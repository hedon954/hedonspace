<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>HedonWang</title>
  
  <subtitle>å›å­æ±‚è¯¸å·±ï¼Œå¾‹å·±åˆ™å®‰ã€‚</subtitle>
  <link href="https://hedon.top/atom.xml" rel="self"/>
  
  <link href="https://hedon.top/"/>
  <updated>2025-06-10T15:44:51.631Z</updated>
  <id>https://hedon.top/</id>
  
  <author>
    <name>Hedon Wang</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª Condvar</title>
    <link href="https://hedon.top/2025/06/09/rust-action-condvar/"/>
    <id>https://hedon.top/2025/06/09/rust-action-condvar/</id>
    <published>2025-06-09T00:51:46.000Z</published>
    <updated>2025-06-10T15:44:51.631Z</updated>
    
    <content type="html"><![CDATA[<p>ç³»åˆ—æ–‡ç« ï¼š</p><ul><li><a href="https://hedon.top/2024/11/11/rust-memory-order/">Rust åŸç†ä¸¨èŠä¸€èŠ Rust çš„ Atomic å’Œå†…å­˜é¡ºåº</a></li><li><a href="https://hedon.top/2025/06/05/rust-atomic-in-processor/">Rust åŸç†ä¸¨ä»æ±‡ç¼–è§’åº¦çœ‹åŸå­æ“ä½œ</a></li><li><a href="https://hedon.top/2025/05/13/rust-action-spinlock/">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª SpinLock</a></li><li><a href="https://hedon.top/2025/05/29/rust-action-oneshot-channel/">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª oneshot channel</a></li><li><a href="https://hedon.top/2025/06/03/rust-action-arc/">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª Arc</a></li><li><a href="https://hedon.top/2025/06/08/rust-os-primitives/">Rust åŸç†ä¸¨æ“ä½œç³»ç»Ÿå¹¶å‘åŸè¯­</a></li><li><a href="https://hedon.top/2025/06/09/rust-action-mutex/">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª Mutex</a></li></ul><hr><p>æœ¬ç¯‡æˆ‘ä»¬ç»§ç»­å‚è€ƒ <a href="https://marabos.nl/atomics/building-locks.html#condition-variable">Rust Atomics and Locks</a> ä¸€ä¹¦æ¥æ‰‹å†™ä¸€ä¸ªæ¡ä»¶å˜é‡ï¼š<em>Condition Variable</em>ï¼Œç®€ç§° <code>Condvar</code>ã€‚åœ¨ Rust ä¸­ï¼Œ<code>Condvar</code> æ˜¯ä¸€ä¸ªé…åˆ <code>Mutex</code> ä½¿ç”¨çš„çº¿ç¨‹åŒæ­¥åŸè¯­ï¼Œä¸»è¦ä½œç”¨æ˜¯è®©çº¿ç¨‹åœ¨æ»¡è¶³æŸäº›â€œæ¡ä»¶â€ä¹‹å‰ä¸»åŠ¨<strong>ç¡çœ </strong>ï¼ˆé˜»å¡ï¼‰ï¼Œå¾…æ¡ä»¶è¾¾æˆæ—¶å†è¢«å”¤é†’ã€‚</p><p>å…¸å‹çš„å°±æ˜¯ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å¼ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹æ ‡å‡†åº“çš„ <code>Condvar</code> å¦‚ä½•ä½¿ç”¨ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> std::&#123;</span><br><span class="line">        collections::VecDeque,</span><br><span class="line">        sync::&#123;Condvar, Mutex&#125;,</span><br><span class="line">        thread,</span><br><span class="line">        time::Duration,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">condvar_usage</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">queue</span> = Mutex::<span class="title function_ invoke__">new</span>(VecDeque::<span class="title function_ invoke__">new</span>());</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">not_empty</span> = Condvar::<span class="title function_ invoke__">new</span>();</span><br><span class="line"></span><br><span class="line">        thread::<span class="title function_ invoke__">scope</span>(|s| &#123;</span><br><span class="line">          <span class="comment">// æ¶ˆè´¹è€…</span></span><br><span class="line">            s.<span class="title function_ invoke__">spawn</span>(|| <span class="keyword">loop</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">q</span> = queue.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">item</span> = <span class="keyword">loop</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(item) = q.<span class="title function_ invoke__">pop_front</span>() &#123; <span class="comment">// ä»é˜Ÿåˆ—ä¸­è·å–æ•°æ®</span></span><br><span class="line">                        <span class="keyword">break</span> item; <span class="comment">// è·å–åˆ°åˆ™è¿”å›</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        q = not_empty.<span class="title function_ invoke__">wait</span>(q).<span class="title function_ invoke__">unwrap</span>(); <span class="comment">// è·å–ä¸åˆ°æ•°æ®åˆ™é˜»å¡ç­‰å¾…</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="title function_ invoke__">drop</span>(q);</span><br><span class="line">                dbg!(item);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// ç”Ÿäº§è€…</span></span><br><span class="line">            <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">10</span> &#123;</span><br><span class="line">                queue.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>().<span class="title function_ invoke__">push_back</span>(i);  <span class="comment">// å¾€é˜Ÿåˆ—é‡Œé¢æŠ•æ”¾æ•°æ®</span></span><br><span class="line">                not_empty.<span class="title function_ invoke__">notify_one</span>();  <span class="comment">// å”¤é†’æ½œåœ¨çš„é˜»å¡çº¿ç¨‹</span></span><br><span class="line">                thread::<span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">1</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€å¯¹ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼š</p><ol><li>æ¶ˆè´¹å°è¯•è·å–é”ï¼Œå¹¶ä»é˜Ÿåˆ—ä¸­è·å–æ•°æ®ï¼š<ol><li>å¦‚æœæœ‰ï¼Œåˆ™é‡Šæ”¾é”å¹¶è¿”å›ã€‚</li><li>å¦‚æœæ²¡æœ‰ï¼Œåˆ™è°ƒç”¨æ¡ä»¶å˜é‡çš„ <code>wait</code> é™·å…¥é˜»å¡<strong>å¹¶é‡Šæ”¾é”</strong>ã€‚</li></ol></li><li>ç”Ÿäº§è€…å°è¯•è·å–é”ï¼Œå¹¶å¾€é˜Ÿåˆ—ä¸­æŠ•æ”¾æ•°æ®ï¼Œå¹¶è°ƒç”¨æ¡ä»¶å˜é‡çš„ <code>notify_one</code> å”¤é†’æ½œåœ¨çš„é˜»å¡çº¿ç¨‹ã€‚</li></ol><pre class="mermaid">flowchart LR    A[ç”Ÿäº§è€…] -->|æ·»åŠ æ•°æ®| B[é˜Ÿåˆ—]    B -->|å–æ•°æ®| C[æ¶ˆè´¹è€…]    A -->|notify_one| C    C -->|wait| A</pre><h2 id="è¯»å®Œæœ¬ç¯‡ä½ èƒ½å­¦åˆ°ä»€ä¹ˆ">è¯»å®Œæœ¬ç¯‡ä½ èƒ½å­¦åˆ°ä»€ä¹ˆ</h2><p>ä½ æ˜¯å¦åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­é‡åˆ°è¿‡è¿™äº›ä»¤äººå¤´ç–¼çš„é—®é¢˜ï¼š</p><p>ğŸ¤” <strong>æ€§èƒ½æµªè´¹é—®é¢˜</strong>ï¼šæ¶ˆè´¹è€…çº¿ç¨‹éœ€è¦ä¸æ–­è½®è¯¢æ£€æŸ¥æ•°æ®æ˜¯å¦å°±ç»ªï¼Œå³ä½¿æ²¡æœ‰æ•°æ®ä¹Ÿè¦æŒç»­å ç”¨ CPUï¼Œè¿™ç§&quot;å¿™ç­‰å¾…&quot;è®©ç¨‹åºæ•ˆç‡ä½ä¸‹ï¼Ÿ</p><p>ğŸ¤” <strong>å¤æ‚çš„åŒæ­¥é€»è¾‘</strong>ï¼šåœ¨ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ä¸­ï¼Œå¦‚ä½•è®©æ¶ˆè´¹è€…åœ¨æ²¡æœ‰æ•°æ®æ—¶ä¼˜é›…åœ°è¿›å…¥ä¼‘çœ ï¼Œè€Œä¸æ˜¯æ— ä¼‘æ­¢åœ°æ£€æŸ¥ï¼Ÿ</p><p>ğŸ¤” <strong>ç«æ€æ¡ä»¶çš„å›°æ‰°</strong>ï¼šå¦‚ä½•ç¡®ä¿åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå”¤é†’æ“ä½œä¸ä¼šä¸¢å¤±ï¼Œçº¿ç¨‹ä¸ä¼šå› ä¸¢å¤±å”¤é†’è€Œæ°¸è¿œæ²‰ç¡ï¼Ÿ</p><p>ğŸ¤” <strong>æ€§èƒ½ä¼˜åŒ–çš„ç–‘æƒ‘</strong>ï¼šç³»ç»Ÿè°ƒç”¨å¼€é”€å¾ˆå¤§ï¼Œå¦‚ä½•é¿å…åœ¨æ²¡æœ‰ç­‰å¾…çº¿ç¨‹æ—¶è¿›è¡Œæ— æ„ä¹‰çš„å”¤é†’æ“ä½œï¼Ÿ</p><p>ğŸ¤” <strong>å†…å­˜é¡ºåºçš„é€‰æ‹©</strong>ï¼šåœ¨å®ç°åŒæ­¥åŸè¯­æ—¶ï¼Œåˆ°åº•è¯¥ç”¨ <code>Acquire</code>ã€<code>Release</code> è¿˜æ˜¯ <code>Relaxed</code>ï¼Ÿå¦‚ä½•åˆ†æ happens-before å…³ç³»ï¼Ÿ</p><p>å¦‚æœè¿™äº›é—®é¢˜æ›¾ç»è®©ä½ å›°æƒ‘ï¼Œé‚£ä¹ˆæœ¬æ–‡æ­£æ˜¯ä¸ºä½ å‡†å¤‡çš„ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ­£å¼å¼€å§‹ä»é›¶å¼€å§‹æ„å»ºä¸€ä¸ªæ¡ä»¶å˜é‡ï¼ˆCondvarï¼‰ï¼Œç”¨æœ€ç›´è§‚çš„æ–¹å¼è§£ç­”è¿™äº›å¹¶å‘ç¼–ç¨‹ä¸­çš„ç»å…¸éš¾é¢˜ã€‚</p><h2 id="v1ï¼šåŸºç¡€å®ç°">v1ï¼šåŸºç¡€å®ç°</h2><p>å…ˆæ¥æ€è€ƒä¸€ä¸‹å¦‚ä½•å®šä¹‰ <code>Condvar</code> è¿™ä¸ªæ•°æ®ç»“æ„ï¼Œå‚è€ƒæ ‡å‡†åº“ï¼Œå®ƒä¼šæœ‰ 3 ä¸ªæ–¹æ³•ï¼š</p><ul><li><code>wait(MutexGuard)</code>: é‡Šæ”¾ MutexGuard å¹¶é™·å…¥ç­‰å¾…ã€‚</li><li><code>notify_one()</code>: å”¤é†’ä¸€ä¸ª <code>wait</code> çš„çº¿ç¨‹ã€‚</li><li><code>notify_all()</code>: å”¤é†’æ‰€æœ‰ <code>wait</code> çš„çº¿ç¨‹ã€‚</li></ul><p>çœ‹è¿‡æœ¬ç³»åˆ—å‰é¢å‡ ç¯‡çš„è¯»è€…åº”è¯¥å¯ä»¥æ•é”è§‰å¯Ÿåˆ°ï¼Œè¿™é‡Œå°±æ˜¯å¯¹åº”äº† <code>atomic-wait</code> ä¸­çš„ <code>wait/wake_one/wake_all</code>ã€‚</p><p>é‚£å±€åŠ¿å°±æ¯”è¾ƒæ˜æœ—äº†ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ <code>condvar.wait(guard)</code> çš„æ—¶å€™è°ƒç”¨ <code>atomic_wait::wait(&amp;atomic)</code> ï¼Œç„¶ååœ¨ <code>condvar.notify_one()</code> çš„æ—¶å€™ä¿®æ”¹ <code>&amp;atomic</code> ç„¶åè°ƒç”¨ <code>atomic_wait::wake_one()</code> å”¤é†’çº¿ç¨‹ï¼Œ<code>condvar.notify_all()</code> ä¹ŸåŒç†ã€‚</p><p>å› æ­¤ <code>Condvar</code> éœ€è¦æœ‰ä¸€ä¸ª <code>AtomicU32</code> ç±»å‹çš„å±æ€§ï¼Œè¿™é‡Œæˆ‘ä»¬ç§°ä¸º <code>counter</code>ã€‚æ•… <code>Condvar</code> ç»“æ„æš‚ä¸”å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Condvar</span> &#123;</span><br><span class="line">    counter: AtomicU32,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Condvar</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            counter: AtomicU32::<span class="title function_ invoke__">new</span>(<span class="number">0</span>),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>notify_one</code> å’Œ <code>notify_all</code> æ‰€ä¸Šæ‰€è¿°ï¼Œå°±éå¸¸ç®€å•äº†ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">Condvar</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">notify_one</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.counter.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Relaxed);</span><br><span class="line">        <span class="title function_ invoke__">wake_one</span>(&amp;<span class="keyword">self</span>.counter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">notify_all</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.counter.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Relaxed);</span><br><span class="line">        <span class="title function_ invoke__">wake_all</span>(&amp;<span class="keyword">self</span>.counter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨å°±å‰©ä¸‹ <code>wait</code> äº†ï¼Œå®ƒçš„åŸºæœ¬åŸç†ï¼š</p><ol><li>æ¥æ”¶ä¸€ä¸ª MutexGuardï¼›</li><li>é‡Šæ”¾ MutexGuardï¼›</li><li>é™·å…¥ç­‰å¾…ï¼Œç­‰å¾…å”¤é†’ï¼›</li><li>è¢«å”¤é†’åï¼Œå†æ¬¡æŠ¢å é”ã€‚</li></ol><p>ç»¼ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥æœ‰ä»¥ä¸‹å®ç°ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">MutexGuard</span>&lt;<span class="symbol">&#x27;a</span>, T&gt; &#123;</span><br><span class="line">    <span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) mutex: &amp;<span class="symbol">&#x27;a</span> Mutex&lt;T&gt;,  <span class="comment">// &lt;---- éœ€è¦å…¬å¼€ mutex å­—æ®µï¼Œè¿™é‡Œä½¿ç”¨ pub(crate) é™åˆ¶ crate å¤–éƒ¨è®¿é—®</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Condvar</span> &#123;</span><br><span class="line">   <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">wait</span>&lt;<span class="symbol">&#x27;a</span>, T&gt;(&amp;<span class="keyword">self</span>, guard: MutexGuard&lt;<span class="symbol">&#x27;a</span>, T&gt;) <span class="punctuation">-&gt;</span> MutexGuard&lt;<span class="symbol">&#x27;a</span>, T&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">counter_value</span> = <span class="keyword">self</span>.counter.<span class="title function_ invoke__">load</span>(Relaxed);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Unlock the mutex by dropping the guard,</span></span><br><span class="line">        <span class="comment">// but remember the mutex so we can lock it again.</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">mutex</span> = guard.mutex;</span><br><span class="line">        <span class="title function_ invoke__">drop</span>(guard);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Wait, but only if the counter hasn&#x27;t changed since unlocking.</span></span><br><span class="line">        <span class="title function_ invoke__">wait</span>(&amp;<span class="keyword">self</span>.counter, counter_value);</span><br><span class="line"></span><br><span class="line">        mutex.<span class="title function_ invoke__">lock</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œä¸ºäº†è®¿é—® <code>guard.mutex</code>ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ä¹‹å‰è‡ªå·±æ‰‹å†™çš„ <a href="https://github.com/hedon-rust-road/conutils/blob/main/src/mutex.rs">MutexGuard</a>ï¼Œå¹¶å°† <code>mutex</code> å­—æ®µçš„ç§æœ‰ç¨‹åº¦ä¿®æ”¹ä¸º <code>pub(crate)</code>ã€‚ä»£ç æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ï¼Œå®Œæ•´æµç¨‹å¯å‚è€ƒä¸‹å›¾ç†è§£ã€‚</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250610230511147.png" alt=""></p><p>æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼Œè¿è¡Œåå‘ç°ä¹Ÿæ˜¯å¯ä»¥é€šè¿‡çš„ï¼</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> std::&#123;collections::VecDeque, thread, time::Duration&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">use</span> crate::&#123;condvar::Condvar, mutex::Mutex&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">condvar_usage</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">queue</span> = Mutex::<span class="title function_ invoke__">new</span>(VecDeque::<span class="title function_ invoke__">new</span>());</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">not_empty</span> = Condvar::<span class="title function_ invoke__">new</span>();</span><br><span class="line"></span><br><span class="line">        thread::<span class="title function_ invoke__">scope</span>(|s| &#123;</span><br><span class="line">            s.<span class="title function_ invoke__">spawn</span>(|| <span class="keyword">loop</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">q</span> = queue.<span class="title function_ invoke__">lock</span>();</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">item</span> = <span class="keyword">loop</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(item) = q.<span class="title function_ invoke__">pop_front</span>() &#123;</span><br><span class="line">                        <span class="keyword">break</span> item;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        q = not_empty.<span class="title function_ invoke__">wait</span>(q);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="title function_ invoke__">drop</span>(q);</span><br><span class="line">                dbg!(item);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">10</span> &#123;</span><br><span class="line">                queue.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">push_back</span>(i);</span><br><span class="line">                not_empty.<span class="title function_ invoke__">notify_one</span>();</span><br><span class="line">                thread::<span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">1</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="v2ï¼šå‡å°‘ä¸å¿…è¦çš„ç³»ç»Ÿè°ƒç”¨">v2ï¼šå‡å°‘ä¸å¿…è¦çš„ç³»ç»Ÿè°ƒç”¨</h2><p>ç¬¬ 1 ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬åœ¨ <code>notify_one</code> å’Œ <code>notify_all</code> åˆ†åˆ«éƒ½æ— æ¡ä»¶è°ƒç”¨äº† <code>wake_one</code> å’Œ <code>wake_all</code> å°è¯•å”¤é†’æ½œåœ¨çš„çº¿ç¨‹ï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™å¯èƒ½å¹¶æ²¡æœ‰çº¿ç¨‹è¢«é˜»å¡ç€ï¼Œé‚£è¿™ä¸ªç³»ç»Ÿè°ƒç”¨å°±ç™½ç™½æµªè´¹äº†ã€‚</p><p>æ‰€ä»¥åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬å°è¯•æ¥ä¼˜åŒ–è¿™ä¸€ç‚¹ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦è®°å½•å½“å‰é˜»å¡ä¸­çš„çº¿ç¨‹çš„æ•°é‡ï¼Œæ‰€ä»¥éœ€è¦ç»™ <code>Condvar</code> åŠ ä¸€ä¸ªå±æ€§ <code>num_waiters</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Condvar</span> &#123;</span><br><span class="line">    counter: AtomicU32,</span><br><span class="line">    num_waiters: AtomicUsize,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Condvar</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            counter: AtomicU32::<span class="title function_ invoke__">new</span>(<span class="number">0</span>),</span><br><span class="line">            num_waiters: AtomicUsize::<span class="title function_ invoke__">new</span>(<span class="number">0</span>),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>notify_one</code> å’Œ <code>notify_all</code> çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä»…å½“ <code>num_waiters&gt;0</code> çš„æ—¶å€™ï¼Œæ‰è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">Condvar</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">notify_one</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.num_waiters.<span class="title function_ invoke__">load</span>(Relaxed) &gt; <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.counter.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Relaxed); <span class="comment">// <span class="doctag">TODO:</span> memory order</span></span><br><span class="line">            <span class="title function_ invoke__">wake_one</span>(&amp;<span class="keyword">self</span>.counter);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">notify_all</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.num_waiters.<span class="title function_ invoke__">load</span>(Relaxed) &gt; <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.counter.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Relaxed); <span class="comment">// <span class="doctag">TODO:</span> memory order</span></span><br><span class="line">            <span class="title function_ invoke__">wake_all</span>(&amp;<span class="keyword">self</span>.counter);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>wait</code> çš„æ—¶å€™ï¼Œæˆ‘ä»¬å…ˆæ ‡è®°è‡ªå·±æ˜¯ç­‰å¾…çš„ï¼Œå³ <code>num_waiters++</code>ï¼Œç„¶ååœ¨è¢«å”¤é†’åï¼Œè§£é™¤è¿™ä¸ªæ ‡è®°ï¼Œå³ <code>num_waiters--</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">Condvar</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">wait</span>&lt;<span class="symbol">&#x27;a</span>, T&gt;(&amp;<span class="keyword">self</span>, guard: MutexGuard&lt;<span class="symbol">&#x27;a</span>, T&gt;) <span class="punctuation">-&gt;</span> MutexGuard&lt;<span class="symbol">&#x27;a</span>, T&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.num_waiters.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Relaxed); <span class="comment">// <span class="doctag">TODO:</span> memory order  &lt;----  New!!!</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> <span class="variable">counter_value</span> = <span class="keyword">self</span>.counter.<span class="title function_ invoke__">load</span>(Relaxed);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Unlock the mutex by dropping the guard,</span></span><br><span class="line">        <span class="comment">// but remember the mutex so we can lock it again.</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">mutex</span> = guard.mutex;</span><br><span class="line">        <span class="title function_ invoke__">drop</span>(guard);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Wait, but only if the counter hasn&#x27;t changed since unlocking.</span></span><br><span class="line">        <span class="title function_ invoke__">wait</span>(&amp;<span class="keyword">self</span>.counter, counter_value);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.num_waiters.<span class="title function_ invoke__">fetch_sub</span>(<span class="number">1</span>, Relaxed); <span class="comment">//<span class="doctag">TODO:</span> memory order   &lt;----  New!!!</span></span><br><span class="line"></span><br><span class="line">        mutex.<span class="title function_ invoke__">lock</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>OKï¼Œè¿™é‡Œåˆåˆ°äº†æœ€å…³é”®çš„é—®é¢˜äº†ï¼š<strong><font color="red">æ“ä½œ num_waiters æ—¶è¯¥ç”¨ä»€ä¹ˆå†…å­˜é¡ºåºï¼Ÿ</font></strong></p><p>è¿™ä¸ªå…³é”®çš„é—®é¢˜çš„å…³é”®æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæ˜¯è¦**<font color="green">ç¡®å®šå“ªäº›åœ°æ–¹éœ€è¦å»ºç«‹ happens-before å…³ç³»ï¼</font>**</p><p>å¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬è¿™é‡Œçš„å…³é”®å°±æ˜¯è¦**<font color="red">é˜²æ­¢ <code>wake_one</code> çš„ä¸¢å¤±</font>**ï¼Œå³ç¡®ä¿å¦‚æœä¸€ä¸ªçº¿ç¨‹å³å°†è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œé‚£ä¹ˆåç»­çš„é€šçŸ¥æ“ä½œèƒ½å¤Ÿçœ‹åˆ°è¿™ä¸ªç­‰å¾…è€…çš„å­˜åœ¨ã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦ <code>notify_one()</code> ä¸­çš„ <code>load</code> å’Œ <code>condvar.wait()</code> ä¸­çš„ <code>fetch_add</code> å»ºç«‹ happens-before å…³ç³»ã€‚è‡³äº <code>fetch_sub</code> å°±æ— æ‰€è°“äº†ï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™å·²ç»è¢«å”¤é†’äº†ï¼Œä¸¢å¤±æˆ–è€…é‡å¤å”¤é†’éƒ½æ— æ‰€è°“äº†ã€‚</p><p>ä¸è¿‡è¿™é‡Œå…¶å®å¯ä»¥çœæ‰è¿™å¯¹ <code>Release</code> å’Œ <code>Acquire</code>ï¼Œç›´æ¥ç”¨ <code>Relaxed</code>ï¼ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><ol><li><p>åœ¨ <code>condvar.wait</code> çš„ <code>fetch_add</code> ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»å…ˆæ‹¿åˆ° MutexGuardï¼Œå³é€šè¿‡ <code>lock()</code> æŠ¢å åˆ°é”ï¼Œ<code>lock()</code> é‡Œé¢æ˜¯å•¥æ“ä½œï¼Ÿæ˜¯ä¸€ä¸ª <strong><code>Acquire</code></strong>!</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; Mutex&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">lock</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> MutexGuard&lt;T&gt; &#123;</span><br><span class="line">        <span class="title function_ invoke__">lock_contended</span>(&amp;<span class="keyword">self</span>.state);</span><br><span class="line">        <span class="comment">// Swap successfully, means locked.</span></span><br><span class="line">        MutexGuard &#123; mutex: <span class="keyword">self</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">lock_contended</span>(state: &amp;AtomicU32) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">spin_count</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">let</span> <span class="variable">Err</span>(s) = state.<span class="title function_ invoke__">compare_exchange</span>(<span class="number">0</span>, <span class="number">1</span>, Ordering::Acquire, Ordering::Relaxed) &#123;</span><br><span class="line">        <span class="keyword">if</span> s == <span class="number">1</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> spin_count &lt; <span class="number">100</span> &#123;</span><br><span class="line">                spin_count += <span class="number">1</span>;</span><br><span class="line">                std::hint::<span class="title function_ invoke__">spin_loop</span>();</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            _ = state.<span class="title function_ invoke__">compare_exchange</span>(<span class="number">1</span>, <span class="number">2</span>, Ordering::Acquire, Ordering::Relaxed);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">wait</span>(state, <span class="number">2</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æˆ‘ä»¬åœ¨è°ƒç”¨ <code>atomic-wait::wait</code> é™·å…¥ç­‰å¾…ä¹‹å‰ï¼Œè¦å…ˆ <code>drop(guard</code>)ï¼Œåˆ«å¿˜äº†ï¼Œ<code>drop(guard)</code> é‡Œé¢æ˜¯å•¥æ“ä½œï¼Ÿæ˜¯ä¸€ä¸ª <strong><code>Release</code></strong>ï¼</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Drop</span> <span class="keyword">for</span> <span class="title class_">MutexGuard</span>&lt;<span class="symbol">&#x27;_</span>, T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="comment">// If there are threads waiting for the lock, wait one of them.</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.mutex.state.<span class="title function_ invoke__">swap</span>(<span class="number">0</span>, Ordering::Release) == <span class="number">2</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">wake_one</span>(&amp;<span class="keyword">self</span>.mutex.state);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>æ‰€ä»¥å‘€ï¼Œè¿™é‡Œå…¶å®å¤©ç„¶å°±å·²ç»æœ‰ä¸€å¯¹ <code>Release</code> å’Œ <code>Acquire</code> äº†ï¼happens-before å…³ç³»æ˜¯æˆç«‹çš„ï¼æ‰€ä»¥æˆ‘ä»¬ä¹‹å‰çš„ä»£ç å°±å·²ç»æ»¡è¶³è¦æ±‚äº†ï¼Œå†æ¬¡è¿è¡Œå‰é¢çš„æµ‹è¯•ç”¨ä¾‹ï¼Œä¾æ—§æ˜¯é¡ºåˆ©é€šè¿‡çš„ï¼</p><p>å®Œæ•´ä»£ç å¯å‚è€ƒï¼š<a href="https://github.com/hedon-rust-road/conutils/blob/main/src/condvar.rs">conutils/condvar</a>ã€‚å…·ä½“æµç¨‹ä½ å¯ä»¥å‚è€ƒä¸‹å›¾è¾…åŠ©ç†è§£ã€‚</p><pre class="mermaid">sequenceDiagram    participant Consumer as æ¶ˆè´¹è€…çº¿ç¨‹    participant Producer as ç”Ÿäº§è€…çº¿ç¨‹    participant Mutex as MutexçŠ¶æ€    participant NumWaiters as num_waiters    participant Counter as counter    Consumer->>Mutex: lock() [Acquire]    Consumer->>Consumer: æ£€æŸ¥æ¡ä»¶ï¼Œå‘ç°éœ€è¦ç­‰å¾…    Consumer->>NumWaiters: fetch_add(1) [Relaxed]    Consumer->>Counter: load() -> counter_value    Consumer->>Mutex: drop(guard) [Release]    Consumer->>Counter: wait(counter_value)    Note over Producer: ç”Ÿäº§è€…åœ¨å¦ä¸€ä¸ªçº¿ç¨‹    Producer->>Mutex: lock() [Acquire] âœ… ä¸Consumerçš„ReleaseåŒæ­¥    Producer->>Producer: ä¿®æ”¹å…±äº«æ•°æ®    Producer->>Mutex: drop(guard) [Release]    Producer->>NumWaiters: load() > 0? âœ… çœ‹åˆ°Consumerçš„increment    Producer->>Counter: fetch_add(1) [Relaxed]    Producer->>Counter: wake_one()    Consumer->>Consumer: è¢«å”¤é†’    Consumer->>Mutex: lock() [Acquire]    Consumer->>NumWaiters: fetch_sub(1) [Relaxed]</pre><blockquote><p>å¦å¤–ï¼Œå³ä½¿ <code>notify_one()</code> åœ¨ <code>wait()</code> ä¹‹å‰è°ƒç”¨ï¼Œ<code>atomic_wait::wait()</code> çš„è¯­ä¹‰ä¹Ÿèƒ½ä¿è¯æ­£ç¡®æ€§ã€‚å› ä¸º <code>wait(&amp;counter, expected_value)</code> åªæœ‰åœ¨ <code>counter</code> çš„å€¼ç­‰äº <code>expected_value</code> æ—¶æ‰ä¼šé˜»å¡ï¼Œå¦‚æœ <code>counter</code> å·²ç»è¢«ä¿®æ”¹ï¼Œ<code>wait</code> ä¼šç«‹å³è¿”å›ã€‚</p></blockquote><h2 id="æ€»ç»“">æ€»ç»“</h2><p>é€šè¿‡æœ¬æ–‡çš„å­¦ä¹ ï¼Œæˆ‘ä»¬ä»é›¶å¼€å§‹å®ç°äº†ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„æ¡ä»¶å˜é‡ï¼ˆCondvarï¼‰ï¼Œå¹¶åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­è§£å†³äº†å¤šä¸ªé‡è¦é—®é¢˜ï¼š</p><ol><li><p><strong>ç†è§£æ¡ä»¶å˜é‡çš„æœ¬è´¨</strong>ï¼šCondvar æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªé…åˆ Mutex ä½¿ç”¨çš„çº¿ç¨‹åŒæ­¥å·¥å…·ï¼Œå®ƒè§£å†³äº†&quot;å¦‚ä½•è®©çº¿ç¨‹åœ¨æ¡ä»¶ä¸æ»¡è¶³æ—¶ä¼‘çœ ï¼Œæ¡ä»¶æ»¡è¶³æ—¶è¢«å”¤é†’&quot;è¿™ä¸€ç»å…¸å¹¶å‘ç¼–ç¨‹é—®é¢˜ã€‚</p></li><li><p><strong>æŒæ¡ä¸¤ç§å®ç°ç­–ç•¥</strong>ï¼š</p><ul><li><strong>v1 åŸºç¡€ç‰ˆæœ¬</strong>ï¼šç›´æ¥ä½¿ç”¨ <code>atomic-wait</code> å®ç°ç­‰å¾…ä¸å”¤é†’æœºåˆ¶</li><li><strong>v2 ä¼˜åŒ–ç‰ˆæœ¬</strong>ï¼šé€šè¿‡ <code>num_waiters</code> è®¡æ•°å™¨é¿å…ä¸å¿…è¦çš„ç³»ç»Ÿè°ƒç”¨</li></ul></li><li><p><strong>æ·±å…¥ç†è§£å†…å­˜é¡ºåº</strong>ï¼šé€šè¿‡åˆ†æ happens-before å…³ç³»ï¼Œæˆ‘ä»¬å‘ç°å¯ä»¥ä½¿ç”¨ <code>Relaxed</code> å†…å­˜é¡ºåºï¼Œå› ä¸º Mutex çš„ <code>Release</code>/<code>Acquire</code> æ“ä½œå·²ç»æä¾›äº†å¿…è¦çš„åŒæ­¥ä¿éšœã€‚</p></li></ol><p>æŒæ¡äº†è¿™äº›çŸ¥è¯†åï¼Œä½ å¯ä»¥ï¼š</p><ul><li>åœ¨ç”Ÿäº§è€…-æ¶ˆè´¹è€…åœºæ™¯ä¸­é«˜æ•ˆåœ°åŒæ­¥çº¿ç¨‹</li><li>ç†è§£æ ‡å‡†åº“ <code>std::sync::Condvar</code> çš„å®ç°åŸç†</li><li>åœ¨è®¾è®¡è‡ªå·±çš„åŒæ­¥åŸè¯­æ—¶åšå‡ºæ­£ç¡®çš„å†…å­˜é¡ºåºé€‰æ‹©</li><li>è¯†åˆ«å¹¶é¿å…å¹¶å‘ç¼–ç¨‹ä¸­çš„å¸¸è§é™·é˜±</li></ul><p>æ¡ä»¶å˜é‡è™½ç„¶æ¦‚å¿µç®€å•ï¼Œä½†å…¶èƒŒåæ¶‰åŠçš„åŸå­æ“ä½œã€å†…å­˜é¡ºåºã€æ“ä½œç³»ç»ŸåŸè¯­ç­‰çŸ¥è¯†å´ç›¸å½“æ·±å…¥ã€‚é€šè¿‡äº²æ‰‹å®ç°ï¼Œæˆ‘ä»¬ä¸ä»…æŒæ¡äº†å·¥å…·çš„ä½¿ç”¨ï¼Œæ›´é‡è¦çš„æ˜¯ç†è§£äº†å…¶èƒŒåçš„è®¾è®¡æ€æƒ³ï¼Œè¿™ä¸ºæˆ‘ä»¬åç»­å­¦ä¹ æ›´å¤æ‚çš„å¹¶å‘ç¼–ç¨‹æŠ€å·§æ‰“ä¸‹äº†åšå®åŸºç¡€ã€‚</p><p>ä¸‹ç¯‡ï¼Œæˆ‘ä»¬å°†å®Œæˆ <a href="https://marabos.nl/atomics/building-locks.html#reader-writer-lock">Rust Atomics and Locks</a> çš„æœ€åä¸€ä¸ªå®æˆ˜æ¡ˆä¾‹ï¼šæ‰‹å†™ä¸€ä¸ªè¯»å†™é”ï¼ˆRWMutexï¼‰ï¼</p><p>Happy Coding! Peace~</p>]]></content>
    
    
    <summary type="html">åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œä½ æ˜¯å¦é‡åˆ°è¿‡è¿™æ ·çš„å›°æ‰°ï¼šæ¶ˆè´¹è€…çº¿ç¨‹ä¸æ–­è½®è¯¢æ£€æŸ¥æ•°æ®æ˜¯å¦å‡†å¤‡å¥½ï¼Œç™½ç™½æµªè´¹ CPU èµ„æºï¼Ÿæˆ–è€…åœ¨ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ä¸­ï¼Œå¦‚ä½•è®©æ¶ˆè´¹è€…ä¼˜é›…åœ°ç­‰å¾…æ•°æ®åˆ°æ¥ï¼Ÿæœ¬æ–‡å°†å¸¦ä½ æ‰‹å†™ä¸€ä¸ªé«˜æ•ˆçš„ Condvarï¼ˆæ¡ä»¶å˜é‡ï¼‰ï¼Œè§£å†³çº¿ç¨‹é—´çš„ç­‰å¾…ä¸å”¤é†’é—®é¢˜ã€‚æˆ‘ä»¬å°†ä»æœ€åŸºç¡€çš„å®ç°å¼€å§‹ï¼Œé€æ­¥ä¼˜åŒ–åˆ°å‡å°‘ä¸å¿…è¦çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå¹¶æ·±å…¥åˆ†æå†…å­˜é¡ºåºçš„é€‰æ‹©ï¼Œè®©ä½ å½»åº•ç†è§£æ¡ä»¶å˜é‡èƒŒåçš„è®¾è®¡å“²å­¦ã€‚</summary>
    
    
    
    <category term="rust" scheme="https://hedon.top/categories/rust/"/>
    
    <category term="rust å®æˆ˜" scheme="https://hedon.top/categories/rust/rust-%E5%AE%9E%E6%88%98/"/>
    
    
    <category term="rust" scheme="https://hedon.top/tags/rust/"/>
    
    <category term="å¹¶å‘ç¼–ç¨‹" scheme="https://hedon.top/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª Mutex</title>
    <link href="https://hedon.top/2025/06/09/rust-action-mutex/"/>
    <id>https://hedon.top/2025/06/09/rust-action-mutex/</id>
    <published>2025-06-09T00:51:46.000Z</published>
    <updated>2025-06-09T16:51:50.652Z</updated>
    
    <content type="html"><![CDATA[<p>ç³»åˆ—æ–‡ç« ï¼š</p><ul><li><a href="https://hedon.top/2024/11/11/rust-memory-order/">Rust åŸç†ä¸¨èŠä¸€èŠ Rust çš„ Atomic å’Œå†…å­˜é¡ºåº</a></li><li><a href="https://hedon.top/2025/06/05/rust-atomic-in-processor/">Rust åŸç†ä¸¨ä»æ±‡ç¼–è§’åº¦çœ‹åŸå­æ“ä½œ</a></li><li><a href="https://hedon.top/2025/05/13/rust-action-spinlock/">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª SpinLock</a></li><li><a href="https://hedon.top/2025/05/29/rust-action-oneshot-channel/">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª oneshot channel</a></li><li><a href="https://hedon.top/2025/06/03/rust-action-arc/">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª Arc</a></li><li><a href="https://hedon.top/2025/06/08/rust-os-primitives/">Rust åŸç†ä¸¨æ“ä½œç³»ç»Ÿå¹¶å‘åŸè¯­</a></li></ul><hr><p>ç»§ä¸Šç¯‡ <a href="https://hedon.top/2025/06/08/rust-os-primitives/">Rust åŸç†ä¸¨æ“ä½œç³»ç»Ÿå¹¶å‘åŸè¯­</a>ï¼Œæˆ‘ä»¬å­¦ä¹ äº†ä¸åŒæ“ä½œç³»ç»Ÿä¸‹çš„å¹¶å‘åŸè¯­å®ç°ï¼Œç†è§£äº†å®ƒä»¬æœ€é‡è¦çš„è´¡çŒ®å°±æ˜¯æä¾›äº†ä¸€å¥— <code>wait/wake_one/wake_all</code> çš„æœºåˆ¶ã€‚æœ¬ç¯‡ï¼Œæˆ‘ä»¬å°†å€ŸåŠ© <a href="https://marabos.nl/atomics/">Rust Atomics and Locks</a> çš„ä½œè€… <a href="https://github.com/m-ou-se">Mara Bos</a> å°è£…çš„ <a href="https://github.com/m-ou-se/atomic-wait">atomic-wait</a> crateï¼Œæ¥æ‰‹å†™ä¸€ä¸ªè‡ªå·±çš„ <code>Mutex</code>ï¼</p><h2 id="v1ï¼šåŸºæœ¬å®ç°">v1ï¼šåŸºæœ¬å®ç°</h2><p>é¦–å…ˆæˆ‘ä»¬æ¥æ€è€ƒä¸€ä¸‹å¦‚ä½•å®šä¹‰æ•°æ®ç»“æ„ï¼š</p><ol><li>æˆ‘ä»¬éœ€è¦ 1 ä¸ªåŸå­å˜é‡ <strong>state</strong> æ¥è®°å½•é”çš„çŠ¶æ€ï¼ˆ0: unlocked, 1: lockedï¼‰ï¼Œå› ä¸º <code>atomic-wait</code> åªæ”¯æŒ AtomicU32ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬çš„ç±»å‹ä¹Ÿå®šä¹‰ä¸º AtomicU32ã€‚</li><li>å¦å¤–æˆ‘ä»¬éœ€è¦ä¸€ä¸ª <strong>value</strong> å­—æ®µæ¥ä¿å­˜æ•°æ®ï¼Œå½“æŠ¢åˆ°é”çš„æ—¶å€™ï¼Œæ˜¯å¯ä»¥å¯¹ <strong>value</strong> è¿›è¡Œä¿®æ”¹çš„ï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™åªæœ‰å…±äº«å¼•ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ <code>UnsafeCell</code> æ¥æä¾›å†…éƒ¨å¯å˜æ€§ã€‚</li></ol><p>åŒæ—¶ï¼Œè´¯å½» *RAIIï¼ˆResource Acquisition Is Initializationï¼Œèµ„æºè·å–å³åˆå§‹åŒ–ï¼‰*åŸåˆ™ï¼š</p><ol><li>æˆ‘ä»¬åœ¨ <code>lock(&amp;self)</code> æˆåŠŸæ—¶è¿”å›ä¸€ä¸ª <code>MutexGuard</code>ï¼Œå®ƒåŒ…å« <code>&amp;Mutex</code>ã€‚</li><li>åœ¨ <code>MutexGuard</code> drop çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°† <strong>state</strong> é‡ç½®ä¸º 0ï¼Œè¡¨ç¤ºé‡Šæ”¾é”ï¼Œå¹¶å”¤é†’ä¸€ä¸ªæ½œåœ¨çš„é˜»å¡çº¿ç¨‹ã€‚</li></ol><p>ä¸ºäº†è®© <code>Mutex</code> å¯ä»¥åœ¨çº¿ç¨‹ä¹‹é—´å…±äº«ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºå…¶å®ç° <code>Sync</code> traitï¼Œè€Œåˆå› ä¸º <code>Mutex</code> å®ç°çš„æ˜¯ç‹¬å è®¿é—®ï¼Œä¸Šé”æˆåŠŸçš„çº¿ç¨‹æ˜¯æ‹¥æœ‰ T çš„æ‰€æœ‰æƒçš„ï¼Œå³è¦æ±‚ T å¯ä»¥åœ¨çº¿ç¨‹ä¸­è½¬ç§»ï¼Œå³è¦æ±‚ T éœ€è¦å®ç° <code>Send</code> traitã€‚</p><p>ç»¼ä¸Šï¼Œæˆ‘ä»¬å®šä¹‰çš„ <code>Mutex</code> å’Œ <code>MutexGuard</code> ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Mutex</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">/// 0: unlocked</span></span><br><span class="line">    <span class="comment">/// 1: locked</span></span><br><span class="line">    state: AtomicU32,</span><br><span class="line">    value: UnsafeCell&lt;T&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">MutexGuard</span>&lt;<span class="symbol">&#x27;a</span>, T&gt; &#123;</span><br><span class="line">    mutex: &amp;<span class="symbol">&#x27;a</span> Mutex&lt;T&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Sync</span> <span class="keyword">for</span> <span class="title class_">Mutex</span>&lt;T&gt; <span class="keyword">where</span> T: <span class="built_in">Send</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Mutex&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(value: T) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            state: AtomicU32::<span class="title function_ invoke__">new</span>(<span class="number">0</span>),</span><br><span class="line">            value: UnsafeCell::<span class="title function_ invoke__">new</span>(value),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†æ–¹é¢è®¿é—®å†…éƒ¨æ•°æ®ï¼Œæˆ‘ä»¬ä¸º <code>MutexGuard</code> å®ç° <code>Deref</code> å’Œ <code>DerefMut</code> è¿™ 2 ä¸ª trait:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; Deref <span class="keyword">for</span> <span class="title class_">MutexGuard</span>&lt;<span class="symbol">&#x27;_</span>, T&gt; &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Target</span> = T;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">deref</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="keyword">Self</span>::Target &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; &amp;*<span class="keyword">self</span>.mutex.value.<span class="title function_ invoke__">get</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; DerefMut <span class="keyword">for</span> <span class="title class_">MutexGuard</span>&lt;<span class="symbol">&#x27;_</span>, T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">deref_mut</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="keyword">mut</span> <span class="keyword">Self</span>::Target &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; &amp;<span class="keyword">mut</span> *<span class="keyword">self</span>.mutex.value.<span class="title function_ invoke__">get</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ <code>MutexGuard</code> ç¦»å¼€ä½œç”¨åŸŸçš„æ—¶å€™ï¼Œå³è¢« drop çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦é‡Šæ”¾é”ï¼Œå¹¶è°ƒç”¨ <code>wake_one</code> å»å”¤é†’ä¸€ä¸ªæ½œåœ¨çš„é˜»å¡çº¿ç¨‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Drop</span> <span class="keyword">for</span> <span class="title class_">MutexGuard</span>&lt;<span class="symbol">&#x27;_</span>, T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.mutex.state.<span class="title function_ invoke__">store</span>(<span class="number">0</span>, Release);</span><br><span class="line">        <span class="title function_ invoke__">wake_one</span>(&amp;<span class="keyword">self</span>.mutex.state);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°† <code>state</code> è®¾ç½®ä¸º 0ï¼Œä½¿ç”¨çš„å†…å­˜é¡ºåºæ˜¯ <code>Release</code>ï¼Œæ˜¯ä¸ºäº†è·Ÿ <code>lock</code> çš„æ—¶å€™ä½¿ç”¨ <code>Acquire</code> å»ºç«‹ happens-before åŸåˆ™ï¼Œç¡®ä¿ state çš„çœŸå®å€¼åœ¨å„ä¸ªçº¿ç¨‹ä¸­éƒ½æ˜¯å¯è§çš„ã€‚</p><p>åœ¨ <code>lock</code> çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å°† <code>state</code> ä» 0 æ›¿æ¢ä¸º 1ï¼Œå¦‚æœæˆåŠŸï¼Œåˆ™è¯´æ˜ä¸Šé”æˆåŠŸï¼Œç›´æ¥è¿”å› MutexGuardï¼Œå¦‚æœå¤±è´¥ï¼Œåˆ™è¯´æ˜é”å·²ç»è¢«æŠ¢å äº†ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬ä½¿ç”¨ <code>atomic-wait</code> çš„ <code>wait()</code> é™·å…¥ä¼‘çœ ï¼Œç­‰å¾… <code>wake_one</code> ä¿¡å·å”¤é†’ï¼Œå†å°è¯•æŠ¢é”ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; Mutex&lt;T&gt; &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">lock</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> MutexGuard&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">self</span>.state.<span class="title function_ invoke__">swap</span>(<span class="number">1</span>, Acquire) == <span class="number">1</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">wait</span>(&amp;<span class="keyword">self</span>.state, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        MutexGuard &#123; mutex: <span class="keyword">self</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œæˆ‘ä»¬ç¬¬ä¸€ä¸ªç‰ˆæœ¬çš„ <code>Mutex</code> å°±å®Œå·¥äº†ï¼æ˜¯ä¸æ˜¯å¾ˆç®€å•ï¼æˆ‘ä»¬æ¥å†™ 2 ä¸ªå•å…ƒæµ‹è¯•éªŒè¯ä¸€ä¸‹åŸºæœ¬é€»è¾‘æ˜¯å¦æ­£ç¡®ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">one_thread_should_work</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">l</span> = Mutex::<span class="title function_ invoke__">new</span>(<span class="built_in">vec!</span>[]);</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">guard</span> = l.<span class="title function_ invoke__">lock</span>();</span><br><span class="line">    guard.<span class="title function_ invoke__">push</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="title function_ invoke__">drop</span>(guard);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">guard</span> = l.<span class="title function_ invoke__">lock</span>();</span><br><span class="line">    <span class="built_in">assert_eq!</span>(guard[<span class="number">0</span>], <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">cross_thread_should_work</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">l</span> = Mutex::<span class="title function_ invoke__">new</span>(<span class="built_in">vec!</span>[]);</span><br><span class="line"></span><br><span class="line">    thread::<span class="title function_ invoke__">scope</span>(|s| &#123;</span><br><span class="line">        s.<span class="title function_ invoke__">spawn</span>(|| &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">guard</span> = l.<span class="title function_ invoke__">lock</span>();</span><br><span class="line">            guard.<span class="title function_ invoke__">push</span>(<span class="number">1</span>);</span><br><span class="line">            <span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">100</span>)); <span class="comment">// sleep for makeing the second thread to be blcoked.</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">10</span>)); <span class="comment">// make sure the first thread get the lock</span></span><br><span class="line">        s.<span class="title function_ invoke__">spawn</span>(|| &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">guard</span> = l.<span class="title function_ invoke__">lock</span>();</span><br><span class="line">            guard.<span class="title function_ invoke__">push</span>(<span class="number">2</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">guard</span> = l.<span class="title function_ invoke__">lock</span>();</span><br><span class="line">    <span class="built_in">assert_eq!</span>(guard.<span class="title function_ invoke__">len</span>(), <span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡ŒæˆåŠŸï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">running 2 tests</span><br><span class="line">test mutex::tests::one_thread_should_work ... ok</span><br><span class="line">test mutex::tests::cross_thread_should_work ... ok</span><br></pre></td></tr></table></figure><h2 id="v2ï¼šå‡å°‘ç³»ç»Ÿè°ƒç”¨">v2ï¼šå‡å°‘ç³»ç»Ÿè°ƒç”¨</h2><p>å½“ <code>MutexGuard</code> çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°† <code>state</code> ç½®ä¸º 0ï¼Œå¹¶è°ƒç”¨ <code>wake_one</code> å”¤é†’ä¸€ä¸ªæ½œåœ¨çš„çº¿ç¨‹ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœæ²¡æœ‰é˜»å¡ä¸­çš„çº¿ç¨‹çš„è¯ï¼Œé‚£è¿™ä¸ªç³»ç»Ÿè°ƒç”¨å°±æ¯”è¾ƒæµªè´¹äº†ã€‚</p><p>æ‰€ä»¥åœ¨ v2 ç‰ˆæœ¬æˆ‘ä»¬å°è¯•æ¥ä¼˜åŒ–è¿™ä¸€ç‚¹ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦æ‰©å±•æˆ‘ä»¬çš„ <code>state</code> å­—æ®µï¼Œæ–°å¢<strong>è¡¨ç¤ºæ˜¯å¦æœ‰é˜»å¡çº¿ç¨‹</strong>çš„èƒ½åŠ›ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Mutex</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">/// 0: unlocked</span></span><br><span class="line">    <span class="comment">/// 1: locked, but no blocked thread</span></span><br><span class="line">    <span class="comment">/// 2: locked, but has blocked threads</span></span><br><span class="line">    state: AtomicU32,</span><br><span class="line">    value: UnsafeCell&lt;T&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹äº† <code>state</code> çš„å®šä¹‰åæˆ‘ä»¬éœ€è¦ä¿®æ”¹ä¸Šé”å’Œè§£é”çš„é€»è¾‘ï¼Œåœ¨ä¸Šé”çš„æ—¶å€™ï¼Œæˆ‘ä»¬å…ˆå°è¯•å°† <code>state</code> ä» <code>0</code> ç½®ä¸º <code>1</code>ï¼Œå¦‚æœæˆåŠŸäº†ï¼Œè¯´æ˜æŠ¢åˆ°äº†é”ï¼Œå¦åˆ™ï¼Œæˆ‘ä»¬å°† <code>state</code> ç½®ä¸º <code>2</code>ï¼Œè¡¨ç¤ºæœ‰çº¿ç¨‹è¢«é˜»å¡äº†ã€‚</p><p>è¿™é‡Œä¹¦ä¸­çš„å®ç°æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; Mutex&lt;T&gt; &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">lock</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> MutexGuard&lt;T&gt; &#123;</span><br><span class="line">        <span class="title function_ invoke__">lock_contended</span>(&amp;<span class="keyword">self</span>.state);</span><br><span class="line">        MutexGuard &#123; mutex: <span class="keyword">self</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">lock_contended</span>(state: &amp;AtomicU32) &#123;</span><br><span class="line">    <span class="keyword">if</span> state.<span class="title function_ invoke__">compare_exchange</span>(<span class="number">0</span>, <span class="number">1</span>, Acquire, Relaxed).<span class="title function_ invoke__">is_err</span>() &#123;</span><br><span class="line">        <span class="keyword">while</span> state.<span class="title function_ invoke__">swap</span>(<span class="number">2</span>, Acquire) != <span class="number">0</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">wait</span>(&amp;state, <span class="number">2</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Drop</span> <span class="keyword">for</span> <span class="title class_">MutexGuard</span>&lt;<span class="symbol">&#x27;_</span>, T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.mutex.state.<span class="title function_ invoke__">swap</span>(<span class="number">0</span>, Release) == <span class="number">2</span> &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;wake_one&quot;</span>);</span><br><span class="line">            <span class="title function_ invoke__">wake_one</span>(&amp;<span class="keyword">self</span>.mutex.state);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>lock()</code>:</p><ul><li>å¦‚æœæˆåŠŸå°† <code>state</code> ä» <code>0</code> å˜æ¢ä¸º <code>1</code>ï¼Œåˆ™è¯´æ˜å½“å‰çº¿ç¨‹æŠ¢é”æˆåŠŸï¼Œç›´æ¥è¿”å› <code>MutexGuard</code>ã€‚</li><li>å¦‚æœå¤±è´¥äº†ï¼Œå°±å°† <code>state</code> ç½®ä¸º <code>2</code>ï¼Œç„¶åè°ƒç”¨ <code>wait</code> è¿›å…¥ä¼‘çœ ã€‚</li></ul><p><code>unlock()</code>:</p><ul><li>å°† <code>state</code> ç½®ä¸º <code>0</code>ï¼Œå¦‚æœä¹‹å‰æ˜¯ <code>2</code> çš„è¯ï¼Œé‚£å°±è¯´æ˜æœ‰çº¿ç¨‹è¢«é˜»å¡ç€ï¼Œè¿™ä¸ªæ—¶å€™æ‰è°ƒç”¨ <code>wake_one</code> å”¤é†’ä¸€ä¸ªé˜»å¡çš„çº¿ç¨‹ã€‚</li></ul><p>è¿™ä¸ªåœ°æ–¹ï¼Œç¬”è€…è§‰å¾—æœ‰ä¸€äº›é—®é¢˜ï¼Œ <code>state.swap(2, Acquire)</code> è¿™ä¸€è¡Œä»£ç ä¼šæ— æ¡ä»¶å°† <code>state</code> ç½®ä¸º <code>2</code>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“è¿™ä¸ªçº¿ç¨‹æŠ¢åˆ°é”åï¼Œå®ƒåœ¨ <code>unlock()</code> çš„æ—¶å€™ï¼Œæ— è®ºæœ‰æ²¡æœ‰åœ¨é˜»å¡çš„çº¿ç¨‹ï¼Œè¿™ä¸ªæ—¶å€™ <code>state</code> éƒ½æ˜¯ <code>2</code>ï¼Œæ‰€ä»¥éƒ½ä¼šè°ƒç”¨ <code>wake_one</code>ã€‚</p><pre class="mermaid">sequenceDiagram    participant A as çº¿ç¨‹A (æŒæœ‰é”)    participant B as çº¿ç¨‹B (å°è¯•è·é”)    participant State as Mutex State    participant System as ç³»ç»Ÿè°ƒç”¨    Note over State: state = 1 (çº¿ç¨‹AæŒæœ‰é”)    B->>State: compare_exchange(0, 1)    State-->>B: å¤±è´¥ (è¿”å› 1)    Note over B: è¿›å…¥ while å¾ªç¯    B->>State: swap(2)    Note over State: state: 1 â†’ 2    State-->>B: è¿”å› 1 (â‰  0)    B->>System: wait(&state, 2)    Note over B: çº¿ç¨‹Bè¿›å…¥ç­‰å¾…çŠ¶æ€    Note over A: çº¿ç¨‹Aé‡Šæ”¾é”    A->>State: swap(0)    Note over State: state: 2 â†’ 0    State-->>A: è¿”å› 2    A->>System: wake_one()    Note over System: æ­£ç¡®çš„å”¤é†’ï¼çº¿ç¨‹Bç¡®å®åœ¨ç­‰å¾…    Note over B: çº¿ç¨‹Bè¢«å”¤é†’ï¼Œç»§ç»­å¾ªç¯    B->>State: swap(2)    Note over State: state: 0 â†’ 2    State-->>B: è¿”å› 0ï¼Œé€€å‡ºå¾ªç¯    Note over B: è·å¾—é”ï¼Œä½†state=2 (é—®é¢˜æ‰€åœ¨)    Note over B: ä½¿ç”¨é”...    B->>State: unlock() - swap(0)    Note over State: state: 2 â†’ 0    State-->>B: è¿”å› 2    B->>System: wake_one()    Note over System: ä¸å¿…è¦çš„è°ƒç”¨ï¼æ­¤æ—¶æ²¡æœ‰ç­‰å¾…è€…</pre><p>æˆ‘ä»¬å¯ä»¥è¿è¡Œä¸Šé¢çš„æµ‹è¯•ç”¨ä¾‹ <code>cross_thread_should_work</code>ï¼Œå¯ä»¥çœ‹åˆ°è¾“å‡ºäº† 2 ä¸ª wake_oneï¼Œä½†æ˜¯é€šè¿‡åˆ†æï¼Œåº”è¯¥åªéœ€è¦è°ƒç”¨ä¸€æ¬¡ <code>wake_one</code> å°±è¶³å¤Ÿäº†ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">test mutex::tests::cross_thread_should_work ... ok</span><br><span class="line"></span><br><span class="line">successes:</span><br><span class="line"></span><br><span class="line">---- mutex::tests::cross_thread_should_work stdout ----</span><br><span class="line">wake_one</span><br><span class="line">wake_one</span><br></pre></td></tr></table></figure><p>ç¬”è€…çš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">lock_contended</span>(state: &amp;AtomicU32) &#123;</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">let</span> <span class="variable">Err</span>(s) = state.<span class="title function_ invoke__">compare_exchange</span>(<span class="number">0</span>, <span class="number">1</span>, Acquire, Relaxed) &#123;</span><br><span class="line">        <span class="keyword">if</span> s == <span class="number">1</span> &#123;</span><br><span class="line">            _ = state.<span class="title function_ invoke__">compare_exchange</span>(<span class="number">1</span>, <span class="number">2</span>, Acquire, Relaxed);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">wait</span>(&amp;state, <span class="number">2</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>æˆ‘ä»¬è·å– <code>state.compare_exchange(0,1)</code> çš„è¿”å›å€¼ï¼Œå¦‚æœæˆåŠŸï¼Œè¯´æ˜æŠ¢åˆ°é”ï¼Œç›´æ¥è¿”å›ã€‚</li><li>å¦‚æœå¤±è´¥äº†ï¼š<ul><li>åŸå§‹å€¼æ˜¯ <code>1</code>ï¼Œé‚£æˆ‘ä»¬å°±å°è¯•å°† <code>state</code> ä» <code>1</code> äº¤æ¢ä¸º <code>2</code>ï¼Œç„¶åè°ƒç”¨ <code>wait</code> é™·å…¥ä¼‘çœ ã€‚</li><li>åŸå§‹å€¼æ˜¯ <code>2</code>ï¼Œè¯´æ˜å·²ç»æœ‰åˆ«çš„çº¿ç¨‹ä¹Ÿè¢«é˜»å¡äº†ï¼Œè¿™ä¸ªæ—¶å€™ç›´æ¥è°ƒç”¨ <code>wait</code> é™·å…¥ä¼‘çœ ã€‚</li></ul></li><li>å½“è¢« <code>wake_one</code> å”¤é†’æ—¶ï¼Œé‡æ–°æ‰§è¡Œ <code>state.compare_exchange(0,1)</code> æŠ¢å é”ã€‚</li></ol><p>è¿™ä¸ªæ–°çš„æµç¨‹ä¸­ï¼Œæˆ‘ä»¬æŠ¢åˆ°é”çš„æ—¶å€™ï¼Œ<code>state</code> ä¼šè¢«æ­£ç¡®çš„è®¾ç½®ä¸º <code>1</code> è€Œä¸æ˜¯ <code>2</code>ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œåœ¨ <code>drop</code> çš„æ—¶å€™å°±ä¸ä¼šæœ‰ä¸å¿…è¦çš„ <code>wake_one</code> çš„è°ƒç”¨äº†ã€‚</p><pre class="mermaid">sequenceDiagram    participant A as çº¿ç¨‹A (æŒæœ‰é”)    participant B as çº¿ç¨‹B (å°è¯•è·é”)    participant State as Mutex State    participant System as ç³»ç»Ÿè°ƒç”¨    Note over State: state = 1 (çº¿ç¨‹AæŒæœ‰é”)    B->>State: compare_exchange(0, 1)    State-->>B: å¤±è´¥ï¼Œè¿”å› s=1    Note over B: s == 1ï¼Œå°è¯•è®¾ç½®ç­‰å¾…è€…æ ‡å¿—    B->>State: compare_exchange(1, 2)    Note over State: state: 1 â†’ 2    State-->>B: æˆåŠŸ    B->>System: wait(&state, 2)    Note over B: çº¿ç¨‹Bè¿›å…¥ç­‰å¾…çŠ¶æ€    Note over A: çº¿ç¨‹Aå®Œæˆå·¥ä½œï¼Œé‡Šæ”¾é”    A->>State: unlock() - swap(0)    Note over State: state: 2 â†’ 0    State-->>A: è¿”å› 2    A->>System: wake_one()    Note over System: æ­£ç¡®å”¤é†’çº¿ç¨‹B    Note over B: çº¿ç¨‹Bè¢«å”¤é†’ï¼Œé‡æ–°å°è¯•è·å–é”    B->>State: compare_exchange(0, 1)    Note over State: state: 0 â†’ 1 (å…³é”®ï¼)    State-->>B: æˆåŠŸï¼é€€å‡ºå¾ªç¯    Note over B: ğŸ¯ è·å¾—é”ï¼Œstate=1 (æ­£ç¡®çŠ¶æ€)    Note over B: ä½¿ç”¨é”è¿›è¡Œå·¥ä½œ...    B->>State: unlock() - swap(0)    Note over State: state: 1 â†’ 0    State-->>B: è¿”å› 1 (ä¸æ˜¯2ï¼)    Note over B: âœ… è¿”å›å€¼æ˜¯1ï¼Œä¸è°ƒç”¨wake_one    Note over System: ğŸ¯ é¿å…äº†ä¸å¿…è¦çš„ç³»ç»Ÿè°ƒç”¨</pre><p>æˆ‘ä»¬é‡æ–°è¿è¡Œä¸Šé¢çš„æµ‹è¯•ç”¨ä¾‹ <code>cross_thread_should_work</code>ï¼Œå¯ä»¥çœ‹åˆ°åªè¾“å‡ºäº† 1 ä¸ª wake_oneï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">test mutex::tests::cross_thread_should_work ... ok</span><br><span class="line"></span><br><span class="line">successes:</span><br><span class="line"></span><br><span class="line">---- mutex::tests::cross_thread_should_work stdout ----</span><br><span class="line">wake_one</span><br></pre></td></tr></table></figure><blockquote><p>ä¸è¿‡ç¬”è€…åœ¨åš benchmark åå‘ç°ä¹¦ä¸­çš„å®ç°æ€§èƒ½å…¶å®æ›´é«˜ï¼Œåœ¨ macbook m2max æœºå™¨ä¸Šï¼Œä¹¦ä¸­çš„ç‰ˆæœ¬è¦æ¯”æˆ‘çš„ç‰ˆæœ¬å¿« 5~10% å·¦å³ï¼ŒçŒœæµ‹å¤§æ¦‚ç‡æ˜¯ <code>swap</code> çš„æ€§èƒ½è¦æ¯” <code>compare_exchange</code> é«˜ã€‚</p></blockquote><h2 id="v3ï¼šçŸ­æš‚è‡ªæ—‹è¿›ä¸€æ­¥é¿å…ç³»ç»Ÿè°ƒç”¨">v3ï¼šçŸ­æš‚è‡ªæ—‹è¿›ä¸€æ­¥é¿å…ç³»ç»Ÿè°ƒç”¨</h2><p>è¿˜æœ‰ä¸€ç§æ½œåœ¨çš„ä¼˜åŒ–æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æŠ¢é”å¤±è´¥ä¸”è¿”å› <code>state</code> ä¸º <code>1</code> çš„æ—¶å€™ï¼Œè¿›è¡ŒçŸ­æš‚çš„è‡ªæ—‹ï¼Œå¦‚æœå®é™…åœºæ™¯ä¸­å ç”¨é”çš„æ—¶é—´éå¸¸çŸ­ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥å†çœç•¥ä¸€æ¬¡ <code>wake</code> çš„ç³»ç»Ÿè°ƒç”¨äº†ã€‚</p><p>ä¸è¿‡å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™ç§ä¼˜åŒ–æœªå¿…æ˜¯æ­£å‘çš„ï¼Œä¸€æ–¹é¢ï¼Œå¦‚æœé”å ç”¨æ—¶é—´æ¯”è¾ƒé•¿ï¼Œé‚£å‰é¢çš„è‡ªæ—‹å°±ç™½ç™½æµªè´¹äº†ï¼Œå¦ä¸€æ–¹é¢ï¼Œè‡ªæ—‹çš„æ¬¡æ•°å¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—ï¼Œæœªå¿…å°±æ¯”ç³»ç»Ÿè°ƒç”¨è¦å°ï¼ˆä¸åŒçš„å¹³å°è¡¨ç°å¯èƒ½å¾ˆä¸ä¸€æ ·ï¼‰ã€‚</p><p>ä¹¦ä¸­ç»™å‡ºçš„ç»éªŒå€¼æ˜¯è‡ªé€‰ <strong>100</strong> æ¬¡ã€‚</p><p>ä¼˜åŒ–åçš„ <code>lock_contended</code> å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">lock_contended</span>(state: &amp;AtomicU32) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">spin_count</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">let</span> <span class="variable">Err</span>(s) = state.<span class="title function_ invoke__">compare_exchange</span>(<span class="number">0</span>, <span class="number">1</span>, Acquire, Relaxed) &#123;</span><br><span class="line">        <span class="keyword">if</span> s == <span class="number">1</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> spin_count &lt; <span class="number">100</span> &#123;</span><br><span class="line">                spin_count += <span class="number">1</span>;</span><br><span class="line">                std::hint::<span class="title function_ invoke__">spin_loop</span>();</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            _ = state.<span class="title function_ invoke__">compare_exchange</span>(<span class="number">1</span>, <span class="number">2</span>, Acquire, Relaxed);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">wait</span>(&amp;state, <span class="number">2</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥ä½¿ç”¨ <a href="https://bheisler.github.io/criterion.rs/book/getting_started.html">criterion</a> åšä¸€ä¸ª benchmark çœ‹çœ‹è‡ªæ—‹ä¸ä¹‹å‰çš„ç‰ˆæœ¬çš„æ€§èƒ½å·®å¼‚æœ‰å¤šå°‘ã€‚</p></blockquote><p>å®Œæ•´ä»£ç å¯å‚è€ƒï¼š<a href="https://github.com/hedon-rust-road/conutils/blob/main/src/mutex.rs">conutils/mutex</a>ã€‚</p><h2 id="æ€»ç»“">æ€»ç»“</h2><p>åœ¨æœ¬ç¯‡ä¸­ï¼Œæˆ‘ä»¬ä»é›¶å¼€å§‹ï¼Œç»“åˆ Rust åŸå­æ“ä½œå’Œå†…å­˜é¡ºåºçš„æ ¸å¿ƒçŸ¥è¯†ï¼Œå®ç°ä¸€ä¸ª Rust ä¸­çš„ Mutex é”ï¼Œé€æ­¥æ­ç¤º Mutex èƒŒåçš„ç­‰å¾…ä¸å”¤é†’æœºåˆ¶ï¼Œä¸ºæ›´å¥½ç†è§£æ ‡å‡†åº“ä¸­çš„ Mutex å¥ å®šäº†è‰¯å¥½çš„åŸºç¡€ã€‚ä¸‹ç¯‡ï¼Œæˆ‘ä»¬å°†å°è¯•æ‰‹å†™ä¸€ä¸ªæ¡ä»¶å˜é‡ <strong>Condition Variable</strong>ï¼</p><p>Happy Coding! Peace~</p>]]></content>
    
    
    <summary type="html">æœ¬æ–‡å¸¦ä½ ä»é›¶å¼€å§‹å®ç°ä¸€ä¸ª Rust ä¸­çš„ Mutex é”ï¼Œç»“åˆ Rust åŸå­æ“ä½œå’Œå†…å­˜é¡ºåºçš„æ ¸å¿ƒçŸ¥è¯†ï¼Œé€æ­¥æ­ç¤º Mutex èƒŒåçš„ç­‰å¾…ä¸å”¤é†’æœºåˆ¶ã€‚é€šè¿‡é˜…è¯»æœ¬æ–‡ï¼Œä½ ä¸ä»…å¯ä»¥æŒæ¡å¦‚ä½•ä½¿ç”¨ Rust çš„åŸå­ API å®ç°ä¸€ä¸ªé«˜æ•ˆçš„äº’æ–¥é”ï¼Œè¿˜èƒ½æ·±å…¥ç†è§£åŸå­æ“ä½œèƒŒåçš„å†…å­˜æ¨¡å‹ï¼Œä¸ºæŒæ¡æ›´å¤æ‚çš„å¹¶å‘ç¼–ç¨‹æŠ€å·§æ‰“ä¸‹åšå®åŸºç¡€ã€‚</summary>
    
    
    
    <category term="rust" scheme="https://hedon.top/categories/rust/"/>
    
    <category term="rust å®æˆ˜" scheme="https://hedon.top/categories/rust/rust-%E5%AE%9E%E6%88%98/"/>
    
    
    <category term="rust" scheme="https://hedon.top/tags/rust/"/>
    
    <category term="å¹¶å‘ç¼–ç¨‹" scheme="https://hedon.top/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>Rust åŸç†ä¸¨æ“ä½œç³»ç»Ÿå¹¶å‘åŸè¯­</title>
    <link href="https://hedon.top/2025/06/08/rust-os-primitives/"/>
    <id>https://hedon.top/2025/06/08/rust-os-primitives/</id>
    <published>2025-06-08T09:45:28.000Z</published>
    <updated>2025-06-08T18:37:11.805Z</updated>
    
    <content type="html"><![CDATA[<p>ç³»åˆ—æ–‡ç« ï¼š</p><ul><li><a href="https://hedon.top/2024/11/11/rust-memory-order/">Rust åŸç†ä¸¨èŠä¸€èŠ Rust çš„ Atomic å’Œå†…å­˜é¡ºåº</a></li><li><a href="https://hedon.top/2025/06/05/rust-atomic-in-processor/">Rust åŸç†ä¸¨ä»æ±‡ç¼–è§’åº¦çœ‹åŸå­æ“ä½œ</a></li><li><a href="https://hedon.top/2025/05/13/rust-action-spinlock/">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª SpinLock</a></li><li><a href="https://hedon.top/2025/05/29/rust-action-oneshot-channel/">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª oneshot channel</a></li><li><a href="https://hedon.top/2025/06/03/rust-action-arc/">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª Arc</a></li></ul><hr><p>åœ¨æœ¬ç³»åˆ—çš„å‰é¢æ‰€æœ‰ç¯‡ç« ä¸­ï¼Œæˆ‘ä»¬å¯¹éé˜»å¡ç±»çš„å¹¶å‘æ“ä½œè¿›è¡Œäº†è¯¦ç»†çš„é˜è¿°å’Œå®è·µï¼ˆé™¤äº† SpinLockï¼Œä¸è¿‡è‡ªæ—‹é”æ˜¯é€šè¿‡è‡ªæ—‹æ¥å®ç°é˜»å¡ä½œç”¨ï¼Œæœ¬è´¨ä¸Šçº¿ç¨‹å¹¶æ²¡æœ‰é™·å…¥é˜»å¡ç­‰å¾…çš„çŠ¶æ€ï¼‰ã€‚</p><p>åé¢æˆ‘ä»¬å°†ç»§ç»­å‚è€ƒ <a href="https://marabos.nl/atomics/">Rust Atomics and Locks</a> ä¹¦ä¸­çš„åç»­ç¯‡ç« ï¼Œç»§ç»­æ‰‹å†™å‡ ä¸ªé˜»å¡ç±»çš„å¹¶å‘å·¥å…·ï¼Œæœ‰ Mutexï¼ˆäº’æ–¥é”ï¼‰ã€RWMutexï¼ˆè¯»å†™é”ï¼‰å’Œ CondVarï¼ˆæ¡ä»¶å˜é‡ï¼‰ã€‚å®ƒä»¬éƒ½æœ‰ä¸€ä¸ªå…±åŒçš„ç‰¹ç‚¹ï¼š<strong>çº¿ç¨‹ä¼šé™·å…¥é˜»å¡ï¼Œè®©å‡º CPUï¼Œåœ¨ç­‰å¾…æŸä¸ªæ¡ä»¶æ»¡è¶³è¦æ±‚åï¼Œä¼šè¢«å”¤é†’å¹¶é‡æ–°è°ƒåº¦æ‰§è¡Œ</strong>ã€‚è¿™å°±éœ€è¦å€ŸåŠ©å†…æ ¸çš„èƒ½åŠ›äº†ï¼Œæˆ‘ä»¬éœ€è¦å†…æ ¸æ”¯æŒï¼š</p><ol><li>è®°ä½é‚£äº›é™·å…¥é˜»å¡çš„çº¿ç¨‹ï¼›</li><li>åœ¨æ»¡è¶³æ¡ä»¶åï¼Œèƒ½å¤Ÿå”¤é†’å¯¹åº”çš„æ­£ç¡®çš„çº¿ç¨‹ã€‚</li></ol><p>ç†Ÿæ‚‰æ“ä½œç³»ç»ŸåŸç†çš„è¯»è€…åº”è¯¥æ¸…æ¥šï¼Œæˆ‘ä»¬ç¼–å†™çš„åº”ç”¨ç¨‹åºï¼Œä¸€èˆ¬æ˜¯å¤„äº<strong>ç”¨æˆ·æ€</strong>ï¼Œè€Œæƒ³è¦è·Ÿå†…æ ¸è¿›è¡Œäº¤äº’ï¼Œéœ€è¦é™·å…¥<strong>å†…æ ¸æ€</strong>ï¼Œè€Œè¿™ç§åˆ‡æ¢ï¼Œå¾ˆå¤§ç¨‹åº¦éœ€è¦ä¾èµ–äºæ“ä½œç³»ç»Ÿæä¾›çš„ç³»ç»Ÿè°ƒç”¨èƒ½åŠ›ï¼Œå³ <code>syscall</code>ã€‚</p><p>æ‰€ä»¥åœ¨è¿›å…¥æ‰‹å†™ Mutexã€RWMutex å’Œ CondVar ç¯‡ç« ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆæ¥å­¦ä¹ ä¸€ä¸‹ï¼Œä¸åŒçš„æ“ä½œç³»ç»Ÿï¼Œéƒ½ä¸ºæˆ‘ä»¬åœ¨å¹¶å‘æ“ä½œä¸­æä¾›äº†ä»€ä¹ˆæ ·çš„èƒ½åŠ›å’Œé™åˆ¶ã€‚</p><p>åœ¨ <a href="https://marabos.nl/atomics/os-primitives.html">Rust Atomics and Locks</a>  ç¬¬å…«ç« ï¼ˆOperating System Primitivesï¼‰ä¸­ï¼Œä½œè€…ä»‹ç»å¹¶æ¯”è¾ƒäº†å„å¹³å°æä¾›çš„æ“ä½œç³»ç»Ÿçº§å¹¶å‘åŸè¯­ï¼ŒåŒ…æ‹¬ POSIX çš„ <code>pthread</code> ç³»åˆ—ã€Linux çš„ <code>futex</code>ã€macOS çš„ <code>os_unfair_lock</code>ï¼Œä»¥åŠ Windows çš„<code>é‡é‡çº§å†…æ ¸å¯¹è±¡</code>ã€<code>è½»é‡çº§å¯¹è±¡</code>å’Œ<code>åŸºäºåœ°å€çš„ç­‰å¾…æœºåˆ¶</code>ã€‚</p><p>åœ¨æœ¬ç¯‡ï¼Œç¬”è€…å°†åŸºäºè‡ªå·±çš„ç†è§£ï¼Œå°è¯•å¯¹è¿™ç« è¿›è¡Œæ¢³ç†å’Œæ€»ç»“ï¼Œä»¥ä¾¿ä¸ºåé¢çš„æ‰‹å†™å®è·µç¯‡ç« å¥ å®šä¸€ä¸ªè‰¯å¥½çš„ç†è®ºåŸºç¡€ï¼Œè¿™é‡Œè¿˜æ˜¯å»ºè®®è¯»è€…å»é˜…è¯»åŸæ–‡ï¼Œä»¥ä¾¿è·å¾—æ›´å¤šçš„ç»†èŠ‚ï¼ŒåŠ æ·±ç†è§£ã€‚</p><h1>POSIX çº¿ç¨‹åŸè¯­ pthread</h1><p>åœ¨ Unix ç±»æ“ä½œç³»ç»Ÿä¸­ï¼Œæ¯”å¦‚ Linuxï¼Œ<code>libc</code> å°±æ‰¿æ‹…äº†è·Ÿå†…æ ¸è¿›è¡Œäº¤äº’çš„æ ‡å‡†æ¥å£ã€‚åœ¨ <code>libc</code> çš„åŸºç¡€ä¹‹å‰ï¼Œè¯ç”Ÿäº†ä¸€ä¸ªæ ‡å‡†ï¼š<em>Portable Operationg System Interface</em>ï¼Œå³ç†ŸçŸ¥çš„ <strong>POSIX</strong>ã€‚åœ¨ Rust ä¸­ï¼Œå¯¹åº”äº† <a href="https://crates.io/crates/libc">libc</a> crateã€‚</p><p>Windows ç³»ç»Ÿå¹¶ä¸éµå¾ª POSIX æ ‡å‡†ï¼Œè€Œæ˜¯ä¸€ç³»åˆ—çš„ç³»ç»Ÿåº“æ¥æä¾›å†…æ ¸äº¤äº’èƒ½åŠ›ï¼Œæ¯”å¦‚ <a href="https://www.geoffchappell.com/studies/windows/win32/kernel32/api/index.htm">kernel32.dll</a>ã€‚</p><p>é’ˆå¯¹çº¿ç¨‹æ“ä½œï¼ŒPOSIX å®šä¹‰äº†ä¸€ç³»åˆ—çš„æ•°æ®ç±»å‹å’Œå‡½æ•°ï¼Œå³æ‰€è°“çš„ <strong>pthreads</strong>ã€‚å®ƒæä¾›äº†ä»¥ä¸‹å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å¹¶å‘åŸè¯­ï¼Œæˆ‘å°†å…¶å½’çº³ä¸ºä¸€ä¸ªè¡¨æ ¼ï¼Œä¾›ä½ å‚è€ƒã€‚</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250608190516988.png" alt=""></p><h1>Linuxï¼šFutex ç”¨æˆ·æ€ç­‰å¾…ä¸å”¤é†’</h1><p>åœ¨ Linux ä¸­ï¼Œæ‰€æœ‰ <code>pthread</code> åŸè¯­çš„å®ç°ï¼Œéƒ½æ˜¯é€šè¿‡ <strong>futex</strong> è¿™ä¸ªç³»ç»Ÿè°ƒç”¨ã€‚å®ƒæ˜¯å…¨ç¨‹æ˜¯ <em>fast user-space mutex</em>ã€‚å®ƒçš„å®ç°æ ¸å¿ƒæ˜¯ï¼š<strong>é€šè¿‡æ“ä½œä¸€ä¸ª 32 ä½çš„åŸå­å˜é‡æ¥å®ç°ç­‰å¾…å’Œå”¤é†’</strong>ã€‚ç­‰å¾…æ“ä½œä¼šå°†ä¸€ä¸ªçº¿ç¨‹é™·å…¥ç¡çœ ï¼Œè€Œå”¤é†’æ“ä½œä¼šå”¤é†’é‚£äº›æ“ä½œåŒä¸€ä¸ªåŸå­å˜é‡çš„ç¡çœ ä¸­çš„çº¿ç¨‹ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬ç®€å•è¿›è¡Œä¸€ä¸‹å±•å¼€ï¼Œæ€è€ƒä¸€ä¸‹è¿™ä¸ª <code>futex</code> è¿™ä¸ªåå­—çš„å«ä¹‰ï¼Œ<em>fast user-space mutex</em> ç¿»è¯‘æˆä¸­æ–‡å°±æ˜¯<em>å¿«é€Ÿç”¨æˆ·ç©ºé—´äº’æ–¥é”</em>ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œç³»ç»Ÿè°ƒç”¨çš„ä»£ä»·æ˜¯æ¯”è¾ƒæ˜‚è´µçš„ï¼Œéœ€è¦é¢‘ç¹åœ°åœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´è¿›è¡Œåˆ‡æ¢ï¼Œå¯¹æ€§èƒ½æ˜¯å¾ˆä¸å‹å¥½çš„ã€‚</p><p>åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œ<strong>futex</strong> æœºåˆ¶å¹¶éç‹¬ç«‹å­˜åœ¨ï¼Œè€Œæ˜¯ä¸äº’æ–¥é”ã€æ¡ä»¶å˜é‡ç­‰åŒæ­¥åŸè¯­ååŒå·¥ä½œï¼Œå½¢æˆ â€œ<strong>ç”¨æˆ·æ€è‡ªæ—‹ + å†…æ ¸æ€ç­‰å¾…</strong>â€ çš„åˆ†å±‚è®¾è®¡ï¼Œä»¥å…¼é¡¾æ€§èƒ½ä¸åŠŸèƒ½ã€‚</p><p>æ¯”å¦‚åœ¨ Mutex äº’æ–¥é”åœºæ™¯ä¸‹ï¼Œé‡‡ç”¨ â€œä¸¤çº§ç­‰å¾…â€ ç­–ç•¥ï¼š</p><ul><li><strong>ç”¨æˆ·æ€è‡ªæ—‹é˜¶æ®µ</strong>ï¼šå°è¯•è·å–é”æ—¶å…ˆé€šè¿‡åŸå­æ“ä½œï¼ˆå¦‚<code>atomic_compare_exchange</code>ï¼‰è‡ªæ—‹å°è¯•ï¼Œé¿å…å†…æ ¸è°ƒç”¨ã€‚</li><li><strong>å†…æ ¸æ€ç­‰å¾…é˜¶æ®µ</strong>ï¼šè‹¥è‡ªæ—‹å¤±è´¥ï¼Œé€šè¿‡ Futex çš„ <code>FUTEX_WAIT</code> é™·å…¥å†…æ ¸ï¼Œå°†çº¿ç¨‹æŒ‚èµ·ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹é€šè¿‡ <code>FUTEX_WAKE</code> å”¤é†’ã€‚</li></ul><p>è¿™æ ·å¤šæ•°çŸ­æ—¶é—´æŒé”åœºæ™¯å¯åœ¨ç”¨æˆ·æ€å®Œæˆï¼Œä»…åœ¨é•¿æ—¶é—´ç«äº‰æ—¶é™·å…¥å†…æ ¸ï¼Œç›¸æ¯”çº¯å†…æ ¸äº’æ–¥é”ï¼ˆå¦‚ spinlockï¼‰å¤§å¹…é™ä½ç³»ç»Ÿè°ƒç”¨å¼€é”€ã€‚</p><p>è¿™é‡Œæœ‰ä¸ªå¾ˆé‡è¦çš„ç‚¹ï¼š<strong>åˆ¤æ–­å’Œé™·å…¥ç­‰å¾…ï¼Œæ˜¯åŸå­çš„</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œçº¿ç¨‹ A åœ¨ç¡®å®šé™·å…¥ç­‰å¾…æ—¶ï¼Œå¦‚æœå…³è”çš„åŸå­å˜é‡å·²ç»å‘ç”Ÿäº†å˜åŒ–ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œä¸ä¼šé™·å…¥ç­‰å¾…ï¼Œè€Œæ˜¯ä¼šç›´æ¥è¿”å›ã€‚è¿™ä¹Ÿå°±é¿å…äº†å”¤é†’ä¿¡å·çš„ä¸¢å¤±ã€‚</p><p>è¿™é‡Œæˆ‘æ•´ç†äº† <strong>futex</strong> çš„æ ¸å¿ƒæ“ä½œï¼Œä¾›ä½ å‚è€ƒï¼š</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250608190538982.png" alt=""></p><h1>macOSï¼šå…¬å¹³çš„ pthread ä¸éå…¬å¹³çš„ os_unfair_lock</h1><p>åœ¨ macOS ä¸Šï¼Œçº¿ç¨‹/é”çš„å†…æ ¸ syscallsï¼ˆ<code>__psynch_*</code> ç­‰ï¼‰<strong>ä¸æ˜¯å…¬å¼€ç¨³å®š ABI</strong>ï¼Œå®˜æ–¹è¦æ±‚å¼€å‘è€…åªé€šè¿‡ <strong>LibSystem</strong>ï¼ˆlibc + libpthread + Objective-C/Swift runtime ç­‰ï¼‰æ¥è®¿é—®ï¼Œå®ƒä»¬éƒ½å®Œå…¨å®ç°äº† <code>pthread</code>ã€‚</p><p>ä¸è¿‡å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨ macOS 10.12 ç‰ˆæœ¬ä¹‹å‰ï¼ŒmacOS çš„ pthread lock é»˜è®¤éƒ½æ˜¯å…¬å¹³é”ï¼ˆfair locksï¼‰ï¼Œä¸è¿‡åœ¨ macOS 10.12 (Sierra, 2016)  èµ·æ–°å¢äº†  <a href="https://developer.apple.com/documentation/os/os_unfair_lock">os_unfair_lock</a>ï¼Œå®ƒæ˜¯ä¸€ä¸ªä¸å…¬å¹³ã€é˜»å¡å‹ã€ä½å¼€é”€çš„é”ï¼Œå–ä»£äº†å·²å¼ƒç”¨çš„ <code>OSSpinLock</code>ã€‚</p><p>éœ€è¦æ³¨æ„ï¼Œ<code>os_unfair_lock</code> æ²¡æœ‰æä¾›å¯¹åº”çš„æ¡ä»¶å˜é‡æˆ–è¯»å†™é”åŠŸèƒ½ ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨æ¡ä»¶ç­‰å¾…æˆ–è¯»å†™é”è¯­ä¹‰ï¼Œä»éœ€ä½¿ç”¨ <code>pthread_cond_t</code> æˆ– <code>pthread_rwlock_t</code> ç­‰ POSIX åŸè¯­ï¼Œæˆ–è€…ä½¿ç”¨æ›´é«˜å±‚çš„ GCDï¼ˆGrand Central Dispatchï¼‰å¹¶å‘æ¨¡å‹ã€‚Apple å°†<code>os_unfair_lock</code> å®šä½ä¸ºæ›¿ä»£æ—©æœŸçš„ <code>OSSpinLock</code> çš„ä½çº§é”ï¼Œä»¥è§£å†³ <code>OSSpinLock</code> å­˜åœ¨çš„ä¼˜å…ˆçº§åè½¬é—®é¢˜ï¼ŒåŒæ—¶æä¾›æ¯” <code>pthread_mutex</code> æ›´å¿«çš„æ€§èƒ½ã€‚<code>os_unfair_lock</code> å†…éƒ¨ä¼šåœ¨å¿…è¦æ—¶è®©å‡º CPU è€Œéè‡ªæ—‹ç­‰å¾…ï¼Œä»è€Œé¿å…é«˜ä¼˜å…ˆçº§çº¿ç¨‹é¥¥é¥¿ï¼Œä½†è°ƒåº¦ä¸Šåˆä¸åƒ <code>pthread_mutex</code> é‚£æ ·ä¸¥æ ¼ FIFOã€‚</p><h1>Windows</h1><p>Windows æä¾›äº†ä¸€ç³»åˆ—ç‹¬ç‰¹çš„å¹¶å‘åŸè¯­ï¼Œå¯åˆ†ä¸º<a href="https://learn.microsoft.com/en-us/windows/win32/sysinfo/kernel-objects">é‡é‡çº§å†…æ ¸å¯¹è±¡</a>ã€è½»é‡çº§å¯¹è±¡ï¼ˆå¦‚ <a href="https://learn.microsoft.com/en-us/windows/win32/sync/critical-section-objects">Critical Section</a>ã€<a href="https://learn.microsoft.com/en-us/windows/win32/sync/slim-reader-writer--srw--locks">SRW é”</a>ã€<a href="https://learn.microsoft.com/en-us/windows/win32/sync/condition-variables">Condition Variable æ¡ä»¶å˜é‡</a>ç­‰ï¼‰å’Œ<a href="https://learn.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-waitonaddress">åŸºäºåœ°å€çš„ç­‰å¾…æœºåˆ¶</a>ä¸‰å¤§ç±»ã€‚å®ƒä»¬åœ¨ API è®¾è®¡ã€ç”¨æ³•å’Œå®ç°ä¸Šå„ä¸ç›¸åŒï¼Œä½“ç°äº† Windows ä»æ—©æœŸåˆ°ç°ä»£çš„æ¼”è¿›ã€‚</p><h2 id="é‡é‡çº§å†…æ ¸å¯¹è±¡ï¼šåŸºäº-HANDLE-çš„-wait-ä¸-notify">é‡é‡çº§å†…æ ¸å¯¹è±¡ï¼šåŸºäº HANDLE çš„ wait ä¸ notify</h2><p>Windows çš„é‡é‡çº§åŒæ­¥åŸè¯­æ˜¯ç”±å†…æ ¸å®Œå…¨ç®¡ç†çš„å¯¹è±¡ï¼Œå…¸å‹ä»£è¡¨åŒ…æ‹¬ï¼š<strong>Mutex</strong>ï¼ˆäº’æ–¥é‡ï¼‰ã€<strong>Event</strong>ï¼ˆäº‹ä»¶ï¼‰ã€<strong>Semaphore</strong>ï¼ˆä¿¡å·é‡ï¼‰ã€<strong>WaitableTimer</strong>ï¼ˆå¯ç­‰å¾…è®¡æ—¶å™¨ï¼‰ç­‰ ã€‚è¿™äº›å¯¹è±¡é€šè¿‡ Windows API åˆ›å»ºï¼Œç›¸å½“äºåˆ›å»ºäº†ä¸€ä¸ªå†…æ ¸å¯¹è±¡å¥æŸ„ï¼ˆ<strong>HANDLE</strong>ï¼‰ï¼Œç±»ä¼¼æ‰“å¼€æ–‡ä»¶ä¼šå¾—åˆ°æ–‡ä»¶å¥æŸ„ä¸€æ · ã€‚æ¯ä¸ªå¯¹è±¡åœ¨å†…æ ¸æœ‰å¯¹åº”çš„æ•°æ®ç»“æ„ï¼Œæ“ä½œç³»ç»Ÿç»´æŠ¤å…¶çŠ¶æ€å’Œç­‰å¾…é˜Ÿåˆ—ã€‚å…·ä½“å¯ä»¥å‚è€ƒï¼š <a href="https://learn.microsoft.com/en-us/windows/win32/sysinfo/kernel-objects">é‡é‡çº§å†…æ ¸å¯¹è±¡</a>ã€‚</p><p>æˆ‘æ•´ç†äº†å®ƒä»¬çš„åŸºæœ¬ä½¿ç”¨æ–¹å¼ï¼Œä¾›ä½ å‚è€ƒï¼š</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250608192945913.png" alt=""></p><h2 id="è½»é‡çº§å¯¹è±¡ï¼šCriticalSectionã€SRWLock-ä¸-ConditionVariable">è½»é‡çº§å¯¹è±¡ï¼šCriticalSectionã€SRWLock ä¸ ConditionVariable</h2><p>&quot;è½»é‡çº§&quot;åŒæ­¥åŸè¯­æ˜¯æŒ‡<strong>ä¸ä»¥ç‹¬ç«‹å†…æ ¸å¯¹è±¡å½¢å¼å­˜åœ¨ã€ä¸»è¦åœ¨ç”¨æˆ·æ€è¿ä½œã€ä»…åœ¨å¿…è¦æ—¶è°ƒç”¨å†…æ ¸çš„æœºåˆ¶</strong>ã€‚</p><blockquote><p>æ˜¯ä¸æ˜¯å·²ç»å¼€å§‹æœ‰ç‚¹ futex çš„æ„Ÿè§‰äº†ï¼ŸğŸ¤­</p></blockquote><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250608224608594.png" alt=""></p><p><strong>CRITICAL_SECTION</strong></p><p>å®ƒå¹¶éé€šè¿‡ Create å‡½æ•°å¾—åˆ°å¥æŸ„ï¼Œè€Œæ˜¯å®šä¹‰ä¸ºç»“æ„ä½“ <code>CRITICAL_SECTION</code>ï¼Œéœ€è°ƒç”¨ <code>InitializeCriticalSection()</code> åˆå§‹åŒ–ï¼Œä¹‹åç›´æ¥ç”¨åœ°å€æ“ä½œã€‚æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªé€’å½’äº’æ–¥é”ï¼ŒåŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤šæ¬¡ <code>Enter</code>ï¼Œå†…éƒ¨æœ‰ä¸€ä¸ªé€’å½’è®¡æ•°ï¼Œå¿…é¡»å¯¹åº”æ¬¡æ•°çš„ <code>Leave</code> æ‰èƒ½å®Œå…¨é‡Šæ”¾ã€‚</p><p>Critical Section åœ¨æœªäº‰ç”¨æƒ…å†µä¸‹å°è¯•é€šè¿‡ç”¨æˆ·æ€ Atomic æ“ä½œè·å–ï¼Œæ¯”å¦‚ CAS äº¤æ¢ä¸ºå½“å‰çº¿ç¨‹ï¼ŒæˆåŠŸåˆ™è¿›å…¥ï¼Œå¤±è´¥åˆ™å¯èƒ½å…ˆè‡ªæ—‹å°è¯•ï¼Œä¾æ—§å¤±è´¥å†è¿›å…¥å†…æ ¸ç­‰å¾…ã€‚</p><p><strong>SRW Locks</strong></p><p>SRW Locks ä¸æ”¯æŒé€’å½’è·å–ï¼ŒåŒä¸€çº¿ç¨‹å¦‚æœæŒæœ‰å†™é”ï¼Œå†è¯·æ±‚å†™é”ä¼šæ­»é”ã€‚SRW ä¹‹æ‰€ä»¥è¢«ç§°ä¸º â€œslimâ€ é”ï¼Œæ˜¯å› ä¸ºå…¶å®ç°ç›¸å½“é«˜æ•ˆï¼Œæ— é”æ—¶è·å–å’Œé‡Šæ”¾éƒ½æ˜¯ç”¨æˆ·æ€çš„ Atomic æ“ä½œï¼Œå‘ç”Ÿäº‰ç”¨æ—¶ï¼Œå†…æ ¸ç”¨ä¸€ä¸ªä¼˜åŒ–çš„ç­‰å¾…æœºåˆ¶ç®¡ç†ç­‰å¾…é˜Ÿåˆ—ã€‚</p><p><strong>Condition Variable</strong></p><p>æ˜¯ <a href="https://wuu.wikipedia.org/wiki/Windows_Vista">Vista</a> æ—¶ä»£å¼•å…¥çš„æ–°åŸè¯­ï¼Œå®ƒå¿…é¡»æ­é… Critical Section æˆ– SWR Lock ä½¿ç”¨ã€‚</p><h2 id="åŸºäºåœ°å€çš„ç­‰å¾…æœºåˆ¶ï¼šWaitOnAddress">åŸºäºåœ°å€çš„ç­‰å¾…æœºåˆ¶ï¼šWaitOnAddress</h2><p>Windows åœ¨ 8 ç‰ˆï¼ˆ2012ï¼‰å¼•å…¥äº†å…¨æ–°çš„åº•å±‚åŒæ­¥æœºåˆ¶ï¼Œä¸ Linux futex éå¸¸ç›¸ä¼¼ï¼Œä¸»è¦å‡½æ•°æœ‰ï¼š</p><ul><li><code>WaitOnAddress(address, compare_address, _,_)</code>: è®©å½“å‰çº¿ç¨‹åœ¨ address æŒ‡å‘çš„å†…å­˜å€¼æ»¡è¶³ç‰¹å®šæ¡ä»¶å‰è¿›å…¥ç¡çœ ï¼Œå‡½æ•°ä¼šå°† address å¤„æä¾›çš„å€¼å’Œ compare_address æé«˜çš„å€¼é€å­—èŠ‚æ¯”è¾ƒï¼Œå¦‚æœå…¨ç­‰ï¼Œåˆ™çº¿ç¨‹ç¡çœ ï¼Œç­‰å¾…åç»­å”¤é†’ï¼Œå¦‚æœä¸ç­‰ï¼Œå‡½æ•°ç«‹å³è¿”å›ã€‚ä¸ futex_wait ç›¸åŒï¼Œ<strong>æ¯”è¾ƒä¸ç¡çœ æ˜¯ä¸€ä¸ªåŸå­æ“ä½œ</strong>ï¼šåœ¨æ£€æŸ¥å†…å­˜å€¼ä¸æœŸæœ›å€¼å†³å®šä¼‘çœ çš„è¿‡ç¨‹ä¸­ï¼Œè‹¥æœ‰å…¶ä»–çº¿ç¨‹æ”¹å˜äº† address æˆ–å‘èµ·å”¤é†’ï¼Œç³»ç»Ÿä¼šä¿è¯ä¸æ¼æ‰ä¿¡å·ã€‚</li><li><code>WakeByAddressSingle(address)</code>: å”¤é†’åœ¨æŒ‡å®šåœ°å€ä¸Šç­‰å¾…çš„ä¸€ä¸ªçº¿ç¨‹ã€‚</li><li><code>WakeByAddressAll(address)</code>: å”¤é†’åœ¨æŒ‡å®šåœ°å€ä¸Šç­‰å¾…çš„æ‰€æœ‰çº¿ç¨‹ã€‚</li></ul><p>åœ¨å®ç°ä¸Šï¼ŒWaitOnAddress éå¸¸è½»é‡ï¼Œæ²¡æœ‰æ˜¾å¼çš„å†…å­˜å¯¹è±¡æˆ–å¥æŸ„ã€‚å½“çº¿ç¨‹ç­‰å¾…æ—¶ï¼Œå†…æ ¸åªæ˜¯å°†çº¿ç¨‹æ”¾å…¥ä¸é‚£å—å†…å­˜åœ°å€ç›¸å…³è”çš„ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œå”¤é†’æ—¶æ ¹æ®åœ°å€æ‰¾åˆ°ç­‰å¾…çº¿ç¨‹åˆ—è¡¨è¿›è¡Œå”¤é†’ã€‚</p><h1>æ€»ç»“</h1><p>é€šè¿‡å¯¹ 3 ä¸ªä¸åŒçš„æ“ä½œç³»ç»Ÿçš„åˆ†æï¼Œä»å¤§çš„è§’åº¦æ¥è®²ï¼Œæˆ‘ä»¬ä¼šå‘ç°å®ƒä»¬çš„å¹¶å‘åŸè¯­æœ€é‡è¦çš„å°±æ˜¯è¦åˆ©ç”¨åŸå­å˜é‡ï¼Œåœ¨ç”¨æˆ·æ€å®ç° 3 ä¸ªæ“ä½œï¼Œä»¥å‡å°‘ç³»ç»Ÿè°ƒç”¨çš„å‡ºç°ï¼Œè¿›ä¸€æ­¥æå‡æ€§èƒ½ã€‚è¿™ 3 ä¸ªæ“ä½œå¯ä»¥å½’çº³ä¸ºï¼š</p><ul><li><strong>wait(&amp;AtomicU32)</strong>: ç­‰å¾…ç›´åˆ°åŸå­å˜é‡ä¸ç­‰äºæŒ‡å®šçš„å€¼ã€‚</li><li><strong>wake_one(&amp;AtomicU32)</strong>: å”¤é†’æŸä¸ª <code>wait()</code> åœ¨å½“å‰å˜é‡çš„çº¿ç¨‹ã€‚</li><li><strong>wake_all(&amp;AtomicU32)</strong>: å”¤é†’æ‰€æœ‰ <code>wait()</code> åœ¨å½“å‰å˜é‡çš„çº¿ç¨‹ã€‚</li></ul><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250608232051766.png" alt=""></p><p>æ‰€ä»¥ä¸‹ä¸€æ­¥å¦‚æœæˆ‘ä»¬æƒ³åœ¨ç¼–ç¨‹è¯­è¨€çš„å±‚é¢ä¸Šï¼ˆRustï¼‰å®ç°è‡ªå·±çš„ <code>Mutex</code>ã€<code>REMutex</code> å’Œ <code>CondVar</code>ï¼Œç¬¬ä¸€æ­¥å°±æ˜¯éœ€è¦é’ˆå¯¹ä¸åŒçš„æ“ä½œç³»ç»Ÿå®ç°ä¸€å¥— <code>wait/wake_one/wake_all</code> ä»¥å±è”½ä¸åŒæ“ä½œç³»ç»Ÿçš„å®ç°å·®å¼‚ï¼Œå¹¸è¿çš„æ˜¯ <a href="https://marabos.nl/atomics/">Rust Atomics and Locks</a> çš„ä½œè€… <a href="https://github.com/m-ou-se">Mara Bos</a> å·²ç»å¸®æˆ‘ä»¬å®ç°å¥½äº†ï¼š<a href="https://github.com/m-ou-se/atomic-wait">atomic-wait</a>ã€‚ä¸‹ç¯‡ï¼Œæˆ‘ä»¬å°±åˆ©ç”¨è¿™ä¸ª crateï¼Œæ¥ä¸€æ­¥æ­¥æ‰‹å†™ä¸€ä¸ªè‡ªå·±çš„ <code>Mutex</code>ï¼</p><p>Happy Coding! Peace~</p>]]></content>
    
    
    <summary type="html">æ“ä½œç³»ç»Ÿçš„å¹¶å‘åŸè¯­æ˜¯å®ç°å„ç§é”ã€æ¡ä»¶å˜é‡å’ŒåŒæ­¥å·¥å…·çš„æ ¸å¿ƒåŸºç¡€ã€‚æ— è®ºæ˜¯ Linux ä¸­è¢«å¹¿æ³›ä½¿ç”¨çš„ futexã€macOS ä¸­çš„ pthread å’Œ os_unfair_lockï¼Œè¿˜æ˜¯ Windows ç³»ç»Ÿä¸Šçš„é‡é‡çº§å†…æ ¸å¯¹è±¡ã€è½»é‡çº§åŸè¯­åŠåœ°å€ç­‰å¾…æœºåˆ¶ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯å›´ç»•ç€ä¸‰ä¸ªåŸºæœ¬åŠ¨ä½œå±•å¼€ï¼šwaitã€wake_one å’Œ wake_allã€‚æœ¬æ–‡å°†é€šè¿‡å¯¹ä¸‰å¤§ä¸»æµæ“ä½œç³»ç»Ÿåº•å±‚å¹¶å‘åŸè¯­çš„æ¢³ç†ä¸å¯¹æ¯”ï¼Œå¸®åŠ©ä½ å»ºç«‹ç»Ÿä¸€çš„è®¤çŸ¥æ¡†æ¶ï¼Œæ›´æ·±å…¥åœ°ç†è§£å¹¶å‘ç¼–ç¨‹èƒŒåçš„ç³»ç»Ÿçº§æ”¯æŒï¼Œé¿å…åœ¨å®è·µå’Œå­¦ä¹ ä¸­è¢«äº”èŠ±å…«é—¨çš„æ¦‚å¿µææ™•ã€‚</summary>
    
    
    
    <category term="rust" scheme="https://hedon.top/categories/rust/"/>
    
    <category term="rust åŸç†" scheme="https://hedon.top/categories/rust/rust-%E5%8E%9F%E7%90%86/"/>
    
    
    <category term="rust" scheme="https://hedon.top/tags/rust/"/>
    
    <category term="å¹¶å‘ç¼–ç¨‹" scheme="https://hedon.top/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"/>
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="https://hedon.top/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
  </entry>
  
  <entry>
    <title>Rust åŸç†ä¸¨ä»æ±‡ç¼–è§’åº¦çœ‹åŸå­æ“ä½œ</title>
    <link href="https://hedon.top/2025/06/05/rust-atomic-in-processor/"/>
    <id>https://hedon.top/2025/06/05/rust-atomic-in-processor/</id>
    <published>2025-06-05T00:36:03.000Z</published>
    <updated>2025-06-07T08:04:23.225Z</updated>
    
    <content type="html"><![CDATA[<p>ç³»åˆ—æ–‡ç« ï¼š</p><ul><li><a href="https://hedon.top/2024/11/11/rust-memory-order/">Rust åŸç†ä¸¨èŠä¸€èŠ Rust çš„ Atomic å’Œå†…å­˜é¡ºåº</a></li><li><a href="https://hedon.top/2025/05/13/rust-action-spinlock/">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª SpinLock</a></li><li><a href="https://hedon.top/2025/05/29/rust-action-oneshot-channel/">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª oneshot channel</a></li><li><a href="https://hedon.top/2025/06/03/rust-action-arc/">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª Arc</a></li></ul><hr><p>ç»§ä¸Šç¯‡ <a href="https://hedon.top/2024/11/11/rust-memory-order/">Rust åŸç†ä¸¨èŠä¸€èŠ Rust çš„ Atomic å’Œå†…å­˜é¡ºåº</a>ï¼Œæˆ‘ä»¬è¯¦ç»†ä»‹ç»äº† Rust ä¸­çš„åŸå­æ“ä½œåŠå†…å­˜é¡ºåºå’Œå†…å­˜å±éšœçš„è¯¸å¤šæ¦‚å¿µã€‚æˆ‘ä»¬çŸ¥é“ï¼Œä¹‹æ‰€ä»¥è¦åœ¨ç¡¬ä»¶å±‚é¢ä¹‹ä¸Šçš„ç¼–ç¨‹è¯­è¨€ä¸­ï¼ŒæŠ½è±¡å‡ºè¿™äº›é¡¶å±‚æ¦‚å¿µï¼Œæ˜¯ä¸ºå±è”½åº•å±‚ç¡¬ä»¶çš„å·®å¼‚ã€‚é‚£ä¹ˆæœ¬ç¯‡ï¼Œæˆ‘ä»¬å°±å°è¯•ä»æ±‡ç¼–ä»£ç å’Œç¡¬ä»¶å±‚é¢æ¥åˆ†æåœ¨ä¸åŒçš„è®¡ç®—æœºæ¶æ„ä¸‹è¿™äº›æ¦‚å¿µæ˜¯å¦‚ä½•è¢«å®ç°çš„ï¼Œå®ƒä»¬ä¹‹é—´å°±æœ‰å“ªäº›å…·ä½“çš„å·®å¼‚ã€‚</p><p>åœ¨å±•å¼€ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥å¤ä¹ ä¸€ä¸‹ Rust ä¸­çš„å†…å­˜é¡ºåºå’Œå†…å­˜å±éšœã€‚</p><p>Rust æ”¯æŒäº”ç§å†…å­˜é¡ºåºï¼ˆOrderingï¼‰ï¼Œä»æœ€æ¾æ•£åˆ°æœ€ä¸¥æ ¼ä¾æ¬¡ä¸ºï¼š</p><table><thead><tr><th>å†…å­˜é¡ºåº</th><th>è¯´æ˜</th><th>ä¿è¯</th><th>é€‚ç”¨åœºæ™¯</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>Relaxed</td><td>æœ€å®½æ¾çš„å†…å­˜é¡ºåº</td><td>- ä»…ä¿è¯æ“ä½œçš„åŸå­æ€§<br>- ä¸æä¾›ä»»ä½•åŒæ­¥ä¿è¯<br>- ä¸å»ºç«‹ happens-before å…³ç³»</td><td>- ç®€å•è®¡æ•°å™¨<br>- æ€§èƒ½è¦æ±‚æé«˜ä¸”ç¡®å®šä¸éœ€è¦åŒæ­¥<br>- å·²é€šè¿‡å…¶ä»–æ–¹å¼ç¡®ä¿åŒæ­¥</td><td><code>counter.fetch_add(1, Ordering::Relaxed)</code></td></tr><tr><td>Release</td><td>ç”¨äºå­˜å‚¨æ“ä½œ</td><td>- ä¹‹å‰çš„å†…å­˜è®¿é—®ä¸ä¼šè¢«é‡æ’åˆ°æ­¤æ“ä½œä¹‹å<br>- ä¸ Acquire é…å¯¹ä½¿ç”¨å¯å»ºç«‹ happens-before å…³ç³»</td><td>- ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼<br>- å‘å¸ƒå…±äº«æ•°æ®<br>- åˆå§‹åŒ–å®Œæˆæ ‡å¿—</td><td><code>data.store(42, Ordering::Release)</code></td></tr><tr><td>Acquire</td><td>ç”¨äºåŠ è½½æ“ä½œ</td><td>- ä¹‹åçš„å†…å­˜è®¿é—®ä¸ä¼šè¢«é‡æ’åˆ°æ­¤æ“ä½œä¹‹å‰<br>- ä¸ Release é…å¯¹ä½¿ç”¨å¯å»ºç«‹ happens-before å…³ç³»</td><td>- ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼<br>- è·å–å…±äº«æ•°æ®<br>- æ£€æŸ¥åˆå§‹åŒ–æ ‡å¿—</td><td><code>data.load(Ordering::Acquire)</code></td></tr><tr><td>AcqRel</td><td>åŒæ—¶åŒ…å« Acquire å’Œ Release è¯­ä¹‰</td><td>- ç»“åˆäº† Acquire å’Œ Release çš„æ‰€æœ‰ä¿è¯<br>- ç”¨äºè¯»æ”¹å†™æ“ä½œ</td><td>- éœ€è¦åŒå‘åŒæ­¥çš„åŸå­æ“ä½œ<br>- é”çš„å®ç°<br>- å¤æ‚çš„åŒæ­¥åŸè¯­</td><td><code>value.fetch_add(1, Ordering::AcqRel)</code></td></tr><tr><td>SeqCst</td><td>æœ€ä¸¥æ ¼çš„å†…å­˜é¡ºåº</td><td>- åŒ…å« AcqRel çš„æ‰€æœ‰ä¿è¯<br>- æ‰€æœ‰çº¿ç¨‹çœ‹åˆ°çš„æ‰€æœ‰ SeqCst æ“ä½œé¡ºåºä¸€è‡´<br>- æä¾›å…¨å±€çš„é¡ºåºä¸€è‡´æ€§</td><td>- éœ€è¦ä¸¥æ ¼çš„å…¨å±€é¡ºåº<br>- ä¸ç¡®å®šä½¿ç”¨å“ªç§é¡ºåºæ—¶<br>- å¯¹æ€§èƒ½è¦æ±‚ä¸é«˜çš„åœºæ™¯</td><td><code>flag.store(true, Ordering::SeqCst)</code></td></tr></tbody></table><p>å†…å­˜å±éšœä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ç§ç±»å‹ï¼š</p><ol><li><p><strong>Load Barrierï¼ˆè¯»å±éšœï¼‰</strong></p><ul><li>ç¡®ä¿åœ¨å±éšœä¹‹å‰çš„æ‰€æœ‰è¯»æ“ä½œéƒ½æ‰§è¡Œå®Œæˆ</li><li>é˜²æ­¢åç»­è¯»æ“ä½œè¢«é‡æ’åˆ°å±éšœä¹‹å‰</li><li>å¯¹åº” Acquire è¯­ä¹‰</li></ul></li><li><p><strong>Store Barrierï¼ˆå†™å±éšœï¼‰</strong></p><ul><li>ç¡®ä¿åœ¨å±éšœä¹‹å‰çš„æ‰€æœ‰å†™æ“ä½œéƒ½æ‰§è¡Œå®Œæˆ</li><li>é˜²æ­¢åç»­å†™æ“ä½œè¢«é‡æ’åˆ°å±éšœä¹‹å‰</li><li>å¯¹åº” Release è¯­ä¹‰</li></ul></li><li><p><strong>Full Barrierï¼ˆå…¨å±éšœï¼‰</strong></p><ul><li>åŒæ—¶åŒ…å«è¯»å±éšœå’Œå†™å±éšœçš„åŠŸèƒ½</li><li>é˜²æ­¢ä»»ä½•å†…å­˜æ“ä½œçš„é‡æ’åº</li><li>å¯¹åº” SeqCst è¯­ä¹‰</li></ul></li></ol><h1>è¯»å®Œæœ¬ç¯‡ä½ èƒ½å­¦åˆ°ä»€ä¹ˆ</h1><ol><li><p><strong>æ±‡ç¼–åˆ†æèƒ½åŠ›</strong>ï¼šæŒæ¡ä» Rust ä»£ç åˆ°æ±‡ç¼–æŒ‡ä»¤çš„å®Œæ•´åˆ†æé“¾è·¯ï¼Œèƒ½å¤Ÿä½¿ç”¨ <code>cargo-show-asm</code> æˆ– Compiler Explorer ç­‰å·¥å…·æ·±å…¥ç†è§£ä»£ç çš„åº•å±‚å®ç°ã€‚</p></li><li><p><strong>è·¨å¹³å°å·®å¼‚æ´å¯Ÿ</strong>ï¼šæ·±åˆ»ç†è§£ x86-64ï¼ˆCISCï¼‰ä¸ ARM64ï¼ˆRISCï¼‰ä¸¤å¤§ä¸»æµæ¶æ„åœ¨åŸå­æ“ä½œå®ç°ä¸Šçš„æœ¬è´¨å·®å¼‚ï¼Œä¸ºæ€§èƒ½ä¼˜åŒ–å’Œå¹³å°é€‚é…æä¾›ç†è®ºåŸºç¡€ã€‚</p></li><li><p><strong>å†…å­˜é¡ºåºé€‰æ‹©ç­–ç•¥</strong>ï¼šä¸å†éœ€è¦æ­»è®°ç¡¬èƒŒäº”ç§å†…å­˜é¡ºåºï¼Œè€Œæ˜¯åŸºäºç¡¬ä»¶ç‰¹æ€§å’Œæ€§èƒ½è€ƒé‡åšå‡ºæ˜æ™ºé€‰æ‹© â€”â€” çŸ¥é“ä½•æ—¶ç”¨ <code>Relaxed</code> è¿½æ±‚æè‡´æ€§èƒ½ï¼Œä½•æ—¶å¿…é¡»ä¸Š <code>SeqCst</code> ä¿è¯æ­£ç¡®æ€§ã€‚</p></li><li><p><strong>åŸå­æ€§ä¿è¯æœºåˆ¶</strong>ï¼šç†è§£ä¸ºä»€ä¹ˆåŒæ ·çš„æ±‡ç¼–ä»£ç ï¼Œæ™®é€šæ“ä½œä¸åŸå­æ“ä½œåœ¨ç¼–è¯‘å™¨å±‚é¢æœ‰æœ¬è´¨åŒºåˆ«ï¼Œä»¥åŠå¯¹é½è®¿é—®ä¸è·¨ç¼“å­˜è¡Œè®¿é—®çš„ä¸åŒè¡Œä¸ºã€‚</p></li><li><p><strong>ç¡¬ä»¶åè®®åŸç†</strong>ï¼šæŒæ¡ MESI ç¼“å­˜ä¸€è‡´æ€§åè®®ã€x86 çš„ <code>lock</code> æœºåˆ¶ã€ARM çš„ <code>LL/SC</code> æœºåˆ¶ç­‰åº•å±‚å®ç°åŸç†ï¼Œèƒ½å¤Ÿè§£é‡Šå¤šæ ¸ç¯å¢ƒä¸‹çš„æ•°æ®åŒæ­¥è¿‡ç¨‹ã€‚</p></li><li><p><strong>æ€§èƒ½ä¼˜åŒ–æ´å¯Ÿ</strong>ï¼šç†è§£ä¸åŒæ¶æ„ä¸‹å†…å­˜å±éšœçš„å¼€é”€å·®å¼‚ï¼Œä¸ºé«˜æ€§èƒ½å¹¶å‘ä»£ç æä¾›ä¼˜åŒ–æ–¹å‘ï¼ˆå¦‚ ARM64 ä¸Š <code>compare_exchange_weak</code> çš„çœŸå®ä¼˜åŠ¿ï¼‰ã€‚</p></li><li><p><strong>å¹¶å‘é—®é¢˜è°ƒè¯•</strong>ï¼šå½“é‡åˆ°å¹¶å‘ bug æ—¶ï¼Œèƒ½å¤Ÿä»æ±‡ç¼–å±‚é¢åˆ†æé—®é¢˜æ ¹å› ï¼Œåˆ¤æ–­æ˜¯å†…å­˜é¡ºåºé—®é¢˜è¿˜æ˜¯åŸå­æ€§é—®é¢˜ã€‚</p></li><li><p><strong>æ¶æ„é€‚é…èƒ½åŠ›</strong>ï¼šåœ¨è·¨å¹³å°å¼€å‘ä¸­ï¼Œèƒ½å¤Ÿé’ˆå¯¹ä¸åŒæ¶æ„çš„ç‰¹æ€§ï¼ˆå¦‚ x86-64 çš„å¼ºé¡ºåº vs ARM64 çš„å¼±é¡ºåºï¼‰åšå‡ºç›¸åº”çš„ä»£ç è°ƒæ•´ã€‚</p></li><li><p><strong>é”ä¸æ— é”æ•°æ®ç»“æ„è®¾è®¡</strong>ï¼šåŸºäºç¡¬ä»¶åŸç†è®¾è®¡é«˜æ•ˆçš„åŒæ­¥åŸè¯­ï¼Œç†è§£ä½•æ—¶é€‰æ‹©åŸºäº CAS çš„æ— é”ç®—æ³•ï¼Œä½•æ—¶é€‰æ‹©ä¼ ç»Ÿé”æœºåˆ¶ã€‚</p></li></ol><p>åœ¨è¿›å…¥æ±‡ç¼–ä»£ç çš„ä¸–ç•Œä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆç®€å•è¡¥å…… 2 ä¸ªé‡è¦æ¦‚å¿µï¼Œåˆ†åˆ«æ˜¯<strong>æŒ‡ä»¤é›†</strong>å’Œ CPU ç¼“å­˜ä¸€è‡´æ€§åè®® <strong>MESI</strong>ã€‚</p><h1>æŒ‡ä»¤é›†</h1><p>ä¸¤ç§æŒ‡ä»¤é›†ï¼š</p><ul><li>CISCï¼ˆComplex Instruction Set Computingï¼Œå¤æ‚æŒ‡ä»¤é›†ï¼‰</li><li>RISCï¼ˆReduced Instruction Set Computingï¼Œç²¾ç®€æŒ‡ä»¤é›†ï¼‰</li></ul><p>äºŒè€…å¯¹æ¯”ï¼š</p><table><thead><tr><th style="text-align:left">ç‰¹å¾</th><th style="text-align:left">RISC</th><th style="text-align:left">CISC</th></tr></thead><tbody><tr><td style="text-align:left">æŒ‡ä»¤é›†</td><td style="text-align:left">ç²¾ç®€ï¼ŒæŒ‡ä»¤æ•°ç›®å°‘</td><td style="text-align:left">å¤æ‚ï¼ŒæŒ‡ä»¤æ•°ç›®å¤š</td></tr><tr><td style="text-align:left">æŒ‡ä»¤å¤æ‚æ€§</td><td style="text-align:left">æŒ‡ä»¤ç®€å•ï¼Œæ¯æ¡æŒ‡ä»¤æ‰§è¡Œå•ä¸€åŠŸèƒ½</td><td style="text-align:left">æŒ‡ä»¤å¤æ‚ï¼Œå¯ä»¥æ‰§è¡Œå¤šä¸ªåŠŸèƒ½</td></tr><tr><td style="text-align:left">å¯»å€æ–¹å¼</td><td style="text-align:left">ç®€å•å¯»å€æ–¹å¼</td><td style="text-align:left">å¤æ‚å¯»å€æ–¹å¼</td></tr><tr><td style="text-align:left">ç¡¬ä»¶å®ç°</td><td style="text-align:left">æ˜“äºå®ç°</td><td style="text-align:left">å®ç°å¤æ‚</td></tr><tr><td style="text-align:left">ç¼–è¯‘å™¨</td><td style="text-align:left">é«˜æ•ˆç¼–è¯‘å™¨</td><td style="text-align:left">ç¼–è¯‘å™¨æ•ˆç‡ç›¸å¯¹è¾ƒä½</td></tr><tr><td style="text-align:left">è¿ç®—é€Ÿåº¦</td><td style="text-align:left">å¿«é€Ÿ</td><td style="text-align:left">ç›¸å¯¹æ…¢</td></tr></tbody></table><blockquote><p>å…·ä½“å¯å‚è€ƒï¼š<a href="https://cs.stanford.edu/people/eroberts/courses/soco/projects/risc/risccisc/">risc vs. cisc</a>ã€‚</p></blockquote><p>ä¸¤ç§æŒ‡ä»¤é›†åˆ†åˆ«å¯¹åº”ä¸¤ç§æœ€å…¸å‹çš„è®¡ç®—æœºæ¶æ„ï¼š</p><ul><li><strong>x86-64</strong>ï¼š<strong>åŸºäº CISCï¼ˆå¤æ‚æŒ‡ä»¤é›†ï¼‰çš„ 64 ä½æ‰©å±•æ¶æ„</strong>ï¼Œç”± AMD è®¾è®¡å¹¶ä¸»å¯¼ï¼Œå…¼å®¹ x86 32 ä½ç”Ÿæ€ï¼Œé€šè¿‡ç¡¬ä»¶å¤æ‚æ€§æ¢å–é«˜æ€§èƒ½ä¸å¹¿æ³›å…¼å®¹æ€§ï¼Œä¸»å¯¼æ¡Œé¢ä¸æœåŠ¡å™¨é¢†åŸŸã€‚</li><li><strong>arm64</strong>ï¼š<strong>åŸºäº RISCï¼ˆç²¾ç®€æŒ‡ä»¤é›†ï¼‰çš„ 64 ä½æ¶æ„</strong>ï¼Œç”± ARM è®¾è®¡ï¼Œä»¥ç²¾ç®€æŒ‡ä»¤ã€é«˜èƒ½æ•ˆä¸ºæ ¸å¿ƒï¼ŒåŸç”Ÿæ”¯æŒä½åŠŸè€—åœºæ™¯ï¼Œä¸»å¯¼ç§»åŠ¨è®¾å¤‡å¹¶é€æ­¥æ‰©å±•è‡³æœåŠ¡å™¨ä¸ PC é¢†åŸŸã€‚</li></ul><p>åœ¨æœ¬ç¯‡ä¸­ï¼Œæˆ‘ä»¬åªæ¶‰åŠ 2 ä¸ªå¹³å°ï¼š</p><ul><li>x86_64-unknown-linux-muslï¼ˆä»¥ä¸‹ç®€ç§° x86-64ï¼‰</li><li>aarch64-unknown-linux-muslï¼ˆä»¥ä¸‹ç®€ç§° ARM64ï¼‰</li></ul><p>è¦å°† Rust ä»£ç ç¼–è¯‘ä¸ºæŒ‡å®šå¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼š</p><ol><li><p>å®‰è£…å¯¹åº”çš„ç›®æ ‡å¹³å°</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rustup target add x86_64-unknown-linux-musl  # x86-64</span><br><span class="line">rustup target add aarch64-unknown-linux-musl # ARM64</span><br></pre></td></tr></table></figure></li><li><p>ç¼–è¯‘æ—¶ä½¿ç”¨ <code>--target</code> æ ‡å¿—</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cargo build --release --target x86_64-unknown-linux-musl</span><br><span class="line">cargo build --release --target aarch64-unknown-linux-musl</span><br></pre></td></tr></table></figure></li></ol><h1>ç¼“å­˜ä¸€è‡´æ€§åè®® MESI</h1><p>åœ¨å¤šæ ¸ç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªæ ¸å¿ƒéƒ½æœ‰è‡ªå·±çš„ç¼“å­˜ï¼ˆL1/L2 Cacheï¼‰ï¼Œè€Œå†…å­˜ä¸­çš„æ•°æ®å¯èƒ½è¢«å¤šä¸ªæ ¸å¿ƒåŒæ—¶è¯»å–æˆ–ä¿®æ”¹ã€‚å¦‚æœä¸åŠ æ§åˆ¶ï¼Œä¼šå¯¼è‡´ä»¥ä¸‹é—®é¢˜ï¼š</p><ul><li><strong>ç¼“å­˜ä¸ä¸€è‡´ï¼ˆCache Coherence Problemï¼‰</strong>ï¼šä¸åŒæ ¸å¿ƒçš„ç¼“å­˜å¯èƒ½æŒæœ‰åŒä¸€å†…å­˜åœ°å€çš„ä¸åŒå‰¯æœ¬ã€‚</li><li><strong>è„æ•°æ®ï¼ˆDirty Dataï¼‰</strong>ï¼šæŸä¸ªæ ¸å¿ƒä¿®æ”¹äº†æ•°æ®ï¼Œä½†å…¶ä»–æ ¸å¿ƒä»ä½¿ç”¨æ—§å€¼ã€‚</li></ul><p>MESIï¼ˆ<strong>Modified, Exclusive, Shared, Invalid</strong>ï¼‰æ˜¯ä¸€ç§å¹¿æ³›ä½¿ç”¨çš„ <strong>ç¼“å­˜ä¸€è‡´æ€§åè®®</strong>ï¼ˆCache Coherence Protocolï¼‰ï¼Œç”¨äºç¡®ä¿å¤šæ ¸å¤„ç†å™¨ç³»ç»Ÿä¸­å„ä¸ªæ ¸å¿ƒçš„ç¼“å­˜æ•°æ®ä¿æŒä¸€è‡´ã€‚å®ƒå®šä¹‰äº†ç¼“å­˜è¡Œçš„ <strong>4 ç§çŠ¶æ€</strong>ï¼Œå¹¶é€šè¿‡çŠ¶æ€è½¬æ¢å’Œæ¶ˆæ¯ä¼ é€’æœºåˆ¶æ¥åè°ƒå¤šæ ¸é—´çš„æ•°æ®è®¿é—®ã€‚</p><table><thead><tr><th style="text-align:center">çŠ¶æ€</th><th style="text-align:left">å«ä¹‰</th><th style="text-align:left">ç‰¹ç‚¹</th></tr></thead><tbody><tr><td style="text-align:center"><strong>M (Modified)</strong></td><td style="text-align:left">å½“å‰æ ¸å¿ƒç‹¬å æ­¤æ•°æ®ï¼Œä¸”å·²ä¿®æ”¹ï¼ˆä¸å†…å­˜ä¸ä¸€è‡´ï¼‰</td><td style="text-align:left">åªæœ‰æœ¬æ ¸å¿ƒæœ‰æœ€æ–°æ•°æ®ï¼Œå¿…é¡»å†™å›å†…å­˜åæ‰èƒ½è¢«å…¶ä»–æ ¸å¿ƒè¯»å–ã€‚</td></tr><tr><td style="text-align:center"><strong>E (Exclusive)</strong></td><td style="text-align:left">å½“å‰æ ¸å¿ƒç‹¬å æ­¤æ•°æ®ï¼Œä½†æœªä¿®æ”¹ï¼ˆä¸å†…å­˜ä¸€è‡´ï¼‰</td><td style="text-align:left">å¯ä»¥å®‰å…¨è¯»å–æˆ–ä¿®æ”¹ï¼Œæ— éœ€é€šçŸ¥å…¶ä»–æ ¸å¿ƒã€‚</td></tr><tr><td style="text-align:center"><strong>S (Shared)</strong></td><td style="text-align:left">å¤šä¸ªæ ¸å¿ƒå…±äº«æ­¤æ•°æ®ï¼ˆä¸å†…å­˜ä¸€è‡´ï¼‰</td><td style="text-align:left">æ‰€æœ‰æ ¸å¿ƒåªèƒ½è¯»å–ï¼Œä¸èƒ½ç›´æ¥ä¿®æ”¹ï¼ˆéœ€å…ˆå‡çº§ä¸º <code>M</code> æˆ– <code>E</code>ï¼‰ã€‚</td></tr><tr><td style="text-align:center"><strong>I (Invalid)</strong></td><td style="text-align:left">ç¼“å­˜è¡Œæ— æ•ˆï¼ˆæ•°æ®å·²è¿‡æœŸæˆ–æœªåŠ è½½ï¼‰</td><td style="text-align:left">å¿…é¡»ä»å†…å­˜æˆ–å…¶ä»–æ ¸å¿ƒé‡æ–°åŠ è½½æœ€æ–°æ•°æ®ã€‚</td></tr></tbody></table><p>æ›´å¤šç»†èŠ‚å¯å‚è€ƒï¼š<a href="https://zh.wikipedia.org/wiki/MESI%E5%8D%8F%E8%AE%AE">ç»´åŸºç™¾ç§‘ MESI</a>ã€‚</p><h1>æŸ¥çœ‹ Rust æ±‡ç¼–ä»£ç </h1><p>æŸ¥çœ‹ Rust æ±‡ç¼–ä»£ç çš„å¸¸ç”¨æ–¹å¼æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p><ol><li><p>cargo rustc --lib --release --target x86_64-unknown-linux-musl â€“ --emit asm</p></li><li><p><a href="https://crates.io/crates/cargo-show-asm">cargo-show-asm</a>ï¼ˆæ¨è âœ…ï¼‰</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cargo asm --release --target=x86_64-unknown-linux-musl --lib &#123;module&#125;::&#123;func_name&#125;</span><br></pre></td></tr></table></figure></li><li><p><a href="https://godbolt.org/">Compiler Explorer</a> ï¼ˆæ¨è âœ…ï¼‰</p></li></ol><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸‹å„ç§ Atomic æ“ä½œçš„æ±‡ç¼–ä»£ç æ˜¯ä»€ä¹ˆæ ·çš„ã€‚</p><h2 id="Store">Store</h2><p>x86-64ï¼š</p><ul><li>æ™®é€šç±»å‹çš„èµ‹å€¼æ“ä½œè·ŸåŸå­æ“ä½œåœ¨ <code>Relaxed</code> é¡ºåºä¸‹ç”Ÿæˆçš„æ±‡ç¼–çš„ä¸€æ¨¡ä¸€æ ·çš„ï¼</li><li>åœ¨å¼ºé¡ºåºä¸€è‡´æ€§è¦æ±‚çš„ <code>SeqCst</code> ä¸‹ï¼Œä½¿ç”¨äº†å¸¦æœ‰ <code>Lock</code> è¯­ä¹‰çš„ <code>xchg</code> æŒ‡ä»¤ä¿è¯å†…å­˜é¡ºåºã€‚</li></ul><p>ARM64ï¼š</p><ul><li>æ™®é€šç±»å‹çš„èµ‹å€¼æ“ä½œè·ŸåŸå­æ“ä½œåœ¨ <code>Relaxed</code> é¡ºåºä¸‹ç”Ÿæˆçš„æ±‡ç¼–çš„ä¹Ÿæ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼</li><li>åœ¨å¼ºé¡ºåºä¸€è‡´æ€§è¦æ±‚çš„ <code>SeqCst</code> ä¸‹ï¼Œä½¿ç”¨äº†åŸå­å­˜å‚¨æŒ‡ä»¤ <code>stlr</code> ä¿è¯å†…å­˜é¡ºåºã€‚</li></ul><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250607135548507.png" alt=""></p><p>é‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼šæ™®é€šç±»å‹çš„èµ‹å€¼æ“ä½œä¸ Relaxed çš„åŸå­æ“ä½œç”Ÿæˆçš„æ±‡ç¼–ä¸€æ ·ï¼Œé‚£å‡­ä»€ä¹ˆåè€…å°±æœ‰åŸå­æ€§çš„ä¿è¯å‘¢ï¼Ÿ</p><ol><li>åœ¨ä¸Šè¿° 2 ä¸ªæ¶æ„ä¸­ï¼Œè¿™ä»…èƒ½è¯´æ˜ <code>mov</code> å’Œ <code>str</code> åœ¨ï¼ˆå½“å‰é€‰æ‹©çš„ï¼‰ç¡¬ä»¶å±‚é¢æ˜¯åŸå­çš„ï¼Œæ— è®ºæ˜¯å¦ä½¿ç”¨ Atomic ç±»å‹ã€‚è¿™å› ä¸º CPU çš„ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼ˆMESIï¼‰å’Œæ€»çº¿é”å®šæœºåˆ¶ç¡®ä¿<strong>å¯¹é½æ“ä½œ</strong>ä¸ä¼šæ’•è£‚ï¼ˆtearingï¼‰ã€‚</li><li>ä½†æ˜¯å¯¹äº<strong>æœªå¯¹é½æˆ–è·¨ç¼“å­˜è¡Œè®¿é—®</strong>ï¼Œæ™®é€šæ“ä½œä¸ä¿è¯åŸå­æ€§ï¼Œå¯èƒ½è¢«æ‹†åˆ†ä¸ºå¤šæ¬¡è®¿é—®ï¼ˆå¦‚æœªå¯¹é½çš„ i64 å¯èƒ½æ‹†ä¸º 2 ä¸ª 32 ä½å†™å…¥ï¼‰ã€‚</li></ol><p>æ‰€ä»¥åœ¨ Rust ç¼–è¯‘å™¨ä¸Šï¼š</p><ul><li><strong>æ™®é€šæ“ä½œï¼ˆ*x=0ï¼‰</strong>ï¼šRust ä¸å°†å…¶è§†ä¸ºåŸå­æ“ä½œï¼Œå³ä½¿ç”Ÿæˆçš„æ±‡ç¼–ä¸ <code>Relaxed</code> åŸå­æ“ä½œç›¸åŒã€‚ç¼–è¯‘å™¨å¯èƒ½ä¼˜åŒ–æˆ–é‡æ’æ™®é€šæ“ä½œï¼Œç ´ååŸå­æ€§å‡è®¾ã€‚<ul><li>å¦‚ï¼šå¾ªç¯ä¸­çš„å¤šæ¬¡æ™®é€šå†™å…¥å¯èƒ½è¢«åˆå¹¶ä¸ºä¸€æ¬¡ï¼ˆä¼˜åŒ–åä»…ä¿ç•™æœ€åä¸€æ¬¡å†™å…¥ï¼‰ã€‚</li></ul></li><li><strong>åŸå­æ“ä½œï¼ˆx.store(0, Relaxed)ï¼‰</strong>ï¼šRust å¼ºåˆ¶ä¿è¯åŸå­æ€§ï¼Œæ— è®ºç¡¬ä»¶æ˜¯å¦éšå¼æ”¯æŒï¼š<ul><li>å¯¹é½è®¿é—®ï¼šç›´æ¥ç”Ÿæˆ <code>mov</code>ï¼ˆåˆ©ç”¨ç¡¬ä»¶åŸå­æ€§ï¼‰ã€‚</li><li>æœªå¯¹é½è®¿é—®ï¼šæ’å…¥é¢å¤–æŒ‡ä»¤ï¼ˆå¦‚ <code>lock cmpxchg</code>ï¼‰ç¡®ä¿åŸå­æ€§ã€‚</li><li>ç¦æ­¢ç¼–è¯‘å™¨ä¼˜åŒ–é‡æ’æˆ–æ¶ˆé™¤æ“ä½œã€‚</li></ul></li></ul><h2 id="Load">Load</h2><p>x86-64ï¼š</p><ul><li>ä¸‰æ®µä»£ç ç”Ÿæˆçš„æ±‡ç¼–ä»£ç ä¸€æ¨¡ä¸€æ ·ï¼è¿™æ˜¯å› ä¸º x86-64 çš„å¼ºé¡ºåºç­–ç•¥é»˜è®¤ä¿è¯ <code>mov</code> å…·æœ‰é¡ºåºä¸€è‡´æ€§ï¼ˆç±»ä¼¼ SeqCstï¼‰ï¼Œå› æ­¤æ— éœ€æ˜¾ç¤ºå†…å­˜å±éšœã€‚</li></ul><p>ARM64ï¼š</p><ul><li>å¯¹äºæ™®é€šç±»å‹çš„åŠ è½½æ“ä½œå’Œ load Relaxed ç”Ÿæˆçš„æ±‡ç¼–ä»£ç æ˜¯ä¸€æ ·çš„ã€‚</li><li>å¯¹äº load SeqCstï¼Œä½¿ç”¨äº†ä¸“é—¨çš„åŸå­åŠ è½½æŒ‡ä»¤ <code>ldar</code>ï¼Œå®ƒä¼šéšå¼æ’å…¥å†…å­˜å±éšœï¼Œä¿è¯è¯¥æ“ä½œä¹‹å‰çš„æ‰€æœ‰å†…å­˜è®¿é—®å¯¹å…¶ä»–çº¿ç¨‹å¯è§ã€‚</li></ul><p>è™½ç„¶ x86-64 å¯¹äºä¸Šé¢çš„ 3 æ®µä»£ç ç”Ÿæˆçš„æ±‡ç¼–æ˜¯ä¸€æ ·çš„ï¼Œä½†è¿™åªæ˜¯ x86-64 ç¡¬ä»¶å±‚é¢ä¸Šçš„ä¿è¯ï¼Œä¸”è·Ÿä¹‹å‰ä¸€æ ·ï¼Œä»…åœ¨å¯¹é½æ—¶æ˜¯åŸå­çš„ï¼Œå¦‚æœæœªå¯¹é½æˆ–è·¨ç¼“å­˜è¡Œè®¿é—®ï¼Œæ˜¯å¯èƒ½è¢«æ’•è£‚æˆ 2 ä¸ªæ“ä½œçš„ã€‚</p><p>åœ¨ ARM64 ä¸­ï¼Œä¸ä¾é ç¡¬ä»¶å±‚é¢çš„å¤æ‚æ€§ï¼Œè€Œé€šè¿‡ <code>ldar</code> åŸå­åŠ è½½æŒ‡ä»¤æ¥ä¿è¯åŸå­æ€§ã€‚</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250607135525872.png" alt=""></p><h2 id="Read-Modify-Write">Read-Modify-Write</h2><p>x86-64:</p><ul><li>ä½¿ç”¨ <code>lock</code> æŒ‡ä»¤æ¥é”å®šæ€»çº¿æˆ–ç¼“å­˜è¡Œï¼Œä»è€Œå®ç°åŸå­æ€§ã€‚</li></ul><p>ARM64:</p><ul><li>ä½¿ç”¨ <code>LL/SC</code> æœºåˆ¶æ¥å®ç°åŸå­æ“ä½œï¼ˆæœ‰ç‚¹ç±»ä¼¼ä¸ä¹è§‚é”çš„å‘³é“ï¼‰ã€‚</li></ul><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250607135850075.png" alt=""></p><h2 id="Compare-and-Exchange">Compare-and-Exchange</h2><p>x86-64:</p><ul><li>äºŒè€…æ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œæˆ–è€…å¯ä»¥ç†è§£ä¸ºï¼Œx86-64 å°±æ²¡æœ‰ä¸“é—¨å®ç° <code>compare_exchange_weak</code>ã€‚</li></ul><p>ARM64:</p><ul><li>äºŒè€…å®ç°æ˜¯ä¸åŒçš„ï¼Œåœ¨ ARM64 ä¸Šï¼Œ<code>compare_exchange_weak</code> æ˜¯çœŸçš„å…·å¤‡ <code>weak</code> çš„ç‰¹æ€§ã€‚æ‰€ä»¥å¦‚æœåœ¨ç‰¹å®šåœºæ™¯ä¸‹æƒ³ç”¨ <code>compare_exchange_weak</code> æ¥è¿›ä¸€æ­¥æå‡æ€§èƒ½ï¼Œåœ¨ä¸Šå±‚ä¹Ÿä¸€å®šè¦ç”¨å¾ªç¯æ¥ä¸»åŠ¨é‡è¯•ï¼Œé¿å…è™šå‡å¤±è´¥ã€‚</li></ul><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250607135449552.png" alt=""></p><h2 id="Fence">Fence</h2><p>x86-64:</p><ul><li>Release å’Œ Acquire å¹¶æ²¡æœ‰é¢å¤–ä½¿ç”¨çš„æŒ‡ä»¤ã€‚åªæœ‰ä½¿ç”¨ SeqCst å†…å­˜å±éšœçš„æ—¶å€™ï¼Œä¼šæ’å…¥ä¸€æ¡ <code>mfence</code> (memory fence) æŒ‡ä»¤ï¼Œè¿™æ¡æŒ‡ä»¤ä¼šä¿è¯åœ¨è¶Šè¿‡å®ƒä¹‹å‰ï¼Œå‰é¢æ‰€æœ‰çš„å†…å­˜æ“ä½œéƒ½å·²ç»å®Œæˆã€‚</li></ul><p>ARM64:</p><ul><li>Releaseã€AcqRel å’Œ SeqCst éƒ½æ’å…¥äº†ä¸€æ¡ <code>dmb ish</code>(data memory barrier, inner shared domain)ã€‚è€Œ Acquire åˆ™æ’å…¥äº†ä¸€æ¡ <code>dmb ishld</code>ï¼Œå®ƒåªä¼šç­‰å¾… load æ“ä½œçš„å®Œæˆï¼Œä½†æ˜¯å…è®¸ store æ“ä½œé‡æ’åºåˆ°å®ƒåé¢ã€‚</li></ul><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250607144937786.png" alt=""></p><h2 id="æ€»ç»“å¯¹æ¯”">æ€»ç»“å¯¹æ¯”</h2><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250607144757100.png" alt=""></p><p>åˆ°è¿™é‡Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä»¥ä¸‹ç»“è®ºï¼š</p><ol><li>x86-64 ä¿è¯åŸå­æ€§çš„å…³é”®æ˜¯ <code>lock</code> æœºåˆ¶ï¼ŒARM64 ä¿è¯åŸå­æ€§çš„å…³é”®æ˜¯ <code>LL/SC</code> æœºåˆ¶ã€‚</li><li>x86-64 ä¿è¯å†…å­˜é¡ºåºçš„å…³é”®æ˜¯ <code>mfence</code> æŒ‡ä»¤ï¼ŒARM64 ä¿è¯å†…å­˜é¡ºåºçš„å…³é”®æ˜¯ <code>dmb ish</code> å’Œ <code>dmb ishld</code> æŒ‡ä»¤ã€‚</li><li>x86-64 æ²¡æœ‰å®ç°çœŸå®çš„ <code>compare_exchange_weak</code>ï¼ŒARM64 å®ç°äº† <code>compare_exchange_weak</code>ã€‚</li><li>x86-64 ä½¿ç”¨çš„æ˜¯å¼ºé¡ºåºç­–ç•¥ï¼Œå…·ä½“æ¥è¯´ï¼š<ul><li><strong>Loadâ†’ åç»­æ“ä½œ</strong>ï¼šç¦æ­¢é‡æ’åºï¼ˆå¦‚ <code>Load A</code> â†’ <code>Store B</code> å¿…é¡»ä¿æŒé¡ºåºï¼‰ã€‚</li><li><strong>Storeâ†’ å‰åºæ“ä½œ</strong>ï¼šç¦æ­¢é‡æ’åºï¼ˆå¦‚ <code>Load A</code> â†’ <code>Store B</code> ä¸­ <code>Store B</code> ä¸èƒ½æå‰åˆ° <code>Load A</code> å‰ï¼‰ã€‚</li><li><strong>Storeâ†’ åç»­ Load</strong>ï¼šå…è®¸é‡æ’åºï¼ˆå¦‚ <code>Store A</code> â†’ <code>Load B</code> å¯èƒ½å®é™…æ‰§è¡Œä¸º <code>Load B</code> â†’ <code>Store A</code></li></ul></li><li>ARM ä½¿ç”¨çš„æ˜¯å¼±é¡ºåºç­–ç•¥ï¼Œå³æ‰€æœ‰çš„åŸå­æ“ä½œéƒ½å¯èƒ½è¢«é‡æ’åºã€‚</li><li>x86-64 ä¸­ï¼ŒRelaxedã€Acquireã€Release å’Œ AcqRel çš„å†…å­˜é¡ºåºæ•ˆæœæ˜¯ä¸€è‡´çš„ã€‚ARM64 ä¸­ï¼ŒRelaxed æ²¡æœ‰ä»»ä½•å†…å­˜é¡ºåºçš„ä¿è¯ï¼Œè€Œ Releaseã€AcqRel å’Œ SeqCst æ˜¯ä¸€æ ·æ˜‚è´µçš„ï¼ŒAcquire ç¨å¾®è½»é‡ä¸€ç‚¹ï¼Œåªä¿è¯äº†å‰é¢çš„ load ä¸ä¼šé‡æ’åˆ°åé¢ã€‚</li></ol><p><a href="https://marabos.nl/atomics/">Rust Atomics and Locks</a> ä¹¦ä¸­ç»™å‡ºäº†ä¸€å¼ æ›´ç»†èŠ‚çš„å›¾ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥ç ”ç©¶ä¸€ä¸‹ã€‚</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250607151428218.png" alt="Rust Atomics and Locks: An overview of the instructions that the various atomic operations compile down to on ARM64 and x86-64 for each memory ordering"></p><h1>ç¡¬ä»¶åŸç†</h1><p>æœ€åæˆ‘ä»¬å°è¯•ä»ç¡¬ä»¶å±‚é¢æ¥è¿›ä¸€æ­¥ç†è§£åŸå­æ“ä½œçš„åº•å±‚å®ç°ã€‚è¿™å—ç¬”è€…å¹¶ä¸ä¸“ä¸šï¼Œæ›´å¤šçš„æ˜¯å°è¯•é€šè¿‡ ChatGPT ç­‰ LLM æŸ¥é˜…èµ„æ–™ï¼Œè¿›è¡Œæ¢³ç†æ€»ç»“ã€‚</p><p>åŸå­æ“ä½œçš„åº•å±‚å®ç°ï¼ˆå¦‚ x86 çš„ <code>lock</code> å‰ç¼€æˆ– ARM çš„ <code>LL/SC</code>ï¼‰ä¾èµ–äºç¡¬ä»¶çº§åˆ«çš„ååŒæœºåˆ¶ï¼Œå…¶æ ¸å¿ƒæ˜¯é€šè¿‡ <strong>ç¼“å­˜ä¸€è‡´æ€§åè®®</strong>ã€<strong>æ€»çº¿ä»²è£</strong> å’Œ <strong>æŒ‡ä»¤é›†å±‚é¢çš„ç‰¹æ®Šæ”¯æŒ</strong> æ¥ä¿è¯å¤šæ ¸ç¯å¢ƒä¸‹çš„åŸå­æ€§å’Œå†…å­˜é¡ºåºã€‚</p><h2 id="x86-çš„-lock-å‰ç¼€ï¼šæ€»çº¿é”å®šä¸ç¼“å­˜ä¸€è‡´æ€§">x86 çš„ <code>lock</code> å‰ç¼€ï¼šæ€»çº¿é”å®šä¸ç¼“å­˜ä¸€è‡´æ€§</h2><ol><li><p><strong>æ€»çº¿é”å®šï¼ˆBus Lockingï¼‰</strong></p><p>å½“ CPU æ‰§è¡Œ <code>lock cmpxchg</code> æ—¶ï¼Œ<code>lock</code> å‰ç¼€ä¼šå‘æ€»çº¿ï¼ˆæˆ–ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼‰å‘é€ä¿¡å·ï¼Œ<strong>ä¸´æ—¶ç‹¬å å†…å­˜åœ°å€çš„è®¿é—®æƒ</strong>ï¼Œé˜»æ­¢å…¶ä»–æ ¸å¿ƒçš„å¹²æ‰°ã€‚</p><ol><li><strong>é”å®šèŒƒå›´</strong>ï¼šç°ä»£ CPU é€šå¸¸é”å®šç¼“å­˜è¡Œï¼ˆé€šå¸¸ 64 å­—èŠ‚ï¼‰ï¼Œè€Œéæ•´ä¸ªæ€»çº¿ã€‚</li><li><strong>ç¡¬ä»¶æ”¯æŒ</strong>ï¼šé€šè¿‡å¤„ç†å™¨çš„ <strong>åŸå­æ“ä½œå•å…ƒ</strong> å’Œ <strong>ç¼“å­˜æ§åˆ¶å™¨</strong> ååŒå®ç°ã€‚</li></ol></li><li><p><strong>MESI ç¼“å­˜ä¸€è‡´æ€§åè®®</strong></p><blockquote><p>ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼ˆå¦‚ MESIï¼‰ä¼šåœ¨ç¡¬ä»¶å±‚é¢ä¸Šç¡®ä¿æ‰€æœ‰æ ¸å¿ƒå¯¹å†…å­˜ä¿®æ”¹çš„è§‚å¯Ÿä¸€è‡´ï¼šä»»ä½•æ ¸å¿ƒçš„ä¿®æ”¹ä¼šç«‹å³ï¼ˆæˆ–æŒ‰åè®®çº¦å®šï¼‰ä¼ æ’­åˆ°å…¶ä»–æ ¸å¿ƒçš„ç¼“å­˜ã€‚</p></blockquote><p><code>lock</code> æ“ä½œä¼šå¼ºåˆ¶ç›®æ ‡ç¼“å­˜è¡Œè¿›å…¥ <strong>Modifiedï¼ˆç‹¬å ä¿®æ”¹ï¼‰</strong> çŠ¶æ€ï¼Œå¹¶é€šçŸ¥å…¶ä»–æ ¸å¿ƒçš„ç¼“å­˜è¡Œå¤±æ•ˆï¼ˆInvalidï¼‰ã€‚ å¦‚ï¼š</p><ol><li><p>æ ¸å¿ƒ A æ‰§è¡Œ <code>lock inc [x]</code>ï¼Œç¼“å­˜è¡Œ <code>x</code> å˜ä¸º Modifiedã€‚</p></li><li><p>æ ¸å¿ƒ B å°è¯•è¯»å– <code>x</code>ï¼Œè§¦å‘ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼š</p><ul><li><p>æ ¸å¿ƒ A å°†ä¿®æ”¹åçš„å€¼å†™å›ä¸»å­˜æˆ–æ ¸å¿ƒ B çš„ç¼“å­˜ï¼ˆå–å†³äºåè®®å˜ç§å¦‚ MESIF/MOESIï¼‰ã€‚</p></li><li><p>æ ¸å¿ƒ B çš„ç¼“å­˜è¡Œ <code>x</code> å˜ä¸º <strong>Shared</strong> æˆ– <strong>Exclusive</strong>ã€‚</p></li></ul></li></ol></li><li><p><strong>å†…å­˜å±éšœçš„éšå«ä¿è¯</strong></p><p>å³ä½¿ä»£ç ä½¿ç”¨ <code>Relaxed</code> å†…å­˜åºï¼Œ<code>lock</code> ä¼šéšå¼æ’å…¥ <strong>StoreLoad</strong> å±éšœï¼Œç¡®ä¿ï¼š</p><ol><li>è¯¥æŒ‡ä»¤å‰çš„æ‰€æœ‰å†™æ“ä½œå¯¹å…¶ä»–æ ¸å¿ƒå¯è§ã€‚</li><li>è¯¥æŒ‡ä»¤åçš„è¯»æ“ä½œä¸ä¼šé‡æ’åˆ°æŒ‡ä»¤å‰ã€‚</li></ol></li><li><p><strong>ç°ä»£ä¼˜åŒ–ï¼šç¼“å­˜é”å®šï¼ˆCache Lockingï¼‰</strong></p><p>æ–°å¼ CPUï¼ˆå¦‚ Intel Skylake+ï¼‰ä¼˜å…ˆåœ¨ç¼“å­˜å±‚é¢å®ç°åŸå­æ€§ï¼Œä»…å½“è·¨ç¼“å­˜è¡Œæˆ–æœªå¯¹é½æ—¶æ‰é™çº§ä¸ºæ€»çº¿é”å®šï¼Œå‡å°‘æ€§èƒ½æŸè€—ã€‚</p></li></ol><h2 id="ARM-çš„-LL-SCï¼ˆLoad-Linked-Store-Conditionalï¼‰ï¼šè½»é‡çº§ç‹¬å æ ‡è®°">ARM çš„ LL/SCï¼ˆLoad-Linked/Store-Conditionalï¼‰ï¼šè½»é‡çº§ç‹¬å æ ‡è®°</h2><ol><li><p><strong>ç‹¬å è®¿é—®æ ‡è®°ï¼ˆExclusive Monitorï¼‰</strong></p><p><strong>ç¡¬ä»¶çŠ¶æ€æœº</strong>ï¼šæ¯ä¸ª CPU æ ¸å¿ƒç»´æŠ¤ä¸€ä¸ª <strong>ç‹¬å è®¿é—®æ ‡è®°</strong>ï¼Œè®°å½•æœ€è¿‘é€šè¿‡ <code>ldxr</code> åŠ è½½çš„å†…å­˜åœ°å€ã€‚</p><ul><li><p><strong>æ ‡è®°è§¦å‘</strong>ï¼š<code>ldxr [x]</code> ä¼šæ ‡è®°åœ°å€ <code>x</code> ä¸ºå½“å‰æ ¸å¿ƒçš„ç‹¬å è®¿é—®åŒºåŸŸã€‚</p></li><li><p><strong>æ ‡è®°æ¸…é™¤æ¡ä»¶</strong>ï¼š</p><ul><li><p>å…¶ä»–æ ¸å¿ƒä¿®æ”¹äº† <code>x</code> çš„ç¼“å­˜è¡Œï¼ˆé€šè¿‡ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼‰ã€‚</p></li><li><p>å½“å‰æ ¸å¿ƒæ‰§è¡Œ <code>clrex</code> æˆ–ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</p></li></ul></li></ul></li><li><p><strong>æ¡ä»¶å­˜å‚¨ï¼ˆ**</strong><code>stxr</code>*<strong>*ï¼‰çš„åŸå­æ€§æ ¡éªŒ</strong></p><p><strong>æ ¡éªŒç‹¬å æ ‡è®°</strong>ï¼š<code>stxr</code> æ‰§è¡Œæ—¶ï¼Œç¡¬ä»¶ä¼šæ£€æŸ¥ç›®æ ‡åœ°å€çš„ç‹¬å æ ‡è®°æ˜¯å¦ä»å±äºå½“å‰æ ¸å¿ƒï¼š</p><ol><li><strong>è‹¥æ ‡è®°æœ‰æ•ˆ</strong>ï¼šå­˜å‚¨æˆåŠŸï¼Œè¿”å› 0ã€‚</li><li><strong>è‹¥æ ‡è®°å¤±æ•ˆ</strong>ï¼šå­˜å‚¨å¤±è´¥ï¼Œè¿”å› 1ï¼ˆéœ€é‡è¯•ï¼‰ã€‚</li></ol></li><li><p><strong>ä¸ç¼“å­˜ä¸€è‡´æ€§åè®®çš„äº¤äº’</strong></p><p><strong>ARM çš„ ACE åè®®</strong>ï¼šLL/SC ä¾èµ–ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼ˆå¦‚ CHI æˆ– ACEï¼‰ç›‘å¬å…¶ä»–æ ¸å¿ƒçš„ä¿®æ”¹ï¼š</p><ol><li>æ ¸å¿ƒ A æ‰§è¡Œ <code>ldxr [x]</code>ï¼Œç¼“å­˜è¡Œ <code>x</code> è¿›å…¥ <strong>Exclusive</strong> çŠ¶æ€ã€‚</li><li>è‹¥æ ¸å¿ƒ B å†™å…¥ <code>x</code>ï¼Œç¼“å­˜è¡Œåœ¨æ ¸å¿ƒ A ä¸­å˜ä¸º <strong>Invalid</strong>ï¼Œç‹¬å æ ‡è®°è¢«æ¸…é™¤ã€‚</li><li>æ ¸å¿ƒ A çš„åç»­ <code>stxr</code> ä¼šå› æ ‡è®°å¤±æ•ˆè€Œå¤±è´¥ã€‚</li></ol></li><li><p><strong>å†…å­˜é¡ºåºçš„çµæ´»æ§åˆ¶</strong></p><p>ARM çš„å†…å­˜åºï¼ˆå¦‚ <code>Relaxed</code>/<code>SeqCst</code>ï¼‰é€šè¿‡æ˜¾å¼å±éšœæŒ‡ä»¤å®ç°ï¼š</p><ol><li><code>ldapr</code>ï¼ˆLoad-Acquireï¼‰ï¼šç¡®ä¿åç»­æ“ä½œä¸é‡æ’åˆ°åŠ è½½å‰ã€‚</li><li><code>stlr</code>ï¼ˆStore-Releaseï¼‰ï¼šç¡®ä¿å‰åºæ“ä½œä¸é‡æ’åˆ°å­˜å‚¨åã€‚</li></ol></li></ol><h1>æ€»ç»“</h1><p>æœ¬ç¯‡æ–‡ç« é€šè¿‡æŸ¥çœ‹ <code>x86_64-unknown-linux-musl</code> å’Œ <code>aarch64-unknown-linux-musl</code> ä¸¤å¤§å¹³å°ä¸‹çš„æ±‡ç¼–ä»£ç  ï¼Œæ·±å…¥å‰–æäº† Rust åŸå­æ“ä½œçš„åº•å±‚å®ç°æœºåˆ¶ï¼Œæ­ç¤ºäº†åŒä¸€è¡Œ Rust ä»£ç åœ¨ä¸åŒå¹³å°ä¸Šæˆªç„¶ä¸åŒçš„æœºå™¨çº§è¡Œä¸ºã€‚</p><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å­¦ä¹ çš„éƒ½æ˜¯æ— é”ï¼ˆnon-blockingï¼‰æ“ä½œï¼Œä¸‹ç¯‡ï¼Œæˆ‘ä»¬å°†ç»§ç»­å­¦ä¹  <a href="https://marabos.nl/atomics/">Rust Atomics and Locks</a> ä¸­çš„ç¬¬å…«ç« ã€ŠOperating System Primitivesã€‹ï¼Œä¸ºæ‰‹å†™é˜»å¡ç±»ç»„ä»¶ï¼ˆMutexã€RWMutexã€CondVarï¼‰åšç†è®ºå‡†å¤‡ï¼Œå’±ä»¬ä¸‹ç¯‡è§ï¼</p><p>Happy Coding! Peace~</p>]]></content>
    
    
    <summary type="html">æœ¬ç¯‡æ–‡ç« æ²¿ç€ â€œCPU â†’ æ±‡ç¼–æŒ‡ä»¤ â†’ Rust åŸå­è¯­ä¹‰â€ çš„é“¾è·¯ï¼Œå¸¦ä½ æ‹†è§£ Atomic* èƒŒååˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆã€‚æˆ‘ä»¬å…ˆç”¨ x86-64 ä¸ ARM64 çš„çœŸå®ç¼–è¯‘ç»“æœå¯¹æ¯” Ordering çš„ç”Ÿæˆä»£ç ï¼Œå†ç»“åˆç¼“å­˜ä¸€è‡´æ€§åè®®ä¸ç¼–è¯‘å™¨é‡æ’è§„åˆ™ï¼Œè§£é‡Šä¸ºä»€ä¹ˆåŒä¸€è¡Œ Rust ä»£ç åœ¨ä¸åŒå¹³å°ä¼šå‘ˆç°æˆªç„¶ä¸åŒçš„æœºå™¨çº§è¡Œä¸ºã€‚è¯»å®Œåï¼Œä½ ä¸å¿…æ­»è®°ç¡¬èƒŒäº”ç§å†…å­˜é¡ºåºï¼Œä¹Ÿèƒ½åˆ¤æ–­ä½•æ—¶é€‰ Relaxedã€ä½•æ—¶å¿…é¡»ä¸Š SeqCstï¼Œå¹¶æŒæ¡ä¸€å¥—â€œçœ‹ asm â†’ è¾¨è¯­ä¹‰ â†’ åšæƒè¡¡â€çš„åˆ†ææ–¹æ³•ï¼Œä¸ºå†™é”ã€å¹¶å‘å®¹å™¨æˆ–æ€§èƒ½è°ƒä¼˜æä¾›æ ¹åº•ã€‚</summary>
    
    
    
    <category term="rust" scheme="https://hedon.top/categories/rust/"/>
    
    <category term="rust åº•å±‚åŸç†" scheme="https://hedon.top/categories/rust/rust-%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/"/>
    
    
    <category term="rust" scheme="https://hedon.top/tags/rust/"/>
    
    <category term="rust åŸç†" scheme="https://hedon.top/tags/rust-%E5%8E%9F%E7%90%86/"/>
    
    <category term="å¹¶å‘åŸç†" scheme="https://hedon.top/tags/%E5%B9%B6%E5%8F%91%E5%8E%9F%E7%90%86/"/>
    
    <category term="åŸå­æ“ä½œ" scheme="https://hedon.top/tags/%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/"/>
    
    <category term="æ±‡ç¼–" scheme="https://hedon.top/tags/%E6%B1%87%E7%BC%96/"/>
    
  </entry>
  
  <entry>
    <title>Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª Arc</title>
    <link href="https://hedon.top/2025/06/03/rust-action-arc/"/>
    <id>https://hedon.top/2025/06/03/rust-action-arc/</id>
    <published>2025-06-03T05:00:00.000Z</published>
    <updated>2025-06-05T00:38:36.796Z</updated>
    
    <content type="html"><![CDATA[<p>ç³»åˆ—æ–‡ç« ï¼š</p><ul><li><a href="https://hedon.top/2024/11/11/rust-memory-order/">Rust åŸç†ä¸¨èŠä¸€èŠ Rust çš„ Atomic å’Œå†…å­˜é¡ºåº</a></li><li><a href="https://hedon.top/2025/05/13/rust-action-spinlock/">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª SpinLock</a></li><li><a href="https://hedon.top/2025/05/29/rust-action-oneshot-channel/">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª oneshot channel</a></li></ul><p>ç»§ä¸Šç¯‡ <a href="https://hedon.top/2025/05/29/rust-action-oneshot-channel/">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª oneshot channel</a>ï¼Œæœ¬ç¯‡æˆ‘ä»¬ç»§ç»­å‚è€ƒ <a href="https://marabos.nl/atomics/">Rust Atomics and Locks</a> ä¸€ä¹¦ï¼Œæ¥å®ç°ä¸€ä¸ª <code>Arc</code>ã€‚</p><h2 id="Arc-ç®€ä»‹">Arc ç®€ä»‹</h2><p><code>Arc</code>ï¼ˆ<em>Atomic Reference Counted</em>ï¼‰æ˜¯ Rust æ ‡å‡†åº“é‡Œä½äº <code>std::sync</code> æ¨¡å—ä¸­çš„æ™ºèƒ½æŒ‡é’ˆï¼Œç”¨äº <strong>åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´å®‰å…¨åœ°å…±äº«åªè¯»æ•°æ®</strong>ã€‚å’Œåªé€‚ç”¨äºå•çº¿ç¨‹åœºæ™¯çš„ <code>Rc&lt;T&gt;</code> ä¸åŒï¼Œ<code>Arc&lt;T&gt;</code> çš„å¼•ç”¨è®¡æ•°å¢å‡æ“ä½œä½¿ç”¨åŸå­æŒ‡ä»¤ï¼Œä»è€Œä¿è¯è·¨çº¿ç¨‹çš„å†…å­˜å®‰å…¨ã€‚</p><p><strong>ä¸ºä»€ä¹ˆéœ€è¦ Arcï¼Ÿ</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">p</span> = Person &#123; age: <span class="number">18</span>, name: <span class="string">&quot;hedon&quot;</span>.<span class="title function_ invoke__">to_string</span>(), address: <span class="string">&quot;China&quot;</span>.<span class="title function_ invoke__">to_string</span>() &#125;;</span><br><span class="line"></span><br><span class="line">thread::<span class="title function_ invoke__">scope</span>(|s| &#123;</span><br><span class="line">    s.<span class="title function_ invoke__">spawn</span>(|| <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, &amp;p)); <span class="comment">// âœ… scope å†…çš„çº¿ç¨‹å¯ä»¥å€Ÿç”¨</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, &amp;p)); <span class="comment">// âŒ éœ€è¦ &#x27;static ç”Ÿå‘½å‘¨æœŸ</span></span><br></pre></td></tr></table></figure><p><strong>é—®é¢˜</strong>ï¼š<code>thread::spawn</code> è¦æ±‚ <code>'static</code> ç”Ÿå‘½å‘¨æœŸï¼Œä½† <code>&amp;p</code> åªæ˜¯æ ˆä¸Šå˜é‡çš„å€Ÿç”¨ã€‚<br><strong>è§£å†³</strong>ï¼šä½¿ç”¨ <code>Arc::new(p)</code> æŠŠæ•°æ®ç§»åˆ°å †ä¸Šï¼Œé€šè¿‡åŸå­å¼•ç”¨è®¡æ•°å®ç°å¤šæ‰€æœ‰æƒï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">p</span> = Arc::<span class="title function_ invoke__">new</span>(Person &#123; <span class="comment">/* ... */</span> &#125;);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">p_clone</span> = p.<span class="title function_ invoke__">clone</span>(); <span class="comment">// åŸå­è®¡æ•° +1</span></span><br><span class="line">thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, p_clone)); <span class="comment">// âœ… ç¼–è¯‘é€šè¿‡</span></span><br></pre></td></tr></table></figure><h2 id="è¯»å®Œæœ¬ç¯‡ä½ èƒ½å­¦åˆ°ä»€ä¹ˆ">è¯»å®Œæœ¬ç¯‡ä½ èƒ½å­¦åˆ°ä»€ä¹ˆ</h2><ul><li><strong>åŸå­æ“ä½œçš„å†…å­˜é¡ºåºé€‰æ‹©</strong>ï¼šé€šè¿‡å¼•ç”¨è®¡æ•°è¿™ä¸ªå…·ä½“ä¾‹å­ï¼Œç†è§£ <code>Relaxed / Acquire / Release / fence</code> çš„ä½¿ç”¨åœºæ™¯ã€‚</li><li><strong>å¼±å¼•ç”¨è§£å†³å¾ªç¯å¼•ç”¨</strong>ï¼š<code>Weak&lt;T&gt;</code> çš„è®¾è®¡åŸç†å’Œåœ¨å›¾ç»“æ„ä¸­çš„åº”ç”¨ã€‚</li><li><strong>Arc::get_mut çš„å®‰å…¨æ€§ä¿è¯</strong>ï¼šç†è§£ã€ŒéåŸå­ä¸¤æ­¥æ ¡éªŒã€çš„å·§å¦™è®¾è®¡ã€‚</li><li><strong>é›¶æˆæœ¬æŠ½è±¡çš„å®ç°ç»†èŠ‚</strong>ï¼š<code>UnsafeCell</code> + <code>ManuallyDrop</code> ç›¸æ¯” <code>Option&lt;T&gt;</code> çš„ä¼˜åŠ¿ã€‚</li></ul><h2 id="v0-åŸºç¡€å¼•ç”¨è®¡æ•°">v0: åŸºç¡€å¼•ç”¨è®¡æ•°</h2><h3 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h3><p>æˆ‘ä»¬å…ˆæ¥åˆ†æä¸€ä¸‹åŸºæœ¬çš„æ•°æ®ç»“æ„è¯¥å¦‚ä½•å®šä¹‰ï¼Œåœ¨ä¹‹å‰çš„ <a href="https://hedon.top/2025/05/13/rust-action-spinlock/">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª SpinLock</a>ï¼Œæˆ‘ä»¬è®²åˆ°äº† C++/Rust å¸¸ç”¨çš„å¹¶å‘ç¼–ç¨‹æ–¹å¼ RAIIï¼ˆResource Acquisition Is Initializationï¼Œèµ„æºè·å–å³åˆå§‹åŒ–ï¼‰ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š<strong>åœ¨å¯¹è±¡æ„é€ å‡½æ•°ä¸­è·å–èµ„æºï¼Œåœ¨ææ„å‡½æ•°ä¸­é‡Šæ”¾èµ„æº</strong>ã€‚ä¸Šé¢çš„æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬åœ¨åˆå§‹åŒ– <code>Person</code> çš„æ—¶å€™å…¶å®ä¹Ÿæ˜¯åº”ç”¨äº†è¿™ç§æ€è·¯ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">p</span> = Arc::<span class="title function_ invoke__">new</span>(Person &#123;</span><br><span class="line">    age: <span class="number">18</span>,</span><br><span class="line">    name: <span class="string">&quot;hedon&quot;</span>.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">    address: <span class="string">&quot;China&quot;</span>.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬çš„è‡ªå®šä¹‰ <code>Arc</code> éœ€è¦æ³›å‹ <code>T</code>ï¼Œä½¿å…¶å¯ä»¥æ‰¿è½½ä¸åŒçš„æ•°æ®ç±»å‹çš„æ•°æ® <code>data</code>ï¼ŒåŒæ—¶ä¸ºäº†åšå¼•ç”¨è®¡æ•°ï¼Œå®ƒéœ€è¦ä¸€ä¸ªæ•°å€¼ç±»å‹ <code>ref_count</code> æ¥è®¡æ•°ï¼Œä¸ºäº†å¹¶å‘å®‰å…¨ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©åŸå­ç±»å‹ <code>AtomicUsize</code>ã€‚</p><p>åœ¨ <code>Arc</code> ä¸­ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±ç®¡ç† <code>data</code> çš„ç”Ÿå‘½å‘¨æœŸï¼Œé™¤äº†ä½¿ç”¨è£¸æŒ‡é’ˆ <code>*mut T</code> æˆ– <code>*const T</code> ä¹‹å¤–ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>std::ptr::NonNull&lt;T&gt;</code> ï¼Œå®ƒæ˜¯ä¸€ä¸ªé›¶æˆæœ¬ã€ä¿è¯éç©ºã€æ”¯æŒåå˜ï¼ˆå¯å®‰å…¨å‘å­ç±»å‹è½¬æ¢ï¼‰çš„è£¸æŒ‡é’ˆåŒ…è£…å™¨ï¼Œå…·ä½“å¯å‚è€ƒ<strong>é™„å½• 1. NonNull&lt;T&gt;</strong>ã€‚</p><p>ç»¼ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä»¥ä¸‹æ•°æ®ç»“æ„ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ArcData</span>&lt;T&gt; &#123;</span><br><span class="line">    ref_count: AtomicUsize,</span><br><span class="line">    data: T,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    ptr: NonNull&lt;ArcData&lt;T&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Arc&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(data: T) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        Arc &#123;</span><br><span class="line">            ptr: NonNull::<span class="title function_ invoke__">from</span>(<span class="type">Box</span>::<span class="title function_ invoke__">leak</span>(<span class="type">Box</span>::<span class="title function_ invoke__">new</span>(ArcData &#123;</span><br><span class="line">                ref_count: AtomicUsize::<span class="title function_ invoke__">new</span>(<span class="number">1</span>),</span><br><span class="line">                data,</span><br><span class="line">            &#125;))),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>æˆ‘ä»¬å®šä¹‰äº† <code>ArcData</code> å’Œ <code>Arc</code> ä¸¤ä¸ªç»“æ„ï¼Œå…¶ä¸­ <code>ArcData</code> åŒ…å«å¼•ç”¨è®¡æ•° <code>ref_count</code> å’Œå®é™…æ•°æ® <code>data</code>ã€‚</li><li>åœ¨ <code>Arc</code> ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>NonNull</code> æ¥ç®¡ç† <code>ArcData</code> çš„ç”Ÿå‘½å‘¨æœŸã€‚åˆå§‹åŒ–æ—¶ï¼Œå…ˆç”¨ <code>Box::new()</code> åœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼Œå†é€šè¿‡ <code>Box::leak()</code> æ”¾å¼ƒ <code>Box&lt;T&gt;</code> çš„æ‰€æœ‰æƒï¼Œäº¤ç”± <code>Arc</code> è‡ªè¡Œç®¡ç†ã€‚</li></ol><pre class="mermaid">graph TB    subgraph Stack ["æ ˆå†…å­˜ Stack"]        ArcStruct["Arc&lt;T&gt;<br/>ptr: NonNull&lt;ArcData&lt;T&gt;&gt;"]    end    subgraph Heap ["å †å†…å­˜ Heap"]        ArcDataStruct["ArcData&lt;T&gt;<br/>ref_count: AtomicUsize(1)<br/>data: T"]    end    ArcStruct -->|æŒ‡å‘| ArcDataStruct    subgraph Process ["å†…å­˜åˆ†é…è¿‡ç¨‹"]        Step1["Box::new(ArcData)"]        Step2["Box::leak()"]        Step3["NonNull::from()"]        Step1 --> Step2        Step2 --> Step3    end    classDef stackStyle fill:#e1f5fe,stroke:#01579b,stroke-width:2px    classDef heapStyle fill:#f3e5f5,stroke:#4a148c,stroke-width:2px    classDef processStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px    class ArcStruct stackStyle    class ArcDataStruct heapStyle    class Step1,Step2,Step3 processStyle</pre><p>å¦å¤–ï¼Œè·¨çº¿ç¨‹å‘é€ <code>Arc&lt;T&gt;</code> ä¼šå¯¼è‡´ <code>T</code> å¯¹è±¡è¢«å…±äº«ï¼Œå³ <code>T</code> éœ€è¦æ»¡è¶³ <code>Sync</code> traitï¼Œè€Œè·¨çº¿ç¨‹å‘é€ <code>Arc&lt;T&gt;</code> ä¹Ÿä¼šå¯¼è‡´éœ€è¦ç”±å¦å¤–ä¸€ä¸ªçº¿ç¨‹æ¥é‡Šæ”¾ <code>T</code>ï¼Œæ‰€ä»¥éœ€è¦ <code>T</code> æ»¡è¶³ <code>Send</code> traitã€‚æ‰€ä»¥åªæœ‰å½“ <code>T</code> æ»¡è¶³ <code>Send+Sync</code> çš„æ—¶å€™ï¼Œ<code>Arc&lt;T&gt;</code> æ‰æ˜¯ <code>Send</code> çš„ï¼Œå¯¹äº <code>Sync</code> ä¹Ÿæ˜¯åŒç†ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥ä¸º <code>Arc&lt;T&gt;</code> åˆ†åˆ«å®ç° <code>Sync</code> å’Œ <code>Send</code> traitï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T: <span class="built_in">Send</span> + <span class="built_in">Sync</span>&gt; <span class="built_in">Send</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;&#125;</span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T: <span class="built_in">Send</span> + <span class="built_in">Sync</span>&gt; <span class="built_in">Sync</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†èƒ½å¤Ÿä¾¿æ·çš„è·å– <code>data</code>ï¼Œæˆ‘ä»¬å…ˆä¸º <code>Arc&lt;T&gt;</code> å®ç°ä¸€ä¸ª <code>data()</code> ç”¨äºè·å– <code>ArcData&lt;T&gt;</code>ï¼ŒåŒæ—¶ä¸ºå…¶å®ç° <code>Deref</code> traitï¼Œç”¨äºåƒæŒ‡é’ˆä¸€æ ·æ— æ„Ÿæ“ä½œ <code>data: T</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; Arc&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">data</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;ArcData&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; <span class="keyword">self</span>.ptr.<span class="title function_ invoke__">as_ref</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Deref <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Target</span> = T;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">deref</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="keyword">Self</span>::Target &#123;</span><br><span class="line">        &amp;<span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().data</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç»´æŠ¤å¼•ç”¨è®¡æ•°">ç»´æŠ¤å¼•ç”¨è®¡æ•°</h3><p>åŸºç¡€éƒ¨åˆ†æˆ‘ä»¬å·²ç»é“ºå«å®Œäº†ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦æ¥å®ç° 2 ä¸ªæœ€é‡è¦çš„ trait äº†ï¼š</p><ul><li><strong>Clone</strong>: <code>Arc</code> å¼•ç”¨è®¡æ•°çš„å…³é”®ï¼Œåœ¨æ¯æ¬¡ <code>clone()</code> çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸æ‹·è´ <code>data</code>ï¼Œè€Œæ˜¯è®© <code>ref_count</code> è‡ªå¢ï¼Œè¿›è¡Œå¼•ç”¨è®¡æ•°ã€‚</li><li><strong>Drop</strong>: åœ¨ <code>Arc&lt;T&gt;</code> å®ä¾‹ç¦»å¼€ä½œç”¨åŸŸçš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦è®© <code>ref_count</code> è‡ªå‡ï¼ŒåŒæ—¶åœ¨æœ€åä¸€ä¸ª <code>Arc&lt;T&gt;</code> è¢«é”€æ¯æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä¸»åŠ¨é‡Šæ”¾ <code>ArcData&lt;T&gt;</code> çš„å†…å­˜èµ„æºã€‚</li></ul><p>æˆ‘ä»¬å…ˆæ¥å®ç° <code>Clone</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Clone</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">clone</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> å¤„ç†æ•´å‹æº¢å‡ºçš„æƒ…å†µ</span></span><br><span class="line">        <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().ref_count.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Ordering::Relaxed)</span><br><span class="line">        Arc &#123; ptr: <span class="keyword">self</span>.ptr &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºè¿™é‡Œæ²¡æœ‰å…¶ä»–åŸå­æ“ä½œéœ€è¦è·Ÿå½“å‰æ“ä½œå»ºç«‹ä¸¥æ ¼çš„ <code>happens-before</code> å…³ç³»ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æœ€æ¾çš„ <code>Relaxed</code> å†…å­˜é¡ºåºã€‚</p><p>æ¥ä¸‹æ¥çœ‹ä¸‹ <code>Drop</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> &lt;T&gt; <span class="built_in">Drop</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().ref_count.<span class="title function_ invoke__">fetch_sub</span>(<span class="number">1</span>, ???) == <span class="number">1</span> &#123; <span class="comment">// &lt;----- è¿™é‡Œéœ€è¦ä»€ä¹ˆä½¿ç”¨å†…å­˜é¡ºåºçº¦æŸï¼Ÿ</span></span><br><span class="line">            <span class="keyword">unsafe</span> &#123;</span><br><span class="line">                <span class="title function_ invoke__">drop</span>(<span class="type">Box</span>::<span class="title function_ invoke__">from_raw</span>(<span class="keyword">self</span>.ptr.<span class="title function_ invoke__">as_ptr</span>()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äº <code>Drop</code>ï¼Œæˆ‘ä»¬å°±éœ€è¦å¥½å¥½æƒ³ä¸€æƒ³éœ€è¦ä»€ä¹ˆå†…å­˜é¡ºåºçº¦æŸäº†ã€‚åœ¨æœ€åä¸€ä¸ª <code>drop</code> çš„æ—¶å€™ï¼Œæˆ‘ä»¬æœ‰ 2 ä¸ªç›®æ ‡ï¼š</p><ol><li><strong>ä¸èƒ½è¿‡æ—©é‡Šæ”¾</strong>ï¼šç¡®ä¿åœ¨å¼•ç”¨è®¡æ•°å‡åˆ° 0 å¹¶é”€æ¯å¯¹è±¡ä¹‹å‰ï¼Œæ²¡æœ‰åˆ«çš„çº¿ç¨‹ä»åœ¨ä½¿ç”¨è¿™ä»½æ•°æ®ï¼›</li><li><strong>è¦çœ‹å¾—è§åˆ«äººå†™çš„ä¸œè¥¿</strong>ï¼šå¦‚æœåˆ«çš„çº¿ç¨‹åœ¨å®ƒä»¬å„è‡ªçš„ <code>drop</code> é‡Œé¢å¯¹å…±äº«å¯¹è±¡åšäº†å†™å…¥ï¼Œæœ€åä¸€ä¸ªçº¿ç¨‹åšææ„æ—¶å¿…é¡»&quot;çœ‹åˆ°&quot;è¿™äº›å†™å…¥ï¼Œå¦åˆ™å°±å¯èƒ½å‡ºç°æ•°æ®ç«äº‰æˆ–æ¬¡åºé”™è¯¯ã€‚</li></ol><p>æ¢è¨€ä¹‹ï¼Œæˆ‘ä»¬éœ€è¦æœ€åä¸€ä¸ª <code>fetch_sub</code> è·Ÿå‰é¢å…¶ä»–æ¯ä¸€ä¸ª <code>fetch_sub</code> éƒ½å»ºç«‹èµ· happens before å…³ç³»ï¼Œä¹Ÿå³æˆ‘ä»¬éœ€è¦ä¸€å¯¹ Release å’Œ Acquire æ¥ä¿è¯ happens-beforeã€‚</p><p>è¿™é‡Œç®€å•å›é¡¾ä¸€ä¸‹ <code>Release</code> å’Œ <code>Acquire</code>ï¼Œä¸ç†Ÿæ‚‰çš„è¯»è€…å¯ä»¥å‚é˜…ï¼š<a href="https://hedon.top/2024/11/11/rust-memory-order/">Rust åŸç†ä¸¨èŠä¸€èŠ Rust çš„ Atomic å’Œå†…å­˜é¡ºåº</a>ã€‚</p><ul><li><code>Release</code>: ä½œç”¨äºå†™æ“ä½œï¼ˆstoreï¼‰ï¼Œç¡®ä¿è¯¥æ“ä½œä¹‹å‰çš„æ‰€æœ‰å†…å­˜è®¿é—®ä¸ä¼šè¢«é‡æ’åˆ°è¿™ä¸ª Release æ“ä½œä¹‹åã€‚</li><li><code>Acquire</code>: ä½œç”¨äºè¯»æ“ä½œï¼ˆloadï¼‰ï¼Œç¡®ä¿è¯¥æ“ä½œä¹‹åçš„æ‰€æœ‰å†…å­˜è®¿é—®ä¸ä¼šè¢«é‡æ’åˆ°è¿™ä¸ª Acquire æ“ä½œä¹‹å‰ã€‚</li><li>å½“ä¸€ä¸ªçº¿ç¨‹é€šè¿‡ <code>Acquire</code> è¯»å–åˆ°å¦ä¸€ä¸ªçº¿ç¨‹é€šè¿‡ <code>Release</code> å†™å…¥çš„å€¼æ—¶ï¼Œä¼šå»ºç«‹ä¸€ä¸ª happens-before å…³ç³»ï¼š<strong>çº¿ç¨‹ A ä¸­ Release å†™å…¥ä¹‹å‰çš„æ‰€æœ‰å†…å­˜å†™æ“ä½œï¼Œå¯¹äºçº¿ç¨‹ B ä¸­ Acquire è¯»å–ä¹‹åçš„æ‰€æœ‰å†…å­˜è¯»æ“ä½œéƒ½æ˜¯å¯è§çš„</strong>ã€‚</li></ul><blockquote><p><strong>Release-Sequence æ¦‚å¿µè¡¥å……</strong>ï¼šå½“å¤šä¸ªçº¿ç¨‹å¯¹åŒä¸€ä¸ªåŸå­å˜é‡æ‰§è¡Œ Release æ“ä½œæ—¶ï¼Œè¿™äº›æ“ä½œä¼šå½¢æˆä¸€ä¸ª â€œrelease-sequenceâ€ã€‚åç»­ä»»ä½•ä¸€ä¸ª Acquire æ“ä½œè¯»å–åˆ°è¿™ä¸ªåºåˆ—ä¸­çš„ä»»æ„å€¼ï¼Œéƒ½èƒ½ä¸æ•´ä¸ªåºåˆ—å»ºç«‹ happens-before å…³ç³»ã€‚è¿™æ­£æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬çš„ <code>fence(Acquire)</code> èƒ½å¤Ÿä¸ä¹‹å‰<strong>æ‰€æœ‰çº¿ç¨‹</strong>çš„ <code>fetch_sub(Release)</code> å½¢æˆåŒæ­¥çš„å…³é”®ã€‚</p></blockquote><p>æˆ‘ä»¬å½“ç„¶å¯ä»¥ä½¿ç”¨ <code> Release</code> å’Œ <code>Acquire</code> çš„ç»“åˆä½“ <code>AcqRel</code> æ¥ä¸€æ­¥åˆ°ä½è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ä¸è¿‡è€ƒè™‘åˆ°åªæœ‰æœ€åä¸€ä¸ª <code>drop</code> éœ€è¦æ»¡è¶³è¿™ä¸ªå…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•åšå¾—æ›´ä¼˜é›…ä¸€äº›ã€‚</p><p><strong>åœ¨è¿™ç§ä»…éœ€åœ¨ä¸´ç•Œå€¼ä¿è¯ happens-before çš„åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥å•ç‹¬åœ¨ä¸´ç•Œæƒ…å†µä¸‹ä½¿ç”¨ä¸€ä¸ª <code>fence</code> æ¥å»ºç«‹èµ· happens-beforeã€‚</strong></p><p>å…·ä½“æ¥è¯´ï¼š</p><ul><li><strong>å¯¹äºéæœ€ç»ˆ <code>drop</code></strong>ï¼šæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨ <code>Release</code>ï¼Œå³ <code>fetch_sub(1, Ordering::Release)</code>ï¼Œå®ƒä¿è¯äº†åˆ«çš„çº¿ç¨‹å¦‚æœæœ€ç»ˆåš&quot;æœ€åä¸€æ¬¡ drop&quot;ï¼Œåªè¦å®ƒå¯¹ç›¸åŒåŸå­æ‰§è¡Œä¸€æ¡ <em>Acquire</em> æ“ä½œï¼Œå®ƒå°±èƒ½åŒæ­¥åˆ°å‰é¢æ‰€æœ‰çº¿ç¨‹å¯¹æ•°æ®åšè¿‡çš„æ”¹åŠ¨ã€‚</li><li><strong>å¯¹äºæœ€ç»ˆ <code>drop</code></strong>ï¼šåœ¨è°ƒç”¨ <code>fetch_sub</code> çš„æ—¶å€™æˆ‘ä»¬ä»éœ€è¦ <code>Release</code> è¯­ä¹‰ï¼Œä½†æ˜¯è°ƒç”¨æ—¶ï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“è‡ªå·±æ˜¯ä¸æ˜¯&quot;æœ€åé‚£ä¸ªçº¿ç¨‹&quot;ã€‚å½“ <code>fetch_sub</code> è¿”å› <code>1</code> çš„æ—¶å€™ï¼Œè¯´æ˜æˆ‘ä»¬æ˜¯&quot;æœ€åé‚£ä¸ªçº¿ç¨‹&quot;ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å»ºç«‹ä¸€ä¸ª <code>fetch(Acquire)</code>ï¼Œä¸ä¹‹å‰çš„æ‰€æœ‰ <code>Release</code> å½¢æˆé…å¯¹ï¼Œç¡®ä¿çœ‹åˆ°<strong>ä¹‹å‰æ‰€æœ‰çš„å†å²å†™å…¥</strong>ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬æ‰èƒ½ç¡®å®šå·²ç»æ²¡æœ‰åˆ«çš„çº¿ç¨‹åœ¨ä½¿ç”¨æ•°æ®äº†ï¼Œæˆ‘ä»¬æ‰å¯ä»¥å®‰å…¨åœ°é”€æ¯å¯¹è±¡ã€‚</li></ul><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼›</p><pre class="mermaid">sequenceDiagram    participant A as Thread A    participant B as Thread B    participant C as Thread C<br/>(æœ€å drop)    %% æ™®é€šå†™å…¥    A->>A: write shared data â€¦    B->>B: write shared data â€¦    %% éæœ€ç»ˆ dropï¼šRelease å†™    A->>A: fetch_sub (Release)  â¬… è®¡æ•° nâ†’n-1    B->>B: fetch_sub (Release)  â¬… è®¡æ•° n-1â†’n-2    %% å½¢æˆ release-sequence    Note over A,B: è¿™ä¸¤æ¬¡ Release å†™ç»„æˆ<br/>åŒä¸€æ¡ release-sequence    %% æœ€ç»ˆ dropï¼šRelease å†™ & è¿”å› 1    C->>C: fetch_sub (Release)  â¬… è¿”å› 1 â†’ è®¡æ•° 0    %% Acquire fence åŒæ­¥    C-->>C: fence (Acquire)<br/>ã€æ¥æ”¶ release-sequenceã€‘    %% å®‰å…¨ææ„    C->>C: drop(Box::from_raw)    %% ç»“æœè¯´æ˜    Note over C: fence (Acquire) ä½¿ A/B<br/>å¯¹å…±äº«æ•°æ®çš„å†™å¿…å®š<br/>åœ¨ææ„å‰å¯è§</pre><p>ç»è¿‡è¿™ä¹ˆä¸€é¡¿åˆ†æåï¼Œæˆ‘ä»¬æœ€ç»ˆçš„ <code>Drop</code> å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Drop</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="comment">// â¶ æ‰€æœ‰ `drop` éƒ½æ‰§è¡Œï¼šRelease</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().ref_count.<span class="title function_ invoke__">fetch_sub</span>(<span class="number">1</span>, Ordering::Release) == <span class="number">1</span> &#123;</span><br><span class="line">            <span class="comment">// â· åªæœ‰æœ€åä¸€ä¸ªå¼•ç”¨æ‰ä¼šè¿›æ¥</span></span><br><span class="line">            std::sync::atomic::<span class="title function_ invoke__">fence</span>(Ordering::Acquire); <span class="comment">// â¸ è¡¥ä¸Š Acquire</span></span><br><span class="line">            <span class="keyword">unsafe</span> &#123;</span><br><span class="line">                <span class="comment">// â¹ ç°åœ¨å¯ä»¥å®‰å…¨åœ°å›æ”¶å¹¶ææ„</span></span><br><span class="line">                <span class="title function_ invoke__">drop</span>(<span class="type">Box</span>::<span class="title function_ invoke__">from_raw</span>(<span class="keyword">self</span>.ptr.<span class="title function_ invoke__">as_ptr</span>()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ç°é€»è¾‘ï¼š</p><ol><li><strong>æ‰€æœ‰ drop</strong> éƒ½ç”¨ <code>Release</code> è¯­ä¹‰å‡å¼•ç”¨è®¡æ•°ï¼Œä¸ºå¯èƒ½çš„&quot;æœ€åä¸€æ¬¡ drop&quot;åšå‡†å¤‡</li><li><strong>åªæœ‰æœ€åä¸€æ¬¡ drop</strong>ï¼ˆè¿”å›å€¼ä¸º 1ï¼‰æ‰éœ€è¦é¢å¤–çš„ <code>fence(Acquire)</code> ä¸ä¹‹å‰æ‰€æœ‰çš„ Release å»ºç«‹ happens-before</li><li><strong>å®‰å…¨ææ„</strong>ï¼šç°åœ¨å¯ä»¥ç¡®ä¿çœ‹åˆ°æ‰€æœ‰å†å²å†™å…¥ï¼Œæ²¡äººå†æŒæœ‰å¼•ç”¨</li></ol><h3 id="å®Œæ•´ä»£ç ">å®Œæ•´ä»£ç </h3><p>è‡ªæ­¤ï¼Œæˆ‘ä»¬ç¬¬ä¸€ä¸ªç‰ˆæœ¬çš„ <code>Arc</code> å°±å®ç°å®Œæ¯•äº†ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æœ€ç»ˆå®Œæˆçš„ä»£ç ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::atomic::&#123;AtomicUsize, Ordering, fence&#125;;</span><br><span class="line"><span class="keyword">use</span> std::ptr::NonNull;</span><br><span class="line"><span class="keyword">use</span> std::ops::Deref;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ArcData</span>&lt;T&gt; &#123;</span><br><span class="line">    ref_count: AtomicUsize,</span><br><span class="line">    data: T,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    ptr: NonNull&lt;ArcData&lt;T&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Arc&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(data: T) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        Arc &#123;</span><br><span class="line">            ptr: NonNull::<span class="title function_ invoke__">from</span>(<span class="type">Box</span>::<span class="title function_ invoke__">leak</span>(<span class="type">Box</span>::<span class="title function_ invoke__">new</span>(ArcData &#123;</span><br><span class="line">                ref_count: AtomicUsize::<span class="title function_ invoke__">new</span>(<span class="number">1</span>),</span><br><span class="line">                data,</span><br><span class="line">            &#125;))),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">data</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;ArcData&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; <span class="keyword">self</span>.ptr.<span class="title function_ invoke__">as_ref</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T: <span class="built_in">Send</span> + <span class="built_in">Sync</span>&gt; <span class="built_in">Send</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;&#125;</span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T: <span class="built_in">Send</span> + <span class="built_in">Sync</span>&gt; <span class="built_in">Sync</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Deref <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Target</span> = T;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">deref</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="keyword">Self</span>::Target &#123;</span><br><span class="line">        &amp;<span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().data</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Clone</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">clone</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().ref_count.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Ordering::Relaxed);</span><br><span class="line">        Arc &#123; ptr: <span class="keyword">self</span>.ptr &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Drop</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().ref_count.<span class="title function_ invoke__">fetch_sub</span>(<span class="number">1</span>, Ordering::Release) == <span class="number">1</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">fence</span>(Ordering::Acquire);</span><br><span class="line">            <span class="keyword">unsafe</span> &#123;</span><br><span class="line">                <span class="title function_ invoke__">drop</span>(<span class="type">Box</span>::<span class="title function_ invoke__">from_raw</span>(<span class="keyword">self</span>.ptr.<span class="title function_ invoke__">as_ptr</span>()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å•å…ƒæµ‹è¯•">å•å…ƒæµ‹è¯•</h3><p>å†™ä¸ªå•å…ƒæµ‹è¯•éªŒè¯ä¸€ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">arc_should_work</span>() &#123;</span><br><span class="line">    <span class="keyword">static</span> NUM_DROPS: AtomicUsize = AtomicUsize::<span class="title function_ invoke__">new</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">DetectDrop</span>;</span><br><span class="line">    <span class="keyword">impl</span> <span class="title class_">Drop</span> <span class="keyword">for</span> <span class="title class_">DetectDrop</span> &#123;</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">            NUM_DROPS.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Ordering::Relaxed);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»º 2 ä¸ª Arc å…±äº«ä¸€ä¸ªå…ƒç»„ï¼ŒåŒ…å«ä¸€ä¸ªå­—ç¬¦ä¸²å’Œ DetectDrop å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = Arc::<span class="title function_ invoke__">new</span>((<span class="string">&quot;hedon&quot;</span>, DetectDrop));</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">y</span> = x.<span class="title function_ invoke__">clone</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°† x è½¬ç§»åˆ°å¦å¤–ä¸€ä¸ªçº¿ç¨‹å¹¶ä½¿ç”¨å®ƒ</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">t</span> = thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(x.<span class="number">0</span>, <span class="string">&quot;hedon&quot;</span>); <span class="comment">// å¯ä»¥æ­£å¸¸ä½¿ç”¨</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™é‡Œï¼Œy åº”è¯¥ä¹Ÿæ˜¯å¯ä»¥æ­£å¸¸ä½¿ç”¨çš„</span></span><br><span class="line">    <span class="built_in">assert_eq!</span>(y.<span class="number">0</span>, <span class="string">&quot;hedon&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾… t çº¿ç¨‹æ‰§è¡Œå®Œæ¯•</span></span><br><span class="line">    t.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™ä¸ªæ—¶å€™ `x` å·²ç»è¢«é‡Šæ”¾äº†ï¼Œä½†æ˜¯`y` è¿˜æ²¡æœ‰è¢«é‡Šæ”¾ï¼Œ</span></span><br><span class="line">    <span class="comment">// æ‰€ä»¥ `DetectDrop` åº”è¯¥è¿˜æ²¡è¢«é‡Šæ”¾ã€‚</span></span><br><span class="line">    <span class="built_in">assert_eq!</span>(NUM_DROPS.<span class="title function_ invoke__">load</span>(Ordering::Relaxed), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰‹åŠ¨é‡Šæ”¾æ‰ `y`ï¼Œè¿™æ˜¯æœ€åä¸€ä¸ª `Arc`ï¼Œæ‰€ä»¥ `DetectDrop` åº”è¯¥ä¼šè¢«é‡Šæ”¾</span></span><br><span class="line">    <span class="title function_ invoke__">drop</span>(y);</span><br><span class="line">    <span class="built_in">assert_eq!</span>(NUM_DROPS.<span class="title function_ invoke__">load</span>(Ordering::Relaxed), <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœæ˜¯ ok çš„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">running 1 test</span><br><span class="line">test arc::tests::arc_should_work ... ok</span><br><span class="line"></span><br><span class="line">successes:</span><br><span class="line"></span><br><span class="line">successes:</span><br><span class="line">    arc::tests::arc_should_work</span><br><span class="line"></span><br><span class="line">test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s</span><br></pre></td></tr></table></figure><h2 id="v1-å®ç°-get-mut-è·å–å¯å˜å¼•ç”¨">v1: å®ç° get_mut è·å–å¯å˜å¼•ç”¨</h2><p>æŒ‰ç…§å‰é¢ç‰ˆæœ¬çš„å®ç°ï¼Œæˆ‘ä»¬æ˜¯ä¸èƒ½ä¸º <code>Arc&lt;T&gt;</code> å®ç° <code>DerefMut</code> trait çš„ï¼Œå› ä¸ºæˆ‘ä»¬ä¸èƒ½æ— æ¡ä»¶åœ°æä¾› <code>&amp;mut T</code> å¯å˜å¼•ç”¨ï¼Œå› ä¸ºå®ƒå¯èƒ½åŒæ—¶è¢«å…¶ä»–çš„ <code>Arc&lt;T&gt;</code> æ‰€è®¿é—®ä¸­ã€‚</p><p>ä¸è¿‡ï¼Œå½“æ»¡è¶³ä¸€å®šæ¡ä»¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¯ä»¥æä¾› <code>&amp;mut T</code> å¯å˜å¼•ç”¨çš„ã€‚å…·ä½“æ¥è¯´ï¼Œéœ€è¦æ»¡è¶³ 2 ä¸ªæ¡ä»¶ï¼š</p><ol><li>ä½¿ç”¨ <code>&amp;mut Arc&lt;T&gt;</code> ä¿è¯å½“å‰ <code>Arc&lt;T&gt;</code> åªæœ‰ä¸€ä¸ªåœ°æ–¹åœ¨ä½¿ç”¨ï¼›</li><li>éœ€è¦ç¡®ä¿å…¨å±€åªæœ‰ä¸€ä¸ª <code>Arc&lt;T&gt;</code>ã€‚</li></ol><p>ä¸ºäº†é¿å…è·Ÿ <code>DerefMut</code> æ··æ·†ï¼Œæˆ‘ä»¬å°†å…¶å£°æ˜ä¸ºä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œå¹¶å°† <code>Arc&lt;T&gt;</code> ä½œä¸ºå‚æ•°ï¼ŒåŒæ—¶å› ä¸ºåªæœ‰æ»¡è¶³ç‰¹å®šæ¡ä»¶çš„æƒ…å†µä¸‹ï¼Œæ‰èƒ½è¿”å› <code>&amp;mut T</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ <code>Option</code> ä½œä¸ºè¿”å›å€¼ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">get_mut</span>(arc: &amp;<span class="keyword">mut</span> Arc&lt;T&gt;) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;&amp;<span class="keyword">mut</span> T&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> arc.<span class="title function_ invoke__">data</span>().ref_count.<span class="title function_ invoke__">load</span>(Ordering::Relaxed) == <span class="number">1</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">fence</span>(Ordering::Acquire);</span><br><span class="line">        <span class="comment">// Safety: æ²¡æœ‰å…¶ä»–åœ°æ–¹å¯ä»¥è®¿é—®æ•°æ®ï¼Œ</span></span><br><span class="line">        <span class="comment">// å› ä¸ºæˆ‘ä»¬ä½¿ç”¨äº† &amp;mut ç‹¬å å¼•ç”¨ï¼Œè€Œä¸”æ­¤æ—¶åªæœ‰ä¸€ä¸ª `Arc`ã€‚</span></span><br><span class="line">        <span class="keyword">unsafe</span> &#123; <span class="title function_ invoke__">Some</span>(&amp;<span class="keyword">mut</span> arc.ptr.<span class="title function_ invoke__">as_mut</span>().data) &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="literal">None</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li><p>è¿™é‡Œæˆ‘ä»¬åœ¨ç¡®å®šåªæœ‰ä¸€ä¸ª <code>Arc</code> å®ä¾‹çš„æ—¶å€™ï¼Œä½¿ç”¨ <code>fetch(Acquire)</code> æ¥è·Ÿæ‰€æœ‰å…¶ä»– <code>Arc</code> æ‰§è¡Œ <code>drop()</code> çš„ <code>fetch_sub(Release)</code> å»ºç«‹ happens-before å…³ç³»ã€‚</p></li><li><p>å› ä¸ºæ­¤æ—¶ <code>ref_count=1</code>ï¼Œè¯´æ˜ä»…æœ‰å½“å‰ <code>Arc</code> è¿™ä¸€ä¸ªå®ä¾‹ï¼Œè€Œ <code>get_mut</code> éœ€è¦çš„åˆæ˜¯ç‹¬å å¼•ç”¨ï¼Œæ‰€ä»¥å½“å‰ <code>Arc</code> ä¸å¯èƒ½å†è¢«æ‹¿å»åš <code>clone()</code> æ“ä½œï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªæƒ…å†µä¸‹ï¼Œæ˜¯å¯ä»¥ä¿è¯æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª <code>Arc</code> å®ä¾‹ï¼Œæ‰€ä»¥æˆ‘ä»¬æ˜¯å¯ä»¥å®‰å…¨è¿”å› <code>&amp;mut T</code> çš„ã€‚</p></li><li><p>è¿”å›çš„ <code>&amp;mut T</code> ä¼šéšå¼åœ°å€Ÿç”¨å‚æ•° <code>&amp;mut Arc&lt;T&gt;</code> çš„ç”Ÿå‘½å‘¨æœŸï¼Œè€Œ Rust ä¸å…è®¸å¯å˜å¼•ç”¨å’Œåªè¯»å¼•ç”¨äº¤å‰å­˜åœ¨ï¼Œæ‰€ä»¥å½“å‰ä»…å‰©çš„è¿™ä¸ª <code>Arc</code>ï¼Œç›´åˆ° <code>&amp;mut T</code> ä½œç”¨åŸŸç»“æŸä¹‹å‰ï¼Œéƒ½æ˜¯ä¸å¯ç”¨çš„ï¼Œæ‰€ä»¥åœ¨é‚£ä¹‹å‰ï¼Œä¸ä¼šå†è¢«æ‹¿å»æ‰§è¡Œ <code>clone()</code> å’Œ <code>Deref</code> ç­‰æ“ä½œï¼Œæ‰€ä»¥æ˜¯å®‰å…¨çš„ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">get_mut_should_be_safe</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">x</span> = Arc::<span class="title function_ invoke__">new</span>(<span class="built_in">vec!</span>[]);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">v</span> = Arc::<span class="title function_ invoke__">get_mut</span>(&amp;<span class="keyword">mut</span> x).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    v.<span class="title function_ invoke__">push</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">y</span> = x.<span class="title function_ invoke__">clone</span>(); <span class="comment">// &lt;---- cannot borrow `x` as immutable</span></span><br><span class="line">    v.<span class="title function_ invoke__">push</span>(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šé¢è¿™ä¸ªä¾‹å­ï¼Œå°±ä¼šæŠ¥é”™ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">error[E0502]: cannot borrow `x` as immutable because it is also borrowed as mutable</span><br><span class="line"><span class="meta prompt_">   --&gt; </span><span class="language-bash">src/arc.rs:117:17</span></span><br><span class="line">    |</span><br><span class="line">114 |         let v = Arc::get_mut(&amp;mut x).unwrap();</span><br><span class="line">    |                              ------ mutable borrow occurs here</span><br><span class="line">...</span><br><span class="line">117 |         let y = x.clone();</span><br><span class="line">    |                 ^ immutable borrow occurs here</span><br><span class="line">118 |         v.push(2);</span><br><span class="line">    |         - mutable borrow later used here</span><br></pre></td></tr></table></figure></li></ol><h2 id="v2-å¼±æŒ‡é’ˆ-Weak-T-è§£å†³å¾ªç¯å¼•ç”¨">v2: å¼±æŒ‡é’ˆ Weak&lt;T&gt; è§£å†³å¾ªç¯å¼•ç”¨</h2><h3 id="å¾ªç¯å¼•ç”¨é—®é¢˜åˆ†æ">å¾ªç¯å¼•ç”¨é—®é¢˜åˆ†æ</h3><pre class="mermaid">graph TDA --> B;A --> C;</pre><p>å¼•ç”¨è®¡æ•°åœ¨å„ç§æ•°æ®ç»“æ„çš„è¡¨ç¤ºä¸­éå¸¸æœ‰ç”¨ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºçš„æ ‘å½¢ç»“æ„ï¼Œå½“é‡Šæ”¾ A çš„æ—¶å€™ï¼Œå› ä¸º B å’Œ C ä¸å†è¢«å¼•ç”¨ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥é¡ºå¸¦é‡Šæ”¾äº†ã€‚</p><p>ä½†æ˜¯ï¼Œå¦‚æœ B å’Œ C ä¹ŸæŒæœ‰å¯¹ A çš„å¼•ç”¨ï¼Œå³å½¢æˆäº†å¾ªç¯å¼•ç”¨ï¼Œé‚£æŒ‰ç…§æˆ‘ä»¬ä¹‹å‰çš„å®ç°ï¼ŒAã€Bã€C éƒ½å°†æ°¸è¿œä¸ä¼šè¢«é‡Šæ”¾äº†ï¼Œå› ä¸ºå®ƒä»¬çš„å¼•ç”¨è®¡æ•°æ°¸ä¸ä¸º 0ï¼Œå“ªæ€•å®ƒä»¬ä¸‰è€…å‡ä¸å†è¢«ä½¿ç”¨ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><pre class="mermaid">graph TDA <--> B;A <--> C;B -.-> A;C -.-> A;</pre><p>ä¸ºäº†åº”å¯¹è¿™ç§åœºæ™¯ï¼ŒRust çš„æ ‡å‡†åº“ä¸­æå‡ºçš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼š<strong><code>Weak&lt;T&gt;</code>ï¼Œä¹Ÿç§°å¼±æŒ‡é’ˆ</strong>ã€‚<strong><code>T</code> å¯ä»¥åœ¨ <code>Arc&lt;T&gt;</code> å’Œ <code>Weak&lt;T&gt;</code> ä¹‹é—´å…±äº«ï¼Œå½“æ‰€æœ‰çš„ <code>Arc&lt;T&gt;</code> éƒ½å¤±æ•ˆçš„æ—¶å€™ï¼Œ<code>T</code> è¢«é‡Šæ”¾ï¼Œæ— è®ºæ­¤æ—¶æ˜¯å¦æœ‰ <code>Weak&lt;T&gt;</code> çš„å­˜åœ¨ã€‚</strong></p><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œçˆ¶èŠ‚ç‚¹å¯¹å­èŠ‚ç‚¹ä½¿ç”¨çš„æ˜¯å¼ºå¼•ç”¨ï¼Œç¡®ä¿äº†çˆ¶èŠ‚ç‚¹å­˜æ´»çš„æ—¶å€™ï¼Œå­èŠ‚ç‚¹éƒ½å­˜åœ¨ã€‚è€Œå­èŠ‚ç‚¹å¯¹çˆ¶èŠ‚ç‚¹ä½¿ç”¨çš„æ˜¯å¼±å¼•ç”¨ï¼Œåªå³ä¿ç•™äº†å­èŠ‚ç‚¹å›æº¯çˆ¶èŠ‚ç‚¹çš„èƒ½åŠ›ï¼Œä¹Ÿä¸ä¼šé˜»æ­¢çˆ¶èŠ‚ç‚¹çš„é‡Šæ”¾ã€‚</p><p>å½“çˆ¶èŠ‚ç‚¹è¢«é‡Šæ”¾æ—¶ï¼Œæ‰€æœ‰å¼ºå¼•ç”¨è®¡æ•°å½’é›¶ï¼ŒèŠ‚ç‚¹å¯ä»¥ä¾æ¬¡è¢«é‡Šæ”¾ã€‚</p><pre class="mermaid">graph TDA -- Arc --> B;A -- Arc --> C;B -.->|Weak| A;C -.->|Weak| A;</pre><h3 id="æ•°æ®ç»“æ„-2">æ•°æ®ç»“æ„</h3><p>OKï¼Œåšäº†è¿™ä¹ˆå¤šé“ºå«åï¼Œæˆ‘ä»¬æ¥æ€è€ƒä¸€ä¸‹ç°åœ¨çš„ <code>ArcData</code> è¯¥å¦‚ä½•è°ƒæ•´ã€‚</p><ol><li>ä¹‹å‰æˆ‘ä»¬ç”¨ <code>ref_count</code> åšå¼•ç”¨è®¡æ•°ï¼Œå®ƒä»£è¡¨çš„éƒ½æ˜¯å¼ºå¼•ç”¨ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦è®°å½•å¼±å¼•ç”¨æ•°é‡çš„ç›¸å…³å­—æ®µã€‚</li><li>å½“åªæœ‰å¼±å¼•ç”¨çš„æ—¶å€™ï¼Œ<code>data</code> å°±å·²ç»è¢«é‡Šæ”¾äº†ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ <code>None</code> æ¥è¡¨ç¤ºè¿™ç§æƒ…å†µï¼Œæ‰€ä»¥ <code>data</code> åº”è¯¥æ˜¯ä¸€ä¸ª <code>Option&lt;T&gt;</code> ç±»å‹ã€‚</li><li>å½“ <code>ArcData&lt;T&gt;</code> è¢«ä¸€ä¸ª <code>Arc</code> å’Œå¤šä¸ª <code>Weak</code> å…±äº«æ—¶ï¼Œé‡Šæ”¾æœ€åä¸€ä¸ª <code>Arc</code> æ—¶ï¼Œæˆ‘ä»¬ä»…æ‹¥æœ‰ <code>&amp;ArcData&lt;T&gt;</code> ä¸å¯å˜å¼•ç”¨ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦å°†å…¶ä» <code>Some(T)</code> ç½®ä¸º <code>None</code>ï¼Œå³è¦åœ¨ä¸å¯å˜å¼•ç”¨ä¸Šå®ç°ä¿®æ”¹ï¼Œè¿™å°±æ¶‰åŠåˆ°äº†å‰å‡ ç¯‡æåˆ°çš„ï¼š<strong>å†…éƒ¨å¯å˜æ€§</strong>ã€‚<strong>UnsafeCell</strong> æ˜¯ Rust æä¾›çš„ä¸€ä¸ªå†…éƒ¨å¯å˜æ€§å·¥å…·ç±»å‹ï¼Œå®ƒåŒ…è£…ä¸€ä¸ªæ•°æ®ï¼Œä½¿å¾—å³ä½¿åœ¨åªæœ‰ä¸å¯å˜å¼•ç”¨çš„æƒ…å†µä¸‹ä¹Ÿå¯ä»¥è¿›è¡Œä¿®æ”¹ï¼ˆå½“ç„¶éœ€è¦åœ¨ <code>unsafe</code> å—ä¸­æ“ä½œï¼‰ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°† <code>data</code> å†ç”¨ <code>UnsafeCell</code> åŒ…ä¸€å±‚ï¼Œä»¥æ»¡è¶³æ­¤åœºæ™¯çš„éœ€æ±‚ã€‚</li></ol><p>ç»¼ä¸Šï¼Œæœ€æ–°çš„ <code>ArcData</code> å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ArcData</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">// `Arc` çš„æ•°é‡ï¼Œä¹Ÿå³æ•°æ® T çš„å¼ºå¼•ç”¨è®¡æ•°ã€‚</span></span><br><span class="line">    data_ref_count: AtomicUsize,</span><br><span class="line">    <span class="comment">// `Arc` + `Weak` çš„æ•°é‡ã€‚</span></span><br><span class="line">    alloc_ref_count: AtomicUsize,</span><br><span class="line">    <span class="comment">// æ•°æ®ï¼Œå½“åªæœ‰ `Weak` çš„æ—¶å€™ï¼Œä¸º Noneã€‚</span></span><br><span class="line">    data: UnsafeCell&lt;<span class="type">Option</span>&lt;T&gt;&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªæ–°ç»“æ„ <code>Weak&lt;T&gt;</code> ï¼Œç”¨æ¥è¡¨ç¤ºå¼±å¼•ç”¨ï¼Œå‡å®šè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°†ç»´æŠ¤ <code>ArcData</code> å­˜æ´»çš„èŒè´£äº¤ç»™ <code>Weak&lt;T&gt;</code>ï¼Œé‚£å°±å¯ä»¥å°† <code>ArcData</code> è½¬ç»™ <code>Weak&lt;T&gt;</code> æŒæœ‰ï¼Œç„¶ååœ¨ <code>Arc&lt;T&gt;</code> ä¸­æŒæœ‰ä¸€ä¸ª <code>Weak&lt;T&gt;</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ArcData</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">// `Arc` çš„æ•°é‡ï¼Œä¹Ÿå³æ•°æ® T çš„å¼ºå¼•ç”¨è®¡æ•°ã€‚</span></span><br><span class="line">    data_ref_count: AtomicUsize,</span><br><span class="line">    <span class="comment">// `Arc` + `Weak` çš„æ•°é‡ã€‚</span></span><br><span class="line">    alloc_ref_count: AtomicUsize,</span><br><span class="line">    <span class="comment">// æ•°æ®ï¼Œå½“åªæœ‰ `Weak` çš„æ—¶å€™ï¼Œä¸º Noneã€‚</span></span><br><span class="line">    data: UnsafeCell&lt;<span class="type">Option</span>&lt;T&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    weak: Weak&lt;T&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Weak</span>&lt;T&gt; &#123;</span><br><span class="line">    ptr: NonNull&lt;ArcData&lt;T&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T: <span class="built_in">Send</span> + <span class="built_in">Sync</span>&gt; <span class="built_in">Send</span> <span class="keyword">for</span> <span class="title class_">Weak</span>&lt;T&gt; &#123;&#125;</span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T: <span class="built_in">Send</span> + <span class="built_in">Sync</span>&gt; <span class="built_in">Sync</span> <span class="keyword">for</span> <span class="title class_">Weak</span>&lt;T&gt; &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Arc&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(data: T) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        Arc &#123;</span><br><span class="line">            weak: Weak &#123;</span><br><span class="line">                ptr: NonNull::<span class="title function_ invoke__">from</span>(<span class="type">Box</span>::<span class="title function_ invoke__">leak</span>(<span class="type">Box</span>::<span class="title function_ invoke__">new</span>(ArcData &#123;</span><br><span class="line">                    alloc_ref_count: AtomicUsize::<span class="title function_ invoke__">new</span>(<span class="number">1</span>),</span><br><span class="line">                    data_ref_count: AtomicUsize::<span class="title function_ invoke__">new</span>(<span class="number">1</span>),</span><br><span class="line">                    data: UnsafeCell::<span class="title function_ invoke__">new</span>(<span class="title function_ invoke__">Some</span>(data)),</span><br><span class="line">                &#125;))),</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Weak&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">data</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;ArcData&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; <span class="keyword">self</span>.ptr.<span class="title function_ invoke__">as_ref</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Deref <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Target</span> = T;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">deref</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="keyword">Self</span>::Target &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">ptr</span> = <span class="keyword">self</span>.weak.<span class="title function_ invoke__">data</span>().data.<span class="title function_ invoke__">get</span>();</span><br><span class="line">        <span class="comment">// Safety: è¿™ä¸ªæ—¶å€™è¿˜æœ‰ Arc å­˜åœ¨ï¼Œæ‰€ä»¥ data è‚¯å®šæ˜¯ç”Ÿæ•ˆçš„ã€‚</span></span><br><span class="line">        <span class="keyword">unsafe</span> &#123; (*ptr).<span class="title function_ invoke__">as_ref</span>().<span class="title function_ invoke__">unwrap</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œé™¤äº†æ•°æ®ç»“æ„ä¹‹å¤–ï¼Œæˆ‘ä»¬åšäº† 3 ç‚¹è°ƒæ•´ï¼š</p><ol><li>åªéœ€è¦ä¸º <code>Weak&lt;T&gt;</code> å®ç° <code>Sync</code> å’Œ <code>Send</code> traitï¼Œè¿™ä¸ªæ—¶å€™ <code>Arc&lt;T&gt;</code> å°±ä¼šè¢«è‡ªåŠ¨å®ç°è¿™ 2 ä¸ª triatã€‚</li><li><code>data(&amp;self)</code> è¾…åŠ©å‡½æ•°ï¼Œç§»åˆ°äº† <code>Weak&lt;T&gt;</code> èº«ä¸Šã€‚</li><li><code>Arc&lt;T&gt;</code> è¦ä» <code>Deref</code> è·å– <code>&amp;T</code>ï¼Œéœ€è¦å…ˆç»è¿‡ä¸€é“ <code>Weak&lt;T&gt;</code>ã€‚</li></ol><pre class="mermaid">graph LR    subgraph Stack ["æ ˆå†…å­˜ Stack"]        ArcStruct["Arc&lt;T&gt;<br/>weak: Weak&lt;T&gt;"]        WeakStruct["Weak&lt;T&gt;<br/>ptr: NonNull&lt;ArcData&lt;T&gt;&gt;"]    end    subgraph Heap ["å †å†…å­˜ Heap"]        ArcDataStruct["ArcData&lt;T&gt;<br/>data_ref_count: AtomicUsize(1)<br/>alloc_ref_count: AtomicUsize(1)<br/>data: UnsafeCell&lt;Option&lt;T&gt;&gt;"]    end    ArcStruct -->|åŒ…å«| WeakStruct    WeakStruct -->|æŒ‡å‘| ArcDataStruct    classDef stackStyle fill:#e1f5fe,stroke:#01579b,stroke-width:2px    classDef heapStyle fill:#f3e5f5,stroke:#4a148c,stroke-width:2px    classDef processStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px    classDef refStyle fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px    class ArcStruct,WeakStruct stackStyle    class ArcDataStruct heapStyle    class Step1,Step2,Step3,Step4,Step5 processStyle    class DataRef,AllocRef,DataContent refStyle</pre><h3 id="ç»´æŠ¤å¼•ç”¨è®¡æ•°-2">ç»´æŠ¤å¼•ç”¨è®¡æ•°</h3><p>ç°åœ¨é‡ç‚¹æ¥äº†ï¼Œæˆ‘ä»¬éœ€è¦æ¥æ€è€ƒ <code>Weak&lt;T&gt;</code> å’Œ <code>Arc&lt;T&gt;</code> çš„ <code>Clone</code> å’Œ <code>Drop</code> è¯¥å¦‚ä½•å®ç°ã€‚å…¶å®é‡ç‚¹å°±æ˜¯è¯¥<strong>å¦‚ä½•ç®¡ç† <code>alloc_ref_count</code> å’Œ <code>data_ref_count</code> çš„è®¡æ•°</strong>ã€‚</p><p>å†æ¬¡æ˜ç¡®ä¸‹æˆ‘ä»¬çš„å®šä¹‰ï¼š</p><ul><li><code>data_ref_count</code>: ä»£è¡¨çš„æ˜¯å¼ºå¼•ç”¨ <code>Arc&lt;T&gt;</code> çš„æ•°é‡ã€‚</li><li><code>alloc_ref_count</code>: ä»£è¡¨çš„æ˜¯ <code>Arc&lt;T&gt;</code> + <code>Weak&lt;T&gt;</code> çš„æ•°é‡ã€‚</li></ul><p>å› æ­¤ï¼š</p><ul><li>Clone:<ul><li>å½“ <code>Weak&lt;T&gt;</code> æ‹·è´æ—¶ï¼Œä»…å¢åŠ äº†å¼±å¼•ç”¨çš„æ•°é‡ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€å¯¹ <code>alloc_ref_count</code> è¿›è¡Œè‡ªå¢ã€‚</li><li>å½“ <code>Arc&lt;T&gt;</code> æ‹·è´æ—¶ï¼Œä¸ä»…éœ€è¦æ‹·è´å†…éƒ¨çš„ <code>Weak&lt;T&gt;</code>ï¼Œè¿˜å¢åŠ äº†å¼ºå¼•ç”¨çš„æ•°é‡ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦å¯¹ <code>data_ref_count</code> è¿›è¡Œè‡ªå¢ã€‚</li></ul></li><li>Drop:<ul><li>å½“ <code>Arc&lt;T&gt;</code> è¢«é‡Šæ”¾æ—¶ï¼Œä¸ä»…é‡Šæ”¾äº†å…¶å†…éƒ¨çš„ <code>Weak&lt;T&gt;</code>ï¼Œè¿˜å‡å°‘äº†ä¸€ä¸ªå¼ºå¼•ç”¨ï¼Œæ‰€ä»¥éœ€è¦å¯¹ <code>data_ref_count</code> è¿›è¡Œè‡ªå‡ã€‚å¦å¤–ï¼Œå¦‚æœæ˜¯æœ€åä¸€ä¸ª <code>Arc&lt;T&gt;</code> è¢«é‡Šæ”¾ï¼Œæˆ‘ä»¬éœ€è¦å°† <code>ArcData&lt;T&gt;.data</code> ç½®ä¸º <code>None</code>ã€‚</li><li>å½“ <code>Weak&lt;T&gt;</code> è¢«é‡Šæ”¾æ—¶ï¼Œæˆ‘ä»¬ä»…éœ€å‡å°‘å¼±å¼•ç”¨çš„æ•°é‡ï¼Œå³å¯¹ <code>alloc_ref_count</code> è¿›è¡Œè‡ªå‡ã€‚å¦å¤–ï¼Œå½“æœ€åä¸€ä¸ª <code>Weak&lt;T&gt;</code> è¢«é‡Šæ”¾æ—¶ï¼ˆæ­¤æ—¶è‚¯å®šä¹Ÿæ²¡æœ‰ <code>Arc&lt;T&gt;</code> äº†ï¼‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è´Ÿè´£é‡Šæ”¾ <code>ArcData&lt;T&gt;</code> ã€‚</li></ul></li></ul><p>ç»¼ä¸Šï¼Œæˆ‘ä»¬çš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Clone</span> <span class="keyword">for</span> <span class="title class_">Weak</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">clone</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().alloc_ref_count.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Ordering::Relaxed) &gt; <span class="type">usize</span>::MAX / <span class="number">2</span> &#123;</span><br><span class="line">            std::process::<span class="title function_ invoke__">abort</span>();</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">Self</span> &#123; ptr: <span class="keyword">self</span>.ptr &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Clone</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">clone</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">weak</span> = <span class="keyword">self</span>.weak.<span class="title function_ invoke__">clone</span>();</span><br><span class="line">        <span class="keyword">if</span> weak.<span class="title function_ invoke__">data</span>().data_ref_count.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Ordering::Relaxed) &gt; <span class="type">usize</span>::MAX / <span class="number">2</span> &#123;</span><br><span class="line">            std::process::<span class="title function_ invoke__">abort</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        Arc &#123; weak &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Drop</span> <span class="keyword">for</span> <span class="title class_">Weak</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().alloc_ref_count.<span class="title function_ invoke__">fetch_sub</span>(<span class="number">1</span>, Ordering::Release) == <span class="number">1</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">fence</span>(Ordering::Acquire);</span><br><span class="line">            <span class="comment">// Safety: æœ€åä¸€ä¸ª Weak&lt;T&gt; å·²ç»è¢«é‡Šæ”¾äº†ã€‚</span></span><br><span class="line">            <span class="keyword">unsafe</span> &#123;</span><br><span class="line">                <span class="title function_ invoke__">drop</span>(<span class="type">Box</span>::<span class="title function_ invoke__">from_raw</span>(<span class="keyword">self</span>.ptr.<span class="title function_ invoke__">as_ptr</span>()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Drop</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span></span><br><span class="line">            .weak</span><br><span class="line">            .<span class="title function_ invoke__">data</span>()</span><br><span class="line">            .data_ref_count</span><br><span class="line">            .<span class="title function_ invoke__">fetch_sub</span>(<span class="number">1</span>, Ordering::Release)</span><br><span class="line">            == <span class="number">1</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="title function_ invoke__">fence</span>(Ordering::Acquire);</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">ptr</span> = <span class="keyword">self</span>.weak.<span class="title function_ invoke__">data</span>().data.<span class="title function_ invoke__">get</span>();</span><br><span class="line">            <span class="comment">// Safety: data_ref_count å·²ç»ä¸º 0 äº†ï¼Œæ²¡æœ‰åœ°æ–¹åœ¨ä½¿ç”¨ data äº†ã€‚</span></span><br><span class="line">            <span class="keyword">unsafe</span> &#123; (*ptr) = <span class="literal">None</span> &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œè€ƒè™‘åˆ°å®é™…åœºæ™¯ä¸­çš„å†…å­˜é™åˆ¶ï¼Œæˆ‘ä»¬å¯¹å¼•ç”¨è®¡æ•°è¿›è¡Œäº†ç®€å•çš„é™åˆ¶ï¼Œå½“å…¶è¶…è¿‡ <code>usize::Max/2</code> çš„æ—¶å€™ï¼Œå°±æ‰§è¡Œ <code>std::process:abort()</code> è®©æ•´ä¸ªè¿›ç¨‹å´©æºƒã€‚</p></blockquote><h3 id="get-mut">get_mut()</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥è€ƒè™‘ä¸‹ <code>get_mut(arc: &amp;mut Arc&lt;T&gt;)</code> è¯¥å¦‚ä½•ä¿®æ”¹ã€‚ä»€ä¹ˆæ—¶å€™å¯ä»¥è¿”å› <code>&amp;mut T</code>ï¼Œå¾ˆæ˜æ˜¾ï¼Œ<strong>å½“ä¸”ä»…å½“åªæœ‰ä¸€ä¸ª <code>Arc&lt;T&gt;</code> çš„æ—¶å€™æ‰å¯ä»¥</strong>ã€‚</p><p>æ•… <code>get_mut</code> çš„å®ç°ä¿®æ”¹å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">get_mut</span>(arc: &amp;<span class="keyword">mut</span> Arc&lt;T&gt;) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;&amp;<span class="keyword">mut</span> T&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> arc.weak.<span class="title function_ invoke__">data</span>().alloc_ref_count.<span class="title function_ invoke__">load</span>(Ordering::Relaxed) == <span class="number">1</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">fence</span>(Ordering::Acquire);</span><br><span class="line">        <span class="comment">// Safety: è¿™ä¸ªæ—¶å€™æ²¡æœ‰å…¶ä»–åœ°æ–¹èƒ½ä½¿ç”¨æ•°æ®ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ª `Arc`ï¼Œ</span></span><br><span class="line">        <span class="comment">// åŒæ—¶æˆ‘ä»¬æ‹¥æœ‰ä»…å­˜çš„è¿™ä¸ª `Arc` çš„ä¸å¯å˜å¼•ç”¨ã€‚</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">arcdata</span> = <span class="keyword">unsafe</span> &#123; arc.weak.ptr.<span class="title function_ invoke__">as_mut</span>() &#125;;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">option</span> = arcdata.data.<span class="title function_ invoke__">get_mut</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">data</span> = option.<span class="title function_ invoke__">as_mut</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(data)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="literal">None</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬æ‰§è¡Œä¹‹å‰çš„ <code>arc_should_work</code> æµ‹è¯•ç”¨ä¾‹ï¼Œå¯ä»¥å‘ç°æ˜¯é¡ºåˆ©é€šè¿‡çš„ã€‚</p><h3 id="dowgrade">dowgrade()</h3><p>å›é¡¾ä¸‹é¢è¿™å¼ å›¾ï¼Œä¸ºäº†æä¾› A çš„ <code>Weak&lt;T&gt;</code> æŒ‡é’ˆï¼Œæˆ‘ä»¬éœ€è¦ç»™ <code>Arc&lt;T&gt;</code> æä¾›ä¸€ä¸ª <code>downgrade()</code> æ–¹æ³•ï¼Œç”¨äºå°†å¼ºå¼•ç”¨é™ä¸ºå¼±å¼•ç”¨ï¼Œè¿™æ˜¯å¿…ç„¶å¯ä»¥æˆåŠŸçš„ã€‚åŒæ—¶ï¼Œå½“æˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸º <code>Weak&lt;T&gt;</code> æä¾›ä¸€ä¸ª <code>upgrade()</code> æ–¹æ³•ï¼Œç”¨äºæŒæœ‰å¼±å¼•ç”¨çš„æƒ…å†µä¸‹å¯ä»¥å°è¯•è®¿é—®æ•°æ®ï¼Œå½“ç„¶è¿™æœªå¿…èƒ½æˆåŠŸã€‚</p><pre class="mermaid">graph TDA -- Arc --> B;A -- Arc --> C;B -.->|Weak| A;C -.->|Weak| A;</pre><p><code>downgrade()</code> æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬ç›´æ¥ <code>clone()</code> ä¸€ä¸ª <code>Weak&lt;T&gt;</code> å°±å¯ä»¥äº†ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; Arc&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">downgrade</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> Weak&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.weak.<span class="title function_ invoke__">clone</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="upgrade">upgrade()</h3><p><code>upgrade()</code> å°±æ¯”è¾ƒå¤æ‚äº†ï¼Œåªæœ‰å½“å­˜åœ¨ <code>Arc</code> çš„æ—¶å€™ï¼Œ<code>data</code> æ‰æ²¡è¢«é‡Šæ”¾ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæ‰èƒ½è¿”å›å‡çº§åçš„ <code>Arc&lt;T&gt;</code>ï¼Œå³è¦æ±‚ <code>data_ref_count&gt;0</code>ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; Weak&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">upgrade</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;Arc&lt;T&gt;&gt; &#123;</span><br><span class="line">      <span class="comment">// è·å– data_ref_count çš„å€¼</span></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">n</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().data_ref_count.<span class="title function_ invoke__">load</span>(Ordering::Relaxed);</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">          <span class="comment">// å¦‚æœç­‰äº 0ï¼Œåˆ™è¯´æ˜ data å·²ç»è¢«é‡Šæ”¾äº†ï¼Œç›´æ¥è¿”å› None</span></span><br><span class="line">            <span class="keyword">if</span> n == <span class="number">0</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">assert!</span>(n &lt; <span class="type">usize</span>::MAX);</span><br><span class="line">          <span class="comment">// ä¸ä¸º 0 çš„è¯ï¼Œdata_ref_count å°è¯•è¿›è¡Œ +1ï¼Œå¤±è´¥äº†å°±é‡è¯•</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Err</span>(e) = <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().data_ref_count.<span class="title function_ invoke__">compare_exchange_weak</span>(</span><br><span class="line">                n,</span><br><span class="line">                n + <span class="number">1</span>,</span><br><span class="line">                Ordering::Relaxed,</span><br><span class="line">                Ordering::Relaxed,</span><br><span class="line">            ) &#123;</span><br><span class="line">                n = e;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          <span class="comment">// æˆåŠŸäº†ï¼Œåˆ™ clone weak å³å¯ï¼ˆæ‰§è¡Œ alloc_ref_count++ï¼‰</span></span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">Some</span>(Arc &#123; weak: <span class="keyword">self</span>.<span class="title function_ invoke__">clone</span>() &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥å†™ä¸€ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼ŒéªŒè¯ä½¿ç”¨äº† <code>Weak&lt;T&gt;</code> åï¼Œæˆ‘ä»¬çš„èµ„æºèƒ½å¦æ­£ç¡®é‡Šæ”¾ã€‚åœ¨è¿™ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå†™ä¸€ä¸ªé <code>Weak&lt;T&gt;</code> ç‰ˆæœ¬çš„ï¼Œçœ‹çœ‹èµ„æºæ˜¯å¦çœŸçš„æ²¡æœ‰è¢«é‡Šæ”¾ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">no_weak_should_not_free_resource</span>() &#123;</span><br><span class="line">    <span class="keyword">static</span> NUM_DROPS: AtomicUsize = AtomicUsize::<span class="title function_ invoke__">new</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">      <span class="comment">// ä½¿ç”¨ RefCellï¼Œåˆ©ç”¨å…¶å†…éƒ¨å¯å˜æ€§ï¼Œæ–¹ä¾¿æˆ‘ä»¬å»ºç«‹çˆ¶å­å…³ç³»</span></span><br><span class="line">        child: RefCell&lt;<span class="type">Vec</span>&lt;Arc&lt;Node&gt;&gt;&gt;,</span><br><span class="line">        parent: RefCell&lt;<span class="type">Option</span>&lt;Arc&lt;Node&gt;&gt;&gt;, <span class="comment">// &lt;---- è¿™é‡ŒæŒæœ‰çš„æ˜¯å¼ºå¼•ç”¨</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">impl</span> <span class="title class_">Drop</span> <span class="keyword">for</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">            NUM_DROPS.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Ordering::Relaxed);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">impl</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">        <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">            <span class="keyword">Self</span> &#123;</span><br><span class="line">                child: RefCell::<span class="title function_ invoke__">new</span>(<span class="built_in">vec!</span>[]),</span><br><span class="line">                parent: RefCell::<span class="title function_ invoke__">new</span>(<span class="literal">None</span>),</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å»ºç«‹çˆ¶å­å…³ç³»</span></span><br><span class="line">        <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">add_child</span>(parent: &amp;Arc&lt;Node&gt;, child: Arc&lt;Node&gt;) &#123;</span><br><span class="line">            *child.parent.<span class="title function_ invoke__">borrow_mut</span>() = <span class="title function_ invoke__">Some</span>(parent.<span class="title function_ invoke__">clone</span>());</span><br><span class="line">            parent.child.<span class="title function_ invoke__">borrow_mut</span>().<span class="title function_ invoke__">push</span>(child);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é™å®šä½œç”¨åŸŸï¼Œç¦»å¼€ä½œç”¨åŸŸåï¼Œroot/child1/child2 æ­£å¸¸æƒ…å†µåº”è¯¥è¢«é‡Šæ”¾ã€‚</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">root</span> = Arc::<span class="title function_ invoke__">new</span>(Node::<span class="title function_ invoke__">new</span>());</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">child1</span> = Arc::<span class="title function_ invoke__">new</span>(Node::<span class="title function_ invoke__">new</span>());</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">child2</span> = Arc::<span class="title function_ invoke__">new</span>(Node::<span class="title function_ invoke__">new</span>());</span><br><span class="line"></span><br><span class="line">        Node::<span class="title function_ invoke__">add_child</span>(&amp;root, child1);</span><br><span class="line">        Node::<span class="title function_ invoke__">add_child</span>(&amp;root, child2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">assert_ne!</span>(NUM_DROPS.<span class="title function_ invoke__">load</span>(Ordering::Relaxed), <span class="number">3</span>); <span class="comment">// ä¸ä¸º 3</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œä¸Šè¿°ç”¨ä¾‹åï¼Œæˆ‘ä»¬å¯ä»¥å‘ç° <code>NUM_DROPS</code> è¿˜æ˜¯ 0ï¼Œå³ <code>root/child1/child2</code> å‡æ²¡æœ‰è¢«é‡Šæ”¾èµ„æºã€‚</p><p>ä½ å¯ä»¥å°† <code>parent</code> çš„å¼•ç”¨ä¿®æ”¹ä¸ºå¼±å¼•ç”¨ï¼Œç„¶åå†é‡æ–°æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ï¼Œå°±ä¼šå‘ç° <code>root/child1/child2</code> çš„èµ„æºéƒ½è¢«æ­£ç¡®é‡Šæ”¾äº†ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">    child: RefCell&lt;<span class="type">Vec</span>&lt;Arc&lt;Node&gt;&gt;&gt;,</span><br><span class="line">    parent: RefCell&lt;<span class="type">Option</span>&lt;Weak&lt;Node&gt;&gt;&gt;, <span class="comment">// &lt;---- è¿™é‡ŒæŒæœ‰çš„æ˜¯å¼±å¼•ç”¨</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            child: RefCell::<span class="title function_ invoke__">new</span>(<span class="built_in">vec!</span>[]),</span><br><span class="line">            parent: RefCell::<span class="title function_ invoke__">new</span>(<span class="literal">None</span>),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å»ºç«‹çˆ¶å­å…³ç³»</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">add_child</span>(parent: &amp;Arc&lt;Node&gt;, child: Arc&lt;Node&gt;) &#123;</span><br><span class="line">        *child.parent.<span class="title function_ invoke__">borrow_mut</span>() = <span class="title function_ invoke__">Some</span>(parent.<span class="title function_ invoke__">downgrade</span>()); <span class="comment">// &lt;---- ä½¿ç”¨ downgrade è½¬ä¸ºå¼±å¼•ç”¨</span></span><br><span class="line">        parent.child.<span class="title function_ invoke__">borrow_mut</span>().<span class="title function_ invoke__">push</span>(child);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="v3-åˆ†ç¦»å¼ºå¼±å¼•ç”¨ï¼Œé¿å…æ— ç”¨æ¶ˆè€—">v3: åˆ†ç¦»å¼ºå¼±å¼•ç”¨ï¼Œé¿å…æ— ç”¨æ¶ˆè€—</h2><p>ä¸Šä¸ªç‰ˆæœ¬æˆ‘ä»¬é€šè¿‡å¼•å…¥äº†å¼±å¼•ç”¨ <code>Weak&lt;T&gt;</code>ï¼ŒæˆåŠŸè§£å†³äº†å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼Œè¿™æ˜¯ä¸ªéå¸¸å¤§çš„è¿›æ­¥ï¼</p><p>ä¸è¿‡æˆ‘ä»¬ä»ç„¶æœ‰è¿›ä¸€æ­¥ä¼˜åŒ–çš„ç©ºé—´ï¼Œå¯ä»¥è§‚å¯Ÿåˆ°ï¼Œ<code>Arc&lt;T&gt;</code> çš„æ¯æ¬¡æ‹·è´ï¼Œéƒ½ä¼šä¼´éšä¸€æ¬¡æ‹·è´ <code>Weak&lt;T&gt;</code>ï¼Œä½†æ˜¯ï¼Œå¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬å…¶å®æ²¡æœ‰å¾ªç¯å¼•ç”¨å…³ç³»çš„ï¼Œä¹Ÿå³æˆ‘ä»¬å¹¶ä¸æ˜¯æ¯ä¸€æ¬¡éƒ½éœ€è¦ <code>Weak&lt;T&gt;</code>ï¼Œæ‰€ä»¥ä¸Šä¸ªç‰ˆæœ¬çš„å®ç°ï¼Œå…¶å®æ˜¯æœ‰å¾ˆå¤šçš„æµªè´¹çš„ã€‚</p><h3 id="æ•°æ®ç»“æ„-3">æ•°æ®ç»“æ„</h3><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è€ƒè™‘å°† <code>Weak&lt;T&gt;</code> ä» <code>Arc&lt;T&gt;</code> ä¸­åˆ†ç¦»å‡ºæ¥ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    ptr: NonNull&lt;ArcData&lt;T&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T: <span class="built_in">Send</span> + <span class="built_in">Sync</span>&gt; <span class="built_in">Send</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;&#125;</span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T: <span class="built_in">Send</span> + <span class="built_in">Sync</span>&gt; <span class="built_in">Sync</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Weak</span>&lt;T&gt; &#123;</span><br><span class="line">    ptr: NonNull&lt;ArcData&lt;T&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T: <span class="built_in">Send</span> + <span class="built_in">Sync</span>&gt; <span class="built_in">Send</span> <span class="keyword">for</span> <span class="title class_">Weak</span>&lt;T&gt; &#123;&#125;</span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T: <span class="built_in">Send</span> + <span class="built_in">Sync</span>&gt; <span class="built_in">Sync</span> <span class="keyword">for</span> <span class="title class_">Weak</span>&lt;T&gt; &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Arc&lt;T&gt; &#123;</span><br><span class="line">  <span class="comment">// è°ƒæ•´ Arc çš„æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(data: T) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        Arc &#123;</span><br><span class="line">            ptr: NonNull::<span class="title function_ invoke__">from</span>(<span class="type">Box</span>::<span class="title function_ invoke__">leak</span>(<span class="type">Box</span>::<span class="title function_ invoke__">new</span>(ArcData &#123;</span><br><span class="line">                data_ref_count: AtomicUsize::<span class="title function_ invoke__">new</span>(<span class="number">1</span>),</span><br><span class="line">                alloc_ref_count: AtomicUsize::<span class="title function_ invoke__">new</span>(<span class="number">1</span>),</span><br><span class="line">                data: UnsafeCell::<span class="title function_ invoke__">new</span>(ManuallyDrop::<span class="title function_ invoke__">new</span>(data)),</span><br><span class="line">            &#125;))),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Arc å·²ç»æ²¡æœ‰ Weak äº†ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæ—¶å€™ç»™å®ƒè¡¥ä¸€ä¸ª data() è¾…åŠ©å‡½æ•°</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">data</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;ArcData&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; <span class="keyword">self</span>.ptr.<span class="title function_ invoke__">as_ref</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›¸åº”åœ°è°ƒæ•´ Deref</span></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Deref <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Target</span> = T;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">deref</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="keyword">Self</span>::Target &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; &amp;*<span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().data.<span class="title function_ invoke__">get</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ—¶æˆ‘ä»¬éœ€è¦å¯¹ <code>ArcData&lt;T&gt;</code> ç»“æ„ä¸­çš„å¼•ç”¨æŠ€æœ¯è¿›è¡Œé‡æ–°å®šä¹‰ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ArcData</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">// `Arc` çš„æ•°é‡</span></span><br><span class="line">    data_ref_count: AtomicUsize,</span><br><span class="line">    <span class="comment">// `Weak` çš„æ•°é‡ï¼Œå½“å­˜åœ¨ `Arc` æ—¶ï¼Œé¢å¤–åŠ  1</span></span><br><span class="line">    alloc_ref_count: AtomicUsize,</span><br><span class="line">    <span class="comment">// æ•°æ®ï¼Œå½“åªæœ‰ `Weak` çš„æ—¶å€™ï¼Œé‡Šæ”¾å®ƒã€‚</span></span><br><span class="line">    data: UnsafeCell&lt;ManuallyDrop&lt;T&gt;&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ€»å…±åšäº† 3 ä¸ªé‡è¦çš„è°ƒæ•´ï¼š</p><ol><li><p><code>Arc&lt;T&gt;</code> ä¸å†åŒ…å« <code>Weak&lt;T&gt;</code>ï¼Œè€Œæ˜¯å„è‡ªç‹¬ç«‹ï¼Œä¸è¿‡å®ƒä»¬ä¹‹å‰ä¼šå…±äº«åº•å±‚çš„ <code>ArcData&lt;T&gt;</code>ã€‚</p></li><li><p><code>alloc_ref_count</code> çš„è¯­ä¹‰ï¼Œä»**â€œArc + Weak çš„æ•°é‡**â€ï¼Œå˜æˆ&quot;<strong>Weak çš„æ•°é‡ï¼Œå½“å­˜åœ¨ Arc æ—¶ï¼Œé¢å¤–åŠ  1</strong>&quot;ã€‚</p><blockquote><p>æ¢è¨€ä¹‹ï¼Œå¯¹äºæ‰€æœ‰çš„ <code>Arc&lt;T&gt;</code>ï¼Œéƒ½å…±æœ‰ä¸€ä¸ªéšå¼çš„ <code>Weak&lt;T&gt;</code> ï¼Œå½“é‡Šæ”¾æœ€åä¸€ä¸ª <code>Arc&lt;T&gt;</code> çš„æ—¶å€™ï¼Œè¿™ä¸ªéšå¼çš„ <code>Weak&lt;T&gt;</code> ä¹Ÿéœ€è¦è¢«é‡Šæ”¾ï¼ˆæœ¬è´¨æ˜¯æ‰§è¡Œ alloc_ref_count å‡ä¸€ï¼ŒåŒæ—¶å¦‚æœæ²¡æœ‰å…¶ä»–çš„ <code>Weak&lt;T&gt;</code>ï¼Œéœ€è¦é¡ºå¸¦é‡Šæ”¾ <code>ArcData&lt;T&gt;</code>ã€‚</p></blockquote></li><li><p><code>data</code> å­—æ®µï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>ManuallyDrop</code> æ¥æ›¿ä»£ <code>Option</code>ï¼Œæˆ‘ä»¬ä¹‹å‰ä½¿ç”¨ <code>None</code> æ¥è¡¨ç¤ºæ•°æ®å·²ç»è¢«é‡Šæ”¾ï¼Œä½†å…¶å® <code>data_ref_count</code> å·²ç»èƒ½è¡¨è¾¾è¿™å±‚æ„æ€äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œä½¿ç”¨ <code>ManuallyDrop</code> æ¥è¿›ä¸€æ­¥èŠ‚çœå†…å­˜èµ„æºã€‚</p></li></ol><blockquote><p><code>std::mem::ManuallyDrop&lt;T&gt;</code> æ˜¯ä¸€ä¸ªé›¶æˆæœ¬ï¼ˆzero-costï¼‰åŒ…è£…å™¨ã€‚å®ƒä¸æ”¹å˜ <code>T</code> çš„å¸ƒå±€ï¼Œä¹Ÿä¸ä¼šäº§ç”Ÿé¢å¤–çš„å­—èŠ‚ï¼Œåœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œå¯ä»¥æ¯” <code>Option&lt;T&gt;</code> å°‘ä¸€äº›æ ‡è®°ä½å’Œå­—èŠ‚å¯¹é½æ‰€å æ®çš„é¢å¤–ç©ºé—´ã€‚å…·ä½“å¯å‚è€ƒï¼š<strong>é™„å½• 2. ManuallyDrop&lt;T&gt;</strong>ã€‚</p></blockquote><pre class="mermaid">graph TB    subgraph Stack ["æ ˆå†…å­˜ Stack"]        ArcStruct["Arc&lt;T&gt;<br/>ptr: NonNull&lt;ArcData&lt;T&gt;&gt;"]        WeakStruct["Weak&lt;T&gt;<br/>ptr: NonNull&lt;ArcData&lt;T&gt;&gt;"]    end    subgraph Heap ["å †å†…å­˜ Heap"]        ArcDataStruct["ArcData&lt;T&gt;<br/>data_ref_count<br/>alloc_ref_count<br/>data"]    end    ArcStruct -->|ç›´æ¥æŒ‡å‘| ArcDataStruct    WeakStruct -->|ç›´æ¥æŒ‡å‘| ArcDataStruct    classDef stackStyle fill:#e1f5fe,stroke:#01579b,stroke-width:2px    classDef heapStyle fill:#f3e5f5,stroke:#4a148c,stroke-width:2px    class ArcStruct,WeakStruct stackStyle    class ArcDataStruct heapStyle</pre><h3 id="ç»´æŠ¤å¼•ç”¨è®¡æ•°-3">ç»´æŠ¤å¼•ç”¨è®¡æ•°</h3><p>ä¿®æ”¹äº†å¼•ç”¨è®¡æ•°çš„è¯­ä¹‰åï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°æ€è€ƒå¦‚ä½•ç®¡ç†å¼•ç”¨è®¡æ•°ã€‚</p><ul><li>Clone:<ul><li>å½“ <code>Weak&lt;T&gt;</code> æ‹·è´æ—¶ï¼Œä»…å¢åŠ äº†å¼±å¼•ç”¨çš„æ•°é‡ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¾æ—§åªéœ€å¯¹ <code>alloc_ref_count</code> è¿›è¡Œè‡ªå¢ã€‚</li><li>å½“ <code>Arc&lt;T&gt;</code> æ‹·è´æ—¶ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±åªéœ€è¦å¯¹ <code>data_ref_count</code> è¿›è¡Œè‡ªå¢å³å¯ã€‚</li></ul></li><li>Drop:<ul><li>å½“ <code>Arc&lt;T&gt;</code> è¢«é‡Šæ”¾æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ <code>data_ref_count</code> è¿›è¡Œè‡ªå‡ã€‚å¦å¤–ï¼Œå¦‚æœæ˜¯æœ€åä¸€ä¸ª <code>Arc&lt;T&gt;</code> è¢«é‡Šæ”¾ï¼Œæˆ‘ä»¬éœ€è¦é‡Šæ”¾ <code>data</code> ï¼ŒåŒæ—¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦é‡Šæ”¾é‚£ä¸ªä»£è¡¨æ‰€æœ‰ <code>Arc</code> çš„éšå¼ <code>Weak</code>ã€‚</li><li>å½“ <code>Weak&lt;T&gt;</code> è¢«é‡Šæ”¾æ—¶ï¼Œæˆ‘ä»¬ä»…éœ€å‡å°‘å¼±å¼•ç”¨çš„æ•°é‡ï¼Œå³å¯¹ <code>alloc_ref_count</code> è¿›è¡Œè‡ªå‡ã€‚å¦å¤–ï¼Œå½“æœ€åä¸€ä¸ª <code>Weak&lt;T&gt;</code> è¢«é‡Šæ”¾æ—¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è´Ÿè´£é‡Šæ”¾ <code>ArcData&lt;T&gt;</code> ã€‚</li></ul></li></ul><p>å…·ä½“çš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Clone</span> <span class="keyword">for</span> <span class="title class_">Weak</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">clone</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().alloc_ref_count.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Ordering::Relaxed) &gt; <span class="type">usize</span>::MAX / <span class="number">2</span> &#123;</span><br><span class="line">            std::process::<span class="title function_ invoke__">abort</span>();</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">Self</span> &#123; ptr: <span class="keyword">self</span>.ptr &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Clone</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">clone</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().data_ref_count.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Ordering::Relaxed) &gt; <span class="type">usize</span>::MAX / <span class="number">2</span> &#123;</span><br><span class="line">            std::process::<span class="title function_ invoke__">abort</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">Self</span> &#123; ptr: <span class="keyword">self</span>.ptr &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Drop</span> <span class="keyword">for</span> <span class="title class_">Weak</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">      <span class="comment">// æ€è€ƒä¸‹è¿™é‡Œä¸ºä»€ä¹ˆè¦ç”¨ Releaseï¼Ÿåé¢æˆ‘ä»¬ä¼šæ­æ™“ï¼</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().alloc_ref_count.<span class="title function_ invoke__">fetch_sub</span>(<span class="number">1</span>, Ordering::Release) == <span class="number">1</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">fence</span>(Ordering::Acquire);</span><br><span class="line">            <span class="comment">// Safety: æœ€åä¸€ä¸ª Weak&lt;T&gt; å·²ç»è¢«é‡Šæ”¾äº†ã€‚</span></span><br><span class="line">            <span class="keyword">unsafe</span> &#123;</span><br><span class="line">                <span class="comment">// é‡Šæ”¾ ArcData&lt;T&gt;</span></span><br><span class="line">                <span class="title function_ invoke__">drop</span>(<span class="type">Box</span>::<span class="title function_ invoke__">from_raw</span>(<span class="keyword">self</span>.ptr.<span class="title function_ invoke__">as_ptr</span>()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Drop</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().data_ref_count.<span class="title function_ invoke__">fetch_sub</span>(<span class="number">1</span>, Ordering::Release) == <span class="number">1</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">fence</span>(Ordering::Acquire);</span><br><span class="line">            <span class="comment">// æœ€åä¸€ä¸ª `Arc` è¢«é‡Šæ”¾ï¼Œéœ€è¦åš 2 ä»¶äº‹æƒ…ï¼š</span></span><br><span class="line">            <span class="comment">// 1. é‡Šæ”¾ ArcData.data</span></span><br><span class="line">            <span class="comment">// 2. é‡Šæ”¾é‚£ä¸ªä»£è¡¨æ‰€æœ‰ `Arc` çš„éšå¼ `Weak`</span></span><br><span class="line">            <span class="keyword">unsafe</span> &#123;</span><br><span class="line">                ManuallyDrop::<span class="title function_ invoke__">drop</span>(&amp;<span class="keyword">mut</span> *<span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().data.<span class="title function_ invoke__">get</span>());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// åœ¨ `Weak` é‚£è¾¹ `drop()` çš„æ—¶å€™ï¼š</span></span><br><span class="line">            <span class="comment">// 1. ä¼šæ‰§è¡Œ alloc_ref_count--;</span></span><br><span class="line">            <span class="comment">// 2. å¦‚æœåˆšå¥½æ˜¯æœ€åä¸€ä¸ª `Weak`ï¼Œé‚£ä¼šé¡ºå¸¦é”€æ¯ `AraData`ã€‚</span></span><br><span class="line">            <span class="title function_ invoke__">drop</span>(Weak &#123; ptr: <span class="keyword">self</span>.ptr &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºè¿™ä¸ªéšå¼ <code>Weak&lt;T&gt;</code>ï¼Œå¦‚æœä½ ä¸€æ—¶æ— æ³•å¾ˆå¥½åœ° Get åˆ°é‚£ä¸ªç‚¹ï¼Œå¯ä»¥å°è¯•æ‰‹åŠ¨å†™å†™æ•´ä¸ªå®ç°çš„è¿‡ç¨‹ï¼Œç›¸ä¿¡å¤šèµ°å‡ éæµç¨‹ï¼Œä½ ä¼šæœ‰é‚£ç§èŒ…å¡é¡¿å¼€çš„æ„Ÿè§‰ï¼</p><pre class="mermaid">flowchart TD    subgraph Clone["Clone æ“ä½œ"]        WeakClone["Weak&lt;T&gt;::clone()"]        ArcClone["Arc&lt;T&gt;::clone()"]        WeakClone --> WeakInc["alloc_ref_count.fetch_add(1)"]        ArcClone --> ArcInc["data_ref_count.fetch_add(1)"]        WeakInc --> WeakCheck{"è®¡æ•° > usize::MAX/2?"}        ArcInc --> ArcCheck{"è®¡æ•° > usize::MAX/2?"}        WeakCheck -->|æ˜¯| Abort1["std::process::abort()"]        ArcCheck -->|æ˜¯| Abort2["std::process::abort()"]        WeakCheck -->|å¦| WeakNew["è¿”å›æ–°çš„ Weak&lt;T&gt;"]        ArcCheck -->|å¦| ArcNew["è¿”å›æ–°çš„ Arc&lt;T&gt;"]    end    subgraph Drop["Drop æ“ä½œ"]        WeakDrop["Weak&lt;T&gt;::drop()"]        ArcDrop["Arc&lt;T&gt;::drop()"]        WeakDrop --> WeakDec["alloc_ref_count.fetch_sub(1, Release)"]        ArcDrop --> ArcDec["data_ref_count.fetch_sub(1, Release)"]        WeakDec --> WeakDropCheck{"è¿”å›å€¼ == 1?<br/>æœ€åä¸€ä¸ª Weak?"}        ArcDec --> ArcDropCheck{"è¿”å›å€¼ == 1?<br/>æœ€åä¸€ä¸ª Arc?"}        WeakDropCheck -->|æ˜¯| WeakFence["fence(Acquire)"]        WeakDropCheck -->|å¦| WeakEnd["ç»“æŸ"]        ArcDropCheck -->|æ˜¯| ArcFence["fence(Acquire)"]        ArcDropCheck -->|å¦| ArcEnd["ç»“æŸ"]        WeakFence --> WeakFree["é‡Šæ”¾ ArcData&lt;T&gt;<br/>Box::from_raw(ptr)"]        ArcFence --> ArcDataFree["é‡Šæ”¾ data<br/>ManuallyDrop::drop()"]        ArcDataFree --> ImplicitWeak["é‡Šæ”¾éšå¼ Weak<br/>drop(Weak { ptr })"]        ImplicitWeak --> WeakDrop    end    subgraph Memory["å†…å­˜é‡Šæ”¾é¡ºåº"]        Step1["â‘  Arc é‡Šæ”¾ data å†…å®¹"]        Step2["â‘¡ Arc é‡Šæ”¾éšå¼ Weak"]        Step3["â‘¢ Weak é‡Šæ”¾ ArcData ç»“æ„"]        Step1 --> Step2        Step2 --> Step3    end    classDef cloneStyle fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px    classDef dropStyle fill:#ffebee,stroke:#c62828,stroke-width:2px    classDef memStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px    classDef criticalStyle fill:#fce4ec,stroke:#880e4f,stroke-width:3px    class WeakClone,ArcClone,WeakInc,ArcInc,WeakNew,ArcNew cloneStyle    class WeakDrop,ArcDrop,WeakDec,ArcDec,WeakEnd,ArcEnd dropStyle    class WeakFree,ArcDataFree,ImplicitWeak criticalStyle    class Step1,Step2,Step3 memStyle</pre><p>è‡³æ­¤ï¼Œæˆ‘ä»¬é‡æ–°è¿è¡Œä¹‹å‰çš„æµ‹è¯•ç”¨ä¾‹ <code>arc_should_work()</code>ï¼Œå¯ä»¥å‘ç°çš„æˆåŠŸé€šè¿‡çš„ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬ç»§ç»­æ¥è°ƒæ•´ <code>get_mut</code>ã€<code>downgrade()</code> å’Œ <code>upgrade()</code>ã€‚</p><h3 id="upgrade-2">upgrade()</h3><p><code>upgrade()</code> æ¯”è¾ƒç®€å•ï¼Œå®ƒçš„è§„åˆ™è¿˜æ˜¯ä¸å˜ï¼Œåªæœ‰å½“å­˜åœ¨ <code>Arc&lt;T&gt;</code> æ—¶ï¼Œå³ <code>data_ref_count&gt;0</code> æ—¶ï¼Œæ‰èƒ½å‡çº§æˆåŠŸï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; Weak&lt;T&gt; &#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">upgrade</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;Arc&lt;T&gt;&gt; &#123;</span><br><span class="line">      <span class="comment">// è·å– data_ref_count çš„å€¼ã€‚</span></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">n</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().data_ref_count.<span class="title function_ invoke__">load</span>(Ordering::Relaxed);</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">          <span class="comment">// å¦‚æœä¸º 0ï¼Œè¡¨ç¤ºå·²ç»æ²¡æœ‰ Arc äº†ï¼Œå‡çº§å¤±è´¥ã€‚</span></span><br><span class="line">            <span class="keyword">if</span> n == <span class="number">0</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">assert!</span>(n &lt; <span class="type">usize</span>::MAX);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// å­˜åœ¨ Arcï¼Œåˆ™å¯¹ data_ref_count å°è¯•è¿›è¡Œ CAS åŠ  1ã€‚</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Err</span>(e) = <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().data_ref_count.<span class="title function_ invoke__">compare_exchange_weak</span>(</span><br><span class="line">                n,</span><br><span class="line">                n + <span class="number">1</span>,</span><br><span class="line">                Ordering::Relaxed,</span><br><span class="line">                Ordering::Relaxed,</span><br><span class="line">            ) &#123;</span><br><span class="line">              <span class="comment">// CAS å¤±è´¥ï¼Œåˆ™é‡è¯•ã€‚</span></span><br><span class="line">                n = e;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// CAS æˆåŠŸï¼Œåˆ™è¿”å›å‡çº§åçš„ Arcã€‚</span></span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">Some</span>(Arc &#123; ptr: <span class="keyword">self</span>.ptr &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="get-mut-2">get_mut()</h3><p>æ¥ä¸€ä¸‹æˆ‘ä»¬çœ‹ <code>get_mut</code>ï¼Œè§„åˆ™ä¹Ÿæ˜¯ä¸å˜ï¼š<strong>å½“å‰ä»…å½“åªæœ‰ä¸€ä¸ª <code>Arc&lt;T&gt;</code>ï¼Œä¸”ä¸å­˜åœ¨ <code>Weak&lt;T&gt;</code> æ—¶ï¼Œæ‰å¯ä»¥è¿”å›å¯å˜å¼•ç”¨ã€‚</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸¤ä¸ªæ¡ä»¶</span></span><br><span class="line"><span class="comment">// 1. æ²¡æœ‰ Weak&lt;T&gt;</span></span><br><span class="line"><span class="comment">// 2. æ²¡æœ‰å…¶ä»–çš„ Arc&lt;T&gt;</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">get_mut</span>(arc: &amp;<span class="keyword">mut</span> Arc&lt;T&gt;) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;&amp;<span class="keyword">mut</span> T&gt; &#123;</span><br><span class="line">    <span class="comment">// å°† alloc_ref_count ä» 1 ç½®ä¸º usize::Maxã€‚</span></span><br><span class="line">    <span class="comment">//  å¦‚æœå¤±è´¥ï¼šè¯´æ˜ä¹‹å‰ä¸æ˜¯ 1ï¼Œå³å­˜åœ¨å…¶ä»–çš„ Weak&lt;T&gt;ï¼Œæ— æ³•è·å– &amp;mut Tï¼Œ None</span></span><br><span class="line">    <span class="comment">//  å¦‚æœæˆåŠŸï¼šè¯´æ˜å½“å‰æ²¡æœ‰ Weak&lt;T&gt;ï¼Œç¬¬ä¸€æ­¥æ ¡éªŒé€šè¿‡ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> arc</span><br><span class="line">        .<span class="title function_ invoke__">data</span>()</span><br><span class="line">        .alloc_ref_count</span><br><span class="line">        .<span class="title function_ invoke__">compare_exchange</span>(<span class="number">1</span>, <span class="type">usize</span>::MAX, Ordering::Acquire, Ordering::Relaxed)</span><br><span class="line">        .<span class="title function_ invoke__">is_err</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">is_unique</span> = arc.<span class="title function_ invoke__">data</span>().data_ref_count.<span class="title function_ invoke__">load</span>(Ordering::Relaxed) == <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡Šæ”¾ alloc_ref_count</span></span><br><span class="line">    arc.<span class="title function_ invoke__">data</span>().alloc_ref_count.<span class="title function_ invoke__">store</span>(<span class="number">1</span>, Ordering::Release);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœå­˜åœ¨å…¶ä»–çš„ Arcï¼Œåˆ™æ— æ³•è·å– &amp;mut Tï¼Œè¿”å› None</span></span><br><span class="line">    <span class="keyword">if</span> !is_unique &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸å­˜åœ¨å…¶ä»–çš„ Arcï¼Œè¿”å› &amp;mut T</span></span><br><span class="line">    <span class="title function_ invoke__">fence</span>(Ordering::Acquire);</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; <span class="title function_ invoke__">Some</span>(&amp;<span class="keyword">mut</span> *arc.<span class="title function_ invoke__">data</span>().data.<span class="title function_ invoke__">get</span>()) &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç çš„é€»è¾‘å°±ä¸èµ˜è¿°äº†ï¼Œä½†æ˜¯è¿™é‡Œæœ‰ <strong>3 ä¸ª</strong>åŸå­æ“ä½œçš„å†…å­˜é¡ºåºæˆ‘ä»¬éœ€è¦è®¨è®ºä¸€ä¸‹ï¼</p><p>åˆ†åˆ«æ˜¯ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å– Weak&lt;T&gt; çš„æ•°é‡å¹¶æš‚æ—¶é”å®š</span></span><br><span class="line">arc</span><br><span class="line">  .<span class="title function_ invoke__">data</span>()</span><br><span class="line">  .alloc_ref_count</span><br><span class="line">  .<span class="title function_ invoke__">compare_exchange</span>(<span class="number">1</span>, <span class="type">usize</span>::MAX, Ordering::Acquire, Ordering::Relaxed)</span><br></pre></td></tr></table></figure><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å– Arc&lt;T&gt; çš„æ•°é‡</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">is_unique</span> = arc.<span class="title function_ invoke__">data</span>().data_ref_count.<span class="title function_ invoke__">load</span>(Ordering::Relaxed) == <span class="number">1</span>;</span><br><span class="line">...</span><br><span class="line"><span class="title function_ invoke__">fence</span>(Ordering::Acquire);</span><br></pre></td></tr></table></figure><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é‡Šæ”¾ alloc_ref_count</span></span><br><span class="line">arc.<span class="title function_ invoke__">data</span>().alloc_ref_count.<span class="title function_ invoke__">store</span>(<span class="number">1</span>, Ordering::Release);</span><br></pre></td></tr></table></figure><hr><p>é¦–å…ˆçœ‹ç¬¬ 1 ä¸ªï¼Œæˆ‘ä»¬è¦åˆ¤æ–­å½“å‰æ˜¯å¦å·²ç»æ²¡æœ‰ <code>Weak&lt;T&gt;</code> äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿è¯çœ‹åˆ°ä¹‹å‰æ‰€æœ‰ <code>drop(Weak&lt;T&gt;)</code> çš„å†™å…¥æ“ä½œï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦å»ºç«‹èµ·ä¸€ä¸ª happens-beforeï¼Œå› æ­¤æˆ‘ä»¬ä¹‹å‰ä¸º <code>Weak&lt;T&gt;</code> å®ç° <code>Drop</code> trait çš„æ—¶å€™ï¼Œä½¿ç”¨çš„æ˜¯ <code>Release</code>ï¼Œè€Œè¿™é‡Œï¼Œéœ€è¦ä½¿ç”¨ <code>Acquire</code> æ¥è¿›è¡Œé…å¯¹ï¼Œå»ºç«‹ happens-beforeã€‚</p><hr><p>ç„¶åçœ‹ç¬¬ 2 ä¸ªï¼Œè¿™é‡Œæˆ‘ä»¬è¦åˆ¤æ–­æ˜¯å¦ä»…æœ‰ä¸€ä¸ª <code>Arc&lt;T&gt;</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿è¯çœ‹åˆ°ä¹‹å‰æ‰€æœ‰ <code>drop&lt;Arc&lt;T&gt;</code> çš„å†™å…¥æ“ä½œï¼Œå› æ­¤æˆ‘ä»¬ä¹‹å‰ä¸º <code>Arc&lt;T&gt;</code> å®ç° <code>Drop</code> trait çš„æ—¶å€™ï¼Œä½¿ç”¨çš„æ˜¯ <code>Release</code>ã€‚ä½†æ˜¯åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä»…éœ€åœ¨ä»…å‰© 1 ä¸ª <code>Arc</code> çš„æ—¶å€™ï¼Œæ‰æœ‰å¿…è¦å»ºç«‹ happens-beforeï¼Œæ‰€ä»¥å½“ <code>is_unique=true</code> æ—¶ï¼Œæˆ‘ä»¬è¡¥ä¸€ä¸ª <code>fence(Acquire)</code> å±éšœï¼Œæ¥å»ºç«‹è·Ÿ <code>drop(Arc&lt;T&gt;)</code> çš„ happens-beforeã€‚</p><hr><p>åœ¨åˆ†æç¬¬ 3 ä¸ªä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ¥å°è¯•æŒ–ä¸€ä¸‹å½“å‰ <code>get_mut</code> çš„æ¼æ´ï¼ç›¸ä¿¡æœ‰éƒ¨åˆ†è¯»è€…åœ¨çœ‹åˆ°ä¸Šè¿°å®ç°åï¼Œè·Ÿç¬”è€…ä¸€æ ·ï¼Œä¼šæœ‰ä¸€ä¸ªç–‘æƒ‘ï¼š<strong><font color="red">ä¸Šè¿° 2 ä¸ªæ¡ä»¶çš„æ£€æŸ¥ï¼Œå¹¶ä¸æ˜¯åŸå­çš„ï¼Œè¿™æ ·çš„æ£€æŸ¥è¿˜å®‰å…¨å¯é å—ï¼Ÿ</font></strong></p><p>æ¯”å¦‚è¯´ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">get_mut</span>(arc: &amp;<span class="keyword">mut</span> Arc&lt;T&gt;) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;&amp;<span class="keyword">mut</span> T&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> arc</span><br><span class="line">        .<span class="title function_ invoke__">data</span>()</span><br><span class="line">        .alloc_ref_count</span><br><span class="line">        .<span class="title function_ invoke__">compare_exchange</span>(<span class="number">1</span>, <span class="type">usize</span>::MAX, Ordering::Acquire, Ordering::Relaxed)</span><br><span class="line">        .<span class="title function_ invoke__">is_err</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &lt;------- åœ¨è¿™ä¸ªé—´éš™ï¼šå¦å¤–ä¸€ä¸ª Arc downgrade() -&gt; Weakï¼Œç„¶å drop(Arc)</span></span><br><span class="line">    <span class="comment">// &lt;------- é‚£å®ƒä¹Ÿæ˜¯æ£€æŸ¥é€šè¿‡çš„ã€‚</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">is_unique</span> = arc.<span class="title function_ invoke__">data</span>().data_ref_count.<span class="title function_ invoke__">load</span>(Ordering::Relaxed) == <span class="number">1</span>;</span><br><span class="line">    arc.<span class="title function_ invoke__">data</span>().alloc_ref_count.<span class="title function_ invoke__">store</span>(<span class="number">1</span>, Ordering::Release);</span><br><span class="line">    <span class="keyword">if</span> !is_unique &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">fence</span>(Ordering::Acquire);</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; <span class="title function_ invoke__">Some</span>(&amp;<span class="keyword">mut</span> *arc.<span class="title function_ invoke__">data</span>().data.<span class="title function_ invoke__">get</span>()) &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­ï¼š</p><ol><li>å‡è®¾æˆ‘ä»¬å·²ç»é€šè¿‡äº†ç¬¬ä¸€ä¸ªæ£€æŸ¥ï¼›</li><li>åœ¨è¿›è¡Œç¬¬äºŒä¸ªæ£€æŸ¥ä¹‹å‰çš„è¿™ä¸ªé—´éš™ä¸­ï¼Œå­˜åœ¨å¦å¤–ä¸€ä¸ª <code>Arc&lt;T&gt;</code>ï¼›</li><li>ç„¶åå®ƒé€šè¿‡ <code>downgrade()</code> ç”Ÿæˆäº†ä¸€ä¸ª <code>Weak&lt;T&gt;</code>ï¼›</li><li>ç„¶åå† <code>drop(Arc&lt;T&gt;)</code>ï¼›</li><li>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å†æ£€æŸ¥ <code>Arc&lt;T&gt;</code> çš„æ—¶å€™ï¼Œä¼šå‘ç°åªæœ‰ 1 ä¸ªï¼Œæ£€æŸ¥å°±é€šè¿‡äº†ã€‚ä½†æ˜¯å…¶å®è¿™ä¸ªæ—¶å€™ï¼Œå­˜åœ¨äº†å…¶ä»–çš„ <code>Weak&lt;T&gt;</code>ï¼Œæ‰€ä»¥æ˜¯æœ‰é—®é¢˜çš„ï¼</li></ol><pre class="mermaid">sequenceDiagram    participant A as T1 :get_mut()    participant B as T2 :downgrade()+drop(Arc)    participant C as ArcData    A->>C: CAS alloc_ref 1â†’MAX âœ”    Note over A,B: éåŸå­çª—å£    B->>C: clone Weak <br> alloc_ref++ (Relaxed)    B->>C: drop(Arc) <br> fetch_sub data_ref (Release)    A->>C: load data_ref ==1 âœ”    A->>C: store alloc_ref MAXâ†’1 (Release)    A-->>A: fence(Acquire) â†’ è¿”å› &mut Tï¼ˆå·²å¤±æ•ˆï¼‰</pre><p>æ‰€ä»¥ï¼š**<font color="green">æˆ‘ä»¬ä¸èƒ½è®© Â <code>downgrade()</code>Â  åœ¨è¿™ä¸ªé—´éš™ä¸­æˆåŠŸæ‰§è¡Œï¼</font>**è¿™ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨å‰é¢å°† <code>alloc_ref_count</code> ç½®ä¸º <code>usize::Max</code>ï¼ˆä¸Šé”ï¼‰çš„åŸå› ï¼Œåœ¨åé¢çš„ <code>downgrade()</code> ä¸­ï¼Œæˆ‘ä»¬è‚¯å®šè¦æ£€æŸ¥è¿™ä¸ªå€¼ï¼Œå¦‚æœ <code>alloc_ref_count=usize::Max</code>ï¼Œå°±ä¸èƒ½ <code>downgrade()</code> æˆåŠŸï¼Œç›´åˆ° <code>alloc_ref_store(1, _)</code> çš„æ—¶å€™ï¼Œæ‰èƒ½ <code>downgrade()</code> æˆåŠŸã€‚ä¸è¿‡è¿™ä¸ªæ—¶å€™å·²ç»æ™šäº†ï¼å¦‚æœæ˜¯è¿™æ ·ï¼Œé‚£ <code>is_unique</code> è‚¯å®šå°±ä¸ä¸º <code>true</code>ï¼Œæ‰€ä»¥ä¼šè¿”å› <code>None</code>ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬ä¸ä¼šè¿”å› <code>&amp;mut T</code>ï¼Œæ‰€ä»¥ï¼Œå±æœºå°±è§£é™¤äº†ï¼</p><h3 id="downgrade">downgrade()</h3><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ <code>downgrade()</code> çš„å®ç°ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; Arc&lt;T&gt; &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">downgrade</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> Weak&lt;T&gt; &#123;</span><br><span class="line">        <span class="comment">// è·å– Weak çš„å¼•ç”¨è®¡æ•°</span></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">n</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().alloc_ref_count.<span class="title function_ invoke__">load</span>(Ordering::Relaxed);</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœä¸º usize::MAXï¼Œè¯´æ˜å·²ç»è¢«é”ä½äº†ï¼Œè¿™ä¸ªæ—¶å€™è‡ªæ—‹é‡è¯•ï¼</span></span><br><span class="line">            <span class="keyword">if</span> n == <span class="type">usize</span>::MAX &#123;</span><br><span class="line">                std::hint::<span class="title function_ invoke__">spin_loop</span>();</span><br><span class="line">                n = <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().alloc_ref_count.<span class="title function_ invoke__">load</span>(Ordering::Relaxed);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">assert!</span>(n &lt; <span class="type">usize</span>::MAX - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// alloc_ref_count æ²¡è¢«é”ä½ï¼Œå°è¯•è¿›è¡Œ +1 æ“ä½œã€‚</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Err</span>(e) = <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().alloc_ref_count.<span class="title function_ invoke__">compare_exchange_weak</span>(</span><br><span class="line">                n,</span><br><span class="line">                n + <span class="number">1</span>,</span><br><span class="line">                Ordering::Acquire,</span><br><span class="line">                Ordering::Relaxed,</span><br><span class="line">            ) &#123;</span><br><span class="line">                <span class="comment">// +1 å¤±è´¥ï¼Œé‡è¯•ã€‚</span></span><br><span class="line">                n = e;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// +1 æˆåŠŸï¼Œè¡¨ç¤ºé™çº§æˆåŠŸï¼Œè¿”å› Weakã€‚</span></span><br><span class="line">            <span class="keyword">return</span> Weak &#123; ptr: <span class="keyword">self</span>.ptr &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>downgrade()</code> çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬è·Ÿ <code>get_mut</code> é¥ç›¸å‘¼åº”ï¼š</p><ol><li><p>å¦‚æœ <code>alloc_ref_count=usize::MAX</code>ï¼Œè¯´æ˜è¢«é”ä½ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦è‡ªæ—‹ç­‰å¾…å¹¶é‡è¯•ã€‚</p><blockquote><p><code>std::hint::spin_loop() </code>ä¼šå‘ CPU å‘é€ç‰¹å®šæŒ‡ä»¤ï¼ˆå¦‚ x86 çš„ pause æˆ– ARM çš„ yieldï¼‰ï¼Œæç¤ºå½“å‰å¤„äºå¿™ç­‰å¾…çŠ¶æ€ï¼Œæœ‰åˆ©äºä¼˜åŒ– CPU è¡Œä¸ºã€‚</p></blockquote></li><li><p>å¦‚æœ <code>alloc_ref_count</code> æ²¡è¢«é”ä½ï¼Œæˆ‘ä»¬å°è¯•è¿›è¡Œ CASï¼Œè¿™é‡ŒæˆåŠŸçš„æ—¶å€™ä½¿ç”¨çš„ <code>Acquire</code> ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿè¿™æ˜¯ä¸ºäº†è·Ÿå‰é¢è¿˜æœªè®¨è®ºçš„<strong>ç¬¬ 3 ä¸ªåŸå­æ“ä½œ</strong>å»ºç«‹ happens-beforeï¼</p></li></ol><p>ç°åœ¨æˆ‘ä»¬ç»ˆäºå¯ä»¥æ¥è§£å¼€è¿™ç¬¬ 3 ä¸ªåŸå­æ“ä½œçš„åŸå­é¡ºåºè°œå›¢äº†ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é‡Šæ”¾ alloc_ref_count</span></span><br><span class="line">arc.<span class="title function_ invoke__">data</span>().alloc_ref_count.<span class="title function_ invoke__">store</span>(<span class="number">1</span>, Ordering::Release);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å¿…é¡»ä¿è¯è·Ÿ <code>download()</code> çš„ <code>compare_exchange(_,_,Acquire,_)</code> å»ºç«‹èµ· happens-before å…³ç³»ï¼Œå³å°† <code>alloc_ref_count</code> ç½®ä¸º 1 çš„ç»“æœå¿…é¡»è¢« <code>downgrade()</code> æ‰€åœ¨çš„çº¿ç¨‹çœ‹åˆ°ã€‚ä¸ç„¶çš„è¯ï¼Œè¿™é‡Œ <code>compare_exchange</code> æˆåŠŸäº†ï¼Œå°† <code>alloc_ref_count</code> ç½®ä¸º 2 äº†ï¼Œä½†æ˜¯ <code>get_mut</code> åˆå°†å…¶ç½®ä¸º 1 äº†ï¼Œå°±ä¹±å¥—äº†ï¼</p><h3 id="å®Œæ•´ä»£ç -2">å®Œæ•´ä»£ç </h3><p>åˆ°è¿™é‡Œæˆ‘ä»¬ç»ˆäºæ˜¯å®Œæˆäº† v3 ç‰ˆæœ¬çš„ä¼˜åŒ–å·¥ä½œäº†ï¼ŒçœŸæ£’ï¼ä»‹äºç¯‡å¹…å·²ç»å¤Ÿé•¿äº†ï¼Œè¿™é‡Œå°±ä¸å†è´´å‡ºå®Œæ•´çš„ä»£ç äº†ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥å‚é˜…ï¼š<a href="https://github.com/hedon-rust-road/conutils/blob/main/src/arc.rs">hedon-rust-road/conutils/arc</a>ã€‚</p><h2 id="æµ…æ¢æ ‡å‡†åº“çš„-Arc-T">æµ…æ¢æ ‡å‡†åº“çš„ Arc&lt;T&gt;</h2><p>åœ¨æœ€åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ ‡å‡†åº“çš„ <code>Arc&lt;T&gt;</code> æ˜¯å¦‚ä½•å®ç°çš„ï¼Œçœ‹æ–‡ç« å¼€å¤´è¯´çš„<strong>å®ç°ä¸€ä¸ªå¯ä»¥åª²ç¾æ ‡å‡†åº“çš„ <code>Arc&lt;T&gt;</code></strong> æ˜¯ä¸æ˜¯åœ¨å¹ç‰›ï¼</p><p>æ ‡å‡†åº“ï¼ˆrustc 1.87.0ï¼‰çš„ <code>Arc&lt;T&gt;</code> ä½äº <a href="https://github.com/rust-lang/rust/blob/1.87.0/library/alloc/src/sync.rs">sync.rs</a> æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒçš„æ•°æ®ç»“æ„å®šä¹‰ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Arc</span>&lt;</span><br><span class="line">    T: ?<span class="built_in">Sized</span>,</span><br><span class="line">    <span class="meta">#[unstable(feature = <span class="string">&quot;allocator_api&quot;</span>, issue = <span class="string">&quot;32838&quot;</span>)]</span> A: Allocator = Global,</span><br><span class="line">&gt; &#123;</span><br><span class="line">    ptr: NonNull&lt;ArcInner&lt;T&gt;&gt;,</span><br><span class="line">    phantom: PhantomData&lt;ArcInner&lt;T&gt;&gt;,</span><br><span class="line">    alloc: A,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Weak</span>&lt;</span><br><span class="line">    T: ?<span class="built_in">Sized</span>,</span><br><span class="line">    <span class="meta">#[unstable(feature = <span class="string">&quot;allocator_api&quot;</span>, issue = <span class="string">&quot;32838&quot;</span>)]</span> A: Allocator = Global,</span><br><span class="line">&gt; &#123;</span><br><span class="line">    ptr: NonNull&lt;ArcInner&lt;T&gt;&gt;,</span><br><span class="line">    alloc: A,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä»–ä¸€äº›è«åå…¶å¦™çš„æ ‡è®°å’±å°±ä¸ç®¡äº†ï¼Œæ˜ å…¥çœ¼å¸˜å¯ä»¥çœ‹åˆ°ä¸€ä¸ª <code>ArcInner</code>ï¼Œè¿™ä¸å°±æ˜¯å’±çš„ <code>ArcData</code> å—ï¼ç‚¹è¿›å»çœ‹ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ArcInner</span>&lt;T: ?<span class="built_in">Sized</span>&gt; &#123;</span><br><span class="line">    strong: atomic::AtomicUsize,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// the value usize::MAX acts as a sentinel for temporarily &quot;locking&quot; the</span></span><br><span class="line">    <span class="comment">// ability to upgrade weak pointers or downgrade strong ones; this is used</span></span><br><span class="line">    <span class="comment">// to avoid races in `make_mut` and `get_mut`.</span></span><br><span class="line">    weak: atomic::AtomicUsize,</span><br><span class="line"></span><br><span class="line">    data: T,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¥½å®¶ä¼™ï¼è¿™ä¸å°±æ˜¯å’±çš„ <code>ArcData</code> !</p><ul><li><code>strong</code>: å¯¹åº”æˆ‘ä»¬çš„ <code>data_ref_count</code></li><li><code>weak</code>: å¯¹åº”æˆ‘ä»¬çš„ <code>alloc_ref_count</code></li></ul><p><code>weak</code> å­—æ®µä¸Šé¢çš„æ³¨é‡Šä¹Ÿæ­ç¤ºäº†å…¶æ ¸å¿ƒé€»è¾‘è·Ÿå’±æ˜¯é«˜åº¦ä¸€è‡´çš„ï¼</p><p>æˆ‘ä»¬ç®€å•çœ‹ä¸‹æœ€é‡è¦çš„ <code>Drop</code> å’Œ <code>Clone</code> çš„å®ç°ï¼Œå› ä¸ºè¿™æ¶‰åŠåˆ°å¼•ç”¨è®¡æ•°çš„ç»´æŠ¤ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> MAX_REFCOUNT: <span class="type">usize</span> = (<span class="type">isize</span>::MAX) <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Arc: Clone</span></span><br><span class="line"><span class="keyword">impl</span>&lt;T: ?<span class="built_in">Sized</span>, A: Allocator + <span class="built_in">Clone</span>&gt; <span class="built_in">Clone</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T, A&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">clone</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> Arc&lt;T, A&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">old_size</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">inner</span>().strong.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Relaxed); <span class="comment">// fetch_add</span></span><br><span class="line">        <span class="keyword">if</span> old_size &gt; MAX_REFCOUNT &#123; <span class="comment">// æº¢å‡ºä¿æŠ¤</span></span><br><span class="line">            <span class="title function_ invoke__">abort</span>();</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">// è¿”å›</span></span><br><span class="line">        <span class="keyword">unsafe</span> &#123; <span class="keyword">Self</span>::<span class="title function_ invoke__">from_inner_in</span>(<span class="keyword">self</span>.ptr, <span class="keyword">self</span>.alloc.<span class="title function_ invoke__">clone</span>()) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Arc: Drop</span></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;<span class="meta">#[may_dangle]</span> T: ?<span class="built_in">Sized</span>, A: Allocator&gt; <span class="built_in">Drop</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T, A&gt; &#123;</span><br><span class="line">    <span class="meta">#[inline]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="comment">// fetch_sub release å¼ºå¼•ç”¨</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="title function_ invoke__">inner</span>().strong.<span class="title function_ invoke__">fetch_sub</span>(<span class="number">1</span>, Release) != <span class="number">1</span> &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">// æœ€åä¸€ä¸ª Arc é‡Šæ”¾çš„æ—¶å€™ï¼Œè¡¥ä¸€ä¸ª fence(Acquire)ï¼Œ</span></span><br><span class="line">      <span class="comment">// ä¸å‰é¢æ‰€æœ‰çš„ release å»ºç«‹ happens-beforeã€‚</span></span><br><span class="line">        acquire!(<span class="keyword">self</span>.<span class="title function_ invoke__">inner</span>().strong);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æœ€åä¸€ä¸ª Arc é‡Šæ”¾çš„æ—¶å€™ï¼Œé‡Šæ”¾ ArcInner é‡Œé¢çš„ data</span></span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.<span class="title function_ invoke__">drop_slow</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Weak: Clone</span></span><br><span class="line"><span class="keyword">impl</span>&lt;T: ?<span class="built_in">Sized</span>, A: Allocator + <span class="built_in">Clone</span>&gt; <span class="built_in">Clone</span> <span class="keyword">for</span> <span class="title class_">Weak</span>&lt;T, A&gt; &#123;</span><br><span class="line">    <span class="meta">#[inline]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">clone</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> Weak&lt;T, A&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(inner) = <span class="keyword">self</span>.<span class="title function_ invoke__">inner</span>() &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">old_size</span> = inner.weak.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Relaxed); <span class="comment">// fetch_add å¼±å¼•ç”¨æ•°é‡</span></span><br><span class="line">            <span class="keyword">if</span> old_size &gt; MAX_REFCOUNT &#123; <span class="comment">// æº¢å‡ºä¿æŠ¤</span></span><br><span class="line">                <span class="title function_ invoke__">abort</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// è¿”å› Weak</span></span><br><span class="line">        Weak &#123; ptr: <span class="keyword">self</span>.ptr, alloc: <span class="keyword">self</span>.alloc.<span class="title function_ invoke__">clone</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Weak: Drop</span></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;<span class="meta">#[may_dangle]</span> T: ?<span class="built_in">Sized</span>, A: Allocator&gt; <span class="built_in">Drop</span> <span class="keyword">for</span> <span class="title class_">Weak</span>&lt;T, A&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">inner</span> = <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(inner) = <span class="keyword">self</span>.<span class="title function_ invoke__">inner</span>() &#123; inner &#125; <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> inner.weak.<span class="title function_ invoke__">fetch_sub</span>(<span class="number">1</span>, Release) == <span class="number">1</span> &#123; <span class="comment">// fetch_sub release å¼±å¼•ç”¨</span></span><br><span class="line">            acquire!(inner.weak);  <span class="comment">// æœ€åä¸€ä¸ªè¡¥ä¸€ä¸ª fence(acquire)</span></span><br><span class="line">            <span class="keyword">unsafe</span> &#123;  <span class="comment">// é‡Šæ”¾ ArcInner</span></span><br><span class="line">                <span class="keyword">self</span>.alloc.<span class="title function_ invoke__">deallocate</span>(<span class="keyword">self</span>.ptr.<span class="title function_ invoke__">cast</span>(), Layout::for_value_raw(<span class="keyword">self</span>.ptr.<span class="title function_ invoke__">as_ptr</span>()))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è·Ÿå’±å‰é¢çš„å®ç°æ˜¯ä¸€æ ·ä¸€æ ·çš„ï¼ä¸ºå•¥ï¼Ÿå› ä¸º <a href="https://marabos.nl/atomics/">Rust Atomics and Locks</a> ä¸€ä¹¦çš„ä½œè€…<a href="https://github.com/m-ou-se">Mara Bos</a> å°±æ˜¯ Rust æ ‡å‡†åº“å›¢é˜Ÿçš„é¢†å¯¼ä¹‹ä¸€ï¼ç‰›é€¼ï¼</p><h2 id="æ€»ç»“">æ€»ç»“</h2><p>é€šè¿‡ä¸‰è½®è¿­ä»£ï¼Œæˆ‘ä»¬ä¸ä»…å®ç°äº†ä¸€ä¸ªåª²ç¾äº†æ ‡å‡†åº“çš„ <code>Arc&lt;T&gt;</code> ï¼Œè¿˜æ›´è¿›ä¸€æ­¥ä½“éªŒäº† <strong>Rust å¹¶å‘æŠ½è±¡çš„è®¾è®¡å“²å­¦</strong>ï¼š</p><ul><li><strong>v0 â€”â€” èƒ½ç”¨</strong>ï¼šå•è®¡æ•° <code>ArcData&lt;T&gt;</code> è§£å†³äº†è·¨çº¿ç¨‹å¤šæ‰€æœ‰æƒï¼Œä½†ä»ç¼ºä¹å¯å˜è§†å›¾ä¸æ–­ç¯èƒ½åŠ›ã€‚</li><li><strong>v1 â€”â€” èƒ½æ”¹</strong>ï¼šå€ŸåŠ©ç‹¬å  <code>&amp;mut Arc&lt;T&gt;</code> + åŸå­ <em>é”</em>ï¼Œåœ¨ <strong>ä¸ç ´åå¹¶å‘å®‰å…¨</strong> çš„å‰æä¸‹å¼€æ”¾äº† <code>get_mut</code>ã€‚</li><li><strong>v2 â€”â€” èƒ½å›æ”¶</strong>ï¼šåŒè®¡æ•° + <code>Weak&lt;T&gt;</code> æ¶ˆé™¤äº†çˆ¶å­äº’æŒ‡é€ æˆçš„æ³„æ¼ï¼Œå±•ç¤ºäº† <em>å¼±å¼•ç”¨</em> åœ¨æ‰€æœ‰æƒå›¾ä¸­çš„ä»·å€¼ã€‚</li><li><strong>v3 â€”â€” æ›´è½»å·§</strong>ï¼šå°† <code>Weak</code> ç‹¬ç«‹ã€ç”¨ <code>ManuallyDrop</code> æ›¿æ¢ <code>Option&lt;T&gt;</code>ï¼Œè®©æ²¡æœ‰å¾ªç¯å¼•ç”¨éœ€æ±‚çš„åœºæ™¯ä¸å†ä¸ºå¼±å¼•ç”¨ä¹°å•ã€‚</li></ul><p>ä¸‹ç¯‡æˆ‘ä»¬å°†å°è¯•å®ç°ä¸€ä¸ª <code>Mutex&lt;T&gt;</code>ï¼Œæ•¬è¯·æœŸå¾…ï¼</p><p>Happy Coding! Peace~</p><h2 id="é™„å½•">é™„å½•</h2><h3 id="1-NonNull-T">1. NonNull&lt;T&gt;</h3><p><code>std::ptr::NonNull&lt;T&gt;</code> æ˜¯ä¸€ä¸ª <strong>é›¶æˆæœ¬ã€éç©ºã€åå˜</strong> çš„è£¸æŒ‡é’ˆåŒ…è£…å™¨ã€‚å®ƒæœ¬è´¨ä¸Šåªæ˜¯æŠŠä¸€ä¸ªåŸå§‹æŒ‡é’ˆå¡è¿› <code>#[repr(transparent)]</code> çš„æ–°ç±»å‹ä¸­ï¼Œä½†å¼ºåˆ¶ä¿è¯ <strong>ç»ä¸ä¸ºç©º</strong>ï¼Œå› æ­¤å¯ä»¥æ‹¿åˆ°ã€Œç©ºå€¼å½“ä½œæšä¸¾åˆ¤åˆ«ä½ã€è¿™ä»½é¢å¤–ä¿¡æ¯ â€”â€” <code>Option&lt;NonNull&lt;T&gt;&gt;</code> ä¸ä¸€ä¸ªæ™®é€šæŒ‡é’ˆå ç”¨åŒæ ·å¤§å°ã€‚</p><p>é‡è¦ç‰¹æ€§ï¼š</p><ul><li><strong>æ°¸è¿œéç©º</strong>ï¼šåˆ›å»ºæ—¶è‹¥ä¼ å…¥ç©ºæŒ‡é’ˆå³è§¦å‘ <strong>æœªå®šä¹‰è¡Œä¸º</strong>ã€‚ç¼–è¯‘å™¨å¯ä¾èµ–è¿™ä¸€ç‚¹åšä¼˜åŒ–ï¼Œä¾‹å¦‚æŠŠ <code>Option&lt;NonNull&lt;T&gt;&gt;</code> åˆå¹¶ä¸ºä¸€ä¸ªæŒ‡é’ˆå®½åº¦ã€‚</li><li><strong>åå˜</strong>ï¼šä¸ <code>*mut T</code> ä¸åŒï¼Œ<code>NonNull&lt;T&gt;</code> å¯ä»¥åœ¨ <code>U: Deref&lt;Target = T&gt;</code> çš„åœºæ™¯ä¸‹å®‰å…¨å‘å­ç±»å‹è½¬æ¢ï¼ˆå› ä¸ºç¦æ­¢ç©ºå€¼å¸¦æ¥äº†é¢å¤–ä¿è¯ï¼‰ï¼Œè¿™ä½¿å®ƒéå¸¸é€‚åˆæ„å»ºè‡ªå®šä¹‰æ™ºèƒ½æŒ‡é’ˆã€‚</li><li><strong>æ— è‡ªåŠ¨ Drop</strong>ï¼š<code> NonNull</code> åªå­˜åœ°å€ï¼Œä¸æŒæœ‰æ‰€æœ‰æƒï¼›é”€æ¯ä¸é‡Šæ”¾å†…å­˜ä»ç”±å¤–éƒ¨é€»è¾‘å†³å®šï¼ˆå¦‚ <code>Box::from_raw</code>ã€<code>Vec::dealloc</code> ç­‰ï¼‰ã€‚</li></ul><p>æˆ‘ä»¬å°†å…¶ä¸è£¸æŒ‡é’ˆã€ <code>Box&lt;T&gt;</code> æ™ºèƒ½æŒ‡é’ˆå’Œå¼•ç”¨ <code>&amp;T</code> åšä¸€ä¸ªç®€å•çš„æ¯”è¾ƒï¼š</p><table><thead><tr><th>ç‰¹æ€§</th><th><code>*mut T</code> / <code>*const T</code></th><th><code>NonNull&lt;T&gt;</code></th><th><code>Box&lt;T&gt;</code> / <code>&amp;T</code></th></tr></thead><tbody><tr><td><strong>æ˜¯å¦å…è®¸ä¸ºç©º</strong></td><td>âœ…</td><td><strong>âŒ å¿…é¡»éç©º</strong></td><td>ä¸é€‚ç”¨</td></tr><tr><td><strong>åå˜æ€§</strong></td><td><code>*mut</code> ä¸åå˜</td><td><strong>åå˜</strong>ï¼ˆå¯å®‰å…¨å‘å­ç±»å‹è½¬æ¢ï¼‰</td><td><code>&amp;T</code> åå˜</td></tr><tr><td><strong>Option ä¼˜åŒ–</strong></td><td>âŒ å¤š 1 B åˆ¤åˆ«å­—èŠ‚</td><td><strong>âœ… ä¸è£¸æŒ‡é’ˆåŒå°ºå¯¸</strong></td><td>å·²è‡ªå¸¦ä¼˜åŒ–</td></tr><tr><td><strong>æ‰€æœ‰æƒ / drop è´£ä»»</strong></td><td>æ²¡æœ‰</td><td>æ²¡æœ‰ï¼ˆçº¯æŒ‡é’ˆï¼‰</td><td>æœ‰</td></tr><tr><td><strong>Send / Sync</strong></td><td>ä¸ <code>T</code> æ— å…³</td><td>é»˜è®¤ <code>!Send !Sync</code></td><td>å–å†³äº <code>T</code></td></tr><tr><td><strong>å¸¸è§ç”¨é€”</strong></td><td>FFIã€åº•å±‚ç®—æ³•</td><td><strong>æ™ºèƒ½æŒ‡é’ˆå†…éƒ¨ã€ä¾µå…¥å¼å®¹å™¨ã€è£æ‰ç©ºåˆ¤</strong></td><td>é«˜å±‚æ‰€æœ‰æƒæ¨¡å‹</td></tr></tbody></table><p>å…³é”®çš„ APIï¼š</p><table><thead><tr><th>åˆ†ç»„</th><th>ä»£è¡¨æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><strong>æ„é€ </strong></td><td><code>NonNull::new(ptr)</code> â†’ <code>Option&lt;NonNull&lt;T&gt;&gt;</code> <br><code>unsafe &#123; NonNull::new_unchecked(ptr) &#125;</code> <br><code>NonNull::dangling()</code></td><td>å®‰å…¨ / ä¸å®‰å…¨ / å ä½</td></tr><tr><td><strong>å¼•ç”¨è§†å›¾</strong></td><td><code>unsafe</code> <br><code>fn as_ref</code> / <code>as_mut</code></td><td>æŠŠè£¸æŒ‡é’ˆä¸´æ—¶å€Ÿç”¨æˆ <code>&amp;T</code> / <code>&amp;mut T</code></td></tr><tr><td><strong>è£¸æŒ‡é’ˆäº’è½¬</strong></td><td><code>fn as_ptr</code></td><td>å–å› <code>*mut T</code>ï¼Œè§£å¼•ç”¨ä»éœ€ <code>unsafe</code></td></tr><tr><td><strong>ç±»å‹è½¬æ¢</strong></td><td><code>fn cast&lt;U&gt;</code> <br><code>fn cast_mut</code> / <code>cast_const</code></td><td>ä¿ç•™åœ°å€ï¼Œæ¢ç±»å‹æˆ–å¯å˜æ€§</td></tr><tr><td><strong>åœ°å€è¿ç®—</strong></td><td><code>unsafe fn add / byte_add / sub / offset</code></td><td>æŒ‡é’ˆç®—æœ¯ï¼Œä¸ <code>ptr::add</code> æ—ä¸€è‡´</td></tr><tr><td><strong>åˆ‡ç‰‡åŠ©æ‰‹</strong></td><td><code>NonNull::slice_from_raw_parts(data, len)</code> <br><code>fn len()</code></td><td>1.70+ ç¨³å®šï¼Œä¸º <code>[T]</code> æä¾›éç©ºè£¸åˆ‡ç‰‡æ„é€  (<a href="https://rustwiki.org/zh-CN/std/ptr/struct.NonNull.html?utm_source=chatgpt.com">rustwiki.org</a>)</td></tr></tbody></table><blockquote><p>âš ï¸ ä»»ä½•æŠŠ <code>NonNull</code> é‡æ–°è§£é‡Šä¸ºå¼•ç”¨æˆ–è§£å¼•ç”¨çš„æ“ä½œï¼Œéƒ½å¿…é¡»åœ¨ <code>unsafe</code> å—é‡Œæ‰‹åŠ¨ä¿è¯å†…å­˜æœ‰æ•ˆæ€§ä¸åˆ«åè§„åˆ™ã€‚</p></blockquote><p>å…¸å‹ä½¿ç”¨åœºæ™¯ï¼š</p><table><thead><tr><th>åœºæ™¯</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td><strong>æ™ºèƒ½æŒ‡é’ˆå†…éƒ¨å®ç°</strong> (<code>Box</code>/<code>Rc</code>/<code>Arc</code>)</td><td>éœ€è¦ <em>éç©º</em> åŸå§‹æŒ‡é’ˆå­˜æ”¾è¢«ç®¡å¯¹è±¡ï¼Œä¸”è¦åœ¨ <code>Option</code> ç­‰åœºæ™¯ä¸‹èŠ‚çœç©ºé—´</td></tr><tr><td><strong>è‡ªç ”ä¾µå…¥å¼é“¾è¡¨ / çº¢é»‘æ ‘</strong></td><td>èŠ‚ç‚¹è‡ªèº«æŒæœ‰å‰åæŒ‡é’ˆå­—æ®µ <code>NonNull&lt;Node&lt;T&gt;&gt;</code>ï¼Œå¤©ç„¶é¿å…ç©ºåˆ¤åˆ†æ”¯</td></tr><tr><td><strong>æƒ°æ€§åˆå§‹åŒ– / <code>Vec::new</code></strong></td><td>å…ˆç”¨ <code>NonNull::dangling()</code> å ä½ï¼Œç­‰çœŸæ­£åˆ†é…åå†å†™å…¥æ­£ç¡®åœ°å€</td></tr><tr><td><strong>FFI</strong></td><td>C API æ˜ç¡®ä¿è¯å‚æ•°æ°¸ä¸ä¸ºç©ºæ—¶ï¼Œç”¨ <code>NonNull</code> åœ¨ç±»å‹å±‚é¢è¡¨è¾¾å‰ç½®æ¡ä»¶</td></tr><tr><td><strong>è‡ªå¼•ç”¨ç»“æ„ï¼ˆPin å·¥ä½œåŒºï¼‰</strong></td><td>åœ¨å®ŒæˆçœŸæ­£åˆå§‹åŒ–å‰ä½¿ç”¨ <code>NonNull::dangling()</code> ä¿å­˜æŒ‡å‘è‡ªèº«å­—æ®µçš„æŒ‡é’ˆ</td></tr></tbody></table><h3 id="2-ManuallyDrop-T">2. ManuallyDrop&lt;T&gt;</h3><p><code>std::mem::ManuallyDrop&lt;T&gt;</code> æ˜¯ä¸€ä¸ªé›¶æˆæœ¬ï¼ˆzero-costï¼‰åŒ…è£…å™¨ã€‚æŠŠå€¼åŒ…åœ¨ <code>ManuallyDrop</code> é‡Œä¼šå‘Šè¯‰ç¼–è¯‘å™¨ï¼š<strong>è¯·ä¸è¦åœ¨ä½œç”¨åŸŸç»“æŸæ—¶è‡ªåŠ¨è°ƒç”¨å®ƒçš„ <code>Drop</code> å®ç°ï¼Œä»€ä¹ˆæ—¶å€™é‡Šæ”¾ï¼ˆæˆ–æ˜¯å¦é‡Šæ”¾ï¼‰ç”±æˆ‘æ‰‹åŠ¨å†³å®šã€‚</strong></p><ul><li><code>ManuallyDrop&lt;T&gt;</code> åªæ˜¯æŠŠ <strong>â€œæ˜¯å¦è‡ªåŠ¨ dropâ€</strong> è¿™ä¸€è¯­ä¹‰ä»ç¼–è¯‘å™¨æ¬åˆ°äº†ç¨‹åºå‘˜èº«ä¸Šï¼›</li><li>å®ƒ<strong>ä¸æ”¹å˜</strong> <code>T</code> çš„å¸ƒå±€ï¼Œä¹Ÿä¸ä¼šäº§ç”Ÿé¢å¤–çš„å­—èŠ‚ï¼Œå› æ­¤æ˜¯é›¶å¼€é”€ï¼›</li><li><strong>unsafe è´£ä»»</strong>ï¼šä½ å¿…é¡»ä¿è¯ä¸€ä»½å€¼<strong>æ°å¥½ææ„ä¸€æ¬¡</strong>ï¼ˆä¸èƒ½æ¼æ‰ï¼Œä¹Ÿä¸èƒ½å¤šè°ƒï¼‰ã€‚</li></ul><p>å®ƒçš„æ ¸å¿ƒ API å¦‚è¡¨æ‰€ç¤ºï¼š</p><table><thead><tr><th>API</th><th>ä½œç”¨</th><th>é‡è¦æ³¨æ„ç‚¹</th></tr></thead><tbody><tr><td><strong><code>ManuallyDrop::new(value)</code></strong></td><td>æŠŠ <code>T</code> åŒ…è£…æˆ <code>ManuallyDrop&lt;T&gt;</code>ï¼Œå…³é—­è‡ªåŠ¨ææ„</td><td>é›¶å¼€é”€ï¼›ä¹‹åéœ€æ˜¾å¼ drop æˆ–ç§»åŠ¨èµ°</td></tr><tr><td><strong><code>ManuallyDrop::drop(&amp;mut self)</code></strong> <em>(unsafe)</em></td><td>æ‰‹åŠ¨è§¦å‘å†…éƒ¨å€¼çš„ææ„</td><td>å¿…é¡»ä¿è¯ä¹‹åä¸ä¼šå†è®¿é—® / å† drop</td></tr><tr><td><strong><code>ManuallyDrop::take(&amp;mut self)</code></strong> <em>(unsafe)</em></td><td>ä»åŒ…è£…é‡Œ&quot;æ¬èµ°&quot;å€¼ï¼ˆç­‰ä»·äº <code>ptr::read</code>ï¼‰</td><td><code>v</code> é‡Œç•™ä¸‹æœªåˆå§‹åŒ–å†…å­˜ï¼Œä¸èƒ½å†ç”¨æˆ–å† drop</td></tr><tr><td><strong><code>ManuallyDrop::into_inner(self)</code></strong> <em>(unsafe)</em></td><td>æ¶ˆè´¹ <code>ManuallyDrop</code> è¿”å›å†…éƒ¨å€¼</td><td>å–å¾—æ‰€æœ‰æƒåï¼ŒåŸåŒ…è£…å·²è¢«ç§»èµ°ï¼ˆä¸ä¼š double-dropï¼‰</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">æœ¬æ–‡æ‰‹æŠŠæ‰‹å¸¦ä½ æ‹†è§£å¹¶é‡æ„ Arcï¼šä»å•çº¿ç¨‹å¼•ç”¨è®¡æ•°ï¼Œåˆ°è·¨çº¿ç¨‹ Weak é˜²ç¯ï¼Œå†åˆ°å‰¥ç¦»å¼º/å¼±å¼•ç”¨ä¸å†…å­˜åºä¼˜åŒ–ï¼Œå±‚å±‚æ·±å…¥ Rust å¹¶å‘ä¸å†…å­˜æ¨¡å‹æ ¸å¿ƒã€‚</summary>
    
    
    
    <category term="rust" scheme="https://hedon.top/categories/rust/"/>
    
    <category term="rust å®æˆ˜" scheme="https://hedon.top/categories/rust/rust-%E5%AE%9E%E6%88%98/"/>
    
    
    <category term="rust" scheme="https://hedon.top/tags/rust/"/>
    
    <category term="å¹¶å‘ç¼–ç¨‹" scheme="https://hedon.top/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª oneshot channel</title>
    <link href="https://hedon.top/2025/05/29/rust-action-oneshot-channel/"/>
    <id>https://hedon.top/2025/05/29/rust-action-oneshot-channel/</id>
    <published>2025-05-29T14:11:03.000Z</published>
    <updated>2025-06-05T00:38:36.454Z</updated>
    
    <content type="html"><![CDATA[<p>ç³»åˆ—æ–‡ç« ï¼š</p><ul><li><a href="https://hedon.top/2024/11/11/rust-memory-order/">Rust åŸç†ä¸¨èŠä¸€èŠ Rust çš„ Atomic å’Œå†…å­˜é¡ºåº</a></li><li><a href="https://hedon.top/2025/05/13/rust-action-spinlock/">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª SpinLock</a></li></ul><p>ç»§ä¸Šç¯‡ <a href="https://hedon.top/2025/05/13/rust-action-spinlock/">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª SpinLock</a>ï¼Œæœ¬ç¯‡æˆ‘ä»¬ç»§ç»­å‚è€ƒ <a href="https://marabos.nl/atomics/">Rust Atomics and Locks</a> ä¸€ä¹¦ï¼Œæ¥å®ç°ä¸€ä¸ª <code>oneshot channel</code>ã€‚</p><p>åœ¨ Go è¯­è¨€ä¸­ï¼Œæœ‰ä¸€å¥åè¨€ï¼š</p><blockquote><p>Donâ€™t communicate by sharing memory, share memory by communicating. ä¸è¦é€šè¿‡å…±äº«å†…å­˜æ¥é€šä¿¡ï¼Œè€Œè¦é€šè¿‡é€šä¿¡æ¥å…±äº«å†…å­˜ã€‚</p></blockquote><p>è®²çš„å°±æ˜¯é€šé“ <code>channel</code>ã€‚ä½¿ç”¨ <code>channel</code> æ¥é€šä¿¡ï¼Œä¸€æ–¹é¢å¯ä»¥é¿å…å…±äº«çŠ¶æ€çš„å¹¶å‘ç«äº‰é—®é¢˜ï¼Œå¦ä¸€æ–¹é¢å¯ä»¥è§£è€¦ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ã€‚</p><p><code>channel</code> æ ¹æ®ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„æ•°é‡ï¼Œå¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç§ï¼š</p><ol><li><strong>å•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…</strong> (SPSC)</li><li><strong>å•ç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…</strong> (SPMC)</li><li><strong>å¤šç”Ÿäº§è€…å•æ¶ˆè´¹è€…</strong> (MPSC)</li><li><strong>å¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…</strong> (MPMC)</li></ol><p>åœ¨<strong>å•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…</strong>è¿™ä¸ªåˆ†ç±»ä¸­ï¼Œæœ‰ä¸€ç§ç‰¹æ®Šä¸”å¸¸ç”¨çš„åœºæ™¯ï¼Œå«<strong>ä¸€æ¬¡æ€§é€šé“</strong>ï¼ˆoneshot channelï¼‰ã€‚å®ƒåœ¨ SPSC çš„åŸºç¡€ä¸Šå¢åŠ äº†é¢å¤–çº¦æŸï¼šæ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…åªä¼ é€’ä¸€æ¬¡æ•°æ®ï¼Œä¼ é€’å®Œæˆåé€šé“å°±å¤±æ•ˆäº†ã€‚</p><p>ç†Ÿæ‚‰ Go è¯­è¨€çš„è¯»è€…åº”è¯¥å¯¹ä»¥ä¸‹ä½¿ç”¨åœºæ™¯å¾ˆç†Ÿæ‚‰ï¼Œè¿™äº›éƒ½æ˜¯å…¸å‹çš„ oneshot channel åº”ç”¨ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">demo1</span><span class="params">()</span></span> &#123;</span><br><span class="line">done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// ... do something</span></span><br><span class="line"><span class="built_in">close</span>(done)</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">&lt;-done</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">demo2</span><span class="params">()</span></span> &#123;</span><br><span class="line">oneShot := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">oneShot &lt;- generateText()</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">text := &lt;-oneShot</span><br><span class="line">doSthWithText(text)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">generateText</span><span class="params">()</span></span> <span class="type">string</span> &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doSthWithText</span><span class="params">(text <span class="type">string</span>)</span></span> &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ Rust ç¤¾åŒºé‡Œé¢ï¼Œå°±æœ‰ä¸€ä¸ªéå¸¸ä¼˜ç§€çš„ <a href="https://docs.rs/oneshot/latest/oneshot/">oneshot</a> å®ç°ï¼Œåœ¨è¯¦ç»†æ·±å…¥å®ƒçš„å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå‚è€ƒ <a href="https://marabos.nl/atomics/building-channels.html">Rust Atomics and Locks</a> ä¸€ä¹¦ï¼Œæ¥å°è¯•å®ç°ä¸€ä¸ª <code>oneshot channel</code>!</p><h2 id="è¯»å®Œæœ¬ç¯‡ä½ èƒ½å­¦åˆ°ä»€ä¹ˆ">è¯»å®Œæœ¬ç¯‡ä½ èƒ½å­¦åˆ°ä»€ä¹ˆ</h2><ol><li><p><strong>ä¸€æ¬¡æ€§ (oneshot) é€šé“çš„åœºæ™¯ä¸ä¼˜åŠ¿</strong></p><ul><li>äº†è§£å®ƒä¸å¤šç”Ÿäº§è€…/å¤šæ¶ˆè´¹è€…é€šé“çš„åŒºåˆ«</li><li>æŒæ¡å¸¸è§ä½¿ç”¨æ¨¡å¼ï¼ˆå¦‚çº¿ç¨‹åŒæ­¥ã€å•æ¬¡ç»“æœè¿”å›ï¼‰</li></ul></li><li><p><strong>Rust å¹¶å‘æ ¸å¿ƒåŸè¯­çš„æ¸è¿›å¼å®è·µ</strong></p><ul><li><code>UnsafeCell</code>ï¼šå†…éƒ¨å¯å˜æ€§åŸºçŸ³</li><li><code>AtomicBool</code> + <code>Ordering::&#123;Release,Acquire&#125;</code>ï¼šæœ€å°åŒ–åŒæ­¥åŸè¯­</li><li><code>MaybeUninit&lt;T&gt;</code>ï¼šé›¶æˆæœ¬å»¶è¿Ÿåˆå§‹åŒ–</li></ul></li><li><p><strong>ç”¨æ‰€æœ‰æƒä¸ç”Ÿå‘½å‘¨æœŸè®¾è®¡é›¶è¯¯ç”¨ API</strong></p><ul><li>å°† <code>Sender</code> / <code>Receiver</code> æ‹†åˆ†å¹¶ä¸€æ¬¡æ€§æ¶ˆè´¹</li><li>ç”Ÿå‘½å‘¨æœŸå¼•ç”¨ vs <code>Arc</code> çš„æƒè¡¡ä¸æ›¿æ¢æŠ€å·§</li></ul></li><li><p><strong>çº¿ç¨‹æŒ‚èµ·/å”¤é†’æœºåˆ¶</strong></p><ul><li><code>std::thread::park / unpark</code> çš„é˜»å¡å¼ç­‰å¾…æ¨¡å‹</li></ul></li><li><p><strong>ç±»å‹ç³»ç»Ÿå±‚é¢çš„â€œé˜²å‘†â€æ‰‹æ®µ</strong></p><ul><li>åˆ©ç”¨ <code>PhantomData</code> ç¦æ­¢è·¨çº¿ç¨‹è¯¯ç”¨</li><li><code>Drop</code> æ‰‹åŠ¨å›æ”¶ï¼Œé¿å…å†…å­˜æ³„æ¼</li></ul></li><li><p><strong>ä¸€æ­¥æ­¥ä¼˜åŒ–çš„æ€è€ƒè·¯å¾„</strong></p><ul><li>å¦‚ä½•å‘ç°é—®é¢˜ â†’ æå‡ºå‡è®¾ â†’ å®ç° â†’ éªŒè¯ â†’ å†è¿­ä»£</li></ul></li></ol><blockquote><p>å¸¦ç€è¿™äº›ç›®æ ‡ï¼Œè·Ÿéšæœ¬æ–‡ä¸€è·¯è¿­ä»£åˆ° <strong>v8</strong>ï¼Œä½ å°†æ‹¥æœ‰ä¸€ä¸ªé«˜æ€§èƒ½ã€é›¶è¯¯ç”¨çš„ oneshot channelï¼Œä»¥åŠä¸€æ•´å¥—å¯è¿ç§»åˆ°å…¶å®ƒå¹¶å‘åœºæ™¯çš„è®¾è®¡æ€ç»´ã€‚</p></blockquote><h2 id="çƒ­èº«ç‰ˆ-v0ï¼šåŸºäºé”çš„é€šé“">çƒ­èº«ç‰ˆ v0ï¼šåŸºäºé”çš„é€šé“</h2><p>æˆ‘ä»¬å…ˆæ¥å®ç°ä¸€ä¸ª<strong>ä¸‡èƒ½ç‰ˆ</strong> <code>channel</code> çƒ­çƒ­èº«ã€‚é¡¾åæ€ä¹‰ï¼Œ<code>channel</code> åˆ†ä¸º 2 ä¸ªåŠŸèƒ½ï¼Œ<code>send</code> å’Œ <code>receive</code>ï¼Œå…¶ä¸­ï¼š</p><ul><li><code>send</code> å¾€ <code>channel</code> ä¸€å¤´æ”¾æ•°æ®ã€‚</li><li><code>receive</code> ä» <code>channel</code> å¦å¤–ä¸€å¤´å–æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®ï¼Œåˆ™é˜»å¡ä½ï¼Œç›´åˆ°æœ‰æ•°æ®æ—¶è¿”å›å–å‡ºæ•°æ®å¹¶è¿”å›ã€‚</li></ul><p>åœ¨ Rust ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨é˜Ÿåˆ— <code>VecQueue</code> æ¥ä½œä¸ºæ•°æ®çš„æ‰¿è½½ï¼ŒåŒæ—¶ä¸ºäº†å¯¹é˜Ÿåˆ—è®¿é—®çš„å¹¶å‘å®‰å…¨ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨é” <code>Mutex</code> æ¥ä¿æŠ¤å®ƒï¼Œå¦å¤–ï¼Œåœ¨æ¶ˆè´¹è€…å–æ•°æ®æ—¶ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®ï¼Œåˆ™éœ€è¦é˜»å¡å¹¶ç­‰å¾…å”¤é†’ï¼ˆä½¿ç”¨å¾ªç¯ç­‰å¾…å°±å¤ªè€— CPU äº†ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ¡ä»¶å˜é‡ <code>Condvar</code> æ¥å®ç°æŒ‚èµ·å’Œå”¤é†’ã€‚</p><p>ç»è¿‡ä»¥ä¸Šåˆ†æï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰å¦‚ä¸‹çš„ç»“æ„ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::&#123;</span><br><span class="line">    collections::VecDeque,</span><br><span class="line">    sync::&#123;Condvar, Mutex&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Channel</span>&lt;T&gt; &#123;</span><br><span class="line">    queue: Mutex&lt;VecDeque&lt;T&gt;&gt;,</span><br><span class="line">    item_ready: Condvar,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>send</code> å’Œ <code>receive</code> æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; Channel&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            queue: Mutex::<span class="title function_ invoke__">new</span>(VecDeque::<span class="title function_ invoke__">new</span>()),</span><br><span class="line">            item_ready: Condvar::<span class="title function_ invoke__">new</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">send</span>(&amp;<span class="keyword">self</span>, message: T) &#123;</span><br><span class="line">      <span class="comment">// ä¸Šé”å¹¶ä»é˜Ÿåˆ—åé¢æ’å…¥æ•°æ®</span></span><br><span class="line">        <span class="keyword">self</span>.queue.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>().<span class="title function_ invoke__">push_back</span>(message);</span><br><span class="line">        <span class="comment">// å”¤é†’ä¸€ä¸ªç­‰å¾…æ•°æ®çš„çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">self</span>.item_ready.<span class="title function_ invoke__">notify_one</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">receive</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> T &#123;</span><br><span class="line">      <span class="comment">// æŠ¢å é˜Ÿåˆ—</span></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">b</span> = <span class="keyword">self</span>.queue.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">          <span class="comment">// å°è¯•ä»é˜Ÿåˆ—ä¸­è·å–æ•°æ®ï¼Œå¦‚æœè·å–åˆ°ï¼Œåˆ™ç›´æ¥è¿”å›ï¼ˆå¹¶é‡Šæ”¾é”ï¼‰</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(message) = b.<span class="title function_ invoke__">pop_front</span>() &#123;</span><br><span class="line">                <span class="keyword">return</span> message;</span><br><span class="line">            &#125;</span><br><span class="line">          <span class="comment">// æ²¡æœ‰æ•°æ®ï¼Œåˆ™æŒ‚èµ·å½“å‰çº¿ç¨‹ï¼ˆåŒæ—¶é‡Šæ”¾é”ï¼‰</span></span><br><span class="line">            b = <span class="keyword">self</span>.item_ready.<span class="title function_ invoke__">wait</span>(b).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>self.queue.lock().unwrap()</code> è¿”å›çš„ <code>b</code> æ˜¯ä¸€ä¸ª <code>MutextGuard</code>ï¼Œæ‰€ä»¥å½“æ‰§è¡Œ <code>self.item_ready.wait(b)</code> çš„æ—¶å€™ï¼Œåœ¨æŒ‚èµ·å½“å‰çº¿ç¨‹çš„æ—¶å€™ï¼Œä¼šé‡Šæ”¾ <code>b</code>ï¼Œæ‰€ä»¥è¿™é‡Œä¸ä¼šä¸€ç›´å ç”¨é”ï¼Œè€Œå¯¼è‡´å…¶ä»–çº¿ç¨‹æŠ¢ä¸åˆ°é”ã€‚</p><p>è¿™ä¸ªç‰ˆæœ¬çš„å®ç°åœ¨åŠŸèƒ½ä¸Šå½“ç„¶æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯åœ¨æ€§èƒ½ä¸Šè¿˜æœ‰éå¸¸å¤šå¯ä»¥ä¼˜åŒ–çš„åœ°æ–¹ï¼Œå°¤å…¶æ˜¯åœ¨é”çš„ä½¿ç”¨ä¸Šï¼Œåœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œé”çš„ç«äº‰ä¼šéå¸¸æ¿€çƒˆã€‚</p><p>OKï¼Œçƒ­å®Œèº«åï¼Œæˆ‘ä»¬å¼€å§‹åŸºäºè¿™ä¸ªå®ç°ï¼Œæ¥ä¸€æ­¥æ­¥å®ç°ä¸€ä¸ªé«˜æ€§èƒ½çš„ <code>oneshot channel</code>ï¼</p><h2 id="åŸºç¡€ç‰ˆ-v1ï¼šunsafe-æé†’ä½¿ç”¨è€…">åŸºç¡€ç‰ˆ v1ï¼šunsafe æé†’ä½¿ç”¨è€…</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Channel</span>&lt;T&gt; &#123;</span><br><span class="line">    queue: Mutex&lt;VecDeque&lt;T&gt;&gt;,</span><br><span class="line">    item_ready: Condvar,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆæ¥åˆ†æä¸€ä¸‹ï¼Œä¸€ä¸ª <code>oneshot channel</code> çš„ç»“æ„ï¼Œéœ€è¦åŒ…å«å“ªäº›å­—æ®µã€‚</p><ol><li>é¦–å…ˆå®ƒå¯èƒ½ä¼šæœ‰ 0 æ¡æ•°æ®æˆ– 1 æ¡æ•°æ®ï¼Œæ‰€ä»¥å¾ˆå½“ç„¶ï¼Œæ•°æ®å¯ä»¥ç”¨ä¸€ä¸ª <code>Option</code> æ¥æ‰¿è½½ã€‚</li><li>å¦å¤–ï¼Œ<code>send</code> å’Œ <code>receive</code> å¯ä»¥åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­è¢«è°ƒç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½ç”¨å…±äº«åªè¯»å¼•ç”¨ï¼Œè€Œä¸æ˜¯ç”¨ <code>mut</code> ç‹¬äº«å¯å˜å¼•ç”¨ï¼Œä½†æ˜¯ <code>send</code> å’Œ <code>receive</code> éƒ½éœ€è¦å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œå°±éœ€è¦ä¸€ä¸ªæ”¯æŒå†…éƒ¨å¯å˜æ€§çš„æ•°æ®ç»“æ„ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œå°±ç”¨åˆ°äº†ä¸Šç¯‡ <a href="https://hedon.top/2025/05/13/rust-action-spinlock/#%E5%8D%87%E7%BA%A7%E7%89%88-v1">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª SpinLock</a> ä»‹ç»çš„ <code>UnsafeCell&lt;T&gt;</code>ï¼Œå®ƒå…è®¸åœ¨å…±äº«å¼•ç”¨ä¸‹è¿›è¡Œå†…éƒ¨å¯å˜æ€§ä¿®æ”¹ï¼Œæ˜¯ Rust å¹¶å‘åŸè¯­çš„åŸºçŸ³ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</li><li>æœ€åï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå˜é‡æ¥è¡¨æ˜æ˜¯å¦æœ‰æ•°æ®ï¼Œä¸ºäº†å¹¶å‘å®‰å…¨ï¼Œè¿™é‡Œå¯ä»¥ç”¨ <code>AtomicBool</code>ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬ä¹Ÿå¢åŠ äº†ä¸€ä¸ª <code>is_ready</code> çš„æ–¹æ³•ï¼Œç”¨äºåˆ¤æ–­æ•°æ®æ˜¯å¦å·²å‡†å¤‡å¥½ã€‚å¯¹äºåŸå­å˜é‡ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€å¯¹ <code>Release</code> å’Œ <code>Acquire</code>ï¼ˆ<code>Release</code> ç¡®ä¿ä¹‹å‰çš„å†™å…¥å¯¹å…¶ä»–çº¿ç¨‹å¯è§ï¼Œ<code>Acquire</code> ç¡®ä¿èƒ½çœ‹åˆ°ä¹‹å‰çš„ <code>Release</code> å†™å…¥ï¼‰æ¥ç¡®ä¿åŸå­å˜é‡çš„è·¨çº¿ç¨‹å¯è§æ€§ã€‚</li></ol><p>åŸºäºä»¥ä¸Šåˆ†æï¼Œæˆ‘ä»¬å®šå‡ºäº†æ–°çš„ <code>Channel</code> ç»“æ„ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Channel</span>&lt;T&gt; &#123;</span><br><span class="line">    message: UnsafeCell&lt;<span class="type">Option</span>&lt;T&gt;&gt;,</span><br><span class="line">    ready: AtomicBool,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹åº”çš„ <code>send</code>ã€<code>receive</code> å’Œ <code>is_ready</code> å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; Channel&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            message: UnsafeCell::<span class="title function_ invoke__">new</span>(<span class="literal">None</span>),</span><br><span class="line">            ready: AtomicBool::<span class="title function_ invoke__">new</span>(<span class="literal">false</span>),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Safety: Only call this once!</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">send</span>(&amp;<span class="keyword">self</span>, message: T) &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.message.<span class="title function_ invoke__">get</span>().<span class="title function_ invoke__">write</span>(<span class="title function_ invoke__">Some</span>(message));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.ready.<span class="title function_ invoke__">store</span>(<span class="literal">true</span>, Ordering::Release);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">is_ready</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.ready.<span class="title function_ invoke__">load</span>(Ordering::Acquire)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Safety: Only call this once,</span></span><br><span class="line">    <span class="comment">/// and only after is_ready() returns true!</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">receive</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> T &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; <span class="keyword">self</span>.message.<span class="title function_ invoke__">get</span>().<span class="title function_ invoke__">read</span>().<span class="title function_ invoke__">unwrap</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼š</p><ol><li>æˆ‘ä»¬æš‚ä¸”ä½¿ç”¨ <code>unsafe</code> åŠ æ³¨é‡Šçš„æ–¹å¼ï¼Œæ¥ <strong>æé†’</strong> ä½¿ç”¨è€…ï¼Œ<code>send</code> å’Œ <code>receive</code> åªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡ï¼ŒåŒæ—¶ï¼Œåœ¨è°ƒç”¨ <code>receive</code> ä¹‹å‰ï¼Œå¿…é¡»å…ˆä½¿ç”¨ <code>is_ready</code> è¿›è¡Œæ•°æ®æ£€æŸ¥ã€‚</li><li>å¯¹äºåŸå­å˜é‡ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€å¯¹ Release å’Œ Acquire æ¥ç¡®ä¿åŸå­å˜é‡çš„è·¨çº¿ç¨‹å¯è§æ€§ï¼Œå…·ä½“å¯å‚è€ƒ <a href="https://hedon.top/2024/11/11/rust-memory-order/">Rust åŸç†ä¸¨èŠä¸€èŠ Rust çš„ Atomic å’Œå†…å­˜é¡ºåº</a>ã€‚</li></ol><p>å¦å¤–åˆ«å¿˜äº†ï¼Œ<code>UnsafeCell&lt;T&gt;</code> æ˜¯ä¸æ”¯æŒ <code>Sync</code> çš„ï¼Œæ‰€ä»¥ä¸ºäº†æˆ‘ä»¬çš„ <code>Channel</code> å¯ä»¥è·¨çº¿ç¨‹ä½¿ç”¨ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºå…¶å®ç° <code>Sync</code> traitï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. Channel&lt;T&gt; å¯ä»¥åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­è¢«åˆ†åˆ«æ‰§è¡Œ send å’Œ receiveï¼Œæ‰€ä»¥å®ƒçš„å¼•ç”¨å¯ä»¥åœ¨çº¿ç¨‹ä¸­å…±äº«ï¼Œæ‰€ä»¥éœ€è¦å®ç° Syncï¼›</span></span><br><span class="line"><span class="comment">// 2. T ç”±çº¿ç¨‹ 1 ç”Ÿæˆå¹¶æ”¾å…¥ Channelï¼Œç„¶åç”±çº¿ç¨‹ 2 ä» Channel ä¸­è·å–ï¼Œæ‰€ä»¥å®ƒéœ€è¦ä»ä¸€ä¸ªçº¿ç¨‹è½¬ç§»åˆ°å¦å¤–ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥éœ€è¦å®ç° Sendã€‚</span></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Sync</span> <span class="keyword">for</span> <span class="title class_">Channel</span>&lt;T&gt; <span class="keyword">where</span> T: <span class="built_in">Send</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">one_thread_should_work</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">channel</span> = Channel::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        channel.<span class="title function_ invoke__">send</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> channel.<span class="title function_ invoke__">is_ready</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">msg</span> = <span class="keyword">unsafe</span> &#123; channel.<span class="title function_ invoke__">receive</span>() &#125;;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(msg, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">cross_thread_should_work</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">channel</span> = Channel::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    thread::<span class="title function_ invoke__">scope</span>(|s| &#123;</span><br><span class="line">        s.<span class="title function_ invoke__">spawn</span>(|| &#123;</span><br><span class="line">            <span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">10</span>));</span><br><span class="line">            <span class="keyword">unsafe</span> &#123;</span><br><span class="line">                channel.<span class="title function_ invoke__">send</span>(<span class="number">1</span>);</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> channel.<span class="title function_ invoke__">is_ready</span>() &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">res</span> = <span class="keyword">unsafe</span> &#123; channel.<span class="title function_ invoke__">receive</span>() &#125;;</span><br><span class="line">                <span class="built_in">assert_eq!</span>(res, <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åŸºç¡€ç‰ˆ-v2ï¼šä½¿ç”¨-MaybeUninit-æ›¿ä»£-Option-å‡å°‘å†…å­˜å¼€é”€">åŸºç¡€ç‰ˆ v2ï¼šä½¿ç”¨ MaybeUninit æ›¿ä»£ Option å‡å°‘å†…å­˜å¼€é”€</h2><p>æˆ‘ä»¬å…ˆæ¥æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼š<strong>Option&lt;T&gt; çš„å†…å­˜å ç”¨æ˜¯å¤šå°‘ï¼Ÿ</strong></p><blockquote><p>ç»“è®ºæ˜¯ï¼šï¼š<strong><code>Option&lt;T&gt;</code> ç›¸æ¯”äº Tï¼Œå¯èƒ½éœ€è¦é¢å¤–æ¶ˆè€—æ ‡è®°ä½å’Œå¡«å……ä½çš„ç©ºé—´</strong>ã€‚å…·ä½“å¯å‚è€ƒ<u>é™„å½•ï¼š1. Option&lt;T&gt; çš„å†…å­˜å ç”¨æ˜¯å¤šå°‘</u>ã€‚</p></blockquote><p>å¦å¤–ä¸€ç‚¹æ˜¯ï¼Œ<code>Option&lt;T&gt;</code> å…¶å®å·²ç»åŒ…å«äº†æ˜¯å¦å­˜åœ¨å€¼çš„ä¿¡æ¯äº†ï¼Œå®ƒè·Ÿ <code>ready</code> è¿™ä¸ªæ ‡å¿—çš„ä½œç”¨å…¶å®é‡å¤äº†ï¼Œæœ‰ä¸€äº›æµªè´¹ã€‚</p><p>åœ¨å½“ä¸‹åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦å¤–ä¸€ä¸ªæ•°æ®ç»“æ„æ¥æ›¿ä»£ <code>Option&lt;T&gt;</code> â€”â€” <code>MaybeUninit&lt;T&gt;</code>ï¼Œç›¸æ¯”äº <code>Option&lt;T&gt;</code>ï¼Œå®ƒæœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š</p><ol><li><strong>å†…å­˜å ç”¨ä¼˜åŒ–</strong>ï¼šåœ¨ <code>Option&lt;T&gt;</code> ä¸­ï¼Œå¯¹äºéç©ºæŒ‡é’ˆä¼˜åŒ–ï¼ˆNiche Optimizationï¼‰çš„ç±»å‹ï¼Œ<code>None</code> ä¼šå ç”¨é¢å¤–çš„ç©ºé—´ï¼ˆä¸€ä¸ªå­—èŠ‚çš„æ ‡ç­¾+å¯èƒ½çš„å¯¹é½å¡«å……ï¼‰ã€‚è€Œ <code>MaybeUninit&lt;T&gt;</code> æœ¬èº«å°±æ˜¯ä¸€ä¸ªå¤§å°ä¸ <code>T</code> ç›¸åŒçš„æœªåˆå§‹åŒ–å†…å­˜ï¼Œå®ƒæ²¡æœ‰æ ‡ç­¾ï¼Œå› æ­¤ä¸ä¼šå¼•å…¥é¢å¤–çš„å†…å­˜å¼€é”€ã€‚</li><li><strong>é¿å…åˆå§‹åŒ–å¼€é”€</strong>ï¼šä½¿ç”¨ <code>Option&lt;T&gt;</code> æ—¶ï¼Œåœ¨åˆå§‹åŒ–æ—¶è®¾ç½®ä¸º <code>None</code>ï¼Œå®é™…ä¸Šä¼šå†™å…¥ä¸€ä¸ªè¡¨ç¤º <code>None</code> çš„å€¼ï¼ˆå³è¿›è¡Œåˆå§‹åŒ–ï¼‰ã€‚è€Œ <code>MaybeUninit&lt;T&gt;</code> çš„ <code>uninit()</code> ä¸ä¼šå¯¹å†…å­˜è¿›è¡Œä»»ä½•åˆå§‹åŒ–ï¼Œè¿™åœ¨æ€§èƒ½æ•æ„Ÿçš„åœºæ™¯ä¸‹å¯ä»¥é¿å…ä¸å¿…è¦çš„åˆå§‹åŒ–å¼€é”€ï¼ˆç‰¹åˆ«æ˜¯å½“ <code>T</code> å¾ˆå¤§æ—¶ï¼‰ã€‚</li><li><strong>æ›´çµæ´»åœ°æ§åˆ¶åˆå§‹åŒ–</strong>ï¼šåœ¨é€šé“çš„å®ç°ä¸­ï¼Œæ¶ˆæ¯å¯èƒ½ç”±ç”Ÿäº§è€…å†™å…¥ï¼Œç„¶åé€šè¿‡è®¾ç½® <code>ready</code> æ ‡å¿—æ¥é€šçŸ¥æ¶ˆè´¹è€…ã€‚ä½¿ç”¨ <code>MaybeUninit</code> å…è®¸æˆ‘ä»¬å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç›´åˆ°å®é™…éœ€è¦å†™å…¥æ¶ˆæ¯çš„æ—¶å€™ã€‚è¿™æ ·ï¼Œåœ¨é€šé“åˆ›å»ºæ—¶ï¼Œæˆ‘ä»¬ä¸éœ€è¦ä¸º <code>T</code> ç±»å‹çš„å€¼è¿›è¡Œä»»ä½•åˆå§‹åŒ–ï¼ˆå³ä½¿æ˜¯ <code>None</code>ï¼‰ï¼Œè€Œæ˜¯ç•™å‡ºä¸€å—æœªåˆå§‹åŒ–çš„å†…å­˜ï¼Œåœ¨åç»­ç”±ç”Ÿäº§è€…å†™å…¥å®é™…çš„å€¼ã€‚</li><li><strong>ä¸åŸå­æ ‡å¿—é…åˆæ›´é«˜æ•ˆ</strong>ï¼šåœ¨ä¸Šä¸ªç‰ˆæœ¬çš„è§†çº¿ä¸­ï¼Œ<code>ready</code> æ˜¯ä¸€ä¸ª <code>AtomicBool</code>ï¼Œç”¨äºæŒ‡ç¤ºæ¶ˆæ¯æ˜¯å¦å°±ç»ªã€‚åœ¨ <code>Option&lt;T&gt;</code> ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ£€æŸ¥ <code>Option</code> æ˜¯å¦ä¸º <code>Some</code>ï¼ŒåŒæ—¶è¿˜è¦æ£€æŸ¥ <code>ready</code> æ ‡å¿—ã€‚è€Œä½¿ç”¨ <code>MaybeUninit</code> åï¼Œæˆ‘ä»¬å®Œå…¨ä¾èµ– <code>ready</code> æ ‡å¿—æ¥åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦å¯ç”¨ï¼Œé¿å…äº†åŒé‡æ£€æŸ¥ï¼ˆå› ä¸º <code>MaybeUninit</code> æœ¬èº«ä¸æºå¸¦çŠ¶æ€ï¼Œæ‰€ä»¥çŠ¶æ€å®Œå…¨ç”± <code>ready</code> æ§åˆ¶ï¼‰ã€‚è¿™æ ·ï¼Œç»“æ„ä½“çš„å†…å­˜å¸ƒå±€æ›´ç´§å‡‘ï¼Œä¸”è®¿é—®æ¨¡å¼æ›´ç›´æ¥ã€‚</li><li><strong>æ½œåœ¨çš„æ€§èƒ½æå‡</strong>ï¼šç”±äºé¿å…äº†é¢å¤–çš„æ ‡ç­¾å’Œåˆå§‹åŒ–ï¼Œä»¥åŠæ›´ç´§å‡‘çš„å†…å­˜å¸ƒå±€ï¼Œå¯èƒ½ä¼šæé«˜ç¼“å­˜åˆ©ç”¨ç‡ï¼Œä»è€Œæå‡æ€§èƒ½ã€‚</li></ol><p><code>MaybeUninit&lt;T&gt;</code> æœ‰ä»¥ä¸‹å¸¸ç”¨æ–¹æ³•ï¼š</p><table><thead><tr><th>å¸¸ç”¨æ–¹æ³•</th><th>ä½œç”¨</th><th>å®‰å…¨çº§åˆ«</th></tr></thead><tbody><tr><td><code>MaybeUninit::uninit()</code></td><td>åˆ›å»ºä¸€å—<strong>å®Œå…¨æœªåˆå§‹åŒ–</strong>çš„å†…å­˜</td><td><code>const fn</code>ã€<code>safe</code></td></tr><tr><td><code>as_mut_ptr()</code> / <code>as_ptr()</code></td><td>å–å‡ºè£¸æŒ‡é’ˆï¼Œä¾›å¤–éƒ¨å†™å…¥æˆ–è¯»å–</td><td><code>safe</code></td></tr><tr><td><code>assume_init()</code> / <code>assume_init_read()</code></td><td>å‘Šè¯‰ç¼–è¯‘å™¨â€œè¿™é‡Œå·²ç»æ˜¯ä¸€ä¸ªåˆæ³•çš„ <code>T</code> äº†â€ï¼Œå¹¶è¿”å›å®ƒ</td><td><code>unsafe</code>ï¼ˆå› ä¸ºä½ å¾—ä¿è¯çœŸåˆå§‹åŒ–è¿‡ï¼‰</td></tr><tr><td><code>write(val)</code></td><td><strong>æŒ‰ä½æŠŠ <code>val</code> å¤åˆ¶/ç§»åŠ¨</strong> åˆ°è¿™å—æœªåˆå§‹åŒ–å†…å­˜ï¼›æ­¤åè§†ä¸ºå·²åˆå§‹åŒ–</td><td><code>unsafe</code></td></tr></tbody></table><p>ç»è¿‡ä¸Šé¢ä¸€é¡¿åˆ†æï¼Œæˆ‘ä»¬æ¥ä½¿ç”¨ <code>MaybeUninit&lt;T&gt;</code> æ¥æ›¿ä»£ <code>Option&lt;T&gt;</code>ï¼Œè¿›ä¸€æ­¥å‡å°‘å†…å­˜å ç”¨å’Œæå‡æ€§èƒ½ï¼Œæ–°çš„ <code>Channel</code> ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Channel</span>&lt;T&gt; &#123;</span><br><span class="line">    message: UnsafeCell&lt;MaybeUninit&lt;T&gt;&gt;,</span><br><span class="line">    ready: AtomicBool,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Channel&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">          <span class="comment">// åˆ›å»ºä¸€å—å®Œå…¨æœªåˆå§‹åŒ–çš„å†…å­˜ï¼Œå…ˆå ä½</span></span><br><span class="line">            message: UnsafeCell::<span class="title function_ invoke__">new</span>(MaybeUninit::<span class="title function_ invoke__">uninit</span>()),</span><br><span class="line">            ready: AtomicBool::<span class="title function_ invoke__">new</span>(<span class="literal">false</span>),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹åº”çš„ <code>send</code> å’Œ <code>receive</code> å®ç°æ›´æ–°å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; Channel&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">/// Safety: Only call this once!</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">send</span>(&amp;<span class="keyword">self</span>, message: T) &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            <span class="comment">// ä» UnsafeCell&lt;MaybeUninit&lt;T&gt;&gt; ä¸­å–å‡º MaybeUninit&lt;T&gt; å¹¶å†™å…¥æ•°æ®ã€‚</span></span><br><span class="line">            (*<span class="keyword">self</span>.message.<span class="title function_ invoke__">get</span>()).<span class="title function_ invoke__">write</span>(message);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.ready.<span class="title function_ invoke__">store</span>(<span class="literal">true</span>, Ordering::Release);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Safety: Only call this once,</span></span><br><span class="line">    <span class="comment">/// and only after is_ready() returns true!</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">receive</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> T &#123;</span><br><span class="line">      <span class="comment">// ä» UnsafeCell&lt;MaybeUninit&lt;T&gt;&gt; ä¸­å–å‡º MaybeUninit&lt;T&gt; å¹¶è¯»å‡ºæ•°æ®ã€‚</span></span><br><span class="line">        <span class="keyword">unsafe</span> &#123; (*<span class="keyword">self</span>.message.<span class="title function_ invoke__">get</span>()).<span class="title function_ invoke__">assume_init_read</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>send</code> ä¸­ï¼Œ<code>(*self.message.get())</code> ä» <code>UnsafeCell&lt;MaybeUninit&lt;T&gt;&gt;</code> ä¸­å–å‡º <code>MaybeUninit&lt;T&gt;</code>ï¼Œç„¶åè°ƒç”¨ <code>write</code> æ–¹æ³•æŠŠ <code>message</code> å†™å…¥è¿™å—æœªåˆå§‹åŒ–çš„å†…å­˜ä¸­ï¼Œæ­¤åè§†ä¸ºå·²åˆå§‹åŒ–ï¼Œå¹¶å¯ä»¥ä½¿ç”¨ä½¿ç”¨ <code>assume_init_read</code> è¿›è¡Œè¯»å–ã€‚</p><p>ä¿®æ”¹åï¼Œæµ‹è¯•ä»£ç æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œæˆ‘ä»¬æ‰§è¡Œä¹‹å‰çš„æµ‹è¯•ä»£ç ï¼Œå‘ç°è¿˜æ˜¯å¯ä»¥é€šè¿‡çš„ï¼</p><h2 id="åŸºç¡€ç‰ˆ-v3ï¼šå¢åŠ åŠ¨æ€æ£€æŸ¥æé«˜å®‰å…¨æ€§">åŸºç¡€ç‰ˆ v3ï¼šå¢åŠ åŠ¨æ€æ£€æŸ¥æé«˜å®‰å…¨æ€§</h2><p>ä¸Šè¿°ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ <code>unsafe</code> å’Œæ³¨é‡Šå»â€œè¦æ±‚â€è°ƒç”¨è€…ä¸¥æ ¼éµå¾ªä»¥ä¸‹çº¦æŸï¼š</p><ol><li><code>send</code> å’Œ <code>receive</code> æœ€å¤šåªè°ƒç”¨ä¸€æ¬¡ã€‚</li><li><code>receive</code> è°ƒç”¨ä¹‹å‰ï¼Œå¿…é¡»å…ˆç»è¿‡ <code>is_ready</code> çš„æ£€æŸ¥ã€‚</li></ol><p>åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬åŠ ä¸€ä¸‹åŠ¨æ€æ£€æŸ¥ï¼Œå¦‚æœè°ƒç”¨è€…ä¸æŒ‰è¦æ±‚åšäº‹ï¼Œé‚£å°±ç›´æ¥ <code>panic</code> ç»™å‡ºå‘Šè­¦ã€‚</p><p>åœ¨ <code>receive</code> ä¸­ï¼Œæˆ‘ä»¬éœ€è¦åš 2 ç‚¹ä¿è¯ï¼šâ‘  å·²ç»æœ‰æ•°æ®äº†ï¼Œâ‘¡ æ•°æ®åªè¢«æ¶ˆè€—äº†ä¸€æ¬¡ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">receive</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> T &#123;</span><br><span class="line">    <span class="keyword">if</span> !<span class="keyword">self</span>.ready.<span class="title function_ invoke__">swap</span>(<span class="literal">false</span>, Ordering::Acquire) &#123;</span><br><span class="line">        <span class="built_in">panic!</span>(<span class="string">&quot;no message available!&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; (*<span class="keyword">self</span>.message.<span class="title function_ invoke__">get</span>()).<span class="title function_ invoke__">assume_init_read</span>() &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ <code>swap</code>ï¼Œå°† <code>ready</code> ä» <code>false</code> è½¬ä¸º <code>true</code>ï¼Œè¾¾åˆ°äº† 2 ä¸ªç›®çš„ï¼š</p><ol><li>å¦‚æœè¿”å›äº† <code>false</code>ï¼Œåˆ™è¯´æ˜ä¹‹å‰çš„ <code>ready</code> ä¸º <code>false</code>ï¼Œå³æ•°æ®æ²¡å‡†å¤‡å¥½ã€‚</li><li>å¦‚æœè¿”å›äº† <code>true</code>ï¼Œåˆ™è¯´æ˜æ•°æ®å·²ç»å‡†å¤‡å¥½äº†ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œä¹Ÿå·²ç»å°† <code>ready</code> ç½®ä¸º <code>false</code>ï¼Œè¿™æ ·åé¢è°ƒç”¨çš„ <code>receive</code> ä¹Ÿå°†å¤±è´¥ã€‚</li></ol><p>å¯¹äº <code>send</code>ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯åªå†™å…¥ä¸€æ¬¡ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦å¼•å…¥ä¸€ä¸ªæ–°çš„å˜é‡ <code>in_user</code>ï¼Œè¡¨ç¤º <code>send</code> æ˜¯å¦å·²ç»ä½¿ç”¨äº†ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Channel</span>&lt;T&gt; &#123;</span><br><span class="line">    message: UnsafeCell&lt;MaybeUninit&lt;T&gt;&gt;,</span><br><span class="line">    in_use: AtomicBool, <span class="comment">// æ–°å˜é‡ï¼Œè¡¨ç¤º send æ˜¯å¦å·²ç»ä½¿ç”¨äº†ã€‚</span></span><br><span class="line">    ready: AtomicBool,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Channel&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            message: UnsafeCell::<span class="title function_ invoke__">new</span>(MaybeUninit::<span class="title function_ invoke__">uninit</span>()),</span><br><span class="line">            in_use: AtomicBool::<span class="title function_ invoke__">new</span>(<span class="literal">false</span>),</span><br><span class="line">            ready: AtomicBool::<span class="title function_ invoke__">new</span>(<span class="literal">false</span>),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>send</code> ä¸­ï¼Œæˆ‘ä»¬ä¾æ—§ä½¿ç”¨ <code>swap</code>ï¼Œæ¥å°† <code>in_use</code> ä»è½¬ä¸º <code>true</code>ï¼Œå¦‚æœè¿”å› <code>true</code>ï¼Œåˆ™è¯´æ˜ä¹‹å‰å·²ç»æ‰§è¡Œè¿‡ <code>send</code> äº†ï¼Œè¿™ä¸ªæ—¶å€™å°†æ‰§è¡Œ panic è¿›è¡Œå‘Šè­¦ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Panics when trying to send more than one message.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">send</span>(&amp;<span class="keyword">self</span>, message: T) &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">self</span>.in_use.<span class="title function_ invoke__">swap</span>(<span class="literal">true</span>, Ordering::Relaxed) &#123;</span><br><span class="line">        <span class="built_in">panic!</span>(<span class="string">&quot;can&#x27;t send more than one message&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        (*<span class="keyword">self</span>.message.<span class="title function_ invoke__">get</span>()).<span class="title function_ invoke__">write</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">self</span>.ready.<span class="title function_ invoke__">store</span>(<span class="literal">true</span>, Ordering::Release);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šè¿°çš„ 2 ä¸ªä¼˜åŒ–ï¼Œæˆ‘ä»¬çš„ <code>Channel</code> åˆâ€œå®‰å…¨â€äº†ä¸€ä¸¢ä¸¢ï¼</p><h2 id="åŸºç¡€ç‰ˆ-v4ï¼šå®ç°-Drop-è‡ªåŠ¨æ¸…ç†æ— ç”¨å†…å­˜">åŸºç¡€ç‰ˆ v4ï¼šå®ç° Drop è‡ªåŠ¨æ¸…ç†æ— ç”¨å†…å­˜</h2><p>å› ä¸ºæˆ‘ä»¬ä½¿ç”¨äº† <code>MaybeUninit&lt;T&gt;</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è‡ªå·±ç®¡ç† <code>T</code> çš„å†…å­˜ç®¡ç†ï¼Œä½†åœ¨ä¸Šè¿°çš„å®ç°ä¸­ï¼Œå¯èƒ½å­˜åœ¨ä¸€ç§æƒ…å†µï¼Œå¯¼è‡´å†…å­˜å¾—ä¸åˆ°é‡Šæ”¾ï¼š<strong>æˆ‘ä»¬åªæ‰§è¡Œäº† <code>send</code>ï¼Œä½†ç›´åˆ° <code>Channel</code> è¶…è¿‡ä½œç”¨åŸŸçš„æ—¶å€™ï¼Œéƒ½æ²¡æœ‰è¢« <code>receive</code></strong>ã€‚</p><p>ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä¸º <code>Channel</code> å®ç° <code>Drop</code> traitï¼Œå½“æœ‰æ•°æ®çš„æ—¶å€™ï¼Œå¯¹<code>MaybeUninit&lt;T&gt;</code> è¿›è¡Œå†…å­˜é‡Šæ”¾ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Drop</span> <span class="keyword">for</span> <span class="title class_">Channel</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> *<span class="keyword">self</span>.ready.<span class="title function_ invoke__">get_mut</span>() &#123;</span><br><span class="line">            <span class="keyword">unsafe</span> &#123;</span><br><span class="line">                <span class="keyword">self</span>.message.<span class="title function_ invoke__">get_mut</span>().<span class="title function_ invoke__">assume_init_drop</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å®‰å…¨éé˜»å¡ç‰ˆ-v5ï¼šæä¾›å®‰å…¨æ–¹æ³•ï¼Œå‡å°‘ä½¿ç”¨è€…è¯¯ç”¨">å®‰å…¨éé˜»å¡ç‰ˆ v5ï¼šæä¾›å®‰å…¨æ–¹æ³•ï¼Œå‡å°‘ä½¿ç”¨è€…è¯¯ç”¨</h2><p>åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬æ¥è§£å†³å‰é¢å®ç°çš„æœ€å¤§é—®é¢˜ï¼š<strong>æ–¹æ³•æ˜¯ä¸å®‰å…¨çš„ï¼Œä¸¥é‡ä¾èµ–è°ƒç”¨è€…çš„è‡ªè§‰æ€§ï¼Œæ²¡æœ‰å……åˆ†å‘æŒ¥ Rust å¼ºå¤§ç¼–è¯‘å™¨çš„æ£€æŸ¥èƒ½åŠ›</strong>ã€‚</p><p>å›é¡¾æˆ‘ä»¬çš„éœ€æ±‚ï¼š<strong>æˆ‘ä»¬è¦å®ç°çš„æ˜¯ä¸€ä¸ª <code>oneshot channel</code>ï¼Œå³åªèƒ½è°ƒç”¨ä¸€æ¬¡ <code>send</code> å’Œ <code>receive</code></strong>ã€‚</p><p>ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯ï¼šå¦‚ä½•åˆ©ç”¨ Rust å¤©ç„¶çš„ç¼–è¯‘å™¨æ£€æŸ¥èƒ½åŠ›æ¥çº¦æŸè¿™ä¸€ç‚¹å‘¢ï¼Ÿå¾ˆæ˜æ˜¾ï¼Œå°±æ˜¯<strong>æ‰€æœ‰æƒæœºåˆ¶</strong>ï¼ä»€ä¹ˆä¸œè¥¿åªèƒ½æ‰§è¡Œä¸€æ¬¡å‘¢ï¼Ÿæ¶ˆè€—æ‰€æœ‰æƒçš„ä¸œè¥¿ï¼</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯¹äºç¬¬ä¸€ä¸ªå‚æ•°ä¸º self çš„æ–¹æ³•ï¼Œæ‰§è¡Œæ—¶ï¼Œä¼šè½¬ç§»æ‰€æœ‰æƒï¼Œæ‰§è¡Œåï¼ŒåŸå˜é‡å°±ä¸èƒ½å†ç”¨äº†ï¼Œå› ä¸ºæ‰€æœ‰æƒå·²ç»è½¬ç§»äº†ã€‚</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">do</span>(<span class="keyword">self</span>) &#123;&#125;</span><br></pre></td></tr></table></figure><p>å¥½ï¼Œé‚£ç¬¬äºŒä¸ªé—®é¢˜å°±æ¥äº†ï¼š<code>self</code> æ–¹æ³•åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œä½†å¾ˆæ˜æ˜¾æˆ‘ä»¬æ€»å…±éœ€è¦ 2 æ¬¡çš„è°ƒç”¨ï¼ˆ<code>send</code> å’Œ <code>receive</code>ï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¯ä»¥å°† <code>Channel</code> è¿›è¡Œæ‹†å¼€ï¼Œåˆ†æˆ <code>Sender</code> å’Œ <code>Receiver</code>ã€‚</p><p>é‚£ç¬¬ä¸‰ä¸ªé—®é¢˜ä¹Ÿå°±éšä¹‹è€Œæ¥äº†ï¼Œ<code>Sender</code> å’Œ <code>Receiver</code> éƒ½éœ€è¦æŒæœ‰ <code>Channel</code>ï¼Œå¹¶ä¸”å¯èƒ½å¤„äºä¸åŒçš„çº¿ç¨‹ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥å…ˆç”¨ <code>Arc</code> æ¥å¯¹ <code>Channel</code> è¿›è¡Œå¼•ç”¨ã€‚</p><p>è§£å†³äº†ä¸Šè¿° 3 ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥æ¢³ç†æ–°çš„æ•°æ®ç»“æ„ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Sender</span>&lt;T&gt; &#123;</span><br><span class="line">    channel: Arc&lt;Channel&lt;T&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Receiver</span>&lt;T&gt; &#123;</span><br><span class="line">    channel: Arc&lt;Channel&lt;T&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Channel</span>&lt;T&gt; &#123;</span><br><span class="line">    message: UnsafeCell&lt;MaybeUninit&lt;T&gt;&gt;,</span><br><span class="line">    ready: AtomicBool,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">channel</span>&lt;T&gt;() <span class="punctuation">-&gt;</span> (Sender&lt;T&gt;, Receiver&lt;T&gt;) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span> = Arc::<span class="title function_ invoke__">new</span>(Channel &#123;</span><br><span class="line">        message: UnsafeCell::<span class="title function_ invoke__">new</span>(MaybeUninit::<span class="title function_ invoke__">uninit</span>()),</span><br><span class="line">        ready: AtomicBool::<span class="title function_ invoke__">new</span>(<span class="literal">false</span>),</span><br><span class="line">    &#125;);</span><br><span class="line">    (Sender &#123; channel: a.<span class="title function_ invoke__">clone</span>() &#125;, Receiver &#123; channel: a &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li><code>Channel</code> ä¸­ç§»é™¤äº† <code>in_use</code> å±æ€§ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»æœ‰ <code>self</code> åšæ‰€æœ‰æƒæ£€æŸ¥äº†ï¼Œä¸å†éœ€è¦ <code>in_use</code> æ¥é¿å…é‡å¤è°ƒç”¨ <code>send</code> äº†ã€‚</li><li>æ–°å¢äº† <code>Sender&lt;T&gt;</code> å’Œ <code>Receiver&lt;T&gt;</code> ä¸¤ä¸ªç»“æ„ï¼Œå®ƒä»¬éƒ½å„è‡ªæŒæœ‰äº†ä¸€ä¸ª <code>Arc&lt;Channel&gt;</code>ã€‚</li></ol><p>å¯¹åº”çš„ <code>send</code> å’Œ <code>receive</code> æ–¹æ³•å½“ç„¶ä¹Ÿå°±è½¬ç§»åˆ° <code>Sender&lt;T&gt;</code> å’Œ <code>Receiver&lt;T&gt;</code> èº«ä¸Šäº†ï¼Œå®ç°ä¹Ÿå’Œä¹‹å‰åŸºæœ¬ä¸€è‡´ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; Sender&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">send</span>(<span class="keyword">self</span>, messgae: T) &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; (*<span class="keyword">self</span>.channel.message.<span class="title function_ invoke__">get</span>()).<span class="title function_ invoke__">write</span>(messgae) &#125;;</span><br><span class="line">        <span class="keyword">self</span>.channel.ready.<span class="title function_ invoke__">store</span>(<span class="literal">true</span>, Ordering::Release);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Receiver&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">is_ready</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.channel.ready.<span class="title function_ invoke__">load</span>(Ordering::Relaxed)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Safety: only after is_ready() returns true!</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">receive</span>(<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> T &#123;</span><br><span class="line">        <span class="keyword">if</span> !<span class="keyword">self</span>.channel.ready.<span class="title function_ invoke__">swap</span>(<span class="literal">false</span>, Ordering::Acquire) &#123;</span><br><span class="line">            <span class="built_in">panic!</span>(<span class="string">&quot;no message available!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; (*<span class="keyword">self</span>.channel.message.<span class="title function_ invoke__">get</span>()).<span class="title function_ invoke__">assume_init_read</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Drop æ²¡å˜</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹äº†ç»“æ„äº†ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹å¯¹åº”çš„æµ‹è¯•ä»£ç ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">one_thread_should_work</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> (sender, receiver) = <span class="title function_ invoke__">channel</span>();</span><br><span class="line">    sender.<span class="title function_ invoke__">send</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> receiver.<span class="title function_ invoke__">is_ready</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">msg</span> = receiver.<span class="title function_ invoke__">receive</span>();</span><br><span class="line">        <span class="built_in">assert_eq!</span>(msg, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">cross_thread_should_work</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> (sender, receiver) = <span class="title function_ invoke__">channel</span>();</span><br><span class="line">    thread::<span class="title function_ invoke__">scope</span>(|s| &#123;</span><br><span class="line">        s.<span class="title function_ invoke__">spawn</span>(|| &#123;</span><br><span class="line">            <span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">10</span>));</span><br><span class="line">            sender.<span class="title function_ invoke__">send</span>(<span class="number">1</span>); <span class="comment">// æ²¡æœ‰ unsafe äº†ï¼</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> receiver.<span class="title function_ invoke__">is_ready</span>() &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">res</span> = receiver.<span class="title function_ invoke__">receive</span>(); <span class="comment">// æ²¡æœ‰ unsafe äº†ï¼</span></span><br><span class="line">                <span class="built_in">assert_eq!</span>(res, <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æœ€æ–°çš„æµ‹è¯•ä»£ç ä¸­ï¼Œæˆ‘ä»¬å·²ç»ä¸å†éœ€è¦ <code>unsafe</code> ä»£ç äº†ï¼è¿™å¯¹äºä½¿ç”¨è€…æ¥è¯´ï¼Œå°±éå¸¸å‹å¥½äº†ï¼</p><p>è€Œä¸”è¿™ä¸ªæ—¶å€™ï¼Œä½ å¦‚æœå°è¯•æ‰§è¡Œå¤šæ¬¡ <code>send</code> å’Œ <code>receive</code> çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨å°±ä¼šæŠ¥é”™äº†ï¼</p><p>ä¸è¿‡å®ƒè¿˜æ˜¯æœ‰ 2 ä¸ªç¼ºç‚¹ï¼š</p><ol><li><code>Arc</code> çš„å¤åˆ¶è¿˜æ˜¯æœ‰ä¸€äº›å¼€é”€çš„ã€‚</li><li>æˆ‘ä»¬ä¾æ—§ä¾èµ–ä½¿ç”¨è€…æå‰ç”¨ <code>is_ready</code> æ¥æ£€æŸ¥ï¼Œå¦åˆ™ç›´æ¥è°ƒç”¨ <code>receive</code> å°±æœ‰å¯èƒ½ä¼š <code>panic</code>ã€‚</li></ol><p>æˆ‘ä»¬å…ˆæ¥è§£å†³ç¬¬ 1 ä¸ªé—®é¢˜ã€‚</p><h2 id="å®‰å…¨éé˜»å¡ç‰ˆ-v6ï¼šä½¿ç”¨ç”Ÿå‘½å‘¨æœŸåŠ å¼•ç”¨ï¼Œé¿å…-Arc-çš„å¤åˆ¶å¼€é”€">å®‰å…¨éé˜»å¡ç‰ˆ v6ï¼šä½¿ç”¨ç”Ÿå‘½å‘¨æœŸåŠ å¼•ç”¨ï¼Œé¿å… Arc çš„å¤åˆ¶å¼€é”€</h2><p>ä¸ºäº†é¿å… Arc çš„å¼€é”€ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ <code>Sender&lt;T&gt;</code> å’Œ <code>Receiver&lt;T&gt;</code> ä¸­æŒæœ‰ <code>Channel&lt;T&gt;</code> çš„å¼•ç”¨ï¼Œè€Œå¼•ç”¨çš„å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸ç¡®å®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åŠ å…¥ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨ï¼Œæ¥å‘Šè¯‰ç¼–è¯‘å™¨æˆ‘ä»¬çš„å¼•ç”¨æ˜¯é€»è¾‘è‡ªæ´½çš„ã€‚</p><p>æ–°çš„ç»“æ„å’Œæ„é€ å‡½æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Sender</span>&lt;<span class="symbol">&#x27;a</span>, T&gt; &#123;</span><br><span class="line">    channel: &amp;<span class="symbol">&#x27;a</span> Channel&lt;T&gt;, <span class="comment">// ä½¿ç”¨å¼•ç”¨æ›¿ä»£ Arcï¼Œå¹¶åŠ å…¥ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Receiver</span>&lt;<span class="symbol">&#x27;a</span>, T&gt; &#123;</span><br><span class="line">    channel: &amp;<span class="symbol">&#x27;a</span> Channel&lt;T&gt;, <span class="comment">// ä½¿ç”¨å¼•ç”¨æ›¿ä»£ Arcï¼Œå¹¶åŠ å…¥ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Channel</span>&lt;T&gt; &#123;</span><br><span class="line">    message: UnsafeCell&lt;MaybeUninit&lt;T&gt;&gt;,</span><br><span class="line">    ready: AtomicBool,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Channel&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            message: UnsafeCell::<span class="title function_ invoke__">new</span>(MaybeUninit::<span class="title function_ invoke__">uninit</span>()),</span><br><span class="line">            ready: AtomicBool::<span class="title function_ invoke__">new</span>(<span class="literal">false</span>),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">split</span>&lt;<span class="symbol">&#x27;a</span>&gt;(&amp;<span class="symbol">&#x27;a</span> <span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> (Sender&lt;<span class="symbol">&#x27;a</span>, T&gt;, Receiver&lt;<span class="symbol">&#x27;a</span>, T&gt;) &#123;</span><br><span class="line">        *<span class="keyword">self</span> = <span class="keyword">Self</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">        (Sender &#123; channel: <span class="keyword">self</span> &#125;, Receiver &#123; channel: <span class="keyword">self</span> &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Drop æ²¡å˜</span></span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªç‰ˆæœ¬çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬æ–°å¢äº† <code>split</code> æ–¹æ³•ï¼š</p><ol><li>å…¶ä¸­å‚æ•° <code>&amp;'a mut self</code> è¡¨æ˜å®ƒæ˜¯ä¸€ä¸ªç‹¬å å¼•ç”¨ï¼Œå³ <code>channel.split()</code> ä¸ä¼šæœ‰å¹¶å‘é—®é¢˜ã€‚</li><li>ç¬¬ä¸€è¡Œä»£ç  <code>*self = Self::new()</code> æˆ‘ä»¬å¯¹åŸæœ‰çš„ <code>Channel</code> è¿›è¡Œé‡ç½®ï¼Œä¿è¯<strong>æ‹†åˆ†ä¹‹å‰é€šé“é‡Œç»å¯¹æ²¡æœ‰æ®‹ç•™æ•°æ®</strong>ï¼Œé¿å…æ—§æ¶ˆæ¯è¢«ä¸‹ä¸€å¯¹ <code>Sender/Receiver</code> è¯¯ä½¿ç”¨ã€‚</li><li><code>'a</code> ç›´æ¥æ¥è‡ªäº <code>&amp;'a mut self</code>ï¼Œä¿è¯ä¸¤ç«¯æŠŠæ‰‹<strong>ç»ä¸ä¼šæ¯”åŸå§‹ <code>Channel</code> æ´»å¾—æ›´ä¹…</strong>ã€‚</li></ol><p>æ–°çš„æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">one_thread_should_work</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">channel</span> = Channel::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="keyword">let</span> (sender, receiver) = channel.<span class="title function_ invoke__">split</span>();</span><br><span class="line">    sender.<span class="title function_ invoke__">send</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> receiver.<span class="title function_ invoke__">is_ready</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">msg</span> = receiver.<span class="title function_ invoke__">receive</span>();</span><br><span class="line">        <span class="built_in">assert_eq!</span>(msg, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">cross_thread_should_work</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">channel</span> = Channel::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="keyword">let</span> (sender, receiver) = channel.<span class="title function_ invoke__">split</span>();</span><br><span class="line">    thread::<span class="title function_ invoke__">scope</span>(|s| &#123;</span><br><span class="line">        s.<span class="title function_ invoke__">spawn</span>(|| &#123;</span><br><span class="line">            <span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">100</span>));</span><br><span class="line">            sender.<span class="title function_ invoke__">send</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> !receiver.<span class="title function_ invoke__">is_ready</span>() &#123;&#125;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(receiver.<span class="title function_ invoke__">receive</span>(), <span class="number">1</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å®‰å…¨é˜»å¡ç‰ˆ-v7ï¼šå»æ‰-is-ready-å®Œå…¨é¿å…ä½¿ç”¨è€…è¯¯è°ƒç”¨">å®‰å…¨é˜»å¡ç‰ˆ v7ï¼šå»æ‰ is_ready å®Œå…¨é¿å…ä½¿ç”¨è€…è¯¯è°ƒç”¨</h2><p>æˆªæ­¢ç›®å‰çš„å®ç°ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä¾èµ–ä½¿ç”¨è€…åœ¨æ‰§è¡Œ <code>receive</code> ä¹‹å‰å…ˆæ‰§è¡Œ <code>is_ready</code> è¿›è¡Œæ•°æ®æ£€æŸ¥ï¼Œè¿˜æ˜¯å­˜åœ¨ä¸€å®šçš„è¯¯æ“ä½œæ€§ã€‚ç°åœ¨æˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªå®Œå…¨é˜»å¡çš„ç‰ˆæœ¬ï¼Œæ¥å®Œå…¨é¿å…è¿™ä¸ªæƒ…å†µã€‚</p><p>æˆ‘ä»¬éœ€è¦åšå‡ ä»¶äº‹æƒ…ï¼š</p><ol><li>å»æ‰ <code>is_ready</code> æ–¹æ³•ï¼›</li><li>åœ¨ <code>receive</code> ä¸­ï¼Œæ ¹æ® <code>ready</code> åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ•°æ®ï¼š<ol><li>å¦‚æœå­˜åœ¨ï¼Œåˆ™ç›´æ¥å–å‡ºæ•°æ®å¹¶è¿”å›ï¼›</li><li>å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™éœ€è¦å…ˆæŒ‚èµ·å½“å‰çº¿ç¨‹ï¼Œç­‰å¾…å”¤é†’ï¼ˆç›´æ¥ CPU å¾ªç¯æ£€æŸ¥è‚¯å®šå¯ä»¥ï¼Œä½†ä¸å¤Ÿä¼˜é›…ï¼å’±ä¸å¹²ï¼ï¼‰ï¼›</li></ol></li><li>åœ¨ <code>send</code> ä¸­ï¼Œæ”¾å…¥æ•°æ®åï¼Œå°è¯•å”¤é†’å¯èƒ½å¤„äºæŒ‚èµ·ä¸­çš„çº¿ç¨‹ã€‚</li></ol><p>é‚£ç°åœ¨æœ€é‡è¦çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼š**å¦‚ä½•å”¤é†’å¤„äºæŒ‚èµ·ä¸­çš„çº¿ç¨‹ï¼Ÿ**æ›´è¿›ä¸€æ­¥ï¼Œ<strong>å”¤é†’å“ªä¸ªçº¿ç¨‹ï¼Ÿ</strong></p><p>è¿™é‡Œå…¶å®æ˜¯è¯´ä¸å®šçš„ï¼Œå› ä¸º <code>Sender</code> å’Œ <code>Receiver</code> éƒ½å¯èƒ½è¢«æ”¾å…¥ä»»ä½•ä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œä¸è¿‡åœ¨ <a href="https://marabos.nl/atomics/building-channels.html">Rust Atomics and Locks</a> ä¹¦ä¸­ï¼Œä½œè€…å‡å®šäº† <code>Receiver</code> ä¼šå›ºå®šåœ¨è°ƒç”¨ <code>split</code> çš„é‚£ä¸ªçº¿ç¨‹ã€‚</p><p>ç¬”è€…è®¤ä¸ºè¿™ä¸ªå‡è®¾æ˜¯ç®€å•ä¸”æœ‰æ•ˆçš„ï¼Œå›é¡¾ä¸€ä¸‹æˆ‘ä»¬å‰é¢ä¸¾çš„ Go è¯­è¨€çš„ 2 ä¸ªä¾‹å­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">demo1</span><span class="params">()</span></span> &#123;</span><br><span class="line">done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;) <span class="comment">// ç±»ä¼¼äº split</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// ... do something</span></span><br><span class="line"><span class="built_in">close</span>(done)</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">&lt;-done  <span class="comment">// receiver</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">demo2</span><span class="params">()</span></span> &#123;</span><br><span class="line">oneShot := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>, <span class="number">1</span>)  <span class="comment">// ç±»ä¼¼äº split</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">oneShot &lt;- generateText()</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">text := &lt;-oneShot  <span class="comment">// receiver</span></span><br><span class="line">doSthWithText(text)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸¤ä¸ªæœ€å¸¸è§çš„ <code>oneshot channel</code> çš„ä¾‹å­ä¸­ï¼Œ<code>Receiver</code> å°±æ˜¯å¤„äºè°ƒç”¨ <code>split</code> çš„çº¿ç¨‹ä¸­ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åŸºäºè¿™ä¸ªå‡è®¾æ¥å®ç°è¿™ä¸ªç‰ˆæœ¬ã€‚</p><p>å…ˆå›é¡¾ä¸‹ <code>Thread</code> 2 ä¸ªæœ€æ ¸å¿ƒçš„æ–¹æ³•ï¼š</p><ul><li><code> Thread.park(thread)</code>: æŒ‚èµ·çº¿ç¨‹ï¼Œç­‰å¾…å”¤é†’ã€‚</li><li><code>thread.unpark()</code>: å”¤é†’çº¿ç¨‹ã€‚</li></ul><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦åœ¨ <code>Sender</code> ä¸­ä¿å­˜å¾…å”¤é†’çš„çº¿ç¨‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Sender</span>&lt;<span class="symbol">&#x27;a</span>, T&gt; &#123;</span><br><span class="line">    channel: &amp;<span class="symbol">&#x27;a</span> Channel&lt;T&gt;,</span><br><span class="line">    receiving_thread: Thread,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>split()</code> çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦è·å–å½“å‰çº¿ç¨‹å¹¶ä¿å­˜åœ¨ <code>Sender</code> ä¸­ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">split</span>&lt;<span class="symbol">&#x27;a</span>&gt;(&amp;<span class="symbol">&#x27;a</span> <span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> (Sender&lt;<span class="symbol">&#x27;a</span>, T&gt;, Receiver&lt;<span class="symbol">&#x27;a</span>, T&gt;) &#123;</span><br><span class="line">    *<span class="keyword">self</span> = <span class="keyword">Self</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    (</span><br><span class="line">        Sender &#123;</span><br><span class="line">            channel: <span class="keyword">self</span>,</span><br><span class="line">          <span class="comment">// è·å–å½“å‰çº¿ç¨‹ã€‚è®°ä½ï¼è¿™é‡Œæˆ‘ä»¬å‡è®¾äº† receiver ä¼šå›ºå®šåœ¨ split çš„çº¿ç¨‹ä¸­ï¼</span></span><br><span class="line">            receiving_thread: thread::<span class="title function_ invoke__">current</span>(),</span><br><span class="line">        &#125;,</span><br><span class="line">        Receiver &#123; channel: <span class="keyword">self</span> &#125;,</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>recevie</code> çš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŒ‚èµ·å½“å‰çº¿ç¨‹ï¼Œç­‰å¾…å”¤é†’ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; Receiver&lt;<span class="symbol">&#x27;_</span>, T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">receive</span>(<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> T &#123;</span><br><span class="line">        <span class="keyword">while</span> !<span class="keyword">self</span>.channel.ready.<span class="title function_ invoke__">swap</span>(<span class="literal">false</span>, Ordering::Acquire) &#123;</span><br><span class="line">            thread::<span class="title function_ invoke__">park</span>(); <span class="comment">// æŒ‚èµ·å½“å‰çº¿ç¨‹ï¼Œå³ thread::current() çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; (*<span class="keyword">self</span>.channel.message.<span class="title function_ invoke__">get</span>()).<span class="title function_ invoke__">assume_init_read</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>send</code> å®Œæ•°æ®åï¼Œå”¤é†’å¯èƒ½æŒ‚èµ·çš„çº¿ç¨‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; Sender&lt;<span class="symbol">&#x27;_</span>, T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">send</span>(<span class="keyword">self</span>, messgae: T) &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; (*<span class="keyword">self</span>.channel.message.<span class="title function_ invoke__">get</span>()).<span class="title function_ invoke__">write</span>(messgae) &#125;;</span><br><span class="line">        <span class="keyword">self</span>.channel.ready.<span class="title function_ invoke__">store</span>(<span class="literal">true</span>, Ordering::Release);</span><br><span class="line">        Thread::<span class="title function_ invoke__">unpark</span>(&amp;<span class="keyword">self</span>.receiving_thread); <span class="comment">// å”¤é†’ receiver çº¿ç¨‹</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ååˆ é™¤ä¹‹å‰çš„ <code>is_ready</code> æ–¹æ³•ï¼Œç„¶åæ›´æ–°æˆ‘ä»¬çš„æµ‹è¯•ä»£ç ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">one_thread_should_work</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">channel</span> = Channel::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="keyword">let</span> (sender, receiver) = channel.<span class="title function_ invoke__">split</span>();</span><br><span class="line">    sender.<span class="title function_ invoke__">send</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">msg</span> = receiver.<span class="title function_ invoke__">receive</span>();</span><br><span class="line">    <span class="built_in">assert_eq!</span>(msg, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">cross_thread_should_work</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">channel</span> = Channel::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="keyword">let</span> (sender, receiver) = channel.<span class="title function_ invoke__">split</span>();</span><br><span class="line">    thread::<span class="title function_ invoke__">scope</span>(|s| &#123;</span><br><span class="line">        s.<span class="title function_ invoke__">spawn</span>(|| &#123;</span><br><span class="line">            <span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">100</span>));</span><br><span class="line">            sender.<span class="title function_ invoke__">send</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(receiver.<span class="title function_ invoke__">receive</span>(), <span class="number">1</span>); <span class="comment">// ä¸å†éœ€è¦æ£€æŸ¥ is_readyï¼Œè¿™é‡Œä¼šé˜»å¡ä¸€ç›´ç›´åˆ°æœ‰æ•°æ®åˆ°æ¥</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æœ€ç»ˆç‰ˆ-v8ï¼šä½¿ç”¨-PhantomData-æ¥ä¿è¯-Receiver-å¤„äº-split-çº¿ç¨‹">æœ€ç»ˆç‰ˆ v8ï¼šä½¿ç”¨ PhantomData æ¥ä¿è¯ Receiver å¤„äº split() çº¿ç¨‹</h2><p>æ˜¯ä¸æ˜¯è§‰å¾—ï¼Œä¸Šè¿°å®ç°å·²ç»å®Œç¾æ— ç‘•äº†ï¼å…¶å®ä¸ç„¶ï¼Œæˆ‘ä»¬è™½ç„¶å‡è®¾äº† <code>Receiver</code> å¤„äºè°ƒç”¨ <code>split()</code> çš„çº¿ç¨‹ä¸­ï¼Œä½†æ˜¯è¿˜æ˜¯æ— æ³•é˜»æ­¢ä½¿ç”¨è€…å°† <code>Receiver</code> è½¬ç§»åˆ°å…¶ä»–çº¿ç¨‹ã€‚</p><p>å†æ¬¡å›é¡¾ä¸‹æˆ‘ä»¬ç°åœ¨çš„ <code>Channel</code> å’Œ <code>Receiver</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Receiver</span>&lt;<span class="symbol">&#x27;a</span>, T&gt; &#123;</span><br><span class="line">    channel: &amp;<span class="symbol">&#x27;a</span> Channel&lt;T&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Channel</span>&lt;T&gt; &#123;</span><br><span class="line">    message: UnsafeCell&lt;MaybeUninit&lt;T&gt;&gt;,</span><br><span class="line">    ready: AtomicBool,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Sync</span> <span class="keyword">for</span> <span class="title class_">Channel</span>&lt;T&gt; <span class="keyword">where</span> T: <span class="built_in">Send</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸º <code>Channel&lt;T&gt;</code> å®ç°äº† <code>Sync</code> traitï¼Œè€Œæ ‡å‡†åº“ä¸­æœ‰è¿™ 2 è¡Œä»£ç ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T: ?<span class="built_in">Sized</span> + <span class="built_in">Sync</span>&gt; <span class="built_in">Sync</span> <span class="keyword">for</span> &amp;T &#123;&#125;</span><br><span class="line"><span class="keyword">impl</span>&lt;T: ?<span class="built_in">Sized</span> + <span class="built_in">Sync</span>&gt; <span class="built_in">Send</span> <span class="keyword">for</span> &amp;T &#123;&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ <code>&amp;Channel&lt;T&gt;</code> å®ç°äº† <code>Sync/Send</code> traitï¼Œè€Œ <code>Receiver</code> åªæŒæœ‰äº†ä¸€ä¸ª <code>&amp;'a Channel&lt;T&gt;</code>ï¼Œæ‰€ä»¥å®ƒä¹Ÿæ˜¯ <code>Send</code> çš„ï¼</p><p>æ‰€ä»¥ <code>Receiver</code> æ˜¯å¯ä»¥è¢«è½¬ç§»åˆ°å…¶ä»–çº¿ç¨‹çš„ï¼Œå³ä¸‹è¿°çš„æµ‹è¯•ä»£ç åœ¨ç¼–è¯‘ä¸Šä¹Ÿæ˜¯é€šè¿‡çš„ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">cross_thread_should_work</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">channel</span> = Channel::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="keyword">let</span> (sender, receiver) = channel.<span class="title function_ invoke__">split</span>(); <span class="comment">// æ‰§è¡Œ split() çš„çº¿ç¨‹</span></span><br><span class="line">    thread::<span class="title function_ invoke__">scope</span>(|s| &#123;</span><br><span class="line">        s.<span class="title function_ invoke__">spawn</span>(|| &#123;</span><br><span class="line">            <span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">100</span>));</span><br><span class="line">            sender.<span class="title function_ invoke__">send</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// è¿™é‡Œåœ¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œæ‰§è¡Œäº† `receiver.receive()`</span></span><br><span class="line">        s.<span class="title function_ invoke__">spawn</span>(|| &#123;</span><br><span class="line">            <span class="built_in">assert_eq!</span>(receiver.<span class="title function_ invoke__">receive</span>(), <span class="number">1</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯æˆ‘ä»¬æ‰§è¡Œåä¼šå‘ç°ï¼Œ<code>receiver.receive()</code> ä¼šè¢«æ°¸ä¹…é˜»å¡ä½ï¼Œè¿™æ˜¯å› ä¸º <code>sender.send(1)</code> åªä¼šå”¤é†’æ‰§è¡Œ <code>split()</code> çš„çº¿ç¨‹ã€‚</p><p>ä¸ºäº†é¿å…è¿™ç§æƒ…å†µçš„å‘ç”Ÿï¼Œæˆ‘ä»¬éœ€è¦å¼ºè¡Œé˜²æ­¢ <code>Receiver</code> å®ç° <code>Send</code> traitï¼</p><p>æ€ä¹ˆåŠå‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦åšåˆ° 2 ä»¶äº‹æƒ…ï¼š</p><ol><li>è®© <code>Receiver</code> æŒæœ‰ä¸€ä¸ªé <code>Sync</code> çš„å±æ€§ï¼›</li><li>è¿™ä¸ªå±æ€§é™¤äº†æ ‡è®°æ²¡æœ‰å…¶ä»–ä½œç”¨ï¼Œæœ€å¥½ä¸è¦å ç”¨ä»»ä½•çš„èµ„æºã€‚</li></ol><p>è¿™é‡Œæˆ‘ä»¬ä»‹ç»ä¸€ä½æ–°æœ‹å‹ï¼š<code>PhantomData</code>ï¼š</p><blockquote><p><code>PhantomData</code> æ˜¯ä¸€ä¸ªé›¶å¤§å°ç±»å‹ï¼ˆZero-Sized Type, ZSTï¼‰ï¼Œç”¨äºåœ¨ç¼–è¯‘æœŸå‘ç±»å‹ç³»ç»Ÿä¼ é€’é¢å¤–ä¿¡æ¯ï¼Œè€Œä¸å ç”¨è¿è¡Œæ—¶å†…å­˜ã€‚</p><p>æˆ‘ä»¬å¯ä»¥ç”¨å®ƒåœ¨åŒ…ä¸€ä¸ª <code>!Send</code> çš„ç±»å‹ï¼Œè¿™æ · <code>Receiver</code> å°±æ˜¯ <code>!Send</code> çš„äº†ã€‚å…³äº <code>PhantomData</code> çš„æ›´å¤šä»‹ç»ï¼Œå¯ä»¥å‚è€ƒ<u>é™„å½• 2ï¼šPhantomData</u>ã€‚</p></blockquote><p>åœ¨ä»‹ç»å®Œ <code>PhantomData</code> åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨å®ƒæ¥é˜²æ­¢ <code>Receiver</code> å®ç° <code>Send</code> trait äº†ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Receiver</span>&lt;<span class="symbol">&#x27;a</span>, T&gt; &#123;</span><br><span class="line">    channel: &amp;<span class="symbol">&#x27;a</span> Channel&lt;T&gt;,</span><br><span class="line">    _no_send: PhantomData&lt;*<span class="title function_ invoke__">const</span> ()&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>*const()</code> æ˜¯ <code>!Send</code> çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ <code>Receiver</code> å†ä¹Ÿä¸ä¼šè¢«è½¬ç§»åˆ°å…¶ä»–çº¿ç¨‹äº†ï¼Œè€Œ <code>send</code> æ˜¯è¦æ±‚ <code>self</code>ï¼Œæ‰€ä»¥å³ä¾¿æ˜¯ <code>Sync</code> çš„ä¹Ÿæ— æ‰€è°“äº†ï¼Œå› ä¸ºæ— æ³•é€šè¿‡å¼•ç”¨æ¥æ‰§è¡Œ <code>receive()</code> æ–¹æ³•ã€‚</p><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å†æ¬¡æ‰§è¡Œä¸Šé¢çš„æµ‹è¯•ä»£ç ï¼ˆå¼ºè¡Œå°† Receiver ç§»åŠ¨åˆ°å…¶ä»–çº¿ç¨‹ä¸­ï¼‰ï¼Œå°†ä¼šå¾—åˆ°ä»¥ä¸‹çš„æŠ¥é”™ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">error[E0277]: `*const ()` cannot be sent between threads safely</span><br><span class="line"><span class="meta prompt_">   --&gt; </span><span class="language-bash">src/oneshotchannel.rs:103:21</span></span><br><span class="line">    |</span><br><span class="line">103 |               s.spawn(|| &#123;</span><br><span class="line">    |                 ----- ^-</span><br><span class="line">    |                 |     |</span><br><span class="line">    |  _______________|_____within this `&#123;closure@oneshotchannel.rs:103:21&#125;`</span><br><span class="line">    | |               |</span><br><span class="line">    | |               required by a bound introduced by this call</span><br><span class="line">104 | |                 assert_eq!(receiver.receive(), 1);</span><br><span class="line">105 | |             &#125;);</span><br><span class="line">    | |_____________^ `*const ()` cannot be sent between threads safely</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œï¼Œé€šè¿‡ 8 ä¸ªç‰ˆæœ¬ï¼Œæˆ‘ä»¬ä¸€æ­¥æ­¥å®ç°äº†ä¸€ä¸ªé«˜æ€§èƒ½ã€ä½å†…å­˜å ç”¨ä¸”å®‰å…¨å¯ç”¨çš„ <code>oneshot channel</code> äº†ï¼</p><h2 id="æ€»ç»“">æ€»ç»“</h2><p>è‡³æ­¤ï¼Œé€šè¿‡ 8 ä¸ªå°ç‰ˆæœ¬ï¼Œæˆ‘ä»¬ä¸ä»…æ‰‹å†™äº†ä¸€ä¸ª <strong>é«˜æ€§èƒ½ã€å®‰å…¨å‹å¥½çš„ oneshot channel</strong>ï¼Œè¿˜æ›´è¿›ä¸€æ­¥ä½“éªŒäº† Rust åœ¨å¹¶å‘é¢†åŸŸ <strong>â€œä»¥ç±»å‹ç³»ç»Ÿé©±åŠ¨æ­£ç¡®æ€§â€</strong> çš„å¨åŠ›ã€‚æˆ‘ä»¬æ¥åšä¸€ä¸ªç®€å•çš„å°ç»“ã€‚</p><p>å…³é”®æ”¶è·ï¼š</p><table><thead><tr><th>ç‰ˆæœ¬</th><th>æ–°å¢èƒ½åŠ›</th><th>è§£å†³äº†ä»€ä¹ˆé—®é¢˜</th></tr></thead><tbody><tr><td><strong>v0</strong></td><td><code>Mutex</code> + <code>Condvar</code> é€šç”¨é€šé“</td><td>æ‰“å¼€è¯é¢˜ã€å¯¹æ¯”åç»­æ— é”æ–¹æ¡ˆ</td></tr><tr><td><strong>v1</strong></td><td><code>UnsafeCell&lt;Option&lt;T&gt;&gt;</code> + <code>AtomicBool</code></td><td>å»é”åŒ–ã€æœ€å°å¯è¡Œä¸€æ¬¡æ€§é€šé“</td></tr><tr><td><strong>v2</strong></td><td>æ›¿æ¢ä¸º <code>MaybeUninit&lt;T&gt;</code></td><td>èŠ‚çœå†…å­˜&amp;é¿å…åŒçŠ¶æ€æ£€æŸ¥</td></tr><tr><td><strong>v3</strong></td><td>è¿è¡Œæ—¶æ£€æŸ¥ (<code>swap</code>)</td><td>é˜»æ­¢æœªå‡†å¤‡/äºŒæ¬¡è°ƒç”¨å¯¼è‡´ UB</td></tr><tr><td><strong>v4</strong></td><td><code>Drop</code> æ¸…ç†</td><td>é˜²æ­¢â€œåª send ä¸ recvâ€æ³„æ¼</td></tr><tr><td><strong>v5</strong></td><td><code>Sender</code> / <code>Receiver</code> æ‰€æœ‰æƒ API</td><td>ç¼–è¯‘æœŸä¿è¯â€œä»…è°ƒç”¨ä¸€æ¬¡â€</td></tr><tr><td><strong>v6</strong></td><td>ç”Ÿå‘½å‘¨æœŸå¼•ç”¨æ›¿æ¢ <code>Arc</code></td><td>æ¶ˆé™¤å¼•ç”¨è®¡æ•°å¼€é”€</td></tr><tr><td><strong>v7</strong></td><td><code>park / unpark</code> é˜»å¡æ¨¡å‹</td><td>ä½¿ç”¨è€…ä¸å†éœ€è¦è½®è¯¢ <code>is_ready</code></td></tr><tr><td><strong>v8</strong></td><td><code>PhantomData</code> é˜²è·¨çº¿ç¨‹è¯¯ç”¨</td><td>ç±»å‹ç³»ç»Ÿå½»åº•å°æ­»é”™è¯¯ç”¨æ³•</td></tr></tbody></table><p>æ ¸å¿ƒè®°å¿†ç‚¹ï¼š</p><ul><li><strong>å†…éƒ¨å¯å˜æ€§</strong>ï¼š<code>UnsafeCell</code> æ˜¯æ‰€æœ‰å¹¶å‘åŸè¯­çš„åŸºçŸ³ã€‚</li><li><strong>å»¶è¿Ÿåˆå§‹åŒ–</strong>ï¼š<code>MaybeUninit&lt;T&gt;</code> + â€œå°±ç»ªæ ‡å¿—â€ æ˜¯é›¶æˆæœ¬ç»„åˆã€‚</li><li><strong>Release / Acquire</strong>ï¼šæœ€è½»é‡çš„è·¨çº¿ç¨‹å¯è§æ€§ä¿éšœã€‚</li><li><strong>æ‰€æœ‰æƒè®¾è®¡ API</strong>ï¼šè®©ç¼–è¯‘å™¨æ›¿ä½ å…œåº•é€»è¾‘çº¦æŸã€‚</li><li><strong>PhantomData</strong>ï¼šé›¶å¤§å°ä½†èƒ½å½±å“ <code>Send/Sync</code> çš„ç±»å‹çº§æ ‡è®°ã€‚</li><li><strong>è¿­ä»£æ€è·¯</strong>ï¼šå…ˆè·‘é€šï¼Œå†æ”¶å£å®‰å…¨æ€§ä¸æ€§èƒ½ï¼Œæœ€åç”¨ç±»å‹ç³»ç»Ÿâ€œé˜²å‘†â€ã€‚</li></ul><p>å®Œæ•´çš„ä»£ç å¯ä»¥å‚è€ƒï¼š<a href="https://github.com/hedon-rust-road/conutils/blob/main/src/oneshot.rs">conutils-oneshot</a>ã€‚</p><h2 id="oneshot-crate-æµ…æ¢">oneshot crate æµ…æ¢</h2><h2 id="é™„å½•">é™„å½•</h2><h3 id="1-Option-T-çš„å†…å­˜å ç”¨æ˜¯å¤šå°‘ï¼Ÿ">1. Option&lt;T&gt; çš„å†…å­˜å ç”¨æ˜¯å¤šå°‘ï¼Ÿ</h3><p>åœ¨ Rust ä¸­ï¼Œ<code>Option&lt;T&gt;</code> ç±»å‹å ç”¨çš„å†…å­˜ï¼Œå–å†³äºæ³›å‹å‚æ•° <code>T</code> çš„ç±»å‹ç‰¹æ€§ã€‚å…·ä½“å¯åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š</p><ul><li>å½“ T æ˜¯<strong>éæŒ‡é’ˆç±»å‹</strong>ï¼ˆå¦‚åŸºæœ¬ç±»å‹ã€ç»“æ„ä½“ç­‰ï¼‰æ—¶ï¼Œ<code>Option&lt;T&gt;</code> éœ€è¦é¢å¤–çš„ç©ºé—´å­˜å‚¨ Some æˆ– None çš„æ ‡ç­¾ï¼Œæ­¤æ—¶ï¼š<ul><li>å†…å­˜å¸ƒå±€ï¼šåŒ…å«ä¸€ä¸ª 1 å­—èŠ‚çš„æ ‡ç­¾ï¼ˆæ ‡è¯† Some æˆ– Noneï¼‰å’Œ <code>T</code> ç±»å‹çš„æ•°æ®ç©ºé—´ï¼ˆå¯èƒ½åŒ…å«å¯¹é½å¡«å……ï¼‰ã€‚</li><li>å³ä½¿ä¸º <code>None</code>ï¼Œä»éœ€ä¿ç•™ <code>T</code> æ‰€éœ€çš„å†…å­˜ç©ºé—´ï¼ˆå«å¡«å……ï¼‰ï¼Œä»¥ä¿éšœæšä¸¾å€¼å¤§å°ç»Ÿä¸€ã€‚å¦‚ <code>Option&lt;i32&gt;</code> å ç”¨ 8 å­—èŠ‚ï¼ˆ1 å­—èŠ‚æ ‡ç­¾ + 4 å­—èŠ‚ i32 + 3 å­—èŠ‚å¡«å……ï¼‰ã€‚</li></ul></li><li>å½“ T æ˜¯<strong>ä¸å¯ä¸ºç©ºçš„æŒ‡é’ˆç±»å‹</strong>ï¼ˆå¦‚ Box&lt;T&gt;ã€&amp;Tã€&amp;mut Tï¼‰æ—¶ï¼ŒRust ç¼–è¯‘å™¨ä¼šå¯ç”¨<strong>ç©ºæŒ‡é’ˆä¼˜åŒ–</strong>ï¼ˆNiche Optimizationï¼‰ã€‚å³åˆ©ç”¨<strong>æŒ‡é’ˆä¸èƒ½ä¸º 0</strong> çš„ç‰¹æ€§ï¼Œå°† <code>None</code> æ ‡è¯†ä¸ºå…¨é›¶ä½æ¨¡å¼ï¼ˆ0x00ï¼‰ï¼Œè€Œ <code>Some(ptr)</code> å­˜å‚¨å®é™…æŒ‡é’ˆåœ°å€ï¼Œæ­¤æ—¶æ— éœ€é¢å¤–æ ‡ç­¾ã€‚è¿™ä¸ªæ—¶å€™ï¼Œ<code>None</code> å’Œ <code>Some(T)</code> ä¸å ç”¨ä»»ä½•çš„é¢å¤–ç©ºé—´ï¼Œå¤§å°ä¸ T ç›¸åŒã€‚</li></ul><p>æˆ‘ä»¬å¯ä»¥å†™ä¸ªç¨‹åºæ¥ç®€å•éªŒè¯ä¸€ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">test_option</span>() &#123;</span><br><span class="line">    <span class="comment">// 1. åŸºæœ¬æ•°æ®ç±»å‹</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">i</span>: <span class="type">i32</span> = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">i_none</span>: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; = <span class="literal">None</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">i_some</span>: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; = <span class="title function_ invoke__">Some</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;åŸºæœ¬ç±»å‹ï¼š&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;i32: &#123;&#125; bytes, ptr: &#123;:p&#125;&quot;</span>, mem::<span class="title function_ invoke__">size_of_val</span>(&amp;i), &amp;i); <span class="comment">// 4 bytes</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;None&lt;i32&gt;: &#123;&#125; bytes, ptr: &#123;:p&#125;&quot;</span>, mem::<span class="title function_ invoke__">size_of_val</span>(&amp;i_none), &amp;i_none); <span class="comment">// 8 bytes</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Some&lt;i32&gt;: &#123;&#125; bytes, ptr: &#123;:p&#125;&quot;</span>, mem::<span class="title function_ invoke__">size_of_val</span>(&amp;i_some), &amp;i_some); <span class="comment">// 8 bytes</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. è‡ªå®šä¹‰ç±»å‹</span></span><br><span class="line">    <span class="meta">#[repr(C)]</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Data</span> &#123;</span><br><span class="line">        a: <span class="type">u64</span>,</span><br><span class="line">        b: <span class="type">u32</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">data</span> = Data &#123; a: <span class="number">1</span>, b: <span class="number">1</span> &#125;;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">data_none</span>: <span class="type">Option</span>&lt;Data&gt; = <span class="literal">None</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">data_some</span>: <span class="type">Option</span>&lt;Data&gt; = <span class="title function_ invoke__">Some</span>(Data &#123; a: <span class="number">1</span>, b: <span class="number">1</span> &#125;);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;\nè‡ªå®šä¹‰ç»“æ„ä½“ï¼š&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Data: &#123;&#125; bytes, ptr: &#123;:p&#125;&quot;</span>, mem::<span class="title function_ invoke__">size_of_val</span>(&amp;data), &amp;data); <span class="comment">// 16 bytes</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;None&lt;Data&gt;: &#123;&#125; bytes, ptr: &#123;:p&#125;&quot;</span>, mem::<span class="title function_ invoke__">size_of_val</span>(&amp;data_none), &amp;data_none); <span class="comment">// 24 bytes</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Some&lt;Data&gt;: &#123;&#125; bytes, ptr: &#123;:p&#125;&quot;</span>, mem::<span class="title function_ invoke__">size_of_val</span>(&amp;data_some), &amp;data_some); <span class="comment">// 24 bytes</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. æŒ‡é’ˆç±»å‹</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b</span> = <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b_none</span>: <span class="type">Option</span>&lt;<span class="type">Box</span>&lt;<span class="type">i32</span>&gt;&gt; = <span class="literal">None</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b_some</span>: <span class="type">Option</span>&lt;<span class="type">Box</span>&lt;<span class="type">i32</span>&gt;&gt; = <span class="title function_ invoke__">Some</span>(<span class="type">Box</span>::<span class="title function_ invoke__">new</span>(<span class="number">1</span>));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;\næŒ‡é’ˆç±»å‹ï¼š&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Box&lt;i32&gt;: &#123;&#125; bytes, ptr: &#123;:p&#125;&quot;</span>, mem::<span class="title function_ invoke__">size_of_val</span>(&amp;b), &amp;b); <span class="comment">// 8 bytes</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;None&lt;Box&lt;i32&gt;&gt;: &#123;&#125; bytes, ptr: &#123;:p&#125;&quot;</span>, mem::<span class="title function_ invoke__">size_of_val</span>(&amp;b_none), &amp;b_none); <span class="comment">// 8 bytes</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Some&lt;Box&lt;i32&gt;&gt;: &#123;&#125; bytes, ptr: &#123;:p&#125;&quot;</span>, mem::<span class="title function_ invoke__">size_of_val</span>(&amp;b_some), &amp;b_some); <span class="comment">// 8 bytes</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">none_value</span> = <span class="keyword">unsafe</span> &#123; *(&amp;b_none <span class="keyword">as</span> *<span class="keyword">const</span> _ <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">i64</span>) &#125;;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;None&lt;Box&lt;i32&gt;&gt; bit pattern: &#123;:#x&#125;&quot;</span>, none_value); <span class="comment">// 0x0</span></span><br><span class="line">  <span class="keyword">let</span> <span class="variable">some_value</span> = <span class="keyword">unsafe</span> &#123; *(&amp;b_some <span class="keyword">as</span> *<span class="keyword">const</span> _ <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">i64</span>) &#125;;</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;None&lt;Box&lt;i32&gt;&gt; bit pattern: &#123;:#x&#125;&quot;</span>, some_value); <span class="comment">// 0x15d0043c0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ç¬”è€…çš„ç”µè„‘ä¸‹ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">åŸºæœ¬ç±»å‹ï¼š</span><br><span class="line">i32: 4 bytes, ptr: 0x16bef203c</span><br><span class="line">None&lt;i32&gt;: 8 bytes, ptr: 0x16bef2040</span><br><span class="line">Some&lt;i32&gt;: 8 bytes, ptr: 0x16bef2048</span><br><span class="line"></span><br><span class="line">è‡ªå®šä¹‰ç»“æ„ä½“ï¼š</span><br><span class="line">Data: 16 bytes, ptr: 0x16bef2200</span><br><span class="line">None&lt;Data&gt;: 24 bytes, ptr: 0x16bef2210</span><br><span class="line">Some&lt;Data&gt;: 24 bytes, ptr: 0x16bef2228</span><br><span class="line"></span><br><span class="line">æŒ‡é’ˆç±»å‹ï¼š</span><br><span class="line">Box&lt;i32&gt;: 8 bytes, ptr: 0x16bef23f8</span><br><span class="line">None&lt;Box&lt;i32&gt;&gt;: 8 bytes, ptr: 0x16bef2400</span><br><span class="line">Some&lt;Box&lt;i32&gt;&gt;: 8 bytes, ptr: 0x16bef2408</span><br><span class="line">None&lt;Box&lt;i32&gt;&gt; bit pattern: 0x0</span><br></pre></td></tr></table></figure><p>é€šè¿‡è¾“å‡ºæˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ°ç»è¿‡<strong>ç©ºæŒ‡é’ˆä¼˜åŒ–</strong>ï¼Œ<code>Option&lt;Box&lt;i32&gt;&gt;</code> çš„ <code>None</code> å’Œ <code>Some</code> éƒ½åªå  <strong>8 å­—èŠ‚</strong>ï¼ˆä¸ <code>Box&lt;i32&gt;</code> ç›¸åŒï¼‰ï¼ŒåŒæ—¶é€šè¿‡ä¸º <code>None</code> å¤ç”¨ç±»å‹çš„æ— æ•ˆä½æ¨¡å¼ï¼ˆå¦‚ <code>0x0</code>ï¼‰æ¶ˆé™¤æšä¸¾æ ‡ç­¾ï¼Œå®ç°é›¶æˆæœ¬æŠ½è±¡ã€‚</p><h3 id="2-PhantomData">2. PhantomData</h3><p>Rust ä¸­çš„ <code>PhantomData</code> æ˜¯ä¸€ä¸ªé›¶å¤§å°ç±»å‹ï¼ˆZero-Sized Type, ZSTï¼‰ï¼Œç”¨äºåœ¨ç¼–è¯‘æœŸå‘ç±»å‹ç³»ç»Ÿä¼ é€’é¢å¤–ä¿¡æ¯ï¼Œè€Œä¸å ç”¨è¿è¡Œæ—¶å†…å­˜ã€‚å®ƒåœ¨æ³›å‹ç¼–ç¨‹ã€ç”Ÿå‘½å‘¨æœŸç®¡ç†å’Œæ‰€æœ‰æƒæ ‡è®°ä¸­æ‰®æ¼”å…³é”®è§’è‰²ã€‚</p><p>å®ƒæœ‰ä»¥ä¸‹çš„æ ¸å¿ƒç‰¹æ€§å’Œä½œç”¨ï¼š</p><ol><li><p><strong>é›¶å†…å­˜å¼€é”€</strong>ï¼š<code>PhantomData&lt;T&gt;</code> æœ¬èº«ä¸å­˜å‚¨ä»»ä½•æ•°æ®ï¼Œç¼–è¯‘åä¼šè¢«ä¼˜åŒ–æ‰ï¼Œå› æ­¤<strong>ä¸ä¼šå¢åŠ ç»“æ„ä½“çš„å®é™…å†…å­˜å ç”¨</strong>ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::marker::PhantomData;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Wrapper</span>&lt;T&gt; &#123;</span><br><span class="line">    data: <span class="type">u32</span>,</span><br><span class="line">    _marker: PhantomData&lt;T&gt;, <span class="comment">// ä¸å ç©ºé—´</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>æ ‡è®°æœªä½¿ç”¨çš„æ³›å‹å‚æ•°</strong>ï¼šRust è¦æ±‚æ³›å‹å‚æ•°å¿…é¡»åœ¨ç»“æ„ä½“ä¸­è¢«æ˜¾å¼ä½¿ç”¨ã€‚è‹¥æ³›å‹å‚æ•°æœªç›´æ¥å‡ºç°åœ¨å­—æ®µä¸­ï¼Œå¯é€šè¿‡ <code>PhantomData</code> æ ‡è®°å…¶å­˜åœ¨æ€§ï¼Œé¿å…ç¼–è¯‘é”™è¯¯ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Resource</span>&lt;T&gt; &#123;</span><br><span class="line">    handle: *<span class="title function_ invoke__">mut</span> (),</span><br><span class="line">    _phantom: PhantomData&lt;T&gt;, <span class="comment">// æ ‡è®°ç±»å‹ T</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>å£°æ˜ç”Ÿå‘½å‘¨æœŸä¾èµ–</strong>ï¼šå½“ç»“æ„ä½“åŒ…å«åŸå§‹æŒ‡é’ˆï¼ˆå¦‚ <code>*const T</code>ï¼‰æ—¶ï¼Œ<code>PhantomData</code> å¯ç»‘å®šç”Ÿå‘½å‘¨æœŸï¼Œç¡®ä¿å¼•ç”¨çš„æ•°æ®æœ‰æ•ˆæ€§ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Slice</span>&lt;<span class="symbol">&#x27;a</span>, T&gt; &#123;</span><br><span class="line">    start: *<span class="keyword">const</span> T,</span><br><span class="line">    end: *<span class="keyword">const</span> T,</span><br><span class="line">    _phantom: PhantomData&lt;&amp;<span class="symbol">&#x27;a</span> T&gt;, <span class="comment">// ç»‘å®šç”Ÿå‘½å‘¨æœŸ &#x27;a</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>åå˜ä¸é€†å˜æ§åˆ¶</strong>ï¼šé€šè¿‡ <code>PhantomData&lt;&amp;'a T&gt;</code> æˆ– <code>PhantomData&lt;*mut T&gt;</code> ç­‰ä¸åŒå½¢å¼ï¼Œè°ƒæ•´ç±»å‹çš„åå˜/é€†å˜è¡Œä¸ºã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::marker::PhantomData;</span><br><span class="line"><span class="keyword">use</span> std::rc::Rc;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ‡è®°ç±»å‹ä¸º !Send ä¸” !Sync</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">NotThreadSafe</span> &#123;</span><br><span class="line">    _marker: PhantomData&lt;Rc&lt;()&gt;&gt;, <span class="comment">// Rc&lt;()&gt; æœ¬èº«æ˜¯ !Send + !Sync</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    
    <summary type="html">æœ¬æ–‡ä»é›¶å¼€å§‹ï¼Œé€šè¿‡å¤šç‰ˆæœ¬è¿­ä»£ï¼Œå®ç°ä¸€ä¸ªå®‰å…¨çš„ Rust oneshot channelã€‚æˆ‘ä»¬å°†æ·±å…¥ `AtomicBool`ã€`UnsafeCell`ã€`MaybeUninit` çš„ä½¿ç”¨ï¼Œé€šè¿‡ `Drop` ç®¡ç†å†…å­˜ï¼Œå¹¶æœ€ç»ˆä»¥ `Sender`/`Receiver` æ¨¡å¼å’Œæ‰€æœ‰æƒæœºåˆ¶å°è£… `unsafe`ï¼Œæ„å»ºå¥å£®çš„å¹¶å‘åŸè¯­ã€‚</summary>
    
    
    
    <category term="rust" scheme="https://hedon.top/categories/rust/"/>
    
    <category term="rust å®æˆ˜" scheme="https://hedon.top/categories/rust/rust-%E5%AE%9E%E6%88%98/"/>
    
    
    <category term="rust" scheme="https://hedon.top/tags/rust/"/>
    
    <category term="å¹¶å‘ç¼–ç¨‹" scheme="https://hedon.top/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª SpinLock</title>
    <link href="https://hedon.top/2025/05/13/rust-action-spinlock/"/>
    <id>https://hedon.top/2025/05/13/rust-action-spinlock/</id>
    <published>2025-05-13T04:58:25.000Z</published>
    <updated>2025-06-05T00:38:36.336Z</updated>
    
    <content type="html"><![CDATA[<p>ç³»åˆ—æ–‡ç« ï¼š</p><ul><li><a href="https://hedon.top/2024/11/11/rust-memory-order/">Rust åŸç†ä¸¨èŠä¸€èŠ Rust çš„ Atomic å’Œå†…å­˜é¡ºåº</a></li></ul><p>åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œ<strong>é”</strong>ï¼ˆlockï¼‰æ˜¯ä¸€ç§å¸¸ç”¨çš„åŒæ­¥æœºåˆ¶ï¼Œç”¨äºä¿æŠ¤å…±äº«æ•°æ®é¿å…ç«æ€æ¡ä»¶ã€‚ç„¶è€Œï¼Œåœ¨è®¸å¤šç¼–ç¨‹è¯­è¨€ä¸­ï¼Œé”çš„ä½¿ç”¨å¾€å¾€éœ€è¦æ‰‹åŠ¨â€œåŠ é”â€å’Œâ€œè§£é”â€ã€‚<strong>æ‰‹åŠ¨è§£é”</strong>çš„æ—¶æœºå¾ˆéš¾æ§åˆ¶â€”â€”å¦‚æœç¨‹åºåœ¨ä¸´ç•ŒåŒºå‡ºç°é”™è¯¯è€Œè·³å‡ºäº†æ­£å¸¸æµç¨‹ï¼Œå¼€å‘è€…å¯èƒ½ä¼šå¿˜è®°è§£é”é”ï¼Œä»è€Œå¯¼è‡´å…¶ä»–çº¿ç¨‹æ°¸è¿œæ— æ³•å–å¾—è¯¥é”ï¼Œå‘ç”Ÿæ­»é”ã€‚å¦å¤–ï¼Œè¿˜å¯èƒ½å‘ç”Ÿ<strong>é‡å¤è§£é”</strong>çš„é—®é¢˜ï¼šæ¯”å¦‚çº¿ç¨‹ A è§£é”åï¼Œçº¿ç¨‹ B å¾ˆå¿«åŠ é”ï¼Œè¿™æ—¶å¦‚æœçº¿ç¨‹ A çš„å¼‚å¸¸å¤„ç†ä»£ç å†æ¬¡æ‰§è¡Œäº†è§£é”æ“ä½œï¼Œå°±ä¼šæŠŠçº¿ç¨‹ B çš„é”è¿‡æ—©é‡Šæ”¾ï¼Œé€ æˆæ•°æ®ç«æ€ã€‚å¦å¤–ï¼Œå¤§éƒ¨åˆ†è¯­è¨€ä¸­<strong>é”å’Œå®ƒæ‰€ä¿æŠ¤çš„æ•°æ®ç¼ºä¹å…³è”</strong>ï¼šç¼–è¯‘å™¨å¹¶ä¸çŸ¥é“æŸä¸ªæ•°æ®å¿…é¡»åœ¨ç‰¹å®šé”ä¿æŠ¤ä¸‹è®¿é—®ï¼Œè¿™æ ·ä¸€æ¥ï¼Œç¨‹åºå‘˜å¾ˆå®¹æ˜“çŠ¯â€œæœªåŠ é”å°±è®¿é—®æ•°æ®â€çš„é”™è¯¯ã€‚è¿™äº›é—®é¢˜å¯¹äºæ–°æ‰‹æ¥è¯´å°¤å…¶å¸¸è§ï¼Œè€Œä¸”<strong>ç¼–è¯‘å™¨æ— æ³•å¸®åŠ©æ£€æŸ¥</strong>å¹¶å‘ä½¿ç”¨ä¸Šçš„è¿™äº› Bugã€‚</p><p>ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œç†æƒ³æƒ…å†µæ˜¯è®©<strong>é”çš„ç®¡ç†å’Œèµ„æºçš„ç”Ÿå‘½å‘¨æœŸç»‘å®š</strong>ï¼Œç”±è¯­è¨€å¸®æˆ‘ä»¬è‡ªåŠ¨ç®¡ç†è§£é”ã€‚Rust æ­£æ˜¯é€šè¿‡æ‰€æœ‰æƒå’Œç”Ÿå‘½å‘¨æœŸæœºåˆ¶ï¼Œå®ç°äº†èµ„æºä¸ä½œç”¨åŸŸç”Ÿå‘½å‘¨æœŸçš„ç»‘å®šï¼Œå³å…¸å‹çš„ <strong>RAII</strong> æŠ€æœ¯ï¼ˆ<em>Resource Acquisition Is Initialization</em>ï¼Œèµ„æºè·å–å³åˆå§‹åŒ–ï¼‰ã€‚</p><p>åœ¨ Rust æ ‡å‡†åº“ä¸­ï¼Œåƒ <code>Mutex</code>ï¼ˆäº’æ–¥é”ï¼‰å°±åˆ©ç”¨äº† RAIIï¼šè·å–é”ä¼šè¿”å›ä¸€ä¸ªå®ˆå«å¯¹è±¡ï¼ˆä¾‹å¦‚ <code>MutexGuard</code>ï¼‰ï¼Œå½“å®ˆå«å¯¹è±¡è¢«ä¸¢å¼ƒï¼ˆææ„ï¼‰æ—¶è‡ªåŠ¨è§£é”ï¼Œä»è€Œé¿å…æ˜¾å¼è§£é”çš„éº»çƒ¦ã€‚Rust æ ‡å‡†åº“çš„ <code>Mutex</code> åº•å±‚åˆ©ç”¨äº†æ“ä½œç³»ç»Ÿçš„é”æœºåˆ¶ï¼Œåœ¨çº¿ç¨‹äº‰ç”¨æ—¶ä¼šä½¿çº¿ç¨‹ä¼‘çœ æŒ‚èµ·ï¼Œä»¥é¿å…æµªè´¹ CPUã€‚ç„¶è€Œï¼Œåœ¨ä¸€äº›åœºæ™¯ä¸‹ï¼Œæ¯”å¦‚<strong>æ— æ“ä½œç³»ç»Ÿç¯å¢ƒï¼ˆno_stdï¼‰<strong>çš„å†…æ ¸å¼€å‘ã€<strong>ä¸­æ–­å¤„ç†</strong>ã€æˆ–è€…</strong>ä¸´ç•ŒåŒºæçŸ­</strong>çš„åœºåˆï¼Œæˆ‘ä»¬å¯èƒ½å¸Œæœ›ä½¿ç”¨<strong>è‡ªæ—‹é”</strong>ï¼ˆSpinLockï¼‰æ¥å¿™ç­‰å¾…é”ï¼Œè€Œä¸è¿›å…¥ä¼‘çœ ã€‚è‡ªæ—‹é”åœ¨é”ç«äº‰çŸ­æš‚æ—¶èƒ½çœå»çº¿ç¨‹åˆ‡æ¢çš„å¼€é”€ï¼Œä½†å¦‚æœé”è¢«å ç”¨æ—¶é—´è¿‡é•¿ï¼Œä¼šæµªè´¹å¤§é‡ CPU æ—¶é—´ï¼Œå› æ­¤éœ€è¦æ…é‡ä½¿ç”¨ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å‚è€ƒ <a href="https://marabos.nl/atomics/">Rust Atomics and Locks</a> ä¸€ä¹¦ï¼Œ<strong>ä»é›¶å¼€å§‹å®ç°ä¸€ä¸ª Rust ç‰ˆæœ¬çš„ SpinLock</strong>ã€‚æˆ‘ä»¬ä¼šæŒ‰ä¸‰ä¸ªç‰ˆæœ¬é€æ­¥å¼•å…¥åŠŸèƒ½å’Œæ¦‚å¿µï¼š</p><ol><li>é¦–å…ˆå®ç°åŸºæœ¬çš„ <strong>v0</strong> ç‰ˆæœ¬ï¼ˆä¸ä¿æŠ¤å…·ä½“æ•°æ®ï¼Œä»…æä¾›åŠ é”/è§£é”æœºåˆ¶ï¼‰ï¼›</li><li>ç„¶åæ‰©å±•ä¸ºèƒ½å¤Ÿä¿æŠ¤æ•°æ®çš„ <strong>v1</strong> ç‰ˆæœ¬ï¼›</li><li>æœ€ååŠ å…¥ RAII æœºåˆ¶å®ç°è‡ªåŠ¨è§£é”çš„<strong>v2</strong>ç‰ˆæœ¬ã€‚</li></ol><p>è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼šè®¨è®ºç›¸å…³çš„ Rust å¹¶å‘æ¦‚å¿µï¼ŒåŒ…æ‹¬ <strong>Atomic</strong> åŸå­ç±»å‹ã€<strong>Ordering</strong> å†…å­˜åºã€<strong>UnsafeCell</strong>ã€<strong>Send/Sync</strong> å¹¶å‘å®‰å…¨æ ‡è®°ã€ä»¥åŠ RAII ä¸­çš„ <strong>Deref/Drop</strong> trait ç­‰ã€‚</p><p>è®©æˆ‘ä»¬ä¸€æ­¥æ­¥å®ç°è¿™ä¸ªè‡ªæ—‹é”å§ï¼</p><h2 id="è¯»å®Œæœ¬ç¯‡ä½ èƒ½å­¦åˆ°ä»€ä¹ˆ">è¯»å®Œæœ¬ç¯‡ä½ èƒ½å­¦åˆ°ä»€ä¹ˆ</h2><ol><li><strong>è‡ªæ—‹é”ä¸äº’æ–¥é”çš„æƒè¡¡</strong>ï¼šäº†è§£è‡ªæ—‹é”é€‚åˆçš„åœºæ™¯ï¼ˆæçŸ­ä¸´ç•ŒåŒºã€å†…æ ¸/ä¸­æ–­ä¸Šä¸‹æ–‡ã€æ—  OS ç¯å¢ƒï¼‰ï¼Œä»¥åŠä¸ºä½•åœ¨é”ç«äº‰æ—¶é—´è¾ƒé•¿æ—¶åº”ä¼˜å…ˆé€‰æ‹©ä¼‘çœ å¼äº’æ–¥é”ã€‚</li><li><strong>åŸå­æ“ä½œ + å†…å­˜é¡ºåºçš„å®æˆ˜ç”¨æ³•</strong>ï¼šå­¦ä¼šä½¿ç”¨ <code>AtomicBool</code>ï¼Œå¹¶ç†è§£ <code>Acquire / Release</code> åœ¨åŠ é”ã€è§£é”æ—¶å»ºç«‹çš„ <em>happens-before</em> å…³ç³»ï¼›æŒæ¡ <code>swap</code> ä¸ <code>spin_loop</code> çš„é…åˆç»†èŠ‚ã€‚</li><li><strong>å†…éƒ¨å¯å˜æ€§ï¼ˆUnsafeCellï¼‰</strong>ï¼šæŒæ¡å¦‚ä½•åœ¨æŒæœ‰ä¸å¯å˜å¼•ç”¨çš„æƒ…å†µä¸‹å¯¹æ•°æ®è¿›è¡Œå®‰å…¨ä¿®æ”¹ã€‚</li><li><strong>RAII + <code>Drop</code> æœºåˆ¶æ¶ˆé™¤â€œå¿˜è®°è§£é”â€Bug</strong>ï¼šé€šè¿‡ <code>SpinLockGuard</code> + <code>Drop</code>ï¼Œä½“éªŒå¦‚ä½•æŠŠâ€œèµ„æºé‡Šæ”¾â€äº¤ç»™ä½œç”¨åŸŸç®¡ç†ï¼Œå½»åº•æ ¹é™¤å¿˜è®°/é‡å¤è§£é”çš„é£é™©ã€‚</li><li><strong><code>Deref</code> / <code>DerefMut</code> çš„é›¶æˆæœ¬æŠ½è±¡</strong>ï¼šæŒæ¡ä¸ºå®ˆå«å¯¹è±¡å®ç° <code>Deref</code>/<code>DerefMut</code>ï¼Œè®©ä½¿ç”¨è€…åƒæ“ä½œæ™®é€šå¼•ç”¨ä¸€æ ·æ“ä½œå—ä¿æŠ¤æ•°æ®ï¼Œè€Œä¸å¼•å…¥é¢å¤–è¿è¡Œæ—¶å¼€é”€ã€‚</li></ol><h2 id="åŸºç¡€ç‰ˆ-v0ï¼šè‡ªæ—‹é”çš„åŸºæœ¬å®ç°">åŸºç¡€ç‰ˆ v0ï¼šè‡ªæ—‹é”çš„åŸºæœ¬å®ç°</h2><p>æˆ‘ä»¬å…ˆä»æœ€åŸºç¡€çš„ç‰ˆæœ¬å¼€å§‹ï¼Œæˆ‘ä»¬åœ¨ <code>lock</code> çš„æ—¶å€™ï¼Œå¦‚æœå¤±è´¥äº†ï¼Œå°±ä¸€ç›´å¾ªç¯å°è¯•ï¼Œç›´åˆ°æˆåŠŸè·å–é”ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">SpinLock</span> &#123;</span><br><span class="line">  <span class="comment">// åŸå­å¸ƒå°”æ ‡å¿—ï¼Œè¡¨ç¤ºé”æ˜¯å¦è¢«å ç”¨</span></span><br><span class="line">    locked: AtomicBool,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">SpinLock</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            locked: AtomicBool::<span class="title function_ invoke__">new</span>(<span class="literal">false</span>),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">lock</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨åŸå­æ“ä½œå°è¯•å°† flag å˜ä¸º trueï¼Œå¹¶è¿”å›ä¹‹å‰çš„å€¼ï¼š</span></span><br><span class="line">      <span class="comment">//   å¦‚æœè¿”å›çš„æ˜¯ trueï¼Œåˆ™è¯´æ˜é”å·²ç»è¢«å…¶ä»–çº¿ç¨‹æŠ¢èµ°äº†ã€‚</span></span><br><span class="line">      <span class="comment">// å¦‚æœè¿”å›çš„æ˜¯ falseï¼Œåˆ™è¯´æ˜å½“å‰çº¿ç¨‹æŠ¢å é”æˆåŠŸã€‚</span></span><br><span class="line">        <span class="comment">// è·å–é”ä½¿ç”¨ Acquire è¯­ä¹‰ä»¥ç¡®ä¿åç»­å¯¹å—ä¿æŠ¤æ•°æ®çš„å†…å­˜è®¿é—®ä¸ä¼šè¢«é‡æ’åˆ°é”è·å–ä¹‹å‰ã€‚</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">self</span>.locked.<span class="title function_ invoke__">swap</span>(<span class="literal">true</span>, Ordering::Acquire) &#123;</span><br><span class="line">            <span class="comment">// å‘å¤„ç†å™¨å‘å‡ºä¸€ä¸ªæç¤ºï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹æ­£å¿™ç­‰å¾…ã€‚</span></span><br><span class="line">          <span class="comment">// è¿™åœ¨æŸäº›æ¶æ„ä¸Šå¯ä»¥å‡å°‘åŠŸè€—æˆ–è®©å¤„ç†å™¨ä¼˜åŒ–æ€§èƒ½ï¼ˆæ¯”å¦‚ x86 ä¸Šçš„ PAUSE æŒ‡ä»¤ï¼‰ï¼Œé¿å…æ— æ•ˆåœ°å ç”¨æ€»çº¿ã€‚</span></span><br><span class="line">            std::hint::<span class="title function_ invoke__">spin_loop</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">unlock</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="comment">// å°†æ ‡å¿—ç½®å› falseï¼Œé‡Šæ”¾é”ã€‚ä½¿ç”¨ Release è¯­ä¹‰ä»¥ç¡®ä¿ä¹‹å‰ä¸´ç•ŒåŒºçš„ä¿®æ”¹å¯¹åç»­è·å–é”çš„çº¿ç¨‹å¯è§ã€‚</span></span><br><span class="line">        <span class="keyword">self</span>.locked.<span class="title function_ invoke__">store</span>(<span class="literal">false</span>, Ordering::Release);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šè¿°å®ç°ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ç»“æ„ <code>SpinLock</code>ï¼Œå®ƒåŒ…å«ä¸€ä¸ªåŸå­å˜é‡ <code>locked</code>ã€‚</p><p>åœ¨ <code>lock</code> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å°è¯•å¯¹ <code>locked</code> åŸå­å˜é‡è¿›è¡Œ <code>swap</code> ä¸º <code>true</code> çš„æ“ä½œï¼Œ<code>swap</code> ä¼šè¿”å›äº¤æ¢ä¹‹å‰çš„å€¼ï¼Œå¦‚æœæ˜¯ <code>false</code>ï¼Œé‚£å°±è¯´æ˜æŠ¢é”æˆåŠŸäº†ï¼Œè¿™ä¸ªæ—¶å€™ <code>lock</code> å°±æˆåŠŸè¿”å›ï¼Œå¦åˆ™ï¼Œåˆ™è°ƒç”¨ <code>std::hint::spin_loop()</code> è¿›è¡Œè‡ªæ—‹ï¼Œåœ¨ä¸‹ä¸€æ¬¡ <code>while</code> å¾ªç¯ä¸­å†å°è¯•è·å–é”ã€‚</p><p>åœ¨ <code>unlock</code> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦å°† <code>locked</code> è®¾ç½®ä¸º <code>false</code> å³å¯ã€‚</p><p>ç¤ºä¾‹å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250513131603680.png" alt=""></p><p>è¿™é‡Œæœ‰å‡ ä¸ªéœ€è¦å…³æ³¨çš„ç‚¹ï¼š</p><ol><li><code>std::hint::spin_loop()</code> ä¼šå‘ CPU å‘é€ç‰¹å®šæŒ‡ä»¤ï¼ˆå¦‚ x86 çš„ pause æˆ– ARM çš„ yieldï¼‰ï¼Œæç¤ºå½“å‰å¤„äºå¿™ç­‰å¾…çŠ¶æ€ã€‚è¿™å…è®¸ CPU ä¼˜åŒ–æ‰§è¡Œè¡Œä¸ºï¼š<ul><li><strong>é™ä½åŠŸè€—</strong>ï¼šå‡å°‘è‡ªæ—‹æœŸé—´çš„è®¡ç®—èµ„æºæ¶ˆè€—ã€‚</li><li><strong>æå‡å¤šçº¿ç¨‹æ•ˆç‡</strong>ï¼šåœ¨è¶…çº¿ç¨‹æ¶æ„ä¸­ï¼Œé¿å…å•ä¸ªæ ¸å¿ƒçš„å¿™ç­‰å¾…é˜»å¡å…¶ä»–çº¿ç¨‹çš„æ‰§è¡Œã€‚</li></ul></li><li><code>locked</code> æ˜¯ä¸€ä¸ªåŸå­å˜é‡ï¼Œå¯¹å…¶çš„æ“ä½œç§°ä¸ºåŸå­æ“ä½œï¼ˆAtomic Operationï¼‰ã€‚<strong>åŸå­æ“ä½œæ˜¯æŒ‡åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹ä¸å¯è¢«ä¸­æ–­çš„æ“ä½œï¼Œèƒ½ä¿è¯å¯¹å˜é‡çš„è¯»/å†™è¦ä¹ˆå®Œæ•´å®Œæˆè¦ä¹ˆä¸å‘ç”Ÿï¼Œå› æ­¤ä¸å­˜åœ¨æ•°æ®ç«äº‰</strong>ã€‚åœ¨ Rust ä¸­ï¼Œæ¯ä¸ªåŸå­æ“ä½œéƒ½éœ€è¦æŒ‡å®šå†…å­˜é¡ºåºï¼ˆMemory Orderingï¼‰å‚æ•°ï¼Œç”¨äºçº¦æŸç¼–è¯‘å™¨å’Œ CPU å¯¹æŒ‡ä»¤é‡æ’çš„è§„åˆ™ã€‚æ›´è¯¦ç»†çš„è§„åˆ™å¯å‚é˜…ï¼š<a href="https://hedon.top/2024/11/11/rust-memory-order/">Rust åŸç†ä¸¨èŠä¸€èŠ Rust çš„ Atomic å’Œå†…å­˜é¡ºåº</a>ã€‚</li><li>è¿™é‡Œæˆ‘ä»¬å†…å­˜é¡ºåºä½¿ç”¨äº†ä¸€å¯¹ <code>Acquire</code> å’Œ <code>Release</code>ã€‚å…¶ä¸­ï¼š<ul><li>è·å–é”çš„æ—¶å€™ä½¿ç”¨ <code>Acquire</code> ç¡®ä¿åç»­å¯¹å—ä¿æŠ¤æ•°æ®çš„å†…å­˜è®¿é—®ä¸ä¼šè¢«é‡æ’åˆ°é”è·å–ä¹‹å‰ã€‚</li><li>é‡Šæ”¾é”çš„æ—¶å€™ä½¿ç”¨ <code>Release</code> ç¡®ä¿ä¹‹å‰ä¸´ç•ŒåŒºå†…çš„æ‰€æœ‰ä¿®æ”¹éƒ½å®Œæˆå‘å¸ƒï¼ˆå¯¹å…¶ä»–çº¿ç¨‹å¯è§ï¼‰ï¼Œå†è®©å…¶ä»–çº¿ç¨‹è·å–é”ã€‚</li></ul></li></ol><p>æˆ‘ä»¬æ¥æ’°å†™å•å…ƒæµ‹è¯•ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line"><span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">one_thread_should_work</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">lock</span> = SpinLock::<span class="title function_ invoke__">new</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">data</span> = <span class="built_in">vec!</span>[]; <span class="comment">// ä¸´ç•ŒåŒºèµ„æº</span></span><br><span class="line"></span><br><span class="line">        lock.<span class="title function_ invoke__">lock</span>();</span><br><span class="line">        data.<span class="title function_ invoke__">push</span>(<span class="number">1</span>); <span class="comment">// ä¸´ç•ŒåŒºä»£ç </span></span><br><span class="line">        lock.<span class="title function_ invoke__">unlock</span>();</span><br><span class="line"></span><br><span class="line">        lock.<span class="title function_ invoke__">lock</span>();</span><br><span class="line">        <span class="built_in">print!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, data); <span class="comment">// ä¸´ç•ŒåŒºä»£ç </span></span><br><span class="line">        lock.<span class="title function_ invoke__">unlock</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">cross_thread_should_work</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">data</span> = <span class="built_in">vec!</span>[];  <span class="comment">// ä¸´ç•ŒåŒºèµ„æº</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">lock</span> = SpinLock::<span class="title function_ invoke__">new</span>();</span><br><span class="line">        thread::<span class="title function_ invoke__">scope</span>(|s| &#123;</span><br><span class="line">            s.<span class="title function_ invoke__">spawn</span>(|| &#123;</span><br><span class="line">                lock.<span class="title function_ invoke__">lock</span>();</span><br><span class="line">                <span class="keyword">unsafe</span> &#123;</span><br><span class="line">                    <span class="keyword">let</span> <span class="variable">data_ptr</span> = &amp;data <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt; <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;;</span><br><span class="line">                    (*data_ptr).<span class="title function_ invoke__">push</span>(<span class="number">1</span>);  <span class="comment">// ä¸´ç•ŒåŒºä»£ç </span></span><br><span class="line">                &#125;</span><br><span class="line">                lock.<span class="title function_ invoke__">unlock</span>();</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">100</span>));</span><br><span class="line">            lock.<span class="title function_ invoke__">lock</span>();</span><br><span class="line">            <span class="keyword">unsafe</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">data_ptr</span> = &amp;data <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt; <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;;</span><br><span class="line">                (*data_ptr).<span class="title function_ invoke__">push</span>(<span class="number">2</span>); <span class="comment">// ä¸´ç•ŒåŒºä»£ç </span></span><br><span class="line">            &#125;</span><br><span class="line">            lock.<span class="title function_ invoke__">unlock</span>();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        lock.<span class="title function_ invoke__">lock</span>();</span><br><span class="line">        <span class="built_in">print!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, data);  <span class="comment">// ä¸´ç•ŒåŒºä»£ç </span></span><br><span class="line">        lock.<span class="title function_ invoke__">unlock</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è·¨çº¿ç¨‹çš„æµ‹è¯•ç”¨ä¾‹ <code>cross_thread_should_work</code> ä¸­ï¼Œä¸ºäº†å¯¹ <code>data</code> è¿›è¡Œä¿®æ”¹ï¼Œæˆ‘ä»¬åªèƒ½åœ¨ <code>unsafe</code> é‡Œé¢å¼ºè¡Œä½¿ç”¨è£¸æŒ‡é’ˆæ¥è¿›è¡Œæ“ä½œï¼Œå¦åˆ™ç¼–è¯‘å°±ä¼šå¤±è´¥ã€‚</p><h2 id="å‡çº§ç‰ˆ-v1ï¼šå°†é”ä¸æ•°æ®å…³è”">å‡çº§ç‰ˆ v1ï¼šå°†é”ä¸æ•°æ®å…³è”</h2><p>åœ¨ä¸Šä¸€ä¸ªåŸºç¡€ç‰ˆæœ¬ä¸­ï¼Œè™½ç„¶è¿™ä¹ˆåšèƒ½èµ·åˆ°äº’æ–¥çš„ä½œç”¨ï¼Œä½†æ˜¯å­˜åœ¨ 2 ä¸ªé—®é¢˜ï¼š</p><ol><li>æˆ‘ä»¬ä¼šå‘ç°æ“ä½œä¸´ç•Œèµ„æºéå¸¸éº»çƒ¦ï¼Œå› ä¸ºä¸´ç•Œèµ„æºçš„ç±»å‹ï¼Œå¯èƒ½æ˜¯ä¸æ»¡è¶³ <code>Sync</code> å’Œ <code>Send</code> çš„ï¼Œæ‰€ä»¥å®ƒä»¬æ— æ³•åœ¨è·¨çº¿ç¨‹ä¸­è¿›è¡Œä¼ é€’æˆ–è½¬ç§»ï¼Œæ‰€ä»¥å³ä¾¿æˆ‘ä»¬èƒ½ä»é€»è¾‘ä¸Šæ–­å®šå®ƒä»¬æ˜¯å¹¶å‘å®‰å…¨çš„ï¼Œä½†æ˜¯ç¼–è¯‘å™¨å¯æ²¡é‚£ä¹ˆèªæ˜ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½é€šè¿‡ <code>unsafe</code> å¼ºè¡Œç»•è¿‡ç¼–è¯‘æœŸçš„æ£€æŸ¥ã€‚</li><li>é”å’Œè¢«ä¿æŠ¤çš„æ•°æ®æ˜¯åˆ†ç¦»çš„ã€‚ç¨‹åºå‘˜å¿…é¡»å°å¿ƒç¡®ä¿æ¯æ¬¡è®¿é—®å…±äº«æ•°æ®éƒ½æ­£ç¡®åœ°è°ƒç”¨äº† <code>lock()</code> å’Œ <code>unlock()</code>ã€‚ä¸€æ—¦å¿˜è®°è°ƒç”¨ <code>unlock()</code>ï¼Œæˆ–è€…æé”™äº†åŠ é”è§£é”çš„é…å¯¹å…³ç³»ï¼Œç¼–è¯‘å™¨éƒ½ä¸ä¼šæŠ¥é”™ï¼Œä½†ç¨‹åºçš„å¹¶å‘è¡Œä¸ºå°±å¯èƒ½å‡ºé—®é¢˜ã€‚</li></ol><p>æ˜¾ç„¶ï¼Œæˆ‘ä»¬å¸Œæœ›è®©<strong>é”ä¸æ•°æ®å…³è”</strong>èµ·æ¥ï¼Œä»è¯­æ³•å±‚é¢é™ä½è¯¯ç”¨çš„å¯èƒ½ï¼ŒåŒæ—¶ä¾¿äºæˆ‘ä»¬ä¸ºä¸´ç•Œèµ„æºçš„æ•°æ®ç±»å‹é™å®šç›¸å…³çš„ traitï¼Œæé«˜èµ„æºè®¿é—®çš„ä¾¿æ·æ€§ã€‚è¿™æ­£æ˜¯ä¸‹ä¸€æ­¥è¦åšçš„æ”¹è¿›ã€‚</p><p>æˆ‘ä»¬çœ‹çœ‹æ ‡å‡†åº“çš„ <code>Mutex</code> æ˜¯æ€ä¹ˆå®ç°çš„ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">lock</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> LockResult&lt;MutexGuard&lt;<span class="symbol">&#x27;_</span>, T&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.inner.<span class="title function_ invoke__">lock</span>();</span><br><span class="line">        MutexGuard::<span class="title function_ invoke__">new</span>(<span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">MutexGuard</span>&lt;<span class="symbol">&#x27;a</span>, T: ?<span class="built_in">Sized</span> + <span class="symbol">&#x27;a</span>&gt; &#123;</span><br><span class="line">    lock: &amp;<span class="symbol">&#x27;a</span> Mutex&lt;T&gt;,</span><br><span class="line">    poison: poison::Guard,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°ï¼Œæ ‡å‡†çš„é”æ˜¯å°†è¦ä¿æŠ¤çš„ä¸´ç•Œèµ„æºæ”¾åœ¨äº†é”é‡Œï¼Œåœ¨è·å–é”çš„æ—¶å€™ï¼Œå°±è¿”å›è¿™ä¸ªä¸´ç•Œèµ„æºçš„ <code>Guard</code>ã€‚</p><p>OKï¼Œæˆ‘ä»¬å…ˆä¸ç€æ€¥å¼•å…¥è¿™ä¸ª <code>Guard</code>ï¼Œæˆ‘ä»¬å°±ç›´æ¥åœ¨è·å–é”çš„æ—¶å€™è¿”å›ä¸´ç•Œèµ„æºçš„å¯å˜å¼•ç”¨å³å¯ã€‚</p><p>æ›´æ–°åçš„ç‰ˆæœ¬å¦‚ä¸‹æ‰€ç¤ºï¼›</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">SpinLock</span>&lt;T&gt; &#123;</span><br><span class="line">    locked: AtomicBool,</span><br><span class="line">    value: UnsafeCell&lt;T&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; SpinLock&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(value: T) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            locked: AtomicBool::<span class="title function_ invoke__">new</span>(<span class="literal">false</span>),</span><br><span class="line">            value: UnsafeCell::<span class="title function_ invoke__">new</span>(value),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">lock</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="keyword">mut</span> T &#123;</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">self</span>.locked.<span class="title function_ invoke__">swap</span>(<span class="literal">true</span>, Ordering::Acquire) &#123;</span><br><span class="line">            std::hint::<span class="title function_ invoke__">spin_loop</span>();</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">// Safety: æˆ‘ä»¬çŸ¥é“è¿™ä¸ªæ—¶å€™åŒæ—¶åªå¯èƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è·å–åˆ° valueï¼Œ</span></span><br><span class="line">      <span class="comment">// ä¹ŸçŸ¥é“è¿™ä¸ª value ä¸€å®šå­˜åœ¨ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ unwrap()ã€‚</span></span><br><span class="line">        <span class="keyword">unsafe</span> &#123; <span class="keyword">self</span>.value.<span class="title function_ invoke__">get</span>().<span class="title function_ invoke__">as_mut</span>().<span class="title function_ invoke__">unwrap</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">unlock</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.locked.<span class="title function_ invoke__">store</span>(<span class="literal">false</span>, Ordering::Release);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Send</span> <span class="keyword">for</span> <span class="title class_">SpinLock</span>&lt;T&gt; <span class="keyword">where</span> T: <span class="built_in">Send</span> &#123;&#125;</span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Sync</span> <span class="keyword">for</span> <span class="title class_">SpinLock</span>&lt;T&gt; <span class="keyword">where</span> T: <span class="built_in">Send</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åœ¨ <code>SpinLock</code> ä¸­åŠ å…¥äº†ç±»å‹ä¸º <code>UnsafeCell&lt;T&gt;</code> çš„å­—æ®µ <code>value</code>ï¼Œç„¶ååœ¨ <code>lock()</code> æŠ¢åˆ°é”çš„æ—¶å€™ï¼Œé€šè¿‡ <code>self.value.get().as_mut().unwrap()</code> è·å– <code>value</code> çš„å¯å˜å¼•ç”¨ï¼Œæˆ‘ä»¬çŸ¥é“è¿™é‡Œæ˜¯å®‰å…¨çš„ï¼Œæ‰€ä»¥ <code>unsafe</code> æ˜¯å®‰å…¨çš„ã€‚</p><p>åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬è§åˆ°äº†ä¸€ä¸ªæ–°æœ‹å‹ <code>UnsafeCell</code>ï¼Œäº‹å®ä¸Šå®ƒæ˜¯ Rust æ ‡å‡†åº“ä¸­æ‰€æœ‰çš„å¹¶å‘å·¥å…·çš„åŸºçŸ³ï¼Œå®ƒæ¶‰åŠåˆ°äº†ä¸€ä¸ªæ¦‚å¿µï¼š<strong>å†…éƒ¨å¯å˜æ€§</strong>ã€‚</p><p>åœ¨ Rust çš„ç±»å‹ç³»ç»Ÿä¸­ï¼Œå¦‚æœæˆ‘ä»¬åªæœ‰ä¸€ä¸ªå¯¹é”çš„ä¸å¯å˜å¼•ç”¨ï¼ˆ<code>&amp;SpinLock&lt;T&gt;</code>ï¼‰ï¼ŒæŒ‰æ­£å¸¸è§„åˆ™æ˜¯æ— æ³•ç›´æ¥è·å¾—å¯¹å†…éƒ¨æ•°æ®çš„å¯å˜å¼•ç”¨ï¼ˆ<code>&amp;mut T</code>ï¼‰çš„â€”â€”<strong>æ¯•ç«Ÿ Rust ä¸å…è®¸åœ¨ä»…æŒæœ‰ä¸å¯å˜å¼•ç”¨çš„æƒ…å†µä¸‹ä¿®æ”¹æ•°æ®</strong>ã€‚ä½†å¯¹äºå®ç°é”è¿™ç§ç‰¹æ®Šç»“æ„ï¼Œæˆ‘ä»¬æ¸…æ¥šåªæœ‰è·å–é”åæ‰ä¼šç‹¬å æ•°æ®çš„è®¿é—®æƒï¼Œæ­¤æ—¶äº§ç”Ÿä¸€ä¸ªå¯å˜å¼•ç”¨æ˜¯å®‰å…¨çš„ã€‚ä¸ºäº†çªç ´ç¼–è¯‘å™¨çš„é™åˆ¶ï¼Œæˆ‘ä»¬éœ€è¦å€ŸåŠ© <code>std::cell::UnsafeCell</code>ã€‚</p><p><strong>UnsafeCell</strong> æ˜¯ Rust æä¾›çš„ä¸€ä¸ªå†…éƒ¨å¯å˜æ€§å·¥å…·ç±»å‹ï¼Œå®ƒåŒ…è£…ä¸€ä¸ªæ•°æ®ï¼Œä½¿å¾—å³ä½¿åœ¨åªæœ‰ä¸å¯å˜å¼•ç”¨çš„æƒ…å†µä¸‹ä¹Ÿå¯ä»¥è¿›è¡Œä¿®æ”¹ï¼ˆå½“ç„¶éœ€è¦åœ¨ <code>unsafe</code> å—ä¸­æ“ä½œï¼‰ã€‚å¾ˆå¤šçº¿ç¨‹åŒæ­¥åŸè¯­ï¼ˆæ¯”å¦‚ <code>Mutex</code>ã€<code>AtomicBool</code> è‡ªèº«ç­‰ï¼‰å†…éƒ¨éƒ½ç”¨ <code>UnsafeCell</code> æ¥å…è®¸å†…éƒ¨æ•°æ®çš„å¯å˜è®¿é—®ã€‚</p><p>æ ‡å‡†åº“ä¸­ï¼ŒåŸºäº <code>UnsafeCell&lt;T</code>&gt;ï¼Œå°è£…äº†ä¸€äº›æ»¡è¶³<strong>å†…éƒ¨å¯å˜æ€§</strong>çš„ç±»å‹ï¼š</p><ul><li><p><code>Cell&lt;T&gt;</code>: åªå…è®¸ Copy ç±»å‹ï¼Œé€šè¿‡ get()/set() æ“ä½œã€‚</p></li><li><p><code>RefCell&lt;T&gt;</code>: è¿è¡Œæ—¶å€Ÿç”¨æ£€æŸ¥ï¼Œä½†ä¸æ˜¯ Syncã€‚</p></li><li><p><code>Mutex&lt;T&gt;</code>: çº¿ç¨‹å®‰å…¨ï¼Œä½†æ€§èƒ½å¼€é”€å¤§ã€‚</p></li></ul><p>åŒæ—¶ä¹Ÿå› ä¸º <code>UnsafeCell&lt;T</code>&gt; å¹¶ä¸æ»¡è¶³ <code>Send</code> å’Œ <code>Sync</code> traitï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨ä¸ºå…¶å®ç°ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Send</span> <span class="keyword">for</span> <span class="title class_">SpinLock</span>&lt;T&gt; <span class="keyword">where</span> T: <span class="built_in">Send</span> &#123;&#125;</span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Sync</span> <span class="keyword">for</span> <span class="title class_">SpinLock</span>&lt;T&gt; <span class="keyword">where</span> T: <span class="built_in">Send</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¿®æ”¹æˆ‘ä»¬çš„æµ‹è¯•ç”¨ä¾‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line"><span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">one_thread_should_work</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">lock</span> = SpinLock::<span class="title function_ invoke__">new</span>(<span class="built_in">vec!</span>[]); <span class="comment">// ä¸´ç•Œèµ„æºåŒ…åœ¨é”é‡Œé¢äº†</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">data</span> = lock.<span class="title function_ invoke__">lock</span>();</span><br><span class="line">        data.<span class="title function_ invoke__">push</span>(<span class="number">1</span>); <span class="comment">// ä¸´ç•ŒåŒºä»£ç </span></span><br><span class="line">        lock.<span class="title function_ invoke__">unlock</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">data</span> = lock.<span class="title function_ invoke__">lock</span>();</span><br><span class="line">        <span class="built_in">print!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, data); <span class="comment">// ä¸´ç•ŒåŒºä»£ç </span></span><br><span class="line">        lock.<span class="title function_ invoke__">unlock</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">cross_thread_should_work</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">lock</span> = SpinLock::<span class="title function_ invoke__">new</span>(<span class="built_in">vec!</span>[]); <span class="comment">// ä¸´ç•Œèµ„æºåŒ…åœ¨é”é‡Œé¢äº†</span></span><br><span class="line">        thread::<span class="title function_ invoke__">scope</span>(|s| &#123;</span><br><span class="line">            s.<span class="title function_ invoke__">spawn</span>(|| &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">data1</span> = lock.<span class="title function_ invoke__">lock</span>();</span><br><span class="line">                data1.<span class="title function_ invoke__">push</span>(<span class="number">1</span>); <span class="comment">// ä¸´ç•ŒåŒºä»£ç </span></span><br><span class="line">                lock.<span class="title function_ invoke__">unlock</span>();</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">100</span>));</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">data2</span> = lock.<span class="title function_ invoke__">lock</span>();</span><br><span class="line">            data2.<span class="title function_ invoke__">push</span>(<span class="number">2</span>); <span class="comment">// ä¸´ç•ŒåŒºä»£ç </span></span><br><span class="line">            lock.<span class="title function_ invoke__">unlock</span>();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">data</span> = lock.<span class="title function_ invoke__">lock</span>();</span><br><span class="line">        <span class="built_in">print!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, data); <span class="comment">// ä¸´ç•ŒåŒºä»£ç </span></span><br><span class="line">        lock.<span class="title function_ invoke__">unlock</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç‰ˆæœ¬çš„æµ‹è¯•ç”¨ä¾‹ä¸­ï¼Œå¯¹äºä½¿ç”¨è€…æ¥è¯´ï¼Œå¾ˆæ˜æ˜¾å°±ç®€æ´å¾ˆå¤šäº†ï¼Œå†ä¹Ÿä¸éœ€è¦ä½¿ç”¨ <code>unsafe</code> è¿™ç§å±é™©å·¥å…·äº†ã€‚</p><h2 id="æœ€ç»ˆç‰ˆ-v2ï¼šå¼•å…¥-RAII-çš„è‡ªæ—‹é”å®ˆå«">æœ€ç»ˆç‰ˆ v2ï¼šå¼•å…¥ RAII çš„è‡ªæ—‹é”å®ˆå«</h2><p>v1 çš„å®ç°ä»ç„¶å­˜åœ¨éšæ‚£ï¼Œå®ƒè¦æ±‚è°ƒç”¨è€…ä¸¥æ ¼æŒ‰ç…§æ­£ç¡®çš„é¡ºåºä½¿ç”¨ã€‚æˆ‘ä»¬å¯ä»¥æƒ³è±¡ä¸€äº›è¯¯ç”¨åœºæ™¯ï¼š</p><ul><li><strong>å¿˜è®°è§£é”ï¼š</strong> å¦‚æœçº¿ç¨‹è·å¾—äº†é”å´æ²¡æœ‰è°ƒç”¨ <code>unlock()</code> å°±ç»“æŸäº†ï¼Œé‚£ä¹ˆé”å°†ä¸€ç›´ä¿æŒé”å®šçŠ¶æ€ï¼Œå¯¼è‡´å…¶ä»–çº¿ç¨‹æ°¸è¿œè‡ªæ—‹ç­‰å¾…ï¼Œæ— æ³•å‰è¿›ã€‚</li><li><strong>é‡å¤è§£é”ï¼š</strong> å¦‚æœè°ƒç”¨è€…ä¸å°å¿ƒå¯¹åŒä¸€ä¸ªé”è°ƒç”¨äº†ä¸¤æ¬¡ <code>unlock()</code>ï¼Œç¬¬äºŒæ¬¡è§£é”ä¼šå°†å¦ä¸€ä¸ªçº¿ç¨‹æŒæœ‰çš„é”è¯¯é‡Šæ”¾ï¼Œé€ æˆæ•°æ®åŒæ—¶è¢«ä¸¤ä¸ªçº¿ç¨‹è®¿é—®çš„é£é™©ã€‚</li><li><strong>æœªåŠ é”è®¿é—®ï¼š</strong> ç”±äºæˆ‘ä»¬æä¾›äº† <code>lock()</code> è¿”å› <code>&amp;mut T</code> çš„æ¥å£ï¼Œè°ƒç”¨è€…ç†è®ºä¸Šå¯ä»¥æŒæœ‰è¿™ä¸ªå¼•ç”¨ä¸æ”¾ï¼Œç„¶åè°ƒç”¨ <code>unlock()</code> è§£é”ã€‚è¿™æ ·ä¸€æ¥ï¼Œå°±å‡ºç°äº†ä¸€ä¸ªæ‚¬ç©ºå¼•ç”¨â€”â€”é”å·²ç»é‡Šæ”¾ä½†ä»æŒæœ‰å…ˆå‰çš„ <code>&amp;mut T</code>ï¼Œå¦‚æœæ­¤æ—¶å¦ä¸€çº¿ç¨‹åŠ é”å¹¶ä¿®æ”¹æ•°æ®ï¼Œä¸¤ä¸ªçº¿ç¨‹å°†åŒæ—¶æŒæœ‰å¯¹åŒä¸€æ•°æ®çš„å¯å˜å¼•ç”¨ï¼Œå‘ç”Ÿæ•°æ®ç«äº‰ï¼æ¢è¨€ä¹‹ï¼Œv1 çš„æ¥å£å¹¶ä¸èƒ½é˜²æ­¢è°ƒç”¨è€…è¿åâ€œå…ˆé”åç”¨ã€ç”¨å®Œè§£é”â€çš„çº¦å®šï¼ŒRust ç¼–è¯‘å™¨ä¹Ÿæ— æ³•å¸®æˆ‘ä»¬æ£€æŸ¥è¿™ç§é€»è¾‘é”™è¯¯ã€‚</li></ul><p>ç»¼ä¸Šï¼Œv1 å°½ç®¡æŠŠæ•°æ®å’Œé”ç»‘å®šåœ¨ä¸€èµ·ï¼Œä½†<strong>æ­£ç¡®ä½¿ç”¨ä»ç„¶å®Œå…¨ä¾èµ–ç¨‹åºå‘˜è‡ªè§‰</strong>ï¼Œç¨æœ‰ä¸æ…å°±å¯èƒ½å‡ºé”™ã€‚è¿™æ˜¾ç„¶ä¸ç¬¦åˆ Rust ä¸€è´¯çš„â€œç¼–è¯‘æœŸä¿è¯å®‰å…¨â€çš„ç†å¿µã€‚æœ‰æ²¡æœ‰åŠæ³•åœ¨<strong>ç¼–è¯‘é˜¶æ®µ</strong>å°±é˜²æ­¢ä¸Šè¿°è¯¯ç”¨å‘¢ï¼Ÿè¿™å°±æ˜¯æˆ‘ä»¬ä¸‹ä¸€æ­¥è¦åšçš„ï¼šå¼•å…¥ <strong>RAII</strong> æœºåˆ¶ï¼Œç”¨ Rust çš„æ‰€æœ‰æƒæ¥ç®¡ç†é”çš„è·å–å’Œé‡Šæ”¾ã€‚</p><blockquote><p>RAIIï¼ˆResource Acquisition Is Initializationï¼Œèµ„æºè·å–å³åˆå§‹åŒ–ï¼‰æ˜¯ C++/Rust ä¸­çš„æ ¸å¿ƒç¼–ç¨‹èŒƒå¼ï¼Œé€šè¿‡å°†èµ„æºçš„ç”Ÿå‘½å‘¨æœŸä¸å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸç»‘å®šï¼Œå®ç°èµ„æºçš„è‡ªåŠ¨ç®¡ç†ã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š<strong>åœ¨å¯¹è±¡æ„é€ å‡½æ•°ä¸­è·å–èµ„æºï¼Œåœ¨ææ„å‡½æ•°ä¸­é‡Šæ”¾èµ„æº</strong>ï¼Œç¡®ä¿èµ„æºåœ¨ä»»ä½•æƒ…å†µä¸‹ï¼ˆåŒ…æ‹¬å¼‚å¸¸ï¼‰éƒ½èƒ½è¢«æ­£ç¡®é‡Šæ”¾ã€‚</p></blockquote><p>è¿™ä¸ªæ—¶å€™ï¼Œ<code>Guard</code> å°±å¯ä»¥ç™»åœºäº†ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒæ ‡å‡†åº“ä¸€æ ·ï¼Œåœ¨ <code>lock</code> çš„æ—¶å€™è¿”å›ä¸€ä¸ª <code>Guard</code>ï¼Œå½“è¿™ä¸ª <code>Guard</code> ç¦»å¼€ä½œç”¨åŸŸçš„æ—¶å€™ï¼Œå®ƒçš„ <code>drop</code> å°±ä¼šè¢«è°ƒç”¨ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨é‡Œé¢ï¼Œæ‰§è¡Œ <code>unlock</code> æ“ä½œï¼Œè¿™æœ‰ 2 ä¸ªå¥½å¤„ï¼š</p><ol><li><code>drop(guard)</code> æ˜¯è¦æ¶ˆè€—æ‰€æœ‰æƒçš„ï¼Œæ‰€ä»¥å¯ä»¥é¿å…é‡å¤é‡Šæ”¾é”ï¼›</li><li><code>drop(guard)</code> åœ¨å˜é‡ç¦»å¼€ä½œç”¨åŸŸåä¼šè¢«è‡ªåŠ¨è°ƒç”¨ï¼Œæ‰€ä»¥å¯ä»¥é¿å…å¿˜è®°é‡Šæ”¾é”çš„æƒ…å†µå‘ç”Ÿã€‚</li></ol><p>æ›´æ–°åçš„ç‰ˆæœ¬å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">SpinLock</span>&lt;T&gt; &#123;</span><br><span class="line">    locked: AtomicBool,</span><br><span class="line">    value: UnsafeCell&lt;T&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">SpinLockGuard</span>&lt;<span class="symbol">&#x27;a</span>, T&gt; &#123;</span><br><span class="line">    lock: &amp;<span class="symbol">&#x27;a</span> SpinLock&lt;T&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Send</span> <span class="keyword">for</span> <span class="title class_">SpinLock</span>&lt;T&gt; <span class="keyword">where</span> T: <span class="built_in">Send</span> &#123;&#125;</span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Sync</span> <span class="keyword">for</span> <span class="title class_">SpinLock</span>&lt;T&gt; <span class="keyword">where</span> T: <span class="built_in">Send</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; SpinLock&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(value: T) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            locked: AtomicBool::<span class="title function_ invoke__">new</span>(<span class="literal">false</span>),</span><br><span class="line">            value: UnsafeCell::<span class="title function_ invoke__">new</span>(value),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">lock</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> SpinLockGuard&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">self</span>.locked.<span class="title function_ invoke__">swap</span>(<span class="literal">true</span>, Ordering::Acquire) &#123;</span><br><span class="line">            std::hint::<span class="title function_ invoke__">spin_loop</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        SpinLockGuard::<span class="title function_ invoke__">new</span>(&amp;<span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;<span class="symbol">&#x27;a</span>, T&gt; SpinLockGuard&lt;<span class="symbol">&#x27;a</span>, T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(lock: &amp;<span class="symbol">&#x27;a</span> SpinLock&lt;T&gt;) <span class="punctuation">-&gt;</span> SpinLockGuard&lt;<span class="symbol">&#x27;a</span>, T&gt; &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123; lock &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Drop</span> <span class="keyword">for</span> <span class="title class_">SpinLockGuard</span>&lt;<span class="symbol">&#x27;_</span>, T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">      <span class="comment">// é‡Šæ”¾é”ã€‚</span></span><br><span class="line">        <span class="keyword">self</span>.lock.locked.<span class="title function_ invoke__">store</span>(<span class="literal">false</span>, Ordering::Release);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Deref <span class="keyword">for</span> <span class="title class_">SpinLockGuard</span>&lt;<span class="symbol">&#x27;_</span>, T&gt; &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Target</span> = T;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">deref</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="keyword">Self</span>::Target &#123;</span><br><span class="line">        <span class="comment">// Safety: è¿™é‡Œæˆ‘ä»¬å·²ç»æ‹¿åˆ°é”ï¼ˆSpinLockGuardï¼‰äº†ï¼Œ</span></span><br><span class="line">        <span class="comment">// æ‰€ä»¥å¯ä»¥ç¡®ä¿æ•°æ®çš„å­˜åœ¨ä¸”ç‹¬å çš„ã€‚</span></span><br><span class="line">        <span class="keyword">unsafe</span> &#123; &amp;*<span class="keyword">self</span>.lock.value.<span class="title function_ invoke__">get</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; DerefMut <span class="keyword">for</span> <span class="title class_">SpinLockGuard</span>&lt;<span class="symbol">&#x27;_</span>, T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">deref_mut</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="keyword">mut</span> <span class="keyword">Self</span>::Target &#123;</span><br><span class="line">        <span class="comment">// Safety: è¿™é‡Œæˆ‘ä»¬å·²ç»æ‹¿åˆ°é”ï¼ˆSpinLockGuardï¼‰äº†ï¼Œ</span></span><br><span class="line">        <span class="comment">// æ‰€ä»¥å¯ä»¥ç¡®ä¿æ•°æ®çš„å­˜åœ¨ä¸”ç‹¬å çš„ã€‚</span></span><br><span class="line">        <span class="keyword">unsafe</span> &#123; &amp;<span class="keyword">mut</span> *<span class="keyword">self</span>.lock.value.<span class="title function_ invoke__">get</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>æˆ‘ä»¬å¼•å…¥äº†ç±»å‹ <code>SpinLockGuard</code>ï¼Œå®ƒåŒ…å«äº†ä¸€ä¸ª <code>SpinLock</code> çš„å¼•ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç”¨ç”Ÿå‘½å‘¨æœŸ <code>'a</code> è¿›è¡Œæ ‡æ³¨ã€‚</li><li><code>SpinLock</code> åœ¨ <code>lock()</code> æˆåŠŸæ—¶ï¼Œè¿”å›ä¸€ä¸ª <code>SpinLockGuard</code>ã€‚</li><li>æˆ‘ä»¬ä¸º <code>SpinLockGuard</code> å®ç° <code>drop</code> traitï¼Œè®©å…¶åœ¨è¢« drop æ—¶è‡ªåŠ¨æ‰§è¡Œ <code>unlock</code>ï¼Œè¿™æ ·å°±å®ç°äº†ç¦»å¼€ä½œç”¨åŸŸè‡ªåŠ¨ unlock çš„åŠŸèƒ½ã€‚</li><li>åŒæ—¶ä¸ºäº†æ“ä½œæ•°æ®çš„ç®€å•æ€§ï¼Œæˆ‘ä»¬ä¸º <code>SpinLockGuard</code> å®ç°äº† <code>Deref</code> å’Œ <code>DerefMut</code> è¿™ 2 ä¸ª traitã€‚</li></ol><p>ä¿®æ”¹ä¸€ä¸‹æˆ‘ä»¬çš„æµ‹è¯•ä»£ç ï¼Œå¯ä»¥å‘ç°æ›´åŠ ç®€æ´äº†ï¼ŒåŒæ—¶æœ‰ç¼–è¯‘å™¨çš„ä¿æŠ¤ï¼Œæˆ‘ä»¬æƒ³çŠ¯é”™éƒ½éš¾äº†ï¼</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">one_thread_should_work</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">lock</span> = SpinLock::<span class="title function_ invoke__">new</span>(<span class="built_in">vec!</span>[]);  <span class="comment">// ä¸´ç•Œèµ„æºåŒ…åœ¨é”é‡Œé¢äº†</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">data</span> = lock.<span class="title function_ invoke__">lock</span>();</span><br><span class="line">        data.<span class="title function_ invoke__">push</span>(<span class="number">1</span>); <span class="comment">// ä¸´ç•Œä»£ç åŒº</span></span><br><span class="line">        <span class="title function_ invoke__">drop</span>(data); <span class="comment">// ä¸»åŠ¨è°ƒç”¨ drop é‡Šæ”¾é”ã€‚</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">data</span> = lock.<span class="title function_ invoke__">lock</span>();</span><br><span class="line">        <span class="built_in">print!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, *data);</span><br><span class="line">      <span class="comment">// ç¦»å¼€ä½œç”¨åŸŸåï¼Œè¿™é‡Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨è°ƒç”¨ drop(data) é‡Šæ”¾é”ã€‚</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">cross_thread_should_work</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">lock</span> = SpinLock::<span class="title function_ invoke__">new</span>(<span class="built_in">vec!</span>[]);  <span class="comment">// ä¸´ç•Œèµ„æºåŒ…åœ¨é”é‡Œé¢äº†</span></span><br><span class="line">        thread::<span class="title function_ invoke__">scope</span>(|s| &#123;</span><br><span class="line">            s.<span class="title function_ invoke__">spawn</span>(|| &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">data1</span> = lock.<span class="title function_ invoke__">lock</span>();</span><br><span class="line">                data1.<span class="title function_ invoke__">push</span>(<span class="number">1</span>); <span class="comment">// ä¸´ç•Œä»£ç åŒº</span></span><br><span class="line">              <span class="comment">// data1 ç¦»å¼€ä½œç”¨åŸŸï¼Œè‡ªåŠ¨è°ƒç”¨ drop(data1)ï¼Œé‡Šæ”¾é”ã€‚</span></span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">100</span>));</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">data2</span> = lock.<span class="title function_ invoke__">lock</span>();</span><br><span class="line">            data2.<span class="title function_ invoke__">push</span>(<span class="number">2</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">data</span> = lock.<span class="title function_ invoke__">lock</span>();</span><br><span class="line">        <span class="built_in">print!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, *data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“">æ€»ç»“</h2><p>æ€»ç»“ä¸€ä¸‹ï¼Œåœ¨æœ¬å®æˆ˜ç¯‡ä¸­ï¼Œæˆ‘ä»¬ä»æœ€åˆç®€å•çš„åŸå­æ ‡å¿—é”å‡ºå‘ï¼Œé€æ­¥æ¼”è¿›ï¼Œæœ€ç»ˆå®ç°äº†ä¸€ä¸ªæ‹¥æœ‰ RAII æœºåˆ¶çš„è‡ªæ—‹é” <code>SpinLock</code>ã€‚è®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹è¿™ä¸ªè‡ªæ—‹é”çš„ç‰¹ç‚¹ï¼š</p><ul><li><strong>å¿™ç­‰å¾…å®ç°ï¼š</strong> ä½¿ç”¨åŸå­å˜é‡å’Œå¾ªç¯å®ç°é”çš„äº‰ç”¨ç­‰å¾…ï¼Œè€Œä¸æ¶‰åŠçº¿ç¨‹ä¼‘çœ ã€‚è¿™æ ·åšåœ¨ä¸´ç•ŒåŒºå¾ˆçŸ­æ—¶å¯ä»¥çœå»çº¿ç¨‹åˆ‡æ¢çš„å¼€é”€ï¼Œä½†å¦‚æœé”æŒæœ‰æ—¶é—´è¾ƒé•¿ï¼Œä¼šæµªè´¹å¤§é‡ CPU æ—¶é—´ã€‚å› æ­¤ï¼Œæœ¬å®ç°é€‚åˆåœ¨<strong>çŸ­ä¸´ç•ŒåŒº</strong>æˆ–è€…<strong>æ— æ“ä½œç³»ç»Ÿ</strong>ç¯å¢ƒï¼ˆå¦‚å†…æ ¸/ä¸­æ–­ä¸Šä¸‹æ–‡ï¼‰ä½¿ç”¨ã€‚</li><li><strong>RAII ä¿è¯è§£é”ï¼š</strong> é€šè¿‡å¼•å…¥ <code>SpinLockGuard</code> å®ˆå«å¹¶å®ç° <code>Drop</code>ï¼Œæˆ‘ä»¬å°†è§£é”æ“ä½œè‡ªåŠ¨åŒ–ã€‚å¼€å‘è€…æ— é¡»æ˜¾å¼è°ƒç”¨è§£é”å‡½æ•°ï¼Œé¿å…äº†å› é—å¿˜æˆ–å¼‚å¸¸è·¯å¾„å¯¼è‡´çš„æ­»é”ã€‚åŒæ—¶ä¹Ÿé˜²æ­¢äº†åŒé‡è§£é”çš„å‘ç”Ÿâ€”â€”åŒä¸€æŠŠé”åªæœ‰ä¸€ä¸ªå®ˆå«ï¼ŒRust ä¸å…è®¸å®ˆå«è¢«æ„å¤–å¤åˆ¶æˆ–é‡å¤é‡Šæ”¾ã€‚</li><li><strong>é”ä¸æ•°æ®ç»‘å®šï¼š</strong> è‡ªæ—‹é”å†…éƒ¨ç›´æ¥æŒæœ‰è¢«ä¿æŠ¤çš„æ•°æ®ï¼Œå¹¶é€šè¿‡ç±»å‹ç³»ç»Ÿå°†ä¸¤è€…å…³è”ã€‚ä»»ä½•å¯¹æ•°æ®çš„è®¿é—®éƒ½å¿…é¡»ç»ç”±è‡ªæ—‹é”æä¾›çš„æ–¹æ³•ï¼Œè¿™ä½¿â€œæœªåŠ é”å°±è®¿é—®æ•°æ®â€åœ¨è¯­æ³•ä¸Šå˜å¾—ä¸å¯èƒ½ï¼ˆå¦åˆ™æ— æ³•æ‹¿åˆ°æ•°æ®çš„å¼•ç”¨ï¼‰ã€‚</li><li><strong>ç¼–è¯‘æœŸå¹¶å‘æ£€æŸ¥ï¼š</strong> åˆ©ç”¨ Rust çš„æ‰€æœ‰æƒå’Œå€Ÿç”¨è§„åˆ™ï¼Œæˆ‘ä»¬å®ç°äº†<strong>ä¸€å®šç¨‹åº¦çš„ç¼–è¯‘æœŸå¹¶å‘å®‰å…¨æ£€æŸ¥</strong>ã€‚åªè¦ä»£ç ç¼–è¯‘é€šè¿‡ï¼Œå°±å·²ç»é¿å…äº†ç»å¤§å¤šæ•°å¸¸è§å¹¶å‘é”™è¯¯ï¼ˆæ•°æ®ç«äº‰ã€æœªè§£é”ç­‰ï¼‰ã€‚å½“ç„¶ï¼Œè¿™ä¸æ„å‘³ç€å¯ä»¥é«˜æ•æ— å¿§ï¼Œæˆ‘ä»¬ä»éœ€æ³¨æ„é¿å…æ­»é”ç­‰é€»è¾‘é—®é¢˜ï¼Œä½† Rust ä¼šæä¾›æœ€å¤§ç¨‹åº¦çš„å¸®åŠ©ã€‚</li></ul><p>åŒæ—¶ï¼Œæˆ‘ä»¬æ›´è¿›ä¸€æ­¥åœ°ç†è§£åŸå­å˜é‡å’Œå†…å­˜é¡ºåºçš„åº”ç”¨ï¼Œä¹Ÿç»“è¯†äº†ä¸€ä¸ªæ–°çš„æœ‹å‹ <code>UnsafeCell</code>ï¼Œå®ƒæ˜¯ Rust ä¸­åŒæ­¥åŸè¯­çš„åŸºç¡€ï¼Œåé¢æˆ‘ä»¬è¿˜ä¼šç»å¸¸è§åˆ°ã€‚</p><p>ä¸‹ç¯‡æˆ‘ä»¬å°†å°è¯•å®ç°ä¸€ä¸ªéå¸¸å®ç”¨çš„å·¥å…·ï¼š<code>oneshot-channel</code>ï¼ˆä¸€æ¬¡æ€§é€šé“ï¼‰ï¼Œæ•¬è¯·æœŸå¾…ï¼</p><p>Happy Coding! Peace~</p>]]></content>
    
    
    <summary type="html">æœ¬æ–‡ä»¥ä¸‰æ®µè¿­ä»£ç¤ºä¾‹æ¼”ç¤ºå¦‚ä½•åœ¨ Rust ä¸­æ‰‹å†™è‡ªæ—‹é”ï¼šä»æœ€å°åŒ–åŸå­æ ‡å¿—å®ç°ï¼Œåˆ°ç»‘å®šå—ä¿æŠ¤æ•°æ®ï¼Œå†åˆ°å€ŸåŠ© RAII å®ç°è‡ªåŠ¨è§£é”ã€‚è¿‡ç¨‹ä¸­æ·±å…¥è®²è§£ Atomic å†…å­˜é¡ºåºã€UnsafeCell å†…éƒ¨å¯å˜æ€§ã€Send/Sync å¹¶å‘æ ‡è®°ï¼Œä»¥åŠ Drop/Deref é›¶æˆæœ¬æŠ½è±¡ï¼Œå¸®åŠ©è¯»è€…ç†è§£è‡ªæ—‹é”é€‚ç”¨åœºæ™¯ä¸æ½œåœ¨é™·é˜±ï¼Œå¹¶æŒæ¡å°†å¹¶å‘å®‰å…¨é—®é¢˜å‰ç§»åˆ°ç¼–è¯‘æœŸçš„å·¥ç¨‹æ€ç»´ã€‚</summary>
    
    
    
    <category term="rust" scheme="https://hedon.top/categories/rust/"/>
    
    <category term="rust å®æˆ˜" scheme="https://hedon.top/categories/rust/rust-%E5%AE%9E%E6%88%98/"/>
    
    
    <category term="rust" scheme="https://hedon.top/tags/rust/"/>
    
    <category term="å¹¶å‘ç¼–ç¨‹" scheme="https://hedon.top/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>RAG æŠ€æœ¯æ¦‚è§ˆ</title>
    <link href="https://hedon.top/2025/04/13/ai-rag-tech-overview/"/>
    <id>https://hedon.top/2025/04/13/ai-rag-tech-overview/</id>
    <published>2025-04-13T14:23:22.000Z</published>
    <updated>2025-06-05T00:39:21.819Z</updated>
    
    <content type="html"><![CDATA[<p>RAG çš„æ•´ä¸ªæµç¨‹å¯æ¦‚æ‹¬ä¸ºå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸»è¦åˆ†æˆ<strong>ç´¢å¼•</strong>ã€<strong>æ£€ç´¢</strong>å’Œ<strong>ç”Ÿæˆ</strong>ä¸‰ä¸ªéƒ¨åˆ†ã€‚</p><p>æœ¬æ–‡æä¾›é…å¥—çš„å®Œæ•´æ¡ˆä¾‹ï¼Œæºç å¯å‚è€ƒï¼š<a href="https://github.com/hedon-ai-road/rag-demo">hedon-ai-road/rag-demo</a>ï¼Œæ¯ä¸ª commit éƒ½å¼•å…¥äº†ä¸€ä¸ªæ–°çš„æŠ€æœ¯ç‚¹ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯æ ¹æ® commit è®°å½•ä¸€ä¸€æŸ¥æ¢ã€‚</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250413223908403.png" alt=""></p><h2 id="æ–‡æ¡£è§£ææŠ€æœ¯">æ–‡æ¡£è§£ææŠ€æœ¯</h2><blockquote><p><a href="https://github.com/hedon-ai-road/rag-demo/commit/26d52ac964ca099e1726fccb5f4c18adc0fd940f#diff-b10564ab7d2c520cdd0243874879fb0a782862c3c902ab535faabe57d5a505e1">ä»£ç ç¤ºä¾‹</a></p></blockquote><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/c60419a3c73f3090651a4c2761e05583.png" alt=""></p><h3 id="PDF">PDF</h3><ul><li>åŸºäºè§„åˆ™çš„å¼€æºåº“<ul><li>pyPDF2</li><li>PyMuPDF</li><li>pdfminer</li><li>pdfplumber</li><li>papermage</li></ul></li><li>åŸºäºæ·±åº¦å­¦ä¹ çš„å¼€æºåº“<ul><li>Layout-parser</li><li>PP-StructureV2</li><li>PDF-Extract-Kit</li><li>pix2text</li><li>MinerU</li><li>marker</li><li>Gptpdfï¼ˆåŸºäº LLM APIï¼‰</li></ul></li><li>å•†ä¸šé—­æºåº“<ul><li><a href="http://Textln.com">Textln.com</a></li><li>Doc2x</li><li>mathpix</li><li>åº–ä¸ PDFlux</li><li>è…¾è®¯äº‘æ–‡æ¡£è¯†åˆ«</li></ul></li></ul><h2 id="åˆ†å—ç­–ç•¥">åˆ†å—ç­–ç•¥</h2><blockquote><p><a href="https://github.com/hedon-ai-road/rag-demo/commit/a26ae8895da7a9673660b31904857307a149c983">ä»£ç ç¤ºä¾‹</a></p><p><a href="https://chunkviz.up.railway.app/">åˆ†å—æ¼”ç¤ºå·¥å…·</a></p></blockquote><p>3 ä¸ªå…³é”®éƒ¨åˆ†ç»„æˆï¼š</p><ul><li>å¤§å°</li><li>é‡å </li><li>æ‹†åˆ†</li></ul><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/63b052c1b1639bfa66c23342cf28d9ef.jpg" style="zoom: 33%;" /><h3 id="å›ºå®šå¤§å°åˆ†å—ï¼ˆFixed-Size-Chunkingï¼‰">å›ºå®šå¤§å°åˆ†å—ï¼ˆFixed Size Chunkingï¼‰</h3><p>é€‚ç”¨åœºæ™¯ï¼š</p><ol><li>ä½œä¸ºåˆ†å—ç­–ç•¥çš„åŸºå‡†çº¿ï¼›</li><li>å¯¹å¤§å‹æ•°æ®é›†è¿›è¡Œåˆæ­¥åˆ†æï¼›</li><li>å®ç°ç®€å•ä¸”å¯è§‚æµ‹æ€§é«˜ï¼Œåˆ†å—ä¾¿äºç®¡ç†ï¼›</li><li>é€‚ç”¨äºæ ¼å¼å’Œå¤§å°ç›¸ä¼¼çš„åŒè´¨æ•°æ®é›†ï¼Œå¦‚æ–°é—»æ–‡ç« æˆ–åšå®¢æ–‡ç« ã€‚</li></ol><p>é—®é¢˜ï¼š</p><ol><li>ä¸è€ƒè™‘å†…å®¹ä¸Šä¸‹æ–‡ï¼Œå®¹æ˜“å¯¼è‡´æ— æ„ä¹‰çš„æ–‡æœ¬å—ï¼›</li><li>ç¼ºä¹çµæ´»æ€§ï¼Œæ— æ³•é€‚åº”æ–‡æœ¬çš„è‡ªç„¶ç»“æ„</li></ol><h3 id="é‡å åˆ†å—ï¼ˆOverlap-Chunkingï¼‰">é‡å åˆ†å—ï¼ˆOverlap Chunkingï¼‰</h3><p>ä½¿ç”¨åœºæ™¯ï¼š</p><ol><li>éœ€è¦æ·±å…¥ç†è§£è¯­ä¹‰å¹¶ä¿æŒä¸Šä¸‹æ–‡å®Œæ•´æ€§çš„æ–‡æ¡£ï¼Œå¦‚æ³•å¾‹æ–‡æ¡£ã€æŠ€æœ¯æ‰‹å†Œæˆ–ç§‘ç ”è®ºæ–‡ï¼›</li><li>æå‡åˆ†å—å†…å®¹çš„è¿è´¯æ€§ï¼Œä»¥æé«˜åˆ†æè´¨é‡ã€‚</li></ol><p>é—®é¢˜ï¼š</p><ol><li>è®¡ç®—å¤æ‚åº¦å¢åŠ ï¼Œå¤„ç†æ•ˆç‡é™ä½ï¼›</li><li>å†—ä½™ä¿¡æ¯çš„å­˜å‚¨å’Œç®¡ç†æˆä¸ºè´Ÿæ‹…ã€‚</li></ol><h3 id="é€’å½’åˆ†å—ï¼ˆRecursive-Chunkingï¼‰">é€’å½’åˆ†å—ï¼ˆRecursive Chunkingï¼‰</h3><ul><li>é€šè¿‡é¢„å®šä¹‰çš„æ–‡æœ¬åˆ†éš”ç¬¦ï¼ˆå¦‚æ¢è¡Œç¬¦ \n\nã€\nã€å¥å·ã€é€—å·ã€æ„Ÿå¹å·ã€ç©ºæ ¼ç­‰ï¼‰è¿­ä»£åœ°å°†æ–‡æœ¬åˆ†è§£ä¸ºæ›´å°çš„å—ï¼Œä»¥å®ç°æ®µå¤§å°çš„å‡åŒ€æ€§å’Œè¯­ä¹‰å®Œæ•´æ€§ã€‚</li><li>å…ˆæŒ‰è¾ƒå¤§çš„é€»è¾‘å•å…ƒåˆ†å‰²ï¼Œå†é€æ­¥é€’å½’åˆ°è¾ƒå°å•å…ƒï¼Œç¡®ä¿åœ¨åˆ†å—å¤§å°é™åˆ¶å†…ä¿ç•™æœ€å¼ºçš„è¯­ä¹‰ç‰‡æ®µã€‚</li></ul><p>ä½¿ç”¨åœºæ™¯ï¼š</p><ol><li>éœ€è¦é€å±‚åˆ†æçš„æ–‡æœ¬æ–‡æ¡£æˆ–éœ€è¦åˆ†è§£æˆé•¿ç‰‡æ®µã€é•¿æ®µè½çš„é•¿æ–‡æ¡£ï¼Œå¦‚ç ”ç©¶æŠ¥å‘Šã€æ³•å¾‹æ–‡æ¡£ç­‰ã€‚</li></ol><p>é—®é¢˜ï¼š</p><ol><li>åœ¨å—è¾¹ç•Œå¤„æ¨¡ç³Šè¯­ä¹‰ï¼Œå®¹æ˜“å°†å®Œæ•´çš„è¯­ä¹‰å•å…ƒåˆ‡åˆ†å¼€ã€‚</li></ol><h3 id="æ–‡æ¡£ç‰¹å®šåˆ†å—ï¼ˆDocument-Specific-Chunkingï¼‰">æ–‡æ¡£ç‰¹å®šåˆ†å—ï¼ˆDocument Specific Chunkingï¼‰</h3><ul><li>æ ¹æ®æ–‡æ¡£çš„æ ¼å¼ï¼ˆå¦‚ Markdownã€Latexã€æˆ–ç¼–ç¨‹è¯­è¨€å¦‚ Python ç­‰ï¼‰è¿›è¡Œå®šåˆ¶åŒ–åˆ†å‰²çš„æŠ€æœ¯ã€‚æ­¤æ–¹æ³•ä¾æ®æ–‡æ¡£çš„ç‰¹å®šæ ¼å¼å’Œç»“æ„è§„åˆ™ï¼Œä¾‹å¦‚ Markdown çš„æ ‡é¢˜ã€åˆ—è¡¨é¡¹ï¼Œæˆ– Python ä»£ç ä¸­çš„å‡½æ•°å’Œç±»å®šä¹‰ç­‰ï¼Œæ¥ç¡®å®šåˆ†å—è¾¹ç•Œã€‚</li></ul><p>é€‚ç”¨åœºæ™¯ï¼š</p><ol><li>æœ‰ç‰¹å®šçš„æ–‡æ¡£ç»“æ„ï¼Œå¦‚ç¼–ç¨‹è¯­è¨€ã€Markdownã€Latex ç­‰ç»“æ„æ–‡æ¡£ã€‚</li></ol><p>é—®é¢˜ï¼š</p><ol><li>æ ¼å¼ä¾èµ–æ€§å¼ºï¼Œä¸åŒæ ¼å¼ä¹‹é—´çš„åˆ†å—ç­–ç•¥ä¸é€šç”¨ï¼›</li><li>æ— æ³•å¤„ç†æ ¼å¼ä¸è§„èŒƒåŠæ··åˆå¤šç§æ ¼å¼çš„æƒ…å†µã€‚</li></ol><h3 id="è¯­ä¹‰åˆ†å—ï¼ˆSemantic-Chunkingï¼‰">è¯­ä¹‰åˆ†å—ï¼ˆSemantic Chunkingï¼‰</h3><ul><li>åŸºäºæ–‡æœ¬çš„è‡ªç„¶è¯­è¨€è¾¹ç•Œï¼ˆå¦‚å¥å­ã€æ®µè½æˆ–ä¸»é¢˜ä¸­æ–­ï¼‰è¿›è¡Œåˆ†æ®µçš„æŠ€æœ¯ï¼Œéœ€è¦ä½¿ç”¨ NLP æŠ€æœ¯æ ¹æ®è¯­ä¹‰åˆ†è¯åˆ†å¥ï¼Œæ—¨åœ¨ç¡®ä¿æ¯ä¸ªåˆ†å—éƒ½åŒ…å«è¯­ä¹‰è¿è´¯çš„ä¿¡æ¯å•å…ƒã€‚</li></ul><p>é€‚ç”¨åœºæ™¯ï¼š</p><ol><li>ç¡®ä¿æ¯ä¸ªæ–‡æ¡£å—çš„ä¿¡æ¯å®Œæ•´æ€§ä¸”è¯­ä¹‰è¿è´¯ï¼›</li><li>æé«˜æ£€ç´¢ç»“æœçš„ç›¸å…³æ€§å’Œå‡†ç¡®æ€§ï¼›</li><li>é€‚ç”¨äºå¤æ‚æ–‡æ¡£å’Œä¸Šä¸‹æ–‡æ•æ„Ÿçš„ç²¾ç»†åŒ–åˆ†æã€‚</li></ol><p>é—®é¢˜ï¼š</p><ol><li>éœ€è¦é¢å¤–çš„é«˜è®¡ç®—èµ„æºï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤§å‹æˆ–åŠ¨æ€å˜åŒ–çš„æ–‡æ¡£æ•°æ®æ—¶ï¼›</li><li>å¤„ç†æ•ˆç‡é™ä½ã€‚</li></ol><h3 id="æ··åˆåˆ†å—ï¼ˆMix-Chunkingï¼‰">æ··åˆåˆ†å—ï¼ˆMix Chunkingï¼‰</h3><ul><li>åœ¨åˆå§‹é˜¶æ®µä½¿ç”¨å›ºå®šé•¿åº¦åˆ†å—å¿«é€Ÿæ•´ç†å¤§é‡æ–‡æ¡£ï¼Œè€Œåœ¨åç»­é˜¶æ®µä½¿ç”¨è¯­ä¹‰åˆ†å—è¿›è¡Œæ›´ç²¾ç»†çš„åˆ†ç±»å’Œä¸»é¢˜æå–ã€‚æ ¹æ®å®é™…ä¸šåŠ¡åœºæ™¯ï¼Œè®¾è®¡å¤šç§åˆ†å—ç­–ç•¥çš„æ··åˆï¼Œèƒ½å¤Ÿçµæ´»é€‚åº”å„ç§éœ€æ±‚ï¼Œæä¾›æ›´å¼ºå¤§çš„åˆ†å—æ–¹æ¡ˆã€‚</li></ul><p>é€‚ç”¨åœºæ™¯ï¼š</p><ol><li>é€‚ç”¨äºå¤šå±‚æ¬¡çš„ç²¾ç»†åŒ–åˆ†å—åœºæ™¯ï¼›</li><li>æ•°æ®é›†åŠ¨æ€å˜åŒ–ï¼ŒåŒ…å«å¤šç§æ–‡æ¡£æ ¼å¼ä¸ç»“æ„ï¼›</li><li>å¹³è¡¡å¤„ç†é€Ÿåº¦ä¸å‡†ç¡®æ€§çš„åœºæ™¯ã€‚</li></ol><p>é—®é¢˜ï¼š</p><ol><li>å®ç°å¤æ‚åº¦é«˜ï¼›</li><li>ç­–ç•¥è°ƒä¼˜éš¾åº¦é«˜ï¼›</li><li>èµ„æºæ¶ˆè€—å¢åŠ ã€‚</li></ol><h2 id="Embedding-æŠ€æœ¯">Embedding æŠ€æœ¯</h2><ul><li>Embedding åµŒå…¥æ˜¯æŒ‡å°†æ–‡æœ¬ã€å›¾åƒã€éŸ³é¢‘ã€è§†é¢‘ç­‰å½¢å¼çš„ä¿¡æ¯æ˜ å°„ä¸ºé«˜ç»´ç©ºé—´ä¸­çš„å¯†é›†å‘é‡è¡¨ç¤ºã€‚è¿™äº›å‘é‡åœ¨è¯­ä¹‰ç©ºé—´ä¸­èµ·åˆ°åæ ‡çš„ä½œç”¨ï¼Œæ•æ‰å¯¹è±¡ä¹‹é—´çš„è¯­ä¹‰å…³ç³»å’Œéšå«çš„æ„ä¹‰ã€‚é€šè¿‡åœ¨å‘é‡ç©ºé—´ä¸­è¿›è¡Œè®¡ç®—ï¼ˆä¾‹å¦‚ä½™å¼¦ç›¸ä¼¼åº¦ï¼‰ï¼Œå¯ä»¥é‡åŒ–å’Œè¡¡é‡è¿™äº›å¯¹è±¡ä¹‹é—´çš„è¯­ä¹‰ç›¸ä¼¼æ€§ã€‚</li><li>å‘é‡æ£€ç´¢ï¼ˆVector Retrievalï¼‰æ˜¯ä¸€ç§åŸºäºå‘é‡è¡¨ç¤ºçš„æœç´¢æŠ€æœ¯ï¼Œé€šè¿‡è®¡ç®—æŸ¥è¯¢å‘é‡ä¸å·²çŸ¥æ–‡æœ¬å‘é‡çš„ç›¸ä¼¼åº¦æ¥è¯†åˆ«æœ€ç›¸å…³çš„æ–‡æœ¬æ•°æ®ã€‚å‘é‡æ£€ç´¢çš„é«˜æ•ˆæ€§åœ¨äºï¼Œå®ƒèƒ½åœ¨å¤§è§„æ¨¡æ•°æ®é›†ä¸­å¿«é€Ÿã€å‡†ç¡®åœ°æ‰¾åˆ°ä¸æŸ¥è¯¢æœ€ç›¸å…³çš„å†…å®¹ï¼Œè¿™å¾—ç›Šäºå‘é‡è¡¨ç¤ºä¸­è•´å«çš„ä¸°å¯Œè¯­ä¹‰ä¿¡æ¯ã€‚</li></ul><p>è¯„ä¼°æŒ‡æ ‡ï¼šï¼ˆMTEBã€C-MTEBï¼‰</p><ol><li>ç‰¹å®šé¢†åŸŸçš„é€‚ç”¨æ€§</li><li>æ£€ç´¢ç²¾åº¦</li><li>æ”¯æŒçš„è¯­è¨€</li><li>æ–‡æœ¬å—é•¿åº¦</li><li>æ¨¡å‹å¤§å°</li><li>æ£€ç´¢æ•ˆç‡</li></ol><h2 id="å‘é‡æ•°æ®åº“">å‘é‡æ•°æ®åº“</h2><blockquote><p><a href="https://github.com/hedon-ai-road/rag-demo/commit/1f9c07ec6b10d6bfdb55c17c2c6a7ad461b00ab2">ä»£ç ç¤ºä¾‹</a></p></blockquote><ul><li>å‘é‡æ•°æ®åº“æ˜¯ä¸€ç§ä¸“é—¨ç”¨äºå­˜å‚¨å’Œæ£€ç´¢å¤šç»´å‘é‡çš„æ•°æ®åº“ç±»å‹ï¼Œä¸ä¼ ç»Ÿçš„åŸºäºè¡Œåˆ—ç»“æ„çš„æ•°æ®åº“ä¸åŒï¼Œå®ƒä¸»è¦å¤„ç†é«˜ç»´ç©ºé—´ä¸­çš„æ•°æ®ç‚¹ã€‚</li><li>å‘é‡æ•°æ®åº“çš„æ“ä½œé€»è¾‘æ˜¯åŸºäºç›¸ä¼¼æ€§æœç´¢ï¼Œå³åœ¨æŸ¥è¯¢æ—¶ï¼Œåº”ç”¨ç‰¹å®šçš„ç›¸ä¼¼æ€§åº¦é‡ï¼ˆå¦‚ä½™å¼¦ç›¸ä¼¼åº¦ã€æ¬§å‡ é‡Œå¾—è·ç¦»ç­‰ï¼‰æ¥æŸ¥æ‰¾ä¸æŸ¥è¯¢å‘é‡æœ€ç›¸ä¼¼çš„å‘é‡ã€‚</li></ul><p>å‘é‡æ•°æ®åº“çš„æ ¸å¿ƒåœ¨äºå…¶é«˜æ•ˆçš„ç´¢å¼•å’Œæœç´¢æœºåˆ¶ã€‚ä¸ºäº†ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ï¼Œå®ƒé‡‡ç”¨äº†å¦‚å“ˆå¸Œã€é‡åŒ–å’ŒåŸºäºå›¾å½¢çš„å¤šç§ç®—æ³•ã€‚</p><ul><li>å±‚æ¬¡åŒ–å¯å¯¼èˆªå°ä¸–ç•Œï¼ˆ<strong>HNSW</strong>ï¼‰ï¼šé€šè¿‡åœ¨å¤šå±‚ç»“æ„ä¸­å°†ç›¸ä¼¼å‘é‡è¿æ¥åœ¨ä¸€èµ·ï¼Œå¿«é€Ÿç¼©å°æœç´¢èŒƒå›´ã€‚</li><li>äº§å“é‡åŒ–ï¼ˆ<strong>PQ</strong>ï¼‰ï¼šé€šè¿‡å‹ç¼©é«˜ç»´å‘é‡ï¼Œå‡å°‘å†…å­˜å ç”¨å¹¶åŠ é€Ÿæ£€ç´¢ã€‚</li><li>ä½ç½®æ•æ„Ÿå“ˆå¸Œï¼ˆ<strong>LSH</strong>ï¼‰ï¼šé€šè¿‡å“ˆå¸Œå‡½æ•°å°†ç›¸ä¼¼å‘é‡èšé›†åœ¨ä¸€èµ·ï¼Œä¾¿äºå¿«é€Ÿå®šä½ã€‚</li></ul><p>å‘é‡æ•°æ®åº“çš„å·¥ä½œæµç¨‹ï¼š</p><ol><li>æ•°æ®å¤„ç†ä¸å‘é‡åŒ–</li><li>å‘é‡å­˜å‚¨</li><li>å‘é‡ç´¢å¼•</li><li>å‘é‡æœç´¢<ul><li>ä½™å¼¦ç›¸ä¼¼åº¦ï¼šä¸»è¦ç”¨äºæ–‡æœ¬å¤„ç†å’Œä¿¡æ¯æ£€ç´¢ï¼Œå…³æ³¨å‘é‡ä¹‹é—´çš„è§’åº¦ï¼Œä»¥æ•æ‰è¯­ä¹‰ç›¸ä¼¼æ€§ã€‚</li><li>æ¬§å‡ é‡Œå¾—è·ç¦»ï¼šæµ‹é‡å‘é‡ä¹‹é—´çš„å®é™…è·ç¦»ï¼Œé€‚ç”¨äºå¯†é›†ç‰¹å¾é›†çš„èšç±»æˆ–åˆ†ç±»ã€‚</li><li>æ›¼å“ˆé¡¿è·ç¦»ï¼šé€šè¿‡è®¡ç®—ç¬›å¡å°”åæ ‡ä¸­çš„ç»å¯¹å·®å€¼ä¹‹å’Œï¼Œé€‚ç”¨äºç¨€ç–æ•°æ®çš„å¤„ç†ã€‚</li></ul></li><li>æ•°æ®æ£€ç´¢</li></ol><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/c27b4yy6748a414dae0c679835a1eccc.jpg" alt=""></p><h2 id="æ··åˆæ£€ç´¢">æ··åˆæ£€ç´¢</h2><blockquote><p><a href="https://github.com/hedon-ai-road/rag-demo/commit/38f1739c7ac1d3fc58023cb12bf863d3f502c419">ä»£ç ç¤ºä¾‹</a></p></blockquote><ul><li>æ··åˆæ£€ç´¢ï¼ˆHybrid Searchï¼‰é€šè¿‡ç»“åˆå…³é”®è¯æ£€ç´¢å’Œè¯­ä¹‰åŒ¹é…çš„ä¼˜åŠ¿ï¼Œå¯ä»¥é¦–å…ˆåˆ©ç”¨å…³é”®è¯æ£€ç´¢ç²¾ç¡®å®šä½åˆ°â€œè®¢å• 12345â€çš„ä¿¡æ¯ï¼Œç„¶åé€šè¿‡è¯­ä¹‰åŒ¹é…æ‰©å±•ä¸è¯¥è®¢å•ç›¸å…³çš„å…¶ä»–ä¸Šä¸‹æ–‡æˆ–å®¢æˆ·æ“ä½œçš„ä¿¡æ¯ï¼Œä¾‹å¦‚â€œ12 å¼€å¤´çš„è®¢å•ã€åŒ…è£…ç ´æŸä¸¥é‡â€ç­‰ã€‚è¿™æ ·ä¸ä»…èƒ½å¤Ÿè·å–ç²¾ç¡®çš„è®¢å•è¯¦æƒ…ï¼Œè¿˜èƒ½è·å¾—ä¸ä¹‹ç›¸å…³çš„é¢å¤–æœ‰ç”¨ä¿¡æ¯ã€‚</li></ul><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/7eddf214ee696b2e1f5977d72a4db134.jpg" alt=""></p><h2 id="é‡æ’åºæŠ€æœ¯">é‡æ’åºæŠ€æœ¯</h2><blockquote><p><a href="https://github.com/hedon-ai-road/rag-demo/commit/4837ef3220d177297169f28fbff5f52eaaee720e">ä»£ç ç¤ºä¾‹</a></p></blockquote><ul><li>é‡æ’åºæŠ€æœ¯ï¼ˆRerankingï¼‰é€šè¿‡å¯¹åˆå§‹æ£€ç´¢ç»“æœè¿›è¡Œé‡æ–°æ’åºï¼Œæ”¹å–„æ£€ç´¢ç»“æœçš„ç›¸å…³æ€§ï¼Œä¸ºç”Ÿæˆæ¨¡å‹æä¾›æ›´ä¼˜è´¨çš„ä¸Šä¸‹æ–‡ï¼Œä»è€Œæå‡æ•´ä½“ RAG ç³»ç»Ÿçš„æ•ˆæœã€‚</li><li>é‡æ’åºæ¨¡å‹å¤§å¤šæ˜¯åŸºäº<strong>åŒå¡”</strong>æˆ–<strong>äº¤å‰ç¼–ç æ¶æ„</strong>çš„æ¨¡å‹ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šè¿›ä¸€æ­¥è®¡ç®—æ›´ç²¾ç¡®çš„ç›¸å…³æ€§åˆ†æ•°ï¼Œèƒ½å¤Ÿæ•æ‰æŸ¥è¯¢è¯ä¸æ–‡æ¡£å—ä¹‹é—´æ›´ç»†è‡´çš„ç›¸å…³æ€§ï¼Œä»è€Œåœ¨ç»†èŠ‚å±‚é¢ä¸Šæé«˜æ£€ç´¢ç²¾åº¦ã€‚</li></ul><h2 id="æç¤ºå·¥ç¨‹">æç¤ºå·¥ç¨‹</h2><p>ä¸€ä¸ªæç¤ºï¼ˆpromptï¼‰é€šå¸¸åŒ…å«ä»¥ä¸‹å‡ ä¸ªå…ƒç´ ï¼š</p><ol><li><strong>æŒ‡ä»¤ï¼ˆInstructionï¼‰</strong>ï¼šæŒ‡æ˜æ¨¡å‹è¦æ‰§è¡Œçš„ç‰¹å®šä»»åŠ¡æˆ–æ“ä½œã€‚</li><li><strong>ä¸Šä¸‹æ–‡ï¼ˆContextï¼‰</strong>ï¼šä¸ºæ¨¡å‹æä¾›é¢å¤–ä¿¡æ¯æˆ–èƒŒæ™¯ï¼Œå¯ä»¥å¸®åŠ©å¼•å¯¼æ¨¡å‹ç”Ÿæˆæ›´å‡†ç¡®çš„å“åº”ã€‚</li><li><strong>è¾“å…¥æ•°æ®ï¼ˆInput Dataï¼‰</strong>ï¼šæˆ‘ä»¬å¸Œæœ›æ¨¡å‹å›ç­”çš„é—®é¢˜æˆ–æ„Ÿå…´è¶£çš„è¾“å…¥å†…å®¹ã€‚</li><li><strong>è¾“å‡ºæŒ‡ç¤ºç¬¦ï¼ˆOutput Indicatorï¼‰</strong>ï¼šæŒ‡å®šæ¨¡å‹çš„è¾“å‡ºç±»å‹æˆ–æ ¼å¼ï¼Œä¾‹å¦‚æ ¼å¼ã€æ˜¯å¦è¦ç”Ÿæˆä»£ç ã€æ€»ç»“æ–‡æœ¬æˆ–å›ç­”å…·ä½“é—®é¢˜ã€‚</li></ol><p>æ ¸å¿ƒæŠ€å·§ï¼š</p><ul><li><strong>å…·ä½“æŒ‡ä»¤æ³•</strong>ï¼šå…·ä½“ã€ç»†è‡´åœ°å‘Šè¯‰å¤§æ¨¡å‹è¦åšä»€ä¹ˆã€‚</li><li><strong>ç¤ºä¾‹å­¦ä¹ </strong>ï¼šç»™å‡ºå…·ä½“è¯¦å°½çš„æœŸæœ›ç¤ºä¾‹ã€‚</li><li><strong>é»˜è®¤å›å¤ç­–ç•¥</strong>ï¼šè®¾å®šé»˜è®¤å›å¤ç­–ç•¥ï¼Œé¿å…æ¨¡å‹äº§ç”Ÿâ€œå¹»è§‰â€ï¼Œè®©å®ƒä¸çŸ¥é“å°±è¯´ä¸çŸ¥é“ã€‚</li><li><strong>ä»»åŠ¡è§’è‰²è®¾å®š</strong>ï¼šè®¾å®šèº«ä»½ï¼Œå¯ä»¥å¸®åŠ©æ¨¡å‹æ›´å¥½åœ°ç†è§£ä»»åŠ¡è¦æ±‚å’Œè§’è‰²è´£ä»»ï¼Œä»è€Œè¾“å‡ºæ›´åŠ ä¸€è‡´ã€ä¸“ä¸šçš„å†…å®¹ã€‚</li><li><strong>è§£é‡Šç†ç”±æ³•</strong>ï¼šå‘æ¨¡å‹è§£é‡Šä¸ºä»€ä¹ˆæŸäº›ä»»åŠ¡éœ€è¦ç‰¹å®šçš„å¤„ç†æ–¹å¼ï¼Œå¸®åŠ©å…¶ç†è§£ä»»åŠ¡èƒŒæ™¯ã€‚</li><li><strong>æ–‡æ¡£åŸºç¡€è¯´æ˜</strong>ï¼šæä¾›æ–‡æ¡£çš„èƒŒæ™¯ä¿¡æ¯å’Œæ–‡æœ¬æ¥æºã€‚</li></ul><h2 id="ä¼˜åŒ–æŠ€æœ¯">ä¼˜åŒ–æŠ€æœ¯</h2><h3 id="æ•°æ®æ¸…æ´—å’Œé¢„å¤„ç†">æ•°æ®æ¸…æ´—å’Œé¢„å¤„ç†</h3><blockquote><p>åœ¨ RAG ç´¢å¼•æµç¨‹ä¸­ï¼Œæ–‡æ¡£è§£æä¹‹åã€æ–‡æœ¬å—åˆ‡åˆ†ä¹‹å‰ï¼Œè¿›è¡Œæ•°æ®æ¸…æ´—å’Œé¢„å¤„ç†èƒ½å¤Ÿæœ‰æ•ˆå‡å°‘è„æ•°æ®å’Œå™ªå£°ï¼Œæå‡æ–‡æœ¬çš„æ•´ä½“è´¨é‡å’Œä¿¡æ¯å¯†åº¦ã€‚</p><p>é€šè¿‡æ¸…é™¤å†—ä½™ä¿¡æ¯ã€ç»Ÿä¸€æ ¼å¼ã€å¤„ç†å¼‚å¸¸å­—ç¬¦ç­‰æ‰‹æ®µï¼Œæ•°æ®æ¸…æ´—å’Œé¢„å¤„ç†è¿‡ç¨‹ç¡®ä¿æ–‡æ¡£æ›´åŠ è§„èŒƒå’Œé«˜è´¨é‡ï¼Œä»è€Œæé«˜ RAG ç³»ç»Ÿçš„æ£€ç´¢æ•ˆæœå’Œä¿¡æ¯å‡†ç¡®æ€§ã€‚</p></blockquote><ul><li>å¤„ç†å†—ä½™çš„æ¨¡å‹å†…å®¹ã€‚</li><li>æ¶ˆé™¤æ–‡æ¡£ä¸­çš„é¢å¤–ç©ºç™½å’Œæ ¼å¼ä¸ä¸€è‡´ã€‚</li><li>å»é™¤æ— ç”¨çš„æ–‡æ¡£è„šæ³¨ã€é¡µçœ‰é¡µè„šã€ç‰ˆæƒä¿¡æ¯ã€‚</li></ul><h3 id="æŸ¥è¯¢æ‰©å±•">æŸ¥è¯¢æ‰©å±•</h3><blockquote><p>æŸ¥è¯¢æ‰©å±•ç­–ç•¥é€šè¿‡å¤§æ¨¡å‹ä»åŸå§‹æŸ¥è¯¢è¯­å¥ç”Ÿæˆå¤šä¸ªè¯­ä¹‰ç›¸å…³çš„æŸ¥è¯¢ï¼Œå¯ä»¥è¦†ç›–å‘é‡ç©ºé—´ä¸­çš„ä¸åŒåŒºåŸŸï¼Œä»è€Œæé«˜æ£€ç´¢çš„å…¨é¢æ€§å’Œå‡†ç¡®æ€§ã€‚</p></blockquote><p>æŸ¥è¯¢æ‰©å±•çš„æŒ‡ä»¤æ¨¡ç‰ˆï¼š</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ä½ æ˜¯ä¸€ä¸ªAIè¯­è¨€æ¨¡å‹åŠ©æ‰‹ã€‚</span><br><span class="line">ä½ çš„ä»»åŠ¡æ˜¯ç”Ÿæˆäº”ä¸ªä¸åŒç‰ˆæœ¬çš„ç”¨æˆ·é—®é¢˜ï¼Œä»¥ä¾¿ä»å‘é‡æ•°æ®åº“ä¸­æ£€ç´¢ç›¸å…³æ–‡æ¡£ã€‚</span><br><span class="line">é€šè¿‡ä»å¤šä¸ªè§’åº¦ç”Ÿæˆç”¨æˆ·é—®é¢˜ï¼Œä½ çš„ç›®æ ‡æ˜¯å¸®åŠ©ç”¨æˆ·å…‹æœåŸºäºè·ç¦»çš„ç›¸ä¼¼æ€§æœç´¢çš„ä¸€äº›å±€é™æ€§ã€‚</span><br><span class="line">è¯·å°†è¿™äº›æ›¿ä»£é—®é¢˜ç”¨æ¢è¡Œç¬¦åˆ†éš”ã€‚åŸå§‹é—®é¢˜ï¼š&#123;æŸ¥è¯¢åŸæ–‡&#125;</span><br></pre></td></tr></table></figure><p>å‡è®¾é—®é¢˜ï¼š</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ä¸‹é¢æŠ¥å‘Šä¸­æ¶‰åŠäº†å“ªå‡ ä¸ªè¡Œä¸šçš„æ¡ˆä¾‹ä»¥åŠæ€»ç»“å„è‡ªé¢ä¸´çš„æŒ‘æˆ˜ï¼Ÿ</span><br></pre></td></tr></table></figure><p>ç»“æœç¤ºä¾‹ï¼š</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">è¯·é—®æŠ¥å‘Šä¸­æåˆ°çš„æ¡ˆä¾‹æ¶‰åŠäº†å“ªäº›è¡Œä¸šï¼Ÿè¿™äº›è¡Œä¸šå„è‡ªé¢ä¸´çš„æŒ‘æˆ˜æœ‰å“ªäº›ï¼Ÿ</span><br><span class="line">æŠ¥å‘Šä¸­æœ‰å“ªäº›è¡Œä¸šçš„æ¡ˆä¾‹è¢«è®¨è®ºï¼Ÿæ¯ä¸ªè¡Œä¸šåœ¨æŠ¥å‘Šä¸­æè¿°çš„æŒ‘æˆ˜æ˜¯ä»€ä¹ˆï¼Ÿ</span><br><span class="line">è¿™ä¸ªæŠ¥å‘Šä¸­å…·ä½“æåˆ°äº†å“ªäº›è¡Œä¸šçš„æ¡ˆä¾‹ï¼Ÿèƒ½å¦æ€»ç»“ä¸€ä¸‹è¿™äº›è¡Œä¸šå½“å‰é¢ä¸´çš„ä¸»è¦æŒ‘æˆ˜ï¼Ÿ</span><br><span class="line">è¯¥æŠ¥å‘Šä¸­æ¶µç›–äº†å“ªäº›è¡Œä¸šæ¡ˆä¾‹ï¼Œå¹¶å¯¹å„è¡Œä¸šçš„æŒ‘æˆ˜è¿›è¡Œäº†å“ªäº›è®¨è®ºï¼Ÿ</span><br><span class="line">åœ¨æŠ¥å‘Šä¸­æåˆ°çš„è¡Œä¸šæ¡ˆä¾‹æœ‰å“ªäº›ï¼Ÿè¿™äº›è¡Œä¸šåˆ†åˆ«é‡åˆ°çš„ä¸»è¦é—®é¢˜å’ŒæŒ‘æˆ˜æ˜¯ä»€ä¹ˆï¼Ÿ</span><br></pre></td></tr></table></figure><p>é€šè¿‡è¿™ç§æŸ¥è¯¢æ‰©å±•ç­–ç•¥ï¼ŒåŸå§‹é—®é¢˜è¢«åˆ†è§£ä¸ºå¤šä¸ªå­æŸ¥è¯¢ï¼Œæ¯ä¸ªå­æŸ¥è¯¢ç‹¬ç«‹æ£€ç´¢ç›¸å…³æ–‡æ¡£å¹¶ç”Ÿæˆç›¸åº”çš„ç»“æœã€‚éšåï¼Œç³»ç»Ÿå°†æ‰€æœ‰å­æŸ¥è¯¢çš„æ£€ç´¢ç»“æœè¿›è¡Œåˆå¹¶å’Œé‡æ–°æ’åºï¼Œæ•ˆæœä¼šæ›´å…¨é¢æ›´å‡†ç¡®ã€‚</p><h3 id="è‡ªæŸ¥è¯¢">è‡ªæŸ¥è¯¢</h3><blockquote><p>è‡ªæŸ¥è¯¢ç­–ç•¥é€šè¿‡å¤§è¯­è¨€æ¨¡å‹è‡ªåŠ¨æå–æŸ¥è¯¢ä¸­å¯¹ä¸šåŠ¡åœºæ™¯è‡³å…³é‡è¦çš„å…ƒæ•°æ®å­—æ®µï¼ˆå¦‚æ ‡ç­¾ã€ä½œè€… IDã€è¯„è®ºæ•°é‡ç­‰å…³é”®ä¿¡æ¯ï¼‰ï¼Œå¹¶å°†è¿™äº›ä¿¡æ¯ç»“åˆåˆ°åµŒå…¥æ£€ç´¢è¿‡ç¨‹ä¸­ã€‚</p></blockquote><p>è‡ªæŸ¥è¯¢çš„æŒ‡ä»¤æ¨¡ç‰ˆï¼š</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ä½ æ˜¯ä¸€ä¸ªAIè¯­è¨€æ¨¡å‹åŠ©æ‰‹ã€‚</span><br><span class="line">ä½ çš„ä»»åŠ¡æ˜¯ä»ç”¨æˆ·é—®é¢˜ä¸­æå–å…³é”®ä¿¡æ¯ï¼Œä½ çš„å›å¤åº”ä»…åŒ…å«æå–çš„å…³é”®ä¿¡æ¯ã€‚</span><br><span class="line">ç”¨æˆ·é—®é¢˜ï¼š&#123;æŸ¥è¯¢åŸæ–‡&#125;</span><br></pre></td></tr></table></figure><p>å‡è®¾é—®é¢˜ï¼š</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ä¸‹é¢æŠ¥å‘Šä¸­æ¶‰åŠäº†å“ªå‡ ä¸ªè¡Œä¸šçš„æ¡ˆä¾‹ä»¥åŠæ€»ç»“å„è‡ªé¢ä¸´çš„æŒ‘æˆ˜ï¼Ÿ</span><br></pre></td></tr></table></figure><p>ç»“æœç¤ºä¾‹ï¼š</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">è¡Œä¸šï¼Œæ¡ˆä¾‹ï¼ŒæŒ‘æˆ˜</span><br></pre></td></tr></table></figure><h3 id="æç¤ºå‹ç¼©">æç¤ºå‹ç¼©</h3><blockquote><p>æç¤ºå‹ç¼©é€šè¿‡ç²¾ç®€ä¸Šä¸‹æ–‡ã€è¿‡æ»¤æ‰ä¸ç›¸å…³çš„ä¿¡æ¯ï¼Œç¡®ä¿ç³»ç»Ÿåªå¤„ç†ä¸æŸ¥è¯¢æœ€ç›¸å…³ã€æœ€é‡è¦çš„å†…å®¹ã€‚</p></blockquote><p>æç¤ºå‹ç¼©çš„æŒ‡ä»¤æ¨¡ç‰ˆï¼š</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ä½ æ˜¯ä¸€ä¸ªAIè¯­è¨€æ¨¡å‹åŠ©æ‰‹ï¼Œè´Ÿè´£å¯¹æ£€ç´¢åˆ°çš„æ–‡æ¡£è¿›è¡Œä¸Šä¸‹æ–‡å‹ç¼©ã€‚</span><br><span class="line">ä½ çš„ç›®æ ‡æ˜¯ä»æ–‡æ¡£ä¸­æå–ä¸ç”¨æˆ·æŸ¥è¯¢é«˜åº¦ç›¸å…³çš„æ®µè½ï¼Œå¹¶åˆ é™¤ä¸æŸ¥è¯¢æ— å…³æˆ–å™ªå£°è¾ƒå¤§çš„éƒ¨åˆ†ã€‚</span><br><span class="line">ä½ åº”ç¡®ä¿ä¿ç•™æ‰€æœ‰èƒ½å¤Ÿç›´æ¥å›ç­”ç”¨æˆ·æŸ¥è¯¢çš„é—®é¢˜æ ¸å¿ƒä¿¡æ¯ã€‚</span><br><span class="line"></span><br><span class="line">è¾“å…¥ï¼š</span><br><span class="line">ç”¨æˆ·æŸ¥è¯¢ï¼š&#123;ç”¨æˆ·çš„åŸå§‹æŸ¥è¯¢&#125;</span><br><span class="line">æ£€ç´¢åˆ°çš„æ–‡æ¡£ï¼š&#123;æ£€ç´¢åˆ°çš„æ–‡æ¡£å†…å®¹&#125;</span><br><span class="line"></span><br><span class="line">è¾“å‡ºè¦æ±‚ï¼š</span><br><span class="line">æå–ä¸ç”¨æˆ·æŸ¥è¯¢æœ€ç›¸å…³çš„æ®µè½å’Œä¿¡æ¯ã€‚</span><br><span class="line">åˆ é™¤æ‰€æœ‰ä¸æŸ¥è¯¢æ— å…³çš„å†…å®¹ï¼ŒåŒ…æ‹¬å™ªå£°ã€èƒŒæ™¯ä¿¡æ¯æˆ–æ‰©å±•è®¨è®ºã€‚</span><br><span class="line">å‹ç¼©åçš„å†…å®¹åº”ç®€æ´æ¸…æ™°ï¼Œç›´æŒ‡ç”¨æˆ·çš„æ ¸å¿ƒé—®é¢˜ã€‚</span><br><span class="line"></span><br><span class="line">è¾“å‡ºæ ¼å¼ï¼š</span><br><span class="line">&#123;å‹ç¼©æ®µè½1&#125;</span><br><span class="line">&#123;å‹ç¼©æ®µè½2&#125;</span><br><span class="line">&#123;å‹ç¼©æ®µè½3&#125;</span><br></pre></td></tr></table></figure><h2 id="RAG-æ•ˆæœè¯„ä¼°">RAG æ•ˆæœè¯„ä¼°</h2><ol><li>å¤§æ¨¡å‹æ‰“åˆ†ï¼šé€šè¿‡ LLM å¯¹ RAG çš„è¾“å‡ºè¿›è¡Œè‡ªåŠ¨è¯„åˆ†ã€‚æ•ˆç‡é«˜ï¼Œä½†æ˜¯å‡†ç¡®æ€§ä¸€èˆ¬ã€‚</li><li>äººå·¥æ‰“åˆ†ï¼šæ‰‹å·¥é’ˆå¯¹ RAG çš„è¾“å‡ºè¿›è¡Œé€ä¸€æ‰“åˆ†ã€‚æ›´ç²¾ç¡®ã€ç»†è‡´çš„åé¦ˆï¼Œæˆæœ¬é«˜ã€‚</li></ol><p>è¯„ä¼°æŒ‡æ ‡ï¼š</p><ol><li>**CRï¼ˆContext Relevancyï¼‰**æ£€ç´¢ç›¸å…³æ€§ï¼šæ£€ç´¢åˆ°çš„ä¿¡æ¯æ˜¯å¦åç¦»äº†åŸå§‹æŸ¥è¯¢ã€‚</li><li>**ARï¼ˆAnswer Relevancyï¼‰**ç­”æ¡ˆç›¸å…³æ€§ï¼šæ˜¯å¦èƒ½è§£å†³ç”¨æˆ·çš„é—®é¢˜ï¼Œä¸”å†…å®¹æ˜¯å¦é€»è¾‘è¿è´¯ã€‚</li><li>**Fï¼ˆFaithfulnessï¼‰**å¯ä¿¡åº¦ï¼šæ˜¯å¦å­˜åœ¨å¹»è§‰æˆ–ä¸å‡†ç¡®ä¹‹å¤„ã€‚</li></ol><p>æ‰“åˆ†æ ‡å‡†ï¼š</p><ol><li>å®Œç¾ï¼ˆPerfectï¼‰1.0 åˆ†</li><li>å¯æ¥å—ï¼ˆAcceptableï¼‰0.75 åˆ†</li><li>ç¼ºå¤±ï¼ˆMissingï¼‰0.5 åˆ†</li><li>é”™è¯¯ï¼ˆIncorrectï¼‰0.25 åˆ†</li></ol><h2 id="æ›´é«˜çº§çš„-RAG">æ›´é«˜çº§çš„ RAG</h2><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/7c3ebbe6ec9d9f2886881d7e534396a0.jpg" alt=""></p><h2 id="GraphRAG">GraphRAG</h2><p>GraphRAG é€šè¿‡æ„å»ºçŸ¥è¯†å›¾è°±ï¼Œå°†å®ä½“å’Œå®ä½“ä¹‹é—´çš„å…³ç³»ç»“æ„åŒ–åœ°è¡¨ç¤ºå‡ºæ¥ï¼Œå…‹æœäº†ä¼ ç»Ÿ RAG çš„å¤æ‚æ¨ç†å±€é™æ€§ã€‚</p><p>æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š</p><ol><li>æé«˜ç­”æ¡ˆçš„å‡†ç¡®æ€§å’Œå®Œæ•´æ€§</li><li>æé«˜æ•°æ®ç†è§£å’Œè¿­ä»£æ•ˆç‡</li><li>æå‡å¯è§£é‡Šæ€§å’Œå¯è¿½æº¯æ€§</li></ol><p>çŸ¥è¯†å›¾è°±çš„æ„å»ºæ­¥éª¤ï¼š</p><ol><li><strong>å®ä½“è¯†åˆ«</strong>ï¼šä»æ–‡æœ¬æˆ–æ•°æ®æºä¸­è¯†åˆ«å‡ºå…³é”®å®ä½“ã€‚</li><li><strong>å…³ç³»æŠ½å–</strong>ï¼šç¡®å®šå®ä½“ä¹‹é—´çš„å…³ç³»ï¼Œå¯èƒ½é€šè¿‡è‡ªç„¶è¯­è¨€å¤„ç†æŠ€æœ¯å®ç°ã€‚</li><li><strong>ä¸‰å…ƒç»„ç”Ÿæˆ</strong>ï¼šå°†å®ä½“å’Œå…³ç³»è¡¨ç¤ºä¸º (ä¸»ä½“ï¼Œå…³ç³»ï¼Œå®¢ä½“) çš„å½¢å¼ã€‚</li><li><strong>å›¾è°±å­˜å‚¨</strong>ï¼šä½¿ç”¨å›¾æ•°æ®åº“æˆ–ä¸“é—¨çš„å­˜å‚¨ç³»ç»Ÿä¿å­˜çŸ¥è¯†å›¾è°±ã€‚</li></ol><p>çŸ¥è¯†å›¾è°±çš„ä¸»è¦<strong>æˆæœ¬</strong>æŒ‘æˆ˜ï¼š</p><ol><li>æ•°æ®æ”¶é›†ä¸æ¸…æ´—æˆæœ¬</li><li>çŸ¥è¯†å›¾è°±æ„å»ºæˆæœ¬</li><li>å›¾è°±çš„ç»´æŠ¤ä¸æ›´æ–°</li></ol>]]></content>
    
    
    <summary type="html">æœ¬æ–‡æ˜¯åœ¨ç¬”è€…å­¦ä¹ äº†æå®¢æ—¶é—´ã€ŠRAG å¿«é€Ÿå¼€å‘å®æˆ˜ã€‹è¯¾ç¨‹åï¼Œå¯¹ RAG ç›¸å…³æŠ€æœ¯è¿›è¡Œä¸€ä¸ªæ¢³ç†å½’çº³ï¼Œå¸®åŠ©å¼€å‘è€…åœ¨ RAG å¼€å‘ä¸­è¿›è¡Œå¿«é€Ÿå®šä½ã€ç³»ç»Ÿå­¦ä¹ ã€‚</summary>
    
    
    
    <category term="ai" scheme="https://hedon.top/categories/ai/"/>
    
    <category term="rag" scheme="https://hedon.top/categories/ai/rag/"/>
    
    
    <category term="ai" scheme="https://hedon.top/tags/ai/"/>
    
    <category term="rag" scheme="https://hedon.top/tags/rag/"/>
    
  </entry>
  
  <entry>
    <title>è¯»ä¹¦ç¬”è®°ä¸¨ã€ŠUnit Testing Principles, Practices, and Patternsã€‹</title>
    <link href="https://hedon.top/2025/04/09/note-unit-testing/"/>
    <id>https://hedon.top/2025/04/09/note-unit-testing/</id>
    <published>2025-04-09T05:19:20.000Z</published>
    <updated>2025-04-15T16:25:59.245Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬ç¯‡åœ¨ä¸Šä¸€ç¯‡çš„åŸºç¡€ä¸Šï¼Œæ¢³ç†ä¸‹ç¬”è€…çš„ä¸ªäººè§è§£ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯å‚è€ƒåŸæ–‡å¯¹æ¯”é˜…è¯»ï¼š</p><div class="tag-plugin link dis-select"><a class="link-card plain" title="" href="https://hedon.top/2025/04/09/note-unit-testing-excerpt/" target="_blank" rel="external nofollow noopener noreferrer" cardlink api="https://site-info-api-hedon.vercel.app/api/v1?url=https://hedon.top/2025/04/09/note-unit-testing-excerpt/" autofill="title,icon"><div class="left"><span class="title">https://hedon.top/2025/04/09/note-unit-testing-excerpt/</span><span class="cap link footnote">https://hedon.top/2025/04/09/note-unit-testing-excerpt/</span></div><div class="right"><div class="lazy img" data-bg="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/link/8f277b4ee0ecd.svg"></div></div></a></div><div class="tag-plugin quot"><h2 class="content" id="æªå¿ƒç–‘æƒ‘" type="icon"><img class="icon prefix" src="https://bu.dusays.com/2022/10/24/63567d3e07da3.png" /><span class="text">æªå¿ƒç–‘æƒ‘</span><span class="empty"></span></h2></div><p>åœ¨æ’°å†™å•å…ƒæµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œä½ æ˜¯å¦æ›¾ç»è¢«ä»¥ä¸‹é—®é¢˜å›°æ‰°è¿‡ï¼Ÿ</p><ol><li>ä¸ºä»€ä¹ˆè¦å†™å•å…ƒæµ‹è¯•ï¼Ÿå•å…ƒæµ‹è¯•çš„ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>å•å…ƒæµ‹è¯•çš„ç²’åº¦æ˜¯æ€æ ·çš„ï¼Ÿä»€ä¹ˆå«å•å…ƒï¼Ÿa class, a function, or a behavior, or an observable behavior?</li><li>å•æµ‹è¦†ç›–ç‡çœŸçš„æœ‰ç”¨å—ï¼Ÿæœ‰ä»€ä¹ˆç”¨ï¼Ÿåˆæœ‰å“ªäº›é™åˆ¶ï¼Ÿ</li><li>æ€æ ·æ‰èƒ½å†™å¥½å•å…ƒæµ‹è¯•ï¼Ÿæ€æ ·æ‰èƒ½å†™å‡ºæ€§ä»·æ¯”æœ€é«˜çš„å•å…ƒæµ‹è¯•ï¼Ÿ</li><li>å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå•å…ƒæµ‹è¯•çš„å¥½åï¼Ÿæœ‰æ²¡æœ‰å…·ä½“å¯ä¾›å‚é˜…çš„ç»´åº¦ï¼Ÿ</li><li>å“ªäº›ä»£ç éœ€è¦å†™å•å…ƒæµ‹è¯•ï¼Œå“ªäº›ä»£ç æ²¡å¿…è¦å†™å•å…ƒæµ‹è¯•ï¼Ÿ</li><li>å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•çš„è¾¹ç•Œæ˜¯ä»€ä¹ˆï¼Ÿ</li><li>ï¼ˆå•å…ƒä¸¨é›†æˆï¼‰æµ‹è¯•åˆ°åº•æ˜¯è¦æµ‹ä»€ä¹ˆä¸œè¥¿ï¼Ÿ</li><li>å•å…ƒæµ‹è¯•çš„ä¾§é‡ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿé›†æˆæµ‹è¯•çš„ä¾§é‡ç‚¹æ˜¯ä»€ä¹ˆï¼ŸäºŒè€…çš„æ¯”ä¾‹è¯¥æ˜¯æ€æ ·çš„ï¼Ÿ</li><li>å¦‚ä½•ä½¿ç”¨ Mockï¼Ÿå“ªäº›ä¸œè¥¿æ˜¯éœ€è¦ Mock çš„ï¼Ÿå“ªäº›ä¸œè¥¿æ˜¯ä¸åº”è¯¥ Mock çš„ï¼Ÿéœ€è¦ Mock çš„ä¸œè¥¿ï¼Œåº”è¯¥åœ¨å“ªä¸ªå±‚æ¬¡è¿›è¡Œ Mockï¼Ÿï¼ˆä½ çš„ repository å±‚éœ€è¦ Mock å—ï¼Ÿï¼‰</li><li>ä¸ºä»€ä¹ˆä½ çš„æµ‹è¯•ä»£ç å¾ˆè„†å¼±ï¼Œæ€»æ˜¯éœ€è¦é¢‘ç¹ä¿®æ”¹ï¼Œç»´æŠ¤èµ·æ¥éš¾åº¦å¾ˆå¤§ï¼Ÿ</li><li>å¦‚ä½•å‡å°‘æµ‹è¯•ç»“æœçš„å‡é˜³æ€§å’Œå‡é˜´æ€§ï¼Ÿ</li></ol><div class="tag-plugin quot"><h2 class="content" id="å››æ ¹æŸ±å­" type="icon"><img class="icon prefix" src="https://bu.dusays.com/2022/10/24/63567d3e07da3.png" /><span class="text">å››æ ¹æŸ±å­</span><span class="empty"></span></h2></div><p>å¯¹äºç¬¬ 5 ä¸ªé—®é¢˜ï¼Œä½œè€…æå‡ºäº† 4 ä¸ªç»´åº¦ï¼š</p><ul><li><strong>Protection against regressionsï¼šé˜²æ­¢å›å½’</strong>ï¼Œé€šè¿‡è‡ªåŠ¨åŒ–éªŒè¯ä»£ç ä¿®æ”¹ååŸæœ‰åŠŸèƒ½ä¸å—ç ´åã€‚<ul><li><em>The amount of code that is executed during the test.</em></li><li><em>The complexity of that code.</em></li><li><em>The codeâ€™s domain significance.</em></li></ul></li><li><strong>Resistance to refactoringï¼šæŠ—é‡æ„æ€§</strong>ï¼Œé‡æ„ä¸šåŠ¡ä»£ç æ—¶ï¼Œæµ‹è¯•ä»£ç æ— éœ€è¿‡å¤šå˜åŠ¨ä¾¿å¯é€šè¿‡ç”¨ä¾‹ï¼Œè¯æ˜é‡æ„æ— è¯¯ã€‚<ul><li><em>Tests provide an early warning when you break existing functionality</em>.</li><li><em>You become confident that your code changes wonâ€™t lead to regressions</em>.</li></ul></li><li><strong>Fast feedbackï¼šå¿«é€Ÿåé¦ˆ</strong>ã€‚</li><li><strong>Maintainabilityï¼šå¯ç»´æŠ¤æ€§</strong>ã€‚<ul><li><em>How hard it is to understand the test.</em></li><li><em>How hard it is to run the test.</em></li></ul></li></ul><p>å¯¹äºè¿™ 4 ä¸ªé—®é¢˜ï¼Œä½ æ˜¯å¦åˆæœ‰ä»¥ä¸‹ç–‘é—®ï¼š</p><ol><li>å“ªä¸ªç»´åº¦æ˜¯æœ€é‡è¦çš„ï¼Ÿ</li><li>æ€æ ·æ‰èƒ½å†™å‡ºæ»¡è¶³å„ä¸ªç»´åº¦çš„æµ‹è¯•ä»£ç ï¼Ÿ</li><li>å¦‚æœç»´åº¦ä¹‹é—´å­˜åœ¨çŸ›ç›¾ï¼Œå¦‚ä½• trade offï¼Ÿ</li></ol><h2 id="ä¸ºä»€ä¹ˆè¦å†™å•å…ƒæµ‹è¯•ï¼Ÿ">ä¸ºä»€ä¹ˆè¦å†™å•å…ƒæµ‹è¯•ï¼Ÿ</h2><p>ä¸‰ä¸ªæœ€é‡è¦çš„åŸå› ï¼š</p><ol><li><p>éªŒè¯ä½ çš„ç¨‹åºé€»è¾‘æ­£ç¡®æ€§ã€‚</p></li><li><p>å¸¦æ¥æ›´å¥½çš„ä»£ç è®¾è®¡ã€‚</p><p>å› ä¸ºå•å…ƒæµ‹è¯•èƒ½å¤Ÿè®©ä½ ç«™åœ¨ä½¿ç”¨è€…çš„è§’åº¦å»ä½¿ç”¨æš´éœ²çš„æ¥å£ï¼Œå¦‚æœæ¥å£ä¸å¥½ç”¨ï¼Œé€»è¾‘ä¸å¥½æµ‹ï¼Œæµ‹è¯•æ¡ä»¶ä¸å¥½æ„å»ºï¼Œå¤§æ¦‚ç‡è¯´æ˜ä»£ç çš„è®¾è®¡æœ¬èº«æ˜¯æœ‰ç¼ºé™·çš„ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼šæŠ½è±¡ä¸åˆç†ã€é€»è¾‘åˆ’åˆ†ä¸æ¸…æ™°ã€ä¸å…¶ä»–æ¨¡å—è€¦åˆä¸¥é‡ç­‰ã€‚</p></li><li><p>ä½¿è½¯ä»¶é¡¹ç›®æ›´å¯æŒç»­å‘å±•ã€‚</p><p>å¦‚æœä½ çš„éœ€æ±‚æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œé‚£åŸæœ¬èƒ½è¿è¡Œé€šè¿‡çš„å•æµ‹åº”è¯¥ä¸€ç›´éƒ½èƒ½è¿è¡Œï¼Œè¿™æœ‰åŠ©äºé¿å…åœ¨å›¢é˜Ÿåä½œä¸­ä¸å°å¿ƒæ”¹åä½ ä¸çŸ¥é“çš„ä»£ç ï¼Œä¹Ÿæœ‰åŠ©äºä½ æ‰§è¡Œå„ç§é‡æ„æªæ–½ã€‚</p></li></ol><p>è¿™ä¸‰ä¸ªåŸå› çš„é‡è¦æ€§æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œä½†ç¬”è€…ä¸ªäººè§‰å¾—è¿˜æœ‰ä¸€ä¸ªæ›´æ·±å±‚æ¬¡çš„æœ€é‡è¦çš„åŸå› ï¼š</p><ul><li>ä½ è¦å¯¹ä½ åšçš„äº‹æƒ…è´Ÿè´£ï¼Œå¥½çš„ä»£ç ä¸€å®šè¦å…ˆè¿‡è‡ªå·±è¿™å…³ã€‚</li></ul><h2 id="å•å…ƒæµ‹è¯•çš„ç²’åº¦æ˜¯ä»€ä¹ˆï¼Ÿ">å•å…ƒæµ‹è¯•çš„ç²’åº¦æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>è¿™æ˜¯ä¸€ä¸ªå¾ˆæœ‰äº‰è®®çš„è¯é¢˜ï¼Œå•å…ƒæµ‹è¯•çš„ã€Œå•å…ƒã€åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ</p><ul><li>ä¸€ä¸ªç±»ï¼Ÿ</li><li>ä¸€ä¸ªå‡½æ•°ï¼Ÿ</li><li>è¿˜æ˜¯å¤šä¸ªç±»ç»„æˆçš„ä¸€ä¸ªæ¨¡å—ï¼Ÿ</li><li>è¿˜æ˜¯å¤šä¸ªå‡½æ•°ç»„æˆçš„ä¸€ä¸ªå¤§é€»è¾‘ï¼Ÿ</li></ul><p>åœ¨ã€ŠUnit Testingã€‹ä¹¦ä¸­ï¼Œä½œè€…æŒ‡å‡ºï¼š<strong>ã€Œå•å…ƒã€æŒ‡çš„æ˜¯ an observable behaviorï¼Œå³ä¸€ä¸ªå¤–éƒ¨ç³»ç»Ÿå¯è§‚æµ‹åˆ°çš„è¡Œä¸º</strong>ã€‚</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2010.png" alt=""></p><p>ä¸ºä»€ä¹ˆæ˜¯å¯è§‚æµ‹è¡Œä¸ºï¼š</p><ol><li>ä¸€ä¸ªå¸®åŠ©å®¢æˆ·ç«¯å®ç°ç›®æ ‡çš„æ“ä½œï¼ˆoperationï¼‰ã€‚</li><li>ä¸€ä¸ªå¸®åŠ©å®¢æˆ·ç«¯å®ç°ç›®æ ‡çš„çŠ¶æ€ï¼ˆstateï¼‰ã€‚</li></ol><p>æ¢è¨€ä¹‹ï¼Œä¹Ÿå°±æ˜¯æˆ‘åœ¨æ’°å†™å•å…ƒæµ‹è¯•çš„æ—¶å€™ï¼Œæˆ‘å°±æ˜¯åœ¨ä½¿ç”¨ç³»ç»Ÿæä¾›çš„èƒ½åŠ›ï¼Œæˆ‘å°±æ˜¯ä¸ªä½¿ç”¨è€…ï¼Œ æˆ‘åªè¦éªŒè¯ä½ èƒ½æä¾›æˆ‘è¦çš„åŠŸèƒ½ï¼Œå°± OK äº†ï¼Œä½ èƒŒåæ€ä¹ˆåšï¼Œä¸ºäº†è¿™ä¸ªåŠŸèƒ½æ‰€æ‹†åˆ†çš„ç±»ä¹Ÿå¥½ï¼Œå°çš„è¾…åŠ©å‡½æ•°ä¹Ÿå¥½ï¼Œéƒ½ä¸é‡è¦ï¼Œéƒ½ä¸å±äºæˆ‘è¦éªŒè¯çš„èŒƒç•´ã€‚</p><p>æ‰€ä»¥è¿™æ›´åƒæ˜¯é»‘ç›’æµ‹è¯•ï¼ˆblack-box testï¼‰ã€‚</p><p>å½“ç„¶ï¼Œä¼šæœ‰ä¾‹å¤–ï¼Œå¦‚æœä½ åº•å±‚æœ‰ä¸€ä¸ªç‰¹åˆ«ç‰¹åˆ«å¤æ‚çš„é€»è¾‘ï¼Œä½ æœ‰å¿…è¦ä¸“é—¨èŠ±ç²¾åŠ›å»éªŒè¯å®ƒçš„é€»è¾‘æ­£ç¡®æ€§ï¼Œé‚£æ˜¯å¯ä»¥é’ˆå¯¹å®ƒæ’°å†™ä¸“é—¨çš„ç™½ç›’æµ‹è¯•ï¼ˆwhite-box testï¼‰çš„ã€‚é’ˆå¯¹è¿™ä¸ªæƒ…å†µï¼Œä½œè€…å…¶å®ä¹Ÿæå‡ºäº†ä¸€ä¸ªè§‚ç‚¹ï¼Œå¯¹äºè¿™ä¸ªå¤æ‚çš„é€»è¾‘ï¼Œä¹Ÿå¯ä»¥æŠ½æˆä¸€ä¸ªå•ç‹¬çš„æ¨¡å—ï¼Œç”±å®ƒæ¥æä¾›èƒ½åŠ›ç»™ä½ å½“å‰æ¨¡å—ä½¿ç”¨ã€‚</p><p>æ€»ç»“ï¼š</p><ol><li>ä¼˜å…ˆé€‰æ‹©é»‘ç›’æµ‹è¯•ã€‚</li><li>å¯¹äºæ¶‰åŠå¤æ‚ç®—æ³•çš„é€»è¾‘ï¼Œå•ç‹¬æ’°å†™ç™½ç›’æµ‹è¯•ã€‚</li><li>ç»“åˆè¦†ç›–ç‡å·¥å…·å»çœ‹å“ªäº›ä»£ç æ²¡è¢«è¦†ç›–ï¼Œç„¶åå†ç«™åœ¨ä½¿ç”¨è€…çš„è§’åº¦å»æ€è€ƒä¸ºä»€ä¹ˆæ²¡è¢«è¦†ç›–ï¼Œæ˜¯è¿™ä¸ªåˆ†æ”¯å‹æ ¹æ²¡å¿…è¦å­˜åœ¨ï¼Œè¿˜æ˜¯è¿˜æœ‰æœªè€ƒè™‘åˆ°çš„ä½¿ç”¨åœºæ™¯ã€‚</li></ol><h2 id="å¦‚ä½•ç»„ç»‡å•å…ƒæµ‹è¯•ï¼Ÿ">å¦‚ä½•ç»„ç»‡å•å…ƒæµ‹è¯•ï¼Ÿ</h2><p>ä¸¤ç§ç»“æ„ï¼š</p><ul><li>AAA: Arrange-Act-Assert</li><li>GWT: Given-When-Then</li></ul><p>å…¶å®éƒ½æ˜¯ä¸€ä¸ªæ€è·¯ï¼šå‡†å¤‡å‰ç½®æ¡ä»¶â†’æ‰§è¡Œå¾…éªŒè¯ä»£ç â†’éªŒè¯é€»è¾‘æ­£ç¡®æ€§ã€‚</p><p>å‡ ä¸ªå»ºè®®ï¼š</p><ol><li>å°½é‡é¿å…ä¸€ä¸ªå•å…ƒæµ‹è¯•ä¸­åŒ…å«å¤šä¸ª  AAA/GWTã€‚</li><li>é¿å…åœ¨å•å…ƒæµ‹è¯•ä¸­ä½¿ç”¨ <code>if</code> ç­‰åˆ†æ”¯è¯­å¥ã€‚</li><li>å‘½åçš„æ—¶å€™ï¼Œå°½å¯èƒ½è®©éç¨‹åºå‘˜ä¹Ÿèƒ½çœ‹æ‡‚ï¼Œå³è¿™ä¸ªå‘½åéœ€è¦æè¿°ä¸€ä¸ªé¢†åŸŸé—®é¢˜ã€‚</li></ol><h2 id="å¦‚ä½•å‘æŒ¥å•æµ‹çš„æœ€å¤§ä»·å€¼ï¼Ÿ">å¦‚ä½•å‘æŒ¥å•æµ‹çš„æœ€å¤§ä»·å€¼ï¼Ÿ</h2><ol><li>å•å…ƒæµ‹è¯•ç”¨ä¾‹å¿…é¡»æŒç»­ä¸æ–­åå¤æ‰§è¡ŒéªŒè¯ã€‚</li><li>ç”¨æœ€å°çš„ç»´æŠ¤ä»£ä»·æä¾›æœ€å¤§ä»·å€¼çš„å•å…ƒæµ‹è¯•ã€‚<ol><li>è¯†åˆ«ä¸€ä¸ªæœ‰ä»·å€¼çš„æµ‹è¯•</li><li>æ’°å†™ä¸€ä¸ªæœ‰ä»·å€¼çš„æµ‹è¯•</li></ol></li><li>éªŒè¯ä»£ç ä¸­æœ€é‡è¦çš„éƒ¨åˆ†ï¼ˆé¢†åŸŸæ¨¡å‹ï¼‰ã€‚</li></ol><h3 id="1-å•å…ƒæµ‹è¯•ç”¨ä¾‹å¿…é¡»æŒç»­ä¸æ–­åå¤æ‰§è¡ŒéªŒè¯">1. å•å…ƒæµ‹è¯•ç”¨ä¾‹å¿…é¡»æŒç»­ä¸æ–­åå¤æ‰§è¡ŒéªŒè¯</h3><p>è¿™é‡Œæ¨èç¬”è€…çš„ä¸ªäººå®è·µï¼š</p><ul><li>åœ¨ <code>pre-commit</code> æ‰§è¡Œ<strong>å¢é‡å•å…ƒæµ‹è¯•</strong>ï¼Œç¡®ä¿æœ¬æ¬¡ä¿®æ”¹çš„ä»£ç æ¶‰åŠçš„å•æµ‹å¯æ­£ç¡®é€šè¿‡ã€‚</li><li>åœ¨ <code>gitlab-ci/github-action</code> æµç¨‹ä¸­æ‰§è¡Œ<strong>å…¨é‡å•å…ƒæµ‹è¯•</strong>ï¼Œå…¨é¢è¦†ç›–ï¼Œé¿å…æœ¬æ¬¡ä¿®æ”¹çš„ä»£ç å½±å“åˆ°å…¶ä»–æ¨¡å—çš„æ­£å¸¸åŠŸèƒ½ã€‚åŒæ—¶å¦‚æœæ˜¯åˆå¹¶åˆ°ä¸»åˆ†æ”¯çš„è¯·æ±‚ï¼ŒåŠ å…¥å¢é‡è¦†ç›–ç‡é˜ˆå€¼æ£€æµ‹ï¼Œä¸æ»¡è¶³é˜ˆå€¼çš„ï¼Œå‘é€é£ä¹¦æ¶ˆæ¯å¡ç‰‡è¿›è¡Œå‘Šè­¦é€šçŸ¥ã€‚</li></ul><h4 id="pre-commit-å¢é‡å•æµ‹">pre-commit å¢é‡å•æµ‹</h4><p><code>.pre-commit-config.yaml</code> é…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">repos:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">repo:</span> <span class="string">local</span></span><br><span class="line">    <span class="attr">hooks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">go-unit-tests</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">go-unit-tests</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">run</span> <span class="string">go</span> <span class="string">tests</span> <span class="string">with</span> <span class="string">race</span> <span class="string">detector</span></span><br><span class="line">        <span class="attr">entry:</span> <span class="string">bash</span> <span class="string">-c</span> <span class="string">&#x27;./script/run_diff_go_test.sh&#x27;</span></span><br><span class="line">        <span class="attr">language:</span> <span class="string">golang</span></span><br><span class="line">        <span class="attr">files:</span> <span class="string">\.*$</span></span><br><span class="line">        <span class="attr">pass_filenames:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><p><code>run_diff_go_test.sh</code> è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">export GOTOOLCHAIN=auto</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è·å–å½“å‰æ”¹åŠ¨çš„ Go æ–‡ä»¶</span></span><br><span class="line">changed_files=$(git diff --name-only --cached --diff-filter=d | grep &#x27;\.go$&#x27;)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¦‚æœæ²¡æœ‰æ”¹åŠ¨çš„ Go æ–‡ä»¶ï¼Œé€€å‡º</span></span><br><span class="line">if [ -z &quot;$changed_files&quot; ]; then</span><br><span class="line">    echo &quot;No Go files changed.&quot;</span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æå–æ”¹åŠ¨æ–‡ä»¶æ‰€åœ¨çš„åŒ…è·¯å¾„ï¼ˆä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼‰ï¼Œå¹¶æ’é™¤ vendor ç›®å½•</span></span><br><span class="line">test_dirs=$(echo &quot;$changed_files&quot; | xargs -n1 dirname | grep -v &#x27;^vendor&#x27; | sort -u)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¯¹æ¯ä¸ªæ”¹åŠ¨çš„åŒ…è·¯å¾„è¿è¡Œ go <span class="built_in">test</span></span></span><br><span class="line">for dir in $test_dirs; do</span><br><span class="line">    # æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨</span><br><span class="line">    if [ ! -d &quot;$dir&quot; ]; then</span><br><span class="line">        echo &quot;Directory $dir does not exist. Skipping...&quot;</span><br><span class="line">        continue</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # æ£€æŸ¥æ˜¯å¦å­˜åœ¨ go.mod æ–‡ä»¶ï¼Œç¡®ä¿åœ¨ Go æ¨¡å—è·¯å¾„ä¸­</span><br><span class="line">    if [ -f &quot;$dir/go.mod&quot; ] || [ -f &quot;./go.mod&quot; ]; then</span><br><span class="line">        echo &quot;Running tests in $dir...&quot;</span><br><span class="line">        (cd &quot;$dir&quot; &amp;&amp; go test -mod=vendor -gcflags=all=-l -short ./...)</span><br><span class="line">        if [ $? -ne 0 ]; then</span><br><span class="line">            echo &quot;Tests failed in $dir&quot;</span><br><span class="line">            exit 1</span><br><span class="line">        fi</span><br><span class="line">    else</span><br><span class="line">        echo &quot;Skipping $dir (no go.mod found)&quot;</span><br><span class="line">    fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">echo &quot;All tests passed.&quot;</span><br></pre></td></tr></table></figure><h4 id="gitlab-ci-å…¨é‡å•æµ‹">gitlab-ci å…¨é‡å•æµ‹</h4><p><code>gitlab-ci.yml</code> é…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">go-unit-test:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">go-unit-test</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sh</span> <span class="string">script/unittest.sh</span> <span class="string">&quot;$CI_MERGE_REQUEST_TITLE&quot;</span> <span class="string">&quot;$GITLAB_USER_EMAIL&quot;</span> <span class="string">&quot;$CI_PIPELINE_ID&quot;</span> <span class="string">&quot;$CI_MERGE_REQUEST_TARGET_BRANCH_NAME&quot;</span> <span class="string">&quot;$CI_JOB_ID&quot;</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">if:</span> <span class="string">$CI_PIPELINE_SOURCE</span> <span class="string">==</span> <span class="string">&quot;merge_request_event&quot;</span> <span class="string">&amp;&amp;</span> <span class="string">$CI_MERGE_REQUEST_TARGET_BRANCH_NAME</span> <span class="string">==</span> <span class="string">&#x27;dev&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">if:</span> <span class="string">$CI_PIPELINE_SOURCE</span> <span class="string">==</span> <span class="string">&quot;merge_request_event&quot;</span> <span class="string">&amp;&amp;</span> <span class="string">$CI_MERGE_REQUEST_TARGET_BRANCH_NAME</span> <span class="string">==</span> <span class="string">&#x27;release&#x27;</span></span><br><span class="line">  <span class="attr">coverage:</span> <span class="string">&#x27;/coverage: \d+.\d+% of statements/&#x27;</span></span><br></pre></td></tr></table></figure><p><code>unittest.sh</code> å•æµ‹æ‰§è¡Œè„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">export GOPROXY=&quot;https://goproxy.cn,direct&quot;</span><br><span class="line"></span><br><span class="line">function generate_coverage_report &#123;</span><br><span class="line">  gocover-cobertura &lt; coverage.out &gt; coverage.xml</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä½¿ç”¨ gotestsum æ‰§è¡Œå•å…ƒæµ‹è¯•</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¦‚æœå•æµ‹æ‰§è¡Œå¤±è´¥ï¼Œä¼šå‘é€é£ä¹¦æ¶ˆæ¯å¡ç‰‡åˆ°å‘Šè­¦ç¾¤ä¸­</span></span><br><span class="line">if ! gotestsum --junitfile report.xml --post-run-command=&quot;./script/send_fs_card.sh \&quot;$1\&quot; \&quot;$2\&quot; \&quot;$3\&quot; \&quot;$5\&quot;&quot;  -- ./... -timeout 3s -short -mod=vendor -gcflags=all=-l -coverpkg=./... -coverprofile=coverage.out ; then</span><br><span class="line">  generate_coverage_report</span><br><span class="line">  sh script/cal_diff_coverage.sh &quot;$4&quot;</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç”Ÿæˆå•å…ƒæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š</span></span><br><span class="line">generate_coverage_report</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¦‚æœå¢é‡è¦†ç›–ç‡ä¸æ»¡è¶³é˜ˆå€¼ï¼Œä¼šå‘é€é£ä¹¦æ¶ˆæ¯å¡ç‰‡åˆ°å‘Šè­¦ç¾¤ä¸­</span></span><br><span class="line">source script/cal_diff_coverage.sh &quot;$4&quot;</span><br><span class="line"></span><br><span class="line">if [[ &quot;$4&quot; == &quot;release&quot; ]]; then</span><br><span class="line">  source script/check_test_coverage.sh &quot;$1&quot; &quot;$2&quot; &quot;$3&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>cal_diff_coverage.sh</code> ç”¨äºè®¡ç®—å¢é‡è¦†ç›–ç‡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">export COVERAGE_PERCENT=0.0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç¡®ä¿ coverage.xml æ–‡ä»¶å­˜åœ¨</span></span><br><span class="line">if [ ! -f coverage.xml ]; then</span><br><span class="line">  echo &quot;coverage: 0.0% of statements&quot;</span><br><span class="line">  exit 0</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä½¿ç”¨ diff-cover ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š</span></span><br><span class="line">diff-cover coverage.xml --exclude **/docs.go --html-report report.html --compare-branch &quot;$1&quot; &gt; diff_detail.txt</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥æ˜¯å¦æˆåŠŸç”ŸæˆæŠ¥å‘Š</span></span><br><span class="line">if [ ! -f report.html ]; then</span><br><span class="line">  echo &quot;coverage: 0.0% of statements&quot;</span><br><span class="line">  exit 0</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä½¿ç”¨ grep å’Œ awk æå–è¦†ç›–ç‡ä¿¡æ¯</span></span><br><span class="line">COVERAGE=$(grep &quot;Coverage:&quot; diff_detail.txt | awk &#x27;&#123;print $2&#125;&#x27;)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¦‚æœæ‰¾åˆ°äº†è¦†ç›–ç‡æ•°æ®ï¼Œæ£€æŸ¥æ˜¯å¦åŒ…å«å°æ•°ç‚¹</span></span><br><span class="line">if [ -n &quot;$COVERAGE&quot; ]; then</span><br><span class="line">  if [[ &quot;$COVERAGE&quot; != *&quot;.&quot;* ]]; then</span><br><span class="line">    # å¦‚æœæ²¡æœ‰å°æ•°ç‚¹ï¼Œåœ¨ç™¾åˆ†å·å‰é¢åŠ ä¸Š &#x27;.0&#x27;</span><br><span class="line">    # è¿™é‡Œè¿™ä¹ˆåšçš„ç›®çš„æ˜¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆ gitlab ci æ— æ³•æ­£ç¡®è§£æä¸‹é¢è¿™ä¸ªæ­£åˆ™</span><br><span class="line">    # /coverage: \d+(.\d+)?% of statements/</span><br><span class="line">    # åªèƒ½è§£æè¿™ä¸ª</span><br><span class="line">    # /coverage: \d+.\d+% of statements/</span><br><span class="line">    COVERAGE=&quot;$&#123;COVERAGE/\%/.0%&#125;&quot;</span><br><span class="line">  fi</span><br><span class="line">  echo &quot;coverage: $COVERAGE of statements&quot;</span><br><span class="line">else</span><br><span class="line">  COVERAGE=&quot;0.0%&quot;</span><br><span class="line">  echo &quot;coverage: 0.0% of statements&quot;</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å°† COVERAGE çš„ç™¾åˆ†å·å»æ‰ï¼Œåªä¿ç•™æ•°å­—</span></span><br><span class="line">export COVERAGE_PERCENT=$(echo &quot;$COVERAGE&quot; | sed &#x27;s/%//&#x27;)</span><br></pre></td></tr></table></figure><h3 id="2-ç”¨æœ€å°çš„ç»´æŠ¤ä»£ä»·æä¾›æœ€å¤§ä»·å€¼çš„å•å…ƒæµ‹è¯•">2. ç”¨æœ€å°çš„ç»´æŠ¤ä»£ä»·æä¾›æœ€å¤§ä»·å€¼çš„å•å…ƒæµ‹è¯•</h3><p>å¦‚ä½•è¯„ä»·ä¸€ä¸ªå•å…ƒæµ‹è¯•ä»·å€¼æ˜¯å¦è¶³å¤Ÿå¤§å‘¢ï¼Ÿæˆ–è€…ï¼Œæ›´ç®€å•çš„è¯´æ³•æ˜¯ï¼Œå¦‚ä½•è¯„ä»·ä¸€ä¸ªå•å…ƒæµ‹è¯•å†™å¾—å¥½ä¸å¥½ï¼Ÿ</p><p>å¯ä»¥ä» 4 ä¸ªè§’åº¦è¿›è¡Œè¯„ä¼°ï¼š</p><ol><li>protection against regressions</li><li>resistance to refactoring</li><li>fast feedback</li><li>maintainability</li></ol><p>æ›´å…·ä½“åœ°è¯´ï¼š</p><h4 id="2-1-é˜²æ­¢å›å½’">2.1 é˜²æ­¢å›å½’</h4><blockquote><p>ä»£ç ä¿®æ”¹åï¼ŒåŸæœ‰åŠŸèƒ½ä¸å—å½±å“ã€‚</p></blockquote><p>è¯„ä»·æŒ‡æ ‡ï¼š</p><ol><li>è¢«æµ‹è¯•ä»£ç æ‰§è¡Œåˆ°çš„ä¸šåŠ¡ä»£ç æ•°é‡ï¼ˆæµ‹è¯•è¦†ç›–ç‡ï¼‰ã€‚</li><li>ä¸šåŠ¡ä»£ç çš„å¤æ‚åº¦ã€‚</li><li>ä¸šåŠ¡ä»£ç çš„é¢†åŸŸé‡è¦æ€§ã€‚</li></ol><h4 id="2-2-æŠµæŠ—é‡æ„">2.2 æŠµæŠ—é‡æ„</h4><blockquote><p>éåŠŸèƒ½æ€§é‡æ„ï¼Œæµ‹è¯•ä»èƒ½é€šè¿‡ï¼Œç¡®ä¿åŠŸèƒ½ä¸€è‡´æ€§ã€‚</p></blockquote><p>è¯„ä»·æŒ‡æ ‡ï¼š</p><ol><li>è¶Šå°‘çš„â€œå‡é˜³æ€§â€è¶Šå¥½ã€‚</li><li>åœ¨é‡æ„ä»£ç æ—¶ï¼Œå¼•å…¥äº†ç ´åæ€§å˜æ›´ï¼Œæµ‹è¯•ä»£ç èƒ½å¦å¿«é€Ÿåé¦ˆï¼Œå³è¶Šå°‘çš„â€œå‡é˜´æ€§â€è¶Šå¥½ã€‚</li><li>æµ‹è¯•ä»£ç æ˜¯å¦ä¸ºä½ é‡æ„ä»£ç æä¾›äº†è¶³å¤Ÿçš„ä¿¡å¿ƒã€‚</li><li>æµ‹è¯•ä»£ç æµ‹è¯•çš„æ˜¯ä¸šåŠ¡ä»£ç çš„ observable behaviorï¼Œè€Œä¸æ˜¯å…¶èƒŒåçš„æ¯ä¸€ä¸ªæ­¥éª¤ã€‚</li></ol><h4 id="2-3-å¿«é€Ÿåé¦ˆ">2.3 å¿«é€Ÿåé¦ˆ</h4><blockquote><p>æµ‹è¯•ä»£ç æ‰§è¡Œæ—¶é—´è¶Šå¿«ï¼Œåˆ™åé¦ˆé—´éš”è¶ŠçŸ­ï¼Œç¼ºé™·ä¿®å¤æ•ˆç‡å’Œè´¨é‡å°±è¶Šé«˜ã€‚</p></blockquote><p>è¯„ä»·æŒ‡æ ‡ï¼š</p><ol><li>ä»£ç æ‰§è¡Œé€Ÿåº¦</li></ol><h4 id="2-4-å¯ç»´æŠ¤æ€§">2.4 å¯ç»´æŠ¤æ€§</h4><blockquote><p>æµ‹è¯•ä»£ç çš„ä¿®æ”¹æˆæœ¬ï¼Œå¯ç»´æŠ¤çš„æµ‹è¯•ä»£ç æ›´æœ‰åˆ©äºé€‚åº”éœ€æ±‚å˜æ›´ã€‚</p></blockquote><p>è¯„ä»·æŒ‡æ ‡ï¼š</p><ol><li>æµ‹è¯•ä»£ç æœ‰å¤šéš¾ç†è§£ï¼Ÿ</li><li>æµ‹è¯•ä»£ç çš„ä»£ç è¡Œæ•°æœ‰å¤šå°‘ï¼Ÿ</li><li>æµ‹è¯•ä»£ç çš„æ‰§è¡Œéš¾åº¦æœ‰å¤šé«˜ï¼Ÿå³æœ‰å¤šå°‘çš„å¤–éƒ¨ä¾èµ–ï¼Ÿ</li></ol><h4 id="2-5-å¦‚ä½•æƒè¡¡">2.5 å¦‚ä½•æƒè¡¡</h4><p>å•å…ƒæµ‹è¯•çš„ä»·å€¼å¯ä»¥é€šè¿‡ä¸Šè¿° 4 ä¸ªæŒ‡æ ‡çš„<strong>ä¹˜ç§¯</strong>æ¥è¿›è¡Œä¼°ç®—ï¼Œä½†ç°å®æ˜¯ï¼Œè¿™ 4 è€…ï¼Œå¾€å¾€æ— æ³•å…¼å¾—ã€‚é‚£æˆ‘ä»¬å¦‚ä½•åšæƒè¡¡å‘¢ï¼Ÿ</p><p>é¦–å…ˆå›é¡¾ã€Œä¸ºä»€ä¹ˆè¦å†™å•å…ƒæµ‹è¯•ã€ï¼Œæ ¸å¿ƒç›®çš„æ˜¯ä¸ºäº†<strong>ç¨‹åºé€»è¾‘æ­£ç¡®æ€§ã€ä½¿è½¯ä»¶é¡¹ç›®æ›´å¯æŒç»­å‘å±•</strong>ã€‚æ‰€ä»¥ï¼š</p><ul><li>**å¯ç»´æŠ¤æ€§ï¼ˆmaintainabilityï¼‰**æ˜¯ä¸å¯å•†é‡çš„ï¼Œå¿…é¡»è¦æ’°å†™å¯ç»´æŠ¤çš„æµ‹è¯•ä»£ç ã€‚</li><li>**æŠµæŠ—é‡æ„ï¼ˆresistance to refactoringï¼‰**æ˜¯ä¸å¯å•†é‡çš„ï¼Œæˆ‘ä»¬çš„æµ‹è¯•ä»£ç åº”å°½å¯èƒ½å¯¹é”™è¯¯çš„é€»è¾‘è¿›è¡Œå‘Šè­¦ï¼Œä¹Ÿåº”é¿å…å¯¹æ­£ç¡®çš„é€»è¾‘è¿›è¡Œè¯¯å‘Šè­¦ã€‚</li></ul><p>æ‰€ä»¥æˆ‘ä»¬èƒ½æƒè¡¡çš„å…¶å®å°±æ˜¯ protection againts regressions å’Œ fast feedbackï¼ŒäºŒè€…çš„çŸ›ç›¾å¾ˆæ¸…æ™°ï¼š</p><ol><li>å¦‚æœæ‰§è¡Œçš„ä»£ç è¶Šå¤šï¼Œç›¸åº”çš„æ•ˆç‡å°±è¶Šä½ã€‚</li><li>å¦‚æœæ‰§è¡Œçš„ä»£ç å¤ªå°‘ï¼Œé‚£éªŒè¯çš„é€»è¾‘èŒƒå›´å°±è¶Šå°ã€‚</li></ol><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%206.png" style="zoom:33%;" /><p>ä¸ºäº†æƒè¡¡è¿™äºŒè€…ï¼Œä¸šç•Œæå‡ºäº†â€œæµ‹è¯•é‡‘å­—å¡”â€çš„æ¦‚å¿µã€‚</p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%207.png" style="zoom:33%;" /><ol><li>å•å…ƒæµ‹è¯•çš„å•ä½æ›´å°ï¼Œæ¶‰åŠçš„å¤–éƒ¨ä¾èµ–ä¹Ÿæ›´å°‘ï¼Œæ›´åŠ  <strong>fast feedback</strong>ï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªå±‚æ¬¡æˆ‘ä»¬è¦æ’°å†™æ›´å¤šçš„æµ‹è¯•ï¼Œå»å°½å¯èƒ½è¦†ç›–æ›´å¤šçš„å•å…ƒé€»è¾‘ã€‚</li><li>é›†æˆæµ‹è¯•ã€ç«¯åˆ°ç«¯æµ‹è¯•çš„é€»è¾‘è¦†ç›–èŒƒå›´æ›´å¤§ï¼Œæ›´åŠ  <strong>resistance to refactoring</strong>ï¼Œä½†æ˜¯å¾€å¾€ä¼šä¾èµ–æ›´å¤šçš„ç»„ä»¶ï¼Œæ‰§è¡Œçš„æ•ˆç‡ä¹Ÿæ›´ä½ï¼Œæ‰€ä»¥åœ¨è¿™ 2 ä¸ªå±‚æ¬¡ï¼Œæˆ‘ä»¬å¯ä»¥åªæ’°å†™è¦†ç›–æœ€é‡è¦ï¼ˆä¹è§‚ï¼‰çš„ä¸šåŠ¡è·¯å¾„çš„æµ‹è¯•ä»£ç ï¼Œåœ¨ç‰ºç‰²æœ‰é™çš„æ‰§è¡Œæ•ˆç‡çš„æƒ…å†µä¸‹ï¼Œå°è¯•æ›´å¤§çš„é˜²æ­¢å›å½’æ•ˆæœã€‚</li></ol><h3 id="3-éªŒè¯ä»£ç ä¸­æœ€é‡è¦çš„éƒ¨åˆ†">3. éªŒè¯ä»£ç ä¸­æœ€é‡è¦çš„éƒ¨åˆ†</h3><p>ä»€ä¹ˆæ˜¯ä»£ç ä¸­æœ€é‡è¦çš„éƒ¨åˆ†å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å°†ä»£ç åˆ†æˆä»¥ä¸‹ 4 ä¸ªç§ç±»ï¼š</p><ol><li><strong>é¢†åŸŸæ¨¡å‹å’Œç®—æ³•ï¼ˆDomain Model and Algorithmsï¼‰</strong>ï¼šé¢†åŸŸæ¨¡å‹æ˜¯å¯¹ä¸šåŠ¡é¢†åŸŸæ ¸å¿ƒæ¦‚å¿µå’Œé€»è¾‘çš„æŠ½è±¡ï¼Œç®—æ³•åˆ™æ˜¯è§£å†³ç‰¹å®šé—®é¢˜çš„è®¡ç®—æ­¥éª¤ã€‚ä¸¤è€…å…±åŒæ„æˆç³»ç»Ÿçš„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ã€‚</li><li><strong>çç¢ä»£ç ï¼ˆTrivial Codeï¼‰</strong>ï¼šå®ç°ç®€å•åŠŸèƒ½ã€æ— å¤æ‚é€»è¾‘çš„ä»£ç ç‰‡æ®µï¼Œé€šå¸¸ä¸ºå·¥å…·æ–¹æ³•æˆ–æ•°æ®è½¬æ¢å±‚ã€‚</li><li><strong>æ§åˆ¶å™¨ï¼ˆControllersï¼‰</strong>ï¼šåè°ƒä¸šåŠ¡é€»è¾‘ä¸å¤–éƒ¨äº¤äº’çš„ä¸­é—´å±‚ï¼Œå¸¸è§äº MVC æˆ–åˆ†å±‚æ¶æ„ä¸­ã€‚</li><li><strong>è¿‡åº¦å¤æ‚ä»£ç ï¼ˆOvercomplicated Codeï¼‰</strong>ï¼šæ—¢åŒ…å«æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ŒåˆåŒ…å«æ§åˆ¶å™¨é€»è¾‘ã€‚</li></ol><p>ä½œè€…å»ºè®®ï¼š</p><ol><li>æ°¸è¿œä¸º <strong>Domain Model and Algorithms</strong> æ’°å†™å…¨é¢ç»†è‡´çš„å•å…ƒæµ‹è¯•ã€‚</li><li>æ°¸è¿œä¸ä¸º <strong>Trivial Code</strong> æ’°å†™å•å…ƒæµ‹è¯•ã€‚</li><li>ä¸º <strong>Controllers</strong> æ’°å†™é›†æˆæµ‹è¯•ï¼Œè€Œä¸æ˜¯å•å…ƒæµ‹è¯•ã€‚</li><li>é¿å…å†™ <strong>Overcomplicated Code</strong>ï¼Œå°†å…¶æ‹†åˆ†æˆ <strong>Domain Model and Algorithms</strong> å’Œ <strong>Controllers</strong> ã€‚</li></ol><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2015.png" alt=""></p><h2 id="å¦‚ä½•è®©ä»£ç æ›´å®¹æ˜“æµ‹è¯•ï¼Ÿ">å¦‚ä½•è®©ä»£ç æ›´å®¹æ˜“æµ‹è¯•ï¼Ÿ</h2><p>æ ¹æ®ä¸åŒå¤„ç†æ¶æ„çš„ä¸šåŠ¡ä»£ç ï¼Œå¯ä»¥å°†æµ‹è¯•ä»£ç åˆ†æˆä»¥ä¸‹ 3 ä¸ªç§ç±»ï¼š</p><ol><li><code>output-based</code>ï¼šä¸šåŠ¡ä»£ç åªäº§ç”Ÿè¾“å‡ºç»“æœï¼Œæ‰€ä»¥åªéœ€è¦<strong>éªŒè¯è¾“å‡º</strong>ã€‚</li><li><code>state-based</code>ï¼šä¸šåŠ¡ä»£ç ä¼šä¿®æ”¹å†…éƒ¨çŠ¶æ€æˆ–ä¾èµ–çŠ¶æ€ï¼Œæ‰€ä»¥éœ€è¦<strong>éªŒè¯çŠ¶æ€å˜åŒ–</strong>ã€‚</li><li><code>communication-based</code>ï¼šä¸šåŠ¡ä»£ç ä¼šè·Ÿåä½œæ–¹è¿›è¡Œäº¤äº’ï¼Œæ‰€ä»¥éœ€è¦<strong>éªŒè¯äº¤äº’æƒ…å†µ</strong>ã€‚å¯¹äºè¿™ç§åœºæ™¯ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ <code>mock</code>  å·¥å…·æ¥è¿›è¡ŒéªŒè¯ã€‚å…³äº <code>mock</code> è¿™ä¸ªè¯é¢˜ï¼Œæ–‡ç« åç»­ä¼šè¿›è¡Œè¯¦ç»†è®¨è®ºã€‚</li></ol><p>æˆ‘ä»¬æŒ‰ç…§ä¸Šè¿° 4 ä¸ªåˆ†æç»´åº¦ï¼Œå¯¹è¿™ 3 ç§æµ‹è¯•ä»£ç è¿›è¡Œæ¯”è¾ƒï¼š</p><table><thead><tr><th></th><th>protection againts regressions</th><th>resistance to refactoring</th><th>fast feedback</th><th>maintainability</th></tr></thead><tbody><tr><td><strong>output-based</strong></td><td>â­ï¸â­ï¸â­ï¸</td><td>â­ï¸â­ï¸â­ï¸</td><td>â­ï¸â­ï¸â­ï¸</td><td>â­ï¸â­ï¸â­ï¸ æœ€å¥½ï¼Œä¸éœ€è¦å¤–éƒ¨ä¾èµ–ã€‚</td></tr><tr><td><strong>state-based</strong></td><td>â­ï¸â­ï¸â­ï¸</td><td>â­ï¸â­ï¸</td><td>â­ï¸â­ï¸â­ï¸</td><td>â­ï¸â­ï¸ æ¯”è¾ƒå·®ï¼Œéœ€è¦å¤–éƒ¨ä¾èµ–ã€‚</td></tr><tr><td><strong>communication-based</strong></td><td>â­ï¸â­ï¸ è¿‡åº¦ä½¿ç”¨ä¼šå¯¼è‡´éœ€è¦åˆ°å¤„ mockï¼Œè€ŒçœŸæ­£æ‰§è¡Œçš„ä¸šåŠ¡ä»£ç æ•°é‡å¾ˆå°‘ã€‚</td><td>â­ï¸ æœ€å·®ï¼Œå› ä¸ºéªŒè¯äº¤äº’æƒ…å†µï¼Œå¾€å¾€ä¼šé™·å…¥å®ç°ç»†èŠ‚ï¼Œå¾ˆå®¹æ˜“åœ¨é‡æ„è¿‡ç¨‹ä¸­å‡ºç°è¯¯è­¦å‘Šã€‚</td><td>â­ï¸â­ï¸ å¤§å·®ä¸å·®ï¼Œä½†æ˜¯ mock å·¥å…·æ•ˆç‡å¯èƒ½ä¼šç›¸å¯¹ä½ä¸€ç‚¹ç‚¹ã€‚</td><td>â­ï¸ æœ€å·®ï¼Œéœ€è¦å¼•å…¥å¤§é‡çš„ mock å·¥å…·å’Œ mock ä»£ç ã€‚</td></tr></tbody></table><p>æ‰€ä»¥æˆ‘ä»¬åº”è¯¥å°½å¯èƒ½å†™ <strong>output-based</strong> æµ‹è¯•ï¼Œå‡å°‘ <strong>communication-based</strong> æµ‹è¯•ã€‚</p><p>å¯ä»¥é‡‡å– <code>functional architecture</code>ï¼Œå°†ä»£ç åˆ†æˆ 2 ä¸ªé˜¶æ®µï¼š</p><ol><li>æ ¹æ®ä¸šåŠ¡è§„åˆ™åšå‡ºå†³å®š</li><li>æ ¹æ®å†³å®šåšå‡ºè¡Œä¸º</li></ol><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2014.png" alt=""></p><p>ä¸ºæ­¤ï¼Œåœ¨å¯èƒ½çš„åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•é€šè¿‡ 2 ä¸ªæ­¥éª¤æ¥ä¼˜åŒ–æˆ‘ä»¬çš„æµ‹è¯•ä»£ç ï¼š</p><ol><li>ä½¿ç”¨ <code>mock</code> æ¥æ›¿ä»£å¤–éƒ¨ä¾èµ– <code>out-of-process dependency</code>ã€‚</li><li>ä½¿ç”¨ <code>functional architecture</code> æ¥æ›¿ä»£ <code>mock</code>ã€‚</li></ol><h2 id="èŠä¸€ä¸‹-Mock">èŠä¸€ä¸‹ Mock</h2><p>åœ¨æ’°å†™å•å…ƒæµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœä¸šåŠ¡é€»è¾‘ä¾èµ–çš„ç»„ä»¶ä¸å¥½å®ä¾‹åŒ–çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¸¸å¸¸ä¼šå€ŸåŠ©å„ç§ <code>Mock</code>  å·¥å…·æ¥å®ç°â€œæ¨¡æ‹Ÿâ€åŠŸèƒ½ï¼Œä½¿å•æµ‹æ›´æ˜“æ’°å†™ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªæ›´å‡†ç¡®çš„è¯å« <code>test doubles</code>ï¼ˆæµ‹è¯•æ›¿èº«ï¼‰ã€‚</p><h3 id="test-double-çš„ç§ç±»">test double çš„ç§ç±»</h3><p>ä»å¤§çš„æ–¹é¢å¯ä»¥åˆ†ä¸º 2 ç§ï¼š</p><ol><li>ç”¨äºæ¨¡æ‹Ÿå’ŒéªŒè¯å¯¹è±¡é—´çš„è¾“å‡ºäº¤äº’ï¼ˆå¦‚æ–¹æ³•è°ƒç”¨æ¬¡æ•°ã€å‚æ•°åŒ¹é…ï¼‰ï¼Œåˆ™ä¸º <code>mock</code>ã€‚</li><li>ç”¨äºæ¨¡æ‹Ÿè¾“å…¥äº¤äº’ï¼Œæä¾›é¢„å®šä¹‰çš„æ•°æ®ï¼Œåˆ™ä¸º <code>stub</code>ã€‚</li></ol><p>æ›´è¿›ä¸€æ­¥å¯ä»¥åˆ†ä¸ºï¼š</p><ul><li><code>mock</code><ul><li><code>mock</code>: ç”± mock å·¥å…·ç”Ÿæˆã€‚</li><li><code>spy</code>: æ‰‹å·¥æ’°å†™ã€‚</li></ul></li><li><code>stub</code><ul><li><code>stub</code>: å¯ä»¥é€šè¿‡é…ç½®åœ¨ä¸åŒçš„åœºæ™¯ä¸‹è¿”å›ä¸åŒçš„æ•°æ®ã€‚</li><li><code>dummy</code>: å ä½ç¬¦ï¼Œä»…ç”¨äºå¡«å……å‚æ•°ï¼Œä¸å‚ä¸å®é™…é€»è¾‘ã€‚</li><li><code>fake</code>: è·Ÿ <code>stub</code> å‡ ä¹ä¸€æ ·ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯ <code>fake</code> ç»å¸¸ç”¨äºæ›¿ä»£å°šæœªå¼€å‘æˆ–å¤æ‚çš„ä¾èµ–ã€‚</li></ul></li></ul><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šæ°¸è¿œä¸è¦å»éªŒè¯ï¼ˆassertï¼‰è·Ÿ <code>stub</code> çš„äº¤äº’ï¼Œæ²¡å¿…è¦ï¼</p></blockquote><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%208.png" alt=""></p><h3 id="å“ªäº›ä¸œè¥¿éœ€è¦-Mockï¼Ÿ">å“ªäº›ä¸œè¥¿éœ€è¦ Mockï¼Ÿ</h3><p>åœ¨å›ç­”è¿™ä¸ªé—®é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆåšä¸‹é“ºå«ï¼ŒèŠä¸€ä¸‹æ¥å£çš„è¯¯è§£ã€ä¾èµ–çš„ç§ç±»å’Œä¸¤ç§äº¤äº’çš„æ¦‚å¿µã€‚</p><h4 id="æ¥å£çš„è¯¯è§£">æ¥å£çš„è¯¯è§£</h4><p>åœ¨è°ˆå¦‚ä½•æ›´å¥½åœ°åˆ©ç”¨ mock ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥èŠä¸€ä¸‹æ¥å£ï¼ˆinterfaceï¼‰çš„è¯¯è§£ã€‚</p><p>åœ¨ä¸šåŠ¡å¼€å‘å½“ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸èƒ½çœ‹åˆ°ä¸€äº›ä¼å›¾è¿›è¡Œâ€œä¼˜é›…â€æ¶æ„è®¾è®¡çš„ä»£ç ï¼Œä¸Šæ¥æ¯ä¸€å±‚éƒ½å®šä¹‰æ¥å£ï¼Œæ¯ä¸€å±‚éƒ½ä½¿ç”¨æ¥å£è¿›è¡Œäº¤äº’ï¼Œåæ­£é‡åˆ°é—®é¢˜å…ˆå®šä¹‰æ¥å£å†è¯´ã€‚</p><p>ç›®çš„æœ‰äºŒï¼š</p><ol><li>æŠ½è±¡å¤–éƒ¨ä¾èµ–ï¼Œè¿›è¡Œè§£è€¦ã€‚</li><li>å¯ä»¥åœ¨ä¸ä¿®æ”¹æ—¢æœ‰ä»£ç çš„æƒ…å†µä¸‹æ‰©å±•åŠŸèƒ½ï¼Œå³æ‰€è°“çš„å¼€é—­åŸåˆ™ï¼ˆOpen-Closed principleï¼‰ã€‚</li></ol><p>ä½†è¿™å…¶å®å­˜åœ¨ä¸€äº›è¯¯åŒºï¼Œä½œè€…åœ¨ä¹¦ä¸­æŒ‡å‡ºï¼š</p><ol><li><strong>åªæœ‰ä¸€ä¸ªå®ç°çš„æ¥å£</strong>ï¼Œå¹¶ä¸æ˜¯æŠ½è±¡ï¼Œä¹Ÿå¹¶æ²¡æœ‰æ¯”å…·ä½“çš„å¯¹è±¡èµ·åˆ°å¤ªå¤šæ‰€è°“çš„è§£è€¦ä½œç”¨ã€‚</li><li>ä¸Šè¿°ç¬¬ 2 ç‚¹è¿åäº†ä¸€ä¸ªæ›´é‡è¦çš„åŸåˆ™ <strong>YAGNIï¼ˆYou are not gonna need itï¼‰</strong>ï¼Œä¹Ÿå°±æ˜¯ä½ æ‰€è°“çš„åŠŸèƒ½æ‰©å±•å¤§æ¦‚ç‡æ˜¯ä¸éœ€è¦çš„ã€‚</li><li>ä¸Šè¿°åšæ³•çš„å”¯ä¸€å¥½å¤„æ˜¯ä»€ä¹ˆï¼š**ä½¿æµ‹è¯•æˆä¸ºå¯èƒ½ï¼**å› ä¸ºä½ ä¸éš”ç¦»æ‰å¤–éƒ¨ä¾èµ–çš„è¯ï¼Œä½ çš„å•å…ƒæµ‹è¯•æ’°å†™ä¼šéå¸¸å›°éš¾ï¼Œä¹Ÿæ— æ³•åšåˆ° fast feedbackã€‚</li></ol><div class="tag-plugin colorful note" color="green"><div class="title">ğŸ™‹ğŸ»â€â™€ï¸</div><div class="body"><p>æŠ½è±¡æ˜¯å‘ç°å‡ºæ¥çš„ï¼Œè€Œä¸æ˜¯å‘æ˜å‡ºæ¥çš„ï¼</p></div></div><h4 id="ä¾èµ–çš„ç§ç±»">ä¾èµ–çš„ç§ç±»</h4><ul><li><code>shared dependency</code>: ä¸€ä¸ªåœ¨æµ‹è¯•ä»£ç ä¸­çš„å…±äº«å¯¹è±¡ã€‚</li><li><code>out-of-process dependency</code>: ç‹¬ç«‹äºå½“å‰åº”ç”¨ç¨‹åºçš„å¦å¤–ä¸€ä¸ªè¿›ç¨‹å¯¹è±¡ï¼Œå¦‚æ•°æ®åº“ã€STMP æœåŠ¡å™¨ç­‰ã€‚<ul><li><code>managed dependency</code>: ä»…å½“å‰åº”ç”¨ç¨‹åºå¯è®¿é—®çš„ä¾èµ–ï¼ˆå¯¹å…¶ä»–ç¨‹åºã€æœåŠ¡æ˜¯ä¸å¯è§çš„ï¼‰ã€‚</li><li><code>unmanaged dependency</code>: é™¤äº†å½“å‰åº”ç”¨ï¼Œå…¶ä»–åº”ç”¨ä¹Ÿå¯è§ã€‚</li></ul></li><li><code>private dependency</code>: ä¸€ä¸ªç§æœ‰å¯¹è±¡ã€‚</li></ul><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2019.png" alt=""></p><h4 id="ä¸¤ç§äº¤äº’">ä¸¤ç§äº¤äº’</h4><ul><li><code>intra-system communication</code>: åº”ç”¨ç¨‹åºå†…éƒ¨çš„äº¤äº’ã€‚</li><li><code>inter-system communication</code>: åº”ç”¨ç¨‹åºä¹‹é—´çš„äº¤äº’ã€‚</li></ul><h4 id="å“ªäº›ä¸œè¥¿éœ€è¦-Mockï¼Ÿ-2">å“ªäº›ä¸œè¥¿éœ€è¦ Mockï¼Ÿ</h4><p>é“ºå«å®Œæ¥å£çš„è¯¯è§£ã€ä¾èµ–çš„ç§ç±»å’Œä¸¤ç§äº¤äº’çš„æ¦‚å¿µä¹‹åï¼Œæˆ‘ä»¬æ¥èŠä¸€ä¸‹å“ªäº›ä¸œè¥¿éœ€è¦ Mockï¼Ÿ</p><p>åœ¨æŠ‰æ‹©çš„æ—¶å€™ï¼Œéœ€è¦ç‰¢è®°æˆ‘ä»¬æµ‹è¯•ç²’åº¦å’Œè¯„ä»·æŒ‡æ ‡ã€‚</p><p>æµ‹è¯•ç²’åº¦ï¼š<strong>an observable behavior â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸</strong></p><p>è¯„ä»·æŒ‡æ ‡ï¼š</p><ul><li>é˜²æ­¢å›å½’ï¼šprotection against regressions</li><li>æŠµæŠ—é‡æ„ï¼šresistance to refactoring</li><li>å¿«é€Ÿåé¦ˆï¼šfast feedback</li><li>å¯ç»´æŠ¤æ€§ï¼šmaintainability</li></ul><p>é›†åˆæµ‹è¯•ç²’åº¦å’Œè¯„ä»·æŒ‡æ ‡ï¼ŒMock å“ªäº›ä¸œè¥¿å¯ä»¥ç”¨ä¸€å¥è¯æ¥æ¦‚æ‹¬ï¼š</p><div class="tag-plugin colorful note" color="green"><div class="title">âœ…</div><div class="body"><p>Mock é‚£äº›å¤–éƒ¨å¯è§‚æµ‹åˆ°çš„äº¤äº’ï¼Œè€Œå°½é‡é¿å… Mock å†…éƒ¨çš„å®ç°ç»†èŠ‚ã€‚</p></div></div><p>æ›´å…·ä½“æ¥è¯´ï¼š</p><ol><li>**ä»…å¯¹ <code>unmanaged dependency</code> åº”ç”¨ <code>mock</code> å¯¹è±¡ã€‚**å› ä¸ºæˆ‘ä»¬æ— æ³•é¢„çŸ¥å…¶ä»–åº”ç”¨ä¼šå¯¹è¿™äº›ä¾èµ–è¿›è¡Œä»€ä¹ˆæ“ä½œï¼Œæ‰€ä»¥åªèƒ½éš”ç¦»å¼€ã€‚</li><li>**å¯¹ç³»ç»Ÿæœ€å¤–å›´çš„è¾¹ç•Œè¿›è¡Œ <code>mock</code>ã€‚**åªæœ‰ç³»ç»Ÿè¾¹ç•Œï¼Œæ‰æ˜¯å¯è§‚æµ‹è¡Œä¸ºï¼Œå†…éƒ¨éƒ½æ˜¯å®ç°ç»†èŠ‚ï¼Œå¯¹å®ç°ç»†èŠ‚è¿‡å¤š Mockï¼Œæ„å‘³ç€ç ´åäº† resistance to refactoringã€‚</li><li><strong>å°½é‡åªåœ¨é›†æˆæµ‹è¯•ä¸­ä½¿ç”¨ mockï¼Œé¿å…åœ¨å•å…ƒæµ‹è¯•ä¸­ä½¿ç”¨ mockã€‚</strong></li><li><strong>åª mock å±äºä½ çš„å¯¹è±¡ï¼Œä¸å» mock ä¾èµ–åº“ä¸­çš„å¯¹è±¡ã€‚</strong><ul><li>å§‹ç»ˆåœ¨ç¬¬ä¸‰æ–¹åº“ä¹‹ä¸Šç¼–å†™è‡ªå·±çš„é€‚é…å™¨ï¼Œå¹¶å¯¹è¿™äº›é€‚é…å™¨è¿›è¡Œ mockï¼Œè€Œä¸æ˜¯ mockåº•å±‚ç±»å‹ã€‚</li><li>ä»…ä»åº“ä¸­æš´éœ²ä½ æ‰€éœ€è¦çš„åŠŸèƒ½ã€‚</li><li>ä½¿ç”¨é¡¹ç›®çš„é¢†åŸŸè¯­è¨€ï¼ˆdomain languageï¼‰æ¥å®Œæˆä¸Šè¿°æ“ä½œã€‚</li></ul></li></ol><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2021.png" alt=""></p><p>åœ¨ä¸Šå›¾ä¸­ï¼Œå³ä¾§æ˜¯æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼Œå®ƒä¾èµ–äº†å·¦ä¸‹è§’çš„ <code>Message bus</code> è¿™ä¸ªå¤–éƒ¨ä¾èµ–ï¼Œå‡†ç¡®è¯´æ˜¯ <code>unmanaged dependency</code>ã€‚å¯¹æ­¤ï¼Œæˆ‘ä»¬ä¸ºå…¶åˆ›å»ºäº†é€‚é…å™¨æ¥å£ <code>IBus</code>ï¼Œåœ¨è¿™ä¸ªé€šç”¨æ¥å£ä¹‹ä¸Šï¼Œæˆ‘ä»¬åˆæ ¹æ®å…·ä½“ä¸šåŠ¡åˆ›å»ºäº† <code>IMessageBus</code>ã€‚</p><p>é’ˆå¯¹è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬åœ¨è¿›è¡Œ mock çš„æ—¶å€™ï¼Œåªéœ€è¦ mock <code>IBus</code> å¯¹è±¡ï¼Œè€Œä¸æ˜¯å» mock <code>Message bus</code> å’Œ <code>IMessageBus</code>ã€‚</p><h3 id="æ•°æ®åº“è¦ä¸è¦-Mockï¼Ÿ">æ•°æ®åº“è¦ä¸è¦ Mockï¼Ÿ</h3><p>è¿™ä¸ªè¯é¢˜æ¯”è¾ƒæœ‰æ„æ€ï¼Œä½œè€…çš„å»ºè®®æ˜¯ï¼š</p><ol><li>å¦‚æœè¿™ä¸ªæ•°æ®åº“åªæœ‰ä½ è¿™ä¸ªåº”ç”¨å¯ä»¥è®¿é—®ï¼Œé‚£å°±ä¸è¦ mockã€‚</li><li>å¦‚æœè¿™ä¸ªæ•°æ®åº“å­˜åœ¨å¯ä»¥è¢«å…¶ä»–åº”ç”¨è®¿é—®çš„éƒ¨åˆ†ï¼Œé‚£å°±åª mock è¿™ä¸€éƒ¨åˆ†ï¼Œä¸å» mock ç‹¬å±äºä½ åº”ç”¨çš„é‚£éƒ¨åˆ†ã€‚</li></ol><p>è¦è·µè¡Œä¸Šè¿°æ ‡å‡†ï¼Œéœ€è¦åšåˆ°ä»¥ä¸‹å‰æï¼š</p><ol><li>å°†æ•°æ®åº“çš„ä¿¡æ¯ä¹Ÿæ”¾åœ¨æºç æ§åˆ¶ç³»ç»Ÿä¸­ï¼ˆgitï¼‰ï¼ŒåŒ…æ‹¬ï¼š<ul><li>schema</li><li>reference dataï¼ˆé¡¹ç›®å¯åŠ¨å¿…é¡»è¦çš„åˆå§‹æ•°æ®ï¼‰</li><li>migrationï¼ˆæ•°æ®å˜æ›´è®°å½•ï¼‰</li></ul></li><li>æ¯ä¸ªå¼€å‘è€…æœ‰ä¸€ä¸ªå•ç‹¬çš„æ•°æ®åº“ï¼ˆæµ‹è¯•ç¯å¢ƒä¸‹ï¼‰</li><li>ä½†æ•°æ®åº“å˜æ›´çš„æ—¶å€™ï¼Œä¸è¦ç›´æ¥ä¿®æ”¹ï¼Œè€Œæ˜¯è¦å†™ä¸€æ¡å¯¹åº” sql å»è¿›è¡Œä¿®æ”¹ï¼ŒåŒæ—¶å°†è¿™æ¡ sql ä¹Ÿçº³å…¥æºç æ§åˆ¶ç³»ç»Ÿä¸­ã€‚</li></ol><p>ä½œè€…ä¸å»ºè®® <code>mock</code> æ•°æ®åº“ï¼ŒåŒ…æ‹¬ä½¿ç”¨å†…å­˜æ•°æ®åº“æ›¿ä»£ï¼Œå¦‚ sqlite æ›¿ä»£ MySQLï¼Œæ ¸å¿ƒåŸå› æ˜¯ï¼šä½ æ— æ³•ä¿è¯è¿™äº›æ•°æ®åº“èƒ½è·Ÿçº¿ä¸Šç¯å¢ƒçš„è¡Œä¸ºä¸€è‡´ï¼Œå¯èƒ½ä¼šå¯¼è‡´ä¸€äº›æ— æ•ˆæµ‹è¯•ç”¨ä¾‹ï¼Œå³å‡é˜´æ€§ã€‚</p><p>ç¬”è€…å¹¶ä¸å®Œå…¨é‡‡çº³è¿™ä¸ªå»ºè®®ï¼Œè¯šç„¶ï¼Œå¦‚æœèƒ½åšåˆ°ä»¥ä¸Šå‰æï¼Œæ˜¯å¯ä»¥è€ƒè™‘è·µè¡Œçš„ã€‚ç„¶è€Œï¼Œå®ƒçš„è¦æ±‚å¾ˆé«˜ï¼Œæ”¶ç›Šå´ç›¸å¯¹è¾ƒå°ï¼Œåœ¨å•å…ƒæµ‹è¯•ç¯å¢ƒä¸‹ï¼Œä½¿ç”¨å†…å­˜æ•°æ®åº“è¿›è¡Œ mockï¼Œåœ¨ä¿è¯äº† fast feedback å’Œ maintainability çš„æƒ…å†µä¸‹ï¼Œä¹Ÿèƒ½å¤Ÿé¿å…ç»å¤§å¤šæ•°çš„é€»è¾‘æ¼æ´äº†ï¼Œå‡é˜´æ€§çš„æƒ…å†µä¼šéå¸¸å°‘ï¼Œå³ä¾¿æœ‰ï¼Œä¹Ÿå¯ä»¥äº¤ç»™é›†æˆæµ‹è¯•å’Œç«¯åˆ°ç«¯æµ‹è¯•å»è§£å†³ã€‚</p><h2 id="åé¢æ¡ˆä¾‹">åé¢æ¡ˆä¾‹</h2><ol><li>æµ‹è¯•ç§æœ‰æ–¹æ³•ã€‚</li><li>æš´éœ²ç§æœ‰çŠ¶æ€ã€‚</li><li>æ³„éœ²é¢†åŸŸçŸ¥è¯†åˆ°æµ‹è¯•ä¸­ã€‚</li><li>åœ¨ä¸šåŠ¡ä»£ç ä¸­æ’°å†™åªç”¨äºæµ‹è¯•çš„ä»£ç ã€‚</li><li>mock å…·ä½“çš„ç±»ã€‚</li></ol><p>ç¬¬ 3 ç‚¹æ¯”è¾ƒæœ‰æ„æ€ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CalculatorTests</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Fact</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Adding_two_numbers</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">int</span> value1 = <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">int</span> value2 = <span class="number">3</span>;</span><br><span class="line">        <span class="built_in">int</span> expected = value1 + value2;   <span class="comment">// &lt;-----The leakage</span></span><br><span class="line">        <span class="comment">// int expected = 4 // the better one</span></span><br><span class="line">        <span class="built_in">int</span> actual = Calculator.Add(value1, value2);</span><br><span class="line">        Assert.Equal(expected, actual);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»€ä¹ˆå«åšæ³„éœ²é¢†åŸŸçŸ¥è¯†å‘¢ï¼Ÿ</p><p>æ¯”å¦‚ä½ è¦éªŒè¯ä¸€ä¸ªåŠ æ³• <code>Add</code> å¯¹ä¸å¯¹ï¼Œä½†æ˜¯åœ¨æµ‹è¯•ä»£ç ä¸­ï¼Œä½ çš„æœŸæœ›å€¼ä¹Ÿæ˜¯ç”¨åŠ æ³•æ¥è·å¾—çš„ï¼Œè¿™ä¸ªâ€œåŠ æ³•â€å°±æ˜¯é¢†åŸŸçŸ¥è¯†ï¼Œå› ä¸ºè¿™æ ·æµ‹çš„è¯ï¼Œå°±å¾ˆæœ‰å¯èƒ½ä¼šå‡ºç°â€œ<strong>è´Ÿè´Ÿå¾—æ­£</strong>â€çš„æƒ…å†µã€‚</p><p>æ­£ç¡®çš„åšæ³•æ˜¯<strong>ç›´æ¥æ–­è¨€ä½ é¢„æœŸçš„æœ€ç»ˆç»“æœ</strong>ï¼Œä»¥ç¡®ä¿é€»è¾‘ç¬¦åˆé¢„æœŸã€‚</p><h2 id="Go-å®è·µæ¡ˆä¾‹">Go å®è·µæ¡ˆä¾‹</h2><p>æœ¬ç« å°†åˆ†äº«ä¸€äº›ç¬”è€…åœ¨ Go é¡¹ç›®å®æˆ˜è¿‡ç¨‹ä¸­çš„ä¸€äº›å®è·µæ¡ˆä¾‹ï¼Œå¸Œæœ›å¯¹è¯»è€…æ’°å†™å•å…ƒæµ‹è¯•èƒ½æä¾›ä¸€äº›å¸®åŠ©ã€‚</p><h3 id="ä¾èµ–-Redis-çš„é€»è¾‘æ€ä¹ˆæµ‹">ä¾èµ– Redis çš„é€»è¾‘æ€ä¹ˆæµ‹</h3><p>å¯ä»¥ä½¿ç”¨ <code>miniredis</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ Go è¯­è¨€å®ç°çš„å†…å­˜ç‰ˆ Redisã€‚</p><div class="tag-plugin link dis-select"><a class="link-card plain" title="" href="https://github.com/alicebob/miniredis" target="_blank" rel="external nofollow noopener noreferrer" cardlink api="https://site-info-api-hedon.vercel.app/api/v1?url=https://github.com/alicebob/miniredis" autofill="title,icon"><div class="left"><span class="title">https://github.com/alicebob/miniredis</span><span class="cap link footnote">https://github.com/alicebob/miniredis</span></div><div class="right"><div class="lazy img" data-bg="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/link/8f277b4ee0ecd.svg"></div></div></a></div><p>å¯ä»¥å°è£…ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºå¿«é€Ÿå¯åŠ¨ miniredis å¹¶è¿”å›å®¢æˆ·ç«¯å¯¹è±¡ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewMiniRedis</span><span class="params">()</span></span> *redis.Client &#123;</span><br><span class="line">    <span class="keyword">var</span> redisClient *redis.Client</span><br><span class="line">    <span class="keyword">var</span> miniRedisClient *miniredis.Miniredis</span><br><span class="line">    <span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line">    miniRedisClient, err = miniredis.Run()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">       <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    redisClient = redis.NewClient(&amp;redis.Options&#123;</span><br><span class="line">       Addr: miniRedisClient.Addr(),</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> redisClient</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œå¯èƒ½ä¼šå‡ºç°ä½œè€…æåˆ°çš„ä¸è¦ä½¿ç”¨å†…å­˜æ•°æ®åº“æ›¿ä»£çœŸå®çš„æ•°æ®åº“ï¼Œå› ä¸ºä½ æ— æ³•ä¿è¯å®ƒä»¬çš„è¡Œä¸ºä¸€è‡´ã€‚</p><p>æ¯”å¦‚è¿™é‡Œæ˜¯å•æœºçš„ï¼Œè€Œç”Ÿäº§ç¯å¢ƒå¯èƒ½æ˜¯é›†ç¾¤çš„ï¼Œåœ¨ Redis Cluster ä¸­ï¼Œæ¶‰åŠåˆ° lua è„šæœ¬å’Œäº‹åŠ¡çš„æ‰€æœ‰ keyï¼Œéƒ½å¿…é¡»ä¿è¯åœ¨åŒä¸€ä¸ª slot ä¸Šï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½¿ç”¨ <code>miniredis</code> æ˜¯æµ‹ä¸å‡ºé—®é¢˜çš„ã€‚</p></blockquote><h3 id="ä¾èµ–-MySQL-çš„é€»è¾‘æ€ä¹ˆæµ‹">ä¾èµ– MySQL çš„é€»è¾‘æ€ä¹ˆæµ‹</h3><p>æ ¸å¿ƒæŒ‘æˆ˜ï¼š</p><ol><li>ä¾èµ–çœŸå® MySQL åˆ™å®¹æ˜“å› ä¸ºç½‘ç»œåŸå› è€Œå¯¼è‡´æµ‹è¯•å¤±è´¥ï¼ˆä¸å¯é‡å¤æ€§ï¼‰</li><li>ä¾èµ–çœŸå® MySQL ä¼šä¸¥é‡å½±å“å•ä¾§æ‰§è¡Œæ•ˆç‡</li><li>æ•°æ®é¢„å¤‡</li><li>æ•°æ®æ¸…æ´—</li><li>å•æµ‹ä¹‹é—´çš„æ•°æ®éš”ç¦»ï¼Œäº’ä¸å½±å“</li><li>å¹¶å‘å®‰å…¨</li></ol><p>ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œæä¾›æ›´ä¼˜é›…çš„ MySQL å•æµ‹è§£å†³æ–¹æ¡ˆï¼Œç¬”è€…å€ŸåŠ© <code>dolthub/go-mysql-server</code> å’Œ <code>gorm</code> çš„èƒ½åŠ›ï¼Œå®ç°äº†ä¸€ä¸ª <code>go-mysql-mocker</code>ï¼Œç®€ç§° <code>gmm</code>ã€‚</p><p>å…¶ä¸­ï¼š</p><ul><li><code>dolthub/go-mysql-server</code> æä¾›äº†å†…å­˜ MySQL å¼•æ“ã€‚</li><li><code>gorm</code> æä¾›äº†å¿«é€Ÿå»ºè¡¨å’Œæ’å…¥æ•°æ®çš„èƒ½åŠ›ã€‚</li></ul><div class="tag-plugin link dis-select"><a class="link-card plain" title="" href="https://github.com/hedon954/go-mysql-mocker" target="_blank" rel="external nofollow noopener noreferrer" cardlink api="https://site-info-api-hedon.vercel.app/api/v1?url=https://github.com/hedon954/go-mysql-mocker" autofill="title,icon"><div class="left"><span class="title">https://github.com/hedon954/go-mysql-mocker</span><span class="cap link footnote">https://github.com/hedon954/go-mysql-mocker</span></div><div class="right"><div class="lazy img" data-bg="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/link/8f277b4ee0ecd.svg"></div></div></a></div><p>æ ¸å¿ƒåŠŸèƒ½ï¼š</p><ol><li>å†…å­˜ç‰ˆæ•°æ®åº“ï¼Œæ— ç½‘ç»œä¾èµ–ï¼›</li><li>æ¯ä¸ªå•æµ‹å¯å•ç‹¬å¯åŠ¨ä¸€ä¸ªæ•°æ®åº“ï¼Œå¤©ç„¶åšåˆ°æ•°æ®éš”ç¦»å’Œæ¸…æ´—ï¼›</li><li>æ”¯æŒ structã€sliceã€sql stmtã€sql file å¤šç§æ–¹å¼è¿›è¡Œæ•°æ®åˆå§‹åŒ–ï¼Œæ”¯æŒéœ€è¦å‰ç½®æ•°æ®çš„ä¸šåŠ¡é€»è¾‘æµ‹è¯•ã€‚</li></ol><h3 id="éšæœºæ¦‚ç‡é€»è¾‘æ€ä¹ˆæµ‹">éšæœºæ¦‚ç‡é€»è¾‘æ€ä¹ˆæµ‹</h3><p>åœºæ™¯ï¼šéšæœºæŠ½å¥–</p><p>éš¾ç‚¹ï¼šéšæœºæ¦‚ç‡çš„ç»“æœæ˜¯ä¸ç¡®å®šçš„ï¼Œç›´æ¥é€šè¿‡ <code>assert.Equal</code> æ˜¯æ— æ³•å†™å‡ºå¯ç¨³å®šé‡å¤è¿è¡Œçš„å•æµ‹çš„ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AssertMapRatioEqual æ£€æŸ¥å®é™…è®¡æ•°çš„æ¯”ä¾‹æ˜¯å¦ç¬¦åˆé¢„æœŸæƒé‡çš„æ¯”ä¾‹</span></span><br><span class="line"><span class="comment">// actual: å®é™…è·å¾—çš„è®¡æ•° map[id]count</span></span><br><span class="line"><span class="comment">// expected: é¢„æœŸçš„æƒé‡ map[id]weight</span></span><br><span class="line"><span class="comment">// tolerance: å…è®¸çš„è¯¯å·®èŒƒå›´ï¼ˆå¦‚ 0.05 è¡¨ç¤ºå…è®¸ 5% çš„è¯¯å·®ï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">AssertMapRatioEqual</span><span class="params">(t *testing.T, actual <span class="keyword">map</span>[<span class="type">int64</span>]<span class="type">int64</span>, expected <span class="keyword">map</span>[<span class="type">int64</span>]<span class="type">int64</span>, tolerance <span class="type">float64</span>)</span></span> &#123;</span><br><span class="line">    t.Helper()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¡ç®—æ€»æ•°</span></span><br><span class="line">    <span class="keyword">var</span> actualTotal, expectedTotal <span class="type">int64</span></span><br><span class="line">    <span class="keyword">for</span> _, count := <span class="keyword">range</span> actual &#123;</span><br><span class="line">        actualTotal += count</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> _, weight := <span class="keyword">range</span> expected &#123;</span><br><span class="line">        expectedTotal += weight</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ¯ä¸ª ID çš„æ¯”ä¾‹</span></span><br><span class="line">    <span class="keyword">for</span> id, expectedWeight := <span class="keyword">range</span> expected &#123;</span><br><span class="line">        actualCount, exists := actual[id]</span><br><span class="line">        <span class="keyword">if</span> !exists &#123;</span><br><span class="line">            t.Errorf(<span class="string">&quot;ID %d åœ¨å®é™…ç»“æœä¸­ä¸å­˜åœ¨&quot;</span>, id)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        expectedRatio := <span class="type">float64</span>(expectedWeight) / <span class="type">float64</span>(expectedTotal)</span><br><span class="line">        actualRatio := <span class="type">float64</span>(actualCount) / <span class="type">float64</span>(actualTotal)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> diff := math.Abs(expectedRatio - actualRatio); diff &gt; tolerance &#123;</span><br><span class="line">            t.Errorf(<span class="string">&quot;ID %d çš„æ¯”ä¾‹ä¸ç¬¦åˆé¢„æœŸ: æœŸæœ› %.3f, å®é™… %.3f, å·®å¼‚ %.3f, è¶…å‡ºå…è®¸è¯¯å·® %.3f&quot;</span>,</span><br><span class="line">                id, expectedRatio, actualRatio, diff, tolerance)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ˜¯å¦æœ‰å¤šä½™çš„ ID</span></span><br><span class="line">    <span class="keyword">for</span> id := <span class="keyword">range</span> actual &#123;</span><br><span class="line">        <span class="keyword">if</span> _, exists := expected[id]; !exists &#123;</span><br><span class="line">            t.Errorf(<span class="string">&quot;å®é™…ç»“æœä¸­å­˜åœ¨æœªé¢„æœŸçš„ ID: %d&quot;</span>, id)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¡ˆä¾‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestLottery_randOnce</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    t.Run(<span class="string">&quot;å¤§é‡æŠ½å–åº”ç¬¦åˆæƒé‡é…ç½®æ¯”ä¾‹&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">        gotCount := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">int64</span>]<span class="type">int64</span>)</span><br><span class="line">        totalCount := <span class="type">int64</span>(<span class="number">10000</span>)</span><br><span class="line">        <span class="keyword">for</span> i := <span class="type">int64</span>(<span class="number">0</span>); i &lt; totalCount; i++ &#123;</span><br><span class="line">            reward, err := lotteryOnce(<span class="number">0</span>, <span class="number">0</span>, <span class="literal">nil</span>)</span><br><span class="line">            assert.Nil(t, err)</span><br><span class="line">            assert.NotNil(t, reward)</span><br><span class="line">            gotCount[reward.Id] += <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        expectedRatio := <span class="keyword">map</span>[<span class="type">int64</span>]<span class="type">int64</span>&#123;</span><br><span class="line">            <span class="number">1</span>: <span class="number">10</span>,</span><br><span class="line">            <span class="number">2</span>: <span class="number">20</span>,</span><br><span class="line">            <span class="number">3</span>: <span class="number">30</span>,</span><br><span class="line">            <span class="number">4</span>: <span class="number">40</span>,</span><br><span class="line">            <span class="number">5</span>: <span class="number">40</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        testutil.AssertMapRatioEqual(t, gotCount, expectedRatio, <span class="number">0.05</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="HTTP-æ¥å£æ€ä¹ˆæµ‹">HTTP æ¥å£æ€ä¹ˆæµ‹</h3><p>æŒ‘æˆ˜ï¼š</p><ol><li>å¦‚ä½•å¿«é€Ÿæ„å»ºè¯·æ±‚ä½“å¹¶å‘é€è¯·æ±‚ï¼Ÿ</li><li>å¦‚ä½•å¿«é€Ÿæ–­è¨€å¼‚å¸¸æƒ…å†µï¼Ÿ</li><li>å¦‚ä½•å¿«é€Ÿæ–­è¨€æˆåŠŸæƒ…å†µï¼Œå¹¶è§£æå‡ºæœŸæœ›çš„è¿”å›å€¼ï¼Ÿ</li></ol><h4 id="1-æ„é€ è¯·æ±‚">1. æ„é€ è¯·æ±‚</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¿«é€Ÿåˆ›å»ºè¯·æ±‚ä½“ form è¡¨å•æ ¼å¼</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewHTTPPostRequest</span><span class="params">(path <span class="type">string</span>, data any)</span></span> *http.Request &#123;</span><br><span class="line">    req := httptest.NewRequest(<span class="string">&quot;POST&quot;</span>, path, NewHTTPBody(data))</span><br><span class="line">    req.Header.Set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> req</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewHTTPBody</span><span class="params">(data any)</span></span> io.Reader &#123;</span><br><span class="line">    values := url.Values&#123;&#125;</span><br><span class="line">    v := reflect.ValueOf(data)</span><br><span class="line">    t := v.Type()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> v.Kind() == reflect.Ptr &#123;</span><br><span class="line">        v = v.Elem()</span><br><span class="line">        t = v.Type()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> v.Kind() != reflect.Struct &#123;</span><br><span class="line">        <span class="keyword">return</span> strings.NewReader(values.Encode())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; t.NumField(); i++ &#123;</span><br><span class="line">        field := t.Field(i)</span><br><span class="line">        value := v.Field(i)</span><br><span class="line"></span><br><span class="line">        tag := field.Tag.Get(<span class="string">&quot;form&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> tag == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¤„ç†å¤æ‚ç±»å‹ï¼ˆç»“æ„ä½“ã€åˆ‡ç‰‡ã€mapï¼‰</span></span><br><span class="line">        <span class="keyword">switch</span> value.Kind() &#123;</span><br><span class="line">        <span class="keyword">case</span> reflect.Struct, reflect.Slice, reflect.Map:</span><br><span class="line">            jsonBytes, err := json.Marshal(value.Interface())</span><br><span class="line">            <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">                values.Set(tag, <span class="type">string</span>(jsonBytes))</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.Printf(<span class="string">&quot;Error marshaling %v: %v&quot;</span>, value.Kind(), err)</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="comment">// å¤„ç†å…¶ä»–ç±»å‹</span></span><br><span class="line">            values.Set(tag, fmt.Sprintf(<span class="string">&quot;%v&quot;</span>, value.Interface()))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> strings.NewReader(values.Encode())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-å‘é€è¯·æ±‚">2. å‘é€è¯·æ±‚</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">w := httptest.NewRecorder()</span><br><span class="line">sfRouterTest.ServeHTTP(w, request)</span><br></pre></td></tr></table></figure><h4 id="3-æ–­è¨€å¼‚å¸¸">3. æ–­è¨€å¼‚å¸¸</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AssertRspErr æ–­è¨€ http å“åº”å¼‚å¸¸ï¼ŒexpectedErr ä¸ºæœŸæœ›çš„é”™è¯¯ä¿¡æ¯</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">AssertRspErr</span><span class="params">(w *httptest.ResponseRecorder, t *testing.T, expectedErr <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">    assert.Equal(t, http.StatusOK, w.Code)</span><br><span class="line">    body := w.Result().Body</span><br><span class="line">    <span class="keyword">defer</span> body.Close()</span><br><span class="line">    rsp, err := FromHTTPResp[any](body)</span><br><span class="line">    assert.Nil(t, rsp)</span><br><span class="line">    assert.Equal(t, expectedErr, err.Error())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-æ–­è¨€æ­£ç¡®ä¸”è¿”å›å“åº”å€¼">4. æ–­è¨€æ­£ç¡®ä¸”è¿”å›å“åº”å€¼</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FromHTTPResp ä» http å“åº”ä¸­è§£æå‡ºæ•°æ®</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">FromHTTPResp</span>[<span class="title">T</span> <span class="title">any</span>]<span class="params">(resp io.ReadCloser)</span></span> (*T, <span class="type">error</span>) &#123;</span><br><span class="line">    body, err := io.ReadAll(resp)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; _ = resp.Close() &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> t httpResp[T]</span><br><span class="line">    err = json.Unmarshal(body, &amp;t)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> t.Code != <span class="number">200</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, errors.New(t.Message)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &amp;t.Data, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AssertRspOk æ–­è¨€ http å“åº”æˆåŠŸï¼Œå¹¶è¿”å›å“åº”ä½“ T</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">AssertRspOk</span>[<span class="title">T</span> <span class="title">any</span>]<span class="params">(w *httptest.ResponseRecorder, t *testing.T)</span></span> *T &#123;</span><br><span class="line">    assert.Equal(t, http.StatusOK, w.Code)</span><br><span class="line">    body := w.Result().Body</span><br><span class="line">    <span class="keyword">defer</span> body.Close()</span><br><span class="line">    rsp, err := FromHTTPResp[T](body)</span><br><span class="line">    assert.Nil(t, err)</span><br><span class="line">    assert.NotNil(t, rsp)</span><br><span class="line">    <span class="keyword">return</span> rsp</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œå…¶å®å°±è¿åäº†ä¸Šä¸€å¼ åé¢æ¡ˆä¾‹ä¸­çš„ç¬¬ 3 ç‚¹â€æ³„éœ²é¢†åŸŸçŸ¥è¯†åˆ°æµ‹è¯•ä¸­â€œï¼Œå› ä¸ºè¿™é‡Œæ¥å—å“åº”çš„æ—¶å€™ï¼Œè¿˜æ˜¯ä½¿ç”¨çš„é¢†åŸŸå¯¹è±¡ç»“æ„ï¼Œæ‰€ä»¥å¯èƒ½ä¼šå‡ºç°è´Ÿè´Ÿå¾—æ­£çš„æƒ…å†µï¼Œæ¯”å¦‚ä½ çš„å¯¹è±¡å­—æ®µåå°±æ˜¯æ‹¼å†™é”™è¯¯äº†ï¼Œä½†æ˜¯å› ä¸ºä½ ä¸šåŠ¡é€»è¾‘å’Œæ–­è¨€å¤„éƒ½æ˜¯ç”¨çš„ä¸€ä¸ªç»“æ„ï¼Œæ‰€ä»¥å†…éƒ¨å½¢æˆäº†å¾ªç¯ï¼Œå°±è´Ÿè´Ÿå¾—æ­£äº†ï¼Œä½†æ˜¯çœŸæ­£åˆ°äº†å®¢æˆ·ç«¯é‚£ï¼Œå°±è§£æå¤±è´¥äº†ã€‚</p><p>ä¸è¿‡åœ¨è¿™ä¸ªæƒ…å†µä¸‹ï¼Œç¬”è€…è®¤ä¸ºè¿™ä¸ªæƒ…å†µä¸‹çš„è¿™ç§é£é™©æ˜¯å¯ä»¥æ¥å—çš„ï¼Œè¿œç›–ä¸ä½å…¶å¸¦æ¥çš„æ•ˆç‡æå‡ã€‚</p></blockquote><h4 id="5-ç»„åˆèµ·æ¥">5. ç»„åˆèµ·æ¥</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SendHTTPRequest</span>[<span class="title">Rsp</span> <span class="title">any</span>]<span class="params">(t *testing.T, server HTTPServer, path <span class="type">string</span>, data any, errMsg ...<span class="type">string</span>)</span></span> *Rsp &#123;</span><br><span class="line">    req := NewHTTPPostRequest(path, data)</span><br><span class="line">    w := httptest.NewRecorder()</span><br><span class="line">    server.ServeHTTP(w, req)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(errMsg) &gt; <span class="number">0</span> &#123;</span><br><span class="line">        AssertRspErr(w, t, errMsg[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> AssertRspOk[Rsp](w, t)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6-æ¡ˆä¾‹">6. æ¡ˆä¾‹</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Test_GetCollectReward</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    t.Run(<span class="string">&quot;é‡å¤é¢†å–&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">        uid := buildUserInfo(&amp;UserInfo&#123;</span><br><span class="line">            Got: <span class="keyword">map</span>[<span class="type">int</span>][]<span class="type">int</span>&#123;</span><br><span class="line">                <span class="number">1</span>: &#123;<span class="number">1</span>&#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;, apiTest.svc)</span><br><span class="line">        _ = testutil.SendHTTPRequest[GetCollectRewardResp](t, routerTest,</span><br><span class="line">            <span class="string">&quot;/get_collect_reward&quot;</span>, &amp;GetCollectRewardReq&#123;</span><br><span class="line">                UID:       uid,</span><br><span class="line">                CollectID: <span class="number">1</span>,</span><br><span class="line">            &#125;, <span class="string">&quot;é‡å¤é¢†å–&quot;</span>) <span class="comment">// é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    t.Run(<span class="string">&quot;é¢†å–æˆåŠŸ&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">      uid := uuid.NewString()</span><br><span class="line">        rsp := testutil.SendHTTPRequest[GetCollectRewardResp](t, routerTest,</span><br><span class="line">            <span class="string">&quot;/get_collect_reward&quot;</span>, &amp;GetCollectRewardReq&#123;</span><br><span class="line">                UID:       uid,</span><br><span class="line">                CollectID: <span class="number">1</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        )</span><br><span class="line">        assert.NotNil(t, rsp.Reward) <span class="comment">// æ­£ç¡®ç»“æœ</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä¾èµ–æ—¶é—´çš„é€»è¾‘æ€ä¹ˆæµ‹">ä¾èµ–æ—¶é—´çš„é€»è¾‘æ€ä¹ˆæµ‹</h3><ol><li>å°½é‡ä¸è¦ä¾èµ–æ—¶é—´ã€‚</li><li>è€ƒè™‘å°†æ—¶é—´ä½œä¸ºå‚æ•°ï¼Œé¿å… <code>time.Now()</code>ã€‚</li></ol><p>ä¹Ÿå¯ä»¥å‚è€ƒï¼š</p><div class="tag-plugin link dis-select"><a class="link-card plain" title="" href="https://hedon.top/2025/03/06/go-lib-synctest/" target="_blank" rel="external nofollow noopener noreferrer" cardlink api="https://site-info-api-hedon.vercel.app/api/v1?url=https://hedon.top/2025/03/06/go-lib-synctest/" autofill="title,icon"><div class="left"><span class="title">https://hedon.top/2025/03/06/go-lib-synctest/</span><span class="cap link footnote">https://hedon.top/2025/03/06/go-lib-synctest/</span></div><div class="right"><div class="lazy img" data-bg="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/link/8f277b4ee0ecd.svg"></div></div></a></div><h3 id="å¹¶å‘é€»è¾‘æ€ä¹ˆæµ‹">å¹¶å‘é€»è¾‘æ€ä¹ˆæµ‹</h3><ul><li><code>go test</code> æ¨èå¼€å¯ <code>-race</code> ç”¨äºæ£€æµ‹å¹¶å‘å†²çªã€‚</li></ul><p>æ›´å¤šå¯å‚è€ƒï¼š</p><div class="tag-plugin link dis-select"><a class="link-card plain" title="" href="https://hedon.top/2025/03/06/go-lib-synctest/" target="_blank" rel="external nofollow noopener noreferrer" cardlink api="https://site-info-api-hedon.vercel.app/api/v1?url=https://hedon.top/2025/03/06/go-lib-synctest/" autofill="title,icon"><div class="left"><span class="title">https://hedon.top/2025/03/06/go-lib-synctest/</span><span class="cap link footnote">https://hedon.top/2025/03/06/go-lib-synctest/</span></div><div class="right"><div class="lazy img" data-bg="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/link/8f277b4ee0ecd.svg"></div></div></a></div>]]></content>
    
    
    <summary type="html">æœ¬æ–‡æ€»ç»“äº†è¯»è€…åœ¨é˜…è¯»ã€ŠUnit Testingã€‹ä¹¦ç±ä¸­çš„æ”¶è·å’Œæ€è€ƒã€‚</summary>
    
    
    
    <category term="è¯»ä¹¦ç¬”è®°" scheme="https://hedon.top/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="å•å…ƒæµ‹è¯•" scheme="https://hedon.top/tags/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/"/>
    
    <category term="è¯»ä¹¦ç¬”è®°" scheme="https://hedon.top/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>ä¹¦ç±æ‘˜æŠ„ä¸¨ã€ŠUnit Testing Principles, Practices, and Patternsã€‹</title>
    <link href="https://hedon.top/2025/04/09/note-unit-testing-excerpt/"/>
    <id>https://hedon.top/2025/04/09/note-unit-testing-excerpt/</id>
    <published>2025-04-09T04:52:14.000Z</published>
    <updated>2025-06-08T18:35:10.816Z</updated>
    
    <content type="html"><![CDATA[<p>Learning unit testing doesnâ€™t stop at mastering the technical bits of it, such as your favorite test framework, mocking library, and so on. Thereâ€™s much more to unit testing than the act of writing tests. You always have to achieve the best return on the time you invest in unit testing, minimizing the effort you put into tests and maximizing the benefits they provide. Achieving both things isnâ€™t an easy task.</p><ul><li>They grow effortlessly, donâ€™t require much maintenance, and can quickly adapt to their customersâ€™ ever-changing needs.</li></ul><p>The ratio between the production code and the test code could be anywhere between <code>1:1</code> and <code>1:3</code>.</p><h1>Coverage limitations</h1><ul><li>You canâ€™t guarantee that the test verifies all the possible outcomes of the system under test.</li><li>No coverage metric can take into account code paths in external libraries.</li></ul><h1>The goal of unit testing</h1><ol><li>lead to a better code design</li><li>enable sustainable(å¯æŒç»­çš„) growth of the software project</li></ol><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image.png" alt=""></p><p>the cost components of writing unit tests:</p><ol><li>refactoring the test when you refactor the underlying code</li><li>running the test on each code change</li><li>dealing with false alarms raised by the test</li><li>spending time reading the test when youâ€™re trying to understanding how the underlying code behaves</li></ol><p>a successful test suite must:</p><ol><li>integrated into the development cycle</li><li>targets only the most important parts of the code base<ol><li>ğŸ‘‰ğŸ»Â domain logic</li><li>infrastructure code</li><li>external services and dependencies</li><li>code that glues everything together</li></ol></li><li>provides maximum value with minimum maintenance costs<ol><li>recognize a valuable test (and, by extension, a test of low value)</li><li>write a valuable test</li></ol></li></ol><h1>What is a unit test?</h1><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%201.png" alt=""></p><ol><li>verifies a single unit of behavior</li><li>dose it quickly</li><li>dost it in isolation from other tests</li></ol><p>An integration test, then, is a test that doesnâ€™t meet one of these criteria.</p><p>End-to-end tests are a subset of integration tests.</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%202.png" alt=""></p><h1>How to structure a unit test?</h1><table><thead><tr><th>Type</th><th>Components</th></tr></thead><tbody><tr><td>AAA</td><td>Arrange - Act - Assert</td></tr><tr><td>GWT</td><td>Given - When - Then</td></tr></tbody></table><ol><li>avoid multiple arrange, act, and assert sections.</li><li>avoid if statements in tests.</li><li>name the test as if you were describing the scenario to a non-programmer who is familiar with the problem domain.</li><li>separate words with underscores.</li><li>structure a test is to make it tell a story about the problem domain</li></ol><h1>Four pillars of a good unit test</h1><blockquote><p><em>code is not an asset, itâ€™s a liability.</em></p></blockquote><ol><li><p><strong>protection against regressions</strong></p><ol><li>the amount of code that is executed during the test</li><li>the complexity of that code</li><li>the codeâ€™s domain significance</li></ol></li><li><p><strong>resistance to refactoring</strong></p><ol><li>the fewer false positives the test generates, the better</li><li>tests provides an early warning when you break exisiting functionality</li><li>you become confident that your code changes wonâ€™t lead to regressions</li><li>the more the test is coupled to the implementation details of the system under set(SUT), the more false alarms it generates</li><li>you need to make sure the test verifies the end result the SUT delivers: its observable behavior, not the steps it takes to do that.</li><li>the best way to structure a test is to make it tell a story about the problem domain</li></ol><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%203.png" alt=""></p></li><li><p><strong>fast feedback</strong></p></li><li><p><strong>maintainability</strong></p><ol><li>how hard it is to understand the test, which is a function of the testâ€™s size</li><li>how hard it is to run the test, which is a function of how many out-of-process dependencies the test works with directly</li></ol></li></ol><h2 id="The-intrinsic-connection-between-the-first-two-attributes">The intrinsic connection between the first two attributes</h2><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%204.png" alt=""></p><p>Type II Error:</p><ul><li>if functionality is broken, the test should fail, but if the test also passed, means it is not a good unit test, should if it fails, means it offers protection against regressions.</li></ul><p>Type I Error:</p><ul><li>if functionality is correct but the test fails, means that the test dose not test the nature of behavior. The good unit test should always pass when the functionality is correct. This would help us a lot when we try to do refactor. If we refactor the code correctly, but the unit tests always failed, means that the unit tests are not good enough, we need to optimize them.</li></ul><h1>An ideal test</h1><ul><li>value = <code>[0..1] * [0..1] * [0..1] * [0..1]</code>(corresponding to the four pillars)</li></ul><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%205.png" alt=""></p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%206.png" alt=""></p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%207.png" alt=""></p><h2 id="black-box-and-white-box-testing">black-box and white-box testing</h2><ol><li>choose black-box testing over white-box testing by default.</li><li>the only exception is when the test covers utility code with high algorithmic complexity</li><li>use code coverage tools to see which code branches are not exercised, but then turn around and test them as if you know nothing about the codeâ€™s internal structure.</li></ol><h1>Mock</h1><h2 id="types-of-test-doubles">types of test doubles</h2><ul><li>mock: help to emulate and examine <code>outcoming</code> interactions â€”â€” change state<ul><li>mock: generated by tools</li><li>spy: written manually</li></ul></li><li>stub: help to emulate <code>incoming</code> interactions â€”â€” get input data<ul><li>stub: can configure to return different values for different scenarios.</li><li>dummy: a simple, hardcoded value such as a null value or a made-up string.</li><li>fake: the same as a stub for most purposes, only except for its creation, it is usually implemented to replace a dependency that dose not yet exist</li></ul></li></ul><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%208.png" alt=""></p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%209.png" alt=""></p><blockquote><p>never asserting interactions with stubs.</p></blockquote><h2 id="Observable-behavior">Observable behavior</h2><ol><li>expose an <code>operation</code> that helps the client achieve one of its goals. An operation is a method that performs a calculation or incurs a side effect or both.</li><li>expose a <code>state</code> that helps the client achieve one of its goals. State is the current condition of the system.</li></ol><blockquote><p>Whether the code is observable behavior depends on who its client is and what the goals of that client are.</p></blockquote><blockquote><p>Ideally, the systemâ€™s public API surface should coincide with its observable behavior, and all its implementation details should be hidden from the eyes of the clients.</p></blockquote><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2010.png" alt=""></p><h2 id="Mocks-and-test-fragility">Mocks and test fragility</h2><ul><li><code>Intra-system</code> communications are communications between classes inside your application.</li><li><code>Inter-system</code> communications are when your application talks to other applications.</li></ul><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2011.png" alt=""></p><ol><li>The use of mocks is <code>beneficial</code> when verifying the communication pattern between your system and external applications.</li><li>Using mocks to verify communications between classes inside your system results in tests that couple to implementation details and therefore fall short of the <code>resistance-to-refactoring</code> metric.</li></ol><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2012.png" alt=""></p><h2 id="Types-of-dependencies">Types of dependencies</h2><ul><li><code>shared dependency</code>: a dependency shared by test (not production code)</li><li><code>out-of-process dependency</code>: a dependency hosted by a process other than the programâ€™s execution process (database, stmp server)</li><li><code>private dependency</code>: any dependency that is not shared</li></ul><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2013.png" alt=""></p><h1>Styles of unit testing</h1><ul><li><code>output-based</code>: only need to verify the output.</li><li><code>state-based</code>: the underlying code changes its own state, the state of its collaborators, or the state of an out-of-process dependency.</li><li><code>communication-based</code>: use mocks to verify communications between the SUT and its collaborators, to verify the communication situations.</li></ul><h2 id="compare">compare</h2><h3 id="protection-against-regressions">protection against regressions</h3><ul><li>for the most part, they are not very different</li><li>but overusing the <code>communication-based</code> style can result in shallow tests that verify only a thin slice of code and mock out everything else.</li></ul><h3 id="fast-feedback">fast feedback</h3><ul><li>for the most part, they are not very different</li><li><code>communication-based</code> testing can be slightly worse because the cost of mocks.</li></ul><h3 id="resistance-to-refactoring">resistance to refactoring</h3><ul><li><code>state-based</code> is the best one.</li><li><code>communication-based</code> is the worse one, because it is the most vulnerable to false alarms.</li></ul><h3 id="maintainability">maintainability</h3><ul><li><code>output-based</code> is the best one, because they do not deal with out-of-process dependencies.</li><li><code>state-based</code> is less maintainable because state verification takes up more space than output verification.</li><li><code>communication-based</code> is the worst one, it requires setting up test doubles and interaction assertions, and that takes up a lot of space.</li></ul><h2 id="functional-architecture">functional architecture</h2><p><code>*Functional architecture</code>* maximizes the amount of code written in a purely functional (immutable) way, while minimizing code that deals with side effects. <em>Immutable</em> means unchangeable: once an object is created, its state canâ€™t be modified. This is in contrast to a *mutable* object (changeable object), which can be modified after it is created.</p><p>Separate two kinds of code:</p><ul><li>code that make a decision</li><li>code that acts upon that decision</li></ul><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2014.png" alt=""></p><h2 id="Tips">Tips</h2><ul><li>Moving from using an out-of-process dependency to using mocks.</li><li>Moving from using mocks to using functional architecture</li></ul><h1>Four kinds of code</h1><ul><li>Domain model and algorithms</li><li>Trivial code</li><li>Controllers</li><li>Overcomplicated code</li></ul><h2 id="Tips-2">Tips</h2><ol><li>always write completed unit tests for <code>domain model the algorithms</code> code</li><li>never test <code>trivial code</code></li><li>write integration test for <code>controllers</code></li><li>do not write overcomplicated code, try to separate it into <code>domain model and algorithms</code> and <code>controllers</code></li></ol><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2015.png" alt=""></p><h2 id="Trade-off">Trade-off</h2><ul><li>domain model testability</li><li>controller simplicity</li><li>performance</li></ul><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2016.png" alt=""></p><ol><li>push all external reads and writes to the edges anyway</li><li>inject the out-of-process dependencies into the domain model</li><li><strong>split the decision-making process into more granular steps</strong> ğŸ‘ˆ<ol><li><code>CanExecute/Execute</code> pattern</li><li>domain events</li></ol></li></ol><h2 id="CanExecute-Execute-pattern">CanExecute/Execute pattern</h2><p>You can use <code>CanExecute/Execute</code> pattern to balance the <code>performance</code> and <code>testability</code> , but concedes controller simplicity, but it is manageable in most cases.</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2017.png" alt=""></p><h2 id="Domain-events">Domain events</h2><p>Domain events help track important changes in the domain model, and then convert those changes to calls to out-of-process dependencies. This pattern removes the tracking responsibility from the controller.</p><ul><li>extract a <code>DomainEvent</code> base class and introduce a base class for all domain classes, which would contain a collection of such events: <code>List&lt;DomainEvent&gt; events</code></li></ul><h1>Integration tests</h1><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2018.png" alt=""></p><ol><li>check as many of the business scenarioâ€™s edge cases as possible with unit tests</li><li>use integration tests to cover one happy path, as well as any edge cases that canâ€™t be covered by unit tests</li><li>if thereâ€™s no one path that goes through all happy paths, write additional integration testsâ€”as many as needed to capture communications with <strong>every</strong> external system</li><li>attempt to apply the <code>fail-fast principle</code> as a viable alternative to integration test.</li></ol><h2 id="two-types-of-out-of-process-dependencies">two types of out-of-process dependencies</h2><ul><li><code>managed dependencies</code>: only accessible through your application. it is implement details and should not be mock.</li><li><code>unmanaged dependencies</code>: you donâ€™t have full control over it. It is observable behavior and you should mock it.</li></ul><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2019.png" alt=""></p><h2 id="interface-misunderstand">interface misunderstand</h2><div class="tag-plugin quot"><p class="content" type="icon"><img class="icon prefix" src="https://bu.dusays.com/2022/10/24/63567d3e092ff.png" /><span class="text">ğŸ™‹ğŸ»â€â™€ï¸ Genuine abstractions are discovered, not invented.</span><img class="icon prefix" src="https://bu.dusays.com/2022/10/24/63567d3e0ab55.png" /></p></div><p>ğŸ‘‰ğŸ»Â For an interface to be a genuine abstraction, it must have at lease two implemtations.</p><p>The common reasoning behind the use of interfaces is that they help to:</p><ol><li>Abstract out-of-process dependencies, thus achieving loose coupling.</li><li>Add new functionality without changing the existing code, thus adhering to the <code>Open-Closed principle</code></li></ol><p>Misconceptions:</p><ol><li>Interfaces with a single implementation are not abstractions and donâ€™t provide loose coupling any more than concrete classes that implement those interfaces.</li><li>The second reason violates a more foundational principle: <code>YAGNI (You are not gonna need it)</code>.</li><li>The only reason to use interfaces for out-of-process dependencies it is to <code>enable testing</code>!</li><li>Do not introduce interfaces for out-of-process dependencies unless you need to mock out those dependencies.</li></ol><h2 id="integration-test-best-practices">integration test best practices</h2><ol><li>making domain model boundaries explicit</li><li>reducing the number of layers in the application</li><li>eliminating circular dependencies</li></ol><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2020.png" alt=""></p><h2 id="maximozing-mockâ€™s-value">maximozing mockâ€™s value</h2><ol><li><p>when mocking, always try to <strong>verify interactions with unmanaged dependencies at the very edges of your system</strong>.</p><blockquote><p>Mocking <code>IBus</code> instead of <code>IMessageBus</code> maximizes the mockâ€™s protection against regressions.</p></blockquote><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2021.png" alt=""></p></li><li><p>A call to an unmanaged dependency goes through several stages before it leaves your application. <strong>Pick the last such stage</strong>. It is the best way to ensure backward compatibility with external systems, which is the goal that mocks help you achieve.</p></li><li><p>In some cases, you can use <code>spy</code> instead of <code>mock</code> for more succinct and expressive.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Fact</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Changing_email_from_corporate_to_non_corporate</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> busSpy = <span class="keyword">new</span> BusSpy();</span><br><span class="line">    <span class="keyword">var</span> messageBus = <span class="keyword">new</span> MessageBus(busSpy);</span><br><span class="line">    <span class="keyword">var</span> loggerMock = <span class="keyword">new</span> Mock&lt;IDomainLogger&gt;();</span><br><span class="line">    <span class="keyword">var</span> sut = <span class="keyword">new</span> UserController(db, messageBus, loggerMock.Object);</span><br><span class="line"><span class="comment">/* ... */</span></span><br><span class="line">    busSpy.ShouldSendNumberOfMessages(<span class="number">1</span>)</span><br><span class="line">        .WithEmailChangedMessage(user.UserId, <span class="string">&quot;new@gmail.com&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h2 id="mocking-best-practices">mocking best practices</h2><ol><li>applying mocks to unmanaged dependencies only</li><li>verifying the interactions with those dependencies at the very edges of your system</li><li>using mocks in integration tests only, not in unit test</li><li>always verifying the number of calls made to the mock</li><li>do not rely on production code when making assertions. Use a separate set of literals and constants in tests.</li><li>mocking only types that you own<ol><li>always write your own adapters on top of third-party libraries and mock those adapters instead of the underlying types.</li><li>only expose features you need from the library</li><li>do that using your projectâ€™s domain language</li><li>this guideline dose not apply to in-process dependencies. There is no need to abstract in-memory or managed dependencies. Similarly, thereâ€™s no need to abstract an ORM as long as itâ€™s used for accessing a database that isnâ€™t visible to external applications.</li></ol></li></ol><h1>Testing the database</h1><h2 id="prerequisites">prerequisites</h2><ol><li><p>keeping the database in the source control system</p><ol><li>database schemas</li><li>reference data</li></ol></li><li><p>using a separate database instance for every developer</p></li><li><p>applying the migration-based approach to database delivery</p><blockquote><p>applying every modification to the database schema (including reference data) through migrations. Do not modify migrations once they are committed to the source control. If a migration is incorrect, create a new migration instead of fixing the old one. Make exceptions to this rule only when the incorrect migration can lead to data loss.</p></blockquote></li></ol><h2 id="transaction">transaction</h2><p>split the <code>Database</code> class into <code>repositories</code> and a <code>transaction</code>:</p><ul><li><code>repositories</code> are classes that enable access to and modification of the data in the database.</li><li><code>transaction</code> is a class that either commits or rolls back data updates in full. This will be a custom class relying on the underlying databaseâ€™s transactions to provide atomicity of data modification.</li></ul><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2022.png" alt=""></p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2023.png" alt=""></p><h2 id="tips">tips</h2><ol><li>use at least three transactions or units of work in an integrations test: one per each arrange, act and assert section.</li><li>your tests should not depend on the state of the database. Your tests should bring that state to the required condition on their own.</li><li>create two collections for unit and integrations, and then disable test parallelization in the collection with the integration test.</li><li>clean up data at the beginning of a test</li><li>write the SQL script manually. Itâ€™s simpler and gives you more granular control over the deletion process.</li><li>the best way to shorten integration is by extracting technical, non-business-related bits into private methods or helper classes.</li><li>only the most complex or important read operations should be test, disregard the rest.</li><li>do not test repositories directly, only as part of the overarching integration test suite.</li></ol><h1>Unit testing anti-patterns</h1><blockquote><p>âš ï¸ Do not do the things like below!</p></blockquote><ol><li><p>unit testing private methods</p><blockquote><p>Private methods are implementation details! Just test observable behaviors!</p></blockquote><blockquote><p><strong>If the private method is too complex to be tested as part of the public API that uses it, thatâ€™s an indication of a missing abstraction. Extract this abstraction into a separate class instead of making the private method public.</strong></p></blockquote></li><li><p>expose private state</p></li><li><p>leaking domain knowledges to tests</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CalculatorTests</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Fact</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Adding_two_numbers</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">int</span> value1 = <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">int</span> value2 = <span class="number">3</span>;</span><br><span class="line">        <span class="built_in">int</span> expected = value1 + value2;   <span class="comment">// &lt;-----The leakage</span></span><br><span class="line">        <span class="comment">// int expected = 4 // the better one</span></span><br><span class="line">        <span class="built_in">int</span> actual = Calculator.Add(value1, value2);</span><br><span class="line">        Assert.Equal(expected, actual);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>code pollution</p><blockquote><p>Code pollution is adding production code thatâ€™s only needed for testing.</p></blockquote></li><li><p>mocking concrete classes</p></li><li><p>working with time</p></li></ol>]]></content>
    
    
    <summary type="html">æœ¬æ–‡å¯¹ã€ŠUnit Testingã€‹çš„å…³é”®è§‚ç‚¹è¿›è¡Œäº†æ¢³ç†æ€»ç»“ã€‚</summary>
    
    
    
    <category term="ä¹¦ç±æ‘˜æŠ„" scheme="https://hedon.top/categories/%E4%B9%A6%E7%B1%8D%E6%91%98%E6%8A%84/"/>
    
    <category term="å•å…ƒæµ‹è¯•" scheme="https://hedon.top/categories/%E4%B9%A6%E7%B1%8D%E6%91%98%E6%8A%84/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/"/>
    
    
    <category term="å•å…ƒæµ‹è¯•" scheme="https://hedon.top/tags/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/"/>
    
    <category term="ä¹¦ç±æ‘˜æŠ„" scheme="https://hedon.top/tags/%E4%B9%A6%E7%B1%8D%E6%91%98%E6%8A%84/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€æ­¥æ­¥æ¨å¯¼å‡º MySQL æ•°æ®çš„åº•å±‚å­˜å‚¨ç»“æ„</title>
    <link href="https://hedon.top/2025/04/08/mysql-ibd/"/>
    <id>https://hedon.top/2025/04/08/mysql-ibd/</id>
    <published>2025-04-08T04:54:13.000Z</published>
    <updated>2025-04-15T16:25:59.245Z</updated>
    
    <content type="html"><![CDATA[<p>ä»¥ä¸‹å‡ä»¥ InnoDB å¼•æ“ä¸ºåŸºç¡€è¿›è¡Œåˆ†æã€‚å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰ 3 è¡Œæ•°æ®ï¼Œå¦‚ä¸‹ï¼š</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250408125932725.png" alt=""></p><p>å…¶ä¸­ï¼š</p><ul><li><code>id</code> æ˜¯ä¸»é”®ç´¢å¼•ã€‚</li><li><code>a</code> å’Œ <code>b</code> éƒ½æ˜¯æ•°æ®å­—æ®µã€‚</li><li><code>tx_id</code> æ˜¯éšè—å­—æ®µï¼Œè¡¨ç¤ºäº‹åŠ¡ idï¼Œç”¨äºå®ç° MVCCã€‚</li><li><code>rollback_ptr</code> æ˜¯å›æŒ‡é’ˆï¼Œç”¨äº undo logã€‚</li></ul><p>åœ¨å°†æ•°æ®å­˜å‚¨åˆ°æ–‡ä»¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šå°†è¿™ä¸‰è¡Œæ•°æ®è¿›è¡Œåºåˆ—åŒ–ï¼Œç„¶åä»¥äºŒè¿›åˆ¶æµçš„å½¢å¼å­˜å‚¨åˆ°æ–‡ä»¶ä¸­ã€‚</p><p>ç°åœ¨æˆ‘ä»¬è¦è§£å†³ç¬¬ä¸€ä¸ªé—®é¢˜ï¼š</p><div class="tag-plugin quot"><h4 class="content" id="å¦‚ä½•æŒ‰ç…§ä¸»é”®ï¼ˆidï¼‰æ’åºï¼Ÿ" type="icon"><img class="icon prefix" src="https://bu.dusays.com/2022/10/24/63567d3e07da3.png" /><span class="text">å¦‚ä½•æŒ‰ç…§ä¸»é”®ï¼ˆidï¼‰æ’åºï¼Ÿ</span><span class="empty"></span></h4></div><p>åœ¨ InnoDB ä¸­ï¼Œä¼šåœ¨æ¯ä¸€è¡Œçš„å‰é¢ï¼ŒåŠ ä¸€ä¸ª <code>next_record</code> å­—æ®µï¼Œç”¨äºæŒ‡å‘æ¯”å½“å‰æ•°æ® id å¤§çš„ä¸‹ä¸€æ¡æ•°æ®ï¼Œæˆ‘ä»¬å‡è®¾ä¸€è¡Œæ•°æ®å  20 ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆå°±å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250408130510505.png" alt=""></p><p>å¦å¤–ï¼Œä¸ºäº†ä¾¿äºå®šä½æ¯ä¸€è¡Œï¼ŒInnoDB ä¼šåœ¨æ¯ä¸€è¡Œå‰é¢å†åŠ ä¸€ä¸ªå­—æ®µ <code>heap_no</code>ï¼Œå®ƒçš„è§„åˆ™å¾ˆç®€å•ï¼Œå°±æ˜¯è‡ªå¢ï¼Œåœ¨å†…éƒ¨ä¼šç”¨äºå®šä½ä¸€è¡Œè®°å½•ï¼Œæ–¹ä¾¿ä¸Šé”ç­‰å„ç§æ“ä½œã€‚</p><p>æ‰€ä»¥ç°åœ¨çš„å­˜å‚¨ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250408130840634.png" alt=""></p><p>ç°åœ¨æˆ‘ä»¬æ¥è§£å†³è§£å†³ç¬¬äºŒä¸ªé—®é¢˜ï¼š</p><div class="tag-plugin quot"><h4 class="content" id="å¦‚ä½•å¿«é€Ÿå®šä½åˆ°èµ·ç‚¹ï¼ˆæœ€å°ï¼‰å’Œç»ˆç‚¹ï¼ˆæœ€å¤§ï¼‰ï¼Ÿ" type="icon"><img class="icon prefix" src="https://bu.dusays.com/2022/10/24/63567d3e07da3.png" /><span class="text">å¦‚ä½•å¿«é€Ÿå®šä½åˆ°èµ·ç‚¹ï¼ˆæœ€å°ï¼‰å’Œç»ˆç‚¹ï¼ˆæœ€å¤§ï¼‰ï¼Ÿ</span><span class="empty"></span></h4></div><p>åœ¨æœ€å‰é¢åŠ  2 æ¡ç‰¹æ®Šçš„è®°å½•ï¼š</p><ul><li><code>PAGE_NEW_INFIMUM</code>ï¼šæŒ‡å‘æœ€å°è®°å½•ã€‚</li><li><code>PAGE_NEW_SUPERMUM</code>ï¼šæœ€å¤§è®°å½•ï¼Œæœ€å¤§çš„ä¸€ä¸ª id ä¼šæŒ‡å‘å®ƒã€‚</li></ul><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250408130825820.png" alt=""></p><p>ç¬¬ä¸‰ä¸ªé—®é¢˜ï¼š</p><div class="tag-plugin quot"><h4 class="content" id="æ¯æ¬¡ select * from t where id = ? éƒ½è¦è¿›è¡Œ I/O æ“ä½œå—ï¼Ÿ" type="icon"><img class="icon prefix" src="https://bu.dusays.com/2022/10/24/63567d3e07da3.png" /><span class="text">æ¯æ¬¡ select * from t where id = ? éƒ½è¦è¿›è¡Œ I/O æ“ä½œå—ï¼Ÿ</span><span class="empty"></span></h4></div><p>å¾ˆæ˜¾ç„¶æ˜¯ä¸è¡Œçš„ï¼Œæ•ˆç‡å¤ªä½äº†ã€‚è¿™ä¸ªç›¸ä¿¡ç»å¤§å¤šæ•°è¯»è€…éƒ½çŸ¥é“ ï¼ŒInnoDB ä¼šä»¥ Pageï¼ˆé»˜è®¤ 16KBï¼‰ä¸ºæœ€å°å•ä½ï¼Œä¸€æ¬¡æ€§å°†æ•°æ®ä»ç£ç›˜åŠ è½½åˆ°å†…å­˜ä¸­ã€‚ä¸ºæ­¤ï¼Œéœ€è¦åœ¨æœ€å‰é¢å†åŠ ä¸€æ¡è®°å½•ï¼Œä¸”è¯¥è®°å½•çš„å‰ä¸‰è¡Œåˆ†åˆ«ä¸ºï¼š</p><ul><li><code>page_no</code>ï¼šé¡µå·ï¼Œè‡ªå¢ï¼ŒInnoDB æœ€å¤šæ”¯æŒ 32 ä½é¡µå·ï¼Œæ‰€ä»¥å­˜å‚¨ä¸Šé™æ˜¯ 16KB * 2^32^ = 64Tã€‚</li><li><code>prev_page</code>ï¼šæŒ‡å‘ä¸Šä¸€é¡µã€‚</li><li><code>next_page</code>ï¼šæŒ‡å‘ä¸‹ä¸€é¡µã€‚</li></ul><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250409000055738.png" alt=""></p><div class="tag-plugin quot"><h4 class="content" id="å¦‚æœä¸€ä¸ª Page æ”¾ä¸ä¸‹å‘¢ï¼Ÿ" type="icon"><img class="icon prefix" src="https://bu.dusays.com/2022/10/24/63567d3e07da3.png" /><span class="text">å¦‚æœä¸€ä¸ª Page æ”¾ä¸ä¸‹å‘¢ï¼Ÿ</span><span class="empty"></span></h4></div><p>å¾ˆæ˜¾ç„¶ï¼Œé‚£å°±è¦è¿›è¡Œåˆ†é¡µï¼Œå³æŒ‰ç…§ ID çš„é¡ºåºè¿›è¡Œä¸€åˆ†ä¸ºäºŒï¼Œå‰è€…å–èŒƒå›´ <code>[a, b)</code>ï¼Œåè€…å–èŒƒå›´ <code>[b, c)</code>ã€‚</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250408131632390.png" alt=""></p><div class="tag-plugin quot"><h4 class="content" id="å¦‚ä½•å¿«é€Ÿå®šä½åˆ°æ•°æ®åœ¨å“ªä¸ª Page ä¸Šå‘¢ï¼Ÿ" type="icon"><img class="icon prefix" src="https://bu.dusays.com/2022/10/24/63567d3e07da3.png" /><span class="text">å¦‚ä½•å¿«é€Ÿå®šä½åˆ°æ•°æ®åœ¨å“ªä¸ª Page ä¸Šå‘¢ï¼Ÿ</span><span class="empty"></span></h4></div><p>è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æ–°åˆ›å»ºä¸€ä¸ª Pageï¼Œä¸“é—¨ç”¨äºç®¡ç†è¿™äº›æ•°æ® Page çš„ï¼Œè¿™ä¸ª Page æˆ‘ä»¬è¿™é‡Œæš‚ä¸”ç§°ä¸ºç´¢å¼• Pageã€‚</p><p>å…¶ä¸­æ ¸å¿ƒæ•°æ®å°±æ˜¯ 2 ä¸ªï¼š</p><ul><li><code>min_id</code>ï¼šå³å½“å‰é¡µå­˜å‚¨çš„æœ€å°ä¸»é”® IDã€‚</li><li><code>page_no</code>ï¼šé¡µå·ï¼Œç”¨äºå®šä½åˆ° Pageã€‚</li></ul><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250408131810905.png" alt=""></p><p>è¿™æ˜¯ä»€ä¹ˆå‘€ï¼Ÿè¿™å…¶å®å°±æ˜¯ B+ æ ‘ï¼åœ¨æ–‡ä»¶å±‚é¢çš„å­˜å‚¨ï¼Œæ˜¯è¿ç»­å­˜å‚¨çš„ï¼Œä½†æ˜¯ä¸ºäº†ä¾¿äºç†è§£ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨é€»è¾‘å±‚é¢å°†å…¶ç»˜åˆ¶æˆ B+ æ ‘çš„å½¢æ€ã€‚å¦‚ä¸‹å›¾å¯ä»¥çœ‹åˆ°è¿™å…¶å®å°±æ˜¯ä¸€é¢— B+ æ ‘ã€‚</p><p>åœ¨ä¸»é”®ç´¢å¼•æ ‘ä¸Šï¼š</p><ol><li>å¶å­èŠ‚ç‚¹å­˜å‚¨çš„å°±æ˜¯å…·ä½“æŸä¸€è¡Œçš„æ•°æ®ï¼ˆèšç°‡ç´¢å¼•ï¼‰ã€‚</li><li>éå¶å­èŠ‚ç‚¹å­˜å‚¨çš„æ˜¯ç´¢å¼•ã€‚</li><li>æ¯ä¸€å±‚çš„èŠ‚ç‚¹ï¼Œéƒ½æ˜¯ä¸€æ¡æœ‰åºçš„åŒå‘é“¾è¡¨ã€‚</li></ol><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250408132026228.png" alt=""></p><div class="tag-plugin quot"><h4 class="content" id="å¦‚æœå¯¹éä¸»é”®ç´¢å¼• a åˆ›å»ºç´¢å¼•å‘¢ï¼Ÿ" type="icon"><img class="icon prefix" src="https://bu.dusays.com/2022/10/24/63567d3e07da3.png" /><span class="text">å¦‚æœå¯¹éä¸»é”®ç´¢å¼• a åˆ›å»ºç´¢å¼•å‘¢ï¼Ÿ</span><span class="empty"></span></h4></div><p>å› ä¸ºè¦å»ºç´¢å¼•ï¼Œæ‰€ä»¥éœ€è¦å…ˆå¯¹ a è¿›è¡Œæ’åºï¼Œç„¶åé’ˆå¯¹ a å»ºç«‹ä¸€é¢— b+ æ ‘ã€‚è€Œä¸”ç”±äº a æ˜¯éä¸»é”®ç´¢å¼•ï¼Œå³è¾…åŠ©ç´¢å¼•ï¼Œæ‰€ä»¥å¶å­èŠ‚ç‚¹å­˜å‚¨çš„æ˜¯ä¸»é”®çš„å€¼ï¼Œç”¨äºå›è¡¨ã€‚</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250408132300926.png" alt=""></p><div class="tag-plugin quot"><h4 class="content" id="å‡è®¾ a =15 çš„æ•°æ®éå¸¸å¤šï¼Œä¸€ä¸ª page æ”¾ä¸ä¸‹å‘¢ï¼Ÿ" type="icon"><img class="icon prefix" src="https://bu.dusays.com/2022/10/24/63567d3e07da3.png" /><span class="text">å‡è®¾ a =15 çš„æ•°æ®éå¸¸å¤šï¼Œä¸€ä¸ª page æ”¾ä¸ä¸‹å‘¢ï¼Ÿ</span><span class="empty"></span></h4></div><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250408132323227.png" alt=""></p><p>ä¼šåŠ å…¥ä¸»é”® ID ä½œä¸ºäºŒç»´æ’åºæ¥è¿›è¡Œåˆ†è£‚ï¼š</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250408132350638.png" alt=""></p><div class="tag-plugin quot"><h4 class="content" id="ä¼°ç®—ä¸€ä¸‹ä¸€ä¸ªä¸‰å±‚çš„ B+ æ ‘å¯ä»¥å­˜å‚¨å¤šå°‘æ¡æ•°æ®ï¼Ÿ" type="icon"><img class="icon prefix" src="https://bu.dusays.com/2022/10/24/63567d3e07da3.png" /><span class="text">ä¼°ç®—ä¸€ä¸‹ä¸€ä¸ªä¸‰å±‚çš„ B+ æ ‘å¯ä»¥å­˜å‚¨å¤šå°‘æ¡æ•°æ®ï¼Ÿ</span><span class="empty"></span></h4></div><ul><li>ä¸€ä¸ª Page æ˜¯ 16KB</li><li>å‡è®¾ 1 ä¸ª Page å¯ä»¥å­˜æ”¾ 1000 ä¸ª key</li><li>å‡è®¾ 1 ä¸ª Page å¯ä»¥å­˜æ”¾ 200 æ¡è®°å½•</li></ul><p>åŸºäºè¿™ç§ä¼°ç®—ï¼š</p><ul><li>ç¬¬ 1 å±‚ï¼š1 ä¸ªèŠ‚ç‚¹æ˜¯ 1 ä¸ª Pageï¼Œå­˜æ”¾ 1000 ä¸ª keyï¼Œå¯¹åº” 1000 ä¸ªåˆ†å‰</li><li>ç¬¬ 2 å±‚ï¼š1000 ä¸ªèŠ‚ç‚¹ 1000 ä¸ª Pageï¼Œå­˜æ”¾ 1000*1000 ä¸ª Keyï¼Œå¯¹åº” 1000*1000 ä¸ªåˆ†å‰</li><li>ç¬¬ 3 å±‚ï¼š1000*1000 ä¸ª Pageï¼Œæ¯ä¸ª Page 200 æ¡æ•°æ®ï¼Œå…± 1000*1000*200=2 äº¿æ¡æ•°æ® = 16KB*1000*1000=16GB</li></ul><p>ğŸ‚ğŸ‚ğŸ‚</p>]]></content>
    
    
    <summary type="html">æœ¬æ–‡ä»æœ€ç®€å•çš„æ•°æ®æ ¼å¼å¼€å§‹ï¼Œé€šè¿‡ä¸æ–­è§£å†³ä¸€ä¸ªä¸ªå…³é”®é—®é¢˜ï¼Œæœ€ç»ˆæ¨å¯¼å‡º MySQL æ•°æ®çš„åº•å±‚å­˜å‚¨ç»“æ„ï¼Œå³ B+ æ ‘ã€‚</summary>
    
    
    
    <category term="æ•°æ®åº“" scheme="https://hedon.top/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    <category term="mysql" scheme="https://hedon.top/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/"/>
    
    
    <category term="mysql" scheme="https://hedon.top/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>åœ¨ Hexo åšå®¢ä¸­ä¼˜é›…åœ°é›†æˆ Markmap æ€ç»´å¯¼å›¾</title>
    <link href="https://hedon.top/2025/03/17/mindmap-for-hexo/"/>
    <id>https://hedon.top/2025/03/17/mindmap-for-hexo/</id>
    <published>2025-03-17T10:21:18.000Z</published>
    <updated>2025-04-05T14:31:32.876Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨æŠ€æœ¯åšå®¢å†™ä½œä¸­ï¼Œæ€ç»´å¯¼å›¾æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„å·¥å…·ï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´æ¸…æ™°åœ°å±•ç¤ºçŸ¥è¯†ç»“æ„å’Œæ¦‚å¿µå…³ç³»ã€‚æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•åœ¨ Hexo åšå®¢ä¸­é›†æˆ Markmapï¼Œè®©ä½ èƒ½å¤Ÿç›´æ¥åœ¨ Markdown æ–‡ä»¶ä¸­åˆ›å»ºäº¤äº’å¼æ€ç»´å¯¼å›¾ã€‚</p><h2 id="ä»€ä¹ˆæ˜¯-Markmapï¼Ÿ">ä»€ä¹ˆæ˜¯ Markmapï¼Ÿ</h2><p>Markmap æ˜¯ä¸€ä¸ªå°† Markdown æ ¼å¼çš„æ–‡æœ¬è½¬æ¢ä¸ºæ€ç»´å¯¼å›¾çš„å¼€æºå·¥å…·ã€‚å®ƒå…è®¸æˆ‘ä»¬ä½¿ç”¨ç†Ÿæ‚‰çš„ Markdown è¯­æ³•æ¥åˆ›å»ºæ¼‚äº®çš„ã€äº¤äº’å¼çš„æ€ç»´å¯¼å›¾ã€‚</p><div class="tag-plugin link dis-select"><a class="link-card plain" title="" href="https://markmap.js.org/" target="_blank" rel="external nofollow noopener noreferrer" cardlink api="https://site-info-api-hedon.vercel.app/api/v1?url=https://markmap.js.org/" autofill="title,icon"><div class="left"><span class="title">https://markmap.js.org/</span><span class="cap link footnote">https://markmap.js.org/</span></div><div class="right"><div class="lazy img" data-bg="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/link/8f277b4ee0ecd.svg"></div></div></a></div><h2 id="å®ç°æ–¹æ¡ˆ">å®ç°æ–¹æ¡ˆ</h2><h3 id="1-å®‰è£…å¿…è¦ä¾èµ–">1. å®‰è£…å¿…è¦ä¾èµ–</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®‰è£… <code>uuid</code> åŒ…ï¼Œè¿™æ˜¯ç”¨æ¥ç»™æˆ‘ä»¬æ¯ä¸€ä¸ªæ€ç»´å¯¼å›¾ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ IDï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install uuid --save</span><br></pre></td></tr></table></figure><h3 id="2-åˆ›å»ºè‡ªå®šä¹‰æ ‡ç­¾æ’ä»¶">2. åˆ›å»ºè‡ªå®šä¹‰æ ‡ç­¾æ’ä»¶</h3><p>åœ¨ <code>scripts/markmap_tag.js</code> ä¸­åˆ›å»ºè‡ªå®šä¹‰æ ‡ç­¾ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Markmap Tag Plugin for Hexo</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; <span class="attr">v4</span>: uuidv4 &#125; = <span class="built_in">require</span>(<span class="string">&quot;uuid&quot;</span>);</span><br><span class="line"></span><br><span class="line">hexo.<span class="property">extend</span>.<span class="property">tag</span>.<span class="title function_">register</span>(</span><br><span class="line">  <span class="string">&quot;markmap&quot;</span>,</span><br><span class="line">  <span class="keyword">function</span> (<span class="params">args, content</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> id = <span class="title function_">uuidv4</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">&lt;div class=&quot;markmap&quot; id=&quot;markmap-<span class="subst">$&#123;id&#125;</span>&quot;&gt;</span></span><br><span class="line"><span class="string">  &lt;script type=&quot;text/template&quot;&gt;</span></span><br><span class="line"><span class="string"><span class="subst">$&#123;content&#125;</span></span></span><br><span class="line"><span class="string">  &lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;script&gt;</span></span><br><span class="line"><span class="string">document.addEventListener(&#x27;DOMContentLoaded&#x27;, () =&gt; &#123;</span></span><br><span class="line"><span class="string">  const template = document.querySelector(&#x27;#markmap-<span class="subst">$&#123;id&#125;</span> script[type=&quot;text/template&quot;]&#x27;);</span></span><br><span class="line"><span class="string">  if (template) &#123;</span></span><br><span class="line"><span class="string">    const content = template.textContent;</span></span><br><span class="line"><span class="string">    window.markmap.autoLoader.renderString(content, null, document.querySelector(&#x27;#markmap-<span class="subst">$&#123;id&#125;</span>&#x27;));</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;);</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br><span class="line"><span class="string">  `</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; <span class="attr">ends</span>: <span class="literal">true</span> &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h3 id="3-æ·»åŠ æ ·å¼">3. æ·»åŠ æ ·å¼</h3><p>åˆ›å»º <code>source/css/markmap.css</code>ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Markmap Styles */</span></span><br><span class="line"><span class="selector-class">.markmap</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">500px</span>;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">20px</span> <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#eaeaea</span>;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">5px</span>;</span><br><span class="line">  <span class="attribute">overflow</span>: hidden;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.markmap</span> <span class="selector-tag">svg</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å“åº”å¼è®¾è®¡ */</span></span><br><span class="line"><span class="keyword">@media</span> (<span class="attribute">max-width</span>: <span class="number">768px</span>) &#123;</span><br><span class="line">  <span class="selector-class">.markmap</span> &#123;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">400px</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@media</span> (<span class="attribute">max-width</span>: <span class="number">480px</span>) &#123;</span><br><span class="line">  <span class="selector-class">.markmap</span> &#123;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">300px</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-æ›´æ–°ä¸»é¢˜é…ç½®">4. æ›´æ–°ä¸»é¢˜é…ç½®</h3><p>åœ¨ä¸»é¢˜é…ç½®æ–‡ä»¶ä¸­æ·»åŠ å¿…è¦çš„èµ„æºå¼•ç”¨ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">inject:</span></span><br><span class="line">  <span class="attr">head:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&lt;link</span> <span class="string">rel=&quot;stylesheet&quot;</span> <span class="string">href=&quot;/css/markmap.css&quot;&gt;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&lt;script</span> <span class="string">src=&quot;https://cdn.jsdelivr.net/npm/markmap-autoloader@0.18&quot;&gt;&lt;/script&gt;</span></span><br></pre></td></tr></table></figure><h2 id="ä½¿ç”¨æ–¹æ³•">ä½¿ç”¨æ–¹æ³•</h2><div class="tag-plugin tabs" align="center"id="tab_1"><div class="nav-tabs"><div class="tab active"><a href="#tab_1-1">ä»£ç å—</a></div><div class="tab"><a href="#tab_1-2">æ•ˆæœ</a></div></div><div class="tab-content"><div class="tab-pane active" id="tab_1-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;% markmap %&#125;</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> æŠ€æœ¯æ ˆ</span><br><span class="line"><span class="bullet">  -</span> å‰ç«¯</span><br><span class="line"><span class="bullet">    -</span> Vue.js</span><br><span class="line"><span class="bullet">    -</span> React</span><br><span class="line"><span class="bullet">    -</span> Angular</span><br><span class="line"><span class="bullet">  -</span> åç«¯</span><br><span class="line"><span class="bullet">    -</span> Node.js</span><br><span class="line"><span class="bullet">    -</span> Python</span><br><span class="line"><span class="bullet">    -</span> Go</span><br><span class="line"><span class="bullet">  -</span> æ•°æ®åº“</span><br><span class="line"><span class="bullet">    -</span> MySQL</span><br><span class="line"><span class="bullet">    -</span> MongoDB</span><br><span class="line"><span class="bullet">    -</span> Redis</span><br><span class="line"></span><br><span class="line">&#123;% endmarkmap %&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="tab_1-2"><style>svg.markmap {        width: 100%;        height: 500px;      }</style><div class="markmap" id="markmap-7f6be6d7-0f68-41a7-95a6-96967fd643c9">  <script type="text/template"><ul><li><p>æŠ€æœ¯æ ˆ</p><ul><li>å‰ç«¯<ul><li>Vue.js</li><li>React</li><li>Angular</li></ul></li><li>åç«¯<ul><li>Node.js</li><li>Python</li><li>Go</li></ul></li><li>æ•°æ®åº“<ul><li>MySQL</li><li>MongoDB</li><li>Redis</li></ul></li></ul></script></li></ul></div></div></div></div><h2 id="å·¥ä½œåŸç†">å·¥ä½œåŸç†</h2><h3 id="1-Hexo-æ’ä»¶ç³»ç»Ÿ">1. Hexo æ’ä»¶ç³»ç»Ÿ</h3><ul><li>Hexo æä¾›äº†å¼ºå¤§çš„æ’ä»¶ç³»ç»Ÿï¼Œå…è®¸æˆ‘ä»¬é€šè¿‡ <code>hexo.extend</code> API æ¥æ‰©å±•åŠŸèƒ½</li><li>æˆ‘ä»¬ä½¿ç”¨äº† <code>hexo.extend.tag</code> æ¥æ³¨å†Œè‡ªå®šä¹‰æ ‡ç­¾ï¼Œè¿™æ˜¯ Hexo æä¾›çš„æ ‡å‡†æ‰©å±•ç‚¹ä¹‹ä¸€</li></ul><h3 id="2-æ ‡ç­¾æ’ä»¶çš„å·¥ä½œåŸç†">2. æ ‡ç­¾æ’ä»¶çš„å·¥ä½œåŸç†</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">hexo.<span class="property">extend</span>.<span class="property">tag</span>.<span class="title function_">register</span>(</span><br><span class="line">  <span class="string">&quot;markmap&quot;</span>,</span><br><span class="line">  <span class="keyword">function</span> (<span class="params">args, content</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> id = <span class="title function_">uuidv4</span>(); <span class="comment">// ç”Ÿæˆå”¯ä¸€ID</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;markmap&quot; id=&quot;markmap-<span class="subst">$&#123;id&#125;</span>&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;script type=&quot;text/template&quot;&gt;</span></span><br><span class="line"><span class="string">        <span class="subst">$&#123;content&#125;</span></span></span><br><span class="line"><span class="string">      &lt;/script&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">    ...</span></span><br><span class="line"><span class="string">  `</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; <span class="attr">ends</span>: <span class="literal">true</span> &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><ul><li>å½“ Hexo è§£æåˆ° <code>markmap</code> æ ‡ç­¾æ—¶ï¼Œä¼šè°ƒç”¨è¿™ä¸ªæ³¨å†Œçš„å‡½æ•°</li><li><code>content</code> å‚æ•°åŒ…å«äº†æ ‡ç­¾ä¹‹é—´çš„æ‰€æœ‰å†…å®¹ï¼ˆä½ çš„ markdown ç»“æ„ï¼‰</li><li><code>&#123;ends: true&#125;</code> è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªé—­åˆæ ‡ç­¾ï¼ˆéœ€è¦ endmarkmap ç»“æŸï¼‰</li></ul><h3 id="3-Markmap-åº“çš„æ¸²æŸ“è¿‡ç¨‹">3. Markmap åº“çš„æ¸²æŸ“è¿‡ç¨‹</h3><ul><li>Markmap åº“ä½¿ç”¨ <code>markmap-autoloader</code> è‡ªåŠ¨å¤„ç† markdown åˆ°æ€ç»´å¯¼å›¾çš„è½¬æ¢</li><li>è½¬æ¢è¿‡ç¨‹ï¼š<ol><li>Markdown æ–‡æœ¬è¢«è§£ææˆå±‚çº§ç»“æ„</li><li>å±‚çº§ç»“æ„è¢«è½¬æ¢ä¸º SVG è·¯å¾„</li><li>SVG è¢«æ¸²æŸ“åˆ°é¡µé¢ä¸Šï¼Œå¹¶æ·»åŠ äº¤äº’åŠŸèƒ½</li></ol></li></ul><h3 id="4-HTML-ç»“æ„è®¾è®¡">4. HTML ç»“æ„è®¾è®¡</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;markmap&quot;</span> <span class="attr">id</span>=<span class="string">&quot;markmap-$&#123;id&#125;&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/template&quot;</span>&gt;</span></span><br><span class="line">    $&#123;content&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>ä½¿ç”¨ <code>script type=&quot;text/template&quot;</code> æ¥å­˜å‚¨åŸå§‹ markdown</li><li>æ¯ä¸ªæ€ç»´å¯¼å›¾éƒ½æœ‰å”¯ä¸€ IDï¼Œé¿å…é¡µé¢ä¸Šå¤šä¸ªå›¾è¡¨äº’ç›¸å¹²æ‰°</li></ul><h3 id="5-JavaScript-åˆå§‹åŒ–">5. JavaScript åˆå§‹åŒ–</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;DOMContentLoaded&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> template = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(</span><br><span class="line">    <span class="string">&#x27;#markmap-$&#123;id&#125; script[type=&quot;text/template&quot;]&#x27;</span></span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">if</span> (template) &#123;</span><br><span class="line">    <span class="keyword">const</span> content = template.<span class="property">textContent</span>;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">markmap</span>.<span class="property">autoLoader</span>.<span class="title function_">renderString</span>(</span><br><span class="line">      content,</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#markmap-$&#123;id&#125;&quot;</span>)</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ul><li>ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ</li><li>è·å–æ¨¡æ¿ä¸­çš„ markdown å†…å®¹</li><li>ä½¿ç”¨ markmap åº“æ¸²æŸ“æ€ç»´å¯¼å›¾</li></ul><h3 id="6-æ ·å¼æ§åˆ¶">6. æ ·å¼æ§åˆ¶</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.markmap</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">500px</span>;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">20px</span> <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#eaeaea</span>;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">5px</span>;</span><br><span class="line">  <span class="attribute">overflow</span>: hidden;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æä¾›å“åº”å¼å¸ƒå±€</li><li>ç¡®ä¿æ€ç»´å¯¼å›¾åœ¨å„ç§å±å¹•å°ºå¯¸ä¸‹éƒ½èƒ½æ­£å¸¸æ˜¾ç¤º</li></ul><h3 id="7-ä¸»é¢˜é›†æˆ">7. ä¸»é¢˜é›†æˆ</h3><ul><li>åœ¨ä¸»é¢˜é…ç½®ä¸­æ³¨å…¥å¿…è¦çš„ CSS å’Œ JavaScript</li><li>ç¡®ä¿èµ„æºåœ¨æ­£ç¡®çš„æ—¶æœºåŠ è½½</li></ul>]]></content>
    
    
    <summary type="html">æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†å¦‚ä½•åœ¨ Hexo åšå®¢ä¸­ä¼˜é›…åœ°é›†æˆ Markmap æ€ç»´å¯¼å›¾ï¼Œè®©ä½ èƒ½å¤Ÿç›´æ¥åœ¨ Markdown æ–‡ä»¶ä¸­åˆ›å»ºäº¤äº’å¼æ€ç»´å¯¼å›¾ã€‚åŒæ—¶è¿™ä¹Ÿæ˜¯ä¸€ä¸ª Hexo æ’ä»¶çš„æ ‡å‡†å®ç°æ¡ˆä¾‹ã€‚</summary>
    
    
    
    <category term="å°æŠ€æœ¯" scheme="https://hedon.top/categories/%E5%B0%8F%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="hexo" scheme="https://hedon.top/tags/hexo/"/>
    
    <category term="markmap" scheme="https://hedon.top/tags/markmap/"/>
    
  </entry>
  
  <entry>
    <title>ä¸ºä»€ä¹ˆ OpenTelemetry çš„ SDK ä¸­ä¸æ”¯æŒå°¾é‡‡æ · Hookï¼Ÿ</title>
    <link href="https://hedon.top/2025/03/13/opentelemetry-tail-sampler/"/>
    <id>https://hedon.top/2025/03/13/opentelemetry-tail-sampler/</id>
    <published>2025-03-13T07:10:27.000Z</published>
    <updated>2025-04-05T14:31:32.877Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿä¸­ï¼Œé‡‡æ ·ç­–ç•¥ç›´æ¥å½±å“ç€ç³»ç»Ÿçš„æ€§èƒ½å’Œå¯è§‚æµ‹æ€§ã€‚OpenTelemetry ä½œä¸ºå½“å‰æœ€æµè¡Œçš„å¯è§‚æµ‹æ€§æ¡†æ¶ï¼Œå…¶é‡‡æ ·æœºåˆ¶è®¾è®¡æœ‰ç€æ·±åˆ»çš„è€ƒé‡ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨ OpenTelemetry çš„é‡‡æ ·æœºåˆ¶ï¼Œç‰¹åˆ«æ˜¯ä¸ºä»€ä¹ˆå®ƒåœ¨ SDK å±‚é¢ä¸æ”¯æŒå°¾é‡‡æ ·ã€‚</p><h2 id="å‰ç½®é‡‡æ ·-vs-å°¾é‡‡æ ·">å‰ç½®é‡‡æ · vs å°¾é‡‡æ ·</h2><p>åœ¨è®¨è®º OpenTelemetry çš„é‡‡æ ·æœºåˆ¶å‰ï¼Œæˆ‘ä»¬éœ€è¦ç†è§£ä¸¤ç§ä¸»è¦çš„é‡‡æ ·ç­–ç•¥ï¼š</p><p><strong>å‰ç½®é‡‡æ ·ï¼ˆHead-based Samplingï¼‰</strong>ï¼š</p><ul><li>åœ¨é“¾è·¯å¼€å§‹æ—¶å°±å†³å®šæ˜¯å¦é‡‡æ ·</li><li>å†³ç­–ä¸€æ—¦åšå‡ºï¼Œæ•´ä¸ªé“¾è·¯éƒ½éµå¾ªè¿™ä¸ªå†³ç­–</li><li>ä¸éœ€è¦ç¼“å­˜å®Œæ•´çš„é“¾è·¯æ•°æ®</li></ul><p><strong>å°¾é‡‡æ ·ï¼ˆTail-based Samplingï¼‰</strong>ï¼š</p><ul><li>åœ¨é“¾è·¯ç»“æŸåå†³å®šæ˜¯å¦ä¿ç•™</li><li>å¯ä»¥åŸºäºå®Œæ•´é“¾è·¯ä¿¡æ¯ï¼ˆå¦‚æ€»è€—æ—¶ã€æ˜¯å¦æœ‰é”™è¯¯ï¼‰åšå†³ç­–</li><li>éœ€è¦ä¸´æ—¶ç¼“å­˜æ‰€æœ‰é“¾è·¯æ•°æ®</li></ul><h2 id="OpenTelemetry-çš„é‡‡æ ·å®ç°">OpenTelemetry çš„é‡‡æ ·å®ç°</h2><p>é€šè¿‡åˆ†æ <a href="https://github.com/open-telemetry/opentelemetry-go/blob/v1.35.0/sdk/trace/tracer.go#L65">OpenTelemetry Go SDK çš„æºç </a>ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°å®ƒé‡‡ç”¨çš„æ˜¯å‰ç½®é‡‡æ ·ç­–ç•¥ã€‚å…³é”®ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(tr *tracer)</span></span> newSpan(ctx context.Context, name <span class="type">string</span>, config *trace.SpanConfig) trace.Span &#123;</span><br><span class="line">    <span class="comment">// ... å‰é¢çš„ä»£ç  ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰§è¡Œé‡‡æ ·å†³ç­–</span></span><br><span class="line">    samplingResult := tr.provider.sampler.ShouldSample(SamplingParameters&#123;</span><br><span class="line">        ParentContext: ctx,</span><br><span class="line">        TraceID:       tid,</span><br><span class="line">        Name:          name,</span><br><span class="line">        Kind:          config.SpanKind(),</span><br><span class="line">        Attributes:    config.Attributes(),</span><br><span class="line">        Links:         config.Links(),</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®é‡‡æ ·æ ‡å¿—</span></span><br><span class="line">    <span class="keyword">if</span> isSampled(samplingResult) &#123;</span><br><span class="line">        scc.TraceFlags = psc.TraceFlags() | trace.FlagsSampled</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        scc.TraceFlags = psc.TraceFlags() &amp;^ trace.FlagsSampled</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... åé¢çš„ä»£ç  ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç æ­ç¤ºäº†å‡ ä¸ªå…³é”®ç‚¹ï¼š</p><ol><li>é‡‡æ ·å†³ç­–åœ¨ span åˆ›å»ºæ—¶å°±å·²ç»åšå‡º</li><li>é‡‡æ ·æ ‡å¿—é€šè¿‡ä½æ“ä½œè®¾ç½®åœ¨ TraceFlags ä¸­</li><li>è¿™ä¸ªæ ‡å¿—ä¼šéšç€ SpanContext ä¼ æ’­åˆ°æ•´ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿ</li></ol><h2 id="é‡‡æ ·æ ‡å¿—çš„ä¼ æ’­æœºåˆ¶">é‡‡æ ·æ ‡å¿—çš„ä¼ æ’­æœºåˆ¶</h2><p>ç‰¹åˆ«å€¼å¾—æ³¨æ„çš„æ˜¯è®¾ç½®é‡‡æ ·æ ‡å¿—çš„ä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> isSampled(samplingResult) &#123;</span><br><span class="line">    scc.TraceFlags = psc.TraceFlags() | trace.FlagsSampled</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    scc.TraceFlags = psc.TraceFlags() &amp;^ trace.FlagsSampled</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ä½¿ç”¨ä½æ“ä½œæ¥è®¾ç½®æˆ–æ¸…é™¤é‡‡æ ·æ ‡å¿—ï¼š</p><ul><li><code>|</code> æ“ä½œç”¨äºè®¾ç½®é‡‡æ ·æ ‡å¿—ï¼Œä¿ç•™å…¶ä»–æ ‡å¿—ä½ä¸å˜</li><li><code>&amp;^</code> æ“ä½œç”¨äºæ¸…é™¤é‡‡æ ·æ ‡å¿—ï¼ŒåŒæ ·ä¿ç•™å…¶ä»–æ ‡å¿—ä½ä¸å˜</li></ul><p>è¿™ç¡®ä¿äº†é‡‡æ ·å†³ç­–èƒ½å¤Ÿä¸€è‡´åœ°ä¼ æ’­åˆ°æ•´ä¸ªåˆ†å¸ƒå¼é“¾è·¯ä¸­ã€‚</p><h2 id="ä¸ºä»€ä¹ˆ-OpenTelemetry-ä¸æ”¯æŒå°¾é‡‡æ ·ï¼Ÿ">ä¸ºä»€ä¹ˆ OpenTelemetry ä¸æ”¯æŒå°¾é‡‡æ ·ï¼Ÿ</h2><p>æœ€é‡è¦çš„åŸå› æ˜¯ï¼š<font color="red">åœ¨ SDK ä¸­æ‰¾ä¸åˆ°å°¾å·´ï¼å› ä¸ºä¸çŸ¥é“é“¾è·¯ä»€ä¹ˆæ—¶å€™ç»“æŸï¼</font></p><p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¸€æ¡é“¾è·¯å¯èƒ½è·¨è¶Šå¤šä¸ªæœåŠ¡ï¼Œæ‰€ä»¥ä½ åœ¨æŸä¸€ä¸ªæœåŠ¡ä¸­ï¼Œæ˜¯ä¸çŸ¥é“é“¾è·¯æ˜¯å¦ç»“æŸçš„ï¼Œè€Œ OpenTelemetry ä¹Ÿä¸æ˜¯ä¸€æ¬¡æ€§ä¸ŠæŠ¥ä¸€æ•´æ¡é“¾è·¯ï¼Œè€Œæ˜¯æ¯ä¸ª <code>span</code> ç‹¬ç«‹ä¸ŠæŠ¥ï¼Œæœ€åå†æ‹¼æ¥åˆ°ä¸€èµ·ã€‚</p><h3 id="OpenTelemetry-ä¸ŠæŠ¥åŸç†">OpenTelemetry ä¸ŠæŠ¥åŸç†</h3><ol><li><p>ç‹¬ç«‹ä¸ŠæŠ¥</p><ul><li><p>æ¯ä¸ª <code>span</code> åœ¨ç»“æŸæ—¶ï¼ˆè°ƒç”¨ <code>span.End()</code>ï¼‰ä¼šè¢«ä¼ é€’ç»™ <code>SpanProcessor</code></p></li><li><p><code>SpanProcessor</code> å†³å®šå¦‚ä½•å¤„ç†è¿™ä¸ª <code>span</code>ï¼ˆç«‹å³å¯¼å‡ºæˆ–æ‰¹é‡å¯¼å‡ºï¼‰</p></li><li><p>å¯¼å‡ºæ˜¯ç‹¬ç«‹çš„ï¼Œä¸ä¼šç­‰å¾…æ•´ä¸ª <code>trace</code> å®Œæˆ</p></li></ul></li><li><p>æ‰¹å¤„ç†æœºåˆ¶</p><ul><li><p>é»˜è®¤ä½¿ç”¨ <code>BatchSpanProcessor</code>ï¼Œå®ƒä¼šæ”¶é›†ä¸€å®šæ•°é‡çš„ <code>spans</code> æˆ–ç­‰å¾…ä¸€å®šæ—¶é—´ç„¶åæ‰¹é‡å¯¼å‡º</p></li><li><p>ä½†è¿™ä¸ªæ‰¹å¤„ç†ä¸ <code>trace</code> å®Œæ•´æ€§æ— å…³ï¼Œåªæ˜¯ä¸ºäº†æ•ˆç‡</p></li></ul></li></ol><h3 id="Collector-å¦‚ä½•å®ç°å°¾é‡‡æ ·">Collector å¦‚ä½•å®ç°å°¾é‡‡æ ·</h3><p>Collector é€šè¿‡ä»¥ä¸‹æ–¹å¼è§£å†³è¿™äº›é—®é¢˜ï¼š</p><ol><li><p>è®¾ç½®ç­‰å¾…æ—¶é—´çª—å£</p><ul><li><p>ä¸ºæ¯ä¸ª trace è®¾ç½®ä¸€ä¸ªç­‰å¾…æœŸï¼ˆå¦‚ 10 ç§’ï¼‰</p></li><li><p>åœ¨æ­¤æœŸé—´æ”¶é›†è¯¥ trace çš„æ‰€æœ‰ spans</p></li><li><p><strong>è¶…è¿‡ç­‰å¾…æœŸåï¼ŒåŸºäºå·²æ”¶é›†çš„ spans åšå†³ç­–</strong></p></li></ul></li><li><p>é›†ä¸­å¼æ”¶é›†</p><ul><li><p>æ‰€æœ‰æœåŠ¡çš„ spans éƒ½å‘é€åˆ° Collector</p></li><li><p>Collector æœ‰æ›´å…¨é¢çš„è§†å›¾æ¥å…³è” spans</p></li></ul></li><li><p>ä¸“é—¨çš„èµ„æºåˆ†é…ï¼šCollector ä½œä¸ºç‹¬ç«‹ç»„ä»¶ï¼Œæœ‰ä¸“é—¨çš„èµ„æºå¤„ç†è¿™ç§å¤æ‚é€»è¾‘ï¼Œä¸ä¼šå½±å“åº”ç”¨æ€§èƒ½ã€‚</p></li></ol><h2 id="å¦‚ä½•åœ¨-OpenTelemetry-ç”Ÿæ€ä¸­å®ç°å°¾é‡‡æ ·ï¼Ÿ">å¦‚ä½•åœ¨ OpenTelemetry ç”Ÿæ€ä¸­å®ç°å°¾é‡‡æ ·ï¼Ÿ</h2><p>è™½ç„¶ SDK ä¸ç›´æ¥æ”¯æŒå°¾é‡‡æ ·ï¼Œä½† OpenTelemetry ç”Ÿæ€æä¾›äº†å…¶ä»–æ–¹å¼å®ç°ç±»ä¼¼åŠŸèƒ½ï¼š</p><h3 id="1-ä½¿ç”¨-OpenTelemetry-Collector">1. ä½¿ç”¨ OpenTelemetry Collector</h3><p>Collector æä¾›äº† Tail Sampling Processorï¼Œå¯ä»¥åœ¨æ•°æ®èšåˆå±‚å®ç°å°¾é‡‡æ ·ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">processors:</span></span><br><span class="line">  <span class="attr">tail_sampling:</span></span><br><span class="line">    <span class="attr">decision_wait:</span> <span class="string">10s</span></span><br><span class="line">    <span class="attr">num_traces:</span> <span class="number">100</span></span><br><span class="line">    <span class="attr">expected_new_traces_per_sec:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">policies:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">error-policy</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">status_code</span></span><br><span class="line">        <span class="attr">status_code:</span> <span class="string">ERROR</span></span><br></pre></td></tr></table></figure><h3 id="2-ç»“åˆå‰ç½®é‡‡æ ·å’Œé”™è¯¯æ•è·">2. ç»“åˆå‰ç½®é‡‡æ ·å’Œé”™è¯¯æ•è·</h3><p>å¯ä»¥å®ç°ä¸€ä¸ªæ™ºèƒ½çš„å‰ç½®é‡‡æ ·å™¨ï¼Œå¯¹ç‰¹å®šåœºæ™¯ï¼ˆå¦‚åŒ…å«é”™è¯¯å±æ€§ï¼‰å¼ºåˆ¶é‡‡æ ·ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> SmartSampler <span class="keyword">struct</span> &#123;</span><br><span class="line">    baseSamplingRate <span class="type">float64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartSampler)</span></span> ShouldSample(p trace.SamplingParameters) trace.SamplingResult &#123;</span><br><span class="line">    <span class="comment">// é”™è¯¯è¯·æ±‚å¿…é‡‡æ ·</span></span><br><span class="line">    <span class="keyword">for</span> _, attr := <span class="keyword">range</span> p.Attributes &#123;</span><br><span class="line">        <span class="keyword">if</span> attr.Key == <span class="string">&quot;error&quot;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> trace.SamplingResult&#123;Decision: trace.RecordAndSample&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…¶ä»–è¯·æ±‚ä½¿ç”¨åŸºç¡€é‡‡æ ·ç‡</span></span><br><span class="line">    <span class="keyword">if</span> <span class="type">float64</span>(p.TraceID[<span class="number">0</span>])/<span class="number">255.0</span> &lt; s.baseSamplingRate &#123;</span><br><span class="line">        <span class="keyword">return</span> trace.SamplingResult&#123;Decision: trace.RecordAndSample&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> trace.SamplingResult&#123;Decision: trace.Drop&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-ä½¿ç”¨ä¸“é—¨çš„åç«¯ç³»ç»Ÿ">3. ä½¿ç”¨ä¸“é—¨çš„åç«¯ç³»ç»Ÿ</h3><p>ä¸€äº›ä¸“é—¨çš„å¯è§‚æµ‹æ€§åç«¯ç³»ç»Ÿæä¾›äº†å°¾é‡‡æ ·åŠŸèƒ½ï¼š</p><ul><li><p>Jaeger çš„ Adaptive Sampling</p></li><li><p>SkyWalking çš„ Trace Sampling</p></li><li><p>Grafana Tempo çš„ Trace Sampling</p></li></ul><h2 id="ç»“è®º">ç»“è®º</h2><p>OpenTelemetry SDK é‡‡ç”¨å‰ç½®é‡‡æ ·è€Œéå°¾é‡‡æ ·ï¼Œæ˜¯åŸºäºåˆ†å¸ƒå¼ç³»ç»Ÿä¸€è‡´æ€§ã€æ€§èƒ½ä¼˜åŒ–å’Œæ¶æ„åˆ†å±‚ç­‰å¤šæ–¹é¢è€ƒè™‘çš„ç»“æœã€‚è™½ç„¶è¿™æ„å‘³ç€æ— æ³•åŸºäºå®Œæ•´é“¾è·¯ä¿¡æ¯åšé‡‡æ ·å†³ç­–ï¼Œä½† OpenTelemetry ç”Ÿæ€æä¾›äº†å¤šç§æ–¹å¼æ¥å¼¥è¡¥è¿™ä¸€é™åˆ¶ã€‚</p><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š</p><ol><li>åœ¨ SDK å±‚ä½¿ç”¨æ™ºèƒ½å‰ç½®é‡‡æ ·ç­–ç•¥ï¼Œç¡®ä¿å…³é”®é“¾è·¯è¢«é‡‡æ ·</li><li>åœ¨ Collector å±‚å®ç°å°¾é‡‡æ ·ï¼Œè¿›ä¸€æ­¥ç­›é€‰æœ‰ä»·å€¼çš„é“¾è·¯</li><li>ç»“åˆä½¿ç”¨å¤šç§é‡‡æ ·ç­–ç•¥ï¼Œå¹³è¡¡æ€§èƒ½å’Œå¯è§‚æµ‹æ€§</li></ol><p>é€šè¿‡è¿™ç§åˆ†å±‚è®¾è®¡ï¼ŒOpenTelemetry æ—¢ä¿è¯äº†é«˜æ•ˆçš„æ•°æ®æ”¶é›†ï¼Œåˆä¸ºé«˜çº§é‡‡æ ·ç­–ç•¥æä¾›äº†å¯èƒ½æ€§ï¼Œæ»¡è¶³äº†ä¸åŒåœºæ™¯çš„éœ€æ±‚ã€‚</p><div class="tag-plugin quot"><h2 class="content" id="å®æˆ˜æ¡ˆä¾‹" type="icon"><img class="icon prefix" src="https://bu.dusays.com/2022/10/24/63567d3e07da3.png" /><span class="text">å®æˆ˜æ¡ˆä¾‹</span><span class="empty"></span></h2></div><p>ç¬”è€…å®ç°ä¸€ä¸ª Go è¯­è¨€çš„å¼€æºé¡¹ç›® <code>goapm</code>ï¼Œå¯¹å¤šä¸ª Go è¯­è¨€ä¸­å¸¸ç”¨çš„ç»„ä»¶è¿›è¡Œäº† traceã€log å’Œ metrics çš„é›†æˆå°è£…ï¼Œç”¨äºå¿«é€Ÿåœ¨ Go è¯­è¨€é¡¹ç›®ä¸­å®ç°å¯è§‚æµ‹æ€§ï¼ŒåŒæ—¶è¿˜æä¾›äº† <code>goapm-example</code> å®æˆ˜æ¡ˆä¾‹ï¼Œå¯ä¾›å‚è€ƒã€‚</p><div class="tag-plugin link dis-select"><a class="link-card plain" title="" href="https://github.com/hedon954/goapm" target="_blank" rel="external nofollow noopener noreferrer" cardlink api="https://site-info-api-hedon.vercel.app/api/v1?url=https://github.com/hedon954/goapm" autofill="title,icon"><div class="left"><span class="title">https://github.com/hedon954/goapm</span><span class="cap link footnote">https://github.com/hedon954/goapm</span></div><div class="right"><div class="lazy img" data-bg="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/link/8f277b4ee0ecd.svg"></div></div></a></div><div class="tag-plugin link dis-select"><a class="link-card plain" title="" href="https://github.com/hedon954/goapm-example" target="_blank" rel="external nofollow noopener noreferrer" cardlink api="https://site-info-api-hedon.vercel.app/api/v1?url=https://github.com/hedon954/goapm-example" autofill="title,icon"><div class="left"><span class="title">https://github.com/hedon954/goapm-example</span><span class="cap link footnote">https://github.com/hedon954/goapm-example</span></div><div class="right"><div class="lazy img" data-bg="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/link/8f277b4ee0ecd.svg"></div></div></a></div>]]></content>
    
    
    <summary type="html">æœ¬æ–‡ä»‹ç»äº† OpenTelemetry çš„é‡‡æ ·æœºåˆ¶ï¼Œç‰¹åˆ«æ˜¯ä¸ºä»€ä¹ˆå®ƒåœ¨ SDK å±‚é¢ä¸æ”¯æŒå°¾é‡‡æ ·ã€‚</summary>
    
    
    
    <category term="æœåŠ¡ç›‘æ§" scheme="https://hedon.top/categories/%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7/"/>
    
    
    <category term="opentelemetry" scheme="https://hedon.top/tags/opentelemetry/"/>
    
    <category term="æœåŠ¡ç›‘æ§" scheme="https://hedon.top/tags/%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7/"/>
    
  </entry>
  
  <entry>
    <title>è¯»ä¹¦ç¬”è®°ä¸¨ã€Šæ‚Ÿé“é¢†åŸŸé©±åŠ¨è®¾è®¡ã€‹</title>
    <link href="https://hedon.top/2025/03/11/note-ddd-awareness/"/>
    <id>https://hedon.top/2025/03/11/note-ddd-awareness/</id>
    <published>2025-03-11T06:45:32.000Z</published>
    <updated>2025-06-05T00:39:43.936Z</updated>
    
    <content type="html"><![CDATA[<div class="tag-plugin quot"><h2 class="content" id="æ€ç»´è½¬å˜" type="icon"><img class="icon prefix" src="https://bu.dusays.com/2022/10/24/63567d3e07da3.png" /><span class="text">æ€ç»´è½¬å˜</span><span class="empty"></span></h2></div><p>é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDomain-Driven Designï¼Œä»¥ä¸‹ç®€ç§° DDDï¼‰çš„æ ¸å¿ƒä»·å€¼åœ¨äºå…¶å¯¹ã€Œä¸šåŠ¡é¢†åŸŸã€çš„æ·±åº¦èšç„¦ã€‚è¿™é‡Œçš„ã€Œé¢†åŸŸã€å¹¶éå•çº¯çš„æŠ€æœ¯èŒƒç•´ï¼Œè€Œæ˜¯æŒ‡ä»£è½¯ä»¶ç³»ç»Ÿæ‰€è¦æ˜ å°„çš„ç°å®ä¸šåŠ¡åœºæ™¯åŠå…¶æ ¸å¿ƒä»·å€¼ä¸»å¼ ã€‚DDD é€šè¿‡å»ºç«‹ä¸ä¸šåŠ¡é«˜åº¦å¥‘åˆçš„é¢†åŸŸæ¨¡å‹ï¼Œä½¿å¾—æŠ€æœ¯å®ç°ä¸ä¸šåŠ¡æœ¬è´¨å½¢æˆåŒé¢‘å…±æŒ¯ï¼Œä»è€Œæœ‰æ•ˆè§£å†³å¤æ‚ä¸šåŠ¡åœºæ™¯ä¸‹çš„è®¤çŸ¥é¸¿æ²Ÿé—®é¢˜ã€‚</p><p>åœ¨ VUCAï¼ˆVolatile æ˜“å˜æ€§ã€Uncertain ä¸ç¡®å®šæ€§ã€Complex å¤æ‚æ€§ã€Ambiguous æ¨¡ç³Šæ€§ï¼‰ç‰¹å¾æ„ˆå‘æ˜¾è‘—çš„ç°ä»£å•†ä¸šç¯å¢ƒä¸­ï¼Œä»»ä½•æ¶æ„è®¾è®¡éƒ½é¢ä¸´å›ºæœ‰å±€é™ã€‚è¿™ç§å±€é™æ€§æ—¢æºäºä¸šåŠ¡éœ€æ±‚æœ¬èº«çš„åŠ¨æ€æ¼”è¿›ï¼Œä¹Ÿå—åˆ¶äºäººç±»è®¤çŸ¥çš„æœ‰é™æ€§â€”â€”æ­£å¦‚ Eric Evans åœ¨å¼€å±±ä¹‹ä½œä¸­å¼ºè°ƒçš„â€œ<strong>æ¨¡å‹æ°¸è¿œæ˜¯å¯¹ç°å®çš„è¿‘ä¼¼æŠ½è±¡</strong>â€ã€‚ä½†æ­£æ˜¯è¿™ç§å±€é™æ€§ï¼Œå‡¸æ˜¾äº† DDD æ–¹æ³•è®ºçš„æˆ˜ç•¥æ„ä¹‰ï¼š</p><div class="tag-plugin colorful note" color="blue"><div class="body"><p>å®ƒé€šè¿‡&quot;æˆ˜ç•¥è®¾è®¡&quot;æ„å»ºä¸šåŠ¡å…¨æ™¯å›¾ï¼Œè¿ç”¨é™ç•Œä¸Šä¸‹æ–‡åˆ’å®šé¢†åŸŸè¾¹ç•Œï¼Œé€šè¿‡&quot;æˆ˜æœ¯è®¾è®¡&quot;è½åœ°èšåˆæ ¹ã€å®ä½“/å€¼å¯¹è±¡ç­‰æ¨¡å¼ï¼Œå½¢æˆåº”å¯¹å¤æ‚æ€§çš„ç»“æ„åŒ–è§£å†³æ–¹æ¡ˆã€‚</p></div></div><p>éœ€è¦ç‰¹åˆ«æŒ‡å‡ºçš„æ˜¯ï¼ŒDDD çš„å¤æ‚æ€§å¹¶éæ–¹æ³•è®ºæœ¬èº«çš„ç¼ºé™·ï¼Œè€Œæ˜¯å…¶åº”å¯¹ç°å®ä¸šåŠ¡å¤æ‚åº¦çš„å¿…è¦ä»£ä»·ã€‚è¿™ç§å¤æ‚æ€§ä½“ç°åœ¨ä¸‰ä¸ªç»´åº¦ï¼š</p><ol><li><strong>è®¤çŸ¥å¤æ‚æ€§</strong>ï¼šè¦æ±‚å¼€å‘å›¢é˜Ÿä¸é¢†åŸŸä¸“å®¶å…±å»º&quot;é€šç”¨è¯­è¨€&quot;ï¼Œå®ç°ä¸šåŠ¡æ¦‚å¿µä¸ä»£ç æ¨¡å‹çš„ç²¾å‡†æ˜ å°„ã€‚</li><li><strong>æ¶æ„å¤æ‚æ€§</strong>ï¼šé€šè¿‡åˆ†å±‚æ¶æ„å®ç°ä¸šåŠ¡é€»è¾‘ä¸æŠ€æœ¯å®ç°çš„è§£è€¦ï¼Œé‡‡ç”¨é˜²è…å±‚å¤„ç†ç³»ç»Ÿé›†æˆé—®é¢˜ã€‚</li><li><strong>æ¼”è¿›å¤æ‚æ€§</strong>ï¼šå€ŸåŠ©å­åŸŸåˆ’åˆ†å’Œä¸Šä¸‹æ–‡æ˜ å°„ï¼Œä¸ºæŒç»­æ¼”è¿›çš„ä¸šåŠ¡æä¾›å¯æ‰©å±•çš„æ¶æ„åŸºç¡€ã€‚</li></ol><p>å¯¹äºå®è·µè€…è€Œè¨€ï¼ŒDDD çš„ä»·å€¼ä¸åœ¨äºæä¾›å®Œç¾æ— ç¼ºçš„ç»ˆææ–¹æ¡ˆï¼Œè€Œæ˜¯ä¸º VUCA ç¯å¢ƒä¸‹çš„ç³»ç»Ÿå»ºè®¾æä¾›åŸºç¡€æ€§æŒ‡å¼•ã€‚å…¶æ ¸å¿ƒæ€æƒ³â€”â€”æ— è®ºæ˜¯é€šè¿‡é™ç•Œä¸Šä¸‹æ–‡å®ç°çš„é¢†åŸŸè‡ªæ²»ï¼Œè¿˜æ˜¯é€šè¿‡èšåˆæ ¹ç»´æŠ¤çš„ä¸šåŠ¡ä¸€è‡´æ€§â€”â€”éƒ½ä¸ºæ§åˆ¶è½¯ä»¶ç†µå¢æä¾›äº†å¯è½åœ°çš„æ¨¡å¼åº“ã€‚å³ä¾¿ä¸å®Œå…¨é‡‡ç”¨ DDD å®Œæ•´ä½“ç³»ï¼Œå…¶é¢†åŸŸå»ºæ¨¡æ€æƒ³ã€åˆ†å±‚æ¶æ„ç†å¿µç­‰æ ¸å¿ƒè¦ç´ ï¼Œä»èƒ½æ˜¾è‘—æå‡å¤æ‚ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§å’Œæ¼”è¿›èƒ½åŠ›ã€‚è¿™ç§å¼€æ”¾åŒ…å®¹çš„å“²å­¦ï¼Œæ°æ˜¯ DDD å†ç»äºŒåå¹´ä»ä¿æŒç”Ÿå‘½åŠ›çš„å…³é”®æ‰€åœ¨ã€‚</p><h3 id="è´«è¡€æ¨¡å‹-vs-å……è¡€æ¨¡å‹">è´«è¡€æ¨¡å‹ vs. å……è¡€æ¨¡å‹</h3><ul><li>è´«è¡€æ¨¡å‹ï¼šæŒ‡çš„æ˜¯åªæœ‰å±æ€§è€Œæ²¡æœ‰è¡Œä¸ºçš„æ¨¡å‹ã€‚</li><li>å……è¡€æ¨¡å‹ï¼šæŒ‡çš„æ˜¯æ—¢æœ‰å±æ€§åˆæœ‰è¡Œä¸ºçš„æ¨¡å‹ã€‚</li></ul><p>ç¬”è€…è¿‡å¾€çš„å®è·µä¸­ï¼ŒåŸºæœ¬ä¸Šéƒ½ä½¿ç”¨ç±»ä¼¼äº <code>controllerâ†’serviceâ†’repository[model]</code> çš„ä¸‰å±‚æ¶æ„ï¼š</p><ul><li><code>conrtoller</code> è´Ÿè´£æš´éœ²å¯¹å¤–æ¥å£ã€‚</li><li><code>service</code> è´Ÿè´£æ‰§è¡Œæ‰€æœ‰çš„ä¸šåŠ¡é€»è¾‘ã€‚</li><li><code>repository</code> å¤æ‚æ•°æ®çš„å­˜å‚¨å’Œç¼“å­˜ï¼ŒåŒ…å«æ•°æ®å¯¹è±¡ <code>model</code> çš„å®šä¹‰ã€‚</li></ul><p>åœ¨è¿™ä¸ªæ¨¡å¼ä¸‹ï¼ŒåŸºæœ¬ä¸Šæ‰€æœ‰çš„æ ¸å¿ƒé€»è¾‘éƒ½å……æ–¥åœ¨ <code>service</code> å±‚ä¸­ï¼Œæ‰€ä»¥ <code>service</code> å±‚ä¸€èˆ¬éƒ½ä¼šéå¸¸å¤§ï¼Œå®ƒè¦æ‰®æ¼”å¤šé¢æ‰‹ï¼Œå³è¦è´Ÿè´£è·Ÿå„ä¸ªæ¨¡å—åä½œï¼Œè¿˜è¦è´Ÿè´£å¤„ç†å…·ä½“çš„ä¸šåŠ¡è§„åˆ™ï¼Œæœ€ç»ˆå®Œæˆä¸€ä¸ªä¸šåŠ¡è¡Œä¸ºã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œ<code>model</code> å³ä¸ºè´«è¡€æ¨¡å‹ï¼Œå› ä¸ºé€»è¾‘éƒ½ç»™ <code>service</code> å¤„ç†äº†ï¼Œè¿™ç§æ¶æ„ä¹Ÿç§°ä¸º<strong>è´«è¡€ä¸‰å±‚æ¶æ„</strong>ã€‚</p><p>åœ¨ DDD çš„ç†å¿µä¸‹ï¼Œå¾ˆå¤šçš„æ ¸å¿ƒä¸šåŠ¡æ¦‚å¿µéƒ½ä¼šè¢«å»ºæ¨¡ä¸ºã€Œé¢†åŸŸå¯¹è±¡ã€ï¼Œè¿™äº›ã€Œé¢†åŸŸå¯¹è±¡ã€æœ¬èº«å°±æ˜¯ä¸€ç§ä¸šåŠ¡è§„åˆ™çš„ä½“ç°ï¼Œæ‰€ä»¥æŠŠä¸šåŠ¡çš„å¤„ç†é€»è¾‘ï¼Œéƒ½å½’å±åˆ°è¿™äº›ã€Œé¢†åŸŸå¯¹è±¡ã€çš„è¡Œä¸ºå½“ä¸­äº†ï¼Œå³æ‰€è°“çš„å……è¡€æ¨¡å‹ã€‚</p><p>åœ¨è¿™ä¸ªç†å¿µä¸‹ï¼Œä¸€ä¸ªä¼˜åŒ–åçš„<strong>å……è¡€å››å±‚æ¶æ„</strong>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250311152623058.png" alt="å……è¡€å››å±‚æ¶æ„"></p><p>è´«è¡€æ¨¡å‹æ¨èåœºæ™¯ï¼šä¸šåŠ¡ç®€å•ã€è¿­ä»£å¿«é€Ÿã€å›¢é˜ŸæŠ€æœ¯æ ˆåä¼ ç»Ÿï¼ˆå¦‚ Spring Boot+MyBatisï¼‰æ—¶ï¼Œé¿å…è¿‡åº¦è®¾è®¡ã€‚</p><p>å……è¡€æ¨¡å‹æ¨èåœºæ™¯ï¼šä¸šåŠ¡å¤æ‚ã€éœ€é•¿æœŸæ¼”è¿›ï¼ˆå¦‚æ ¸å¿ƒäº¤æ˜“ç³»ç»Ÿï¼‰ã€å›¢é˜Ÿå…·å¤‡ DDD ç»éªŒæ—¶ï¼Œé€šè¿‡å®ä½“ã€å€¼å¯¹è±¡ã€é¢†åŸŸæœåŠ¡ç­‰æˆ˜æœ¯è®¾è®¡ç†å¿µé™ä½ç³»ç»Ÿç†µå¢ã€‚</p><p>æ··åˆä½¿ç”¨çš„åœºæ™¯ï¼šéƒ¨åˆ†æ ¸å¿ƒé¢†åŸŸç”¨å……è¡€æ¨¡å‹ï¼ˆå¦‚è®¢å•ã€æ”¯ä»˜ï¼‰ï¼Œéæ ¸å¿ƒæ¨¡å—ç”¨è´«è¡€æ¨¡å‹ï¼ˆå¦‚æ—¥å¿—ã€é…ç½®ï¼‰ï¼Œå¹³è¡¡æ•ˆç‡ä¸è´¨é‡ã€‚</p><p>å®é™…ä¸Šï¼Œå……è¡€æ¨¡å‹å› å…¶çŠ¶æ€å®Œæ•´ï¼Œé€‚åˆè¿›è¡Œ<strong>çŠ¶æ€å˜æ›´ç±»</strong>çš„æ“ä½œï¼Œä»¥ç¡®ä¿ä¸šåŠ¡æ“ä½œç¬¦åˆé¢†åŸŸè§„åˆ™ï¼›è´«è¡€æ¨¡å‹ç”±äºå…¶è½»é‡çº§ï¼Œæ›´é€‚åˆä½œä¸ºä¸ä¼šæ¶‰åŠçŠ¶æ€å˜æ›´çš„æ“ä½œçš„æ•°æ®å®¹å™¨ã€‚è¿™å…¶å®å°±æ˜¯ CQRS çš„ç†å¿µã€‚</p><div class="tag-plugin quot"><h2 class="content" id="æ¦‚å¿µæ¸…å•" type="icon"><img class="icon prefix" src="https://bu.dusays.com/2022/10/24/63567d3e07da3.png" /><span class="text">æ¦‚å¿µæ¸…å•</span><span class="empty"></span></h2></div><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/ddd.jpg" alt=""></p><h3 id="æˆ˜æœ¯è®¾è®¡">æˆ˜æœ¯è®¾è®¡</h3><details class="tag-plugin colorful folding" ><summary><p>å®ä½“</p></summary><div class="body"><p><strong>å®šä¹‰</strong>ï¼šä¼šéšç€ä¸šåŠ¡å˜åŒ–å‘ç”Ÿå˜åŒ–çš„ä¸šåŠ¡æ¦‚å¿µå«ä½œå®ä½“å¯¹è±¡ã€‚</p><p><strong>å…³é”®ç‚¹</strong>ï¼šå®ä½“éœ€è¦å”¯ä¸€è¡¨ç¤º</p></div></details><details class="tag-plugin colorful folding" ><summary><p>å€¼å¯¹è±¡</p></summary><div class="body"><p><strong>å®šä¹‰</strong>ï¼šä¸€äº›å¯¹è±¡åœ¨è¡¨è¾¾ä¸šåŠ¡æ¦‚å¿µæ—¶æ˜¯å¿…é¡»çš„ï¼Œå¯ä¸šåŠ¡å¹¶ä¸å›´ç»•ç€å®ƒä»¬è¿›è¡Œï¼Œå®ƒä»¬ä»…æ˜¯å¯¹è¿™äº›é‡è¦ä¸šåŠ¡æ¦‚å¿µçš„æè¿°ï¼Œè¿™ä¸€ç±»å¯¹è±¡å«ä½œå€¼å¯¹è±¡ã€‚</p><p><strong>å…³é”®ç‚¹</strong>ï¼š</p><ol><li>å€¼å¯¹è±¡çš„æ„ä¹‰å–å†³äºå±æ€§ï¼Œåªè¦å¯¹è±¡çš„å±æ€§ä¸€æ¨¡ä¸€æ ·ï¼Œé‚£ä¹ˆå¯¹è±¡å°±æ˜¯ç›¸åŒçš„ã€‚</li><li>å°½é‡æŠŠå€¼å¯¹è±¡å®ç°ä¸ºä¸å¯å˜å¯¹è±¡ã€‚</li></ol></div></details><details class="tag-plugin colorful folding" ><summary><p>é¢†åŸŸæœåŠ¡</p></summary><div class="body"><p><strong>å®šä¹‰</strong>ï¼šé¢†åŸŸæœåŠ¡è‡ªèº«æ˜¯æ²¡æœ‰æ•°æ®çš„ï¼Œåªæ˜¯è¡¨è¾¾äº†æŸç§ä¸šåŠ¡è®¡ç®—é€»è¾‘ï¼Œæˆ–è€…ä¸šåŠ¡çš„æŸç§ç­–ç•¥ã€‚</p><p><strong>å…³é”®ç‚¹</strong>ï¼š</p><ol><li>é¢†åŸŸæœåŠ¡æ˜¯æ— çŠ¶æ€çš„ã€‚</li><li>åªæœ‰åœ¨ç¡®å®è¡¨è¾¾äº†ä¸€ä¸ªç›¸å¯¹ç‹¬ç«‹çš„ä¸šåŠ¡æ¦‚å¿µæˆ–è€…ä¸šåŠ¡ç­–ç•¥ï¼Œå¹¶ä¸”ä¸èƒ½ç®€å•åœ°æŠŠå®ƒå½’ç»“åˆ°æŸä¸ªæ—¢æœ‰çš„ä¸šåŠ¡å¯¹è±¡ä¸Šæ—¶ï¼Œæ‰æ˜¯ä¸€ä¸ªçœŸæ­£çš„é¢†åŸŸæœåŠ¡ã€‚</li></ol></div></details><details class="tag-plugin colorful folding" ><summary><p>é¢†åŸŸäº‹ä»¶</p></summary><div class="body"><p><strong>å®šä¹‰</strong>ï¼šé¢†åŸŸäº‹ä»¶ä»£è¡¨ä»ä¸šåŠ¡ä¸“å®¶è§†è§’çœ‹åˆ°çš„æŸç§é‡è¦çš„äº‹æƒ…å‘ç”Ÿäº†ã€‚</p><p><strong>å…³é”®ç‚¹</strong>ï¼š</p><ol><li>é¢†åŸŸäº‹ä»¶æ˜¯ä¸€ç§ç‰¹æ®Šçš„å€¼å¯¹è±¡ã€‚</li><li>åº”è¯¥æ ¹æ®é™ç•Œä¸Šä¸‹æ–‡ä¸­çš„é€šç”¨è¯­è¨€æ¥å‘½åäº‹ä»¶ï¼šAccountActivitedã€‚</li><li>åº”è¯¥å°†äº‹ä»¶å»ºæ¨¡æˆå€¼å¯¹è±¡æˆ–è´«è¡€å¯¹è±¡ã€‚</li></ol></div></details><details class="tag-plugin colorful folding" ><summary><p>èšåˆ</p></summary><div class="body"><p><strong>å®šä¹‰</strong>ï¼šèšåˆä»æœ¬è´¨ä¸Šè®²æ˜¯åœ¨åŸºç¡€çš„æ„é€ å—ä¸Šå¢åŠ äº†ä¸€å±‚è¾¹ç•Œï¼Œç”¨è¾¹ç•ŒæŠŠé‚£äº›ç´§å¯†ç›¸å…³çš„å¯¹è±¡æ”¾åˆ°äº†ä¸€èµ·ã€‚</p><p><strong>å…³é”®ç‚¹</strong>ï¼š</p><ol><li>ç´§å¯†ç›¸å…³çš„å¯¹è±¡å­˜åœ¨æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼›</li><li>ç¼ºä¹è¾¹ç•Œæ—¶ï¼Œç»´æŠ¤æ•°æ®ä¸€è‡´æ€§æ˜¯å›°éš¾çš„ï¼›</li><li>åˆ’åˆ†è¾¹ç•Œçš„å…³é”®åœ¨äºæ—¢ä¸è¦è®©æ•´ä¸ªç³»ç»Ÿæˆä¸ºä¸€ä¸ªæ•´ä½“ï¼Œåˆè®©æ¯ä¸ªå•ç‹¬åˆ’åˆ†å‡ºçš„èšåˆå…·æœ‰æ˜ç¡®çš„ä¸šåŠ¡æ„ä¹‰ï¼›</li><li>èšåˆéœ€è¦å…³æ³¨ä¸‰æ¡æ³•åˆ™ï¼š<ol><li>ç”Ÿå‘½å‘¨æœŸä¸€è‡´æ€§ï¼šå¦‚æœä¸€ä¸ªå¯¹è±¡åœ¨èšåˆæ ¹æ¶ˆå¤±ä¹‹åä»ç„¶æœ‰æ„ä¹‰ï¼Œé‚£ä¹ˆè¯´æ˜æ­¤æ—¶åœ¨ç³»ç»Ÿä¸­å¿…ç„¶å­˜åœ¨èƒ½å¤Ÿè®¿é—®è¯¥å¯¹è±¡çš„æ–¹æ³•ã€‚è¿™å’Œèšåˆçš„å®šä¹‰çŸ›ç›¾ï¼Œæ‰€ä»¥èšåˆå†…çš„å…¶ä»–å…ƒç´ å¿…ç„¶åœ¨èšåˆæ ¹æ¶ˆå¤±åå¤±æ•ˆã€‚</li><li>é—®é¢˜åŸŸä¸€è‡´æ€§ï¼šä¸å±äºåŒä¸€ä¸ªé—®é¢˜åŸŸçš„å¯¹è±¡ï¼Œä¸åº”è¯¥å‡ºç°åœ¨åŒä¸€ä¸ªèšåˆä¸­ã€‚</li><li>å°½é‡å°çš„èšåˆï¼šèšåˆçš„æœ¬è´¨ä½œç”¨æ˜¯æå‡å¯¹è±¡ç³»ç»Ÿçš„ç²’åº¦ï¼Œç¡®ä¿ä¸€è‡´æ€§ã€é™ä½å¤æ‚åº¦ã€‚ä¸è¿‡ï¼Œç²’åº¦ç»ä¸æ˜¯è¶Šå¤§è¶Šå¥½ã€‚å¦‚æœèšåˆçš„ç²’åº¦å¤ªå¤§ï¼Œé‚£å†…éƒ¨çš„é€»è¾‘å¤æ‚åº¦ä¹Ÿä¼šå¤§å¤§å¢åŠ è¿˜ä¼šå½±å“åˆ°å¤ç”¨åº¦ã€‚å› æ­¤ï¼Œè¦èƒ½å¤Ÿæ¯”è¾ƒå®¹æ˜“åœ°æ–­å¼€èšåˆã€‚</li></ol></li></ol></div></details><details class="tag-plugin colorful folding" ><summary><p>èµ„æºåº“</p></summary><div class="body"><p><strong>å®šä¹‰</strong>ï¼šå¯¹äºæŸ¥è¯¢ã€åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤æ•°æ®çš„æ“ä½œï¼Œé¢†åŸŸæ¨¡å‹ä½¿ç”¨â€œèµ„æºåº“(Repository)â€è¿™ä¸ªæ¦‚å¿µæ¥æ‰¿è½½å®ƒä»¬ã€‚</p><p><strong>å…³é”®ç‚¹</strong>ï¼šä¸€ä¸ªèšåˆå¯¹åº”ä¸€ä¸ªèµ„æºåº“ï¼Œåº”ä»¥èšåˆæ ¹å‘½åèµ„æºåº“ï¼Œé™¤äº†èšåˆæ ¹ä¹‹å¤–çš„å…¶ä»–å¯¹è±¡ï¼Œéƒ½ä¸åº”è¯¥æä¾›èµ„æºåº“å¯¹è±¡ã€‚</p></div></details><details class="tag-plugin colorful folding" ><summary><p>å·¥å‚</p></summary><div class="body"><p><strong>å®šä¹‰</strong>ï¼šå·¥å‚ç”¨äºæ„å»ºèšåˆã€‚</p><p><strong>å…³é”®ç‚¹</strong>ï¼šä¸€ä¸ªèšåˆå¾€å¾€åŒ…å«å¤šä¸ªå¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡çš„æ•°æ®ä¹‹é—´åˆå¯èƒ½å­˜åœ¨è”ç³»ï¼Œå¦‚æœå…è®¸åˆ†åˆ«åˆ›å»ºè¿™äº›å¯¹è±¡ï¼Œå°±ä¼šè®©èšåˆæ˜¯ä¸šåŠ¡å®Œæ•´æ€§çš„å•å…ƒè¿™ä¸ªå®šä¹‰é¢ä¸´å¤±è´¥ã€‚</p></div></details><h3 id="æˆ˜ç•¥è®¾è®¡">æˆ˜ç•¥è®¾è®¡</h3><details class="tag-plugin colorful folding" ><summary><p>ç»Ÿä¸€è¯­è¨€</p></summary><div class="body"><p><strong>å®šä¹‰</strong>ï¼šä¸ä¸šåŠ¡ä¸“å®¶åä½œå®šä¹‰å…¨å›¢é˜Ÿé€šç”¨çš„æœ¯è¯­è¡¨ï¼Œæ¶ˆé™¤æ²Ÿé€šæ­§ä¹‰ã€‚</p><p><strong>å…³é”®ç‚¹</strong>ï¼š</p><ol><li>åŒä¸€ä¸ªæ¦‚å¿µåœ¨ä¸åŒçš„ä¸Šä¸‹æ–‡ä¸­å¯èƒ½å­˜åœ¨ä¸åŒçš„å«ä¹‰ï¼›</li><li>åŒä¸€ä¸ªæ¦‚å¿µåœ¨åŒä¸€ä¸Šä¸‹æ–‡ä¸­çš„ä¸åŒç¯èŠ‚ï¼Œä¹Ÿå¯èƒ½å­˜åœ¨ä¸åŒçš„å«ä¹‰ï¼Œéœ€è¦éå¸¸æ˜ç¡®æ¸…æ™°çš„ç•Œå®šï¼Œé™ä½æ²Ÿé€šæˆæœ¬ã€‚</li></ol></div></details><details class="tag-plugin colorful folding" ><summary><p>å­åŸŸ</p></summary><div class="body"><p><strong>å®šä¹‰</strong>ï¼šå­åŸŸæ˜¯å¯¹ä¸šåŠ¡é¢†åŸŸçš„é€»è¾‘åˆ’åˆ†ï¼Œç”¨äºåˆ†è§£å¤æ‚é—®é¢˜ã€‚é€šå¸¸åˆ†ä¸º<strong>æ ¸å¿ƒå­åŸŸ</strong>ï¼ˆä¸šåŠ¡æ ¸å¿ƒç«äº‰åŠ›ï¼‰ã€<strong>æ”¯æ’‘å­åŸŸ</strong>ï¼ˆè¾…åŠ©æ ¸å¿ƒä¸šåŠ¡ï¼‰å’Œ<strong>é€šç”¨å­åŸŸ</strong>ï¼ˆå¯å¤ç”¨çš„æ ‡å‡†åŒ–èƒ½åŠ›ï¼‰ã€‚</p><p><strong>å…³é”®ç‚¹</strong>ï¼šå› ä¸šåŠ¡ç›®æ ‡ã€å›¢é˜Ÿå®šä½å’Œç»„ç»‡å‘å±•é˜¶æ®µç­‰æ–¹é¢çš„ä¸åŒï¼Œè¿™ä¸‰ä¸ªå­åŸŸçš„åˆ’åˆ†å¹¶éä¸€æˆä¸å˜ï¼Œè€Œæ˜¯ä¼šäº’ç›¸è½¬æ¢ã€‚</p></div></details><details class="tag-plugin colorful folding" ><summary><p>é™ç•Œä¸Šä¸‹æ–‡</p></summary><div class="body"><p><strong>å®šä¹‰</strong>ï¼šé™ç•Œä¸Šä¸‹æ–‡æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªè‡ªæ²»çš„å°ä¸–ç•Œï¼Œå®ƒæœ‰å®Œå¤‡çš„èŒè´£ï¼Œè¿˜æœ‰æ¸…æ™°çš„è¾¹ç•Œã€‚</p><p><strong>å…³é”®ç‚¹</strong>ï¼š</p><ol><li>ä¸€ä¸ªå­åŸŸçš„ä¸€åˆ‡èµ„äº§ï¼ŒåŒ…æ‹¬é¢†åŸŸæ¨¡å‹ã€æ•°æ®åº“ã€åŒ…ã€å¯æ‰§è¡Œç¨‹åºã€æ¥å£å£°æ˜ç­‰ï¼Œéƒ½åº”è¯¥å°è£…åœ¨é™ç•Œä¸Šä¸‹æ–‡ä¸­ï¼Œé¿å…è·¨è¶Šè¾¹ç•Œã€‚</li><li>å¦‚ä½•å¹³è¡¡è¾¹ç•Œçš„ä»·å€¼å’Œä¸åˆ©å½±å“ï¼Œæ˜¯åˆ’åˆ†è¾¹ç•Œæ—¶è¦åšçš„ä¸€ç§é‡è¦å–èˆã€‚<strong>ä¸€ä¸ªè¾ƒä¸ºç¨³å¦¥çš„ç­–ç•¥æ˜¯è€ƒè™‘è®¤çŸ¥çš„æ¸è¿›ç‰¹å¾ï¼Œä¸è¦è¿‡æ—©éš”ç¦»ã€‚åœ¨å·²ç»ç¡®å®šçš„è¾¹ç•Œä¸Šè¿›è¡Œåˆ’åˆ†ï¼Œå»¶ç¼“åˆ’åˆ†é‚£äº›å°šå…·æ¨¡ç³Šæ€§çš„è¾¹ç•Œï¼Œåœ¨è¿™äº›è¾¹ç•Œé€æ¸å˜å¾—æ¸…æ™°æ—¶å†åˆ†ç¦»å®ƒä»¬ã€‚</strong></li></ol></div></details><details class="tag-plugin colorful folding" ><summary><p>ä¸Šä¸‹æ–‡æ˜ å°„</p></summary><div class="body"><p><strong>å®šä¹‰</strong>ï¼šé™ç•Œä¸Šä¸‹æ–‡çº¦å®šäº†åŸºäºé¢†åŸŸæ¨¡å‹çš„æ¶æ„å±‚æ¬¡çš„è®¾è®¡åˆ†è§£ï¼Œè€Œåˆ†è§£å¿…ç„¶æ„å‘³ç€é›†æˆå’Œåä½œã€‚ä¸Šä¸‹æ–‡æ˜ å°„å°±æ˜¯å¯¹é™ç•Œä¸Šä¸‹æ–‡ä¹‹é—´çš„åä½œå…³ç³»çš„æ¨¡å¼æ€»ç»“ã€‚</p><p><strong>å…³é”®ç‚¹</strong>ï¼š</p><ol><li>åœ¨è¾¹ç•Œä¸Šå®Œæˆæ¦‚å¿µæ˜ å°„æ˜¯ä¸€ç§åŸºæœ¬æ¨¡å¼ã€‚é€šè¿‡åœ¨åº”ç”¨å±‚ç»„è£…æˆ–è€…ä½¿ç”¨é€‚é…å™¨å®Œæˆæ¦‚å¿µæ˜ å°„ï¼Œå¯ä»¥ä¿æŒé¢†åŸŸæ¦‚å¿µçš„æ¸…æ™°ï¼Œé¿å…é¢†åŸŸæ¨¡å‹é­åˆ°ä¸å¿…è¦çš„æ±¡æŸ“ã€‚</li><li>é˜²è…å±‚æ¨¡å¼ã€æ ‡å‡†å¼€æ”¾æœåŠ¡æ¨¡å¼ã€å®¢æˆ·-ä¾›åº”å•†æ¨¡å¼ã€è¿½éšè€…æ¨¡å¼ã€‚</li></ol></div></details><h3 id="ä¸²è®²">ä¸²è®²</h3><p>åœ¨åº”å¯¹å¤æ‚ä¸šåŠ¡ç³»ç»Ÿæ—¶ï¼ŒDDD é€šè¿‡<strong>åˆ†æ²»ç­–ç•¥</strong>å°†ä¸šåŠ¡é¢†åŸŸæ‹†åˆ†ä¸ºå¤šä¸ª<strong>å­åŸŸ</strong>ï¼ˆå¦‚ç”µå•†ç³»ç»Ÿçš„è®¢å•ã€æ”¯ä»˜å­åŸŸï¼‰ï¼Œæ¯ä¸ªå­åŸŸå¯¹åº”ä¸€ä¸ª<strong>é™ç•Œä¸Šä¸‹æ–‡</strong>â€”â€”è¿™æ˜¯æŠ€æœ¯ä¸ä¸šåŠ¡å¯¹é½çš„å…³é”®è¾¹ç•Œï¼Œæ—¢æ‰¿è½½é¢†åŸŸæ¨¡å‹çš„å®ç°ï¼Œä¹Ÿé€šè¿‡<strong>ä¸Šä¸‹æ–‡æ˜ å°„</strong>ï¼ˆå¦‚é˜²è…å±‚ã€å…±äº«å†…æ ¸ç­‰æ¨¡å¼ï¼‰å®ç°è·¨å­åŸŸåä½œï¼Œé¿å…æ¨¡å‹æ±¡æŸ“ã€‚</p><p>é™ç•Œä¸Šä¸‹æ–‡å†…çš„<strong>é¢†åŸŸå¯¹è±¡</strong>æ˜¯ä¸šåŠ¡é€»è¾‘çš„è½½ä½“ï¼šå…·å¤‡å”¯ä¸€æ ‡è¯†å’Œç”Ÿå‘½å‘¨æœŸçš„<strong>å®ä½“</strong>ï¼ˆå¦‚è®¢å•å®ä½“é€šè¿‡ ID è·Ÿè¸ªçŠ¶æ€å˜åŒ–ï¼‰ã€æè¿°ç‰¹å¾ä¸”ä¸å¯å˜çš„<strong>å€¼å¯¹è±¡</strong>ï¼ˆå¦‚åœ°å€ç”±çœå¸‚æ„æˆï¼Œä¿®æ”¹éœ€æ•´ä½“æ›¿æ¢ï¼‰ï¼Œä»¥åŠé€šè¿‡<strong>èšåˆæ ¹</strong>ç»Ÿä¸€æ“ä½œä¿è¯ä¸€è‡´æ€§çš„<strong>èšåˆ</strong>ï¼ˆå¦‚è®¢å•èšåˆæ ¹ç®¡ç†è®¢å•é¡¹å’Œé…é€ä¿¡æ¯ï¼‰ã€‚å½“ä¸šåŠ¡é€»è¾‘è·¨è¶Šå¤šä¸ªèšåˆæ—¶ï¼Œç”±æ— çŠ¶æ€çš„<strong>é¢†åŸŸæœåŠ¡</strong>åè°ƒï¼ˆå¦‚æ”¯ä»˜è®¡ç®—éœ€æ•´åˆè®¢å•ã€è´¦æˆ·èšåˆï¼‰ã€‚</p><p>å¯¹è±¡çš„åˆ›å»ºä¸æŒä¹…åŒ–åˆ†åˆ«ç”±<strong>å·¥å‚</strong>ï¼ˆå°è£…å¤æ‚åˆå§‹åŒ–é€»è¾‘ï¼‰å’Œ<strong>èµ„æºåº“</strong>ï¼ˆéš”ç¦»å­˜å‚¨ç»†èŠ‚ï¼‰è´Ÿè´£ï¼Œè€Œ<strong>é¢†åŸŸäº‹ä»¶</strong>ï¼ˆå¦‚è®¢å•æ”¯ä»˜æˆåŠŸäº‹ä»¶ï¼‰åˆ™é©±åŠ¨è·¨ä¸Šä¸‹æ–‡çš„å¼‚æ­¥åä½œã€‚</p><div class="tag-plugin quot"><h2 class="content" id="æˆ˜æœ¯è®¾è®¡" type="icon"><img class="icon prefix" src="https://bu.dusays.com/2022/10/24/63567d3e07da3.png" /><span class="text">æˆ˜æœ¯è®¾è®¡</span><span class="empty"></span></h2></div><h3 id="factory">factory</h3><ul><li>factory ç”¨äºæ„å»ºå¤æ‚çš„é¢†åŸŸå¯¹è±¡ã€‚</li></ul><h3 id="repository">repository</h3><ul><li>åªæœ‰èšåˆæ ¹æœ‰ repositoryã€‚</li><li>repository å°±åªæä¾› <code>load</code> å’Œ <code>save</code> åŠŸèƒ½ï¼Œä¸”è¦ä¿è¯äº‹åŠ¡ä¸€è‡´æ€§ã€‚</li><li>å°½å¯èƒ½æä¾›è¡Œçº§çš„ repositoryï¼Œè€Œä¸æ˜¯è¡¨çº§çš„ repositoryï¼Œå¯¹äºè¡¨çº§çš„ repositoryï¼Œå¯ä»¥æŠ½æˆä¸€ä¸ªé¢†åŸŸæœåŠ¡ã€‚</li></ul><h3 id="è®¾è®¡æ¨¡å¼">è®¾è®¡æ¨¡å¼</h3><h4 id="è´£ä»»é“¾æ¨¡å¼">è´£ä»»é“¾æ¨¡å¼</h4><blockquote><p>å°†è¯·æ±‚çš„å‘é€è€…å’Œæ¥å—è€…è§£è€¦ï¼Œä½¿å¤šä¸ªå¯¹è±¡éƒ½æœ‰æœºä¼šå¤„ç†è¯·æ±‚ã€‚</p></blockquote><ul><li>è´£ä»»é“¾æ¨¡å¼çš„ä½¿ç”¨è¦ç‚¹åœ¨äºè¦å°†ç»´æŠ¤è´£ä»»é“¾çš„ä»£ç å’Œä¸šåŠ¡ä»£ç åˆ†å¼€ã€‚</li><li>åœ¨ DDD ä¸­ä½¿ç”¨è´£ä»»é“¾æ¨¡å¼æ—¶ï¼Œåº”åˆ›å»ºä¸€ä¸ªé¢†åŸŸæœåŠ¡ï¼Œåœ¨é¢†åŸŸæœåŠ¡ä¸­å®Œæˆè´£ä»»é“¾çš„åˆ›å»ºå’Œæ‰§è¡Œã€‚</li><li>å°½é‡ä¸è¦åœ¨è´£ä»»é“¾çš„å¤„ç†å™¨ä¸­é€šè¿‡ <code>set</code> ä¿®æ”¹é¢†åŸŸå¯¹è±¡ï¼ˆèšåˆæ ¹ï¼‰çš„çŠ¶æ€ï¼Œè´£ä»»é“¾åº”ä»…ç”¨äºæŸäº›å€¼çš„è®¡ç®—ï¼Œæœ€ç»ˆå°†è®¡ç®—ç»“æœäº¤ç»™èšåˆæ ¹å®Œæˆä¸šåŠ¡æ“ä½œã€‚</li></ul><p>ç¬”è€…å®ç°äº†ä¸€ä¸ªå¿«é€Ÿæ„å»ºè´£ä»»é“¾çš„å·¥å…·ï¼š</p><div class="tag-plugin link dis-select"><a class="link-card plain" title="" href="https://github.com/hedon954/devkit-go/blob/main/designmode/responsibility/builder.go" target="_blank" rel="external nofollow noopener noreferrer" cardlink api="https://site-info-api-hedon.vercel.app/api/v1?url=https://github.com/hedon954/devkit-go/blob/main/designmode/responsibility/builder.go" autofill="title,icon"><div class="left"><span class="title">https://github.com/hedon954/devkit-go/blob/main/designmode/responsibility/builder.go</span><span class="cap link footnote">https://github.com/hedon954/devkit-go/blob/main/designmode/responsibility/builder.go</span></div><div class="right"><div class="lazy img" data-bg="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/link/8f277b4ee0ecd.svg"></div></div></a></div><h4 id="ç­–ç•¥æ¨¡å¼">ç­–ç•¥æ¨¡å¼</h4><blockquote><p>å…è®¸åœ¨è¿è¡Œæ—¶æ ¹æ®éœ€è¦é€‰æ‹©ä¸åŒçš„å®ç°ã€‚</p></blockquote><ul><li>åœ¨ DDD ä¸­ä½¿ç”¨ç­–ç•¥æ¨¡å¼æ—¶ï¼Œé€šå¸¸å…ˆå®šä¹‰ä¸€ä¸ªé¢†åŸŸæœåŠ¡æ¥å£ï¼Œå†åœ¨å…¶å®ç°ç±»ä¸­å®Œæˆç­–ç•¥çš„åŠ è½½ã€é€‰æ‹©å’Œæ‰§è¡Œã€‚</li><li>æ³¨æ„å±è”½ç­–ç•¥æ¨¡å¼çš„å®ç°ç»†èŠ‚ï¼Œé¿å…ä¸Šå±‚å…³æ³¨é¢†åŸŸæœåŠ¡å†…çš„è®¾è®¡æ¨¡å¼ç»†èŠ‚ã€‚</li></ul><h4 id="æ¡¥æ¥æ¨¡å¼">æ¡¥æ¥æ¨¡å¼</h4><blockquote><p>æ—¨åœ¨é€šè¿‡è§£è€¦æŠ½è±¡å’Œå®ç°ï¼Œä½¿ä¸¤è€…èƒ½å¤Ÿç‹¬ç«‹æ‰©å±•å’Œå˜åŒ–ã€‚</p></blockquote><ul><li><strong>å¤šç»´è§£è€¦æœºåˆ¶</strong>ï¼šæ¡¥æ¥æ¨¡å¼é€šè¿‡ç»„åˆ/èšåˆå…³ç³»æ›¿ä»£ç»§æ‰¿å…³ç³»ï¼Œå°†åŸæœ¬ç´§å¯†è€¦åˆçš„æŠ½è±¡å±‚ï¼ˆåŠŸèƒ½å®šä¹‰ï¼‰ä¸å®ç°å±‚ï¼ˆå…·ä½“æ“ä½œï¼‰åˆ†ç¦»ä¾‹å¦‚é¥æ§å™¨ï¼ˆæŠ½è±¡ï¼‰ä¸ç”µè§†ï¼ˆå®ç°ï¼‰çš„åä½œï¼Œé¥æ§å™¨é€šè¿‡æ¥å£æ§åˆ¶ç”µè§†ï¼Œæ— éœ€å…³æ³¨å…·ä½“å“ç‰Œã€‚</li><li><strong>æ­£äº¤æ‰©å±•èƒ½åŠ›</strong>ï¼šæ”¯æŒä¸¤ä¸ªç‹¬ç«‹å˜åŒ–ç»´åº¦ï¼ˆå¦‚æ¶ˆæ¯ç±»å‹ä¸é€šçŸ¥æ¸ é“ã€å›¾å½¢ä¸æ¸²æŸ“æ–¹å¼ï¼‰ï¼Œé¿å…ç±»æ•°é‡å‘ˆæŒ‡æ•°çº§å¢é•¿ï¼ˆMÃ—N ç»„åˆé—®é¢˜ï¼‰ã€‚ç”µå•†ç‰©æµç³»ç»Ÿä¸­ï¼Œæ–°å¢å¾®ä¿¡é€šçŸ¥æ¸ é“æ—¶ï¼Œæ— éœ€ä¿®æ”¹æ‰€æœ‰æ¶ˆæ¯ç±»å³å¯å®ç°æ‰©å±•ã€‚</li></ul><h4 id="è§„çº¦æ¨¡å¼">è§„çº¦æ¨¡å¼</h4><blockquote><p>è§„çº¦æ¨¡å¼æ˜¯ä¸€ç§ç”¨äºå®šä¹‰ä¸šåŠ¡é¢†åŸŸä¸­è§„åˆ™å’Œçº¦æŸçš„æ¨¡å¼ï¼Œé€šå¸¸ç”±è§„çº¦æ¥å£ï¼ˆSpecificationï¼‰å’ŒéªŒè¯å™¨ï¼ˆValidatorï¼‰ä¸¤ä¸ªéƒ¨åˆ†ç»„æˆã€‚</p></blockquote><ul><li>åœ¨ DDD ä¸­ï¼Œè§„çº¦æ¨¡å¼å¹¶ä¸æ˜¯åœ¨èšåˆæ ¹è¿›è¡Œä¸šåŠ¡æ“ä½œä¹‹å‰åšå‰ç½®æ ¡éªŒï¼Œè€Œæ˜¯åœ¨èšåˆæ ¹å®Œæˆä¸šåŠ¡æ“ä½œä¹‹ååšåç½®æ ¡éªŒï¼Œç¡®ä¿ Repository ä¿å­˜çš„èšåˆæ ¹ç¬¦åˆä¸šåŠ¡è§„åˆ™ã€‚</li></ul><h4 id="é€‚é…å™¨æ¨¡å¼">é€‚é…å™¨æ¨¡å¼</h4><blockquote><p>å°†<strong>è¢«é€‚é…è€…ï¼ˆAdapteeï¼‰çš„æ¥å£</strong>è½¬æ¢ä¸º<strong>ç›®æ ‡æ¥å£ï¼ˆTargetï¼‰</strong>ï¼Œä½¿åŸæœ¬å› æ¥å£ä¸å…¼å®¹è€Œæ— æ³•ååŒå·¥ä½œçš„ç±»èƒ½å¤ŸååŒã€‚</p></blockquote><ul><li>åœ¨ DDD ä¸­ï¼Œå¯ä»¥ä½¿ç”¨é€‚é…å™¨æ¨¡å¼æ¥å®ç°é˜²è…å±‚ï¼Œä»¥å°†å¤–éƒ¨ä¸Šä¸‹æ–‡æ¥å£ï¼ˆå¦‚å¼€æ”¾ä¸»æœºæœåŠ¡ï¼‰è¿”å›çš„æ¨¡å‹è½¬æ¢ä¸ºæœ¬åœ°ä¸Šä¸‹æ–‡å®šä¹‰çš„é¢†åŸŸæ¨¡å‹ï¼Œå¹¶å°†æœ¬åœ°ä¸Šä¸‹æ–‡çš„æ“ä½œè½¬æ¢ä¸ºå¯¹å¤–éƒ¨ä¸Šä¸‹æ–‡çš„æ“ä½œã€‚å¯ä»¥æœ‰æ•ˆéš”ç¦»å¤–éƒ¨ä¸Šä¸‹æ–‡çš„é¢†åŸŸæ¨¡å‹ï¼Œé¿å…äº’ç›¸æ±¡æŸ“ã€‚</li></ul><h3 id="é¢†åŸŸäº‹ä»¶">é¢†åŸŸäº‹ä»¶</h3><h4 id="å¹‚ç­‰æ€§">å¹‚ç­‰æ€§</h4><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image.png" alt=""></p><h4 id="é¢†åŸŸäº‹ä»¶çš„å®šä¹‰">é¢†åŸŸäº‹ä»¶çš„å®šä¹‰</h4><blockquote><p>é¢†åŸŸäº‹ä»¶æ˜¯é¢†åŸŸæ¨¡å‹çš„ç»„æˆéƒ¨åˆ†ï¼Œå®ƒé€šå¸¸ç”±èšåˆæ ¹äº§ç”Ÿï¼Œå¹¶è¢«å…¶ä»–èšåˆæˆ–è€…é™ç•Œä¸Šä¸‹æ–‡è®¢é˜…å’Œå¤„ç†ï¼Œè§¦å‘ç›¸åº”çš„ä¸šåŠ¡é€»è¾‘ã€‚</p></blockquote><p>æ³¨æ„ç‚¹ï¼š</p><ul><li>åº”è¯¥æ ¹æ®é™ç•Œä¸Šä¸‹æ–‡ä¸­çš„é€šç”¨è¯­è¨€æ¥å‘½åäº‹ä»¶ï¼šAccountActivitedã€‚</li><li>åº”è¯¥å°†äº‹ä»¶å»ºæ¨¡æˆå€¼å¯¹è±¡æˆ–è´«è¡€å¯¹è±¡ã€‚</li></ul><p>åº”ç”¨ï¼š</p><ol><li>è§£è€¦é¢†åŸŸå¯¹è±¡ä¹‹é—´çš„å…³ç³»ï¼›</li><li>è§¦å‘å…¶ä»–é¢†åŸŸå¯¹è±¡çš„è¡Œä¸ºï¼›</li><li>è®°å½•é¢†åŸŸå†…å·²å‘ç”Ÿçš„çŠ¶æ€å˜åŒ–ï¼›</li><li>å®ç°è·¨èšåˆçš„æœ€ç»ˆä¸€è‡´æ€§ï¼›</li><li>è¿›è¡Œé™ç•Œä¸Šä¸‹æ–‡é›†æˆã€‚</li></ol><p>æ¶ˆæ¯ä½“ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;event_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;entity_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;event_time&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;extra_data&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#125;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="é¢†åŸŸäº‹ä»¶çš„ç”Ÿæˆ">é¢†åŸŸäº‹ä»¶çš„ç”Ÿæˆ</h4><ol><li>åº”ç”¨å±‚åˆ›å»ºé¢†åŸŸäº‹ä»¶ã€‚</li><li>èšåˆæ ¹åˆ›å»ºé¢†åŸŸäº‹ä»¶ã€‚</li></ol><p>è¦é¿å…åœ¨èšåˆæ ¹å†…éƒ¨è°ƒç”¨åŸºç¡€å®æ–½å‘å¸ƒé¢†åŸŸäº‹ä»¶ï¼Œè€Œæ˜¯ç”Ÿæˆåè¿”å›ç»™åº”ç”¨å±‚ï¼Œç”±åº”ç”¨å±‚å»å‘å¸ƒã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Entity <span class="keyword">struct</span> &#123;</span><br><span class="line">  Events []Event</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(e *Entity)</span></span>ResgisterEvent(event Event) &#123;</span><br><span class="line">  e.Events = <span class="built_in">append</span>(e.Events. event)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(e *Entity)</span></span> GetEvents() []Event &#123;</span><br><span class="line">  res := e.Events()</span><br><span class="line">  e.Events = []Event&#123;&#125;</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="é¢†åŸŸäº‹ä»¶çš„å‘å¸ƒ">é¢†åŸŸäº‹ä»¶çš„å‘å¸ƒ</h4><ol><li>ç›´æ¥å‘å¸ƒå¹¶è½®è¯¢è¡¥å¿ï¼šä¸ºäº‹ä»¶å­˜å‚¨ä¸€ä¸ªå‘å¸ƒçŠ¶æ€æ ‡è¯†ï¼Œç”¨äºè®°å½•æ˜¯å¦è¡¥å‘æˆåŠŸã€‚å¹¶æä¾›å®šæ—¶ä»»åŠ¡æ£€ç´¢è¶…æ—¶æœªå‘å¸ƒæˆåŠŸçš„äº‹ä»¶è¿›è¡Œé‡æ–°å‘å¸ƒã€‚</li><li>é‡‡ç”¨äº‹åŠ¡æ—¥å¿—æ‹–å°¾ï¼šå¼•å…¥å˜æ›´æ•°æ®æ•è·ç»„ä»¶ï¼ˆChange Data Captureï¼Œç®€ç§° CDCï¼‰ï¼Œæ•è·æ•°æ®çš„å˜æ›´æ—¥å¿—ï¼Œè§£æåè·å¾—é¢†åŸŸäº‹ä»¶å¹¶å‘å¸ƒã€‚</li></ol><h4 id="é¢†åŸŸäº‹ä»¶çš„è®¢é˜…">é¢†åŸŸäº‹ä»¶çš„è®¢é˜…</h4><p>å°†é¢†åŸŸäº‹ä»¶è®¢é˜…è€…æ”¾ç½®åœ¨ç”¨æˆ·æ¥å£å±‚ <code>user-interface-subscriber</code>ï¼Œæ”¶åˆ°äº‹ä»¶åè°ƒç”¨åº”ç”¨æœåŠ¡æ‰§è¡Œä¸šåŠ¡é€»è¾‘ã€‚</p><h3 id="äº‹ä»¶æº¯æº">äº‹ä»¶æº¯æº</h3><p>äº‹ä»¶æº¯æºï¼ˆEvent Sourcingï¼‰æ˜¯ä¸€ç§å°†æ‰€æœ‰çš„é¢†åŸŸäº‹ä»¶ï¼ˆDomain Eventï¼‰å­˜å‚¨åˆ°äº‹ä»¶å­˜å‚¨ï¼ˆEvent Storeï¼‰ä¸­ï¼Œå¹¶é€šè¿‡é‡æ”¾å†å²äº‹ä»¶æ¥è¿˜åŸé¢†åŸŸå¯¹è±¡çŠ¶æ€çš„æ¨¡å¼ã€‚</p><p>æ ¸å¿ƒæ€æƒ³æ˜¯å°†ç³»ç»Ÿä¸­æ‰€æœ‰çš„çŠ¶æ€å˜æ›´éƒ½è§†ä¸ºäº‹ä»¶ï¼Œå°†è¿™äº›äº‹ä»¶ä»¥äº‹ä»¶é¡ºåºè®°å½•ä¸‹æ¥ï¼Œå¹¶å­˜å‚¨åˆ°äº‹ä»¶å­˜å‚¨ä¸­ã€‚è¿™æ ·ï¼Œå¯ä»¥é€šè¿‡é‡æ”¾è¿™äº›äº‹ä»¶ï¼Œæ¥è¿˜åŸä»»æ„æ—¶åˆ»çš„ç³»ç»ŸçŠ¶æ€ã€‚</p><p>ä¸‰ç§æ–¹æ¡ˆï¼š</p><ol><li>é€šè¿‡å›æ”¾æ‰€æœ‰çš„å†å²äº‹ä»¶é‡å»ºèšåˆæ ¹ã€‚</li><li>é€šè¿‡å¿«ç…§æé«˜é‡å»ºèšåˆæ ¹çš„æ•ˆç‡ã€‚</li><li><strong>é€šè¿‡æ‹‰é“¾è¡¨ç”Ÿæˆæ‰€æœ‰äº‹ä»¶å¯¹åº”çš„å¿«ç…§ã€‚</strong></li></ol><div class="tag-plugin colorful note" color="green"><div class="body"><p>æ‹‰é“¾è¡¨æ˜¯ä¸€ç§ç”¨äºå¤„ç†ç¼“æ…¢å˜åŒ–ç»´åº¦é—®é¢˜çš„æ•°æ®ç»“æ„ï¼Œå®ƒå¯ä»¥æœ‰æ•ˆåœ°å¤„ç†ç»´åº¦æ•°æ®çš„å†å²å˜åŒ–ã€‚åœ¨æ‹‰é“¾è¡¨ä¸­ï¼Œæ¯ä¸ªè®°å½•éƒ½æœ‰ä¸€ä¸ªå¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´ï¼Œç”¨äºæè¿°è¯¥è®°å½•çš„å­˜æ´»æ—¶é—´ï¼Œå³è¯¥è®°å½•çš„æœ‰æ•ˆæœŸã€‚</p></div></div><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250312183214921.png" alt="æ‹‰é“¾æ³•ç¤ºæ„å›¾"></p><h3 id="CQRS">CQRS</h3><p>CQRS å°†ç³»ç»Ÿçš„æ“ä½œåˆ†ä¸ºä¸¤ç±»ï¼š</p><ul><li><strong>å‘½ä»¤ï¼ˆCommandï¼‰</strong>ï¼šè´Ÿè´£æ•°æ®çš„å†™æ“ä½œï¼ˆå¢ã€åˆ ã€æ”¹ï¼‰ï¼Œä¸è¿”å›æ•°æ®ã€‚</li><li><strong>æŸ¥è¯¢ï¼ˆQueryï¼‰</strong>ï¼šè´Ÿè´£æ•°æ®çš„è¯»æ“ä½œï¼Œä»…è¿”å›ç»“æœä¸”ä¸ä¿®æ”¹æ•°æ®ã€‚</li></ul><p>ä¸¤è€…çš„æ•°æ®æ¨¡å‹å¯ç‹¬ç«‹è®¾è®¡ï¼Œç”šè‡³ä½¿ç”¨ä¸åŒçš„æ•°æ®åº“æˆ–å­˜å‚¨æŠ€æœ¯ã€‚</p><details class="tag-plugin colorful folding" color="blue"><summary><p>é€‚ç”¨åœºæ™¯</p></summary><div class="body"><p><strong>åº”å¯¹é«˜å¹¶å‘è¯»å†™åœºæ™¯</strong></p><ul><li><p>æ¡ˆä¾‹ 1ï¼šB ç«™ç‚¹èµç³»ç»Ÿ</p><p>åœ¨æ—¥å‡æ´»è·ƒç”¨æˆ·è¿‘äº¿çš„ B ç«™ï¼Œç‚¹èµåŠŸèƒ½é€šè¿‡ CQRS åˆ†ç¦»è¯»å†™æ“ä½œã€‚å†™å…¥ç«¯é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¦‚ Kafkaï¼‰å¼‚æ­¥å¤„ç†è¯·æ±‚ï¼Œé¿å…æ•°æ®åº“é”ç«äº‰ï¼›æŸ¥è¯¢ç«¯é€šè¿‡ç¼“å­˜ä¼˜åŒ–è¯»å–æ€§èƒ½ï¼Œæ˜¾è‘—æå‡ç³»ç»Ÿååé‡å’Œç¨³å®šæ€§ã€‚</p></li><li><p>æ¡ˆä¾‹ 2ï¼šå®æ—¶ç­”é¢˜ PK æ¸¸æˆ</p><p>é«˜å¹¶å‘çš„ç­”é¢˜å¾—åˆ†è®¡ç®—åœºæ™¯ä¸­ï¼ŒCQRS ç»“åˆäº‹ä»¶æº¯æºï¼ˆEvent Sourcingï¼‰è®°å½•æ¯ä¸ªæ“ä½œäº‹ä»¶ï¼Œç¡®ä¿è¯»å†™æ¨¡å‹çš„æœ€ç»ˆä¸€è‡´æ€§ï¼ŒåŒæ—¶æ”¯æŒå¤æ‚æˆ˜å†µæ•°æ®çš„å®æ—¶å±•ç¤ºã€‚</p></li></ul><p><strong>è§£å†³å¤æ‚æŸ¥è¯¢éœ€æ±‚</strong></p><ul><li><p>æ¡ˆä¾‹ 3ï¼šç”µå•†è®¢å•æŸ¥è¯¢</p><p>éšç€è®¢å•æŸ¥è¯¢éœ€æ±‚å¤šæ ·åŒ–ï¼ˆå¦‚æŒ‰æ—¶é—´ç­›é€‰ã€è·¨å®ä½“èšåˆæ•°æ®ï¼‰ï¼ŒCQRS é€šè¿‡ç‹¬ç«‹è¯»æ¨¡å‹ç®€åŒ–æŸ¥è¯¢é€»è¾‘ï¼Œé¿å…é¢†åŸŸæ¨¡å‹è¢«å¤æ‚æŸ¥è¯¢é€»è¾‘æ±¡æŸ“ã€‚</p></li><li><p>æ¡ˆä¾‹ 4ï¼šå¾®æœåŠ¡æ•°æ®èšåˆ</p><p>åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒCQRS å…è®¸é€šè¿‡äº‹ä»¶åŒæ­¥è·¨æœåŠ¡æ•°æ®åˆ°ä¸“ç”¨è¯»åº“ï¼Œé¿å…è·¨æœåŠ¡è”è¡¨æŸ¥è¯¢çš„æ€§èƒ½ç“¶é¢ˆï¼ˆå¦‚è¡Œç¨‹ç®¡ç†æœåŠ¡ä¸ç”¨æˆ·ä¿¡æ¯æœåŠ¡çš„èšåˆæŸ¥è¯¢ï¼‰ã€‚</p></li></ul><p><strong>æå‡æ•°æ®æ¨¡å‹çµæ´»æ€§</strong></p><ul><li><p>æ¡ˆä¾‹ 5ï¼šæ–‡æœ¬å¢é‡æ›´æ–°</p><p>é’ˆå¯¹å¤§å‹æ–‡æœ¬ç¼–è¾‘åœºæ™¯ï¼ŒCQRS æ‹†åˆ†è¯»å†™æ¨¡å‹ï¼Œå¢é‡ä¿å­˜ä¿®æ”¹è®°å½•å¹¶é€šè¿‡äº‹ä»¶åˆå¹¶ï¼Œå‡å°‘ç½‘ç»œä¼ è¾“æ•°æ®é‡ï¼ŒåŒæ—¶æ”¯æŒä»»æ„ç‰ˆæœ¬çš„å†å²æ•°æ®æ¢å¤ã€‚</p></li></ul></div></details><details class="tag-plugin colorful folding" color="orange"><summary><p>ä¸é€‚ç”¨åœºæ™¯</p></summary><div class="body"><ul><li>ç®€å• CRUD ç³»ç»Ÿï¼ˆå¦‚å°å‹ç®¡ç†åå°ï¼‰</li><li>å¼ºä¸€è‡´æ€§è¦æ±‚çš„é‡‘èäº¤æ˜“åœºæ™¯ï¼ˆå¦‚å®æ—¶æ‰£æ¬¾ï¼‰</li><li>å›¢é˜Ÿç¼ºä¹äº‹ä»¶é©±åŠ¨æ¶æ„ç»éªŒæ—¶</li></ul></div></details><h3 id="ä¸€è‡´æ€§">ä¸€è‡´æ€§</h3><h4 id="èšåˆå†…äº‹åŠ¡å®ç°">èšåˆå†…äº‹åŠ¡å®ç°</h4><ul><li>èšåˆå†…äº‹åŠ¡æ§åˆ¶ä¸è¦æ”¾åœ¨åº”ç”¨å±‚ï¼Œä¼šä½¿åº”ç”¨å±‚æ‰¿æ‹…è¿‡å¤šçš„è´£ä»»ã€‚åº”ç”¨å±‚åº”ä¸“æ³¨äºåè°ƒé¢†åŸŸå¯¹è±¡å’ŒåŸºç¡€è®¾æ–½ä»¥å®Œæˆä¸šåŠ¡æ“ä½œï¼Œä¸åº”è¿‡å¤šæ¶‰åŠæ•°æ®è®¿é—®å’Œäº‹åŠ¡æ§åˆ¶çš„ç»†èŠ‚ã€‚</li><li>èšåˆå†…äº‹åŠ¡æ§åˆ¶å¯ä»¥äº¤ç»™ <code>Repository</code> æ¥å®ç°ï¼Œé‡‡ç”¨ä¹è§‚é”è§£å†³å¹¶å‘é—®é¢˜ï¼Œå¯ä»¥åŸºäºç‰ˆæœ¬å·å’Œæ—¶é—´æˆ³ï¼Œä¸€èˆ¬é‡è¯• 1-3 æ¬¡å³å¯ã€‚</li></ul><h4 id="èšåˆé—´äº‹åŠ¡å®ç°">èšåˆé—´äº‹åŠ¡å®ç°</h4><ul><li><p>èšåˆé—´æ§åˆ¶å¯ä»¥å•ç‹¬å»ºç«‹ä¸€ä¸ªé¢†åŸŸæœåŠ¡ Domain Service æ¥å®Œæˆã€‚</p></li><li><p>å¯¹äºå®æ—¶æ€§è¦æ±‚ä¸é«˜ï¼Œä»…éœ€æœ€ç»ˆä¸€è‡´æ€§ï¼Œå¯ä»¥ä½¿ç”¨<strong>æœ¬åœ°æ¶ˆæ¯è¡¨</strong>æˆ–è€…<strong>æœ€å¤§åŠªåŠ›é€šçŸ¥</strong>çš„æ–¹æ¡ˆã€‚</p></li><li><p>å¯¹äºå®æ—¶æ€§ä¸€è‡´æ€§è¦æ±‚æ¯”è¾ƒé«˜ï¼Œå¯ä»¥é‡‡ç”¨ <strong>TCCï¼ˆTry-Confirm-Cancelï¼‰</strong> äº‹åŠ¡æ–¹æ¡ˆã€‚</p></li><li><p>å¯¹äºé•¿äº‹åŠ¡åœºæ™¯ï¼Œæˆ–è€…æ¶‰åŠå¤–éƒ¨ç³»ç»Ÿã€é—ç•™ç³»ç»Ÿï¼Œå¯ä»¥è€ƒè™‘ <strong>Saga</strong> äº‹åŠ¡æ–¹æ¡ˆã€‚</p><blockquote><p>Saga å°†äº‹åŠ¡åˆ†ä¸ºå¤šä¸ªäº‹åŠ¡ï¼Œè¿™äº›åˆ†æ”¯äº‹åŠ¡æŒ‰ç…§ä¸€å®šçš„é¡ºåºæ‰§è¡Œã€‚å½“æŸä¸ªåˆ†æ”¯äº‹åŠ¡æ‰§è¡ŒæˆåŠŸåï¼Œä¼šé€šè¿‡æ¶ˆæ¯é€šçŸ¥ä¸‹ä¸€ä¸ªåˆ†æ”¯æ‰§è¡Œï¼›å½“æŸä¸ªåˆ†æ”¯äº‹åŠ¡æ‰§è¡Œå¤±è´¥æ—¶ï¼Œä¼šæŒ‰ç…§æ­£å¸¸äº‹åŠ¡æ‰§è¡Œé¡ºåºçš„ç›¸åæ–¹å‘è¿›è¡Œä¸€ç³»åˆ—çš„è¡¥å¿æ“ä½œï¼Œä»¥ç¡®ä¿å…¨å±€äº‹åŠ¡çš„ä¸€è‡´æ€§ã€‚</p></blockquote></li></ul><div class="tag-plugin quot"><h2 class="content" id="æˆ˜ç•¥è®¾è®¡" type="icon"><img class="icon prefix" src="https://bu.dusays.com/2022/10/24/63567d3e07da3.png" /><span class="text">æˆ˜ç•¥è®¾è®¡</span><span class="empty"></span></h2></div><h3 id="äº‹ä»¶é£æš´">äº‹ä»¶é£æš´</h3><h4 id="æ ¸å¿ƒæ¦‚å¿µä¸å…ƒç´ ">æ ¸å¿ƒæ¦‚å¿µä¸å…ƒç´ </h4><table><thead><tr><th>å…ƒç´ åç§°</th><th>é¢œè‰²æ ‡è¯†</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><font color="#FFA500"><strong>é¢†åŸŸäº‹ä»¶ï¼ˆDomain Eventï¼‰</strong></font></td><td>æ©™è‰²</td><td>è¡¨ç¤ºå·²å‘ç”Ÿçš„ä¸šåŠ¡äº‹å®ï¼Œä»¥â€œåŠ¨è¯è¿‡å»å¼â€å‘½åï¼ˆå¦‚â€œè®¢å•å·²æäº¤â€ï¼‰ï¼Œæ˜¯äº‹ä»¶é£æš´çš„æ ¸å¿ƒèµ·ç‚¹ã€‚</td></tr><tr><td><font color="#00008B"><strong>å‘½ä»¤ï¼ˆCommandï¼‰</strong></font></td><td>æ·±è“è‰²</td><td>è§¦å‘é¢†åŸŸäº‹ä»¶çš„æ“ä½œæˆ–æ„å›¾ï¼ˆå¦‚â€œæäº¤è®¢å•â€ï¼‰ï¼Œé€šå¸¸ç”±ç”¨æˆ·æˆ–ç³»ç»Ÿè§¦å‘ã€‚</td></tr><tr><td><font color="#FFFF00"><strong>å‚ä¸è€…ï¼ˆActorï¼‰</strong></font></td><td>é»„è‰²</td><td>æ‰§è¡Œå‘½ä»¤çš„è§’è‰²ï¼ŒåŒ…æ‹¬ç”¨æˆ·ã€éƒ¨é—¨æˆ–å¤–éƒ¨ç³»ç»Ÿï¼ˆå¦‚â€œå®¢æˆ·â€è§¦å‘æ”¯ä»˜å‘½ä»¤ï¼‰ã€‚</td></tr><tr><td><font color="#FFC0CB"><strong>å¤–éƒ¨ç³»ç»Ÿï¼ˆExternal Systemï¼‰</strong></font></td><td>ç²‰è‰²</td><td>ä¸å½“å‰ç³»ç»Ÿäº¤äº’çš„ç¬¬ä¸‰æ–¹æœåŠ¡ï¼ˆå¦‚æ”¯ä»˜ç½‘å…³å›è°ƒç”Ÿæˆäº‹ä»¶ï¼‰ã€‚</td></tr><tr><td><font color="#800080"><strong>ç­–ç•¥ï¼ˆPolicyï¼‰</strong></font></td><td>ç´«è‰²</td><td>ä¸šåŠ¡è§„åˆ™æˆ–çº¦æŸæ¡ä»¶ï¼ˆå¦‚â€œåº“å­˜ä¸è¶³æ—¶å–æ¶ˆè®¢å•â€ï¼‰ï¼Œå†³å®šäº‹ä»¶è§¦å‘çš„é€»è¾‘ã€‚</td></tr><tr><td><font color="#008000"><strong>è¯»æ¨¡å‹ï¼ˆRead Modelï¼‰</strong></font></td><td>ç»¿è‰²</td><td>ä¸ºæŸ¥è¯¢ä¼˜åŒ–çš„æ•°æ®è§†å›¾ï¼ˆå¦‚â€œç”¨æˆ·è®¢å•åˆ—è¡¨â€ï¼‰ï¼Œæ”¯æŒå†³ç­–å±•ç¤ºã€‚</td></tr><tr><td><font color="#FFD700"><strong>èšåˆï¼ˆAggregateï¼‰</strong></font></td><td>å¤§é»„è‰²</td><td>ä¸šåŠ¡å¯¹è±¡é›†åˆï¼ˆå¦‚â€œè®¢å•èšåˆâ€åŒ…å«è®¢å•é¡¹å’ŒçŠ¶æ€ï¼‰ï¼Œç»´æŠ¤ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ã€‚</td></tr><tr><td><font color="#FF0000"><strong>é—®é¢˜ï¼ˆQuestionï¼‰</strong></font></td><td>çº¢è‰²</td><td>æœªè¾¾æˆå…±è¯†çš„äº‰è®®ç‚¹ï¼ˆå¦‚äº‹ä»¶å®šä¹‰åˆ†æ­§ï¼‰ï¼Œéœ€åç»­ä¸“é¡¹è®¨è®ºã€‚</td></tr></tbody></table><h4 id="å®æ–½æµç¨‹ä¸æ­¥éª¤">å®æ–½æµç¨‹ä¸æ­¥éª¤</h4><ol><li><p><strong>å‡†å¤‡å·¥ä½œ</strong></p><ul><li><strong>å‚ä¸äººå‘˜</strong>ï¼šä¸šåŠ¡ä¸“å®¶ã€å¼€å‘ã€äº§å“ã€æµ‹è¯•ç­‰è·¨èŒèƒ½è§’è‰²ï¼Œéœ€é¢†åŸŸä¸“å®¶ä¸»å¯¼ã€‚</li><li><strong>ç‰©æ–™</strong>ï¼šå¤šè‰²ä¾¿ç­¾ã€ç™½æ¿ã€é©¬å…‹ç¬”ï¼Œçº¿ä¸Šå·¥å…·è¾…åŠ©è¿œç¨‹åä½œã€‚</li></ul></li><li><p><strong>è¯†åˆ«é¢†åŸŸäº‹ä»¶</strong><br>å›¢é˜Ÿé€šè¿‡å¤´è„‘é£æš´ç½—åˆ—æ‰€æœ‰å¯èƒ½äº‹ä»¶ï¼ˆå¦‚ç”µå•†åœºæ™¯çš„â€œè®¢å•å·²åˆ›å»ºâ€â€œåº“å­˜å·²æ‰£å‡â€ï¼‰ï¼ŒæŒ‰æ—¶é—´è½´æ’åˆ—ï¼Œäº‰è®®äº‹ä»¶ç”¨çº¢è‰²ä¾¿ç­¾æ ‡è®°å¹¶æš‚å­˜ã€‚</p></li><li><p><strong>è¡¥å……å‘½ä»¤ä¸è§’è‰²</strong><br>ä¸ºæ¯ä¸ªäº‹ä»¶å…³è”è§¦å‘å‘½ä»¤åŠæ‰§è¡Œè€…ï¼ˆå¦‚â€œå®¢æˆ·â€æ‰§è¡Œâ€œæ”¯ä»˜è®¢å•â€å‘½ä»¤ç”Ÿæˆâ€œæ”¯ä»˜å®Œæˆâ€äº‹ä»¶ï¼‰ï¼ŒåŒºåˆ†å†…éƒ¨æ“ä½œä¸å¤–éƒ¨ç³»ç»Ÿè°ƒç”¨ã€‚</p></li><li><p><strong>å®šä¹‰ç­–ç•¥ä¸è¯»æ¨¡å‹</strong><br>æ·»åŠ ä¸šåŠ¡è§„åˆ™ï¼ˆå¦‚â€œè®¢å•é‡‘é¢ â‰¥1000 å…ƒéœ€å®¡æ ¸â€ï¼‰å’Œæ•°æ®å±•ç¤ºéœ€æ±‚ï¼ˆå¦‚â€œå®æ—¶åº“å­˜çœ‹æ¿â€ï¼‰ã€‚</p></li><li><p><strong>æ„å»ºèšåˆä¸åˆ’åˆ†å­åŸŸ</strong><br>å°†ç›¸å…³äº‹ä»¶ã€å‘½ä»¤å½’ç±»ä¸ºèšåˆï¼ˆå¦‚â€œæ”¯ä»˜èšåˆâ€ï¼‰ï¼Œåˆ’åˆ†é™ç•Œä¸Šä¸‹æ–‡ï¼ˆå¦‚â€œè®¢å•æœåŠ¡â€â€œåº“å­˜æœåŠ¡â€ï¼‰ï¼Œæ˜ç¡®å¾®æœåŠ¡è¾¹ç•Œã€‚</p></li></ol><h4 id="æ³¨æ„äº‹é¡¹">æ³¨æ„äº‹é¡¹</h4><ol><li><p><strong>äº‹ä»¶ç²’åº¦çš„æŠŠæ§</strong>ï¼šé¿å…è¿‡åº¦ç»†åŒ–ï¼ˆå¦‚â€œç”¨æˆ·å·²ççœ¼&quot;ï¼‰æˆ–è¿‡äºå®½æ³›ï¼ˆå¦‚â€œè®¢å•å·²ä¿®æ”¹â€ï¼‰ï¼Œéœ€èšç„¦ä¸šåŠ¡å…³é”®èŠ‚ç‚¹ã€‚</p></li><li><p><strong>äº‰è®®å¤„ç†ä¸è¿­ä»£</strong>ï¼šå¯¹æœªè¾¾æˆå…±è¯†çš„äº‹ä»¶æ ‡è®°ä¸ºâ€œé—®é¢˜â€ï¼ˆçº¢è‰²ä¾¿ç­¾ï¼‰ï¼Œåç»­ä¸“é¢˜è®¨è®ºï¼›å®šæœŸå›é¡¾æ¨¡å‹ï¼Œä¿®æ­£é”™è¯¯æˆ–è¡¥å……é—æ¼ã€‚</p></li><li><p><strong>æŠ€æœ¯å®ç°è¡”æ¥</strong> ï¼šäº‹ä»¶é£æš´çš„è¾“å‡ºéœ€è½¬åŒ–ä¸ºä»£ç æ¨¡å‹ï¼Œä¾‹å¦‚é€šè¿‡äº‹ä»¶æº¯æºï¼ˆEvent Sourcingï¼‰æŒä¹…åŒ–äº‹ä»¶æµï¼Œæˆ–ç»“åˆ CQRS åˆ†ç¦»è¯»å†™é€»è¾‘ã€‚</p></li></ol><h3 id="C4-æ¶æ„æ¨¡å‹">C4 æ¶æ„æ¨¡å‹</h3><div class="tag-plugin link dis-select"><a class="link-card rich" title="" href="https://c4model.com/" target="_blank" rel="external nofollow noopener noreferrer" cardlink api="https://site-info-api-hedon.vercel.app/api/v1?url=https://c4model.com/" autofill="title,icon,desc"><div class="top"><div class="lazy img" data-bg="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/link/8f277b4ee0ecd.svg"></div><span class="cap link footnote">https://c4model.com/</span></div><div class="bottom"><span class="title">https://c4model.com/</span><span class="cap desc footnote"></span></div></a></div><table><thead><tr><th><strong>å±‚çº§</strong></th><th><strong>æ ¸å¿ƒç›®æ ‡</strong></th><th><strong>å—ä¼—</strong></th><th><strong>å…³é”®å…ƒç´ </strong></th></tr></thead><tbody><tr><td><strong>Contextï¼ˆä¸Šä¸‹æ–‡ï¼‰</strong></td><td>æè¿°ç³»ç»Ÿä¸å¤–éƒ¨å®ä½“ï¼ˆç”¨æˆ·ã€ç¬¬ä¸‰æ–¹ç³»ç»Ÿï¼‰çš„äº¤äº’å…³ç³»</td><td>éæŠ€æœ¯äººå‘˜ï¼ˆå¦‚ä¸šåŠ¡æ–¹ã€å®¢æˆ·ï¼‰</td><td>ç³»ç»Ÿè¾¹ç•Œã€ç”¨æˆ·è§’è‰²ã€å¤–éƒ¨ä¾èµ–ï¼ˆå¦‚æ”¯ä»˜ç½‘å…³ï¼‰</td></tr><tr><td><strong>Containerï¼ˆå®¹å™¨ï¼‰</strong></td><td>å±•ç¤ºç³»ç»Ÿå†…éƒ¨çš„é«˜é˜¶æŠ€æœ¯ç»„ä»¶ï¼ˆè¿›ç¨‹çº§å•å…ƒï¼‰</td><td>æŠ€æœ¯ç®¡ç†è€…ã€æ¶æ„å¸ˆ</td><td>Web åº”ç”¨ã€æ•°æ®åº“ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰ç‹¬ç«‹è¿›ç¨‹å•å…ƒï¼Œå…³æ³¨æŠ€æœ¯é€‰å‹ä¸é€šä¿¡åè®®ï¼ˆå¦‚ REST APIã€gRPCï¼‰</td></tr><tr><td><strong>Componentï¼ˆç»„ä»¶ï¼‰</strong></td><td>ç»†åŒ–å®¹å™¨å†…éƒ¨çš„ä¸šåŠ¡æ¨¡å—ä¸äº¤äº’é€»è¾‘</td><td>å¼€å‘å›¢é˜Ÿ</td><td>æœåŠ¡ã€æ¨¡å—ã€æ¥å£ï¼ˆå¦‚è®¢å•æœåŠ¡ã€åº“å­˜æœåŠ¡ï¼‰ï¼Œå¼ºè°ƒèŒè´£åˆ’åˆ†ä¸ä¾èµ–å…³ç³»</td></tr><tr><td><strong>Codeï¼ˆä»£ç ï¼‰</strong></td><td>å±•ç¤ºç»„ä»¶å®ç°çš„ä»£ç ç»“æ„</td><td>å¼€å‘è€…</td><td>ç±»ã€æ–¹æ³•ã€æ•°æ®åº“è¡¨ï¼ˆå¦‚ UML ç±»å›¾ã€ER å›¾ï¼‰ï¼Œé€šå¸¸ç”± IDE å·¥å…·è‡ªåŠ¨ç”Ÿæˆ</td></tr></tbody></table><p>é™¤äº†å››å±‚æ ¸å¿ƒè§†å›¾ï¼ŒC4 æ¨¡å‹è¿˜æä¾›ï¼š</p><ul><li><strong>éƒ¨ç½²å›¾</strong>ï¼šå±•ç¤ºå®¹å™¨åœ¨ç‰©ç†ç¯å¢ƒä¸­çš„åˆ†å¸ƒï¼ˆå¦‚ Kubernetes é›†ç¾¤éƒ¨ç½²ï¼‰ã€‚</li><li><strong>åŠ¨æ€å›¾</strong>ï¼šæè¿°ä¸šåŠ¡æµç¨‹ï¼ˆå¦‚ç”¨æˆ·ä¸‹å•åˆ°æ”¯ä»˜å®Œæˆçš„æ—¶åºäº¤äº’ï¼‰ã€‚</li><li><strong>ç³»ç»Ÿæ™¯è§‚å›¾</strong>ï¼šå¤šç³»ç»ŸååŒçš„å…¨å±€è§†å›¾ï¼ˆå¦‚ä¼ä¸šçº§ä¸­å°æ¶æ„ï¼‰ã€‚</li></ul><div class="tag-plugin tabs" align="center"id="tab_2"><div class="nav-tabs"><div class="tab active"><a href="#tab_2-1">Context</a></div><div class="tab"><a href="#tab_2-2">Container</a></div><div class="tab"><a href="#tab_2-3">Component</a></div><div class="tab"><a href="#tab_2-4">Code</a></div></div><div class="tab-content"><div class="tab-pane active" id="tab_2-1"><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/SystemContext-20250312173256060.png" alt=""></p></div><div class="tab-pane" id="tab_2-2"><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/Containers-20250312173305921.png" alt=""></p></div><div class="tab-pane" id="tab_2-3"><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/Components-20250312173320890.png" alt=""></p></div><div class="tab-pane" id="tab_2-4"><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/MainframeBankingSystemFacade-20250312173313572.png" alt=""></p></div></div></div><div class="tag-plugin quot"><h2 class="content" id="å®è·µæ¡ˆä¾‹" type="icon"><img class="icon prefix" src="https://bu.dusays.com/2022/10/24/63567d3e07da3.png" /><span class="text">å®è·µæ¡ˆä¾‹</span><span class="empty"></span></h2></div><p>å‚è€ƒä½œè€…çš„ <a href="https://github.com/feiniaojin/ddd-archetype">ddd-archetype</a> ï¼Œç¬”è€…å®ç°äº†ä¸€ä¸ª Go ç‰ˆæœ¬çš„ <code>ddd-archetype-go</code>ï¼š</p><div class="tag-plugin link dis-select"><a class="link-card plain" title="" href="https://github.com/hedon-go-road/ddd-archetype-go" target="_blank" rel="external nofollow noopener noreferrer" cardlink api="https://site-info-api-hedon.vercel.app/api/v1?url=https://github.com/hedon-go-road/ddd-archetype-go" autofill="title,icon"><div class="left"><span class="title">https://github.com/hedon-go-road/ddd-archetype-go</span><span class="cap link footnote">https://github.com/hedon-go-road/ddd-archetype-go</span></div><div class="right"><div class="lazy img" data-bg="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/link/8f277b4ee0ecd.svg"></div></div></a></div><p>æ•´ä½“æ¶æ„å¦‚ä¸‹ï¼š</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/ddd-ruoyi.drawio.png" alt=""></p>]]></content>
    
    
    <summary type="html">é˜…è¯»ã€Šæ‚Ÿé“é¢†åŸŸé©±åŠ¨è®¾è®¡ã€‹åçš„ä¸€äº›ç¬”è®°å’Œæ€è€ƒã€‚</summary>
    
    
    
    <category term="è¯»ä¹¦ç¬”è®°" scheme="https://hedon.top/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="è¯»ä¹¦ç¬”è®°" scheme="https://hedon.top/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
    <category term="ddd" scheme="https://hedon.top/tags/ddd/"/>
    
  </entry>
  
  <entry>
    <title>Go 1.24 æ–°ç‰¹æ€§è§£è¯»ï¼šä½¿ç”¨ testing/synctest ä¼˜é›…åœ°æµ‹è¯•å¹¶å‘ä»£ç </title>
    <link href="https://hedon.top/2025/03/06/go-lib-synctest/"/>
    <id>https://hedon.top/2025/03/06/go-lib-synctest/</id>
    <published>2025-03-06T07:00:18.000Z</published>
    <updated>2025-06-05T00:38:50.822Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ Go è¯­è¨€å¼€å‘ä¸­ï¼Œå¹¶å‘ç¼–ç¨‹ä¸€ç›´æ˜¯å…¶æœ€å¼•äººæ³¨ç›®çš„ç‰¹æ€§ä¹‹ä¸€ã€‚ç„¶è€Œï¼Œå¦‚ä½•æœ‰æ•ˆåœ°æµ‹è¯•å¹¶å‘ä»£ç å´å¸¸å¸¸è®©å¼€å‘è€…æ„Ÿåˆ°å¤´ç–¼ã€‚Go 1.24 ç‰ˆæœ¬å¼•å…¥çš„å®éªŒæ€§åŒ… <code>testing/synctest</code> ä¸ºè¿™ä¸ªé—®é¢˜å¸¦æ¥äº†ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆã€‚ä»Šå¤©ï¼Œè®©æˆ‘ä»¬æ·±å…¥äº†è§£è¿™ä¸ªæ–°ç‰¹æ€§ã€‚</p><h1>å¹¶å‘æµ‹è¯•çš„ä¼ ç»Ÿå›°å¢ƒ</h1><p>åœ¨ä»‹ç»æ–°æ–¹æ¡ˆä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹ä¼ ç»Ÿçš„å¹¶å‘æµ‹è¯•é¢ä¸´å“ªäº›é—®é¢˜ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestTraditional</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    done := <span class="literal">false</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// æ‰§è¡ŒæŸäº›æ“ä½œ</span></span><br><span class="line">        time.Sleep(<span class="number">100</span> * time.Millisecond)</span><br><span class="line">        done = <span class="literal">true</span></span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…æ“ä½œå®Œæˆ</span></span><br><span class="line">    time.Sleep(<span class="number">200</span> * time.Millisecond)</span><br><span class="line">    <span class="keyword">if</span> !done &#123;</span><br><span class="line">        t.Fatal(<span class="string">&quot;æ“ä½œæœªå®Œæˆ&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ç§æ–¹å¼å­˜åœ¨æ˜æ˜¾çš„é—®é¢˜ï¼š</p><ol><li><strong>æ—¶é—´ä¾èµ–</strong>ï¼šéœ€è¦é€šè¿‡ Sleep ç­‰å¾…ï¼Œå¯¼è‡´æµ‹è¯•è¿è¡Œç¼“æ…¢</li><li><strong>ä¸ç¨³å®šæ€§</strong>ï¼šåœ¨ä¸åŒç¯å¢ƒä¸‹å¯èƒ½äº§ç”Ÿä¸åŒç»“æœ</li><li><strong>ç²¾ç¡®æ€§å·®</strong>ï¼šéš¾ä»¥å‡†ç¡®æŠŠæ¡æ£€æŸ¥æ—¶æœº</li></ol><h1>synctestï¼šä¼˜é›…çš„è§£å†³æ–¹æ¡ˆ</h1><p><code>testing/synctest</code> åŒ…é€šè¿‡ä¸¤ä¸ªæ ¸å¿ƒå‡½æ•°æ”¹å˜äº†è¿™ä¸€åˆ‡ï¼š</p><ul><li><code>Run()</code>: åˆ›å»ºéš”ç¦»çš„æµ‹è¯•ç¯å¢ƒï¼ˆbubbleï¼‰</li><li><code>Wait()</code>: ç­‰å¾…æ‰€æœ‰ goroutine è¿›å…¥ç¨³å®šçŠ¶æ€</li></ul><p>è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•æ”¹å†™ä¸Šé¢çš„æµ‹è¯•ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestWithSynctest</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    synctest.Run(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        done := <span class="literal">false</span></span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            <span class="comment">// æ‰§è¡ŒæŸäº›æ“ä½œ</span></span><br><span class="line">            time.Sleep(<span class="number">100</span> * time.Millisecond)</span><br><span class="line">            done = <span class="literal">true</span></span><br><span class="line">        &#125;()</span><br><span class="line"></span><br><span class="line">        synctest.Wait()  <span class="comment">// ç­‰å¾…æ‰€æœ‰ goroutine è¿›å…¥ç¨³å®šçŠ¶æ€</span></span><br><span class="line">        <span class="keyword">if</span> !done &#123;</span><br><span class="line">            t.Fatal(<span class="string">&quot;æ“ä½œæœªå®Œæˆ&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>æ·±å…¥ç†è§£ Wait æœºåˆ¶</h1><h2 id="Wait-çš„æœ¬è´¨">Wait çš„æœ¬è´¨</h2><p>å¾ˆå¤šå¼€å‘è€…åˆæ¬¡æ¥è§¦ <code>Wait()</code> æ—¶å¯èƒ½ä¼šæ„Ÿåˆ°å›°æƒ‘ï¼šå®ƒåˆ°åº•åœ¨ç­‰å¾…ä»€ä¹ˆï¼Ÿä»€ä¹ˆæ—¶å€™ä¼šè¿”å›ï¼Ÿ</p><p>æƒ³è±¡ä¸€ä¸ªåœºæ™¯ï¼šä½ åœ¨æ‹æ‘„ä¸€å¼ å…¨å®¶ç¦ï¼Œéœ€è¦ç­‰å¾…æ‰€æœ‰äººéƒ½æ‰¾åˆ°è‡ªå·±çš„ä½ç½®ï¼Œç«™å¥½ä¸åŠ¨ï¼Œæ‰èƒ½æŒ‰ä¸‹å¿«é—¨ã€‚<code>Wait()</code> å°±åƒè¿™ä¸ªæ‘„å½±å¸ˆï¼Œå®ƒåœ¨ç­‰å¾…æ‰€æœ‰ goroutineï¼ˆå°±åƒç…§ç‰‡ä¸­çš„äººï¼‰éƒ½è¿›å…¥ä¸€ä¸ªç¨³å®šçš„çŠ¶æ€ï¼ˆç«™å¥½ä¸åŠ¨ï¼‰ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">synctest.Run(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// ç±»æ¯”ï¼šä¸‰ä¸ªäººè¦æ‹å…¨å®¶ç¦</span></span><br><span class="line">    <span class="keyword">go</span> person1()  <span class="comment">// ç¬¬ä¸€ä¸ªäººæ‰¾ä½ç½®</span></span><br><span class="line">    <span class="keyword">go</span> person2()  <span class="comment">// ç¬¬äºŒä¸ªäººæ‰¾ä½ç½®</span></span><br><span class="line">    <span class="keyword">go</span> person3()  <span class="comment">// ç¬¬ä¸‰ä¸ªäººæ‰¾ä½ç½®</span></span><br><span class="line"></span><br><span class="line">    synctest.Wait()  <span class="comment">// ç­‰å¾…æ‰€æœ‰äººéƒ½ç«™å¥½ä¸åŠ¨</span></span><br><span class="line">    <span class="comment">// è¿™æ—¶å¯ä»¥å®‰å…¨åœ°&quot;æŒ‰ä¸‹å¿«é—¨&quot;ï¼ˆæ£€æŸ¥ç¨‹åºçŠ¶æ€ï¼‰</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="ä¸ºä»€ä¹ˆéœ€è¦-Waitï¼Ÿ">ä¸ºä»€ä¹ˆéœ€è¦ Waitï¼Ÿ</h2><p>åœ¨å¹¶å‘ç¨‹åºä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦åœ¨ç‰¹å®šæ—¶åˆ»æ£€æŸ¥ç¨‹åºçŠ¶æ€ã€‚ä½†æ˜¯ï¼Œå¦‚æœæŸäº› goroutine è¿˜åœ¨è¿è¡Œï¼Œè¿™ä¸ªçŠ¶æ€å¯èƒ½éšæ—¶å‘ç”Ÿå˜åŒ–ã€‚<code>Wait()</code> é€šè¿‡ç¡®ä¿æ‰€æœ‰ goroutine éƒ½è¿›å…¥ç¨³å®šçŠ¶æ€ï¼Œä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ª&quot;å¿«ç…§&quot;æ—¶åˆ»ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">synctest.Run(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    result := <span class="literal">false</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">        time.Sleep(<span class="number">1</span> * time.Second)</span><br><span class="line">        result = <span class="literal">true</span></span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    synctest.Wait()  <span class="comment">// ç­‰å¾… goroutine è¿›å…¥ç¨³å®šçŠ¶æ€</span></span><br><span class="line">    <span class="comment">// æ­¤æ—¶ result çš„å€¼æ˜¯ç¡®å®šçš„ï¼Œä¸ä¼šçªç„¶æ”¹å˜</span></span><br><span class="line">    fmt.Println(result)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="æŒä¹…é˜»å¡çš„æ¦‚å¿µ">æŒä¹…é˜»å¡çš„æ¦‚å¿µ</h2><p>å“ªäº›æ“ä½œä¼šå¯¼è‡´æŒä¹…é˜»å¡ï¼Ÿ</p><ul><li>channel æ“ä½œï¼ˆåŒä¸€ bubble å†…ï¼‰</li><li>time.Sleep</li><li>sync.WaitGroup.Wait</li><li>sync.Cond.Wait</li></ul><p>å“ªäº›æ“ä½œä¸ç®—æŒä¹…é˜»å¡ï¼Ÿ</p><ul><li>äº’æ–¥é”æ“ä½œ</li><li>å¤–éƒ¨ I/O</li><li>å¤–éƒ¨ channel æ“ä½œ</li></ul><h1>è™šæ‹Ÿæ—¶é’Ÿï¼šæµ‹è¯•çš„ç¥å™¨</h1><p><code>synctest</code> çš„å¦ä¸€ä¸ªå¼ºå¤§ç‰¹æ€§æ˜¯è™šæ‹Ÿæ—¶é’Ÿæœºåˆ¶ã€‚åœ¨ bubble å†…éƒ¨ï¼Œæ‰€æœ‰æ—¶é—´ç›¸å…³çš„æ“ä½œéƒ½ä½¿ç”¨è™šæ‹Ÿæ—¶é’Ÿï¼Œè¿™æ„å‘³ç€ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">synctest.Run(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// çœ‹ä¼¼ç­‰å¾…24å°æ—¶</span></span><br><span class="line">    time.Sleep(<span class="number">24</span> * time.Hour)</span><br><span class="line">    <span class="comment">// å®é™…ä¸Šç«‹å³æ‰§è¡Œå®Œæˆï¼</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç‰¹æ€§è®©æˆ‘ä»¬èƒ½å¤Ÿï¼š</p><ol><li>å¿«é€Ÿæµ‹è¯•é•¿æ—¶é—´æ“ä½œ</li><li>ç²¾ç¡®æ§åˆ¶æ—¶é—´æµé€</li><li>é¿å…æµ‹è¯•çš„ä¸ç¡®å®šæ€§</li></ol><h1>å®æˆ˜æ¡ˆä¾‹ï¼šæ·±å…¥ç†è§£ HTTP 100 Continue æµ‹è¯•</h1><h2 id="èƒŒæ™¯çŸ¥è¯†">èƒŒæ™¯çŸ¥è¯†</h2><p>HTTP çš„ 100 Continue æœºåˆ¶æ˜¯ä¸€ä¸ªä¼˜åŒ–å¤§æ–‡ä»¶ä¸Šä¼ çš„åè®®ç‰¹æ€§ï¼š</p><ol><li>å®¢æˆ·ç«¯æƒ³ä¸Šä¼ å¤§æ–‡ä»¶æ—¶ï¼Œå…ˆå‘é€å¸¦æœ‰ â€œExpect: 100-continueâ€ å¤´çš„è¯·æ±‚</li><li>æœåŠ¡å™¨å¯ä»¥å†³å®šæ˜¯å¦æ¥å—è¿™ä¸ªä¸Šä¼ ï¼š<ul><li>å¦‚æœæ¥å—ï¼Œè¿”å› â€œ100 Continueâ€</li><li>å¦‚æœæ‹’ç»ï¼Œå¯ä»¥ç›´æ¥è¿”å›é”™è¯¯çŠ¶æ€ç </li></ul></li><li>å®¢æˆ·ç«¯æ ¹æ®æœåŠ¡å™¨çš„å“åº”å†³å®šæ˜¯å¦å‘é€æ–‡ä»¶å†…å®¹</li></ol><h2 id="è¯¦ç»†æµ‹è¯•å®ç°">è¯¦ç»†æµ‹è¯•å®ç°</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestHTTPContinue</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    synctest.Run(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// ç¬¬ä¸€æ­¥ï¼šå»ºç«‹æµ‹è¯•ç¯å¢ƒ</span></span><br><span class="line">        srvConn, cliConn := net.Pipe()</span><br><span class="line">        <span class="keyword">defer</span> srvConn.Close()</span><br><span class="line">        <span class="keyword">defer</span> cliConn.Close()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç¬¬äºŒæ­¥ï¼šé…ç½® HTTP å®¢æˆ·ç«¯</span></span><br><span class="line">        tr := &amp;http.Transport&#123;</span><br><span class="line">            DialContext: <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, network, address <span class="type">string</span>)</span></span> (net.Conn, <span class="type">error</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> cliConn, <span class="literal">nil</span></span><br><span class="line">            &#125;,</span><br><span class="line">            ExpectContinueTimeout: <span class="number">5</span> * time.Second,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç¬¬ä¸‰æ­¥ï¼šå‡†å¤‡æµ‹è¯•æ•°æ®</span></span><br><span class="line">        body := <span class="string">&quot;request body&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç¬¬å››æ­¥ï¼šå‘é€è¯·æ±‚</span></span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            req, _ := http.NewRequest(<span class="string">&quot;PUT&quot;</span>, <span class="string">&quot;http://test.tld/&quot;</span>,</span><br><span class="line">                strings.NewReader(body))</span><br><span class="line">            req.Header.Set(<span class="string">&quot;Expect&quot;</span>, <span class="string">&quot;100-continue&quot;</span>)</span><br><span class="line">            resp, err := tr.RoundTrip(req)</span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                t.Errorf(<span class="string">&quot;è¯·æ±‚å¤±è´¥: %v&quot;</span>, err)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                resp.Body.Close()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç¬¬äº”æ­¥ï¼šéªŒè¯è¯·æ±‚å¤´</span></span><br><span class="line">        req, err := http.ReadRequest(bufio.NewReader(srvConn))</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            t.Fatalf(<span class="string">&quot;è¯»å–è¯·æ±‚å¤±è´¥: %v&quot;</span>, err)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç¬¬å…­æ­¥ï¼šéªŒè¯è¯·æ±‚ä½“æœªå‘é€</span></span><br><span class="line">        <span class="keyword">var</span> gotBody strings.Builder</span><br><span class="line">        <span class="keyword">go</span> io.Copy(&amp;gotBody, req.Body)</span><br><span class="line">        synctest.Wait()</span><br><span class="line">        <span class="keyword">if</span> got := gotBody.String(); got != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">            t.Fatalf(<span class="string">&quot;åœ¨å‘é€ 100 Continue ä¹‹å‰ï¼Œæ„å¤–æ”¶åˆ°è¯·æ±‚ä½“: %q&quot;</span>, got)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç¬¬ä¸ƒæ­¥ï¼šå‘é€ 100 Continue</span></span><br><span class="line">        srvConn.Write([]<span class="type">byte</span>(<span class="string">&quot;HTTP/1.1 100 Continue\r\n\r\n&quot;</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç¬¬å…«æ­¥ï¼šéªŒè¯è¯·æ±‚ä½“</span></span><br><span class="line">        synctest.Wait()</span><br><span class="line">        <span class="keyword">if</span> got := gotBody.String(); got != body &#123;</span><br><span class="line">            t.Fatalf(<span class="string">&quot;æ”¶åˆ°çš„è¯·æ±‚ä½“ %qï¼ŒæœŸæœ› %q&quot;</span>, got, body)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç¬¬ä¹æ­¥ï¼šå®Œæˆè¯·æ±‚</span></span><br><span class="line">        srvConn.Write([]<span class="type">byte</span>(<span class="string">&quot;HTTP/1.1 200 OK\r\n\r\n&quot;</span>))</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æµ‹è¯•çš„å…³é”®ç‚¹è§£æ">æµ‹è¯•çš„å…³é”®ç‚¹è§£æ</h2><ol><li><p><strong>ä½¿ç”¨ net.Pipe()</strong></p><ul><li>åˆ›å»ºå†…å­˜ä¸­çš„ç½‘ç»œè¿æ¥</li><li>é¿å…ä¾èµ–çœŸå®ç½‘ç»œ</li><li>ä¿è¯æµ‹è¯•çš„å¯é‡å¤æ€§</li></ul></li><li><p><strong>è¯·æ±‚å‘é€è¿‡ç¨‹</strong></p><ul><li>åœ¨ç‹¬ç«‹çš„ goroutine ä¸­å‘é€è¯·æ±‚</li><li>è®¾ç½® â€œExpect: 100-continueâ€ å¤´</li><li>å‡†å¤‡è¦å‘é€çš„è¯·æ±‚ä½“</li></ul></li><li><p><strong>éªŒè¯å…³é”®è¡Œä¸º</strong></p><ul><li>ç¡®è®¤è¯·æ±‚å¤´æ­£ç¡®å‘é€</li><li>éªŒè¯è¯·æ±‚ä½“åœ¨æ”¶åˆ° 100 Continue ä¹‹å‰æœªå‘é€</li><li>éªŒè¯è¯·æ±‚ä½“åœ¨æ”¶åˆ° 100 Continue åæ­£ç¡®å‘é€</li></ul></li><li><p><strong>ä½¿ç”¨ Wait çš„æ—¶æœº</strong></p><ul><li>åœ¨æ£€æŸ¥è¯·æ±‚ä½“ä¹‹å‰è°ƒç”¨ Wait</li><li>ç¡®ä¿æ‰€æœ‰æ•°æ®ä¼ è¾“æ“ä½œéƒ½å·²å®Œæˆæˆ–é˜»å¡</li><li>è·å¾—ç¨³å®šçš„ç¨‹åºçŠ¶æ€è¿›è¡ŒéªŒè¯</li></ul></li></ol><h1>ä½¿ç”¨å»ºè®®</h1><ol><li><strong>æ˜ç¡®è¾¹ç•Œ</strong>ï¼šç†è§£ä»€ä¹ˆæ“ä½œä¼šå¯¼è‡´æŒä¹…é˜»å¡ï¼Œä»€ä¹ˆä¸ä¼š</li><li><strong>æ¸…ç†èµ„æº</strong>ï¼šç¡®ä¿æ‰€æœ‰ goroutine åœ¨æµ‹è¯•ç»“æŸå‰é€€å‡º</li><li><strong>æ¨¡æ‹Ÿ I/O</strong>ï¼šä½¿ç”¨å†…å­˜ç®¡é“æ›¿ä»£çœŸå®ç½‘ç»œè¿æ¥</li><li><strong>åˆç†ä½¿ç”¨ Wait</strong>ï¼šåœ¨éœ€è¦æ£€æŸ¥çŠ¶æ€çš„å…³é”®ç‚¹è°ƒç”¨</li></ol><h1>æ³¨æ„äº‹é¡¹</h1><ol><li>ç›®å‰æ˜¯å®éªŒæ€§åŠŸèƒ½ï¼Œéœ€è¦è®¾ç½® <code>GOEXPERIMENT=synctest</code></li><li>ä¸æ”¯æŒæµ‹è¯•çœŸå®çš„å¤–éƒ¨ I/O æ“ä½œ</li><li>äº’æ–¥é”æ“ä½œä¸è¢«è§†ä¸ºæŒä¹…é˜»å¡</li></ol>]]></content>
    
    
    <summary type="html">æœ¬æ–‡ä»‹ç»äº† Go 1.24 ç‰ˆæœ¬å¼•å…¥çš„å®éªŒæ€§åŒ… testing/synctestï¼Œå¹¶è¯¦ç»†è®²è§£äº†å¦‚ä½•ä½¿ç”¨å®ƒä¼˜é›…åœ°æµ‹è¯•å¹¶å‘ä»£ç ã€‚</summary>
    
    
    
    <category term="go" scheme="https://hedon.top/categories/go/"/>
    
    
    <category term="go" scheme="https://hedon.top/tags/go/"/>
    
    <category term="å•å…ƒæµ‹è¯•" scheme="https://hedon.top/tags/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>ç›´æ’­ç³»ç»Ÿæ¨æ‹‰æµåŸç†</title>
    <link href="https://hedon.top/2025/03/04/live-stream-push-pull/"/>
    <id>https://hedon.top/2025/03/04/live-stream-push-pull/</id>
    <published>2025-03-04T03:34:09.000Z</published>
    <updated>2025-04-05T14:31:32.876Z</updated>
    
    <content type="html"><![CDATA[<h1>ç›´æ’­ç³»ç»Ÿæ¨æ‹‰æµåŸç†æ¦‚è¿°</h1><p>ç›´æ’­ç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½æ˜¯å®ç°ä¸»æ’­ç«¯è§†é¢‘é‡‡é›†åçš„å®æ—¶ä¼ è¾“ï¼Œä»¥åŠè§‚ä¼—ç«¯çš„å®æ—¶è§‚çœ‹ã€‚æ•´ä¸ªè¿‡ç¨‹ä¸»è¦åŒ…å«ï¼šæ¨æµã€æœåŠ¡å™¨å¤„ç†ã€æ‹‰æµä¸‰ä¸ªç¯èŠ‚ã€‚</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250304121833913.png" alt="ç›´æ’­ç³»ç»Ÿæ¶æ„"></p><h2 id="æ ¸å¿ƒæ¦‚å¿µè§£æ">æ ¸å¿ƒæ¦‚å¿µè§£æ</h2><h3 id="1-æ¨æµï¼ˆPushï¼‰">1. æ¨æµï¼ˆPushï¼‰</h3><p>æ¨æµæ˜¯æŒ‡ä¸»æ’­ç«¯å°†è§†é¢‘æ•°æ®ä¼ è¾“åˆ°æœåŠ¡å™¨çš„è¿‡ç¨‹ã€‚ä¸»è¦ä½¿ç”¨ <code>RTMP</code> åè®®ï¼ˆReal Time Messaging Protocolï¼‰ã€‚</p><p>æ¯”å¦‚å¯èƒ½æœ‰å¦‚ä¸‹æ¨æµ URL çš„ç”Ÿæˆé€»è¾‘ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">generatePushUrl</span><span class="params">(String pushDomain, String pushKey, String appName, String streamName, <span class="type">long</span> expireTime)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">pushUrl</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="comment">// æ¨æµåŸŸåæœªå¼€å¯é‰´æƒåŠŸèƒ½çš„æƒ…å†µä¸‹</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(pushKey)) &#123;</span><br><span class="line">        pushUrl = <span class="string">&quot;rtmp://&quot;</span> + pushDomain + <span class="string">&quot;/&quot;</span> + appName + <span class="string">&quot;/&quot;</span> + streamName;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">timeStamp</span> <span class="operator">=</span> System.currentTimeMillis() / <span class="number">1000L</span> + expireTime;</span><br><span class="line">        <span class="type">String</span> <span class="variable">stringToMd5</span> <span class="operator">=</span> <span class="string">&quot;/&quot;</span> + appName + <span class="string">&quot;/&quot;</span> + streamName + <span class="string">&quot;-&quot;</span> + Long.toString(timeStamp) + <span class="string">&quot;-0-0-&quot;</span> + pushKey;</span><br><span class="line">        <span class="type">String</span> <span class="variable">authKey</span> <span class="operator">=</span> md5(stringToMd5);</span><br><span class="line">        pushUrl = <span class="string">&quot;rtmp://&quot;</span> + pushDomain + <span class="string">&quot;/&quot;</span> + appName + <span class="string">&quot;/&quot;</span> + streamName + <span class="string">&quot;?auth_key=&quot;</span> + Long.toString(timeStamp) + <span class="string">&quot;-0-0-&quot;</span> + authKey;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pushUrl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¨æµåœ°å€çš„ç»„æˆéƒ¨åˆ†ï¼š</p><ul><li>rtmp:// - åè®®</li><li>pushDomain - æ¨æµåŸŸå</li><li>appName - åº”ç”¨åç§°</li><li>streamName - æµåç§°</li><li>auth_key - é‰´æƒå‚æ•°ï¼ˆå¯é€‰ï¼‰</li></ul><h3 id="2-æ‹‰æµï¼ˆPullï¼‰">2. æ‹‰æµï¼ˆPullï¼‰</h3><p>æ‹‰æµæ˜¯è§‚ä¼—è§‚çœ‹ç›´æ’­çš„è¿‡ç¨‹ã€‚æ”¯æŒå¤šç§åè®®ï¼š</p><ul><li>RTMPï¼šå»¶è¿Ÿä½ï¼ˆ1-3ç§’ï¼‰</li><li>HTTP-FLVï¼šå»¶è¿Ÿé€‚ä¸­ï¼ˆ2-5ç§’ï¼‰</li><li>HLS(m3u8)ï¼šå»¶è¿Ÿè¾ƒé«˜ï¼ˆ5-30ç§’ï¼‰</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FLV æ ¼å¼</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">generalPullUrlFlv</span><span class="params">(String pullDomain, String pullKey, String appName, String streamName, <span class="type">long</span> expireTime)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(pullKey)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;http://&quot;</span> + pullDomain + <span class="string">&quot;/&quot;</span> + appName + <span class="string">&quot;/&quot;</span> + streamName + <span class="string">&quot;.flv&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ... é‰´æƒé€»è¾‘</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HLS æ ¼å¼</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">generalPullUrlHls</span><span class="params">(String pullDomain, String pullKey, String appName, String streamName, <span class="type">long</span> expireTime)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(pullKey)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;http://&quot;</span> + pullDomain + <span class="string">&quot;/&quot;</span> + appName + <span class="string">&quot;/&quot;</span> + streamName + <span class="string">&quot;.m3u8&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ... é‰´æƒé€»è¾‘</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç›´æ’­æµç¨‹">ç›´æ’­æµç¨‹</h2><ol><li><p><strong>ä¸»æ’­å¼€æ’­</strong>ï¼š</p><ul><li>ç³»ç»Ÿç”Ÿæˆå”¯ä¸€çš„ streamId</li><li>ç”Ÿæˆå¸¦é‰´æƒçš„æ¨æµåœ°å€</li><li>ä¸»æ’­ç«¯æ¨æµè½¯ä»¶ï¼ˆå¦‚ OBSï¼‰å¼€å§‹æ¨æµ</li></ul></li><li><p><strong>æœåŠ¡å™¨å¤„ç†</strong>ï¼š</p><ul><li>æµåª’ä½“æœåŠ¡å™¨æ¥æ”¶æ¨æµ</li><li>è¿›è¡Œè½¬ç ã€å½•åˆ¶ç­‰å¤„ç†</li><li>å°†æµåˆ†å‘åˆ° CDN èŠ‚ç‚¹</li></ul></li><li><p><strong>è§‚ä¼—è§‚çœ‹</strong>ï¼š</p><ul><li>è·å–å¯¹åº”æ ¼å¼çš„æ‹‰æµåœ°å€</li><li>é€šè¿‡æ’­æ”¾å™¨æ‹‰å–ç›´æ’­æµ</li><li>å®ç°å®æ—¶è§‚çœ‹</li></ul></li></ol><h2 id="å®ç°å»ºè®®">å®ç°å»ºè®®</h2><ol><li><p><strong>é€‰æ‹©åˆé€‚çš„æµåª’ä½“æœåŠ¡å™¨</strong>ï¼š</p><ul><li>å•†ä¸šäº‘æœåŠ¡ï¼šé˜¿é‡Œäº‘ç›´æ’­ã€è…¾è®¯äº‘ç›´æ’­</li><li>å¼€æºæ–¹æ¡ˆï¼šSRSã€Nginx-RTMP</li></ul></li><li><p><strong>æ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©åè®®</strong>ï¼š</p><ul><li>æ™®é€šç›´æ’­ï¼šHTTP-FLV</li><li>ä½å»¶è¿Ÿåœºæ™¯ï¼šRTMP</li><li>ç§»åŠ¨ç«¯å…¼å®¹æ€§è¦æ±‚é«˜ï¼šHLS</li></ul></li><li><p><strong>å…³æ³¨å…³é”®æŒ‡æ ‡</strong>ï¼š</p><ul><li>å»¶è¿Ÿæ§åˆ¶</li><li>å¡é¡¿ç‡</li><li>é¦–å±æ—¶é—´</li><li>å¸¦å®½æˆæœ¬</li></ul></li><li><p><strong>å®‰å…¨é‰´æƒï¼š</strong></p><ul><li>é˜²ç›—é“¾æœºåˆ¶</li></ul></li></ol>]]></content>
    
    
    <summary type="html">æœ¬æ–‡ä»‹ç»äº†ç›´æ’­ç³»ç»Ÿæ¨æ‹‰æµçš„åŸºæœ¬åŸç†ï¼ŒåŒ…æ‹¬æ¨æµå’Œæ‹‰æµçš„è¿‡ç¨‹ã€åè®®é€‰æ‹©ã€å…³é”®æŒ‡æ ‡ç­‰ã€‚</summary>
    
    
    
    <category term="è§£å†³æ–¹æ¡ˆ" scheme="https://hedon.top/categories/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"/>
    
    <category term="ç›´æ’­ç³»ç»Ÿ" scheme="https://hedon.top/categories/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/%E7%9B%B4%E6%92%AD%E7%B3%BB%E7%BB%9F/"/>
    
    
    <category term="ç›´æ’­ç³»ç»Ÿ" scheme="https://hedon.top/tags/%E7%9B%B4%E6%92%AD%E7%B3%BB%E7%BB%9F/"/>
    
  </entry>
  
  <entry>
    <title>ç½‘ç»œæ•°æ®åŒ…çš„å®Œæ•´æ—…ç¨‹ï¼šä»å‘é€åˆ°æ¥æ”¶çš„å…¨è¿‡ç¨‹</title>
    <link href="https://hedon.top/2025/03/01/net-data-journey/"/>
    <id>https://hedon.top/2025/03/01/net-data-journey/</id>
    <published>2025-03-01T04:58:37.000Z</published>
    <updated>2025-04-05T14:31:32.876Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸çŸ¥é“ä½ æ˜¯å¦æ›¾ç»å¥½å¥‡ä½ å‘å‡ºçš„ä¸€ä¸ªç½‘ç»œè¯·æ±‚ï¼Œæœ€ç»ˆæ˜¯æ€ä¹ˆåˆ°è¾¾å¯¹ç«¯ï¼Œå¹¶å°†ä½ æƒ³è¦çš„ä¿¡æ¯è¿”å›ç»™ä½ çš„ã€‚æœ¬æ–‡å°†é€šè¿‡ä¸€ä¸ª HTTP è¯·æ±‚ä¸å“åº”ï¼Œä»ä¸€ä¸ªæ¯”è¾ƒå®è§‚çš„è§’åº¦æ¥æ¢³ç†ä¸‹ä¸€ä¸ªæ•°æ®åŒ…åœ¨ç½‘ç»œä¸­çš„æ—…é€”ï¼Œæ—¨åœ¨å¸®åŠ©ç¬”è€…å’Œå„ä½è¯»è€…å»ºç«‹èµ·å¯¹è®¡ç®—æœºç½‘ç»œæ¨¡å‹ä¸€ä¸ªæ¯”è¾ƒå…¨é¢çš„è®¤çŸ¥ã€‚</p><blockquote><p>æœ¬æ–‡å‚è€ƒæå®¢æ—¶é—´ã€Šç½‘ç»œæ¶æ„å®æˆ˜è¯¾ï¼ˆè°¢å‹é¹ï¼‰ã€‹ï¼Œå†æ ¹æ®ç¬”è€…çš„çŸ¥è¯†é¢ã€æŒ‰ç…§ä¸ªäººç†è§£ï¼Œè¡¥å……æ›´å¤šä¸°å¯Œå…·ä½“çš„å†…å®¹ã€‚</p></blockquote><h1>å®æˆ˜</h1><p>å¥½ï¼Œé‚£æˆ‘ä»¬ç›´æ¥å¼€å§‹ï¼Œæˆ‘ä»¬å…ˆä½¿ç”¨ <code>curl</code> æ¥å‘èµ·ä¸€ä¸ª HTTP è¯·æ±‚ï¼Œçœ‹çœ‹è¿™è¿‡ç¨‹ä¸­å‘ç”Ÿäº†ä»€ä¹ˆï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -o /dev/null -v https://example.com</span><br></pre></td></tr></table></figure><p>åœ¨ç¬”è€…çš„ mac æœºå™¨ä¸Šï¼Œè¿™è¡Œå‘½ä»¤çš„è¾“å‡ºå¦‚ä¸‹ï¼š</p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250301131247066.png" data-fancybox="true" alt="curl https//example.com ç»“æœåˆ†æ" style="width: 100%; height: auto;"><p>å½“æˆ‘ä»¬å‘èµ·è¯·æ±‚æ—¶ï¼Œé¦–å…ˆä¼šå¯¹ <code>example.com</code> è¿›è¡ŒåŸŸåè§£æï¼Œåˆ†åˆ«å°è¯•è§£æåˆ°å®ƒçš„ <code>IPv6</code> å’Œ <code>IPv4</code>ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* IPv6: (none)</span><br><span class="line">* IPv4: 23.215.0.138, 96.7.128.198, 23.192.228.80, 23.192.228.84, 23.215.0.136, 96.7.128.175</span><br></pre></td></tr></table></figure><p>å› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ <code>https</code> åè®®ï¼Œæ‰€ä»¥ä¼šå°è¯•è·Ÿè¿™äº›åœ°å€çš„ <code>443</code> ç«¯å£å»ºç«‹ <code>TCP</code> è¿æ¥ï¼Œï¼ˆå¦‚æœæ˜¯ <code>https</code> åˆ™è·Ÿ <code>80</code> ç«¯å£ï¼‰ï¼Œå¹¶è¿›è¡Œ <code>TLS æ¡æ‰‹éªŒè¯</code>ï¼Œå¦‚æœæˆåŠŸäº†ï¼Œåˆ™ä¼šå»ºç«‹ <code>TCP</code> è¿æ¥ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*   Trying <span class="number">23.215</span><span class="number">.0</span><span class="number">.138</span>:<span class="number">443.</span>..</span><br><span class="line">...[TLS handshake]</span><br><span class="line">* Connected to example.com (<span class="number">23.215</span><span class="number">.0</span><span class="number">.138</span>) port <span class="number">443</span></span><br></pre></td></tr></table></figure><p>å»ºç«‹è¿æ¥åï¼Œå°±å¼€å§‹å‘é€ <code>HTTP</code> è¯·æ±‚ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ HTTP2 åè®®ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">* using HTTP/2</span><br><span class="line">  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0* [HTTP/2] [1] OPENED stream <span class="keyword">for</span> https://example.com/</span><br><span class="line">* [HTTP/2] [1] [:method: GET]</span><br><span class="line">* [HTTP/2] [1] [:scheme: https]</span><br><span class="line">* [HTTP/2] [1] [:authority: example.com]</span><br><span class="line">* [HTTP/2] [1] [:path: /]</span><br><span class="line">* [HTTP/2] [1] [user-agent: curl/8.10.1]</span><br><span class="line">* [HTTP/2] [1] [accept: */*]</span><br><span class="line">&#125; [5 bytes data]</span><br><span class="line">&gt; GET / HTTP/2</span><br><span class="line">&gt; Host: example.com</span><br><span class="line">&gt; User-Agent: curl/8.10.1</span><br><span class="line">&gt; Accept: */*</span><br><span class="line">&gt;</span><br><span class="line">* Request completely sent off</span><br></pre></td></tr></table></figure><p>æœ€åï¼ŒæœåŠ¡å™¨è¿”å›äº† HTTP 200 OK çš„å“åº”ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123; [5 bytes data]</span><br><span class="line">* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):</span><br><span class="line">&#123; [265 bytes data]</span><br><span class="line">* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):</span><br><span class="line">&#123; [265 bytes data]</span><br><span class="line">&lt; HTTP/2 200</span><br><span class="line">&lt; content-type: text/html</span><br><span class="line">&lt; etag: <span class="string">&quot;84238dfc8092e5d9c0dac8ef93371a07:1736799080.121134&quot;</span></span><br><span class="line">&lt; last-modified: Mon, 13 Jan 2025 20:11:20 GMT</span><br><span class="line">&lt; cache-control: max-age=1374</span><br><span class="line">&lt; <span class="built_in">date</span>: Sat, 01 Mar 2025 05:01:03 GMT</span><br><span class="line">&lt; alt-svc: h3=<span class="string">&quot;:443&quot;</span>; ma=93600,h3-29=<span class="string">&quot;:443&quot;</span>; ma=93600,quic=<span class="string">&quot;:443&quot;</span>; ma=93600; v=<span class="string">&quot;43&quot;</span></span><br><span class="line">&lt; content-length: 1256</span><br><span class="line">&lt;</span><br><span class="line">&#125; [5 bytes data]</span><br><span class="line">100  1256  100  1256    0     0   1172      0  0:00:01  0:00:01 --:--:--  1172</span><br><span class="line">* Connection <span class="comment">#0 to host example.com left intact</span></span><br></pre></td></tr></table></figure><p>è¦è¿›ä¸€æ­¥äº†è§£ç½‘ç»œæ•°æ®åŒ…çš„ç»†èŠ‚ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŠ“åŒ…å·¥å…·è¿›è¡Œåˆ†æã€‚ä½ å¯ä»¥ä½¿ç”¨ <code>tcpdump</code> æŠ“å–ä¸ <a href="http://example.com">example.com</a> çš„é€šä¿¡æ•°æ®åŒ…ã€‚</p><p>è¿è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> tcpdump host example.com -w example.com.pcap</span><br></pre></td></tr></table></figure><p>ç„¶åå†å¦å¤–ä¸€ä¸ªå‘½ä»¤è¡Œçª—å£å†æ¬¡å‘é€è¯·æ±‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -o /dev/null -v https://example.com</span><br></pre></td></tr></table></figure><p>å›åˆ° <code>tcpdump</code> çš„çª—å£å¹¶ç»“æŸç›‘å¬ï¼Œæˆ‘ä»¬å°±ä¼šå¾—åˆ° <code>example.com.pcap</code> çš„æŠ“åŒ…æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡ <code>Wireshark</code> è½¯ä»¶æ‰“å¼€è¯¥æ–‡ä»¶ï¼š</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250301133015523.png" alt="tcpdump åˆ†æç»“æœ"></p><h1>ç½‘ç»œåˆ†å±‚</h1><p>é€šè¿‡ä¸Šè¿°å®éªŒï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ™°çœ‹åˆ°ç½‘ç»œæ˜¯åˆ†å±‚çš„ï¼Œä¸»æµçš„åˆ†å±‚æ¨¡å‹æœ‰ OSI ä¸ƒå±‚æ¨¡å‹å’Œ TCP/IP å››å±‚æ¨¡å‹ï¼Œå®ƒä»¬çš„å¯¹åº”å…³ç³»åŠå¸¸è§çš„åè®®å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/OSI-vs-TCP.png" alt="OSI-vs-TCP/IP"></p><p>æˆ‘ä»¬åœ¨ Wireshark ä¸Šæ–¹éšä¾¿é€‰æ‹©ä¸€ä¸ªæ•°æ®åŒ…ï¼Œä½¿ç”¨é¼ æ ‡ç‚¹å‡»ä¸‹æ–¹å·¦ä¾§çš„æ¯ä¸€å±‚ï¼Œå¯ä»¥åœ¨å³ä¾§çœ‹åˆ°å¯¹åº”çš„å±‚çº§æ•°æ®ã€‚ä»é“¾è·¯å±‚åˆ°åº”ç”¨å±‚ï¼Œæ¯ä¸€å±‚çš„æ•°æ®éƒ½æ˜¯å¯¹ä¸‹ä¸€å±‚çš„è¿›ä¸€æ­¥å°è£…ã€‚</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250301134103404.png" alt="æ•°æ®åŒ…å°è£…"></p><p>åœ¨å‘é€æ–¹ï¼Œç”¨æˆ·ç¨‹åºéœ€è¦ä¼ è¾“çš„æ•°æ®ä¼šç»è¿‡é€å±‚å°è£…ã€‚é¦–å…ˆæ·»åŠ åº”ç”¨å±‚çš„ HTTP Headerï¼Œç„¶åæ˜¯ä¼ è¾“å±‚çš„ TCP Headerï¼Œæ¥ç€æ˜¯ç½‘ç»œå±‚çš„ IP Headerï¼Œæœ€ååœ¨é“¾è·¯å±‚æ·»åŠ ä»¥å¤ªç½‘å¸§çš„å¸§å¤´å’Œå¸§å°¾ï¼ŒåŒ…æ‹¬æº MAC åœ°å€ã€ç›®çš„ MAC åœ°å€ç­‰é“¾è·¯å±‚ä¿¡æ¯ï¼Œæœ€ç»ˆå½¢æˆç½‘ç»œä¸­ä¼ è¾“çš„å®Œæ•´æ•°æ®åŒ…ã€‚</p><p>åœ¨æ¥æ”¶æ–¹ï¼Œæ•°æ®åŒ…ä¼šæŒ‰ç›¸åçš„é¡ºåºé€å±‚è§£å°è£…ã€‚æ¥æ”¶è®¾å¤‡ä»é“¾è·¯å±‚å¼€å§‹è§£ææ•°æ®ï¼Œä¾æ¬¡è§£è¯»ç½‘ç»œå±‚ã€ä¼ è¾“å±‚å’Œåº”ç”¨å±‚çš„ä¿¡æ¯ï¼Œæœ€åå°†æ•°æ®ä¼ é€’ç»™æ¥æ”¶æ–¹çš„åº”ç”¨ç¨‹åºã€‚</p><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/cn1.png" alt="æ•°æ®åŒ…å°è£… &amp; è§£æ"></p><p>æˆ‘ä»¬åœ¨ Wireshark ä¸­ç‚¹å¼€ä¸‹é¢çš„æ¯ä¸€å±‚ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼Œæˆ‘åœ¨å›¾æ ‡æ³¨äº†æœ€é‡è¦çš„å‡ ä¸ªä¿¡æ¯ï¼š<img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250301135433547.png" alt="ç½‘ç»œæ•°æ®åŒ…å…³é”®ä¿¡æ¯"></p><h1>ç½‘ç»œä¹‹æ—…</h1><p>ç»è¿‡ä¸Šè¿°å®éªŒï¼Œæˆ‘ä»¬å¯ä»¥åšä¸ªå°æ€»ç»“ï¼š</p><p>é€šè¿‡ä¸Šè¿°å®éªŒï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ™°ç†è§£æ•°æ®åŒ…çš„ä¼ è¾“è¿‡ç¨‹ï¼š</p><ul><li>HTTP è¯·æ±‚æ˜¯ç½‘ç»œé€šä¿¡çš„åº”ç”¨å±‚å†…å®¹ï¼Œå®ƒéœ€è¦é€šè¿‡å„å±‚ç½‘ç»œåè®®çš„å°è£…æ‰èƒ½å®ç°ç«¯åˆ°ç«¯ä¼ è¾“ã€‚</li><li>ä»å‘é€æ–¹è§’åº¦ï¼Œæ•°æ®ä¼ è¾“éµå¾ªä¸€ä¸ªæ˜ç¡®çš„é€»è¾‘é¡ºåºï¼šé¦–å…ˆå°†åŸŸåï¼ˆ<a href="http://example.com">example.com</a>ï¼‰è§£æä¸º IP åœ°å€ï¼Œç„¶ååŸºäºè¯¥ IP åœ°å€å’Œç›®æ ‡ç«¯å£ï¼ˆ443ï¼‰å»ºç«‹ TCP è¿æ¥ï¼Œæ¥ç€æ‰¾åˆ°ç›®æ ‡ IP çš„ MAC åœ°å€ï¼Œæœ€ç»ˆç”±ç½‘å¡å°†å®Œæ•´å°è£…çš„æ•°æ®åŒ…å‘é€åˆ°ç½‘ç»œä¸­ã€‚</li><li>ä»æ¥æ”¶æ–¹è§’åº¦ï¼ŒæœåŠ¡å™¨å¤„ç†æ•°æ®åŒ…çš„è¿‡ç¨‹æ˜¯ä¸€ä¸ªè‡ªä¸‹è€Œä¸Šçš„è§£å°è£…è¿‡ç¨‹ï¼šæ•°æ®é“¾è·¯å±‚æ¥æ”¶åˆ°çš„å¸§åŒ…å«æº MAC åœ°å€ï¼Œç½‘ç»œå±‚è§£æå‡º IPv4 åœ°å€å’Œåè®®ç±»å‹ï¼Œä¼ è¾“å±‚è¯†åˆ«å‡º TCP åè®®å’Œæºç«¯å£å·ï¼Œæœ€ç»ˆåœ¨åº”ç”¨å±‚è·å–å¹¶å¤„ç† HTTP è¯·æ±‚æ•°æ®ã€‚æœåŠ¡å™¨æ ¹æ®è¿™äº›ä¿¡æ¯æ„å»ºå“åº”ï¼Œå¹¶æŒ‰ç›¸åé¡ºåºå°è£…è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</li></ul><p>è¿™ç§åˆ†å±‚å¤„ç†æœºåˆ¶ç¡®ä¿äº†ç½‘ç»œé€šä¿¡çš„çµæ´»æ€§å’Œå¯é æ€§ï¼Œæ¯å±‚åªéœ€å…³æ³¨è‡ªå·±çš„èŒè´£ï¼Œå…±åŒå®Œæˆç«¯åˆ°ç«¯çš„æ•°æ®ä¼ è¾“ä»»åŠ¡ã€‚</p><p>å¥½ï¼Œé‚£ä¹ˆè¿™é‡Œå°±æœ‰ 2 ä¸ªæœ€å…³é”®çš„é—®é¢˜ï¼š</p><ol><li>å¦‚ä½•é€šè¿‡åŸŸåè·å¾— IP åœ°å€ï¼Ÿ</li><li>å¦‚ä½•é€šè¿‡ IP åœ°å€è·å– MAC åœ°å€ï¼Ÿ</li></ol><h2 id="DNS-è§£æ">DNS è§£æ</h2><p>DNSï¼ˆDomain Name Systemï¼ŒåŸŸåç³»ç»Ÿï¼‰æ˜¯äº’è”ç½‘çš„ä¸€é¡¹æ ¸å¿ƒæœåŠ¡ï¼Œå®ƒå…è®¸æˆ‘ä»¬ä½¿ç”¨æ˜“è®°çš„åŸŸåï¼ˆå¦‚ <code>example.com</code>ï¼‰è€Œä¸æ˜¯æ•°å­— IP åœ°å€ï¼ˆå¦‚ <code>93.184.216.34</code>ï¼‰æ¥è®¿é—®ç½‘ç«™ã€‚</p><p>å½“ä½ åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ä¸€ä¸ªåŸŸåæ—¶ï¼ŒDNS è§£ææŒ‰ä»¥ä¸‹æ­¥éª¤è¿›è¡Œï¼š</p><ol><li><p><strong>æµè§ˆå™¨ç¼“å­˜æ£€æŸ¥</strong>ï¼šæµè§ˆå™¨é¦–å…ˆæ£€æŸ¥è‡ªå·±çš„ç¼“å­˜ï¼Œçœ‹æ˜¯å¦å·²ç»å­˜å‚¨äº†è¯¥åŸŸåå¯¹åº”çš„ IP åœ°å€ã€‚</p></li><li><p><strong>æ“ä½œç³»ç»Ÿç¼“å­˜æ£€æŸ¥</strong>ï¼šå¦‚æœæµè§ˆå™¨ç¼“å­˜ä¸­æ²¡æœ‰ï¼Œç³»ç»Ÿä¼šæ£€æŸ¥æ“ä½œç³»ç»Ÿçš„ DNS ç¼“å­˜ï¼ˆå¦‚ Windows çš„ DNS Client æœåŠ¡ï¼‰ã€‚</p></li><li><p><strong>è·¯ç”±å™¨ç¼“å­˜æ£€æŸ¥</strong>ï¼šè‹¥ç³»ç»Ÿç¼“å­˜ä¸­ä¹Ÿæ²¡æœ‰ï¼Œè¯·æ±‚ä¼šè¢«å‘é€åˆ°ä½ çš„è·¯ç”±å™¨ï¼Œå®ƒä¹Ÿç»´æŠ¤ç€ä¸€ä¸ª DNS ç¼“å­˜ã€‚</p></li><li><p><strong>ISP DNS æœåŠ¡å™¨æŸ¥è¯¢</strong>ï¼šå¦‚æœä»¥ä¸Šç¼“å­˜éƒ½æœªå‘½ä¸­ï¼Œè¯·æ±‚ä¼šè¢«å‘é€åˆ°ä½ çš„ ISPï¼ˆäº’è”ç½‘æœåŠ¡æä¾›å•†ï¼‰çš„ DNS æœåŠ¡å™¨ã€‚</p></li><li><p><strong>é€’å½’æŸ¥è¯¢</strong>ï¼šISP çš„ DNS æœåŠ¡å™¨ä¼šæ‰§è¡Œé€’å½’æŸ¥è¯¢ï¼š</p><ul><li>é¦–å…ˆæŸ¥è¯¢æ ¹åŸŸåæœåŠ¡å™¨ï¼ˆRoot DNS Serverï¼‰</li><li>æ ¹æœåŠ¡å™¨ä¼šå¼•å¯¼åˆ°é¡¶çº§åŸŸåæœåŠ¡å™¨ï¼ˆTLD DNS Serverï¼Œå¦‚ .com, .net, .org ç­‰ï¼‰</li><li>é¡¶çº§åŸŸåæœåŠ¡å™¨ä¼šå¼•å¯¼åˆ°æƒå¨åŸŸåæœåŠ¡å™¨ï¼ˆAuthoritative DNS Serverï¼‰</li><li>æƒå¨æœåŠ¡å™¨ä¼šè¿”å›è¯¥åŸŸåçš„ IP åœ°å€</li></ul></li><li><p><strong>ç»“æœè¿”å›ä¸ç¼“å­˜</strong>ï¼šä¸€æ—¦è·å–åˆ° IP åœ°å€ï¼Œå®ƒä¼šè¢«æ²¿ç€æŸ¥è¯¢è·¯å¾„è¿”å›ï¼Œå¹¶åœ¨å„ä¸ªå±‚çº§ä¸Šç¼“å­˜ä¸€æ®µæ—¶é—´ï¼ˆç”± TTL å€¼å†³å®šï¼‰ã€‚</p></li></ol><p>ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å·¥å…·æŸ¥è¯¢ DNS ä¿¡æ¯ï¼š</p><ul><li><strong>nslookup</strong>ï¼š<code>nslookup example.com</code></li><li><strong>dig</strong>ï¼š<code>dig example.com</code></li><li><strong>host</strong>ï¼š<code>host example.com</code></li></ul><p>è¿™äº›å·¥å…·å¯ä»¥å¸®åŠ©ä½ äº†è§£åŸŸåçš„è§£æè¿‡ç¨‹å’Œç»“æœã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ host example.com</span><br><span class="line">example.com has address 23.215.0.138</span><br><span class="line">example.com has address 23.192.228.84</span><br><span class="line">example.com has address 23.215.0.136</span><br><span class="line">example.com has address 23.192.228.80</span><br><span class="line">example.com has address 96.7.128.175</span><br><span class="line">example.com has address 96.7.128.198</span><br><span class="line">example.com has IPv6 address 2600:1408:ec00:36::1736:7f31</span><br><span class="line">example.com has IPv6 address 2600:1406:3a00:21::173e:2e65</span><br><span class="line">example.com has IPv6 address 2600:1406:3a00:21::173e:2e66</span><br><span class="line">example.com has IPv6 address 2600:1406:bc00:53::b81e:94c8</span><br><span class="line">example.com has IPv6 address 2600:1406:bc00:53::b81e:94ce</span><br><span class="line">example.com has IPv6 address 2600:1408:ec00:36::1736:7f24</span><br><span class="line">example.com mail is handled by 0 .</span><br></pre></td></tr></table></figure><p>é€šè¿‡ DNS è§£æå°†åŸŸåè½¬æ¢ä¸º IP åœ°å€åï¼Œç½‘ç»œé€šä¿¡çš„ä¸‹ä¸€æ­¥å°±æ˜¯ç¡®å®šå¦‚ä½•å°†æ•°æ®åŒ…å‘é€åˆ°ç›®æ ‡ IP åœ°å€ï¼Œè¿™å°±éœ€è¦ç”¨åˆ° ARP åè®®æ¥è·å–ç›®æ ‡è®¾å¤‡çš„ MAC åœ°å€ã€‚</p><h2 id="ç©¿è¶Šå®¢æˆ·ç«¯å±€åŸŸç½‘">ç©¿è¶Šå®¢æˆ·ç«¯å±€åŸŸç½‘</h2><p><strong>å½“æˆ‘ä»¬å‘é€ä¸€ä¸ªç½‘ç»œè¯·æ±‚æ—¶ï¼Œæ•°æ®åŒ…å¦‚ä½•æ‰¾åˆ°ç¦»å¼€å®¶åº­/åŠå…¬ç½‘ç»œçš„&quot;å‡ºå£&quot;ï¼Ÿ</strong></p><p>æ•°æ®åŒ…é¦–å…ˆéœ€è¦è§£å†³çš„æ˜¯&quot;è¯¥å¾€å“ªèµ°&quot;çš„é—®é¢˜ï¼š</p><ol><li><p><strong>é—®é¢˜ï¼šæˆ‘éœ€è¦ç›´æ¥è”ç³»ç›®æ ‡è®¾å¤‡è¿˜æ˜¯æ‰¾ä¸ª&quot;ä¸­ä»‹&quot;ï¼Ÿ</strong></p><p>è§£å†³æ–¹æ¡ˆï¼šå­ç½‘åˆ¤æ–­</p><ul><li>è®¾å¤‡ä¼šæ¯”è¾ƒç›®æ ‡ IP ä¸è‡ªå·±çš„ IP å’Œå­ç½‘æ©ç </li><li>å°±åƒåˆ¤æ–­æ”¶ä»¶äººæ˜¯ä¸æ˜¯ä½åœ¨åŒä¸€ä¸ªå°åŒº</li></ul></li><li><p><strong>é—®é¢˜ï¼šå¦‚ä½•æ‰¾åˆ°åŒä¸€ç½‘ç»œä¸­çš„è®¾å¤‡ï¼Ÿ</strong></p><p>è§£å†³æ–¹æ¡ˆï¼šARP åè®®</p><ul><li>ç±»ä¼¼äºå°åŒºå¹¿æ’­ï¼šâ€œè°æ˜¯ 202 å·æˆ¿çš„ï¼Ÿè¯·å‘Šè¯‰æˆ‘ä½ çš„é—¨ç‰Œå·ï¼â€</li><li>ç›®æ ‡è®¾å¤‡å›åº”è‡ªå·±çš„ MAC åœ°å€ï¼ˆè®¾å¤‡çš„&quot;èº«ä»½è¯å·&quot;ï¼‰</li></ul></li><li><p><strong>é—®é¢˜ï¼šç›®æ ‡åœ¨è¿œæ–¹ï¼Œå¦‚ä½•ç¦»å¼€æœ¬åœ°ç½‘ç»œï¼Ÿ</strong></p><p>è§£å†³æ–¹æ¡ˆï¼šé»˜è®¤ç½‘å…³</p><ul><li>å°±åƒä¸è®¤è¯†è¿œæ–¹æ”¶ä»¶äººçš„åœ°å€ï¼Œå…ˆäº¤ç»™å°åŒºé—¨å«ï¼ˆè·¯ç”±å™¨ï¼‰</li><li>æ•°æ®åŒ…å¤´ä¸Šæ ‡æ³¨æœ€ç»ˆç›®çš„åœ° IPï¼Œä½†å…ˆé€åˆ°ç½‘å…³çš„ MAC åœ°å€</li></ul></li><li><p><strong>é—®é¢˜ï¼šæ•°æ®å¦‚ä½•åœ¨æœ¬åœ°ç½‘ç»œä¸­è½¬å‘ï¼Ÿ</strong></p><p>è§£å†³æ–¹æ¡ˆï¼šäº¤æ¢æœºçš„ MAC åœ°å€è¡¨</p><ul><li>äº¤æ¢æœºå°±åƒå°åŒºå†…çš„å¿«é€’å‘˜ï¼Œè®°ä½äº†æ¯å®¶æ¯æˆ·çš„é—¨ç‰Œå·</li><li>å®ƒæŸ¥è¡¨åå°†åŒ…è£¹ç²¾ç¡®é€åˆ°å¯¹åº”çš„é—¨å£ï¼Œä¸ä¼šæ‰“æ‰°å…¶ä»–ä½æˆ·</li></ul></li></ol><p>ç®€å•æ¥è¯´ï¼Œæ•°æ®åŒ…åœ¨æœ¬åœ°ç½‘ç»œä¸­çš„æ—…ç¨‹å°±åƒæ˜¯å¿«é€’å…ˆç¡®è®¤æ”¶ä»¶äººæ˜¯å¦åœ¨åŒä¸€å°åŒºï¼Œå¦‚æœæ˜¯ï¼Œç›´æ¥é€è¾¾ï¼›å¦‚æœä¸æ˜¯ï¼Œåˆ™äº¤ç»™å°åŒºå‡ºå£çš„ä¿å®‰ï¼Œç”±ä»–è´Ÿè´£è¿›ä¸€æ­¥è½¬å‘ã€‚</p><h2 id="ç©¿è¶Šå…¬ç½‘">ç©¿è¶Šå…¬ç½‘</h2><p><strong>æ•°æ®åŒ…ç¦»å¼€äº†æœ¬åœ°ç½‘ç»œï¼Œå¦‚ä½•åœ¨èŒ«èŒ«äº’è”ç½‘ä¸­æ‰¾åˆ°é¥è¿œçš„ç›®æ ‡æœåŠ¡å™¨ï¼Ÿ</strong></p><p>æ•°æ®åŒ…åœ¨äº’è”ç½‘ä¸Šçš„æ—…ç¨‹å°±åƒä¸€æ¬¡è·¨å›½æ—…è¡Œï¼š</p><ol><li><p><strong>é—®é¢˜ï¼šå¦‚ä½•ä»ç§äººåŒºåŸŸè¿›å…¥å…¬å…±ä¸–ç•Œï¼Ÿ</strong></p><p>è§£å†³æ–¹æ¡ˆï¼šNATï¼ˆç½‘ç»œåœ°å€è½¬æ¢ï¼‰</p><ul><li><p>å°±åƒå¤šäººå…±ç”¨ä¸€ä¸ªæŠ¤ç…§å‡ºå›½ï¼Œæœ¬åœ°è®¾å¤‡å…±äº«ä¸€ä¸ªå…¬ç½‘ IP</p></li><li><p>è·¯ç”±å™¨ä¼šè®°ä½è°å‘äº†ä»€ä¹ˆè¯·æ±‚ï¼Œå›ç¨‹æ—¶èƒ½é€å›æ­£ç¡®çš„è®¾å¤‡</p></li></ul></li><li><p><strong>é—®é¢˜ï¼šäº’è”ç½‘å¦‚æ­¤åºå¤§å¤æ‚ï¼Œè°æ¥ç®¡ç†è¿™äº›ç½‘ç»œï¼Ÿ</strong></p><p>è§£å†³æ–¹æ¡ˆï¼šè‡ªæ²»ç³»ç»Ÿï¼ˆAutonomous System, ASï¼‰</p><ul><li><p>AS å°±åƒäº’è”ç½‘ä¸–ç•Œçš„&quot;å›½å®¶&quot;æˆ–&quot;ç‹¬ç«‹ç‹å›½&quot;</p></li><li><p>æ¯ä¸ª AS ç”±å•ä¸€æŠ€æœ¯ç®¡ç†æœºæ„æ§åˆ¶ï¼ˆå¦‚ ISPã€å¤§ä¼ä¸šæˆ–æ•™è‚²æœºæ„ï¼‰</p></li><li><p>ä½ çš„æ•°æ®åŒ…é¦–å…ˆè¿›å…¥ä½ çš„ ISP æ‰€åœ¨çš„ ASï¼Œç„¶åå¯èƒ½ç©¿è¶Šå¤šä¸ª AS</p></li><li><p>æ¯ä¸ª AS æœ‰å”¯ä¸€çš„ AS å·ï¼ˆASNï¼‰ï¼Œå¦‚ AS7018(AT&amp;T) æˆ– AS8075(Microsoft)</p></li></ul></li><li><p><strong>é—®é¢˜ï¼šè¿™äº›&quot;ç½‘ç»œç‹å›½&quot;å¦‚ä½•ç›¸äº’é€šä¿¡å’Œåˆä½œï¼Ÿ</strong></p><p>è§£å†³æ–¹æ¡ˆï¼šBGP åè®®(è¾¹ç•Œç½‘å…³åè®®)</p><ul><li><p>BGP æ˜¯ AS ä¹‹é—´çš„&quot;å¤–äº¤è¯­è¨€&quot;ï¼Œç”¨äºå®£å‘Šè·¯ç”±ä¿¡æ¯</p></li><li><p>å®ƒå‘Šè¯‰å…¶ä»– ASï¼šâ€œé€šè¿‡æˆ‘å¯ä»¥åˆ°è¾¾è¿™äº›ç½‘ç»œâ€</p></li><li><p>è·¯ç”±å™¨æ ¹æ® BGP ä¿¡æ¯ï¼Œå†³å®šæ•°æ®åŒ…åº”è¯¥ç»è¿‡å“ªäº› AS</p></li></ul></li><li><p><strong>é—®é¢˜ï¼šå¦‚ä½•å†³å®šæ•°æ®åŒ…åœ¨ AS å†…éƒ¨è¯¥èµ°å“ªæ¡è·¯ï¼Ÿ</strong></p><p>è§£å†³æ–¹æ¡ˆï¼šå†…éƒ¨è·¯ç”±åè®®</p><ul><li><p>AS å†…éƒ¨ä½¿ç”¨ OSPF æˆ– IS-IS ç­‰åè®®æ¥æ‰¾åˆ°æœ€ä½³è·¯å¾„</p></li><li><p>è·¯ç”±å™¨åƒåŸå¸‚ä¸­çš„äº¤é€šæŒ‡æŒ¥ï¼Œæ ¹æ®&quot;è·¯å†µ&quot;å†³å®šä¸‹ä¸€ä¸ªæ–¹å‘</p></li></ul></li><li><p><strong>é—®é¢˜ï¼šä¸åŒè¿è¥å•†ä¹‹é—´å¦‚ä½•è¿æ¥ï¼Ÿ</strong></p><p>è§£å†³æ–¹æ¡ˆï¼šäº’è”ç½‘äº¤æ¢ä¸­å¿ƒï¼ˆIXPï¼‰</p><ul><li><p>å°±åƒä¸åŒèˆªç©ºå…¬å¸åœ¨å¤§å‹æ¢çº½æœºåœºäº¤æ¢ä¹˜å®¢</p></li><li><p>æ•°æ®åŒ…åœ¨ IXP ä»ä¸€ä¸ª AS â€œè½¬æœºâ€åˆ°å¦ä¸€ä¸ª AS</p></li><li><p>è¿™å‡å°‘äº†è·¯å¾„é•¿åº¦ï¼Œæé«˜äº†ä¼ è¾“æ•ˆç‡</p></li></ul></li><li><p><strong>é—®é¢˜ï¼šæˆ‘èƒ½çŸ¥é“æˆ‘çš„æ•°æ®ç»è¿‡äº†å“ªäº›åœ°æ–¹å—ï¼Ÿ</strong></p><p>è§£å†³æ–¹æ¡ˆï¼šè·¯å¾„è¿½è¸ªå·¥å…·</p><ul><li><p>traceroute/tracert å°±åƒç»™æ•°æ®åŒ…è£…ä¸Š GPS</p></li><li><p>ä½ å¯ä»¥çœ‹åˆ°æ•°æ®åŒ…ç©¿è¶Šçš„ä¸åŒ AS å’Œè·¯ç”±å™¨</p></li></ul></li></ol><p>äº’è”ç½‘å°±åƒä¸€ä¸ªå·¨å¤§çš„å…¨çƒå¿«é€’ç½‘ç»œï¼Œä½ çš„æ•°æ®åŒ…å¯èƒ½ç©¿è¶Šå¤šä¸ªå›½å®¶ã€ç»è¿‡æµ·åº•ç”µç¼†ï¼Œç”±ä¸åŒçš„è¿è¥å•†æ¥åŠ›ä¼ é€’ï¼Œæœ€ç»ˆåˆ°è¾¾ç›®çš„åœ°çš„ç½‘ç»œã€‚</p><h2 id="ç©¿è¶ŠæœåŠ¡ç«¯å±€åŸŸç½‘">ç©¿è¶ŠæœåŠ¡ç«¯å±€åŸŸç½‘</h2><p><strong>æ•°æ®åŒ…åˆ°è¾¾ç›®æ ‡æ‰€åœ¨ç½‘ç»œåï¼Œå¦‚ä½•æ‰¾åˆ°å¹¶åˆ°è¾¾æœ€ç»ˆçš„æœåŠ¡å™¨ï¼Ÿ</strong></p><p>æ•°æ®åŒ…æŠµè¾¾ç›®çš„åœ°ç½‘ç»œï¼Œå°±åƒå›½é™…å¿«é€’åˆ°è¾¾ç›®æ ‡åŸå¸‚ï¼Œè¿˜éœ€è¦æœ€åä¸€æ®µ&quot;æœ¬åœ°é…é€&quot;ï¼š</p><ol><li><p><strong>é—®é¢˜ï¼šå¦‚ä½•ç¡®ä¿åªæœ‰åˆæ³•è¯·æ±‚èƒ½è¿›å…¥ç½‘ç»œï¼Ÿ</strong></p><p>è§£å†³æ–¹æ¡ˆï¼šé˜²ç«å¢™å’Œå®‰å…¨ç­–ç•¥</p><ul><li>å°±åƒæœºåœºæµ·å…³ï¼Œæ£€æŸ¥å…¥å¢ƒè€…æ˜¯å¦ç¬¦åˆå…¥å¢ƒæ¡ä»¶</li><li>åªæœ‰åˆæ³•çš„æ•°æ®åŒ…æ‰èƒ½é€šè¿‡å®‰å…¨æ£€æŸ¥</li></ul></li><li><p><strong>é—®é¢˜ï¼šå¤§å‹ç½‘ç«™å¦‚ä½•å¤„ç†æµ·é‡è¯·æ±‚ï¼Ÿ</strong></p><p>è§£å†³æ–¹æ¡ˆï¼šè´Ÿè½½å‡è¡¡</p><ul><li>åƒå¤§å‹åŒ»é™¢çš„åˆ†è¯Šå°ï¼Œå°†ç—…äººåˆ†é…åˆ°ä¸åŒçš„åŒ»ç”Ÿå¤„</li><li>æ ¹æ®æœåŠ¡å™¨è´Ÿè½½ã€ç”¨æˆ·ä½ç½®ç­‰å› ç´ æ™ºèƒ½åˆ†å‘è¯·æ±‚</li></ul></li><li><p><strong>é—®é¢˜ï¼šå¦‚ä½•åœ¨æ•°æ®ä¸­å¿ƒå¤æ‚ç¯å¢ƒä¸­æ‰¾åˆ°ç›®æ ‡æœåŠ¡å™¨ï¼Ÿ</strong></p><p>è§£å†³æ–¹æ¡ˆï¼šå†…éƒ¨è·¯ç”±ä¸æœ€åä¸€è·³ ARP</p><ul><li>æ•°æ®ä¸­å¿ƒå†…éƒ¨æœ‰è‡ªå·±çš„&quot;åœ°å›¾&quot;å’Œ&quot;é“è·¯ç³»ç»Ÿ&quot;</li><li>æœ€åä¸€ä¸ªè·¯ç”±å™¨ä¼šé€šè¿‡ ARP æ‰¾åˆ°æœåŠ¡å™¨çš„å…·ä½“ä½ç½®</li></ul></li><li><p><strong>é—®é¢˜ï¼šç°ä»£äº‘ç¯å¢ƒä¸­ï¼ŒæœåŠ¡å™¨å¯èƒ½æ˜¯è™šæ‹Ÿçš„ï¼Œæ€ä¹ˆå¤„ç†ï¼Ÿ</strong></p><p>è§£å†³æ–¹æ¡ˆï¼šè™šæ‹Ÿç½‘ç»œ</p><ul><li>ç‰©ç†æœåŠ¡å™¨ä¸Šå¯èƒ½è¿è¡Œå¤šä¸ªè™šæ‹Ÿæœºæˆ–å®¹å™¨</li><li>è™šæ‹Ÿäº¤æ¢æœºå°†æ•°æ®åŒ…å‡†ç¡®é€è¾¾è™šæ‹Ÿç¯å¢ƒä¸­çš„ç›®æ ‡åº”ç”¨</li></ul></li></ol><p>è¿™å°±åƒå›½é™…å¿«é€’æœ€åçš„â€œæœ€åä¸€å…¬é‡Œâ€é…é€ - ä»ç›®çš„åœ°åŸå¸‚çš„åˆ†æ‹£ä¸­å¿ƒï¼Œç»è¿‡å±‚å±‚ç­›é€‰ï¼Œæœ€ç»ˆé€åˆ°æ”¶ä»¶äººæ‰‹ä¸­ã€‚</p><h2 id="æ€»ç»“">æ€»ç»“</h2><p>ç½‘ç»œè¯·æ±‚å°±åƒä¸€å°å›½é™…ä¿¡ä»¶çš„æ—…ç¨‹ï¼š</p><ol><li><p>æœ¬åœ°æŠ•é€’ï¼šä»ä½ å®¶å‡ºå‘ï¼Œåˆ¤æ–­æ”¶ä»¶äººæ˜¯å¦åœ¨åŒå°åŒºã€‚å¦‚ä¸åœ¨ï¼Œäº¤ç»™å°åŒºå‡ºå£çš„é—¨å«ï¼ˆç½‘å…³ï¼‰ã€‚</p></li><li><p>å›½é™…è¿è¾“ï¼š</p><ul><li>å…ˆç»è¿‡ä½ æ‰€åœ¨â€œå›½å®¶â€ï¼ˆä½  ISP çš„ ASï¼‰çš„æµ·å…³ï¼ˆNATï¼‰</li><li>ç„¶åå¯èƒ½ç©¿è¶Šå¤šä¸ªâ€œå›½å®¶â€ï¼ˆä¸åŒçš„ ASï¼‰</li><li>å„å›½æµ·å…³ï¼ˆè·¯ç”±å™¨ï¼‰é€šè¿‡â€œå›½é™…æ¡çº¦â€ï¼ˆBGPï¼‰å†³å®šåŒ…è£¹èµ°å‘</li><li>æœ‰æ—¶é€šè¿‡â€œå›½é™…ä¸­è½¬ç«™â€ï¼ˆIXPï¼‰å¿«é€Ÿè½¬è¿åˆ°å…¶ä»–â€œå›½å®¶â€</li></ul></li><li><p>ç›®çš„åœ°é…é€ï¼š</p><ul><li><p>é€šè¿‡ç›®çš„åœ°â€œæµ·å…³â€ï¼ˆé˜²ç«å¢™ï¼‰å…¥å¢ƒæ£€æŸ¥</p></li><li><p>ç»è¿‡â€œåˆ†æ‹£ä¸­å¿ƒâ€ï¼ˆè´Ÿè½½å‡è¡¡å™¨ï¼‰åˆ†é…å¤„ç†äººå‘˜</p></li><li><p>æœ€ç»ˆé€šè¿‡â€œæœ¬åœ°å¿«é€’å‘˜â€ï¼ˆå†…éƒ¨è·¯ç”±å’Œäº¤æ¢ï¼‰é€è¾¾æ”¶ä»¶äººæ‰‹ä¸­</p></li></ul></li></ol><p>æ•°æ®åŒ…å°±è¿™æ ·å®Œæˆäº†å®¢æˆ·ç«¯è®¾å¤‡åˆ°æœåŠ¡å™¨çš„å…¨ç¨‹æ—…è¡Œï¼Œç„¶åæœåŠ¡å™¨çš„å“åº”å†æ²¿ç€ç±»ä¼¼çš„è·¯å¾„è¿”å›åˆ°å®¢æˆ·ç«¯è®¾å¤‡ï¼Œå®Œæˆæ•´ä¸ªè¯·æ±‚-å“åº”å¾ªç¯ã€‚</p><h1>å‚è€ƒ</h1><ul><li><p><a href="https://time.geekbang.org/column/article/846257">æå®¢æ—¶é—´ã€Šç½‘ç»œæ¶æ„å®æˆ˜è¯¾ã€‹</a></p></li><li><p><a href="https://www.geeksforgeeks.org/difference-between-osi-model-and-tcp-ip-model/">Difference Between OSI Model and TCP/IP Model</a></p></li></ul>]]></content>
    
    
    <summary type="html">é€šè¿‡ä¸€ä¸ª HTTP è¯·æ±‚ä¸å“åº”ï¼Œæ·±å…¥æ¢ç´¢èƒŒåçš„ç½‘ç»œé€šä¿¡æœºåˆ¶ï¼Œä» DNS è§£æã€TCP è¿æ¥åˆ°æ•°æ®å°è£…ä¸ä¼ è¾“ï¼Œå…¨é¢è§£ææ•°æ®åŒ…å¦‚ä½•ç©¿è¶Šå±€åŸŸç½‘ä¸å…¬ç½‘åˆ°è¾¾ç›®æ ‡æœåŠ¡å™¨ã€‚</summary>
    
    
    
    <category term="è®¡ç®—æœºåŸºç¡€" scheme="https://hedon.top/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/"/>
    
    <category term="è®¡ç®—æœºç½‘ç»œ" scheme="https://hedon.top/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"/>
    
    
    <category term="è®¡ç®—æœºç½‘ç»œ" scheme="https://hedon.top/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"/>
    
  </entry>
  
  <entry>
    <title>è§£å†³æ–¹æ¡ˆä¸¨æ¸¸æˆåç«¯ä¸­çš„ Push-ACK æœºåˆ¶è®¾è®¡ä¸å†…å­˜ä¼˜åŒ–</title>
    <link href="https://hedon.top/2025/02/27/solution-push-ack/"/>
    <id>https://hedon.top/2025/02/27/solution-push-ack/</id>
    <published>2025-02-27T12:31:45.000Z</published>
    <updated>2025-06-05T00:40:01.562Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¼•è¨€">å¼•è¨€</h2><p>åœ¨ç°ä»£åœ¨çº¿æ¸¸æˆå¼€å‘ä¸­ï¼ŒæœåŠ¡å™¨ä¸å®¢æˆ·ç«¯ä¹‹é—´å®æ—¶ã€å¯é çš„é€šä¿¡æœºåˆ¶æ˜¯æ¸¸æˆä½“éªŒçš„åŸºçŸ³ã€‚ä½œä¸ºä¸€åæ¸¸æˆåç«¯å¼€å‘è€…ï¼Œæˆ‘æ›¾ç»é‡åˆ°è¿‡è¿™æ ·çš„åœºæ™¯ï¼šæ›´æ–°äº†ä¸€ä¸ªå…¬ä¼šç³»ç»Ÿçš„æ–°åŠŸèƒ½ï¼ŒæœåŠ¡å™¨éœ€è¦å‘æˆåƒä¸Šä¸‡ä¸ªåœ¨çº¿ç©å®¶æ¨é€å…¬ä¼šçŠ¶æ€å˜æ›´ã€‚çŸ­çŸ­å‡ å°æ—¶åï¼ŒæœåŠ¡å™¨å†…å­˜ä½¿ç”¨ç‡é£™å‡è‡³ 90%ï¼Œç³»ç»Ÿå‘Šè­¦ä¸æ–­ã€‚é—®é¢˜å‡ºåœ¨å“ªé‡Œï¼ŸPush æ¶ˆæ¯çš„å¯é æ€§æœºåˆ¶å®ç°ä¸å½“å¯¼è‡´äº†å†…å­˜æ³„æ¼ã€‚</p><p>æœ¬æ–‡å°†æ·±å…¥æ¢è®¨æ¸¸æˆåç«¯ä¸­ Push-ACK æœºåˆ¶çš„è®¾è®¡ä¸å®ç°ï¼Œç‰¹åˆ«å…³æ³¨å¦‚ä½•é¿å…å†…å­˜æš´æ¶¨é—®é¢˜ï¼Œåˆ†äº«æˆ‘åœ¨å¤šä¸ªå¤§å‹æ¸¸æˆé¡¹ç›®ä¸­ç§¯ç´¯çš„ç»éªŒä¸æ•™è®­ã€‚</p><h2 id="èƒŒæ™¯ï¼šä¸ºä»€ä¹ˆéœ€è¦åº”ç”¨å±‚çš„-ACK-æœºåˆ¶ï¼Ÿ">èƒŒæ™¯ï¼šä¸ºä»€ä¹ˆéœ€è¦åº”ç”¨å±‚çš„ ACK æœºåˆ¶ï¼Ÿ</h2><p>TCP åè®®ç¡®å®æä¾›äº†å¯é çš„æ•°æ®ä¼ è¾“ä¿è¯ï¼ŒåŒ…æ‹¬æ•°æ®åŒ…çš„åºåˆ—å·ã€æ ¡éªŒå’Œã€è¶…æ—¶é‡ä¼ ç­‰æœºåˆ¶ã€‚é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬è¿˜éœ€è¦åœ¨åº”ç”¨å±‚å®ç°é¢å¤–çš„ ACK æœºåˆ¶å‘¢ï¼Ÿ</p><h3 id="TCP-å¯é æ€§çš„è¾¹ç•Œ">TCP å¯é æ€§çš„è¾¹ç•Œ</h3><p>TCP åªèƒ½ä¿è¯<strong>æ•°æ®è¢«é€è¾¾åˆ°å®¢æˆ·ç«¯çš„ç½‘ç»œæ ˆ</strong>ï¼Œä½†æ— æ³•ä¿è¯ï¼š</p><ol><li>æ•°æ®è¢«å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºæ­£ç¡®å¤„ç†</li><li>å¤„ç†è¿‡ç¨‹ä¸­æ²¡æœ‰å‡ºç°å¼‚å¸¸</li><li>å®¢æˆ·ç«¯çš„ä¸šåŠ¡é€»è¾‘æ­£ç¡®æ‰§è¡Œ</li></ol><p>æƒ³è±¡è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼šæœåŠ¡å™¨å‘ç©å®¶æ¨é€äº†ä¸€æ¡&quot;è·å¾—ç¨€æœ‰è£…å¤‡&quot;çš„æ¶ˆæ¯ï¼ŒTCP ç¡®ä¿äº†æ•°æ®é€è¾¾å®¢æˆ·ç«¯ï¼Œä½†å¦‚æœå®¢æˆ·ç«¯åœ¨å¤„ç†è¿™ä¸ªæ¶ˆæ¯æ—¶å´©æºƒäº†å‘¢ï¼Ÿå¯¹äºæ¸¸æˆè¿™ç±»çŠ¶æ€æ•æ„Ÿçš„åº”ç”¨ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“æ¶ˆæ¯æ˜¯å¦è¢«<strong>æˆåŠŸå¤„ç†</strong>ï¼Œè€Œä¸ä»…ä»…æ˜¯<strong>æˆåŠŸä¼ è¾“</strong>ã€‚</p><h3 id="ä¸šåŠ¡å¯é æ€§éœ€æ±‚">ä¸šåŠ¡å¯é æ€§éœ€æ±‚</h3><p>å®é™…æ¸¸æˆå¼€å‘ä¸­ï¼Œä¸åŒç±»å‹çš„æ¶ˆæ¯æœ‰ä¸åŒçš„å¯é æ€§éœ€æ±‚ï¼š</p><table><thead><tr><th>æ¶ˆæ¯ç±»å‹</th><th>ç¤ºä¾‹</th><th>å¯é æ€§éœ€æ±‚</th></tr></thead><tbody><tr><td>å…³é”®çŠ¶æ€å˜æ›´</td><td>é“å…·è·å–ã€è´§å¸å˜åŒ–</td><td>æé«˜ï¼ˆå¿…é¡»ç¡®è®¤å¤„ç†ï¼‰</td></tr><tr><td>æ¸¸æˆè¿›ç¨‹é€šçŸ¥</td><td>ä»»åŠ¡æ›´æ–°ã€æˆå°±è§£é”</td><td>é«˜ï¼ˆéœ€è¦ç¡®è®¤ï¼‰</td></tr><tr><td>å®æ—¶ä½ç½®åŒæ­¥</td><td>ç©å®¶ä½ç½®ã€NPC ç§»åŠ¨</td><td>ä¸­ï¼ˆæ–°æ•°æ®å¯è¦†ç›–æ—§æ•°æ®ï¼‰</td></tr><tr><td>ç¯å¢ƒä¿¡æ¯</td><td>å¤©æ°”å˜åŒ–ã€èƒŒæ™¯éŸ³ä¹</td><td>ä½ï¼ˆå¯æ¥å—å¶å°”ä¸¢å¤±ï¼‰</td></tr></tbody></table><h2 id="è®¾è®¡é€šç”¨çš„-Push-ACK-æœºåˆ¶">è®¾è®¡é€šç”¨çš„ Push-ACK æœºåˆ¶</h2><p>ä¸€ä¸ªå®Œå–„çš„ Push-ACK æœºåˆ¶éœ€è¦è€ƒè™‘ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼šæ¶ˆæ¯å”¯ä¸€æ ‡è¯†ã€ä¼˜å…ˆçº§åˆ†çº§ã€è¶…æ—¶é‡è¯•ã€æ‰¹é‡ç¡®è®¤å’Œå¤±è´¥å¤„ç†ã€‚ä¸‹é¢æ˜¯åŸºäº Go è¯­è¨€çš„è®¾è®¡å®ç°ï¼š</p><h3 id="æ ¸å¿ƒæ•°æ®ç»“æ„">æ ¸å¿ƒæ•°æ®ç»“æ„</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Message è¡¨ç¤ºæœåŠ¡å™¨æ¨é€çš„æ¶ˆæ¯</span></span><br><span class="line"><span class="keyword">type</span> Message <span class="keyword">struct</span> &#123;</span><br><span class="line">    MsgID        <span class="type">string</span>      <span class="string">`json:&quot;msg_id&quot;`</span>        <span class="comment">// å”¯ä¸€æ¶ˆæ¯æ ‡è¯†</span></span><br><span class="line">    MsgType      <span class="type">string</span>      <span class="string">`json:&quot;msg_type&quot;`</span>      <span class="comment">// æ¶ˆæ¯ç±»å‹</span></span><br><span class="line">    Timestamp    <span class="type">int64</span>       <span class="string">`json:&quot;timestamp&quot;`</span>     <span class="comment">// å‘é€æ—¶é—´æˆ³</span></span><br><span class="line">    Priority     <span class="type">int</span>         <span class="string">`json:&quot;priority&quot;`</span>      <span class="comment">// ä¼˜å…ˆçº§ï¼š1-é«˜ï¼Œ2-ä¸­ï¼Œ3-ä½</span></span><br><span class="line">    Payload      <span class="keyword">interface</span>&#123;&#125; <span class="string">`json:&quot;payload&quot;`</span>       <span class="comment">// æ¶ˆæ¯å†…å®¹</span></span><br><span class="line">    RequiresAck  <span class="type">bool</span>        <span class="string">`json:&quot;requires_ack&quot;`</span>  <span class="comment">// æ˜¯å¦éœ€è¦ç¡®è®¤</span></span><br><span class="line">    Expiration   <span class="type">int64</span>       <span class="string">`json:&quot;expiration&quot;`</span>    <span class="comment">// è¿‡æœŸæ—¶é—´æˆ³</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AckMessage è¡¨ç¤ºå®¢æˆ·ç«¯çš„ç¡®è®¤æ¶ˆæ¯</span></span><br><span class="line"><span class="keyword">type</span> AckMessage <span class="keyword">struct</span> &#123;</span><br><span class="line">    AckID            <span class="type">string</span>  <span class="string">`json:&quot;ack_id&quot;`</span>           <span class="comment">// å¯¹åº”åŸæ¶ˆæ¯ID</span></span><br><span class="line">    Status           <span class="type">string</span>  <span class="string">`json:&quot;status&quot;`</span>           <span class="comment">// çŠ¶æ€ï¼šsuccess/failed/partial</span></span><br><span class="line">    ClientTimestamp  <span class="type">int64</span>   <span class="string">`json:&quot;client_timestamp&quot;`</span> <span class="comment">// å®¢æˆ·ç«¯å¤„ç†æ—¶é—´</span></span><br><span class="line">    ErrorCode        <span class="type">int</span>     <span class="string">`json:&quot;error_code&quot;`</span>       <span class="comment">// é”™è¯¯ç </span></span><br><span class="line">    ErrorMessage     <span class="type">string</span>  <span class="string">`json:&quot;error_message&quot;`</span>    <span class="comment">// é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BatchAckMessage è¡¨ç¤ºæ‰¹é‡ç¡®è®¤æ¶ˆæ¯</span></span><br><span class="line"><span class="keyword">type</span> BatchAckMessage <span class="keyword">struct</span> &#123;</span><br><span class="line">    BatchAck        <span class="type">bool</span>     <span class="string">`json:&quot;batch_ack&quot;`</span>       <span class="comment">// æ‰¹é‡ç¡®è®¤æ ‡å¿—</span></span><br><span class="line">    AckIDs          []<span class="type">string</span> <span class="string">`json:&quot;ack_ids&quot;`</span>         <span class="comment">// æ¶ˆæ¯IDåˆ—è¡¨</span></span><br><span class="line">    Status          <span class="type">string</span>   <span class="string">`json:&quot;status&quot;`</span>          <span class="comment">// çŠ¶æ€</span></span><br><span class="line">    ClientTimestamp <span class="type">int64</span>    <span class="string">`json:&quot;client_timestamp&quot;`</span><span class="comment">// ç¡®è®¤æ—¶é—´</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PendingMessageInfo è¡¨ç¤ºç­‰å¾…ç¡®è®¤çš„æ¶ˆæ¯ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">type</span> PendingMessageInfo <span class="keyword">struct</span> &#123;</span><br><span class="line">    ClientID    <span class="type">string</span>      <span class="comment">// å®¢æˆ·ç«¯ID</span></span><br><span class="line">    Message     *Message    <span class="comment">// åŸå§‹æ¶ˆæ¯</span></span><br><span class="line">    SentTime    <span class="type">int64</span>       <span class="comment">// å‘é€æ—¶é—´</span></span><br><span class="line">    RetryCount  <span class="type">int</span>         <span class="comment">// é‡è¯•æ¬¡æ•°</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æœåŠ¡å™¨ç«¯-Push-ç®¡ç†å™¨å®ç°">æœåŠ¡å™¨ç«¯ Push ç®¡ç†å™¨å®ç°</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PushManager è´Ÿè´£ç®¡ç†æ¨é€æ¶ˆæ¯å’Œç¡®è®¤</span></span><br><span class="line"><span class="keyword">type</span> PushManager <span class="keyword">struct</span> &#123;</span><br><span class="line">    pendingMessages    <span class="keyword">map</span>[<span class="type">string</span>]*PendingMessageInfo  <span class="comment">// ç­‰å¾…ç¡®è®¤çš„æ¶ˆæ¯</span></span><br><span class="line">    clientMessageCount <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span>                  <span class="comment">// æ¯ä¸ªå®¢æˆ·ç«¯çš„æ¶ˆæ¯æ•°é‡</span></span><br><span class="line">    ackTimeout         <span class="type">int64</span>                           <span class="comment">// ç¡®è®¤è¶…æ—¶æ—¶é—´(ç§’)</span></span><br><span class="line">    maxRetries         <span class="type">int</span>                             <span class="comment">// æœ€å¤§é‡è¯•æ¬¡æ•°</span></span><br><span class="line">    maxPendingPerClient <span class="type">int</span>                            <span class="comment">// æ¯å®¢æˆ·ç«¯æœ€å¤§æ¶ˆæ¯æ•°</span></span><br><span class="line">    maxMessageAge      <span class="type">int64</span>                           <span class="comment">// æ¶ˆæ¯æœ€å¤§ç”Ÿå­˜æ—¶é—´(ç§’)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†…å­˜ç›‘æ§ç›¸å…³</span></span><br><span class="line">    memoryThresholdMB  <span class="type">int64</span>                           <span class="comment">// å†…å­˜é˜ˆå€¼(MB)</span></span><br><span class="line">    criticalThresholdMB <span class="type">int64</span>                          <span class="comment">// å±é™©å†…å­˜é˜ˆå€¼(MB)</span></span><br><span class="line"></span><br><span class="line">    mutex              sync.RWMutex                    <span class="comment">// ä¿æŠ¤å¹¶å‘è®¿é—®</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç½‘ç»œæ¥å£ï¼ˆä¾èµ–å¤–éƒ¨å®ç°ï¼‰</span></span><br><span class="line">    networkLayer       NetworkInterface</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewPushManager åˆ›å»ºä¸€ä¸ªæ–°çš„æ¨é€ç®¡ç†å™¨</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewPushManager</span><span class="params">(networkLayer NetworkInterface)</span></span> *PushManager &#123;</span><br><span class="line">    pm := &amp;PushManager&#123;</span><br><span class="line">        pendingMessages:     <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]*PendingMessageInfo),</span><br><span class="line">        clientMessageCount:  <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span>),</span><br><span class="line">        ackTimeout:          <span class="number">10</span>,</span><br><span class="line">        maxRetries:          <span class="number">3</span>,</span><br><span class="line">        maxPendingPerClient: <span class="number">1000</span>,</span><br><span class="line">        maxMessageAge:       <span class="number">300</span>,</span><br><span class="line">        memoryThresholdMB:   <span class="number">1000</span>,  <span class="comment">// 1GB</span></span><br><span class="line">        criticalThresholdMB: <span class="number">1500</span>,  <span class="comment">// 1.5GB</span></span><br><span class="line">        networkLayer:        networkLayer,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯åŠ¨åå°ä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">go</span> pm.checkTimeoutsLoop()</span><br><span class="line">    <span class="keyword">go</span> pm.cleanupLoop()</span><br><span class="line">    <span class="keyword">go</span> pm.memoryMonitorLoop()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pm</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PushMessage å‘å®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pm *PushManager)</span></span> PushMessage(clientID <span class="type">string</span>, message *Message) <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœä¸éœ€è¦ç¡®è®¤ï¼Œç›´æ¥å‘é€</span></span><br><span class="line">    <span class="keyword">if</span> !message.RequiresAck &#123;</span><br><span class="line">        <span class="keyword">return</span> pm.networkLayer.SendToClient(clientID, message)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pm.mutex.Lock()</span><br><span class="line">    <span class="keyword">defer</span> pm.mutex.Unlock()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ£€æŸ¥å®¢æˆ·ç«¯æ¶ˆæ¯æ•°æ˜¯å¦è¶…é™</span></span><br><span class="line">    <span class="keyword">if</span> pm.clientMessageCount[clientID] &gt;= pm.maxPendingPerClient &#123;</span><br><span class="line">        pm.handleQueueOverflow(clientID, message)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å­˜å‚¨å¾…ç¡®è®¤æ¶ˆæ¯</span></span><br><span class="line">    pm.pendingMessages[message.MsgID] = &amp;PendingMessageInfo&#123;</span><br><span class="line">        ClientID:    clientID,</span><br><span class="line">        Message:     message,</span><br><span class="line">        SentTime:    time.Now().Unix(),</span><br><span class="line">        RetryCount:  <span class="number">0</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ›´æ–°å®¢æˆ·ç«¯æ¶ˆæ¯è®¡æ•°</span></span><br><span class="line">    pm.clientMessageCount[clientID]++</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘é€æ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">return</span> pm.networkLayer.SendToClient(clientID, message)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ProcessAck å¤„ç†å®¢æˆ·ç«¯çš„ç¡®è®¤æ¶ˆæ¯</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pm *PushManager)</span></span> ProcessAck(clientID <span class="type">string</span>, ack *AckMessage) <span class="type">bool</span> &#123;</span><br><span class="line">    pm.mutex.Lock()</span><br><span class="line">    <span class="keyword">defer</span> pm.mutex.Unlock()</span><br><span class="line"></span><br><span class="line">    info, exists := pm.pendingMessages[ack.AckID]</span><br><span class="line">    <span class="keyword">if</span> !exists || info.ClientID != clientID &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¡®è®¤æˆåŠŸï¼Œåˆ é™¤æ¶ˆæ¯</span></span><br><span class="line">    <span class="built_in">delete</span>(pm.pendingMessages, ack.AckID)</span><br><span class="line">    pm.clientMessageCount[clientID]--</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœå®¢æˆ·ç«¯æ²¡æœ‰å¾…ç¡®è®¤æ¶ˆæ¯äº†ï¼Œæ¸…ç†è®¡æ•°å™¨</span></span><br><span class="line">    <span class="keyword">if</span> pm.clientMessageCount[clientID] &lt;= <span class="number">0</span> &#123;</span><br><span class="line">        <span class="built_in">delete</span>(pm.clientMessageCount, clientID)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ProcessBatchAck å¤„ç†æ‰¹é‡ç¡®è®¤</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pm *PushManager)</span></span> ProcessBatchAck(clientID <span class="type">string</span>, batchAck *BatchAckMessage) <span class="type">int</span> &#123;</span><br><span class="line">    pm.mutex.Lock()</span><br><span class="line">    <span class="keyword">defer</span> pm.mutex.Unlock()</span><br><span class="line"></span><br><span class="line">    confirmedCount := <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, ackID := <span class="keyword">range</span> batchAck.AckIDs &#123;</span><br><span class="line">        info, exists := pm.pendingMessages[ackID]</span><br><span class="line">        <span class="keyword">if</span> exists &amp;&amp; info.ClientID == clientID &#123;</span><br><span class="line">            <span class="built_in">delete</span>(pm.pendingMessages, ackID)</span><br><span class="line">            pm.clientMessageCount[clientID]--</span><br><span class="line">            confirmedCount++</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœå®¢æˆ·ç«¯æ²¡æœ‰å¾…ç¡®è®¤æ¶ˆæ¯äº†ï¼Œæ¸…ç†è®¡æ•°å™¨</span></span><br><span class="line">    <span class="keyword">if</span> pm.clientMessageCount[clientID] &lt;= <span class="number">0</span> &#123;</span><br><span class="line">        <span class="built_in">delete</span>(pm.clientMessageCount, clientID)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> confirmedCount</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åå°ä»»åŠ¡ï¼šè¶…æ—¶æ£€æŸ¥ä¸é‡è¯•</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pm *PushManager)</span></span> checkTimeoutsLoop() &#123;</span><br><span class="line">    ticker := time.NewTicker(<span class="number">5</span> * time.Second)</span><br><span class="line">    <span class="keyword">defer</span> ticker.Stop()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">range</span> ticker.C &#123;</span><br><span class="line">        pm.checkTimeouts()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¶…æ—¶æ£€æŸ¥ä¸é‡è¯•</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pm *PushManager)</span></span> checkTimeouts() &#123;</span><br><span class="line">    pm.mutex.Lock()</span><br><span class="line">    <span class="keyword">defer</span> pm.mutex.Unlock()</span><br><span class="line"></span><br><span class="line">    now := time.Now().Unix()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> msgID, info := <span class="keyword">range</span> pm.pendingMessages &#123;</span><br><span class="line">        <span class="comment">// æ£€æŸ¥æ˜¯å¦è¶…æ—¶</span></span><br><span class="line">        <span class="keyword">if</span> now - info.SentTime &gt; pm.ackTimeout &#123;</span><br><span class="line">            <span class="keyword">if</span> info.RetryCount &lt; pm.maxRetries &#123;</span><br><span class="line">                <span class="comment">// å¢åŠ é‡è¯•æ¬¡æ•°</span></span><br><span class="line">                info.RetryCount++</span><br><span class="line">                info.SentTime = now</span><br><span class="line"></span><br><span class="line">                <span class="comment">// é‡æ–°å‘é€</span></span><br><span class="line">                pm.networkLayer.SendToClient(info.ClientID, info.Message)</span><br><span class="line">                log.Printf(<span class="string">&quot;Retrying message %s to client %s, attempt %d&quot;</span>,</span><br><span class="line">                          msgID, info.ClientID, info.RetryCount)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// è¶…å‡ºæœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ”¾å¼ƒå¹¶è®°å½•</span></span><br><span class="line">                log.Printf(<span class="string">&quot;Message %s to client %s failed after %d attempts&quot;</span>,</span><br><span class="line">                          msgID, info.ClientID, pm.maxRetries)</span><br><span class="line"></span><br><span class="line">                <span class="built_in">delete</span>(pm.pendingMessages, msgID)</span><br><span class="line">                pm.clientMessageCount[info.ClientID]--</span><br><span class="line"></span><br><span class="line">                <span class="comment">// é€šçŸ¥ä¸šåŠ¡å±‚å¤„ç†å¤±è´¥</span></span><br><span class="line">                <span class="keyword">go</span> pm.notifyMessageFailed(info.ClientID, info.Message)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è§£å†³å†…å­˜æš´æ¶¨é—®é¢˜">è§£å†³å†…å­˜æš´æ¶¨é—®é¢˜</h2><p>åœ¨å¤§å‹æ¸¸æˆä¸­ï¼ŒæœåŠ¡å™¨å¯èƒ½åŒæ—¶ç»´æŠ¤æ•°åä¸‡ç”šè‡³ä¸Šç™¾ä¸‡ä¸ªè¿æ¥ï¼Œå¦‚æœæ¯ä¸ªè¿æ¥éƒ½æœ‰æ•°ç™¾æ¡å¾…ç¡®è®¤æ¶ˆæ¯ï¼ŒæœåŠ¡å™¨å†…å­˜å¾ˆå¿«å°±ä¼šçˆ†æ»¡ã€‚ä»¥ä¸‹æ˜¯æˆ‘åœ¨å®è·µä¸­æ€»ç»“çš„å‡ ç§é«˜æ•ˆå†…å­˜ç®¡ç†ç­–ç•¥ï¼š</p><h3 id="1-å‘¨æœŸæ€§è¿‡æœŸæ¶ˆæ¯æ¸…ç†">1. å‘¨æœŸæ€§è¿‡æœŸæ¶ˆæ¯æ¸…ç†</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¸…ç†è¿‡æœŸæ¶ˆæ¯çš„åå°å¾ªç¯</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pm *PushManager)</span></span> cleanupLoop() &#123;</span><br><span class="line">    ticker := time.NewTicker(<span class="number">1</span> * time.Minute)</span><br><span class="line">    <span class="keyword">defer</span> ticker.Stop()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">range</span> ticker.C &#123;</span><br><span class="line">        pm.cleanExpiredMessages()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¸…ç†è¿‡æœŸæ¶ˆæ¯</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pm *PushManager)</span></span> cleanExpiredMessages() &#123;</span><br><span class="line">    pm.mutex.Lock()</span><br><span class="line">    <span class="keyword">defer</span> pm.mutex.Unlock()</span><br><span class="line"></span><br><span class="line">    now := time.Now().Unix()</span><br><span class="line">    expiredCount := <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> msgID, info := <span class="keyword">range</span> pm.pendingMessages &#123;</span><br><span class="line">        <span class="comment">// æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦è¿‡æœŸ</span></span><br><span class="line">        <span class="keyword">if</span> now - info.SentTime &gt; pm.maxMessageAge &#123;</span><br><span class="line">            <span class="built_in">delete</span>(pm.pendingMessages, msgID)</span><br><span class="line">            pm.clientMessageCount[info.ClientID]--</span><br><span class="line">            expiredCount++</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è®°å½•æ—¥å¿—</span></span><br><span class="line">            log.Printf(<span class="string">&quot;Cleaned expired message %s to client %s (age: %d seconds)&quot;</span>,</span><br><span class="line">                      msgID, info.ClientID, now - info.SentTime)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> expiredCount &gt; <span class="number">0</span> &#123;</span><br><span class="line">        log.Printf(<span class="string">&quot;Cleanup: Removed %d expired messages&quot;</span>, expiredCount)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-æ¶ˆæ¯å‹ç¼©ä¸åˆå¹¶">2. æ¶ˆæ¯å‹ç¼©ä¸åˆå¹¶</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CompressMessage å‹ç¼©æ¶ˆæ¯ä»¥å‡å°‘å†…å­˜å ç”¨</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CompressMessage</span><span class="params">(message *Message)</span></span> []<span class="type">byte</span> &#123;</span><br><span class="line">    <span class="comment">// å°†æ¶ˆæ¯è½¬ä¸ºJSON</span></span><br><span class="line">    jsonData, err := json.Marshal(message)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Printf(<span class="string">&quot;Error marshaling message: %v&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨gzipå‹ç¼©</span></span><br><span class="line">    <span class="keyword">var</span> buf bytes.Buffer</span><br><span class="line">    writer := gzip.NewWriter(&amp;buf)</span><br><span class="line"></span><br><span class="line">    _, err = writer.Write(jsonData)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Printf(<span class="string">&quot;Error compressing message: %v&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err := writer.Close(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Printf(<span class="string">&quot;Error closing gzip writer: %v&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> buf.Bytes()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DecompressMessage è§£å‹ç¼©æ¶ˆæ¯</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DecompressMessage</span><span class="params">(compressed []<span class="type">byte</span>)</span></span> (*Message, <span class="type">error</span>) &#123;</span><br><span class="line">    reader, err := gzip.NewReader(bytes.NewReader(compressed))</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;create gzip reader: %w&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> reader.Close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> buf bytes.Buffer</span><br><span class="line">    <span class="keyword">if</span> _, err := io.Copy(&amp;buf, reader); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;decompress data: %w&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> message Message</span><br><span class="line">    <span class="keyword">if</span> err := json.Unmarshal(buf.Bytes(), &amp;message); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;unmarshal json: %w&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &amp;message, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-åˆ†çº§å­˜å‚¨ç­–ç•¥">3. åˆ†çº§å­˜å‚¨ç­–ç•¥</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PushManager å¢åŠ åˆ†çº§å­˜å‚¨åŠŸèƒ½</span></span><br><span class="line"><span class="keyword">type</span> PushManager <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// ... ä¹‹å‰çš„å­—æ®µ ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†…å­˜ä¸­å­˜å‚¨é«˜ä¼˜å…ˆçº§æ¶ˆæ¯</span></span><br><span class="line">    memoryPending     <span class="keyword">map</span>[<span class="type">string</span>]*PendingMessageInfo</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Rediså®¢æˆ·ç«¯ï¼Œç”¨äºå­˜å‚¨ä½ä¼˜å…ˆçº§æ¶ˆæ¯</span></span><br><span class="line">    redisClient      *redis.Client</span><br><span class="line">    redisKeyPrefix   <span class="type">string</span></span><br><span class="line">    redisExpiry      time.Duration</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PushMessage åˆ†çº§å­˜å‚¨ç‰ˆæœ¬</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pm *PushManager)</span></span> PushMessage(clientID <span class="type">string</span>, message *Message) <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœä¸éœ€è¦ç¡®è®¤ï¼Œç›´æ¥å‘é€</span></span><br><span class="line">    <span class="keyword">if</span> !message.RequiresAck &#123;</span><br><span class="line">        <span class="keyword">return</span> pm.networkLayer.SendToClient(clientID, message)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pm.mutex.Lock()</span><br><span class="line">    <span class="keyword">defer</span> pm.mutex.Unlock()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ£€æŸ¥å®¢æˆ·ç«¯æ¶ˆæ¯æ•°é‡é™åˆ¶</span></span><br><span class="line">    <span class="keyword">if</span> pm.clientMessageCount[clientID] &gt;= pm.maxPendingPerClient &#123;</span><br><span class="line">        pm.handleQueueOverflow(clientID, message)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pm.clientMessageCount[clientID]++</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®ä¼˜å…ˆçº§é€‰æ‹©å­˜å‚¨ä½ç½®</span></span><br><span class="line">    <span class="keyword">if</span> message.Priority &lt;= <span class="number">2</span> &#123; <span class="comment">// é«˜ä¼˜å…ˆçº§å’Œä¸­ä¼˜å…ˆçº§</span></span><br><span class="line">        <span class="comment">// å­˜å…¥å†…å­˜</span></span><br><span class="line">        pm.memoryPending[message.MsgID] = &amp;PendingMessageInfo&#123;</span><br><span class="line">            ClientID:    clientID,</span><br><span class="line">            Message:     message,</span><br><span class="line">            SentTime:    time.Now().Unix(),</span><br><span class="line">            RetryCount:  <span class="number">0</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// ä½ä¼˜å…ˆçº§</span></span><br><span class="line">        <span class="comment">// å­˜å…¥Redis</span></span><br><span class="line">        messageInfo := &amp;PendingMessageInfo&#123;</span><br><span class="line">            ClientID:    clientID,</span><br><span class="line">            Message:     message,</span><br><span class="line">            SentTime:    time.Now().Unix(),</span><br><span class="line">            RetryCount:  <span class="number">0</span>,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        jsonData, err := json.Marshal(messageInfo)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            log.Printf(<span class="string">&quot;Error marshaling message: %v&quot;</span>, err)</span><br><span class="line">            pm.clientMessageCount[clientID]--</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        redisKey := pm.redisKeyPrefix + message.MsgID</span><br><span class="line">        err = pm.redisClient.Set(context.Background(), redisKey, jsonData, pm.redisExpiry).Err()</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            log.Printf(<span class="string">&quot;Error storing message in Redis: %v&quot;</span>, err)</span><br><span class="line">            pm.clientMessageCount[clientID]--</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘é€æ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">return</span> pm.networkLayer.SendToClient(clientID, message)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ProcessAck åˆ†çº§å­˜å‚¨ç‰ˆæœ¬</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pm *PushManager)</span></span> ProcessAck(clientID <span class="type">string</span>, ack *AckMessage) <span class="type">bool</span> &#123;</span><br><span class="line">    pm.mutex.Lock()</span><br><span class="line">    <span class="keyword">defer</span> pm.mutex.Unlock()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…ˆæ£€æŸ¥å†…å­˜ä¸­çš„æ¶ˆæ¯</span></span><br><span class="line">    info, existsInMemory := pm.memoryPending[ack.AckID]</span><br><span class="line">    <span class="keyword">if</span> existsInMemory &amp;&amp; info.ClientID == clientID &#123;</span><br><span class="line">        <span class="built_in">delete</span>(pm.memoryPending, ack.AckID)</span><br><span class="line">        pm.clientMessageCount[clientID]--</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> pm.clientMessageCount[clientID] &lt;= <span class="number">0</span> &#123;</span><br><span class="line">            <span class="built_in">delete</span>(pm.clientMessageCount, clientID)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†æ£€æŸ¥Redisä¸­çš„æ¶ˆæ¯</span></span><br><span class="line">    redisKey := pm.redisKeyPrefix + ack.AckID</span><br><span class="line">    exists, err := pm.redisClient.Exists(context.Background(), redisKey).Result()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Printf(<span class="string">&quot;Error checking message in Redis: %v&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> exists == <span class="number">1</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–æ¶ˆæ¯ä»¥éªŒè¯å®¢æˆ·ç«¯ID</span></span><br><span class="line">        jsonData, err := pm.redisClient.Get(context.Background(), redisKey).Bytes()</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            log.Printf(<span class="string">&quot;Error getting message from Redis: %v&quot;</span>, err)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> messageInfo PendingMessageInfo</span><br><span class="line">        <span class="keyword">if</span> err := json.Unmarshal(jsonData, &amp;messageInfo); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            log.Printf(<span class="string">&quot;Error unmarshaling message from Redis: %v&quot;</span>, err)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> messageInfo.ClientID == clientID &#123;</span><br><span class="line">            <span class="comment">// ä»Redisåˆ é™¤å¹¶æ›´æ–°è®¡æ•°</span></span><br><span class="line">            pm.redisClient.Del(context.Background(), redisKey)</span><br><span class="line">            pm.clientMessageCount[clientID]--</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> pm.clientMessageCount[clientID] &lt;= <span class="number">0</span> &#123;</span><br><span class="line">                <span class="built_in">delete</span>(pm.clientMessageCount, clientID)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-å†…å­˜è‡ªé€‚åº”è°ƒæ•´">4. å†…å­˜è‡ªé€‚åº”è°ƒæ•´</h3><p>å†…å­˜è‡ªé€‚åº”è°ƒæ•´æ˜¯æˆ‘åœ¨å®é™…é¡¹ç›®ä¸­è§£å†³çªå‘æµé‡é—®é¢˜çš„å…³é”®ç­–ç•¥ã€‚å®ƒèƒ½å¤Ÿæ ¹æ®å½“å‰ç³»ç»Ÿè´Ÿè½½åŠ¨æ€è°ƒæ•´æ¶ˆæ¯å¤„ç†å‚æ•°ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å†…å­˜ç›‘æ§å¾ªç¯</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pm *PushManager)</span></span> memoryMonitorLoop() &#123;</span><br><span class="line">    ticker := time.NewTicker(<span class="number">10</span> * time.Second)</span><br><span class="line">    <span class="keyword">defer</span> ticker.Stop()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">range</span> ticker.C &#123;</span><br><span class="line">        memoryMB := pm.getMemoryUsageMB()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> memoryMB &gt; pm.criticalThresholdMB &#123;</span><br><span class="line">            <span class="comment">// ç´§æ€¥æƒ…å†µï¼Œè¿›è¡Œåº”æ€¥æ¸…ç†</span></span><br><span class="line">            pm.emergencyCleanup(memoryMB)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> memoryMB &gt; pm.memoryThresholdMB &#123;</span><br><span class="line">            <span class="comment">// è¶…è¿‡è­¦æˆ’çº¿ï¼Œè°ƒæ•´å‚æ•°</span></span><br><span class="line">            pm.adjustParameters(memoryMB)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–å½“å‰è¿›ç¨‹å†…å­˜ä½¿ç”¨é‡ï¼ˆMBï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pm *PushManager)</span></span> getMemoryUsageMB() <span class="type">int64</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> memStats runtime.MemStats</span><br><span class="line">    runtime.ReadMemStats(&amp;memStats)</span><br><span class="line">    <span class="keyword">return</span> <span class="type">int64</span>(memStats.Alloc / <span class="number">1024</span> / <span class="number">1024</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®å†…å­˜ä½¿ç”¨æƒ…å†µè°ƒæ•´å‚æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pm *PushManager)</span></span> adjustParameters(currentMemoryMB <span class="type">int64</span>) &#123;</span><br><span class="line">    pm.mutex.Lock()</span><br><span class="line">    <span class="keyword">defer</span> pm.mutex.Unlock()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¡ç®—å†…å­˜è¶…å‡ºæ¯”ä¾‹</span></span><br><span class="line">    excessRatio := <span class="type">float64</span>(currentMemoryMB - pm.memoryThresholdMB) / <span class="type">float64</span>(pm.memoryThresholdMB)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒæ•´æ¯å®¢æˆ·ç«¯æœ€å¤§æ¶ˆæ¯æ•°</span></span><br><span class="line">    newMaxPerClient := <span class="type">int</span>(<span class="type">float64</span>(pm.maxPendingPerClient) * (<span class="number">1</span> - excessRatio*<span class="number">0.5</span>))</span><br><span class="line">    <span class="keyword">if</span> newMaxPerClient &lt; <span class="number">100</span> &#123;</span><br><span class="line">        newMaxPerClient = <span class="number">100</span> <span class="comment">// ç¡®ä¿è‡³å°‘ä¿ç•™100æ¡</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒæ•´æ¶ˆæ¯æœ€å¤§ç”Ÿå­˜æ—¶é—´</span></span><br><span class="line">    newMaxAge := <span class="type">int64</span>(<span class="type">float64</span>(pm.maxMessageAge) * (<span class="number">1</span> - excessRatio*<span class="number">0.5</span>))</span><br><span class="line">    <span class="keyword">if</span> newMaxAge &lt; <span class="number">60</span> &#123;</span><br><span class="line">        newMaxAge = <span class="number">60</span> <span class="comment">// è‡³å°‘60ç§’</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ›´æ–°å‚æ•°</span></span><br><span class="line">    pm.maxPendingPerClient = newMaxPerClient</span><br><span class="line">    pm.maxMessageAge = newMaxAge</span><br><span class="line"></span><br><span class="line">    log.Printf(<span class="string">&quot;Memory usage: %d MB, adjusted parameters: maxPending=%d, maxAge=%ds&quot;</span>,</span><br><span class="line">               currentMemoryMB, pm.maxPendingPerClient, pm.maxMessageAge)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰§è¡Œä¸€æ¬¡æ¸…ç†</span></span><br><span class="line">    pm.cleanExpiredMessages()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç´§æ€¥æ¸…ç†</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pm *PushManager)</span></span> emergencyCleanup(currentMemoryMB <span class="type">int64</span>) &#123;</span><br><span class="line">    pm.mutex.Lock()</span><br><span class="line">    <span class="keyword">defer</span> pm.mutex.Unlock()</span><br><span class="line"></span><br><span class="line">    log.Printf(<span class="string">&quot;CRITICAL: Memory usage at %d MB, performing emergency cleanup&quot;</span>, currentMemoryMB)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤§å¹…é™ä½å‚æ•°</span></span><br><span class="line">    pm.maxPendingPerClient = <span class="number">100</span></span><br><span class="line">    pm.maxMessageAge = <span class="number">60</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…ç†ä½ä¼˜å…ˆçº§æ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">for</span> msgID, info := <span class="keyword">range</span> pm.memoryPending &#123;</span><br><span class="line">        <span class="keyword">if</span> info.Message.Priority &gt; <span class="number">1</span> &#123; <span class="comment">// åªä¿ç•™æœ€é«˜ä¼˜å…ˆçº§</span></span><br><span class="line">            <span class="built_in">delete</span>(pm.memoryPending, msgID)</span><br><span class="line">            pm.clientMessageCount[info.ClientID]--</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log.Printf(<span class="string">&quot;Emergency cleanup completed&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-é˜Ÿåˆ—æº¢å‡ºå¤„ç†ç­–ç•¥">5. é˜Ÿåˆ—æº¢å‡ºå¤„ç†ç­–ç•¥</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¤„ç†é˜Ÿåˆ—æº¢å‡º</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pm *PushManager)</span></span> handleQueueOverflow(clientID <span class="type">string</span>, newMessage *Message) &#123;</span><br><span class="line">    log.Printf(<span class="string">&quot;Queue overflow for client %s&quot;</span>, clientID)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­–ç•¥1: æ ¹æ®æ¶ˆæ¯ä¼˜å…ˆçº§å†³å®šæ˜¯å¦æ›¿æ¢ç°æœ‰æ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">if</span> newMessage.Priority == <span class="number">1</span> &#123; <span class="comment">// é«˜ä¼˜å…ˆçº§æ¶ˆæ¯</span></span><br><span class="line">        <span class="comment">// æŸ¥æ‰¾å¹¶æ›¿æ¢è¯¥å®¢æˆ·ç«¯çš„ä¸€æ¡ä½ä¼˜å…ˆçº§æ¶ˆæ¯</span></span><br><span class="line">        <span class="keyword">for</span> msgID, info := <span class="keyword">range</span> pm.memoryPending &#123;</span><br><span class="line">            <span class="keyword">if</span> info.ClientID == clientID &amp;&amp; info.Message.Priority &gt; <span class="number">1</span> &#123;</span><br><span class="line">                <span class="comment">// è®°å½•</span></span><br><span class="line">                log.Printf(<span class="string">&quot;Replacing low priority message %s with high priority message&quot;</span>, msgID)</span><br><span class="line"></span><br><span class="line">                <span class="comment">// åˆ é™¤æ—§æ¶ˆæ¯</span></span><br><span class="line">                <span class="built_in">delete</span>(pm.memoryPending, msgID)</span><br><span class="line"></span><br><span class="line">                <span class="comment">// æ·»åŠ æ–°æ¶ˆæ¯</span></span><br><span class="line">                pm.memoryPending[newMessage.MsgID] = &amp;PendingMessageInfo&#123;</span><br><span class="line">                    ClientID:    clientID,</span><br><span class="line">                    Message:     newMessage,</span><br><span class="line">                    SentTime:    time.Now().Unix(),</span><br><span class="line">                    RetryCount:  <span class="number">0</span>,</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// å‘é€æ–°æ¶ˆæ¯</span></span><br><span class="line">                pm.networkLayer.SendToClient(clientID, newMessage)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­–ç•¥2: ä¸¢å¼ƒæ—§æ¶ˆæ¯ä»¥è…¾å‡ºç©ºé—´</span></span><br><span class="line">    <span class="comment">// æŸ¥æ‰¾è¯¥å®¢æˆ·ç«¯æœ€æ—§çš„æ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">var</span> oldestMsgID <span class="type">string</span></span><br><span class="line">    <span class="keyword">var</span> oldestTime <span class="type">int64</span> = math.MaxInt64</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> msgID, info := <span class="keyword">range</span> pm.memoryPending &#123;</span><br><span class="line">        <span class="keyword">if</span> info.ClientID == clientID &amp;&amp; info.SentTime &lt; oldestTime &#123;</span><br><span class="line">            oldestMsgID = msgID</span><br><span class="line">            oldestTime = info.SentTime</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> oldestMsgID != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        log.Printf(<span class="string">&quot;Dropping oldest message %s for client %s&quot;</span>, oldestMsgID, clientID)</span><br><span class="line">        <span class="built_in">delete</span>(pm.memoryPending, oldestMsgID)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ·»åŠ æ–°æ¶ˆæ¯</span></span><br><span class="line">        pm.memoryPending[newMessage.MsgID] = &amp;PendingMessageInfo&#123;</span><br><span class="line">            ClientID:    clientID,</span><br><span class="line">            Message:     newMessage,</span><br><span class="line">            SentTime:    time.Now().Unix(),</span><br><span class="line">            RetryCount:  <span class="number">0</span>,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‘é€æ–°æ¶ˆæ¯</span></span><br><span class="line">        pm.networkLayer.SendToClient(clientID, newMessage)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æç«¯æƒ…å†µï¼Œæ— æ³•æ‰¾åˆ°å¯æ›¿æ¢çš„æ¶ˆæ¯</span></span><br><span class="line">        log.Printf(<span class="string">&quot;Cannot find message to replace for client %s&quot;</span>, clientID)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å®¢æˆ·ç«¯å®ç°">å®¢æˆ·ç«¯å®ç°</h2><p>å®¢æˆ·ç«¯å®ç°åŒæ ·å…³é”®ï¼Œç‰¹åˆ«æ˜¯æ‰¹é‡ç¡®è®¤æœºåˆ¶èƒ½æ˜¾è‘—å‡å°‘ç½‘ç»œæµé‡ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PushReceiver å®¢æˆ·ç«¯æ¨é€æ¥æ”¶å¤„ç†å™¨</span></span><br><span class="line"><span class="keyword">type</span> PushReceiver <span class="keyword">struct</span> &#123;</span><br><span class="line">    connection        Connection          <span class="comment">// ç½‘ç»œè¿æ¥æ¥å£</span></span><br><span class="line">    processedMsgIDs   <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int64</span>    <span class="comment">// å·²å¤„ç†æ¶ˆæ¯IDåŠå¤„ç†æ—¶é—´</span></span><br><span class="line">    pendingAcks       []<span class="type">string</span>            <span class="comment">// å¾…ç¡®è®¤çš„æ¶ˆæ¯ID</span></span><br><span class="line">    ackBatchSize      <span class="type">int</span>                 <span class="comment">// æ‰¹é‡ç¡®è®¤å¤§å°</span></span><br><span class="line">    ackInterval       time.Duration       <span class="comment">// æ‰¹é‡ç¡®è®¤é—´éš”</span></span><br><span class="line">    messageHandlers   <span class="keyword">map</span>[<span class="type">string</span>]MessageHandler <span class="comment">// æ¶ˆæ¯å¤„ç†å‡½æ•°</span></span><br><span class="line"></span><br><span class="line">    mutex             sync.Mutex          <span class="comment">// ä¿æŠ¤å¹¶å‘è®¿é—®</span></span><br><span class="line">    stopChan          <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;       <span class="comment">// åœæ­¢ä¿¡å·</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MessageHandler æ¶ˆæ¯å¤„ç†å‡½æ•°ç±»å‹</span></span><br><span class="line"><span class="keyword">type</span> MessageHandler <span class="function"><span class="keyword">func</span><span class="params">(payload <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">error</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// NewPushReceiver åˆ›å»ºæ¨é€æ¥æ”¶å™¨</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewPushReceiver</span><span class="params">(conn Connection)</span></span> *PushReceiver &#123;</span><br><span class="line">    receiver := &amp;PushReceiver&#123;</span><br><span class="line">        connection:       conn,</span><br><span class="line">        processedMsgIDs:  <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int64</span>),</span><br><span class="line">        pendingAcks:      <span class="built_in">make</span>([]<span class="type">string</span>, <span class="number">0</span>, <span class="number">100</span>),</span><br><span class="line">        ackBatchSize:     <span class="number">50</span>,</span><br><span class="line">        ackInterval:      time.Second,</span><br><span class="line">        messageHandlers:  <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]MessageHandler),</span><br><span class="line">        stopChan:         <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯åŠ¨æ‰¹é‡ç¡®è®¤ä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">go</span> receiver.ackLoop()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯åŠ¨è¿‡æœŸæ¶ˆæ¯IDæ¸…ç†ä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">go</span> receiver.cleanupLoop()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> receiver</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RegisterHandler æ³¨å†Œæ¶ˆæ¯å¤„ç†å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *PushReceiver)</span></span> RegisterHandler(msgType <span class="type">string</span>, handler MessageHandler) &#123;</span><br><span class="line">    r.mutex.Lock()</span><br><span class="line">    <span class="keyword">defer</span> r.mutex.Unlock()</span><br><span class="line"></span><br><span class="line">    r.messageHandlers[msgType] = handler</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HandleMessage å¤„ç†æ”¶åˆ°çš„æ¶ˆæ¯</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *PushReceiver)</span></span> HandleMessage(message *Message) &#123;</span><br><span class="line">    r.mutex.Lock()</span><br><span class="line">    <span class="keyword">defer</span> r.mutex.Unlock()</span><br><span class="line"></span><br><span class="line">    msgID := message.MsgID</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ˜¯å¦å·²å¤„ç†è¿‡è¯¥æ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">if</span> _, exists := r.processedMsgIDs[msgID]; exists &#123;</span><br><span class="line">        <span class="comment">// å·²å¤„ç†è¿‡ï¼Œå†æ¬¡å‘é€ç¡®è®¤</span></span><br><span class="line">        <span class="keyword">if</span> message.RequiresAck &#123;</span><br><span class="line">            r.pendingAcks = <span class="built_in">append</span>(r.pendingAcks, msgID)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¦‚æœç§¯ç´¯çš„ç¡®è®¤æ•°é‡è¶…è¿‡æ‰¹é‡å¤§å°ï¼Œç«‹å³å‘é€</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(r.pendingAcks) &gt;= r.ackBatchSize &#123;</span><br><span class="line">                <span class="keyword">go</span> r.sendBatchAcks()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŸ¥æ‰¾å¤„ç†å‡½æ•°</span></span><br><span class="line">    handler, exists := r.messageHandlers[message.MsgType]</span><br><span class="line">    <span class="keyword">if</span> !exists &#123;</span><br><span class="line">        log.Printf(<span class="string">&quot;No handler for message type: %s&quot;</span>, message.MsgType)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æœªçŸ¥æ¶ˆæ¯ç±»å‹ä¹Ÿéœ€è¦ç¡®è®¤</span></span><br><span class="line">        <span class="keyword">if</span> message.RequiresAck &#123;</span><br><span class="line">            r.sendErrorAck(msgID, <span class="string">&quot;Unknown message type&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤„ç†æ¶ˆæ¯</span></span><br><span class="line">    err := handler(message.Payload)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Printf(<span class="string">&quot;Error processing message %s: %v&quot;</span>, msgID, err)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> message.RequiresAck &#123;</span><br><span class="line">            r.sendErrorAck(msgID, err.Error())</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®°å½•å·²å¤„ç†çš„æ¶ˆæ¯</span></span><br><span class="line">    r.processedMsgIDs[msgID] = time.Now().Unix()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœéœ€è¦ç¡®è®¤ï¼ŒåŠ å…¥å¾…ç¡®è®¤é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">if</span> message.RequiresAck &#123;</span><br><span class="line">        r.pendingAcks = <span class="built_in">append</span>(r.pendingAcks, msgID)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœç§¯ç´¯çš„ç¡®è®¤æ•°é‡è¶…è¿‡æ‰¹é‡å¤§å°ï¼Œç«‹å³å‘é€</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(r.pendingAcks) &gt;= r.ackBatchSize &#123;</span><br><span class="line">            <span class="keyword">go</span> r.sendBatchAcks()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‘é€æ‰¹é‡ç¡®è®¤</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *PushReceiver)</span></span> sendBatchAcks() &#123;</span><br><span class="line">    r.mutex.Lock()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœæ²¡æœ‰å¾…ç¡®è®¤æ¶ˆæ¯ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(r.pendingAcks) == <span class="number">0</span> &#123;</span><br><span class="line">        r.mutex.Unlock()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤åˆ¶å½“å‰çš„å¾…ç¡®è®¤IDåˆ—è¡¨</span></span><br><span class="line">    ackIDs := <span class="built_in">make</span>([]<span class="type">string</span>, <span class="built_in">len</span>(r.pendingAcks))</span><br><span class="line">    <span class="built_in">copy</span>(ackIDs, r.pendingAcks)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…ç©ºå¾…ç¡®è®¤åˆ—è¡¨</span></span><br><span class="line">    r.pendingAcks = r.pendingAcks[:<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    r.mutex.Unlock()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºæ‰¹é‡ç¡®è®¤æ¶ˆæ¯</span></span><br><span class="line">    batchAck := &amp;BatchAckMessage&#123;</span><br><span class="line">        BatchAck:        <span class="literal">true</span>,</span><br><span class="line">        AckIDs:          ackIDs,</span><br><span class="line">        Status:          <span class="string">&quot;success&quot;</span>,</span><br><span class="line">        ClientTimestamp: time.Now().Unix(),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘é€ç¡®è®¤</span></span><br><span class="line">    r.connection.Send(batchAck)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‘é€é”™è¯¯ç¡®è®¤</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *PushReceiver)</span></span> sendErrorAck(msgID <span class="type">string</span>, errorMessage <span class="type">string</span>) &#123;</span><br><span class="line">    ack := &amp;AckMessage&#123;</span><br><span class="line">        AckID:           msgID,</span><br><span class="line">        Status:          <span class="string">&quot;failed&quot;</span>,</span><br><span class="line">        ClientTimestamp: time.Now().Unix(),</span><br><span class="line">        ErrorCode:       <span class="number">1001</span>,</span><br><span class="line">        ErrorMessage:    errorMessage,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r.connection.Send(ack)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰¹é‡ç¡®è®¤å®šæ—¶å™¨</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *PushReceiver)</span></span> ackLoop() &#123;</span><br><span class="line">    ticker := time.NewTicker(r.ackInterval)</span><br><span class="line">    <span class="keyword">defer</span> ticker.Stop()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> &lt;-ticker.C:</span><br><span class="line">            r.sendBatchAcks()</span><br><span class="line">        <span class="keyword">case</span> &lt;-r.stopChan:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¸…ç†è¿‡æœŸçš„å·²å¤„ç†æ¶ˆæ¯ID</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *PushReceiver)</span></span> cleanupLoop() &#123;</span><br><span class="line">    <span class="comment">// æ¯å°æ—¶æ¸…ç†ä¸€æ¬¡</span></span><br><span class="line">    ticker := time.NewTicker(<span class="number">1</span> * time.Hour)</span><br><span class="line">    <span class="keyword">defer</span> ticker.Stop()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> &lt;-ticker.C:</span><br><span class="line">            r.cleanupProcessedIDs()</span><br><span class="line">        <span class="keyword">case</span> &lt;-r.stopChan:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¸…ç†è¿‡æœŸçš„å·²å¤„ç†æ¶ˆæ¯ID</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *PushReceiver)</span></span> cleanupProcessedIDs() &#123;</span><br><span class="line">    r.mutex.Lock()</span><br><span class="line">    <span class="keyword">defer</span> r.mutex.Unlock()</span><br><span class="line"></span><br><span class="line">    now := time.Now().Unix()</span><br><span class="line">    expireTime := <span class="type">int64</span>(<span class="number">86400</span>) <span class="comment">// 24å°æ—¶è¿‡æœŸ</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> msgID, processTime := <span class="keyword">range</span> r.processedMsgIDs &#123;</span><br><span class="line">        <span class="keyword">if</span> now - processTime &gt; expireTime &#123;</span><br><span class="line">            <span class="built_in">delete</span>(r.processedMsgIDs, msgID)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Close å…³é—­æ¨é€æ¥æ”¶å™¨</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *PushReceiver)</span></span> Close() &#123;</span><br><span class="line">    <span class="comment">// å‘é€æ‰€æœ‰å¾…ç¡®è®¤æ¶ˆæ¯</span></span><br><span class="line">    r.sendBatchAcks()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœæ­¢æ‰€æœ‰åå°ä»»åŠ¡</span></span><br><span class="line">    <span class="built_in">close</span>(r.stopChan)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å®æˆ˜ç»éªŒä¸æœ€ä½³å®è·µ">å®æˆ˜ç»éªŒä¸æœ€ä½³å®è·µ</h2><p>åœ¨å¤šä¸ªåƒä¸‡ç”¨æˆ·çº§åˆ«çš„æ¸¸æˆé¡¹ç›®å®è·µä¸­ï¼Œæˆ‘æ€»ç»“äº†ä»¥ä¸‹å‡ ç‚¹ Push-ACK æœºåˆ¶çš„æœ€ä½³å®è·µï¼š</p><h3 id="1-æ¶ˆæ¯åˆ†çº§æ˜¯å…³é”®">1. æ¶ˆæ¯åˆ†çº§æ˜¯å…³é”®</h3><p>ä¸æ˜¯æ‰€æœ‰æ¶ˆæ¯éƒ½éœ€è¦ç›¸åŒçº§åˆ«çš„å¯é æ€§ä¿è¯ã€‚åœ¨ä¸€ä¸ª MMORPG é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å°†æ¶ˆæ¯åˆ†ä¸ºå››çº§ï¼š</p><ul><li><strong>å…³é”®çº§</strong>ï¼šç›´æ¥å½±å“æ¸¸æˆå¹³è¡¡å’Œç»æµçš„æ¶ˆæ¯ï¼Œå¦‚é“å…·è·å–ã€è´§å¸å˜åŒ–</li><li><strong>é‡è¦çº§</strong>ï¼šå½±å“æ¸¸æˆè¿›ç¨‹çš„æ¶ˆæ¯ï¼Œå¦‚ä»»åŠ¡æ›´æ–°ã€æ’è¡Œæ¦œå˜åŠ¨</li><li><strong>æ™®é€šçº§</strong>ï¼šä¸€èˆ¬æ¸¸æˆçŠ¶æ€ä¿¡æ¯ï¼Œå¦‚å…¶ä»–ç©å®¶åŠ¨ä½œã€ç¯å¢ƒå˜åŒ–</li><li><strong>ä½ä¼˜å…ˆçº§</strong>ï¼šå¯ä»¥å®¹å¿ä¸¢å¤±çš„èƒŒæ™¯ä¿¡æ¯ï¼Œå¦‚èŠå¤©ã€å¤©æ°”æ•ˆæœ</li></ul><p>é«˜çº§åˆ«æ¶ˆæ¯ä½¿ç”¨å®Œæ•´çš„ ACK æœºåˆ¶ï¼Œä½çº§åˆ«æ¶ˆæ¯å¯ä»¥ç®€åŒ–ç”šè‡³å–æ¶ˆ ACK éœ€æ±‚ï¼Œè¿™æ ·å¤§å¤§å‡è½»äº†æœåŠ¡å™¨å†…å­˜å‹åŠ›ã€‚</p><h3 id="2-åˆ©ç”¨ç»Ÿè®¡æŒ‡æ ‡è¿›è¡Œè°ƒä¼˜">2. åˆ©ç”¨ç»Ÿè®¡æŒ‡æ ‡è¿›è¡Œè°ƒä¼˜</h3><p>ç›‘æ§ä»¥ä¸‹å…³é”®æŒ‡æ ‡ï¼š</p><ul><li>ACK å“åº”æ—¶é—´åˆ†å¸ƒ</li><li>æ¶ˆæ¯é‡è¯•ç‡</li><li>æ¯å®¢æˆ·ç«¯å¹³å‡å¾…ç¡®è®¤æ¶ˆæ¯æ•°</li><li>å†…å­˜ä½¿ç”¨å¢é•¿æ›²çº¿</li></ul><p>åœ¨ä¸€ä¸ªè¶³çƒç»ç†ç±»æ¸¸æˆä¸­ï¼Œé€šè¿‡è¿™äº›æŒ‡æ ‡æˆ‘ä»¬å‘ç°ï¼Œå°† ACK è¶…æ—¶æ—¶é—´ä» 10 ç§’è°ƒæ•´åˆ° 5 ç§’ï¼Œå¹¶å°†æœ€å¤§é‡è¯•æ¬¡æ•°ä» 3 æ¬¡å¢åŠ åˆ° 5 æ¬¡ï¼Œå¯ä»¥å°†æ¶ˆæ¯æœ€ç»ˆç¡®è®¤ç‡ä» 99.2%æé«˜åˆ° 99.8%ï¼ŒåŒæ—¶å‡å°‘äº† 25%çš„å†…å­˜ä½¿ç”¨ã€‚</p><h3 id="3-é’ˆå¯¹ä¸åŒç½‘ç»œç¯å¢ƒä¼˜åŒ–">3. é’ˆå¯¹ä¸åŒç½‘ç»œç¯å¢ƒä¼˜åŒ–</h3><p>ç§»åŠ¨ç½‘ç»œç¯å¢ƒå·®å¼‚å¾ˆå¤§ï¼Œé’ˆå¯¹ä¸åŒç½‘ç»œæ¡ä»¶åŠ¨æ€è°ƒæ•´ç­–ç•¥ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ ¹æ®ç½‘ç»œæ¡ä»¶è°ƒæ•´å‚æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pm *PushManager)</span></span> adjustForNetworkCondition(clientID <span class="type">string</span>, rtt time.Duration) &#123;</span><br><span class="line">    <span class="comment">// ç½‘ç»œæ¡ä»¶è‰¯å¥½</span></span><br><span class="line">    <span class="keyword">if</span> rtt &lt; <span class="number">100</span>*time.Millisecond &#123;</span><br><span class="line">        pm.clientTimeouts[clientID] = <span class="number">3</span> <span class="comment">// 3ç§’è¶…æ—¶</span></span><br><span class="line">        pm.clientRetries[clientID] = <span class="number">2</span>  <span class="comment">// 2æ¬¡é‡è¯•</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> rtt &lt; <span class="number">300</span>*time.Millisecond &#123;</span><br><span class="line">        pm.clientTimeouts[clientID] = <span class="number">5</span> <span class="comment">// 5ç§’è¶…æ—¶</span></span><br><span class="line">        pm.clientRetries[clientID] = <span class="number">3</span>  <span class="comment">// 3æ¬¡é‡è¯•</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        pm.clientTimeouts[clientID] = <span class="number">10</span> <span class="comment">// 10ç§’è¶…æ—¶</span></span><br><span class="line">        pm.clientRetries[clientID] = <span class="number">5</span>   <span class="comment">// 5æ¬¡é‡è¯•</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-å®šæœŸå‹åŠ›æµ‹è¯•">4. å®šæœŸå‹åŠ›æµ‹è¯•</h3><p>åœ¨ä¸€ä¸ªå¤§å‹å¼€æ”¾ä¸–ç•Œæ¸¸æˆä¸­ï¼Œæˆ‘ä»¬æ¯æœˆè¿›è¡Œä¸€æ¬¡&quot;æ··æ²Œæµ‹è¯•&quot;ï¼Œæ¨¡æ‹Ÿæç«¯æƒ…å†µï¼š</p><ol><li>çªå‘ 50%å®¢æˆ·ç«¯åŒæ—¶æ‰çº¿ç„¶åé‡è¿</li><li>æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿçªç„¶ä» 50ms å¢åŠ åˆ° 500ms</li><li>æ¨¡æ‹Ÿ 10%çš„ç¡®è®¤æ¶ˆæ¯ä¸¢å¤±</li></ol><p>è¿™ç§æµ‹è¯•è®©æˆ‘ä»¬å‘ç°äº†å¾ˆå¤šè¾¹ç¼˜æƒ…å†µï¼Œå¹¶å»ºç«‹äº†æ›´å¥å£®çš„é˜²å¾¡æœºåˆ¶ã€‚</p><h2 id="ç»“è®º">ç»“è®º</h2><p>ä¸€ä¸ªè®¾è®¡è‰¯å¥½çš„ Push-ACK æœºåˆ¶æ˜¯ç°ä»£æ¸¸æˆæœåŠ¡å™¨æ¶æ„çš„æ ¸å¿ƒç»„ä»¶ã€‚å®ƒç¡®ä¿äº†æ¸¸æˆçŠ¶æ€çš„ä¸€è‡´æ€§ï¼Œæå‡äº†ç©å®¶ä½“éªŒï¼ŒåŒæ—¶ä¹Ÿä¸ºè¿è¥å›¢é˜Ÿæä¾›äº†å¯é çš„æ•°æ®åŸºç¡€ã€‚æœ€é‡è¦çš„æ˜¯ï¼Œå®ƒå¿…é¡»æ˜¯é«˜æ€§èƒ½ä¸”èµ„æºå‹å¥½çš„ã€‚</p><p>é€šè¿‡é‡‡ç”¨æœ¬æ–‡ä»‹ç»çš„å¤šçº§å­˜å‚¨ã€è‡ªé€‚åº”å‚æ•°è°ƒæ•´ã€æ¶ˆæ¯ä¼˜å…ˆçº§å’Œè¿‡æœŸç­–ç•¥ç­‰æŠ€æœ¯ï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºä¸€ä¸ªæ—¢å¯é åˆé«˜æ•ˆçš„æ¨é€ç¡®è®¤ç³»ç»Ÿï¼Œå³ä½¿åœ¨é¢å¯¹æ•°åä¸‡å¹¶å‘</p>]]></content>
    
    
    <summary type="html">æœ¬æ–‡ä»‹ç»äº†æ¸¸æˆåç«¯ä¸­çš„ Push-ACK æœºåˆ¶çš„è®¾è®¡ä¸å®ç°ï¼Œç‰¹åˆ«å…³æ³¨å¦‚ä½•é¿å…å†…å­˜æš´æ¶¨é—®é¢˜ï¼Œåˆ†äº«äº†åœ¨å¤šä¸ªå¤§å‹æ¸¸æˆé¡¹ç›®ä¸­ç§¯ç´¯çš„ç»éªŒä¸æ•™è®­ã€‚</summary>
    
    
    
    <category term="è§£å†³æ–¹æ¡ˆ" scheme="https://hedon.top/categories/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"/>
    
    <category term="æ¸¸æˆåç«¯" scheme="https://hedon.top/categories/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/%E6%B8%B8%E6%88%8F%E5%90%8E%E7%AB%AF/"/>
    
    
    <category term="è§£å†³æ–¹æ¡ˆ" scheme="https://hedon.top/tags/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"/>
    
    <category term="æ¸¸æˆåç«¯" scheme="https://hedon.top/tags/%E6%B8%B8%E6%88%8F%E5%90%8E%E7%AB%AF/"/>
    
    <category term="push-ack" scheme="https://hedon.top/tags/push-ack/"/>
    
  </entry>
  
  <entry>
    <title>æœåŠ¡ç›‘æ§ä¸¨Prometheus å››å¤§æ•°æ®ç±»å‹è¯¦è§£</title>
    <link href="https://hedon.top/2025/02/26/prometheus-data-type/"/>
    <id>https://hedon.top/2025/02/26/prometheus-data-type/</id>
    <published>2025-02-26T07:52:10.000Z</published>
    <updated>2025-04-05T14:31:32.877Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>åœ¨å¾®æœåŠ¡å’Œäº‘åŸç”Ÿæ¶æ„çš„ä¸–ç•Œä¸­ï¼Œä¸€å¥—å¼ºå¤§çš„ç›‘æ§ç³»ç»Ÿæ˜¯ä¿éšœæœåŠ¡ç¨³å®šæ€§çš„åŸºçŸ³ã€‚Prometheus ä½œä¸º CNCF çš„æ˜æ˜Ÿé¡¹ç›®ï¼Œå‡­å€Ÿå…¶ç®€å•é«˜æ•ˆçš„ç‰¹æ€§ï¼Œå·²æˆä¸ºäº‹å®ä¸Šçš„äº‘åŸç”Ÿç›‘æ§æ ‡å‡†ã€‚æœ¬æ–‡å°†æ·±å…¥å‰–æ Prometheus çš„å››å¤§æ•°æ®ç±»å‹åŠå…¶ PromQL æŸ¥è¯¢è¯­è¨€ï¼Œå¸®åŠ©å¼€å‘å›¢é˜Ÿæ„å»ºå¼ºå¤§çš„å¯è§‚æµ‹æ€§ç³»ç»Ÿã€‚</p><h2 id="ç»“è®ºå…ˆè¡Œï¼šPrometheus-å››å¤§æ•°æ®ç±»å‹é€Ÿè§ˆ">ç»“è®ºå…ˆè¡Œï¼šPrometheus å››å¤§æ•°æ®ç±»å‹é€Ÿè§ˆ</h2><table><thead><tr><th>ç‰¹æ€§</th><th>Counter</th><th>Gauge</th><th>Histogram</th><th>Summary</th></tr></thead><tbody><tr><td><strong>å®šä¹‰</strong></td><td>åªå¢ä¸å‡çš„ç´¯ç§¯è®¡æ•°å™¨</td><td>å¯å¢å¯å‡çš„ç¬æ—¶å€¼</td><td>è§‚æµ‹å€¼åˆ†å¸ƒçš„åˆ†æ¡¶ç»Ÿè®¡</td><td>å®¢æˆ·ç«¯è®¡ç®—çš„åˆ†ä½æ•°ç»Ÿè®¡</td></tr><tr><td><strong>é‡ç½®è¡Œä¸º</strong></td><td>æœåŠ¡é‡å¯æ—¶å½’é›¶</td><td>ä¿æŒå½“å‰å€¼</td><td>æ¡¶è®¡æ•°å½’é›¶</td><td>è®¡æ•°å½’é›¶</td></tr><tr><td><strong>å…¸å‹åº”ç”¨</strong></td><td>è¯·æ±‚è®¡æ•°ã€é”™è¯¯æ•°ã€æµé‡ç»Ÿè®¡</td><td>æ¸©åº¦ã€å†…å­˜ä½¿ç”¨ã€è¿æ¥æ•°</td><td>è¯·æ±‚å»¶è¿Ÿã€å“åº”å¤§å°</td><td>è¯·æ±‚å»¶è¿Ÿã€é˜Ÿåˆ—ç­‰å¾…æ—¶é—´</td></tr><tr><td><strong>æ•°æ®ç‚¹</strong></td><td>å•ä¸€å€¼</td><td>å•ä¸€å€¼</td><td>_bucketã€_sumã€count</td><td>{quantile=â€œxâ€}ã€_sumã€_count</td></tr><tr><td><strong>æŸ¥è¯¢é‡ç‚¹</strong></td><td>rate()ã€increase()</td><td>ç›´æ¥ä½¿ç”¨ã€é¢„æµ‹å‡½æ•°</td><td>histogram_quantile()</td><td>ç›´æ¥è¯»å–åˆ†ä½æ•°</td></tr><tr><td><strong>åˆ†å¸ƒå¼èšåˆ</strong></td><td>å¯ä»¥ï¼ˆsumã€rateï¼‰</td><td>å¯ä»¥ï¼ˆavgã€maxã€minï¼‰</td><td>å¯ä»¥ï¼ˆç™¾åˆ†ä½ä¹Ÿå¯èšåˆï¼‰</td><td>æœ‰é™ï¼ˆåˆ†ä½æ•°ä¸å¯èšåˆï¼‰</td></tr><tr><td><strong>èµ„æºæ¶ˆè€—</strong></td><td>ä½</td><td>ä½</td><td>ä¸­ï¼ˆä¾èµ–æ¡¶æ•°é‡ï¼‰</td><td>ä¸­ï¼ˆå®¢æˆ·ç«¯è®¡ç®—ï¼‰</td></tr></tbody></table><h2 id="ä¸€ã€Prometheus-æ ¸å¿ƒæ•°æ®ç±»å‹è¯¦è§£">ä¸€ã€Prometheus æ ¸å¿ƒæ•°æ®ç±»å‹è¯¦è§£</h2><h3 id="1-Counterï¼ˆè®¡æ•°å™¨ï¼‰ï¼šæŒç»­å¢é•¿çš„ç´¯ç§¯å€¼">1. Counterï¼ˆè®¡æ•°å™¨ï¼‰ï¼šæŒç»­å¢é•¿çš„ç´¯ç§¯å€¼</h3><p>Counter æ˜¯æœ€ç®€å•ä½†ä¹Ÿæœ€å¸¸ç”¨çš„æŒ‡æ ‡ç±»å‹ï¼Œä»£è¡¨ä¸€ä¸ªåªå¢ä¸å‡çš„ç´¯ç§¯æ•°å€¼ã€‚æ¯å½“äº‹ä»¶å‘ç”Ÿï¼Œè®¡æ•°å™¨å¢åŠ ï¼›å½“ç›‘æ§ç›®æ ‡é‡å¯æ—¶ï¼Œè®¡æ•°å™¨å½’é›¶ã€‚</p><p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š</p><ul><li>API è¯·æ±‚æ€»æ•°</li><li>é”™è¯¯å‘ç”Ÿæ¬¡æ•°</li><li>å¤„ç†ä»»åŠ¡çš„æ•°é‡</li><li>ç½‘ç»œæµé‡å­—èŠ‚æ•°</li></ul><p><strong>æ­£ç¡®çš„ä»£ç å®ç°</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å£°æ˜å¸¦æ ‡ç­¾çš„è®¡æ•°å™¨</span></span><br><span class="line">requestCounter := prometheus.NewCounterVec(</span><br><span class="line">    prometheus.CounterOpts&#123;</span><br><span class="line">        Name: <span class="string">&quot;http_requests_total&quot;</span>,</span><br><span class="line">        Help: <span class="string">&quot;Total number of HTTP requests&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    []<span class="type">string</span>&#123;<span class="string">&quot;method&quot;</span>, <span class="string">&quot;path&quot;</span>, <span class="string">&quot;status&quot;</span>&#125;, <span class="comment">// å®šä¹‰æ ‡ç­¾ç»´åº¦</span></span><br><span class="line">)</span><br><span class="line">prometheus.MustRegister(requestCounter)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨æ ‡ç­¾è®°å½•è¯·æ±‚</span></span><br><span class="line">requestCounter.WithLabelValues(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;/api/users&quot;</span>, <span class="string">&quot;200&quot;</span>).Inc()</span><br></pre></td></tr></table></figure><p><strong>PromQL æŸ¥è¯¢æŠ€å·§</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># æ¯ç§’è¯·æ±‚ç‡ï¼ˆ5åˆ†é’Ÿçª—å£ï¼‰</span><br><span class="line">rate(http_requests_total&#123;status=&quot;200&quot;&#125;[5m])</span><br><span class="line"></span><br><span class="line"># é”™è¯¯ç‡è®¡ç®—</span><br><span class="line">sum(rate(http_requests_total&#123;status=~&quot;5..&quot;&#125;[5m])) / sum(rate(http_requests_total[5m]))</span><br><span class="line"></span><br><span class="line"># 1å°æ—¶å†…çš„è¯·æ±‚å¢é‡</span><br><span class="line">increase(http_requests_total[1h])</span><br></pre></td></tr></table></figure><p><strong>æœ€ä½³å®è·µ</strong>ï¼š</p><ul><li>æ°¸è¿œä¸è¦ç›´æ¥ä½¿ç”¨ Counter çš„åŸå§‹å€¼ï¼Œæ€»æ˜¯ä½¿ç”¨ <code>rate()</code> æˆ– <code>increase()</code></li><li>ä½¿ç”¨æœ‰æ„ä¹‰çš„æ ‡ç­¾è¿›è¡Œå¤šç»´åº¦åˆ†æï¼Œä½†é¿å…é«˜åŸºæ•°æ ‡ç­¾</li><li>Counter é‡ç½®ï¼ˆå¦‚æœåŠ¡é‡å¯ï¼‰ä¼šè¢« <code>rate()</code> å‡½æ•°è‡ªåŠ¨å¤„ç†</li></ul><h3 id="2-Gaugeï¼ˆä»ªè¡¨ç›˜ï¼‰ï¼šå¯å˜çš„ç¬æ—¶å€¼">2. Gaugeï¼ˆä»ªè¡¨ç›˜ï¼‰ï¼šå¯å˜çš„ç¬æ—¶å€¼</h3><p>Gauge è¡¨ç¤ºä¸€ä¸ªå¯å¢å¯å‡çš„ç¬æ—¶æµ‹é‡å€¼ï¼Œåæ˜ ç³»ç»Ÿçš„å½“å‰çŠ¶æ€ã€‚</p><p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š</p><ul><li>å†…å­˜ä½¿ç”¨é‡</li><li>CPU ä½¿ç”¨ç‡</li><li>å½“å‰æ´»è·ƒè¿æ¥æ•°</li><li>é˜Ÿåˆ—æ·±åº¦</li><li>æ¸©åº¦ç­‰ç‰©ç†é‡</li></ul><p><strong>æ­£ç¡®çš„ä»£ç å®ç°</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å£°æ˜å¸¦æ ‡ç­¾çš„ä»ªè¡¨ç›˜</span></span><br><span class="line">memoryGauge := prometheus.NewGaugeVec(</span><br><span class="line">    prometheus.GaugeOpts&#123;</span><br><span class="line">        Name: <span class="string">&quot;app_memory_usage_bytes&quot;</span>,</span><br><span class="line">        Help: <span class="string">&quot;Current memory usage in bytes&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    []<span class="type">string</span>&#123;<span class="string">&quot;component&quot;</span>, <span class="string">&quot;instance&quot;</span>&#125;,</span><br><span class="line">)</span><br><span class="line">prometheus.MustRegister(memoryGauge)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®å½“å‰å€¼</span></span><br><span class="line">memoryGauge.WithLabelValues(<span class="string">&quot;api-server&quot;</span>, <span class="string">&quot;instance-1&quot;</span>).Set(<span class="type">float64</span>(getCurrentMemoryUsage()))</span><br></pre></td></tr></table></figure><p><strong>PromQL æŸ¥è¯¢æŠ€å·§</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># ç›´æ¥ä½¿ç”¨å½“å‰å€¼</span><br><span class="line">app_memory_usage_bytes&#123;component=&quot;api-server&quot;&#125;</span><br><span class="line"></span><br><span class="line"># ç»Ÿè®¡èšåˆ</span><br><span class="line">avg_over_time(app_memory_usage_bytes[1h])</span><br><span class="line">max_over_time(app_memory_usage_bytes[24h])</span><br><span class="line"></span><br><span class="line"># è¶‹åŠ¿é¢„æµ‹ï¼ˆçº¿æ€§å›å½’ï¼‰</span><br><span class="line">predict_linear(app_memory_usage_bytes[6h], 4 * 3600)</span><br><span class="line"></span><br><span class="line"># è®¡ç®—å˜åŒ–ç‡</span><br><span class="line">(app_memory_usage_bytes - app_memory_usage_bytes offset 1h) / app_memory_usage_bytes offset 1h</span><br></pre></td></tr></table></figure><p><strong>æœ€ä½³å®è·µ</strong>ï¼š</p><ul><li>Gauge å¯ä»¥ç›´æ¥ä½¿ç”¨å…¶ç¬æ—¶å€¼ï¼Œä¸éœ€è¦åƒ Counter é‚£æ ·ä½¿ç”¨ rate</li><li>å¯¹äºå®¹æ˜“æ³¢åŠ¨çš„æŒ‡æ ‡ï¼Œè€ƒè™‘ä½¿ç”¨ <code>avg_over_time</code> å¹³æ»‘æ•°æ®</li><li>åˆ©ç”¨ <code>predict_linear</code> è¿›è¡Œå®¹é‡è§„åˆ’å’Œè¶‹åŠ¿é¢„æµ‹</li></ul><h3 id="3-Histogramï¼ˆç›´æ–¹å›¾ï¼‰ï¼šè§‚æµ‹å€¼åˆ†å¸ƒçš„åˆ†æ¡¶ç»Ÿè®¡">3. Histogramï¼ˆç›´æ–¹å›¾ï¼‰ï¼šè§‚æµ‹å€¼åˆ†å¸ƒçš„åˆ†æ¡¶ç»Ÿè®¡</h3><p>Histogram å…è®¸å¯¹è§‚æµ‹å€¼ï¼ˆå¦‚è¯·æ±‚å»¶è¿Ÿï¼‰è¿›è¡Œåˆ†å¸ƒå¼ç»Ÿè®¡ï¼Œå°†æ•°æ®åˆ†æ•£åˆ°é¢„å®šä¹‰çš„æ¡¶ä¸­ï¼Œæ˜¯åˆ†ææ€§èƒ½åˆ†å¸ƒçš„ç†æƒ³å·¥å…·ã€‚</p><p><strong>è‡ªåŠ¨ç”Ÿæˆçš„æŒ‡æ ‡</strong>ï¼š</p><ul><li><code>&lt;metric&gt;_bucket&#123;le=&quot;&lt;upper bound&gt;&quot;&#125;</code>: å°äºç­‰äºç‰¹å®šé˜ˆå€¼çš„è§‚æµ‹å€¼è®¡æ•°</li><li><code>&lt;metric&gt;_sum</code>: æ‰€æœ‰è§‚æµ‹å€¼çš„æ€»å’Œ</li><li><code>&lt;metric&gt;_count</code>: è§‚æµ‹å€¼æ€»æ•°</li></ul><p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š</p><ul><li>è¯·æ±‚å»¶è¿Ÿåˆ†å¸ƒ</li><li>å“åº”å¤§å°åˆ†å¸ƒ</li><li>æ‰¹å¤„ç†ä»»åŠ¡æ‰§è¡Œæ—¶é—´</li><li>ä»»ä½•éœ€è¦ç™¾åˆ†ä½æ•°åˆ†æçš„åœºæ™¯</li></ul><p><strong>æ­£ç¡®çš„ä»£ç å®ç°</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å£°æ˜å¸¦æ ‡ç­¾çš„ç›´æ–¹å›¾</span></span><br><span class="line">durationHistogram := prometheus.NewHistogramVec(</span><br><span class="line">    prometheus.HistogramOpts&#123;</span><br><span class="line">        Name:    <span class="string">&quot;http_request_duration_seconds&quot;</span>,</span><br><span class="line">        Help:    <span class="string">&quot;HTTP request duration in seconds&quot;</span>,</span><br><span class="line">        Buckets: prometheus.ExponentialBuckets(<span class="number">0.001</span>, <span class="number">2</span>, <span class="number">10</span>), <span class="comment">// ä»1mså¼€å§‹æŒ‡æ•°å¢é•¿</span></span><br><span class="line">    &#125;,</span><br><span class="line">    []<span class="type">string</span>&#123;<span class="string">&quot;method&quot;</span>, <span class="string">&quot;path&quot;</span>&#125;,</span><br><span class="line">)</span><br><span class="line">prometheus.MustRegister(durationHistogram)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®°å½•è¯·æ±‚å»¶è¿Ÿ</span></span><br><span class="line">durationHistogram.WithLabelValues(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;/api/users&quot;</span>).Observe(responseTime)</span><br></pre></td></tr></table></figure><p><strong>PromQL æŸ¥è¯¢æŠ€å·§</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># è®¡ç®—å¹³å‡å“åº”æ—¶é—´</span><br><span class="line">rate(http_request_duration_seconds_sum[5m]) / rate(http_request_duration_seconds_count[5m])</span><br><span class="line"></span><br><span class="line"># è®¡ç®—P90å»¶è¿Ÿ</span><br><span class="line">histogram_quantile(0.9, rate(http_request_duration_seconds_bucket[5m]))</span><br><span class="line"></span><br><span class="line"># æŒ‰APIè·¯å¾„åˆ†æP95å»¶è¿Ÿ</span><br><span class="line">histogram_quantile(0.95, sum by(path, le) (rate(http_request_duration_seconds_bucket[5m])))</span><br><span class="line"></span><br><span class="line"># è®¡ç®—SLOï¼šå»¶è¿Ÿå°äº100msçš„è¯·æ±‚æ¯”ä¾‹</span><br><span class="line">sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.1&quot;&#125;[5m])) / sum(rate(http_request_duration_seconds_count[5m]))</span><br></pre></td></tr></table></figure><p><strong>æœ€ä½³å®è·µ</strong>ï¼š</p><ul><li>ä»”ç»†è®¾è®¡æ¡¶è¾¹ç•Œï¼Œè¦†ç›–å…³é”®åˆ†ä½æ•°åŒºåŸŸ</li><li>å¯¹äºå»¶è¿ŸæŒ‡æ ‡ï¼Œé€šå¸¸ä½¿ç”¨æŒ‡æ•°æ¡¶æ¯”çº¿æ€§æ¡¶æ›´åˆç†</li><li>åˆ©ç”¨ <code>histogram_quantile</code> è®¡ç®—ä»»æ„åˆ†ä½æ•°</li><li>æ¡¶çš„æ•°é‡ä¼šå½±å“å­˜å‚¨å’Œæ€§èƒ½ï¼Œæƒè¡¡ç²¾åº¦å’Œå¼€é”€</li></ul><h3 id="4-Summaryï¼ˆæ‘˜è¦ï¼‰ï¼šå®¢æˆ·ç«¯è®¡ç®—çš„åˆ†ä½æ•°ç»Ÿè®¡">4. Summaryï¼ˆæ‘˜è¦ï¼‰ï¼šå®¢æˆ·ç«¯è®¡ç®—çš„åˆ†ä½æ•°ç»Ÿè®¡</h3><p>Summary ä¸ Histogram ç±»ä¼¼ï¼Œä½†åœ¨å®¢æˆ·ç«¯ç›´æ¥è®¡ç®—å¹¶å­˜å‚¨åˆ†ä½æ•°ï¼Œæ— éœ€æœåŠ¡å™¨ç«¯è®¡ç®—ã€‚</p><p><strong>è‡ªåŠ¨ç”Ÿæˆçš„æŒ‡æ ‡</strong>ï¼š</p><ul><li><code>&lt;metric&gt;&#123;quantile=&quot;&lt;Ï†&gt;&quot;&#125;</code>: Ï† åˆ†ä½æ•°çš„å€¼</li><li><code>&lt;metric&gt;_sum</code>: æ‰€æœ‰è§‚æµ‹å€¼çš„æ€»å’Œ</li><li><code>&lt;metric&gt;_count</code>: è§‚æµ‹å€¼æ€»æ•°</li></ul><p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š</p><ul><li>éœ€è¦é«˜ç²¾åº¦åˆ†ä½æ•°çš„åœºæ™¯</li><li>å®¢æˆ·ç«¯è®¡ç®—åˆ†ä½æ•°æ›´é«˜æ•ˆçš„æƒ…å†µ</li><li>å¯¹æœåŠ¡å™¨ç«¯èšåˆè¦æ±‚ä¸é«˜çš„åœºæ™¯</li></ul><p><strong>æ­£ç¡®çš„ä»£ç å®ç°</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å£°æ˜å¸¦æ ‡ç­¾çš„æ‘˜è¦</span></span><br><span class="line">durationSummary := prometheus.NewSummaryVec(</span><br><span class="line">    prometheus.SummaryOpts&#123;</span><br><span class="line">        Name:       <span class="string">&quot;http_request_duration_seconds_summary&quot;</span>,</span><br><span class="line">        Help:       <span class="string">&quot;HTTP request duration in seconds&quot;</span>,</span><br><span class="line">        Objectives: <span class="keyword">map</span>[<span class="type">float64</span>]<span class="type">float64</span>&#123;<span class="number">0.5</span>: <span class="number">0.05</span>, <span class="number">0.9</span>: <span class="number">0.01</span>, <span class="number">0.99</span>: <span class="number">0.001</span>&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    []<span class="type">string</span>&#123;<span class="string">&quot;method&quot;</span>, <span class="string">&quot;path&quot;</span>&#125;,</span><br><span class="line">)</span><br><span class="line">prometheus.MustRegister(durationSummary)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®°å½•è¯·æ±‚å»¶è¿Ÿ</span></span><br><span class="line">durationSummary.WithLabelValues(<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;/api/login&quot;</span>).Observe(responseTime)</span><br></pre></td></tr></table></figure><p><strong>PromQL æŸ¥è¯¢æŠ€å·§</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># ç›´æ¥è¯»å–P99å»¶è¿Ÿ</span><br><span class="line">http_request_duration_seconds_summary&#123;quantile=&quot;0.99&quot;, method=&quot;GET&quot;, path=&quot;/api/users&quot;&#125;</span><br><span class="line"></span><br><span class="line"># è®¡ç®—å¹³å‡å“åº”æ—¶é—´</span><br><span class="line">rate(http_request_duration_seconds_summary_sum[5m]) / rate(http_request_duration_seconds_summary_count[5m])</span><br><span class="line"></span><br><span class="line"># æ¯ä¸ªæœåŠ¡çš„ä¸­ä½æ•°å»¶è¿Ÿ</span><br><span class="line">max by(service) (http_request_duration_seconds_summary&#123;quantile=&quot;0.5&quot;&#125;)</span><br></pre></td></tr></table></figure><p><strong>æœ€ä½³å®è·µä¸é™åˆ¶</strong>ï¼š</p><ul><li>Summary é¢„è®¡ç®—çš„åˆ†ä½æ•°ä¸èƒ½è·¨å®ä¾‹èšåˆï¼ˆè¿™æ˜¯å…³é”®é™åˆ¶ï¼‰</li><li>é€‚ç”¨äºåˆ†ä½æ•°ç²¾åº¦è¦æ±‚é«˜ä¸”å®ä¾‹ç›¸å¯¹ç‹¬ç«‹çš„åœºæ™¯</li><li>å®¢æˆ·ç«¯è®¡ç®—åˆ†ä½æ•°ä¼šå¢åŠ åº”ç”¨èµ„æºæ¶ˆè€—</li><li>åˆ†ä½æ•°è®¾ç½®åä¸å¯æ›´æ”¹ï¼Œéœ€æå‰è§„åˆ’å¥½ç›‘æ§éœ€æ±‚</li></ul><h2 id="äºŒã€PromQL-æŸ¥è¯¢è¯­è¨€ç²¾é€š">äºŒã€PromQL æŸ¥è¯¢è¯­è¨€ç²¾é€š</h2><p>PromQL æ˜¯ Prometheus çš„å¼ºå¤§æ­¦å™¨ï¼ŒæŒæ¡å®ƒèƒ½è®©æˆ‘ä»¬ç²¾ç¡®æå–æ‰€éœ€çš„ç›‘æ§æ•°æ®ã€‚</p><h3 id="1-åŸºç¡€æŸ¥è¯¢ä¸æ ‡ç­¾é€‰æ‹©">1. åŸºç¡€æŸ¥è¯¢ä¸æ ‡ç­¾é€‰æ‹©</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># åŸºæœ¬æŸ¥è¯¢ä¸ç²¾ç¡®åŒ¹é…</span><br><span class="line">http_requests_total&#123;status=&quot;200&quot;, method=&quot;GET&quot;&#125;</span><br><span class="line"></span><br><span class="line"># æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…</span><br><span class="line">http_requests_total&#123;path=~&quot;/api/v1/.+&quot;, method!=&quot;OPTIONS&quot;&#125;</span><br><span class="line"></span><br><span class="line"># èŒƒå›´æŸ¥è¯¢ï¼ˆè¿”å›æ—¶é—´åºåˆ—ï¼‰</span><br><span class="line">http_requests_total&#123;status=&quot;500&quot;&#125;[5m]</span><br></pre></td></tr></table></figure><h3 id="2-æ“ä½œç¬¦ä¸å‡½æ•°">2. æ“ä½œç¬¦ä¸å‡½æ•°</h3><p><strong>ç®—æœ¯è¿ç®—ç¬¦</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># è®¡ç®—å†…å­˜ä½¿ç”¨ç‡ç™¾åˆ†æ¯”</span><br><span class="line">100 * (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes</span><br></pre></td></tr></table></figure><p><strong>èšåˆå‡½æ•°</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># æŒ‰æœåŠ¡å’Œè·¯å¾„åˆ†ç»„æ±‚å’Œ</span><br><span class="line">sum by(service, path) (rate(http_requests_total[5m]))</span><br><span class="line"></span><br><span class="line"># ä¸¢å¼ƒinstanceæ ‡ç­¾æ±‚æœ€å¤§å€¼</span><br><span class="line">max without(instance) (node_cpu_seconds_total)</span><br></pre></td></tr></table></figure><p><strong>ç¬æ—¶å‘é‡å‡½æ•°</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># æ ‡ç­¾æ›¿æ¢</span><br><span class="line">label_replace(up, &quot;host&quot;, &quot;$1&quot;, &quot;instance&quot;, &quot;(.*):.*&quot;)</span><br><span class="line"></span><br><span class="line"># æŒ‰æ ‡ç­¾åˆ†ç»„å–topk</span><br><span class="line">topk by(path) (5, http_request_duration_seconds_sum / http_request_duration_seconds_count)</span><br></pre></td></tr></table></figure><h3 id="3-å¤æ‚æŸ¥è¯¢æ¨¡å¼">3. å¤æ‚æŸ¥è¯¢æ¨¡å¼</h3><p><strong>SLI/SLO ç›‘æ§</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># æœåŠ¡å¯ç”¨æ€§SLI</span><br><span class="line">sum(rate(http_requests_total&#123;status=~&quot;2..|3..&quot;&#125;[5m])) / sum(rate(http_requests_total[5m]))</span><br><span class="line"></span><br><span class="line"># å»¶è¿ŸSLO</span><br><span class="line">histogram_quantile(0.99, sum by(le) (rate(http_request_duration_seconds_bucket[5m]))) &lt; 0.3</span><br></pre></td></tr></table></figure><p><strong>å¼‚å¸¸æ£€æµ‹</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># ç›¸å¯¹äºå†å²åŒæœŸçš„å¼‚å¸¸å¢é•¿</span><br><span class="line">rate(http_requests_total[5m])</span><br><span class="line">  &gt; 2 * avg_over_time(rate(http_requests_total[5m])[1d:5m] offset 1d)</span><br></pre></td></tr></table></figure><p><strong>é¢„æµ‹åˆ†æ</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># ç£ç›˜ç©ºé—´é¢„æµ‹</span><br><span class="line">predict_linear(node_filesystem_free_bytes&#123;mountpoint=&quot;/&quot;&#125;[6h], 7 * 24 * 3600) &lt; 10 * 1024 * 1024 * 1024</span><br></pre></td></tr></table></figure><h2 id="ä¸‰ã€å®æˆ˜åº”ç”¨åœºæ™¯">ä¸‰ã€å®æˆ˜åº”ç”¨åœºæ™¯</h2><h3 id="1-æœåŠ¡å¥åº·åº¦ç›‘æ§">1. æœåŠ¡å¥åº·åº¦ç›‘æ§</h3><p><strong>RED æ–¹æ³•å®ç°</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># Rate - è¯·æ±‚ç‡</span><br><span class="line">sum by(service) (rate(http_requests_total[5m]))</span><br><span class="line"></span><br><span class="line"># Error - é”™è¯¯ç‡</span><br><span class="line">sum by(service) (rate(http_requests_total&#123;status=~&quot;5..&quot;&#125;[5m])) / sum by(service) (rate(http_requests_total[5m]))</span><br><span class="line"></span><br><span class="line"># Duration - P95å»¶è¿Ÿ</span><br><span class="line">histogram_quantile(0.95, sum by(service, le) (rate(http_request_duration_seconds_bucket[5m])))</span><br></pre></td></tr></table></figure><p><strong>æœåŠ¡ä¾èµ–å¥åº·åº¦</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># æ•°æ®åº“æŸ¥è¯¢é”™è¯¯ç‡</span><br><span class="line">sum(rate(database_query_errors_total[5m])) / sum(rate(database_queries_total[5m]))</span><br><span class="line"></span><br><span class="line"># ç¬¬ä¸‰æ–¹APIè°ƒç”¨å»¶è¿Ÿ</span><br><span class="line">histogram_quantile(0.99, sum by(api_name, le) (rate(api_request_duration_seconds_bucket[5m])))</span><br></pre></td></tr></table></figure><h3 id="2-æ€§èƒ½ç“¶é¢ˆåˆ†æ">2. æ€§èƒ½ç“¶é¢ˆåˆ†æ</h3><p><strong>çƒ­ç‚¹ API å‘ç°</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># å»¶è¿Ÿæœ€é«˜çš„10ä¸ªæ¥å£</span><br><span class="line">topk(10,</span><br><span class="line">  histogram_quantile(0.95, sum by(method, path, le) (rate(http_request_duration_seconds_bucket[5m])))</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># è¯·æ±‚é‡æœ€å¤§çš„æ¥å£</span><br><span class="line">topk(10, sum by(method, path) (rate(http_requests_total[5m])))</span><br></pre></td></tr></table></figure><p><strong>æ•°æ®åº“æ€§èƒ½åˆ†æ</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># å¹³å‡æŸ¥è¯¢æ—¶é—´è¶‹åŠ¿</span><br><span class="line">rate(db_query_duration_seconds_sum[5m]) / rate(db_query_duration_seconds_count[5m])</span><br><span class="line"></span><br><span class="line"># æ…¢æŸ¥è¯¢æ¯”ä¾‹</span><br><span class="line">sum(rate(db_query_duration_seconds_bucket&#123;le=&quot;+Inf&quot;&#125;[5m])) - sum(rate(db_query_duration_seconds_bucket&#123;le=&quot;0.1&quot;&#125;[5m])) / sum(rate(db_query_duration_seconds_bucket&#123;le=&quot;+Inf&quot;&#125;[5m]))</span><br></pre></td></tr></table></figure><h3 id="3-å®¹é‡è§„åˆ’ä¸å‘Šè­¦">3. å®¹é‡è§„åˆ’ä¸å‘Šè­¦</h3><p><strong>èµ„æºé¢„æµ‹</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># CPUä½¿ç”¨ç‡é¢„æµ‹</span><br><span class="line">predict_linear(avg by(instance) (rate(node_cpu_seconds_total&#123;mode!=&quot;idle&quot;&#125;[6h])) [3d:], 7 * 24 * 3600) &gt; 0.85</span><br><span class="line"></span><br><span class="line"># å†…å­˜å‹åŠ›å‘Šè­¦</span><br><span class="line">(node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes &gt; 0.9</span><br></pre></td></tr></table></figure><p><strong>æµé‡å®¹é‡è§„åˆ’</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># å¸¦å®½ä½¿ç”¨é¢„æµ‹</span><br><span class="line">predict_linear(rate(node_network_transmit_bytes_total[12h])[7d:], 30 * 24 * 3600)</span><br></pre></td></tr></table></figure><h2 id="å››ã€æœ€ä½³å®è·µä¸æ€§èƒ½ä¼˜åŒ–">å››ã€æœ€ä½³å®è·µä¸æ€§èƒ½ä¼˜åŒ–</h2><h3 id="1-æŒ‡æ ‡å‘½åä¸æ ‡ç­¾è®¾è®¡">1. æŒ‡æ ‡å‘½åä¸æ ‡ç­¾è®¾è®¡</h3><p><strong>å‘½åè§„èŒƒ</strong>ï¼š</p><ul><li>ä½¿ç”¨ snake_case</li><li>åŒ…å«å•ä½åç¼€ï¼ˆ_bytes, _seconds, _totalï¼‰</li><li>ä¿æŒé£æ ¼ä¸€è‡´æ€§</li></ul><p><strong>æ ‡ç­¾æœ€ä½³å®è·µ</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆç†è®¾è®¡æ ‡ç­¾ç»´åº¦</span></span><br><span class="line">apiLatency := prometheus.NewHistogramVec(</span><br><span class="line">    prometheus.HistogramOpts&#123;</span><br><span class="line">        Name:    <span class="string">&quot;api_request_duration_seconds&quot;</span>,</span><br><span class="line">        Help:    <span class="string">&quot;API request duration in seconds&quot;</span>,</span><br><span class="line">        Buckets: prometheus.ExponentialBuckets(<span class="number">0.001</span>, <span class="number">2</span>, <span class="number">10</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">    []<span class="type">string</span>&#123;<span class="string">&quot;service&quot;</span>, <span class="string">&quot;endpoint&quot;</span>, <span class="string">&quot;status_code&quot;</span>&#125;, <span class="comment">// åˆç†çš„ä½åŸºæ•°æ ‡ç­¾</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸å¯å˜æ ‡ç­¾ä½¿ç”¨ConstLabels</span></span><br><span class="line">prometheus.NewGaugeVec(</span><br><span class="line">    prometheus.GaugeOpts&#123;</span><br><span class="line">        Name:        <span class="string">&quot;service_info&quot;</span>,</span><br><span class="line">        Help:        <span class="string">&quot;Service information&quot;</span>,</span><br><span class="line">        ConstLabels: prometheus.Labels&#123;<span class="string">&quot;version&quot;</span>: <span class="string">&quot;v2.1.3&quot;</span>, <span class="string">&quot;environment&quot;</span>: <span class="string">&quot;production&quot;</span>&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    []<span class="type">string</span>&#123;<span class="string">&quot;instance&quot;</span>&#125;,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h3 id="2-å®¢æˆ·ç«¯æ€§èƒ½ä¼˜åŒ–">2. å®¢æˆ·ç«¯æ€§èƒ½ä¼˜åŒ–</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¼“å­˜å¸¸ç”¨æ ‡ç­¾ç»„åˆä»¥æé«˜æ€§èƒ½</span></span><br><span class="line">getCounter := requestCounter.WithLabelValues(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;/api/users&quot;</span>, <span class="string">&quot;200&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100</span>; i++ &#123;</span><br><span class="line">    getCounter.Inc() <span class="comment">// é‡ç”¨æ ‡ç­¾ç»„åˆï¼Œé¿å…é‡å¤åˆ›å»º</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰¹é‡æ›´æ–°æ–¹å¼</span></span><br><span class="line"><span class="keyword">var</span> rpcDurations = prometheus.NewSummaryVec(</span><br><span class="line">    prometheus.SummaryOpts&#123;</span><br><span class="line">        Name:       <span class="string">&quot;rpc_durations_seconds&quot;</span>,</span><br><span class="line">        Help:       <span class="string">&quot;RPC latency distributions.&quot;</span>,</span><br><span class="line">        Objectives: <span class="keyword">map</span>[<span class="type">float64</span>]<span class="type">float64</span>&#123;<span class="number">0.5</span>: <span class="number">0.05</span>, <span class="number">0.9</span>: <span class="number">0.01</span>, <span class="number">0.99</span>: <span class="number">0.001</span>&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    []<span class="type">string</span>&#123;<span class="string">&quot;service&quot;</span>&#125;,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ObserveBatch</span><span class="params">(durations <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">float64</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> service, duration := <span class="keyword">range</span> durations &#123;</span><br><span class="line">        rpcDurations.WithLabelValues(service).Observe(duration)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-æŸ¥è¯¢ä¼˜åŒ–">3. æŸ¥è¯¢ä¼˜åŒ–</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># ä¼˜åŒ–å‰ï¼šé«˜åŸºæ•°æŸ¥è¯¢</span><br><span class="line">sum(rate(http_requests_total&#123;path=~&quot;/api/.*&quot;&#125;[5m])) by (path, method, status)</span><br><span class="line"></span><br><span class="line"># ä¼˜åŒ–åï¼šé™ä½åŸºæ•°ï¼ŒæŒ‰éœ€èšåˆ</span><br><span class="line">sum(rate(http_requests_total&#123;path=~&quot;/api/.*&quot;&#125;[5m])) by (method, status)</span><br><span class="line"></span><br><span class="line"># ä¼˜åŒ–èšåˆé¡ºåºï¼ˆå…ˆèšåˆå†æ±‚å’Œï¼‰</span><br><span class="line">sum(</span><br><span class="line">  avg by(instance) (rate(node_cpu_seconds_total&#123;mode!=&quot;idle&quot;&#125;[5m]))</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h2 id="äº”ã€å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ">äº”ã€å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ</h2><h3 id="1-é«˜åŸºæ•°é—®é¢˜">1. é«˜åŸºæ•°é—®é¢˜</h3><p><strong>é—®é¢˜</strong>ï¼šæ ‡ç­¾ç»„åˆè¿‡å¤šå¯¼è‡´æ—¶é—´åºåˆ—çˆ†ç‚¸<br><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p><ul><li>é™åˆ¶æ ‡ç­¾åŸºæ•°ï¼Œé¿å…ä½¿ç”¨ UserIDã€SessionID ç­‰ä½œä¸ºæ ‡ç­¾</li><li>ä½¿ç”¨<code>label_replace</code>å’Œæ­£åˆ™è¡¨è¾¾å¼è½¬æ¢é«˜åŸºæ•°æ ‡ç­¾</li><li>è€ƒè™‘ä½¿ç”¨ Exemplars è€Œéæ ‡ç­¾å­˜å‚¨é«˜åŸºæ•°æ•°æ®</li></ul><h3 id="2-æ•°æ®ç±»å‹é€‰æ‹©è¯¯åŒº">2. æ•°æ®ç±»å‹é€‰æ‹©è¯¯åŒº</h3><p><strong>Counter vs Gauge</strong>ï¼šè¯·æ±‚æ•°åº”ä½¿ç”¨ Counter è€Œé Gauge<br><strong>Histogram vs Summary</strong>ï¼šéœ€è¦èšåˆåˆ†æè¯·ä½¿ç”¨ Histogramï¼Œç²¾ç¡®åˆ†ä½æ•°å¯é€‰ Summary</p><h3 id="3-æŸ¥è¯¢æ€§èƒ½é—®é¢˜">3. æŸ¥è¯¢æ€§èƒ½é—®é¢˜</h3><p><strong>é—®é¢˜</strong>ï¼šå¤æ‚æŸ¥è¯¢å¯¼è‡´ Prometheus é«˜è´Ÿè½½<br><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p><ul><li>ä½¿ç”¨è®°å½•è§„åˆ™é¢„è®¡ç®—å¸¸ç”¨æŸ¥è¯¢</li><li>åˆç†è®¾ç½® scrape é—´éš”ï¼Œé¿å…è¿‡åº¦é‡‡é›†</li><li>å¯¹é«˜è¯·æ±‚é‡æ¥å£ä½¿ç”¨å®¢æˆ·ç«¯èšåˆ</li></ul><h2 id="æ€»ç»“ä¸å±•æœ›">æ€»ç»“ä¸å±•æœ›</h2><p>Prometheus çš„å››ç§æ•°æ®ç±»å‹å„æœ‰æ‰€é•¿ï¼šCounter é€‚åˆç´¯ç§¯äº‹ä»¶è®¡æ•°ï¼ŒGauge é€‚åˆç¬æ—¶çŠ¶æ€æµ‹é‡ï¼ŒHistogram é€‚åˆåˆ†å¸ƒç»Ÿè®¡å’Œç™¾åˆ†ä½åˆ†æï¼ŒSummary é€‚åˆå®¢æˆ·ç«¯ç²¾ç¡®åˆ†ä½æ•°è®¡ç®—ã€‚ä¸ä¹‹é…åˆçš„ PromQL æä¾›äº†å¼ºå¤§çš„æ•°æ®æŸ¥è¯¢å’Œåˆ†æèƒ½åŠ›ï¼Œå…±åŒæ„æˆäº†å®Œæ•´çš„ç›‘æ§è§£å†³æ–¹æ¡ˆã€‚</p><p>éšç€äº‘åŸç”ŸæŠ€æœ¯çš„å‘å±•ï¼ŒPrometheus ç”Ÿæ€ä¹Ÿåœ¨ä¸æ–­å£®å¤§ï¼Œä¸ Grafanaã€Alertmanagerã€Thanos ç­‰å·¥å…·é›†æˆï¼Œèƒ½å¤Ÿæ„å»ºæ›´å®Œå–„çš„ç›‘æ§å‘Šè­¦å¹³å°ã€‚åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œç»“åˆ REDï¼ˆRateã€Errorã€Durationï¼‰å’Œ USEï¼ˆUtilizationã€Saturationã€Errorsï¼‰æ–¹æ³•è®ºï¼Œå¯ä»¥æ„å»ºå…¨é¢çš„å¯è§‚æµ‹æ€§ç³»ç»Ÿã€‚</p><p>æ— è®ºä½ æ˜¯åˆšå¼€å§‹ä½¿ç”¨ Prometheus çš„æ–°æ‰‹ï¼Œè¿˜æ˜¯å¯»æ±‚ä¼˜åŒ–ç›‘æ§ç³»ç»Ÿçš„èµ„æ·±å·¥ç¨‹å¸ˆï¼Œå¸Œæœ›æœ¬æ–‡å¯¹ä½ ç†è§£å’Œåº”ç”¨ Prometheus æœ‰æ‰€å¸®åŠ©ã€‚è®°ä½ï¼Œå¥½çš„ç›‘æ§ä¸ä»…èƒ½åŠæ—¶å‘ç°é—®é¢˜ï¼Œæ›´èƒ½é¢„æµ‹å’Œé˜²èŒƒé—®é¢˜ï¼Œæœ€ç»ˆæœåŠ¡äºä¸šåŠ¡å¯é æ€§å’Œç”¨æˆ·ä½“éªŒçš„æå‡ã€‚</p><hr><p><em>å‚è€ƒèµ„æº:</em></p><ul><li>Prometheus å®˜æ–¹æ–‡æ¡£: <a href="https://prometheus.io/docs/">https://prometheus.io/docs/</a></li><li>Google SRE ä¹¦ç±: <a href="https://sre.google/sre-book/monitoring-distributed-systems/">https://sre.google/sre-book/monitoring-distributed-systems/</a></li><li>Prometheus å®æˆ˜: <a href="https://prometheusbook.com/">https://prometheusbook.com/</a></li></ul>]]></content>
    
    
    <summary type="html">æœ¬æ–‡ä»‹ç»äº† Prometheus çš„å››å¤§æ•°æ®ç±»å‹åŠå…¶ PromQL æŸ¥è¯¢è¯­è¨€ï¼Œå¸®åŠ©å¼€å‘å›¢é˜Ÿæ„å»ºå¼ºå¤§çš„å¯è§‚æµ‹æ€§ç³»ç»Ÿã€‚</summary>
    
    
    
    <category term="æœåŠ¡ç›‘æ§" scheme="https://hedon.top/categories/%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7/"/>
    
    
    <category term="æœåŠ¡ç›‘æ§" scheme="https://hedon.top/tags/%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7/"/>
    
    <category term="prometheus" scheme="https://hedon.top/tags/prometheus/"/>
    
  </entry>
  
  <entry>
    <title>åœ¨ Go é¡¹ç›®ä¸­å®ç° JWT ç”¨æˆ·è®¤è¯ä¸ç»­æœŸæœºåˆ¶</title>
    <link href="https://hedon.top/2025/02/15/go-action-jwt/"/>
    <id>https://hedon.top/2025/02/15/go-action-jwt/</id>
    <published>2025-02-15T15:28:10.000Z</published>
    <updated>2025-06-05T00:38:51.444Z</updated>
    
    <content type="html"><![CDATA[<p>JWT (JSON Web Token) æ˜¯ä¸€ç§å¹¿æ³›ä½¿ç”¨çš„ç”¨æˆ·è®¤è¯æ–¹æ¡ˆï¼Œå› å…¶æ— çŠ¶æ€ã€è·¨åŸŸæ”¯æŒå’Œçµæ´»æ€§è€Œå—åˆ°æ¬¢è¿ã€‚æœ¬æ–‡å°†ç»“åˆå®é™…ä»£ç ï¼Œè¯¦ç»†è®²è§£å¦‚ä½•åœ¨ Go é¡¹ç›®ä¸­å®ç° JWT è®¤è¯æœºåˆ¶ï¼Œå¹¶æ¢è®¨ä¸¤ç§å¸¸è§çš„ Token ç»­æœŸç­–ç•¥ï¼šè‡ªåŠ¨ç»­æœŸå’Œ Refresh Tokenã€‚</p><h2 id="1-JWT-åŸºç¡€æ¦‚å¿µ">1. JWT åŸºç¡€æ¦‚å¿µ</h2><p>JWT ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šHeaderã€Payload å’Œ Signatureã€‚ä½¿ç”¨ JWT è¿›è¡Œç™»å½•è®¤è¯çš„åŸºæœ¬å·¥ä½œæµç¨‹æ˜¯ï¼š</p><ol><li>ç”¨æˆ·ç™»å½•æˆåŠŸåï¼ŒæœåŠ¡å™¨ç”Ÿæˆ JWTã€‚</li><li>æœåŠ¡å™¨å°† token è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</li><li>å®¢æˆ·ç«¯åç»­è¯·æ±‚æºå¸¦ tokenã€‚</li><li>æœåŠ¡å™¨éªŒè¯ token çš„æœ‰æ•ˆæ€§ã€‚</li></ol><p>æˆ‘ä»¬å¯ä»¥åœ¨ <a href="https://jwt.io/">https://jwt.io/</a> ç½‘ç«™å¯¹ JWT è¿›è¡Œåˆ†æï¼ŒæŸ¥çœ‹å…¶å…·ä½“çš„ç»„æˆæˆåˆ†ã€‚</p><h2 id="2-åŸºæœ¬å‡†å¤‡">2. åŸºæœ¬å‡†å¤‡</h2><p>åœ¨æœ¬ç¯‡ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Go è¯­è¨€ï¼Œé€šè¿‡ä¸€ä¸ªå®Œæ•´çš„æ¡ˆä¾‹å®ç°åœ¨ HTTP æ¥å£ä¸­ï¼Œä½¿ç”¨ JWT è¿›è¡Œç”¨æˆ·ç™»å½•å’Œè®¤è¯æµç¨‹ã€‚æœ¬æ–‡å‡è®¾è¯»è€…å·²æŒæ¡åŸºæœ¬çš„ Go è¯­è¨€è¯­æ³•å’Œç½‘ç»œç¼–ç¨‹ç»éªŒï¼Œå¹¶å¯¹ <a href="https://github.com/gin-gonic/gin">Gin</a> æ¡†æ¶æœ‰åŸºæœ¬çš„äº†è§£ã€‚</p><p>ä¸ºäº†å¿«é€Ÿå“åº”å¤±è´¥ï¼Œæœ¬æ–‡æ¡ˆä¾‹ä¸­ä½¿ç”¨äº†å°è£…å¥½çš„å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> utils</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">ErrUser = errors.New(<span class="string">&quot;&quot;</span>)</span><br><span class="line">ErrSys  = errors.New(<span class="string">&quot;&quot;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰ç”¨æˆ·ä¾§é”™è¯¯ï¼Œä¼šç›´æ¥å°†é”™è¯¯å†…å®¹è¿”å›ç»™ç”¨æˆ·ï¼Œä¸æ‰“å°æ—¥å¿—ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">UserErr</span><span class="params">(msg <span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;%w%v&quot;</span>, ErrUser, msg)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">UserErrf</span><span class="params">(format <span class="type">string</span>, a ...any)</span></span> <span class="type">error</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;%w%v&quot;</span>, ErrUser, fmt.Sprintf(format, a...))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰ç³»ç»Ÿå†…éƒ¨é”™è¯¯ï¼Œä¼šå›ºå®šè¿”å› internal server error ç»™ç”¨æˆ·ï¼Œä½†æ˜¯ä¼šå°†åŸå§‹é”™è¯¯ä¿¡æ¯è¾“å‡ºåˆ°æ—¥å¿—ä¸­ï¼Œä¾¿äºå†…éƒ¨æ’æŸ¥ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SystemErr</span><span class="params">(err <span class="type">error</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;%w%v&quot;</span>, ErrSys, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SystemErrf</span><span class="params">(format <span class="type">string</span>, a ...any)</span></span> <span class="type">error</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;%w%v&quot;</span>, ErrSys, fmt.Sprintf(format, a...))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GinErr</span><span class="params">(c *gin.Context, req any, err <span class="type">error</span>, msgs ...<span class="type">string</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> errors.Is(err, ErrUser) &#123;</span><br><span class="line">c.JSON(http.StatusOK, err.Error())</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">msg := <span class="string">&quot;internal server error&quot;</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(msgs) &gt; <span class="number">0</span> &#123;</span><br><span class="line">msg = msgs[<span class="number">0</span>]</span><br><span class="line">&#125;</span><br><span class="line">slog.Error(msg,</span><br><span class="line">slog.Any(<span class="string">&quot;req&quot;</span>, req),</span><br><span class="line">slog.String(<span class="string">&quot;err&quot;</span>, err.Error()),</span><br><span class="line">)</span><br><span class="line">c.JSON(http.StatusOK, <span class="string">&quot;internal server error&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-å®ç°ç”¨æˆ·è®¤è¯">3. å®ç°ç”¨æˆ·è®¤è¯</h2><p>åœ¨è¿›è¡Œå®é™…ä»£ç ç¼–å†™ä¹‹å‰ï¼Œä½ éœ€è¦å…ˆåˆå§‹åŒ–å¥½é¡¹ç›®å¹¶å¼•å…¥ <code>jwt</code> ä¾èµ–ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get -u github.com/golang-jwt/jwt/v5</span><br></pre></td></tr></table></figure><p>åœ¨ä»£ç ä¸­ä½¿ç”¨çš„æ—¶å€™ï¼Œå¯ä»¥ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;github.com/golang-jwt/jwt/v5&quot;</span></span><br></pre></td></tr></table></figure><p>é‚£æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ­£å¼å¼€å§‹æˆ‘ä»¬çš„åŠŸèƒ½å®ç°ã€‚</p><h3 id="3-1-å®šä¹‰-Claims-ç»“æ„">3.1 å®šä¹‰ Claims ç»“æ„</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ JWT çš„è½½è·ï¼ˆPayloadï¼‰ç»“æ„ï¼Œå³å†³å®šå°†ä»€ä¹ˆä¿¡æ¯å­˜å‚¨åœ¨ token å½“ä¸­ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> UserClaims <span class="keyword">struct</span> &#123;</span><br><span class="line">    jwt.RegisteredClaims</span><br><span class="line">    UserID    <span class="type">uint64</span> <span class="string">`json:&quot;user_id&quot;`</span>    <span class="comment">// ç”¨æˆ·ID</span></span><br><span class="line">    UserAgent <span class="type">string</span> <span class="string">`json:&quot;user_agent&quot;`</span>  <span class="comment">// ç”¨æˆ·è®¾å¤‡ä¿¡æ¯</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬ï¼š</p><ul><li><p>ç»„åˆäº† <code>jwt.RegisteredClaims</code>ï¼Œå®ƒåŒ…å«äº†æ ‡å‡†çš„ JWT å­—æ®µï¼ˆå¦‚è¿‡æœŸæ—¶é—´ï¼‰ï¼Œå¸®åŠ©æˆ‘ä»¬å®ç°äº† <code>jwt.Clamis</code> æ¥å£ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Claims <span class="keyword">interface</span> &#123;</span><br><span class="line">GetExpirationTime() (*NumericDate, <span class="type">error</span>)</span><br><span class="line">GetIssuedAt() (*NumericDate, <span class="type">error</span>)</span><br><span class="line">GetNotBefore() (*NumericDate, <span class="type">error</span>)</span><br><span class="line">GetIssuer() (<span class="type">string</span>, <span class="type">error</span>)</span><br><span class="line">GetSubject() (<span class="type">string</span>, <span class="type">error</span>)</span><br><span class="line">GetAudience() (ClaimStrings, <span class="type">error</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>jwt.RegisteredClaims</code> çš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> RegisteredClaims <span class="keyword">struct</span> &#123;</span><br><span class="line">Issuer <span class="type">string</span> <span class="string">`json:&quot;iss,omitempty&quot;`</span></span><br><span class="line">Subject <span class="type">string</span> <span class="string">`json:&quot;sub,omitempty&quot;`</span></span><br><span class="line">Audience ClaimStrings <span class="string">`json:&quot;aud,omitempty&quot;`</span></span><br><span class="line">ExpiresAt *NumericDate <span class="string">`json:&quot;exp,omitempty&quot;`</span></span><br><span class="line">NotBefore *NumericDate <span class="string">`json:&quot;nbf,omitempty&quot;`</span></span><br><span class="line">IssuedAt *NumericDate <span class="string">`json:&quot;iat,omitempty&quot;`</span></span><br><span class="line">ID <span class="type">string</span> <span class="string">`json:&quot;jti,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c RegisteredClaims)</span></span> GetExpirationTime() (*NumericDate, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> c.ExpiresAt, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c RegisteredClaims)</span></span> GetNotBefore() (*NumericDate, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> c.NotBefore, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c RegisteredClaims)</span></span> GetIssuedAt() (*NumericDate, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> c.IssuedAt, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c RegisteredClaims)</span></span> GetAudience() (ClaimStrings, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> c.Audience, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c RegisteredClaims)</span></span> GetIssuer() (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> c.Issuer, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c RegisteredClaims)</span></span> GetSubject() (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> c.Subject, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ·»åŠ äº†è‡ªå®šä¹‰å­—æ®µ <code>UserID</code> å’Œ <code>UserAgent</code> ç”¨äºå®‰å…¨æ§åˆ¶ã€‚ä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„ä¸šåŠ¡éœ€æ±‚ï¼Œæ·»åŠ ä»»æ„éæ•æ„Ÿä¿¡æ¯åˆ°è¿™ä¸ªç»“æ„ä¸­ã€‚</p></li></ul><h3 id="3-2-ç™»å½•æ¥å£å®ç°">3.2 ç™»å½•æ¥å£å®ç°</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">   AccessTokenDuration = time.Minute * <span class="number">15</span></span><br><span class="line">   RefreshTokenDuration = time.Hour * <span class="number">24</span> * <span class="number">7</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *UserHandler)</span></span> LoginJWT(ctx *gin.Context) &#123;</span><br><span class="line">    <span class="comment">// 1. æ ¡éªŒç”¨æˆ·ä¿¡æ¯ï¼Œåœ¨æœ¬æ¡ˆä¾‹ä¸­ï¼Œä½¿ç”¨é‚®ç®±åŠ å¯†ç è¿›è¡Œç™»å½•</span></span><br><span class="line">    user, err := u.svc.Login(ctx.Request.Context(), req.Email, req.Password)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        utils.GinErr(ctx, req, utils.UserErr(err), <span class="string">&quot;login failed&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. åˆ›å»º JWT Claims</span></span><br><span class="line">    accessClaims := UserClaims&#123;</span><br><span class="line">        UserID:    user.ID,</span><br><span class="line">        UserAgent: ctx.Request.UserAgent(),</span><br><span class="line">        RegisteredClaims: jwt.RegisteredClaims&#123;</span><br><span class="line">            ExpiresAt: jwt.NewNumericDate(time.Now().Add(AccessTokenDuration)), <span class="comment">// 15åˆ†é’Ÿè¿‡æœŸ</span></span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. ç”Ÿæˆ Access Token</span></span><br><span class="line">    accessToken := jwt.NewWithClaims(jwt.SigningMethodHS512, accessClaims)</span><br><span class="line">    accessTokenStr, err := accessToken.SignedString(AccessTokenKey)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        utils.GinErr(ctx, req, utils.SystemErr(err), <span class="string">&quot;generate access token failed&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. ç”Ÿæˆ Refresh Tokenï¼Œç”¨äº Token ç»­æœŸ</span></span><br><span class="line">    refreshClaims := RefreshClaims&#123;</span><br><span class="line">        UserID:    user.ID,</span><br><span class="line">        UserAgent: ctx.Request.UserAgent(),</span><br><span class="line">        RegisteredClaims: jwt.RegisteredClaims&#123;</span><br><span class="line">            ExpiresAt: jwt.NewNumericDate(time.Now().Add(RefreshTokenDuration)), <span class="comment">// 7å¤©è¿‡æœŸ</span></span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    refreshToken := jwt.NewWithClaims(jwt.SigningMethodHS512, refreshClaims)</span><br><span class="line">    refreshTokenStr, err := refreshToken.SignedString(RefreshTokenKey)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        utils.GinErr(ctx, req, utils.SystemErr(err), <span class="string">&quot;generate refresh token failed&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. è¿”å›ä¸¤ä¸ª token</span></span><br><span class="line">    ctx.Header(<span class="string">&quot;x-jwt-token&quot;</span>, accessTokenStr)</span><br><span class="line">    ctx.Header(<span class="string">&quot;x-refresh-token&quot;</span>, refreshTokenStr)</span><br><span class="line">    ctx.JSON(http.StatusOK, <span class="string">&quot;login success&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-3-JWT-ä¸­é—´ä»¶å®ç°">3.3 JWT ä¸­é—´ä»¶å®ç°</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> LoginJWTMiddlewareBuilder <span class="keyword">struct</span> &#123;</span><br><span class="line">whiteList []<span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewLoginJWTMiddlewareBuilder</span><span class="params">()</span></span> *LoginJWTMiddlewareBuilder &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;LoginJWTMiddlewareBuilder&#123;</span><br><span class="line">whiteList: []<span class="type">string</span>&#123;&#125;,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *LoginJWTMiddlewareBuilder)</span></span> IgnorePaths(paths ...<span class="type">string</span>) *LoginJWTMiddlewareBuilder &#123;</span><br><span class="line">b.whiteList = <span class="built_in">append</span>(b.whiteList, paths...)</span><br><span class="line"><span class="keyword">return</span> b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *LoginJWTMiddlewareBuilder)</span></span> Build() gin.HandlerFunc &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(ctx *gin.Context)</span></span> &#123;</span><br><span class="line">        <span class="comment">// 1. æå– token</span></span><br><span class="line">        authCode := ctx.GetHeader(<span class="string">&quot;Authorization&quot;</span>)</span><br><span class="line">        tokenStr := strings.TrimPrefix(authCode, <span class="string">&quot;Bearer &quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. è§£æå’ŒéªŒè¯ token</span></span><br><span class="line">        uc := web.UserClaims&#123;&#125;</span><br><span class="line">        token, err := jwt.ParseWithClaims(tokenStr, &amp;uc, <span class="function"><span class="keyword">func</span><span class="params">(token *jwt.Token)</span></span> (<span class="keyword">interface</span>&#123;&#125;, <span class="type">error</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> web.AccessTokenKey, <span class="literal">nil</span></span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. éªŒè¯ token æœ‰æ•ˆæ€§</span></span><br><span class="line">        <span class="keyword">if</span> token == <span class="literal">nil</span> || !token.Valid &#123;</span><br><span class="line">            ctx.AbortWithStatus(http.StatusUnauthorized)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. éªŒè¯ UserAgent</span></span><br><span class="line">        <span class="keyword">if</span> uc.UserAgent != ctx.Request.UserAgent() &#123;</span><br><span class="line">            ctx.AbortWithStatus(http.StatusUnauthorized)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. è®¾ç½®ç”¨æˆ·ä¿¡æ¯åˆ°ä¸Šä¸‹æ–‡</span></span><br><span class="line">        ctx.Set(<span class="string">&quot;user_id&quot;</span>, uc.UserID)</span><br><span class="line">      ctx.Set(<span class="string">&quot;claims&quot;</span>, uc)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-4-æ³¨å†Œä¸­é—´ä»¶">3.4 æ³¨å†Œä¸­é—´ä»¶</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initWebServer</span><span class="params">()</span></span> *gin.Engine &#123;</span><br><span class="line">server := gin.Default()</span><br><span class="line"></span><br><span class="line">server.Use(</span><br><span class="line">middleware.CORS(),</span><br><span class="line">middleware.NewLoginJWTMiddlewareBuilder().</span><br><span class="line">IgnorePaths(<span class="string">&quot;/users/signup&quot;</span>).</span><br><span class="line">IgnorePaths(<span class="string">&quot;/users/login&quot;</span>).</span><br><span class="line">Build(),</span><br><span class="line">)</span><br><span class="line">web.RegisterRoutes(server)</span><br><span class="line"><span class="keyword">return</span> server</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RegisterRoutes</span><span class="params">(server *gin.Engine)</span></span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">userHandler.RegisterRoutes(server)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *UserHandler)</span></span> RegisterRoutes(server *gin.Engine) &#123;</span><br><span class="line">  ur := server.Group(<span class="string">&quot;/users&quot;</span>)</span><br><span class="line">  ur.POST(<span class="string">&quot;/login&quot;</span>, u.LoginJWT)</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-åœ¨å…¶ä»–æ¥å£ä¸­ä½¿ç”¨-Token-çš„ç›¸å…³ä¿¡æ¯">4. åœ¨å…¶ä»–æ¥å£ä¸­ä½¿ç”¨ Token çš„ç›¸å…³ä¿¡æ¯</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *UserHandler)</span></span> Profile(ctx *gin.Context) &#123;</span><br><span class="line">  <span class="comment">// å¯ä»¥è·å– user_id</span></span><br><span class="line">userID := ctx.GetUint64(<span class="string">&quot;user_id&quot;</span>)</span><br><span class="line">  <span class="comment">// ä¹Ÿå¯ä»¥ç›´æ¥è·å–æ•´ä¸ª claimsã€‚</span></span><br><span class="line">  <span class="comment">// è¿™é‡Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ä¸è¿›è¡Œæ–­è¨€ï¼Œå› ä¸ºç†è®ºä¸Šæˆ‘ä»¬çš„å¯ä»¥ä¿è¯è¿™é‡Œé€šè¿‡æ–­è¨€ã€‚</span></span><br><span class="line">  <span class="comment">// å¦‚æœè¿™é‡Œå‘ç”Ÿ panic äº†ï¼Œåˆ™è¯´æ˜æˆ‘ä»¬çš„å†…éƒ¨é€»è¾‘æ²¡æœ‰å½¢æˆé—­ç¯ï¼Œå­˜åœ¨é—®é¢˜ã€‚</span></span><br><span class="line">  <span class="comment">// panic å¯ä»¥ç¬¬ä¸€æ—¶é—´æš´éœ²é—®é¢˜ï¼Œç„¶åè¢«è§£å†³æ‰ã€‚</span></span><br><span class="line">  <span class="comment">// ä¸è¿‡è¿™ä¸ªæ—¶å€™å»ºè®®ä½ ä½¿ç”¨ gin çš„ recover ä¸­é—´ä»¶è¿›è¡Œå…¨å±€ä¿æŠ¤ï¼Œé¿å…æ•´ä¸ªæœåŠ¡å› ä¸º panic è€Œå®•æœºã€‚</span></span><br><span class="line">  uc, _ := ctx.Get(<span class="string">&quot;claims&quot;</span>)</span><br><span class="line">userClaims := uc.(*UserClaims)</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5-Refresh-Token-æœºåˆ¶">5. Refresh Token æœºåˆ¶</h2><h3 id="5-1-æ·»åŠ åˆ·æ–°-Token-æ¥å£">5.1 æ·»åŠ åˆ·æ–° Token æ¥å£</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *UserHandler)</span></span> RefreshToken(ctx *gin.Context) &#123;</span><br><span class="line">    <span class="comment">// ä»è¯·æ±‚å¤´è·å– Refresh Token</span></span><br><span class="line">    refreshTokenStr := ctx.GetHeader(<span class="string">&quot;x-refresh-token&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> refreshTokenStr == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        ctx.AbortWithStatus(http.StatusUnauthorized)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£æå’ŒéªŒè¯ Refresh Token</span></span><br><span class="line">    <span class="keyword">var</span> refreshClaims RefreshClaims</span><br><span class="line">    refreshToken, err := jwt.ParseWithClaims(refreshTokenStr, &amp;refreshClaims, <span class="function"><span class="keyword">func</span><span class="params">(token *jwt.Token)</span></span> (<span class="keyword">interface</span>&#123;&#125;, <span class="type">error</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> RefreshTokenKey, <span class="literal">nil</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> || !refreshToken.Valid &#123;</span><br><span class="line">        ctx.AbortWithStatus(http.StatusUnauthorized)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éªŒè¯ User Agent</span></span><br><span class="line">    <span class="keyword">if</span> refreshClaims.UserAgent != ctx.Request.UserAgent() &#123;</span><br><span class="line">        ctx.AbortWithStatus(http.StatusUnauthorized)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”Ÿæˆæ–°çš„ Access Token</span></span><br><span class="line">    accessClaims := UserClaims&#123;</span><br><span class="line">        UserID:    refreshClaims.UserID,</span><br><span class="line">        UserAgent: ctx.Request.UserAgent(),</span><br><span class="line">        RegisteredClaims: jwt.RegisteredClaims&#123;</span><br><span class="line">            ExpiresAt: jwt.NewNumericDate(time.Now().Add(AccessTokenDuration)),</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    newAccessToken := jwt.NewWithClaims(jwt.SigningMethodHS512, accessClaims)</span><br><span class="line">    newAccessTokenStr, err := newAccessToken.SignedString(AccessTokenKey)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        utils.GinErr(ctx, <span class="literal">nil</span>, utils.SystemErr(err), <span class="string">&quot;generate new access token failed&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¯¹ Refresh Token è¿›è¡Œç»­æœŸ</span></span><br><span class="line">  refreshClaims := RefreshClaims&#123;</span><br><span class="line">        UserID:    user.ID,</span><br><span class="line">        UserAgent: ctx.Request.UserAgent(),</span><br><span class="line">        RegisteredClaims: jwt.RegisteredClaims&#123;</span><br><span class="line">            ExpiresAt: jwt.NewNumericDate(time.Now().Add(RefreshTokenDuration)), <span class="comment">// 7å¤©è¿‡æœŸ</span></span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    newRefreshToken := jwt.NewWithClaims(jwt.SigningMethodHS512, refreshClaims)</span><br><span class="line">    newRefreshTokenStr, err := newRefreshToken.SignedString(RefreshTokenKey)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        utils.GinErr(ctx, req, utils.SystemErr(err), <span class="string">&quot;generate new refresh token failed&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›æ–°çš„ Access Token å’Œç»­æœŸåçš„ Refresh Token</span></span><br><span class="line">    ctx.Header(<span class="string">&quot;x-jwt-token&quot;</span>, newAccessTokenStr)</span><br><span class="line">   ctx.Header(<span class="string">&quot;x-refresh-token&quot;</span>, newRefreshTokenStr)</span><br><span class="line">    ctx.JSON(http.StatusOK, <span class="string">&quot;token refreshed&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-2-æ³¨å†Œè·¯ç”±">5.2 æ³¨å†Œè·¯ç”±</h3><p>åœ¨ <code>RegisterRoutes</code> æ–¹æ³•ä¸­æ·»åŠ æ–°è·¯ç”±ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *UserHandler)</span></span> RegisterRoutes(server *gin.Engine) &#123;</span><br><span class="line">  ur := server.Group(<span class="string">&quot;/users&quot;</span>)</span><br><span class="line">  ur.POST(<span class="string">&quot;/login&quot;</span>, u.LoginJWT)</span><br><span class="line">  ur.GET(<span class="string">&quot;/profile&quot;</span>, u.Profile)</span><br><span class="line">  ur.POST(<span class="string">&quot;/refresh&quot;</span>, u.RefreshToken)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="6-å®¢æˆ·ç«¯ä½¿ç”¨æµç¨‹">6. å®¢æˆ·ç«¯ä½¿ç”¨æµç¨‹</h2><ol><li>ç™»å½•åè·å– Access Token å’Œ Refresh Token</li><li>ä½¿ç”¨ Access Token è®¿é—®å—ä¿æŠ¤èµ„æº</li><li>å½“ Access Token è¿‡æœŸæ—¶è°ƒç”¨ /refresh æ¥å£è·å–æ–°çš„ Access Token</li><li>ä½¿ç”¨æ–°çš„ Access Token ç»§ç»­è®¿é—®</li></ol><p>åˆ·æ–° token çš„å®¢æˆ·ç«¯ç¤ºä¾‹ä»£ç ï¼ˆç¬”è€…å¹¶ä¸æ“…é•¿å†™å‰ç«¯ä»£ç  hhhï¼Œæ‰€ä»¥è¿™æ˜¯è®© ChatGPT å¸®å¿™å†™çš„ ğŸ˜„ï¼‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">async function refreshAccessToken() &#123;</span><br><span class="line">    <span class="keyword">const</span> response = await fetch(<span class="string">&#x27;/users/refresh&#x27;</span>, &#123;</span><br><span class="line">        method: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">        headers: &#123;</span><br><span class="line">            <span class="string">&#x27;x-refresh-token&#x27;</span>: localStorage.getItem(<span class="string">&#x27;refreshToken&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (response.ok) &#123;</span><br><span class="line">        <span class="keyword">const</span> newAccessToken = response.headers.get(<span class="string">&#x27;x-jwt-token&#x27;</span>);</span><br><span class="line">        localStorage.setItem(<span class="string">&#x27;accessToken&#x27;</span>, newAccessToken);</span><br><span class="line">        <span class="keyword">const</span> newRefreshToken = response.headers.get(<span class="string">&#x27;x-refresh-token&#x27;</span>);</span><br><span class="line">        localStorage.setItem(<span class="string">&#x27;refreshToken&#x27;</span>, newRefreshToken);</span><br><span class="line">        <span class="keyword">return</span> newAccessToken;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœåˆ·æ–°å¤±è´¥ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ</span></span><br><span class="line">    window.location.href = <span class="string">&#x27;/login&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="7-Token-ç»­æœŸç­–ç•¥å¯¹æ¯”">7. Token ç»­æœŸç­–ç•¥å¯¹æ¯”</h2><p>åœ¨å‰é¢æ¡ˆä¾‹ä¸­ï¼Œç»†å¿ƒçš„è¯»è€…å¯ä»¥è§‚å¯Ÿåˆ°æˆ‘ä»¬å¯¹ <code>AccessToken</code> å’Œ <code>RefreshToken</code> åˆ†åˆ«é‡‡ç”¨äº† 2 ç§ä¸åŒçš„ç»­æœŸç­–ç•¥ã€‚</p><h3 id="è‡ªåŠ¨ç»­æœŸ">è‡ªåŠ¨ç»­æœŸ</h3><p><strong>ä¼˜ç‚¹ï¼š</strong></p><ul><li>ç®€å•æ˜“ç”¨ï¼šåœ¨æ¯æ¬¡è¯·æ±‚æ—¶è‡ªåŠ¨æ£€æŸ¥å¹¶ç»­æœŸ Tokenï¼Œç”¨æˆ·ä½“éªŒæµç•…ã€‚</li><li>æ— é¢å¤–å­˜å‚¨éœ€æ±‚ï¼šä¸éœ€è¦å­˜å‚¨ Refresh Tokenï¼Œå‡å°‘äº†å­˜å‚¨å’Œç®¡ç†çš„å¤æ‚æ€§</li></ul><p><strong>ç¼ºç‚¹ï¼š</strong></p><ul><li>å®‰å…¨æ€§è¾ƒä½ï¼šå¦‚æœ Token è¢«ç›—ç”¨ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡è‡ªåŠ¨ç»­æœŸä¿æŒé•¿æ—¶é—´çš„è®¿é—®ã€‚</li><li>Token è¿‡æœŸæ—¶é—´ä¸å›ºå®šï¼šToken çš„æœ‰æ•ˆæœŸä¼šä¸æ–­å»¶é•¿ï¼Œéš¾ä»¥æ§åˆ¶ã€‚</li></ul><h3 id="Refresh-Token">Refresh Token</h3><p><strong>ä¼˜ç‚¹ï¼š</strong></p><ul><li>æ›´é«˜çš„å®‰å…¨æ€§ï¼šå³ä½¿ Access Token è¢«ç›—ç”¨ï¼Œæ”»å‡»è€…ä¹Ÿæ— æ³•ç»­æœŸï¼Œé™¤éåŒæ—¶è·å– Refresh Tokenã€‚</li><li>å¯æ§çš„ Token ç”Ÿå‘½å‘¨æœŸï¼šAccess Token æœ‰å›ºå®šçš„çŸ­æœŸæœ‰æ•ˆæœŸï¼ŒRefresh Token æœ‰è¾ƒé•¿çš„æœ‰æ•ˆæœŸã€‚</li><li>æ”¯æŒ Token æ’¤é”€ï¼šå¯ä»¥å®ç° Refresh Token çš„é»‘åå•æœºåˆ¶ï¼Œæ”¯æŒæ‰‹åŠ¨æ’¤é”€ã€‚</li></ul><p><strong>ç¼ºç‚¹ï¼š</strong></p><ul><li>å®ç°å¤æ‚åº¦è¾ƒé«˜ï¼šéœ€è¦é¢å¤–çš„æ¥å£å’Œé€»è¾‘æ¥å¤„ç† Refresh Tokenã€‚</li><li>å­˜å‚¨éœ€æ±‚ï¼šéœ€è¦å®‰å…¨å­˜å‚¨ Refresh Tokenï¼Œå¯èƒ½éœ€è¦æ•°æ®åº“æ”¯æŒã€‚</li></ul><h2 id="8-æ€»ç»“">8. æ€»ç»“</h2><p>JWT å®ç°ç”¨æˆ·è®¤è¯çš„ä¼˜åŠ¿åœ¨äºæ— çŠ¶æ€ã€è·¨åŸŸæ”¯æŒå’Œçµæ´»æ€§ã€‚é€šè¿‡åˆç†ä½¿ç”¨ JWT å’Œé€‰æ‹©åˆé€‚çš„ Token ç»­æœŸç­–ç•¥ï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºå®‰å…¨ã€å¯é çš„ç”¨æˆ·è®¤è¯ç³»ç»Ÿã€‚å¸Œæœ›æœ¬æ–‡èƒ½å¸®åŠ©æ‚¨åœ¨ Go é¡¹ç›®ä¸­æ›´å¥½åœ°å®ç° JWT è®¤è¯ã€‚</p>]]></content>
    
    
    <summary type="html">æœ¬æ–‡å°†ç»“åˆå®é™…ä»£ç ï¼Œè¯¦ç»†è®²è§£å¦‚ä½•åœ¨ Go é¡¹ç›®ä¸­å®ç° JWT è®¤è¯æœºåˆ¶ï¼Œå¹¶æ¢è®¨ä¸¤ç§å¸¸è§çš„ Token ç»­æœŸç­–ç•¥ï¼šè‡ªåŠ¨ç»­æœŸå’Œ Refresh Tokenã€‚</summary>
    
    
    
    <category term="go" scheme="https://hedon.top/categories/go/"/>
    
    <category term="go å®æˆ˜" scheme="https://hedon.top/categories/go/go-%E5%AE%9E%E6%88%98/"/>
    
    
    <category term="go" scheme="https://hedon.top/tags/go/"/>
    
    <category term="JWT" scheme="https://hedon.top/tags/JWT/"/>
    
    <category term="go å®æˆ˜" scheme="https://hedon.top/tags/go-%E5%AE%9E%E6%88%98/"/>
    
  </entry>
  
</feed>
