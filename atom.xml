<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>HedonSpace</title>
  
  
  <link href="https://hedon.top/atom.xml" rel="self"/>
  
  <link href="https://hedon.top/"/>
  <updated>2025-02-16T01:32:47.265Z</updated>
  <id>https://hedon.top/</id>
  
  <author>
    <name>Hedon Wang</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>åœ¨ Go é¡¹ç›®ä¸­å®ç° JWT ç”¨æˆ·è®¤è¯ä¸ç»­æœŸæœºåˆ¶</title>
    <link href="https://hedon.top/2025/02/15/go-action-jwt/"/>
    <id>https://hedon.top/2025/02/15/go-action-jwt/</id>
    <published>2025-02-15T15:28:10.000Z</published>
    <updated>2025-02-16T01:32:47.265Z</updated>
    
    <content type="html"><![CDATA[<p>JWT (JSON Web Token)æ˜¯ä¸€ç§å¹¿æ³›ä½¿ç”¨çš„ç”¨æˆ·è®¤è¯æ–¹æ¡ˆï¼Œå› å…¶æ— çŠ¶æ€ã€è·¨åŸŸæ”¯æŒå’Œçµæ´»æ€§è€Œå—åˆ°æ¬¢è¿ã€‚æœ¬æ–‡å°†ç»“åˆå®é™…ä»£ç ï¼Œè¯¦ç»†è®²è§£å¦‚ä½•åœ¨Go é¡¹ç›®ä¸­å®ç° JWT è®¤è¯æœºåˆ¶ï¼Œå¹¶æ¢è®¨ä¸¤ç§å¸¸è§çš„ Token ç»­æœŸç­–ç•¥ï¼šè‡ªåŠ¨ç»­æœŸå’ŒRefresh Tokenã€‚</p><h2 id="jwt-åŸºç¡€æ¦‚å¿µ">1. JWT åŸºç¡€æ¦‚å¿µ</h2><p>JWT ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šHeaderã€Payload å’Œ Signatureã€‚ä½¿ç”¨ JWTè¿›è¡Œç™»å½•è®¤è¯çš„åŸºæœ¬å·¥ä½œæµç¨‹æ˜¯ï¼š</p><ol type="1"><li>ç”¨æˆ·ç™»å½•æˆåŠŸåï¼ŒæœåŠ¡å™¨ç”Ÿæˆ JWTã€‚</li><li>æœåŠ¡å™¨å°† token è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</li><li>å®¢æˆ·ç«¯åç»­è¯·æ±‚æºå¸¦ tokenã€‚</li><li>æœåŠ¡å™¨éªŒè¯ token çš„æœ‰æ•ˆæ€§ã€‚</li></ol><p>æˆ‘ä»¬å¯ä»¥åœ¨ https://jwt.io/ ç½‘ç«™å¯¹ JWTè¿›è¡Œåˆ†æï¼ŒæŸ¥çœ‹å…¶å…·ä½“çš„ç»„æˆæˆåˆ†ã€‚</p><h2 id="åŸºæœ¬å‡†å¤‡">2. åŸºæœ¬å‡†å¤‡</h2><p>åœ¨æœ¬ç¯‡ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Go è¯­è¨€ï¼Œé€šè¿‡ä¸€ä¸ªå®Œæ•´çš„æ¡ˆä¾‹å®ç°åœ¨ HTTPæ¥å£ä¸­ï¼Œä½¿ç”¨ JWT è¿›è¡Œç”¨æˆ·ç™»å½•å’Œè®¤è¯æµç¨‹ã€‚æœ¬æ–‡å‡è®¾è¯»è€…å·²æŒæ¡åŸºæœ¬çš„ Goè¯­è¨€è¯­æ³•å’Œç½‘ç»œç¼–ç¨‹ç»éªŒï¼Œå¹¶å¯¹ <ahref="https://github.com/gin-gonic/gin">Gin</a> æ¡†æ¶æœ‰åŸºæœ¬çš„äº†è§£ã€‚</p><p>ä¸ºäº†å¿«é€Ÿå“åº”å¤±è´¥ï¼Œæœ¬æ–‡æ¡ˆä¾‹ä¸­ä½¿ç”¨äº†å°è£…å¥½çš„å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> utils<br><br><span class="hljs-keyword">var</span> (<br>ErrUser = errors.New(<span class="hljs-string">&quot;&quot;</span>)<br>ErrSys  = errors.New(<span class="hljs-string">&quot;&quot;</span>)<br>)<br><br><span class="hljs-comment">// å®šä¹‰ç”¨æˆ·ä¾§é”™è¯¯ï¼Œä¼šç›´æ¥å°†é”™è¯¯å†…å®¹è¿”å›ç»™ç”¨æˆ·ï¼Œä¸æ‰“å°æ—¥å¿—ã€‚</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">UserErr</span><span class="hljs-params">(msg <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">error</span> &#123;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;%w%v&quot;</span>, ErrUser, msg)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">UserErrf</span><span class="hljs-params">(format <span class="hljs-type">string</span>, a ...any)</span></span> <span class="hljs-type">error</span> &#123;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;%w%v&quot;</span>, ErrUser, fmt.Sprintf(format, a...))<br>&#125;<br><br><span class="hljs-comment">// å®šä¹‰ç³»ç»Ÿå†…éƒ¨é”™è¯¯ï¼Œä¼šå›ºå®šè¿”å› internal server error ç»™ç”¨æˆ·ï¼Œä½†æ˜¯ä¼šå°†åŸå§‹é”™è¯¯ä¿¡æ¯è¾“å‡ºåˆ°æ—¥å¿—ä¸­ï¼Œä¾¿äºå†…éƒ¨æ’æŸ¥ã€‚</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SystemErr</span><span class="hljs-params">(err <span class="hljs-type">error</span>)</span></span> <span class="hljs-type">error</span> &#123;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;%w%v&quot;</span>, ErrSys, err)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SystemErrf</span><span class="hljs-params">(format <span class="hljs-type">string</span>, a ...any)</span></span> <span class="hljs-type">error</span> &#123;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;%w%v&quot;</span>, ErrSys, fmt.Sprintf(format, a...))<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GinErr</span><span class="hljs-params">(c *gin.Context, req any, err <span class="hljs-type">error</span>, msgs ...<span class="hljs-type">string</span>)</span></span> &#123;<br><span class="hljs-keyword">if</span> errors.Is(err, ErrUser) &#123;<br>c.JSON(http.StatusOK, err.Error())<br><span class="hljs-keyword">return</span><br>&#125;<br><br>msg := <span class="hljs-string">&quot;internal server error&quot;</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(msgs) &gt; <span class="hljs-number">0</span> &#123;<br>msg = msgs[<span class="hljs-number">0</span>]<br>&#125;<br>slog.Error(msg,<br>slog.Any(<span class="hljs-string">&quot;req&quot;</span>, req),<br>slog.String(<span class="hljs-string">&quot;err&quot;</span>, err.Error()),<br>)<br>c.JSON(http.StatusOK, <span class="hljs-string">&quot;internal server error&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å®ç°ç”¨æˆ·è®¤è¯">3. å®ç°ç”¨æˆ·è®¤è¯</h2><p>åœ¨è¿›è¡Œå®é™…ä»£ç ç¼–å†™ä¹‹å‰ï¼Œä½ éœ€è¦å…ˆåˆå§‹åŒ–å¥½é¡¹ç›®å¹¶å¼•å…¥ <code>jwt</code>ä¾èµ–ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">go get -u github.com/golang-jwt/jwt/v5<br></code></pre></td></tr></table></figure><p>åœ¨ä»£ç ä¸­ä½¿ç”¨çš„æ—¶å€™ï¼Œå¯ä»¥ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;github.com/golang-jwt/jwt/v5&quot;</span><br></code></pre></td></tr></table></figure><p>é‚£æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ­£å¼å¼€å§‹æˆ‘ä»¬çš„åŠŸèƒ½å®ç°ã€‚</p><h3 id="å®šä¹‰-claims-ç»“æ„">3.1 å®šä¹‰ Claims ç»“æ„</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ JWT çš„è½½è·ï¼ˆPayloadï¼‰ç»“æ„ï¼Œå³å†³å®šå°†ä»€ä¹ˆä¿¡æ¯å­˜å‚¨åœ¨token å½“ä¸­ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> UserClaims <span class="hljs-keyword">struct</span> &#123;<br>    jwt.RegisteredClaims<br>    UserID    <span class="hljs-type">uint64</span> <span class="hljs-string">`json:&quot;user_id&quot;`</span>    <span class="hljs-comment">// ç”¨æˆ·ID</span><br>    UserAgent <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;user_agent&quot;`</span>  <span class="hljs-comment">// ç”¨æˆ·è®¾å¤‡ä¿¡æ¯</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬ï¼š</p><ul><li><p>ç»„åˆäº† <code>jwt.RegisteredClaims</code>ï¼Œå®ƒåŒ…å«äº†æ ‡å‡†çš„ JWTå­—æ®µï¼ˆå¦‚è¿‡æœŸæ—¶é—´ï¼‰ï¼Œå¸®åŠ©æˆ‘ä»¬å®ç°äº† <code>jwt.Clamis</code> æ¥å£ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Claims <span class="hljs-keyword">interface</span> &#123;<br>GetExpirationTime() (*NumericDate, <span class="hljs-type">error</span>)<br>GetIssuedAt() (*NumericDate, <span class="hljs-type">error</span>)<br>GetNotBefore() (*NumericDate, <span class="hljs-type">error</span>)<br>GetIssuer() (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>)<br>GetSubject() (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>)<br>GetAudience() (ClaimStrings, <span class="hljs-type">error</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p><code>jwt.RegisteredClaims</code> çš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> RegisteredClaims <span class="hljs-keyword">struct</span> &#123;<br>Issuer <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;iss,omitempty&quot;`</span><br>Subject <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;sub,omitempty&quot;`</span><br>Audience ClaimStrings <span class="hljs-string">`json:&quot;aud,omitempty&quot;`</span><br>ExpiresAt *NumericDate <span class="hljs-string">`json:&quot;exp,omitempty&quot;`</span><br>NotBefore *NumericDate <span class="hljs-string">`json:&quot;nbf,omitempty&quot;`</span><br>IssuedAt *NumericDate <span class="hljs-string">`json:&quot;iat,omitempty&quot;`</span><br>ID <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;jti,omitempty&quot;`</span><br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c RegisteredClaims)</span></span> GetExpirationTime() (*NumericDate, <span class="hljs-type">error</span>) &#123;<br><span class="hljs-keyword">return</span> c.ExpiresAt, <span class="hljs-literal">nil</span><br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c RegisteredClaims)</span></span> GetNotBefore() (*NumericDate, <span class="hljs-type">error</span>) &#123;<br><span class="hljs-keyword">return</span> c.NotBefore, <span class="hljs-literal">nil</span><br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c RegisteredClaims)</span></span> GetIssuedAt() (*NumericDate, <span class="hljs-type">error</span>) &#123;<br><span class="hljs-keyword">return</span> c.IssuedAt, <span class="hljs-literal">nil</span><br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c RegisteredClaims)</span></span> GetAudience() (ClaimStrings, <span class="hljs-type">error</span>) &#123;<br><span class="hljs-keyword">return</span> c.Audience, <span class="hljs-literal">nil</span><br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c RegisteredClaims)</span></span> GetIssuer() (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) &#123;<br><span class="hljs-keyword">return</span> c.Issuer, <span class="hljs-literal">nil</span><br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c RegisteredClaims)</span></span> GetSubject() (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) &#123;<br><span class="hljs-keyword">return</span> c.Subject, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>æ·»åŠ äº†è‡ªå®šä¹‰å­—æ®µ <code>UserID</code> å’Œ <code>UserAgent</code>ç”¨äºå®‰å…¨æ§åˆ¶ã€‚ä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„ä¸šåŠ¡éœ€æ±‚ï¼Œæ·»åŠ ä»»æ„éæ•æ„Ÿä¿¡æ¯åˆ°è¿™ä¸ªç»“æ„ä¸­ã€‚</p></li></ul><h3 id="ç™»å½•æ¥å£å®ç°">3.2 ç™»å½•æ¥å£å®ç°</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">const</span> (<br>   AccessTokenDuration = time.Minute * <span class="hljs-number">15</span><br>   RefreshTokenDuration = time.Hour * <span class="hljs-number">24</span> * <span class="hljs-number">7</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(u *UserHandler)</span></span> LoginJWT(ctx *gin.Context) &#123;<br>    <span class="hljs-comment">// 1. æ ¡éªŒç”¨æˆ·ä¿¡æ¯ï¼Œåœ¨æœ¬æ¡ˆä¾‹ä¸­ï¼Œä½¿ç”¨é‚®ç®±åŠ å¯†ç è¿›è¡Œç™»å½•</span><br>    user, err := u.svc.Login(ctx.Request.Context(), req.Email, req.Password)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        utils.GinErr(ctx, req, utils.UserErr(err), <span class="hljs-string">&quot;login failed&quot;</span>)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    <span class="hljs-comment">// 2. åˆ›å»º JWT Claims</span><br>    accessClaims := UserClaims&#123;<br>        UserID:    user.ID,<br>        UserAgent: ctx.Request.UserAgent(),<br>        RegisteredClaims: jwt.RegisteredClaims&#123;<br>            ExpiresAt: jwt.NewNumericDate(time.Now().Add(AccessTokenDuration)), <span class="hljs-comment">// 15åˆ†é’Ÿè¿‡æœŸ</span><br>        &#125;,<br>    &#125;<br><br>    <span class="hljs-comment">// 3. ç”Ÿæˆ Access Token</span><br>    accessToken := jwt.NewWithClaims(jwt.SigningMethodHS512, accessClaims)<br>    accessTokenStr, err := accessToken.SignedString(AccessTokenKey)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        utils.GinErr(ctx, req, utils.SystemErr(err), <span class="hljs-string">&quot;generate access token failed&quot;</span>)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    <span class="hljs-comment">// 4. ç”Ÿæˆ Refresh Tokenï¼Œç”¨äº Token ç»­æœŸ</span><br>    refreshClaims := RefreshClaims&#123;<br>        UserID:    user.ID,<br>        UserAgent: ctx.Request.UserAgent(),<br>        RegisteredClaims: jwt.RegisteredClaims&#123;<br>            ExpiresAt: jwt.NewNumericDate(time.Now().Add(RefreshTokenDuration)), <span class="hljs-comment">// 7å¤©è¿‡æœŸ</span><br>        &#125;,<br>    &#125;<br>    refreshToken := jwt.NewWithClaims(jwt.SigningMethodHS512, refreshClaims)<br>    refreshTokenStr, err := refreshToken.SignedString(RefreshTokenKey)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        utils.GinErr(ctx, req, utils.SystemErr(err), <span class="hljs-string">&quot;generate refresh token failed&quot;</span>)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    <span class="hljs-comment">// 5. è¿”å›ä¸¤ä¸ª token</span><br>    ctx.Header(<span class="hljs-string">&quot;x-jwt-token&quot;</span>, accessTokenStr)<br>    ctx.Header(<span class="hljs-string">&quot;x-refresh-token&quot;</span>, refreshTokenStr)<br>    ctx.JSON(http.StatusOK, <span class="hljs-string">&quot;login success&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="jwt-ä¸­é—´ä»¶å®ç°">3.3 JWT ä¸­é—´ä»¶å®ç°</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> LoginJWTMiddlewareBuilder <span class="hljs-keyword">struct</span> &#123;<br>whiteList []<span class="hljs-type">string</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewLoginJWTMiddlewareBuilder</span><span class="hljs-params">()</span></span> *LoginJWTMiddlewareBuilder &#123;<br><span class="hljs-keyword">return</span> &amp;LoginJWTMiddlewareBuilder&#123;<br>whiteList: []<span class="hljs-type">string</span>&#123;&#125;,<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *LoginJWTMiddlewareBuilder)</span></span> IgnorePaths(paths ...<span class="hljs-type">string</span>) *LoginJWTMiddlewareBuilder &#123;<br>b.whiteList = <span class="hljs-built_in">append</span>(b.whiteList, paths...)<br><span class="hljs-keyword">return</span> b<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *LoginJWTMiddlewareBuilder)</span></span> Build() gin.HandlerFunc &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx *gin.Context)</span></span> &#123;<br>        <span class="hljs-comment">// 1. æå– token</span><br>        authCode := ctx.GetHeader(<span class="hljs-string">&quot;Authorization&quot;</span>)<br>        tokenStr := strings.TrimPrefix(authCode, <span class="hljs-string">&quot;Bearer &quot;</span>)<br><br>        <span class="hljs-comment">// 2. è§£æå’ŒéªŒè¯ token</span><br>        uc := web.UserClaims&#123;&#125;<br>        token, err := jwt.ParseWithClaims(tokenStr, &amp;uc, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(token *jwt.Token)</span></span> (<span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-type">error</span>) &#123;<br>            <span class="hljs-keyword">return</span> web.AccessTokenKey, <span class="hljs-literal">nil</span><br>        &#125;)<br><br>        <span class="hljs-comment">// 3. éªŒè¯ token æœ‰æ•ˆæ€§</span><br>        <span class="hljs-keyword">if</span> token == <span class="hljs-literal">nil</span> || !token.Valid &#123;<br>            ctx.AbortWithStatus(http.StatusUnauthorized)<br>            <span class="hljs-keyword">return</span><br>        &#125;<br><br>        <span class="hljs-comment">// 4. éªŒè¯ UserAgent</span><br>        <span class="hljs-keyword">if</span> uc.UserAgent != ctx.Request.UserAgent() &#123;<br>            ctx.AbortWithStatus(http.StatusUnauthorized)<br>            <span class="hljs-keyword">return</span><br>        &#125;<br><br>        <span class="hljs-comment">// 5. è®¾ç½®ç”¨æˆ·ä¿¡æ¯åˆ°ä¸Šä¸‹æ–‡</span><br>        ctx.Set(<span class="hljs-string">&quot;user_id&quot;</span>, uc.UserID)<br>      ctx.Set(<span class="hljs-string">&quot;claims&quot;</span>, uc)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ³¨å†Œä¸­é—´ä»¶">3.4 æ³¨å†Œä¸­é—´ä»¶</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">initWebServer</span><span class="hljs-params">()</span></span> *gin.Engine &#123;<br>server := gin.Default()<br><br>server.Use(<br>middleware.CORS(),<br>middleware.NewLoginJWTMiddlewareBuilder().<br>IgnorePaths(<span class="hljs-string">&quot;/users/signup&quot;</span>).<br>IgnorePaths(<span class="hljs-string">&quot;/users/login&quot;</span>).<br>Build(),<br>)<br>web.RegisterRoutes(server)<br><span class="hljs-keyword">return</span> server<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">RegisterRoutes</span><span class="hljs-params">(server *gin.Engine)</span></span> &#123;<br>  <span class="hljs-comment">// ...</span><br>userHandler.RegisterRoutes(server)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(u *UserHandler)</span></span> RegisterRoutes(server *gin.Engine) &#123;<br>  ur := server.Group(<span class="hljs-string">&quot;/users&quot;</span>)<br>  ur.POST(<span class="hljs-string">&quot;/login&quot;</span>, u.LoginJWT)<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="åœ¨å…¶ä»–æ¥å£ä¸­ä½¿ç”¨-token-çš„ç›¸å…³ä¿¡æ¯">4. åœ¨å…¶ä»–æ¥å£ä¸­ä½¿ç”¨ Tokençš„ç›¸å…³ä¿¡æ¯</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(u *UserHandler)</span></span> Profile(ctx *gin.Context) &#123;<br>  <span class="hljs-comment">// å¯ä»¥è·å– user_id</span><br>userID := ctx.GetUint64(<span class="hljs-string">&quot;user_id&quot;</span>)<br>  <span class="hljs-comment">// ä¹Ÿå¯ä»¥ç›´æ¥è·å–æ•´ä¸ª claimsã€‚</span><br>  <span class="hljs-comment">// è¿™é‡Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ä¸è¿›è¡Œæ–­è¨€ï¼Œå› ä¸ºç†è®ºä¸Šæˆ‘ä»¬çš„å¯ä»¥ä¿è¯è¿™é‡Œé€šè¿‡æ–­è¨€ã€‚</span><br>  <span class="hljs-comment">// å¦‚æœè¿™é‡Œå‘ç”Ÿ panic äº†ï¼Œåˆ™è¯´æ˜æˆ‘ä»¬çš„å†…éƒ¨é€»è¾‘æ²¡æœ‰å½¢æˆé—­ç¯ï¼Œå­˜åœ¨é—®é¢˜ã€‚</span><br>  <span class="hljs-comment">// panic å¯ä»¥ç¬¬ä¸€æ—¶é—´æš´éœ²é—®é¢˜ï¼Œç„¶åè¢«è§£å†³æ‰ã€‚</span><br>  <span class="hljs-comment">// ä¸è¿‡è¿™ä¸ªæ—¶å€™å»ºè®®ä½ ä½¿ç”¨ gin çš„ recover ä¸­é—´ä»¶è¿›è¡Œå…¨å±€ä¿æŠ¤ï¼Œé¿å…æ•´ä¸ªæœåŠ¡å› ä¸º panic è€Œå®•æœºã€‚</span><br>  uc, _ := ctx.Get(<span class="hljs-string">&quot;claims&quot;</span>)<br>userClaims := uc.(*UserClaims)<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="refresh-token-æœºåˆ¶">5. Refresh Token æœºåˆ¶</h2><h3 id="æ·»åŠ åˆ·æ–°-token-æ¥å£">5.1 æ·»åŠ åˆ·æ–° Token æ¥å£</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(u *UserHandler)</span></span> RefreshToken(ctx *gin.Context) &#123;<br>    <span class="hljs-comment">// ä»è¯·æ±‚å¤´è·å– Refresh Token</span><br>    refreshTokenStr := ctx.GetHeader(<span class="hljs-string">&quot;x-refresh-token&quot;</span>)<br>    <span class="hljs-keyword">if</span> refreshTokenStr == <span class="hljs-string">&quot;&quot;</span> &#123;<br>        ctx.AbortWithStatus(http.StatusUnauthorized)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    <span class="hljs-comment">// è§£æå’ŒéªŒè¯ Refresh Token</span><br>    <span class="hljs-keyword">var</span> refreshClaims RefreshClaims<br>    refreshToken, err := jwt.ParseWithClaims(refreshTokenStr, &amp;refreshClaims, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(token *jwt.Token)</span></span> (<span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-type">error</span>) &#123;<br>        <span class="hljs-keyword">return</span> RefreshTokenKey, <span class="hljs-literal">nil</span><br>    &#125;)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> || !refreshToken.Valid &#123;<br>        ctx.AbortWithStatus(http.StatusUnauthorized)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    <span class="hljs-comment">// éªŒè¯ User Agent</span><br>    <span class="hljs-keyword">if</span> refreshClaims.UserAgent != ctx.Request.UserAgent() &#123;<br>        ctx.AbortWithStatus(http.StatusUnauthorized)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    <span class="hljs-comment">// ç”Ÿæˆæ–°çš„ Access Token</span><br>    accessClaims := UserClaims&#123;<br>        UserID:    refreshClaims.UserID,<br>        UserAgent: ctx.Request.UserAgent(),<br>        RegisteredClaims: jwt.RegisteredClaims&#123;<br>            ExpiresAt: jwt.NewNumericDate(time.Now().Add(AccessTokenDuration)),<br>        &#125;,<br>    &#125;<br>    newAccessToken := jwt.NewWithClaims(jwt.SigningMethodHS512, accessClaims)<br>    newAccessTokenStr, err := newAccessToken.SignedString(AccessTokenKey)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        utils.GinErr(ctx, <span class="hljs-literal">nil</span>, utils.SystemErr(err), <span class="hljs-string">&quot;generate new access token failed&quot;</span>)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>  <span class="hljs-comment">// å¯¹ Refresh Token è¿›è¡Œç»­æœŸ</span><br>  refreshClaims := RefreshClaims&#123;<br>        UserID:    user.ID,<br>        UserAgent: ctx.Request.UserAgent(),<br>        RegisteredClaims: jwt.RegisteredClaims&#123;<br>            ExpiresAt: jwt.NewNumericDate(time.Now().Add(RefreshTokenDuration)), <span class="hljs-comment">// 7å¤©è¿‡æœŸ</span><br>        &#125;,<br>    &#125;<br>    newRefreshToken := jwt.NewWithClaims(jwt.SigningMethodHS512, refreshClaims)<br>    newRefreshTokenStr, err := newRefreshToken.SignedString(RefreshTokenKey)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        utils.GinErr(ctx, req, utils.SystemErr(err), <span class="hljs-string">&quot;generate new refresh token failed&quot;</span>)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br><br>    <span class="hljs-comment">// è¿”å›æ–°çš„ Access Token å’Œç»­æœŸåçš„ Refresh Token</span><br>    ctx.Header(<span class="hljs-string">&quot;x-jwt-token&quot;</span>, newAccessTokenStr)<br>   ctx.Header(<span class="hljs-string">&quot;x-refresh-token&quot;</span>, newRefreshTokenStr)<br>    ctx.JSON(http.StatusOK, <span class="hljs-string">&quot;token refreshed&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ³¨å†Œè·¯ç”±">5.2 æ³¨å†Œè·¯ç”±</h3><p>åœ¨ <code>RegisterRoutes</code> æ–¹æ³•ä¸­æ·»åŠ æ–°è·¯ç”±ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(u *UserHandler)</span></span> RegisterRoutes(server *gin.Engine) &#123;<br>  ur := server.Group(<span class="hljs-string">&quot;/users&quot;</span>)<br>  ur.POST(<span class="hljs-string">&quot;/login&quot;</span>, u.LoginJWT)<br>  ur.GET(<span class="hljs-string">&quot;/profile&quot;</span>, u.Profile)<br>  ur.POST(<span class="hljs-string">&quot;/refresh&quot;</span>, u.RefreshToken)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å®¢æˆ·ç«¯ä½¿ç”¨æµç¨‹">6. å®¢æˆ·ç«¯ä½¿ç”¨æµç¨‹</h2><ol type="1"><li>ç™»å½•åè·å– Access Token å’Œ Refresh Token</li><li>ä½¿ç”¨ Access Token è®¿é—®å—ä¿æŠ¤èµ„æº</li><li>å½“ Access Token è¿‡æœŸæ—¶è°ƒç”¨ /refresh æ¥å£è·å–æ–°çš„ Access Token</li><li>ä½¿ç”¨æ–°çš„ Access Token ç»§ç»­è®¿é—®</li></ol><p>åˆ·æ–° token çš„å®¢æˆ·ç«¯ç¤ºä¾‹ä»£ç ï¼ˆç¬”è€…å¹¶ä¸æ“…é•¿å†™å‰ç«¯ä»£ç  hhhï¼Œæ‰€ä»¥è¿™æ˜¯è®©ChatGPT å¸®å¿™å†™çš„ ğŸ˜„ï¼‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go">async function refreshAccessToken() &#123;<br>    <span class="hljs-keyword">const</span> response = await fetch(<span class="hljs-string">&#x27;/users/refresh&#x27;</span>, &#123;<br>        method: <span class="hljs-string">&#x27;POST&#x27;</span>,<br>        headers: &#123;<br>            <span class="hljs-string">&#x27;x-refresh-token&#x27;</span>: localStorage.getItem(<span class="hljs-string">&#x27;refreshToken&#x27;</span>)<br>        &#125;<br>    &#125;);<br><br>    <span class="hljs-keyword">if</span> (response.ok) &#123;<br>        <span class="hljs-keyword">const</span> newAccessToken = response.headers.get(<span class="hljs-string">&#x27;x-jwt-token&#x27;</span>);<br>        localStorage.setItem(<span class="hljs-string">&#x27;accessToken&#x27;</span>, newAccessToken);<br>        <span class="hljs-keyword">const</span> newRefreshToken = response.headers.get(<span class="hljs-string">&#x27;x-refresh-token&#x27;</span>);<br>        localStorage.setItem(<span class="hljs-string">&#x27;refreshToken&#x27;</span>, newRefreshToken);<br>        <span class="hljs-keyword">return</span> newAccessToken;<br>    &#125;<br><br>    <span class="hljs-comment">// å¦‚æœåˆ·æ–°å¤±è´¥ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ</span><br>    window.location.href = <span class="hljs-string">&#x27;/login&#x27;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="token-ç»­æœŸç­–ç•¥å¯¹æ¯”">7. Token ç»­æœŸç­–ç•¥å¯¹æ¯”</h2><p>åœ¨å‰é¢æ¡ˆä¾‹ä¸­ï¼Œç»†å¿ƒçš„è¯»è€…å¯ä»¥è§‚å¯Ÿåˆ°æˆ‘ä»¬å¯¹ <code>AccessToken</code> å’Œ<code>RefreshToken</code> åˆ†åˆ«é‡‡ç”¨äº† 2 ç§ä¸åŒçš„ç»­æœŸç­–ç•¥ã€‚</p><h3 id="è‡ªåŠ¨ç»­æœŸ">è‡ªåŠ¨ç»­æœŸ</h3><p><strong>ä¼˜ç‚¹ï¼š</strong></p><ul><li>ç®€å•æ˜“ç”¨ï¼šåœ¨æ¯æ¬¡è¯·æ±‚æ—¶è‡ªåŠ¨æ£€æŸ¥å¹¶ç»­æœŸ Tokenï¼Œç”¨æˆ·ä½“éªŒæµç•…ã€‚</li><li>æ— é¢å¤–å­˜å‚¨éœ€æ±‚ï¼šä¸éœ€è¦å­˜å‚¨ RefreshTokenï¼Œå‡å°‘äº†å­˜å‚¨å’Œç®¡ç†çš„å¤æ‚æ€§</li></ul><p><strong>ç¼ºç‚¹ï¼š</strong></p><ul><li>å®‰å…¨æ€§è¾ƒä½ï¼šå¦‚æœ Tokenè¢«ç›—ç”¨ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡è‡ªåŠ¨ç»­æœŸä¿æŒé•¿æ—¶é—´çš„è®¿é—®ã€‚</li><li>Token è¿‡æœŸæ—¶é—´ä¸å›ºå®šï¼šToken çš„æœ‰æ•ˆæœŸä¼šä¸æ–­å»¶é•¿ï¼Œéš¾ä»¥æ§åˆ¶ã€‚</li></ul><h3 id="refresh-token">Refresh Token</h3><p><strong>ä¼˜ç‚¹ï¼š</strong></p><ul><li>æ›´é«˜çš„å®‰å…¨æ€§ï¼šå³ä½¿ Access Tokenè¢«ç›—ç”¨ï¼Œæ”»å‡»è€…ä¹Ÿæ— æ³•ç»­æœŸï¼Œé™¤éåŒæ—¶è·å– Refresh Tokenã€‚</li><li>å¯æ§çš„ Token ç”Ÿå‘½å‘¨æœŸï¼šAccess Token æœ‰å›ºå®šçš„çŸ­æœŸæœ‰æ•ˆæœŸï¼ŒRefreshToken æœ‰è¾ƒé•¿çš„æœ‰æ•ˆæœŸã€‚</li><li>æ”¯æŒ Token æ’¤é”€ï¼šå¯ä»¥å®ç° Refresh Tokençš„é»‘åå•æœºåˆ¶ï¼Œæ”¯æŒæ‰‹åŠ¨æ’¤é”€ã€‚</li></ul><p><strong>ç¼ºç‚¹ï¼š</strong></p><ul><li>å®ç°å¤æ‚åº¦è¾ƒé«˜ï¼šéœ€è¦é¢å¤–çš„æ¥å£å’Œé€»è¾‘æ¥å¤„ç† Refresh Tokenã€‚</li><li>å­˜å‚¨éœ€æ±‚ï¼šéœ€è¦å®‰å…¨å­˜å‚¨ Refresh Tokenï¼Œå¯èƒ½éœ€è¦æ•°æ®åº“æ”¯æŒã€‚</li></ul><h2 id="æ€»ç»“">8. æ€»ç»“</h2><p>JWT å®ç°ç”¨æˆ·è®¤è¯çš„ä¼˜åŠ¿åœ¨äºæ— çŠ¶æ€ã€è·¨åŸŸæ”¯æŒå’Œçµæ´»æ€§ã€‚é€šè¿‡åˆç†ä½¿ç”¨ JWTå’Œé€‰æ‹©åˆé€‚çš„ Tokenç»­æœŸç­–ç•¥ï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºå®‰å…¨ã€å¯é çš„ç”¨æˆ·è®¤è¯ç³»ç»Ÿã€‚å¸Œæœ›æœ¬æ–‡èƒ½å¸®åŠ©æ‚¨åœ¨ Goé¡¹ç›®ä¸­æ›´å¥½åœ°å®ç° JWT è®¤è¯ã€‚</p>]]></content>
    
    
    <summary type="html">æœ¬æ–‡å°†ç»“åˆå®é™…ä»£ç ï¼Œè¯¦ç»†è®²è§£å¦‚ä½•åœ¨ Go é¡¹ç›®ä¸­å®ç° JWT è®¤è¯æœºåˆ¶ï¼Œå¹¶æ¢è®¨ä¸¤ç§å¸¸è§çš„ Token ç»­æœŸç­–ç•¥ï¼šè‡ªåŠ¨ç»­æœŸå’Œ Refresh Tokenã€‚</summary>
    
    
    
    <category term="Go" scheme="https://hedon.top/categories/Go/"/>
    
    <category term="Go å®æˆ˜" scheme="https://hedon.top/categories/Go/Go-%E5%AE%9E%E6%88%98/"/>
    
    
    <category term="Go" scheme="https://hedon.top/tags/Go/"/>
    
    <category term="JWT" scheme="https://hedon.top/tags/JWT/"/>
    
    <category term="Go å®æˆ˜" scheme="https://hedon.top/tags/Go-%E5%AE%9E%E6%88%98/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥ Go è¯­è¨€æ ¸å¿ƒï¼šmap å’Œ slice çš„ä¼ å‚æœ‰ä»€ä¹ˆä¸åŒ</title>
    <link href="https://hedon.top/2025/02/14/go-slice-vs-map/"/>
    <id>https://hedon.top/2025/02/14/go-slice-vs-map/</id>
    <published>2025-02-14T07:34:05.000Z</published>
    <updated>2025-02-16T01:37:39.094Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ Go å¼€å‘ä¸­ï¼Œç»å¸¸ä¼šé‡åˆ°éœ€è¦åœ¨å‡½æ•°ä¸­ä¿®æ”¹ map æˆ– sliceçš„åœºæ™¯ã€‚è™½ç„¶å®ƒä»¬éƒ½æ”¯æŒåŠ¨æ€æ‰©å®¹ï¼Œä½†åœ¨å‡½æ•°ä¼ å‚æ—¶çš„è¡Œä¸ºå´å¤§ä¸ç›¸åŒã€‚ä»Šå¤©ï¼Œè®©æˆ‘ä»¬é€šè¿‡å®ä¾‹æ·±å…¥ç†è§£è¿™ä¸ªé—®é¢˜ã€‚</p><h2 id="ä¸€ä¸ªå›°æƒ‘çš„å¼€å§‹">ä¸€ä¸ªå›°æƒ‘çš„å¼€å§‹</h2><p>çœ‹è¿™æ ·ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-comment">// Map ç¤ºä¾‹</span><br>    m := <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int</span>&#123;<span class="hljs-string">&quot;old&quot;</span>: <span class="hljs-number">1</span>&#125;<br>    modifyMap(m)<br>    fmt.Println(m) <span class="hljs-comment">// è¾“å‡º: map[new:1]</span><br><br>    <span class="hljs-comment">// Slice ç¤ºä¾‹</span><br>    s := []<span class="hljs-type">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>&#125;<br>    modifySlice(s)<br>    fmt.Println(s) <span class="hljs-comment">// è¾“å‡º: [100 2 3]ï¼Œè€Œä¸æ˜¯ [100 2 3 200]</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">modifyMap</span><span class="hljs-params">(m <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int</span>)</span></span> &#123;<br>    m[<span class="hljs-string">&quot;new&quot;</span>] = <span class="hljs-number">1</span>        <span class="hljs-comment">// ä¼šå½±å“åŸå§‹ map</span><br>    <span class="hljs-built_in">delete</span>(m, <span class="hljs-string">&quot;old&quot;</span>)    <span class="hljs-comment">// ä¹Ÿä¼šå½±å“åŸå§‹ map</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">modifySlice</span><span class="hljs-params">(s []<span class="hljs-type">int</span>)</span></span> &#123;<br>    s[<span class="hljs-number">0</span>] = <span class="hljs-number">100</span>          <span class="hljs-comment">// ä¼šå½±å“åŸå§‹ slice</span><br>    s = <span class="hljs-built_in">append</span>(s, <span class="hljs-number">200</span>)  <span class="hljs-comment">// ä¸ä¼šå½±å“åŸå§‹ slice</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æœ‰è¶£çš„æ˜¯ï¼š</p><ol type="1"><li>map çš„æ‰€æœ‰æ“ä½œéƒ½ä¼šå½±å“åŸå§‹æ•°æ®</li><li>slice çš„ç®€å•ç´¢å¼•ä¿®æ”¹ä¼šå½±å“åŸå§‹æ•°æ®ï¼Œä½† append å¯èƒ½ä¸ä¼š</li></ol><p>ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿè®©æˆ‘ä»¬ä»å†…éƒ¨ç»“æ„å¼€å§‹åˆ†æã€‚</p><h2 id="å†…éƒ¨ç»“æ„è§£æ">å†…éƒ¨ç»“æ„è§£æ</h2><h3 id="map-çš„å†…éƒ¨ç»“æ„">Map çš„å†…éƒ¨ç»“æ„</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> hmap <span class="hljs-keyword">struct</span> &#123;<br>    count      <span class="hljs-type">int</span>            <span class="hljs-comment">// å…ƒç´ ä¸ªæ•°</span><br>    flags      <span class="hljs-type">uint8</span>          <span class="hljs-comment">// çŠ¶æ€æ ‡å¿—</span><br>    B          <span class="hljs-type">uint8</span>          <span class="hljs-comment">// æ¡¶çš„å¯¹æ•° B</span><br>    buckets    unsafe.Pointer <span class="hljs-comment">// æŒ‡å‘æ¡¶æ•°ç»„çš„æŒ‡é’ˆ</span><br>    <span class="hljs-comment">// ... å…¶ä»–å­—æ®µ</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬å£°æ˜ä¸€ä¸ª map å˜é‡æ—¶ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">m := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int</span>)<br><span class="hljs-comment">// å®é™…ä¸Š m æ˜¯ *hmapï¼Œå³æŒ‡å‘ hmap ç»“æ„çš„æŒ‡é’ˆ</span><br></code></pre></td></tr></table></figure><h3 id="slice-çš„å†…éƒ¨ç»“æ„">Slice çš„å†…éƒ¨ç»“æ„</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> slice <span class="hljs-keyword">struct</span> &#123;<br>    array unsafe.Pointer  <span class="hljs-comment">// æŒ‡å‘åº•å±‚æ•°ç»„çš„æŒ‡é’ˆ</span><br>    <span class="hljs-built_in">len</span>   <span class="hljs-type">int</span>            <span class="hljs-comment">// å½“å‰é•¿åº¦</span><br>    <span class="hljs-built_in">cap</span>   <span class="hljs-type">int</span>            <span class="hljs-comment">// å½“å‰å®¹é‡</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬å£°æ˜ä¸€ä¸ª slice å˜é‡æ—¶ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">s := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-number">0</span>, <span class="hljs-number">10</span>)<br><span class="hljs-comment">// s æ˜¯ä¸€ä¸ªå®Œæ•´çš„ slice ç»“æ„ä½“ï¼Œè€Œä¸æ˜¯æŒ‡é’ˆ</span><br></code></pre></td></tr></table></figure><h2 id="æ·±å…¥ç†è§£ä¼ å‚è¡Œä¸º">æ·±å…¥ç†è§£ä¼ å‚è¡Œä¸º</h2><h3 id="åœºæ™¯ä¸€ç®€å•ä¿®æ”¹ä¸æ¶‰åŠæ‰©å®¹">åœºæ™¯ä¸€ï¼šç®€å•ä¿®æ”¹ï¼ˆä¸æ¶‰åŠæ‰©å®¹ï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">modifyBoth</span><span class="hljs-params">(m <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int</span>, s []<span class="hljs-type">int</span>)</span></span> &#123;<br>    m[<span class="hljs-string">&quot;key&quot;</span>] = <span class="hljs-number">1</span>   <span class="hljs-comment">// é€šè¿‡æŒ‡é’ˆä¿®æ”¹åŸå§‹ map</span><br>    s[<span class="hljs-number">0</span>] = <span class="hljs-number">100</span>     <span class="hljs-comment">// é€šè¿‡æŒ‡å‘ç›¸åŒåº•å±‚æ•°ç»„çš„æŒ‡é’ˆä¿®æ”¹</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å›¾è§£ï¼š</p><figure class="highlight nim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs nim"><span class="hljs-type">Map</span>:<br>main()ä¸­çš„ m  -----&gt; hmap<span class="hljs-meta">&#123;...&#125;</span>  &lt;----- modifyBoth()ä¸­çš„ m<br>(åŒä¸€ä¸ªåº•å±‚ç»“æ„)<br><br><span class="hljs-type">Slice</span>:<br>main()ä¸­çš„ s      = slice&#123;<span class="hljs-type">array</span>: æŒ‡å‘æ•°ç»„<span class="hljs-number">1</span>, len: <span class="hljs-number">3</span>, cap: <span class="hljs-number">3</span>&#125;<br>                           |<br>                           v<br>                        [<span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span>]<br>                           ^<br>modifyBoth()ä¸­çš„ s = slice&#123;<span class="hljs-type">array</span>: æŒ‡å‘æ•°ç»„<span class="hljs-number">1</span>, len: <span class="hljs-number">3</span>, cap: <span class="hljs-number">3</span>&#125;<br></code></pre></td></tr></table></figure><h3 id="åœºæ™¯äºŒæ¶‰åŠæ‰©å®¹çš„æ“ä½œ">åœºæ™¯äºŒï¼šæ¶‰åŠæ‰©å®¹çš„æ“ä½œ</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">expandBoth</span><span class="hljs-params">(m <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int</span>, s []<span class="hljs-type">int</span>)</span></span> &#123;<br>    <span class="hljs-comment">// map æ‰©å®¹</span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++ &#123;<br>        m[fmt.Sprintf(<span class="hljs-string">&quot;key%d&quot;</span>, i)] = i<br>    &#125;<br><br>    <span class="hljs-comment">// slice æ‰©å®¹</span><br>    s = <span class="hljs-built_in">append</span>(s, <span class="hljs-number">200</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>å›¾è§£ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">Map</span> <span class="hljs-string">æ‰©å®¹è¿‡ç¨‹ï¼š</span><br><span class="hljs-attr">Before:</span><br><span class="hljs-string">main()ä¸­çš„</span> <span class="hljs-string">m</span>  <span class="hljs-string">-----&gt;</span> <span class="hljs-string">hmap&#123;buckets:</span> <span class="hljs-string">æŒ‡å‘å­˜å‚¨A&#125;</span><br>                           <span class="hljs-string">^</span><br><span class="hljs-string">expandBoth()ä¸­çš„</span> <span class="hljs-string">m</span> <span class="hljs-string">---------|</span><br><br><span class="hljs-attr">After:</span><br><span class="hljs-string">main()ä¸­çš„</span> <span class="hljs-string">m</span>  <span class="hljs-string">-----&gt;</span> <span class="hljs-string">hmap&#123;buckets:</span> <span class="hljs-string">æŒ‡å‘æ›´å¤§çš„å­˜å‚¨B&#125;</span>  <span class="hljs-string">//</span> <span class="hljs-string">åŒä¸€ä¸ª</span> <span class="hljs-string">hmapï¼Œåªæ˜¯æ›´æ–°äº†å†…éƒ¨æŒ‡é’ˆ</span><br>                           <span class="hljs-string">^</span><br><span class="hljs-string">expandBoth()ä¸­çš„</span> <span class="hljs-string">m</span> <span class="hljs-string">---------|</span><br><br><br><span class="hljs-string">Slice</span> <span class="hljs-string">æ‰©å®¹è¿‡ç¨‹ï¼š</span><br><span class="hljs-attr">Before:</span><br><span class="hljs-string">main()ä¸­çš„</span> <span class="hljs-string">s</span>      <span class="hljs-string">=</span> <span class="hljs-string">slice&#123;array:</span> <span class="hljs-string">æŒ‡å‘æ•°ç»„A,</span> <span class="hljs-attr">len:</span> <span class="hljs-number">3</span><span class="hljs-string">,</span> <span class="hljs-attr">cap:</span> <span class="hljs-number">3</span><span class="hljs-string">&#125;</span><br>                           <span class="hljs-string">|</span><br><span class="hljs-string">                           v</span><br><span class="hljs-string"></span>                        [<span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span>]<br>                           <span class="hljs-string">^</span><br><span class="hljs-string">expandBoth()ä¸­çš„</span> <span class="hljs-string">s</span> <span class="hljs-string">=</span> <span class="hljs-string">slice&#123;array:</span> <span class="hljs-string">æŒ‡å‘æ•°ç»„A,</span> <span class="hljs-attr">len:</span> <span class="hljs-number">3</span><span class="hljs-string">,</span> <span class="hljs-attr">cap:</span> <span class="hljs-number">3</span><span class="hljs-string">&#125;</span><br><br><span class="hljs-attr">After append:</span><br><span class="hljs-string">main()ä¸­çš„</span> <span class="hljs-string">s</span>      <span class="hljs-string">=</span> <span class="hljs-string">slice&#123;array:</span> <span class="hljs-string">æŒ‡å‘æ•°ç»„A,</span> <span class="hljs-attr">len:</span> <span class="hljs-number">3</span><span class="hljs-string">,</span> <span class="hljs-attr">cap:</span> <span class="hljs-number">3</span><span class="hljs-string">&#125;</span>     <span class="hljs-string">//</span> <span class="hljs-string">ä¿æŒä¸å˜</span><br>                           <span class="hljs-string">|</span><br><span class="hljs-string">                           v</span><br><span class="hljs-string"></span>                        [<span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span>]<br><br><span class="hljs-string">expandBoth()ä¸­çš„</span> <span class="hljs-string">s</span> <span class="hljs-string">=</span> <span class="hljs-string">slice&#123;array:</span> <span class="hljs-string">æŒ‡å‘æ•°ç»„B,</span> <span class="hljs-attr">len:</span> <span class="hljs-number">4</span><span class="hljs-string">,</span> <span class="hljs-attr">cap:</span> <span class="hljs-number">6</span><span class="hljs-string">&#125;</span>    <span class="hljs-string">//</span> <span class="hljs-string">æ–°çš„ç»“æ„ä½“ï¼ŒæŒ‡å‘æ–°æ•°ç»„</span><br>                           <span class="hljs-string">|</span><br><span class="hljs-string">                           v</span><br><span class="hljs-string"></span>                     [<span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">200</span>]<br></code></pre></td></tr></table></figure><h2 id="å…³é”®åŒºåˆ«è§£æ">å…³é”®åŒºåˆ«è§£æ</h2><ol type="1"><li><p><strong>ä¼ é€’æ–¹å¼ä¸åŒ</strong>ï¼š</p><ul><li>map ä¼ é€’çš„æ˜¯æŒ‡é’ˆï¼Œå‡½æ•°å†…å¤–ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ª hmap ç»“æ„</li><li>slice ä¼ é€’çš„æ˜¯ç»“æ„ä½“å‰¯æœ¬ï¼Œå‡½æ•°å†…çš„ä¿®æ”¹å‘ç”Ÿåœ¨å‰¯æœ¬ä¸Š</li></ul></li><li><p><strong>æ‰©å®¹è¡Œä¸ºä¸åŒ</strong>ï¼š</p><ul><li>map æ‰©å®¹æ—¶ï¼ŒåŸæœ‰çš„ hmap ç»“æ„ä¿æŒä¸å˜ï¼Œåªæ›´æ–°å†…éƒ¨çš„ buckets æŒ‡é’ˆ</li><li>slice æ‰©å®¹æ—¶ï¼Œä¼šåˆ›å»ºæ–°çš„åº•å±‚æ•°ç»„ï¼Œå¹¶è¿”å›ä¸€ä¸ªæŒ‡å‘æ–°æ•°ç»„çš„æ–° sliceç»“æ„ä½“</li></ul></li><li><p><strong>ä¿®æ”¹æ•ˆæœä¸åŒ</strong>ï¼š</p><ul><li>map çš„æ‰€æœ‰æ“ä½œï¼ˆåŒ…æ‹¬æ‰©å®¹ï¼‰éƒ½ä¼šåæ˜ åˆ°åŸå§‹æ•°æ®</li><li>slice çš„è¡Œä¸ºåˆ†ä¸¤ç§æƒ…å†µï¼š<ul><li>ä¸æ¶‰åŠæ‰©å®¹çš„ä¿®æ”¹ä¼šå½±å“åŸå§‹æ•°æ®ï¼ˆå› ä¸ºæŒ‡å‘åŒä¸€ä¸ªåº•å±‚æ•°ç»„ï¼‰</li><li>æ¶‰åŠæ‰©å®¹çš„æ“ä½œï¼ˆå¦‚appendï¼‰ä¼šåˆ›å»ºæ–°çš„åº•å±‚æ•°ç»„ï¼Œä¿®æ”¹ä¸ä¼šå½±å“åŸå§‹æ•°æ®</li></ul></li></ul></li></ol><h2 id="æœ€ä½³å®è·µ">æœ€ä½³å®è·µ</h2><p>åŸºäºä»¥ä¸ŠåŸç†ï¼Œåœ¨ç¼–ç æ—¶åº”æ³¨æ„ï¼š</p><ol type="1"><li>å¯¹äº mapï¼š</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">modifyMap</span><span class="hljs-params">(m <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int</span>)</span></span> &#123;<br>    m[<span class="hljs-string">&quot;key&quot;</span>] = <span class="hljs-number">1</span>    <span class="hljs-comment">// ç›´æ¥ä¿®æ”¹å³å¯ï¼Œä¸éœ€è¦è¿”å›</span><br>&#125;<br></code></pre></td></tr></table></figure><ol start="2" type="1"><li>å¯¹äº sliceï¼š</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">modifySlice</span><span class="hljs-params">(s []<span class="hljs-type">int</span>)</span></span> []<span class="hljs-type">int</span> &#123;<br>    <span class="hljs-comment">// å¦‚æœéœ€è¦ append æˆ–å…¶ä»–å¯èƒ½å¯¼è‡´æ‰©å®¹çš„æ“ä½œ</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">append</span>(s, <span class="hljs-number">1</span>)<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨æ—¶</span><br>s = modifySlice(s)<br></code></pre></td></tr></table></figure><h2 id="æ€»ç»“">æ€»ç»“</h2><p>ç†è§£ map å’Œ slice çš„è¿™äº›å·®å¼‚ï¼Œå…³é”®åœ¨äºï¼š</p><ol type="1"><li>map æ˜¯æŒ‡é’ˆç±»å‹ï¼Œå§‹ç»ˆæŒ‡å‘åŒä¸€ä¸ª hmap ç»“æ„</li><li>slice æ˜¯ç»“æ„ä½“ï¼ŒåŒ…å«äº†æŒ‡å‘åº•å±‚æ•°ç»„çš„æŒ‡é’ˆ</li><li>æ‰©å®¹æ—¶ map åªæ›´æ–°å†…éƒ¨æŒ‡é’ˆï¼Œè€Œ slice éœ€è¦åˆ›å»ºæ–°çš„åº•å±‚æ•°ç»„</li></ol><p>è¿™ç§è®¾è®¡å„æœ‰ä¼˜åŠ¿ï¼š</p><ul><li>map çš„è¡Œä¸ºæ›´åŠ ç»Ÿä¸€å’Œç›´è§‚</li><li>slice çš„è®¾è®¡æä¾›äº†æ›´å¤šçš„çµæ´»æ€§å’Œæ§åˆ¶æƒ</li></ul><p>åœ¨å®é™…ç¼–ç¨‹ä¸­ï¼Œæ­£ç¡®ç†è§£å’Œå¤„ç†è¿™äº›å·®å¼‚ï¼Œæ˜¯å†™å‡ºå¥å£® Go ä»£ç çš„å…³é”®ã€‚</p>]]></content>
    
    
    <summary type="html">æœ¬æ–‡é€šè¿‡ä¸€ä¸ªä»¤äººå›°æƒ‘çš„ä¾‹å­å¼€å§‹ï¼Œæ¢è®¨ Go è¯­è¨€ä¸­ map å’Œ slice åŠ¨æ€æ‰©å®¹æœºåˆ¶ä¸ä¼ å‚æ—¶éœ€è¦æ³¨æ„çš„é—®é¢˜ã€‚</summary>
    
    
    
    <category term="Go" scheme="https://hedon.top/categories/Go/"/>
    
    
    <category term="Go" scheme="https://hedon.top/tags/Go/"/>
    
  </entry>
  
  <entry>
    <title>è¯»ä¹¦ç¬”è®°ä¸¨è§£å¯† QUIC/HTTP3ï¼šæœªæ¥äº’è”ç½‘çš„åŸºçŸ³</title>
    <link href="https://hedon.top/2025/01/15/book-quic-http3/"/>
    <id>https://hedon.top/2025/01/15/book-quic-http3/</id>
    <published>2025-01-15T11:17:20.000Z</published>
    <updated>2025-02-15T15:27:55.982Z</updated>
    
    <content type="html"><![CDATA[<h1 id="quic-äº§ç”ŸèƒŒæ™¯">1. QUIC äº§ç”ŸèƒŒæ™¯</h1><h2 id="å¸¸è§ç½‘ç»œåè®®">å¸¸è§ç½‘ç»œåè®®</h2><ul><li><code>UDP</code></li><li><code>TCP</code></li><li><code>SCTP</code>ï¼ˆStream Control TransmissionProtocolï¼‰ï¼šç”¨äºç”µè¯ç½‘ç»œã€‚</li><li><code>KCP</code>ï¼šåŸºäº UDPåœ¨åº”ç”¨å±‚å®ç°å¯é æ€§ä¼ è¾“ï¼Œç‰ºç‰²å¸¦å®½æ¢å–æ•ˆç‡ã€‚</li><li><code>RTP</code>ï¼ˆReal-time Transport Protocolï¼‰ï¼šä¸ RTCPé…åˆä¼ è¾“å®æ—¶æ•°æ®ï¼Œå¦‚äº¤äº’å¼éŸ³é¢‘å’Œè§†é¢‘æ•°æ®ã€‚<ul><li>RTCPï¼šä¼ è¾“æ§åˆ¶ä¿¡æ¯</li><li>RTPï¼šä¼ è¾“å®æ—¶æ•°æ®</li></ul></li></ul><h2 id="tsl-ç‰ˆæœ¬æ¼”åŒ–">TSL ç‰ˆæœ¬æ¼”åŒ–</h2><ul><li><p><code>SSLv2</code>ï¼šå®‰å…¨æ€§ä½</p></li><li><p><code>SSLv3</code>ï¼šåˆ†ä¸ºæ¡æ‰‹é˜¶æ®µå’Œæ•°æ®ä¼ è¾“é˜¶æ®µã€‚</p><ul><li>æ¡æ‰‹é˜¶æ®µå®Œæˆå¯¹ç«¯ç‚¹çš„è®¤è¯å’Œç¡®å®šä¿æŠ¤æ•°æ®ä¼ è¾“çš„å¯†é’¥ã€‚</li><li>ä¸€æ—¦ç¡®å®šäº†å¯†é’¥ï¼Œåé¢çš„æ•°æ®ä¼ è¾“å’ŒSSLåè®®è¿‡ç¨‹éƒ½å—åˆ°åŠ å¯†å’Œå®Œæ•´æ€§ä¿æŠ¤ã€‚</li></ul></li><li><p><code>TSL1.0</code>ï¼šåŸºäº SSLv3ï¼Œå­˜åœ¨ CBCï¼ˆCipher BlockChainingï¼Œå¯†æ–‡åˆ†ç»„é“¾æ¥ï¼‰åŠ å¯†å’Œè§£å¯†æ¨¡å¼æ¼æ´ï¼Œä½¿å¾—ä¸»åŠ¨æ”»å‡»è€…å¯ä»¥è§‚å¯Ÿåˆ°å½“å‰è®°å½•çš„IVï¼ˆIntiallizationVectorï¼Œåˆå§‹åŒ–å‘é‡ï¼‰ï¼ŒçŒœæµ‹ä¸€ä¸ªæ•°æ®åº“ï¼Œè¿›è¡Œæ•°æ®æ³¨å…¥ã€‚</p></li><li><p><code>TSL1.1</code>ï¼šä¿®å¤äº† TSL1.0 çš„ä¸€äº›å…³é”®å®‰å…¨é—®é¢˜ï¼š</p><ul><li>BC åŠ å¯†ä½¿ç”¨æ¯æ¡è®°å½•ä¸€ä¸ªçš„æ˜¾å¼IVï¼›</li><li>ä¸ºäº†é˜²æ­¢ CBC å¡«å……æ”»å‡»ï¼Œä½¿ç”¨ bad_record_mac é”™è¯¯ç ä»£æ›¿decryption_failed å›å¤å¡«å……é”™è¯¯ï¼›</li><li>æ”¯æŒä¼ è¾“å‚æ•°çš„IANAï¼ˆInternet Assigned NumbersAuthorityï¼Œäº’è”ç½‘æ•°å­—åˆ†é…æœºæ„ï¼‰æ³¨å†Œï¼Œå¢åŠ äº†ä¼ è¾“å‚æ•°çš„çµæ´»æ€§ï¼›</li><li>æ”¹è¿›äº†è¿æ¥å…³é—­è¿‡æ—©æƒ…å†µä¸‹çš„è¿æ¥æ¢å¤é—®é¢˜ã€‚</li></ul><p>æœ‰äº›åŠ å¯†ç®—æ³•è¿˜æ˜¯å­˜åœ¨å®‰å…¨æ¼æ´ï¼Œä½¿ç”¨çš„ MD5 ä¹Ÿä¸å®‰å…¨ã€‚</p></li><li><p><code>TSL1.2</code>ï¼šä¸»è¦å…³æ³¨äº†æ¶æ„çµæ´»æ€§å’Œå®‰å…¨é—®é¢˜ã€‚</p><ul><li>æ¶æ„ï¼š<ul><li>å®¢æˆ·ç«¯å¯ä»¥æŒ‡å®šè‡ªå·±æ”¯æŒçš„ç­¾åå’Œ hash ç®—æ³•åˆ—è¡¨ï¼›</li><li>æ”¯æŒéåè®®å›ºå®šçš„ç®—æ³•ï¼›</li></ul></li><li>å®‰å…¨ï¼š<ul><li>å¢åŠ äº†å¯¹ AEADï¼ˆAuthenticated Encryption with Associated Dataå…³è”æ•°æ®è®¤è¯åŠ å¯†ï¼‰çš„æ”¯æŒï¼Œå¯ä»¥åœ¨åŠ å¯†ä¸­è®¤è¯æ²¡æœ‰åŠ å¯†éƒ¨åˆ†çš„å…³é”®æ•°æ®ï¼Œç”šè‡³æ˜¯ä¸åœ¨æŠ¥æ–‡ä¸­çš„å…³é”®æ•°æ®ï¼Œå¯ä»¥ä¿æŠ¤æ›´å¤§çš„èŒƒå›´ã€‚</li><li>è§„å®šå¿…é¡»å®ç°å¯†ç å¥—ä»¶ TLS_RSA_WITH_AES_128_CBC_SHAã€‚</li><li>å¢åŠ äº† HMAC-SHA256 å¯†ç å¥—ä»¶ã€‚</li><li>åˆ é™¤äº†åŒ…å«å·²åºŸå¼ƒç®—æ³•çš„ IDEA å’Œ DES å¯†ç å¥—ä»¶ã€‚</li><li>å¯¹ EncryptedPreMasterSecret ç‰ˆæœ¬å·è¿›è¡Œäº†æ›´ä¸¥æ ¼çš„æ£€æŸ¥ã€‚</li></ul></li></ul></li><li><p><code>TSL1.3</code>ï¼šé™¤äº†å¢åŠ å®‰å…¨æ€§ï¼Œé‡ç‚¹æ”¹è¿›äº†è¿æ¥é€Ÿåº¦ï¼Œé¦–æ¬¡è¿æ¥å‘é€æ•°æ®æœ€ä½å¯ä»¥1-RTTï¼Œæ¢å¤è¿æ¥å‘é€æ•°æ®æœ€ä½å¯ä»¥ 0-RTTã€‚</p><ul><li>å®‰å…¨ï¼š<ul><li>åˆ é™¤äº†æ‰€æœ‰è¢«è¯æ˜æœ‰é—®é¢˜çš„å¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œåªä¿ç•™äº† AEADçš„åŠ å¯†å¥—ä»¶ã€‚å¯†ç å¥—ä»¶çš„æ¦‚å¿µä¹Ÿå·²ç»æ”¹å˜ï¼Œå°†è®¤è¯å’Œå¯†é’¥äº¤æ¢æœºåˆ¶ä¸åŠ å¯†ç®—æ³•å’Œæ•£åˆ—ï¼ˆç”¨äºå¯†é’¥å¯¼å‡ºå‡½æ•°å’Œæ¡æ‰‹æ¶ˆæ¯è®¤è¯ç ï¼‰åˆ†ç¦»ã€‚</li><li>åˆ é™¤ RSA å’Œé™æ€ DH å¯†ç å¥—ä»¶ï¼Œå› ä¸ºé™æ€ RSAåŠ å¯†é¢„ä¸»å¯†é’¥çš„æ–¹å¼å’Œä½¿ç”¨é™æ€ DHç§é’¥éƒ½ä¸èƒ½ä¿è¯å‰å‘å®‰å…¨æ€§ï¼Œå¾ˆå®¹æ˜“æ³„éœ²å¯†é’¥ã€‚åªä¿ç•™èƒ½ä¿è¯å‰å‘å®‰å…¨çš„å¯†é’¥äº¤æ¢ç®—æ³•ï¼Œå¦‚ä½¿ç”¨ä¸´æ—¶ç§é’¥çš„ECDHEï¼ˆElliptic Curve Diffie-Hellman Ephemeralï¼Œæ¤­åœ†æ›²çº¿ DHä¸´æ—¶å¯†é’¥äº¤æ¢ç®—æ³•ï¼‰å’Œ DHEï¼ˆDiffie-Hellman Ephemeral, DHä¸´æ—¶å¯†é’¥äº¤æ¢ç®—æ³•ï¼‰ã€‚</li><li>ServerHello ä¹‹åçš„æ¶ˆæ¯éƒ½åŠ å¯†ä¼ è¾“ã€‚</li><li>åˆ é™¤äº†å‹ç¼©åŠŸèƒ½ã€‚ä¹‹å‰ç‰ˆæœ¬çš„å‹ç¼©åŠŸèƒ½ç”±äºå­˜åœ¨è¢«æ”»å‡»çš„é£é™©å®é™…ä¸Šå¾ˆå°‘ä½¿ç”¨ï¼Œè€Œä¸”ç°ä»£çš„å‹ç¼©åŸºæœ¬éƒ½åœ¨åº”ç”¨å±‚å®ç°ï¼Œæ¯”å¦‚HTTPå°±è‡ªå·±å®ç°çš„å‹ç¼©ã€‚</li></ul></li></ul></li></ul><h2 id="http-ç‰ˆæœ¬æ¼”åŒ–">HTTP ç‰ˆæœ¬æ¼”åŒ–</h2><ul><li><p><code>HTTP0.9</code>ï¼šä»…æ”¯æŒç®€å•çš„è¯·æ±‚å“åº”ï¼Œåªèƒ½è®¿é—®<strong>ç®€å•çš„æ–‡æœ¬</strong>æ–‡æ¡£ã€‚</p></li><li><p><code>HTTP1.0</code>ï¼šHTTP1ä¸­å¼•å…¥äº†<strong>è¯·æ±‚å¤´å’Œå“åº”å¤´</strong>ï¼Œè¯·æ±‚æ—¶å¯ä»¥æŒ‡å®š HTTPç‰ˆæœ¬å·ã€ç”¨æˆ·ä»£ç†ã€æ¥æ”¶ç±»å‹ç­‰ï¼Œå“åº”å¯ä»¥æŒ‡æ˜å“åº”çŠ¶æ€ã€å†…å®¹é•¿åº¦ã€å†…å®¹ç±»å‹ç­‰ã€‚</p></li><li><p><code>HTTP1.1</code>ï¼šå¢åŠ äº†<strong>é‡ç”¨ TCPè¿æ¥</strong>ï¼ˆkeep-aliveï¼‰çš„æ–¹æ³•ï¼Œé»˜è®¤ä¿æŒè¿æ¥ï¼Œé™¤éæ˜¾å¼é€šçŸ¥å…³é—­è¿æ¥[æ’å›¾]ã€‚è¿™æ ·å¯ä»¥åœ¨ä¸€ä¸ªTCP è¿æ¥ä¸Šå®Œæˆå¤šä¸ªè¯·æ±‚-å“åº”ï¼Œæ¶ˆé™¤äº† TCP å»ºç«‹çš„å»¶è¿Ÿï¼Œä¹Ÿé¿å…äº†æ–°å»ºç«‹çš„ TCPè¿æ¥çš„æ…¢å¯åŠ¨è¿‡ç¨‹ã€‚</p><ul><li>HTTP1.1 åœ¨ HTTP è¯·æ±‚é¦–éƒ¨ä¸­å¢åŠ äº† Host å­—æ®µï¼Œç”¨æ¥æ”¯æŒå…±äº« IPåœ°å€çš„è™šæ‹Ÿä¸»æœºæœåŠ¡å™¨ã€‚</li><li>åŒæ—¶æ”¯æŒäº†æ›´å¤šçš„æ–¹æ³•ï¼Œå¦‚ PUTã€PATCHã€DELETEã€OPTIONSã€‚</li><li>å¼•å…¥åˆ†å—ä¼ è¾“æ”¯æŒåŠ¨æ€å†…å®¹ã€‚</li><li>å¼•å…¥äº†æ›´å¤šçš„ç¼“å­˜æ§åˆ¶ç­–ç•¥ã€‚</li><li>æ”¯æŒè¯·æ±‚éƒ¨åˆ†å†…å®¹ã€‚</li></ul></li><li><p><code>HTTP2</code>ï¼šä¿®æ”¹äº† HTTP1.1çš„å°è£…æ ¼å¼ï¼Œå¢åŠ äº†ä¸€ä¸ªäºŒè¿›åˆ¶åˆ†å¸§å±‚ã€‚åŸºäºäºŒè¿›åˆ¶åˆ†å±‚ï¼ŒHTTP2 å®ç°äº† HTTPçš„<strong>å¤šè·¯å¤ç”¨</strong>ã€‚HTTP2ä¸ºæ¯ä¸ªè¯·æ±‚åˆ†é…äº†ä¸€ä¸ªæµæ ‡è¯†ï¼ŒæœåŠ¡å™¨å“åº”æ—¶å¸¦ä¸Šç›¸åŒçš„æµæ ‡è¯†ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥æ–¹ä¾¿åœ°å°†å“åº”ä¸è¯·æ±‚å…³è”èµ·æ¥ï¼Œè€Œä¸ç”¨ä¾èµ–é¡ºåºï¼Œä»è€Œå¯ä»¥é™ä½å»¶è¿Ÿå’Œæé«˜ååé‡ã€‚</p><ul><li>HTTP2 è¿˜å¢åŠ äº†é¦–éƒ¨å‹ç¼© HPACKï¼ˆHeader Compression for HTTP2ï¼ŒHTTP2é¦–éƒ¨å‹ç¼©ç®—æ³•ï¼‰ã€‚</li><li>æ”¯æŒè¯·æ±‚ä¼˜å…ˆçº§ã€‚</li><li>æ”¯æŒæœåŠ¡å™¨ä¸»åŠ¨æ¨é€ã€‚</li><li>å¢åŠ äº† ALPNï¼ˆApplication-Layer ProtocolNegotiationï¼Œåº”ç”¨å±‚åè®®åå•†ï¼‰ã€‚</li><li>æ”¯æŒè®¤è¯ã€åŠ å¯†å’Œå®Œæ•´æ€§ä¿æŠ¤ï¼Œå³ <code>HTTPS</code>ã€‚</li></ul><p>ä½†å¤šä¸ªè¯·æ±‚æˆ–å“åº”åœ¨åŒä¸€ä¸ª TCP ä¸Šå‘é€æ—¶ï¼Œä»ç„¶å—åˆ¶äº TCPçš„é˜Ÿé¦–é˜»å¡é—®é¢˜ã€‚</p></li><li><p><code>HTTP3</code>ï¼šåŸºäº <code>QUIC</code> åè®®ï¼Œåº•å±‚ä½¿ç”¨ UDPå®ç°ï¼Œæ‘†è„±äº† TCP çš„é˜Ÿé¦–é˜»å¡é—®é¢˜ã€‚åŒæ—¶æ”¹è¿›äº† TCPä¸­å­˜åœ¨çš„ä¸€äº›å…¶ä»–é—®é¢˜ï¼Œæ¯”å¦‚æ‹¥å¡æ§åˆ¶ã€åè®®åƒµåŒ–ã€å¯åŠ¨æ…¢ã€é‡è¿æ…¢ã€å®‰å…¨å¼±ç­‰ã€‚</p><ul><li>å®ç°äº†æ²¡æœ‰é˜Ÿé¦–é˜»å¡çš„å¹¶å‘ã€‚å¦‚æœ QUICä¸¢äº†ä¸€ä¸ªæŠ¥æ–‡ï¼Œä»…ä»…å½±å“å¯¹åº”æµçš„äº¤ä»˜ï¼Œä¸ä¼šé˜»å¡å…¶ä»–æµã€‚</li><li>ä¸ TLS1.3 ç´§å¯†åˆä½œï¼Œå°½å¯èƒ½çš„åŠ å¯†ã€‚è¿˜å¢åŠ äº† QUICæŠ¥æ–‡çš„é¦–éƒ¨åŠ å¯†ï¼Œé™¤ä¿è¯äº†æŠ¥æ–‡å®‰å…¨æ€§ï¼Œæé«˜äº†æ”»å‡»é—¨æ§›ï¼Œè¿˜é¿å…äº†åè®®åƒµåŒ–ã€‚</li><li>é€‰æ‹© UDP ä½œä¸ºåº•å±‚å®ç°ã€‚ä¸€æ–¹é¢é¿å…äº† TCPçš„é¦–éƒ¨é˜»å¡ï¼Œå¦ä¸€æ–¹é¢äº’è”ç½‘ä¸­ç»å¤§éƒ¨åˆ†çš„ä¸»æœºå’Œä¸­é—´ä»¶éƒ½æ˜¯ TCP å’Œ UDPçš„å¤©ä¸‹ï¼Œæ‰€ä»¥å¤©ç„¶æ”¯æŒã€‚</li><li>ç”¨æˆ·æ€å®ç°ã€‚ä¸ä¾èµ–äºå†…æ ¸ï¼Œå®¹æ˜“å•ç‹¬å‡çº§ã€‚</li><li>ä½å»¶è¿Ÿçš„å»ºç«‹ã€‚å®ç°äº†é¦–æ¬¡æœ€ä½ 1-RTTå‘é€åº”ç”¨æ•°æ®ï¼Œæ¢å¤è¿æ¥æ—¶å‘é€åº”ç”¨æ•°æ®æœ€ä½åªéœ€ 0-RTTã€‚</li><li>æ— ç¼çš„è¿æ¥è¿ç§»ã€‚QUIC çš„è¿æ¥åŸºäºè¿æ¥æ ‡è¯†ï¼Œæ”¹å˜ IP æˆ–è€… UDPç«¯å£å·å¹¶ä¸å½±å“è¿æ¥çš„è¯†åˆ«ï¼Œå› æ­¤å¯ä»¥å®ç°æ— ç¼çš„è¿æ¥è¿ç§»ã€‚ä½†æ˜¯è´Ÿè½½å‡è¡¡å°±éº»çƒ¦äº†ã€‚</li><li>æ”¹è¿›çš„æµé‡æ§åˆ¶ã€‚</li><li>åè®®è¡Œä¸ºä½œä¸ºè´Ÿè½½ã€‚</li></ul></li></ul><h1 id="quic-æŠ¥æ–‡">2. QUIC æŠ¥æ–‡</h1><ul><li>é•¿é¦–éƒ¨æŠ¥æ–‡ï¼šç”¨äºå»ºç«‹ QUIC è¿æ¥å’Œå»ºç«‹è¿æ¥å‰å‘é€åº”ç”¨æ•°æ®ã€‚</li><li>çŸ­é¦–éƒ¨æŠ¥æ–‡ï¼šç”¨äºåœ¨ QUIC è¿æ¥å»ºç«‹åå‘é€åº”ç”¨æ•°æ®å’Œ QUICåè®®å†…å®¹ã€‚</li><li>æ— çŠ¶æ€é‡ç½®æŠ¥æ–‡ï¼šå½“æœåŠ¡å™¨ä¸¢å¤±äº†è¿æ¥çŠ¶æ€ä½†ä»ç„¶æ”¶åˆ°è¯¥è¿æ¥çš„æ•°æ®åŒ…æ—¶ï¼Œå¯ä»¥å‘é€æ— çŠ¶æ€é‡ç½®æŠ¥æ–‡é€šçŸ¥å®¢æˆ·ç«¯ç«‹å³ç»ˆæ­¢è¿æ¥ã€‚</li></ul><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250122195252117.png"alt="QUIC æŠ¥æ–‡ç±»å‹" /><figcaption aria-hidden="true">QUIC æŠ¥æ–‡ç±»å‹</figcaption></figure><p>åˆå§‹æŠ¥æ–‡ï¼šå®¢æˆ·ç«¯ä½¿ç”¨åˆå§‹æŠ¥æ–‡æ¥å‘èµ·è¿æ¥ï¼ŒæœåŠ¡å™¨ä½¿ç”¨åˆå§‹æŠ¥æ–‡å’Œæ¡æ‰‹æŠ¥æ–‡å›åº”å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚</p><p>0-RTT æŠ¥æ–‡ï¼šç”¨äºæ‰¿è½½ QUICè¿æ¥ä¹‹å‰æƒ³è¦å‘é€çš„æ•°æ®ï¼Œä¸€èˆ¬ç”¨äºæ¢å¤è¿æ¥åç«‹å³å‘é€æ•°æ®ã€‚</p><p>æ¡æ‰‹æŠ¥æ–‡ï¼šç”¨æ¥æºå¸¦æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çš„ TLS åŠ å¯†æ¡æ‰‹ä¿¡æ¯å’Œç¡®è®¤ï¼Œè½½è·ä¸€èˆ¬æ˜¯CRYPTO å¸§å’Œ ACK å¸§ã€‚</p><p>é‡è¯•æŠ¥æ–‡ï¼šæ˜¯æœåŠ¡å™¨ç”¨æ¥éªŒè¯å®¢æˆ·ç«¯åœ°å€çš„æŠ¥æ–‡ï¼Œå¯ä»¥é˜²æ­¢æºåœ°å€æ¬ºéª—ã€‚</p><blockquote><p>æœåŠ¡å™¨ä½¿ç”¨é‡è¯•æŠ¥æ–‡é€šçŸ¥å®¢æˆ·ç«¯æŒ‰ç…§è¦æ±‚é‡æ–°å‘é€åˆå§‹æŠ¥æ–‡ï¼Œåœ¨é‡è¯•æŠ¥æ–‡ä¸­æºå¸¦é‡è¯•ä»¤ç‰Œç»™å®¢æˆ·ç«¯ï¼Œå¹¶ä½¿ç”¨æœåŠ¡å™¨é€‰æ‹©çš„è¿æ¥æ ‡è¯†ä½œä¸ºé‡è¯•æŠ¥æ–‡çš„æºè¿æ¥æ ‡è¯†ï¼›å®¢æˆ·ç«¯éœ€è¦ä½¿ç”¨æœåŠ¡å™¨æŒ‡å®šçš„è¿æ¥æ ‡è¯†ä½œä¸ºç›®çš„è¿æ¥æ ‡è¯†ï¼Œæºå¸¦æœåŠ¡å™¨æŒ‡å®šçš„é‡è¯•ä»¤ç‰Œï¼Œæ„å»ºæ–°çš„åˆå§‹æŠ¥æ–‡ï¼Œé‡æ–°å‘é€ç»™æœåŠ¡å™¨ã€‚</p></blockquote><p>ç‰ˆæœ¬åå•†æŠ¥æ–‡ï¼šå½“æœåŠ¡å™¨æ”¶åˆ°åŒ…å«è‡ªå·±ä¸æ”¯æŒçš„ç‰ˆæœ¬å·çš„åˆå§‹æŠ¥æ–‡æ—¶ï¼Œå°±ä¼šå‘é€ç‰ˆæœ¬åå•†æŠ¥æ–‡ã€‚å®¢æˆ·ç«¯æ”¶åˆ°ç‰ˆæœ¬åå•†æŠ¥æ–‡åéœ€è¦åœ¨å…¶ä¸­é€‰æ‹©ä¸€ä¸ªè‡ªå·±æ”¯æŒçš„ç‰ˆæœ¬å·ï¼Œé‡æ–°ä»¥æ–°ç‰ˆæœ¬å·å‘é€åˆå§‹æŠ¥æ–‡ã€‚</p><p>çŸ­é¦–éƒ¨æŠ¥æ–‡ï¼šä¸€èˆ¬ä¹Ÿå«ä½œ 1-RTT æŠ¥æ–‡ï¼Œè¿æ¥åœ¨åå•†å‡º 1-RTTå¯†é’¥åå°±å¯ä»¥å‘é€çŸ­é¦–éƒ¨æŠ¥æ–‡ï¼Œç”¨äºæºå¸¦åº”ç”¨æ•°æ®ã€‚</p>]]></content>
    
    
    <summary type="html">æ•´ç†é˜…è¯»ã€Šè§£å¯† QUIC/HTTP3ï¼šæœªæ¥äº’è”ç½‘çš„åŸºçŸ³ã€‹ç¬”è®°ã€‚</summary>
    
    
    
    <category term="è®¡ç®—æœºåŸºç¡€" scheme="https://hedon.top/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/"/>
    
    <category term="è®¡ç®—æœºç½‘ç»œ" scheme="https://hedon.top/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"/>
    
    
    <category term="QUIC" scheme="https://hedon.top/tags/QUIC/"/>
    
    <category term="HTTP3" scheme="https://hedon.top/tags/HTTP3/"/>
    
    <category term="è®¡ç®—æœºç½‘ç»œ" scheme="https://hedon.top/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"/>
    
  </entry>
  
  <entry>
    <title>åŒ å¿ƒç é“ä¸¨01 ç¼–å†™ä¼˜è´¨ä»£ç çš„åå¤§é»„é‡‘æ³•åˆ™</title>
    <link href="https://hedon.top/2024/12/12/clean-code-10-rules/"/>
    <id>https://hedon.top/2024/12/12/clean-code-10-rules/</id>
    <published>2024-12-12T02:22:49.000Z</published>
    <updated>2025-02-15T15:27:55.982Z</updated>
    
    <content type="html"><![CDATA[<p>ä»£ç è´¨é‡çš„ä¼˜åŠ£ç›´æ¥å½±å“ç€é¡¹ç›®çš„å¯ç»´æŠ¤æ€§å’Œå›¢é˜Ÿçš„å¼€å‘æ•ˆç‡ã€‚ä¸€ä¸ªç»éªŒä¸°å¯Œçš„å¼€å‘è€…ä¸ä»…è¦èƒ½å®ç°åŠŸèƒ½ï¼Œæ›´è¦å–„äºç¼–å†™æ¸…æ™°æ˜“æ‡‚ã€ç»“æ„åˆç†çš„ä»£ç ã€‚æœ¬æ–‡å°†ä»‹ç»10 æ¡å¸®åŠ©ä½ ç¼–å†™æ¸…æ™°ã€æ˜“ç»´æŠ¤ä¸”å¯æ‰©å±•ä»£ç çš„é‡è¦è§„åˆ™ã€‚</p><h1 id="è§„åˆ™">è§„åˆ™</h1><h2 id="ä½¿ç”¨æœ‰æ„ä¹‰çš„å˜é‡å’Œå‡½æ•°åç§°">1. ä½¿ç”¨æœ‰æ„ä¹‰çš„å˜é‡å’Œå‡½æ•°åç§°</h2><p>å˜é‡ã€å‡½æ•°å’Œç±»çš„å‘½ååº”è¯¥å…·æœ‰æè¿°æ€§å’Œæ„ä¹‰ã€‚ä½ çš„ä»£ç åº”è¯¥èƒ½å¤Ÿæ¸…æ™°åœ°è¡¨è¾¾å…¶æ„å›¾ï¼Œè€Œæ— éœ€é¢å¤–çš„æ³¨é‡Šæ¥è§£é‡Šã€‚</p><p><strong>åé¢ç¤ºä¾‹ï¼š</strong> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> a = <span class="hljs-number">10</span>;<br><span class="hljs-keyword">const</span> d = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();<br><span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">get</span>();<br><span class="hljs-keyword">const</span> arr = users.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">u</span> =&gt;</span> u.<span class="hljs-property">a</span> === <span class="hljs-literal">true</span>);<br></code></pre></td></tr></table></figure></p><p><strong>æ­£é¢ç¤ºä¾‹ï¼š</strong> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> maxRetries = <span class="hljs-number">10</span>;<br><span class="hljs-keyword">const</span> currentDate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();<br><span class="hljs-keyword">const</span> userResponse = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">getUserProfile</span>();<br><span class="hljs-keyword">const</span> activeUsers = users.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> user.<span class="hljs-property">isActive</span> === <span class="hljs-literal">true</span>);<br></code></pre></td></tr></table></figure></p><p>æœ‰æ„ä¹‰çš„å‘½åèƒ½è®²è¿°ä»£ç çš„æ•…äº‹ã€‚è¯»è€…åº”è¯¥èƒ½å¤Ÿä»…é€šè¿‡åç§°å°±ç†è§£å˜é‡æˆ–å‡½æ•°çš„ç”¨é€”ã€‚</p><p>ğŸ’¡å®è·µå»ºè®®ï¼š</p><ul><li>ä½¿ç”¨åŠ¨è¯å‰ç¼€å‘½åå‡½æ•°ï¼š<code>getUserProfile()</code>ã€<code>validateInput()</code>ã€<code>calculateTotal()</code></li><li>ä½¿ç”¨åè¯å‘½åå˜é‡ï¼š<code>userCount</code>ã€<code>activeUsers</code>ã€<code>orderStatus</code></li><li>å¸ƒå°”å€¼ä½¿ç”¨ is/has/shouldç­‰å‰ç¼€ï¼š<code>isValid</code>ã€<code>hasPermission</code>ã€<code>shouldUpdate</code></li></ul><h2 id="ä¿æŒå‡½æ•°ç®€çŸ­ä¸”ä¸“æ³¨">2. ä¿æŒå‡½æ•°ç®€çŸ­ä¸”ä¸“æ³¨</h2><p>å‡½æ•°åº”è¯¥ä¿æŒç®€çŸ­ï¼Œå¹¶ä¸”åªåšä¸€ä»¶äº‹ã€‚å‡½æ•°æ‰¿æ‹…çš„è´£ä»»è¶Šå¤šï¼Œæµ‹è¯•ã€è°ƒè¯•å’Œç†è§£èµ·æ¥å°±è¶Šå›°éš¾ã€‚</p><p><strong>åé¢ç¤ºä¾‹ï¼š</strong> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">process_order</span>(<span class="hljs-params">order</span>):<br>    <span class="hljs-comment"># å¤šä¸ªè´£ä»»ï¼šéªŒè¯ã€å®šä»·ã€æŠ˜æ‰£ã€é…é€ç­‰</span><br>    <span class="hljs-keyword">pass</span><br></code></pre></td></tr></table></figure></p><p><strong>æ­£é¢ç¤ºä¾‹ï¼š</strong> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">validate_order</span>(<span class="hljs-params">order</span>):<br>    <span class="hljs-keyword">pass</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_total</span>(<span class="hljs-params">order</span>):<br>    <span class="hljs-keyword">pass</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">apply_discount</span>(<span class="hljs-params">order</span>):<br>    <span class="hljs-keyword">pass</span><br></code></pre></td></tr></table></figure></p><p>æ¯ä¸ªå‡½æ•°åº”è¯¥åªæœ‰ä¸€ä¸ªè´£ä»»ã€‚å¦‚æœä½ éœ€è¦ç”¨"å’Œ"æ¥æè¿°å‡½æ•°çš„åŠŸèƒ½ï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°å¯èƒ½åšå¾—å¤ªå¤šäº†ã€‚</p><p>ğŸ’¡ æœ€ä½³å®è·µï¼š</p><ul><li>å‡½æ•°å»ºè®®ä¿æŒåœ¨ 20-30 è¡Œä»¥å†…</li><li>å¦‚æœè¶…è¿‡ 50 è¡Œï¼Œåº”è¯¥è€ƒè™‘æ‹†åˆ†</li><li>ä¸€ä¸ªå‡½æ•°æœ€å¥½ä¸è¦è¶…è¿‡ 3 ä¸ªå‚æ•°</li></ul><h2 id="é¿å…æ·±å±‚åµŒå¥—">3. é¿å…æ·±å±‚åµŒå¥—</h2><p>æ·±å±‚åµŒå¥—çš„å¾ªç¯å’Œæ¡ä»¶è¯­å¥ä¼šä½¿ä»£ç éš¾ä»¥ç†è§£ã€‚é€šè¿‡ä½¿ç”¨æå‰è¿”å›ã€å‡½æ•°æ‹†åˆ†æˆ–å°†å¤§é—®é¢˜åˆ†è§£ä¸ºå°é—®é¢˜æ¥ä½¿ä»£ç æ‰å¹³åŒ–ã€‚</p><p><strong>åé¢ç¤ºä¾‹ï¼š</strong> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">if</span> (user.<span class="hljs-title function_">isActive</span>()) &#123;<br>        <span class="hljs-keyword">if</span> (order != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-title function_">processOrder</span>(order);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></p><p><strong>æ­£é¢ç¤ºä¾‹ï¼š</strong> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span> || !user.<span class="hljs-title function_">isActive</span>()) <span class="hljs-keyword">return</span>;<br><span class="hljs-keyword">if</span> (order == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;<br><span class="hljs-title function_">processOrder</span>(order);<br></code></pre></td></tr></table></figure></p><p>æå‰è¿”å›å¯ä»¥å‡å°‘è¯»è€…çš„è®¤çŸ¥è´Ÿæ‹…ï¼Œä½¿ä»£ç æ›´ç®€å•ã€æ›´å®¹æ˜“ç†è§£ã€‚</p><h2 id="æ˜æ™ºåœ°ä½¿ç”¨æ³¨é‡Š">4. æ˜æ™ºåœ°ä½¿ç”¨æ³¨é‡Š</h2><p>æ³¨é‡Šä¸åº”è¯¥è§£é‡Šä»£ç åšäº†ä»€ä¹ˆï¼›ä»£ç æœ¬èº«åº”è¯¥æ˜¯è‡ªè§£é‡Šçš„ã€‚åªåœ¨å¿…è¦æ—¶ä½¿ç”¨æ³¨é‡Šæ¥è§£é‡Šå¤æ‚é€»è¾‘èƒŒåçš„"åŸå› "ï¼Œè€Œä¸æ˜¯"æ˜¯ä»€ä¹ˆ"ã€‚</p><p><strong>åé¢ç¤ºä¾‹ï¼š</strong> <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">// è®¾ç½®ç”¨æˆ·çŠ¶æ€ä¸ºæ¿€æ´»</span><br><span class="hljs-variable">$user</span>-&gt;isActive = <span class="hljs-literal">true</span>;<br></code></pre></td></tr></table></figure></p><p><strong>æ­£é¢ç¤ºä¾‹ï¼š</strong> <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">// ç™»å½•æˆåŠŸåå°†ç”¨æˆ·æ ‡è®°ä¸ºæ¿€æ´»çŠ¶æ€</span><br><span class="hljs-variable">$user</span>-&gt;isActive = <span class="hljs-literal">true</span>;<br></code></pre></td></tr></table></figure></p><p>æ³¨é‡Šåº”è¯¥å¢åŠ ä»·å€¼ï¼Œè§£é‡Šç‰¹å®šå®ç°èƒŒåçš„åŸå› æˆ–è§£é‡Šå¤æ‚çš„ä¸šåŠ¡é€»è¾‘ã€‚</p><h2 id="ä¿æŒä¸€è‡´çš„æ ¼å¼">5. ä¿æŒä¸€è‡´çš„æ ¼å¼</h2><p>ä¸€è‡´çš„ä»£ç æ ¼å¼ä½¿ä»£ç æ›´å®¹æ˜“é˜…è¯»å’Œå¯¼èˆªã€‚åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ç»Ÿä¸€çš„ç¼©è¿›ã€é—´è·å’Œå¯¹é½æ–¹å¼ã€‚</p><p><strong>åé¢ç¤ºä¾‹ï¼š</strong> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">calculate</span>(<span class="hljs-params">a,b</span>)&#123;<span class="hljs-keyword">return</span> a+b;&#125;<br></code></pre></td></tr></table></figure></p><p><strong>æ­£é¢ç¤ºä¾‹ï¼š</strong> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">calculate</span>(<span class="hljs-params">a, b</span>) &#123;<br>    <span class="hljs-keyword">return</span> a + b;<br>&#125;<br></code></pre></td></tr></table></figure></p><p>è®¸å¤šå›¢é˜Ÿä½¿ç”¨ Prettier æˆ– ESLintç­‰å·¥å…·æ¥è‡ªåŠ¨æ ¼å¼åŒ–å¹¶å¼ºåˆ¶æ‰§è¡Œä»£ç é£æ ¼è§„åˆ™ã€‚</p><h2 id="ä¸è¦é‡å¤è‡ªå·±dry-åŸåˆ™">6. ä¸è¦é‡å¤è‡ªå·±ï¼ˆDRY åŸåˆ™ï¼‰</h2><p>ä»£ç é‡å¤ä¼šå¯¼è‡´ä¸ä¸€è‡´ã€bug å’Œä¸å¿…è¦çš„å¤æ‚æ€§ã€‚åº”ç”¨ DRYåŸåˆ™å¯ä»¥ä¿æŒä»£ç åº“ç²¾ç®€ï¼Œæ›´æ˜“äºç»´æŠ¤ã€‚</p><p><strong>åé¢ç¤ºä¾‹ï¼š</strong> <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (<span class="hljs-variable">$userType</span> == <span class="hljs-string">&quot;admin&quot;</span>) &#123;<br>    <span class="hljs-comment">// å¤æ‚é€»è¾‘</span><br>&#125;<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$userType</span> == <span class="hljs-string">&quot;superadmin&quot;</span>) &#123;<br>    <span class="hljs-comment">// ç›¸åŒçš„å¤æ‚é€»è¾‘</span><br>&#125;<br></code></pre></td></tr></table></figure></p><p><strong>æ­£é¢ç¤ºä¾‹ï¼š</strong> <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">userIsAdmin</span>(<span class="hljs-variable">$userType</span>)) &#123;<br>    <span class="hljs-comment">// å¤æ‚é€»è¾‘</span><br>&#125;<br></code></pre></td></tr></table></figure></p><p>é€šè¿‡å°†å…±åŒé€»è¾‘æŠ½è±¡åˆ°å‡½æ•°ã€ç±»æˆ–å·¥å…·ä¸­æ¥é¿å…ä»£ç é‡å¤ã€‚</p><h2 id="å•ä¸€è´£ä»»åŸåˆ™srp">7. å•ä¸€è´£ä»»åŸåˆ™ï¼ˆSRPï¼‰</h2><p>æ¯ä¸ªç±»å’Œå‡½æ•°åº”è¯¥åªæœ‰ä¸€ä¸ªæ”¹å˜çš„ç†ç”±ã€‚éµå¾ªå•ä¸€è´£ä»»åŸåˆ™ä½¿ä»£ç æ¨¡å—åŒ–ï¼Œæ›´å®¹æ˜“é‡æ„ã€‚</p><p><strong>åé¢ç¤ºä¾‹ï¼š</strong> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">login</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendEmail</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure></p><p><strong>æ­£é¢ç¤ºä¾‹ï¼š</strong> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">login</span><span class="hljs-params">()</span>;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">EmailService</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendEmail</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure></p><p>æ‰¿æ‹…å¤ªå¤šè´£ä»»çš„ç±»æ›´éš¾ç»´æŠ¤ã€‚SRP ä½¿ä»£ç æ›´æ¨¡å—åŒ–ï¼Œæ›´å®¹æ˜“æµ‹è¯•ã€‚</p><h2 id="é¿å…é­”æ³•æ•°å­—å’Œå­—ç¬¦ä¸²">8. é¿å…é­”æ³•æ•°å­—å’Œå­—ç¬¦ä¸²</h2><p>é­”æ³•æ•°å­—ï¼ˆæˆ–å­—ç¬¦ä¸²ï¼‰æ˜¯æ²¡æœ‰ä¸Šä¸‹æ–‡æˆ–è§£é‡Šçš„ç¡¬ç¼–ç å€¼ã€‚ä½¿ç”¨å¸¸é‡æˆ–æšä¸¾ä»£æ›¿ï¼Œè¿™æ ·å¯ä»¥å¢åŠ ä»£ç çš„æ¸…æ™°åº¦ã€‚</p><p><strong>åé¢ç¤ºä¾‹ï¼š</strong> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">discount = <span class="hljs-number">0.05</span><br><span class="hljs-keyword">if</span> user.role == <span class="hljs-string">&quot;admin&quot;</span>:<br></code></pre></td></tr></table></figure></p><p><strong>æ­£é¢ç¤ºä¾‹ï¼š</strong> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">DISCOUNT_RATE = <span class="hljs-number">0.05</span><br>ADMIN_ROLE = <span class="hljs-string">&quot;admin&quot;</span><br>discount = DISCOUNT_RATE<br><span class="hljs-keyword">if</span> user.role == ADMIN_ROLE:<br></code></pre></td></tr></table></figure></p><p>å¸¸é‡ä¸ºæ•°å­—æˆ–å­—ç¬¦ä¸²æä¾›äº†å«ä¹‰ï¼Œä½¿ä»£ç æ›´å®¹æ˜“ç†è§£ã€‚</p><h2 id="ç¼–å†™æµ‹è¯•">9. ç¼–å†™æµ‹è¯•</h2><p>å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•ç¡®ä¿ä½ çš„ä»£ç æŒ‰é¢„æœŸå·¥ä½œï¼Œå¹¶ä¸”åœ¨è¿›è¡Œæ›´æ”¹æ—¶ä¸ä¼šå‡ºé”™ã€‚ç¼–å†™æµ‹è¯•ä½¿ä»£ç æ›´å¯é ï¼Œé•¿æœŸæ›´æ˜“äºç»´æŠ¤ã€‚</p><p><strong>åé¢ç¤ºä¾‹ï¼š</strong> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// è¿™ä¸ªæ–¹æ³•æ²¡æœ‰æµ‹è¯•</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processOrder</span><span class="hljs-params">(Order order)</span> &#123;<br>    <span class="hljs-comment">// é€»è¾‘</span><br>&#125;<br></code></pre></td></tr></table></figure></p><p><strong>æ­£é¢ç¤ºä¾‹ï¼š</strong> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testProcessOrder</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();<br>    <span class="hljs-comment">// æ–­è¨€</span><br>&#125;<br></code></pre></td></tr></table></figure></p><p>æµ‹è¯•åº”è¯¥æˆä¸ºä½ å·¥ä½œæµç¨‹çš„ä¸€éƒ¨åˆ†ï¼Œç¡®ä¿ä»£ç æ—  BUG ä¸”ç¨³å®šã€‚</p><h2 id="ä¿æŒç®€å•kiss-åŸåˆ™">10. ä¿æŒç®€å•ï¼ˆKISS åŸåˆ™ï¼‰</h2><p>KISSï¼ˆKeep It Simple,Stupidï¼‰åŸåˆ™æé†’æˆ‘ä»¬ç®€å•æ˜¯å…³é”®ã€‚å¤æ‚çš„è§£å†³æ–¹æ¡ˆä¼šå¯¼è‡´æ··æ·†ï¼Œæ›´éš¾ç»´æŠ¤ã€‚åœ¨é¢å¯¹å†³ç­–æ—¶ï¼Œé€‰æ‹©æœ€ç®€å•ã€æœ€ç›´æ¥çš„æ–¹æ¡ˆæ¥æ»¡è¶³éœ€æ±‚ã€‚</p><p><strong>åé¢ç¤ºä¾‹ï¼š</strong> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// è¿‡åº¦å¤æ‚çš„è´­ç‰©è½¦å•†å“æ€»ä»·è®¡ç®—</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">calculateTotal</span>(<span class="hljs-params">items</span>) &#123;<br>    <span class="hljs-keyword">let</span> total = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">let</span> discount = <span class="hljs-number">0</span>;<br>    <br>    <span class="hljs-comment">// å¤æ‚çš„æŠ˜æ‰£è®¡ç®—é€»è¾‘</span><br>    items.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> &#123;<br>        <span class="hljs-keyword">if</span> (item.<span class="hljs-property">category</span> === <span class="hljs-string">&#x27;electronics&#x27;</span>) &#123;<br>            <span class="hljs-keyword">if</span> (item.<span class="hljs-property">price</span> &gt; <span class="hljs-number">1000</span>) &#123;<br>                discount += item.<span class="hljs-property">price</span> * <span class="hljs-number">0.1</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (item.<span class="hljs-property">price</span> &gt; <span class="hljs-number">500</span>) &#123;<br>                discount += item.<span class="hljs-property">price</span> * <span class="hljs-number">0.05</span>;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (item.<span class="hljs-property">category</span> === <span class="hljs-string">&#x27;books&#x27;</span>) &#123;<br>            <span class="hljs-keyword">if</span> (item.<span class="hljs-property">quantity</span> &gt; <span class="hljs-number">3</span>) &#123;<br>                discount += item.<span class="hljs-property">price</span> * item.<span class="hljs-property">quantity</span> * <span class="hljs-number">0.15</span>;<br>            &#125;<br>        &#125;<br>        total += item.<span class="hljs-property">price</span> * item.<span class="hljs-property">quantity</span>;<br>    &#125;);<br>    <br>    <span class="hljs-keyword">return</span> total - discount;<br>&#125;<br></code></pre></td></tr></table></figure></p><p><strong>æ­£é¢ç¤ºä¾‹ï¼š</strong> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// å°†å¤æ‚é€»è¾‘æ‹†åˆ†æˆå°å‡½æ•°</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">calculateDiscount</span>(<span class="hljs-params">item</span>) &#123;<br>    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">category</span> === <span class="hljs-string">&#x27;electronics&#x27;</span>) &#123;<br>        <span class="hljs-keyword">return</span> item.<span class="hljs-property">price</span> &gt; <span class="hljs-number">1000</span> ? <span class="hljs-number">0.1</span> : (item.<span class="hljs-property">price</span> &gt; <span class="hljs-number">500</span> ? <span class="hljs-number">0.05</span> : <span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">category</span> === <span class="hljs-string">&#x27;books&#x27;</span> &amp;&amp; item.<span class="hljs-property">quantity</span> &gt; <span class="hljs-number">3</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0.15</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">calculateTotal</span>(<span class="hljs-params">items</span>) &#123;<br>    <span class="hljs-keyword">return</span> items.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">total, item</span>) =&gt;</span> &#123;<br>        <span class="hljs-keyword">const</span> discount = <span class="hljs-title function_">calculateDiscount</span>(item);<br>        <span class="hljs-keyword">const</span> itemTotal = item.<span class="hljs-property">price</span> * item.<span class="hljs-property">quantity</span>;<br>        <span class="hljs-keyword">return</span> total + itemTotal * (<span class="hljs-number">1</span> - discount);<br>    &#125;, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure></p><p>ğŸ’¡ æœ€ä½³å®è·µï¼š</p><ul><li>å°†å¤æ‚é€»è¾‘æ‹†åˆ†æˆå°çš„ã€å®¹æ˜“ç†è§£çš„å‡½æ•°</li><li>é¿å…åœ¨ä¸€ä¸ªå‡½æ•°ä¸­å¤„ç†è¿‡å¤šçš„æ¡ä»¶åˆ¤æ–­</li><li>ä½¿ç”¨æ¸…æ™°çš„å‘½åæ¥è¡¨è¾¾æ„å›¾</li><li>ä¿æŒå‡½æ•°çš„å•ä¸€èŒè´£</li></ul><h1 id="æ€»ç»“">æ€»ç»“</h1><p>å¹²å‡€çš„ä»£ç å¯¹äºå¯ç»´æŠ¤æ€§ã€å¯è¯»æ€§å’Œåä½œè‡³å…³é‡è¦ã€‚éµå¾ªè¿™ 10æ¡è§„åˆ™â€”â€”ä½¿ç”¨æœ‰æ„ä¹‰çš„å‘½åã€ä¿æŒå‡½æ•°ç®€çŸ­ã€é¿å…é­”æ³•æ•°å­—ã€ç¼–å†™æµ‹è¯•ç­‰ï¼Œå°†ä¼šå¸¦æ¥æ›´å¥å£®ã€æ›´æ˜“ç†è§£å’Œæ›´æ˜“æ‰©å±•çš„ä»£ç åº“ã€‚ç¼–å†™ä»£ç ä¸ä»…ä»…æ˜¯è¦è®©å®ƒèƒ½å·¥ä½œï¼Œæ›´è¦è®©å…¶ä»–äººï¼ˆåŒ…æ‹¬æœªæ¥çš„ä½ ï¼‰èƒ½å¤Ÿè½»æ¾ç†è§£å’Œæ‰©å±•ã€‚</p><h1 id="ä»£ç å®¡æŸ¥æ¸…å•">ä»£ç å®¡æŸ¥æ¸…å•</h1><p>åœ¨æäº¤ä»£ç å‰ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ¸…å•è¿›è¡Œè‡ªæŸ¥ï¼š</p><ul class="task-list"><li><label><inputtype="checkbox" />å˜é‡å’Œå‡½æ•°åç§°æ˜¯å¦å…·æœ‰æè¿°æ€§</label></li><li><label><input type="checkbox" />å‡½æ•°æ˜¯å¦åªåšä¸€ä»¶äº‹</label></li><li><label><input type="checkbox" />æ˜¯å¦å­˜åœ¨é‡å¤ä»£ç </label></li><li><label><input type="checkbox" />æ˜¯å¦æœ‰æœªä½¿ç”¨çš„é­”æ³•æ•°å­—</label></li><li><label><input type="checkbox" />æ˜¯å¦ç¼–å†™äº†ç›¸åº”çš„æµ‹è¯•</label></li><li><label><input type="checkbox" />ä»£ç æ ¼å¼æ˜¯å¦ç»Ÿä¸€</label></li><li><label><input type="checkbox" />æ³¨é‡Šæ˜¯å¦æœ‰ä»·å€¼</label></li><li><label><input type="checkbox" />åµŒå¥—æ˜¯å¦è¿‡æ·±</label></li></ul><h1 id="å‚è€ƒ">å‚è€ƒ</h1><ul><li><ahref="https://www.thecodingdev.com/2024/09/top-10-clean-code-rules-every-developer.html?ref=dailydev">top-10-clean-code-rules-every-developer-should-follow</a></li></ul>]]></content>
    
    
    <summary type="html">è¯¦è§£ç¼–å†™æ•´æ´ä»£ç çš„åå¤§åŸåˆ™ï¼Œå¸®ä½ å†™å‡ºæ›´å¥½çš„ä»£ç ã€‚</summary>
    
    
    
    <category term="åŒ å¿ƒç é“" scheme="https://hedon.top/categories/%E5%8C%A0%E5%BF%83%E7%A0%81%E9%81%93/"/>
    
    
    <category term="ç¼–ç¨‹è§„èŒƒ" scheme="https://hedon.top/tags/%E7%BC%96%E7%A8%8B%E8%A7%84%E8%8C%83/"/>
    
    <category term="ä»£ç è´¨é‡" scheme="https://hedon.top/tags/%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F/"/>
    
    <category term="æœ€ä½³å®è·µ" scheme="https://hedon.top/tags/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/"/>
    
  </entry>
  
  <entry>
    <title>KCP æºç åˆ†æä¸åŸç†æ€»ç»“</title>
    <link href="https://hedon.top/2024/12/01/kcp/"/>
    <id>https://hedon.top/2024/12/01/kcp/</id>
    <published>2024-12-01T02:08:02.000Z</published>
    <updated>2024-12-01T02:44:33.772Z</updated>
    
    <content type="html"><![CDATA[<h1 id="åºè¨€">åºè¨€</h1><p>æœ¬æ–‡å¾ˆå¤§éƒ¨åˆ†å‚è€ƒäº† <ahref="https://luyuhuang.tech/2020/12/09/kcp.html">è¯¦è§£ KCPåè®®çš„åŸç†å’Œå®ç°</a>ï¼Œéå¸¸æ„Ÿè°¢è¯¥æ–‡ä½œè€…çš„è®²è§£ã€‚æœ¬æ–‡å†æ­¤åŸºç¡€ä¸Šï¼ŒåŠ å…¥äº†ä¸€äº›ç¬”è€…çš„æ€è€ƒå’Œåˆ†æå›¾ç¤ºï¼Œä»¥æœŸæ›´å¥½åœ°ç†è§£KCP çš„åº•å±‚åŸç†ã€‚</p><h1 id="ç»“è®ºå…ˆè¡Œ">ç»“è®ºå…ˆè¡Œ</h1><p>KCP æ˜¯ä¸€ä¸ªå¿«é€Ÿå¯é åè®®ï¼Œèƒ½ä»¥æ¯” TCP æµªè´¹ 10%-20%çš„å¸¦å®½çš„ä»£ä»·ï¼Œæ¢å–å¹³å‡å»¶è¿Ÿé™ä½30%-40%ï¼Œä¸”æœ€å¤§å»¶è¿Ÿé™ä½ä¸‰å€çš„ä¼ è¾“æ•ˆæœã€‚</p><p>TCP æ˜¯ä¸ºæµé‡è®¾è®¡çš„ï¼ˆæ¯ç§’å†…å¯ä»¥ä¼ è¾“å¤šå°‘ KBçš„æ•°æ®ï¼‰ï¼Œè®²ç©¶çš„æ˜¯å……åˆ†åˆ©ç”¨å¸¦å®½ã€‚è€Œ KCPæ˜¯ä¸ºæµé€Ÿè®¾è®¡çš„ï¼ˆå•ä¸ªæ•°æ®åŒ…ä»ä¸€ç«¯å‘é€åˆ°ä¸€ç«¯éœ€è¦å¤šå°‘æ—¶é—´ï¼‰ï¼Œä»¥ 10%-20%å¸¦å®½æµªè´¹çš„ä»£ä»·æ¢å–äº†æ¯” TCP å¿« 30%-40% çš„ä¼ è¾“é€Ÿåº¦ã€‚TCPä¿¡é“æ˜¯ä¸€æ¡æµé€Ÿå¾ˆæ…¢ï¼Œä½†æ¯ç§’æµé‡å¾ˆå¤§çš„å¤§è¿æ²³ï¼Œè€Œ KCPæ˜¯æ°´æµæ¹æ€¥çš„å°æ¿€æµã€‚</p><h2 id="kcp-å¢åŠ çš„å¸¦å®½åœ¨å“ªé‡Œå¢åŠ çš„é€Ÿåº¦åˆåœ¨å“ªé‡Œ">KCPå¢åŠ çš„å¸¦å®½åœ¨å“ªé‡Œï¼Ÿå¢åŠ çš„é€Ÿåº¦åˆåœ¨å“ªé‡Œï¼Ÿ</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240612111337839.png"alt="ä¸ºä»€ä¹ˆ KCP èƒ½ä»¥æ¯” TCP æµªè´¹ 10%-20% çš„å¸¦å®½çš„ä»£ä»·ï¼Œæ¢å–å¹³å‡å»¶è¿Ÿé™ä½ 30%-40%ï¼Ÿ" /><figcaption aria-hidden="true">ä¸ºä»€ä¹ˆ KCP èƒ½ä»¥æ¯” TCP æµªè´¹ 10%-20%çš„å¸¦å®½çš„ä»£ä»·ï¼Œæ¢å–å¹³å‡å»¶è¿Ÿé™ä½ 30%-40%ï¼Ÿ</figcaption></figure><h2 id="kcp-æ ¸å¿ƒç‰¹æ€§">KCP æ ¸å¿ƒç‰¹æ€§</h2><p><strong>å¿«é€Ÿé‡ä¼ </strong>ï¼š KCP æ”¯æŒå¿«é€Ÿé‡ä¼ æœºåˆ¶ï¼Œä¸åƒ TCPé‚£æ ·ä¾èµ–è¶…æ—¶é‡ä¼ ã€‚KCPå¯ä»¥æ ¹æ®æ¥æ”¶æ–¹è¿”å›çš„ç¡®è®¤ä¿¡æ¯å¿«é€Ÿåˆ¤æ–­å“ªäº›æ•°æ®åŒ…å·²ç»ä¸¢å¤±ï¼Œå¹¶è¿…é€Ÿè¿›è¡Œé‡ä¼ ã€‚</p><p><strong>é€‰æ‹©æ€§ç¡®è®¤ï¼ˆSelective Acknowledgment, SACKï¼‰</strong>ï¼š KCPæ”¯æŒSACKï¼Œè¿™å…è®¸æ¥æ”¶ç«¯å‘ŠçŸ¥å‘é€ç«¯å“ªäº›åŒ…å·²ç»æ”¶åˆ°ï¼Œä»è€Œä»…é‡ä¼ æœªè¢«ç¡®è®¤æ¥æ”¶çš„æ•°æ®åŒ…ï¼Œå‡å°‘ä¸å¿…è¦çš„é‡ä¼ ã€‚</p><p><strong>æ— è¿æ¥æ“ä½œ</strong>ï¼š åŸºäº UDP çš„å®ç°ä½¿å¾— KCPåœ¨ä¼ è¾“æ•°æ®å‰ä¸éœ€è¦åƒ TCPé‚£æ ·è¿›è¡Œä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥ï¼Œè¿™å‡å°‘äº†åˆå§‹çš„å»¶è¿Ÿï¼Œå¹¶ä½¿å…¶èƒ½åœ¨è¿æ¥æ€§è¾ƒå·®çš„ç½‘ç»œç¯å¢ƒä¸‹æ›´åŠ çµæ´»å’Œå¿«é€Ÿã€‚</p><p><strong>æ‹¥å¡æ§åˆ¶</strong>ï¼š KCP å®ç°äº†ç±»ä¼¼ TCPçš„æ‹¥å¡æ§åˆ¶ç®—æ³•ï¼Œä½†æ›´ä¸ºç®€åŒ–ï¼Œèƒ½å¤Ÿå¿«é€Ÿé€‚åº”ç½‘ç»œæ¡ä»¶çš„å˜åŒ–ï¼Œå¦‚å¸¦å®½æ³¢åŠ¨å’Œä¸¢åŒ…ã€‚</p><p><strong>æµé‡æ§åˆ¶</strong>ï¼š KCPå…è®¸è°ƒæ•´å‘é€å’Œæ¥æ”¶çš„çª—å£å¤§å°ï¼Œä½¿å¾—å‘é€æ–¹å¯ä»¥æ ¹æ®æ¥æ”¶æ–¹çš„å¤„ç†èƒ½åŠ›å’Œç½‘ç»œæ¡ä»¶è°ƒæ•´æ•°æ®å‘é€é€Ÿç‡ï¼Œä¼˜åŒ–ç½‘ç»œåˆ©ç”¨ç‡å’Œå‡å°‘æ‹¥å¡ã€‚</p><p><strong>å¯é…ç½®çš„ä¼ è¾“ç­–ç•¥</strong>ï¼š KCPå…è®¸ç”¨æˆ·æ ¹æ®åº”ç”¨éœ€æ±‚è°ƒæ•´å†…éƒ¨å‚æ•°ï¼Œå¦‚ä¼ è¾“é—´éš”ã€çª—å£å¤§å°ç­‰ï¼Œä»¥è¾¾åˆ°æœ€ä¼˜çš„ä¼ è¾“æ•ˆç‡å’Œå»¶è¿Ÿã€‚</p><p><strong>å‰å‘é”™è¯¯æ ¡æ­£ï¼ˆForward Error Correction, FECï¼‰</strong>ï¼š KCPè¿˜å¯ä»¥ç»“åˆä½¿ç”¨ FECæŠ€æœ¯ï¼Œé€šè¿‡å‘é€é¢å¤–çš„å†—ä½™æ•°æ®æ¥æ¢å¤ä¸¢å¤±çš„åŒ…ï¼Œè¿›ä¸€æ­¥æé«˜åœ¨é«˜ä¸¢åŒ…ç¯å¢ƒä¸‹çš„æ•°æ®ä¼ è¾“å¯é æ€§ã€‚</p><h2 id="ä¸ºä»€ä¹ˆ-tcp-åšä¸åˆ°-kcp-è¿™æ ·">ä¸ºä»€ä¹ˆ TCP åšä¸åˆ° KCP è¿™æ ·ï¼Ÿ</h2><p>TCPä½œä¸ºä¸€ç§æˆç†Ÿä¸”å¹¿æ³›ä½¿ç”¨çš„ä¼ è¾“åè®®ï¼Œåœ¨è®¾è®¡ä¸Šæ³¨é‡å¯é æ€§å’Œé€šç”¨æ€§ï¼Œå› æ­¤åœ¨æ‹¥å¡æ§åˆ¶å’Œæµé‡æ§åˆ¶æ–¹é¢ç›¸å¯¹ä¿å®ˆï¼Œä»¥ç¡®ä¿åœ¨å„ç§ç½‘ç»œæ¡ä»¶ä¸‹éƒ½èƒ½ç¨³å®šè¿è¡Œã€‚ç„¶è€Œï¼Œè¿™äº›è®¾è®¡ä¸Šçš„ä¿å®ˆæ€§ä¹Ÿå¯¼è‡´äº†TCP åœ¨æŸäº›æƒ…å†µä¸‹çš„çµæ´»æ€§å’Œè‡ªé€‚åº”æ€§ä¸å¦‚ KCPã€‚</p><table><thead><tr class="header"><th>ç‰¹æ€§ç±»åˆ«</th><th>åè®®</th><th>æè¿°</th></tr></thead><tbody><tr class="odd"><td>æ‹¥å¡æ§åˆ¶æœºåˆ¶</td><td>TCP</td><td>å›ºå®šç®—æ³•ï¼ˆæ…¢å¯åŠ¨ã€æ‹¥å¡é¿å…ç­‰ï¼‰ï¼Œä¿å®ˆçš„è°ƒæ•´ç­–ç•¥ï¼ˆæŒ‡æ•°å’Œçº¿æ€§å¢é•¿ï¼‰</td></tr><tr class="even"><td></td><td>KCP</td><td>çµæ´»ç®—æ³•ï¼ŒåŠ¨æ€è°ƒæ•´ç­–ç•¥ï¼Œå¿«é€Ÿè°ƒæ•´çª—å£å¤§å°</td></tr><tr class="odd"><td>é‡ä¼ æœºåˆ¶çš„å»¶è¿Ÿ</td><td>TCP</td><td>å›ºå®šé‡ä¼ é—´éš”ï¼ˆRTOï¼‰ï¼Œå¤šæ¬¡ç¡®è®¤è§¦å‘é‡ä¼ ï¼Œéœ€è¦ä¸»åŠ¨å¼€å¯é€‰æ‹©æ€§é‡ä¼ ï¼ˆSACKï¼‰</td></tr><tr class="even"><td></td><td>KCP</td><td>å¿«é€Ÿé‡ä¼ ï¼Œé€‰æ‹©æ€§é‡ä¼ ï¼Œå‡å°‘é‡ä¼ å»¶è¿Ÿ</td></tr><tr class="odd"><td>æµé‡æ§åˆ¶</td><td>TCP</td><td>å›ºå®šæµé‡æ§åˆ¶ï¼ˆä¾èµ–æ¥æ”¶çª—å£å’Œå‘é€çª—å£ï¼‰ï¼Œé€šç”¨æ€§è®¾è®¡</td></tr><tr class="even"><td></td><td>KCP</td><td>è‡ªé€‚åº”æµé‡æ§åˆ¶ï¼Œåº”ç”¨å±‚åé¦ˆè°ƒæ•´å‘é€çª—å£å’Œé‡ä¼ ç­–ç•¥</td></tr><tr class="odd"><td>åº”ç”¨åœºæ™¯</td><td>TCP</td><td>å¹¿æ³›åº”ç”¨äºå„ç§ç½‘ç»œç¯å¢ƒï¼Œæ ‡å‡†åŒ–è¦æ±‚é«˜</td></tr><tr class="even"><td></td><td>KCP</td><td>ä¼˜åŒ–ç‰¹å®šåœºæ™¯ï¼ˆå¦‚é«˜ä¸¢åŒ…ç‡å’Œé«˜å»¶è¿Ÿç½‘ç»œï¼‰ï¼Œçµæ´»å®ç°</td></tr></tbody></table><h3 id="æ‹¥å¡æ§åˆ¶æœºåˆ¶çš„å›ºå®šæ€§">1. æ‹¥å¡æ§åˆ¶æœºåˆ¶çš„å›ºå®šæ€§</h3><p><strong>TCP</strong>ï¼š</p><ul><li><strong>å›ºå®šç®—æ³•</strong>ï¼šTCP çš„æ‹¥å¡æ§åˆ¶ç®—æ³•ï¼Œå¦‚æ…¢å¯åŠ¨ï¼ˆSlowStartï¼‰ã€æ‹¥å¡é¿å…ï¼ˆCongestion Avoidanceï¼‰ã€å¿«é€Ÿé‡ä¼ ï¼ˆFastRetransmitï¼‰å’Œå¿«é€Ÿæ¢å¤ï¼ˆFastRecoveryï¼‰ï¼Œåœ¨è®¾è®¡æ—¶è€ƒè™‘äº†å¹¿æ³›çš„å…¼å®¹æ€§å’Œå¯é æ€§ã€‚è¿™äº›ç®—æ³•è™½ç„¶æœ‰æ•ˆï¼Œä½†å…¶è°ƒæ•´æœºåˆ¶ç›¸å¯¹å›ºå®šï¼Œå“åº”é€Ÿåº¦è¾ƒæ…¢ã€‚</li><li><strong>ä¿å®ˆçš„è°ƒæ•´ç­–ç•¥</strong>ï¼šTCPçš„æ‹¥å¡æ§åˆ¶ç®—æ³•é‡‡ç”¨äº†ä¿å®ˆçš„è°ƒæ•´ç­–ç•¥ï¼Œä¾‹å¦‚æŒ‡æ•°å¢é•¿å’Œçº¿æ€§å¢é•¿ï¼Œè¿™åœ¨é«˜ä¸¢åŒ…ç‡æˆ–é«˜å»¶è¿Ÿç½‘ç»œä¸­ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ‹¥å¡çª—å£ï¼ˆcwndï¼‰å¢é•¿é€Ÿåº¦è¾ƒæ…¢ï¼Œå½±å“ä¼ è¾“æ•ˆç‡ã€‚</li></ul><p><strong>KCP</strong>ï¼š</p><ul><li><strong>çµæ´»ç®—æ³•</strong>ï¼šKCPçš„æ‹¥å¡æ§åˆ¶æœºåˆ¶æ›´ä¸ºçµæ´»ï¼Œå¯ä»¥æ ¹æ®å®æ—¶ç½‘ç»œçŠ¶å†µè¿›è¡Œå¿«é€Ÿè°ƒæ•´ã€‚ä¾‹å¦‚ï¼ŒKCPçš„å¿«é€Ÿé‡ä¼ å’Œé€‰æ‹©æ€§é‡ä¼ æœºåˆ¶ï¼Œä½¿å…¶èƒ½æ›´å¿«é€Ÿåœ°å“åº”ç½‘ç»œä¸¢åŒ…æƒ…å†µã€‚</li><li><strong>åŠ¨æ€è°ƒæ•´ç­–ç•¥</strong>ï¼šKCPçš„æ‹¥å¡çª—å£è°ƒæ•´æ›´ä¸ºçµæ´»ï¼Œå¯ä»¥æ ¹æ®ç½‘ç»œçŠ¶å†µå¿«é€Ÿå¢åŠ æˆ–å‡å°‘çª—å£å¤§å°ï¼Œæé«˜ä¼ è¾“æ•ˆç‡ã€‚</li></ul><h3 id="é‡ä¼ æœºåˆ¶çš„å»¶è¿Ÿ">2. é‡ä¼ æœºåˆ¶çš„å»¶è¿Ÿ</h3><p><strong>TCP</strong>ï¼š</p><ul><li><strong>å›ºå®šé‡ä¼ é—´éš”</strong>ï¼šTCPä½¿ç”¨å›ºå®šçš„é‡ä¼ è¶…æ—¶ï¼ˆRTOï¼‰ï¼Œå¹¶éšç€æ¯æ¬¡é‡ä¼ é€æ¸å¢åŠ ï¼ˆæŒ‡æ•°å›é€€ï¼‰ï¼Œè¿™ç§ä¿å®ˆçš„é‡ä¼ æœºåˆ¶åœ¨é«˜å»¶è¿Ÿå’Œé«˜ä¸¢åŒ…ç‡ç½‘ç»œä¸­å¯èƒ½å¯¼è‡´é‡ä¼ å»¶è¿Ÿè¾ƒé•¿ã€‚</li><li><strong>å¤šæ¬¡ç¡®è®¤è§¦å‘é‡ä¼ </strong>ï¼šTCP çš„å¿«é€Ÿé‡ä¼ éœ€è¦ç­‰å¾…ä¸‰ä¸ªé‡å¤çš„ACK æ‰èƒ½è§¦å‘ï¼Œè¿™åœ¨ä¸¢åŒ…ç‡è¾ƒé«˜çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šå¯¼è‡´è¾ƒé•¿çš„å»¶è¿Ÿã€‚</li></ul><p><strong>KCP</strong>ï¼š</p><ul><li><strong>å¿«é€Ÿé‡ä¼ </strong>ï¼šKCPåœ¨æ£€æµ‹åˆ°ä¸¢åŒ…åç«‹å³è¿›è¡Œé‡ä¼ ï¼Œè€Œä¸éœ€è¦ç­‰å¾…å¤šä¸ªé‡å¤çš„ACKï¼Œè¿™æ˜¾è‘—å‡å°‘äº†é‡ä¼ å»¶è¿Ÿã€‚</li><li><strong>é€‰æ‹©æ€§é‡ä¼ </strong>ï¼šKCPåªé‡ä¼ ä¸¢å¤±çš„æ•°æ®åŒ…ï¼Œè€Œä¸æ˜¯æ‰€æœ‰æœªç¡®è®¤çš„æ•°æ®åŒ…ï¼Œå‡å°‘äº†ä¸å¿…è¦çš„é‡ä¼ å¼€é”€ã€‚ï¼ˆTCPå…¶å®ä¹Ÿæ”¯æŒé€‰æ‹©æ€§é‡ä¼  SACKï¼‰</li></ul><h3 id="æµé‡æ§åˆ¶çš„çµæ´»æ€§">3. æµé‡æ§åˆ¶çš„çµæ´»æ€§</h3><p><strong>TCP</strong>ï¼š</p><ul><li><strong>å›ºå®šæµé‡æ§åˆ¶</strong>ï¼šTCPçš„æµé‡æ§åˆ¶ä¸»è¦ä¾èµ–äºæ¥æ”¶çª—å£ï¼ˆrwndï¼‰å’Œå‘é€çª—å£ï¼ˆswndï¼‰ï¼Œåœ¨å¤„ç†çªå‘æµé‡æˆ–å˜åŒ–è¾ƒå¤§çš„ç½‘ç»œæ¡ä»¶æ—¶ï¼Œè°ƒæ•´é€Ÿåº¦è¾ƒæ…¢ã€‚</li><li><strong>é€šç”¨æ€§è®¾è®¡</strong>ï¼šTCPä½œä¸ºä¸€ç§é€šç”¨åè®®ï¼Œå…¶è®¾è®¡å¿…é¡»å…¼é¡¾å„ç§ç½‘ç»œç¯å¢ƒï¼Œå› æ­¤åœ¨æµé‡æ§åˆ¶ä¸Šç›¸å¯¹ä¿å®ˆï¼Œä»¥ç¡®ä¿åœ¨ä»»ä½•ç¯å¢ƒä¸‹éƒ½èƒ½ç¨³å®šè¿è¡Œã€‚</li></ul><p><strong>KCP</strong>ï¼š</p><ul><li><strong>è‡ªé€‚åº”æµé‡æ§åˆ¶</strong>ï¼šKCPçš„æµé‡æ§åˆ¶æœºåˆ¶å¯ä»¥æ ¹æ®å®é™…åº”ç”¨éœ€æ±‚è¿›è¡Œæ›´ç»†ç²’åº¦çš„è°ƒæ•´ã€‚ä¾‹å¦‚ï¼ŒKCPå¯ä»¥æ ¹æ®å»¶è¿ŸæŠ–åŠ¨ã€ä¸¢åŒ…ç‡ç­‰åŠ¨æ€å‚æ•°è°ƒæ•´å‘é€é€Ÿç‡ï¼Œç¡®ä¿åœ¨ä¸åŒç½‘ç»œæ¡ä»¶ä¸‹éƒ½èƒ½ä¿æŒé«˜æ•ˆä¼ è¾“ã€‚</li><li><strong>åº”ç”¨å±‚åé¦ˆ</strong>ï¼šKCPå¯ä»¥æ ¹æ®åº”ç”¨å±‚çš„å®æ—¶åé¦ˆï¼ŒåŠ¨æ€è°ƒæ•´å‘é€çª—å£å’Œé‡ä¼ ç­–ç•¥ï¼Œè¿›ä¸€æ­¥ä¼˜åŒ–ä¼ è¾“æ•ˆç‡ã€‚</li></ul><h3 id="åº”ç”¨åœºæ™¯çš„å·®å¼‚">4. åº”ç”¨åœºæ™¯çš„å·®å¼‚</h3><p><strong>TCP</strong>ï¼š</p><ul><li><strong>å¹¿æ³›åº”ç”¨</strong>ï¼šTCPè®¾è®¡ç”¨äºå¹¿æ³›çš„ç½‘ç»œç¯å¢ƒï¼ŒåŒ…æ‹¬ç¨³å®šçš„æœ‰çº¿ç½‘ç»œå’Œä¸ç¨³å®šçš„æ— çº¿ç½‘ç»œï¼Œå› æ­¤å…¶æœºåˆ¶å¿…é¡»è¶³å¤Ÿé€šç”¨å’Œä¿å®ˆï¼Œä¿è¯åœ¨å„ç§æƒ…å†µä¸‹çš„å¯é æ€§ã€‚</li><li><strong>æ ‡å‡†åŒ–è¦æ±‚</strong>ï¼šä½œä¸ºäº’è”ç½‘çš„åŸºç¡€åè®®ï¼ŒTCPçš„å„é¡¹æœºåˆ¶ç»è¿‡ä¸¥æ ¼æ ‡å‡†åŒ–ï¼Œä»»ä½•ä¿®æ”¹éƒ½éœ€è¦å¹¿æ³›æµ‹è¯•å’ŒéªŒè¯ï¼Œä»¥ç¡®ä¿ä¸ä¼šå½±å“ç°æœ‰ç½‘ç»œçš„ç¨³å®šæ€§ã€‚</li></ul><p><strong>KCP</strong>ï¼š</p><ul><li><strong>ç‰¹å®šä¼˜åŒ–</strong>ï¼šKCPè®¾è®¡åˆè¡·æ˜¯ä¼˜åŒ–ç‰¹å®šåœºæ™¯ä¸‹çš„ä¼ è¾“æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯é«˜ä¸¢åŒ…ç‡å’Œé«˜å»¶è¿Ÿç½‘ç»œï¼Œå› æ­¤åœ¨è®¾è®¡ä¸Šæ›´åŠ çµæ´»ï¼Œèƒ½å¤Ÿæ ¹æ®å®æ—¶ç½‘ç»œçŠ¶å†µè¿›è¡Œè°ƒæ•´ã€‚</li><li><strong>çµæ´»å®ç°</strong>ï¼šKCPå¯ä»¥æ ¹æ®å…·ä½“åº”ç”¨éœ€æ±‚è¿›è¡Œä¼˜åŒ–ï¼Œä¾‹å¦‚åœ¨å®æ—¶é€šä¿¡å’Œåœ¨çº¿æ¸¸æˆç­‰åœºæ™¯ä¸­ï¼Œçµæ´»çš„æµé‡æ§åˆ¶å’Œå¿«é€Ÿé‡ä¼ æœºåˆ¶æ˜¾è‘—æå‡äº†ä¼ è¾“æ•ˆç‡ã€‚</li></ul><h3 id="ç»“è®º">ç»“è®º</h3><p>è™½ç„¶ TCPåœ¨æ‹¥å¡æ§åˆ¶å’Œæµé‡æ§åˆ¶æ–¹é¢å…·å¤‡åŸºæœ¬çš„åŠ¨æ€è°ƒæ•´èƒ½åŠ›ï¼Œä½†å…¶ä¿å®ˆçš„è®¾è®¡å’Œæ ‡å‡†åŒ–è¦æ±‚ä½¿å¾—å…¶åœ¨é«˜ä¸¢åŒ…ç‡å’Œé«˜å»¶è¿Ÿç½‘ç»œä¸­çš„é€‚åº”æ€§å’Œçµæ´»æ€§ä¸å¦‚KCPã€‚KCPé€šè¿‡çµæ´»çš„æ‹¥å¡æ§åˆ¶ã€å¿«é€Ÿé‡ä¼ å’Œè‡ªé€‚åº”æµé‡æ§åˆ¶æœºåˆ¶ï¼Œèƒ½å¤Ÿæ›´æœ‰æ•ˆåœ°åº”å¯¹ä¸åŒç½‘ç»œæ¡ä»¶ä¸‹çš„ä¼ è¾“éœ€æ±‚ï¼Œæä¾›æ›´é«˜æ•ˆçš„ä¼ è¾“æ€§èƒ½ã€‚</p><h2 id="kcp-ä¸€å®šæ¯”-tcp-å¿«å—">KCP ä¸€å®šæ¯” TCP å¿«å—ï¼Ÿ</h2><p><font color="red">ä¸ä¸€å®š</font>ã€‚KCP å¹¶ä¸ä¸€å®šåœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½æ¯” TCPå¿«ã€‚è™½ç„¶ KCPåœ¨æŸäº›ç‰¹å®šç½‘ç»œç¯å¢ƒï¼ˆå¦‚é«˜ä¸¢åŒ…ç‡å’Œé«˜å»¶è¿Ÿçš„ç½‘ç»œï¼‰ä¸­è¡¨ç°æ›´ä¼˜å¼‚ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒTCPå¯èƒ½æ›´åˆé€‚ã€‚</p><h3 id="ç½‘ç»œç¯å¢ƒ">1. ç½‘ç»œç¯å¢ƒ</h3><p><strong>é«˜ä¸¢åŒ…ç‡å’Œé«˜å»¶è¿Ÿç½‘ç»œ</strong>ï¼š</p><ul><li><strong>KCP</strong>ï¼šKCPé€šè¿‡å¿«é€Ÿé‡ä¼ å’Œé€‰æ‹©æ€§é‡ä¼ æœºåˆ¶ï¼Œä»¥åŠåŠ¨æ€è°ƒæ•´çš„çª—å£å’Œé‡ä¼ é—´éš”ï¼Œèƒ½å¤Ÿæ›´å¥½åœ°åº”å¯¹é«˜ä¸¢åŒ…ç‡å’Œé«˜å»¶è¿Ÿç½‘ç»œï¼Œå‡å°‘ä¼ è¾“å»¶è¿Ÿï¼Œæé«˜ä¼ è¾“æ•ˆç‡ã€‚</li><li><strong>TCP</strong>ï¼šTCPçš„é‡ä¼ æœºåˆ¶å’Œä¿å®ˆçš„æ‹¥å¡æ§åˆ¶åœ¨è¿™ç§ç¯å¢ƒä¸­å¯èƒ½å¯¼è‡´è¾ƒé«˜çš„å»¶è¿Ÿå’Œè¾ƒä½çš„å¸¦å®½åˆ©ç”¨ç‡ã€‚</li></ul><p><strong>ä½ä¸¢åŒ…ç‡å’Œä½å»¶è¿Ÿç½‘ç»œ</strong>ï¼š</p><ul><li><strong>KCP</strong>ï¼šåœ¨ç¨³å®šçš„ä½ä¸¢åŒ…ç‡å’Œä½å»¶è¿Ÿç½‘ç»œä¸­ï¼ŒKCPçš„é¢‘ç¹é‡ä¼ å’Œæ§åˆ¶æŠ¥æ–‡å¯èƒ½ä¼šå¯¼è‡´é¢å¤–çš„å¸¦å®½å¼€é”€ï¼Œæœªå¿…æœ‰æ˜æ˜¾çš„æ€§èƒ½ä¼˜åŠ¿ã€‚</li><li><strong>TCP</strong>ï¼šTCPåœ¨è¿™ç§ç¯å¢ƒä¸­è¡¨ç°ç¨³å®šï¼Œä¸”ç”±äºå…¶å¸¦å®½å¼€é”€è¾ƒå°ï¼Œå¯èƒ½æ¯” KCP æ›´é«˜æ•ˆã€‚</li></ul><h3 id="å¸¦å®½åˆ©ç”¨ç‡">2. å¸¦å®½åˆ©ç”¨ç‡</h3><p><strong>å¸¦å®½å……è¶³çš„ç½‘ç»œ</strong>ï¼š</p><ul><li><strong>KCP</strong>ï¼šKCPç”±äºå…¶é¢‘ç¹çš„é‡ä¼ å’Œæ§åˆ¶æŠ¥æ–‡ï¼Œå¯èƒ½ä¼šå ç”¨æ›´å¤šçš„å¸¦å®½ï¼Œä½†å¦‚æœå¸¦å®½å……è¶³ï¼Œè¿™ç§å¼€é”€å¯¹æ•´ä½“æ€§èƒ½å½±å“è¾ƒå°ï¼Œä¸”å…¶ä½å»¶è¿Ÿä¼˜åŠ¿å¯èƒ½æ›´æ˜æ˜¾ã€‚</li><li><strong>TCP</strong>ï¼šTCPçš„å¸¦å®½åˆ©ç”¨ç‡è¾ƒé«˜ï¼Œé€‚åˆå¸¦å®½å……è¶³çš„ç¯å¢ƒã€‚</li></ul><p><strong>å¸¦å®½å—é™çš„ç½‘ç»œ</strong>ï¼š</p><ul><li><strong>KCP</strong>ï¼šKCPçš„é¢å¤–å¸¦å®½å¼€é”€åœ¨å¸¦å®½å—é™çš„ç½‘ç»œä¸­å¯èƒ½ä¼šæ˜¾è‘—å½±å“æ•´ä½“ä¼ è¾“æ•ˆç‡ã€‚</li><li><strong>TCP</strong>ï¼šTCPçš„è¾ƒä½å¸¦å®½å¼€é”€ä½¿å…¶åœ¨å¸¦å®½å—é™çš„ç¯å¢ƒä¸­æ›´æœ‰ä¼˜åŠ¿ã€‚</li></ul><h3 id="åº”ç”¨åœºæ™¯">3. åº”ç”¨åœºæ™¯</h3><p><strong>å®æ—¶åº”ç”¨</strong>ï¼ˆå¦‚åœ¨çº¿æ¸¸æˆã€è§†é¢‘ä¼šè®®ï¼‰ï¼š</p><ul><li><strong>KCP</strong>ï¼šKCPçš„ä½å»¶è¿Ÿå’Œå¿«é€Ÿå“åº”èƒ½åŠ›ä½¿å…¶éå¸¸é€‚åˆå®æ—¶åº”ç”¨ï¼Œåœ¨è¿™äº›åœºæ™¯ä¸­ï¼Œä¼ è¾“çš„åŠæ—¶æ€§æ¯”å¸¦å®½åˆ©ç”¨ç‡æ›´é‡è¦ã€‚</li><li><strong>TCP</strong>ï¼šTCP åœ¨è¿™äº›åœºæ™¯ä¸­çš„è¡¨ç°å¯èƒ½ä¸å¦‚KCPï¼Œç‰¹åˆ«æ˜¯åœ¨é«˜ä¸¢åŒ…ç‡å’Œé«˜å»¶è¿Ÿçš„ç½‘ç»œä¸­ã€‚</li></ul><p><strong>éå®æ—¶åº”ç”¨</strong>ï¼ˆå¦‚æ–‡ä»¶ä¼ è¾“ã€ç½‘é¡µæµè§ˆï¼‰ï¼š</p><ul><li><strong>KCP</strong>ï¼šKCP åœ¨è¿™äº›åœºæ™¯ä¸­å¯èƒ½ä¸å¦‚ TCPé«˜æ•ˆï¼Œç‰¹åˆ«æ˜¯åœ¨ç½‘ç»œç¨³å®šä¸”å¸¦å®½æœ‰é™çš„æƒ…å†µä¸‹ã€‚</li><li><strong>TCP</strong>ï¼šTCPçš„å¯é æ€§å’Œé«˜å¸¦å®½åˆ©ç”¨ç‡ä½¿å…¶éå¸¸é€‚åˆéå®æ—¶åº”ç”¨ã€‚</li></ul><h3 id="å®ç°å’Œé…ç½®">4. å®ç°å’Œé…ç½®</h3><p><strong>å®ç°å¤æ‚æ€§</strong>ï¼š</p><ul><li><strong>KCP</strong>ï¼šå®ç°å’Œé…ç½® KCP å¯èƒ½æ¯” TCPæ›´å¤æ‚ï¼Œéœ€è¦æ ¹æ®å…·ä½“åº”ç”¨å’Œç½‘ç»œç¯å¢ƒè¿›è¡Œä¼˜åŒ–å’Œè°ƒæ•´ã€‚</li><li><strong>TCP</strong>ï¼šTCPæ˜¯ä¸€ä¸ªæˆç†Ÿçš„åè®®ï¼Œç³»ç»Ÿå’Œåº“çš„æ”¯æŒè¾ƒå¥½ï¼Œé…ç½®å’Œä½¿ç”¨ç›¸å¯¹ç®€å•ã€‚</li></ul><h3 id="æ€»ç»“">æ€»ç»“</h3><p>KCP åœ¨æŸäº›ç‰¹å®šç¯å¢ƒå’Œåº”ç”¨åœºæ™¯ä¸­ç¡®å®æ¯” TCPæ›´å¿«ï¼Œå°¤å…¶æ˜¯é«˜ä¸¢åŒ…ç‡å’Œé«˜å»¶è¿Ÿçš„ç½‘ç»œç¯å¢ƒï¼Œä»¥åŠå¯¹ä½å»¶è¿Ÿè¦æ±‚è¾ƒé«˜çš„å®æ—¶åº”ç”¨ã€‚ä½†åœ¨ç½‘ç»œç¨³å®šã€å¸¦å®½æœ‰é™æˆ–éå®æ—¶åº”ç”¨åœºæ™¯ä¸­ï¼ŒTCPå¯èƒ½è¡¨ç°æ›´å¥½ã€‚å› æ­¤ï¼Œé€‰æ‹©ä½¿ç”¨ KCP è¿˜æ˜¯ TCPåº”æ ¹æ®å…·ä½“çš„ç½‘ç»œæ¡ä»¶å’Œåº”ç”¨éœ€æ±‚è¿›è¡Œæƒè¡¡ã€‚</p><h1 id="å‰ç½®å‡†å¤‡">å‰ç½®å‡†å¤‡</h1><p>ç¬”è€…ä¸æƒ³é‚£ä¹ˆå¿«å°±è´´å‡ºå¤§æ®µå¤§æ®µçš„ä»£ç è¿›è¡Œåˆ†æï¼Œè¿™å¯èƒ½ä¼šä½¿è¯»è€…ä¸çŸ¥æ‰€äº‘ã€‚ä¸ºäº†æ›´å¥½åœ°é˜è¿°KCPçš„åº•å±‚åŸç†ï¼Œç¬”è€…çš„è®¾æƒ³æ˜¯å…ˆå¯¹åŸç†éƒ¨åˆ†è¿›è¡Œæ¦‚è¦æ€»ç»“ï¼Œç„¶åå†å¸¦ç€è¿™äº›ç»“è®ºå»åˆ†ææºç ï¼Œè¿›ä¸€æ­¥å¡«å……é‡Œé¢çš„è¾¹è§’ç»†èŠ‚ã€‚</p><p>ä½†æ˜¯å‘¢ï¼Œä¸ºäº†æ›´å¥½åœ°ç†è§£ KCPçš„åŸç†ï¼Œåˆä¸å¾—ä¸å¯¹æ¶‰åŠæºç çš„ä¸€äº›é‡è¦è®¾è®¡ï¼Œä¸ºäº†é¿å…åœ¨åŸç†åˆ†æé˜¶æ®µï¼Œå¯¹æºç è¿›è¡Œè¿‡å¤šçš„æ¶‰åŠï¼Œç¬”è€…å†³å®šæ·»åŠ è¿™å•ç‹¬çš„ä¸€ç« å†…å®¹ï¼Œå¯¹KCP çš„â€œæ¥å£è®¾è®¡â€ã€â€œæŠ¥æ–‡æ®µâ€ã€â€œKCPæ§åˆ¶å—â€ä»¥åŠâ€œé˜Ÿåˆ—å’Œç¼“å†²åŒºâ€å…ˆè¿›è¡Œç®€è¦æ¦‚è¿°ï¼Œä»¥è¾…åŠ©è¯»è€…æ›´å¥½åœ°ç†è§£åç»­çš„å†…å®¹ã€‚</p><h2 id="æ¥å£è®¾è®¡">æ¥å£è®¾è®¡</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240612171839051.png"alt="KCP å·¥ä½œç®€çº¦å›¾" /><figcaption aria-hidden="true">KCP å·¥ä½œç®€çº¦å›¾</figcaption></figure><p>åœ¨ <ahref="https://github.com/skywind3000/kcp/blob/master/ikcp.h">kcp.h</a>æ–‡ä»¶ä¸­ï¼Œå®šä¹‰äº† KCP æœ€æ ¸å¿ƒçš„å‡ ä¸ªæ¥å£ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„ KCP æ§åˆ¶å¯¹è±¡</span><br>ikcpcb* <span class="hljs-title function_">ikcp_create</span><span class="hljs-params">(IUINT32 conv, <span class="hljs-type">void</span> *user)</span>;<br><br><span class="hljs-comment">// é‡Šæ”¾ä¸€ä¸ª KCP æ§åˆ¶å¯¹è±¡ã€‚</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">ikcp_release</span><span class="hljs-params">(ikcpcb *kcp)</span>;<br><br><span class="hljs-comment">// è®¾ç½® KCP çš„è¾“å‡ºå›è°ƒå‡½æ•°ï¼Œè¿™ä¸ªå›è°ƒå‡½æ•°åœ¨ KCP éœ€è¦å‘é€æ•°æ®æ—¶è¢«è°ƒç”¨ã€‚</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">ikcp_setoutput</span><span class="hljs-params">(ikcpcb *kcp, <span class="hljs-type">int</span> (*output)(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">int</span> len,</span><br><span class="hljs-params">ikcpcb *kcp, <span class="hljs-type">void</span> *user))</span>;<br><br><span class="hljs-comment">// ä» KCP çš„æ¥æ”¶é˜Ÿåˆ—ä¸­æ¥æ”¶æ•°æ®ï¼Œç”¨äºä¸Šå±‚ä» KCP ä¸­è¯»å–æ•°æ®ã€‚</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">ikcp_recv</span><span class="hljs-params">(ikcpcb *kcp, <span class="hljs-type">char</span> *buffer, <span class="hljs-type">int</span> len)</span>;<br><br><span class="hljs-comment">// å‘ KCP çš„å‘é€é˜Ÿåˆ—ä¸­æ·»åŠ æ•°æ®ï¼Œç”¨äºä¸Šå±‚å‘ KCP å‘é€æ•°æ®ï¼ŒKCP ä¼šç®¡ç†è¿™äº›æ•°æ®å¹¶è´Ÿè´£å…¶å¯é ä¼ è¾“ã€‚</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">ikcp_send</span><span class="hljs-params">(ikcpcb *kcp, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *buffer, <span class="hljs-type">int</span> len)</span>;<br><br><span class="hljs-comment">// æ›´æ–° KCP çš„å†…éƒ¨çŠ¶æ€ï¼Œé€šå¸¸éœ€è¦å®šæœŸè°ƒç”¨ã€‚</span><br><span class="hljs-comment">// è¿™ä¸ªå‡½æ•°è´Ÿè´£å¤„ç† KCP çš„è¶…æ—¶ã€é‡ä¼ ç­‰æ“ä½œï¼Œéœ€è¦åœ¨ä¸€å®šçš„æ—¶é—´é—´éš”å†…åå¤è°ƒç”¨ï¼ˆé€šå¸¸æ¯ 10-100 æ¯«ç§’ï¼‰ã€‚</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">ikcp_update</span><span class="hljs-params">(ikcpcb *kcp, IUINT32 current)</span>;<br><br><span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦è¦è°ƒç”¨ ikcp_update</span><br>IUINT32 <span class="hljs-title function_">ikcp_check</span><span class="hljs-params">(<span class="hljs-type">const</span> ikcpcb *kcp, IUINT32 current)</span>;<br><br><span class="hljs-comment">// å¤„ç†æ¥æ”¶åˆ°çš„ä½å±‚æ•°æ®åŒ…ï¼ˆä¾‹å¦‚ UDP åŒ…ï¼‰ã€‚</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">ikcp_input</span><span class="hljs-params">(ikcpcb *kcp, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *data, <span class="hljs-type">long</span> size)</span>;<br><br><span class="hljs-comment">// å°†ç¼“å†²åŒºå¯ä»¥å‘é€çš„åŒ…å‘é€å‡ºå»ï¼Œä¼šåœ¨ ikcp_update ä¸­è¢«è°ƒç”¨ã€‚</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">ikcp_flush</span><span class="hljs-params">(ikcpcb *kcp)</span>;<br></code></pre></td></tr></table></figure><ul><li><p><code>ikcp_create</code>:</p><ul><li><code>conv</code>:ä¼šè¯æ ‡è¯†ç¬¦ï¼Œç”¨äºæ ‡è¯†ä¸¤ä¸ªç«¯ç‚¹ä¹‹é—´çš„è¿æ¥ã€‚è¿™ä¸ªæ ‡è¯†ç¬¦åœ¨ä¸¤ä¸ªé€šä¿¡ç«¯ç‚¹ä¹‹é—´å¿…é¡»ä¸€è‡´ã€‚</li><li><code>user</code>: ç”¨æˆ·æ•°æ®æŒ‡é’ˆï¼Œå¯ä»¥ä¼ é€’ä»»æ„ç”¨æˆ·æ•°æ®ï¼Œè¿™ä¸ªæ•°æ®åœ¨KCP çš„ <code>output</code> å›è°ƒä¸­ä¼šè¢«ä¼ é€’å›å»ã€‚</li><li><strong>è¿”å›å€¼</strong>: ä¸€ä¸ªæŒ‡å‘æ–°åˆ›å»ºçš„ KCPæ§åˆ¶å—ï¼ˆ<code>ikcpcb</code>ï¼‰çš„æŒ‡é’ˆã€‚</li></ul></li><li><p><code>ikcp_release</code>: é‡Šæ”¾ä¸€ä¸ª KCP æ§åˆ¶å¯¹è±¡ã€‚</p></li><li><p><code>ikcp_setoutput</code>: è®¾ç½® KCP çš„è¾“å‡ºå›è°ƒå‡½æ•°ã€‚</p><ul><li><p><code>output</code>: è¾“å‡ºå›è°ƒå‡½æ•°æŒ‡é’ˆã€‚è¿™ä¸ªå›è°ƒå‡½æ•°åœ¨ KCPéœ€è¦å‘é€æ•°æ®æ—¶è¢«è°ƒç”¨ã€‚</p><ul><li><code>buf</code>: è¦å‘é€çš„æ•°æ®ç¼“å†²åŒºã€‚</li><li><code>len</code>: æ•°æ®é•¿åº¦ã€‚</li><li><code>kcp</code>: å½“å‰çš„ KCP å¯¹è±¡ã€‚</li><li><code>user</code>: ç”¨æˆ·æ•°æ®ã€‚</li></ul><p>é€šè¿‡è¿™ä¸ªå›è°ƒï¼ŒKCP å¯ä»¥å°†è¦å‘é€çš„æ•°æ®ä¼ é€’ç»™ä¸‹å±‚çš„ç½‘ç»œå±‚ï¼Œæ¯”å¦‚ UDPå¥—æ¥å­—ã€‚</p></li></ul></li><li><p><code>ikcp_recv</code>: ä» KCP çš„æ¥æ”¶é˜Ÿåˆ—ä¸­æ¥æ”¶æ•°æ®ã€‚</p><ul><li><code>kcp</code>: KCP æ§åˆ¶å¯¹è±¡çš„æŒ‡é’ˆã€‚</li><li><code>buffer</code>: ç”¨æˆ·æä¾›çš„ç¼“å†²åŒºï¼Œç”¨äºå­˜å‚¨æ¥æ”¶åˆ°çš„æ•°æ®ã€‚</li><li><code>len</code>: ç¼“å†²åŒºçš„é•¿åº¦ã€‚</li><li><strong>è¿”å›å€¼</strong>:æˆåŠŸæ¥æ”¶çš„æ•°æ®å¤§å°ï¼›å¦‚æœæ²¡æœ‰æ•°æ®å¯æ¥æ”¶ï¼Œè¿”å›è´Ÿå€¼ï¼ˆä¾‹å¦‚ï¼ŒEAGAINï¼‰ã€‚</li></ul><p>è¿™ä¸ªå‡½æ•°ç”¨äºä¸Šå±‚ä» KCP ä¸­è¯»å–æ•°æ®ã€‚</p></li><li><p><code>ikcp_send</code>: å‘ KCP çš„å‘é€é˜Ÿåˆ—ä¸­æ·»åŠ æ•°æ®ã€‚</p><ul><li><code>kcp</code>: KCP æ§åˆ¶å¯¹è±¡çš„æŒ‡é’ˆã€‚</li><li><code>buffer</code>: è¦å‘é€çš„æ•°æ®ç¼“å†²åŒºã€‚</li><li><code>len</code>: æ•°æ®çš„é•¿åº¦ã€‚</li><li><strong>è¿”å›å€¼</strong>:æˆåŠŸå‘é€çš„æ•°æ®å¤§å°ï¼›å¦‚æœå‘é€å¤±è´¥ï¼Œè¿”å›è´Ÿå€¼ã€‚</li></ul><p>è¿™ä¸ªå‡½æ•°ç”¨äºä¸Šå±‚å‘ KCP å‘é€æ•°æ®ï¼ŒKCPä¼šç®¡ç†è¿™äº›æ•°æ®å¹¶è´Ÿè´£å…¶å¯é ä¼ è¾“ã€‚</p></li><li><p><code>ikcp_update</code>: æ›´æ–° KCPçš„å†…éƒ¨çŠ¶æ€ï¼Œé€šå¸¸éœ€è¦å®šæœŸè°ƒç”¨ã€‚</p><ul><li><code>kcp</code>: KCP æ§åˆ¶å¯¹è±¡çš„æŒ‡é’ˆã€‚</li><li><code>current</code>: å½“å‰çš„æ—¶é—´æˆ³ï¼ˆä»¥æ¯«ç§’ä¸ºå•ä½ï¼‰ã€‚</li></ul><p>è¿™ä¸ªå‡½æ•°è´Ÿè´£å¤„ç† KCPçš„è¶…æ—¶ã€é‡ä¼ ç­‰æ“ä½œï¼Œéœ€è¦åœ¨ä¸€å®šçš„æ—¶é—´é—´éš”å†…åå¤è°ƒç”¨ï¼ˆé€šå¸¸æ¯ 10-100æ¯«ç§’ï¼‰ã€‚</p></li><li><p><code>ikcp_input</code>: å¤„ç†æ¥æ”¶åˆ°çš„ä½å±‚æ•°æ®åŒ…ï¼ˆä¾‹å¦‚ UDPåŒ…ï¼‰ã€‚</p><ul><li><code>kcp</code>: KCP æ§åˆ¶å¯¹è±¡çš„æŒ‡é’ˆã€‚</li><li><code>data</code>: æ”¶åˆ°çš„æ•°æ®ç¼“å†²åŒºã€‚</li><li><code>size</code>: æ•°æ®çš„é•¿åº¦ã€‚</li><li><strong>è¿”å›å€¼</strong>:æˆåŠŸå¤„ç†çš„æ•°æ®å¤§å°ï¼›å¦‚æœå¤„ç†å¤±è´¥ï¼Œè¿”å›è´Ÿå€¼ã€‚</li></ul></li><li><p><code>ikcp_flush</code>: åˆ·æ–°å¾…å‘é€çš„æ•°æ®ã€‚</p></li></ul><p>å…¶ä¸­æœ€é‡è¦çš„æ˜¯è¿™ 4 ä¸ªï¼š</p><ul><li><code>ikcp_send</code>: å°†æ•°æ®æ”¾åœ¨å‘é€é˜Ÿåˆ—ä¸­ç­‰å¾…å‘é€ã€‚</li><li><code>ikcp_recv</code>: ä»æ¥æ”¶é˜Ÿåˆ—ä¸­è¯»å–æ•°æ®ã€‚</li><li><code>ikcp_input</code>:è¯»å–ä¸‹å±‚åè®®è¾“å…¥æ•°æ®ï¼Œè§£ææŠ¥æ–‡æ®µï¼Œå¦‚æœæ˜¯æ•°æ®ï¼Œå°±å°†æ•°æ®æ”¾å…¥æ¥æ”¶ç¼“å†²åŒºï¼Œå¦‚æœæ˜¯ACKï¼Œå°±åœ¨å‘é€ç¼“å†²åŒºä¸­æ ‡è®°å¯¹åº”çš„æŠ¥æ–‡æ®µå·²é€è¾¾ã€‚</li><li><code>ikcp_flush</code>:è°ƒç”¨è¾“å‡ºå›è°ƒå°†å‘é€ç¼“å†²åŒºçš„æ•°æ®å‘é€å‡ºå»ã€‚</li></ul><p>è¿™é‡Œå°±å…ˆç®€è¦ä»‹ç»åˆ°è¿™é‡Œï¼Œåé¢åœ¨æºç åˆ†æç¯‡ç« å†å¯¹è¿™äº›æ¥å£è¿›è¡Œè¯¦ç»†åˆ†æã€‚</p><h2 id="æŠ¥æ–‡æ®µ">æŠ¥æ–‡æ®µ</h2><p>KCP çš„æŠ¥æ–‡æ®µå¤§å°ä¸º 24 å­—èŠ‚ï¼Œç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240612172557464.png" alt="KCP æŠ¥æ–‡æ®µ" style="zoom: 33%;" /></p><p>æ¯ä¸ªå­—æ®µçš„å«ä¹‰å¦‚ä¸‹ï¼š</p><ul><li><code>conv</code>: è¿æ¥æ ‡è¯†</li><li><code>cmd</code>ï¼šæŠ¥æ–‡ç±»å‹</li><li><code>frg</code>ï¼šåˆ†ç‰‡æ•°é‡ï¼Œè¡¨ç¤ºéšåè¿˜æœ‰å¤šå°‘ä¸ªæŠ¥æ–‡å±äºåŒä¸€ä¸ªåŒ…</li><li><code>wnd</code>ï¼šå‘é€æ–¹å‰©ä½™æ¥æ”¶çª—å£çš„å¤§å°</li><li><code>ts</code>ï¼šæ—¶é—´æˆ³</li><li><code>sn</code>ï¼šæŠ¥æ–‡ç¼–å·</li><li><code>una</code>ï¼šå‘é€æ–¹çš„æ¥æ”¶ç¼“å†²åŒºä¸­æœ€å°è¿˜æœªæ”¶åˆ°çš„æŠ¥æ–‡æ®µçš„ç¼–å·ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯”å®ƒå°çš„æŠ¥æ–‡æ®µéƒ½å·²å…¨éƒ¨æ¥æ”¶</li><li><code>len</code>ï¼šæ•°æ®æ®µé•¿åº¦</li><li><code>data</code>ï¼šæ•°æ®æ®µï¼Œåªæœ‰æ•°æ®æŠ¥æ–‡ä¼šæœ‰è¿™ä¸ªå­—æ®µ</li></ul><p>å…¶ä¸­ <code>cmd</code> å…±æœ‰ 4 ç§æŠ¥æ–‡ç±»å‹ï¼š</p><ul><li>æ•°æ®æŠ¥æ–‡ï¼šIKCP_CMD_PUSH</li><li>ç¡®è®¤æŠ¥æ–‡ï¼šIKCP_CMD_ACK</li><li>çª—å£æ¢æµ‹æŠ¥æ–‡ï¼šIKCP_CMD_WASK è¯¢é—®å¯¹ç«¯å‰©ä½™æ¥æ”¶çª—å£çš„å¤§å°</li><li>çª—å£é€šçŸ¥æŠ¥æ–‡ï¼šIKCP_CMD_WINS é€šçŸ¥å¯¹ç«¯å‰©ä½™æ¥æ”¶çª—å£çš„å¤§å°</li></ul><p>åœ¨ KCP ä¸­ï¼ŒæŠ¥æ–‡æ®µç»“æ„å®šä¹‰åœ¨ <ahref="https://github.com/skywind3000/kcp/blob/master/ikcp.h">kcp.h</a>æ–‡ä»¶ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">IKCPSEG</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">IQUEUEHEAD</span> <span class="hljs-title">node</span>;</span><br>IUINT32 conv;<br>IUINT32 cmd;<br>IUINT32 frg;<br>IUINT32 wnd;<br>IUINT32 ts;<br>IUINT32 sn;<br>IUINT32 una;<br>IUINT32 len;<br>IUINT32 resendts;<br>IUINT32 rto;<br>IUINT32 fastack;<br>IUINT32 xmit;<br><span class="hljs-type">char</span> data[<span class="hljs-number">1</span>];<br>&#125;;<br></code></pre></td></tr></table></figure><p><code>IKCPSEG</code> ç»“æ„è¿˜å¤šå‡ºäº†å‡ ä¸ªå­—æ®µï¼Œè¿™æ˜¯ä¸ºäº†æ”¯æŒ KCPåè®®çš„å¯é æ€§å’Œæ•ˆç‡ï¼š</p><ul><li><code>resendts</code>:è®°å½•æŠ¥æ–‡çš„ä¸‹æ¬¡é‡ä¼ æ—¶é—´ï¼Œç”¨äºå®ç°é‡ä¼ æœºåˆ¶ã€‚å¦‚æœæŠ¥æ–‡åœ¨ä¸€å®šæ—¶é—´å†…æ²¡æœ‰è¢«ç¡®è®¤æ”¶åˆ°ï¼Œå°±ä¼šåœ¨è¿™ä¸ªæ—¶é—´æˆ³ä¹‹åè¢«é‡æ–°å‘é€ã€‚</li><li><code>rto</code>: è¡¨ç¤ºå½“å‰æŠ¥æ–‡çš„é‡ä¼ è¶…æ—¶æ—¶é—´ï¼ˆRTTçš„ä¼°è®¡å€¼ï¼‰ã€‚ç”¨äºè®¡ç®—æ¯ä¸ªæŠ¥æ–‡çš„é‡ä¼ æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡ <code>rto</code>æ—¶é—´æ²¡æœ‰æ”¶åˆ° ACKï¼Œä¼šè§¦å‘é‡ä¼ ã€‚</li><li><code>fastack</code>:å¿«é€Ÿé‡ä¼ è®¡æ•°ï¼Œè®°å½•è¯¥æŠ¥æ–‡è¢«è·³è¿‡çš„æ¬¡æ•°ã€‚å¦‚æœä¸€ä¸ªæŠ¥æ–‡çš„ ACKè¿ç»­æ¥æ”¶åˆ°å¤šä¸ªå¯¹åŒä¸€æŠ¥æ–‡çš„ç¡®è®¤ï¼Œè€Œä¸æ˜¯æ–°çš„æŠ¥æ–‡ï¼Œä¼šå¢åŠ è¿™ä¸ªè®¡æ•°ï¼Œç”¨äºå®ç°å¿«é€Ÿé‡ä¼ æœºåˆ¶ã€‚</li><li><code>xmit</code>:è®°å½•æŠ¥æ–‡å·²ç»è¢«å‘é€çš„æ¬¡æ•°ã€‚ç”¨äºç»Ÿè®¡ä¸€ä¸ªæŠ¥æ–‡çš„é‡ä¼ æ¬¡æ•°ï¼Œå¸®åŠ©åˆ¤æ–­ä¼ è¾“çš„å¯é æ€§ã€‚å¦‚æœæ“ä½œ<code>dead_link</code> æ¬¡ï¼Œåˆ™ä¼šåˆ¤æ–­ä¸ºè¿æ¥å¤±æ•ˆï¼ŒKCP ä¼šæ–­å¼€è¿æ¥ã€‚</li><li><code>node</code>: é“¾è¡¨èŠ‚ç‚¹ï¼Œç”¨äºå°†å¤šä¸ª <code>IKCPSEG</code>ç»“æ„ä½“é“¾æ¥åœ¨ä¸€èµ·ã€‚KCP çš„é˜Ÿåˆ—å’Œç¼“å†²åŒºéƒ½æ˜¯å¾ªç¯åŒé“¾è¡¨ç»“æ„ã€‚</li></ul><p>è¿™äº›å­—æ®µå…±åŒä½œç”¨ï¼Œå¸®åŠ© KCP å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š</p><ul><li><strong>å¯é æ€§</strong>ï¼šé€šè¿‡ <code>sn</code>ã€<code>una</code> å’Œ<code>ack</code> ç¡®ä¿æ•°æ®åŒ…æŒ‰é¡ºåºæ¥æ”¶å’Œé‡ä¼ ã€‚</li><li><strong>æµé‡æ§åˆ¶</strong>ï¼šé€šè¿‡ <code>wnd</code>æ§åˆ¶æ•°æ®æµé‡ï¼Œé¿å…æ¥æ”¶æ–¹è¿‡è½½ã€‚</li><li><strong>é«˜æ•ˆä¼ è¾“</strong>ï¼šé€šè¿‡ <code>resendts</code> å’Œ<code>rto</code> è¿›è¡Œè¶…æ—¶å’Œé‡ä¼ æ§åˆ¶ï¼Œ<code>fastack</code>æä¾›å¿«é€Ÿé‡ä¼ æœºåˆ¶ã€‚</li><li><strong>çµæ´»ç®¡ç†</strong>ï¼šä½¿ç”¨é“¾è¡¨èŠ‚ç‚¹ <code>node</code>ç»„ç»‡æ•°æ®ï¼Œä¾¿äºå†…éƒ¨ç®¡ç†ã€‚</li></ul><h2 id="kcp-æ§åˆ¶å—-ikcpcb">KCP æ§åˆ¶å— ikcpcb</h2><p>ä¸Šé¢æˆ‘ä»¬æåˆ°çš„ <code>ikcp_create</code> å’Œ <code>ikcp_release</code>å°±æ˜¯å¯¹ KCP æ§åˆ¶å— <code>ikcpcb</code> çš„åˆ›å»ºå’Œé‡Šæ”¾ï¼Œæ¯ä¸ª KCPè¿æ¥éƒ½å¯¹åº”ä¸€ä¸ª KCP æ§åˆ¶å—ã€‚å®ƒå®šä¹‰åœ¨ <ahref="https://github.com/skywind3000/kcp/blob/master/ikcp.h#L343">kcp.h</a>ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">IKCPCB</span></span><br><span class="hljs-class">&#123;</span><br>IUINT32 conv, mtu, mss, state;<br>IUINT32 snd_una, snd_nxt, rcv_nxt;<br>IUINT32 ts_recent, ts_lastack, ssthresh;<br>IINT32 rx_rttval, rx_srtt, rx_rto, rx_minrto;<br>IUINT32 snd_wnd, rcv_wnd, rmt_wnd, cwnd, probe;<br>IUINT32 current, interval, ts_flush, xmit;<br>IUINT32 nrcv_buf, nsnd_buf;<br>IUINT32 nrcv_que, nsnd_que;<br>IUINT32 nodelay, updated;<br>IUINT32 ts_probe, probe_wait;<br>IUINT32 dead_link, incr;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">IQUEUEHEAD</span> <span class="hljs-title">snd_queue</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">IQUEUEHEAD</span> <span class="hljs-title">rcv_queue</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">IQUEUEHEAD</span> <span class="hljs-title">snd_buf</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">IQUEUEHEAD</span> <span class="hljs-title">rcv_buf</span>;</span><br>IUINT32 *acklist;<br>IUINT32 ackcount;<br>IUINT32 ackblock;<br><span class="hljs-type">void</span> *user;<br><span class="hljs-type">char</span> *buffer;<br><span class="hljs-type">int</span> fastresend;<br><span class="hljs-type">int</span> fastlimit;<br><span class="hljs-type">int</span> nocwnd, stream;<br><span class="hljs-type">int</span> logmask;<br><span class="hljs-type">int</span> (*output)(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">int</span> len, <span class="hljs-keyword">struct</span> IKCPCB *kcp, <span class="hljs-type">void</span> *user);<br><span class="hljs-type">void</span> (*writelog)(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-built_in">log</span>, <span class="hljs-keyword">struct</span> IKCPCB *kcp, <span class="hljs-type">void</span> *user);<br>&#125;;<br></code></pre></td></tr></table></figure><p>å­—æ®µçš„å«ä¹‰å¦‚ä¸‹ï¼Œè¯»è€…å¯åœ¨åç»­åˆ†æè¿‡ç¨‹å›è¿‡æ¥æŸ¥é˜…ï¼š</p><table><thead><tr class="header"><th>å­—æ®µå</th><th>å«ä¹‰</th></tr></thead><tbody><tr class="odd"><td><code>conv</code></td><td>è¿æ¥æ ‡è¯†ç¬¦ï¼Œç”¨äºè¯†åˆ«ä¸€ä¸ªç‰¹å®šçš„ä¼šè¯ã€‚</td></tr><tr class="even"><td><code>mtu</code></td><td>æœ€å¤§ä¼ è¾“å•å…ƒï¼ˆMaximum TransmissionUnitï¼‰ï¼Œè¡¨ç¤ºç½‘ç»œå±‚ä¼ è¾“æ•°æ®åŒ…çš„æœ€å¤§å­—èŠ‚æ•°ã€‚</td></tr><tr class="odd"><td><code>mss</code></td><td>æœ€å¤§æŠ¥æ–‡æ®µé•¿åº¦ï¼ˆMaximum SegmentSizeï¼‰ï¼Œè¡¨ç¤ºåº”ç”¨å±‚ä¼ è¾“æ•°æ®çš„æœ€å¤§å­—èŠ‚æ•°ã€‚</td></tr><tr class="even"><td><code>state</code></td><td>è¿æ¥çŠ¶æ€ï¼Œæ ‡è¯†å½“å‰çš„ä¼ è¾“çŠ¶æ€ã€‚</td></tr><tr class="odd"><td><code>snd_una</code></td><td>æœªç¡®è®¤çš„å‘é€åºå·ï¼Œè¡¨ç¤ºæœ€æ—©æœªç¡®è®¤çš„åŒ…çš„åºå·ã€‚</td></tr><tr class="even"><td><code>snd_nxt</code></td><td>ä¸‹ä¸€ä¸ªå‘é€åºå·ï¼Œè¡¨ç¤ºå³å°†å‘é€çš„åŒ…çš„åºå·ã€‚</td></tr><tr class="odd"><td><code>rcv_nxt</code></td><td>ä¸‹ä¸€ä¸ªæ¥æ”¶åºå·ï¼Œè¡¨ç¤ºæœŸæœ›æ¥æ”¶çš„ä¸‹ä¸€ä¸ªåŒ…çš„åºå·ã€‚</td></tr><tr class="even"><td><code>ts_recent</code></td><td>æœ€è¿‘çš„æ—¶é—´æˆ³ï¼Œç”¨äºå»¶è¿Ÿæµ‹é‡ã€‚</td></tr><tr class="odd"><td><code>ts_lastack</code></td><td>æœ€è¿‘çš„ç¡®è®¤æ—¶é—´æˆ³ï¼Œç”¨äº RTT è®¡ç®—ã€‚</td></tr><tr class="even"><td><code>ssthresh</code></td><td>æ‹¥å¡é¿å…çš„æ…¢å¯åŠ¨é˜ˆå€¼ã€‚</td></tr><tr class="odd"><td><code>rx_rttval</code></td><td>RTT çš„åå·®ï¼Œç”¨äºè®¡ç®— RTT çš„æ³¢åŠ¨ã€‚</td></tr><tr class="even"><td><code>rx_srtt</code></td><td>å¹³æ»‘çš„ RTT å€¼ï¼Œç”¨äºè®¡ç®—å¹³å‡ RTTã€‚</td></tr><tr class="odd"><td><code>rx_rto</code></td><td>é‡æ–°ä¼ è¾“è¶…æ—¶æ—¶é—´ï¼Œæ ¹æ® RTT åŠ¨æ€è°ƒæ•´ã€‚</td></tr><tr class="even"><td><code>rx_minrto</code></td><td>æœ€å°çš„é‡æ–°ä¼ è¾“è¶…æ—¶æ—¶é—´ã€‚</td></tr><tr class="odd"><td><code>snd_wnd</code></td><td>å‘é€çª—å£å¤§å°ï¼Œæ§åˆ¶å‘é€æµé‡çš„çª—å£ã€‚</td></tr><tr class="even"><td><code>rcv_wnd</code></td><td>æ¥æ”¶çª—å£å¤§å°ï¼Œæ§åˆ¶æ¥æ”¶æµé‡çš„çª—å£ã€‚</td></tr><tr class="odd"><td><code>rmt_wnd</code></td><td>è¿œç«¯çª—å£å¤§å°ï¼Œè¡¨ç¤ºå¯¹æ–¹æ¥æ”¶çª—å£çš„å¤§å°ã€‚</td></tr><tr class="even"><td><code>cwnd</code></td><td>æ‹¥å¡çª—å£å¤§å°ï¼Œæ§åˆ¶å‘é€æµé‡çš„çª—å£ï¼Œç”¨äºæ‹¥å¡æ§åˆ¶ã€‚</td></tr><tr class="odd"><td><code>probe</code></td><td>æ¢æµ‹æ ‡å¿—ï¼Œè¡¨ç¤ºæ˜¯å¦éœ€è¦è¿›è¡Œçª—å£æ¢æµ‹ã€‚</td></tr><tr class="even"><td><code>current</code></td><td>å½“å‰çš„æ—¶é—´æˆ³ã€‚</td></tr><tr class="odd"><td><code>interval</code></td><td>åˆ·æ–°é—´éš”æ—¶é—´ï¼Œè¡¨ç¤ºå®šæœŸåˆ·æ–° KCP çŠ¶æ€çš„é—´éš”ã€‚</td></tr><tr class="even"><td><code>ts_flush</code></td><td>ä¸‹æ¬¡åˆ·æ–°æ—¶é—´æˆ³ï¼Œç”¨äºç¡®å®šä½•æ—¶æ‰§è¡Œä¸‹ä¸€æ¬¡çŠ¶æ€åˆ·æ–°ã€‚</td></tr><tr class="odd"><td><code>xmit</code></td><td>å‘é€æ¬¡æ•°ï¼Œè¡¨ç¤ºæ•°æ®åŒ…é‡ä¼ çš„æ¬¡æ•°ã€‚</td></tr><tr class="even"><td><code>nrcv_buf</code></td><td>æ¥æ”¶ç¼“å†²åŒºçš„æ•°æ®åŒ…æ•°é‡ã€‚</td></tr><tr class="odd"><td><code>nsnd_buf</code></td><td>å‘é€ç¼“å†²åŒºçš„æ•°æ®åŒ…æ•°é‡ã€‚</td></tr><tr class="even"><td><code>nrcv_que</code></td><td>æ¥æ”¶é˜Ÿåˆ—ä¸­çš„æ•°æ®åŒ…æ•°é‡ã€‚</td></tr><tr class="odd"><td><code>nsnd_que</code></td><td>å‘é€é˜Ÿåˆ—ä¸­çš„æ•°æ®åŒ…æ•°é‡ã€‚</td></tr><tr class="even"><td><code>nodelay</code></td><td>å»¶è¿Ÿæ¨¡å¼æ ‡å¿—ï¼Œè¡¨ç¤ºæ˜¯å¦å¯ç”¨æ— å»¶è¿Ÿæ¨¡å¼ã€‚</td></tr><tr class="odd"><td><code>updated</code></td><td>æ›´æ–°æ ‡å¿—ï¼Œè¡¨ç¤ºæ˜¯å¦éœ€è¦æ›´æ–° KCP çŠ¶æ€ã€‚</td></tr><tr class="even"><td><code>ts_probe</code></td><td>ä¸‹æ¬¡æ¢æµ‹æ—¶é—´æˆ³ï¼Œç”¨äºçª—å£æ¢æµ‹ã€‚</td></tr><tr class="odd"><td><code>probe_wait</code></td><td>æ¢æµ‹ç­‰å¾…æ—¶é—´ï¼Œè¡¨ç¤ºç­‰å¾…å¤šé•¿æ—¶é—´åè¿›è¡Œä¸‹ä¸€æ¬¡çª—å£æ¢æµ‹ã€‚</td></tr><tr class="even"><td><code>dead_link</code></td><td>æ­»é“¾æ ‡å¿—ï¼Œè¡¨ç¤ºè¿æ¥æ˜¯å¦å·²ç»å¤±æ•ˆã€‚</td></tr><tr class="odd"><td><code>incr</code></td><td>å¢é‡ï¼Œç”¨äºæ§åˆ¶æµé‡çš„å¢åŠ é€Ÿç‡ã€‚</td></tr><tr class="even"><td><code>snd_queue</code></td><td>å‘é€é˜Ÿåˆ—ï¼Œç”¨äºå­˜å‚¨å¾…å‘é€çš„æ•°æ®åŒ…ã€‚</td></tr><tr class="odd"><td><code>rcv_queue</code></td><td>æ¥æ”¶é˜Ÿåˆ—ï¼Œç”¨äºå­˜å‚¨å¾…å¤„ç†çš„æ•°æ®åŒ…ã€‚</td></tr><tr class="even"><td><code>snd_buf</code></td><td>å‘é€ç¼“å†²åŒºï¼Œç”¨äºå­˜å‚¨å·²ç»å‘é€ä½†æœªç¡®è®¤çš„æ•°æ®åŒ…ã€‚</td></tr><tr class="odd"><td><code>rcv_buf</code></td><td>æ¥æ”¶ç¼“å†²åŒºï¼Œç”¨äºå­˜å‚¨å·²ç»æ¥æ”¶åˆ°ä½†æœªå¤„ç†çš„æ•°æ®åŒ…ã€‚</td></tr><tr class="even"><td><code>acklist</code></td><td>ç¡®è®¤åˆ—è¡¨ï¼Œç”¨äºå­˜å‚¨å¾…å‘é€çš„ç¡®è®¤åºå·ã€‚</td></tr><tr class="odd"><td><code>ackcount</code></td><td>ç¡®è®¤è®¡æ•°ï¼Œè¡¨ç¤ºç¡®è®¤åˆ—è¡¨ä¸­çš„æ¡ç›®æ•°é‡ã€‚</td></tr><tr class="even"><td><code>ackblock</code></td><td>ç¡®è®¤å—å¤§å°ï¼Œè¡¨ç¤ºç¡®è®¤åˆ—è¡¨çš„å†…å­˜åˆ†é…å¤§å°ã€‚</td></tr><tr class="odd"><td><code>user</code></td><td>ç”¨æˆ·æ•°æ®æŒ‡é’ˆï¼Œç”¨äºå­˜å‚¨ç”¨æˆ·è‡ªå®šä¹‰çš„æ•°æ®ã€‚</td></tr><tr class="even"><td><code>buffer</code></td><td>ç¼“å†²åŒºï¼Œç”¨äºä¸´æ—¶å­˜å‚¨å‘é€çš„æ•°æ®ã€‚</td></tr><tr class="odd"><td><code>fastresend</code></td><td>å¿«é€Ÿé‡ä¼ æ ‡å¿—ï¼Œè¡¨ç¤ºå¯ç”¨å¿«é€Ÿé‡ä¼ åŠŸèƒ½ã€‚</td></tr><tr class="even"><td><code>fastlimit</code></td><td>å¿«é€Ÿé‡ä¼ é™åˆ¶ï¼Œè¡¨ç¤ºåœ¨ä¸€ä¸ª RTT å†…å…è®¸çš„æœ€å¤§é‡ä¼ æ¬¡æ•°ã€‚</td></tr><tr class="odd"><td><code>nocwnd</code></td><td>æ— æ‹¥å¡çª—å£æ§åˆ¶æ ‡å¿—ï¼Œè¡¨ç¤ºæ˜¯å¦ç¦ç”¨æ‹¥å¡çª—å£æ§åˆ¶ã€‚</td></tr><tr class="even"><td><code>stream</code></td><td>æµæ¨¡å¼æ ‡å¿—ï¼Œè¡¨ç¤ºæ˜¯å¦å¯ç”¨æµæ¨¡å¼ã€‚</td></tr><tr class="odd"><td><code>logmask</code></td><td>æ—¥å¿—æ©ç ï¼Œç”¨äºæ§åˆ¶æ—¥å¿—è¾“å‡ºçš„çº§åˆ«ã€‚</td></tr><tr class="even"><td><code>output</code></td><td>å‘é€æ•°æ®å›è°ƒå‡½æ•°ï¼Œç”¨äºå‘é€æ•°æ®ã€‚</td></tr><tr class="odd"><td><code>writelog</code></td><td>æ—¥å¿—å›è°ƒå‡½æ•°ï¼Œç”¨äºè¾“å‡ºæ—¥å¿—ã€‚</td></tr></tbody></table><h2 id="é˜Ÿåˆ—å’Œç¼“å†²åŒº">é˜Ÿåˆ—å’Œç¼“å†²åŒº</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">IKCPCB</span></span><br><span class="hljs-class">&#123;</span><br>  ...<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">IQUEUEHEAD</span> <span class="hljs-title">snd_queue</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">IQUEUEHEAD</span> <span class="hljs-title">rcv_queue</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">IQUEUEHEAD</span> <span class="hljs-title">snd_buf</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">IQUEUEHEAD</span> <span class="hljs-title">rcv_buf</span>;</span><br>  ...<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">IQUEUEHEAD</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">IQUEUEHEAD</span> *<span class="hljs-title">next</span>, *<span class="hljs-title">prev</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>KCPä¸­é˜Ÿåˆ—å’Œç¼“å†²åŒºéƒ½æ˜¯å¾ªç¯åŒé“¾è¡¨ï¼Œé“¾è¡¨ç”±å®å®ç°ï¼Œç¬”è€…å¹¶ä¸æ“…é•¿ï¼Œæ‰€ä»¥æœ¬æ–‡å°±ä¸æ¢è®¨è¯¥é“¾è¡¨çš„å®ç°äº†ï¼Œæœ‰æ•°æ®ç»“æ„åŸºç¡€çš„ç¬”è€…åº”è¯¥å¾ˆå¥½ç†è§£è¿™ä¸€å—ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240612175626865.png"alt="é˜Ÿåˆ—å’Œç¼“å†²åŒºçš„å®ç°ï¼šå¾ªç¯åŒé“¾è¡¨" /><figcaptionaria-hidden="true">é˜Ÿåˆ—å’Œç¼“å†²åŒºçš„å®ç°ï¼šå¾ªç¯åŒé“¾è¡¨</figcaption></figure><p>é˜Ÿåˆ—å’Œç¼“å†²åŒºæ˜¯ KCPæœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œå®ƒä»¬çš„ä½œç”¨æµç¨‹å¤§æ¦‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¯»è€…å¯ä»¥è‡ªè¡Œé˜…è¯»å°è¯•ç†è§£ï¼Œåç»­æˆ‘ä»¬ä¼šè¿›è¡Œè¯¦ç»†çš„åˆ†æã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240612175950432.png"alt="KCP é˜Ÿåˆ—å’Œç¼“å†²åŒºä½œç”¨æµç¨‹" /><figcaption aria-hidden="true">KCP é˜Ÿåˆ—å’Œç¼“å†²åŒºä½œç”¨æµç¨‹</figcaption></figure><h1 id="åŸç†åˆ†æ">åŸç†åˆ†æ</h1><p>è¿™ä¸€èŠ‚æˆ‘ä»¬è¯¦ç»†è®¨è®º KCP çš„æ•´ä¸ª ARQæµç¨‹ã€‚é¦–å…ˆæˆ‘ä»¬ä¼šå¯¹æ•´ä½“æµç¨‹è¿›è¡Œç®€è¦æ¦‚è¿°ï¼Œç„¶åè¯¦ç»†è®¨è®ºæ»‘åŠ¨çª—å£ä¸­çš„å‘é€å’Œæ¥æ”¶è¿‡ç¨‹ï¼Œæ¥ç€è®¨è®ºè¶…æ—¶é‡ä¼ å’Œå¿«é€Ÿé‡ä¼ ï¼Œåœ¨è¿™ä¹‹åæˆ‘ä»¬ä¼šå°†KCP å’Œ TCP çš„é‡ä¼ ç­–ç•¥è¿›è¡Œç®€å•å¯¹æ¯”ï¼Œæœ€åä»‹ç»ä¸€ä¸‹æ‹¥å¡æ§åˆ¶ç­–ç•¥ã€‚</p><h2 id="æ•´ä½“æµç¨‹">1. æ•´ä½“æµç¨‹</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240612192523848.png"alt="KCP å…¨æµç¨‹" /><figcaption aria-hidden="true">KCP å…¨æµç¨‹</figcaption></figure><p>KCP çš„å…¨æµç¨‹å¦‚ä¸Šå›¾æ‰€ç¤ºï¼š</p><ol type="1"><li>å‘é€æ–¹è°ƒç”¨ <code>ikcp_send</code>å°†å‘é€æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™ä¼šåˆ›å»ºæŠ¥æ–‡æ®µå®ä¾‹ï¼Œå¹¶æ”¾å…¥ <code>snd_queue</code>å‘é€é˜Ÿåˆ—ä¸­ã€‚</li><li>KCP ä¼šå®šæ—¶è°ƒç”¨ <code>ikcp_update</code> åˆ¤æ–­æ˜¯å¦è¦è°ƒç”¨<code>ikcp_flush</code>ã€‚</li><li>è°ƒç”¨ <code>ikcp_flush</code> æ—¶ä¼šå°†åˆé€‚çš„æŠ¥æ–‡æ®µæ”¾å…¥<code>snd_buf</code> ç¼“å†²åŒºä¸­ï¼Œå…·ä½“åŒ…æ‹¬ï¼š<ol type="1"><li>å‘é€ ACK åˆ—è¡¨ä¸­æ‰€æœ‰ ACKï¼›</li><li>æ ¹æ®æ˜¯å¦éœ€è¦å‘é€çª—å£æ¢æµ‹å’Œé€šçŸ¥æŠ¥æ–‡ï¼Œéœ€è¦åˆ™å‘ï¼›</li><li>æ ¹æ®å‘é€çª—å£å¤§å°ï¼Œå°†é€‚é‡çš„æŠ¥æ–‡æ®µä» <code>snd_queue</code> ç§»å…¥<code>snd_buf</code> ä¸­ï¼›</li><li>å‘é€ <code>snd_buf</code>ä¸­çš„æŠ¥æ–‡ï¼ŒåŒ…æ‹¬<strong>æ–°åŠ å…¥çš„</strong>ã€<strong>RTO å†…æœªæ”¶åˆ°ACK</strong> çš„å’Œ <strong>ACK å¤±åºè‹¥å¹²æ¬¡</strong>çš„ï¼›</li><li>æ ¹æ®ä¸¢åŒ…æƒ…å†µè®¡ç®— <code>ssthresh</code> å’Œ <code>cwnd</code>ã€‚</li></ol></li><li>å‘é€çš„æ—¶å€™ä¼šè°ƒç”¨ç”± <code>ikcp_setoutput</code>è®¾ç½®çš„å›è°ƒå‡½æ•°ï¼Œå°†æ•°æ®å‘é€åˆ°å¯¹ç«¯ã€‚</li><li>æ¥æ”¶æ–¹æ”¶åˆ°æ•°æ®åï¼Œä¼šè°ƒç”¨ <code>ikcp_input</code>ï¼Œå°†æ•°æ®æ”¾å…¥<code>rcv_buf</code> ç¼“å†²åŒºï¼Œå…·ä½“åŒ…æ‹¬ï¼š<ol type="1"><li>æ ¹æ®æ‰€æœ‰æŠ¥æ–‡çš„ una å°†ç›¸åº”çš„æŠ¥æ–‡æ ‡è®°ä¸ºå·²é€è¾¾ï¼›</li><li>å¦‚æœæ˜¯ ACKï¼Œå°±å°†ç›¸åº”çš„æŠ¥æ–‡æ ‡è®°ä¸ºå·²é€è¾¾ï¼›</li><li>å¦‚æœæ˜¯æ•°æ®æŠ¥æ–‡ï¼Œå°±å°†å®ƒæ”¾å…¥ <code>rcv_buf</code>ï¼Œç„¶åå°†<code>rcv_buf</code> ä¸­é¡ºåºæ­£ç¡®çš„æŠ¥æ–‡ç§»å…¥ <code>rcv_queue</code>æ¥æ”¶é˜Ÿåˆ—ä¸­ï¼Œæ¥ç€å°†ç›¸å…³ä¿¡æ¯æ’å…¥ ACK åˆ—è¡¨ï¼Œåœ¨ç¨åçš„<code>ikcp_flush</code> ä¸­ä¼šå‘é€ç›¸åº”çš„ ACKï¼›</li><li>å¦‚æœæ˜¯çª—å£æ¢æµ‹æŠ¥æ–‡ï¼Œå°±æ ‡è®°â€œéœ€è¦å‘é€çª—å£é€šçŸ¥â€ï¼Œåœ¨ç¨åçš„<code>ikcp_flush</code> ä¸­ä¼šå‘é€çª—å£é€šçŸ¥æŠ¥æ–‡ï¼›</li><li>åŒ…æ‹¬çª—å£é€šçŸ¥æŠ¥æ–‡åœ¨å†…çš„æ‰€æœ‰æŠ¥æ–‡éƒ½æœ‰ wnd å­—æ®µï¼Œæ®æ­¤æ›´æ–° rmt_wndï¼›</li><li>æ ¹æ® ACK å¤±åºæƒ…å†µå†³å®šæ˜¯å¦è¿›è¡Œå¿«é€Ÿé‡ä¼ ï¼›</li><li>è®¡ç®— cwndã€‚</li></ol></li><li>è°ƒç”¨ <code>ikcp_recv</code> ä» <code>rcv_queue</code>ä¸­æ¥æ”¶æ•°æ®ã€‚</li></ol><h2 id="æ»‘åŠ¨çª—å£">2. æ»‘åŠ¨çª—å£</h2><p>å‘é€ç¼“å†²åŒº <code>snd_buf</code> å’Œæ¥æ”¶ç¼“å†²åŒº <code>rcv_buf</code>ä¸­æ´»åŠ¨çš„æŠ¥æ–‡éƒ½æ˜¯åœ¨æ»‘åŠ¨çª—å£ä¹‹ä¸­çš„ã€‚è¿™å¯¹äºæˆ‘ä»¬ç†è§£ KCPçš„å‘é€å’Œæ¥æ”¶æµç¨‹éå¸¸é‡è¦ï¼Œæ‰€æœ‰æˆ‘ä»¬å…ˆä»æ»‘åŠ¨çª—å£å¼€å§‹ä»‹ç»ã€‚</p><p>æ»‘åŠ¨çª—å£å®é™…æ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µ,ä¸èƒ½ç®€å•åœ°è®¤ä¸ºå®ƒæ˜¯ç¼“å†²åŒºçš„ä¸€éƒ¨åˆ†ï¼Œå‡†ç¡®çš„è¯´ï¼Œæ»‘åŠ¨çª—å£æ˜¯ç”±é˜Ÿåˆ—åŠ ç¼“å†²åŒºå…±åŒç»„æˆçš„ã€‚</p><h3 id="å‘é€">2.1 å‘é€</h3><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240612193023604.png"alt="å‘é€çª—å£" /><figcaption aria-hidden="true">å‘é€çª—å£</figcaption></figure><p><code>snd_una</code> å’Œ <code>snd_nxt</code>ä¼šåŠªåŠ›å¾€<strong>å³</strong>ç§»åŠ¨ï¼š</p><ol type="1"><li><code>ikcp_flush</code> æ—¶ï¼Œä¼šä» <code>snd_queue</code>ä¸­å–å‡ºæŠ¥æ–‡æ’å…¥åˆ° <code>snd_nxt</code> çš„ä½ç½®ä¸Šï¼›</li><li>å¦‚æœ<code>snd_nxt - snd_una &gt;= cwnd</code>ï¼Œåˆ™ä¸å…è®¸æ–°çš„æŠ¥æ–‡æ’å…¥ï¼›</li><li>å½“ <code>snd_una</code> çš„ ACK æŠ¥æ–‡åˆ°è¾¾æ—¶ï¼Œ<code>snd_una</code>å°±ä¼šå³ç§»åˆ°ç¬¬ä¸€ä¸ªæ²¡æœ‰æ”¶åˆ° ACK æŠ¥æ–‡çš„ä½ç½®ï¼›</li></ol><p>å‘é€çª—å£ä¸­æœªç¡®è®¤åˆ°è¾¾çš„æŠ¥æ–‡ä½•æ—¶é‡ä¼ ï¼Ÿ</p><ul><li>æŠ¥æ–‡åœ¨ä¸€ä¸ª RTO æ—¶é—´å†…ä»æœªç¡®è®¤åˆ°è¾¾ï¼Œå°±ä¼šé‡ä¼ ã€‚æŠ¥æ–‡ RTO åˆå§‹å€¼æ˜¯rx_rto ï¼Œä¼šæŒç»­å¢é•¿ï¼Œé€Ÿç‡æ”¯æŒé…ç½®ã€‚</li></ul><h3 id="æ¥æ”¶">2.2 æ¥æ”¶</h3><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240612193238859.png"alt="æ¥æ”¶çª—å£" /><figcaption aria-hidden="true">æ¥æ”¶çª—å£</figcaption></figure><ol type="1"><li>æ¯æ”¶åˆ°ä¸€ä¸ªæ•°æ®æŠ¥æ–‡, éƒ½ä¼šæ ¹æ®å®ƒçš„ç¼–å·å°†å®ƒæ’å…¥åˆ° <code>rcv_buf</code>å¯¹åº”çš„ä½ç½®ä¸­ï¼›</li><li>æ¥ç€æ£€æŸ¥ <code>rcv_nxt</code> èƒ½å¦å‘å³ç§»åŠ¨,åªæœ‰å½“æŠ¥æ–‡çš„é¡ºåºæ­£ç¡®ä¸”è¿ç»­æ‰èƒ½ç§»åŠ¨ï¼›</li><li>åœ¨ä¸Šå›¾çš„ä¾‹å­ä¸­ç”±äº 4 å·æŠ¥æ–‡çš„ç¼ºå¤±, <code>rcv_nxt</code> åªèƒ½å¤„äº 4å·ä½ç½®ç­‰å¾…ï¼Œ5, 6 å·æŠ¥æ–‡ä¹Ÿä¸èƒ½ç§»åŠ¨åˆ° <code>rcv_queue</code> ä¸­ï¼›</li><li>ç­‰åˆ° 4 å·æŠ¥æ–‡åˆ°è¾¾åï¼Œæ‰èƒ½å°† 4, 5, 6 å·æŠ¥æ–‡ä¸€å¹¶ç§»åŠ¨åˆ°<code>rcv_queue</code> ä¸­ï¼ŒåŒæ—¶ <code>rcv_nxt</code> ä¼šå³ç§»åˆ° 7å·ä½ç½®ã€‚</li></ol><h3 id="æ¡ˆä¾‹åˆ†æ">2.3 æ¡ˆä¾‹åˆ†æ</h3><p>æˆ‘ä»¬ä¸¾ä¸ªç®€å•çš„ä¾‹å­æ¼”ç¤ºæ•´ä¸ª ARQçš„æµç¨‹ã€‚ä¸‹å›¾ä¸­å®çº¿ç®­å¤´è¡¨ç¤ºæ•°æ®æŠ¥æ–‡ï¼Œè™šçº¿ç®­å¤´è¡¨ç¤º ACKã€‚</p><figure><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/kcp_5.svg"alt="KCP ARQ æµç¨‹" /><figcaption aria-hidden="true">KCP ARQ æµç¨‹</figcaption></figure><p>â‘  t1 æ—¶åˆ»å‘é€æ–¹å‘é€ 1 å·æŠ¥æ–‡, 1 å·æŠ¥æ–‡æ”¾å…¥å‘é€ç¼“å†²åŒºä¸­, snd_una æŒ‡å‘1, snd_nxt æŒ‡å‘ 2.</p><p>â‘¡ t2 è‡³ t3 æ—¶åˆ»å‘é€æ–¹ä¾æ¬¡å‘é€ 2 è‡³ 3 å·æŠ¥æ–‡, snd_nxt ä¾æ¬¡åç§».</p><p>â‘¢ 1 å·æŠ¥æ–‡ä¸¢åŒ….</p><p>â‘£ t4, t5 æ—¶åˆ»æ¥æ”¶æ–¹æ”¶åˆ° 3 å·å’Œ 2 å·æŠ¥æ–‡, æ”¾å…¥ rcv_buf ä¸­; éšåå›å¤ 3å·å’Œ 2 å· ACK. æ­¤æ—¶ç”±äº 1 å·æŠ¥æ–‡ç¼ºå¤±, rcv_nxt å§‹ç»ˆæŒ‡å‘ 1.</p><p>â‘¤ 3 å· ACK ä¸¢åŒ….</p><p>â‘¥ t7 æ—¶åˆ»å‘é€æ–¹æ”¶åˆ° 2 å· ACK, å°† 2 å·æŠ¥æ–‡æ ‡è®°ä¸ºå·²é€è¾¾. æ­¤æ—¶ç”±äº 3 å·ACK ä¸¢åŒ…, 3 å·æŠ¥æ–‡æœªæ ‡è®°ä¸ºå·²é€è¾¾. ç”±äº 1 å·æŠ¥æ–‡æœªç¡®è®¤é€è¾¾, snd_unaäº¦æŒ‡å‘ 1.</p><p>â‘¦ t8 æ—¶åˆ» 1 å·æŠ¥æ–‡è¶…æ—¶, é‡ä¼ .</p><p>â‘§ t9 æ—¶åˆ»æ¥æ”¶æ–¹æ”¶åˆ° 1 å·æŠ¥æ–‡, æ”¾å…¥ rcv_buf ä¸­; è¿™æ—¶ 1, 2, 3å·æŠ¥æ–‡é¡ºåºæ­£ç¡®, rcv_nxt å³ç§»åˆ° 4 å·ä½ç½®. æ¥æ”¶æ–¹å›å¤ 1 å· ACK, åŒæ—¶å¸¦ä¸Šuna = 4.</p><p>â‘¨ t10 æ—¶åˆ»å‘é€æ–¹æ”¶åˆ° 1 å· ACK, å°† 1 å·æŠ¥æ–‡æ ‡è®°ä¸ºå·²é€è¾¾. åŒæ—¶ una è¡¨æ˜1, 2, 3 å·æŠ¥æ–‡å‡å·²é€è¾¾, å› æ­¤ä¹Ÿå°† 3 å·æŠ¥æ–‡æ ‡è®°ä¸ºå·²é€è¾¾. snd_una ç§»åŠ¨åˆ°4.</p><h2 id="è¶…æ—¶é‡ä¼ ">3. è¶…æ—¶é‡ä¼ </h2><p>è¶…æ—¶é‡ä¼ æ˜¯å½“å‘é€çš„æ•°æ®åŒ…åœ¨é¢„å®šæ—¶é—´å†…æœªè¢«ç¡®è®¤æ—¶ï¼Œé‡æ–°å‘é€è¯¥æ•°æ®åŒ…çš„æœºåˆ¶ã€‚åœ¨KCP ä¸­ï¼Œè¿™ä¸ªæ—¶é—´ç”±é‡æ–°ä¼ è¾“è¶…æ—¶ï¼ˆRTOï¼‰å†³å®šã€‚KCP è®¡ç®— RTO åˆå§‹å€¼çš„æ–¹æ³•æ˜¯TCP çš„æ ‡å‡†æ–¹æ³•, è§„å®šåœ¨ <ahref="https://www.rfc-editor.org/rfc/rfc6298.html">RFC 6298</a> ä¸­ã€‚</p><p>è¿™é‡Œè¿˜æ˜¯è´´å‡ºæºç è®²æ¯”è¾ƒç›´è§‚ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">ikcp_update_ack</span><span class="hljs-params">(ikcpcb *kcp, IINT32 rtt)</span><br>&#123;<br>IINT32 rto = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">if</span> (kcp-&gt;rx_srtt == <span class="hljs-number">0</span>) &#123;<br>kcp-&gt;rx_srtt = rtt;<br>kcp-&gt;rx_rttval = rtt / <span class="hljs-number">2</span>;<br>&#125;<span class="hljs-keyword">else</span> &#123;<br><span class="hljs-type">long</span> delta = rtt - kcp-&gt;rx_srtt;<br><span class="hljs-keyword">if</span> (delta &lt; <span class="hljs-number">0</span>) delta = -delta;<br>kcp-&gt;rx_rttval = (<span class="hljs-number">3</span> * kcp-&gt;rx_rttval + delta) / <span class="hljs-number">4</span>;<br>kcp-&gt;rx_srtt = (<span class="hljs-number">7</span> * kcp-&gt;rx_srtt + rtt) / <span class="hljs-number">8</span>;<br><span class="hljs-keyword">if</span> (kcp-&gt;rx_srtt &lt; <span class="hljs-number">1</span>) kcp-&gt;rx_srtt = <span class="hljs-number">1</span>;<br>&#125;<br>rto = kcp-&gt;rx_srtt + _imax_(kcp-&gt;interval, <span class="hljs-number">4</span> * kcp-&gt;rx_rttval);<br>kcp-&gt;rx_rto = _ibound_(kcp-&gt;rx_minrto, rto, IKCP_RTO_MAX);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªè®¡ç®—è¿‡ç¨‹ç¬”è€…å°±ä¸åšè¯¦ç»†ä»‹ç»äº†ï¼Œä»£ç é‡Œé¢çš„å…¬å¼è¯»è€…å¯ä»¥å°è¯•è‡ªè¡Œç”»å›¾è¿›è¡Œç†è§£ï¼Œè¿™é‡Œå°±ä¸èŠ±å¤§ç¯‡å¹…ç”»å…¬å¼äº†ï¼Œä¸‹é¢æˆ‘å°è¯•ä»¥æ›´é€šä¿—æ˜“æ‡‚çš„è¯è¯­è§£é‡ŠRTOï¼Œåªéœ€è¦ç†è§£å®ƒåœ¨åšä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆåšï¼Œå°±å¯ä»¥äº†ï¼Œä¸ªäººè§‰å¾—å¯¹å…¬å¼çš„ç»†èŠ‚å¯ä»¥æš‚ä¸”å¿½ç•¥ã€‚</p><h3 id="rto-è®¡ç®—ç›®çš„">3.1 RTO è®¡ç®—ç›®çš„</h3><p>KCP çš„ RTOè®¡ç®—æ˜¯ä¸ºäº†ç¡®å®šåœ¨å¤šé•¿æ—¶é—´å†…æœªæ”¶åˆ°ç¡®è®¤ï¼ˆACKï¼‰æ—¶ï¼Œåº”è¯¥é‡æ–°å‘é€æ•°æ®åŒ…ã€‚è¿™æ®µæ—¶é—´è¢«ç§°ä¸ºé‡ä¼ è¶…æ—¶æ—¶é—´ï¼ˆRTOï¼‰ã€‚è®¡ç®—RTOçš„ç›®çš„æ˜¯åœ¨ç½‘ç»œæ¡ä»¶å˜åŒ–çš„æƒ…å†µä¸‹ï¼Œæ—¢èƒ½å¿«é€Ÿå“åº”æ•°æ®ä¸¢å¤±ï¼Œä¹Ÿèƒ½é¿å…ä¸å¿…è¦çš„é‡ä¼ ï¼Œä»è€Œä¿æŒé«˜æ•ˆçš„ä¼ è¾“ã€‚</p><h3 id="rto-è®¡ç®—æ¶‰åŠçš„å˜é‡è§£é‡Š">3.2 RTO è®¡ç®—æ¶‰åŠçš„å˜é‡è§£é‡Š</h3><p><strong>RTT å’Œ SRTT çš„æ¦‚å¿µ:</strong></p><ul><li>RTTï¼ˆRound-Trip Timeï¼‰:æ˜¯ä»å‘é€ä¸€ä¸ªæ•°æ®åŒ…åˆ°æ”¶åˆ°å…¶ç¡®è®¤ï¼ˆACKï¼‰æ‰€èŠ±çš„æ—¶é—´ã€‚</li><li>SRTTï¼ˆSmoothed RTTï¼‰: æ˜¯ RTT çš„åŠ æƒå¹³å‡å€¼ï¼Œå®ƒä»£è¡¨äº† RTTçš„ä¸€ä¸ªæ›´ç¨³å®šçš„ä¼°è®¡å€¼ã€‚SRTT çš„ç›®çš„æ˜¯å‡å°‘ RTT çš„çŸ­æœŸæ³¢åŠ¨å¯¹ RTOçš„å½±å“ã€‚</li></ul><p><strong>RTT å˜åŒ–å€¼ï¼ˆRTTvarianceï¼‰</strong>ï¼šç½‘ç»œä¼ è¾“æ—¶é—´å¹¶ä¸æ€»æ˜¯å›ºå®šçš„ï¼Œæœ‰æ—¶ä¼šå› ä¸ºç½‘ç»œæ‹¥å¡æˆ–å…¶ä»–åŸå› å‡ºç°æ³¢åŠ¨ã€‚æˆ‘ä»¬é€šè¿‡è®¡ç®—RTT å˜åŒ–å€¼ï¼ˆRTT varianceï¼‰æ¥ä¼°è®¡è¿™ç§æ³¢åŠ¨çš„å¤§å°ã€‚</p><p><strong>ä¸ºä»€ä¹ˆéœ€è¦ SRTT å’Œ RTT å˜åŒ–å€¼ï¼š</strong></p><ul><li>SRTT ç»™æˆ‘ä»¬ä¸€ä¸ªå¹³å‡çš„ RTT ä¼°è®¡å€¼ã€‚</li><li>RTT å˜åŒ–å€¼å‘Šè¯‰æˆ‘ä»¬ç½‘ç»œçš„æ³¢åŠ¨æ€§ã€‚å¦‚æœæ³¢åŠ¨å¾ˆå¤§ï¼Œæˆ‘ä»¬å¸Œæœ› RTOæ›´å¤§ï¼Œä»¥å…å› ä¸ºçŸ­æš‚çš„ç½‘ç»œå»¶è¿Ÿå°±è§¦å‘ä¸å¿…è¦çš„é‡ä¼ ã€‚</li></ul><h3 id="rto-è®¡ç®—æ­¥éª¤">3.3 RTO è®¡ç®—æ­¥éª¤</h3><p><strong>1. åˆå§‹åŒ–</strong>ï¼šåˆæ¬¡è®¡ç®—æ—¶ï¼Œæˆ‘ä»¬æ²¡æœ‰å†å² RTTå€¼ï¼Œæ‰€ä»¥ç›´æ¥ç”¨ç¬¬ä¸€æ¬¡æµ‹é‡çš„ RTT æ¥åˆå§‹åŒ– SRTTï¼Œå¹¶å°† RTT å˜åŒ–å€¼è®¾ä¸º RTTçš„ä¸€åŠã€‚</p><p><strong>2. æ›´æ–° SRTT å’Œ RTT å˜åŒ–å€¼</strong>:</p><ul><li>æ¯æ¬¡æˆ‘ä»¬æµ‹é‡æ–°çš„ RTTï¼Œå°±ç”¨å®ƒæ¥æ›´æ–° SRTT å’Œ RTT å˜åŒ–å€¼ã€‚</li><li>æ›´æ–° SRTTï¼šæˆ‘ä»¬ä¸ç›´æ¥æ›¿æ¢æ—§çš„SRTTï¼Œè€Œæ˜¯ç”¨ä¸€ä¸ªå¹³æ»‘çš„æ–¹å¼ï¼ˆå³åŠ æƒå¹³å‡ï¼‰ï¼Œä½¿å¾— SRTT é€æ¸é è¿‘æ–°RTTï¼Œä½†åˆä¸ä¼šå‰§çƒˆå˜åŒ–ã€‚</li><li>æ›´æ–° RTT å˜åŒ–å€¼ï¼šè®¡ç®—æ–°çš„ RTT ä¸ SRTT çš„å·®å€¼ï¼Œç”¨è¿™ä¸ªå·®å€¼æ¥æ›´æ–° RTTå˜åŒ–å€¼ï¼Œä½¿å…¶åæ˜ å½“å‰ç½‘ç»œæ³¢åŠ¨çš„å¤§å°ã€‚</li></ul><p><strong>3. è®¡ç®— RTO</strong>:</p><ul><li>ç”¨ SRTT åŠ ä¸Šå››å€çš„ RTT å˜åŒ–å€¼æ¥è®¡ç®— RTOï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿ RTOè¶³å¤Ÿé•¿ï¼Œèƒ½æ¶µç›–å¤§éƒ¨åˆ†çš„ç½‘ç»œæ³¢åŠ¨ã€‚</li><li>æˆ‘ä»¬è¿˜è¦ç¡®ä¿ RTO ä¸å°äºä¸€ä¸ªæœ€å°å€¼ï¼ˆ<code>rx_minrto</code>ï¼‰ï¼Œä»¥é˜²æ­¢RTOè¿‡å°å¯¼è‡´é¢‘ç¹é‡ä¼ ï¼›ä¹Ÿä¸èƒ½å¤§äºä¸€ä¸ªæœ€å¤§å€¼ï¼ˆ<code>IKCP_RTO_MAX</code>ï¼‰ï¼Œä»¥é˜²æ­¢RTO è¿‡å¤§å½±å“å“åº”é€Ÿåº¦ã€‚</li></ul><h3 id="rto-è®¡ç®—æ•ˆæœ">4. RTO è®¡ç®—æ•ˆæœ</h3><ul><li><strong>ç¨³å®šçš„ä¼ è¾“</strong>: SRTT æä¾›äº†ä¸€ä¸ªç¨³å®šçš„å¹³å‡ RTTä¼°è®¡ï¼Œä½¿å¾— RTO èƒ½é€‚åº”ç½‘ç»œçš„é•¿æœŸå˜åŒ–ã€‚</li><li><strong>é€‚åº”ç½‘ç»œæ³¢åŠ¨</strong>: RTT å˜åŒ–å€¼ä½¿å¾— RTOèƒ½å¤Ÿåº”å¯¹ç½‘ç»œçš„çŸ­æœŸæ³¢åŠ¨ï¼Œå‡å°‘å› çŸ­æš‚å»¶è¿Ÿè€Œå¯¼è‡´çš„é‡ä¼ ã€‚</li><li><strong>å¿«é€Ÿå“åº”</strong>: RTOè®¾ç½®åˆç†åï¼Œèƒ½å¤Ÿåœ¨æ•°æ®ä¸¢å¤±æ—¶å¿«é€Ÿé‡ä¼ ï¼Œä¿æŒä¼ è¾“çš„é«˜æ•ˆå’ŒåŠæ—¶æ€§ã€‚</li></ul><p>é€šè¿‡è¿™æ ·çš„è®¡ç®—æ–¹å¼ï¼ŒKCPèƒ½å¤Ÿåœ¨ä¸åŒçš„ç½‘ç»œæ¡ä»¶ä¸‹ï¼Œè‡ªåŠ¨è°ƒæ•´é‡ä¼ ç­–ç•¥ï¼Œä»è€Œåœ¨ä¿è¯æ•°æ®å¯é æ€§çš„åŒæ—¶ï¼Œä¿æŒè¾ƒé«˜çš„ä¼ è¾“æ•ˆç‡ã€‚</p><h2 id="å¿«é€Ÿé‡ä¼ ">4. å¿«é€Ÿé‡ä¼ </h2><p>åœ¨ç½‘ç»œä¼ è¾“ä¸­ï¼Œæ•°æ®åŒ…å¯èƒ½ä¼šç”±äºç½‘ç»œæ‹¥å¡ã€ä¸¢åŒ…ç­‰åŸå› è€Œä¸¢å¤±ã€‚è¶…æ—¶é‡ä¼ ä¾èµ–äºé‡ä¼ è¶…æ—¶æ—¶é—´ï¼ˆRTOï¼‰æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦é‡ä¼ ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´å“åº”å»¶è¿Ÿã€‚è€Œå¿«é€Ÿé‡ä¼ é€šè¿‡æ£€æµ‹é‡å¤çš„ç¡®è®¤åŒ…ï¼ˆACKï¼‰æ¥å¿«é€Ÿåˆ¤æ–­æ•°æ®åŒ…çš„ä¸¢å¤±ï¼Œå¹¶ç«‹å³è§¦å‘é‡ä¼ ï¼Œæ˜¾è‘—ç¼©çŸ­äº†æ•°æ®ä¸¢å¤±çš„æ¢å¤æ—¶é—´ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240612200038895.png"alt="KCP å¿«é€Ÿé‡ä¼ " /><figcaption aria-hidden="true">KCP å¿«é€Ÿé‡ä¼ </figcaption></figure><h3 id="ä½•æ—¶å¿«é€Ÿé‡ä¼ ">4.1 ä½•æ—¶å¿«é€Ÿé‡ä¼ ï¼Ÿ</h3><ul><li>æ¯ä¸ªæŠ¥æ–‡çš„ <code>fastack</code> è®°å½•äº†å®ƒæ£€æµ‹åˆ° ACK å¤±åºçš„æ¬¡æ•°ï¼Œæ¯å½“KCP æ”¶åˆ°ä¸€ä¸ªç¼–å·ä¸º sn çš„ ACK æ—¶ï¼Œå°±ä¼šæ£€æŸ¥ snd_buf ä¸­ç¼–å·å°äº snä¸”æœªç¡®è®¤é€è¾¾çš„æŠ¥æ–‡ï¼Œå¹¶å°†å…¶ <code>fastack</code> åŠ  1ã€‚</li><li>å¯ä»¥é€šè¿‡é…ç½® <code>fastresend</code>æŒ‡å®šå¤±åºå¤šå°‘æ¬¡å°±æ‰§è¡Œå¿«é€Ÿé‡ä¼ ã€‚</li><li>æ¯æ¬¡è°ƒç”¨ ikcp_flush éƒ½ä¼šé‡ä¼  snd_buf ä¸­<code>fastask &gt;= fastresend</code> çš„æŠ¥æ–‡ã€‚</li></ul><h3 id="æ— é™å¿«é€Ÿé‡ä¼ å—">4.2 æ— é™å¿«é€Ÿé‡ä¼ å—ï¼Ÿ</h3><ul><li>æ¯ä¸ªæŠ¥æ–‡çš„ <code>xmit</code> è®°å½•å®ƒè¢«ä¼ è¾“çš„æ¬¡æ•°ï¼Œå¯ä»¥é…ç½®<code>fastlimit</code> è§„å®šä¼ è¾“æ¬¡æ•°å°äº <code>fastlimit</code>çš„æŠ¥æ–‡æ‰èƒ½æ‰§è¡Œå¿«é€Ÿé‡ä¼ ã€‚</li></ul><h2 id="æ¯”è¾ƒ-tcp-çš„è¶…æ—¶é‡ä¼ å’Œå¿«é€Ÿé‡ä¼ ">5. æ¯”è¾ƒ TCPçš„è¶…æ—¶é‡ä¼ å’Œå¿«é€Ÿé‡ä¼ </h2><p>TCP ä¹Ÿå®ç°äº†ç±»ä¼¼çš„æœºåˆ¶ï¼Œä½†åœ¨å¤æ‚æ€§å’Œåº”ç”¨åœºæ™¯ä¸Šæœ‰æ‰€ä¸åŒã€‚</p><h3 id="tcp-çš„è¶…æ—¶é‡ä¼ ">5.1 TCP çš„è¶…æ—¶é‡ä¼ </h3><p><strong>1. RTT ä¼°ç®—</strong>:</p><ul><li><p>TCP é€šè¿‡æ¥æ”¶ç¡®è®¤åŒ…æ¥ä¼°ç®— RTTï¼Œå¹¶ä½¿ç”¨ RTT çš„å˜åŒ–èŒƒå›´æ¥è®¡ç®—RTOã€‚</p></li><li><p>TCP ä½¿ç”¨ Jacobson/Karels ç®—æ³•è¿›è¡Œ RTT ä¼°ç®—å’Œ RTO è®¡ç®—ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// SRTT and RTTVAR calculation</span><br>RTTVAR = (<span class="hljs-number">1</span> - Î²) * RTTVAR + Î² * |RTTsample - SRTT|<br>SRTT = (<span class="hljs-number">1</span> - Î±) * SRTT + Î± * RTTsample<br>RTO = SRTT + <span class="hljs-number">4</span> * RTTVAR<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ï¼ŒSRTT æ˜¯å¹³æ»‘çš„ RTTï¼ŒRTTVAR æ˜¯ RTT çš„å˜åŒ–èŒƒå›´ï¼ŒÎ± å’Œ Î²æ˜¯æƒé‡å› å­ã€‚</p></li></ul><p><strong>2. é‡ä¼ ç­–ç•¥</strong>:</p><ul><li>å¦‚æœåœ¨ RTO æ—¶é—´å†…æœªæ”¶åˆ° ACKï¼ŒTCP ä¼šé‡ä¼ æœªç¡®è®¤çš„æ•°æ®åŒ…ã€‚</li><li>æ¯æ¬¡é‡ä¼ ï¼ŒRTO å€¼ä¼šæŒ‰ç…§æŒ‡æ•°å¢é•¿ï¼ˆæŒ‡æ•°é€€é¿ç®—æ³•ï¼‰ã€‚</li></ul><p><strong>3. æ‹¥å¡æ§åˆ¶</strong>:</p><ul><li>TCPä½¿ç”¨å¤æ‚çš„æ‹¥å¡æ§åˆ¶æœºåˆ¶ï¼Œå¦‚æ…¢å¯åŠ¨ã€æ‹¥å¡é¿å…ç­‰ï¼Œæ¥è°ƒæ•´å‘é€çª—å£å’Œä¼ è¾“é€Ÿç‡ã€‚</li></ul><h3 id="tcp-çš„å¿«é€Ÿé‡ä¼ ">5.2 TCP çš„å¿«é€Ÿé‡ä¼ </h3><ul><li>å½“æ¥æ”¶åˆ°ä¸‰ä¸ªé‡å¤çš„ ACK æ—¶ï¼ŒTCP ä¼šç«‹å³é‡ä¼ ä¸¢å¤±çš„æ•°æ®åŒ…ï¼Œè€Œä¸ç­‰å¾… RTOè¶…æ—¶ã€‚</li><li>å¿«é€Ÿé‡ä¼ åï¼ŒTCPè¿›å…¥å¿«é€Ÿæ¢å¤çŠ¶æ€ï¼Œè°ƒæ•´æ‹¥å¡çª—å£ï¼Œé¿å…æ‹¥å¡çª—å£è¿‡åº¦æ”¶ç¼©ã€‚</li></ul><h3 id="æ¯”è¾ƒåˆ†æ">5.3 æ¯”è¾ƒåˆ†æ</h3><table><thead><tr class="header"><th>ç‰¹æ€§</th><th>KCP</th><th>TCP</th></tr></thead><tbody><tr class="odd"><td><strong>RTT ä¼°ç®—</strong></td><td>åŸºäºåŠ æƒç§»åŠ¨å¹³å‡ï¼Œè¾ƒä¸ºç®€å•</td><td>ä½¿ç”¨ Jacobson/Karels ç®—æ³•ï¼Œå¤æ‚ä½†ç²¾ç¡®</td></tr><tr class="even"><td><strong>RTO è®¡ç®—</strong></td><td>ç®€åŒ–çš„è®¡ç®—å…¬å¼</td><td>åŸºäº RTT çš„å¤æ‚è®¡ç®—</td></tr><tr class="odd"><td><strong>é‡ä¼ æœºåˆ¶</strong></td><td>è¶…æ—¶é‡ä¼ å’Œå¿«é€Ÿé‡ä¼ </td><td>è¶…æ—¶é‡ä¼ å’Œå¿«é€Ÿé‡ä¼ </td></tr><tr class="even"><td><strong>æ‹¥å¡æ§åˆ¶</strong></td><td>ç®€å•çš„æ‹¥å¡æ§åˆ¶ï¼Œé€‚åˆä½å»¶è¿Ÿåº”ç”¨</td><td>å¤æ‚çš„æ‹¥å¡æ§åˆ¶ï¼Œé€‚åˆå¹¿æ³›çš„ä¼ è¾“åœºæ™¯</td></tr><tr class="odd"><td><strong>é€‚ç”¨åœºæ™¯</strong></td><td>å®æ—¶åº”ç”¨ï¼Œå¦‚æ¸¸æˆã€è§†é¢‘ä¼šè®®</td><td>é€šç”¨åº”ç”¨ï¼Œå¦‚æ–‡ä»¶ä¼ è¾“ã€HTTP</td></tr><tr class="even"><td><strong>å®ç°å¤æ‚åº¦</strong></td><td>è¾ƒä¸ºç®€å•ï¼Œæ˜“äºç†è§£å’Œå®ç°</td><td>å¤æ‚ï¼Œéœ€å¤„ç†æ›´å¤šçš„ç½‘ç»œçŠ¶æ€å’Œæ§åˆ¶</td></tr><tr class="odd"><td><strong>å¯é æ€§</strong></td><td>ä¾èµ–äºç”¨æˆ·è‡ªå®šä¹‰çš„é‡ä¼ å’Œæ§åˆ¶ç­–ç•¥</td><td>å†…ç½®å¯é æ€§å’Œæµæ§åˆ¶æœºåˆ¶</td></tr><tr class="even"><td><strong>å“åº”é€Ÿåº¦</strong></td><td>é«˜æ•ˆå¿«é€Ÿï¼Œé€‚ç”¨äºä½å»¶è¿Ÿå’Œé«˜ååé‡åœºæ™¯</td><td>å¯é ä½†å“åº”é€Ÿåº¦è¾ƒæ…¢ï¼Œé€‚åˆç¨³å®šä¼ è¾“åœºæ™¯</td></tr></tbody></table><p>KCP å’Œ TCP éƒ½æä¾›äº†å¯é çš„ä¼ è¾“æœºåˆ¶ï¼Œä½†å®ƒä»¬é€‚ç”¨äºä¸åŒçš„åº”ç”¨åœºæ™¯ã€‚KCPè®¾è®¡ç®€å•ï¼Œé€‚åˆå¯¹å»¶è¿Ÿæ•æ„Ÿçš„å®æ—¶åº”ç”¨ï¼Œè€Œ TCPæ‹¥æœ‰å®Œå–„çš„æ‹¥å¡æ§åˆ¶å’Œå¯é æ€§æœºåˆ¶ï¼Œé€‚åˆå¹¿æ³›çš„ç½‘ç»œåº”ç”¨ã€‚</p><h2 id="æ‹¥å¡æ§åˆ¶">6. æ‹¥å¡æ§åˆ¶</h2><p>æ‹¥å¡æ§åˆ¶æ˜¯ç½‘ç»œä¼ è¾“åè®®ä¸­çš„ä¸€ä¸ªé‡è¦æœºåˆ¶ï¼Œç”¨äºé˜²æ­¢å‘é€è¿‡å¤šçš„æ•°æ®åŒ…å¯¼è‡´ç½‘ç»œæ‹¥å¡ã€‚åœ¨KCPä¸­ï¼Œæ‹¥å¡æ§åˆ¶ç›¸å¯¹ç®€å•ï¼Œä¸»è¦é€šè¿‡å‘é€çª—å£ï¼ˆ<code>snd_wnd</code>ï¼‰å’Œæ‹¥å¡çª—å£ï¼ˆ<code>cwnd</code>ï¼‰æ¥ç®¡ç†æ•°æ®å‘é€é€Ÿç‡ã€‚</p><h3 id="ä¸‰ç§ç­–ç•¥">6.1 ä¸‰ç§ç­–ç•¥</h3><p>KCP æœ‰ 3 ç§æ‹¥å¡æ§åˆ¶çš„ç­–ç•¥ï¼š</p><ul><li>æ…¢å¯åŠ¨ï¼ˆslow startï¼‰</li><li>æ‹¥å¡é¿å…ï¼ˆcongestion avoidanceï¼‰</li><li>å¿«é€Ÿæ¢å¤ï¼ˆfast recoveryï¼‰</li></ul><p><strong>æ…¢å¯åŠ¨</strong>ï¼šå…ˆå°† cwnd è®¾ç½®ä¸º 1ï¼Œéšåå¹³å‡æ¯ç»è¿‡ä¸€ä¸ª RTTæ—¶é—´ï¼Œ<code>cwnd = cwnd * 2</code>ï¼Œç›´åˆ°é˜ˆå€¼ <code>ssthresh</code>ã€‚</p><p><strong>æ‹¥å¡é¿å…</strong>ï¼šcwnd åˆ° <code>ssthresh</code> åï¼Œcwndå‘ˆ<strong>çº¿æ€§</strong>å¢é•¿ã€‚</p><p>å½“æ…¢å¯åŠ¨æˆ–è€…æ‹¥å¡é¿å…é€ æˆ <strong>ä¸¢åŒ…</strong>åï¼Œå°±é‡‡å–ç›¸åº”çš„é€€è®©ç­–ç•¥ï¼š</p><ol type="1"><li><code>fastack &gt;= fastresend</code> -&gt; å‘ç”Ÿå¿«é€Ÿé‡ä¼ ï¼šå°†<code>ssthresh = cwnd / 2</code>ï¼Œ<code>cwnd = ssthresh + fastresend</code>è¿›å…¥<strong>å¿«æ¢å¤</strong>ã€‚</li><li><code>current &gt;= resentts</code> -&gt;è¶…æ—¶é‡ä¼ ï¼š<code>ssthresh = ssthresh / 2</code>ï¼Œ<code>cwnd = 1</code>ï¼Œè¿›å…¥<strong>æ…¢å¯åŠ¨</strong>ã€‚</li></ol><figure><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/kcp_7.svg"alt="æ‹¥å¡æ§åˆ¶ä¸­ cwnd å’Œ ssthresh çš„å˜åŒ–æƒ…å†µ" /><figcaption aria-hidden="true">æ‹¥å¡æ§åˆ¶ä¸­ cwnd å’Œ ssthreshçš„å˜åŒ–æƒ…å†µ</figcaption></figure><h3 id="æ ¸å¿ƒæ¦‚å¿µ">6.2 æ ¸å¿ƒæ¦‚å¿µ</h3><p>KCP çš„æ‹¥å¡æ§åˆ¶åŸºäºä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š</p><ul><li><strong>å‘é€çª—å£(<code>snd_wnd</code>)</strong>ï¼šè¡¨ç¤ºå‘é€ç«¯åœ¨æœªæ”¶åˆ°æ¥æ”¶ç«¯ç¡®è®¤ä¹‹å‰ï¼Œå…è®¸å‘é€çš„æ•°æ®åŒ…çš„æ•°é‡ã€‚å®ƒç±»ä¼¼äºTCP ä¸­çš„å‘é€çª—å£ï¼Œæ§åˆ¶äº†æ•°æ®æµçš„é€Ÿç‡ã€‚</li><li><strong>æ¥æ”¶çª—å£(<code>rcv_wnd</code>)</strong>ï¼šè¡¨ç¤ºæ¥æ”¶ç«¯èƒ½å¤Ÿå¤„ç†çš„æœ€å¤§æ•°æ®åŒ…æ•°é‡ã€‚å‘é€ç«¯é€šè¿‡æ¥æ”¶ç«¯çš„çª—å£å¤§å°æ¥è°ƒæ•´è‡ªå·±çš„å‘é€é€Ÿç‡ã€‚</li><li><strong>è¿œç«¯çª—å£(<code>rmt_wnd</code>)</strong>ï¼šè¡¨ç¤ºæ¥æ”¶ç«¯çš„çª—å£å¤§å°ï¼Œå‘é€ç«¯ä¼šæ ¹æ®è¿™ä¸ªå€¼è°ƒæ•´è‡ªå·±çš„å‘é€çª—å£ï¼Œä»¥é¿å…å‘é€çš„æ•°æ®è¶…å‡ºæ¥æ”¶ç«¯çš„å¤„ç†èƒ½åŠ›ã€‚</li><li><strong>æ‹¥å¡çª—å£(<code>cwnd</code>)</strong>ï¼šç”¨äºæ§åˆ¶ä¼ è¾“ä¸­çš„æ•°æ®åŒ…æ•°é‡ã€‚å®ƒåŸºäºç½‘ç»œçš„æ‹¥å¡æƒ…å†µåŠ¨æ€è°ƒæ•´ï¼Œä»¥é¿å…ç½‘ç»œæ‹¥å¡ã€‚</li><li><strong>æ…¢å¯åŠ¨é˜ˆå€¼(<code>ssthresh</code>)</strong>ï¼šç”¨äºç¡®å®šæ‹¥å¡æ§åˆ¶çš„æ¨¡å¼ã€‚å½“<code>cwnd</code> å°äº <code>ssthresh</code> æ—¶ï¼ŒKCPå¤„äºæ…¢å¯åŠ¨æ¨¡å¼ï¼Œå¦åˆ™è¿›å…¥æ‹¥å¡é¿å…æ¨¡å¼ã€‚</li></ul><h3 id="çª—å£æ¢æµ‹window-probing">6.3 çª—å£æ¢æµ‹ï¼ˆWindow Probingï¼‰</h3><p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ¥æ”¶ç«¯çš„çª—å£å¯èƒ½ä¼šè¢«å…³é—­ï¼ˆå³ <code>rmt_wnd</code> ä¸º0ï¼‰ï¼Œè¿™æ„å‘³ç€æ¥æ”¶ç«¯æ— æ³•æ¥æ”¶ä»»ä½•æ–°çš„æ•°æ®ã€‚ä¸ºäº†åº”å¯¹è¿™ç§æƒ…å†µï¼ŒKCPå®ç°äº†çª—å£æ¢æµ‹æœºåˆ¶ï¼š</p><ul><li>å½“ <code>rmt_wnd</code> ä¸º 0 æ—¶ï¼ŒKCPä¸ä¼šç«‹å³åœæ­¢å‘é€æ•°æ®ï¼Œè€Œæ˜¯ä¼šå®šæœŸå‘é€ä¸€ä¸ªæ¢æµ‹åŒ…ï¼Œä»¥æ£€æµ‹æ¥æ”¶ç«¯çª—å£æ˜¯å¦å·²ç»æ‰“å¼€ã€‚</li><li>è¿™ä¸ªæ¢æµ‹åŒ…ä¼šè§¦å‘æ¥æ”¶ç«¯è¿”å›ä¸€ä¸ªACKï¼Œå…¶ä¸­åŒ…å«æœ€æ–°çš„æ¥æ”¶çª—å£å¤§å°ä¿¡æ¯ã€‚</li></ul><h3 id="è°ƒèŠ‚å’Œé…ç½®">6.4 è°ƒèŠ‚å’Œé…ç½®</h3><p>KCPçš„æ‹¥å¡æ§åˆ¶æœºåˆ¶æä¾›äº†ä¸€äº›é…ç½®å‚æ•°ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡è°ƒæ•´è¿™äº›å‚æ•°æ¥ä¼˜åŒ–ä¼ è¾“æ€§èƒ½ï¼š</p><ul><li><strong><code>snd_wnd</code></strong>:å‘é€çª—å£å¤§å°ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®åº”ç”¨çš„éœ€æ±‚è°ƒæ•´è¯¥å€¼ï¼Œä»¥æ§åˆ¶æ•°æ®å‘é€çš„æœ€å¤§é‡ã€‚</li><li><strong><code>rcv_wnd</code></strong>:æ¥æ”¶çª—å£å¤§å°ï¼Œè¡¨ç¤ºæ¥æ”¶ç«¯èƒ½å¤Ÿå¤„ç†çš„æœ€å¤§æ•°æ®åŒ…æ•°é‡ã€‚</li><li><strong><code>ssthresh</code></strong>:æ…¢å¯åŠ¨é˜ˆå€¼ï¼Œåˆå§‹å€¼é€šå¸¸è®¾ç½®ä¸ºè¾ƒå¤§çš„ä¸€ä¸ªå¸¸é‡ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®ç½‘ç»œæƒ…å†µè°ƒæ•´ã€‚</li><li><strong><code>cwnd</code></strong>: æ‹¥å¡çª—å£å¤§å°ï¼Œåˆå§‹å€¼é€šå¸¸è®¾ç½®ä¸º1ï¼Œéšä¼ è¾“æƒ…å†µåŠ¨æ€è°ƒæ•´ã€‚</li></ul><h2 id="æ¯”è¾ƒ-tcp-çš„æ‹¥å¡æ§åˆ¶">7. æ¯”è¾ƒ TCP çš„æ‹¥å¡æ§åˆ¶</h2><h3 id="å››ä¸ªé˜¶æ®µ">7.1 å››ä¸ªé˜¶æ®µ</h3><p>TCP æ‹¥å¡æ§åˆ¶æœ‰å››ä¸ªå…³é”®é˜¶æ®µ</p><p><strong>æ…¢å¯åŠ¨ï¼ˆSlow Startï¼‰</strong>ï¼š</p><ul><li><strong>ç›®çš„</strong>ï¼šå¿«é€Ÿæ¢æµ‹ç½‘ç»œçš„å¯ç”¨å¸¦å®½ã€‚</li><li><strong>æœºåˆ¶</strong>ï¼šå½“ä¸€ä¸ªè¿æ¥åˆšå»ºç«‹æˆ–è€…ä»ä¸¢åŒ…æ¢å¤æ—¶ï¼Œ<code>cwnd</code>ï¼ˆæ‹¥å¡çª—å£ï¼‰ä»ä¸€ä¸ªè¾ƒå°çš„å€¼ï¼ˆé€šå¸¸æ˜¯1 ä¸ª MSSï¼Œå³æœ€å¤§æŠ¥æ–‡æ®µå¤§å°ï¼‰å¼€å§‹ï¼Œå¹¶ä»¥æŒ‡æ•°å¢é•¿çš„æ–¹å¼å¢åŠ ã€‚</li><li><strong>è¿‡ç¨‹</strong>ï¼šæ¯æ¬¡æ”¶åˆ°ä¸€ä¸ª ACKï¼Œ<code>cwnd</code> å¢åŠ ä¸€ä¸ªMSSï¼Œä½¿å¾— <code>cwnd</code> æ¯ RTT å¢åŠ ä¸€å€ï¼Œç›´åˆ° <code>cwnd</code>è¾¾åˆ°æ…¢å¯åŠ¨é˜ˆå€¼ï¼ˆ<code>ssthresh</code>ï¼‰ã€‚</li></ul><p><strong>æ‹¥å¡é¿å…ï¼ˆCongestion Avoidanceï¼‰</strong>:</p><ul><li><strong>ç›®çš„</strong>ï¼šé€æ­¥æ¢æµ‹ç½‘ç»œçš„æœ€å¤§å®¹é‡ï¼Œå¹¶é¿å…æ‹¥å¡ã€‚</li><li><strong>æœºåˆ¶</strong>ï¼šå½“ <code>cwnd</code> è¾¾åˆ°æˆ–è¶…è¿‡<code>ssthresh</code> æ—¶ï¼ŒTCP è¿›å…¥æ‹¥å¡é¿å…é˜¶æ®µï¼Œæ­¤æ—¶ <code>cwnd</code>ä»¥çº¿æ€§å¢é•¿çš„æ–¹å¼å¢åŠ ã€‚</li><li><strong>è¿‡ç¨‹</strong>ï¼šæ¯ä¸ª RTTï¼Œ<code>cwnd</code> å¢åŠ <code>1/cwnd</code> ä¸ªMSSï¼Œè¿™ç§å¢é•¿æ–¹å¼è¾ƒä¸ºä¿å®ˆï¼Œæ—¨åœ¨é˜²æ­¢è¿‡åº¦å‘é€å¯¼è‡´çš„æ‹¥å¡ã€‚</li></ul><p><strong>å¿«é€Ÿé‡ä¼ ï¼ˆFast Retransmitï¼‰</strong>:</p><ul><li><strong>ç›®çš„</strong>ï¼šå¿«é€Ÿå“åº”ä¸¢åŒ…ï¼Œæé«˜ä¼ è¾“æ•ˆç‡ã€‚</li><li><strong>æœºåˆ¶</strong>ï¼šå½“å‘é€ç«¯æ”¶åˆ°ä¸‰ä¸ªé‡å¤çš„ ACKæ—¶ï¼Œç«‹å³é‡ä¼ è¢«ç¡®è®¤ä¸¢å¤±çš„æ•°æ®åŒ…ï¼Œè€Œä¸ç­‰å¾… RTO è¶…æ—¶ã€‚</li><li><strong>è¿‡ç¨‹</strong>ï¼šå¿«é€Ÿé‡ä¼ çš„ç›®çš„æ˜¯è¿…é€Ÿæ¢å¤ä¸¢å¤±çš„æ•°æ®åŒ…ï¼Œä»è€Œå‡å°‘å› ä¸¢åŒ…å¯¼è‡´çš„ç­‰å¾…æ—¶é—´ã€‚</li></ul><p><strong>å¿«é€Ÿæ¢å¤ï¼ˆFast Recoveryï¼‰</strong>:</p><ul><li><strong>ç›®çš„</strong>ï¼šåœ¨æ‹¥å¡åå¿«é€Ÿæ¢å¤åˆ°é€‚å½“çš„ä¼ è¾“é€Ÿç‡ã€‚</li><li><strong>æœºåˆ¶</strong>ï¼šåœ¨å¿«é€Ÿé‡ä¼ åï¼ŒTCPä¸ä¼šç›´æ¥è¿›å…¥æ…¢å¯åŠ¨ï¼Œè€Œæ˜¯ä¿æŒ <code>cwnd</code>çš„ä¸€éƒ¨åˆ†ï¼Œä»¥è¾ƒå¿«çš„é€Ÿåº¦æ¢å¤åˆ°æ‹¥å¡é¿å…çŠ¶æ€ã€‚</li><li><strong>è¿‡ç¨‹</strong>ï¼šå°† <code>ssthresh</code> è®¾ç½®ä¸ºå½“å‰<code>cwnd</code> çš„ä¸€åŠï¼Œ<code>cwnd</code> è¢«ä¸´æ—¶å‡å°ï¼Œç„¶ååœ¨æ¥æ”¶æ–° ACKæ—¶å¿«é€Ÿå¢åŠ  <code>cwnd</code>ï¼Œç›´åˆ°æ¢å¤åˆ° <code>ssthresh</code>ä¸ºæ­¢ã€‚</li></ul><h3 id="æ¯”è¾ƒåˆ†æ-1">7.2 æ¯”è¾ƒåˆ†æ</h3><table><thead><tr class="header"><th>ç‰¹æ€§</th><th>TCP</th><th>KCP</th></tr></thead><tbody><tr class="odd"><td><strong>å®ç°å¤æ‚åº¦</strong></td><td>å¤æ‚ï¼ŒåŒ…å«å¤šä¸ªé˜¶æ®µå’Œç®—æ³•</td><td>ç®€å•ï¼Œä¸»è¦é€šè¿‡çª—å£å¤§å°æ§åˆ¶</td></tr><tr class="even"><td><strong>æ‹¥å¡æ£€æµ‹</strong></td><td>é€šè¿‡ RTT ä¼°ç®—å’Œ ACK æ£€æµ‹ä¸¢åŒ…</td><td>ä¸»è¦é€šè¿‡ ACK å’Œçª—å£å¤§å°æ£€æµ‹ä¸¢åŒ…</td></tr><tr class="odd"><td><strong>å“åº”é€Ÿåº¦</strong></td><td>å“åº”ç›¸å¯¹è¾ƒæ…¢ï¼Œé€‚åˆç¨³å®šä¼ è¾“</td><td>å“åº”è¾ƒå¿«ï¼Œé€‚åˆå®æ—¶æ€§é«˜çš„ä¼ è¾“</td></tr><tr class="even"><td><strong>é€‚åº”æ€§</strong></td><td>èƒ½é€‚åº”å¹¿æ³›çš„ç½‘ç»œæ¡ä»¶</td><td>é€‚åº”æ€§è¾ƒå¥½ï¼Œä½†æ›´é€‚åˆä½å»¶è¿Ÿç½‘ç»œ</td></tr><tr class="odd"><td><strong>é…ç½®çµæ´»æ€§</strong></td><td>è¾ƒä¸ºå›ºå®šï¼Œä¾èµ–äºç³»ç»Ÿé…ç½®å’Œä¼˜åŒ–</td><td>æä¾›æ›´å¤šçš„é…ç½®é€‰é¡¹ï¼Œç”¨æˆ·å¯æ ¹æ®éœ€æ±‚è°ƒæ•´</td></tr><tr class="even"><td><strong>åº”ç”¨åœºæ™¯</strong></td><td>é€‚ç”¨äºå„ç§éœ€è¦å¯é ä¼ è¾“çš„åº”ç”¨</td><td>é€‚ç”¨äºå®æ—¶æ€§è¦æ±‚é«˜çš„åº”ç”¨ï¼Œå¦‚æ¸¸æˆå’Œè§†é¢‘ä¼šè®®</td></tr><tr class="odd"><td><strong>çª—å£è°ƒæ•´</strong></td><td>æ…¢å¯åŠ¨ã€æ‹¥å¡é¿å…ã€å¿«é€Ÿé‡ä¼ ã€å¿«é€Ÿæ¢å¤ç­‰æœºåˆ¶</td><td>ä¸»è¦é€šè¿‡å‘é€çª—å£å’Œæ‹¥å¡çª—å£è°ƒæ•´</td></tr><tr class="even"><td><strong>ä¸¢åŒ…å“åº”</strong></td><td>ä¸¢åŒ…æ—¶é€šè¿‡å‡å° <code>cwnd</code> å’Œ <code>ssthresh</code>æ¥è°ƒæ•´</td><td>ä¸¢åŒ…æ—¶è¿…é€Ÿè°ƒæ•´ <code>cwnd</code> å’Œé‡ä¼ </td></tr><tr class="odd"><td><strong>æ‹¥å¡æ§åˆ¶ç­–ç•¥</strong></td><td>æ…¢å¯åŠ¨ã€æ‹¥å¡é¿å…ã€å¿«é€Ÿé‡ä¼ ã€å¿«é€Ÿæ¢å¤ç­‰å¤šç§ç­–ç•¥</td><td>ä¸»è¦é€šè¿‡è°ƒæ•´ <code>cwnd</code> å’Œ <code>ssthresh</code>è¿›è¡Œç®€å•æ§åˆ¶</td></tr><tr class="even"><td><strong>ä¼˜ç‚¹</strong></td><td>ç¨³å®šå¯é ã€æœºåˆ¶å…¨é¢ã€åº”ç”¨å¹¿æ³›</td><td>å®ç°ç®€å•ã€å“åº”å¿«ã€çµæ´»æ€§é«˜ã€é€‚åˆå®æ—¶åº”ç”¨</td></tr><tr class="odd"><td><strong>ç¼ºç‚¹</strong></td><td>å¤æ‚ã€å“åº”æ…¢ã€åˆå§‹é˜¶æ®µä¿å®ˆ</td><td>æ— æ³•åº”å¯¹æ›´åŠ å¤æ‚çš„ç½‘ç»œçŠ¶å†µã€åº”ç”¨åœºæ™¯æœ‰é™</td></tr></tbody></table><p>TCP å’Œ KCP éƒ½æœ‰å„è‡ªçš„æ‹¥å¡æ§åˆ¶æœºåˆ¶ï¼Œé€‚ç”¨äºä¸åŒçš„åº”ç”¨åœºæ™¯ã€‚TCPæä¾›äº†å¤æ‚è€Œå…¨é¢çš„æ‹¥å¡æ§åˆ¶ï¼Œé€‚åˆäºå„ç§ç½‘ç»œæ¡ä»¶ä¸‹çš„å¯é ä¼ è¾“ï¼Œè€Œ KCPæä¾›äº†ç®€å•é«˜æ•ˆçš„æ§åˆ¶æœºåˆ¶ï¼Œé€‚åˆäºä½å»¶è¿Ÿå’Œé«˜å“åº”é€Ÿåº¦çš„å®æ—¶åº”ç”¨ã€‚é€‰æ‹©ä½¿ç”¨å“ªç§åè®®å–å†³äºå…·ä½“çš„åº”ç”¨éœ€æ±‚å’Œç½‘ç»œç¯å¢ƒã€‚</p><h1 id="æºç åˆ†æ">æºç åˆ†æ</h1><h2 id="æ ¸å¿ƒæ•°æ®ç»“æ„">1. æ ¸å¿ƒæ•°æ®ç»“æ„</h2><h3 id="ikcpseg-æŠ¥æ–‡æ®µç»“æ„">1.1 IKCPSEG æŠ¥æ–‡æ®µç»“æ„</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">IKCPSEG</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">IQUEUEHEAD</span> <span class="hljs-title">node</span>;</span>  <span class="hljs-comment">// é“¾è¡¨èŠ‚ç‚¹</span><br>    IUINT32 conv;     <span class="hljs-comment">// ä¼šè¯ID</span><br>    IUINT32 cmd;      <span class="hljs-comment">// å‘½ä»¤ç±»å‹</span><br>    IUINT32 frg;      <span class="hljs-comment">// åˆ†ç‰‡åºå·</span><br>    IUINT32 wnd;      <span class="hljs-comment">// çª—å£å¤§å°</span><br>    IUINT32 ts;       <span class="hljs-comment">// æ—¶é—´æˆ³</span><br>    IUINT32 sn;       <span class="hljs-comment">// åºåˆ—å·</span><br>    IUINT32 una;      <span class="hljs-comment">// å¾…æ¥æ”¶çš„ä¸‹ä¸€ä¸ªåŒ…åºå·</span><br>    IUINT32 len;      <span class="hljs-comment">// æ•°æ®é•¿åº¦</span><br>    IUINT32 resendts; <span class="hljs-comment">// é‡ä¼ æ—¶é—´æˆ³</span><br>    IUINT32 rto;      <span class="hljs-comment">// è¶…æ—¶é‡ä¼ æ—¶é—´</span><br>    IUINT32 fastack;  <span class="hljs-comment">// å¿«é€Ÿé‡ä¼ è®¡æ•°å™¨</span><br>    IUINT32 xmit;     <span class="hljs-comment">// ä¼ è¾“æ¬¡æ•°</span><br>    <span class="hljs-type">char</span> data[<span class="hljs-number">1</span>];     <span class="hljs-comment">// æ•°æ®</span><br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="ikcpcb-æ§åˆ¶å—">1.2 IKCPCB æ§åˆ¶å—</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">IKCPCB</span> &#123;</span><br>    <span class="hljs-comment">// === åŸºç¡€é…ç½® ===</span><br>    IUINT32 conv;          <span class="hljs-comment">// ä¼šè¯IDï¼Œç”¨äºæ ‡è¯†ä¸€ä¸ªä¼šè¯</span><br>    IUINT32 mtu;          <span class="hljs-comment">// æœ€å¤§ä¼ è¾“å•å…ƒï¼Œé»˜è®¤1400å­—èŠ‚</span><br>    IUINT32 mss;          <span class="hljs-comment">// æœ€å¤§æŠ¥æ–‡æ®µå¤§å°ï¼Œé»˜è®¤mtu-24å­—èŠ‚</span><br>    IUINT32 state;        <span class="hljs-comment">// è¿æ¥çŠ¶æ€ï¼Œ0=æ­£å¸¸ï¼Œ-1=æ–­å¼€</span><br><br>    <span class="hljs-comment">// === å‘é€å’Œæ¥æ”¶åºå· ===</span><br>    IUINT32 snd_una;      <span class="hljs-comment">// ç¬¬ä¸€ä¸ªæœªç¡®è®¤çš„åŒ…åºå·</span><br>    IUINT32 snd_nxt;      <span class="hljs-comment">// ä¸‹ä¸€ä¸ªå¾…å‘é€çš„åŒ…åºå·</span><br>    IUINT32 rcv_nxt;      <span class="hljs-comment">// å¾…æ¥æ”¶çš„ä¸‹ä¸€ä¸ªåŒ…åºå·</span><br><br>    <span class="hljs-comment">// === æ—¶é—´æˆ³ç›¸å…³ ===</span><br>    IUINT32 ts_recent;    <span class="hljs-comment">// æœ€è¿‘ä¸€æ¬¡æ”¶åˆ°åŒ…çš„æ—¶é—´æˆ³</span><br>    IUINT32 ts_lastack;   <span class="hljs-comment">// æœ€è¿‘ä¸€æ¬¡æ”¶åˆ°ACKçš„æ—¶é—´æˆ³</span><br>    IUINT32 ssthresh;     <span class="hljs-comment">// æ…¢å¯åŠ¨é˜ˆå€¼ï¼Œé»˜è®¤ä¸ºIKCP_THRESH_INIT(2)</span><br><br>    <span class="hljs-comment">// === RTTç›¸å…³ ===</span><br>    IINT32 rx_rttval;     <span class="hljs-comment">// RTTçš„å˜åŒ–é‡</span><br>    IINT32 rx_srtt;       <span class="hljs-comment">// å¹³æ»‘åçš„RTT</span><br>    IINT32 rx_rto;        <span class="hljs-comment">// è¶…æ—¶é‡ä¼ æ—¶é—´ï¼Œåˆå§‹ä¸ºIKCP_RTO_DEF(200ms)</span><br>    IINT32 rx_minrto;     <span class="hljs-comment">// æœ€å°é‡ä¼ è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸ºIKCP_RTO_MIN(100ms)</span><br><br>    <span class="hljs-comment">// === çª—å£ç›¸å…³ ===</span><br>    IUINT32 snd_wnd;      <span class="hljs-comment">// å‘é€çª—å£å¤§å°ï¼Œé»˜è®¤32</span><br>    IUINT32 rcv_wnd;      <span class="hljs-comment">// æ¥æ”¶çª—å£å¤§å°ï¼Œé»˜è®¤128</span><br>    IUINT32 rmt_wnd;      <span class="hljs-comment">// è¿œç«¯çª—å£å¤§å°ï¼Œé»˜è®¤128</span><br>    IUINT32 cwnd;         <span class="hljs-comment">// æ‹¥å¡çª—å£å¤§å°ï¼Œåˆå§‹ä¸º0</span><br>    IUINT32 probe;        <span class="hljs-comment">// æ¢æµ‹æ ‡å¿—ï¼Œç”¨äºçª—å£æ¢æµ‹</span><br><br>    <span class="hljs-comment">// === æ—¶é—´ç›¸å…³ ===</span><br>    IUINT32 current;      <span class="hljs-comment">// å½“å‰æ—¶é—´</span><br>    IUINT32 interval;     <span class="hljs-comment">// å†…éƒ¨æ›´æ–°æ—¶é—´é—´éš”ï¼Œé»˜è®¤100ms</span><br>    IUINT32 ts_flush;     <span class="hljs-comment">// ä¸‹æ¬¡åˆ·æ–°æ—¶é—´</span><br>    IUINT32 xmit;         <span class="hljs-comment">// æ€»é‡ä¼ æ¬¡æ•°</span><br><br>    <span class="hljs-comment">// === é˜Ÿåˆ—è®¡æ•°å™¨ ===</span><br>    IUINT32 nrcv_buf;     <span class="hljs-comment">// æ¥æ”¶ç¼“å­˜ä¸­çš„åŒ…æ•°é‡</span><br>    IUINT32 nsnd_buf;     <span class="hljs-comment">// å‘é€ç¼“å­˜ä¸­çš„åŒ…æ•°é‡</span><br>    IUINT32 nrcv_que;     <span class="hljs-comment">// æ¥æ”¶é˜Ÿåˆ—ä¸­çš„åŒ…æ•°é‡</span><br>    IUINT32 nsnd_que;     <span class="hljs-comment">// å‘é€é˜Ÿåˆ—ä¸­çš„åŒ…æ•°é‡</span><br><br>    <span class="hljs-comment">// === é…ç½®æ ‡å¿— ===</span><br>    IUINT32 nodelay;      <span class="hljs-comment">// æ˜¯å¦å¯ç”¨nodelayæ¨¡å¼ï¼Œ0=ä¸å¯ç”¨</span><br>    IUINT32 updated;      <span class="hljs-comment">// æ˜¯å¦è°ƒç”¨è¿‡update</span><br><br>    <span class="hljs-comment">// === æ¢æµ‹ç›¸å…³ ===</span><br>    IUINT32 ts_probe;     <span class="hljs-comment">// ä¸‹æ¬¡æ¢æµ‹æ—¶é—´</span><br>    IUINT32 probe_wait;   <span class="hljs-comment">// æ¢æµ‹ç­‰å¾…æ—¶é—´</span><br><br>    <span class="hljs-comment">// === é“¾è·¯æ§åˆ¶ ===</span><br>    IUINT32 dead_link;    <span class="hljs-comment">// æœ€å¤§é‡ä¼ æ¬¡æ•°ï¼Œé»˜è®¤ä¸ºIKCP_DEADLINK(20)</span><br>    IUINT32 incr;         <span class="hljs-comment">// å¯å‘é€çš„æœ€å¤§æ•°æ®é‡</span><br><br>    <span class="hljs-comment">// === æ•°æ®é˜Ÿåˆ— ===</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">IQUEUEHEAD</span> <span class="hljs-title">snd_queue</span>;</span>  <span class="hljs-comment">// å‘é€é˜Ÿåˆ—</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">IQUEUEHEAD</span> <span class="hljs-title">rcv_queue</span>;</span>  <span class="hljs-comment">// æ¥æ”¶é˜Ÿåˆ—</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">IQUEUEHEAD</span> <span class="hljs-title">snd_buf</span>;</span>    <span class="hljs-comment">// å‘é€ç¼“å­˜</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">IQUEUEHEAD</span> <span class="hljs-title">rcv_buf</span>;</span>    <span class="hljs-comment">// æ¥æ”¶ç¼“å­˜</span><br><br>    <span class="hljs-comment">// === ACKç›¸å…³ ===</span><br>    IUINT32 *acklist;     <span class="hljs-comment">// ACKåˆ—è¡¨</span><br>    IUINT32 ackcount;     <span class="hljs-comment">// ACKæ•°é‡</span><br>    IUINT32 ackblock;     <span class="hljs-comment">// ACKåˆ—è¡¨å¤§å°</span><br><br>    <span class="hljs-comment">// === ç”¨æˆ·ç›¸å…³ ===</span><br>    <span class="hljs-type">void</span> *user;           <span class="hljs-comment">// ç”¨æˆ·æ•°æ®æŒ‡é’ˆ</span><br>    <span class="hljs-type">char</span> *buffer;         <span class="hljs-comment">// ä¸´æ—¶ç¼“å­˜</span><br><br>    <span class="hljs-comment">// === å¿«é€Ÿé‡ä¼ ç›¸å…³ ===</span><br>    <span class="hljs-type">int</span> fastresend;       <span class="hljs-comment">// è§¦å‘å¿«é€Ÿé‡ä¼ çš„é‡å¤ACKä¸ªæ•°</span><br>    <span class="hljs-type">int</span> fastlimit;        <span class="hljs-comment">// å¿«é€Ÿé‡ä¼ æ¬¡æ•°é™åˆ¶ï¼Œé»˜è®¤IKCP_FASTACK_LIMIT(5)</span><br><br>    <span class="hljs-comment">// === å…¶ä»–é…ç½® ===</span><br>    <span class="hljs-type">int</span> nocwnd;          <span class="hljs-comment">// æ˜¯å¦å…³é—­æ‹¥å¡æ§åˆ¶ï¼Œ0=ä¸å…³é—­</span><br>    <span class="hljs-type">int</span> stream;          <span class="hljs-comment">// æ˜¯å¦ä¸ºæµæ¨¡å¼ï¼Œ0=æ¶ˆæ¯æ¨¡å¼(é»˜è®¤)ï¼Œ1=æµæ¨¡å¼</span><br>    <span class="hljs-type">int</span> logmask;        <span class="hljs-comment">// æ—¥å¿—æ©ç ï¼Œæ§åˆ¶æ—¥å¿—è¾“å‡ºçº§åˆ«</span><br><br>    <span class="hljs-comment">// === å›è°ƒå‡½æ•° ===</span><br>    <span class="hljs-comment">// æ•°æ®è¾“å‡ºå›è°ƒï¼Œç”¨äºå‘é€æ•°æ®</span><br>    <span class="hljs-type">int</span> (*output)(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">int</span> len, <span class="hljs-keyword">struct</span> IKCPCB *kcp, <span class="hljs-type">void</span> *user);<br>    <span class="hljs-comment">// æ—¥å¿—è¾“å‡ºå›è°ƒ</span><br>    <span class="hljs-type">void</span> (*writelog)(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-built_in">log</span>, <span class="hljs-keyword">struct</span> IKCPCB *kcp, <span class="hljs-type">void</span> *user);<br>&#125;;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªç»“æ„ä½“å¯ä»¥å¤§è‡´åˆ†ä¸ºå‡ ä¸ªä¸»è¦éƒ¨åˆ†ï¼š</p><ul><li>åŸºç¡€é…ç½®ï¼šåŒ…å«åŸºæœ¬çš„ä¼šè¯æ ‡è¯†å’Œä¼ è¾“å•å…ƒå¤§å°è®¾ç½®</li><li>åºå·è¿½è¸ªï¼šç”¨äºè¿½è¸ªå‘é€å’Œæ¥æ”¶çš„åŒ…åºå·</li><li>æ—¶é—´ç®¡ç†ï¼šåŒ…å«å„ç§æ—¶é—´æˆ³å’Œå®šæ—¶å™¨</li><li>çª—å£æ§åˆ¶ï¼šå®ç°æµé‡æ§åˆ¶å’Œæ‹¥å¡æ§åˆ¶</li><li>é˜Ÿåˆ—ç®¡ç†ï¼šç®¡ç†æ•°æ®çš„å‘é€å’Œæ¥æ”¶</li><li>ACK å¤„ç†ï¼šå¤„ç†ç¡®è®¤åŒ…</li><li>é…ç½®é€‰é¡¹ï¼šå„ç§åŠŸèƒ½å¼€å…³å’Œå‚æ•°è®¾ç½®</li><li>å›è°ƒå‡½æ•°ï¼šç”¨äºæ•°æ®è¾“å‡ºå’Œæ—¥å¿—è®°å½•</li></ul><h2 id="æ ¸å¿ƒå‡½æ•°">2. æ ¸å¿ƒå‡½æ•°</h2><p>åœ¨è¿›å…¥å…·ä½“çš„æ ¸å¿ƒå‡½æ•°åˆ†æä¹‹å‰ï¼Œéœ€è¦å…ˆç‚¹æ˜ 2 ç‚¹ï¼Œ<code>kcp</code>çš„å®ç°è€…æœŸæœ›å…¶å°½å¯èƒ½åœ°ç®€å•å’Œå‡å°‘ä¾èµ–ï¼Œæ‰€ä»¥æ•°æ®çš„è¾“å‡ºç”šè‡³æ˜¯å½“å‰æ—¶é—´éƒ½æ˜¯ç”±ä½¿ç”¨è€…æ¥è®¾ç½®çš„ï¼Œå³<code>kcp</code> æœ¬èº«æ˜¯ä¸ä¾èµ–äºæœºå™¨æ—¶é’Ÿçš„ã€‚å…·ä½“ä½“ç°åœ¨ä¸‹é¢ 2 ä¸ªå‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//---------------------------------------------------------------------</span><br><span class="hljs-comment">// set output callback, which will be invoked by kcp</span><br><span class="hljs-comment">//---------------------------------------------------------------------</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">ikcp_setoutput</span><span class="hljs-params">(ikcpcb *kcp, <span class="hljs-type">int</span> (*output)(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">int</span> len,</span><br><span class="hljs-params">ikcpcb *kcp, <span class="hljs-type">void</span> *user))</span><br>&#123;<br>kcp-&gt;output = output;<br>&#125;<br><br><span class="hljs-comment">//---------------------------------------------------------------------</span><br><span class="hljs-comment">// update state (call it repeatedly, every 10ms-100ms), or you can ask</span><br><span class="hljs-comment">// ikcp_check when to call it again (without ikcp_input/_send calling).</span><br><span class="hljs-comment">// &#x27;current&#x27; - current timestamp in millisec.</span><br><span class="hljs-comment">//---------------------------------------------------------------------</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">ikcp_update</span><span class="hljs-params">(ikcpcb *kcp, IUINT32 current)</span><br>&#123;<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ikcp_send-å‘é€æ•°æ®">2.1 ikcp_send å‘é€æ•°æ®</h3><p><code>ikcp_send</code>æ˜¯åº”ç”¨å±‚æ¥å£ï¼Œè´Ÿè´£å°†ç”¨æˆ·æ•°æ®åˆ†ç‰‡å¹¶åŠ å…¥åˆ°å‘é€é˜Ÿåˆ—ï¼ˆ<code>snd_queue</code>ï¼‰ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20241129154115523.png"alt="ikcp_send" /><figcaption aria-hidden="true">ikcp_send</figcaption></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//---------------------------------------------------------------------</span><br><span class="hljs-comment">// user/upper level send, returns below zero for error</span><br><span class="hljs-comment">//---------------------------------------------------------------------</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">ikcp_send</span><span class="hljs-params">(ikcpcb *kcp, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *buffer, <span class="hljs-type">int</span> len)</span><br>&#123;<br>IKCPSEG *seg;<br><span class="hljs-type">int</span> count, i;<br><span class="hljs-type">int</span> sent = <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">// mtu: æœ€å¤§ä¼ è¾“å•å…ƒ</span><br><span class="hljs-comment">// mss: æœ€å¤§æŠ¥æ–‡æ®µå¤§å°</span><br><span class="hljs-comment">// mss = mtu - åŒ…å¤´é•¿åº¦(24)</span><br>assert(kcp-&gt;mss &gt; <span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (len &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br><span class="hljs-comment">// append to previous segment in streaming mode (if possible)</span><br><span class="hljs-comment">// å¦‚æœæ˜¯æµæ¨¡å¼ï¼Œåˆ™å°†æ•°æ®è¿½åŠ åˆ°å‰ä¸€ä¸ªåˆ†æ®µä¸­ï¼ˆå¦‚æœå¯èƒ½ï¼‰</span><br><span class="hljs-keyword">if</span> (kcp-&gt;stream != <span class="hljs-number">0</span>) &#123;<br><span class="hljs-comment">// å¦‚æœå½“å‰å‘é€é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œä¸”å‰ä¸€ä¸ªåˆ†æ®µæœªæ»¡ï¼Œåˆ™å°†æ•°æ®è¿½åŠ åˆ°å‰ä¸€ä¸ªåˆ†æ®µä¸­</span><br><span class="hljs-keyword">if</span> (!iqueue_is_empty(&amp;kcp-&gt;snd_queue)) &#123;<br>IKCPSEG *old = iqueue_entry(kcp-&gt;snd_queue.prev, IKCPSEG, node);<br><span class="hljs-keyword">if</span> (old-&gt;len &lt; kcp-&gt;mss) &#123;<br><span class="hljs-type">int</span> capacity = kcp-&gt;mss - old-&gt;len;<br><span class="hljs-type">int</span> extend = (len &lt; capacity)? len : capacity;<br>seg = ikcp_segment_new(kcp, old-&gt;len + extend);<br>assert(seg);<br><span class="hljs-keyword">if</span> (seg == <span class="hljs-literal">NULL</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-number">-2</span>;<br>&#125;<br><span class="hljs-comment">// å°†æ–°çš„ seg-&gt;node æ”¾å…¥ snd_queue ä¸­ç­‰å¾…å‘é€</span><br>iqueue_add_tail(&amp;seg-&gt;node, &amp;kcp-&gt;snd_queue);<br><span class="hljs-comment">// æŠŠä¸Šä¸€ä¸ªæŠ¥æ–‡çš„æ•°æ®æ‹·è´è¿‡æ¥</span><br><span class="hljs-built_in">memcpy</span>(seg-&gt;data, old-&gt;data, old-&gt;len);<br><span class="hljs-keyword">if</span> (buffer) &#123;<br><span class="hljs-built_in">memcpy</span>(seg-&gt;data + old-&gt;len, buffer, extend);<br>buffer += extend;<br>&#125;<br>seg-&gt;len = old-&gt;len + extend;<br>seg-&gt;frg = <span class="hljs-number">0</span>;<br>len -= extend;<br>iqueue_del_init(&amp;old-&gt;node);<br><span class="hljs-comment">// é‡Šæ”¾ä¹‹å‰è€æ•°æ®çš„ kcp node</span><br>ikcp_segment_delete(kcp, old);<br>sent = extend;<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> (len &lt;= <span class="hljs-number">0</span>) &#123;<br><span class="hljs-keyword">return</span> sent;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// 1. éæµæ¨¡å¼ï¼Œä¸è¿½åŠ åˆ°ä¸Šä¸€ä¸ªæŠ¥æ–‡åé¢</span><br><span class="hljs-comment">// 2. æµæ¨¡å¼ï¼Œä½†æ˜¯ä¸Šä¸€ä¸ªæŠ¥æ–‡å·²æ»¡ï¼Œåˆ™åˆ›å»ºæ–°çš„æŠ¥æ–‡</span><br><br><span class="hljs-comment">// è®¡ç®—éœ€è¦çš„æŠ¥æ–‡æ•°é‡ï¼Œkcp ä¼šå¯¹æ•°æ®è¿›è¡Œåˆ†æ®µä¼ è¾“</span><br><span class="hljs-keyword">if</span> (len &lt;= (<span class="hljs-type">int</span>)kcp-&gt;mss) count = <span class="hljs-number">1</span>;<br><span class="hljs-keyword">else</span> count = (len + kcp-&gt;mss - <span class="hljs-number">1</span>) / kcp-&gt;mss;<br><br><span class="hljs-comment">// æ¥æ”¶çª—å£ä½ç½®ä¸å¤Ÿï¼Œåˆ™æš‚åœå‘é€</span><br><span class="hljs-keyword">if</span> (count &gt;= (<span class="hljs-type">int</span>)IKCP_WND_RCV) &#123;<br><span class="hljs-keyword">if</span> (kcp-&gt;stream != <span class="hljs-number">0</span> &amp;&amp; sent &gt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> sent;<br><span class="hljs-keyword">return</span> <span class="hljs-number">-2</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span> (count == <span class="hljs-number">0</span>) count = <span class="hljs-number">1</span>;<br><br><span class="hljs-comment">// å‘é€æ‰€æœ‰çš„æŠ¥æ–‡æ®µ</span><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; count; i++) &#123;<br><span class="hljs-type">int</span> size = len &gt; (<span class="hljs-type">int</span>)kcp-&gt;mss ? (<span class="hljs-type">int</span>)kcp-&gt;mss : len;<br>seg = ikcp_segment_new(kcp, size);<br>assert(seg);<br><span class="hljs-keyword">if</span> (seg == <span class="hljs-literal">NULL</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-number">-2</span>;<br>&#125;<br><span class="hljs-keyword">if</span> (buffer &amp;&amp; len &gt; <span class="hljs-number">0</span>) &#123;<br><span class="hljs-built_in">memcpy</span>(seg-&gt;data, buffer, size);<br>&#125;<br>seg-&gt;len = size;<br>seg-&gt;frg = (kcp-&gt;stream == <span class="hljs-number">0</span>)? (count - i - <span class="hljs-number">1</span>) : <span class="hljs-number">0</span>;<br>iqueue_init(&amp;seg-&gt;node);<br><br><span class="hljs-comment">// å°†æŠ¥æ–‡æ®µæ”¾å…¥ snd_queue ä¸­</span><br>iqueue_add_tail(&amp;seg-&gt;node, &amp;kcp-&gt;snd_queue);<br>kcp-&gt;nsnd_que++;<br><span class="hljs-keyword">if</span> (buffer) &#123;<br>buffer += size;<br>&#125;<br>len -= size;<br>sent += size;<br>&#125;<br><br><span class="hljs-keyword">return</span> sent;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ikcp_input-æ¥æ”¶æ•°æ®">2.2 ikcp_input æ¥æ”¶æ•°æ®</h3><p><code>ikcp_input</code> è´Ÿè´£å¤„ç†ä»ç½‘ç»œæ¥æ”¶åˆ°çš„åŸå§‹ KCPæ•°æ®åŒ…ï¼Œå®ƒä¼šå¤„ç†åè®®å±‚é¢çš„æ•°æ®ï¼ŒåŒ…æ‹¬ACKã€çª—å£æ§åˆ¶ç­‰åè®®ä¿¡æ¯ï¼Œå¹¶å°†æ¥æ”¶åˆ°çš„æ•°æ®æ”¾å…¥ KCPçš„å†…éƒ¨æ¥æ”¶ç¼“å†²åŒºï¼ˆ<code>rcv_buf</code> å’Œ <code>rcv_queue</code>ï¼‰ã€‚</p><h3 id="ikcp_recv-è·å–æ•°æ®">2.3 ikcp_recv è·å–æ•°æ®</h3><p><code>ikcp_recv</code>æ˜¯åº”ç”¨å±‚å‡½æ•°ï¼Œä¾›ä¸Šå±‚åº”ç”¨è°ƒç”¨ä»¥è·å–å®Œæ•´çš„æ¶ˆæ¯æ•°æ®ï¼Œå®ƒä» KCPçš„æ¥æ”¶é˜Ÿåˆ—(rcv_queue)ä¸­è¯»å–å·²ç»æ’åºå¥½çš„æ•°æ®ï¼Œå¤„ç†åˆ†ç‰‡é‡ç»„ï¼Œç¡®ä¿è¿”å›å®Œæ•´çš„æ¶ˆæ¯ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20241129163431276.png"alt="ikcp_recv" /><figcaption aria-hidden="true">ikcp_recv</figcaption></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//---------------------------------------------------------------------</span><br><span class="hljs-comment">// user/upper level recv: returns size, returns below zero for EAGAIN</span><br><span class="hljs-comment">// ä» rcv_queue ä¸­è·å–æ•°æ®</span><br><span class="hljs-comment">//---------------------------------------------------------------------</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">ikcp_recv</span><span class="hljs-params">(ikcpcb *kcp, <span class="hljs-type">char</span> *buffer, <span class="hljs-type">int</span> len)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">IQUEUEHEAD</span> *<span class="hljs-title">p</span>;</span><br><span class="hljs-type">int</span> ispeek = (len &lt; <span class="hljs-number">0</span>)? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>;<br><span class="hljs-type">int</span> peeksize;<br><span class="hljs-type">int</span> recover = <span class="hljs-number">0</span>;<br>IKCPSEG *seg;<br>assert(kcp);<br><br><span class="hljs-comment">// å¦‚æœ rcv_queue ä¸ºç©ºï¼Œåˆ™ç›´æ¥è¿”å›</span><br><span class="hljs-keyword">if</span> (iqueue_is_empty(&amp;kcp-&gt;rcv_queue))<br><span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br><span class="hljs-comment">// å¦‚æœ len &lt; 0ï¼Œåˆ™è¯´æ˜æ˜¯ peek æ“ä½œï¼Œå‡†å¤‡åªæŸ¥çœ‹æ•°æ®</span><br><span class="hljs-keyword">if</span> (len &lt; <span class="hljs-number">0</span>) len = -len;<br><br><span class="hljs-comment">// è®¡ç®— rcv_queue ä¸­æ•°æ®çš„å¤§å°</span><br>peeksize = ikcp_peeksize(kcp);<br><br><span class="hljs-comment">// æ— æ³•è·å¾—å¤§å°ï¼Œè¿”å› -2</span><br><span class="hljs-keyword">if</span> (peeksize &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-number">-2</span>;<br><br><span class="hljs-comment">// æ•°æ®è¿‡å¤§ï¼Œè¿”å› -3</span><br><span class="hljs-keyword">if</span> (peeksize &gt; len)<br><span class="hljs-keyword">return</span> <span class="hljs-number">-3</span>;<br><br><span class="hljs-comment">// nrcv_que: rcv_queue çš„é•¿åº¦</span><br><span class="hljs-comment">// rcv_wnd: æ¥æ”¶çª—å£çš„å¤§å°</span><br><span class="hljs-comment">// å¦‚æœ nrcv_que &gt;= rcv_wndï¼Œåˆ™éœ€è¦è¿›è¡Œå¿«æ¢å¤</span><br><span class="hljs-comment">// å› ä¸º nrcv_que &gt;= rcv_wndï¼Œè¯´æ˜æ¥æ”¶çª—å£å·²ç»æ»¡äº†ï¼Œ</span><br><span class="hljs-comment">// è¿™ä¸ªæ—¶å€™éœ€è¦å‘é€ IKCP_CMD_WINS å‘Šè¯‰å‘é€æ–¹çª—å£å¤§å°ï¼Œ</span><br><span class="hljs-comment">// è¿™ä¸ªæ—¶å€™å‘é€æ–¹éœ€è¦è¿›è¡Œå¿«æ¢å¤ï¼Œå‡å°æ•°æ®ä¼ è¾“ï¼Œä»¥å°½å¿«é‡Šæ”¾æ¥æ”¶çª—å£</span><br><span class="hljs-keyword">if</span> (kcp-&gt;nrcv_que &gt;= kcp-&gt;rcv_wnd)<br>recover = <span class="hljs-number">1</span>;<br><br><span class="hljs-comment">// merge fragment</span><br><span class="hljs-comment">// å°†å¤šä¸ªç‰‡æ®µåˆå¹¶æˆä¸€ä¸ªå®Œæ•´çš„ç‰‡æ®µ</span><br><span class="hljs-comment">// åˆå¹¶åï¼Œå°†åˆå¹¶åçš„ç‰‡æ®µä» rcv_queue ä¸­åˆ é™¤</span><br><span class="hljs-keyword">for</span> (len = <span class="hljs-number">0</span>, p = kcp-&gt;rcv_queue.next; p != &amp;kcp-&gt;rcv_queue; ) &#123;<br><span class="hljs-type">int</span> fragment;<br>seg = iqueue_entry(p, IKCPSEG, node);<br>p = p-&gt;next;<br><br><span class="hljs-keyword">if</span> (buffer) &#123;<br><span class="hljs-built_in">memcpy</span>(buffer, seg-&gt;data, seg-&gt;len);<br>buffer += seg-&gt;len;<br>&#125;<br><br>len += seg-&gt;len;<br>fragment = seg-&gt;frg;<br><br><span class="hljs-keyword">if</span> (ikcp_canlog(kcp, IKCP_LOG_RECV)) &#123;<br>ikcp_log(kcp, IKCP_LOG_RECV, <span class="hljs-string">&quot;recv sn=%lu&quot;</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)seg-&gt;sn);<br>&#125;<br><br><span class="hljs-keyword">if</span> (ispeek == <span class="hljs-number">0</span>) &#123;<br>iqueue_del(&amp;seg-&gt;node);<br>ikcp_segment_delete(kcp, seg);<br>kcp-&gt;nrcv_que--;<br>&#125;<br><br><span class="hljs-keyword">if</span> (fragment == <span class="hljs-number">0</span>)<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br>assert(len == peeksize);<br><br><span class="hljs-comment">// move available data from rcv_buf -&gt; rcv_queue</span><br><span class="hljs-comment">// å°è¯•å°† rcv_buf ä¸­ç¼–å·è¿ç»­çš„æ•°æ®ï¼Œç§»åŠ¨åˆ° rcv_queue ä¸­</span><br><span class="hljs-comment">// ç§»åŠ¨åï¼Œå°†ç§»åŠ¨çš„æ•°æ®ä» rcv_buf ä¸­åˆ é™¤</span><br><span class="hljs-keyword">while</span> (! iqueue_is_empty(&amp;kcp-&gt;rcv_buf)) &#123;<br>seg = iqueue_entry(kcp-&gt;rcv_buf.next, IKCPSEG, node);<br><span class="hljs-keyword">if</span> (seg-&gt;sn == kcp-&gt;rcv_nxt &amp;&amp; kcp-&gt;nrcv_que &lt; kcp-&gt;rcv_wnd) &#123;<br>iqueue_del(&amp;seg-&gt;node);<br>kcp-&gt;nrcv_buf--;<br>iqueue_add_tail(&amp;seg-&gt;node, &amp;kcp-&gt;rcv_queue);<br>kcp-&gt;nrcv_que++;<br>kcp-&gt;rcv_nxt++;<br>&#125;<span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">break</span>;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// å¿«æ¢å¤</span><br><span class="hljs-keyword">if</span> (kcp-&gt;nrcv_que &lt; kcp-&gt;rcv_wnd &amp;&amp; recover) &#123;<br><span class="hljs-comment">// åœ¨ikcp_flush ä¸­è¿”å› IKCP_CMD_WINS</span><br><span class="hljs-comment">// é€šçŸ¥æœ¬æ®µçª—å£å¤§å°ç»™å¯¹ç«¯</span><br>kcp-&gt;probe |= IKCP_ASK_TELL;<br>&#125;<br><br><span class="hljs-keyword">return</span> len;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ikcp_update-å®šæ—¶æ—¶é’Ÿ">2.4 ikcp_update å®šæ—¶æ—¶é’Ÿ</h3><p>å‰é¢æˆ‘ä»¬çœ‹äº† <code>ikcp_send</code> ã€<code>ikcp_input</code> å’Œ<code>ikcp_recv</code>ä¸‰ä¸ªæ ¸å¿ƒæµç¨‹çš„å‡½æ•°ï¼Œå…¶ä¸­çš„ä¸€äº›ç»†èŠ‚ï¼Œä½ å¯ä»¥å›åˆ°æœ¬æ–‡å‰é¢çš„ã€ŒåŸç†åˆ†æã€å†å¯¹ç…§æºç ä»”ç»†é˜…è¯»ã€‚</p><p>åœ¨å‰é¢çš„åŸç†åˆ†æä¸­ï¼Œæˆ‘ä»¬æåˆ°ï¼Œä¸ºäº†æé«˜ä¼ è¾“å’Œå¤„ç†æ•°æ®çš„æ•ˆç‡ï¼Œ<code>kcp</code>è®¾è®¡äº†é˜Ÿåˆ—å’Œç¼“å†²åŒºï¼ŒåŒæ—¶ä¸ºäº†å®ç°å¯é æ€§ï¼Œ<code>kcp</code> ä¹Ÿæä¾›äº†<code>ACK</code>å’Œé‡è¯•ã€æ‹¥å¡æ§åˆ¶ç­‰æœºåˆ¶ï¼Œè¿™äº›äº‹æƒ…éƒ½æ˜¯å‘¨æœŸå®šæ—¶å»å¤„ç†çš„ã€‚è¿™é‡Œæ˜¯ç”±<code>ikcp_update</code> å‡½æ•°å»å¤„ç†çš„ã€‚</p><p><code>ikcp_update</code> æ˜¯ KCP çš„å®šæ—¶å™¨å‡½æ•°ï¼Œè´Ÿè´£ä»¥å›ºå®šé—´éš”è°ƒç”¨<code>ikcp_flush</code> å¤„ç†æ•°æ®å‘é€å’Œåè®®æ›´æ–°ï¼Œæ˜¯ KCPçš„"å¿ƒè·³"æœºåˆ¶ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//---------------------------------------------------------------------</span><br><span class="hljs-comment">// update state (call it repeatedly, every 10ms-100ms), or you can ask</span><br><span class="hljs-comment">// ikcp_check when to call it again (without ikcp_input/_send calling).</span><br><span class="hljs-comment">// &#x27;current&#x27; - current timestamp in millisec.</span><br><span class="hljs-comment">//---------------------------------------------------------------------</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">ikcp_update</span><span class="hljs-params">(ikcpcb *kcp, IUINT32 current)</span><br>&#123;<br>IINT32 slap;<br><br>kcp-&gt;current = current;<br><br><span class="hljs-keyword">if</span> (kcp-&gt;updated == <span class="hljs-number">0</span>) &#123;<br>kcp-&gt;updated = <span class="hljs-number">1</span>;<br>kcp-&gt;ts_flush = kcp-&gt;current;<br>&#125;<br><br><span class="hljs-comment">// è®¡ç®—é—´éš”</span><br>slap = _itimediff(kcp-&gt;current, kcp-&gt;ts_flush);<br><br><span class="hljs-keyword">if</span> (slap &gt;= <span class="hljs-number">10000</span> || slap &lt; <span class="hljs-number">-10000</span>) &#123;<br>kcp-&gt;ts_flush = kcp-&gt;current;<br>slap = <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">// è¾¾åˆ°è°ƒç”¨é—´éš”ï¼Œåˆ™æ‰§è¡Œ ikcp_flush è¿›è¡Œæ¥æ”¶æ•°æ®æˆ–å‘é€æ•°æ®</span><br><span class="hljs-keyword">if</span> (slap &gt;= <span class="hljs-number">0</span>) &#123;<br>kcp-&gt;ts_flush += kcp-&gt;interval;<br><span class="hljs-keyword">if</span> (_itimediff(kcp-&gt;current, kcp-&gt;ts_flush) &gt;= <span class="hljs-number">0</span>) &#123;<br>kcp-&gt;ts_flush = kcp-&gt;current + kcp-&gt;interval;<br>&#125;<br>ikcp_flush(kcp);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°å¾ˆç®€å•ï¼Œæ ¹æ®æ³¨é‡Šæ‰€è¯´ï¼Œé€šå¸¸æƒ…å†µä¸‹ä¼šæ¯ <code>10ms~100ms</code>æ‰§è¡Œä¸€æ¬¡ï¼Œç„¶åæ ¸å¿ƒæ˜¯å»è°ƒç”¨ <code>ikcp_flush</code>å‡½æ•°ï¼Œæ‰€æœ‰çš„é€»è¾‘éƒ½åœ¨é‡Œé¢ã€‚</p><h3 id="ikcp_flush-å®šæ—¶å¤„ç†">2.5 ikcp_flush å®šæ—¶å¤„ç†</h3><p>å¦‚ä¸Šæ‰€è¿°ï¼Œ<code>ikcp_flush</code> æ˜¯ KCPçš„æ ¸å¿ƒå‘é€å‡½æ•°ï¼Œè´Ÿè´£å°†å‘é€é˜Ÿåˆ— <code>snd_queue</code>ä¸­çš„æ•°æ®ç§»å…¥å‘é€ç¼“å­˜ <code>snd_buf</code> å¹¶é€šè¿‡ <code>output</code>å›è°ƒå‘é€å‡ºå»ï¼ŒåŒæ—¶å¤„ç† ACKå‘é€ã€å¿«é€Ÿé‡ä¼ ã€è¶…æ—¶é‡ä¼ å’Œçª—å£æ¢æµ‹ç­‰åè®®ç»†èŠ‚ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20241129170905325.png"alt="ikcp_flush" /><figcaption aria-hidden="true">ikcp_flush</figcaption></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">ikcp_flush</span><span class="hljs-params">(ikcpcb *kcp)</span><br>&#123;<br>IUINT32 current = kcp-&gt;current;<span class="hljs-comment">// å½“å‰æ—¶é—´</span><br><span class="hljs-type">char</span> *buffer = kcp-&gt;buffer;<span class="hljs-comment">// ä¸´æ—¶ç¼“å†²åŒº</span><br><span class="hljs-type">char</span> *ptr = buffer;<br><span class="hljs-type">int</span> count, size, i;<br>IUINT32 resent, cwnd;<br>IUINT32 rtomin;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">IQUEUEHEAD</span> *<span class="hljs-title">p</span>;</span><br><span class="hljs-type">int</span> change = <span class="hljs-number">0</span>;<span class="hljs-comment">// æ˜¯å¦æ‰§è¡Œè¿‡å¿«é€Ÿé‡ä¼ </span><br><span class="hljs-type">int</span> lost = <span class="hljs-number">0</span>;<span class="hljs-comment">// æ˜¯å¦æ‰§è¡Œè¿‡è¶…æ—¶é‡ä¼ </span><br>IKCPSEG seg;<br><br><span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦å·²è°ƒç”¨ ikcp_update</span><br><span class="hljs-keyword">if</span> (kcp-&gt;updated == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;<br><br><span class="hljs-comment">// åˆå§‹åŒ–ä¸€ä¸ªæ®µç”¨äºæ„å»ºå„ç§æ§åˆ¶åŒ…</span><br>seg.conv = kcp-&gt;conv;  <span class="hljs-comment">// è¿æ¥æ ‡è¯†</span><br>seg.cmd = IKCP_CMD_ACK;<span class="hljs-comment">// æŠ¥æ–‡ç±»å‹ï¼šIKCP_CMD_ACK è¡¨ç¤ºç¡®è®¤æŠ¥æ–‡</span><br>seg.frg = <span class="hljs-number">0</span>;<span class="hljs-comment">// åˆ†ç‰‡æ•°é‡ï¼Œè¡¨ç¤ºéšåè¿˜æœ‰å¤šå°‘ä¸ªæŠ¥æ–‡å±äºåŒä¸€ä¸ªåŒ…</span><br>seg.wnd = ikcp_wnd_unused(kcp);<span class="hljs-comment">// å‘é€æ–¹å‰©ä½™æ¥æ”¶çª—å£çš„å¤§å°</span><br>seg.una = kcp-&gt;rcv_nxt;<span class="hljs-comment">// å‘é€æ–¹çš„æ¥æ”¶ç¼“å†²åŒºä¸­æœ€å°è¿˜æœªæ”¶åˆ°çš„æŠ¥æ–‡æ®µçš„ç¼–å·ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç¼–å·æ¯”å®ƒå°çš„æŠ¥æ–‡æ®µéƒ½å·²å…¨éƒ¨æ¥æ”¶</span><br>seg.len = <span class="hljs-number">0</span>;<span class="hljs-comment">// æ•°æ®æ®µé•¿åº¦</span><br>seg.sn = <span class="hljs-number">0</span>;<span class="hljs-comment">// æŠ¥æ–‡ç¼–å·</span><br>seg.ts = <span class="hljs-number">0</span>;<span class="hljs-comment">// æ—¶é—´æˆ³</span><br><br><span class="hljs-comment">// flush acknowledges</span><br><span class="hljs-comment">// â‘  å‘é€ ACK é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ ACK</span><br>count = kcp-&gt;ackcount;<br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; count; i++) &#123;<br>size = (<span class="hljs-type">int</span>)(ptr - buffer);<br><span class="hljs-comment">// buffer ä¸­ç´¯è®¡çš„æ•°æ®å°†è¦è¶…è¿‡ mtu çš„æ—¶å€™</span><br><span class="hljs-comment">// å°±è°ƒç”¨ ikcp_output å°†æ•°æ®å‘é€å‡ºå»</span><br><span class="hljs-keyword">if</span> (size + (<span class="hljs-type">int</span>)IKCP_OVERHEAD &gt; (<span class="hljs-type">int</span>)kcp-&gt;mtu) &#123;<br>ikcp_output(kcp, buffer, size);<br>ptr = buffer;<br>&#125;<br><span class="hljs-comment">// ä» ACK åˆ—è¡¨ä¸­å–å‡º sn(æŠ¥æ–‡ç¼–å·)å’Œ ts(æ—¶é—´æˆ³)</span><br>ikcp_ack_get(kcp, i, &amp;seg.sn, &amp;seg.ts);<br><span class="hljs-comment">// å°† ACK æŠ¥æ–‡å†™å…¥ buffer</span><br>ptr = ikcp_encode_seg(ptr, &amp;seg);<br>&#125;<br><span class="hljs-comment">// â‘¡ ACK é˜Ÿåˆ—å·²æ¸…ç©º</span><br>kcp-&gt;ackcount = <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">// probe window size (if remote window size equals zero)</span><br><span class="hljs-comment">// å¯¹ç«¯å‰©ä½™æ¥æ”¶çª—å£å¤§å°ä¸º 0ï¼Œåˆ™æ„å‘³ç€å¯èƒ½éœ€è¦å‘é€çª—å£æ¢æµ‹æŠ¥æ–‡ï¼šIKCP_CMD_WASK</span><br><span class="hljs-keyword">if</span> (kcp-&gt;rmt_wnd == <span class="hljs-number">0</span>) &#123;<br><span class="hljs-comment">// æ ¹æ® ts_probe å’Œ probe_wait ç¡®å®šå½“å‰æ—¶åˆ»æ˜¯å¦éœ€è¦å‘é€æ¢æµ‹æŠ¥æ–‡</span><br><span class="hljs-comment">// probe_wait: ç­‰å¾…å‘é€æ¢æµ‹æŠ¥æ–‡çš„æ—¶é—´ï¼ŒIKCP_PROBE_INIT=7s, IKCP_PROBE_LIMIT=</span><br><span class="hljs-keyword">if</span> (kcp-&gt;probe_wait == <span class="hljs-number">0</span>) &#123;<br>kcp-&gt;probe_wait = IKCP_PROBE_INIT; <span class="hljs-comment">// 7s åå»å‘æ¢æµ‹æŠ¥æ–‡</span><br>kcp-&gt;ts_probe = kcp-&gt;current + kcp-&gt;probe_wait;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">if</span> (_itimediff(kcp-&gt;current, kcp-&gt;ts_probe) &gt;= <span class="hljs-number">0</span>) &#123;<br><span class="hljs-keyword">if</span> (kcp-&gt;probe_wait &lt; IKCP_PROBE_INIT)<br>kcp-&gt;probe_wait = IKCP_PROBE_INIT;<br>kcp-&gt;probe_wait += kcp-&gt;probe_wait / <span class="hljs-number">2</span>;<br><span class="hljs-keyword">if</span> (kcp-&gt;probe_wait &gt; IKCP_PROBE_LIMIT)<br>kcp-&gt;probe_wait = IKCP_PROBE_LIMIT;<br>kcp-&gt;ts_probe = kcp-&gt;current + kcp-&gt;probe_wait;<br>kcp-&gt;probe |= IKCP_ASK_SEND; <span class="hljs-comment">// è®¾ç½®æ˜¯å¦éœ€è¦å»å‘é€ IKCP_ASK_SEND</span><br>&#125;<br>&#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>kcp-&gt;ts_probe = <span class="hljs-number">0</span>;<br>kcp-&gt;probe_wait = <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">// flush window probing commands</span><br><span class="hljs-comment">// â‘¢ å¦‚æœéœ€è¦ï¼Œåˆ™å‘é€çª—å£æ¢æµ‹æŠ¥æ–‡ï¼šIKCP_CMD_WASK</span><br><span class="hljs-keyword">if</span> (kcp-&gt;probe &amp; IKCP_ASK_SEND) &#123;<br>seg.cmd = IKCP_CMD_WASK;<br>size = (<span class="hljs-type">int</span>)(ptr - buffer);<br><span class="hljs-keyword">if</span> (size + (<span class="hljs-type">int</span>)IKCP_OVERHEAD &gt; (<span class="hljs-type">int</span>)kcp-&gt;mtu) &#123;<br>ikcp_output(kcp, buffer, size);<br>ptr = buffer;<br>&#125;<br>ptr = ikcp_encode_seg(ptr, &amp;seg);<br>&#125;<br><br><span class="hljs-comment">// flush window probing commands</span><br><span class="hljs-comment">// â‘£ å¦‚æœéœ€è¦ï¼Œåˆ™å‘é€çª—å£é€šçŸ¥æŠ¥æ–‡ï¼šIKCP_CMD_WINS</span><br><span class="hljs-keyword">if</span> (kcp-&gt;probe &amp; IKCP_ASK_TELL) &#123;<br>seg.cmd = IKCP_CMD_WINS;<br>size = (<span class="hljs-type">int</span>)(ptr - buffer);<br><span class="hljs-keyword">if</span> (size + (<span class="hljs-type">int</span>)IKCP_OVERHEAD &gt; (<span class="hljs-type">int</span>)kcp-&gt;mtu) &#123;<br>ikcp_output(kcp, buffer, size);<br>ptr = buffer;<br>&#125;<br>ptr = ikcp_encode_seg(ptr, &amp;seg);<br>&#125;<br><br>kcp-&gt;probe = <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">// calculate window size</span><br><span class="hljs-comment">// â‘¤ è®¡ç®—å½“å‰çª—å£å¤§å°</span><br>cwnd = _imin_(kcp-&gt;snd_wnd, kcp-&gt;rmt_wnd);<br><span class="hljs-keyword">if</span> (kcp-&gt;nocwnd == <span class="hljs-number">0</span>) cwnd = _imin_(kcp-&gt;cwnd, cwnd);<br><br><span class="hljs-comment">// move data from snd_queue to snd_buf</span><br><span class="hljs-comment">// 5.1 å¦‚æœç¬¦åˆå‘é€çš„æ¡ä»¶ï¼Œåˆ™åˆ›å»ºæ–°çš„ newseg å¹¶æ”¾å…¥ snd_buf çš„å°¾éƒ¨</span><br><span class="hljs-keyword">while</span> (_itimediff(kcp-&gt;snd_nxt, kcp-&gt;snd_una + cwnd) &lt; <span class="hljs-number">0</span>) &#123;<br>IKCPSEG *newseg;<br><span class="hljs-keyword">if</span> (iqueue_is_empty(&amp;kcp-&gt;snd_queue)) <span class="hljs-keyword">break</span>;<br><br>newseg = iqueue_entry(kcp-&gt;snd_queue.next, IKCPSEG, node);<br><br>iqueue_del(&amp;newseg-&gt;node);<br>iqueue_add_tail(&amp;newseg-&gt;node, &amp;kcp-&gt;snd_buf);<br>kcp-&gt;nsnd_que--;<br>kcp-&gt;nsnd_buf++;<br><br>newseg-&gt;conv = kcp-&gt;conv;<br>newseg-&gt;cmd = IKCP_CMD_PUSH;<br>newseg-&gt;wnd = seg.wnd;<br>newseg-&gt;ts = current;<br>newseg-&gt;sn = kcp-&gt;snd_nxt++;<br>newseg-&gt;una = kcp-&gt;rcv_nxt;<br>newseg-&gt;resendts = current;<br>newseg-&gt;rto = kcp-&gt;rx_rto;<br>newseg-&gt;fastack = <span class="hljs-number">0</span>;<br>newseg-&gt;xmit = <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">// calculate resent</span><br><span class="hljs-comment">// å¤±åºå¤šå°‘æ¬¡å°±å¿«é€Ÿé‡ä¼ ã€‚å¦‚æœ fastresend å¤§äº 0ï¼Œåˆ™å–å…¶å€¼ï¼›å¦åˆ™ï¼Œè®¾ä¸ºæœ€å¤§å€¼ 0xffffffffã€‚</span><br>resent = (kcp-&gt;fastresend &gt; <span class="hljs-number">0</span>)? (IUINT32)kcp-&gt;fastresend : <span class="hljs-number">0xffffffff</span>;<br><span class="hljs-comment">// æœ€å°è¶…æ—¶é‡ä¼ æ—¶é—´ã€‚å¦‚æœ nodelay ä¸º 0ï¼Œåˆ™ä¸º rx_rto çš„å…«åˆ†ä¹‹ä¸€ï¼Œå¦åˆ™ä¸º 0ã€‚</span><br>rtomin = (kcp-&gt;nodelay == <span class="hljs-number">0</span>)? (kcp-&gt;rx_rto &gt;&gt; <span class="hljs-number">3</span>) : <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">// flush data segments</span><br><span class="hljs-keyword">for</span> (p = kcp-&gt;snd_buf.next; p != &amp;kcp-&gt;snd_buf; p = p-&gt;next) &#123;<br><span class="hljs-comment">// ä» snd_buf å–å‡ºä¸€ä¸ªæŠ¥æ–‡</span><br>IKCPSEG *segment = iqueue_entry(p, IKCPSEG, node);<br><span class="hljs-type">int</span> needsend = <span class="hljs-number">0</span>;<br><span class="hljs-comment">// æ¡ä»¶1ï¼šç¬¬ä¸€æ¬¡å‘é€çš„æŠ¥æ–‡ï¼Œç›´æ¥å‘é€</span><br><span class="hljs-keyword">if</span> (segment-&gt;xmit == <span class="hljs-number">0</span>) &#123;   <span class="hljs-comment">//  è¯¥æŠ¥æ–‡çš„ xmit ä¼ è¾“æ¬¡æ•°</span><br>needsend = <span class="hljs-number">1</span>;<br>segment-&gt;xmit++;<br>segment-&gt;rto = kcp-&gt;rx_rto;<br>segment-&gt;resendts = current + segment-&gt;rto + rtomin;<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (_itimediff(current, segment-&gt;resendts) &gt;= <span class="hljs-number">0</span>) &#123;<br><span class="hljs-comment">// æ¡ä»¶2ï¼šä¸”é‡ä¼ æ—¶é—´åˆ°äº†ï¼Œåˆ™é‡ä¼ </span><br>needsend = <span class="hljs-number">1</span>;<br>segment-&gt;xmit++;<br>kcp-&gt;xmit++;<br><span class="hljs-keyword">if</span> (kcp-&gt;nodelay == <span class="hljs-number">0</span>) &#123;<br>segment-&gt;rto += _imax_(segment-&gt;rto, (IUINT32)kcp-&gt;rx_rto);<br>&#125;<span class="hljs-keyword">else</span> &#123;<br>IINT32 step = (kcp-&gt;nodelay &lt; <span class="hljs-number">2</span>)?<br>((IINT32)(segment-&gt;rto)) : kcp-&gt;rx_rto;<br>segment-&gt;rto += step / <span class="hljs-number">2</span>;<br>&#125;<br>segment-&gt;resendts = current + segment-&gt;rto;<br>lost = <span class="hljs-number">1</span>;<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (segment-&gt;fastack &gt;= resent) &#123;<br><span class="hljs-comment">// æ¡ä»¶3ï¼šè¾¾åˆ°å¿«é€Ÿé‡ä¼ æ¬¡æ•°ï¼Œåˆ™é‡ä¼ </span><br><span class="hljs-keyword">if</span> ((<span class="hljs-type">int</span>)segment-&gt;xmit &lt;= kcp-&gt;fastlimit ||<br>kcp-&gt;fastlimit &lt;= <span class="hljs-number">0</span>) &#123;<br>needsend = <span class="hljs-number">1</span>;<br>segment-&gt;xmit++;<br>segment-&gt;fastack = <span class="hljs-number">0</span>;<br>segment-&gt;resendts = current + segment-&gt;rto;<br>change++;<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">if</span> (needsend) &#123;<br><span class="hljs-type">int</span> need;<br>segment-&gt;ts = current;<br>segment-&gt;wnd = seg.wnd;<br>segment-&gt;una = kcp-&gt;rcv_nxt;<br><br>size = (<span class="hljs-type">int</span>)(ptr - buffer);<br>need = IKCP_OVERHEAD + segment-&gt;len;<br><br><span class="hljs-keyword">if</span> (size + need &gt; (<span class="hljs-type">int</span>)kcp-&gt;mtu) &#123;<br>ikcp_output(kcp, buffer, size);<br>ptr = buffer;<br>&#125;<br><br>ptr = ikcp_encode_seg(ptr, segment);<br><br><span class="hljs-keyword">if</span> (segment-&gt;len &gt; <span class="hljs-number">0</span>) &#123;<br><span class="hljs-built_in">memcpy</span>(ptr, segment-&gt;data, segment-&gt;len);<br>ptr += segment-&gt;len;<br>&#125;<br><br><span class="hljs-comment">// å¦‚æœæŸä¸ªæ•°æ®åŒ…çš„é‡ä¼ æ¬¡æ•°è¶…è¿‡é˜ˆå€¼ï¼Œåˆ™æ ‡è®°è¿æ¥æ–­å¼€ã€‚</span><br><span class="hljs-keyword">if</span> (segment-&gt;xmit &gt;= kcp-&gt;dead_link) &#123;<br>kcp-&gt;state = (IUINT32)<span class="hljs-number">-1</span>;<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// flash remain segments</span><br>size = (<span class="hljs-type">int</span>)(ptr - buffer);<br><span class="hljs-keyword">if</span> (size &gt; <span class="hljs-number">0</span>) &#123;<br>ikcp_output(kcp, buffer, size);<br>&#125;<br><br><span class="hljs-comment">// update ssthresh</span><br><span class="hljs-comment">// 1. å¦‚æœå‘ç”Ÿäº†å¿«é€Ÿé‡ä¼ ï¼Œè®© ssthresh å‡åŠï¼Œè¿›å…¥å¿«æ¢å¤</span><br><span class="hljs-keyword">if</span> (change) &#123;<br>IUINT32 inflight = kcp-&gt;snd_nxt - kcp-&gt;snd_una;<br>kcp-&gt;ssthresh = inflight / <span class="hljs-number">2</span>;<br><span class="hljs-keyword">if</span> (kcp-&gt;ssthresh &lt; IKCP_THRESH_MIN)<br>kcp-&gt;ssthresh = IKCP_THRESH_MIN;<br>kcp-&gt;cwnd = kcp-&gt;ssthresh + resent;<br>kcp-&gt;incr = kcp-&gt;cwnd * kcp-&gt;mss;<br>&#125;<br><br><span class="hljs-comment">// 2. å¦‚æœå‘ç”Ÿäº†è¶…æ—¶é‡ä¼ ï¼Œåˆ™è®© ssthresh å‡åŠï¼Œç„¶å cwnd = 1ï¼Œè¿›å…¥æ…¢å¯åŠ¨</span><br><span class="hljs-keyword">if</span> (lost) &#123;<br>kcp-&gt;ssthresh = cwnd / <span class="hljs-number">2</span>;<br><span class="hljs-keyword">if</span> (kcp-&gt;ssthresh &lt; IKCP_THRESH_MIN)<br>kcp-&gt;ssthresh = IKCP_THRESH_MIN;<br>kcp-&gt;cwnd = <span class="hljs-number">1</span>;<br>kcp-&gt;incr = kcp-&gt;mss;<br>&#125;<br><br><span class="hljs-comment">// å…œåº•ï¼Œcwnd è‡³å°‘ä¸º 1</span><br><span class="hljs-keyword">if</span> (kcp-&gt;cwnd &lt; <span class="hljs-number">1</span>) &#123;<br>kcp-&gt;cwnd = <span class="hljs-number">1</span>;<br>kcp-&gt;incr = kcp-&gt;mss;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="å‚è€ƒ">å‚è€ƒ</h1><ul><li><a href="https://github.com/skywind3000/kcp">KCP repo</a></li><li><a href="https://luyuhuang.tech/2020/12/09/kcp.html">è¯¦è§£ KCPåè®®çš„åŸç†å’Œå®ç°</a></li></ul>]]></content>
    
    
    <summary type="html">æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†æ¸¸æˆå¼€å‘ä¸­å¸¸ç”¨çš„ç½‘ç»œåè®® KCP çš„åº•å±‚åŸç†å’Œæºç å®ç°ã€‚é€šè¿‡å¤§é‡å›¾ç¤ºå’ŒåŸç†æ€»ç»“,å¸®åŠ©è¯»è€…æ·±å…¥ç†è§£ KCP åè®®çš„å·¥ä½œæœºåˆ¶ï¼ŒåŒ…æ‹¬å…¶å¿«é€Ÿé‡ä¼ ã€é€‰æ‹©æ€§ç¡®è®¤ã€æµé‡æ§åˆ¶ç­‰æ ¸å¿ƒç‰¹æ€§ã€‚</summary>
    
    
    
    <category term="è®¡ç®—æœºåŸºç¡€" scheme="https://hedon.top/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/"/>
    
    <category term="è®¡ç®—æœºç½‘ç»œ" scheme="https://hedon.top/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"/>
    
    
    <category term="KCP" scheme="https://hedon.top/tags/KCP/"/>
    
    <category term="TCP" scheme="https://hedon.top/tags/TCP/"/>
    
    <category term="ç½‘ç»œ" scheme="https://hedon.top/tags/%E7%BD%91%E7%BB%9C/"/>
    
  </entry>
  
  <entry>
    <title>Rust å…¥é—¨ä¸¨01 ç±»å‹ç³»ç»Ÿæ¦‚è¿°</title>
    <link href="https://hedon.top/2024/11/28/rust-01-type-system/"/>
    <id>https://hedon.top/2024/11/28/rust-01-type-system/</id>
    <published>2024-11-28T09:52:47.000Z</published>
    <updated>2024-12-01T02:42:28.951Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ Rust ç¼–ç¨‹ä¸–ç•Œä¸­ï¼Œç»å¤§éƒ¨åˆ†çš„ç‰¹æ€§å’Œèƒ½åŠ›éƒ½ç¦»ä¸å¼€ Rustå¼ºå¤§çš„ç±»å‹ç³»ç»Ÿï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªç³»åˆ—çš„ç¬¬ 1 ç¯‡æˆ‘ä»¬å…ˆæ¥å¯¹ Rustçš„ç±»å‹ç³»ç»Ÿåšä¸€ä¸ªå…¨å±€æ¦‚è¿°ï¼Œå¸Œæœ›å¯ä»¥å¸®åŠ©ä½ å»ºç«‹èµ·å¯¹ Rustçš„åŸºæœ¬å°è±¡ã€‚åœ¨åç»­çš„å®è·µè¿‡ç¨‹ä¸­ï¼Œæˆ‘æ¨èä½ å¯ä»¥ç»å¸¸å›æ¥æ€è€ƒä¸‹ä¸ºä»€ä¹ˆ Rustè¦æ„å»ºè¿™æ ·çš„ç±»å‹ç³»ç»Ÿï¼Œåœ¨æ¯ä¸€ä¸ªåˆ†æ”¯ç‚¹æ˜¯å¦‚ä½•åšå‡ºå†³ç­–çš„ï¼Œè¿™äº›å†³ç­–åˆä½“ç°åœ¨ä»£ç çš„å“ªäº›åœ°æ–¹ã€‚ç›¸ä¿¡è¿™æ ·å¯ä»¥å¸®åŠ©ä½ æ›´å¥½åœ°å…¥é—¨Rustã€‚</p><p>åºŸè¯ä¸å¤šè¯´ï¼Œè¿›å…¥æ­£æ–‡ã€‚</p><h1 id="ä»€ä¹ˆæ˜¯ç±»å‹ç³»ç»Ÿ">ä»€ä¹ˆæ˜¯ç±»å‹ç³»ç»Ÿï¼Ÿ</h1><p>åœ¨è¿›å…¥ Rustç±»å‹ç³»ç»Ÿè®¨è®ºä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå°è¯•å åœ¨æ›´é«˜çš„è§’åº¦ï¼Œå³æ•´ä¸ªç¼–ç¨‹è¯­è¨€ç•Œçš„è§’åº¦å»æ€è€ƒï¼Œ<font color="red">ä»€ä¹ˆæ˜¯ç±»å‹ç³»ç»Ÿï¼Ÿ</font></p><blockquote><p>ç¼–ç¨‹è¯­è¨€çš„ç±»å‹ç³»ç»Ÿæ˜¯æŒ‡ä¸€å¥—è§„åˆ™ï¼Œç”¨äºå®šä¹‰å’Œç®¡ç†ç¨‹åºä¸­æ•°æ®çš„ç±»å‹ã€‚ç±»å‹ç³»ç»Ÿçš„ä¸»è¦ç›®çš„æ˜¯å¸®åŠ©æ•è·ç¨‹åºä¸­çš„é”™è¯¯ï¼Œæé«˜ä»£ç çš„å¯é æ€§å’Œå¯è¯»æ€§ã€‚</p></blockquote><p>ç±»å‹ç³»ç»Ÿå¯ä»¥æ ¹æ®å¤šç§ç‰¹æ€§è¿›è¡Œåˆ†ç±»ï¼Œä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p><ol type="1"><li><strong>é™æ€ç±»å‹å’ŒåŠ¨æ€ç±»å‹</strong>ï¼š<ul><li><strong>é™æ€ç±»å‹</strong>ï¼šåœ¨ç¼–è¯‘æ—¶æ£€æŸ¥å˜é‡ç±»å‹ã€‚ä¾‹å¦‚ï¼ŒJavaã€C++ å’ŒHaskelléƒ½æ˜¯é™æ€ç±»å‹è¯­è¨€ã€‚åœ¨è¿™äº›è¯­è¨€ä¸­ï¼Œå˜é‡çš„ç±»å‹å¿…é¡»åœ¨ç¼–è¯‘æ—¶ç¡®å®šï¼Œè¿™æ ·å¯ä»¥åœ¨ç¼–è¯‘é˜¶æ®µæ•è·è®¸å¤šç±»å‹é”™è¯¯ã€‚</li><li><strong>åŠ¨æ€ç±»å‹</strong>ï¼šåœ¨è¿è¡Œæ—¶æ£€æŸ¥å˜é‡ç±»å‹ã€‚ä¾‹å¦‚ï¼ŒPythonã€Rubyå’Œ JavaScriptæ˜¯åŠ¨æ€ç±»å‹è¯­è¨€ã€‚åœ¨è¿™äº›è¯­è¨€ä¸­ï¼Œå˜é‡çš„ç±»å‹æ˜¯åœ¨ç¨‹åºè¿è¡Œæ—¶ç¡®å®šçš„ï¼Œè¿™æä¾›äº†æ›´å¤§çš„çµæ´»æ€§ï¼Œä½†ä¹Ÿå¯èƒ½å¯¼è‡´è¿è¡Œæ—¶é”™è¯¯ã€‚</li></ul></li><li><strong>å¼ºç±»å‹å’Œå¼±ç±»å‹</strong>ï¼š<ul><li><strong>å¼ºç±»å‹</strong>ï¼šä¸¥æ ¼é™åˆ¶ä¸åŒç±»å‹ä¹‹é—´çš„æ“ä½œã€‚ä¾‹å¦‚ï¼ŒPython å’ŒJavaæ˜¯å¼ºç±»å‹è¯­è¨€ã€‚å¼ºç±»å‹ç³»ç»Ÿé€šå¸¸ä¸å…è®¸éšå¼ç±»å‹è½¬æ¢ï¼Œè¿™æ„å‘³ç€åœ¨è¿›è¡Œä¸åŒç±»å‹ä¹‹é—´çš„æ“ä½œæ—¶ï¼Œå¿…é¡»æ˜¾å¼åœ°è¿›è¡Œç±»å‹è½¬æ¢ã€‚</li><li><strong>å¼±ç±»å‹</strong>ï¼šå…è®¸æ›´å¤šéšå¼ç±»å‹è½¬æ¢ã€‚ä¾‹å¦‚ï¼ŒJavaScript å’ŒPerlæ˜¯å¼±ç±»å‹è¯­è¨€ã€‚åœ¨è¿™äº›è¯­è¨€ä¸­ï¼Œç¼–è¯‘å™¨æˆ–è§£é‡Šå™¨ä¼šåœ¨éœ€è¦æ—¶è‡ªåŠ¨è¿›è¡Œç±»å‹è½¬æ¢ï¼Œè¿™å¯èƒ½å¯¼è‡´éš¾ä»¥é¢„æ–™çš„è¡Œä¸ºã€‚</li></ul></li><li><strong>æ˜¾å¼ç±»å‹å’Œéšå¼ç±»å‹</strong>ï¼š<ul><li><strong>æ˜¾å¼ç±»å‹</strong>ï¼šç¨‹åºå‘˜å¿…é¡»æ˜ç¡®å£°æ˜æ¯ä¸ªå˜é‡çš„ç±»å‹ã€‚ä¾‹å¦‚ï¼ŒJavaå’Œ C++ è¦æ±‚åœ¨å£°æ˜å˜é‡æ—¶æŒ‡å®šå…¶ç±»å‹ã€‚</li><li><strong>éšå¼ç±»å‹</strong>ï¼šç¼–è¯‘å™¨æˆ–è§£é‡Šå™¨ä¼šæ ¹æ®ä¸Šä¸‹æ–‡è‡ªåŠ¨æ¨æ–­å˜é‡çš„ç±»å‹ã€‚ä¾‹å¦‚ï¼ŒPythonå’Œ JavaScript ä½¿ç”¨éšå¼ç±»å‹ï¼Œç¨‹åºå‘˜ä¸éœ€è¦æ˜¾å¼å£°æ˜å˜é‡ç±»å‹ã€‚</li></ul></li><li><strong>å­ç±»å‹å’Œå¤šæ€</strong>ï¼š<ul><li><strong>å­ç±»å‹</strong>ï¼šä¸€ç§ç±»å‹ç³»ç»Ÿå…è®¸ä¸€ç§ç±»å‹ä½œä¸ºå¦ä¸€ç§ç±»å‹çš„å­é›†ã€‚ä¾‹å¦‚ï¼Œåœ¨é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­ï¼Œå­ç±»æ˜¯çˆ¶ç±»çš„å­ç±»å‹ã€‚</li><li><strong>å¤šæ€</strong>ï¼šå…è®¸ä¸€ä¸ªæ¥å£è¢«å¤šç§ä¸åŒç±»å‹å®ç°ã€‚å¤šæ€æ€§æœ‰å¤šç§å½¢å¼ï¼ŒåŒ…æ‹¬å‚æ•°å¤šæ€ï¼ˆå¦‚æ³›å‹ï¼‰å’Œå­ç±»å‹å¤šæ€ï¼ˆå¦‚ç»§æ‰¿ï¼‰ã€‚</li></ul></li><li><strong>ç±»å‹æ¨æ–­</strong>ï¼š<ul><li>ç±»å‹æ¨æ–­æ˜¯æŒ‡ç¼–è¯‘å™¨è‡ªåŠ¨ç¡®å®šè¡¨è¾¾å¼çš„ç±»å‹ï¼Œè€Œæ— éœ€æ˜ç¡®çš„ç±»å‹æ³¨é‡Šã€‚ä¾‹å¦‚ï¼ŒHaskellå’Œ Scala ä½¿ç”¨ç±»å‹æ¨æ–­æ¥å‡å°‘ç¨‹åºå‘˜çš„è´Ÿæ‹…ï¼ŒåŒæ—¶ä¿æŒé™æ€ç±»å‹çš„å®‰å…¨æ€§ã€‚</li></ul></li><li><strong>ä»£æ•°æ•°æ®ç±»å‹å’Œç±»å‹æ„é€ </strong>ï¼š<ul><li>ä»£æ•°æ•°æ®ç±»å‹ï¼ˆADTï¼‰æ˜¯é€šè¿‡ç»„åˆå…¶ä»–ç±»å‹æ¥æ„é€ æ–°ç±»å‹çš„æœºåˆ¶ï¼Œå¸¸è§äºå‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ï¼Œå¦‚Haskell å’Œ OCamlã€‚ADT åŒ…æ‹¬äº§å“ç±»å‹ï¼ˆå¦‚å…ƒç»„ï¼‰å’Œå’Œç±»å‹ï¼ˆå¦‚æšä¸¾ï¼‰ã€‚</li></ul></li><li><strong>ç»“æ„ç±»å‹å’Œåä¹‰ç±»å‹</strong>ï¼š<ul><li><strong>ç»“æ„ç±»å‹</strong>ï¼šåŸºäºå¯¹è±¡çš„ç»“æ„æ¥ç¡®å®šç±»å‹çš„å…¼å®¹æ€§ã€‚ä¾‹å¦‚ï¼ŒTypeScriptå’Œ Go ä½¿ç”¨ç»“æ„ç±»å‹ç³»ç»Ÿã€‚</li><li><strong>åä¹‰ç±»å‹</strong>ï¼šåŸºäºåç§°æ¥ç¡®å®šç±»å‹çš„å…¼å®¹æ€§ã€‚ä¾‹å¦‚ï¼ŒJava å’ŒC++ ä½¿ç”¨åä¹‰ç±»å‹ç³»ç»Ÿã€‚</li></ul></li></ol><p>è¿™é‡Œæˆ‘æ¢³ç†äº†ä¸€å¼ å›¾ï¼Œä¾›ä½ å‚è€ƒï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20241128183852984.png"alt="ç¼–ç¨‹è¯­è¨€ç±»å‹ç³»ç»Ÿ" /><figcaption aria-hidden="true">ç¼–ç¨‹è¯­è¨€ç±»å‹ç³»ç»Ÿ</figcaption></figure><blockquote><p>æ³¨ï¼šæœ¬å›¾å‚è€ƒäº†é™ˆå¤©è€å¸ˆåœ¨ Rustè®­ç»ƒè¥è¯¾ç¨‹ä¸Šæä¾›çš„æ•™æ¡ˆå¹¶è¿›è¡Œäº†å¢æ”¹ã€‚</p></blockquote><h1 id="rust-ç±»å‹ç³»ç»Ÿ">Rust ç±»å‹ç³»ç»Ÿ</h1><p>Rustä¸ºäº†åœ¨æä¾›é«˜æ€§èƒ½çš„åŒæ—¶ä¿è¯å†…å­˜å®‰å…¨å’Œçº¿ç¨‹å®‰å…¨ï¼ŒèŠ±äº†å¤§é‡åŠ›æ°”æ„å»ºäº†ä¸€ä¸ªå¼ºå¤§çš„ç±»å‹ç³»ç»Ÿã€‚</p><p>åŸºäºä¹‹å‰æåˆ°çš„ä¸ƒä¸ªæ–¹é¢ï¼Œæˆ‘ä»¬æ¥æ¢³ç†ä¸‹ Rust çš„ç±»å‹ç³»ç»Ÿï¼š</p><ol type="1"><li><p><strong>é™æ€ç±»å‹</strong>ï¼šRustæ˜¯é™æ€ç±»å‹è¯­è¨€ï¼Œè¿™æ„å‘³ç€å˜é‡çš„ç±»å‹åœ¨ç¼–è¯‘æ—¶å°±è¢«ç¡®å®šã€‚è¿™ç§è®¾è®¡ä½¿å¾— Ruståœ¨ç¼–è¯‘é˜¶æ®µå°±å¯ä»¥æ•è·è®¸å¤šç±»å‹é”™è¯¯ï¼Œä»è€Œæé«˜ä»£ç çš„å®‰å…¨æ€§å’Œæ€§èƒ½ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">x</span>: <span class="hljs-type">i32</span> = <span class="hljs-number">10</span>; <span class="hljs-comment">// æ˜ç¡®æŒ‡å®šç±»å‹</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>å¼ºç±»å‹</strong>ï¼šRustæ˜¯å¼ºç±»å‹è¯­è¨€ï¼Œå®ƒä¸¥æ ¼é™åˆ¶ä¸åŒç±»å‹ä¹‹é—´çš„æ“ä½œã€‚Rustä¸å…è®¸éšå¼ç±»å‹è½¬æ¢ï¼ˆä¾‹å¦‚ï¼Œä¸èƒ½è‡ªåŠ¨å°†æ•´æ•°è½¬æ¢ä¸ºæµ®ç‚¹æ•°ï¼‰ï¼Œéœ€è¦æ˜¾å¼åœ°ä½¿ç”¨as è¿›è¡Œç±»å‹è½¬æ¢ã€‚è¿™ç§ä¸¥æ ¼æ€§æœ‰åŠ©äºé¿å…è®¸å¤šå¸¸è§çš„ç¼–ç¨‹é”™è¯¯ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">x</span>: <span class="hljs-type">i32</span> = <span class="hljs-number">5</span>;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">y</span>: <span class="hljs-type">f64</span> = <span class="hljs-number">10.0</span>;<br><br>    <span class="hljs-comment">// é”™è¯¯ï¼šä¸èƒ½å°† i32 éšå¼è½¬æ¢ä¸º f64</span><br>    <span class="hljs-comment">// let sum = x + y;</span><br><br>    <span class="hljs-comment">// æ­£ç¡®ï¼šéœ€è¦æ˜¾å¼è½¬æ¢</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">sum</span> = x <span class="hljs-keyword">as</span> <span class="hljs-type">f64</span> + y;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Sum = &#123;&#125;&quot;</span>, sum);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>æ˜¾å¼ç±»å‹å’Œç±»å‹æ¨æ–­</strong>ï¼šè™½ç„¶ Rustæ˜¯æ˜¾å¼ç±»å‹è¯­è¨€ï¼Œè¦æ±‚åœ¨æŸäº›æƒ…å†µä¸‹å£°æ˜å˜é‡ç±»å‹ï¼Œä½†å®ƒä¹Ÿå…·æœ‰å¼ºå¤§çš„ç±»å‹æ¨æ–­èƒ½åŠ›ã€‚ç¼–è¯‘å™¨å¯ä»¥æ ¹æ®ä¸Šä¸‹æ–‡æ¨æ–­å‡ºå¤§å¤šæ•°å˜é‡çš„ç±»å‹ï¼Œå‡å°‘äº†ç¨‹åºå‘˜çš„è´Ÿæ‹…ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">v</span> = <span class="hljs-built_in">vec!</span>[];<br>v.<span class="hljs-title function_ invoke__">push</span>(<span class="hljs-number">5u8</span>);  <span class="hljs-comment">// ç»“åˆè¿™é‡Œï¼ŒRust ç¼–è¯‘å™¨å¯ä»¥æ¨æ–­å‡º v çš„ç±»å‹æ˜¯ Vec&lt;u8&gt;</span><br></code></pre></td></tr></table></figure></li><li><p><strong>å­ç±»å‹å’Œå¤šæ€</strong>ï¼šRust æ”¯æŒæ³›å‹å’Œtraitï¼Œè¿™æ˜¯ä¸€ç§å¤šæ€æ€§çš„å®ç°æ–¹å¼ã€‚traitç±»ä¼¼äºæ¥å£ï¼Œå…è®¸å®šä¹‰ç±»å‹å¯ä»¥å®ç°çš„ä¸€ç»„æ–¹æ³•ã€‚æ³›å‹å…è®¸å®šä¹‰å‡½æ•°ã€ç»“æ„ä½“å’Œæšä¸¾æ—¶ä½¿ç”¨å ä½ç±»å‹ï¼Œä»è€Œå®ç°ä»£ç çš„é‡ç”¨å’Œçµæ´»æ€§ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// è¿™é‡Œ std::fmt::Display å°±æ˜¯ä¸€ä¸ª traitï¼Œç›®å‰ï¼Œä½ å¯ä»¥å…ˆç®€å•ç†è§£ä¸º trait å°±æ˜¯æ¥å£</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">print_value</span>&lt;T: std::fmt::Display&gt;(value: T) &#123;  <br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, value);<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-title function_ invoke__">print_value</span>(<span class="hljs-number">42</span>);  <span class="hljs-comment">// 42 é»˜è®¤ä¸º i32ï¼Œæ ‡å‡†åº“ä¸ºå…¶æ˜¯å®ç°äº† Display trait</span><br>    <span class="hljs-title function_ invoke__">print_value</span>(<span class="hljs-string">&quot;Hello, world!&quot;</span>); <span class="hljs-comment">// &amp;str ä¹Ÿå®ç°äº† Display trait</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>ç±»å‹æ¨æ–­</strong>ï¼šRustçš„ç±»å‹æ¨æ–­ç³»ç»Ÿéå¸¸å¼ºå¤§ï¼Œèƒ½å¤Ÿæ ¹æ®ä»£ç ä¸Šä¸‹æ–‡è‡ªåŠ¨æ¨æ–­å˜é‡å’Œè¡¨è¾¾å¼çš„ç±»å‹ã€‚è¿™ä½¿å¾—ä»£ç æ›´ç®€æ´ï¼ŒåŒæ—¶ä¿æŒäº†ç±»å‹å®‰å…¨æ€§ã€‚</p></li><li><p><strong>ä»£æ•°æ•°æ®ç±»å‹å’Œç±»å‹æ„é€ </strong>ï¼šRustæ”¯æŒä»£æ•°æ•°æ®ç±»å‹ï¼Œé€šè¿‡æšä¸¾ï¼ˆenumï¼‰å’Œç»“æ„ä½“ï¼ˆstructï¼‰æ¥å®ç°ã€‚æšä¸¾å…è®¸å®šä¹‰ä¸€ä¸ªç±»å‹ï¼Œè¯¥ç±»å‹å¯ä»¥æ˜¯å‡ ç§ä¸åŒçš„å˜ä½“ä¹‹ä¸€ï¼Œæ¯ä¸ªå˜ä½“å¯ä»¥æºå¸¦ä¸åŒçš„æ•°æ®ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Option</span>&lt;T&gt; &#123;<br>    <span class="hljs-title function_ invoke__">Some</span>(T),<br>    <span class="hljs-literal">None</span>,<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>ç»“æ„ç±»å‹å’Œåä¹‰ç±»å‹</strong>ï¼šRustä½¿ç”¨åä¹‰ç±»å‹ç³»ç»Ÿã€‚æ¯ä¸ªç±»å‹éƒ½æœ‰ä¸€ä¸ªæ˜¾å¼çš„åç§°ï¼Œç±»å‹çš„å…¼å®¹æ€§åŸºäºåç§°è€Œä¸æ˜¯ç»“æ„ã€‚è¿™æ„å‘³ç€å³ä½¿ä¸¤ä¸ªç»“æ„ä½“æœ‰ç›¸åŒçš„å­—æ®µï¼Œå®ƒä»¬ä¹Ÿè¢«è§†ä¸ºä¸åŒçš„ç±»å‹ï¼Œé™¤éé€šè¿‡ç‰¹å¾æˆ–æ˜¾å¼è½¬æ¢æ¥å®ç°å…¼å®¹æ€§ã€‚</p></li></ol><p>é™¤æ­¤ä¹‹å¤–ï¼ŒRustçš„ç±»å‹ç³»ç»Ÿè¿˜æä¾›äº†å…¶ä»–éå¸¸å¼ºå¤§ä¸”æœ‰ç”¨çš„ç‰¹æ•ˆï¼Œå¦‚æ‰€æœ‰æƒå’Œå€Ÿç”¨ã€ç”Ÿå‘½å‘¨æœŸä»¥åŠæ¨¡å¼åŒ¹é…ã€‚</p><ul><li><p><strong>æ‰€æœ‰æƒå’Œå€Ÿç”¨ï¼ˆOwnership and Borrowingï¼‰</strong>ï¼š</p><ul><li>Rustçš„ç±»å‹ç³»ç»Ÿä¸å…¶æ‰€æœ‰æƒæ¨¡å‹ç´§å¯†ç»“åˆã€‚æ‰€æœ‰æƒæ¨¡å‹é€šè¿‡æ‰€æœ‰æƒã€å€Ÿç”¨å’Œç”Ÿå‘½å‘¨æœŸçš„æ¦‚å¿µæ¥ç®¡ç†å†…å­˜ï¼Œä»è€Œåœ¨æ— åƒåœ¾å›æ”¶å™¨çš„æƒ…å†µä¸‹ç¡®ä¿å†…å­˜å®‰å…¨ã€‚</li></ul><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">s</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;Hello&quot;</span>);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">len</span> = <span class="hljs-title function_ invoke__">calculate_length</span>(&amp;s); <span class="hljs-comment">// å€Ÿç”¨</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;The length of &#x27;&#123;&#125;&#x27; is &#123;&#125;.&quot;</span>, s, len);<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">calculate_length</span>(s: &amp;<span class="hljs-type">String</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> &#123;<br>    s.<span class="hljs-title function_ invoke__">len</span>()<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>ç”Ÿå‘½å‘¨æœŸï¼ˆLifetimesï¼‰</strong>ï¼š</p><ul><li>Rustä½¿ç”¨ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨æ¥è·Ÿè¸ªå¼•ç”¨çš„æœ‰æ•ˆèŒƒå›´ï¼Œç¡®ä¿å¼•ç”¨åœ¨ä½¿ç”¨æ—¶å§‹ç»ˆæœ‰æ•ˆã€‚è¿™æ˜¯Rust ç±»å‹ç³»ç»Ÿä¸­ä¸€ä¸ªç‹¬ç‰¹çš„ç‰¹æ€§ï¼Œå¸®åŠ©é˜²æ­¢æ‚¬ç©ºå¼•ç”¨å’Œæ•°æ®ç«äº‰ã€‚</li></ul><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">longest</span>&lt;<span class="hljs-symbol">&#x27;a</span>&gt;(x: &amp;<span class="hljs-symbol">&#x27;a</span> <span class="hljs-type">str</span>, y: &amp;<span class="hljs-symbol">&#x27;a</span> <span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-symbol">&#x27;a</span> <span class="hljs-type">str</span> &#123;<br>    <span class="hljs-keyword">if</span> x.<span class="hljs-title function_ invoke__">len</span>() &gt; y.<span class="hljs-title function_ invoke__">len</span>() &#123;<br>        x<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        y<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">string1</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;long string is long&quot;</span>);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">string2</span> = <span class="hljs-string">&quot;xyz&quot;</span>;<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">result</span> = <span class="hljs-title function_ invoke__">longest</span>(string1.<span class="hljs-title function_ invoke__">as_str</span>(), string2);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;The longest string is &#x27;&#123;&#125;&#x27;&quot;</span>, result);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>æ¨¡å¼åŒ¹é…</strong>ï¼š</p><ul><li>Rustæä¾›å¼ºå¤§çš„æ¨¡å¼åŒ¹é…åŠŸèƒ½ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†æšä¸¾å’Œå¤æ‚æ•°æ®ç»“æ„æ—¶ï¼Œä½¿å¾—ä»£ç æ›´å…·è¡¨è¾¾åŠ›å’Œå®‰å…¨æ€§ã€‚</li></ul><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Message</span> &#123;<br>    Quit,<br>    Move &#123; x: <span class="hljs-type">i32</span>, y: <span class="hljs-type">i32</span> &#125;,<br>    <span class="hljs-title function_ invoke__">Write</span>(<span class="hljs-type">String</span>),<br>    <span class="hljs-title function_ invoke__">ChangeColor</span>(<span class="hljs-type">i32</span>, <span class="hljs-type">i32</span>, <span class="hljs-type">i32</span>),<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">process_message</span>(msg: Message) &#123;<br>    <span class="hljs-keyword">match</span> msg &#123;<br>        Message::Quit =&gt; &#123;<br>            <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Quit the application&quot;</span>);<br>        &#125;<br>        Message::Move &#123; x, y &#125; =&gt; &#123;  <span class="hljs-comment">// æ¨¡å¼åŒ¹é…èƒ½æ ¹æ®æ•°æ®ç±»å‹ç›´æ¥æ‹†è§£å‡ºæ¥ï¼Œä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿</span><br>            <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Move to coordinates: (&#123;&#125;, &#123;&#125;)&quot;</span>, x, y);<br>        &#125;<br>        Message::<span class="hljs-title function_ invoke__">Write</span>(text) =&gt; &#123;<br>            <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Text message: &#123;&#125;&quot;</span>, text);<br>        &#125;<br>        Message::<span class="hljs-title function_ invoke__">ChangeColor</span>(r, g, b) =&gt; &#123;<br>            <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Change color to RGB(&#123;&#125;, &#123;&#125;, &#123;&#125;)&quot;</span>, r, g, b);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><p>Rustçš„ç±»å‹ç³»ç»Ÿé€šè¿‡ä¸Šè¿°ç‰¹æ€§å®ç°äº†é«˜æ•ˆã€å®‰å…¨å’Œçµæ´»çš„ç¼–ç¨‹æ¨¡å‹ï¼Œé€‚åˆç³»ç»Ÿç¼–ç¨‹å’Œé«˜æ€§èƒ½åº”ç”¨ã€‚å®ƒåœ¨ç¼–è¯‘æœŸæ•è·è®¸å¤šæ½œåœ¨é”™è¯¯ï¼Œä½¿å¾—è¿è¡Œæ—¶æ›´ä¸ºå®‰å…¨å¯é ã€‚</p><p>å½“ç„¶ï¼Œå¦‚æœä½ ä¹‹å‰æ²¡æœ‰å­¦ä¹ è¿‡Rustï¼Œé‚£è¿™äº›æ¦‚å¿µå’Œä»£ç å¯¹ä½ æ¥è¯´å¤§æ¦‚ç‡æ˜¯äº‘é‡Œé›¾é‡Œï¼Œä¸è¦ç€æ€¥ï¼Œæˆ‘ä»¬å…ˆå»ºç«‹èµ·ä¸€ä¸ªå¤§æ¦‚çš„å°è±¡å°±è¡Œäº†ã€‚è¿™é‡Œæˆ‘é’ˆå¯¹Rust ç±»å‹ç³»ç»Ÿæ¢³ç†äº†ä¸€å¼ å›¾ï¼Œä½ å¯ä»¥åœ¨ä»¥åçš„å­¦ä¹ ä¸­æ—¶å¸¸å›æ¥çœ‹çœ‹ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20241128185615522.png"alt="Rust ç±»å‹ç³»ç»Ÿ" /><figcaption aria-hidden="true">Rust ç±»å‹ç³»ç»Ÿ</figcaption></figure><blockquote><p>æ³¨ï¼šæœ¬å›¾å‚è€ƒäº†é™ˆå¤©è€å¸ˆåœ¨ Rustè®­ç»ƒè¥è¯¾ç¨‹ä¸Šæä¾›çš„æ•™æ¡ˆå¹¶è¿›è¡Œäº†å¢æ”¹ã€‚</p></blockquote><p>æœ¬ç¯‡å°±åˆ°è¿™é‡Œï¼Œä¸‹ç¯‡æˆ‘ä»¬å°†ä»‹ç» Rust çš„æ•°æ®ç±»å‹ï¼Œenjoy coding~</p>]]></content>
    
    
    <summary type="html">æœ¬æ–‡ä»ç¼–ç¨‹è¯­è¨€çš„è§’åº¦ä»‹ç»äº†ç±»å‹ç³»ç»Ÿçš„åŸºæœ¬æ¦‚å¿µï¼Œå¹¶è¯¦ç»†é˜è¿°äº† Rust ç±»å‹ç³»ç»Ÿçš„ç‰¹ç‚¹ï¼ŒåŒ…æ‹¬é™æ€ç±»å‹ã€å¼ºç±»å‹ã€æ‰€æœ‰æƒç³»ç»Ÿç­‰æ ¸å¿ƒç‰¹æ€§ã€‚</summary>
    
    
    
    <category term="Rust" scheme="https://hedon.top/categories/Rust/"/>
    
    <category term="Rust å…¥é—¨" scheme="https://hedon.top/categories/Rust/Rust-%E5%85%A5%E9%97%A8/"/>
    
    
    <category term="Rust" scheme="https://hedon.top/tags/Rust/"/>
    
  </entry>
  
  <entry>
    <title>Rust å…¥é—¨ä¸¨02 æ•°æ®ç±»å‹</title>
    <link href="https://hedon.top/2024/11/28/rust-02-data-type/"/>
    <id>https://hedon.top/2024/11/28/rust-02-data-type/</id>
    <published>2024-11-28T09:41:08.000Z</published>
    <updated>2025-02-15T15:27:55.982Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸Šæ–‡ä¸­ï¼Œæˆ‘ä»¬ç®€å•æ¢è®¨äº† <ahref="https://hedon.top/2024/11/28/rust-01-type-system/">Rustçš„ç±»å‹ç³»ç»Ÿ</a>ï¼Œè¿™ä¸€ç¯‡æˆ‘ä»¬ç»§ç»­æ¥äº†è§£ Rust çš„æ•°æ®ç±»å‹ã€‚æˆ‘ç”»äº†ä¸€å¼  RuståŸºç¡€çŸ¥è¯†å›¾è°±ï¼Œå¸Œæœ›å¯ä»¥å¸®åŠ©ä½ æ›´å¥½åœ°å®šä½å½“å‰æ‰€åœ¨çš„ä½ç½®ã€‚</p><pre><code class=" mermaid">mindmap  root((Rust æ•°æ®ç±»å‹))    æ•°å€¼ç±»å‹      æ•´æ•°        æœ‰ç¬¦å·          i8/i16/i32/i64/i128/isize        æ— ç¬¦å·          u8/u16/u32/u64/u128/usize      æµ®ç‚¹æ•°        f32        f64      å¸ƒå°”å‹        bool      å­—ç¬¦å‹        char    å¤åˆç±»å‹      å…ƒç»„ Tuple      æ•°ç»„ Array      åˆ‡ç‰‡ Slice      å­—ç¬¦ä¸²        String        str      ç»“æ„ä½“ Struct      æšä¸¾ Enum    ç‰¹æ®Šç±»å‹      å•å…ƒç±»å‹ unit      Neverç±»å‹ !      æŒ‡é’ˆç±»å‹        å¼•ç”¨ &amp;T        åŸå§‹æŒ‡é’ˆ *const/*mut        æ™ºèƒ½æŒ‡é’ˆ</code></pre>]]></content>
    
    
    <summary type="html">æœ¬æ–‡ä»‹ç»äº† Rust ä¸­çš„æ•°æ®ç±»å‹ã€‚</summary>
    
    
    
    <category term="Rust" scheme="https://hedon.top/categories/Rust/"/>
    
    
    <category term="Rust" scheme="https://hedon.top/tags/Rust/"/>
    
  </entry>
  
  <entry>
    <title>Rust è®­ç»ƒè¥æ€»ç»“ä¸¨ç¬¬ä¸‰æ¬¡å…¥é—¨ Rust</title>
    <link href="https://hedon.top/2024/11/26/rust-bootcamp/"/>
    <id>https://hedon.top/2024/11/26/rust-bootcamp/</id>
    <published>2024-11-26T11:10:08.000Z</published>
    <updated>2024-11-27T14:13:04.461Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç¼˜èµ·">ç¼˜èµ·</h1><p>2023å¹´æˆ‘ç»™è‡ªå·±å®šäº†å¾ˆå¤šä¸ªç›®æ ‡ï¼Œæœ€ç»ˆçš„ç»“æœæ˜¯æ¯ä¸ªéƒ½åšäº†ä¸€äº›äº‹æƒ…ï¼Œä½†æ˜¯æ²¡æœ‰ä¸€ä¸ªæ˜¯åšå¾—æ¯”è¾ƒå½»åº•çš„ï¼Œå°è¯äº†ã€Šå­™å­å…µæ³•ã€‹çš„é‚£å¥ï¼šâ€œæ— æ‰€ä¸å¤‡ï¼Œåˆ™æ— æ‰€ä¸å¯¡â€ã€‚</p><p>åœ¨ 2023.10.23 å‡ºäºå¥½å¥‡ï¼Œæˆ‘è®¢é˜…äº†ã€ŠRustè¯­è¨€ä»å…¥é—¨åˆ°å®æˆ˜ã€‹çš„ä¸“æ ï¼Œè·Ÿç€è¯¾ç¨‹çš„æ›´æ–°èŠ‚å¥å­¦ä¹ å®Œäº†æ•´ä¸ªä¸“æ ã€‚</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/Rust%E8%AF%AD%E8%A8%80%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98%E7%BB%93%E8%AF%BE%E8%AF%81%E4%B9%A6.png" alt="Rustè¯­è¨€ä»å…¥é—¨åˆ°å®æˆ˜ç»“è¯¾è¯ä¹¦" style="zoom:33%;" /></p><p>è™½ç„¶æˆ‘ç¬¬ä¸€æ¬¡å…¥é—¨ Rust å¤±è´¥äº†ï¼Œä½†ä¹Ÿè¢« Rustçš„ç§ç§ç‰¹æ€§æ‰€å¸å¼•ã€‚æˆ‘æ˜¯ä¸ªç‰¹åˆ«å–œæ¬¢â€œç—›è‹¦å‰ç½®â€çš„äººï¼Œè€Œ Rustç¼–è¯‘å™¨"çšçœ¦å¿…æŠ¥"çš„ç¼–è¯‘å™¨æ£€æŸ¥æ­£ç»™äºˆäº†æˆ‘è¢«è™çš„çˆ½æ„Ÿï¼Œç¼–è¯‘é€šè¿‡åç¨‹åºçš„ç¨³å®šè¿è¡Œä¹Ÿç¬¦åˆæˆ‘è¿½æ±‚æˆä¸ºä¸€ä½â€œé è°±â€å·¥ç¨‹å¸ˆçš„æ„¿æ™¯ã€‚</p><p>åŠ ä¹‹æˆ‘çš„ä¸»åŠ›è¯­è¨€æ˜¯Goï¼Œä¸€é—¨åº”ç”¨ç¼–ç¨‹è¯­è¨€ï¼Œæ‰€ä»¥æˆ‘ä¸€ç›´å¸Œæœ›å­¦ä¹ ä¸€é—¨ç³»ç»Ÿç¼–ç¨‹è¯­è¨€ï¼Œä»¥æœŸå°†æ¥æœ‰èƒ½åŠ›çª¥æ¢ä¸€äº›åº•å±‚çš„ç»†èŠ‚åŸç†ã€‚C/C++å¤ªå¤è€äº†ï¼Œç‰¹æ€§å¤ªå¤šäº†ï¼Œå¤§ç¥å¤ªå¤šäº†ï¼Œæˆ‘æ€ä¹ˆå­¦éƒ½ä¸å¯èƒ½èµ¶å¾—ä¸Šåˆ«äººï¼Œå˜¿å˜¿ï¼Œå­¦ä¸ªæ–°çš„ï¼Œå¤§å®¶éƒ½æ²¡å­¦è¿‡ï¼Œè¿™ä¸å°±èˆ’æœäº†ä¹ˆã€‚</p><p>åæ¥æå®¢æ—¶é—´å†³å®šå¼€è®¾ã€ŠRust è®­ç»ƒè¥ã€‹ï¼Œè®²å¸ˆæ˜¯<ahref="https://www.zhihu.com/people/tchen">é™ˆå¤©</a>è€å¸ˆï¼Œæˆ‘å»æœäº†å…³äºé™ˆå¤©è€å¸ˆçš„ä¸€äº›èµ„æ–™ï¼Œçœ‹äº†ä¸€äº›ä»–å†™çš„æ–‡ç« å’ŒæŠ€æœ¯åˆ†äº«è§†é¢‘ï¼Œç”šè‡³æ²¹ç®¡ä¸Šè¿˜æœ‰ä»–ä¹‹å‰é¢è¯•çš„è§†é¢‘ã€‚OKï¼Œè¿™ä¸ªäººå¾—åˆ°äº†æˆ‘çš„è®¤å¯ï¼Œæˆ‘æƒ³è·Ÿè¿™æ ·çš„äººäº¤ä¸ªæœ‹å‹ï¼Œå“ªæ€•åªæ˜¯åŠ ä¸ªå¾®ä¿¡ï¼Œè‡³å°‘æˆ‘å¤šäº†ä¸ªå£å­ï¼Œå¾—ä»¥çª¥æ¢ç²¾è‹±é˜¶å±‚äººå£«çš„ç”Ÿæ´»ä¸€è§’ã€‚</p><p>ç»“åˆ 2023 å¹´çš„æ•™è®­ï¼Œ2024å¹´å¹´åˆæˆ‘å°±ç»™è‡ªå·±åˆ¶å®šäº†ä¸€å¹´çš„ç›®æ ‡ï¼Œåªæœ‰ä¸€ä¸ªï¼Œå°±æ˜¯<strong>è¸è¸å®å®ã€å®Œå®Œæ•´æ•´å­¦ä¹ å®Œæ•´ä¸ªRust è®­ç»ƒè¥ï¼Œå…¶ä»–æ‰€æœ‰äº‹æƒ…å’Œç›®æ ‡ï¼Œéƒ½è¦ä¸ºå…¶è®©æ­¥</strong>ã€‚</p><blockquote><p>å…¶å®æ˜¯ 2 ä¸ªç›®æ ‡ hhhï¼Œå¦å¤–ä¸€ä¸ªç›®æ ‡æ˜¯ï¼šå®Œæˆäººç”Ÿçš„ç¬¬ä¸€åœºåŠç¨‹é©¬æ‹‰æ¾ã€‚</p></blockquote><h1 id="ç­‘åŸº">ç­‘åŸº</h1><p>ä¸ºäº†æ›´å¥½æœåŠ¡äºã€ŠRust è®­ç»ƒè¥ã€‹ï¼Œåœ¨ 1-4 æœˆä»½ï¼Œæˆ‘èŠ±äº†å·®ä¸å¤š 3ä¸ªå¤šæœˆçš„æ—¶é—´å•ƒä¸‹äº†<ahref="https://book.douban.com/subject/36547630/">ã€ŠRustç¨‹åºè®¾è®¡ï¼ˆç¬¬äºŒç‰ˆï¼‰ã€‹</a>ï¼Œå¯¹æ•´ä¸ª Rustçš„è¯­è¨€ç‰¹æ€§å»ºç«‹äº†æ›´åŠ å®Œå–„çš„ä½“ç³»åŸºç¡€ï¼Œä¹Ÿå¤šå¥ å®šäº†ä¸€äº›åŸºç¡€ï¼Œå½“ç„¶ï¼Œè¿™æ˜¯æˆ‘ç¬¬äºŒæ¬¡å…¥é—¨Rust å¤±è´¥ã€‚</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20241127172804063.png" alt="Rust ç¨‹åºè®¾è®¡ï¼ˆç¬¬äºŒç‰ˆï¼‰é˜…è¯»è®¡åˆ’" style="zoom: 25%;" /></p><h1 id="ä¿®ç‚¼">ä¿®ç‚¼</h1><p>4 æœˆ 18 å·å¼€è¥ï¼Œæœ¬æ¥æ˜¯é¢„è®¡ 7æœˆä»½ç»“è¥çš„ï¼Œä¸è¿‡é™ˆå¤©è€å¸ˆåˆ†äº«çš„æ¬²æœ›åˆ¹ä¸ä½è½¦ï¼Œç¡¬æ˜¯â€œæ‹–å ‚â€åˆ°äº† 11 æœˆ 22å·ã€‚äº‹å®ä¸Šï¼Œè¿™æ˜¯æœ‰ç‚¹éš¾å—çš„ï¼Œä¸€ä¸ªäº‹æƒ…æ‹–å¤ªä¹…ï¼Œæ€ç»´ä¸Šå¾ˆå®¹æ˜“ç–²æƒ«ï¼Œæ‡’æƒ°ä¹Ÿæ„ˆéš¾å…‹æœã€‚ä¸è¿‡ä»æ¶ˆè´¹è€…çš„è§’åº¦ï¼Œè¿™æ˜¯èµšç¿»äº†ï¼Œæ¯•ç«Ÿï¼Œå­¦ç€å­¦ç€ï¼ŒèŠ±å‘—çš„12 æœŸæ— æ¯åˆ†æœŸä¹Ÿå·®ä¸å¤šè¦è¿˜å®Œäº†ã€‚</p><p>æ‰€ä»¥ï¼Œå…¶å®ä¸€ä¸ª 1095 çš„ç¨‹åºå‘˜ï¼Œåœ¨ 4.20 åˆ° 11.22 æ˜¯å¯ä»¥èŠ± 279 å°æ—¶ 54åˆ†é’Ÿå­¦å®Œ 202 è®²è¯¾ç¨‹çš„ã€‚</p><blockquote><p>å³ä½¿ä½ å°†æ¥ä¸ä½¿ç”¨Rustï¼Œç›¸ä¿¡ä½ å­¦å®Œè¿™é—¨è¯¾ç¨‹åä¹Ÿèƒ½æˆä¸ºä¸€ä½æ›´å¥½çš„è½¯ä»¶å·¥ç¨‹å¸ˆã€‚ â€”â€” é™ˆå¤©</p></blockquote><p>æ˜¯çš„ï¼Œåœ¨å­¦ä¹ ä¸­ï¼Œæ›´å¤šæ—¶å€™æ„Ÿå—åˆ°çš„ä¸ä»…ä»…æ˜¯åœ¨å­¦ä¹ Rustï¼Œè€Œæ˜¯åœ¨é‡å­¦è½¯ä»¶å·¥ç¨‹ï¼Œæˆ‘å¼€å§‹åˆ‡èº«æ¥è§¦ä¼˜ç§€çš„è½¯ä»¶å¼€å‘å…·å¤‡äº†å“ªäº›ä¸å¯æˆ–ç¼ºçš„æµç¨‹ã€‚ä¸ºäº†æ•ˆä»¿è¿™äº›ä¼˜ç§€çš„æ€æƒ³å’Œå®è·µï¼Œåœ¨å®é™…å·¥ä½œä¸­ï¼Œä»Šå¹´æˆ‘åšäº†ä¸€äº›å°è¯•ï¼š</p><ol type="1"><li>å¼•å…¥æ›´ä¸°å¯Œçš„ CI/CDæµç¨‹ï¼Œå°½å¯èƒ½å‘æŒ¥æœºå™¨çš„èƒ½åŠ›ï¼Œè®©æœºå™¨ä¸åŒå…¶çƒ¦åœ°åšé‚£äº›çš„é‡å¤åŠ³åŠ¨ï¼Œè€Œè¿™äº›ä¸èµ·çœ¼çš„é‡å¤åŠ³åŠ¨ï¼Œå´èƒ½ä»¥æœ€å°ä»£ç ä¸ºæˆ‘ä»¬æ’æŸ¥å‡ºæœ€å¤šéš¾ä»¥å‘ç°çš„â€œå¤±è¯¯â€BUGã€‚</li><li>å¼€å§‹å­¦ä¹ å†™å•æµ‹ï¼Œå¼€å§‹å­¦ä¹ å¦‚ä½•å°†ä»£ç å†™å¾—èƒ½å•æµ‹ã€æ˜“å•æµ‹ï¼Œå­¦ä¹ ç€å¦‚ä½•å°†é‚£äº›ä¸èƒ½å•æµ‹çš„ğŸ’©ä»£ç æ”¹é€ æˆå¯å•æµ‹çš„ä»£ç ï¼Œä¹Ÿå°†å•æµ‹è¿è¡ŒåŠ å…¥äº†CI/CDçš„æµç¨‹ä¸­ã€‚åœ¨å•æµ‹å¤šæ¬¡å¸®æˆ‘æªå‡ºé‚£äº›æˆ‘æ„è¯†ä¸åˆ°çš„ä¸å°å¿ƒæ”¹é”™çš„é€»è¾‘çš„æ—¶å€™ï¼Œæˆ‘æ‰åˆ‡èº«æ„Ÿå—åˆ°å•æµ‹çš„ä½œç”¨ï¼Œä¹ŸçœŸæ­£ç†è§£äº†â€œå†™å•æµ‹å¹¶ä¸ä¼šå½±å“å¼€å‘æ•ˆç‡ï¼Œå¦‚æœå½±å“äº†ï¼Œé‚£ä¹Ÿæ˜¯æé«˜äº†å¼€å‘æ•ˆç‡â€ã€‚å¹¸è¿çš„æ˜¯ï¼Œæˆªè‡³ç›®å‰ï¼ˆ11.27ï¼‰ï¼Œæˆ‘å·²ç»è¿ç»­2 æ¬¡ï¼Œåœ¨ä¸Šåƒè¡Œä»£ç çš„éœ€æ±‚å¼€å‘ä¸­ï¼Œææµ‹é˜¶æ®µå’Œçº¿ä¸Šå‘å¸ƒé˜¶æ®µï¼Œéƒ½æ˜¯ 0Bugï¼Œè¿æ°”ä¸é”™ã€‚</li><li>å¼•å…¥ç›‘æ§ç³»ç»Ÿï¼Œåœ¨æŒ‡æ ‡ä¸Šï¼Œå­˜å‚¨å±‚ã€åº”ç”¨å±‚ã€ä¸šåŠ¡å±‚å’Œç½‘å…³å±‚è¿›è¡Œåˆ†å±‚ç›‘æ§ï¼Œåœ¨å¼€å‘æ—¶ï¼Œä»ä¸šåŠ¡æ— å…³ç»„ä»¶ï¼ˆ<ahref="https://github.com/hedon954/goapm">goapm</a>ï¼‰ï¼Œåˆ°ä¸šåŠ¡ç›¸å…³é€šç”¨ç»„ä»¶ï¼Œæœ€åå†åˆ°åº”ç”¨ç¨‹åºç‰¹å®šç»„ä»¶çš„åˆ†é˜¶æ®µåˆ†å±‚æ¬¡å¼€å‘ï¼Œå¼€å§‹å­¦ä¹ ç€â€œå…ˆè§£å†³ä¸šåŠ¡èƒŒåçš„é¢†åŸŸé—®é¢˜ï¼Œé¡ºå¸¦è§£å†³ä¸šåŠ¡é—®é¢˜â€ã€‚</li><li>å¼€å§‹æ€è€ƒä¸€äº›æ¶æ„å±‚é¢çš„ä¸œè¥¿ï¼Œå¼€å§‹æ€è€ƒä¸€äº›ä»£ç ç»„ç»‡ã€æ¥å£å¥‘çº¦ã€é¢†åŸŸæ¨¡å—åˆ’åˆ†çš„é—®é¢˜ï¼Œä»¥æœŸå†™å‡ºè´¨é‡æ›´å¥½çš„ä»£ç ã€‚</li></ol><p>ä¸ºäº†æ”¯æ’‘ä¸Šé¢è¿™äº›äº‹æƒ…ï¼Œä»Šå¹´æˆ‘åˆé¡ºå¸¦è¯»äº†ä¸€äº›ä¹¦ï¼Œæˆ‘æ˜¯ä¸ªå¾ˆå°‘è¯»ä¹¦çš„äººï¼Œå› ä¸ºæˆ‘æ€»è§‰å¾—ï¼šâ€œè¯»ä¹¦å¥½æ…¢â€ã€‚è€Œä¸”æˆ‘è¯»ä¹¦ä¹Ÿç¡®å®å¾ˆæ…¢ï¼Œä¸»è¦æ˜¯ï¼Œå¾ˆå›°ğŸ˜…ã€‚ç„¶è€Œï¼Œå½“æˆ‘å›æœ›æ¥æ—¶è·¯ï¼Œä¸€åˆ‡å´éƒ½åœ¨æˆ‘çš„æ„æ–™ä¹‹å¤–ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20241127180300408.png"alt="hedon 2024 çš„ä¹¦å•" /><figcaption aria-hidden="true">hedon 2024 çš„ä¹¦å•</figcaption></figure><p>è¿™ä¸ªæ—¶å€™æˆ‘æ‰çŸ¥é“ï¼š</p><ul><li>æ…¢å°±æ˜¯å¿«</li><li>å°‘å°±æ˜¯å¤š</li></ul><h1 id="å†åŠ«">å†åŠ«</h1><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20241127161520649.png"alt="rust-road" /><figcaption aria-hidden="true">rust-road</figcaption></figure><p>è¿™äº›ä¹¦å…¶å®éƒ½ä¸åœ¨æˆ‘çš„è®¡åˆ’ä¹‹å†…ï¼Œå› ä¸º 2024 æˆ‘åªæœ‰ä¸€ä¸ªç›®æ ‡ï¼š<strong>å®ŒæˆRustè®­ç»ƒè¥çš„å­¦ä¹ </strong>ã€‚å®ƒä»¬åªä¸è¿‡æ˜¯æˆ‘å®Œæˆæ—¢å®šè®¡åˆ’ä¹‹ä½™çš„åŠ é¤ç½¢äº†ã€‚</p><p>è€Œå¹¸å¥½æˆ‘åªæœ‰ä¸€ä¸ªç›®æ ‡ï¼Œæ‰€ä»¥æ‰èƒ½æœ‰æ›´å¤šæ—¶é—´å’Œç²¾åŠ›å»åº”å¯¹è·Ÿéšè®­ç»ƒè¥å­¦ä¹ ä¸­çš„ä¸€äº›å›°éš¾ï¼š</p><ul><li>æ™šä¸Š 9 ç‚¹ä¸‹ç­ï¼ŒçœŸç´¯å•Šï¼Œä¼‘æ¯ä¸‹å§ï¼ŒçœŸä¸æƒ³å­¦äº†ã€‚</li><li>å·¥ä½œäº†ä¸€å‘¨ï¼ŒçœŸç´¯å•Šï¼Œå‘¨æœ«è¦ä¸å°±ä¼‘æ¯å§ï¼ŒçœŸä¸æƒ³å­¦äº†ã€‚</li><li>ç¼–è¯‘å™¨æŠ¥é”™å¥½å¤šå•Šï¼Œç®—äº†ï¼Œè¦ä¸ç›´æ¥ copy ç°æˆçš„ä»£ç å§ã€‚</li><li>è¿™çŸ¥è¯†ç‚¹åœ¨è®²å•¥å•Šï¼Œç®—äº†ï¼Œå…ˆä¸æ‡‚è£…æ‡‚å§ï¼Œåé¢è¿˜é‚£ä¹ˆå¤šè¯¾ï¼Œå…ˆèµ¶è¿›åº¦å†è¯´ã€‚</li><li>å‰ç«¯å’Œå®¢æˆ·ç«¯çš„çŸ¥è¯†ï¼Œå¥½åƒè·Ÿæˆ‘æ²¡å•¥å…³ç³»ï¼Œç®—äº†ï¼Œä¸å¬äº†ï¼Œè¿‡è¿‡è¿‡ã€‚</li><li>å•æµ‹æˆ‘å°±ä¸å†™äº†ï¼Œæµªè´¹æ—¶é—´ã€‚</li><li>å­¦å®Œå’¯ï¼Œæ„Ÿè§‰æ²¡å•¥å¥½æ€»ç»“çš„ï¼Œç®—äº†ï¼Œä¸‹ä¸€ä¸ªå§ã€‚</li><li>....</li></ul><p>è¿æ°”ä¸é”™ï¼Œä¸Šè¿°çš„ n å¤šç§æƒ…å†µï¼Œè‡³å°‘åœ¨ 50-70% çš„æ—¶å€™ï¼Œæˆ‘èƒ½åšåˆ°ï¼š</p><ul><li>å­¦ä¸€ä¸‹å†è¯´ï¼Œç´¯äº†å†åœã€‚</li><li>ä¸‹åˆå‡ºå»ç©ï¼Œæ—©ä¸Šå…ˆå­¦äº†å†è¯´ã€‚</li><li>ç®—äº†ï¼Œç‹ ç‚¹ï¼Œç›²å†™ï¼Œè‡ªå·±å°è¯•è§£å†³ä¸€ä¸‹ï¼Œå’¦ï¼Œä¹Ÿå°±é‚£ä¹ˆå›äº‹ã€‚å†™å®Œåå†å¯¹æ¯”ä¸‹ï¼Œå“¦ï¼Œå…¶å®è¿™å—æ²¡å¬æ‡‚ã€‚</li><li>å¼„æ‡‚å†è¯´ï¼Œå¤šå¬å‡ éè¯¾ï¼Œé‡æ–°çœ‹å‡ éä¹¦ï¼Œå†æœä¸€äº›ç›¸å…³åšå®¢ï¼Œå“¦ï¼Œè¿™ä¸ªçŸ¥è¯†ç‚¹æ˜¯è¿™ä¸ªæ„æ€ï¼Œè¯»ä¹¦ç™¾éå…¶ä¹‰è‡ªè§åŸæ¥æ˜¯è¿™å‘³ï¼Ÿ</li><li>ç®—äº†ï¼Œè¯•è¯•ç°åœ¨ LLM æ˜¯å¦å¦‚å¹çš„é‚£ä¹ˆç‰›ï¼Œå—¯ï¼Œå¥½åƒç”¨ LLMæ¥å®ç°å‰ç«¯å’Œå®¢æˆ·ç«¯çš„åŸºç¡€åŠŸèƒ½è¿˜çœŸå¯ä»¥ï¼Œä¹Ÿæ²¡é‚£ä¹ˆæ— èŠå˜›ã€‚</li><li>ç®—äº†ï¼Œå…ˆè¯•ç€å†™ä¸‹å•æµ‹å§ã€‚å“¦ï¼Œæˆ‘çš„ä»£ç è¿™ä¹ˆéš¾æµ‹å•Šï¼Œå“¦ï¼Œè¿™è¡Œä»£ç æ€ä¹ˆå°±çŠ¯è ¢äº†å‘¢ï¼Œå“¦ï¼ŒèŠ±ä¸äº†å¤šå°‘æ—¶é—´å˜›ã€‚</li><li>è¦ä¸è¿˜æ˜¯æ€»ç»“ä¸‹å§ï¼Œå“¦ï¼ŒåŸæ¥è¿™ä¸ªåœ°æ–¹æ˜¯è¿™ä¸ªæ„æ€ï¼Œå“¦ï¼ŒåŸæ¥è¿˜è®²åˆ°äº†è¿™ä¸ªç‚¹ã€‚</li></ul><p>æ‰€ä»¥è¿™ä¸ªæ—¶å€™æˆ‘åˆçŸ¥é“äº†ï¼š</p><ul><li>æ…¢å°±æ˜¯å¿«</li><li>å°‘å°±æ˜¯å¤š</li></ul><h1 id="å°æˆ">å°æˆ</h1><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs tap">âœ  hedon-rust-road ll<br>total 0<br>drwxr-xr-x <span class="hljs-number"> 21 </span>wangjiahan  staff   672B Nov<span class="hljs-number"> 27 </span>18:26 aicomm<br>drwxr-xr-x <span class="hljs-number"> 23 </span>wangjiahan  staff   736B Sep<span class="hljs-number"> 11 </span>13:55 chat<br>drwxr-xr-x <span class="hljs-number"> 17 </span>wangjiahan  staff   544B Sep<span class="hljs-number"> 11 </span>18:31 chatapp<br>drwxr-xr-x <span class="hljs-number"> 26 </span>wangjiahan  staff   832B Nov<span class="hljs-number"> 27 </span>18:26 crm<br>drwxr-xr-x <span class="hljs-number"> 22 </span>wangjiahan  staff   704B Nov<span class="hljs-number"> 27 </span>18:26 dino<br>drwxr-xr-x <span class="hljs-number"> 16 </span>wangjiahan  staff   512B Nov<span class="hljs-number"> 27 </span>18:29 error-info<br>drwxr-xr-x <span class="hljs-number"> 18 </span>wangjiahan  staff   576B Sep <span class="hljs-number"> 4 </span>19:00 hackernews<br>drwxr-xr-x <span class="hljs-number"> 22 </span>wangjiahan  staff   704B Sep<span class="hljs-number"> 12 </span>15:54 hedon-bot<br>drwxr-xr-x  <span class="hljs-number"> 9 </span>wangjiahan  staff   288B Nov<span class="hljs-number"> 27 </span>18:29 httpie<br>drwxr-xr-x <span class="hljs-number"> 13 </span>wangjiahan  staff   416B Aug<span class="hljs-number"> 22 </span>10:40 inverted-index-concurrency<br>drwxr-xr-x  <span class="hljs-number"> 7 </span>wangjiahan  staff   224B Nov<span class="hljs-number"> 27 </span>18:28 json-macro<br>drwxr-xr-x <span class="hljs-number"> 26 </span>wangjiahan  staff   832B Sep <span class="hljs-number"> 3 </span>19:30 learn-ffi<br>drwxr-xr-x  <span class="hljs-number"> 8 </span>wangjiahan  staff   256B Nov<span class="hljs-number"> 27 </span>18:29 learn-proc-macro<br>drwxr-xr-x  <span class="hljs-number"> 7 </span>wangjiahan  staff   224B Nov<span class="hljs-number"> 27 </span>18:30 mandelbrot<br>drwxr-xr-x <span class="hljs-number"> 10 </span>wangjiahan  staff   320B Aug<span class="hljs-number"> 22 </span>10:40 matrix-multi<br>drwxr-xr-x  <span class="hljs-number"> 7 </span>wangjiahan  staff   224B Nov<span class="hljs-number"> 27 </span>18:29 pest-parser-collection<br>drwxr-xr-x <span class="hljs-number"> 19 </span>wangjiahan  staff   608B Nov<span class="hljs-number"> 27 </span>18:27 r-redis<br>drwxr-xr-x <span class="hljs-number"> 21 </span>wangjiahan  staff   672B Aug<span class="hljs-number"> 22 </span>10:40 rcli<br>drwxr-xr-x <span class="hljs-number"> 17 </span>wangjiahan  staff   544B Aug<span class="hljs-number"> 22 </span>10:40 simple-chat<br>drwxr-xr-x <span class="hljs-number"> 17 </span>wangjiahan  staff   544B Aug<span class="hljs-number"> 22 </span>10:40 simple-shortener<br>drwxr-xr-x <span class="hljs-number"> 21 </span>wangjiahan  staff   672B Aug<span class="hljs-number"> 22 </span>10:40 taotie<br>drwxr-xr-x@<span class="hljs-number"> 18 </span>wangjiahan  staff   576B Nov<span class="hljs-number"> 27 </span>15:38 thumbor<br>drwxr-xr-x <span class="hljs-number"> 19 </span>wangjiahan  staff   608B Aug<span class="hljs-number"> 29 </span>10:56 winnow-parser-collection<br>âœ  hedon-rust-road tokei -t rust<br>===============================================================================<br> Language            Files        Lines         Code     Comments       Blanks<br>===============================================================================<br> Rust                 <span class="hljs-number"> 336 </span>      <span class="hljs-number"> 25451 </span>      <span class="hljs-number"> 21615 </span>        <span class="hljs-number"> 644 </span>        3192<br> |- Markdown           <span class="hljs-number"> 53 </span>        <span class="hljs-number"> 546 </span>          <span class="hljs-number"> 0 </span>        <span class="hljs-number"> 476 </span>          70<br> (Total)                         <span class="hljs-number"> 25997 </span>      <span class="hljs-number"> 21615 </span>       <span class="hljs-number"> 1120 </span>        3262<br>===============================================================================<br> Total                <span class="hljs-number"> 336 </span>      <span class="hljs-number"> 25451 </span>      <span class="hljs-number"> 21615 </span>        <span class="hljs-number"> 644 </span>        3192<br>===============================================================================<br></code></pre></td></tr></table></figure><p>çœ‹è€å¸ˆç”»äº†é‚£ä¹ˆå¤šç‰›é€¼çš„å›¾ï¼Œè¦ä¸â€œé‚¯éƒ¸å­¦æ­¥â€æ¨¡ä»¿ä¸€ä¸‹å§ã€‚æ•…è€Œåˆå¿ç€â€œä¸‹ä¸€ä¸ªå§â€çš„å¿µå¤´ï¼Œæ¢³ç†äº†ä¸‹è¿™å‡ ä¸ªæœˆåˆ°åº•åšäº†äº›ä»€ä¹ˆã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/8abb5b2a2f3020ca36f75087ae76a53c.PNG"alt="rcli" /><figcaption aria-hidden="true">rcli</figcaption></figure><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/4ac783c6adaa38a45853861753112e35.PNG"alt="r-redis" /><figcaption aria-hidden="true">r-redis</figcaption></figure><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/4bdd0cba75aa773c6f4e941cf5c5fe29.PNG"alt="macro-json" /><figcaption aria-hidden="true">macro-json</figcaption></figure><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/969e023d9003b3c28ea1c95a7c1d9388.PNG"alt="macro-error-info" /><figcaption aria-hidden="true">macro-error-info</figcaption></figure><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/f25b8a0f1c95ac306ecda6c4ff3954a3.PNG"alt="rust-ecosystem" /><figcaption aria-hidden="true">rust-ecosystem</figcaption></figure><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/d04da8bf3577f1d09b7fce647451a700.PNG"alt="crm" /><figcaption aria-hidden="true">crm</figcaption></figure><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/c85939619088cda8c9a763ba514d235e.PNG"alt="taotie" /><figcaption aria-hidden="true">taotie</figcaption></figure><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/2d3892c57b0742707c6ff3a1267f532a.PNG"alt="dino" /><figcaption aria-hidden="true">dino</figcaption></figure><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/874082e0f9f9410f342d875f8559bd15.PNG"alt="aicomm" /><figcaption aria-hidden="true">aicomm</figcaption></figure><h1 id="å½’å…ƒ">å½’å…ƒ</h1><ul><li>çŸ¥æ˜¯è¡Œä¹‹å§‹ï¼Œè¡Œæ˜¯çŸ¥ä¹‹æˆã€‚</li><li>é‡äº‹ä¸å†³ï¼Œå¯é—®æ˜¥é£ã€‚æ˜¥é£ä¸è¯­ï¼Œæ—¢éšæœ¬å¿ƒã€‚</li></ul><p>2025 è§ï¼</p>]]></content>
    
    
    <summary type="html">æœ¬æ–‡è®°å½•äº†æˆ‘åœ¨ Rust è®­ç»ƒè¥çš„å­¦ä¹ å†ç¨‹ï¼Œä¹Ÿæ˜ å°„äº†æˆ‘ 2024 å¹´å…¨å¹´çš„æˆé•¿è½¨è¿¹ã€‚</summary>
    
    
    
    <category term="Rust" scheme="https://hedon.top/categories/Rust/"/>
    
    <category term="æ€»ç»“" scheme="https://hedon.top/categories/Rust/%E6%80%BB%E7%BB%93/"/>
    
    <category term="2024" scheme="https://hedon.top/categories/Rust/%E6%80%BB%E7%BB%93/2024/"/>
    
    
    <category term="Rust" scheme="https://hedon.top/tags/Rust/"/>
    
  </entry>
  
  <entry>
    <title>Rust åŸç†ä¸¨èŠä¸€èŠ Rust çš„ Atomic å’Œå†…å­˜é¡ºåº</title>
    <link href="https://hedon.top/2024/11/11/rust-memory-order/"/>
    <id>https://hedon.top/2024/11/11/rust-memory-order/</id>
    <published>2024-11-11T05:06:49.000Z</published>
    <updated>2024-12-01T02:42:28.952Z</updated>
    
    <content type="html"><![CDATA[<h1 id="atomic">Atomic</h1><p>åœ¨ Rust çš„ <code>std::sync::atomic</code>æ¨¡å—ä¸­åŒ…å«äº†æ— é”å¹¶å‘ç¼–ç¨‹çš„åŸå­åŒ–ç±»å‹ï¼Œä¸é€šå¸¸çš„ç®—æœ¯è¿ç®—ç¬¦å’Œé€»è¾‘è¿ç®—ç¬¦ä¸åŒï¼ŒåŸå­åŒ–ç±»å‹ä¼šæš´éœ²æ‰§è¡ŒåŸå­åŒ–æ“ä½œçš„æ–¹æ³•ï¼Œå•ç‹¬çš„åŠ è½½ã€å­˜å‚¨ã€äº¤æ¢å’Œç®—æœ¯è¿ç®—éƒ½ä¼šä½œä¸ºä¸€ä¸ªå•å…ƒå®‰å…¨åœ°è¿›è¡Œï¼Œå“ªæ€•å…¶ä»–çº¿ç¨‹ä¹Ÿåœ¨æ‰§è¡Œæ“ä½œåŒä¸€å†…å­˜çš„åŸå­åŒ–æ“ä½œä¹Ÿæ²¡é—®é¢˜ã€‚</p><p>Rust æä¾›äº†ä»¥ä¸‹å‡ ç§åŸå­åŒ–ç±»å‹ï¼š</p><ul><li><code>AtomicIsize</code> å’Œ <code>AtomicUsize</code> æ˜¯ä¸å•çº¿ç¨‹<code>isize</code> ç±»å‹å’Œ <code>usize</code>ç±»å‹å¯¹åº”çš„å…±äº«æ•´æ•°ç±»å‹ã€‚</li><li><code>AtomicI8</code>ã€<code>AtomicI16</code>ã€<code>AtomicI32</code>ã€<code>AtomicI64</code>åŠå…¶æ— ç¬¦å·å˜ä½“ï¼ˆå¦‚<code>AtomicU8</code>ï¼‰æ˜¯å…±äº«æ•´æ•°ç±»å‹ï¼Œå¯¹åº”äºå•çº¿ç¨‹ä¸­çš„ç±»å‹<code>i8</code>ã€<code>i16</code> ç­‰ã€‚</li><li><code>AtomicBool</code> æ˜¯ä¸€ä¸ªå…±äº«çš„ <code>bool</code> å€¼ã€‚</li><li><code>AtomicPtr</code> æ˜¯ä¸å®‰å…¨æŒ‡é’ˆç±»å‹ <code>*mut T</code>çš„å…±äº«å€¼ã€‚</li></ul><p>è¿™äº›ç±»å‹éƒ½ä¼šä»¥ä¸‹å‡ ç±»æ ¸å¿ƒåŠŸèƒ½ï¼š</p><ul><li><code>Load</code> ã€<code>Store</code>: å­˜å–å€¼</li><li><code>Fetch-and-Modify</code>: è·å–å¹¶ä¿®æ”¹</li><li><code>Compare-and-Exchange</code>: æ¯”è¾ƒå¹¶äº¤æ¢</li></ul><p>ä¸‹é¢æˆ‘ä»¬å¯¹ä¸Šè¿°æåˆ°çš„å‡ ç§æ ¸å¿ƒåŠŸèƒ½è¿›è¡Œä¸¾ä¾‹ã€‚</p><h2 id="load-store">Load &amp; Store</h2><ul><li><strong>load</strong>:ä»åŸå­åŒ–ç±»å‹ä¸­è·å–èµ·å¯¹åº”çš„åŸºæœ¬æ•°æ®ç±»å‹çš„å€¼ã€‚</li><li><strong>store</strong>:å°†ä¸€ä¸ªåŸºæœ¬æ•°æ®ç±»å‹çš„å€¼å­˜å‚¨åˆ°å…¶å¯¹åº”çš„åŸå­åŒ–ç±»å‹ä¸­ã€‚</li></ul><p>åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>AtomicUsize::new(0)</code>åˆå§‹åŒ–äº†ä¸€ä¸ªåŸå­ç±»å‹ï¼Œå®ƒå¯¹åº”çš„åŸºæœ¬æ•°æ®ç±»å‹æ˜¯ <code>usize</code>ã€‚</p><p>æˆ‘ä»¬èµ·äº†ä¸€ä¸ªå­çº¿ç¨‹ï¼Œåœ¨ for å¾ªç¯ä¸­ä¸æ–­åœ°ä½¿ç”¨ <code>store</code>å‡½æ•°ä¿®æ”¹ <code>num_done</code> çš„å€¼ï¼Œç„¶ååœ¨ä¸»çº¿ç¨‹ä¸­ä½¿ç”¨<code>load</code> è·å–èµ·å¯¹åº”çš„å€¼ï¼Œå½“å‘ç°å€¼ä¸º <code>100</code>æ—¶ï¼Œå°±é€€å‡ºå¾ªç¯ï¼Œè¿›ç¨‹ç»“æŸã€‚</p><p>å¾—ç›ŠäºåŸå­åŒ–ç±»å‹çš„å¹¶å‘å®‰å…¨ç‰¹æ€§ï¼Œæ‰€ä»¥è¿™é‡Œä¸¤ä¸ªçº¿ç¨‹å¯¹<code>num_done</code> è¿›è¡Œå¹¶å‘è¯»å†™éƒ½æ˜¯å®‰å…¨çš„ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">num_done</span> = AtomicUsize::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">main_thread</span> = thread::<span class="hljs-title function_ invoke__">current</span>();<br><br>    thread::<span class="hljs-title function_ invoke__">scope</span>(|s| &#123;<br>        s.<span class="hljs-title function_ invoke__">spawn</span>(|| &#123;<br>            <span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..<span class="hljs-number">100</span> &#123;<br>                <span class="hljs-title function_ invoke__">sleep</span>(Duration::<span class="hljs-title function_ invoke__">from_millis</span>(<span class="hljs-number">10</span>));<br>                num_done.<span class="hljs-title function_ invoke__">store</span>(i + <span class="hljs-number">1</span>, std::sync::atomic::Ordering::Relaxed);  <span class="hljs-comment">// store å­˜å‚¨</span><br>                main_thread.<span class="hljs-title function_ invoke__">unpark</span>();<br>            &#125;<br>        &#125;);<br><br>        <span class="hljs-keyword">loop</span> &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">n</span> = num_done.<span class="hljs-title function_ invoke__">load</span>(std::sync::atomic::Ordering::Relaxed); <span class="hljs-comment">// load è·å–</span><br>            <span class="hljs-keyword">if</span> n == <span class="hljs-number">100</span> &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Working... &#123;n&#125;/100 done&quot;</span>);<br>            thread::<span class="hljs-title function_ invoke__">park_timeout</span>(Duration::<span class="hljs-title function_ invoke__">from_millis</span>(<span class="hljs-number">1</span>));<br>        &#125;<br>    &#125;);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Done!&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œæˆ‘ä»¬æš‚ä¸”å¿½ç•¥ <code>std::sync::atomic::Ordering::Relaxed</code>è¿™ä¸ªå‚æ•°çš„å«ä¹‰ï¼Œåœ¨åç»­çš„ã€Œå†…å­˜é¡ºåºã€ç« èŠ‚ä¼šè¿›è¡Œè¯¦ç»†é˜è¿°ã€‚</p></blockquote><h2 id="fetch-and-modify">Fetch-and-Modify</h2><p><strong>Fetch-and-Modify</strong>æ“ä½œç”¨äºåœ¨è·å–å½“å‰å€¼çš„åŒæ—¶å¯¹å…¶è¿›è¡Œä¿®æ”¹ã€‚è¿™ç±»æ“ä½œåŒ…æ‹¬<code>fetch_add</code>ã€<code>fetch_sub</code>ã€<code>fetch_and</code>ã€<code>fetch_or</code>ã€<code>fetch_xor</code>ç­‰ã€‚</p><p>æˆ‘ä»¬å°†ä¸Šé¢çš„ä¾‹å­ä¿®æ”¹ä¸€ä¸‹ï¼Œä¸å†æ˜¯ç›´æ¥ <code>store</code>ä¸€ä¸ªå€¼ï¼Œè€Œæ˜¯ä¸æ–­è¿›è¡ŒåŠ  1 æ“ä½œï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">num_done</span> = &amp;AtomicUsize::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">0</span>);<br><br>    thread::<span class="hljs-title function_ invoke__">scope</span>(|s| &#123;<br>        s.<span class="hljs-title function_ invoke__">spawn</span>(|| &#123;<br>            <span class="hljs-keyword">for</span> <span class="hljs-variable">_</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..<span class="hljs-number">100</span> &#123;<br>                num_done.<span class="hljs-title function_ invoke__">fetch_add</span>(<span class="hljs-number">1</span>, std::sync::atomic::Ordering::Relaxed); <span class="hljs-comment">// ä½¿ç”¨ fetch_add è¿›è¡ŒåŠ  1</span><br>            &#125;<br>        &#125;);<br><br>        <span class="hljs-keyword">loop</span> &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">n</span> = num_done.<span class="hljs-title function_ invoke__">load</span>(std::sync::atomic::Ordering::Relaxed);<br>            <span class="hljs-keyword">if</span> n == <span class="hljs-number">100</span> &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Working... &#123;n&#125;/100 done&quot;</span>);<br>        &#125;<br>    &#125;);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Done!&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="compare-and-exchange">Compare-and-Exchange</h2><p><strong>Compare-and-Exchange</strong>æ˜¯ä¸€ç§æ¡ä»¶æ›´æ–°æ“ä½œï¼Œåªæœ‰åœ¨å½“å‰å€¼ç­‰äºé¢„æœŸå€¼æ—¶æ‰ä¼šæ›´æ–°ã€‚</p><p>ä¸‹é¢çš„ä¾‹å­ä¸­æˆ‘ä»¬å®ç°äº†ä¸€ä¸ªå‡½æ•°<code>allocate_new_id</code>ï¼Œå®ƒæ”¯æŒåœ¨å¹¶å‘ç¯å¢ƒä¸‹åˆ†é…æ–°çš„<code>id</code>ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº† <code>compare_exchange(id, id+1)</code>è¿›è¡Œæ¡ä»¶æ›´æ–°ï¼Œåªæœ‰å½“ <code>id</code>æ²¡æœ‰å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œæ‰è¿è¡Œå¯¹å…¶è¿›è¡ŒåŠ 1ï¼Œè¿™å°±ä¿è¯äº†åœ¨å¹¶å‘ä¸‹ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æˆåŠŸæ‰§è¡Œè¯¥è¯­å¥ï¼Œä»è€Œä¿è¯<code>id</code> çš„é€’å¢æ€§å’Œå”¯ä¸€æ€§ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">allocate_new_id</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">u32</span> &#123;<br>    <span class="hljs-keyword">static</span> NEXT_ID: AtomicU32 = AtomicU32::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">id</span> = NEXT_ID.<span class="hljs-title function_ invoke__">load</span>(std::sync::atomic::Ordering::Relaxed);<br>    <span class="hljs-keyword">loop</span> &#123;<br>        <span class="hljs-built_in">assert!</span>(id &lt; <span class="hljs-number">1000</span>, <span class="hljs-string">&quot;Too many IDs!&quot;</span>);<br>        <span class="hljs-keyword">match</span> NEXT_ID.<span class="hljs-title function_ invoke__">compare_exchange</span>(  <span class="hljs-comment">// åªæœ‰ id æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œæ‰å…è®¸è¿›è¡ŒåŠ  1</span><br>            id,<br>            id + <span class="hljs-number">1</span>,<br>            std::sync::atomic::Ordering::Relaxed,<br>            std::sync::atomic::Ordering::Relaxed,<br>        ) &#123;<br>            <span class="hljs-title function_ invoke__">Ok</span>(_) =&gt; <span class="hljs-keyword">return</span> id,<br>            <span class="hljs-title function_ invoke__">Err</span>(v) =&gt; id = v,<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><div class="note note-info">            <p>åœ¨ Rustä¸­ï¼ŒåŸå­åŒ–ç±»å‹è¿˜æä¾›äº†å¦å¤–ä¸€ä¸ªå‡½æ•°ï¼š<code>compare_exchange_weak</code>ï¼Œå®ƒä¸<code>compare_exchange</code>çš„ä¸»è¦åŒºåˆ«åœ¨äºå®ƒä»¬åœ¨<strong>å¤±è´¥æ—¶</strong>çš„è¡Œä¸ºï¼š</p><p><strong>compare_exchange</strong>:</p><ul><li>åªä¼šåœ¨å®é™…å€¼ä¸ç­‰äºæœŸæœ›å€¼æ—¶å¤±è´¥ã€‚</li><li>æä¾›æ›´å¼ºçš„ä¿è¯ï¼Œä½†å¯èƒ½æ€§èƒ½è¾ƒä½ã€‚</li><li>é€‚ç”¨äºä¸åœ¨å¾ªç¯ä¸­çš„å•æ¬¡æ¯”è¾ƒäº¤æ¢æ“ä½œã€‚</li></ul><p><strong>compare_exchange_weak</strong>:</p><ul><li>å³ä½¿å®é™…å€¼ç­‰äºæœŸæœ›å€¼æ—¶ä¹Ÿå¯èƒ½å¤±è´¥ï¼ˆç§°ä¸ºâ€œè™šå‡å¤±è´¥â€æˆ–â€œspuriousfailureâ€ï¼‰ã€‚</li><li>æ€§èƒ½å¯èƒ½æ›´å¥½ï¼Œå› ä¸ºå…è®¸åœ¨æŸäº›æ¶æ„ä¸Šç”Ÿæˆæ›´é«˜æ•ˆçš„ä»£ç ã€‚</li><li>æœ€é€‚åˆåœ¨å¾ªç¯ä¸­ä½¿ç”¨ï¼Œå› ä¸ºéœ€è¦å¤„ç†å¯èƒ½çš„è™šå‡å¤±è´¥ã€‚</li></ul><p>åœ¨å®é™…åº”ç”¨ä¸­:</p><ul><li>å¦‚æœæ“ä½œåœ¨å¾ªç¯ä¸­,ä½¿ç”¨ <code>compare_exchange_weak</code>é€šå¸¸æ›´å¥½ã€‚</li><li>å¦‚æœæ˜¯å•æ¬¡æ“ä½œ,ä½¿ç”¨ <code>compare_exchange</code> æ›´åˆé€‚ã€‚</li><li>åœ¨æŸäº›å¹³å°ä¸Šï¼Œè¿™ä¸¤ä¸ªæ“ä½œå¯èƒ½æ²¡æœ‰æ€§èƒ½å·®å¼‚,ä½†<code>compare_exchange_weak</code> çš„è¡Œä¸ºä»ç„¶å¯èƒ½ä¸åŒã€‚</li></ul><p>è¿™ç§åŒºåˆ«çš„å­˜åœ¨æ˜¯å› ä¸ºåœ¨æŸäº› CPUæ¶æ„ä¸Š,å…è®¸è™šå‡å¤±è´¥å¯ä»¥ç”Ÿæˆæ›´é«˜æ•ˆçš„æœºå™¨ç ã€‚æ¯”å¦‚åœ¨ ARMæ¶æ„ä¸Šï¼Œ<code>compare_exchange_weak</code> å¯ä»¥ç›´æ¥æ˜ å°„åˆ°å•ä¸ªLL/SCï¼ˆLoad-Link/Store-Conditionalï¼‰æŒ‡ä»¤ã€‚</p>          </div><h2 id="ç¡¬ä»¶åŸç†">ç¡¬ä»¶åŸç†</h2><p>åœ¨ä¸€äº›å¤„ç†å™¨æ¶æ„ä¸­ï¼Œå½“ä¸€ä¸ª CPUæ‰§è¡Œéœ€è¦åŸå­æ€§çš„æ“ä½œæ—¶ï¼Œå®ƒå¯ä»¥é€šè¿‡é”å®šå†…å­˜æ€»çº¿æ¥ç¡®ä¿åœ¨æ“ä½œå®Œæˆä¹‹å‰ï¼Œå…¶ä»–CPU æ— æ³•è®¿é—®ç›¸å…³çš„å†…å­˜åœ°å€ã€‚</p><p>åŸºæœ¬å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">CPU å‘å‡º LOCK ä¿¡å·<br>   â””â”€â”€ æ¿€æ´»å¤„ç†å™¨çš„ LOCK# å¼•è„š<br>      â””â”€â”€ è·å¾—æ€»çº¿çš„ç‹¬å è®¿é—®æƒ<br>          â””â”€â”€ æ‰§è¡ŒåŸå­æ“ä½œ<br>              â””â”€â”€ é‡Šæ”¾ LOCK ä¿¡å·<br>                  â””â”€â”€ å…¶ä»–å¤„ç†å™¨å¯ä»¥è®¿é—®å†…å­˜<br></code></pre></td></tr></table></figure><p>ä¸»æµçš„æœ‰ 2 ç§é”å®šæœºåˆ¶ï¼š</p><ul><li><p><strong>æ€»çº¿é”å®šï¼ˆBusLockingï¼‰</strong>ï¼šæ€»çº¿é”å®šæ˜¯ä¸€ç§æœºåˆ¶ï¼Œå®ƒé€šè¿‡é”å®šå†…å­˜æ€»çº¿æ¥ç¡®ä¿åœ¨æ‰§è¡ŒåŸå­æ“ä½œæ—¶ï¼Œå…¶ä»–å¤„ç†å™¨æ— æ³•è®¿é—®å†…å­˜ã€‚è¿™ç§æ–¹æ³•è™½ç„¶ç®€å•ï¼Œä½†ä¼šå¯¼è‡´æ€»çº¿çš„å…¶ä»–æ“ä½œè¢«é˜»å¡ï¼Œä»è€Œå½±å“ç³»ç»Ÿæ€§èƒ½ã€‚</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs markdown">ä¼˜ç‚¹ï¼š<br><span class="hljs-bullet">-</span> ç»å¯¹çš„åŸå­æ€§ä¿è¯<br><span class="hljs-bullet">-</span> é€‚ç”¨äºæ‰€æœ‰å†…å­˜ä½ç½®<br><br>ç¼ºç‚¹ï¼š<br><span class="hljs-bullet">-</span> æ€§èƒ½å¼€é”€å¤§<br><span class="hljs-bullet">-</span> ä¼šé˜»å¡å…¶ä»– CPU å¯¹å†…å­˜çš„è®¿é—®<br></code></pre></td></tr></table></figure></li><li><p><strong>ç¼“å­˜é”å®šï¼ˆCacheLockingï¼‰</strong>ï¼šç°ä»£å¤„ç†å™¨é€šå¸¸ä½¿ç”¨ç¼“å­˜é”å®šæ¥å®ç°åŸå­æ“ä½œã€‚ç¼“å­˜é”å®šé€šè¿‡é”å®šå¤„ç†å™¨çš„ç¼“å­˜è¡Œæ¥å®ç°ï¼Œè€Œä¸æ˜¯é”å®šæ•´ä¸ªæ€»çº¿ã€‚è¿™ç§æ–¹æ³•å¯ä»¥å‡å°‘å¯¹æ€»çº¿çš„å½±å“ï¼Œæé«˜ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½ã€‚</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs markdown">ä¼˜ç‚¹ï¼š<br><span class="hljs-bullet">-</span> æ€§èƒ½æ›´å¥½<br><span class="hljs-bullet">-</span> ä¸ä¼šå®Œå…¨é˜»å¡å†…å­˜è®¿é—®<br><br>æ¡ä»¶ï¼š<br><span class="hljs-bullet">-</span> æ•°æ®å¿…é¡»åœ¨ç¼“å­˜è¡Œä¸­<br><span class="hljs-bullet">-</span> ç¼“å­˜è¡Œå¿…é¡»æ˜¯ç‹¬å çŠ¶æ€<br></code></pre></td></tr></table></figure></li></ul><p>ç¼“å­˜é”å®šé€šå¸¸ä¾èµ–äºç¼“å­˜ä¸€è‡´æ€§åè®®ï¼ˆå¦‚ <strong>MESI</strong>åè®®ï¼‰æ¥ç¡®ä¿åœ¨å¤šä¸ªå¤„ç†å™¨ä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§ã€‚é€šè¿‡è¿™äº›åè®®ï¼Œå¤„ç†å™¨å¯ä»¥åœ¨æœ¬åœ°ç¼“å­˜ä¸­æ‰§è¡ŒåŸå­æ“ä½œï¼Œå¹¶åœ¨å¿…è¦æ—¶ä¸å…¶ä»–å¤„ç†å™¨åŒæ­¥ã€‚</p><p><strong>MESI</strong> åè®®å³ï¼š</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs markdown">M (Modified)ï¼šå·²ä¿®æ”¹<br>E (Exclusive)ï¼šç‹¬å <br>S (Shared)ï¼šå…±äº«<br>I (Invalid)ï¼šæ— æ•ˆ<br><br>æ“ä½œæµç¨‹ï¼š<br><span class="hljs-bullet">1.</span> æ£€æŸ¥æ•°æ®æ˜¯å¦åœ¨ç¼“å­˜ä¸­<br><span class="hljs-bullet">2.</span> å¦‚æœåœ¨ï¼Œå°†çŠ¶æ€æ”¹ä¸º Exclusive<br><span class="hljs-bullet">3.</span> æ‰§è¡ŒåŸå­æ“ä½œ<br><span class="hljs-bullet">4.</span> é€šçŸ¥å…¶ä»– CPU ä½¿å…¶ç¼“å­˜å¤±æ•ˆ<br></code></pre></td></tr></table></figure><p>ä¸åŒçš„æ¶æ„æœ‰ä¸åŒçš„é”å®šæ–¹å¼ï¼š</p><ul><li>x86/x64ï¼šä½¿ç”¨ LOCK å‰ç¼€</li><li>ARMï¼šä½¿ç”¨ exclusive load/store æŒ‡ä»¤</li><li>PowerPCï¼šä½¿ç”¨ load-linked/store-conditional</li></ul><p>ä»¥ä¸‹æ˜¯ x86 æ±‡ç¼–çš„ä¸€ä¸ªç¤ºä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs assembly">; åŸå­åŠ æ³•æ“ä½œ<br>lock add dword ptr [memory], 1<br><br>; æ¯”è¾ƒå¹¶äº¤æ¢<br>lock cmpxchg dword ptr [memory], eax<br></code></pre></td></tr></table></figure><p>ä¸ºäº†å……åˆ†åˆ©ç”¨<strong>ç¼“å­˜é”å®š</strong>çš„ä¼˜åŠ¿ï¼Œæˆ‘ä»¬åœ¨ç¼–å†™ä»£ç æ—¶ï¼Œå¯ä»¥æœ‰ä»¥ä¸‹çš„æ€§èƒ½è€ƒè™‘ï¼š</p><ul><li><p><strong>ç¼“å­˜è¡Œå¯¹é½ï¼Œé¿å…ä¼ªå…±äº«</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> std::sync::atomic::&#123;AtomicI32, Ordering&#125;;<br><br><span class="hljs-comment">// åœ¨ Rust ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ #[repr(align(N))] å±æ€§æ¥ç¡®ä¿ç»“æ„ä½“æˆ–å˜é‡çš„å¯¹é½æ–¹å¼ï¼Œä»¥é¿å…ä¼ªå…±äº«ã€‚</span><br><span class="hljs-comment">// ä¼ªå…±äº«æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹è®¿é—®ä¸åŒçš„å˜é‡ï¼Œä½†è¿™äº›å˜é‡å…±äº«åŒä¸€ä¸ªç¼“å­˜è¡Œï¼Œä»è€Œå¯¼è‡´ä¸å¿…è¦çš„ç¼“å­˜ä¸€è‡´æ€§æµé‡ã€‚</span><br><span class="hljs-meta">#[repr(align(64))]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">AlignedCounter</span> &#123;<br>    counter: AtomicI32,<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">counter</span> = AlignedCounter &#123;<br>        counter: AtomicI32::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">0</span>),<br>    &#125;;<br>    <span class="hljs-comment">// ä½¿ç”¨ counter.counter.fetch_add(...) è¿›è¡Œæ“ä½œ</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>é¿å…é¢‘ç¹çš„æ€»çº¿é”å®š</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> std::sync::atomic::&#123;AtomicI32, Ordering&#125;;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">counter</span> = AtomicI32::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">// ä¸å¥½çš„åšæ³•ï¼šé¢‘ç¹çš„åŸå­æ“ä½œ</span><br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">_</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..<span class="hljs-number">1000</span> &#123;<br>        counter.<span class="hljs-title function_ invoke__">fetch_add</span>(<span class="hljs-number">1</span>, Ordering::SeqCst);<br>    &#125;<br><br>    <span class="hljs-comment">// æ›´å¥½çš„åšæ³•ï¼šæœ¬åœ°ç´¯åŠ åä¸€æ¬¡æ€§æ›´æ–°</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">local_sum</span> = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">_</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..<span class="hljs-number">1000</span> &#123;<br>        local_sum += <span class="hljs-number">1</span>;<br>    &#125;<br>    counter.<span class="hljs-title function_ invoke__">fetch_add</span>(local_sum, Ordering::SeqCst);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h3 id="rust-å®æˆ˜æŸ¥çœ‹æ±‡ç¼–">Rust å®æˆ˜æŸ¥çœ‹æ±‡ç¼–</h3><blockquote><p>ç¬”è€…ä½¿ç”¨çš„æ˜¯ ARM64 æ¶æ„çš„ macbookã€‚</p></blockquote><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> std::sync::atomic::&#123;AtomicI64, Ordering&#125;;<br><span class="hljs-keyword">use</span> std::thread;<br><br><span class="hljs-keyword">static</span> ATOMIC: AtomicI64 = AtomicI64::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">0</span>);<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">t1</span> = thread::<span class="hljs-title function_ invoke__">spawn</span>(|| &#123;<br>        ATOMIC.<span class="hljs-title function_ invoke__">store</span>(<span class="hljs-number">10086</span>, Ordering::Release);<br>    &#125;);<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">t2</span> = thread::<span class="hljs-title function_ invoke__">spawn</span>(|| &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">val</span> = ATOMIC.<span class="hljs-title function_ invoke__">load</span>(Ordering::Acquire);<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;val&#125;&quot;</span>);<br>    &#125;);<br><br>    t1.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br>    t2.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>rustc</code> ç¼–è¯‘å¹¶è¾“å‡ºæ±‡ç¼–ä»£ç ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">rustc -O --emit asm src/main.rs<br></code></pre></td></tr></table></figure><p>ä»£ç ä¸­æˆ‘ç‰¹åœ°è®¾ç½®äº† <code>10086</code>è¿™ä¸ªç‰¹æ®Šçš„å€¼ï¼Œè¿™æ˜¯ä¸ºäº†å¯ä»¥åœ¨è¾“å‡ºçš„ <code>main.s</code> æ–‡ä»¶ä¸­å¿«é€Ÿæ‰¾åˆ°<code>store</code> å¯¹åº”çš„ä½ç½®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs assembly">__ZN3std3sys9backtrace28__rust_begin_short_backtrace17h750d7a3a9c81fc67E:<br>.cfi_startproc<br>Lloh8:<br>adrpx8, __ZN4main6ATOMIC17hd0b0dbf92e477148E.0@PAGE<br>Lloh9:<br>addx8, x8, __ZN4main6ATOMIC17hd0b0dbf92e477148E.0@PAGEOFF<br>movw9, #10086 ; å°†å€¼ 10086 ç§»å…¥å¯„å­˜å™¨<br>stlrx9, [x8] ; Store-Release æŒ‡ä»¤ï¼ŒåŸå­åœ°å­˜å‚¨å€¼<br>; InlineAsm Start<br>; InlineAsm End<br>ret<br>.loh AdrpAddLloh8, Lloh9<br>.cfi_endproc<br></code></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä»£ç ä¸­ï¼Œ<code>stlr</code> å°±æ˜¯ <code>Store Release</code>çš„æ„æ€ï¼Œå¦å¤–ä¸€ä¸ªå…³é”®å­—æ˜¯ <code>ladpr</code>ï¼Œè¡¨ç¤º<code>Load Acquire</code> çš„æ„æ€ï¼Œé€šè¿‡è¿™ä¸ªå…³é”®å­—ï¼Œä½ å¯ä»¥æ‰¾åˆ°<code>load</code> å¯¹åº”çš„æ±‡ç¼–ä»£ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs assembly">Lloh11:<br>addx8, x8, __ZN4main6ATOMIC17hd0b0dbf92e477148E.0@PAGEOFF<br>ldaprx8, [x8] ; ; Load-Acquire æŒ‡ä»¤ï¼ŒåŸå­åœ°åŠ è½½å€¼<br>strx8, [sp, #8]<br></code></pre></td></tr></table></figure><h3 id="go-å®æˆ˜æŸ¥çœ‹æ±‡ç¼–">Go å®æˆ˜æŸ¥çœ‹æ±‡ç¼–</h3><blockquote><p>ç¬”è€…ä½¿ç”¨çš„æ˜¯ ARM64 æ¶æ„çš„ macbookã€‚</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;sync/atomic&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>data := atomic.Int64&#123;&#125;<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>data.Store(<span class="hljs-number">10086</span>)<br>&#125;()<br><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>a := data.Load()<br><span class="hljs-built_in">println</span>(a)<br>&#125;()<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼Œå¯ä»¥è¾“å‡ºä¼˜åŒ–åçš„æ±‡ç¼–ä»£ç ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">go build -gcflags=-S -ldflags=-w main.go 2&gt; assembly.txt<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹è¾“å‡ºçš„æ–‡ä»¶ï¼Œæˆ‘ä»¬åŒæ ·æœç´¢ <code>10086</code>ï¼Œå¯ä»¥å¿«é€Ÿæ‰¾åˆ°<code>store</code> çš„ä½ç½®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">0x0008 00008 (/Users/wangjiahan/go/go1.23.2/src/sync/atomic/type.go:109)MOVD$10086, R1<br>0x000c 00012 (/Users/wangjiahan/go/go1.23.2/src/sync/atomic/type.go:109)STLRR1, (R0)<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡ŒåŒæ ·ä¹Ÿæ˜¯ä½¿ç”¨äº† <code>STLR</code> æŒ‡ä»¤ã€‚æ¥ç€æˆ‘ä»¬çœ‹ç¬¬ 14è¡Œä»£ç çš„ä½ç½®å¯¹åº”çš„æ±‡ç¼–ï¼šå¯ä»¥å‘ç°è¿™é‡Œä½¿ç”¨çš„ <code>LDAR</code>æŒ‡ä»¤ï¼Œä¹Ÿå°±æ˜¯ <code>Load Acuqire</code>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs assembly">0x001c 00028 (/Users/wangjiahan/goStudy/go-atomic/main.go:14)HINT$0<br>0x0020 00032 (/Users/wangjiahan/go/go1.23.2/src/sync/atomic/type.go:106)LDAR(R0), R0<br>0x0024 00036 (/Users/wangjiahan/go/go1.23.2/src/sync/atomic/type.go:106)MOVDR0, main..autotmp_6-8(SP)<br></code></pre></td></tr></table></figure><h1 id="å†…å­˜é¡ºåº">å†…å­˜é¡ºåº</h1><p>åœ¨äº†è§£äº† Rust Atomicçš„åŸºæœ¬ç”¨æ³•å’ŒåŸºæœ¬åŸç†ä¹‹åï¼Œæˆ‘ä»¬å›è¿‡å¤´æ¥è°ˆä¸€è°ˆåŸå­æ“ä½œå‚æ•°ä¸­çš„<code>std::sync::atomic::Ordering::Relaxed</code>ï¼Œè¿™ä¸ªå°±æ˜¯æœ¬ç¯‡çš„ä¸»é¢˜ï¼š<strong>å†…å­˜é¡ºåº</strong>ã€‚å†…å­˜é¡ºåºè¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜æ˜¯<u>å¦‚ä½•åˆç†åœ°é™åˆ¶å•ä¸€çº¿ç¨‹ä¸­çš„ä»£ç æ‰§è¡Œé¡ºåºï¼Œä½¿å¾—åœ¨ä¸ä½¿ç”¨é”çš„æƒ…å†µä¸‹ï¼Œæ—¢èƒ½æœ€å¤§åŒ–åˆ©ç”¨CPU çš„è®¡ç®—èƒ½åŠ›ï¼Œåˆèƒ½ä¿è¯å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¸ä¼šå‡ºç°é€»è¾‘é”™è¯¯ã€‚</u></p><h2 id="æŒ‡ä»¤ä¹±åº">æŒ‡ä»¤ä¹±åº</h2><p>CPUå’Œç¼–è¯‘å™¨éƒ½ä¼šåœ¨ä¿è¯ç¨‹åºè¿è¡Œç»“æœä¸å‘ç”Ÿæ”¹å˜çš„å‰æä¸‹ï¼Œå°½ä¸€åˆ‡å¯èƒ½è®©æˆ‘ä»¬çš„ç¨‹åºè¿è¡Œå¾—å°½å¯èƒ½å¿«ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">f</span>(a: &amp;<span class="hljs-keyword">mut</span> <span class="hljs-type">i32</span>, b: &amp;<span class="hljs-keyword">mut</span> <span class="hljs-type">i32</span>) &#123;<br>  *a += <span class="hljs-number">1</span>;<br>  *b += <span class="hljs-number">1</span>;<br>  *a += <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>åƒä¸Šè¿°ä»£ç ï¼Œç¼–è¯‘å™¨å®Œå…¨å¯ä»¥ä¼˜åŒ–æˆä¸‹é¢çš„ä»£ç ï¼Œä»è€Œæé«˜ç¨‹åºçš„è¿è¡Œæ•ˆç‡ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">f</span>(a: &amp;<span class="hljs-keyword">mut</span> <span class="hljs-type">i32</span>, b: &amp;<span class="hljs-keyword">mut</span> <span class="hljs-type">i32</span>) &#123;<br>  *a += <span class="hljs-number">2</span>;<br>  *b += <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå°±å¯èƒ½ä¼šå‡ºç°<strong>æŒ‡ä»¤é‡æ’</strong>ï¼Œç”šè‡³æ˜¯<strong>ä»£ç é‡å†™</strong>ï¼Œä¸è¿‡è¿™å¸¦æ¥äº†æŒ‡ä»¤ä¹±åºçš„é—®é¢˜ï¼Œå³<u>ç¨‹åºçš„å®é™…æ‰§è¡Œé¡ºåºè·Ÿæˆ‘ä»¬çš„ä»£ç é¡ºåºæ˜¯ä¸ä¸€è‡´çš„</u>ã€‚</p><p>ä¸è¿‡ï¼Œç¼–è¯‘å™¨ä¿è¯çš„æ˜¯<strong>åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œæ‰§è¡Œçš„ç»“æœæœ€ç»ˆä¸€è‡´</strong>ï¼Œæ‰€ä»¥ï¼ŒæŒ‡ä»¤ä¹±åºåœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹å®Œå…¨æ˜¯å…è®¸çš„ã€‚å¯¹äºç¼–è¯‘å™¨æ¥è¯´ï¼Œå®ƒåªçŸ¥é“ï¼šåœ¨å½“å‰çº¿ç¨‹ä¸­ï¼Œæ•°æ®çš„è¯»å†™ä»¥åŠæ•°æ®ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚ä½†æ˜¯ï¼Œ<strong>ç¼–è¯‘å™¨å¹¶ä¸çŸ¥é“å“ªäº›æ•°æ®æ˜¯åœ¨çº¿ç¨‹é—´å…±äº«ï¼Œè€Œä¸”æ˜¯æœ‰å¯èƒ½ä¼šè¢«ä¿®æ”¹çš„</strong>ã€‚è€Œè¿™äº›æ˜¯éœ€è¦å¼€å‘äººå‘˜å»ä¿è¯çš„ã€‚</p><h2 id="å†…å­˜æ¨¡å‹">å†…å­˜æ¨¡å‹</h2><p>ä¸ºäº†è§£å†³æŒ‡ä»¤ä¹±åºå¸¦æ¥çš„å¹¶å‘é—®é¢˜ï¼ŒRust é‡‡ç”¨äº†å†…å­˜æ¨¡å‹ï¼ˆMemoryModelï¼‰è¿™ä¸€æ¦‚å¿µã€‚è¿™ä¸ªæ¦‚å¿µä¸»è¦å€Ÿé‰´è‡ª C++11ä¸­å¼•å…¥çš„å†…å­˜æ¨¡å‹ï¼Œå®ƒå®šä¹‰äº†åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å†…å­˜è®¿é—®çš„è¡Œä¸ºè§„èŒƒã€‚</p><p>å†…å­˜æ¨¡å‹çš„æ ¸å¿ƒç›®æ ‡æ˜¯åœ¨ä»¥ä¸‹ä¸‰æ–¹é¢ä¹‹é—´å–å¾—å¹³è¡¡ï¼š</p><ol type="1"><li><strong>æ­£ç¡®æ€§ä¿è¯</strong>ï¼šç¡®ä¿å¤šçº¿ç¨‹ç¨‹åºçš„è¡Œä¸ºæ˜¯å¯é¢„æµ‹å’Œä¸€è‡´çš„ã€‚</li><li><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼šå…è®¸ç¼–è¯‘å™¨å’Œ CPUåœ¨ä¸è¿åæ­£ç¡®æ€§çš„å‰æä¸‹è¿›è¡Œä¼˜åŒ–ã€‚</li><li><strong>è·¨å¹³å°å…¼å®¹</strong>ï¼šæä¾›ä¸€ä¸ªç»Ÿä¸€çš„æŠ½è±¡å±‚ï¼Œä½¿ä»£ç å¯ä»¥åœ¨ä¸åŒçš„ç¡¬ä»¶æ¶æ„ä¸Šæ­£ç¡®è¿è¡Œã€‚</li></ol><p>å…·ä½“æ¥è¯´ï¼Œå†…å­˜æ¨¡å‹ï¼š</p><ul><li>ä¸ºå¼€å‘è€…æä¾›äº†æ¸…æ™°çš„è§„åˆ™ï¼Œè¯´æ˜åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä»€ä¹ˆæ ·çš„å†…å­˜è®¿é—®è¡Œä¸ºæ˜¯åˆæ³•çš„ï¼Œä»€ä¹ˆæ ·çš„è¡Œä¸ºä¼šå¯¼è‡´æœªå®šä¹‰è¡Œä¸ºã€‚</li><li>ä¸ºç¼–è¯‘å™¨å¼€å‘è€…æä¾›äº†æ˜ç¡®çš„æ ‡å‡†ï¼ŒæŒ‡å¯¼ä»–ä»¬åœ¨ä¸åŒå¹³å°ä¸Šå®ç°å¿…è¦çš„å†…å­˜åŒæ­¥åŸè¯­ã€‚</li><li>é€šè¿‡å®šä¹‰ä¸åŒçš„å†…å­˜é¡ºåºçº§åˆ«ï¼ˆå¦‚ Relaxedã€Release/Acquireã€SeqCstç­‰ï¼‰ï¼Œè®©å¼€å‘è€…å¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©åˆé€‚çš„åŒæ­¥å¼ºåº¦ã€‚</li></ul><p>è¿™ç§æŠ½è±¡è®©å¼€å‘è€…å¯ä»¥ä¸“æ³¨äºå¹¶å‘é€»è¾‘æœ¬èº«ï¼Œè€Œä¸å¿…è¿‡åˆ†å…³æ³¨åº•å±‚ç¡¬ä»¶çš„å…·ä½“å®ç°ç»†èŠ‚ã€‚</p><h2 id="sequenced-before">Sequenced-Before</h2><p>åœ¨è®¨è®ºå†…å­˜é¡ºåºä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå¯¹ 2 ä¸ªé‡è¦å…³ç³»æœ¯è¯­è¿›è¡Œç®€å•é˜è¿°ï¼Œåˆ†åˆ«æ˜¯<code>Sequenced-Before</code> å’Œ <code>Happens-Before</code>ã€‚</p><p><strong>Sequenced-Before</strong>æè¿°çš„æ˜¯<strong>å•ä¸ªçº¿ç¨‹å†…</strong>çš„æ“ä½œé¡ºåºã€‚å®ƒåŸºäºç¨‹åºçš„æºä»£ç é¡ºåºï¼Œè¡¨ç¤ºåœ¨åŒä¸€çº¿ç¨‹ä¸­ï¼Œä¸€ä¸ªæ“ä½œåœ¨ç¨‹åºä¸­å‡ºç°åœ¨å¦ä¸€ä¸ªæ“ä½œä¹‹å‰ã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œå¦‚æœæ“ä½œ A sequenced-before æ“ä½œ Bï¼Œé‚£ä¹ˆï¼š</p><ol type="1"><li><p><strong>æ•°æ®ä¾èµ–å…³ç³»</strong>ï¼šå¦‚æœ B ä¾èµ–äº A çš„ç»“æœï¼Œé‚£ä¹ˆ Aä¸€å®šä¼šåœ¨ B ä¹‹å‰æ‰§è¡Œã€‚ä¾‹å¦‚ï¼š <figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">x</span> = <span class="hljs-number">1</span>;      <span class="hljs-comment">// æ“ä½œ A</span><br><span class="hljs-keyword">let</span> <span class="hljs-variable">y</span> = x + <span class="hljs-number">1</span>;  <span class="hljs-comment">// æ“ä½œ B - ä¾èµ–äº A çš„ç»“æœ</span><br></code></pre></td></tr></table></figure></p></li><li><p><strong>åŸå­æ“ä½œçš„é¡ºåº</strong>ï¼šå¯¹åŒä¸€ä¸ªåŸå­å˜é‡çš„æ“ä½œä¼šä¿æŒç¨‹åºé¡ºåºã€‚ä¾‹å¦‚ï¼š<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs rust">X.<span class="hljs-title function_ invoke__">fetch_add</span>(<span class="hljs-number">5</span>, Relaxed);    <span class="hljs-comment">// ä¸€å®šå…ˆæ‰§è¡Œ</span><br>X.<span class="hljs-title function_ invoke__">fetch_add</span>(<span class="hljs-number">10</span>, Relaxed);   <span class="hljs-comment">// ä¸€å®šåæ‰§è¡Œ</span><br></code></pre></td></tr></table></figure></p></li><li><p><strong>ç‹¬ç«‹æ“ä½œçš„å¯é‡æ’æ€§</strong>ï¼šå¦‚æœä¸¤ä¸ªæ“ä½œä¹‹é—´æ²¡æœ‰æ•°æ®ä¾èµ–å…³ç³»ï¼Œä¸”æ“ä½œçš„æ˜¯ä¸åŒçš„å˜é‡ï¼Œé‚£ä¹ˆå®ƒä»¬å¯èƒ½ä¼šè¢«é‡æ’åºã€‚ä¾‹å¦‚ï¼š<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs rust">X.<span class="hljs-title function_ invoke__">store</span>(<span class="hljs-number">1</span>, Relaxed);  <span class="hljs-comment">// è¿™ä¸¤ä¸ªæ“ä½œå¯èƒ½ä¼šè¢«é‡æ’åº</span><br>Y.<span class="hljs-title function_ invoke__">store</span>(<span class="hljs-number">2</span>, Relaxed);  <span class="hljs-comment">// å› ä¸ºå®ƒä»¬æ“ä½œçš„æ˜¯ä¸åŒçš„å˜é‡</span><br></code></pre></td></tr></table></figure></p></li></ol><h2 id="happens-before">Happens-Before</h2><p><strong>Happens-Before</strong>åˆ™æè¿°äº†<strong>è·¨çº¿ç¨‹</strong>çš„æ“ä½œé¡ºåºã€‚å®ƒå®šä¹‰äº†ä¸åŒçº¿ç¨‹ä¸­çš„æ“ä½œä¹‹é—´çš„å¯è§æ€§å’Œé¡ºåºå…³ç³»ã€‚å¦‚æœæ“ä½œA Happens-Before æ“ä½œ Bï¼Œé‚£ä¹ˆ A çš„å†…å­˜å†™å…¥å¯¹ B æ˜¯å¯è§çš„ã€‚</p><p>å…¸å‹çš„ Happens-Before æœ‰ï¼š</p><ol type="1"><li>åŒä¸€çº¿ç¨‹å†…ï¼Œå¦‚æœå…ˆè°ƒç”¨ <code>f()</code>ï¼Œå†è°ƒä½£ <code>g()</code>ï¼Œåˆ™<code>f()</code> happens-before <code>g()</code>ï¼Œå…¶å®è¿™å°±æ˜¯<code>sequenced-before</code>ã€‚</li><li><code>spawing</code> happens-before <code>joining</code>ã€‚</li><li><code>lock</code> happens-before <code>unlock</code>ã€‚</li></ol><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">static</span> X: AtomicI32 = AtomicI32::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">0</span>);<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    X.<span class="hljs-title function_ invoke__">store</span>(<span class="hljs-number">1</span>, Relaxed);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">t</span> = thread::<span class="hljs-title function_ invoke__">spawn</span>(f);<br>    X.<span class="hljs-title function_ invoke__">store</span>(<span class="hljs-number">2</span>, Relaxed);<br>    t.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br>    X.<span class="hljs-title function_ invoke__">store</span>(<span class="hljs-number">3</span>, Relaxed);<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">f</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">x</span> = X.<span class="hljs-title function_ invoke__">load</span>(Relaxed);<br>    <span class="hljs-built_in">assert!</span>(x == <span class="hljs-number">1</span> || x == <span class="hljs-number">2</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢è¿™ä¸ªä¾‹å­çš„æ‰§è¡Œé¡ºåºå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå› ä¸º <code>spawn</code>happens-before<code>join</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç¡®å®šçš„æ‰§è¡Œé¡ºåºæ˜¯ï¼š<strong>â€œstore 1 toXâ€â†’â€œstore 2 to Xâ€â†’â€œstore 3 to Xâ€</strong>ã€‚è€Œ <strong>load fromX</strong> ä»‹äº spawn å’Œ joinä¹‹é—´ï¼Œä¸”æ²¡æœ‰è¿›è¡Œä»»ä½•å…¶ä»–çš„å†…å­˜é¡ºåºé™åˆ¶ï¼Œæ‰€ä»¥å®ƒå’Œ <strong>store 2 toX</strong> ä¹‹é—´çš„é¡ºåºæ˜¯ä¸ç¡®å®šçš„ï¼Œä½†æ˜¯å¯ä»¥è‚¯å®šçš„æ˜¯ï¼Œå®ƒä¸€å®šåœ¨<strong>store 3 to X</strong> ä¹‹å‰ï¼Œæ‰€ä»¥<code>assert!(x == 1 || x == 2);</code> æ˜¯æ°¸è¿œæˆç«‹çš„ã€‚</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20241111160041436.png" alt="spawn-happens-before-join" style="zoom:33%;" /></p><p>åˆ°è¿™é‡Œï¼Œç›¸ä¿¡ä¸å°‘è¯»è€…å·²ç»èƒ½å¤Ÿç†è§£ä¸ºä»€ä¹ˆéœ€è¦å†…å­˜é¡ºåºè¿™ä¸ªä¸œè¥¿äº†ï¼Œæ ¸å¿ƒé—®é¢˜å°±æ˜¯åœ¨äº<strong>store 2 to X</strong> å’Œ <strong>load from X</strong>çš„æ‰§è¡Œé¡ºåºæ˜¯å¦ä¼šå½±å“æˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘ï¼Œå¦‚æœä¸ä¼šï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æŒ‡å®šæœ€æ¾æ•£çš„å†…å­˜é¡ºåºè¦æ±‚ï¼Œå¦‚æœä¼šï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¦åˆ©ç”¨æŒ‡å®šåˆé€‚çš„å†…å­˜é¡ºåºæ¥ä½¿å¾—å…¶æŒ‰ç…§æˆ‘ä»¬çš„é¢„æœŸé¡ºåºè¿›è¡Œæ‰§è¡Œï¼Œä»è€Œä¿è¯ä¸šåŠ¡é€»çš„æ­£ç¡®ã€‚</p><h2 id="rust-å†…å­˜é¡ºåº">Rust å†…å­˜é¡ºåº</h2><p>Rust æ”¯æŒäº”ç§å†…å­˜é¡ºåºï¼ˆOrderingï¼‰ï¼Œä»æœ€æ¾æ•£åˆ°æœ€ä¸¥æ ¼ä¾æ¬¡ä¸ºï¼š</p><table><thead><tr class="header"><th>å†…å­˜é¡ºåº</th><th>è¯´æ˜</th><th>ä¿è¯</th><th>é€‚ç”¨åœºæ™¯</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr class="odd"><td>Relaxed</td><td>æœ€å®½æ¾çš„å†…å­˜é¡ºåº</td><td>- ä»…ä¿è¯æ“ä½œçš„åŸå­æ€§<br>- ä¸æä¾›ä»»ä½•åŒæ­¥ä¿è¯<br>- ä¸å»ºç«‹happens-before å…³ç³»</td><td>- ç®€å•è®¡æ•°å™¨<br>- æ€§èƒ½è¦æ±‚æé«˜ä¸”ç¡®å®šä¸éœ€è¦åŒæ­¥<br>-å·²é€šè¿‡å…¶ä»–æ–¹å¼ç¡®ä¿åŒæ­¥</td><td><code>counter.fetch_add(1, Ordering::Relaxed)</code></td></tr><tr class="even"><td>Release</td><td>ç”¨äºå­˜å‚¨æ“ä½œ</td><td>- ä¹‹å‰çš„å†…å­˜è®¿é—®ä¸ä¼šè¢«é‡æ’åˆ°æ­¤æ“ä½œä¹‹å<br>- ä¸ Acquireé…å¯¹ä½¿ç”¨å¯å»ºç«‹ happens-before å…³ç³»</td><td>- ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼<br>- å‘å¸ƒå…±äº«æ•°æ®<br>- åˆå§‹åŒ–å®Œæˆæ ‡å¿—</td><td><code>data.store(42, Ordering::Release)</code></td></tr><tr class="odd"><td>Acquire</td><td>ç”¨äºåŠ è½½æ“ä½œ</td><td>- ä¹‹åçš„å†…å­˜è®¿é—®ä¸ä¼šè¢«é‡æ’åˆ°æ­¤æ“ä½œä¹‹å‰<br>- ä¸ Releaseé…å¯¹ä½¿ç”¨å¯å»ºç«‹ happens-before å…³ç³»</td><td>- ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼<br>- è·å–å…±äº«æ•°æ®<br>- æ£€æŸ¥åˆå§‹åŒ–æ ‡å¿—</td><td><code>data.load(Ordering::Acquire)</code></td></tr><tr class="even"><td>AcqRel</td><td>åŒæ—¶åŒ…å« Acquire å’Œ Release è¯­ä¹‰</td><td>- ç»“åˆäº† Acquire å’Œ Release çš„æ‰€æœ‰ä¿è¯<br>- ç”¨äºè¯»æ”¹å†™æ“ä½œ</td><td>- éœ€è¦åŒå‘åŒæ­¥çš„åŸå­æ“ä½œ<br>- é”çš„å®ç°<br>- å¤æ‚çš„åŒæ­¥åŸè¯­</td><td><code>value.fetch_add(1, Ordering::AcqRel)</code></td></tr><tr class="odd"><td>SeqCst</td><td>æœ€ä¸¥æ ¼çš„å†…å­˜é¡ºåº</td><td>- åŒ…å« AcqRel çš„æ‰€æœ‰ä¿è¯<br>- æ‰€æœ‰çº¿ç¨‹çœ‹åˆ°çš„æ‰€æœ‰ SeqCstæ“ä½œé¡ºåºä¸€è‡´<br>- æä¾›å…¨å±€çš„é¡ºåºä¸€è‡´æ€§</td><td>- éœ€è¦ä¸¥æ ¼çš„å…¨å±€é¡ºåº<br>- ä¸ç¡®å®šä½¿ç”¨å“ªç§é¡ºåºæ—¶<br>-å¯¹æ€§èƒ½è¦æ±‚ä¸é«˜çš„åœºæ™¯</td><td><code>flag.store(true, Ordering::SeqCst)</code></td></tr></tbody></table><p>åœ¨ C++ ä¸­ï¼Œå…¶å®è¿˜æœ‰å¦å¤–ä¸€ç§å†…å­˜é¡ºåº <code>Consume</code>ï¼Œå®ƒæ˜¯<code>Acquire</code> çš„ä¸€ä¸ªæ›´å¼±çš„ç‰ˆæœ¬ï¼š</p><ul><li><p><strong>Acquire</strong>:ä¿è¯åç»­çš„æ‰€æœ‰è¯»å†™æ“ä½œä¸ä¼šé‡æ’åˆ°è¿™ä¸ªæ“ä½œå‰é¢</p></li><li><p><strong>Consume</strong>:åªä¿è¯åç»­ä¸è¿™ä¸ªæ“ä½œç»“æœç›¸å…³çš„è¯»å†™æ“ä½œä¸ä¼šé‡æ’åˆ°è¿™ä¸ªæ“ä½œå‰é¢</p></li></ul><p>ç†è®ºä¸Šï¼ŒConsume åœ¨æŸäº›æ¶æ„ä¸Šå¯ä»¥æä¾›æ¯” Acquireæ›´å¥½çš„æ€§èƒ½ï¼Œå› ä¸ºå®ƒåªéœ€è¦å¯¹æ•°æ®ä¾èµ–çš„æ“ä½œè¿›è¡ŒåŒæ­¥ã€‚</p><p>ç„¶è€Œï¼Œç”±äºä»¥ä¸‹åŸå› ï¼ŒRust é€‰æ‹©ä¸æ”¯æŒ Consume é¡ºåºï¼š</p><ol type="1"><li><strong>å®ç°å¤æ‚æ€§</strong>ï¼šå¾ˆå¤šç¼–è¯‘å™¨å®ç°è€…å‘ç°æ­£ç¡®å®ç° Consumeè¯­ä¹‰éå¸¸å›°éš¾ã€‚</li><li><strong>æ€§èƒ½æ”¶ç›Šä¸ç¡®å®š</strong>ï¼šåœ¨å®è·µä¸­ï¼Œå¤§å¤šæ•°ç¼–è¯‘å™¨éƒ½å°† Consumeè§†ä¸º Acquire æ¥å¤„ç†ã€‚</li><li><strong>æ ‡å‡†å›°æƒ‘</strong>ï¼šC++ æ ‡å‡†å§”å‘˜ä¼šä¹Ÿæ‰¿è®¤å½“å‰çš„ Consumeè¯­ä¹‰å®šä¹‰å­˜åœ¨é—®é¢˜ï¼Œæ­£åœ¨è€ƒè™‘é‡æ–°è®¾è®¡ã€‚</li></ol><div class="note note-info">            <p>é€‰æ‹©å»ºè®®ï¼š</p><ol type="1"><li><strong>ä¸ç¡®å®šé€‰æ‹©å“ªç§é¡ºåºæ—¶</strong>ï¼š<ul><li>ä½¿ç”¨ SeqCstï¼ˆæœ€å®‰å…¨ä½†æ€§èƒ½æœ€ä½ï¼‰</li><li>æˆ–å’¨è¯¢æœ‰ç»éªŒçš„å¼€å‘è€…</li></ul></li><li><strong>æ€§èƒ½ä¼˜åŒ–æ—¶</strong>ï¼š<ul><li>å…ˆä½¿ç”¨ SeqCst å¼€å‘</li><li>åœ¨æ€§èƒ½æµ‹è¯•åï¼Œæ ¹æ®éœ€è¦é™ä½åˆ° Release/Acquire</li><li>åªæœ‰åœ¨ç¡®å®éœ€è¦æ—¶æ‰ä½¿ç”¨ Relaxed</li></ul></li><li><strong>å¸¸è§ç»„åˆ</strong>ï¼š<ul><li>Release å†™ + Acquire è¯»ï¼šæœ€å¸¸è§çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼</li><li>AcqRelï¼šç”¨äºåŸå­çš„è¯»æ”¹å†™æ“ä½œ</li><li>Relaxedï¼šç”¨äºç®€å•çš„è®¡æ•°å™¨åœºæ™¯</li></ul></li></ol>          </div><p>ä¸‹é¢æˆ‘ä»¬æ¥å¯¹æ¯ç§å†…å­˜é¡ºåºè¿›è¡Œä¸¾ä¾‹é˜è¿°ã€‚</p><h3 id="relaxed">Relaxed</h3><p><code>Relaxed</code>æ˜¯æœ€å®½æ¾çš„å†…å­˜é¡ºåºï¼Œå®ƒåªä¿è¯äº†åŸå­æ“ä½œåœ¨å¹¶å‘ä¸‹çš„å®‰å…¨æ€§ï¼Œä½†ä¸ä¿è¯æ‰§è¡Œé¡ºåºã€‚</p><p>è€ƒè™‘å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">static</span> X: AtomicI32 = AtomicI32::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">0</span>);<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">a</span>() &#123;<br>    X.<span class="hljs-title function_ invoke__">fetch_add</span>(<span class="hljs-number">5</span>, Relaxed);<br>    X.<span class="hljs-title function_ invoke__">fetch_add</span>(<span class="hljs-number">10</span>, Relaxed); <br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">b</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">a</span> = X.<span class="hljs-title function_ invoke__">load</span>(Relaxed);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">b</span> = X.<span class="hljs-title function_ invoke__">load</span>(Relaxed);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">c</span> = X.<span class="hljs-title function_ invoke__">load</span>(Relaxed);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">d</span> = X.<span class="hljs-title function_ invoke__">load</span>(Relaxed);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;a&#125; &#123;b&#125; &#123;c&#125; &#123;d&#125;&quot;</span>);  <span class="hljs-comment">// è¿™ä¸ªè¾“å‡ºä¸ä¸€å®š</span><br>&#125;<br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    thread::<span class="hljs-title function_ invoke__">scope</span>(|s| &#123;<br>        s.<span class="hljs-title function_ invoke__">spawn</span>(a);<br>        s.<span class="hljs-title function_ invoke__">spawn</span>(b);<br>    &#125;);<br><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;:?&#125;&quot;</span>, X.<span class="hljs-title function_ invoke__">load</span>(Relaxed)); <span class="hljs-comment">// æœ€ç»ˆç»“æœä¸€å®šæ˜¯ 15</span><br>&#125;<br></code></pre></td></tr></table></figure><p>åŸºäºæˆ‘ä»¬ä¸Šé¢æåˆ°çš„ <code>sequenced-before</code> è§„åˆ™ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®å®š<code>a</code> å’Œ <code>b</code> ä¸¤ä¸ªçº¿ç¨‹å†…çš„<code>happens-before</code> è§„åˆ™ï¼Œä½†æ˜¯äºŒè€…ä¹‹é—´çš„<code>happens-before</code> æ˜¯æ— æ³•ç¡®å®šçš„ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ç¡®å®šæœ€åçš„ç»“æœæ˜¯<code>15</code>ã€‚ä¸‹å›¾å±•ç¤ºäº†ä¸Šè¿°ä»£ç çš„æ‰§è¡Œé¡ºåºç¤ºæ„å›¾ï¼š</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20241111164259913.png" alt="relaxed-ordering" style="zoom:50%;" /></p><p>è™½ç„¶ä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´çš„ <code>happens-before</code>æ˜¯æ— æ³•ç¡®å®šçš„ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ç¡®å®š <code>X</code>çš„å˜åŒ–é¡ºåºï¼š0â†’5â†’15ã€‚æ‰€ä»¥çº¿ç¨‹ <code>b</code> è¾“å‡º<code>0 0 0 0</code>ã€<code>0 0 5 15</code> å’Œ <code>0 15 15 15</code>éƒ½æ˜¯å¯èƒ½çš„ï¼Œè€Œæ°¸è¿œä¸å¯èƒ½è¾“å‡º <code>0 5 0 15</code> æˆ–<code>0 0 10 15</code> ç±»ä¼¼çš„ç»“æœã€‚</p><p>ä½†æ˜¯å¦‚æœæ˜¯è¿™æ ·å­çš„è¯ï¼Œå°±ä¸ä¸€å®šäº†ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">static</span> X: AtomicI32 = AtomicI32::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">0</span>);<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">a1</span>() &#123;<br>    X.<span class="hljs-title function_ invoke__">fetch_add</span>(<span class="hljs-number">5</span>, Relaxed);<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">a2</span>() &#123;<br>    X.<span class="hljs-title function_ invoke__">fetch_add</span>(<span class="hljs-number">10</span>, Relaxed); <br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">b</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">a</span> = X.<span class="hljs-title function_ invoke__">load</span>(Relaxed);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">b</span> = X.<span class="hljs-title function_ invoke__">load</span>(Relaxed);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">c</span> = X.<span class="hljs-title function_ invoke__">load</span>(Relaxed);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">d</span> = X.<span class="hljs-title function_ invoke__">load</span>(Relaxed);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;a&#125; &#123;b&#125; &#123;c&#125; &#123;d&#125;&quot;</span>);  <span class="hljs-comment">// è¿™ä¸ªè¾“å‡ºä¸ä¸€å®š</span><br>&#125;<br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    thread::<span class="hljs-title function_ invoke__">scope</span>(|s| &#123;<br>        s.<span class="hljs-title function_ invoke__">spawn</span>(a1);<br>      s.<span class="hljs-title function_ invoke__">apawn</span>(a2);<br>        s.<span class="hljs-title function_ invoke__">spawn</span>(b);<br>    &#125;);<br><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;:?&#125;&quot;</span>, X.<span class="hljs-title function_ invoke__">load</span>(Relaxed)); <span class="hljs-comment">// æœ€ç»ˆç»“æœä¸€å®šæ˜¯ 15</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢è¿™ä¸ªä¾‹å­ï¼Œ<code>X</code> çš„å˜åŒ–é¡ºåºå¯ä»¥æ˜¯ 0â†’5â†’15ï¼Œä¹Ÿå¯ä»¥æ˜¯0â†’10â†’15ï¼Œè¿™å–å†³äºå“ªä¸ª <code>fetch_add</code> å…ˆè¢«æ‰§è¡Œã€‚</p><p>å†ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">static</span> DATA: AtomicI32 = AtomicI32::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">static</span> READY: AtomicBool = AtomicBool::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-literal">false</span>);<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    thread::<span class="hljs-title function_ invoke__">scope</span>(|s| &#123;<br>        <span class="hljs-comment">// çº¿ç¨‹ A - å†™å…¥è€…</span><br>        s.<span class="hljs-title function_ invoke__">spawn</span>(|| &#123;<br>            DATA.<span class="hljs-title function_ invoke__">store</span>(<span class="hljs-number">123</span>, Ordering::Relaxed);     <span class="hljs-comment">// â‘  å‡†å¤‡æ•°æ®</span><br>            READY.<span class="hljs-title function_ invoke__">store</span>(<span class="hljs-literal">true</span>, Ordering::Relaxed);   <span class="hljs-comment">// â‘¡ å‘å‡ºæ•°æ®å°±ç»ªä¿¡å·</span><br>        &#125;);<br><br>        <span class="hljs-comment">// çº¿ç¨‹ B - è¯»å–è€…</span><br>        s.<span class="hljs-title function_ invoke__">spawn</span>(|| &#123;<br>            <span class="hljs-keyword">while</span> !READY.<span class="hljs-title function_ invoke__">load</span>(Ordering::Relaxed) &#123;  <span class="hljs-comment">// â‘¢ ç­‰å¾…æ•°æ®å°±ç»ªä¿¡å·</span><br>                thread::<span class="hljs-title function_ invoke__">yield_now</span>();<br>            &#125;<br>            <span class="hljs-built_in">assert_eq!</span>(DATA.<span class="hljs-title function_ invoke__">load</span>(Ordering::Relaxed), <span class="hljs-number">123</span>); <span class="hljs-comment">// â‘£ è·å–æ•°æ®ï¼Œè¿™é‡Œæ–­è¨€ä¸€å®šæˆåŠŸå—ï¼Ÿ</span><br>        &#125;);<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œçº¿ç¨‹ A æ‰§è¡Œäº†ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs rust">DATA.<span class="hljs-title function_ invoke__">store</span>(<span class="hljs-number">123</span>, Ordering::Relaxed);     <span class="hljs-comment">// å‡†å¤‡æ•°æ®</span><br>READY.<span class="hljs-title function_ invoke__">store</span>(<span class="hljs-literal">true</span>, Ordering::Relaxed);   <span class="hljs-comment">// å‘å‡ºæ•°æ®å°±ç»ªä¿¡å·</span><br></code></pre></td></tr></table></figure><p>è¿™æ˜¯ 2 ä¸ªæ²¡æœ‰ä¾èµ–å…³ç³»çš„åŸå­æ“ä½œï¼Œä¸”ä½¿ç”¨çš„æ˜¯ <code>Relaxed</code>å†…å­˜é¡ºåºï¼Œæ‰€ä»¥å¯¹äºçº¿ç¨‹ B æ¥è¯´ï¼Œè¿™ 2ä¸ªæ“ä½œçš„é¡ºåºæ˜¯ä¸ç¡®å®šçš„ã€‚æ‰€ä»¥æ˜¯å¾ˆå¯èƒ½åœ¨<code>READY.load(Ordering::Relaxed)</code> è¿”å› <code>true</code>çš„æ—¶å€™ï¼Œ<code>DATA.load(Ordering::Relaxed)</code> ä¾æ—§è¿˜æ˜¯<code>0</code>ã€‚</p><p>é‚£å¦‚ä½•ç¡®ä¿è¿™ä¸ªæ–­è¨€ä¸€å®šæˆåŠŸå‘¢ï¼Ÿé‚£å°±éœ€è¦â€œå‡çº§â€ä¸€ä¸‹äº†~ è¿™ä¸ªæ—¶å€™å°±è½®åˆ°<code>Release</code> å’Œ <code>Acquire</code> çš„å‡ºåœºäº†ã€‚</p><h3 id="release-acquire">Release &amp; Acquire</h3><p><code>Release</code> å’Œ <code>Acquire</code>ä¸€èˆ¬æˆå¯¹å‡ºç°ï¼Œå®ƒä»¬å…±åŒå»ºç«‹äº†çº¿ç¨‹é—´çš„åŒæ­¥å…³ç³»ï¼š</p><ul><li><code>Release</code>:ä½œç”¨äºå†™æ“ä½œï¼ˆstoreï¼‰ï¼Œç¡®ä¿è¯¥æ“ä½œä¹‹å‰çš„æ‰€æœ‰å†…å­˜è®¿é—®ä¸ä¼šè¢«é‡æ’åˆ°è¿™ä¸ªRelease æ“ä½œä¹‹åã€‚</li><li><code>Acquire</code>:ä½œç”¨äºè¯»æ“ä½œï¼ˆloadï¼‰ï¼Œç¡®ä¿è¯¥æ“ä½œä¹‹åçš„æ‰€æœ‰å†…å­˜è®¿é—®ä¸ä¼šè¢«é‡æ’åˆ°è¿™ä¸ªAcquire æ“ä½œä¹‹å‰ã€‚</li></ul><p>å½“ä¸€ä¸ªçº¿ç¨‹é€šè¿‡ <code>Acquire</code> è¯»å–åˆ°å¦ä¸€ä¸ªçº¿ç¨‹é€šè¿‡<code>Release</code> å†™å…¥çš„å€¼æ—¶ï¼Œä¼šå»ºç«‹ä¸€ä¸ª happens-beforeå…³ç³»ï¼š<strong><font color="orange">çº¿ç¨‹ A ä¸­ Releaseå†™å…¥ä¹‹å‰çš„æ‰€æœ‰å†…å­˜å†™æ“ä½œï¼Œå¯¹äºçº¿ç¨‹ B ä¸­ Acquireè¯»å–ä¹‹åçš„æ‰€æœ‰å†…å­˜è¯»æ“ä½œéƒ½æ˜¯å¯è§çš„</font></strong>ã€‚</p><p>ä¿®æ”¹ä¸€ä¸‹ä¸Šé¢çš„ä¾‹å­ï¼š <figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">static</span> DATA: AtomicI32 = AtomicI32::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">static</span> READY: AtomicBool = AtomicBool::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-literal">false</span>);<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    thread::<span class="hljs-title function_ invoke__">scope</span>(|s| &#123;<br>        s.<span class="hljs-title function_ invoke__">spawn</span>(|| &#123;<br>            DATA.<span class="hljs-title function_ invoke__">store</span>(<span class="hljs-number">123</span>, Ordering::Relaxed);   <br>            READY.<span class="hljs-title function_ invoke__">store</span>(<span class="hljs-literal">true</span>, Ordering::Release);   <span class="hljs-comment">// è¿™é‡Œæ”¹ä¸º release</span><br>        &#125;);<br><br>        s.<span class="hljs-title function_ invoke__">spawn</span>(|| &#123;<br>            <span class="hljs-keyword">while</span> !READY.<span class="hljs-title function_ invoke__">load</span>(Ordering::Acquire) &#123;  <span class="hljs-comment">// è¿™é‡Œæ”¹ä¸º acquire</span><br>                thread::<span class="hljs-title function_ invoke__">yield_now</span>();<br>            &#125;<br>            <span class="hljs-built_in">assert_eq!</span>(DATA.<span class="hljs-title function_ invoke__">load</span>(Ordering::Relaxed), <span class="hljs-number">123</span>); <span class="hljs-comment">// å¿…å®šæˆåŠŸ</span><br>        &#125;);<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure></p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20241111165714772.png" alt="release-acquire-ordering" style="zoom:50%;" /></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼š</p><ol type="1"><li>Release-Acquire åŒæ­¥ç¡®ä¿äº† <code>READY</code> çš„å†™å…¥å’Œè¯»å–ä¹‹é—´å»ºç«‹äº†happens-before å…³ç³»</li><li>ç”±äº <code>DATA</code> çš„å†™å…¥åœ¨ <code>READY</code> çš„ Releaseå†™å…¥ä¹‹å‰ï¼Œè€Œ <code>DATA</code> çš„è¯»å–åœ¨ <code>READY</code> çš„ Acquireè¯»å–ä¹‹å</li><li>å› æ­¤å¯ä»¥ä¿è¯çº¿ç¨‹ B ä¸€å®šèƒ½çœ‹åˆ°çº¿ç¨‹ A å†™å…¥çš„å€¼ 123</li></ol><p>æ›´è¿›ä¸€æ­¥ï¼Œæˆ‘ä»¬é€šè¿‡è§‚å¯Ÿï¼Œå¯ä»¥å‘ç° <code>DATA</code> éƒ½æ²¡å¿…è¦ä½¿ç”¨<code>Atomic</code> ç±»å‹ï¼Œå› ä¸ºç”± <code>READY</code> å»ºè®®çš„<code>happens-before</code> è§„åˆ™å·²ç»èƒ½ä¿è¯å¯¹ <code>DATA</code>çš„è¯»å†™ä¸å¯èƒ½å¹¶å‘æ‰§è¡Œäº†ã€‚ä¸è¿‡å› ä¸º Rustçš„ç±»å‹ç³»ç»Ÿå¹¶ä¸å…è®¸è·¨çº¿ç¨‹è¿›è¡ŒéåŸå­ç±»å‹çš„è¯»å†™æ“ä½œï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨<code>unsafe</code>æ‰èƒ½ä½¿ç¼–è¯‘é€šè¿‡ï¼Œä½†é€šè¿‡æˆ‘ä»¬ä¹‹å‰çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿ä¸‹é¢è¿™æ®µä»£ç æ˜¯å®‰å…¨çš„ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">static</span> <span class="hljs-keyword">mut</span> DATA: <span class="hljs-type">u64</span> = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">static</span> READY: AtomicBool = AtomicBool::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-literal">false</span>);<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    thread::<span class="hljs-title function_ invoke__">spawn</span>(|| &#123;<br>        <span class="hljs-comment">// Safety: æ­¤æ—¶æ²¡æœ‰å…¶ä»–çº¿ç¨‹è®¿é—® DATAï¼Œ</span><br>        <span class="hljs-comment">// å› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰è®¾ç½® READY æ ‡å¿—</span><br>        <span class="hljs-keyword">unsafe</span> &#123; DATA = <span class="hljs-number">123</span> &#125;;<br>        READY.<span class="hljs-title function_ invoke__">store</span>(<span class="hljs-literal">true</span>, Release); <span class="hljs-comment">// åœ¨è¿™ä¸ªå­˜å‚¨æ“ä½œä¹‹å‰çš„æ‰€æœ‰å†…å­˜æ“ä½œ ..</span><br>    &#125;);<br>    <span class="hljs-keyword">while</span> !READY.<span class="hljs-title function_ invoke__">load</span>(Acquire) &#123; <span class="hljs-comment">// .. åœ¨è¿™ä¸ªåŠ è½½æ“ä½œè¿”å› true åéƒ½æ˜¯å¯è§çš„</span><br>        thread::<span class="hljs-title function_ invoke__">sleep</span>(Duration::<span class="hljs-title function_ invoke__">from_millis</span>(<span class="hljs-number">100</span>));<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;waiting...&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// Safety: æ²¡æœ‰çº¿ç¨‹ä¼šä¿®æ”¹ DATAï¼Œå› ä¸º READY å·²ç»è¢«è®¾ç½®</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, <span class="hljs-keyword">unsafe</span> &#123; DATA &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><div class="note note-info">            <h3 id="é‡Šæ”¾åºåˆ—release-sequence">é‡Šæ”¾åºåˆ—ï¼ˆRelease Sequenceï¼‰</h3><p>æˆ‘ä»¬å†æ¥çœ‹ä¸€æ®µä»£ç ç¤ºä¾‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> std::&#123;sync::atomic::AtomicU8, thread&#125;;<br><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">mut</span> DATA: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">i64</span>&gt; = <span class="hljs-built_in">vec!</span>[];<br><span class="hljs-keyword">static</span> FLAG: AtomicU8 = AtomicU8::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">0</span>);<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">thread_1</span>() &#123;<br>    <span class="hljs-keyword">unsafe</span> &#123;<br>        DATA.<span class="hljs-title function_ invoke__">push</span>(<span class="hljs-number">42</span>);<br>    &#125;<br>    FLAG.<span class="hljs-title function_ invoke__">store</span>(<span class="hljs-number">1</span>, std::sync::atomic::Ordering::Release);<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">thread_2</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">expected</span> = <span class="hljs-number">1</span>;<br>    <span class="hljs-comment">// memory_order_relaxed is okay because this is an RMW,</span><br>    <span class="hljs-comment">// and RMWs (with any ordering) following a release form a release sequence</span><br>    <span class="hljs-keyword">while</span> FLAG<br>        .<span class="hljs-title function_ invoke__">compare_exchange</span>(<br>            expected,<br>            <span class="hljs-number">2</span>,<br>            std::sync::atomic::Ordering::Relaxed,<br>            std::sync::atomic::Ordering::Relaxed,<br>        )<br>        .<span class="hljs-title function_ invoke__">is_err</span>()<br>    &#123;<br>        expected = <span class="hljs-number">1</span><br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">thread_3</span>() &#123;<br>    <span class="hljs-keyword">while</span> FLAG.<span class="hljs-title function_ invoke__">load</span>(std::sync::atomic::Ordering::Acquire) &lt; <span class="hljs-number">2</span> &#123;&#125;<br>    <span class="hljs-comment">// if we read the value 2 from the atomic flag, we see 42 in the vector</span><br>    <span class="hljs-keyword">unsafe</span> &#123;<br>        <span class="hljs-built_in">assert_eq!</span>(DATA[<span class="hljs-number">0</span>], <span class="hljs-number">42</span>); <span class="hljs-comment">// will never fire</span><br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    thread::<span class="hljs-title function_ invoke__">scope</span>(|s| &#123;<br>        s.<span class="hljs-title function_ invoke__">spawn</span>(thread_1);<br>        s.<span class="hljs-title function_ invoke__">spawn</span>(thread_2);<br>        s.<span class="hljs-title function_ invoke__">spawn</span>(thread_3);<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ®µä»£ç æ˜¯å‚è€ƒ <ahref="https://en.cppreference.com/w/cpp/atomic/memory_order">cppreference</a>è€Œç¿»è¯‘æˆ Rust ä»£ç çš„ï¼Œåœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œå³ä½¿ <code>thread_2</code>ä¸­æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ <code>Relaxed</code>ï¼Œ è¿™æ®µä»£ç ä¸­çš„<code>assert_eq!(DATA[0], 42)</code>ä¹Ÿæ˜¯ä¸€å®šæˆåŠŸçš„ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿè¿™æ¶‰åŠåˆ°ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µâ€”â€”<strong>é‡Šæ”¾åºåˆ—ï¼ˆReleaseSequenceï¼‰</strong>ï¼š</p><ul><li>å½“ä¸€ä¸ª <code>release</code>æ“ä½œåé¢è·Ÿç€ä¸€ç³»åˆ—çš„åŸå­<code>"è¯»-ä¿®æ”¹-å†™"(RMW)</code>æ“ä½œæ—¶ï¼Œè¿™äº›æ“ä½œä¼šå½¢æˆä¸€ä¸ªé‡Šæ”¾åºåˆ—ã€‚</li><li>åœ¨è¿™ä¸ªåºåˆ—ä¸­ï¼Œåç»­çš„ RMW æ“ä½œ<strong>ä¸éœ€è¦</strong>ä½¿ç”¨ release æˆ–acquire è¯­ä¹‰ä¹Ÿèƒ½ä¿è¯åŒæ­¥ã€‚</li></ul><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼šå½“ <code>thread_2</code> çš„ <code>RMW</code>æ“ä½œæˆåŠŸçš„æ—¶å€™ï¼Œè¯´æ˜ <code>FLAG</code> æ˜¯ <code>1</code>ï¼Œå³<code>thread_1</code> å·²ç»æ‰§è¡Œäº† <code>release</code>æ“ä½œï¼Œè¿™ä¸ªæ—¶å€™ï¼š</p><ol type="1"><li><code>thread_1</code> çš„ <code>release</code> æ“ä½œå»ºç«‹äº†åŒæ­¥ç‚¹</li><li><code>thread_2</code> çš„ <code>RMW</code>æ“ä½œè‡ªåŠ¨æˆä¸ºé‡Šæ”¾åºåˆ—çš„ä¸€éƒ¨åˆ†</li><li>å½“ <code>thread_3</code> é€šè¿‡ <code>acquire</code> çœ‹åˆ°å€¼ 2æ—¶ï¼Œå®ƒèƒ½çœ‹åˆ°æ•´ä¸ªé‡Šæ”¾åºåˆ—çš„æ‰€æœ‰ä¿®æ”¹ã€‚</li><li>å› æ­¤èƒ½ä¿è¯çœ‹åˆ° <code>DATA</code> ä¸­çš„ 42ã€‚</li></ol><p>æ‰€ä»¥åœ¨è¿™ç§åœºæ™¯ä¸‹ä½¿ç”¨ <code>relaxed</code> æ—¢å®‰å…¨åˆé«˜æ•ˆï¼Œå› ä¸ºï¼š</p><ul><li>å®ƒæ˜¯é‡Šæ”¾åºåˆ—çš„ä¸€éƒ¨åˆ†</li><li>ä¸éœ€è¦é¢å¤–çš„åŒæ­¥å¼€é”€</li><li>ä»ç„¶èƒ½ä¿è¯æ­£ç¡®çš„å†…å­˜é¡ºåº</li></ul><p>ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡å‘¢ï¼Ÿ</p><ul><li><strong>åŸå­æ€§ä¿è¯</strong>ï¼šRMWæ“ä½œæœ¬èº«å°±æ˜¯åŸå­çš„ï¼Œä¸ä¼šäº§ç”Ÿæ•°æ®ç«äº‰</li><li><strong>è¿ç»­æ€§</strong>ï¼šæ¯ä¸ª RMWæ“ä½œéƒ½ç›´æ¥æˆ–é—´æ¥åœ°åŸºäºå‰ä¸€ä¸ªæ“ä½œçš„ç»“æœ</li><li><strong>å› æœå…³ç³»</strong>ï¼šå½¢æˆäº†ä¸€ä¸ªæ¸…æ™°çš„ä¿®æ”¹é“¾æ¡</li><li><strong>æ€§èƒ½è€ƒè™‘</strong>ï¼šä¸­é—´çš„ RMW æ“ä½œä¸éœ€è¦é¢å¤–çš„åŒæ­¥å¼€é”€</li></ul>          </div><h3 id="sequentially-consistent">Sequentially Consistent</h3><p><code>SeqCst</code> æ˜¯æœ€ä¸¥æ ¼çš„å†…å­˜é¡ºåºï¼Œå®ƒåŒ…æ‹¬è·å–<code>release</code> å’Œ <code>acquire</code>çš„æ‰€æœ‰ä¿è¯ï¼Œè¿˜ä¿è¯äº†å…¨å±€ä¸€è‡´çš„æ“ä½œé¡ºåºã€‚ç®€å•ç†è§£å°±æ˜¯ï¼Œä½ ä»£ç çš„é¡ºåºæ˜¯æ€ä¹ˆæ ·ï¼Œå®é™…çš„æ‰§è¡Œé¡ºåºå°±æ˜¯ä»€ä¹ˆæ ·ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹ä¸€æ®µä»£ç ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> std::sync::atomic::Ordering::SeqCst;<br><br><span class="hljs-keyword">static</span> A: AtomicBool = AtomicBool::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-literal">false</span>);<br><span class="hljs-keyword">static</span> B: AtomicBool = AtomicBool::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-literal">false</span>);<br><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">mut</span> S: <span class="hljs-type">String</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">new</span>();<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">a</span> = thread::<span class="hljs-title function_ invoke__">spawn</span>(|| &#123;<br>        A.<span class="hljs-title function_ invoke__">store</span>(<span class="hljs-literal">true</span>, SeqCst);<br>        <span class="hljs-keyword">if</span> !B.<span class="hljs-title function_ invoke__">load</span>(SeqCst) &#123;<br>            <span class="hljs-keyword">unsafe</span> &#123; S.<span class="hljs-title function_ invoke__">push</span>(<span class="hljs-string">&#x27;!&#x27;</span>) &#125;;<br>        &#125;<br>    &#125;);<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">b</span> = thread::<span class="hljs-title function_ invoke__">spawn</span>(|| &#123;<br>        B.<span class="hljs-title function_ invoke__">store</span>(<span class="hljs-literal">true</span>, SeqCst);<br>        <span class="hljs-keyword">if</span> !A.<span class="hljs-title function_ invoke__">load</span>(SeqCst) &#123;<br>            <span class="hljs-keyword">unsafe</span> &#123; S.<span class="hljs-title function_ invoke__">push</span>(<span class="hljs-string">&#x27;!&#x27;</span>) &#125;;<br>        &#125;<br>    &#125;);<br><br>    a.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br>    b.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œä¸¤ä¸ªçº¿ç¨‹éƒ½æ˜¯å¸Œæœ›å°†è‡ªå·±çš„åŸå­å˜é‡è®¾ç½®ä¸º<code>true</code>ï¼Œä»è€Œé˜»æ­¢å¦å¤–ä¸€ä¸ªçº¿ç¨‹å¯¹ <code>S</code> è¿›è¡Œ<code>push</code> æ“ä½œï¼Œå…¶å®å°±ç±»ä¼¼äºé”ã€‚å› ä¸ºè¿™é‡Œä½¿ç”¨äº†<code>SeqCst</code>ï¼Œæ‰€ä»¥ä»£ç çš„æ‰§è¡Œé¡ºåºæ˜¯è·Ÿä»£ç ç¼–å†™é¡ºåºæ˜¯ä¸€è‡´çš„ï¼Œé‚£ä¹ˆå°±å¯èƒ½å‡ºç°ä»¥ä¸‹3 ç§æ‰§è¡Œæƒ…å†µï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20241112113535084.png"alt="seqcst-memory-order" /><figcaption aria-hidden="true">seqcst-memory-order</figcaption></figure><p>å³ï¼šåŒä¸€æ—¶åˆ»ï¼Œ<strong>æœ€å¤š</strong>åªå¯èƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šå¯¹<code>S</code> è¿›è¡Œæ“ä½œã€‚</p><h1 id="å†…å­˜å±éšœ">å†…å­˜å±éšœ</h1><p>é™¤äº†å†…å­˜é¡ºåºï¼ˆMemoryOrderï¼‰ï¼Œè¿˜æœ‰å¦å¤–ä¸€ç§æ–¹å¼å¯ä»¥æ§åˆ¶ç¨‹åºçš„æ‰§è¡Œé¡ºåºï¼Œå°±æ˜¯å†…å­˜å±éšœï¼ˆMemoryBarrierï¼‰ã€‚å†…å­˜å±éšœæ˜¯ä¸€ç§åº•å±‚çš„åŒæ­¥åŸè¯­ï¼Œå®ƒèƒ½å¼ºåˆ¶å¤„ç†å™¨æŒ‰ç…§ç‰¹å®šçš„é¡ºåºæ‰§è¡Œå†…å­˜æ“ä½œã€‚å†…å­˜å±éšœé€šè¿‡é˜»æ­¢æˆ–é™åˆ¶æŒ‡ä»¤é‡æ’åºï¼Œæ¥ç¡®ä¿å†…å­˜æ“ä½œçš„å¯è§æ€§å’Œé¡ºåºæ€§ã€‚</p><h2 id="åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ</h2><p>å†…å­˜å±éšœä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ç§ç±»å‹ï¼š</p><ol type="1"><li><strong>Load Barrierï¼ˆè¯»å±éšœï¼‰</strong><ul><li>ç¡®ä¿åœ¨å±éšœä¹‹å‰çš„æ‰€æœ‰è¯»æ“ä½œéƒ½æ‰§è¡Œå®Œæˆ</li><li>é˜²æ­¢åç»­è¯»æ“ä½œè¢«é‡æ’åˆ°å±éšœä¹‹å‰</li><li>å¯¹åº” Acquire è¯­ä¹‰</li></ul></li><li><strong>Store Barrierï¼ˆå†™å±éšœï¼‰</strong><ul><li>ç¡®ä¿åœ¨å±éšœä¹‹å‰çš„æ‰€æœ‰å†™æ“ä½œéƒ½æ‰§è¡Œå®Œæˆ</li><li>é˜²æ­¢åç»­å†™æ“ä½œè¢«é‡æ’åˆ°å±éšœä¹‹å‰</li><li>å¯¹åº” Release è¯­ä¹‰</li></ul></li><li><strong>Full Barrierï¼ˆå…¨å±éšœï¼‰</strong><ul><li>åŒæ—¶åŒ…å«è¯»å±éšœå’Œå†™å±éšœçš„åŠŸèƒ½</li><li>é˜²æ­¢ä»»ä½•å†…å­˜æ“ä½œçš„é‡æ’åº</li><li>å¯¹åº” SeqCst è¯­ä¹‰</li></ul></li></ol><p>å³ä¸‹é¢è¿™ 2 ç§å®ç°æ–¹å¼æ˜¯ç­‰ä»·çš„ï¼š</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20241112123652784.png" alt="fench" style="zoom:50%;" /></p><p>æ‰€ä»¥åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥æ›´å¥½åœ°ç†è§£<strong>ä¸ºä»€ä¹ˆ <code>release</code>æ˜¯é˜»æ­¢å…¶å‰é¢çš„å†…å­˜è®¿é—®è¶Šè¿‡å®ƒï¼Œè€Œ <code>acquire</code>æ˜¯é˜»æ­¢å…¶åé¢çš„å†…å­˜è®¿é—®è¶Šè¿‡å®ƒäº†</strong>ã€‚å› ä¸ºæœ‰ä¸ª <code>fence</code>åœ¨å‰é¢æˆ–åé¢æ‹¦ç€ï¼</p><p>ä½†æ˜¯ä¸€èˆ¬æ¥è¯´ï¼Œä¸‹é¢çš„å†™æ³•ç›¸æ¯”ä¸Šé¢çš„å†™æ³•ä¼šæœ‰ä¸€ä¸¢ä¸¢çš„æ€§èƒ½æŸå¤±ï¼Œå› ä¸ºè¿™ä¼šå¢åŠ ä¸€äº›é¢å¤–çš„å¤„ç†æŒ‡ä»¤ã€‚é‚£<code>fence</code> çš„ç”¨æ­¦ä¹‹åœ°æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><ol type="1"><li>å¯ä»¥åŒæ—¶å¯¹å¤šä¸ªåŸå­æ“ä½œè¿›è¡Œ <code>fench</code>ï¼›</li><li>å¯ä»¥æ ¹æ®æ¡ä»¶åˆ¤æ–­ï¼Œé€‰æ‹©æ˜¯å¦è¿›è¡Œ <code>fench</code>ã€‚</li></ol><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20241112125023036.png" alt="fence-multi-atomics" style="zoom:50%;" /></p><p>è¿™ä¸ªä¾‹å­çš„å…³é”®ç‚¹æ˜¯ï¼š</p><ol type="1"><li>å¦‚æœçº¿ç¨‹ 2 ä¸­çš„ä»»ä½•ä¸€ä¸ª load æ“ä½œè§‚å¯Ÿåˆ°äº†çº¿ç¨‹ 1 ä¸­å¯¹åº”çš„ storeæ“ä½œçš„å€¼ï¼š<ul><li>æ¯”å¦‚ A.load() è¯»åˆ°äº†å€¼ 1ï¼Œæˆ–</li><li>B.load() è¯»åˆ°äº†å€¼ 2ï¼Œæˆ–</li><li>C.load() è¯»åˆ°äº†å€¼ 3</li></ul></li><li>é‚£ä¹ˆï¼šçº¿ç¨‹ 1 ä¸­çš„ release fence å°±ä¼š happens-before çº¿ç¨‹ 2 ä¸­çš„acquire fenceã€‚è¿™æ„å‘³ç€çº¿ç¨‹ 1 ä¸­ release fence ä¹‹å‰çš„æ‰€æœ‰å†…å­˜æ“ä½œå¯¹çº¿ç¨‹2 ä¸­ acquire fence ä¹‹åçš„æ“ä½œéƒ½æ˜¯å¯è§çš„ã€‚</li></ol><p>è¿™å±•ç¤ºäº†å†…å­˜å±éšœçš„ä¸€ä¸ªé‡è¦ä¼˜åŠ¿ï¼š<strong>ä¸€ä¸ªå±éšœå¯ä»¥åŒæ—¶ä¸ºå¤šä¸ªåŸå­æ“ä½œå»ºç«‹åŒæ­¥å…³ç³»ï¼Œè€Œä¸éœ€è¦åœ¨æ¯ä¸ªåŸå­æ“ä½œä¸Šéƒ½ä½¿ç”¨Release/Acquire å†…å­˜åºã€‚è¿™åœ¨æŸäº›åœºæ™¯ä¸‹å¯èƒ½ä¼šæ›´é«˜æ•ˆã€‚</strong></p><p>ç”¨æ›´é€šä¿—çš„è¯è¯´ï¼šè¿™å°±åƒåœ¨çº¿ç¨‹ 1 è®¾ç½®äº†ä¸€ä¸ª"æ£€æŸ¥ç‚¹"ï¼ˆreleasefenceï¼‰ï¼Œåœ¨çº¿ç¨‹ 2 ä¹Ÿè®¾ç½®äº†ä¸€ä¸ª"æ£€æŸ¥ç‚¹"ï¼ˆacquire fenceï¼‰ï¼Œåªè¦çº¿ç¨‹ 2çœ‹åˆ°äº†çº¿ç¨‹ 1 åœ¨å…¶æ£€æŸ¥ç‚¹ä¹‹ååšçš„ä»»ä½•ä¸€ä¸ªæ”¹åŠ¨ï¼Œé‚£ä¹ˆçº¿ç¨‹ 1æ£€æŸ¥ç‚¹ä¹‹å‰çš„æ‰€æœ‰æ“ä½œå¯¹çº¿ç¨‹ 2 çš„æ£€æŸ¥ç‚¹ä¹‹åéƒ½æ˜¯å¯è§çš„ã€‚</p><h2 id="ç¡¬ä»¶å®ç°">ç¡¬ä»¶å®ç°</h2><p>ä¸åŒçš„å¤„ç†å™¨æ¶æ„å®ç°å†…å­˜å±éšœçš„æ–¹å¼ä¸åŒï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs assembly">; x86/x64<br>MFENCE  ; å…¨å±éšœ<br>LFENCE  ; è¯»å±éšœ<br>SFENCE  ; å†™å±éšœ<br><br>; ARM<br>DMB     ; æ•°æ®å†…å­˜å±éšœ<br>DSB     ; æ•°æ®åŒæ­¥å±éšœ<br>ISB     ; æŒ‡ä»¤åŒæ­¥å±éšœ<br></code></pre></td></tr></table></figure><h2 id="ä¸å†…å­˜é¡ºåºçš„å…³ç³»">ä¸å†…å­˜é¡ºåºçš„å…³ç³»</h2><p>Rust çš„å†…å­˜é¡ºåºå®é™…ä¸Šæ˜¯é€šè¿‡å†…å­˜å±éšœæ¥å®ç°çš„ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// Release å†™å…¥ä¼šæ’å…¥ Store Barrier</span><br>atomic.<span class="hljs-title function_ invoke__">store</span>(<span class="hljs-number">42</span>, Ordering::Release);  <span class="hljs-comment">// ç¼–è¯‘å™¨ä¼šåœ¨æ­¤å¤„æ’å…¥ Store Barrier</span><br><br><span class="hljs-comment">// Acquire è¯»å–ä¼šæ’å…¥ Load Barrier</span><br><span class="hljs-keyword">let</span> <span class="hljs-variable">x</span> = atomic.<span class="hljs-title function_ invoke__">load</span>(Ordering::Acquire);  <span class="hljs-comment">// ç¼–è¯‘å™¨ä¼šåœ¨æ­¤å¤„æ’å…¥ Load Barrier</span><br><br><span class="hljs-comment">// SeqCst æ“ä½œä¼šæ’å…¥ Full Barrier</span><br>atomic.<span class="hljs-title function_ invoke__">store</span>(<span class="hljs-number">42</span>, Ordering::SeqCst);  <span class="hljs-comment">// ç¼–è¯‘å™¨ä¼šåœ¨æ­¤å¤„æ’å…¥ Full Barrier</span><br></code></pre></td></tr></table></figure><div class="note note-warning">            <p>æ³¨æ„ï¼šç›´æ¥ä½¿ç”¨å†…å­˜å±éšœæ˜¯éå¸¸åº•å±‚çš„æ“ä½œï¼Œé€šå¸¸æˆ‘ä»¬åº”è¯¥ä½¿ç”¨ Rustæä¾›çš„é«˜çº§æŠ½è±¡ï¼ˆå¦‚åŸå­ç±»å‹å’Œå®ƒä»¬çš„å†…å­˜é¡ºåºï¼‰æ¥å®ç°åŒæ­¥ã€‚å†…å­˜å±éšœçš„çŸ¥è¯†ä¸»è¦ç”¨äºç†è§£è¿™äº›é«˜çº§æŠ½è±¡çš„å·¥ä½œåŸç†ã€‚</p>          </div><h1 id="go-atomic">Go Atomic</h1><p>ç†Ÿæ‚‰ Go è¯­è¨€çš„è¯»è€…åº”è¯¥ä¼šæ„è¯†åˆ°åœ¨ä½¿ç”¨ Goè¯­è¨€çš„åŸå­ç±»å‹çš„æ—¶å€™ï¼Œå¥½åƒéƒ½æ²¡è§è¿‡ Memory Order è¿™ä¸ªä¸œè¥¿ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;sync/atomic&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>data := atomic.Int64&#123;&#125;<br>data.Add(<span class="hljs-number">1</span>)<br>data.And(<span class="hljs-number">2</span>)<br>data.Or(<span class="hljs-number">3</span>)<br>data.Swap(<span class="hljs-number">4</span>)<br>data.Store(<span class="hljs-number">5</span>)<br>data.Load()<br>data.CompareAndSwap(<span class="hljs-number">6</span>, <span class="hljs-number">7</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ <ahref="https://github.com/golang/go/blob/release-branch.go1.23/src/sync/atomic/doc.go">atomic/doc.go</a>æºç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™æ®µè¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// The load and store operations, implemented by the LoadT and StoreT</span><br><span class="hljs-comment">// functions, are the atomic equivalents of &quot;return *addr&quot; and</span><br><span class="hljs-comment">// &quot;*addr = val&quot;.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// In the terminology of [the Go memory model], if the effect of</span><br><span class="hljs-comment">// an atomic operation A is observed by atomic operation B,</span><br><span class="hljs-comment">// then A â€œsynchronizes beforeâ€ B.</span><br><span class="hljs-comment">// Additionally, all the atomic operations executed in a program</span><br><span class="hljs-comment">// behave as though executed in some sequentially consistent order.</span><br><span class="hljs-comment">// This definition provides the same semantics as</span><br><span class="hljs-comment">// C++&#x27;s sequentially consistent atomics and Java&#x27;s volatile variables.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// [the Go memory model]: https://go.dev/ref/mem</span><br></code></pre></td></tr></table></figure><p>Goè¯­è¨€è®¾è®¡è€…è®¤ä¸ºè®©ç¨‹åºå‘˜é€‰æ‹©å†…å­˜åºä¼šå¢åŠ å¤æ‚æ€§å’Œå‡ºé”™çš„å¯èƒ½ï¼Œæ‰€ä»¥ä¸ºäº†ç¨‹åºçš„ç®€å•æ€§å’Œå¯é¢„æµ‹æ€§ï¼Œç›´æ¥å°±<strong>ä½¿ç”¨äº†æœ€å®‰å…¨çš„<code>Seq-Cst</code> å†…å­˜é¡ºåº</strong>äº†ã€‚</p><p><a href="https://go.dev/ref/mem">the Go memory model</a>ä¸­è¿˜æäº†ä¸€å¥ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">If you must read the rest of this document to understand the behavior of your program, you are being too clever.<br>Don&#x27;t be clever.<br></code></pre></td></tr></table></figure><p>è¿™ä¹Ÿå‘¼åº”äº† Go çš„è®¾è®¡ç†å¿µï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">Share memory by communicating; don&#x27;t communicate by sharing memory.<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥æ€»ç»“ä¸€ä¸‹ï¼š</p><ol type="1"><li>Go çš„åŸå­æ“ä½œé‡‡ç”¨äº†æœ€å¼ºçš„é¡ºåºä¸€è‡´æ€§å†…å­˜åºï¼›</li><li>è¿™æ˜¯ä¸€ä¸ªæœ‰æ„è¯†çš„è®¾è®¡é€‰æ‹©ï¼Œä¸ºäº†ç®€å•æ€§å’Œå¯é¢„æµ‹æ€§ï¼›</li><li>å¦‚æœä½ éœ€è¦æ›´ç»†ç²’åº¦çš„å†…å­˜åºæ§åˆ¶ï¼Œé‚£ä¹ˆ Go å¯èƒ½ä¸æ˜¯æœ€ä½³é€‰æ‹©ï¼›</li><li>Go æ›´æ¨èä½¿ç”¨ channels å’Œå…¶ä»–åŒæ­¥åŸè¯­æ¥è¿›è¡Œå¹¶å‘æ§åˆ¶ã€‚</li></ol><h1 id="å‚è€ƒ">å‚è€ƒ</h1><ul><li><a href="https://marabos.nl/atomics/memory-ordering.html">RustAtomics And Lock</a></li><li><ahref="https://mp.weixin.qq.com/s/t5_Up2YZEZt1NLbvgYz9FQ">èŠä¸€èŠå†…å­˜æ¨¡å‹ä¸å†…å­˜åº</a></li><li><ahref="https://en.cppreference.com/w/cpp/atomic/memory_order">cppreference</a></li><li><a href="https://go.dev/ref/mem">the Go memory model</a></li></ul>]]></content>
    
    
    <summary type="html">æœ¬æ–‡æ·±å…¥æ¢è®¨äº† Rust ä¸­çš„åŸå­æ“ä½œå’Œå†…å­˜é¡ºåºæ¨¡å‹ã€‚ä»ç¡¬ä»¶å±‚é¢çš„åŸå­æ“ä½œå®ç°åŸç†å‡ºå‘,è¯¦ç»†ä»‹ç»äº† Rust æä¾›çš„å„ç§åŸå­ç±»å‹åŠå…¶æ“ä½œ,å¹¶é‡ç‚¹é˜è¿°äº†å†…å­˜é¡ºåº(Memory Ordering)çš„æ¦‚å¿µã€åˆ†ç±»åŠå…¶åœ¨å¹¶å‘ç¼–ç¨‹ä¸­çš„åº”ç”¨ã€‚é€šè¿‡å¤§é‡ç¤ºä¾‹ä»£ç å’Œå›¾è§£,å¸®åŠ©è¯»è€…å…¨é¢ç†è§£ Rust çš„å†…å­˜æ¨¡å‹å’Œå¹¶å‘å®‰å…¨æœºåˆ¶ã€‚</summary>
    
    
    
    <category term="Rust" scheme="https://hedon.top/categories/Rust/"/>
    
    <category term="Rust åº•å±‚åŸç†" scheme="https://hedon.top/categories/Rust/Rust-%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/"/>
    
    
    <category term="Go" scheme="https://hedon.top/tags/Go/"/>
    
    <category term="Rust" scheme="https://hedon.top/tags/Rust/"/>
    
    <category term="å†…å­˜é¡ºåº" scheme="https://hedon.top/tags/%E5%86%85%E5%AD%98%E9%A1%BA%E5%BA%8F/"/>
    
    <category term="å†…å­˜å±éšœ" scheme="https://hedon.top/tags/%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C/"/>
    
    <category term="å¹¶å‘æ§åˆ¶" scheme="https://hedon.top/tags/%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/"/>
    
    <category term="Atomic" scheme="https://hedon.top/tags/Atomic/"/>
    
    <category term="Happens-Before" scheme="https://hedon.top/tags/Happens-Before/"/>
    
  </entry>
  
  <entry>
    <title>Rust å®æˆ˜ä¸¨SSE(Server-Sent Events)</title>
    <link href="https://hedon.top/2024/06/06/rust-action-sse/"/>
    <id>https://hedon.top/2024/06/06/rust-action-sse/</id>
    <published>2024-06-06T13:30:51.000Z</published>
    <updated>2024-06-06T13:40:05.329Z</updated>
    
    <content type="html"><![CDATA[<p>ğŸ“Œ SSEï¼ˆServer-SentEventsï¼‰æ˜¯ä¸€ç§å…è®¸æœåŠ¡å™¨å‘å®¢æˆ·ç«¯æµè§ˆå™¨æ¨é€ä¿¡æ¯çš„æŠ€æœ¯ã€‚å®ƒæ˜¯ HTML5çš„ä¸€éƒ¨åˆ†ï¼Œä¸“é—¨ç”¨äºå»ºç«‹ä¸€ä¸ªå•å‘çš„ä»æœåŠ¡å™¨åˆ°å®¢æˆ·ç«¯çš„é€šä¿¡è¿æ¥ã€‚SSEçš„ä½¿ç”¨åœºæ™¯éå¸¸å¹¿æ³›ï¼ŒåŒ…æ‹¬å®æ—¶æ¶ˆæ¯æ¨é€ã€å®æ—¶é€šçŸ¥æ›´æ–°ç­‰ã€‚</p><h1 id="sse-çš„æœ¬è´¨">SSE çš„æœ¬è´¨</h1><p>ä¸¥æ ¼åœ°è¯´ï¼Œ<ahref="https://en.wikipedia.org/wiki/HTTP">HTTP</a>æ— æ³•åšåˆ°æœåŠ¡å™¨ä¸»åŠ¨æ¨é€ä¿¡æ¯ã€‚ä½†æ˜¯ï¼Œæœ‰ä¸€ç§å˜é€šæ–¹æ³•ï¼Œå°±æ˜¯æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å£°æ˜ï¼Œæ¥ä¸‹æ¥è¦å‘é€çš„æ˜¯æµä¿¡æ¯ï¼ˆstreamingï¼‰ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå‘é€çš„ä¸æ˜¯ä¸€æ¬¡æ€§çš„æ•°æ®åŒ…ï¼Œè€Œæ˜¯ä¸€ä¸ªæ•°æ®æµï¼Œä¼šè¿ç»­ä¸æ–­åœ°å‘é€è¿‡æ¥ã€‚è¿™æ—¶ï¼Œå®¢æˆ·ç«¯ä¸ä¼šå…³é—­è¿æ¥ï¼Œä¼šä¸€ç›´ç­‰ç€æœåŠ¡å™¨å‘è¿‡æ¥çš„æ–°çš„æ•°æ®æµï¼Œè§†é¢‘æ’­æ”¾å°±æ˜¯è¿™æ ·çš„ä¾‹å­ã€‚æœ¬è´¨ä¸Šï¼Œè¿™ç§é€šä¿¡å°±æ˜¯ä»¥æµä¿¡æ¯çš„æ–¹å¼ï¼Œå®Œæˆä¸€æ¬¡ç”¨æ—¶å¾ˆé•¿çš„ä¸‹è½½ã€‚</p><p>SSE å°±æ˜¯åˆ©ç”¨è¿™ç§æœºåˆ¶ï¼Œä½¿ç”¨æµä¿¡æ¯å‘æµè§ˆå™¨æ¨é€ä¿¡æ¯ã€‚å®ƒåŸºäº HTTPåè®®ï¼Œç›®å‰é™¤äº† IE/Edgeï¼Œå…¶ä»–æµè§ˆå™¨éƒ½æ”¯æŒã€‚</p><h1 id="ç‰¹ç‚¹">ç‰¹ç‚¹</h1><ol type="1"><li><strong>æŒç»­è¿æ¥</strong>ï¼šä¸ä¼ ç»Ÿçš„ HTTP è¯·æ±‚ä¸åŒï¼ŒSSEä¿æŒè¿æ¥å¼€æ”¾ï¼ŒæœåŠ¡å™¨å¯ä»¥éšæ—¶å‘é€æ¶ˆæ¯ã€‚</li><li><strong>æ–‡æœ¬æ•°æ®æµ</strong>ï¼šSSEä¸»è¦ä¼ è¾“æ–‡æœ¬æ•°æ®ï¼Œè¿™äº›æ•°æ®ä»¥ç‰¹å®šçš„æ ¼å¼æµå¼ä¼ è¾“ï¼Œä½¿å¾—æ¯æ¡æ¶ˆæ¯éƒ½æ˜¯ç®€å•çš„æ–‡æœ¬æ ¼å¼ã€‚</li><li><strong>å†…ç½®é‡è¿æœºåˆ¶</strong>ï¼šæµè§ˆå™¨ä¼šè‡ªåŠ¨å¤„ç†è¿æ¥ä¸­æ–­å’Œé‡è¿ï¼ŒåŒ…æ‹¬åœ¨é‡è¿è¯·æ±‚ä¸­å‘é€æœ€åæ¥æ”¶çš„äº‹ä»¶IDï¼Œä»¥ä¾¿æœåŠ¡å™¨ä»æ­£ç¡®çš„ä½ç½®æ¢å¤å‘é€äº‹ä»¶ã€‚</li><li><strong>ç®€å•çš„å®¢æˆ·ç«¯å¤„ç†</strong>ï¼šåœ¨æµè§ˆå™¨ä¸­ï¼Œä½¿ç”¨ JavaScript çš„<code>EventSource</code> æ¥å£å¤„ç† SSEéå¸¸ç®€å•ï¼Œåªéœ€å‡ è¡Œä»£ç å³å¯ç›‘å¬æœåŠ¡å™¨å‘æ¥çš„äº‹ä»¶ã€‚</li></ol><h1 id="å·¥ä½œåŸç†">å·¥ä½œåŸç†</h1><ol type="1"><li><strong>å»ºç«‹è¿æ¥</strong>ï¼šå®¢æˆ·ç«¯é€šè¿‡åˆ›å»ºä¸€ä¸ª<code>EventSource</code> å¯¹è±¡è¯·æ±‚ç‰¹å®šçš„ URL æ¥å¯åŠ¨ SSEè¿æ¥ã€‚è¿™ä¸ªè¯·æ±‚æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ HTTPè¯·æ±‚ï¼Œä½†ä¼šè¦æ±‚æœåŠ¡å™¨ä»¥ç‰¹å®šæ–¹å¼å“åº”ã€‚</li><li><strong>æœåŠ¡å™¨å“åº”</strong>ï¼šæœåŠ¡å™¨å“åº”å¿…é¡»è®¾ç½®<code>Content-Type</code> ä¸º<code>text/event-stream</code>ï¼Œç„¶åä¿æŒè¿æ¥æ‰“å¼€ã€‚</li><li><strong>å‘é€æ¶ˆæ¯</strong>ï¼šæœåŠ¡å™¨å¯ä»¥é€šè¿‡æŒç»­å‘é€æ•°æ®æ ¼å¼ä¸ºç‰¹å®šäº‹ä»¶æµçš„æ¶ˆæ¯æ¥æ¨é€æ›´æ–°ã€‚æ¯ä¸ªæ¶ˆæ¯åŒ…æ‹¬ä¸€ä¸ªå¯é€‰çš„äº‹ä»¶ç±»å‹ã€æ•°æ®å’Œä¸€ä¸ªå¯é€‰çš„IDã€‚<ul><li><strong>æ•°æ®</strong>ï¼šå®é™…çš„æ¶ˆæ¯å†…å®¹ï¼Œä»¥ <code>data:</code>å¼€å¤´ï¼Œå¤šè¡Œæ•°æ®ä»¥åŒæ¢è¡Œç¬¦ <code>\n\n</code> ç»“æŸã€‚</li><li><strong>äº‹ä»¶ç±»å‹</strong>ï¼šå…è®¸å®¢æˆ·ç«¯æ ¹æ®äº‹ä»¶ç±»å‹æ¥ç›‘å¬ï¼Œä»¥<code>event:</code> å¼€å¤´ã€‚</li><li><strong>ID</strong>ï¼šå¦‚æœè¿æ¥ä¸­æ–­ï¼Œå®¢æˆ·ç«¯å°†å‘é€åŒ…å«ä¸Šæ¬¡æ¥æ”¶çš„æœ€åä¸€ä¸ªIDçš„<code>Last-Event-ID</code> å¤´ï¼Œä»¥ä¾¿æœåŠ¡å™¨ä»æ–­ç‚¹ç»§ç»­å‘é€æ•°æ®ã€‚</li></ul></li></ol><h1 id="å®æˆ˜">å®æˆ˜</h1><h2 id="å®¢æˆ·ç«¯">å®¢æˆ·ç«¯</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>SSE Test<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Server-Sent Events Test<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;events&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">// ç¡®ä¿è¿™é‡Œçš„URLåŒ¹é…ä½ çš„æœåŠ¡å™¨åœ°å€å’Œç«¯å£</span></span><br><span class="language-javascript">    <span class="hljs-keyword">var</span> eventSource = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventSource</span>(<span class="hljs-string">&#x27;http://localhost:8000/events&#x27;</span>);</span><br><span class="language-javascript">    eventSource.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) &#123;</span><br><span class="language-javascript">        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;New event:&#x27;</span>, event.<span class="hljs-property">data</span>);</span><br><span class="language-javascript">        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;events&#x27;</span>).<span class="hljs-property">innerHTML</span> += event.<span class="hljs-property">data</span> + <span class="hljs-string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="language-javascript">    &#125;;</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="rust-æœåŠ¡ç«¯">Rust æœåŠ¡ç«¯</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/20240606213652.gif"alt="Rust å®ç°æ¼”ç¤º" /><figcaption aria-hidden="true">Rust å®ç°æ¼”ç¤º</figcaption></figure><p>ä¾èµ–ï¼š</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs toml"><span class="hljs-attr">anyhow</span> = <span class="hljs-string">&quot;1.0.86&quot;</span><br><span class="hljs-attr">axum</span> = &#123; version = <span class="hljs-string">&quot;0.7.5&quot;</span> &#125;<br><span class="hljs-attr">chrono</span> = <span class="hljs-string">&quot;0.4.38&quot;</span><br><span class="hljs-attr">futures-core</span> = <span class="hljs-string">&quot;0.3.30&quot;</span><br><span class="hljs-attr">tokio</span> = &#123; version = <span class="hljs-string">&quot;1.38.0&quot;</span>, features = [<span class="hljs-string">&quot;macros&quot;</span>, <span class="hljs-string">&quot;rt-multi-thread&quot;</span>, ] &#125;<br><span class="hljs-attr">tokio-stream</span> = <span class="hljs-string">&quot;0.1.15&quot;</span><br><span class="hljs-attr">tower-http</span> = &#123; version = <span class="hljs-string">&quot;0.5.2&quot;</span>, features = [<span class="hljs-string">&quot;cors&quot;</span>] &#125;<br></code></pre></td></tr></table></figure><p>ä»£ç ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> std::time::Duration;<br><br><span class="hljs-keyword">use</span> axum::&#123;<br>    response::&#123;sse::Event, Sse&#125;,<br>    routing::get,<br>    Router,<br>&#125;;<br><span class="hljs-keyword">use</span> tokio::&#123;net::TcpListener, time::interval&#125;;<br><span class="hljs-keyword">use</span> tokio_stream::&#123;wrappers::IntervalStream, StreamExt&#125;;<br><span class="hljs-keyword">use</span> tower_http::cors::&#123;Any, CorsLayer&#125;;<br><br><span class="hljs-meta">#[tokio::main]</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-&gt;</span> anyhow::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cors</span> = CorsLayer::<span class="hljs-title function_ invoke__">new</span>()<br>        .<span class="hljs-title function_ invoke__">allow_headers</span>(Any)<br>        .<span class="hljs-title function_ invoke__">allow_origin</span>(Any)<br>        .<span class="hljs-title function_ invoke__">allow_headers</span>(Any)<br>        .<span class="hljs-title function_ invoke__">allow_credentials</span>(<span class="hljs-literal">false</span>);<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">listener</span> = TcpListener::<span class="hljs-title function_ invoke__">bind</span>(<span class="hljs-string">&quot;0.0.0.0:8000&quot;</span>).<span class="hljs-keyword">await</span>?;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">app</span> = Router::<span class="hljs-title function_ invoke__">new</span>().<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;/events&quot;</span>, <span class="hljs-title function_ invoke__">get</span>(sse_handler)).<span class="hljs-title function_ invoke__">layer</span>(cors);<br>    axum::<span class="hljs-title function_ invoke__">serve</span>(listener, app).<span class="hljs-keyword">await</span>?;<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">sse_handler</span>() <span class="hljs-punctuation">-&gt;</span> Sse&lt;<span class="hljs-keyword">impl</span> <span class="hljs-title class_">futures_core</span>::Stream&lt;Item = <span class="hljs-type">Result</span>&lt;Event, axum::Error&gt;&gt;&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">interval</span> = <span class="hljs-title function_ invoke__">interval</span>(Duration::<span class="hljs-title function_ invoke__">from_secs</span>(<span class="hljs-number">1</span>));<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">stream</span> = IntervalStream::<span class="hljs-title function_ invoke__">new</span>(interval).<span class="hljs-title function_ invoke__">map</span>(|_| &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">data</span> = <span class="hljs-built_in">format!</span>(<span class="hljs-string">&quot;&#123;&#125;\n\n&quot;</span>, chrono::Local::<span class="hljs-title function_ invoke__">now</span>().<span class="hljs-title function_ invoke__">to_rfc2822</span>());<br>        <span class="hljs-title function_ invoke__">Ok</span>(Event::<span class="hljs-title function_ invoke__">default</span>().<span class="hljs-title function_ invoke__">data</span>(data))<br>    &#125;);<br><br>    Sse::<span class="hljs-title function_ invoke__">new</span>(stream)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="go-æœåŠ¡ç«¯">Go æœåŠ¡ç«¯</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/20240606195749.gif"alt="Go å®ç°æ¼”ç¤º" /><figcaption aria-hidden="true">Go å®ç°æ¼”ç¤º</figcaption></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;log&quot;</span><br><span class="hljs-string">&quot;net/http&quot;</span><br><span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sseHandler</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;<br><span class="hljs-comment">// è®¾ç½®å¤´éƒ¨ä¿¡æ¯ï¼Œç¡®ä¿å…è®¸è·¨åŸŸï¼Œå¹¶ä¸”å‘Šè¯‰æµè§ˆå™¨è¿™æ˜¯ä¸€ä¸ªäº‹ä»¶æµ</span><br>w.Header().Set(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;text/event-stream&quot;</span>)<br>w.Header().Set(<span class="hljs-string">&quot;Cache-Control&quot;</span>, <span class="hljs-string">&quot;no-cache&quot;</span>)<br>w.Header().Set(<span class="hljs-string">&quot;Connection&quot;</span>, <span class="hljs-string">&quot;keep-alive&quot;</span>)<br>w.Header().Set(<span class="hljs-string">&quot;Access-Control-Allow-Origin&quot;</span>, <span class="hljs-string">&quot;*&quot;</span>)<br><br><span class="hljs-comment">// ä¸æ–­å‘é€æ¶ˆæ¯</span><br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-comment">// ç”ŸæˆæœåŠ¡å™¨æ—¶é—´ï¼Œå¹¶å‘é€ç»™å®¢æˆ·ç«¯</span><br>now := time.Now()<br><span class="hljs-comment">// ç”Ÿæˆæ¶ˆæ¯ï¼Œæ ¼å¼ä¸º data: &#123;content&#125; \n\n</span><br>msg := fmt.Sprintf(<span class="hljs-string">&quot;data: %s\n\n&quot;</span>, now.Format(time.DateTime))<br><span class="hljs-comment">// å‘é€æ¶ˆæ¯</span><br><span class="hljs-keyword">if</span> _, err := fmt.Fprintf(w, msg); err != <span class="hljs-literal">nil</span> &#123;<br>log.Println(<span class="hljs-string">&quot;write error:&quot;</span>, err)<br><span class="hljs-keyword">break</span><br>&#125;<br><br><span class="hljs-comment">// åˆ·æ–°å“åº”ç¼“å†²ï¼Œç¡®ä¿å³æ—¶å‘é€</span><br>flusher, ok := w.(http.Flusher)<br><span class="hljs-keyword">if</span> !ok &#123;<br>log.Println(<span class="hljs-string">&quot;Streaming unsupported!&quot;</span>)<br><span class="hljs-keyword">break</span><br>&#125;<br>flusher.Flush()<br><br><span class="hljs-comment">// æ¯ç§’å‘é€ä¸€æ¬¡</span><br>time.Sleep(<span class="hljs-number">1</span> * time.Second)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>http.HandleFunc(<span class="hljs-string">&quot;/events&quot;</span>, sseHandler)<br>log.Println(<span class="hljs-string">&quot;Server started on port 8000...&quot;</span>)<br>log.Fatal(http.ListenAndServe(<span class="hljs-string">&quot;:8000&quot;</span>, <span class="hljs-literal">nil</span>))<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">æœ¬æ–‡è¯¦ç»†ä»‹ç»äº† SSE çš„å·¥ä½œåŸç†ï¼Œå¹¶é€šè¿‡ç¤ºä¾‹ä»£ç å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ Go å’Œ Rust å®ç°ä¸€ä¸ªç®€å•çš„ SSE æœåŠ¡ç«¯ï¼Œå±•ç¤ºäº†åœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨ SSE çš„æ–¹æ³•ã€‚</summary>
    
    
    
    <category term="Rust" scheme="https://hedon.top/categories/Rust/"/>
    
    <category term="Rust å®æˆ˜" scheme="https://hedon.top/categories/Rust/Rust-%E5%AE%9E%E6%88%98/"/>
    
    
    <category term="Go" scheme="https://hedon.top/tags/Go/"/>
    
    <category term="Rust" scheme="https://hedon.top/tags/Rust/"/>
    
    <category term="SSE" scheme="https://hedon.top/tags/SSE/"/>
    
  </entry>
  
  <entry>
    <title>Rust å®æˆ˜ä¸¨é€šè¿‡å®ç° json! æŒæ¡å£°æ˜å®</title>
    <link href="https://hedon.top/2024/05/28/rust-action-macro-json/"/>
    <id>https://hedon.top/2024/05/28/rust-action-macro-json/</id>
    <published>2024-05-28T07:37:23.000Z</published>
    <updated>2024-05-28T15:13:08.694Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ Rustç¼–ç¨‹è¯­è¨€ä¸­ï¼Œå®æ˜¯ä¸€ç§å¼ºå¤§çš„å·¥å…·ï¼Œå¯ä»¥ç”¨äºåœ¨ç¼–è¯‘æ—¶ç”Ÿæˆä»£ç ã€‚<code>json!</code>æ˜¯ä¸€ä¸ªåœ¨ Rust ä¸­å¹¿æ³›ä½¿ç”¨çš„å®ï¼Œå®ƒå…è®¸æˆ‘ä»¬åœ¨ Rust ä»£ç ä¸­æ–¹ä¾¿åœ°åˆ›å»º JSONæ•°æ®ã€‚</p><p>å£°æ˜å®ï¼ˆdeclarative macrosï¼‰æ˜¯ Rust ä¸­çš„ä¸€ç§å®ï¼Œå®ƒä»¬ä½¿ç”¨<code>macro_rules!</code> å…³é”®å­—å®šä¹‰ã€‚</p><p>æœ¬æ–‡å°†å‚è€ƒã€ŠRust ç¨‹åºè®¾è®¡ï¼ˆç¬¬äºŒç‰ˆï¼‰ã€‹ï¼Œé€šè¿‡å®ç° <code>json!</code>å®ï¼Œæ·±å…¥ç†è§£å£°æ˜å®çš„å·¥ä½œåŸç†ã€‚</p><h1 id="ç»“è®ºå…ˆè¡Œ">ç»“è®ºå…ˆè¡Œ</h1><p>æœ¬æ–‡æˆ‘ä»¬å°†æ„å»ºä¸€ä¸ª <code>json!</code> å®ï¼Œå®ƒæ”¯æŒæˆ‘ä»¬ä»¥å­—ç¬¦ä¸² JSONé£æ ¼çš„è¯­æ³•æ¥ç¼–å†™ Json å€¼ã€‚å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">students</span> = json![<br>&#123;<br><span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;Hedon Wang&quot;</span>,<br><span class="hljs-string">&quot;class_of&quot;</span>: <span class="hljs-number">2022</span>,<br><span class="hljs-string">&quot;major&quot;</span>: <span class="hljs-string">&quot;Software engineering&quot;</span><br>&#125;,<br>&#123;<br><span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;Jun Lei&quot;</span>,<br><span class="hljs-string">&quot;class_of&quot;</span>: <span class="hljs-number">1991</span>,<br><span class="hljs-string">&quot;major&quot;</span>: <span class="hljs-string">&quot;Computor science&quot;</span><br>&#125;<br>]<br></code></pre></td></tr></table></figure><blockquote><p><a href="#å®Œæ•´ä»£ç ">å®Œæ•´ä»£ç </a></p></blockquote><h1 id="å®ç°-json">å®ç° <code>json!</code></h1><h2 id="å®šä¹‰-json-enum">å®šä¹‰ Json enum</h2><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦æ€è€ƒä¸€ä¸‹ Json ç»“æ„æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿä¸»è¦æ˜¯ä»¥ä¸‹ 3 ç§æ¨¡å¼ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;hedon&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">18</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;school&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Wuhan University&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;address&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Hubwi Wuhan&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">[</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;hedon&quot;</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;john&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-literal"><span class="hljs-keyword">null</span></span><br></code></pre></td></tr></table></figure><p>ä¸ºæ­¤æˆ‘ä»¬å®šä¹‰ä¸€ä¸ª Json ç»“æ„çš„æšä¸¾ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[derive(Clone, PartialEq, Debug)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Json</span> &#123;<br>    Null,<br>    <span class="hljs-title function_ invoke__">Boolean</span>(<span class="hljs-type">bool</span>),<br>    <span class="hljs-title function_ invoke__">Number</span>(<span class="hljs-type">f64</span>),<br>    <span class="hljs-title function_ invoke__">String</span>(<span class="hljs-type">String</span>),<br>    <span class="hljs-title function_ invoke__">Array</span>(<span class="hljs-type">Vec</span>&lt;Json&gt;),<br>    <span class="hljs-title function_ invoke__">Object</span>(HashMap&lt;<span class="hljs-type">String</span>, Json&gt;),<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½ åº”è¯¥å¯ä»¥æ„Ÿåˆ°éå¸¸å¥‡å¦™ï¼Œä½¿ç”¨ä¸€ä¸ªè¿™ä¹ˆç®€å•çš„æšä¸¾ï¼Œå±…ç„¶å°±å¯ä»¥è¡¨ç¤ºæ‰€æœ‰çš„Json ç»“æ„äº†ã€‚é—æ†¾çš„æ˜¯ï¼Œç°åœ¨è¿™ä¸ªç»“æ„ç¼–å†™ Json å€¼çš„è¯­æ³•ç›¸å½“å†—é•¿ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">people</span> = Json::<span class="hljs-title function_ invoke__">Object</span>(HashMap::<span class="hljs-title function_ invoke__">from</span>([<br>    (<span class="hljs-string">&quot;name&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), Json::<span class="hljs-title function_ invoke__">String</span>(<span class="hljs-string">&quot;hedon&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>())),<br>    (<span class="hljs-string">&quot;age&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), Json::<span class="hljs-title function_ invoke__">Number</span>(<span class="hljs-number">10.0</span>)),<br>    (<span class="hljs-string">&quot;is_student&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), Json::<span class="hljs-title function_ invoke__">Boolean</span>(<span class="hljs-literal">true</span>)),<br>    (<br>        <span class="hljs-string">&quot;detail&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(),<br>        Json::<span class="hljs-title function_ invoke__">Object</span>(HashMap::<span class="hljs-title function_ invoke__">from</span>([<br>            (<span class="hljs-string">&quot;address&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), Json::<span class="hljs-title function_ invoke__">String</span>(<span class="hljs-string">&quot;beijing&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>())),<br>            (<span class="hljs-string">&quot;phone&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), Json::<span class="hljs-title function_ invoke__">String</span>(<span class="hljs-string">&quot;1234567890&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>()))<br>        ]))<br>    )<br>]))<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬æœŸæœ›å¯ä»¥ä»¥ä¸‹é¢è¿™ç§æ–¹å¼æ¥å£°æ˜ Jsonå˜é‡ï¼Œè¿™çœ‹èµ·æ¥å°±æ¸…çˆ½è®¸å¤šäº†ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">students</span> = json!([<br>    &#123;<br>        <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;Jim Blandy&quot;</span>,<br>        <span class="hljs-string">&quot;class_of&quot;</span>: <span class="hljs-number">1926</span>,<br>        <span class="hljs-string">&quot;major&quot;</span>: <span class="hljs-string">&quot;Tibetan throat singing&quot;</span><br>    &#125;,<br>    &#123;<br>        <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;Jason Orendorff&quot;</span>,<br>        <span class="hljs-string">&quot;class_of&quot;</span>: <span class="hljs-number">1702</span>,<br>        <span class="hljs-string">&quot;major&quot;</span>: <span class="hljs-string">&quot;Knots&quot;</span><br>    &#125;<br>]);<br></code></pre></td></tr></table></figure><h2 id="çŒœæƒ³-json">çŒœæƒ³ <code>json!</code></h2><p>æˆ‘ä»¬å¯ä»¥é¢„è§ Json å®å†…éƒ¨å°†ä¼šæœ‰å¤šæ¡è§„åˆ™ï¼Œå› ä¸º JSONæ•°æ®æœ‰å¤šç§ç±»å‹ï¼šå¯¹è±¡ã€æ•°ç»„ã€æ•°å€¼ç­‰ã€‚äº‹å®ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥åˆç†åœ°çŒœæµ‹æ¯ç§ JSONç±»å‹éƒ½å°†æœ‰ä¸€æ¡è§„åˆ™ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-built_in">macro_rules!</span> json &#123;<br>    (null)    =&gt; &#123; Json::Null &#125;;<br>    ([ ... ]) =&gt; &#123; Json::<span class="hljs-title function_ invoke__">Array</span>(...) &#125;;<br>    (&#123; ... &#125;) =&gt; &#123; Json::<span class="hljs-title function_ invoke__">Object</span>(...) &#125;;<br>    (???)     =&gt; &#123; Json::<span class="hljs-title function_ invoke__">Boolean</span>(...) &#125;;<br>    (???)     =&gt; &#123; Json::<span class="hljs-title function_ invoke__">Number</span>(...) &#125;;<br>    (???)     =&gt; &#123; Json::<span class="hljs-title function_ invoke__">String</span>(...) &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶è€Œè¿™ä¸å¤ªæ­£ç¡®ï¼Œå› ä¸ºå®æ¨¡å¼æ— æ³•åŒºåˆ†æœ€å 3ç§æƒ…å†µï¼Œç¨åæˆ‘ä»¬ä¼šè®¨è®ºå¦‚ä½•å¤„ç†ã€‚è‡³äºå‰ 3ç§æƒ…å†µï¼Œæ˜¾ç„¶å®ƒä»¬æ˜¯ä»¥ä¸åŒçš„è¯­æ³•æ ‡è®°å¼€å§‹çš„ï¼Œæ‰€ä»¥è¿™å‡ ç§æƒ…å†µæ¯”è¾ƒå¥½å¤„ç†ã€‚</p><h2 id="å®ç°-null">å®ç° Null</h2><p>æˆ‘ä»¬å…ˆä»æœ€ç®€å•çš„ <code>Null</code> åˆ†æ”¯å¼€å§‹ï¼Œå…ˆç¼–å†™å¦‚ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[cfg(test)]</span><br><span class="hljs-keyword">mod</span> tests &#123;<br>    <span class="hljs-keyword">use</span> super::*;<br><br>    <span class="hljs-meta">#[test]</span><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">test_null_json</span>() &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">json</span> = json!(null);<br>        <span class="hljs-built_in">assert_eq!</span>(json, Json::Null);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æƒ³è¦é€šè¿‡ä¸Šè¿°æµ‹è¯•ç”¨ä¾‹éå¸¸ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ <code>macro_rules!</code>æ”¯æŒä¸­åŒ¹é…è¿™ç§æƒ…å†µå³å¯ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[macro_export]</span><br><span class="hljs-built_in">macro_rules!</span> json &#123;<br>    (null) =&gt; &#123;<br>        Json::Null<br>    &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>#[macro_export]</code> æ³¨è§£æ˜¯ Rustä¸­çš„ä¸€ä¸ªå±æ€§ï¼Œç”¨äºæŒ‡ç¤ºè¿™ä¸ªå®åº”è¯¥è¢«å¯¼å‡ºåˆ°è°ƒç”¨è€…çš„ä½œç”¨åŸŸä¸­ï¼Œè¿™æ ·å…¶ä»–æ¨¡å—ä¹Ÿå¯ä»¥ä½¿ç”¨å®ƒã€‚</li><li><code>macro_rules!</code>å®å®šä¹‰äº†ä¸€ä¸ªè‡ªå®šä¹‰çš„å®ã€‚åœ¨è¿™é‡Œï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªåä¸º <code>json</code>çš„å®ï¼Œç”¨äºç”Ÿæˆ JSON æ•°æ®ã€‚</li><li>å®å®šä¹‰ä¸­ <code>(null)</code> æ˜¯åŒ¹é…æ¨¡å¼ã€‚è¿™æ„å‘³ç€å½“ä½ è°ƒç”¨<code>json!</code> å®å¹¶ä¼ é€’ <code>null</code>ä½œä¸ºå‚æ•°æ—¶ï¼Œå°†ä¼šè§¦å‘è¿™ä¸ªè§„åˆ™ã€‚</li><li><code>=&gt;</code>ç¬¦å·ç”¨äºæŒ‡ç¤ºåŒ¹é…æ¨¡å¼åçš„ä»£ç å—ã€‚åœ¨è¿™é‡Œï¼Œå®ƒæŒ‡å®šäº†å½“åŒ¹é…<code>(null)</code> æ—¶åº”è¯¥ç”Ÿæˆçš„ä»£ç å—ã€‚</li><li><code>Json::Null</code> æ˜¯ä¸€ä¸ª JSON ç±»å‹çš„æšä¸¾å€¼ï¼Œè¡¨ç¤º JSON ä¸­çš„null å€¼ã€‚è¿™ä¸ªå®çš„ç›®çš„æ˜¯å°†ä¼ å…¥çš„ <code>null</code> è½¬æ¢ä¸º<code>Json::Null</code>ã€‚</li></ul><h2 id="å®ç°-booleannumberstring">å®ç° Boolean/Number/String</h2><p>æˆ‘ä»¬å…ˆå‡†å¤‡å¦‚ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[test]</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">test_boolean_number_string_json</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">json</span> = json!(<span class="hljs-literal">true</span>);<br>    <span class="hljs-built_in">assert_eq!</span>(json, Json::<span class="hljs-title function_ invoke__">Boolean</span>(<span class="hljs-literal">true</span>));<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">json</span> = json!(<span class="hljs-number">1.0</span>);<br>    <span class="hljs-built_in">assert_eq!</span>(json, Json::<span class="hljs-title function_ invoke__">Number</span>(<span class="hljs-number">1.0</span>));<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">json</span> = json!(<span class="hljs-string">&quot;hello&quot;</span>);<br>    <span class="hljs-built_in">assert_eq!</span>(json, Json::<span class="hljs-title function_ invoke__">String</span>(<span class="hljs-string">&quot;hello&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>()));<br>&#125;<br></code></pre></td></tr></table></figure><p>é€šè¿‡è§‚å¯Ÿåˆ†æï¼Œå®ƒä»¬å…¶å®éƒ½æ˜¯åŒä¸€ç§æ¨¡å¼ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240528114725679.png"alt="Boolean/Number/String åˆ†æ" /><figcaption aria-hidden="true">Boolean/Number/String åˆ†æ</figcaption></figure><p>ç°åœ¨éœ€è¦è§£å†³çš„é—®é¢˜å°±æ˜¯ï¼Œå¦‚ä½•å°†è¿™ 3 ç§æ¨¡å¼è¿›è¡Œç»Ÿä¸€ï¼Œè¿™æ ·åœ¨<code>macro_rules!</code> ä¸­æ‰å¯ä»¥ç»Ÿä¸€åŒ¹é…æ¨¡å¼å¹¶è¿›è¡Œä»£ç ç”Ÿæˆã€‚</p><p>è¿™é‡Œæˆ‘ä»¬å…¶å®éœ€è¦åšçš„å°±æ˜¯å°† <code>bool</code>ã€<code>f64</code> å’Œ<code>&amp;str</code> è½¬ä¸ºå¯¹åº”çš„ <code>Json</code>ç±»å‹ã€‚é‚£å°±éœ€è¦ç”¨åˆ°æ ‡å‡†åº“ä¸­çš„ <code>From</code> trait äº†ã€‚</p><p>åšæ³•å¾ˆç®€å•ï¼Œæˆ‘ä»¬å®ç°å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;<span class="hljs-type">bool</span>&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">Json</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(value: <span class="hljs-type">bool</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        Json::<span class="hljs-title function_ invoke__">Boolean</span>(value)<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;&amp;<span class="hljs-type">str</span>&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">Json</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(value: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        Json::<span class="hljs-title function_ invoke__">String</span>(value.<span class="hljs-title function_ invoke__">to_string</span>())<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;<span class="hljs-type">f64</span>&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">Json</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(value: <span class="hljs-type">f64</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        Json::<span class="hljs-title function_ invoke__">Number</span>(value)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå®Œå–„æˆ‘ä»¬çš„ <code>json!</code>ï¼Œç›®å‰çš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[macro_export]</span><br><span class="hljs-built_in">macro_rules!</span> json &#123;<br>    (null) =&gt; &#123;<br>        Json::Null<br>    &#125;;<br>    ($value: tt) =&gt; &#123;<br>        Json::<span class="hljs-title function_ invoke__">from</span>($value)<br>    &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ <code>$value</code>ä½œ ä¸ºå˜é‡æ¥æ‰¿æ¥åŒ¹é…åˆ°çš„å…ƒç´ ï¼Œå…¶ç±»å‹ä¸º<code>tt</code> ï¼Œè¡¨ç¤ºä»»æ„çš„è¯­æ³•æ ‡è®°æ ‘ã€‚å…·ä½“å¯ä»¥å‚è€ƒï¼š<ahref="#ç‰‡æ®µç±»å‹">ç‰‡æ®µç±»å‹</a>ã€‚</p><p>è¿™æ—¶è¿è¡Œä¸Šè¿°æµ‹è¯•ç”¨ä¾‹ï¼Œæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">PASS [   0.004s] json-macro tests::test_boolean_number_string_json<br>PASS [   0.004s] json-macro tests::test_null_json<br></code></pre></td></tr></table></figure><p>ç¾ä¸­ä¸è¶³çš„æ˜¯ï¼ŒJSON ç»“æ„ä¸­çš„æ•°å­—ç±»å‹ï¼Œå…¶å®ä¸ä¸€å®šæ˜¯ f64ï¼Œä¹Ÿå¯ä»¥æ˜¯i32ã€u32ã€f32 æˆ–å…¶ä»–çš„æ•°å­—ç±»å‹ï¼Œå¦‚æœæˆ‘ä»¬è¦ä¸ºè¿™å…¨éƒ¨çš„æ•°å­—ç±»å‹éƒ½å®ç°åˆ°Json çš„ <code>From</code> traitï¼Œé‚£å°±å¤šå†—ä½™ã€‚</p><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬åˆå¯ä»¥å®ç°ä¸€ä¸ªå®ï¼Œç”¨äºå¿«é€Ÿç”Ÿæˆ<code>impl From&lt;T&gt; for Json</code>ã€‚è¿™ä¸ªå®ç°æ¯”è¾ƒç®€å•ï¼Œæœ¬æ–‡å°±ä¸èµ˜è¿°äº†ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[macro_export]</span><br><span class="hljs-built_in">macro_rules!</span> impl_from_for_primitives &#123;<br>    (  $( $<span class="hljs-keyword">type</span>: ty ) * ) =&gt; &#123;<br>        $(<br>            <span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;$<span class="hljs-keyword">type</span>&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">Json</span> &#123;<br>                <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(value: $<span class="hljs-keyword">type</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>                    Json::<span class="hljs-title function_ invoke__">Number</span>(value <span class="hljs-keyword">as</span> <span class="hljs-type">f64</span>)<br>                &#125;<br>            &#125;<br>        )*<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬åªéœ€è¦ç”¨ä¸‹é¢è¿™ä¸€è¡Œä»£ç ï¼Œå°±å¯ä»¥ä¸ºæ‰€æœ‰çš„æ•°å­—ç±»å‹å®ç°<code>From</code> trait äº†ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust">impl_from_for_primitives!(<span class="hljs-type">u8</span> <span class="hljs-type">u16</span> <span class="hljs-type">u32</span> <span class="hljs-type">u64</span> <span class="hljs-type">i8</span> <span class="hljs-type">i16</span> <span class="hljs-type">i32</span> <span class="hljs-type">i64</span> <span class="hljs-type">f32</span> <span class="hljs-type">f64</span> <span class="hljs-type">isize</span> <span class="hljs-type">usize</span>);<br></code></pre></td></tr></table></figure><p>è®°å¾—è¿™ä¸ªæ—¶å€™ä½ è¦åˆ é™¤ä¸Šé¢æ‰‹åŠ¨å®ç°çš„<code>impl From&lt;f64&gt; for Json</code>ï¼Œä¸ç„¶ä¼šæœ‰ impl å†²çªé”™è¯¯ã€‚</p><p>å†æ¬¡è¿è¡Œæµ‹è¯•ï¼Œä¹Ÿæ˜¯å¯ä»¥é€šè¿‡çš„ã€‚</p><h2 id="å®ç°-array">å®ç° Array</h2><p>å‡†å¤‡å¦‚ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[test]</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">test_array_json</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">json</span> = json!([<span class="hljs-number">1</span>, null, <span class="hljs-string">&quot;string&quot;</span>, <span class="hljs-literal">true</span>]);<br>    <span class="hljs-built_in">assert_eq!</span>(<br>        json,<br>        Json::<span class="hljs-title function_ invoke__">Array</span>(<span class="hljs-built_in">vec!</span>[<br>            Json::<span class="hljs-title function_ invoke__">Number</span>(<span class="hljs-number">1.0</span>),<br>            Json::Null,<br>            Json::<span class="hljs-title function_ invoke__">String</span>(<span class="hljs-string">&quot;string&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>()),<br>            Json::<span class="hljs-title function_ invoke__">Boolean</span>(<span class="hljs-literal">true</span>)<br>        ])<br>    )<br>&#125;<br></code></pre></td></tr></table></figure><p>è¦åŒ¹é…<code>[1, null, "string", true]</code>è¿™ä¸ªæ¨¡å¼ï¼Œç¬”è€…çš„åˆ†æè¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol type="1"><li>é¦–å…ˆæ˜¯å¤–é¢çš„ä¸¤ä¸ªä¸­æ‹¬å· <code>[</code> å’Œ <code>]</code> ï¼›</li><li>å†å¾€é‡Œï¼Œæ˜¯ä¸€ä¸ªé‡å¤åŒ¹é…çš„æ¨¡å¼ï¼Œä»¥ <code>,</code> åˆ†å‰²ï¼Œå¯ä»¥åŒ¹é… 0åˆ°ä»»æ„å¤šä¸ªå…ƒç´ ï¼Œæ‰€ä»¥æ˜¯ <code>$(  ,*)</code> ï¼Œå…·ä½“å¯ä»¥å‚è€ƒï¼š<ahref="#é‡å¤æ¨¡å¼">é‡å¤æ¨¡å¼</a>ï¼›</li><li>æœ€é‡Œé¢å°±æ˜¯ç¬¬ 2 æ­¥è¦åŒ¹é…çš„å…ƒç´ äº†ï¼Œæˆ‘ä»¬å…ˆç”¨ <code>$element</code>ä½œä¸ºå˜é‡æ¥æ‰¿æ¥æ¯ä¸€ä¸ªå…ƒç´ ï¼Œå…¶ç±»å‹ä¸º <code>tt</code>ï¼Œè¡¨ç¤ºä»»æ„çš„è¯­æ³•æ ‡è®°æ ‘ã€‚</li></ol><p>åˆ†æå®ŒåŒ¹é…çš„è¡¨è¾¾å¼åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust">([ $( $element:tt ), * ]) =&gt; &#123; <span class="hljs-comment">/* TODO */</span> &#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è¦ç”Ÿæˆçš„ä»£ç é•¿è¿™ä¸ªæ ·å­ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust">Json::<span class="hljs-title function_ invoke__">Array</span>(<span class="hljs-built_in">vec!</span>[<br>    Json::<span class="hljs-title function_ invoke__">Number</span>(<span class="hljs-number">1.0</span>),<br>    Json::Null,<br>    Json::<span class="hljs-title function_ invoke__">String</span>(<span class="hljs-string">&quot;string&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>()),<br>    Json::<span class="hljs-title function_ invoke__">Boolean</span>(<span class="hljs-literal">true</span>)<br>])<br></code></pre></td></tr></table></figure><p>å…¶å®å°±æ˜¯ä¸€ä¸ª <code>vec!</code>ï¼Œç„¶åé‡Œé¢æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ª<code>Json</code>ï¼Œå¦‚æ­¤é€’å½’ä¸‹å»ã€‚</p><p>å³å¯ä»¥å¾—åˆ°ä»£ç ç”Ÿæˆéƒ¨åˆ†çš„é€»è¾‘ä¸ºï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust">Json::<span class="hljs-title function_ invoke__">Array</span>(<span class="hljs-built_in">vec!</span>[$(json!($element)),* ])<br></code></pre></td></tr></table></figure><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240528134133088.png"alt="Json::Array å®åˆ†æ" /><figcaption aria-hidden="true">Json::Array å®åˆ†æ</figcaption></figure><p>ç»¼ä¸Šï¼Œæˆ‘ä»¬å®ç°çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[macro_export]</span><br><span class="hljs-built_in">macro_rules!</span> json &#123;<br>    (null) =&gt; &#123;<br>        Json::Null<br>    &#125;;<br>    ([ $( $element: tt),* ]) =&gt; &#123;<br>        Json::<span class="hljs-title function_ invoke__">Array</span>(<span class="hljs-built_in">vec!</span>[ $( json!($element)), * ])<br>    &#125;;<br>    ($value: tt) =&gt; &#123;<br>        Json::<span class="hljs-title function_ invoke__">from</span>($value)<br>    &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œæµ‹è¯•ç”¨ä¾‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">PASS [   0.003s] json-macro tests::test_null_json<br>PASS [   0.003s] json-macro tests::test_boolean_number_string_json<br>PASS [   0.004s] json-macro tests::test_array_json<br></code></pre></td></tr></table></figure><h2 id="å®ç°-object">å®ç° Object</h2><p>å†™å¥½å¦‚ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼Œè¿™æ¬¡æˆ‘ä»¬é¡ºå¸¦æŠŠ Nullã€Booleanã€Number å’Œ Stringå¸¦ä¸Šäº†ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[test]</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">test_object_json</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">json</span> = json!(&#123;<br>        <span class="hljs-string">&quot;null&quot;</span>: null,<br>        <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;hedon&quot;</span>,<br>        <span class="hljs-string">&quot;age&quot;</span>: <span class="hljs-number">10</span>,<br>        <span class="hljs-string">&quot;is_student&quot;</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-string">&quot;detail&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;address&quot;</span>: <span class="hljs-string">&quot;beijing&quot;</span>,<br>            <span class="hljs-string">&quot;phone&quot;</span>: <span class="hljs-string">&quot;1234567890&quot;</span><br>        &#125;<br>    &#125;);<br>    <span class="hljs-built_in">assert_eq!</span>(<br>        json,<br>        Json::<span class="hljs-title function_ invoke__">Object</span>(HashMap::<span class="hljs-title function_ invoke__">from</span>([<br>            (<span class="hljs-string">&quot;name&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), Json::<span class="hljs-title function_ invoke__">String</span>(<span class="hljs-string">&quot;hedon&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>())),<br>            (<span class="hljs-string">&quot;age&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), Json::<span class="hljs-title function_ invoke__">Number</span>(<span class="hljs-number">10.0</span>)),<br>            (<span class="hljs-string">&quot;is_student&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), Json::<span class="hljs-title function_ invoke__">Boolean</span>(<span class="hljs-literal">true</span>)),<br>            (<br>                <span class="hljs-string">&quot;detail&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(),<br>                Json::<span class="hljs-title function_ invoke__">Object</span>(HashMap::<span class="hljs-title function_ invoke__">from</span>([<br>                    (<span class="hljs-string">&quot;address&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), Json::<span class="hljs-title function_ invoke__">String</span>(<span class="hljs-string">&quot;beijing&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>())),<br>                    (<span class="hljs-string">&quot;phone&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), Json::<span class="hljs-title function_ invoke__">String</span>(<span class="hljs-string">&quot;1234567890&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>()))<br>                ]))<br>            )<br>        ]))<br>    )<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹æ¯”é¢„æœŸçš„ <code>json!</code> å®å†…å®¹å’Œå±•å¼€åçš„ä»£ç ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240528133040062.png"alt="Json::Object å®åˆ†æ" /><figcaption aria-hidden="true">Json::Object å®åˆ†æ</figcaption></figure><p>å®Œå–„æˆ‘ä»¬çš„ <code>macro_rules! json</code> ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[macro_export]</span><br><span class="hljs-built_in">macro_rules!</span> json &#123;<br>    (null) =&gt; &#123;<br>        Json::Null<br>    &#125;;<br>    ([ $( $element: tt),* ]) =&gt; &#123;<br>        Json::<span class="hljs-title function_ invoke__">Array</span>(<span class="hljs-built_in">vec!</span>[ $( json!($element)), * ])<br>    &#125;;<br>    (&#123; $( $key:tt : $value:tt ),* &#125;) =&gt; &#123;<br>        Json::<span class="hljs-title function_ invoke__">Object</span>(HashMap::<span class="hljs-title function_ invoke__">from</span>([<br>            $(<br>                ( $key.<span class="hljs-title function_ invoke__">to_string</span>(), json!($value) )<br>            ), *<br>        ]))<br>    &#125;;<br>    ($value: tt) =&gt; &#123;<br>        Json::<span class="hljs-title function_ invoke__">from</span>($value)<br>    &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œæµ‹è¯•ç”¨ä¾‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">PASS [   0.004s] json-macro tests::test_object_json<br>PASS [   0.005s] json-macro tests::test_array_json<br>PASS [   0.004s] json-macro tests::test_null_json<br>PASS [   0.005s] json-macro tests::test_boolean_number_string_json<br></code></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®Œæˆäº† <code>json!</code> å®çš„æ„å»ºäº†ï¼å®Œæ•´æºç å¯è§ï¼š<ahref="https://www.notion.so/e90c161d8e3743b2a4f788e3d7b75181?pvs=21">å®Œæ•´ä»£ç </a></p><p>Peace! Enjoy coding~</p><h1 id="é™„å½•">é™„å½•</h1><h2 id="é‡å¤æ¨¡å¼">é‡å¤æ¨¡å¼</h2><p>åœ¨ <ahref="https://www.notion.so/Array-c914526ab9474ccd9cb92c7eb17225b6?pvs=21">å®ç°Array</a> ä¸­ï¼Œæˆ‘ä»¬åŒ¹é…äº†è¿™æ ·ä¸€ä¸ªæ¨¡å¼ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust">([ $( $element:tt ), * ]) =&gt; &#123; <span class="hljs-comment">/* TODO */</span> &#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>$($element:tt), *)</code>å°±æ˜¯ä¸€ä¸ªé‡å¤æ¨¡å¼ï¼Œå…¶å¯ä»¥è¿›ä¸€æ­¥æŠ½è±¡ä¸º <code>$( ... ),*</code> ï¼Œè¡¨ç¤ºåŒ¹é…0 æ¬¡æˆ–å¤šæ¬¡ï¼Œä»¥ <code>,</code> åˆ†éš”ã€‚</p><p>Rust æ”¯æŒä»¥ä¸‹å…¨éƒ¨é‡å¤æ¨¡å¼ï¼š</p><table><thead><tr class="header"><th>æ¨¡å¼</th><th>å«ä¹‰</th></tr></thead><tbody><tr class="odd"><td>$( â€¦ ) *</td><td>åŒ¹é… 0 æ¬¡æˆ–å¤šæ¬¡ï¼Œæ²¡æœ‰åˆ†éš”ç¬¦</td></tr><tr class="even"><td>$( â€¦ ), *</td><td>åŒ¹é… 0 æ¬¡æˆ–å¤šæ¬¡ï¼Œä»¥é€—å·åˆ†éš”</td></tr><tr class="odd"><td>$( â€¦ ); *</td><td>åŒ¹é… 0 æ¬¡æˆ–å¤šæ¬¡ï¼Œä»¥åˆ†å·åˆ†éš”</td></tr><tr class="even"><td>$( â€¦ ) +</td><td>åŒ¹é… 1 æ¬¡æˆ–å¤šæ¬¡ï¼Œæ²¡æœ‰åˆ†éš”ç¬¦</td></tr><tr class="odd"><td>$( â€¦ ), +</td><td>åŒ¹é… 1 æ¬¡æˆ–å¤šæ¬¡ï¼Œä»¥é€—å·åˆ†éš”</td></tr><tr class="even"><td>$( â€¦ ); +</td><td>åŒ¹é… 1 æ¬¡æˆ–å¤šæ¬¡ï¼Œä»¥åˆ†å·åˆ†éš”</td></tr><tr class="odd"><td>$( â€¦ ) ?</td><td>åŒ¹é… 0 æ¬¡æˆ– 1 æ¬¡ï¼Œæ²¡æœ‰åˆ†éš”ç¬¦</td></tr></tbody></table><p>å³ï¼š</p><ul><li><code>*</code> è¡¨ç¤º 0 æ¬¡æˆ–å¤šæ¬¡</li><li><code>+</code> è¡¨ç¤º 1 æ¬¡æˆ–å¤šæ¬¡</li><li><code>?</code> è¡¨ç¤º 0 æ¬¡æˆ– 1 æ¬¡</li><li>å¯åœ¨ä¸Šè¿° 3 è€…ä¹‹å‰åŠ å…¥åˆ†éš”ç¬¦</li></ul><h2 id="ç‰‡æ®µç±»å‹">ç‰‡æ®µç±»å‹</h2><p>åœ¨ <a href="#å®ç°-array">å®ç° Array</a>ä¸­ï¼Œæˆ‘ä»¬åŒ¹é…äº†è¿™æ ·ä¸€ä¸ªæ¨¡å¼ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust">([ $( $element:tt ), * ]) =&gt; &#123; <span class="hljs-comment">/* TODO */</span> &#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å°† <code>$element</code> æŒ‡å®šä¸º <code>tt</code>ï¼Œè¿™ä¸ª<code>tt</code> å°±æ˜¯å®ä¸­çš„ä¸€ç§ç‰‡æ®µç±»å‹ã€‚</p><p><code>tt</code> èƒ½åŒ¹é…å•ä¸ªè¯­æ³•æ ‡è®°æ ‘ï¼ŒåŒ…å«ï¼š</p><ul><li>ä¸€å¯¹æ‹¬å·ï¼Œå¦‚ <code>(..)</code>ã€<code>[..]</code>ã€æˆ–<code>&#123;..&#125;</code> ï¼Œä»¥åŠä½äºå…¶ä¸­çš„æ‰€æœ‰å†…å®¹ï¼ŒåŒ…æ‹¬åµŒå¥—çš„è¯­æ³•æ ‡è®°æ ‘ã€‚</li><li>å•ç‹¬çš„éæ‹¬å·è¯­æ³•æ ‡è®°ï¼Œæ¯”å¦‚ <code>1926</code> æˆ– <code>Knots</code>ã€‚</li></ul><p>æ‰€ä»¥ä¸ºäº†åŒ¹é…ä»»æ„ç±»å‹çš„ <code>Json</code> ï¼Œæˆ‘ä»¬é€‰æ‹©äº† <code>tt</code>ä½œä¸º <code>$element</code> çš„ç‰‡æ®µç±»å‹ã€‚</p><p><code>macro_rules!</code> æ”¯æŒçš„ç‰‡æ®µç±»å‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><table><thead><tr class="header"><th>ç‰‡æ®µç±»å‹</th><th>åŒ¹é…ï¼ˆå¸¦ä¾‹å­ï¼‰</th><th>åé¢å¯ä»¥è·Ÿ Â·Â·Â·Â·Â·Â·</th></tr></thead><tbody><tr class="odd"><td>expr</td><td>è¡¨è¾¾å¼ï¼š2 + 2, "udon", x.len()</td><td>=&gt;,;</td></tr><tr class="even"><td>stmt</td><td>è¡¨è¾¾å¼æˆ–å£°æ˜ï¼Œä¸åŒ…æ‹¬ä»»ä½•å°¾éšåˆ†å·ï¼ˆå¾ˆéš¾ç”¨ï¼Œè¯·å°è¯•ä½¿ç”¨ expr æˆ–blockï¼‰</td><td>=&gt;,;</td></tr><tr class="odd"><td>ty</td><td>ç±»å‹ï¼šString, Vec<u8>, (&amp;str, bool), dyn Read + Send</td><td>=&gt;,; =</td></tr><tr class="even"><td>path</td><td>è·¯å¾„ï¼šferns, ::std::sync::mpsc</td><td>=&gt;,; =</td></tr><tr class="odd"><td>pat</td><td>æ¨¡å¼ï¼š_, Some(ref x)</td><td>=&gt;,=</td></tr><tr class="even"><td>item</td><td>è¯­æ³•é¡¹ï¼šstruct Point { x: f64, y: f64 }, mod ferns;</td><td>ä»»æ„</td></tr><tr class="odd"><td>block</td><td>å—ï¼š{ s += "ok"; true }</td><td>ä»»æ„</td></tr><tr class="even"><td>meta</td><td>å±æ€§çš„ä¸»ä½“ï¼šinline, derive(Copy, Clone), doc="3D models."</td><td>ä»»æ„</td></tr><tr class="odd"><td>literal</td><td>å­—é¢é‡å€¼ï¼š1024, "Hello, world!", 1_000_000f64</td><td>ä»»æ„</td></tr><tr class="even"><td>lifetime</td><td>ç”Ÿå‘½å‘¨æœŸï¼š'a, 'item, 'static</td><td>ä»»æ„</td></tr><tr class="odd"><td>vis</td><td>å¯è§æ€§è¯´æ˜ç¬¦ï¼špub, pub(crate), pub(in module::submodule)</td><td>ä»»æ„</td></tr><tr class="even"><td>ident</td><td>æ ‡è¯†ç¬¦ï¼šstd, Json, longish_variable_name</td><td>ä»»æ„</td></tr><tr class="odd"><td>tt</td><td>è¯­æ³•æ ‡è®°æ ‘ï¼š;, &gt;=, {}, [0 1 (+ 0 1)]</td><td>ä»»æ„</td></tr></tbody></table><h2 id="å®Œæ•´ä»£ç ">å®Œæ•´ä»£ç </h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> std::collections::HashMap;<br><br><span class="hljs-meta">#[derive(Debug, Clone, PartialEq)]</span><br><span class="hljs-meta">#[allow(unused)]</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Json</span> &#123;<br>    Null,<br>    <span class="hljs-title function_ invoke__">Boolean</span>(<span class="hljs-type">bool</span>),<br>    <span class="hljs-title function_ invoke__">String</span>(<span class="hljs-type">String</span>),<br>    <span class="hljs-title function_ invoke__">Number</span>(<span class="hljs-type">f64</span>),<br>    <span class="hljs-title function_ invoke__">Array</span>(<span class="hljs-type">Vec</span>&lt;Json&gt;),<br>    <span class="hljs-title function_ invoke__">Object</span>(HashMap&lt;<span class="hljs-type">String</span>, Json&gt;),<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;<span class="hljs-type">bool</span>&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">Json</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(value: <span class="hljs-type">bool</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        Json::<span class="hljs-title function_ invoke__">Boolean</span>(value)<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;&amp;<span class="hljs-type">str</span>&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">Json</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(value: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        Json::<span class="hljs-title function_ invoke__">String</span>(value.<span class="hljs-title function_ invoke__">to_string</span>())<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;<span class="hljs-type">String</span>&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">Json</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(value: <span class="hljs-type">String</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        Json::<span class="hljs-title function_ invoke__">String</span>(value)<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">#[macro_export]</span><br><span class="hljs-built_in">macro_rules!</span> impl_from_for_primitives &#123;<br>    (  $( $<span class="hljs-keyword">type</span>: ty ) * ) =&gt; &#123;<br>        $(<br>            <span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;$<span class="hljs-keyword">type</span>&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">Json</span> &#123;<br>                <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(value: $<span class="hljs-keyword">type</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>                    Json::<span class="hljs-title function_ invoke__">Number</span>(value <span class="hljs-keyword">as</span> <span class="hljs-type">f64</span>)<br>                &#125;<br>            &#125;<br>        )*<br>    &#125;<br>&#125;<br><br>impl_from_for_primitives!(<span class="hljs-type">u8</span> <span class="hljs-type">u16</span> <span class="hljs-type">u32</span> <span class="hljs-type">u64</span> <span class="hljs-type">i8</span> <span class="hljs-type">i16</span> <span class="hljs-type">i32</span> <span class="hljs-type">i64</span> <span class="hljs-type">f32</span> <span class="hljs-type">f64</span> <span class="hljs-type">isize</span> <span class="hljs-type">usize</span>);<br><br><span class="hljs-meta">#[macro_export]</span><br><span class="hljs-built_in">macro_rules!</span> json &#123;<br>    (null) =&gt; &#123;<br>        Json::Null<br>    &#125;;<br>    ([ $( $element: tt),* ]) =&gt; &#123;<br>        Json::<span class="hljs-title function_ invoke__">Array</span>(<span class="hljs-built_in">vec!</span>[ $( json!($element)), * ])<br>    &#125;;<br>    (&#123; $( $key:tt : $value:tt ),* &#125;) =&gt; &#123;<br>        Json::<span class="hljs-title function_ invoke__">Object</span>(HashMap::<span class="hljs-title function_ invoke__">from</span>([<br>            $(<br>                ( $key.<span class="hljs-title function_ invoke__">to_string</span>(), json!($value) )<br>            ), *<br>        ]))<br>    &#125;;<br>    ($value: tt) =&gt; &#123;<br>        Json::<span class="hljs-title function_ invoke__">from</span>($value)<br>    &#125;;<br>&#125;<br><br><span class="hljs-meta">#[cfg(test)]</span><br><span class="hljs-keyword">mod</span> tests &#123;<br>    <span class="hljs-keyword">use</span> super::*;<br><br>    <span class="hljs-meta">#[test]</span><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">test_null_json</span>() &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">json</span> = json!(null);<br>        <span class="hljs-built_in">assert_eq!</span>(json, Json::Null);<br>    &#125;<br><br>    <span class="hljs-meta">#[test]</span><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">test_boolean_number_string_json</span>() &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">json</span> = json!(<span class="hljs-literal">true</span>);<br>        <span class="hljs-built_in">assert_eq!</span>(json, Json::<span class="hljs-title function_ invoke__">Boolean</span>(<span class="hljs-literal">true</span>));<br><br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">json</span> = json!(<span class="hljs-number">1.0</span>);<br>        <span class="hljs-built_in">assert_eq!</span>(json, Json::<span class="hljs-title function_ invoke__">Number</span>(<span class="hljs-number">1.0</span>));<br><br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">json</span> = json!(<span class="hljs-string">&quot;hello&quot;</span>);<br>        <span class="hljs-built_in">assert_eq!</span>(json, Json::<span class="hljs-title function_ invoke__">String</span>(<span class="hljs-string">&quot;hello&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>()));<br>    &#125;<br><br>    <span class="hljs-meta">#[test]</span><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">test_object_json</span>() &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">json</span> = json!(&#123;<br>            <span class="hljs-string">&quot;null&quot;</span>: null,<br>            <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;hedon&quot;</span>,<br>            <span class="hljs-string">&quot;age&quot;</span>: <span class="hljs-number">10</span>,<br>            <span class="hljs-string">&quot;is_student&quot;</span>: <span class="hljs-literal">true</span>,<br>            <span class="hljs-string">&quot;detail&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;address&quot;</span>: <span class="hljs-string">&quot;beijing&quot;</span>,<br>                <span class="hljs-string">&quot;phone&quot;</span>: <span class="hljs-string">&quot;1234567890&quot;</span><br>            &#125;<br>        &#125;);<br>        <span class="hljs-built_in">assert_eq!</span>(<br>            json,<br>            Json::<span class="hljs-title function_ invoke__">Object</span>(HashMap::<span class="hljs-title function_ invoke__">from</span>([<br>                (<span class="hljs-string">&quot;null&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), Json::Null),<br>                (<span class="hljs-string">&quot;name&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), Json::<span class="hljs-title function_ invoke__">String</span>(<span class="hljs-string">&quot;hedon&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>())),<br>                (<span class="hljs-string">&quot;age&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), Json::<span class="hljs-title function_ invoke__">Number</span>(<span class="hljs-number">10.0</span>)),<br>                (<span class="hljs-string">&quot;is_student&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), Json::<span class="hljs-title function_ invoke__">Boolean</span>(<span class="hljs-literal">true</span>)),<br>                (<br>                    <span class="hljs-string">&quot;detail&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(),<br>                    Json::<span class="hljs-title function_ invoke__">Object</span>(HashMap::<span class="hljs-title function_ invoke__">from</span>([<br>                        (<span class="hljs-string">&quot;address&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), Json::<span class="hljs-title function_ invoke__">String</span>(<span class="hljs-string">&quot;beijing&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>())),<br>                        (<span class="hljs-string">&quot;phone&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), Json::<span class="hljs-title function_ invoke__">String</span>(<span class="hljs-string">&quot;1234567890&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>()))<br>                    ]))<br>                )<br>            ]))<br>        )<br>    &#125;<br><br>    <span class="hljs-meta">#[test]</span><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">test_array_json</span>() &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">json</span> = json!([<span class="hljs-number">1</span>, null, <span class="hljs-string">&quot;string&quot;</span>, <span class="hljs-literal">true</span>]);<br>        <span class="hljs-built_in">assert_eq!</span>(<br>            json,<br>            Json::<span class="hljs-title function_ invoke__">Array</span>(<span class="hljs-built_in">vec!</span>[<br>                Json::<span class="hljs-title function_ invoke__">Number</span>(<span class="hljs-number">1.0</span>),<br>                Json::Null,<br>                Json::<span class="hljs-title function_ invoke__">String</span>(<span class="hljs-string">&quot;string&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>()),<br>                Json::<span class="hljs-title function_ invoke__">Boolean</span>(<span class="hljs-literal">true</span>)<br>            ])<br>        )<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">æœ¬æ–‡åˆ†æ­¥å±•ç¤ºäº†å®ç° json! å®çš„è¿‡ç¨‹ï¼ŒåŒ…æ‹¬å®šä¹‰ Json æšä¸¾å’Œä¸åŒç±»å‹çš„åŒ¹é…è§„åˆ™ã€‚é€šè¿‡è¿™ä¸ªè¿‡ç¨‹ï¼Œè¯»è€…å¯ä»¥æŒæ¡å£°æ˜å®çš„åŸºæœ¬æ¦‚å¿µå’Œå®ç°æ–¹æ³•ã€‚</summary>
    
    
    
    <category term="Rust" scheme="https://hedon.top/categories/Rust/"/>
    
    <category term="Rust å®æˆ˜" scheme="https://hedon.top/categories/Rust/Rust-%E5%AE%9E%E6%88%98/"/>
    
    
    <category term="Rust" scheme="https://hedon.top/tags/Rust/"/>
    
    <category term="å®" scheme="https://hedon.top/tags/%E5%AE%8F/"/>
    
    <category term="å…ƒç¼–ç¨‹" scheme="https://hedon.top/tags/%E5%85%83%E7%BC%96%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>xgo åŸç†æ¢ç´¢</title>
    <link href="https://hedon.top/2024/05/23/go-xgo-explore/"/>
    <id>https://hedon.top/2024/05/23/go-xgo-explore/</id>
    <published>2024-05-23T13:15:10.000Z</published>
    <updated>2024-05-28T15:13:08.693Z</updated>
    
    <content type="html"><![CDATA[<h1 id="go-å•æµ‹-mock-æ–¹æ¡ˆ">Go å•æµ‹ mock æ–¹æ¡ˆ</h1><table><thead><tr class="header"><th>Mock æ–¹æ³•</th><th>åŸç†</th><th>ä¾èµ–</th><th>ä¼˜ç‚¹</th><th>ç¼ºç‚¹</th></tr></thead><tbody><tr class="odd"><td>æ¥å£ Mock</td><td>ä¸ºä¾èµ–é¡¹å®šä¹‰æ¥å£ï¼Œå¹¶æä¾›æ¥å£çš„ Mock å®ç°ã€‚</td><td>éœ€è¦å®šä¹‰æ¥å£å’Œ Mock å®ç°ã€‚</td><td>çµæ´»ï¼Œéµå¾ª Go çš„ç±»å‹ç³»ç»Ÿï¼›æ˜“äºæ›¿æ¢å®ç°ã€‚</td><td>éœ€è¦æ›´å¤šçš„æ ·æ¿ä»£ç æ¥å®šä¹‰æ¥å£å’Œ Mock å®ç°ã€‚</td></tr><tr class="even"><td>Monkey Patchingï¼ˆbouk/monekyï¼‰</td><td>ç›´æ¥ä¿®æ”¹å‡½æ•°æŒ‡é’ˆçš„å†…å­˜åœ°å€æ¥å®ç°å¯¹å‡½æ•°çš„æ›¿æ¢ã€‚</td><td>å†…å­˜ä¿æŠ¤ï¼›æ±‡ç¼–ä»£ç ã€‚</td><td>å¼ºå¤§ï¼Œå¯ä»¥ Mock ä»»ä½•å‡½æ•°ï¼Œç”šè‡³ç¬¬ä¸‰æ–¹åº“çš„å‡½æ•°ã€‚</td><td>å¤æ‚ï¼Œå®¹æ˜“å‡ºé”™ï¼›çº¿ç¨‹ä¸å®‰å…¨ï¼›ä¾èµ–ç³»ç»ŸæŒ‡ä»¤é›†ã€‚</td></tr></tbody></table><h1 id="boukmonkey-å¼Šç«¯">bouk/monkey å¼Šç«¯</h1><blockquote><p><a href="https://github.com/bouk/monkey">bouk/monkey</a> ğŸ’</p></blockquote><p>monkey çš„æ ¸å¿ƒåŠŸèƒ½æ˜¯èƒ½å¤Ÿåœ¨è¿è¡Œæ—¶æ›¿æ¢æŸä¸ªå‡½æ•°çš„å®ç°ã€‚</p><p><strong>åŸç†ï¼š</strong></p><ol type="1"><li><strong>å‡½æ•°æŒ‡é’ˆæ›¿æ¢</strong>ï¼šåœ¨ Goè¯­è¨€ä¸­ï¼Œå‡½æ•°çš„åœ°å€å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚bouk/monkeyé€šè¿‡ç›´æ¥ä¿®æ”¹å‡½æ•°æŒ‡é’ˆçš„å†…å­˜åœ°å€æ¥å®ç°å¯¹å‡½æ•°çš„æ›¿æ¢ã€‚</li><li><strong>æ±‡ç¼–ä»£ç </strong>ï¼šä½¿ç”¨äº†æ±‡ç¼–ä»£ç æ¥å®ç°å¯¹å‡½æ•°å…¥å£çš„è·³è½¬ã€‚è¿™äº›æ±‡ç¼–ä»£ç ä¼šåœ¨å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œå°†æ‰§è¡Œæµé‡å®šå‘åˆ°æ–°çš„å‡½æ•°å®ç°ã€‚</li><li><strong>å†…å­˜ä¿æŠ¤</strong>ï¼šä¸ºäº†ä¿®æ”¹å†…å­˜ä¸­çš„å‡½æ•°æŒ‡é’ˆï¼Œbouk/monkeyéœ€è¦ä¸´æ—¶ä¿®æ”¹å†…å­˜é¡µé¢çš„ä¿æŠ¤å±æ€§ï¼ˆä¾‹å¦‚ï¼Œå°†é¡µé¢è®¾ä¸ºå¯å†™ï¼‰ã€‚åœ¨ä¿®æ”¹å®Œæ¯•åï¼Œå®ƒä¼šæ¢å¤åŸæ¥çš„ä¿æŠ¤å±æ€§ã€‚</li><li><strong>åå°„ä¸ unsafe åŒ…</strong>ï¼šåˆ©ç”¨ Go çš„åå°„æœºåˆ¶å’Œ unsafeåŒ…ï¼Œbouk/monkey å¯ä»¥è·å–å¹¶æ“ä½œå‡½æ•°çš„åº•å±‚å®ç°ç»†èŠ‚ã€‚</li></ol><p><strong>å®ç°æ­¥éª¤ï¼š</strong></p><ol type="1"><li><strong>ä¿å­˜åŸå‡½æ•°</strong>ï¼šåœ¨æ›¿æ¢å‡½æ•°ä¹‹å‰ï¼Œbouk/monkeyä¼šä¿å­˜åŸå§‹å‡½æ•°çš„æŒ‡é’ˆï¼Œä»¥ä¾¿åœ¨éœ€è¦æ—¶æ¢å¤æˆ–è°ƒç”¨åŸå§‹å‡½æ•°ã€‚</li><li><strong>ç”Ÿæˆè·³è½¬ä»£ç </strong>ï¼šbouk/monkeyç”Ÿæˆä¸€æ®µæ±‡ç¼–è·³è½¬ä»£ç ï¼Œè¿™æ®µä»£ç ä¼šåœ¨å‡½æ•°è°ƒç”¨æ—¶ï¼Œå°†æ‰§è¡Œæµè·³è½¬åˆ°æ–°çš„å‡½æ•°å®ç°ã€‚</li><li><strong>ä¿®æ”¹å‡½æ•°æŒ‡é’ˆ</strong>ï¼šä½¿ç”¨ unsafe åŒ…ï¼Œbouk/monkeyä¿®æ”¹ç›®æ ‡å‡½æ•°çš„å…¥å£åœ°å€ï¼ŒæŒ‡å‘ç”Ÿæˆçš„è·³è½¬ä»£ç ã€‚</li><li><strong>æ¢å¤å†…å­˜ä¿æŠ¤</strong>ï¼šåœ¨å®Œæˆä¸Šè¿°ä¿®æ”¹åï¼Œæ¢å¤å†…å­˜é¡µé¢çš„ä¿æŠ¤å±æ€§ã€‚</li></ol><p><strong>æœ‰ä»¥ä¸‹å‡ ä¸ªå¼Šç«¯ï¼š</strong></p><ol type="1"><li>å¦‚æœå¯ç”¨äº†å†…è”ï¼ŒMonkeyæœ‰æ—¶æ— æ³•ä¿®è¡¥å‡½æ•°ã€‚å°è¯•åœ¨ç¦ç”¨å†…è”çš„æƒ…å†µä¸‹è¿è¡Œæµ‹è¯•ï¼Œä¾‹å¦‚:<code>go test -gcflags=-l</code>ã€‚åŒæ ·çš„å‘½ä»¤è¡Œå‚æ•°ä¹Ÿå¯ä»¥ç”¨äºæ„å»ºã€‚</li><li>Monkeyä¸èƒ½åœ¨ä¸€äº›é¢å‘å®‰å…¨çš„æ“ä½œç³»ç»Ÿä¸Šå·¥ä½œï¼Œè¿™äº›æ“ä½œç³»ç»Ÿä¸å…è®¸åŒæ—¶å†™å…¥å’Œæ‰§è¡Œå†…å­˜é¡µã€‚ç›®å‰çš„æ–¹æ³•å¹¶æ²¡æœ‰çœŸæ­£å¯é çš„è§£å†³æ–¹æ¡ˆã€‚</li><li>çº¿ç¨‹ä¸å®‰å…¨çš„ã€‚</li><li>ä¾èµ–æŒ‡ä»¤é›†ã€‚</li></ol><h1 id="å…ˆçœ‹-xgo-æ€ä¹ˆç”¨">å…ˆçœ‹ xgo æ€ä¹ˆç”¨</h1><blockquote><p><a href="https://github.com/xhd2015/xgo">xgo</a> ğŸ˜ˆ</p></blockquote><p>ä»£ç ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">.<br>â”œâ”€â”€ greet.<span class="hljs-keyword">go</span><br>â””â”€â”€ greet_test.<span class="hljs-keyword">go</span><br></code></pre></td></tr></table></figure><p>ç°åœ¨åœ¨ <code>greet.go</code> ä¸­æœ‰ä¸€ä¸ªå‡½æ•° <code>greet</code>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">greet</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello &quot;</span> + s<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨çœŸå®çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œ<code>greet</code>å¯èƒ½è¦å¤æ‚å¾—å¤šï¼Œå®ƒå¯èƒ½ä¼šä¾èµ–å„ç§ç¬¬ä¸‰æ–¹APIï¼Œä¹Ÿå¯èƒ½ä¼šä¾èµ–æ•°æ®åº“ç­‰å¤šç§å¤–éƒ¨ç»„ä»¶ã€‚æ‰€ä»¥åœ¨æµ‹è¯•çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¸Œæœ›å¯¹å…¶è¿›è¡Œ<strong>mock</strong>ï¼Œä½¿å…¶è¿”å›ä¸€ä¸ªå›ºå®šçš„å€¼ï¼Œä¾¿äºæˆ‘ä»¬æ’°å†™å•å…ƒæµ‹è¯•ã€‚</p><p><code>xgo</code> å‚è€ƒäº† <code>go-monkey</code> çš„æ€æƒ³ï¼Œä½†æ˜¯ä¸ä»<strong>ä¿®æ”¹æŒ‡ä»¤</strong> è¿™ä¸ªé€”å¾„å…¥æ‰‹ï¼Œè€Œæ˜¯å¦è¾Ÿè¹Šå¾„ï¼Œä»<strong>ä»£ç é‡å†™</strong> çš„è§’åº¦å®ç°äº† <strong>mock</strong>çš„èƒ½åŠ›ã€‚</p><p>ä¸ºäº†ä½¿ç”¨ <code>xgo</code>ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå®‰è£… <code>xgo</code>è¿™ä¸ªå‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go install github.com/xhd2015/xgo/cmd/xgo@latest<br></code></pre></td></tr></table></figure><p>åŒæ—¶åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­éœ€è¦å¼•å…¥ <code>xgo</code> ä¾èµ–ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go get <span class="hljs-string">&quot;github.com/xhd2015/xgo/runtime/mock&quot;</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ç¼–å†™çš„ <code>greet_test.go</code> å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> xgo_use<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;testing&quot;</span><br><br><span class="hljs-string">&quot;github.com/xhd2015/xgo/runtime/mock&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestOriginGreet</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>res := greet(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;hello world&quot;</span> &#123;<br>t.Fatalf(<span class="hljs-string">&quot;greet() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;hello world&quot;</span>)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestMockGreet</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>mock.Patch(greet, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock &quot;</span> + s<br>&#125;)<br>res := greet(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;mock world&quot;</span> &#123;<br>t.Fatalf(<span class="hljs-string">&quot;greet() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;mock world&quot;</span>)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨ <code>TestMockGreet</code> è¿™ä¸ªå•å…ƒæµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬å°†<code>greet</code> è¿›è¡Œäº† mockï¼Œè¿”å› <code>"mock " + s</code>ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">mock.Patch(greet, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock &quot;</span> + s<br>&#125;)<br></code></pre></td></tr></table></figure><p>ä¸ºäº†ä½¿ç”¨ <code>xgo</code>çš„èƒ½åŠ›ï¼Œæˆ‘ä»¬åœ¨æ‰§è¡Œå•å…ƒæµ‹è¯•çš„æ—¶å€™ï¼Œéœ€è¦è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">xgo <span class="hljs-built_in">test</span> -v ./<br></code></pre></td></tr></table></figure><p>è¾“å‡ºå¤§è‡´å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  xgo-use git:(master) xgo <span class="hljs-built_in">test</span> -v ./<br>xgo is taking a <span class="hljs-keyword">while</span> to setup, please <span class="hljs-built_in">wait</span>...<br>=== RUN   TestOriginGreet<br>--- PASS: TestOriginGreet (0.00s)<br>=== RUN   TestMockGreet<br>--- PASS: TestMockGreet (0.00s)<br>PASS<br>ok      xgo-explore/xgo-use     (cached)<br></code></pre></td></tr></table></figure><h1 id="xgo-çš„æ ¸å¿ƒåŸç†">xgo çš„æ ¸å¿ƒåŸç†</h1><p><code>xgo</code> çš„æ ¸å¿ƒåŸç†æ˜¯åˆ©ç”¨ <code>go build -toolexec</code>çš„èƒ½åŠ›ã€‚</p><p>è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go <span class="hljs-built_in">help</span> build<br></code></pre></td></tr></table></figure><p>æ‰¾åˆ° <code>toolexec</code> çš„ç›¸å…³è¯´æ˜ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">-toolexec <span class="hljs-string">&#x27;cmd args&#x27;</span><br>        a program to use to invoke toolchain programs like vet and asm.<br>        For example, instead of running asm, the go <span class="hljs-built_in">command</span> will run<br>        <span class="hljs-string">&#x27;cmd args /path/to/asm &lt;arguments for asm&gt;&#x27;</span>.<br>        The TOOLEXEC_IMPORTPATH environment variable will be <span class="hljs-built_in">set</span>,<br>        matching <span class="hljs-string">&#x27;go list -f &#123;&#123;.ImportPath&#125;&#125;&#x27;</span> <span class="hljs-keyword">for</span> the package being built.<br></code></pre></td></tr></table></figure><p>ä¸€è¨€ä»¥è”½ä¹‹ï¼š<code>-toolexec</code> å…è®¸å¯¹ go å·¥å…·é“¾è¿›è¡Œæ‹¦æˆªï¼ŒåŒ…æ‹¬<code>vet</code>ã€<code>asm</code>ã€<code>compile</code> å’Œ<code>link</code>ã€‚</p><p>è¿™ç§æŠ€æœ¯ä¹Ÿè¢«ç§°ä¸ºï¼šæ’æ¡©ï¼ˆstubbingï¼‰ã€å¢å¼ºï¼ˆinstrumentationï¼‰å’Œä»£ç é‡å†™ï¼ˆrewritingï¼‰ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/Km9eLWtYFJMiFYP0uC-B29J__5mGvLlSsrD52hWgS_S2nOGSx9PnMybHuqcQljAtTUr5QVVqaHGyyAEwqVPowhPqJvAZHLALdQpj6gzHzb60NLLe91tX87_sAerIGq2mwYMVdBcptglQpJ0QkfmDC-ZHoQ=s2048.png"alt="-toolexec ç¤ºæ„å›¾ï¼ˆæ¥æºï¼šhttps://blog.xhd2015.xyz/zh/posts/xgo-monkey-patching-in-go-using-toolexec/ï¼‰" /><figcaption aria-hidden="true">-toolexecç¤ºæ„å›¾ï¼ˆæ¥æºï¼šhttps://blog.xhd2015.xyz/zh/posts/xgo-monkey-patching-in-go-using-toolexec/ï¼‰</figcaption></figure><p>åŸºäºä¸Šè¿°åˆ†æï¼Œ<code>xgo</code> æå‡ºäº† <strong>ä»£ç é‡å†™</strong>çš„æ€è·¯ï¼Œå®ç°äº† <strong>åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­æ’å…¥æ‹¦æˆªå™¨ä»£ç </strong> çš„åŠŸèƒ½ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240523164815047.png"alt="xgo åœ¨ go build ä¸­çš„ä½œç”¨ä½ç½®ï¼ˆæ¥æºï¼šhttps://blog.xhd2015.xyz/zh/posts/xgo-monkey-patching-in-go-using-toolexec/ï¼‰" /><figcaption aria-hidden="true">xgo åœ¨ go buildä¸­çš„ä½œç”¨ä½ç½®ï¼ˆæ¥æºï¼šhttps://blog.xhd2015.xyz/zh/posts/xgo-monkey-patching-in-go-using-toolexec/ï¼‰</figcaption></figure><p>æ‰€ä»¥ä¸Šè¿°æˆ‘ä»¬çš„ <code>greet.go</code> æ–‡ä»¶ä¸­çš„æºä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">greet</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello &quot;</span> + s<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»è¿‡ <code>xgo</code> ç¼–è¯‘åæœ€ç»ˆå®é™…ç¼–è¯‘çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;runtime&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">greet</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> (r0 <span class="hljs-type">string</span>) &#123;<br>  stop, post := runtime.__xgo_trap(Greet, &amp;s, &amp;r0)<br>  <span class="hljs-keyword">if</span> stop &#123;<br>    <span class="hljs-keyword">return</span><br>  &#125;<br>  <span class="hljs-keyword">defer</span> post()<br>  <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello&quot;</span> + s<br>&#125;<br></code></pre></td></tr></table></figure><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/5e020865-fd1d-49d3-be72-7ee2233a3c5f.png"alt="greet å‡½æ•°é‡å†™å˜åŒ–ç¤ºæ„å›¾ï¼ˆæ¥æºï¼šhttps://blog.xhd2015.xyz/zh/posts/xgo-monkey-patching-in-go-using-toolexec/ï¼‰" /><figcaption aria-hidden="true">greetå‡½æ•°é‡å†™å˜åŒ–ç¤ºæ„å›¾ï¼ˆæ¥æºï¼šhttps://blog.xhd2015.xyz/zh/posts/xgo-monkey-patching-in-go-using-toolexec/ï¼‰</figcaption></figure><p>å¦‚å›¾æ‰€ç¤ºï¼Œä¸€æ—¦å‡½æ•°è¢«è°ƒç”¨ï¼Œå®ƒçš„æ§åˆ¶æµé¦–å…ˆè½¬ç§»åˆ°<code>Trap</code>ï¼Œç„¶åä¸€ç³»åˆ—æ‹¦æˆªå™¨å°†æ ¹æ®å…¶ç›®çš„æ£€æŸ¥å½“å‰è°ƒç”¨æ˜¯å¦åº”è¯¥è¢«Mockã€ä¿®æ”¹ã€è®°å½•æˆ–åœæ­¢ã€‚</p><p>å¦‚æœ <code>greet</code> æ³¨å†Œäº† mock å‡½æ•°ï¼Œé‚£ä¹ˆå°±ä¼šåœ¨<code>__xgo_trap</code> ä¸­è°ƒç”¨ mock çš„å‡½æ•°ï¼Œå¹¶å°†è¿”å›å€¼è®¾ç½®åˆ°<code>r0</code> ä¸Šè¿›è¡Œè¿”å›ï¼Œè€Œè·³è¿‡åŸå§‹çš„æ‰§è¡Œé€»è¾‘ã€‚</p><h1 id="ç¬¬-1-æ­¥æ­»ä»£ç å®ç°">ç¬¬ 1 æ­¥ï¼šæ­»ä»£ç å®ç°</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  01-deadcode git:(master) tree<br>.<br>â”œâ”€â”€ greet.go<br>â”œâ”€â”€ greet_test.go<br>â””â”€â”€ mock.go<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆä»æœ€ç®€å•çš„å®ç°å¼€å§‹ï¼Œé‡‡ç”¨ä¾µå…¥æ€§ä»£ç å®ç° <code>xgo</code>çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œè¿™é‡Œæˆ‘ä»¬è¿˜ç”¨ä¸åˆ° <code>-toolexec</code>ã€‚</p><p>ä»£ç ç»“æ„å¦‚ä¸Šæ‰€ç¤ºï¼Œåœ¨ <code>mock.go</code> ä¸­ï¼Œæˆ‘ä»¬æœ‰å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> mockFuncs = sync.Map&#123;&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">RegisterMockFunc</span><span class="hljs-params">(funcName <span class="hljs-type">string</span>, fun <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br>mockFuncs.Store(funcName, fun)<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>mockFuncs</code>: ç”¨äºæ‰¿è½½å‡½æ•°ä¸ mock å‡½æ•°çš„å¯¹åº”å…³ç³»ï¼Œå…¶ä¸­ keyä¸ºå‡½æ•°åç§°ï¼Œvalue ä¸º mock å‡½æ•°ã€‚æˆ‘ä»¬ä½¿ç”¨ <code>sync.Map</code>æ¥ä¿è¯å¹¶å‘å®‰å…¨ã€‚</li><li><code>RegisterMockFunc</code> ç”¨äºä¸ºæŒ‡å®šçš„ funcName æ³¨å†Œ mockå‡½æ•°ã€‚</li></ul><p>åœ¨ <code>greet.go</code> ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ª <code>Greet</code> å‡½æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Greet</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello &quot;</span> + s<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬è¦å¯¹å…¶æ”¯æŒ mockï¼Œé‚£ä¹ˆéœ€è¦ä¿®æ”¹å…¶å®ç°ä¸ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Greet</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>fun, ok := mockFuncs.Load(<span class="hljs-string">&quot;Greet&quot;</span>)<br><span class="hljs-keyword">if</span> ok &#123;<br>f, ok := fun.(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span>)<br><span class="hljs-keyword">if</span> ok &#123;<br><span class="hljs-keyword">return</span> f(s)<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello &quot;</span> + s<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ä¿®æ”¹åçš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å…ˆåˆ¤æ–­æ˜¯å¦å­˜åœ¨ mock å‡½æ•°ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™æ‰§è¡Œ mockå‡½æ•°ï¼Œå¦åˆ™æ‰§è¡ŒåŸå§‹é€»è¾‘ã€‚</p><p>ç°åœ¨æˆ‘ä»¬åœ¨ <code>greet_test.go</code> ä¸­ç¼–å†™æµ‹è¯•ä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestMockGreet</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>RegisterMockFunc(<span class="hljs-string">&quot;Greet&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock &quot;</span> + s<br>&#125;)<br>res := Greet(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;mock world&quot;</span> &#123;<br>t.Fatalf(<span class="hljs-string">&quot;Greet() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;mock world&quot;</span>)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestOriginGreet</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>res := Greet(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;hello world&quot;</span> &#123;<br>t.Fatalf(<span class="hljs-string">&quot;Greet() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;hello world&quot;</span>)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œæµ‹è¯•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å•ç‹¬æ‰§è¡Œ TestMockGreet</span><br>âœ  01-deadcode git:(master) âœ— go <span class="hljs-built_in">test</span> -v -run TestMockGreet<br>=== RUN   TestMockGreet<br>--- PASS: TestMockGreet (0.00s)<br>PASS<br>ok      xgo-explore/01-deadcode 0.103s<br><br><span class="hljs-comment"># å•ç‹¬æ‰§è¡Œ TestOriginGreet</span><br>âœ  01-deadcode git:(master) âœ— go <span class="hljs-built_in">test</span> -v -run TestOriginGreet<br>=== RUN   TestOriginGreet<br>--- PASS: TestOriginGreet (0.00s)<br>PASS<br>ok      xgo-explore/01-deadcode 0.102s<br><br><span class="hljs-comment"># ä¸€èµ·æ‰§è¡Œ</span><br>âœ  01-deadcode git:(master) âœ— go <span class="hljs-built_in">test</span> -v -run $Test$<br>=== RUN   TestMockGreet<br>--- PASS: TestMockGreet (0.00s)<br>=== RUN   TestOriginGreet<br>    greet_test.go:20: Greet() = <span class="hljs-string">&quot;mock world&quot;</span>; want <span class="hljs-string">&quot;hello world&quot;</span><br>--- FAIL: TestOriginGreet (0.00s)<br>FAIL<br><span class="hljs-built_in">exit</span> status 1<br>FAIL    xgo-explore/01-deadcode 0.102s<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¼šå‘ç°å•ç‹¬æ‰§è¡Œéƒ½æ˜¯ ok çš„ï¼Œä¸è¿‡ä¸€èµ·æ‰§è¡Œçš„è¯<code>TestOriginGreet</code> å°±å¤±è´¥äº†ï¼Œè¿™æ˜¯å› ä¸ºå…ˆæ‰§è¡Œäº†<code>TestMockGreet</code>ï¼Œè¿™ä¸ªæ—¶å€™å·²ç»å¾€ <code>mockFunc</code>ä¸­æ³¨å†Œäº† mock å‡½æ•°äº†ï¼Œæ‰€ä»¥ <code>TessOriginGreet</code>å°±æ‰§è¡Œå¤±è´¥äº†ã€‚</p><p>è¿™é‡Œéœ€è¦åœ¨åç¨‹å±‚é¢ä¸Šåš mock éš”ç¦»ï¼Œ<code>xgo</code>çš„æ€è·¯æ˜¯åœ¨ç¼–è¯‘æ—¶æ³¨å…¥ <code>getg()</code>å‡½æ•°æ¥è·å–å½“å‰åç¨‹ä¿¡æ¯ä»è€Œå®ç°åœ¨æ³¨å†Œ mockå‡½æ•°æ—¶è¿›è¡Œåç¨‹éš”ç¦»ã€‚æœ¬æ–‡å°†èšç„¦åœ¨ <code>xgo</code> çš„æ ¸å¿ƒåŸç†<strong>ä»£ç é‡å†™</strong> ä¸Šï¼Œæ•…æš‚æ—¶ä¸è€ƒè™‘è¿™ä¸€å—ã€‚</p><p>Okï¼Œé‚£ä¹ˆçŸ­çŸ­å‡ è¡Œä»£ç ï¼Œæˆ‘ä»¬å°±å°† <code>xgo</code>çš„æœ€æ ¸å¿ƒæ€æƒ³ç»™å±•ç¤ºå‡ºæ¥äº†ã€‚å¯ä»¥çœ‹åˆ°ï¼Œ<code>xgo</code>çš„æ ¸å¿ƒæ€æƒ³æ˜¯å¾€æºä»£ç ä¸­åŠ å…¥ <strong>åˆæ³•çš„ Goä»£ç </strong>ï¼Œæ‰€ä»¥ä¸æ¶‰åŠæŒ‡ä»¤é‡å†™ï¼Œæ•…è€Œåªè¦ä½ çš„æœºå™¨èƒ½æ‰§è¡Œ Goç¨‹åºï¼Œå¤©ç„¶å°±æ”¯æŒ mockåŠŸèƒ½ï¼Œè¿™å°±å¤©ç„¶è¾¾åˆ°äº†æ¶æ„æ— å…³çš„å…¼å®¹æ€§äº†ã€‚åŒæ—¶æˆ‘ä»¬ä¹Ÿä½¿ç”¨äº†<code>sync.Map</code> æ¥ä¿è¯äº†å¹¶å‘å®‰å…¨ã€‚</p><h1 id="ç¬¬-2-æ­¥æ­»ä»£ç æ‹¦æˆªå™¨">ç¬¬ 2 æ­¥ï¼šæ­»ä»£ç æ‹¦æˆªå™¨</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  02-deadcode-interceptor git:(master) tree<br>.<br>â”œâ”€â”€ greet.go<br>â”œâ”€â”€ greet_test.go<br>â””â”€â”€ mock.go<br></code></pre></td></tr></table></figure><p>åœ¨ç¬¬ 1 æ­¥ä¸­ï¼Œè¿™æ®µä»£ç æˆ‘è§‰å¾—æœ‰ç‚¹å†—é•¿äº†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">fun, ok := mockFuncs.Load(<span class="hljs-string">&quot;Greet&quot;</span>)<br><span class="hljs-keyword">if</span> ok &#123;<br>  f, ok := fun.(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span>)<br>  <span class="hljs-keyword">if</span> ok &#123;<br>    <span class="hljs-keyword">return</span> f(s)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å‚è€ƒ <code>xgo</code> çš„å‡½æ•°ç­¾åï¼Œæˆ‘ä»¬å¯¹å…¶è¿›è¡Œä¼˜åŒ–ï¼Œåœ¨<code>mock.go</code> ä¸­åŠ å…¥ä¸€ä¸ª <strong>ä¸ç‰ˆæ‹¦æˆªå™¨</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// mock.go</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InterceptMock</span><span class="hljs-params">(funcName <span class="hljs-type">string</span>, arg <span class="hljs-type">string</span>, result *<span class="hljs-type">string</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>fn, ok := mockFuncs.Load(funcName)<br><span class="hljs-keyword">if</span> ok &#123;<br>f, ok := fn.(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span>)<br><span class="hljs-keyword">if</span> ok &#123;<br>*result = f(arg)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹åº” <code>greet.go</code> ä¸­ <code>Greet</code> å‡½æ•°å°±ä¿®æ”¹ä¸ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Greet</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> (res <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">if</span> InterceptMock(<span class="hljs-string">&quot;Greet&quot;</span>, s, &amp;res) &#123;<br><span class="hljs-keyword">return</span> res<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello &quot;</span> + s<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™çœ‹èµ·æ¥å°±æ¸…çˆ½å¤šäº†ã€‚å†æ¬¡æ‰§è¡Œæµ‹è¯•ä»£ç ï¼Œä¸€æ ·æ˜¯å¯ä»¥é€šè¿‡çš„ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  02-deadcode-interceptor git:(master) go <span class="hljs-built_in">test</span> -v -run TestOriginGreet<br>=== RUN   TestOriginGreet<br>--- PASS: TestOriginGreet (0.00s)<br>PASS<br>ok      xgo-explore/02-deadcode-interceptor     0.331s<br><br>âœ  02-deadcode-interceptor git:(master) go <span class="hljs-built_in">test</span> -v -run TestMockGreet<br>=== RUN   TestMockGreet<br>--- PASS: TestMockGreet (0.00s)<br>PASS<br>ok      xgo-explore/02-deadcode-interceptor     0.103s<br></code></pre></td></tr></table></figure><h1 id="ç¬¬-3-æ­¥toolexec-åˆæ¢">ç¬¬ 3 æ­¥ï¼štoolexec åˆæ¢</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  03-toolexec-static git:(master) tree<br>.<br>â”œâ”€â”€ cmd<br>â”‚Â Â  â””â”€â”€ mytool<br>â”‚Â Â      â””â”€â”€ mytool.go<br>â”œâ”€â”€ greet.go<br>â”œâ”€â”€ main.go<br>â”œâ”€â”€ mock.go<br>â””â”€â”€ script.sh<br></code></pre></td></tr></table></figure><p>è¿™é‡Œ <code>mock.go</code> æ²¡æœ‰ä»»ä½•å˜åŒ–ã€‚æˆ‘ä»¬æœŸæœ›ä½¿ç”¨<code>-toolexec</code> æ¥ä¿®æ”¹æºä»£ç ï¼Œä»¥å®ç° mockæ— æºä»£ç ä¾µå…¥çš„ç‰¹æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ <code>greet.to</code> ä¸­å°†<code>Greet</code> å‡½æ•°æ¢å¤ä¸ºåªå…³æ³¨å®é™…åŠŸèƒ½çš„æ ·å­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Greet</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> (res <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello &quot;</span> + s<br>&#125;<br></code></pre></td></tr></table></figure><p>åŒæ—¶ä¸ºäº†æ›´å¥½åœ°æµ‹è¯•ä½¿ç”¨ <code>-toolexec</code>ç¼–è¯‘åçš„è¿è¡Œç»“æœï¼Œè¿™é‡Œå°† <code>greet_test.go</code> åˆ é™¤äº†å¹¶æ–°å¢äº†<code>main.go</code> æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>res := Greet(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;hello world&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Greet() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;hello world&quot;</span>)<br>&#125;<br><br>RegisterMockFunc(<span class="hljs-string">&quot;Greet&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock &quot;</span> + s<br>&#125;)<br>res = Greet(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;mock world&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Greet() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;mock world&quot;</span>)<br>&#125;<br><br>log.Println(<span class="hljs-string">&quot;run successfully&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆ <code>-toolexec</code> è¦æ‰§è¡Œçš„å‘½ä»¤æ€ä¹ˆå®ç°å‘¢ï¼Ÿåœ¨ Google æœç´¢<strong>go toolexec</strong> ä½ ä¼šçœ‹åˆ°å®˜æ–¹ç»™å‡ºçš„ä¸€ä¸ªæ¡ˆä¾‹ï¼š<ahref="https://go.dev/src/cmd/go/testdata/script/toolexec.txt">toolexec.txt</a>ã€‚</p><p>æ ¸å¿ƒéƒ¨åˆ†åœ¨æœ€ä¸‹é¢ï¼Œå‚è€ƒè¿™ä¸ªç¤ºä¾‹ï¼Œæˆ‘ä»¬æ¥å®ç°è‡ªå·±çš„<code>toolexec</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p cmd/mytool<br><span class="hljs-built_in">touch</span> cmd/mytool/mytool.go<br></code></pre></td></tr></table></figure><p>åœ¨<code>mytool.go</code>ä¸­ï¼Œæˆ‘ä»¬å…ˆå†™è¿™ä¹ˆç‚¹ä»£ç ï¼Œçœ‹ä¸€ä¸‹ä¼šè¾“å‡ºä»€ä¹ˆã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>tool, args := os.Args[<span class="hljs-number">1</span>], os.Args[<span class="hljs-number">2</span>:]<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(args) &gt; <span class="hljs-number">0</span> &amp;&amp; args[<span class="hljs-number">0</span>] == <span class="hljs-string">&quot;-V=full&quot;</span> &#123;<br><span class="hljs-comment">// don&#x27;t do anything to infuence the version full output.</span><br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(args) &gt; <span class="hljs-number">0</span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;tool: %s\n&quot;</span>, tool)<br>fmt.Printf(<span class="hljs-string">&quot;args: %v\n&quot;</span>, args)<br>&#125;<br>  <span class="hljs-comment">// ç»§ç»­æ‰§è¡Œä¹‹å‰çš„å‘½ä»¤</span><br>cmd := exec.Command(tool, args...)<br>cmd.Stdout = os.Stdout<br>cmd.Stderr = os.Stderr<br><br><span class="hljs-keyword">if</span> err := cmd.Run(); err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;run command error: %v\n&quot;</span>, err)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬ä¼å›¾è¾“å‡ºæ‰§è¡Œçš„å·¥å…· <code>tool</code> åŠä¼ ç»™å®ƒçš„å‚æ•°<code>args</code>ã€‚ç”±äº <code>-V=full</code>çš„ä½œç”¨æ˜¯åœ¨ç»ˆç«¯è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦è·³è¿‡å®ƒï¼Œé¿å…äº§ç”Ÿå¹²æ‰°ã€‚è¾“å‡ºæ—¥å¿—åï¼Œæˆ‘ä»¬æš‚ä¸”å…ˆç»§ç»­æ‰§è¡ŒåŸå§‹çš„å‘½ä»¤ï¼Œä¸å¯¹ç¼–è¯‘è¿‡ç¨‹åšå…¶ä»–çš„å¹²æ‰°ã€‚</p><p>Okï¼Œç°åœ¨å°±æ¥çœ‹çœ‹è¿™ä¸ª <code>-toolexec</code> åˆ°åº•åšäº†ä»€ä¹ˆï¼Œåœ¨<code>03-toolexec-static</code> ç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æ¸…é™¤ç¼“å­˜ï¼Œä¸€ç›´ä½¿ç”¨æœ€æ–°çš„ç¼–è¯‘ç»“æœ</span><br>go clean -cache -modcache -i -r<br><span class="hljs-comment"># ç¼–è¯‘ mytool</span><br>go build ./cmd/mytool<br><span class="hljs-comment"># ç¼–è¯‘ä¸šåŠ¡ç¨‹åº</span><br>go build -toolexec=./mytool -o main<br></code></pre></td></tr></table></figure><p>å› ä¸ºè¿™å‡ ä¸ªå‘½ä»¤ç»å¸¸ä¼šç”¨åˆ°ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†å…¶å°è£…åˆ°<code>script.sh</code> æ–‡ä»¶ä¸­ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">touch</span> script.sh<br><span class="hljs-built_in">chmod</span> +x script.sh<br></code></pre></td></tr></table></figure><p>å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><br>go clean -cache -modcache -i -r<br>go build ./cmd/mytool<br>go build -toolexec=./mytool -o main<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œä¸Šè¿°å‘½ä»¤åï¼Œå¯ä»¥çœ‹åˆ°ä»¥ä¸‹è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  03-toolexec-static git:(master) ./script.sh<br><span class="hljs-comment"># xgo-explore/03-toolexec-static</span><br>tool: /opt/homebrew/Cellar/go/1.22.3/libexec/pkg/tool/darwin_arm64/compile<br>args: [-o <span class="hljs-variable">$WORK</span>/b001/_pkg_.a -trimpath <span class="hljs-variable">$WORK</span>/b001=&gt; -p main -lang=go1.22 -complete -buildid PcS9clqF_ny_Ds5N0i_s/PcS9clqF_ny_Ds5N0i_s -goversion go1.22.3 -c=4 -shared -nolocalimports -importcfg <span class="hljs-variable">$WORK</span>/b001/importcfg -pack ./greet.go ./main.go ./mock.go]<br><span class="hljs-comment"># xgo-explore/03-toolexec-static</span><br>tool: /opt/homebrew/Cellar/go/1.22.3/libexec/pkg/tool/darwin_arm64/link<br>args: [-o <span class="hljs-variable">$WORK</span>/b001/exe/a.out -importcfg <span class="hljs-variable">$WORK</span>/b001/importcfg.link -buildmode=pie -buildid=KgnnCoU_6enHkOm-T62Z/PcS9clqF_ny_Ds5N0i_s/H80dtgGZw1L8mTtVqJBf/KgnnCoU_6enHkOm-T62Z -extld=cc <span class="hljs-variable">$WORK</span>/b001/_pkg_.a]<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ‰§è¡Œäº† <code>compile</code> å’Œ <code>link</code>ä¸¤ä¸ªå·¥å…·ï¼Œ<code>compile</code> æ˜¯ç¼–è¯‘è¿‡ç¨‹ï¼Œå°†ç”Ÿæˆ <code>&#123;&#125;.out</code>æ–‡ä»¶ï¼Œè€Œ <code>link</code> æ˜¯å°†å¤šä¸ª <code>&#123;&#125;.out</code>æ–‡ä»¶é“¾æ¥æˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ã€‚è¿™æ˜¯å¾ˆç»å…¸çš„ç¼–è¯‘è¿‡ç¨‹ï¼Œå¦‚æœå¯¹ Goè¯­è¨€çš„ç¼–è¯‘è¿‡ç¨‹æ„Ÿå…´è¶£ï¼Œä¹Ÿå¯ä»¥å‚è€ƒå®˜æ–¹çš„ <ahref="https://github.com/golang/go/tree/release-branch.go1.22/src/cmd/compile">GoCompile Readme</a>ï¼Œæˆ–è€…ç¬”è€…æ’°å†™çš„ <ahref="https://hedon.top/2023/11/29/go-compilation/">Go1.21.0ç¨‹åºç¼–è¯‘è¿‡ç¨‹</a>ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬éœ€è¦é‡ç‚¹å…³æ³¨çš„æ˜¯ <code>compile</code>å‘½ä»¤ï¼Œå®ƒæ˜¯è´Ÿè´£ç¼–è¯‘æºä»£ç çš„ï¼Œæ¶‰åŠåˆ°çš„æºä»£ç æ–‡ä»¶ä¼šé€šè¿‡<code>-pack ./greet.go ./main.go ./mock.go</code> ä¼ é€’ç»™<code>compile</code> å‘½ä»¤ã€‚</p><p>ç»“åˆ <code>-toolexec</code> çš„å¸®åŠ©ä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">-toolexec <span class="hljs-string">&#x27;cmd args&#x27;</span><br>        a program to use to invoke toolchain programs like vet and asm.<br>        For example, instead of running asm, the go <span class="hljs-built_in">command</span> will run<br>        <span class="hljs-string">&#x27;cmd args /path/to/asm &lt;arguments for asm&gt;&#x27;</span>.<br>        The TOOLEXEC_IMPORTPATH environment variable will be <span class="hljs-built_in">set</span>,<br>        matching <span class="hljs-string">&#x27;go list -f &#123;&#123;.ImportPath&#125;&#125;&#x27;</span> <span class="hljs-keyword">for</span> the package being built.<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬åªéœ€è¦åœ¨æ‰§è¡Œ <code>compile</code> å‘½ä»¤ä¹‹å‰ï¼Œåœ¨<code>cmd args</code> è¿™ä¸ªç¯èŠ‚ï¼Œè¿›è¡Œ <strong>ä»£ç é‡å†™</strong>å°±å¯ä»¥å®ç°æˆ‘ä»¬æƒ³è¦çš„åŠŸèƒ½äº†ã€‚</p><p>æˆ‘ä»¬ç°åœ¨æ˜¯è¦å¯¹ <code>greet.go</code> é‡Œé¢çš„ <code>Greet</code>å‡½æ•°è¿›è¡Œé‡å†™ï¼Œå…ˆçœ‹çœ‹ä¹‹å‰çš„ä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Greet</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> (res <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello &quot;</span> + s<br>&#125;<br></code></pre></td></tr></table></figure><p>é‡å†™åçš„ä»£ç åº”è¯¥è·Ÿæˆ‘ä»¬ä¹‹å‰ <strong>ç¬¬ 2 æ­¥</strong> æ˜¯ä¸€æ ·çš„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Greet</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> (res <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">if</span> InterceptMock(<span class="hljs-string">&quot;Greet&quot;</span>, s, &amp;res) &#123;<br> <span class="hljs-keyword">return</span> res<br>    &#125;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello &quot;</span> + s<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ nå¤šç§æ–¹å¼å¯ä»¥åšåˆ°ï¼Œç°åœ¨ç¬”è€…å†³å®šä½¿ç”¨æœ€æš´åŠ›çš„æ–¹å¼ï¼Œç›´æ¥ä¸´æ—¶åˆ›å»ºä¸€ä¸ªåŒ…å«è¿™æ®µä»£ç çš„æ–‡ä»¶<code>tmp.go</code>ï¼Œå¹¶æ›¿æ¢æ‰ä¼ ç»™ <code>compile</code> çš„å‚æ•°ï¼Œå³å°†<code>-pack ./greet.go ./main.go ./mock.go</code> æ›¿æ¢ä¸º<code>-pack tmp.go ./main.go ./mock.go</code></p><p>ç»¼ä¸Šï¼Œ<code>cmd/mytool/mytool/go</code> å®ç°çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>tool, args := os.Args[<span class="hljs-number">1</span>], os.Args[<span class="hljs-number">2</span>:]<br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(args) &gt; <span class="hljs-number">0</span> &amp;&amp; args[<span class="hljs-number">0</span>] == <span class="hljs-string">&quot;-V=full&quot;</span> &#123;<br><span class="hljs-comment">// don&#x27;t do anything to infuence the version full output.</span><br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(args) &gt; <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">if</span> filepath.Base(tool) == <span class="hljs-string">&quot;compile&quot;</span> &#123;<br>index := findGreetFile(args)<br><span class="hljs-keyword">if</span> index &gt; <span class="hljs-number">-1</span> &#123;<br>f, err := os.Create(<span class="hljs-string">&quot;tmp.go&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;create tmp.go error: %v\n&quot;</span>, err)<br>&#125;<br><span class="hljs-keyword">defer</span> f.Close()<br><span class="hljs-keyword">defer</span> os.Remove(<span class="hljs-string">&quot;tmp.go&quot;</span>)<br>_, _ = f.WriteString(newCode)<br>args[index] = <span class="hljs-string">&quot;tmp.go&quot;</span><br>&#125;<br>&#125;<br>fmt.Printf(<span class="hljs-string">&quot;tool: %s\n&quot;</span>, tool)<br>fmt.Printf(<span class="hljs-string">&quot;args: %v\n&quot;</span>, args)<br>&#125;<br><span class="hljs-comment">// ç»§ç»­æ‰§è¡Œä¹‹å‰çš„å‘½ä»¤</span><br>cmd := exec.Command(tool, args...)<br>cmd.Stdout = os.Stdout<br>cmd.Stderr = os.Stderr<br><br><span class="hljs-keyword">if</span> err := cmd.Run(); err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;run command error: %v\n&quot;</span>, err)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">findGreetFile</span><span class="hljs-params">(args []<span class="hljs-type">string</span>)</span></span> <span class="hljs-type">int</span> &#123;<br><span class="hljs-keyword">for</span> i, arg := <span class="hljs-keyword">range</span> args &#123;<br><span class="hljs-keyword">if</span> strings.Contains(arg, <span class="hljs-string">&quot;greet.go&quot;</span>) &#123;<br><span class="hljs-keyword">return</span> i<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-number">-1</span><br>&#125;<br><br><span class="hljs-keyword">var</span> newCode = <span class="hljs-string">`</span><br><span class="hljs-string">package main</span><br><span class="hljs-string"></span><br><span class="hljs-string">func Greet(s string) (res string) &#123;</span><br><span class="hljs-string">if InterceptMock(&quot;Greet&quot;, s, &amp;res) &#123;</span><br><span class="hljs-string"> return res</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">return &quot;hello &quot; + s</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">`</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘å…ˆä½¿ç”¨ <code>findGreetFile</code> æ¥æŸ¥æ‰¾ <code>greet.go</code>æ–‡ä»¶æ‰€å¤„çš„å‚æ•°ä½ç½®ï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œåˆ™ç”Ÿæˆæ–°çš„ <code>tmp.go</code>æ–‡ä»¶ï¼Œå¹¶æ›¿æ¢å‚æ•°ï¼Œæœ€ååœ¨ æœ¬æ¬¡ <code>compile</code> å‘½ä»¤æ‰§è¡Œå®Œæ¯•åï¼Œåˆ é™¤<code>tmp.go</code>ï¼Œâ€œæ¯å°¸ç­è¿¹â€ã€‚</p><p>æ‰§è¡Œ <code>./script.sh</code> é‡æ–°ç¼–è¯‘ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  03-toolexec-static git:(master) âœ— ./script.sh<br><span class="hljs-comment"># xgo-explore/03-toolexec-static</span><br>tool: /opt/homebrew/Cellar/go/1.22.3/libexec/pkg/tool/darwin_arm64/compile<br>args: [-o <span class="hljs-variable">$WORK</span>/b001/_pkg_.a -trimpath <span class="hljs-variable">$WORK</span>/b001=&gt; -p main -lang=go1.22 -complete -buildid PcS9clqF_ny_Ds5N0i_s/PcS9clqF_ny_Ds5N0i_s -goversion go1.22.3 -c=4 -shared -nolocalimports -importcfg <span class="hljs-variable">$WORK</span>/b001/importcfg -pack tmp.go ./main.go ./mock.go]<br><span class="hljs-comment"># xgo-explore/03-toolexec-static</span><br>tool: /opt/homebrew/Cellar/go/1.22.3/libexec/pkg/tool/darwin_arm64/link<br>args: [-o <span class="hljs-variable">$WORK</span>/b001/exe/a.out -importcfg <span class="hljs-variable">$WORK</span>/b001/importcfg.link -buildmode=pie -buildid=KgnnCoU_6enHkOm-T62Z/PcS9clqF_ny_Ds5N0i_s/H80dtgGZw1L8mTtVqJBf/KgnnCoU_6enHkOm-T62Z -extld=cc <span class="hljs-variable">$WORK</span>/b001/_pkg_.a]<br></code></pre></td></tr></table></figure><p>è¾“å‡ºçš„ç»“æœä¸­å¯ä»¥çœ‹åˆ°å·²ç»å°† <code>compile</code> çš„å‚æ•°æ›¿æ¢ä¸º<code>-pack tmp.go ./main.go ./mock.go</code> äº†ã€‚</p><p>ç°åœ¨æˆ‘ä»¬æ¥æ‰§è¡Œç”Ÿæˆçš„ç¨‹åºæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯æ‰§è¡ŒæˆåŠŸçš„ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  03-toolexec-static git:(master) âœ— ./main<br>2024/05/23 17:53:52 run successfully<br></code></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬ä¸ä½¿ç”¨ <code>-toolexec</code>ï¼Œæ˜¯æ‰§è¡Œä¸æˆåŠŸçš„ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  03-toolexec-static git:(master) âœ— go clean -cache -modcache -i -r<br>âœ  03-toolexec-static git:(master) âœ— go build -o main<br>âœ  03-toolexec-static git:(master) âœ— ./main<br>2024/05/23 17:54:33 Greet() = <span class="hljs-string">&quot;hello world&quot;</span>; want <span class="hljs-string">&quot;mock world&quot;</span><br></code></pre></td></tr></table></figure><h1 id="ç¬¬-4-æ­¥ä½¿ç”¨-ast-åœ¨å‡½æ•°å‰æ’å…¥ä»£ç ">ç¬¬ 4 æ­¥ï¼šä½¿ç”¨ ASTåœ¨å‡½æ•°å‰æ’å…¥ä»£ç </h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  04-toolexec-ast git:(master) âœ— tree<br>.<br>â”œâ”€â”€ cmd<br>â”‚Â Â  â””â”€â”€ mytool<br>â”‚Â Â      â””â”€â”€ mytool.go<br>â”œâ”€â”€ greet.go<br>â”œâ”€â”€ main.go<br>â”œâ”€â”€ mock.go<br>â””â”€â”€ script.sh<br></code></pre></td></tr></table></figure><p>æš´åŠ›æ›¿æ¢æºä»£ç æ–‡ä»¶çš„æ–¹å¼å¯èƒ½æ˜¯ä¸å¤ªä¼˜é›…å“ˆï¼Œå‡å¦‚æˆ‘ä»¬çš„<code>greet.go</code> å†…å®¹æ”¹æˆä¸‹é¢è¿™æ ·ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Greet</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> (res <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello &quot;</span> + s<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Greet2</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> (res <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello 2 &quot;</span> + s<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬æƒ³å¯¹ <code>Greet2</code> ä¹Ÿè¿›è¡Œ<strong>ä»£ç é‡å†™</strong>ï¼Œé‚£å°±éœ€è¦ä¿®æ”¹å‰é¢ <code>newCode</code>å­—æ®µçš„å†…å®¹ï¼Œè€Œä¸”å®ƒæ˜¯å†™æ­»çš„ï¼Œç¡®å®ä¸å¤ªä¼˜é›…ã€‚ç°åœ¨æˆ‘ä»¬æ­£å¼æ¥é¢å¯¹è¿™ä»¶äº‹ï¼Œå¯¹æ¯”ä¿®æ”¹åçš„å‡½æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Greet</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> (res <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">if</span> InterceptMock(<span class="hljs-string">&quot;Greet&quot;</span>, s, &amp;res) &#123;<br> <span class="hljs-keyword">return</span> res<br>    &#125;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello &quot;</span> + s<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶å®å°±æ˜¯åœ¨æ¯ä¸ªå‡½æ•°å‰åŠ ä¸Šè¿™ä¹ˆä¸€æ®µï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> InterceptMock(<span class="hljs-string">&quot;Greet&quot;</span>, s, &amp;res) &#123;<br><span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><p>äº†è§£è¿‡ç¼–è¯‘åŸç†çš„è¯»è€…åº”è¯¥å¯ä»¥æƒ³åˆ°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ“ä½œæºä»£ç çš„ ASTç»“æ„ï¼Œå¾€å‡½æ•°çš„å¼€å¤´æ’å…¥è¿™æ®µä»£ç å³å¯ã€‚å¦‚æœæˆ‘ä»¬å…ˆä¸è€ƒè™‘å‚æ•°å’Œè¿”å›å€¼çš„è¯ï¼Œé‚£è¿™æ®µä»£ç æˆ‘ä»¬éœ€è¦æ›¿æ¢çš„åœ°æ–¹å°±æ˜¯å‡½æ•°åç§°äº†ï¼Œæ‰€ä»¥å®ƒçš„ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> InterceptMock(<span class="hljs-string">&quot;$&#123;funcName&#125;&quot;</span>, s, &amp;res) &#123;<br><span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°å‡ ä¸ªæ ‡å‡†åº“å·¥å…·ï¼š</p><ul><li><code>go/ast</code>: åŒ…å®šä¹‰äº† Goç¼–ç¨‹è¯­è¨€çš„æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰ï¼Œæ ¸å¿ƒæœ‰ä»¥ä¸‹å‡ ç§ç±»å‹ï¼š<ul><li><code>File</code>: è¡¨ç¤ºä¸€ä¸ª Go æºæ–‡ä»¶ã€‚</li><li><code>Decl</code>:è¡¨ç¤ºä¸€ä¸ªå£°æ˜ï¼ŒåŒ…æ‹¬å‡½æ•°å£°æ˜ã€å˜é‡å£°æ˜ã€ç±»å‹å£°æ˜ç­‰ã€‚</li><li><code>Stmt</code>: è¡¨ç¤ºä¸€ä¸ªè¯­å¥ã€‚</li><li><code>Expr</code>: è¡¨ç¤ºä¸€ä¸ªè¡¨è¾¾å¼ã€‚</li></ul></li><li><code>go/token</code>: å®šä¹‰äº†å¤„ç† Goæºä»£ç çš„è¯æ³•å…ƒç´ çš„åŸºç¡€è®¾æ–½ï¼ŒåŒ…æ‹¬ä½ç½®ã€æ ‡è®°å’Œæ ‡è¯†ç¬¦ç­‰ã€‚è¿™ä¸ªåŒ…æä¾›äº†ç”¨äºç®¡ç†æºä»£ç ä½ç½®çš„ä¿¡æ¯ï¼Œå¯ä»¥å¸®åŠ©å®šä½ä»£ç ä¸­çš„ç‰¹å®šéƒ¨åˆ†ã€‚</li><li><code>go/parser</code>: å°†ä¸€ä¸ª <code>.go</code> æ–‡ä»¶ä»¥è§£ææˆ ASTç»“æ„ã€‚</li><li><code>go/printer</code>: æä¾›äº†å°† AST æ ¼å¼åŒ–å¹¶è¾“å‡ºä¸º Goæºç çš„åŠŸèƒ½</li></ul><p>ä¿®æ”¹åçš„ <code>cmd/mytool/mytool.go</code> ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>tool, args := os.Args[<span class="hljs-number">1</span>], os.Args[<span class="hljs-number">2</span>:]<br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(args) &gt; <span class="hljs-number">0</span> &amp;&amp; args[<span class="hljs-number">0</span>] == <span class="hljs-string">&quot;-V=full&quot;</span> &#123;<br><span class="hljs-comment">// don&#x27;t do anything to infuence the version full output.</span><br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(args) &gt; <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">if</span> filepath.Base(tool) == <span class="hljs-string">&quot;compile&quot;</span> &#123;<br>index := findGreetFile(args)<br><span class="hljs-keyword">if</span> index &gt; <span class="hljs-number">-1</span> &#123;<br>filename := args[index]<br>f, err := os.Create(<span class="hljs-string">&quot;tmp.go&quot;</span>)<br><span class="hljs-keyword">defer</span> f.Close()<br><span class="hljs-keyword">defer</span> os.Remove(<span class="hljs-string">&quot;tmp.go&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;create tmp.go error: %v\n&quot;</span>, err)<br>&#125;<br>_, _ = f.WriteString(insertCode(filename))<br>args[index] = <span class="hljs-string">&quot;tmp.go&quot;</span><br>&#125;<br>&#125;<br>fmt.Printf(<span class="hljs-string">&quot;tool: %s\n&quot;</span>, tool)<br>fmt.Printf(<span class="hljs-string">&quot;args: %v\n&quot;</span>, args)<br>&#125;<br><span class="hljs-comment">// ç»§ç»­æ‰§è¡Œä¹‹å‰çš„å‘½ä»¤</span><br>cmd := exec.Command(tool, args...)<br>cmd.Stdout = os.Stdout<br>cmd.Stderr = os.Stderr<br><br><span class="hljs-keyword">if</span> err := cmd.Run(); err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;run command error: %v\n&quot;</span>, err)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">findGreetFile</span><span class="hljs-params">(args []<span class="hljs-type">string</span>)</span></span> <span class="hljs-type">int</span> &#123;<br><span class="hljs-keyword">for</span> i, arg := <span class="hljs-keyword">range</span> args &#123;<br><span class="hljs-keyword">if</span> strings.Contains(arg, <span class="hljs-string">&quot;greet.go&quot;</span>) &#123;<br><span class="hljs-keyword">return</span> i<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-number">-1</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">insertCode</span><span class="hljs-params">(filename <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>fset := token.NewFileSet()<br>fast, err := parser.ParseFile(fset, filename, <span class="hljs-literal">nil</span>, parser.AllErrors)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;parse file error: %v\n&quot;</span>, err)<br>&#125;<br><br><span class="hljs-keyword">for</span> _, decl := <span class="hljs-keyword">range</span> fast.Decls &#123;<br>fun, ok := decl.(*ast.FuncDecl)<br><span class="hljs-keyword">if</span> !ok &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><br>f, err := os.Create(<span class="hljs-string">&quot;tmp2.go&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;create tmp2.go error: %v\n&quot;</span>, err)<br>&#125;<br>_, _ = f.WriteString(fmt.Sprintf(newCodeFormat, fun.Name.Name))<br>f.Close()<br><br>tmpFset := token.NewFileSet()<br>tmpF, err := parser.ParseFile(tmpFset, <span class="hljs-string">&quot;tmp2.go&quot;</span>, <span class="hljs-literal">nil</span>, parser.AllErrors)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;parse tmp2.go error: %v\n&quot;</span>, err)<br>&#125;<br>fun.Body.List = <span class="hljs-built_in">append</span>(tmpF.Decls[<span class="hljs-number">0</span>].(*ast.FuncDecl).Body.List, fun.Body.List...)<br>os.Remove(<span class="hljs-string">&quot;tmp2.go&quot;</span>)<br>&#125;<br><br><span class="hljs-keyword">var</span> buf bytes.Buffer<br>printer.Fprint(&amp;buf, fset, fast)<br><br>fmt.Println(buf.String())<br><br><span class="hljs-keyword">return</span> buf.String()<br>&#125;<br><br><span class="hljs-keyword">var</span> newCodeFormat = <span class="hljs-string">`</span><br><span class="hljs-string">package main</span><br><span class="hljs-string"></span><br><span class="hljs-string">func TmpFunc() &#123;</span><br><span class="hljs-string">if InterceptMock(&quot;%s&quot;, s, &amp;res) &#123;</span><br><span class="hljs-string"> return res</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">`</span><br></code></pre></td></tr></table></figure><p>æ ¸å¿ƒçš„ä¿®æ”¹åœ¨äº <code>insertCode</code> å‡½æ•°ï¼š</p><ol type="1"><li><p>ä½¿ç”¨ <code>parser.ParseFile</code> å°†æºä»£ç æ–‡ä»¶è§£ææˆ ASTç»“æ„ï¼›</p></li><li><p>éå† AST ç»“æ„ï¼Œæ‰¾åˆ°æ‰€æœ‰çš„å£°æ˜ï¼ˆDeclï¼‰ç»“æ„ï¼Œå¹¶ä½¿ç”¨<code>decl(.ast.FuncDecl)</code> æ‰¾åˆ°æ‰€æœ‰çš„å‡½æ•°ï¼›</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go">FuncDecl <span class="hljs-keyword">struct</span> &#123;<br>  Doc  *CommentGroup <span class="hljs-comment">// associated documentation; or nil</span><br>  Recv *FieldList    <span class="hljs-comment">// receiver (methods); or nil (functions)</span><br>  Name *Ident        <span class="hljs-comment">// function/method name</span><br>  Type *FuncType     <span class="hljs-comment">// function signature: type and value parameters, results, and position of &quot;func&quot; keyword</span><br>  Body *BlockStmt    <span class="hljs-comment">// function body; or nil for external (non-Go) function</span><br>&#125;<br><br>BlockStmt <span class="hljs-keyword">struct</span> &#123;<br>  Lbrace token.Pos <span class="hljs-comment">// position of &quot;&#123;&quot;</span><br>  List   []Stmt<br>  Rbrace token.Pos <span class="hljs-comment">// position of &quot;&#125;&quot;, if any (may be absent due to syntax error)</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹ <code>ast.FuncDecl</code> çš„ç»“æ„åï¼Œå¯ä»¥å¾—å‡ºä¸‹ä¸€æ­¥å°±æ˜¯å¾€<code>FuncDecl.Body.List</code> åˆ—è¡¨å‰é¢æ’å…¥ä¸€äº›<code>Stmt</code>ï¼›</p></li><li><p>ç¬”è€…æ²¡æ‰¾åˆ°ç±»ä¼¼ <code>parseStmt</code>æ–¹æ³•ï¼Œæ‰€ä»¥å–äº†ä¸ªå·§ï¼Œæˆ‘å®šä¹‰äº†ä¸€æ®µä»£ç çš„ <code>format</code>ï¼Œé‡Œé¢çš„<code>%s</code> ä¼šä½¿ç”¨ <code>fun.Name.Name</code>è·å–å‡½æ•°åå¹¶è¿›è¡Œæ›¿æ¢ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> newCodeFormat = <span class="hljs-string">`</span><br><span class="hljs-string">package main</span><br><span class="hljs-string"></span><br><span class="hljs-string">func TmpFunc() &#123;</span><br><span class="hljs-string">if InterceptMock(&quot;%s&quot;, s, &amp;res) &#123;</span><br><span class="hljs-string"> return res</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">`</span><br></code></pre></td></tr></table></figure></li><li><p>åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ <code>tmp2.go</code>å¹¶å†™å…¥æ ¼å¼åŒ–åçš„ä»£ç ï¼Œç„¶åå†æ¬¡è°ƒç”¨ <code>parser.ParseFile</code>å¾—åˆ°è§£æè¿™æ®µä»£ç çš„æŠ½è±¡è¯­æ³•æ ‘ç»“æ„ <code>tmpF</code> äº†ï¼›</p></li><li><p>ç„¶åé€šè¿‡ <code>tmpF.Decls[0].(*ast.FuncDecl).Body.List</code>å°±å¯ä»¥å¾—åˆ° <code>TmpFunc</code> ä¸­çš„è¯­å¥ <code>Stmt</code> äº†ï¼›</p></li><li><p>å°†å…¶åŠ åœ¨æºä»£ç å‡½æ•°çš„å‰é¢å³å¯ï¼š<code>fun.Body.List = append(tmpF.Decls[0].(*ast.FuncDecl).Body.List, fun.Body.List...)</code>ï¼›</p></li><li><p>ç„¶åå†ä½¿ç”¨ <code>go/printer</code> å°†ä¿®æ”¹åçš„ ASTè¾“å‡ºä¸ºæ–°æ–‡ä»¶å†…å®¹ã€‚</p></li></ol><p>é€šè¿‡ä¸Šè¿°æ­¥éª¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¸º <code>greet.go</code>ä¸­çš„æ¯ä¸ªå‡½æ•°å‰é¢éƒ½æ’å…¥æ‰“æ¡©ä»£ç äº†ã€‚</p><p>ä¿®æ”¹ <code>main.go</code> é‡Œé¢çš„å†…å®¹ï¼ŒåŠ å…¥å¯¹ <code>Greet2</code>çš„æµ‹è¯•ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>res := Greet(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;hello world&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Greet() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;hello world&quot;</span>)<br>&#125;<br><br>RegisterMockFunc(<span class="hljs-string">&quot;Greet&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock &quot;</span> + s<br>&#125;)<br>res = Greet(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;mock world&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Greet() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;mock world&quot;</span>)<br>&#125;<br><br>log.Println(<span class="hljs-string">&quot;run greet 1 successfully&quot;</span>)<br><br>RegisterMockFunc(<span class="hljs-string">&quot;Greet2&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock 2 &quot;</span> + s<br>&#125;)<br>res = Greet2(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;mock 2 world&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Greet2() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;mock 2 world&quot;</span>)<br>&#125;<br><br>log.Println(<span class="hljs-string">&quot;run greet 2 successfully&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œè„šæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./script.sh<br></code></pre></td></tr></table></figure><p>è¾“å‡ºåº”è¯¥è¿˜æ˜¯è·Ÿä¹‹å‰æ˜¯ä¸€æ ·çš„ï¼Œæˆ‘ä»¬è¿è¡Œç”Ÿæˆçš„å¯æ‰§è¡Œå‡½æ•°ï¼Œå¾—åˆ°å¦‚ä¸‹ç»“æœé‚£å°±è¯´æ˜æˆ‘ä»¬åˆæˆåŠŸè¿›äº†ä¸€æ­¥äº†~</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  04-toolexec-ast git:(master) âœ— ./main<br>2024/05/23 20:03:22 run greet 1 successfully<br>2024/05/23 20:03:22 run greet 2 successfully<br></code></pre></td></tr></table></figure><h1 id="ç¬¬-5-æ­¥ä½¿ç”¨-reflect-åå°„åŠ¨æ€è·å–å‚æ•°å’Œè¿”å›å€¼åç§°">ç¬¬ 5 æ­¥ï¼šä½¿ç”¨reflect åå°„åŠ¨æ€è·å–å‚æ•°å’Œè¿”å›å€¼åç§°</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  05-toolexec-general git:(master) âœ— tree<br>.<br>â”œâ”€â”€ cmd<br>â”‚Â Â  â””â”€â”€ mytool<br>â”‚Â Â      â””â”€â”€ mytool.go<br>â”œâ”€â”€ greet.go<br>â”œâ”€â”€ main.go<br>â”œâ”€â”€ mock.go<br>â””â”€â”€ script.sh<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å¤„ç†å‡½æ•°ç­¾åä¸­çš„å‚æ•°å’Œè¿”å›å€¼éƒ¨åˆ†ï¼Œæˆ‘ä»¬çš„æ ·æ¿ä»£ç ä¸­ï¼Œå†™æ­»äº†å‚æ•°çš„åç§°å’Œè¿”å›å€¼çš„åç§°ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦æ¥åŠ¨æ€è·å–å‡½æ•°å‚æ•°çš„åç§°å’Œè¿”å›å€¼çš„åç§°ï¼Œå¦‚æœè¿”å›å€¼æ²¡æœ‰åç§°ï¼Œé‚£æˆ‘ä»¬è¿˜éœ€è¦æ‰‹åŠ¨è®¾ç½®åç§°ã€‚</p><p>æˆ‘ä»¬å°† <code>greet.to</code> ä¿®æ”¹ä¸ºä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Greet</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> (res <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello &quot;</span> + s<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Greet2</span><span class="hljs-params">(s2 <span class="hljs-type">string</span>)</span></span> (res2 <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello 2 &quot;</span> + s2<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Greet3</span><span class="hljs-params">(s3 <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello 3 &quot;</span> + s3<br>&#125;<br></code></pre></td></tr></table></figure><p>å‡½æ•°çš„ä¿¡æ¯å½“ç„¶éƒ½åœ¨å‰é¢è·å¾—çš„ <code>ast.FuncDecl</code>ç»“æ„ä¸­ï¼Œå†æ¬¡è§‚å¯Ÿå…¶ç»“æ„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">FuncDecl <span class="hljs-keyword">struct</span> &#123;<br>Doc  *CommentGroup <span class="hljs-comment">// associated documentation; or nil</span><br>Recv *FieldList    <span class="hljs-comment">// receiver (methods); or nil (functions)</span><br>Name *Ident        <span class="hljs-comment">// function/method name</span><br>Type *FuncType     <span class="hljs-comment">// function signature: type and value parameters, results, and position of &quot;func&quot; keyword</span><br>Body *BlockStmt    <span class="hljs-comment">// function body; or nil for external (non-Go) function</span><br>&#125;<br></code></pre></td></tr></table></figure><p>é€šè¿‡æ³¨é‡Šå°±å¯ä»¥çŸ¥é“ <code>Type</code>å­—æ®µå°±åŒ…å«äº†å‚æ•°å’Œè¿”å›å€¼çš„ç›¸å…³ä¿¡æ¯ï¼ŒæŸ¥çœ‹ <code>FuncType</code>ç»“æ„ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">FuncType <span class="hljs-keyword">struct</span> &#123;<br>  Func       token.Pos  <span class="hljs-comment">// position of &quot;func&quot; keyword (token.NoPos if there is no &quot;func&quot;)</span><br>  TypeParams *FieldList <span class="hljs-comment">// type parameters; or nil</span><br>  Params     *FieldList <span class="hljs-comment">// (incoming) parameters; non-nil</span><br>  Results    *FieldList <span class="hljs-comment">// (outgoing) results; or nil</span><br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>Params</code>ï¼šå‡½æ•°å‚æ•°</li><li><code>Results</code>ï¼šå‡½æ•°è¿”å›å€¼</li></ul><p>æŸ¥çœ‹ <code>FieldList</code> ç»“æ„ï¼Œå¯çŸ¥å‚æ•°åˆ—è¡¨å’Œè¿”å›å€¼åˆ—è¡¨éƒ½åœ¨ç›¸åº”çš„<code>List</code> å­—æ®µä¸­ï¼Œè€Œå…¶ä¸­çš„ <code>Names</code>å­—æ®µå°±æ˜¯å‚æ•°çš„åç§°äº†ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> FieldList <span class="hljs-keyword">struct</span> &#123;<br>Opening token.Pos <span class="hljs-comment">// position of opening parenthesis/brace/bracket, if any</span><br>List    []*Field  <span class="hljs-comment">// field list; or nil</span><br>Closing token.Pos <span class="hljs-comment">// position of closing parenthesis/brace/bracket, if any</span><br>&#125;<br><br><span class="hljs-keyword">type</span> Field <span class="hljs-keyword">struct</span> &#123;<br>Doc     *CommentGroup <span class="hljs-comment">// associated documentation; or nil</span><br>Names   []*Ident      <span class="hljs-comment">// field/method/(type) parameter names; or nil</span><br>Type    Expr          <span class="hljs-comment">// field/method/parameter type; or nil</span><br>Tag     *BasicLit     <span class="hljs-comment">// field tag; or nil</span><br>Comment *CommentGroup <span class="hljs-comment">// line comments; or nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¡¥å……ä¸€ä¸‹ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆ <code>Names</code> ç±»å‹æ˜¯ <code>[]*Ident</code>å‘¢ï¼Ÿå› ä¸ºå‡½æ•°æœ‰ä»¥ä¸‹çš„å‘½åæ–¹å¼ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">hello</span><span class="hljs-params">(s1, s2 <span class="hljs-type">string</span>)</span></span> (r1, r1 <span class="hljs-type">string</span>) &#123;&#125;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆåœ¨å½“ä¸‹ï¼Œåªæœ‰ 1 ä¸ªå‚æ•°å’Œåªæœ‰ 1 ä¸ªè¿”å›å€¼çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡<code>fun.Type.Params.List[0].Names[0].Name</code>æ¥è·å–å‚æ•°åç§°ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ <code>fun.Type.Results.List[0].Names</code>æ¥è·å–è¿”å›å€¼åç§°ï¼Œå¦‚æœè¿”å›å€¼æ²¡æœ‰åç§°ï¼Œé‚£æˆ‘ä»¬å°±ä¸ºå…¶è®¾ç½®åç§°<code>__xgo_res_1</code> å¹¶å†™å›æº ASTç»“æ„ã€‚è¿™æ ·å°±éƒ½æœ‰åç§°ï¼Œå°±å¾ˆå¥½å¤„ç†äº†ã€‚</p><p>ç»ä¸Šåˆ†æï¼Œ <code>cmd/mytool/mytool.go</code> ä¸­æˆ‘ä»¬åªéœ€è¦ä¿®æ”¹<code>insertCode</code> éƒ¨åˆ†ï¼Œä¿®æ”¹çš„ç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">insertCode</span><span class="hljs-params">(filename <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>fset := token.NewFileSet()<br>fast, err := parser.ParseFile(fset, filename, <span class="hljs-literal">nil</span>, parser.AllErrors)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;parse file error: %v\n&quot;</span>, err)<br>&#125;<br><br><span class="hljs-keyword">for</span> _, decl := <span class="hljs-keyword">range</span> fast.Decls &#123;<br>fun, ok := decl.(*ast.FuncDecl)<br><span class="hljs-keyword">if</span> !ok &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><br>f, err := os.Create(<span class="hljs-string">&quot;tmp.go&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;create tmp.go error: %v\n&quot;</span>, err)<br>&#125;<br>_, _ = f.WriteString(newCode(fun))<br>f.Close()<br><br>tmpFset := token.NewFileSet()<br>tmpF, err := parser.ParseFile(tmpFset, <span class="hljs-string">&quot;tmp.go&quot;</span>, <span class="hljs-literal">nil</span>, parser.AllErrors)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;parse tmp.go error: %v\n&quot;</span>, err)<br>&#125;<br>fun.Body.List = <span class="hljs-built_in">append</span>(tmpF.Decls[<span class="hljs-number">0</span>].(*ast.FuncDecl).Body.List, fun.Body.List...)<br>os.Remove(<span class="hljs-string">&quot;tmp.go&quot;</span>)<br>&#125;<br><br><span class="hljs-keyword">var</span> buf bytes.Buffer<br>printer.Fprint(&amp;buf, fset, fast)<br><br>fmt.Println(buf.String())<br><br><span class="hljs-keyword">return</span> buf.String()<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newCode</span><span class="hljs-params">(fun *ast.FuncDecl)</span></span> <span class="hljs-type">string</span> &#123;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">&amp;&#123;Doc:&lt;nil&gt; Names:[s] Type:string Tag:&lt;nil&gt; Comment:&lt;nil&gt;&#125;</span><br><span class="hljs-comment">&amp;&#123;Doc:&lt;nil&gt; Names:[res] Type:string Tag:&lt;nil&gt; Comment:&lt;nil&gt;&#125;</span><br><span class="hljs-comment">&amp;&#123;Doc:&lt;nil&gt; Names:[s2] Type:string Tag:&lt;nil&gt; Comment:&lt;nil&gt;&#125;</span><br><span class="hljs-comment">&amp;&#123;Doc:&lt;nil&gt; Names:[res2] Type:string Tag:&lt;nil&gt; Comment:&lt;nil&gt;&#125;</span><br><span class="hljs-comment">&amp;&#123;Doc:&lt;nil&gt; Names:[s3] Type:string Tag:&lt;nil&gt; Comment:&lt;nil&gt;&#125;</span><br><span class="hljs-comment">&amp;&#123;Doc:&lt;nil&gt; Names:[] Type:string Tag:&lt;nil&gt; Comment:&lt;nil&gt;&#125;</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-comment">// å‡½æ•°åç§°</span><br>funcName := fun.Name.Name<br><br><span class="hljs-comment">// å‚æ•°åˆ—è¡¨</span><br>argName := fun.Type.Params.List[<span class="hljs-number">0</span>].Names[<span class="hljs-number">0</span>].Name<br><br><span class="hljs-comment">// è¿”å›å€¼åˆ—è¡¨</span><br>resNames := fun.Type.Results.List[<span class="hljs-number">0</span>].Names<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(resNames) == <span class="hljs-number">0</span> &#123;<br>resNames = <span class="hljs-built_in">append</span>(resNames, &amp;ast.Ident&#123;Name: <span class="hljs-string">&quot;_xgo_res_1&quot;</span>&#125;)<br>fun.Type.Results.List[<span class="hljs-number">0</span>].Names = resNames<br>&#125;<br>resName := resNames[<span class="hljs-number">0</span>].Name<br><span class="hljs-keyword">return</span> fmt.Sprintf(newCodeFormat, funcName, argName, resName, resName)<br>&#125;<br><br><span class="hljs-keyword">var</span> newCodeFormat = <span class="hljs-string">`</span><br><span class="hljs-string">package main</span><br><span class="hljs-string"></span><br><span class="hljs-string">func TmpFunc() &#123;</span><br><span class="hljs-string">if InterceptMock(&quot;%s&quot;, %s, &amp;%s) &#123;</span><br><span class="hljs-string"> return %s</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">`</span><br></code></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥åŠ¨æ€è·å–å‚æ•°åç§°å’Œè¿”å›å€¼åç§°äº†ã€‚</p><p>ä¿®æ”¹æˆ‘ä»¬çš„ <code>main.go</code>ï¼Œä»¥æµ‹è¯•æ‰€æœ‰çš„æƒ…å†µï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>res := Greet(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;hello world&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Greet() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;hello world&quot;</span>)<br>&#125;<br><br>RegisterMockFunc(<span class="hljs-string">&quot;Greet&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock &quot;</span> + s<br>&#125;)<br>res = Greet(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;mock world&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Greet() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;mock world&quot;</span>)<br>&#125;<br><br>log.Println(<span class="hljs-string">&quot;run greet 1 successfully&quot;</span>)<br><br>RegisterMockFunc(<span class="hljs-string">&quot;Greet2&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock 2 &quot;</span> + s<br>&#125;)<br>res = Greet2(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;mock 2 world&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Greet2() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;mock 2 world&quot;</span>)<br>&#125;<br><br>log.Println(<span class="hljs-string">&quot;run greet 2 successfully&quot;</span>)<br><br>RegisterMockFunc(<span class="hljs-string">&quot;Greet3&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock 3 &quot;</span> + s<br>&#125;)<br>res = Greet3(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;mock 3 world&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Greet3() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;mock 3 world&quot;</span>)<br>&#125;<br><br>log.Println(<span class="hljs-string">&quot;run greet 3 successfully&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œç¼–è¯‘è„šæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./script.sh<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œç¼–è¯‘äº§ç”Ÿçš„å¯æ‰§è¡Œç¨‹åºï¼Œè¾“å‡ºå¦‚ä¸‹å°±è¯´æ˜æˆ‘ä»¬åˆæˆåŠŸè¿›äº†ä¸€å¤§æ­¥~</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  05-toolexec-general git:(master) âœ— ./main<br>2024/05/23 20:15:08 run greet 1 successfully<br>2024/05/23 20:15:08 run greet 2 successfully<br>2024/05/23 20:15:08 run greet 3 successfully<br></code></pre></td></tr></table></figure><h1 id="ç¬¬-6-æ­¥æ”¯æŒå¤šå‚æ•°å’Œå¤šè¿”å›å€¼">ç¬¬ 6 æ­¥ï¼šæ”¯æŒå¤šå‚æ•°å’Œå¤šè¿”å›å€¼</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  06-toolexec-multi git:(master) âœ— tree<br>.<br>â”œâ”€â”€ cmd<br>â”‚Â Â  â””â”€â”€ mytool<br>â”‚Â Â      â””â”€â”€ mytool.go<br>â”œâ”€â”€ greet.go<br>â”œâ”€â”€ main.go<br>â”œâ”€â”€ mock.go<br>â””â”€â”€ script.sh<br></code></pre></td></tr></table></figure><p>æœ¬æ–‡çš„æœ€åä¸€æ­¥ï¼Œæˆ‘ä»¬æ¥é¢å¯¹ä¸€ä¸‹å¤šå‚æ•°å’Œå¤šè¿”å›å€¼çš„é—®é¢˜ã€‚å‡è®¾æˆ‘ä»¬åˆå¦‚ä¸‹å‡½æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Pair1</span><span class="hljs-params">(s1, s2 <span class="hljs-type">string</span>)</span></span> (res <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;pair 1 &quot;</span> + s1 + <span class="hljs-string">&quot; &quot;</span> + s2<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬ <strong>ä»£ç é‡å†™</strong>ååº”è¯¥é•¿ä»€ä¹ˆæ ·å­å‘¢ï¼Ÿå¯ä»¥æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Pair1</span><span class="hljs-params">(s1, s2 <span class="hljs-type">string</span>)</span></span> (res <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">if</span> InterceptMock(<span class="hljs-string">&quot;Pair1&quot;</span>, s1, s2, &amp;res) &#123;<br><span class="hljs-keyword">return</span> res<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;pair 1 &quot;</span> + s1 + <span class="hljs-string">&quot; &quot;</span> + s2<br>&#125;<br></code></pre></td></tr></table></figure><p>æŒ‰ç…§è¿™ä¸ªæ€è·¯ï¼Œä¸‹é¢è¿™ä¸ªå‡½æ•°å‘¢ï¼Ÿ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Pair2</span><span class="hljs-params">(s1, s2 <span class="hljs-type">string</span>)</span></span> (res1, res2 <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;pair 1 &quot;</span> + s1, <span class="hljs-string">&quot;pair 2 &quot;</span> + s2<br>&#125;<br></code></pre></td></tr></table></figure><p>é‚£å°±æ˜¯è¿™æ ·çš„ï¼Ÿ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Pair2</span><span class="hljs-params">(s1, s2 <span class="hljs-type">string</span>)</span></span> (res1, res2 <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">if</span> InterceptMock(<span class="hljs-string">&quot;Pair2&quot;</span>, s1, s2, &amp;res1, &amp;res2) &#123;<br><span class="hljs-keyword">return</span> res1, res2<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;pair 1 &quot;</span> + s1, <span class="hljs-string">&quot;pair 2 &quot;</span> + s2<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ç§æ€è·¯å½“ç„¶ä¹Ÿèƒ½å®ç°ï¼Œæ¢ä¸€ç§æ›´ä¼˜é›…çš„æ€è·¯å‘¢ï¼Ÿæ—¢ç„¶æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç”¨åˆ‡ç‰‡æ¥æ‰¿è½½ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Pair2</span><span class="hljs-params">(s1, s2 <span class="hljs-type">string</span>)</span></span> (res1, res2 <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">if</span> InterceptMock(<span class="hljs-string">&quot;Pair2&quot;</span>, []<span class="hljs-keyword">interface</span>&#123;&#125;&#123;s1, s2&#125;, []<span class="hljs-keyword">interface</span>&#123;&#125;&#123;&amp;res1, &amp;res2&#125;) &#123;<br><span class="hljs-keyword">return</span> res1, res2<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;pair 1 &quot;</span> + s1, <span class="hljs-string">&quot;pair 2 &quot;</span> + s2<br>&#125;<br></code></pre></td></tr></table></figure><p>é‚£æˆ‘ä»¬å°±å¯ä»¥æŠ½è±¡å‡ºæ’å…¥ä»£ç çš„æ¨¡æ¿äº†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> InterceptMock(<span class="hljs-string">&quot;$&#123;funcName&#125;&quot;</span>, []<span class="hljs-keyword">interface</span>&#123;&#125;&#123;$&#123;paramList&#125;&#125;, []<span class="hljs-keyword">interface</span>&#123;&#125;&#123;$&#123;returnListWith&amp;&#125;&#125;) &#123;<br>  <span class="hljs-keyword">return</span> $&#123;returnListWithout&amp;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸ºäº†å®ç°è¿™ä¸ªï¼Œæˆ‘ä»¬éœ€è¦å…ˆä¿®æ”¹ä¸€ä¸‹ <code>mock.go</code> ä¸­çš„<code>InterceptMock</code> å‡½æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InterceptMock</span><span class="hljs-params">(funcName <span class="hljs-type">string</span>, args []<span class="hljs-keyword">interface</span>&#123;&#125;, results []<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> <span class="hljs-type">bool</span> &#123;<br>mockFn, ok := mockFuncs.Load(funcName)<br><span class="hljs-keyword">if</span> !ok &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><br><br>in := <span class="hljs-built_in">make</span>([]reflect.Value, <span class="hljs-built_in">len</span>(args))<br><span class="hljs-keyword">for</span> i, arg := <span class="hljs-keyword">range</span> args &#123;<br>in[i] = reflect.ValueOf(arg)<br>&#125;<br><br>  mockFnValue := reflect.ValueOf(mockFn)<br>out := mockFnValue.Call(in)<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(out) != <span class="hljs-built_in">len</span>(results) &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;mock function return value number is not equal to results number&quot;</span>)<br>&#125;<br><br><span class="hljs-keyword">for</span> i, result := <span class="hljs-keyword">range</span> results &#123;<br>reflect.ValueOf(result).Elem().Set(out[i])<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ‹¦æˆªå™¨çš„å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p><ol type="1"><li>åˆ¤æ–­æ˜¯å¦æ³¨å†Œäº† mock å‡½æ•°ï¼Œæ²¡æœ‰åˆ™ç›´æ¥è¿”å›ï¼›</li><li>å°†æ‰€æœ‰å‚æ•°éƒ½æ”¾åˆ° <code>[]refect.Value</code> ä¸­ï¼›</li><li>é€šè¿‡åå°„ <code>refect.ValueOf</code> è·å– mockFn çš„å€¼ï¼›</li><li>è°ƒç”¨ <code>mockFnValue.Call()</code>æ¥æ‰§è¡Œå‡½æ•°ï¼Œå¹¶è¿”å›ç»“æœåˆ—è¡¨ï¼›</li><li>éå†ä¼ è¿›æ¥çš„è¿”å›å€¼å¼•ç”¨åˆ—è¡¨ï¼Œè°ƒç”¨<code>reflect.ValueOf(result).Elem().Set(out[i])</code>å°†è¿”å›å€¼è®¾ç½®å›å»ã€‚</li></ol><p>ç°åœ¨æˆ‘ä»¬æ¥ä¿®æ”¹æˆ‘ä»¬çš„ <code>-toolexec</code> å·¥å…·ï¼Œæ¥æ ¹æ®å‡½æ•°çš„ ASTç»“æ„ï¼Œè·å–å‚æ•°åˆ—è¡¨å’Œè¿”å›å€¼åˆ—è¡¨ï¼Œç”Ÿæˆä»£æ’å…¥çš„æ¨¡æ¿ä»£ç ï¼Œå¹¶å°†å…¶æ’å…¥åˆ°æ¯ä¸ªå‡½æ•°çš„å¼€å¤´ã€‚è¿™æ¬¡åœ¨<code>cmd/mytool/mytool.go</code> ä¸­ï¼Œæˆ‘ä»¬åªéœ€ä¿®æ”¹ <code>newCode</code>å‡½æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">insertCode</span><span class="hljs-params">(filename <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>fset := token.NewFileSet()<br>fast, err := parser.ParseFile(fset, filename, <span class="hljs-literal">nil</span>, parser.AllErrors)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;parse file error: %v\n&quot;</span>, err)<br>&#125;<br><br><span class="hljs-keyword">for</span> _, decl := <span class="hljs-keyword">range</span> fast.Decls &#123;<br>fun, ok := decl.(*ast.FuncDecl)<br><span class="hljs-keyword">if</span> !ok &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><br>f, err := os.Create(<span class="hljs-string">&quot;tmp.go&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;create tmp.go error: %v\n&quot;</span>, err)<br>&#125;<br>_, _ = f.WriteString(newCode(fun))<br>f.Close()<br><br>tmpFset := token.NewFileSet()<br>tmpF, err := parser.ParseFile(tmpFset, <span class="hljs-string">&quot;tmp.go&quot;</span>, <span class="hljs-literal">nil</span>, parser.AllErrors)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;parse tmp.go error: %v\n&quot;</span>, err)<br>&#125;<br>fun.Body.List = <span class="hljs-built_in">append</span>(tmpF.Decls[<span class="hljs-number">0</span>].(*ast.FuncDecl).Body.List, fun.Body.List...)<br>os.Remove(<span class="hljs-string">&quot;tmp.go&quot;</span>)<br>&#125;<br><br><span class="hljs-keyword">var</span> buf bytes.Buffer<br>printer.Fprint(&amp;buf, fset, fast)<br><br>fmt.Println(buf.String())<br><br><span class="hljs-keyword">return</span> buf.String()<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newCode</span><span class="hljs-params">(fun *ast.FuncDecl)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-comment">// å‡½æ•°åç§°</span><br>funcName := fun.Name.Name<br><br><span class="hljs-comment">// å‚æ•°åˆ—è¡¨</span><br>args := <span class="hljs-built_in">make</span>([]<span class="hljs-type">string</span>, <span class="hljs-number">0</span>)<br><span class="hljs-keyword">for</span> _, arg := <span class="hljs-keyword">range</span> fun.Type.Params.List &#123;<br><span class="hljs-keyword">for</span> _, name := <span class="hljs-keyword">range</span> arg.Names &#123;<br>args = <span class="hljs-built_in">append</span>(args, name.Name)<br>&#125;<br>&#125;<br><span class="hljs-comment">// è¿”å›å€¼åˆ—è¡¨</span><br>returns := <span class="hljs-built_in">make</span>([]<span class="hljs-type">string</span>, <span class="hljs-number">0</span>)<br>returnRefs := <span class="hljs-built_in">make</span>([]<span class="hljs-type">string</span>, <span class="hljs-number">0</span>)<br>returnNames := fun.Type.Results.List[<span class="hljs-number">0</span>].Names<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(returnNames) == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; fun.Type.Results.NumFields(); i++ &#123;<br>fun.Type.Results.List[<span class="hljs-number">0</span>].Names = <span class="hljs-built_in">append</span>(fun.Type.Results.List[<span class="hljs-number">0</span>].Names,<br>&amp;ast.Ident&#123;Name: fmt.Sprintf(<span class="hljs-string">&quot;_xgo_res_%d&quot;</span>, i+<span class="hljs-number">1</span>)&#125;)<br>&#125;<br>&#125;<br><span class="hljs-keyword">for</span> _, re := <span class="hljs-keyword">range</span> fun.Type.Results.List[<span class="hljs-number">0</span>].Names &#123;<br>returns = <span class="hljs-built_in">append</span>(returns, re.Name)<br>returnRefs = <span class="hljs-built_in">append</span>(returnRefs, <span class="hljs-string">&quot;&amp;&quot;</span>+re.Name)<br>&#125;<br><span class="hljs-keyword">return</span> fmt.Sprintf(newCodeFormat,<br>funcName,<br>strings.Join(args, <span class="hljs-string">&quot;,&quot;</span>),<br>strings.Join(returnRefs, <span class="hljs-string">&quot;,&quot;</span>),<br>strings.Join(returns, <span class="hljs-string">&quot;,&quot;</span>))<br>&#125;<br><br><span class="hljs-keyword">var</span> newCodeFormat = <span class="hljs-string">`</span><br><span class="hljs-string">package main</span><br><span class="hljs-string"></span><br><span class="hljs-string">func TmpFunc() &#123;</span><br><span class="hljs-string">if InterceptMock(&quot;%s&quot;, []interface&#123;&#125;&#123;%s&#125;, []interface&#123;&#125;&#123;%s&#125;) &#123;</span><br><span class="hljs-string">return %s</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">`</span><br></code></pre></td></tr></table></figure><p>æ€è·¯è·Ÿä¹‹å‰ç¬¬ 5æ­¥å¤§åŒå°å¼‚ï¼Œä¸è¿‡æ˜¯ç”¨éå†çš„æ–¹å¼æ¥æ”¯æŒå¤šä¸ªå‚æ•°å’Œå¤šä¸ªè¿”å›å€¼ç½¢äº†ã€‚</p><p>ç°åœ¨æˆ‘ä»¬ä¸º <code>greet.go</code> æ·»åŠ æ›´å¤šçš„æµ‹è¯•å‡½æ•°ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Greet</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> (res <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello &quot;</span> + s<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Greet2</span><span class="hljs-params">(s2 <span class="hljs-type">string</span>)</span></span> (res2 <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello 2 &quot;</span> + s2<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Greet3</span><span class="hljs-params">(s3 <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello 3 &quot;</span> + s3<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Pair1</span><span class="hljs-params">(s1, s2 <span class="hljs-type">string</span>)</span></span> (res <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;pair 1 &quot;</span> + s1 + <span class="hljs-string">&quot; &quot;</span> + s2<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Pair2</span><span class="hljs-params">(s1, s2 <span class="hljs-type">string</span>)</span></span> (res1, res2 <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;pair 1 &quot;</span> + s1, <span class="hljs-string">&quot;pair 2 &quot;</span> + s2<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Other</span><span class="hljs-params">(i <span class="hljs-type">int</span>, s <span class="hljs-type">string</span>, f <span class="hljs-type">float64</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">&quot;int: %d, string: %s, float: %f&quot;</span>, i, s, f)<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸ºäº†æµ‹è¯•ï¼Œæˆ‘ä»¬å†æ¬¡ä¿®æ”¹ <code>main.go</code>ï¼Œä½¿å…¶è¦†ç›–æ‰€æœ‰çš„æƒ…å†µï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><br>RegisterMockFunc(<span class="hljs-string">&quot;Other&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-type">int</span>, s <span class="hljs-type">string</span>, f <span class="hljs-type">float64</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">&quot;mock %d %s %.2f&quot;</span>, i, s, f)<br>&#125;)<br>res := Other(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;hello&quot;</span>, <span class="hljs-number">3.14</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;mock 1 hello 3.14&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Other() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;mock 1 hello 3.14&quot;</span>)<br>&#125;<br>log.Println(<span class="hljs-string">&quot;run other successfully&quot;</span>)<br><br>RegisterMockFunc(<span class="hljs-string">&quot;Pair1&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s1, s2 <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock 1 &quot;</span> + s1 + <span class="hljs-string">&quot; &quot;</span> + s2<br>&#125;)<br>res = Pair1(<span class="hljs-string">&quot;hello&quot;</span>, <span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;mock 1 hello world&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Pair1() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;mock 1 hello world&quot;</span>)<br>&#125;<br>log.Println(<span class="hljs-string">&quot;run pair1 successfully&quot;</span>)<br><br>RegisterMockFunc(<span class="hljs-string">&quot;Pair2&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s1, s2 <span class="hljs-type">string</span>)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock 2 &quot;</span> + s1, <span class="hljs-string">&quot;mock 2 &quot;</span> + s2<br>&#125;)<br>res1, res2 := Pair2(<span class="hljs-string">&quot;hello&quot;</span>, <span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res1 != <span class="hljs-string">&quot;mock 2 hello&quot;</span> || res2 != <span class="hljs-string">&quot;mock 2 world&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Pair2() = %q, %q; want %q, %q&quot;</span>, res1, res2, <span class="hljs-string">&quot;mock 2 hello&quot;</span>, <span class="hljs-string">&quot;mock 2 world&quot;</span>)<br>&#125;<br>log.Println(<span class="hljs-string">&quot;run pair2 successfully&quot;</span>)<br><br>res = Greet(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;hello world&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Greet() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;hello world&quot;</span>)<br>&#125;<br><br>RegisterMockFunc(<span class="hljs-string">&quot;Greet&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock &quot;</span> + s<br>&#125;)<br>res = Greet(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;mock world&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Greet() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;mock world&quot;</span>)<br>&#125;<br><br>log.Println(<span class="hljs-string">&quot;run greet 1 successfully&quot;</span>)<br><br>RegisterMockFunc(<span class="hljs-string">&quot;Greet2&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock 2 &quot;</span> + s<br>&#125;)<br>res = Greet2(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;mock 2 world&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Greet2() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;mock 2 world&quot;</span>)<br>&#125;<br><br>log.Println(<span class="hljs-string">&quot;run greet 2 successfully&quot;</span>)<br><br>RegisterMockFunc(<span class="hljs-string">&quot;Greet3&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock 3 &quot;</span> + s<br>&#125;)<br>res = Greet3(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;mock 3 world&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Greet3() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;mock 3 world&quot;</span>)<br>&#125;<br><br>log.Println(<span class="hljs-string">&quot;run greet 3 successfully&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘ä»£ç ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./script.sh<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œç”Ÿæˆçš„å¯æ‰§è¡Œç¨‹åºï¼Œå¦‚æœæœ‰ä»¥ä¸‹è¾“å‡ºï¼Œé‚£æˆ‘ä»¬å°±åˆæˆåŠŸè¿›äº†ä¸€å¤§å¤§æ­¥äº†~</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  06-toolexec-multi git:(master) âœ— ./main<br>2024/05/23 20:31:10 run other successfully<br>2024/05/23 20:31:10 run pair1 successfully<br>2024/05/23 20:31:10 run pair2 successfully<br>2024/05/23 20:31:10 run greet 1 successfully<br>2024/05/23 20:31:10 run greet 2 successfully<br>2024/05/23 20:31:10 run greet 3 successfully<br></code></pre></td></tr></table></figure><h1 id="æ›´è¿›ä¸€æ­¥">æ›´è¿›ä¸€æ­¥</h1><p>é€šè¿‡ä¸Šé¢ 6 ä¸ªç®€å•çš„å°é˜¶æ®µï¼Œæˆ‘ä»¬å°±å·²ç»æŠŠ <code>xgo</code>æœ€æœ€æ ¸å¿ƒçš„åŠŸèƒ½ç»™å®ç°äº†ï¼Œåœ¨ä¸€äº›å°åœºæ™¯ä¸‹è¿˜å‹‰å¼ºèƒ½ç”¨ï¼ŸğŸ¤¡</p><p>æˆ‘ä»¬æ¥çœ‹çœ‹åŒ…å«æµ‹è¯•ä»£ç å’Œæ ·ä¾‹å‡½æ•°ï¼Œæ€»å…±ç”¨äº†å¤šå°‘ä»£ç ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  06-toolexec-multi git:(master) âœ— tokei .<br>===============================================================================<br> Language            Files        Lines         Code     Comments       Blanks<br>===============================================================================<br> Go                      4          281          224           11           46<br> Shell                   1            5            3            1            1<br>===============================================================================<br> Total                   5          286          227           12           47<br>===============================================================================<br></code></pre></td></tr></table></figure><p>çŸ­çŸ­ <strong>224</strong> è¡Œä»£ç ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸äº†ä¸èµ·çš„æˆå°±ï¼</p><p>å½“ç„¶ï¼Œä¼˜ç§€çš„è¯»è€…è‚¯å®šå¯ä»¥å‘ç°æˆ‘ä»¬è¿™ä¸ª <strong>ä¸ç‰ˆ xgo</strong>æœ‰å¤ªå¤šçš„ä¸è¶³å’Œç¼ºé™·äº†ã€‚è¿™æ˜¯å¿…ç„¶çš„ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ <code>xgo</code> æˆªæ­¢<code>1.0.37</code> ç‰ˆæœ¬ï¼Œæ€»å…±æœ‰å¤šå°‘è¡Œä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go">âœ  xgo git:(master) tokei .<br>===============================================================================<br> Language            Files        Lines         Code     Comments       Blanks<br>===============================================================================<br> BASH                    <span class="hljs-number">1</span>          <span class="hljs-number">104</span>           <span class="hljs-number">81</span>           <span class="hljs-number">11</span>           <span class="hljs-number">12</span><br> CSS                     <span class="hljs-number">1</span>          <span class="hljs-number">153</span>          <span class="hljs-number">118</span>            <span class="hljs-number">5</span>           <span class="hljs-number">30</span><br> Go                    <span class="hljs-number">369</span>        <span class="hljs-number">33232</span>        <span class="hljs-number">26836</span>         <span class="hljs-number">2588</span>         <span class="hljs-number">3808</span><br> JavaScript              <span class="hljs-number">1</span>          <span class="hljs-number">170</span>          <span class="hljs-number">146</span>           <span class="hljs-number">10</span>           <span class="hljs-number">14</span><br> JSON                    <span class="hljs-number">2</span>          <span class="hljs-number">435</span>          <span class="hljs-number">435</span>            <span class="hljs-number">0</span>            <span class="hljs-number">0</span><br> PowerShell              <span class="hljs-number">1</span>           <span class="hljs-number">28</span>           <span class="hljs-number">16</span>            <span class="hljs-number">3</span>            <span class="hljs-number">9</span><br> Shell                   <span class="hljs-number">3</span>          <span class="hljs-number">288</span>          <span class="hljs-number">251</span>            <span class="hljs-number">4</span>           <span class="hljs-number">33</span><br> SVG                     <span class="hljs-number">1</span>           <span class="hljs-number">41</span>           <span class="hljs-number">41</span>            <span class="hljs-number">0</span>            <span class="hljs-number">0</span><br> Plain Text              <span class="hljs-number">7</span>          <span class="hljs-number">192</span>            <span class="hljs-number">0</span>          <span class="hljs-number">174</span>           <span class="hljs-number">18</span><br>-------------------------------------------------------------------------------<br> HTML                    <span class="hljs-number">1</span>           <span class="hljs-number">19</span>           <span class="hljs-number">16</span>            <span class="hljs-number">3</span>            <span class="hljs-number">0</span><br> |- JavaScript           <span class="hljs-number">1</span>            <span class="hljs-number">6</span>            <span class="hljs-number">6</span>            <span class="hljs-number">0</span>            <span class="hljs-number">0</span><br> (Total)                             <span class="hljs-number">25</span>           <span class="hljs-number">22</span>            <span class="hljs-number">3</span>            <span class="hljs-number">0</span><br>-------------------------------------------------------------------------------<br> Markdown               <span class="hljs-number">17</span>         <span class="hljs-number">1455</span>            <span class="hljs-number">0</span>         <span class="hljs-number">1083</span>          <span class="hljs-number">372</span><br> |- Go                   <span class="hljs-number">8</span>          <span class="hljs-number">820</span>          <span class="hljs-number">635</span>           <span class="hljs-number">72</span>          <span class="hljs-number">113</span><br> |- JSON                 <span class="hljs-number">1</span>           <span class="hljs-number">80</span>           <span class="hljs-number">80</span>            <span class="hljs-number">0</span>            <span class="hljs-number">0</span><br> (Total)                           <span class="hljs-number">2355</span>          <span class="hljs-number">715</span>         <span class="hljs-number">1155</span>          <span class="hljs-number">485</span><br>===============================================================================<br> Total                 <span class="hljs-number">404</span>        <span class="hljs-number">36117</span>        <span class="hljs-number">27940</span>         <span class="hljs-number">3881</span>         <span class="hljs-number">4296</span><br>===============================================================================<br></code></pre></td></tr></table></figure><p>å…‰ Go ä»£ç å°±æœ‰ <strong>26836</strong> è¡Œäº†ã€‚æ‰€ä»¥å¯çŸ¥ <code>xgo</code>çš„ä½œè€…æ˜¯åšäº†å¾ˆå¤šçš„ä»˜å‡ºå’ŒåŠªåŠ›çš„ã€‚ä¸è¿‡æˆ‘ä»¬ç”¨äº†ä¸åˆ°ç™¾åˆ†ä¹‹ä¸€çš„ä»£ç é‡ï¼Œå°±å°†<code>xgo</code>æœ€æ ¸å¿ƒçš„åŸç†å±•ç¤ºå¾—æ·‹æ¼“å°½è‡´äº†ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è¿›ä¸€æ­¥é˜…è¯»<code>xgo</code> çš„æºç ï¼Œå¯ä»¥è¿›ä¸€æ­¥æ¢ç´¢å¦‚ä½•æŠ½è±¡å‡ºæ›´é€šç”¨æ›´ç®€æ´æ›´æ˜“æ‰©å±•çš„interceptorï¼Œå¦‚ä½•æ”¯æŒåç¨‹éš”ç¦»ï¼Œå¦‚ä½•ä¼˜åŒ–ä¾èµ–ç®¡ç†ï¼Œä»¥åŠå¦‚ä½•å®ç°å…¶ä»–çš„traceã€coverage åŠŸèƒ½ã€‚å†æ¬¡ä¸º <code>xgo</code> æ‰“ call ğŸ‘ï¼</p><h1 id="å‚è€ƒ">å‚è€ƒ</h1><ul><li><a href="https://github.com/xhd2015/xgo">xgo repo</a></li><li><ahref="https://docs.google.com/presentation/d/1U5yTdrUjnManxztzsMPGBAePrE3HvJcDtRjV6h3HelA/edit#slide=id.g2705943ae25_0_50">xgo:åŸºäºä»£ç é‡å†™å®ç° Monkey Patch å’Œ Trace</a></li><li><ahref="https://github.com/golang/go/tree/release-branch.go1.22/src/cmd/compile">gocompile README</a></li><li><ahref="https://blog.xhd2015.xyz/zh/posts/xgo-monkey-patching-in-go-using-toolexec/">xgo:åœ¨ go ä¸­ä½¿ç”¨-toolexec å®ç°çŒ´å­è¡¥ä¸</a></li></ul>]]></content>
    
    
    <summary type="html">xgo æ˜¯ä¸€ä¸ªé€šè¿‡ä»£ç é‡å†™æ¥å®ç° mockã€trace å’Œ coverage åŠŸèƒ½çš„å•å…ƒæµ‹è¯•æ¡†æ¶ã€‚æœ¬æ–‡å°†æ¢è®¨ xgo æœ€æ ¸å¿ƒçš„åº•å±‚åŸç† -toolexecï¼Œå¹¶é€šè¿‡ 6 ä¸ªç®€å•çš„å°é˜¶æ®µï¼Œä¸€æ­¥æ­¥å®ç°ä¸€ä¸ªä¸ç‰ˆ xgoï¼Œè¿›ä¸€æ­¥å±•ç¤º xgo çš„è®¾è®¡ç†å¿µã€‚</summary>
    
    
    
    <category term="Go" scheme="https://hedon.top/categories/Go/"/>
    
    <category term="å¼€æºé¡¹ç›®" scheme="https://hedon.top/categories/Go/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/"/>
    
    
    <category term="Go" scheme="https://hedon.top/tags/Go/"/>
    
    <category term="å¼€æºé¡¹ç›®" scheme="https://hedon.top/tags/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/"/>
    
    <category term="å•å…ƒæµ‹è¯•" scheme="https://hedon.top/tags/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>xgo ä½¿ç”¨ç»éªŒ</title>
    <link href="https://hedon.top/2024/05/21/go-xgo-use/"/>
    <id>https://hedon.top/2024/05/21/go-xgo-use/</id>
    <published>2024-05-21T08:32:51.000Z</published>
    <updated>2024-05-22T13:26:45.423Z</updated>
    
    <content type="html"><![CDATA[<h1 id="patch">Patch</h1><h2 id="mock-å‡½æ•°">mock å‡½æ•°</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">greet</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello &quot;</span> + s<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestPatchFunc</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>mock.Patch(greet, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock &quot;</span> + s<br>&#125;)<br><br>res := greet(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;mock world&quot;</span> &#123;<br>t.Fatalf(<span class="hljs-string">&quot;expteced mock world got %s&quot;</span>, res)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="mock-å˜é‡">mock å˜é‡</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> value = <span class="hljs-string">&quot;hello&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">greet</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> value + s<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestPatchVar</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>mock.Patch(&amp;value, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock &quot;</span><br>&#125;)<br>res := greet(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;mock world&quot;</span> &#123;<br>t.Fatalf(<span class="hljs-string">&quot;expteced mock world got %s&quot;</span>, res)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestPatchVarByName</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>mock.PatchByName(<span class="hljs-string">&quot;learn-xgo/api&quot;</span>, <span class="hljs-string">&quot;value&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock &quot;</span><br>&#125;)<br>res := greet2(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;mock world&quot;</span> &#123;<br>t.Fatalf(<span class="hljs-string">&quot;expteced mock world got %s&quot;</span>, res)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="mock">Mock</h1><blockquote><p>å› æ­¤ï¼Œå½“å‡½æ•°å«æœ‰æœªå¯¼å‡ºç±»å‹æ—¶ï¼Œ<code>Patch</code>æ— æ³•ä½¿ç”¨ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨ <code>Mock</code>ã€‚</p></blockquote><h2 id="mockbyname">MockByName</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// learn-xgo/funcs/funcs.go</span><br><span class="hljs-keyword">package</span> funcs<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CallUnexportedFunc</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> unexportedFunc(s)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">unexportedFunc</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;origin unexported func, your msg is &quot;</span> + s<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// learn-xgo/api/mock_test.go</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestMockByName</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>mock.MockByName(<span class="hljs-string">&quot;learn-xgo/funcs&quot;</span>, <span class="hljs-string">&quot;unexportedFunc&quot;</span>,<br><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, fn *core.FuncInfo, args core.Object, results core.Object)</span></span> <span class="hljs-type">error</span> &#123;<br>results.GetFieldIndex(<span class="hljs-number">0</span>).Set(<span class="hljs-string">&quot;mock funcs &quot;</span> + args.GetFieldIndex(<span class="hljs-number">0</span>).Value().(<span class="hljs-type">string</span>))<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;)<br><br>msg := funcs.CallUnexportedFunc(<span class="hljs-string">&quot;hedon&quot;</span>)<br><span class="hljs-keyword">if</span> msg != <span class="hljs-string">&quot;mock funcs hedon&quot;</span> &#123;<br>t.Fatalf(<span class="hljs-string">&quot;expteced `mock funcs hedon` got %s&quot;</span>, msg)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">x</summary>
    
    
    
    <category term="Go" scheme="https://hedon.top/categories/Go/"/>
    
    <category term="å¼€æºé¡¹ç›®" scheme="https://hedon.top/categories/Go/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/"/>
    
    
    <category term="Go" scheme="https://hedon.top/tags/Go/"/>
    
    <category term="å¼€æºé¡¹ç›®" scheme="https://hedon.top/tags/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/"/>
    
    <category term="å•å…ƒæµ‹è¯•" scheme="https://hedon.top/tags/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>Kafka è´Ÿè½½å‡è¡¡æŒ‘æˆ˜åŠè§£å†³æ€è·¯</title>
    <link href="https://hedon.top/2024/05/20/kafka-load-balance/"/>
    <id>https://hedon.top/2024/05/20/kafka-load-balance/</id>
    <published>2024-05-20T02:37:10.000Z</published>
    <updated>2024-05-21T14:41:10.216Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡è½¬è½½è‡ª Agoda Engineeringï¼Œä»‹ç»äº†åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¦‚ä½•åº”å¯¹ Kafkaè´Ÿè½½å‡è¡¡æ‰€é‡åˆ°çš„å„ç§æŒ‘æˆ˜ï¼Œå¹¶æå‡ºç›¸åº”çš„è§£å†³æ€è·¯ã€‚æœ¬æ–‡ç®€è¦é˜è¿°äº† Kafkaçš„å¹¶è¡Œæ€§æœºåˆ¶ã€å¸¸ç”¨çš„åˆ†åŒºç­–ç•¥ä»¥åŠåœ¨å®é™…æ“ä½œä¸­é‡åˆ°çš„å¼‚æ„ç¡¬ä»¶ã€ä¸å‡åŒ€å·¥ä½œè´Ÿè½½ç­‰é—®é¢˜ã€‚é€šè¿‡æ·±å…¥åˆ†æè¿™äº›æŒ‘æˆ˜ï¼Œå¹¶æä¾›å…·ä½“çš„è§£å†³æ–¹æ¡ˆï¼Œæœ¬æ–‡æ—¨åœ¨å¸®åŠ©è¯»è€…æ›´å¥½åœ°ç†è§£å’Œåº”ç”¨Kafka çš„è´Ÿè½½å‡è¡¡æŠ€æœ¯ï¼Œä»è€Œæé«˜ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½å’Œç¨³å®šæ€§ã€‚</p><p>ä»¥ä¸‹å¤§éƒ¨åˆ†å†…å®¹ç¿»è¯‘è‡ªåŸæ–‡ <ahref="https://medium.com/agoda-engineering/how-we-solve-load-balancing-challenges-in-apache-kafka-8cd88fdad02b">how-we-solve-load-balancing-challenges-in-apache-kafka</a>ï¼Œå¹¶å·²è·å¾—åŸä½œè€…åŒæ„ã€‚</p><h1 id="æ€ç»´å¯¼å›¾">æ€ç»´å¯¼å›¾</h1><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/Kafka%20%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.png"alt="Kafka è´Ÿè½½å‡è¡¡è§£å†³æ–¹æ¡ˆ" /><figcaption aria-hidden="true">Kafka è´Ÿè½½å‡è¡¡è§£å†³æ–¹æ¡ˆ</figcaption></figure><h1 id="kafka-å¹¶è¡Œæ€§">Kafka å¹¶è¡Œæ€§</h1><p>Kafkaé€šè¿‡åˆ†åŒºæ¥å®ç°å¹¶è¡Œæ€§ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç”Ÿäº§è€…ï¼ˆProducerï¼‰äº§ç”Ÿçš„æ¶ˆæ¯ä¼šæŒ‰ç…§ä¸€å®šçš„åˆ†åŒºç­–ç•¥åˆ†é…åˆ°å¤šä¸ªåˆ†åŒºï¼ˆPartitionï¼‰ä¸­ï¼Œæ¶ˆè´¹ç»„ä¸­çš„æ¯ä¸ªæ¶ˆè´¹è€…ä¼šåˆ†åˆ«è´Ÿè´£æ¶ˆè´¹å…¶ä¸­çš„è‹¥å¹²ä¸ªåˆ†åŒºã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/0*ixosAmhBDsyBBhoS.png"alt="Kafka åˆ†åŒºæ¼”ç¤º" /><figcaption aria-hidden="true">Kafka åˆ†åŒºæ¼”ç¤º</figcaption></figure><p>åˆ†åŒºç­–ç•¥ï¼š</p><ul><li>è½®è¯¢ï¼ˆRound Robinï¼‰ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼ŒKafkaä½¿ç”¨è½®è¯¢ç­–ç•¥å°†æ¶ˆæ¯å‡åŒ€åœ°åˆ†é…åˆ°æ‰€æœ‰åˆ†åŒºã€‚</li><li>å“ˆå¸Œï¼ˆKey Hashingï¼‰ï¼šå¦‚æœæ¶ˆæ¯æœ‰åˆ†åŒºé”®ï¼ŒKafkaä¼šå¯¹é”®è¿›è¡Œå“ˆå¸Œè®¡ç®—ï¼Œå°†æ¶ˆæ¯åˆ†é…åˆ°ç‰¹å®šçš„åˆ†åŒºã€‚</li><li>è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥ï¼šå¼€å‘è€…å¯ä»¥å®ç°è‡ªå®šä¹‰çš„åˆ†åŒºå™¨ï¼ˆPartitionerï¼‰é€»è¾‘ï¼Œä»¥æ»¡è¶³ç‰¹å®šéœ€æ±‚ã€‚</li></ul><p>å¦‚æœè¦ä½¿ç”¨è½®è¯¢æˆ–è€…å“ˆå¸Œç­–ç•¥æ¥è¾¾åˆ°â€œè´Ÿè½½å‡è¡¡â€çš„ç›®çš„ï¼Œé‚£ä¹ˆéœ€è¦æ»¡è¶³ä»¥ä¸‹ 2ä¸ªå‡è®¾ï¼š</p><ol type="1"><li>æ¶ˆè´¹è€…æ‹¥æœ‰ç›¸åŒçš„å¤„ç†èƒ½åŠ›ï¼Œ</li><li>æ¶ˆæ¯çš„å·¥ä½œé‡ç›¸ç­‰ã€‚</li></ol><p>ç„¶è€Œï¼Œåœ¨å®è·µä¸­ï¼Œè¿™äº›å‡è®¾å¾€å¾€ä¸æˆç«‹ã€‚</p><h1 id="ç°å®æŒ‘æˆ˜">ç°å®æŒ‘æˆ˜</h1><h2 id="å¼‚æ„ç¡¬ä»¶">1. å¼‚æ„ç¡¬ä»¶</h2><p>ä¸åŒä»£çš„æœåŠ¡å™¨ç¡¬ä»¶æ€§èƒ½ä¸åŒï¼Œå¯¼è‡´å¤„ç†é€Ÿç‡å­˜åœ¨å·®å¼‚ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ä¸åŒä»£ç¡¬ä»¶è¿›è¡Œå¤„ç†çš„åŸºå‡†æ˜¾ç¤ºæ€§èƒ½å­˜åœ¨æ˜¾ç€å·®å¼‚ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/1*B6svY0ZjYVy-uJ7ZA18Jtg.png"alt="ä¸åŒæœåŠ¡å™¨å¤„ç†é€Ÿç‡å·®å¼‚ä¸¾ä¾‹" /><figcaption aria-hidden="true">ä¸åŒæœåŠ¡å™¨å¤„ç†é€Ÿç‡å·®å¼‚ä¸¾ä¾‹</figcaption></figure><h2 id="æ¯æ¡-kafka-æ¶ˆæ¯çš„å·¥ä½œè´Ÿè½½ä¸å‡åŒ€">2. æ¯æ¡ Kafkaæ¶ˆæ¯çš„å·¥ä½œè´Ÿè½½ä¸å‡åŒ€</h2><p>ä¸‹å›¾æ˜¾ç¤ºäº†åœ¨ä¸€ä¸ªæ—¶é—´çª—å£å†…åˆ°è¾¾çš„ 12æ¡æ¶ˆæ¯ã€‚åœ¨è¿™é‡Œï¼Œç”Ÿäº§è€…å‘è¯¥ä¸»é¢˜ä¸­çš„å…­ä¸ªåˆ†åŒºä¸­çš„æ¯ä¸€ä¸ªå‘å¸ƒä¸¤æ¡æ¶ˆæ¯ã€‚å› æ­¤ï¼Œæ¯ä¸ªworker æ¶ˆè€—æ¥è‡ª 2 ä¸ªåˆ†åŒºçš„æ•°æ®ï¼Œè¿™æ„å‘³ç€æ¯ä¸ª worker éœ€è¦å¤„ç† 4æ¡æ¶ˆæ¯ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/0*VwPda5gNsHRL2tJV.png"alt="ä½¿ç”¨å¾ªç¯åˆ†åŒºå™¨å’Œå¾ªç¯åˆ†é…å™¨æ¥åˆ†å‘æ¶ˆæ¯çš„å…ˆå‰ä¾›åº”ç³»ç»Ÿçš„æ¼”ç¤ºã€‚æ¯ä¸ª worker éƒ½åˆ†é…æœ‰ç›¸åŒæ•°é‡çš„æ¶ˆæ¯ã€‚" /><figcaptionaria-hidden="true">ä½¿ç”¨å¾ªç¯åˆ†åŒºå™¨å’Œå¾ªç¯åˆ†é…å™¨æ¥åˆ†å‘æ¶ˆæ¯çš„å…ˆå‰ä¾›åº”ç³»ç»Ÿçš„æ¼”ç¤ºã€‚æ¯ä¸ªworker éƒ½åˆ†é…æœ‰ç›¸åŒæ•°é‡çš„æ¶ˆæ¯ã€‚</figcaption></figure><p>ä¸åŒçš„æ¶ˆæ¯å¯èƒ½éœ€è¦ä¸åŒçš„å¤„ç†æ­¥éª¤é›†ã€‚ä¾‹å¦‚ï¼Œå¤„ç†æ¶ˆæ¯å¯èƒ½æ¶‰åŠè°ƒç”¨ç¬¬ä¸‰æ–¹HTTPç«¯ç‚¹ï¼Œå¹¶ä¸”ä¸åŒçš„å“åº”å¤§å°æˆ–å»¶è¿Ÿå¯èƒ½ä¼šå½±å“å¤„ç†é€Ÿç‡ã€‚æ­¤å¤–ï¼Œå¯¹äºæ¶‰åŠæ•°æ®åº“æ“ä½œçš„åº”ç”¨ç¨‹åºï¼Œå…¶æ•°æ®åº“æŸ¥è¯¢çš„å»¶è¿Ÿå¯èƒ½ä¼šæ ¹æ®æŸ¥è¯¢å‚æ•°è€Œæ³¢åŠ¨ï¼Œä»è€Œå¯¼è‡´å¤„ç†é€Ÿç‡å‘ç”Ÿå˜åŒ–ã€‚</p><h2 id="è¿‡åº¦é…ç½®é—®é¢˜">3. è¿‡åº¦é…ç½®é—®é¢˜</h2><p>ç”±äºå·¥ä½œè´Ÿè½½å’Œå¤„ç†æ•ˆç‡ä¸åŒï¼Œä¸ºäº†è¾¾åˆ°ç³»ç»Ÿååé‡çš„éœ€æ±‚ï¼Œå¯èƒ½ä¼šå‡ºç°è¿‡åº¦é…ç½®é—®é¢˜ï¼Œä»è€Œå¯¼è‡´èµ„æºæµªè´¹ã€‚</p><p>å‡è®¾æˆ‘ä»¬çš„é«˜ååé‡å’Œä½ååé‡çš„å¤„ç†é€Ÿç‡åˆ†åˆ«ä¸º 20 msg/s å’Œ 10msg/sï¼ˆæ ¹æ®è¡¨ 1ä¸­çš„æ•°æ®è¿›è¡Œç®€åŒ–ï¼‰ã€‚ä½¿ç”¨ä¸¤ä¸ªè¾ƒå¿«çš„å¤„ç†å™¨å’Œä¸€ä¸ªè¾ƒæ…¢çš„å¤„ç†å™¨ï¼Œæˆ‘ä»¬é¢„è®¡æ€»å®¹é‡ä¸º20+20+10 = 50æ¡æ¶ˆæ¯/ç§’ã€‚ä½†æ˜¯ï¼Œå½“ä¿æŒæ¶ˆæ¯çš„å¾ªç¯åˆ†é…æ—¶ï¼Œæˆ‘ä»¬æ— æ³•è¾¾åˆ°æ­¤å®¹é‡ã€‚ä¸‹å›¾æ˜¾ç¤ºäº†å¦‚æœæµé‡æŒç»­è¾¾åˆ°æ¯ç§’50 æ¡æ¶ˆæ¯æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/0*P-Qa3gyPgXtIeZMx.png"alt="å¦‚æœä¼ å…¥æµé‡ä¿æŒåœ¨ 50 æ¡æ¶ˆæ¯/ç§’ï¼Œåˆ™æ…¢é€Ÿå¤„ç†å™¨æ— æ³•å¤„ç†æ€»ä½“æ¶ˆæ¯ 1/3 çš„è´Ÿè½½ï¼Œä»è€Œå¯¼è‡´ç´¯ç§¯å»¶è¿Ÿã€‚ä¸ºäº†é¿å…é«˜å»¶è¿Ÿï¼Œå‘è¯¥ç³»ç»Ÿæ·»åŠ äº†é¢å¤–çš„èµ„æºä»¥ç»´æŒå¤„ç†ã€‚" /><figcaption aria-hidden="true">å¦‚æœä¼ å…¥æµé‡ä¿æŒåœ¨ 50æ¡æ¶ˆæ¯/ç§’ï¼Œåˆ™æ…¢é€Ÿå¤„ç†å™¨æ— æ³•å¤„ç†æ€»ä½“æ¶ˆæ¯ 1/3çš„è´Ÿè½½ï¼Œä»è€Œå¯¼è‡´ç´¯ç§¯å»¶è¿Ÿã€‚ä¸ºäº†é¿å…é«˜å»¶è¿Ÿï¼Œå‘è¯¥ç³»ç»Ÿæ·»åŠ äº†é¢å¤–çš„èµ„æºä»¥ç»´æŒå¤„ç†ã€‚</figcaption></figure><p>ä»è¿™ä¸ªä¾‹å­ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬çš„å¤„ç†å™¨æœåŠ¡ä¸€æ¬¡æœ€å¤šåªèƒ½æ¥å— 30æ¡æ¶ˆæ¯ï¼Œä»¥é˜²æ­¢æ»åå¹¶ç¡®ä¿åŠæ—¶ä¼ é€’æ›´æ–°ã€‚</p><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¦å®é™…æ¯ç§’å¤„ç† 50 æ¡æ¶ˆæ¯ï¼Œæˆ‘ä»¬å¿…é¡»æ€»å…±æ‰©å±•åˆ° 5å°æœºå™¨ï¼Œä»¥ä¿è¯åŠæ—¶å¤„ç†æ‰€æœ‰æ¶ˆæ¯ã€‚ç”±äºè¿™ç§ä¸é€‚å½“çš„åˆ†é…é€»è¾‘ï¼ˆ66.7ï¼…çš„è¿‡åº¦é…ç½®ï¼‰ï¼Œæˆ‘ä»¬ä¼šå‘è¯¥ç³»ç»Ÿè¿‡åº¦é…ç½®é¢å¤–çš„ä¸¤å°æœºå™¨ã€‚</p><p>ä¸ºäº†æ¯ç§’å¤„ç† 50æ¡æ¶ˆæ¯ï¼Œæˆ‘ä»¬éœ€è¦æ‰©å±•åˆ°äº”å°æœºå™¨ä»¥ç¡®ä¿åŠæ—¶å¤„ç†æ‰€æœ‰æ¶ˆæ¯ã€‚ç”±äºè¿™ç§ä¸é€‚å½“çš„åˆ†é…é€»è¾‘ï¼ˆ66.7%çš„è¿‡åº¦é…ç½®ï¼‰ï¼Œè¿™ä¼šå¯¼è‡´å‘è¯¥ç³»ç»Ÿè¿‡åº¦é…ç½®ä¸¤å°é¢å¤–çš„æœºå™¨ã€‚</p><h1 id="é™æ€è§£å†³æ–¹æ¡ˆ">é™æ€è§£å†³æ–¹æ¡ˆ</h1><h2 id="åœ¨ç›¸åŒçš„-podæœºå™¨ä¸Šéƒ¨ç½²">1. åœ¨ç›¸åŒçš„ Podï¼ˆæœºå™¨ï¼‰ä¸Šéƒ¨ç½²</h2><p>è€ƒè™‘æ§åˆ¶æœåŠ¡éƒ¨ç½²ä¸­ä½¿ç”¨çš„ç¡¬ä»¶ç±»å‹ä»¥ç¼“è§£é—®é¢˜ã€‚å¦‚æœæ‚¨åœ¨è™šæ‹Ÿæœºä¸Šéƒ¨ç½²æœåŠ¡å¹¶æ‹¥æœ‰å……è¶³çš„èµ„æºå’Œæ€§èƒ½ç›¸åŒçš„ç¡¬ä»¶ï¼Œåˆ™æ­¤æ–¹æ³•æ˜¯å¯è¡Œçš„ã€‚</p><p>ç„¶è€Œï¼Œç”±äºæˆæœ¬æ•ˆç›Šå’Œçµæ´»æ€§ä¸‹é™ï¼Œåœ¨ç§æœ‰äº‘ç¯å¢ƒä¸­é€šå¸¸ä¸å»ºè®®é‡‡ç”¨è¿™ç§ç­–ç•¥ï¼Œä¸»è¦æ˜¯å› ä¸ºåŒæ—¶å‡çº§æ‰€æœ‰ç°æœ‰ç¡¬ä»¶å¯èƒ½å…·æœ‰æŒ‘æˆ˜æ€§ã€‚å¦‚æœå®ƒéå¸¸é€‚åˆæ‚¨çš„æƒ…å†µï¼Œåˆ™å¯ä»¥ä½¿ç”¨<ahref="https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/">Kuberneteså…³è”æ€§å°† Pod åˆ†é…ç»™æŸäº›ç±»å‹çš„èŠ‚ç‚¹ã€‚</a></p><h2 id="åŠ æƒè´Ÿè½½å‡è¡¡">2. åŠ æƒè´Ÿè½½å‡è¡¡</h2><p>å¦‚æœå®¹é‡æ˜¯å¯é¢„æµ‹çš„å¹¶ä¸”å¤§éƒ¨åˆ†æ—¶é—´ä¿æŒé™æ€ï¼Œåˆ™ä¸ºä¸åŒçš„æ¶ˆè´¹è€…åˆ†é…ä¸åŒçš„æƒé‡å¯ä»¥å¸®åŠ©æœ€å¤§é™åº¦åœ°åˆ©ç”¨å¯ç”¨èµ„æºã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸ºè¡¨ç°è¾ƒå¥½çš„æ¶ˆè´¹è€…èµ‹äºˆæ›´é«˜çš„æƒé‡åï¼Œæˆ‘ä»¬å¯ä»¥å°†æ›´å¤šæµé‡è·¯ç”±ç»™è¿™äº›æ¶ˆè´¹è€…ã€‚</p><h1 id="åŠ¨æ€è§£å†³æ–¹æ¡ˆ">åŠ¨æ€è§£å†³æ–¹æ¡ˆ</h1><p>è™½ç„¶æˆ‘ä»¬å¯ä»¥ä¼°è®¡æ¶ˆæ¯çš„å®¹é‡å’Œå·¥ä½œè´Ÿè½½æ¥è®¾è®¡é™æ€è§„åˆ™æ¥ç¡®å®šåŠ æƒè´Ÿè½½å¹³è¡¡ç­–ç•¥ï¼Œä½†ç”±äºä»¥ä¸‹å‡ ä¸ªå› ç´ ï¼Œè¿™ç§æ–¹æ³•åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­å¯èƒ½å¹¶ä¸æ€»æ˜¯å¯è¡Œï¼š</p><ul><li>æ¶ˆæ¯çš„å·¥ä½œè´Ÿè½½å¹¶ä¸ç»Ÿä¸€ï¼Œè¿™ä½¿å¾—ä¼°è®¡æœºå™¨å®¹é‡å˜å¾—å›°éš¾ã€‚</li><li>ä¾èµ–å…³ç³»ï¼ˆä¾‹å¦‚ç½‘ç»œå’Œç¬¬ä¸‰æ–¹è¿æ¥ï¼‰ä¸ç¨³å®šï¼Œæœ‰æ—¶ä¼šå¯¼è‡´å®é™…å¤„ç†ä¸­çš„å®¹é‡å‘ç”Ÿå˜åŒ–ã€‚</li><li>è¯¥ç³»ç»Ÿç»å¸¸æ·»åŠ æ–°åŠŸèƒ½ï¼Œå¢åŠ é¢å¤–çš„ç»´æŠ¤å·¥ä½œä»¥ä¿æŒæƒé‡æ›´æ–°ã€‚</li></ul><p>ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥åŠ¨æ€ç›‘æ§æ¯ä¸ªåˆ†åŒºä¸­çš„å½“å‰æ»åå¹¶æ ¹æ®å½“å‰æµé‡çŠ¶å†µåšå‡ºç›¸åº”å“åº”ã€‚</p><p>æœ‰ 2 ç§æ€è·¯ï¼š</p><ol type="1"><li><strong>ç”Ÿäº§è€…è§’åº¦</strong>ï¼šä½¿ç”¨è‡ªå®šä¹‰ç®—æ³•æ ¹æ®æ»åçš„æ¶ˆæ¯æ•°é‡æ¥ç¡®å®šæ¯ä¸ªåˆ†åŒºçš„æµé‡ï¼Œè¿™ç§ç”Ÿäº§è€…ç§°ä¸ºæ»åæ„ŸçŸ¥ç”Ÿäº§è€…ï¼ˆLag-awareProducerï¼‰ã€‚</li><li><strong>æ¶ˆè´¹è€…è§’åº¦</strong>ï¼šè¿™äº›æ¶ˆè´¹è€…æ—¨åœ¨ç›‘æ§å½“å‰æ»åçš„æ¶ˆæ¯æ•°é‡ï¼Œå¹¶å¯ä»¥åœ¨å¿…è¦æ—¶å–æ¶ˆè®¢é˜…ä»¥è§¦å‘è´Ÿè½½é‡æ–°å¹³è¡¡ã€‚é€šå¸¸ï¼Œå¯ä»¥é‡‡ç”¨è‡ªå®šä¹‰çš„é‡æ–°å¹³è¡¡ç­–ç•¥æ¥è°ƒæ•´åˆ†åŒºåˆ†é…ã€‚è¿™ç§æ¶ˆè´¹è€…ç§°ä¸ºæ»åæ„ŸçŸ¥æ¶ˆè´¹è€…ï¼ˆLag-awareComsumerï¼‰ã€‚</li></ol><h2 id="ä»ç”Ÿäº§è€…è§’åº¦å‡ºå‘">1. ä»ç”Ÿäº§è€…è§’åº¦å‡ºå‘</h2><p>å¦‚æ­¤å›¾æ‰€ç¤ºï¼Œç”Ÿäº§è€…å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰ç®—æ³•æ ¹æ®æ»åç¡®å®šæ¯ä¸ªåˆ†åŒºçš„æµé‡ã€‚ä¸ºäº†å‡å°‘å¯¹Kafkaä»£ç†çš„è°ƒç”¨æ¬¡æ•°ï¼Œç³»ç»Ÿå¯ä»¥ç»´æŠ¤ä¸€ä¸ªå†…éƒ¨å»¶è¿Ÿç¼“å­˜ï¼Œè€Œä¸æ˜¯åœ¨å‘å¸ƒæ¯æ¡æ¶ˆæ¯ä¹‹å‰è°ƒç”¨Kafka ä»£ç†ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/0*Mg1lxKzMTy7LRAXT.png"alt="åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œåˆ†åŒº 4 å’Œ 6 çš„å»¶è¿Ÿæ¯”å…¶ä»–åˆ†åŒºé«˜å¾—å¤šã€‚åº”å‡å°‘ä»å†…éƒ¨ç”Ÿäº§è€…å‘é€åˆ°è¿™äº›åˆ†åŒºçš„æµé‡ã€‚" /><figcaption aria-hidden="true">åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œåˆ†åŒº 4 å’Œ 6çš„å»¶è¿Ÿæ¯”å…¶ä»–åˆ†åŒºé«˜å¾—å¤šã€‚åº”å‡å°‘ä»å†…éƒ¨ç”Ÿäº§è€…å‘é€åˆ°è¿™äº›åˆ†åŒºçš„æµé‡ã€‚</figcaption></figure><p>ä½¿ç”¨æ»åæ•°æ®ï¼Œå®šåˆ¶çš„ç®—æ³•è¢«è®¾è®¡ä¸ºå‘ç»å†é«˜æ»åçš„åˆ†åŒºå‘å¸ƒæ›´å°‘çš„æµé‡ï¼Œå‘ä½æ»åçš„åˆ†åŒºå‘å¸ƒæ›´å¤šæµé‡ï¼Œä»¥å¹³è¡¡æ¯ä¸ªåˆ†åŒºä¸Šçš„å·¥ä½œè´Ÿè½½ã€‚å½“æ»åå¹³è¡¡ä¸”ç¨³å®šæ—¶ï¼Œæ­¤æ–¹æ³•åº”ç¡®ä¿æ¶ˆæ¯çš„å‡åŒ€åˆ†å¸ƒã€‚</p><p>ä¸é€‚ç”¨æƒ…å†µï¼š</p><ol type="1"><li><strong>çº¯æ¶ˆè´¹è€…åº”ç”¨ç¨‹åº</strong>ï¼šæ‚¨çš„åº”ç”¨ç¨‹åºä¸æ§åˆ¶æ¶ˆæ¯ç”Ÿæˆã€‚</li><li><strong>å¤šä¸ªæ¶ˆè´¹è€…ç»„ï¼š</strong>å½“ç”Ÿæˆçš„æ¶ˆæ¯è¢«å¤šä¸ªæ¶ˆè´¹è€…ç»„æ¶ˆè´¹æ—¶ï¼Œç”Ÿäº§è€…å¯èƒ½ä¼šä¸ºå…¶ä»–æ¶ˆè´¹è€…ç»„äº§ç”Ÿä¸å¿…è¦çš„å€¾æ–œè´Ÿè½½ï¼Œå› ä¸ºæ»ååªæ˜¯ç‰¹å®šäºä¸€ä¸ªæ¶ˆè´¹è€…ç»„çš„ä¿¡æ¯ã€‚</li></ol><h3 id="ç›¸åŒé˜Ÿåˆ—é•¿åº¦ç®—æ³•">ç›¸åŒé˜Ÿåˆ—é•¿åº¦ç®—æ³•</h3><p>è¯¥ç®—æ³•å°†æ¯ä¸ªåˆ†åŒºæ»åè§†ä¸ºå¤„ç†çš„é˜Ÿåˆ—å¤§å°ã€‚è·å–æ»åä¿¡æ¯åï¼Œå®ƒä¼šå‘å¸ƒé€‚å½“æ•°é‡çš„æ¶ˆæ¯ä»¥å¡«å……çŸ­é˜Ÿåˆ—ã€‚æ­¤æ–¹æ³•æ›´é€‚åˆç”±äºå¼‚æ„ç¡¬ä»¶è€Œå¯¼è‡´çš„å€¾æ–œæ»ååˆ†å¸ƒï¼Œå…¶ä¸­é«˜æ€§èƒ½Podï¼ˆæœºå™¨ï¼‰åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹èƒ½å¤Ÿæ›´å¿«åœ°å¤„ç†ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/0*zp-S1Y_GbIzbjCX4.png"alt="ç›¸åŒé˜Ÿåˆ—é•¿åº¦ç®—æ³•çš„æ¼”ç¤ºã€‚æœ€åˆï¼Œä¸åŒé˜Ÿåˆ—çš„é•¿åº¦ä¸åŒã€‚è¯¥ç®—æ³•å°è¯•ç”Ÿæˆä¸åŒæ•°é‡çš„æ¶ˆæ¯ï¼Œä»¥åœ¨æ‰€æœ‰é˜Ÿåˆ—ä¸­å®ç°ç›¸åŒçš„é˜Ÿåˆ—é•¿åº¦ã€‚è¿™é‡Œï¼Œé˜Ÿåˆ—é•¿åº¦å’Œ Kafka lag æ˜¯åŒä¸€ä¸ªæ¦‚å¿µï¼Œä»£è¡¨å°šæœªå¤„ç†çš„æ¶ˆæ¯æ•°é‡" /><figcaptionaria-hidden="true">ç›¸åŒé˜Ÿåˆ—é•¿åº¦ç®—æ³•çš„æ¼”ç¤ºã€‚æœ€åˆï¼Œä¸åŒé˜Ÿåˆ—çš„é•¿åº¦ä¸åŒã€‚è¯¥ç®—æ³•å°è¯•ç”Ÿæˆä¸åŒæ•°é‡çš„æ¶ˆæ¯ï¼Œä»¥åœ¨æ‰€æœ‰é˜Ÿåˆ—ä¸­å®ç°ç›¸åŒçš„é˜Ÿåˆ—é•¿åº¦ã€‚è¿™é‡Œï¼Œé˜Ÿåˆ—é•¿åº¦å’ŒKafka lag æ˜¯åŒä¸€ä¸ªæ¦‚å¿µï¼Œä»£è¡¨å°šæœªå¤„ç†çš„æ¶ˆæ¯æ•°é‡</figcaption></figure><h3 id="å¼‚å¸¸å€¼æ£€æµ‹ç®—æ³•">å¼‚å¸¸å€¼æ£€æµ‹ç®—æ³•</h3><p>è¯¥ç®—æ³•åˆ©ç”¨ç»Ÿè®¡æ–¹æ³•æ¥ç¡®å®šæ‰€æœ‰åˆ†åŒºçš„ä¸Šç¦»ç¾¤å€¼ï¼Œå¹¶æš‚æ—¶åœæ­¢é‚£äº›æ…¢é€Ÿç¦»ç¾¤å€¼çš„å‘å¸ƒè¿‡ç¨‹ã€‚åœ¨åŸæ–‡ç« ä¸­ï¼Œé’ˆå¯¹Agoda çš„ç‰¹å®šéœ€æ±‚ï¼Œä»–ä»¬æå‡ºäº† IQRï¼ˆå››åˆ†ä½è·ï¼‰å’ŒSTDï¼ˆæ ‡å‡†å·®ï¼‰å¼‚å¸¸å€¼æ£€æµ‹ç®—æ³•ã€‚ç®—æ³•æµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤ºã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/0*pjkj5kF6aFcWwBwU.png"alt="å¼‚å¸¸å€¼æ£€æŸ¥ç®—æ³•æµç¨‹" /><figcaption aria-hidden="true">å¼‚å¸¸å€¼æ£€æŸ¥ç®—æ³•æµç¨‹</figcaption></figure><ul><li><strong>æ…¢é€Ÿåˆ†åŒºï¼š</strong>ï¼ˆå·²å…³é—­ï¼‰ç”±äºå­˜åœ¨å»¶è¿Ÿï¼Œè¿™äº›åˆ†åŒºçš„æ¶ˆæ¯ç”Ÿæˆå·²åœæ­¢ã€‚</li><li><strong>å¥½çš„åˆ†åŒº</strong>ï¼šï¼ˆæ‰“å¼€ï¼‰ç…§å¸¸å‘å¸ƒå¹¶å‡åŒ€åˆ†å‘åˆ°æ‰€æœ‰å¥½çš„åˆ†åŒºã€‚</li><li><strong>OKåˆ†åŒºï¼š</strong>ï¼ˆè§‚å¯Ÿ/åŠå¼€æ”¾ï¼‰ä¸ºäº†æé«˜æ€§èƒ½ä¸ä½³çš„æœºå™¨çš„æ€§èƒ½ï¼Œå½“ç³»ç»Ÿå°è¯•å°†æ…¢é€Ÿåˆ†åŒºæå‡ä¸ºè‰¯å¥½åˆ†åŒºæ—¶ï¼Œä¼šæ·»åŠ ä¸€ä¸ªè§‚å¯ŸæœŸã€‚é€šè¿‡ä»…ç”Ÿæˆä¸€å°éƒ¨åˆ†æ¶ˆæ¯å¹¶è¿›è¡Œè§‚å¯Ÿï¼Œå¯ä»¥å°†è¯¥è§‚å¯Ÿé˜¶æ®µä¼˜åŒ–ä¸ºâ€œåŠå¼€æ”¾â€çŠ¶æ€ã€‚å½“æ»åè·å–é—´éš”ç›¸å¯¹è¾ƒé•¿æ—¶ï¼ŒåŠå¼€æ”¾æ˜¯æœ‰ç›Šçš„ï¼Œå› ä¸ºå®ƒå¯ä»¥é˜²æ­¢æ¶ˆè´¹è€…å»¶è¿Ÿç­‰å¾…ä¼ å…¥æ¶ˆæ¯è€Œæ›´æ–°çš„æ»åæ•°æ®å°šæœªæŸ¥è¯¢çš„æƒ…å†µã€‚</li></ul><h2 id="ä»æ¶ˆè´¹è€…è§’åº¦å‡ºå‘">2. ä»æ¶ˆè´¹è€…è§’åº¦å‡ºå‘</h2><p>è¿™é‡Œ Adogaæå‡ºçš„æ€è·¯æ˜¯ï¼š<strong>é‡åˆ°é«˜å»¶è¿Ÿçš„å®ä¾‹å¯ä»¥ä¸»åŠ¨å–æ¶ˆè®¢é˜…ä¸»é¢˜ä»¥è§¦å‘é‡æ–°å¹³è¡¡ã€‚åœ¨é‡æ–°å¹³è¡¡æœŸé—´ï¼Œå¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰çš„åˆ†é…å™¨æ¥å¹³è¡¡æ‰€æœ‰æ¶ˆè´¹è€…å®ä¾‹ä¹‹é—´çš„åˆ†åŒºã€‚</strong></p><p>è§¦å‘é‡æ–°å¹³è¡¡çš„æˆæœ¬éå¸¸æ˜‚è´µï¼Œå› ä¸ºæ€¥åˆ‡çš„é‡æ–°å¹³è¡¡ä¼šåœæ­¢æ¶ˆè´¹è€…ç»„ä¸­çš„æ‰€æœ‰å¤„ç†ã€‚Kafka2.4ä¸­å¼•å…¥çš„<ahref="https://www.confluent.io/blog/incremental-cooperative-rebalancing-in-kafka/">å¢é‡åä½œå†å¹³è¡¡åè®®</a>å·²ç»æœ€å¤§é™åº¦åœ°å‡å°‘äº†æ€§èƒ½å½±å“ï¼Œå…è®¸æ›´é¢‘ç¹çš„å†å¹³è¡¡ä»¥æ›´å¥½åœ°åˆ†é…æ¯ä¸ªåˆ†åŒºä¸Šçš„è´Ÿè½½ã€‚</p><p>ä¸ºäº†å¢å¼ºé‡æ–°åˆ†é…çš„çµæ´»æ€§ï¼Œåˆ†åŒºçš„æ•°é‡åº”è¯¥å¤§äº workerçš„æ•°é‡ã€‚è¿™ä¸€æ¯”ç‡åº”æ ¹æ®åº”ç”¨ç¨‹åºè€Œæœ‰æ‰€ä¸åŒï¼Œå¹¶å‡è®¾ä¸€ä¸ªå·¥ä½œçº¿ç¨‹è‡³å°‘å¯ä»¥å¤„ç†æ¥è‡ªä¸€ä¸ªåˆ†åŒºçš„è´Ÿè½½ä»¥é¿å…é¥¥é¥¿ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/0*68P7QtdFGeIzwZSs.png"alt="åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œå·¥ä½œç¨‹åº 3 åœ¨é€Ÿåº¦è¾ƒæ…¢çš„ç¡¬ä»¶ä¸Šè¿è¡Œï¼Œå¯¼è‡´åˆ†åŒº 5 å’Œ 6 å‡ºç°æ›´é«˜çš„å»¶è¿Ÿã€‚å› æ­¤ï¼Œå·¥ä½œç¨‹åº 3 å¯èƒ½ä¼šä¸»åŠ¨å–æ¶ˆè®¢é˜…ä¸»é¢˜ä»¥è§¦å‘é‡æ–°å¹³è¡¡å¹¶æ›´æœ‰æ•ˆåœ°é‡æ–°åˆ†é…åˆ†åŒºã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œåº”å®ç°è‡ªå®šä¹‰åˆ†é…å™¨ä»¥æ ¹æ®æœºå™¨æŒ‡æ ‡å’Œæ»åä¿¡æ¯é‡æ–°åˆ†é…åˆ†åŒºã€‚" /><figcaption aria-hidden="true">åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œå·¥ä½œç¨‹åº 3åœ¨é€Ÿåº¦è¾ƒæ…¢çš„ç¡¬ä»¶ä¸Šè¿è¡Œï¼Œå¯¼è‡´åˆ†åŒº 5 å’Œ 6 å‡ºç°æ›´é«˜çš„å»¶è¿Ÿã€‚å› æ­¤ï¼Œå·¥ä½œç¨‹åº 3å¯èƒ½ä¼šä¸»åŠ¨å–æ¶ˆè®¢é˜…ä¸»é¢˜ä»¥è§¦å‘é‡æ–°å¹³è¡¡å¹¶æ›´æœ‰æ•ˆåœ°é‡æ–°åˆ†é…åˆ†åŒºã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œåº”å®ç°è‡ªå®šä¹‰åˆ†é…å™¨ä»¥æ ¹æ®æœºå™¨æŒ‡æ ‡å’Œæ»åä¿¡æ¯é‡æ–°åˆ†é…åˆ†åŒºã€‚</figcaption></figure><h1 id="æ€»ç»“">æ€»ç»“</h1><p>æœ¬æ–‡ä» Kafka å¹¶è¡Œæ€§çš„ä¸€èˆ¬å®ç°å‡ºå‘ï¼Œæ¢è®¨äº† Kafkaå®ç°è´Ÿè½½å‡è¡¡åœ¨ç°å®å®è·µä¸­å¯èƒ½é‡åˆ°çš„å„ç§æŒ‘æˆ˜ï¼Œå¹¶ä»é™æ€è°ƒæ•´å’ŒåŠ¨æ€è°ƒæ•´ä¸¤ä¸ªæ–¹é¢ç»™å‡ºäº†è§£å†³æ€è·¯ï¼Œç‰¹åˆ«æ³¨é‡è®¨è®ºäº†åŠ¨æ€è°ƒæ•´ç­–ç•¥ï¼Œå¹¶åˆ†åˆ«ä»ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„è§’åº¦æå‡ºäº†è§£å†³æ–¹æ¡ˆã€‚</p><p>æ€»ä¹‹ï¼Œé€šè¿‡åœ¨ Kafkaä¸­å®ç°è´Ÿè½½å‡è¡¡ï¼Œå¯ä»¥æœ‰æ•ˆåœ°å°†å·¥ä½œè´Ÿè½½åˆ†é…åˆ°å¯ç”¨èµ„æºä¹‹é—´ï¼Œä»è€Œæ˜¾è‘—æé«˜æœåŠ¡æ€§èƒ½ã€‚å…·ä½“çš„ç®—æ³•å’Œç­–ç•¥éœ€è¦æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œé€‰æ‹©å’Œè°ƒæ•´ã€‚</p>]]></content>
    
    
    <summary type="html">æœ¬æ–‡è½¬è½½è‡ª Agoda Enginnering, ä»‹ç»äº† Kafka è´Ÿè½½å‡è¡¡çš„å®é™…åº”ç”¨è¿‡ç¨‹ä¸­çš„è´Ÿè½½å‡è¡¡æŒ‘æˆ˜åŠè§£å†³æ€è·¯ã€‚</summary>
    
    
    
    <category term="Kafka" scheme="https://hedon.top/categories/Kafka/"/>
    
    
    <category term="Kafka" scheme="https://hedon.top/tags/Kafka/"/>
    
    <category term="ä¸­é—´ä»¶" scheme="https://hedon.top/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    <category term="æ¶ˆæ¯é˜Ÿåˆ—" scheme="https://hedon.top/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"/>
    
  </entry>
  
  <entry>
    <title>å­¦ä¹ è®°å½•ï¼šç”¨ Go è‡ªåˆ¶è§£é‡Šå™¨ Monkey</title>
    <link href="https://hedon.top/2024/05/12/monkey-language/"/>
    <id>https://hedon.top/2024/05/12/monkey-language/</id>
    <published>2024-05-11T19:44:15.000Z</published>
    <updated>2024-05-12T11:59:36.393Z</updated>
    
    <content type="html"><![CDATA[<h1 id="è¯æ³•åˆ†æ">è¯æ³•åˆ†æ</h1><p>TDDï¼šæµ‹è¯•é©±åŠ¨å¼€å‘</p><p>å…ˆå†™æµ‹è¯•ç”¨ä¾‹ï¼Œå†è¿›è¡Œè¯æ³•åˆ†æé€»è¾‘çš„å®Œå–„ã€‚</p><h1 id="è¯­æ³•åˆ†æ">è¯­æ³•åˆ†æ</h1><p>é€’å½’ä¸‹é™è¯­æ³•åˆ†æä¼ªä»£ç </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs go">function parseProgram() &#123;<br>    program = newProgramASTNode()<br>    advanceTokens()<br>    <span class="hljs-keyword">for</span> (currentToken() != EOF_TOKEN) &#123;<br>        statement = null<br>        <span class="hljs-keyword">if</span> (currentToken() == LET_TOKEN) &#123;<br>            statement = parseLetStatement()<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (currentToken() == RETURN_TOKEN) &#123;<br>            statement = parseReturnStatement()<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (currentToken() == IF_TOKEN) &#123;<br>            statement = parseIfStatement()<br>        &#125;<br>        <span class="hljs-keyword">if</span> (statement != null) &#123;<br>            program.Statements.push(statement)<br>        &#125;<br>        advanceTokens()<br>    &#125;<br>    <span class="hljs-keyword">return</span> program<br>&#125;<br>function parseLetStatement() &#123;<br>    advanceTokens()<br>    identifier = parseIdentifier()<br>    advanceTokens()<br>    <span class="hljs-keyword">if</span> currentToken() != EQUAL_TOKEN &#123;<br>        parseError(<span class="hljs-string">&quot;no equal sign!&quot;</span>)<br>        <span class="hljs-keyword">return</span> null<br>    &#125;<br>    advanceTokens()<br>    value = parseExpression()<br>    variableStatement = newVariableStatementASTNode()<br>    variableStatement.identifier = identifier<br>    variableStatement.value = value<br>    <span class="hljs-keyword">return</span> variableStatement<br>&#125;<br>function parseIdentifier() &#123;<br>    identifier = newIdentifierASTNode()<br>    identifier.token = currentToken()<br>    <span class="hljs-keyword">return</span> identifier<br>&#125;<br>function parseExpression() &#123;<br>    <span class="hljs-keyword">if</span> (currentToken() == INTEGER_TOKEN) &#123;<br>        <span class="hljs-keyword">if</span> (nextToken() == PLUS_TOKEN) &#123;<br>            <span class="hljs-keyword">return</span> parseOperatorExpression()<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nextToken() == SEMICOLON_TOKEN) &#123;<br>            <span class="hljs-keyword">return</span> parseIntegerLiteral()<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (currentToken() == LEFT_PAREN) &#123;<br>        <span class="hljs-keyword">return</span> parseGroupedExpression()<br>    &#125;<br><span class="hljs-comment">// [...]</span><br>&#125;<br>function parseOperatorExpression() &#123;<br>    operatorExpression = newOperatorExpression()<br>    operatorExpression.left = parseIntegerLiteral()<br>    operatorExpression.operator = currentToken()<br>    operatorExpression.right = parseExpression()<br>    <span class="hljs-keyword">return</span> operatorExpression()<br>&#125;<br></code></pre></td></tr></table></figure><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240512042659060.png"alt="é€’å½’ä¸‹é™åˆ†ææ³•" /><figcaption aria-hidden="true">é€’å½’ä¸‹é™åˆ†ææ³•</figcaption></figure><h2 id="let-x5">let x=5</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240512035446100.png"alt="let stmt AST structure" /><figcaption aria-hidden="true">let stmt AST structure</figcaption></figure><h2 id="return-5">return 5</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240512045650041.png"alt="return stmt AST structue" /><figcaption aria-hidden="true">return stmt AST structue</figcaption></figure><h2 id="æ™®æ‹‰ç‰¹è§£æ">æ™®æ‹‰ç‰¹è§£æ</h2>]]></content>
    
    
    <summary type="html">æœ¬æ–‡ä¸»è¦æ˜¯è®°å½•ç¬”è€…åœ¨å­¦ä¹ ã€Šç”¨ Go è‡ªåˆ¶è§£é‡Šå™¨ Monkeyã€‹è¿‡ç¨‹ä¸­æ¶‰åŠçš„é‡è¦è®¾è®¡ç†å¿µå’Œæ€è€ƒã€‚</summary>
    
    
    
    <category term="Go" scheme="https://hedon.top/categories/Go/"/>
    
    <category term="Go å®æˆ˜" scheme="https://hedon.top/categories/Go/Go-%E5%AE%9E%E6%88%98/"/>
    
    
    <category term="Go" scheme="https://hedon.top/tags/Go/"/>
    
    <category term="ç¼–è¯‘åŸç†" scheme="https://hedon.top/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>æ—¶é—´å¤„ç†åŸºç¡€ï¼šRust çš„ chrono åº“æ•™ç¨‹</title>
    <link href="https://hedon.top/2024/05/11/rust-crate-chrono/"/>
    <id>https://hedon.top/2024/05/11/rust-crate-chrono/</id>
    <published>2024-05-11T15:52:55.000Z</published>
    <updated>2024-05-11T17:02:48.217Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸æœ‰å¯¹æ—¶é—´å’Œæ—¥æœŸå¤„ç†çš„éœ€æ±‚ã€‚ä¸è®ºæ˜¯æ—¥å†åº”ç”¨ã€æ—¥ç¨‹å®‰æ’ã€è¿˜æ˜¯æ—¶é—´æˆ³è®°å½•ï¼Œå‡†ç¡®çš„æ—¶é—´æ•°æ®å¤„ç†éƒ½æ˜¯å¿…ä¸å¯å°‘çš„ã€‚Rustç¤¾åŒºæä¾›çš„ <code>chrono</code> åº“ä»¥å…¶å¼ºå¤§çš„åŠŸèƒ½å’Œçµæ´»çš„æ¥å£ï¼Œåœ¨ Rustå¼€å‘è€…ä¸­å¹¿å—æ¬¢è¿ã€‚æœ¬æ–‡å°†ç®€å•ä»‹ç» <code>chrono</code>åº“ï¼Œå±•ç¤ºå¦‚ä½•åˆ©ç”¨å®ƒæ¥ç²¾ç¡®å¤„ç†å’Œè½¬æ¢æ—¶é—´å’Œæ—¥æœŸï¼Œå¸®åŠ©ä½ åœ¨ä»»ä½• Rusté¡¹ç›®ä¸­éƒ½èƒ½é«˜æ•ˆåœ°ç®¡ç†æ—¶é—´ã€‚</p><h1 id="ç‰ˆæœ¬">ç‰ˆæœ¬</h1><ul><li><code>chrono</code>: 0.4.38</li></ul><h1 id="ç»“è®ºå…ˆè¡Œ">ç»“è®ºå…ˆè¡Œ</h1><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240512010241356.png"alt="chrono å„ç§æ—¶é—´ç±»å‹è½¬æ¢å›¾" /><figcaption aria-hidden="true">chrono å„ç§æ—¶é—´ç±»å‹è½¬æ¢å›¾</figcaption></figure><h1 id="æ—¶é—´ç›¸å…³æ¦‚å¿µ">æ—¶é—´ç›¸å…³æ¦‚å¿µ</h1><table><thead><tr class="header"><th>æ¦‚å¿µ</th><th>ç†è§£</th></tr></thead><tbody><tr class="odd"><td>UNIX æ—¶é—´æˆ³ï¼ˆUNIX Timestampï¼‰</td><td>ä¹Ÿç§°ä¸º POSIX æ—¶é—´æˆ– Epoch æ—¶é—´ï¼Œæ˜¯è‡ª 1970 å¹´ 1 æœˆ 1 æ—¥ï¼ˆUTCæ—¶åŒºï¼‰ä»¥æ¥ç»è¿‡çš„ç§’æ•°ï¼Œä¸è®¡å…¥é—°ç§’ã€‚è¿™æ˜¯ä¸€ç§éå¸¸é€šç”¨çš„æ—¶é—´è¡¨ç¤ºæ–¹æ³•ï¼Œåœ¨ç¼–ç¨‹ä¸­å¹¿æ³›ä½¿ç”¨ï¼Œå› ä¸ºå®ƒå¯ä»¥ç®€åŒ–æ—¶é—´å·®çš„è®¡ç®—ã€‚</td></tr><tr class="even"><td>UTCï¼ˆåè°ƒä¸–ç•Œæ—¶ï¼‰</td><td>å…¨ç§°ä¸ºåè°ƒä¸–ç•Œæ—¶ï¼ˆCoordinated UniversalTimeï¼‰ï¼Œæ˜¯ç›®å‰å›½é™…ä¸Šå¹¿æ³›é‡‡ç”¨çš„æ—¶é—´æ ‡å‡†ã€‚å®ƒåŸºæœ¬ä¸Šä¸æ ¼æ—å¨æ²»å¹³å‡æ—¶ï¼ˆGMTï¼‰ç›¸åŒï¼Œä½†åœ¨æŠ€æœ¯ä¸Šæ›´åŠ ç²¾ç¡®ï¼Œå› ä¸ºå®ƒä½¿ç”¨åŸå­é’Ÿæ¥ä¿æŒæ—¶é—´å‡†ç¡®ã€‚ä¸–ç•Œå„åœ°çš„æ—¶é—´éƒ½æ˜¯ä»¥UTC ä¸ºåŸºç¡€ï¼ŒåŠ ä¸Šæˆ–å‡å»ä¸€å®šçš„å°æ—¶æ•°æ¥å®šä¹‰çš„ã€‚</td></tr><tr class="odd"><td>æ—¶åŒºï¼ˆTime Zoneï¼‰</td><td>æ—¶åŒºæ˜¯åœ°çƒä¸Šåˆ’åˆ†çš„æ ‡å‡†æ—¶é—´åŒºåŸŸã€‚ç”±äºåœ°çƒè‡ªè¥¿å‘ä¸œæ—‹è½¬ï¼Œæ¯å‘ä¸œç§»åŠ¨ä¸€å®šè§’åº¦ï¼Œå½“åœ°çš„å¤ªé˜³æ—¶é—´å°±ä¼šç›¸åº”åœ°æå‰ã€‚ä¸–ç•Œè¢«åˆ†æˆäº†24ä¸ªæ—¶åŒºï¼Œæ¯ä¸ªæ—¶åŒºé€šå¸¸ç›¸å·®ä¸€å°æ—¶ã€‚æ—¶åŒºå…è®¸åœ°åŒºå†…çš„äººä»¬èƒ½åœ¨å¤§è‡´ç›¸åŒçš„æ—¶é—´å†…ï¼Œç»å†ç±»ä¼¼çš„æ—¥å¤œæ›´æ›¿æ¨¡å¼ã€‚</td></tr><tr class="even"><td>UTC+8</td><td>UTC+8 æ˜¯ UTC æ—¶é—´åŠ ä¸Š 8å°æ—¶çš„æ—¶é—´åŒºã€‚ä¸­å›½å¤§é™†å°±æ˜¯ä½äºè¿™ä¸ªæ—¶åŒºã€‚ä¾‹å¦‚ï¼Œå½“ UTC æ—¶é—´ä¸º 00:00æ—¶ï¼ŒUTC+8 çš„æ—¶é—´å°±æ˜¯ 08:00ã€‚</td></tr></tbody></table><h1 id="chrono-å…³é”®ç±»å‹">chrono å…³é”®ç±»å‹</h1><table><thead><tr class="header"><th>ç±»å‹</th><th>å«ä¹‰</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr class="odd"><td>DateTime&lt;Tz&gt;</td><td>ä¸€ä¸ªå¸¦æœ‰æ—¶åŒºçš„æ—¥æœŸå’Œæ—¶é—´ç±»å‹ï¼Œå…¶ä¸­ <code>Tz</code> æ˜¯å®ç°äº†<code>TimeZone</code> ç‰¹è´¨çš„ç±»å‹ï¼Œå¦‚ <code>Utc</code> å’Œ<code>Local</code> ã€‚è¿™æ„å‘³ç€ <code>DateTime</code>è€ƒè™‘äº†æ—¶åŒºçš„å½±å“ï¼Œå¯ä»¥è¡¨ç¤ºå…¨çƒä»»æ„åœ°ç‚¹çš„ç²¾ç¡®æ—¶é—´ã€‚</td><td>å¹¿æ³›ç”¨äºéœ€è¦è€ƒè™‘æ—¶åŒºè½¬æ¢çš„åœºæ™¯ï¼Œå¦‚å­˜å‚¨ç”¨æˆ·çš„æœ¬åœ°æ—¶é—´æˆ–åœ¨ä¸åŒåœ°åŒºä¹‹é—´è½¬æ¢æ—¶é—´ã€‚</td></tr><tr class="even"><td>NaiveDateTime</td><td>ä¸€ä¸ªâ€œå¤©çœŸçš„â€æ—¥æœŸå’Œæ—¶é—´ï¼Œå³ä¸åŒ…å«ä»»ä½•æ—¶åŒºä¿¡æ¯çš„æ—¥æœŸå’Œæ—¶é—´ã€‚è¿™ç§ç±»å‹ä»…ä»…è¡¨ç¤ºä¸€ä¸ªæ—¥å†æ—¥æœŸå’Œä¸€å¤©ä¸­çš„æ—¶é—´ï¼Œè€Œæ²¡æœ‰ä»»ä½•å…³äºåœ°ç†æˆ–æ”¿æ²»æ—¶åŒºçš„æ•°æ®ã€‚</td><td>å¯¹äºä¸€äº›æ—¶åŒºä¸é‡è¦çš„åœºæ™¯éå¸¸æœ‰ç”¨ï¼Œæ¯”å¦‚è®°å½•ç”µå½±çš„å‘è¡Œæ—¥æœŸæˆ–å†å²äº‹ä»¶çš„æ—¥æœŸã€‚</td></tr><tr class="odd"><td>NaiveDate</td><td>ä»…è¡¨ç¤ºä¸€ä¸ªæ—¥å†æ—¥æœŸï¼Œä¸åŒ…æ‹¬æ—¶é—´æˆ–æ—¶åŒºä¿¡æ¯ã€‚</td><td>å®ƒç”¨äºå¤„ç†åªéœ€è¦æ—¥æœŸè€Œä¸å…³å¿ƒå…·ä½“æ—¶é—´çš„åœºæ™¯ï¼Œå¦‚ç”Ÿæ—¥ã€èŠ‚æ—¥ç­‰ã€‚</td></tr><tr class="even"><td>NaiveTime</td><td>æ˜¯ä¸€ä¸ªåªè¡¨ç¤ºä¸€å¤©ä¸­æ—¶é—´çš„ç±»å‹ï¼Œå®ƒä¸åŒ…å«æ—¥æœŸæˆ–æ—¶åŒºä¿¡æ¯ã€‚</td><td>è¿™ä¸ªç±»å‹é€‚ç”¨äºéœ€è¦å¤„ç†å…·ä½“æŸä¸ªæ—¶é—´ç‚¹ï¼ˆå¦‚å¼€ä¼šæ—¶é—´ã€æ—¥å¸¸æ´»åŠ¨çš„å¼€å§‹æ—¶é—´ï¼‰ä½†ä¸éœ€è¦æ—¥æœŸæ•°æ®çš„æƒ…æ™¯ã€‚</td></tr></tbody></table><h1 id="chrono-æ—¶åŒºç±»å‹">chrono æ—¶åŒºç±»å‹</h1><p><code>chrono</code>æ”¯æŒå¤šç§æ—¶åŒºç±»å‹ï¼Œæ–¹ä¾¿è¿›è¡Œå…¨çƒæ—¶é—´çš„è½¬æ¢å’Œè®¡ç®—ï¼š</p><ul><li><strong><code>Utc</code></strong>: ç”¨äºå¤„ç†åè°ƒä¸–ç•Œæ—¶ã€‚</li><li><strong><code>Local</code></strong>:ä»£è¡¨æœåŠ¡å™¨æˆ–ç”¨æˆ·çš„æœ¬åœ°æ—¶åŒºã€‚</li><li><strong><code>FixedOffset</code></strong>:å…è®¸å®šä¹‰ä»»æ„çš„å°æ—¶å’Œåˆ†é’Ÿåç§»é‡ï¼Œé€‚åˆå›ºå®šåç§»çš„æ—¶é—´è®¡ç®—ã€‚</li></ul><h1 id="å¸¸ç”¨åŠŸèƒ½">å¸¸ç”¨åŠŸèƒ½</h1><h2 id="è·å–å½“å‰æ—¶é—´">è·å–å½“å‰æ—¶é—´</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">local_datetime</span>: DateTime&lt;Local&gt; = Local::<span class="hljs-title function_ invoke__">now</span>();<br><span class="hljs-keyword">let</span> <span class="hljs-variable">utc_datetime</span>: DateTime&lt;Utc&gt; = Utc::<span class="hljs-title function_ invoke__">now</span>();<br></code></pre></td></tr></table></figure><h2 id="datetime-è½¬-string">DateTime è½¬ String</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, local_datetime.<span class="hljs-title function_ invoke__">to_rfc2822</span>()); <span class="hljs-comment">// Sun, 12 May 2024 00:15:55 +0800</span><br><span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, local_datetime.<span class="hljs-title function_ invoke__">to_rfc3339</span>()); <span class="hljs-comment">// 2024-05-12T00:15:55.325058+08:00</span><br><span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, local_datetime.<span class="hljs-title function_ invoke__">to_string</span>()); <span class="hljs-comment">// 2024-05-12 00:15:55.325058 +08:00</span><br><span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, local_datetime.format(<span class="hljs-string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)) <span class="hljs-comment">// 2024-05-12 00:15:55</span><br></code></pre></td></tr></table></figure><h2 id="string-è½¬-datetime">String è½¬ DateTime</h2><p>å­—ç¬¦ä¸²å¸¦æ—¶åŒºä¿¡æ¯ï¼Œä½¿ç”¨<code>DateTime::parse_from_str(s, f)</code>ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">format_withzone</span> = <span class="hljs-string">&quot;%Y-%m-%d %H:%M:%S %z&quot;</span>;<br><span class="hljs-keyword">let</span> <span class="hljs-variable">datetime_withzone_str</span> = <span class="hljs-string">&quot;2024-01-01 00:00:00 +08:00&quot;</span>;<br><span class="hljs-keyword">let</span> <span class="hljs-variable">local_datetime</span> =<br>    DateTime::<span class="hljs-title function_ invoke__">parse_from_str</span>(&amp;datetime_withzone_str, &amp;format_withzone).<span class="hljs-title function_ invoke__">unwrap</span>();<br></code></pre></td></tr></table></figure><p>å­—ç¬¦ä¸²æ— æ—¶åŒºä¿¡æ¯ï¼Œä½¿ç”¨<code>NaiveDateTime::parse_from_str(s, f)</code>ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">format</span> = <span class="hljs-string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>;<br><span class="hljs-keyword">let</span> <span class="hljs-variable">datetime_str</span> = <span class="hljs-string">&quot;2024-01-01 00:00:00&quot;</span>;<br><span class="hljs-keyword">let</span> <span class="hljs-variable">local_datetime</span> = NaiveDateTime::<span class="hljs-title function_ invoke__">parse_from_str</span>(&amp;datetime_str, &amp;format)<br>    .<span class="hljs-title function_ invoke__">unwrap</span>()<br>    .<span class="hljs-title function_ invoke__">and_local_timezone</span>(Local) <span class="hljs-comment">// è½¬ä¸ºå¸¦æ—¶åŒºçš„ DateTime</span><br>    .<span class="hljs-title function_ invoke__">unwrap</span>();<br></code></pre></td></tr></table></figure><h2 id="datetime-è½¬-timestamp">DateTime è½¬ timestamp</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">local_datetime</span> = Local::<span class="hljs-title function_ invoke__">now</span>();<br><span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;seconds: &#123;&#125;&quot;</span>, local_datetime.<span class="hljs-title function_ invoke__">timestamp</span>()); <span class="hljs-comment">// 1715444324</span><br><span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;millis: &#123;&#125;&quot;</span>, local_datetime.<span class="hljs-title function_ invoke__">timestamp_millis</span>()); <span class="hljs-comment">// 1715444338610</span><br><span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;micros: &#123;&#125;&quot;</span>, local_datetime.<span class="hljs-title function_ invoke__">timestamp_micros</span>()); <span class="hljs-comment">// 1715444338610873</span><br><span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;nacos: &#123;&#125;&quot;</span>, local_datetime.<span class="hljs-title function_ invoke__">timestamp_nanos_opt</span>().<span class="hljs-title function_ invoke__">unwrap</span>()); <span class="hljs-comment">// 1715444338610873000</span><br></code></pre></td></tr></table></figure><h2 id="timestamp-è½¬-datetime">timestamp è½¬ DateTime</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">utc_datetime</span>: DateTime&lt;Utc&gt; = DateTime::<span class="hljs-title function_ invoke__">from_timestamp</span>(<span class="hljs-number">1704139200</span>, <span class="hljs-number">0</span>).<span class="hljs-title function_ invoke__">unwrap</span>(); <span class="hljs-comment">// é»˜è®¤æ˜¯ Utc</span><br><span class="hljs-keyword">let</span> <span class="hljs-variable">local_datetime</span>: DateTime&lt;Local&gt; = DateTime::<span class="hljs-title function_ invoke__">from_timestamp</span>(<span class="hljs-number">1704139200</span>, <span class="hljs-number">0</span>).<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-title function_ invoke__">into</span>(); <span class="hljs-comment">// ä½¿ç”¨ into() è½¬ä¸º Local</span><br></code></pre></td></tr></table></figure><h2 id="æ—¶åŒºè½¬æ¢">æ—¶åŒºè½¬æ¢</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> chrono::&#123;DateTime, FixedOffset, Utc&#125;;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">utc_date_time</span>: DateTime&lt;Utc&gt; = Utc::<span class="hljs-title function_ invoke__">now</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">fixed_offset</span> = FixedOffset::<span class="hljs-title function_ invoke__">east</span>(<span class="hljs-number">8</span> * <span class="hljs-number">3600</span>); <span class="hljs-comment">// è½¬ä¸º utc+8 ä¸œå…«åŒº</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">local_date_time</span> = utc_date_time.<span class="hljs-title function_ invoke__">with_timezone</span>(&amp;fixed_offset);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Local time in UTC+8: &#123;&#125;&quot;</span>, local_date_time);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æ—¶é—´è®¡ç®—">æ—¶é—´è®¡ç®—</h2><p>æ—¶é—´åŠ å‡ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> chrono::&#123;Duration, Local&#125;;<br><br><span class="hljs-keyword">let</span> <span class="hljs-variable">now</span> = Local::<span class="hljs-title function_ invoke__">now</span>();<br><span class="hljs-keyword">let</span> <span class="hljs-variable">yesterday</span> = now - Duration::<span class="hljs-title function_ invoke__">hours</span>(<span class="hljs-number">24</span>);<br></code></pre></td></tr></table></figure><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240512002330526.png"alt="chrono time duration methods" /><figcaption aria-hidden="true">chrono time duration methods</figcaption></figure><p>æ—¶é—´é—´éš”ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> chrono::&#123;Duration, Local&#125;;<br><br><span class="hljs-keyword">let</span> <span class="hljs-variable">now</span> = Local::<span class="hljs-title function_ invoke__">now</span>();<br><span class="hljs-keyword">let</span> <span class="hljs-variable">yesterday</span> = now - Duration::<span class="hljs-title function_ invoke__">hours</span>(<span class="hljs-number">24</span>);<br><span class="hljs-keyword">let</span> <span class="hljs-variable">hour_interval</span> = (now - yesterday).<span class="hljs-title function_ invoke__">num_hours</span>();<br></code></pre></td></tr></table></figure><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240512002106738.png"alt="chrono time interval methods" /><figcaption aria-hidden="true">chrono time interval methods</figcaption></figure><h1 id="æ€»ç»“">æ€»ç»“</h1><p>é€šè¿‡æœ¬æ–‡çš„è¯¦ç»†ä»‹ç»å’Œå®ç”¨ç¤ºä¾‹ï¼Œæˆ‘ä»¬äº†è§£äº†å¦‚ä½•ä½¿ç”¨ Rust çš„<code>chrono</code> åº“æ¥ç²¾ç¡®å¤„ç†æ—¶é—´å’Œæ—¥æœŸã€‚<code>chrono</code>ä¸ä»…æ”¯æŒå¤æ‚çš„æ—¶åŒºè®¡ç®—å’Œå…¨çƒæ—¶é—´ç®¡ç†ï¼Œè¿˜æä¾›äº†æ–¹ä¾¿çš„æ—¥æœŸæ—¶é—´è§£æå’Œæ ¼å¼åŒ–å·¥å…·ï¼Œä»¥åŠçµæ´»çš„æ—¶é—´è¿ç®—åŠŸèƒ½ã€‚æŒæ¡äº†è¿™äº›æŠ€èƒ½åï¼Œä½ å°†èƒ½å¤Ÿåœ¨ä»»ä½•éœ€è¦ç²¾ç¡®æ—¶é—´æ•°æ®å¤„ç†çš„Rust åº”ç”¨ä¸­ï¼Œæä¾›ç¨³å®šå’Œé«˜æ•ˆçš„è§£å†³æ–¹æ¡ˆã€‚</p><p>æ—¶é—´æ˜¯æ¯ä¸ªç¨‹åºçš„åŸºçŸ³ï¼Œè€Œ <code>chrono</code>å°±æ˜¯é‚£æŠŠèƒ½å¤Ÿæ“çºµæ—¶é—´çš„é­”æ–ã€‚</p><p>å¸Œæœ›æœ¬æ–‡èƒ½å¯¹ä½ æœ‰å¸®åŠ©ï¼Œpeace! enjoy coding~</p><blockquote><p>å‚è€ƒï¼š</p><ul><li><a href="https://docs.rs/chrono/latest/chrono/">chronocrate</a></li><li><ahref="https://blog.stackademic.com/rust-working-with-date-and-time-30e003cd59e8">rust-working-with-date-and-time</a></li></ul><p>ä½œå›¾ï¼š</p><ul><li>https://excalidraw.com/</li></ul></blockquote>]]></content>
    
    
    <summary type="html">æœ¬æ–‡å…¨é¢çš„æŒ‡å—æ·±å…¥ä»‹ç»äº†å¦‚ä½•åœ¨ Rust ä¸­ä½¿ç”¨ chrono åº“æ¥ç²¾ç¡®å¤„ç†å’Œè½¬æ¢æ—¶é—´ä¸æ—¥æœŸã€‚ä»åŸºæœ¬æ¦‚å¿µåˆ°é«˜çº§åŠŸèƒ½ï¼Œæœ¬æ–‡æä¾›äº†å®ç”¨çš„ä»£ç ç¤ºä¾‹å’Œè¯¦å°½çš„è§£é‡Šï¼Œå¸®åŠ©ä½ åœ¨ä»»ä½• Rust é¡¹ç›®ä¸­é«˜æ•ˆç®¡ç†æ—¶é—´ã€‚</summary>
    
    
    
    <category term="Rust" scheme="https://hedon.top/categories/Rust/"/>
    
    <category term="Rust å¸¸ç”¨åº“" scheme="https://hedon.top/categories/Rust/Rust-%E5%B8%B8%E7%94%A8%E5%BA%93/"/>
    
    
    <category term="Rust" scheme="https://hedon.top/tags/Rust/"/>
    
  </entry>
  
  <entry>
    <title>epoll</title>
    <link href="https://hedon.top/2024/04/28/epoll/"/>
    <id>https://hedon.top/2024/04/28/epoll/</id>
    <published>2024-04-28T12:27:29.000Z</published>
    <updated>2024-05-06T09:11:27.155Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€">å‰è¨€</h1><p><code>epoll</code> æ˜¯ä¸€ç§ I/Oå¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œä¸»è¦ç”¨äºé«˜æ€§èƒ½çš„ç½‘ç»œæœåŠ¡å™¨ä¸­ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤§é‡å¹¶å‘è¿æ¥æ—¶ã€‚å®ƒæ˜¯Linux ç‰¹æœ‰çš„ï¼Œè‡ª Linux å†…æ ¸ 2.5.44ç‰ˆæœ¬å¼•å…¥ï¼Œå¹¶åœ¨åç»­ç‰ˆæœ¬ä¸­ä¸æ–­ä¼˜åŒ–ã€‚<code>epoll</code>èƒ½å¤Ÿå¸®åŠ©æœåŠ¡å™¨é«˜æ•ˆåœ°ç®¡ç†æ•°ä»¥åƒè®¡çš„å®¢æˆ·ç«¯è¿æ¥ï¼Œæ˜¯ <code>select</code> å’Œ<code>poll</code> æ–¹æ³•çš„ç°ä»£æ›¿ä»£å“ã€‚</p><p>æœ¬æ–‡ä¸å¯¹ <code>epoll</code>çš„æºç è¿›è¡Œåˆ†æï¼Œä»…åšåŸç†ä¸Šçš„æ€»ç»“ï¼Œæ–¹ä¾¿å¿«é€ŸæŸ¥é˜…å›é¡¾ã€‚å„å¤§è®ºå›å¾ˆå¤šå¤§ä½¬éƒ½å¯¹<code>epoll</code>çš„æºç è¿›è¡Œäº†è¯¦å°½çš„åˆ†æï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥çœ‹ã€Œå‚è€ƒã€ç¯‡ç« ã€‚</p><h1 id="ä¸»è¦ç‰¹ç‚¹">ä¸»è¦ç‰¹ç‚¹</h1><ol type="1"><li><strong>æ•ˆç‡é«˜</strong>: ç›¸è¾ƒäº <code>select</code> å’Œ<code>poll</code>ï¼Œ<code>epoll</code>å¯ä»¥æ›´é«˜æ•ˆåœ°å¤„ç†å¤§é‡çš„å¹¶å‘è¿æ¥ã€‚<code>select</code> å’Œ <code>poll</code>çš„æ•ˆç‡éšç€ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡å¢åŠ è€Œçº¿æ€§ä¸‹é™ï¼Œè€Œ <code>epoll</code>åˆ™ä¸ä¼šå› ä¸ºç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡å¢åŠ è€Œæ˜¾è‘—é™ä½æ•ˆç‡ã€‚</li><li><strong>æ‰©å±•æ€§å¥½</strong>: <code>epoll</code>ä½¿ç”¨ä¸€ç§ç§°ä¸ºäº‹ä»¶é€šçŸ¥çš„æœºåˆ¶ï¼Œåªä¼šå¤„ç†é‚£äº›çœŸæ­£å‘ç”Ÿäº†äº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ã€‚è¿™æ„å‘³ç€ç³»ç»Ÿä¸å¿…é‡æ–°æ£€æŸ¥æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ï¼Œä»è€Œå¤§å¤§å‡å°‘äº†ä¸å¿…è¦çš„CPU å¼€é”€ã€‚</li><li><strong>æ”¯æŒè¾¹ç¼˜è§¦å‘å’Œæ°´å¹³è§¦å‘</strong>: <code>epoll</code> æ”¯æŒ<code>Edge Triggered</code> å’Œæ°´å¹³è§¦å‘ <code>Level Triggered</code>ä¸¤ç§æ¨¡å¼ã€‚è¾¹ç¼˜è§¦å‘æ¨¡å¼åªåœ¨æ–‡ä»¶æè¿°ç¬¦çŠ¶æ€æ”¹å˜æ—¶æ‰é€šçŸ¥åº”ç”¨ç¨‹åºï¼Œé€‚ç”¨äºéé˜»å¡I/Oï¼›è€Œæ°´å¹³è§¦å‘æ¨¡å¼åˆ™åœ¨æœ‰äº‹ä»¶å¯è¯»æˆ–å¯å†™æ—¶éƒ½ä¼šé€šçŸ¥åº”ç”¨ç¨‹åºï¼Œæ›´å®¹æ˜“ä½¿ç”¨ä½†æ•ˆç‡ç•¥ä½ã€‚</li></ol><h1 id="ç»“è®ºå…ˆè¡Œ">ç»“è®ºå…ˆè¡Œ</h1><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240429121302958.png"alt="epoll flow chart" /><figcaption aria-hidden="true">epoll flow chart</figcaption></figure><h1 id="å·¥ä½œåŸç†">å·¥ä½œåŸç†</h1><p><code>epoll</code> çš„å·¥ä½œå¯ä»¥åˆ†ä¸ºä¸‰ä¸ªä¸»è¦æ­¥éª¤ï¼š</p><ol type="1"><li><strong>åˆ›å»º epoll å®ä¾‹</strong>: ä½¿ç”¨ <code>epoll_create</code>å‡½æ•°åˆ›å»ºä¸€ä¸ª <code>epoll</code> å®ä¾‹ã€‚</li><li><strong>æ·»åŠ /ä¿®æ”¹/åˆ é™¤æ–‡ä»¶æè¿°ç¬¦</strong>: ä½¿ç”¨<code>epoll_ctl</code> å‡½æ•°å°†æ–°çš„æ–‡ä»¶æè¿°ç¬¦æ·»åŠ åˆ° <code>epoll</code>å®ä¾‹ä¸­ï¼Œæˆ–è€…ä¿®æ”¹ã€åˆ é™¤å·²å­˜åœ¨çš„æ–‡ä»¶æè¿°ç¬¦ã€‚è¿™äº›æ“ä½œä¸æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡æ— å…³ï¼Œå› æ­¤æ‰§è¡Œé€Ÿåº¦éå¸¸å¿«ã€‚</li><li><strong>ç­‰å¾…äº‹ä»¶å‘ç”Ÿ</strong>: ä½¿ç”¨ <code>epoll_wait</code>å‡½æ•°ç­‰å¾…äº‹ä»¶çš„å‘ç”Ÿã€‚è¿™ä¸ªå‡½æ•°å¯ä»¥åŒæ—¶ç›‘æ§å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå½“æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦ä¸Šå‘ç”Ÿäº†æ³¨å†Œçš„äº‹ä»¶æ—¶ï¼Œå‡½æ•°è¿”å›ï¼Œå¹¶å‘ŠçŸ¥å“ªäº›æ–‡ä»¶æè¿°ç¬¦ä¸Šå‘ç”Ÿäº†äº‹ä»¶ã€‚</li></ol><h1 id="et-lt">ET &amp; LT</h1><p>åœ¨ <code>epoll</code> ä¸­ï¼Œè¾¹ç¼˜è§¦å‘ï¼ˆET, EdgeTriggeredï¼‰å’Œæ°´å¹³è§¦å‘ï¼ˆLT, LevelTriggeredï¼‰æ˜¯ä¸¤ç§ä¸åŒçš„äº‹ä»¶é€šçŸ¥æ–¹å¼ï¼Œå®ƒä»¬å®šä¹‰äº†æ“ä½œç³»ç»Ÿå¦‚ä½•é€šçŸ¥åº”ç”¨ç¨‹åºæ–‡ä»¶æè¿°ç¬¦ä¸Šçš„I/O äº‹ä»¶ã€‚</p><p>è¿™ä¸¤ç§æ¨¡å¼çš„ä¸»è¦åŒºåˆ«åœ¨äºä½•æ—¶ä»¥åŠå¦‚ä½•å¤šæ¬¡é€šçŸ¥åº”ç”¨ç¨‹åºå…³äºæŸä¸ªæ–‡ä»¶æè¿°ç¬¦çš„äº‹ä»¶ã€‚</p><h2 id="æ°´å¹³è§¦å‘level-triggered">æ°´å¹³è§¦å‘ï¼ˆLevel Triggeredï¼‰</h2><ul><li><strong>å®šä¹‰</strong>: åœ¨æ°´å¹³è§¦å‘æ¨¡å¼ä¸‹ï¼Œåªè¦æ–‡ä»¶æè¿°ç¬¦ä¸Šæœ‰æœªå¤„ç†çš„I/O äº‹ä»¶å­˜åœ¨ï¼Œ<code>epoll_wait</code>å°±ä¼šé€šçŸ¥åº”ç”¨ç¨‹åºã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœæ•°æ®å¯è¯»å–ä½†æœªè¢«å®Œå…¨è¯»å–ï¼Œ<code>epoll_wait</code>ä¼šåœ¨ä¸‹æ¬¡è°ƒç”¨æ—¶å†æ¬¡è¿”å›è¯¥æ–‡ä»¶æè¿°ç¬¦ã€‚</li><li><strong>è¡Œä¸º</strong>:è¿™ç§æ¨¡å¼æ›´å®¹æ˜“ç¼–ç¨‹ï¼Œå› ä¸ºåº”ç”¨ç¨‹åºå¯ä»¥ä¸ç”¨æ‹…å¿ƒåœ¨ä¸€ä¸ªæ“ä½œä¸­å¤„ç†æ‰€æœ‰æ•°æ®ã€‚å¦‚æœæ•°æ®è¿˜åœ¨ï¼Œ<code>epoll_wait</code>ä¼šç»§ç»­é€šçŸ¥ä½ ã€‚</li><li><strong>é€‚ç”¨åœºæ™¯</strong>:æ›´é€‚åˆé‚£äº›ç®€å•çš„åº”ç”¨æˆ–è€…å¯¹å®æ—¶æ€§è¦æ±‚ä¸æ˜¯éå¸¸é«˜çš„åº”ç”¨ï¼Œå› ä¸ºå®ƒç®€åŒ–äº†å¤„ç†é€»è¾‘ã€‚</li></ul><h2 id="è¾¹ç¼˜è§¦å‘edge-triggered">è¾¹ç¼˜è§¦å‘ï¼ˆEdge Triggeredï¼‰</h2><ul><li><strong>å®šä¹‰</strong>:åœ¨è¾¹ç¼˜è§¦å‘æ¨¡å¼ä¸‹ï¼Œåªæœ‰çŠ¶æ€å˜åŒ–æ—¶ï¼ˆä¾‹å¦‚ä»æ— æ•°æ®åˆ°æœ‰æ•°æ®ï¼‰ï¼Œ<code>epoll_wait</code>æ‰ä¼šé€šçŸ¥åº”ç”¨ç¨‹åºã€‚ä¸€æ—¦é€šçŸ¥äº†åº”ç”¨ç¨‹åºæŸäº‹ä»¶å‘ç”Ÿï¼Œé™¤éæœ‰æ–°çš„æ•°æ®åˆ°è¾¾æˆ–çŠ¶æ€å†æ¬¡å‘ç”Ÿå˜åŒ–ï¼Œå¦åˆ™ä¸ä¼šå†æ¬¡é€šçŸ¥åº”ç”¨ç¨‹åºè¯¥äº‹ä»¶ã€‚</li><li><strong>è¡Œä¸º</strong>:è¿™è¦æ±‚åº”ç”¨ç¨‹åºå¿…é¡»ç«‹å³å¤„ç†æ‰€æœ‰äº‹ä»¶ï¼Œå› ä¸ºä¹‹åä¸ä¼šå†æ”¶åˆ°å…³äºè¿™äº›äº‹ä»¶çš„é€šçŸ¥ã€‚è¿™æ„å‘³ç€åº”ç”¨ç¨‹åºå¿…é¡»å¾ªç¯è¯»å–æˆ–å†™å…¥ï¼Œç›´åˆ°æ•°æ®è¢«å®Œå…¨å¤„ç†å®Œï¼Œä»¥ç¡®ä¿ä¸é—æ¼ä»»ä½•äº‹ä»¶ã€‚</li><li><strong>é€‚ç”¨åœºæ™¯</strong>:é€‚åˆéœ€è¦é«˜æ€§èƒ½çš„åœºæ™¯ï¼Œå› ä¸ºå®ƒå‡å°‘äº†äº‹ä»¶å¤„ç†çš„æ¬¡æ•°ï¼Œä½†è¦æ±‚ç¨‹åºå¿…é¡»æ›´åŠ å°å¿ƒåœ°ç®¡ç†I/O æ“ä½œã€‚</li></ul><h2 id="æ¯”è¾ƒå’Œé€‰æ‹©">æ¯”è¾ƒå’Œé€‰æ‹©</h2><ul><li><strong>æ€§èƒ½</strong>:è¾¹ç¼˜è§¦å‘é€šå¸¸æä¾›æ›´é«˜çš„æ€§èƒ½ï¼Œå› ä¸ºå®ƒå‡å°‘äº†ç³»ç»Ÿè°ƒç”¨çš„æ¬¡æ•°å’Œä¸å¿…è¦çš„äº‹ä»¶å¤„ç†ã€‚</li><li><strong>ç¼–ç¨‹å¤æ‚æ€§</strong>:è¾¹ç¼˜è§¦å‘æ¨¡å¼ç¼–ç¨‹æ¯”æ°´å¹³è§¦å‘å¤æ‚ï¼Œå› ä¸ºéœ€è¦ç¡®ä¿æ¯æ¬¡äº‹ä»¶è¢«å½»åº•å¤„ç†ï¼Œå¹¶ä¸”æ›´å®¹æ˜“é‡åˆ°å¦‚â€œæƒŠç¾¤æ•ˆåº”â€ï¼ˆå¤šä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹è¢«åŒä¸€ä¸ªäº‹ä»¶å”¤é†’ï¼‰ç­‰é—®é¢˜ã€‚</li><li><strong>å¯é æ€§</strong>:æ°´å¹³è§¦å‘å› ä¸ºå…¶ç®€å•çš„è¡Œä¸ºæ¨¡å¼ï¼Œåœ¨å¯é æ€§å¤„ç†ä¸Šæ›´ä¸ºç›´æ¥å’Œå®¹æ˜“ã€‚</li></ul><p>é€šå¸¸ï¼Œé€‰æ‹©å“ªç§æ¨¡å¼å–å†³äºåº”ç”¨çš„å…·ä½“éœ€æ±‚ã€é¢„æœŸçš„è´Ÿè½½ä»¥åŠå¼€å‘è€…å¯¹äº‹ä»¶å¤„ç†é€»è¾‘çš„æ§åˆ¶ç¨‹åº¦ã€‚é«˜æ€§èƒ½æœåŠ¡å™¨é€šå¸¸é€‰æ‹©è¾¹ç¼˜è§¦å‘æ¨¡å¼ï¼Œä»¥æœ€å¤§åŒ–å…¶æ•ˆç‡ï¼Œè€Œç®€å•çš„æˆ–è€…ä½è´Ÿè½½åº”ç”¨å¯èƒ½ä¼šæ›´å€¾å‘äºä½¿ç”¨æ°´å¹³è§¦å‘ï¼Œä»¥ç®€åŒ–å¼€å‘å’Œè°ƒè¯•è¿‡ç¨‹ã€‚</p><h1 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h1><p><code>epoll</code> ä½¿ç”¨ 2ç§å…³é”®çš„æ•°æ®ç»“æ„æ¥ç»´æŠ¤å’Œè·Ÿè¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆFDï¼‰å’Œäº‹ä»¶ï¼š</p><ol type="1"><li><strong>çº¢é»‘æ ‘ï¼ˆRed-Black Treeï¼‰</strong>:ç”¨äºå­˜å‚¨æ‰€æœ‰æ³¨å†Œçš„æ–‡ä»¶æè¿°ç¬¦åŠå…¶äº‹ä»¶ã€‚çº¢é»‘æ ‘æ˜¯ä¸€ç§è‡ªå¹³è¡¡äºŒå‰æœç´¢æ ‘ï¼Œèƒ½å¤Ÿåœ¨å¯¹æ•°æ—¶é—´å†…å®Œæˆæ’å…¥ã€åˆ é™¤å’ŒæŸ¥æ‰¾æ“ä½œï¼Œè¿™ä½¿å¾—ç®¡ç†å¤§é‡æ–‡ä»¶æè¿°ç¬¦å˜å¾—é«˜æ•ˆã€‚</li><li><strong>å°±ç»ªåˆ—è¡¨ï¼ˆReady Listï¼‰</strong>:å½“äº‹ä»¶å‘ç”Ÿï¼ˆå¦‚å¯è¯»ã€å¯å†™ç­‰ï¼‰å¹¶è¢«å†…æ ¸æ£€æµ‹åˆ°æ—¶ï¼Œç›¸åº”çš„ FDä¼šè¢«æ·»åŠ åˆ°ä¸€ä¸ªå°±ç»ªåˆ—è¡¨ä¸­ã€‚è¿™ä¸ªåˆ—è¡¨ä»…åŒ…å«å®é™…æœ‰äº‹ä»¶å‘ç”Ÿçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä»è€Œå‡å°‘äº†<code>epoll_wait</code> è°ƒç”¨çš„å¤„ç†æ—¶é—´ã€‚</li></ol><h1 id="å·¥ä½œç»†èŠ‚">å·¥ä½œç»†èŠ‚</h1><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/epoll_principle.jpg"alt="epoll data structure" /><figcaption aria-hidden="true">epoll data structure</figcaption></figure><ol type="1"><li>é€šè¿‡è°ƒç”¨ <code>epoll_create()</code> å‡½æ•°åˆ›å»ºå¹¶åˆå§‹åŒ–ä¸€ä¸ª<code>eventpoll</code> å¯¹è±¡ã€‚</li><li>é€šè¿‡è°ƒç”¨ <code>epoll_ctl()</code> å‡½æ•°æŠŠè¢«ç›‘å¬çš„æ–‡ä»¶å¥æŸ„ (å¦‚ socketå¥æŸ„) å°è£…æˆ <code>epitem</code> å¯¹è±¡å¹¶ä¸”æ·»åŠ åˆ° <code>eventpoll</code>å¯¹è±¡çš„çº¢é»‘æ ‘ä¸­è¿›è¡Œç®¡ç†ã€‚</li><li>é€šè¿‡è°ƒç”¨ <code>epoll_wait()</code>å‡½æ•°ç­‰å¾…è¢«ç›‘å¬çš„æ–‡ä»¶çŠ¶æ€å‘ç”Ÿæ”¹å˜ã€‚</li><li>å½“è¢«ç›‘å¬çš„æ–‡ä»¶çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼ˆå¦‚ socketæ¥æ”¶åˆ°æ•°æ®ï¼‰ï¼Œä¼šæŠŠæ–‡ä»¶å¥æŸ„å¯¹åº” <code>epitem</code> å¯¹è±¡æ·»åŠ åˆ°<code>eventpoll</code> å¯¹è±¡çš„å°±ç»ªé˜Ÿåˆ— <code>rdllist</code>ä¸­ã€‚å¹¶ä¸”æŠŠå°±ç»ªé˜Ÿåˆ—çš„æ–‡ä»¶åˆ—è¡¨å¤åˆ¶åˆ° <code>epoll_wait()</code> å‡½æ•°çš„<code>events</code> å‚æ•°ä¸­ã€‚</li><li>å”¤é†’è°ƒç”¨ <code>epoll_wait()</code> å‡½æ•°è¢«é˜»å¡ï¼ˆç¡çœ ï¼‰çš„è¿›ç¨‹ã€‚</li></ol><h1 id="äº‹ä»¶ç›‘å¬">äº‹ä»¶ç›‘å¬</h1><p>å†…æ ¸ä¸­çš„äº‹ä»¶ç›‘å¬å’Œå›è°ƒæœºåˆ¶æ˜¯é€šè¿‡é«˜æ•ˆçš„äº‹ä»¶é©±åŠ¨æ¨¡å‹å®ç°çš„ï¼Œè€Œä¸æ˜¯ç®€å•çš„å¾ªç¯æ£€æŸ¥ï¼ˆå¦‚åœ¨ç”¨æˆ·ç©ºé—´ä¸­çš„è½®è¯¢ï¼‰ã€‚è¿™ç§æœºåˆ¶åˆ©ç”¨äº†ç°ä»£æ“ä½œç³»ç»Ÿçš„ä¸­æ–­å’Œå›è°ƒç³»ç»Ÿï¼Œä»¥åŠé’ˆå¯¹å¼‚æ­¥äº‹ä»¶çš„ä¼˜åŒ–å¤„ç†ç­–ç•¥ã€‚</p><p>ä»¥ä¸‹æ˜¯è¿™ä¸ªè¿‡ç¨‹çš„è¯¦ç»†è§£é‡Šï¼š</p><h2 id="ä¸­æ–­å’Œä¸­æ–­å¤„ç†">1. ä¸­æ–­å’Œä¸­æ–­å¤„ç†</h2><p>åœ¨ç¡¬ä»¶å±‚é¢ï¼Œå¤§å¤šæ•° I/O æ“ä½œï¼ˆå¦‚ç½‘ç»œé€šä¿¡ã€ç£ç›˜I/Oï¼‰éƒ½æ˜¯é€šè¿‡ä¸­æ–­é©±åŠ¨çš„ã€‚å½“ä¸€ä¸ª I/Oè®¾å¤‡å‡†å¤‡å¥½æ•°æ®æˆ–éœ€è¦æœåŠ¡æ—¶ï¼Œå®ƒä¼šäº§ç”Ÿä¸€ä¸ªä¸­æ–­ä¿¡å·ï¼Œè¿™ä¸ªä¿¡å·è¢«å‘é€åˆ°CPUã€‚CPU å“åº”ä¸­æ–­ï¼Œå¹¶æ‰§è¡Œä¸€ä¸ªé¢„å®šçš„ä¸­æ–­å¤„ç†ç¨‹åºï¼ˆInterrupt ServiceRoutine, ISRï¼‰ï¼Œè¯¥ç¨‹åºæ˜¯ç”±è®¾å¤‡çš„é©±åŠ¨ç¨‹åºæä¾›çš„ã€‚</p><h2 id="äº‹ä»¶å’Œå›è°ƒ">2. äº‹ä»¶å’Œå›è°ƒ</h2><p>åœ¨ ISRä¸­ï¼Œä¸è®¾å¤‡ç›¸å…³çš„äº‹ä»¶ï¼ˆä¾‹å¦‚ç½‘ç»œåŒ…çš„æ¥æ”¶ã€ç¡¬ç›˜è¯»å–å®Œæˆï¼‰ä¼šè¢«æ£€æµ‹åˆ°ï¼Œå¹¶ä¸”å¯ä»¥åœ¨æ­¤é˜¶æ®µè°ƒç”¨ç‰¹å®šçš„å›è°ƒå‡½æ•°ã€‚è¿™äº›å›è°ƒå‡½æ•°æ˜¯åœ¨è®¾å¤‡é©±åŠ¨æˆ–ç›¸å…³çš„å†…æ ¸æ¨¡å—ä¸­å®šä¹‰çš„ï¼Œç”¨æ¥é€šçŸ¥å†…æ ¸å…¶ä»–éƒ¨åˆ†æˆ–è€…ç›¸å…³çš„è¿›ç¨‹æœ‰å…³äº‹ä»¶çš„å‘ç”Ÿã€‚</p><h2 id="æ–‡ä»¶æè¿°ç¬¦çš„å›è°ƒæœºåˆ¶">3. æ–‡ä»¶æè¿°ç¬¦çš„å›è°ƒæœºåˆ¶</h2><p>å¯¹äº <code>epoll</code> ç­‰ I/Oå¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œå†…æ ¸ä¸ºæ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦ç»´æŠ¤äº†ä¸€ä¸ªäº‹ä»¶å¤„ç†æœºåˆ¶ã€‚å½“æ–‡ä»¶æè¿°ç¬¦è¢«åˆ›å»ºæ—¶ï¼Œç›¸å…³çš„è®¾å¤‡æˆ–èµ„æºä¼šæ³¨å†Œä¸€ç»„å›è°ƒå‡½æ•°ï¼Œè¿™äº›å‡½æ•°ä¼šåœ¨ç‰¹å®šçš„æ“ä½œï¼ˆå¦‚è¯»ã€å†™ã€é”™è¯¯ï¼‰ä¸Šè¢«è§¦å‘ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªç½‘ç»œå¥—æ¥å­—å¯èƒ½ä¼šåœ¨æ•°æ®åˆ°è¾¾æ—¶è§¦å‘ä¸€ä¸ªâ€œå¯è¯»â€äº‹ä»¶çš„å›è°ƒã€‚</p><h2 id="epoll-çš„äº‹ä»¶ç»‘å®š">4. <code>epoll</code> çš„äº‹ä»¶ç»‘å®š</h2><p>å½“ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦è¢«åŠ å…¥åˆ° <code>epoll</code>ç›‘å¬é˜Ÿåˆ—ä¸­ï¼Œ<code>epoll</code>ä¼šåˆ©ç”¨è¿™äº›å›è°ƒæ¥è·å¾—äº‹ä»¶é€šçŸ¥ã€‚<code>epoll</code>æ“ä½œç›¸å…³çš„ä»£ç ä¼šå°†ä¸€ä¸ªé¢å¤–çš„å›è°ƒå‡½æ•°ç»‘å®šåˆ°è¿™äº›æ–‡ä»¶æè¿°ç¬¦ä¸Šã€‚å½“æ–‡ä»¶æè¿°ç¬¦çš„çŠ¶æ€æ”¹å˜æ—¶ï¼ˆå¦‚æ•°æ®å¯è¯»ï¼‰ï¼Œè¿™ä¸ªå›è°ƒå‡½æ•°å°†è¢«è§¦å‘ï¼Œç„¶åå®ƒä¼šå°†ç›¸åº”çš„æ–‡ä»¶æè¿°ç¬¦æ ‡è®°ä¸ºâ€œå°±ç»ªâ€ï¼Œå¹¶æ”¾å…¥<code>epoll</code> çš„å°±ç»ªé˜Ÿåˆ—ã€‚</p><h2 id="äº‹ä»¶é€šçŸ¥å’Œå”¤é†’">5. äº‹ä»¶é€šçŸ¥å’Œå”¤é†’</h2><p>å½“ <code>epoll_wait</code>è¢«è°ƒç”¨ä¸”æœ‰äº‹ä»¶å°±ç»ªæ—¶ï¼Œå†…æ ¸ä¼šæ£€æŸ¥å°±ç»ªé˜Ÿåˆ—ï¼Œå¹¶å°†è¿™äº›äº‹ä»¶ä¼ é€’ç»™ç­‰å¾…çš„è¿›ç¨‹ã€‚å¦‚æœæ²¡æœ‰äº‹ä»¶å°±ç»ªï¼Œè¿›ç¨‹å°†è¢«æŒ‚èµ·ç›´åˆ°æœ‰äº‹ä»¶å‘ç”Ÿã€‚äº‹ä»¶çš„å‘ç”Ÿä¼šè§¦å‘å†…æ ¸è°ƒåº¦ç¨‹åºå”¤é†’ç›¸åº”çš„è¿›ç¨‹ã€‚</p><h2 id="æ•ˆç‡å’Œæ€§èƒ½">6. æ•ˆç‡å’Œæ€§èƒ½</h2><p>è¿™ç§åŸºäºä¸­æ–­çš„äº‹ä»¶é€šçŸ¥æœºåˆ¶æ„å‘³ç€å†…æ ¸ä¸éœ€è¦ä¸æ–­å¾ªç¯æ£€æŸ¥æ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„çŠ¶æ€ï¼Œä»è€Œæå¤§åœ°æé«˜äº†æ•ˆç‡ã€‚äº‹ä»¶åªæœ‰åœ¨å®é™…å‘ç”Ÿæ—¶æ‰è¢«å¤„ç†ï¼Œä¸”å¤„ç†é€šå¸¸æ˜¯ç”±ç¡¬ä»¶ä¸­æ–­ç›´æ¥è§¦å‘çš„ï¼Œè¿™ä½¿å¾—æ•´ä¸ªç³»ç»Ÿæ›´åŠ å“åº”å¿«é€Ÿï¼Œå‡å°‘äº†æ— æ•ˆçš„CPU ä½¿ç”¨ã€‚</p><p>è¿™ç§è®¾è®¡ä½¿å¾— Linux å†…æ ¸åœ¨å¤„ç†å¤§é‡å¹¶å‘ I/Oæ“ä½œæ—¶èƒ½å¤Ÿä¿æŒé«˜æ•ˆå’Œç¨³å®šï¼Œé€‚åˆæ„å»ºé«˜æ€§èƒ½çš„ç½‘ç»œæœåŠ¡å’Œåº”ç”¨ã€‚</p><h1 id="ä¸­æ–­">ä¸­æ–­</h1><p>ä¸­æ–­æœºåˆ¶æ˜¯è®¡ç®—æœºç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿæ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œå®ƒå…è®¸å¤–è®¾æˆ–ç¡¬ä»¶å¼‚æ­¥åœ°é€šçŸ¥CPU éœ€è¦å¤„ç†æŸäº›äº‹ä»¶ã€‚ä¸­æ–­æœºåˆ¶çš„å®ç°å¹¶ä¸ä¾èµ–äºç±»ä¼¼äº <code>for</code>å¾ªç¯çš„è½®è¯¢æ£€æŸ¥ï¼Œè€Œæ˜¯å»ºç«‹åœ¨æ›´ä¸ºç›´æ¥å’Œé«˜æ•ˆçš„ç¡¬ä»¶å’Œå¤„ç†å™¨æ¶æ„æ”¯æŒä¹‹ä¸Šã€‚</p><p>å½“ CPUæ¥æ”¶åˆ°ä¸­æ–­ä¿¡å·æ—¶ï¼Œå®ƒæ˜¯é€šè¿‡ä¸€å¥—å†…å»ºäºç¡¬ä»¶çš„åè°ƒæœºåˆ¶æ¥è¯†åˆ«å’Œå“åº”ä¸­æ–­çš„ã€‚è¿™ä¸ªè¿‡ç¨‹æ¶‰åŠç¡¬ä»¶ç”µè·¯è®¾è®¡ã€å¤„ç†å™¨æ¶æ„å’Œæ“ä½œç³»ç»Ÿçš„ä¸­æ–­ç®¡ç†åŠŸèƒ½ã€‚</p><p>ä»¥ä¸‹æ˜¯ CPU å¦‚ä½•çŸ¥é“æœ‰ä¸­æ–­å‘ç”Ÿï¼Œå¹¶ä¸”å¦‚ä½•å¤„ç†è¿™ä¸€ä¸­æ–­çš„è¯¦ç»†æ­¥éª¤ï¼š</p><h2 id="ä¸­æ–­ä¿¡å·çš„æ£€æµ‹å’Œå“åº”">ä¸­æ–­ä¿¡å·çš„æ£€æµ‹å’Œå“åº”</h2><ol type="1"><li><p><strong>ä¸­æ–­è¯·æ±‚çº¿ï¼ˆIRQï¼‰</strong>ï¼šå¤–éƒ¨è®¾å¤‡é€šè¿‡è¿æ¥åˆ°å¤„ç†å™¨çš„ä¸€ä¸ªç‰¹å®šçš„ç¡¬ä»¶çº¿è·¯ï¼ˆIRQï¼‰å‘é€ä¸­æ–­ä¿¡å·ã€‚è¿™ä¸ªçº¿è·¯ç›´æ¥ä¸å¤„ç†å™¨å†…çš„ä¸­æ–­æ§åˆ¶å•å…ƒï¼ˆInterruptControllerï¼‰ç›¸è¿ã€‚</p></li><li><p><strong>ä¸­æ–­æ§åˆ¶å™¨</strong>ï¼šå¤§å¤šæ•°ç°ä»£è®¡ç®—æœºç³»ç»Ÿä½¿ç”¨ä¸€ä¸ªæˆ–å¤šä¸ªä¸­æ–­æ§åˆ¶å™¨æ¥ç®¡ç†ä¸­æ–­ä¿¡å·ã€‚ä¸­æ–­æ§åˆ¶å™¨çš„ä»»åŠ¡æ˜¯æ¥æ”¶æ¥è‡ªå„ç§å¤–éƒ¨è®¾å¤‡çš„ä¸­æ–­è¯·æ±‚ï¼Œå¹¶å°†è¿™äº›è¯·æ±‚ä¼˜å…ˆçº§æ’åºåå‘é€ç»™CPUã€‚</p></li><li><p><strong>ä¸­æ–­å‘é‡</strong>ï¼šå½“ä¸­æ–­æ§åˆ¶å™¨æ¥æ”¶åˆ°ä¸€ä¸ªä¸­æ–­ä¿¡å·åï¼Œå®ƒä¼šæ ¹æ®ä¸­æ–­æºç¡®å®šä¸€ä¸ªä¸­æ–­å‘é‡ã€‚è¿™ä¸ªå‘é‡æ˜¯ä¸€ä¸ªæ•°å­—ï¼ŒæŒ‡å‘ä¸­æ–­å‘é‡è¡¨ä¸­å¯¹åº”çš„å…¥å£ï¼Œè¯¥å…¥å£åŒ…å«äº†å¤„ç†è¯¥ä¸­æ–­çš„ä¸­æ–­æœåŠ¡ä¾‹ç¨‹ï¼ˆISRï¼‰çš„åœ°å€ã€‚</p></li></ol><h2 id="cpu-å¦‚ä½•å¤„ç†ä¸­æ–­">CPU å¦‚ä½•å¤„ç†ä¸­æ–­</h2><ol type="1"><li><p><strong>å½“å‰æŒ‡ä»¤çš„å®Œæˆ</strong>ï¼šå½“ CPUæ¥æ”¶åˆ°ä¸­æ–­æ§åˆ¶å™¨å‘å‡ºçš„ä¸­æ–­ä¿¡å·æ—¶ï¼Œå®ƒé¦–å…ˆä¼šå®Œæˆå½“å‰æ‰§è¡Œçš„æŒ‡ä»¤ã€‚è¿™æ˜¯ä¸ºäº†ä¿è¯ç¨‹åºçš„çŠ¶æ€èƒ½å¤Ÿæ­£ç¡®ä¿å­˜ï¼Œä»è€Œåœ¨ä¸­æ–­å¤„ç†å®Œæ¯•åå¯ä»¥æ— ç¼åœ°æ¢å¤æ‰§è¡Œã€‚</p></li><li><p><strong>ä¿å­˜ä¸Šä¸‹æ–‡</strong>ï¼šä¸€æ—¦å½“å‰æŒ‡ä»¤æ‰§è¡Œå®Œæ¯•ï¼ŒCPUä¼šè‡ªåŠ¨ä¿å­˜å½“å‰çš„ç¨‹åºçŠ¶æ€ï¼ŒåŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰ã€å¯„å­˜å™¨å’Œå…¶ä»–å¿…è¦çš„çŠ¶æ€ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯é€šå¸¸è¢«æ¨é€åˆ°å½“å‰çš„æ ˆä¸Šã€‚</p></li><li><p><strong>è·³è½¬åˆ° ISR</strong>ï¼šCPUä½¿ç”¨ä¸­æ–­å‘é‡æ¥è®¿é—®ä¸­æ–­å‘é‡è¡¨ï¼Œæ‰¾åˆ°ä¸ä¸­æ–­å·å¯¹åº”çš„ä¸­æ–­æœåŠ¡ä¾‹ç¨‹ï¼ˆISRï¼‰çš„åœ°å€ï¼Œå¹¶è·³è½¬åˆ°è¯¥åœ°å€å¼€å§‹æ‰§è¡ŒISRã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯è‡ªåŠ¨çš„ï¼Œç”±å¤„ç†å™¨çš„å†…éƒ¨æœºåˆ¶æ§åˆ¶ã€‚</p></li><li><p><strong>æ‰§è¡ŒISR</strong>ï¼šä¸­æ–­æœåŠ¡ä¾‹ç¨‹ä¼šæ‰§è¡Œå¿…è¦çš„æ“ä½œæ¥å¤„ç†ä¸­æ–­ï¼Œæ¯”å¦‚è¯»å–æ•°æ®ç¼“å†²åŒºã€æ¸…é™¤è®¾å¤‡çŠ¶æ€æˆ–å‘é€ä¿¡å·ç­‰ã€‚</p></li><li><p><strong>æ¢å¤ä¸Šä¸‹æ–‡å¹¶è¿”å›</strong>ï¼šä¸€æ—¦ ISRæ‰§è¡Œå®Œæˆï¼Œå¤„ç†å™¨ä¼šä»æ ˆä¸Šæ¢å¤ä¹‹å‰ä¿å­˜çš„ç¨‹åºçŠ¶æ€ï¼Œå¹¶å°†æ§åˆ¶æƒè¿”å›åˆ°è¢«ä¸­æ–­çš„ç¨‹åºï¼Œç»§ç»­æ‰§è¡Œã€‚</p></li></ol><h2 id="ç¡¬ä»¶æ”¯æŒ">ç¡¬ä»¶æ”¯æŒ</h2><p>è¿™ä¸€è¿‡ç¨‹å¤§é‡ä¾èµ–äºå¤„ç†å™¨çš„ç¡¬ä»¶æ”¯æŒï¼Œå¦‚ä¸­æ–­å‘é‡è¡¨é€šå¸¸æ˜¯å›ºå®šåœ¨å¤„ç†å™¨çš„ç‰¹å®šå†…å­˜åœ°å€ä¸Šçš„ã€‚æ­¤å¤–ï¼Œç°ä»£å¤„ç†å™¨å¦‚x86æ¶æ„è¿˜æä¾›äº†æ›´é«˜çº§çš„åŠŸèƒ½ï¼Œæ¯”å¦‚æ”¯æŒå¤šé‡ä¸­æ–­æ§åˆ¶å™¨å’Œé«˜çº§å¯ç¼–ç¨‹ä¸­æ–­æ§åˆ¶å™¨ï¼ˆAPICï¼‰ç­‰ã€‚</p><p>è¿™ç§åŸºäºç¡¬ä»¶çš„ä¸­æ–­å“åº”æœºåˆ¶å…è®¸ CPUå¿«é€Ÿæœ‰æ•ˆåœ°å¤„ç†å„ç§å¤–éƒ¨äº‹ä»¶ï¼Œç¡®ä¿ç³»ç»Ÿçš„å“åº”æ€§å’Œç¨³å®šæ€§ã€‚</p><h1 id="å‚è€ƒ">å‚è€ƒ</h1><ul><li><ahref="https://blog.csdn.net/zhangyanfei01/article/details/114959103">å›¾è§£| æ·±å…¥æ­ç§˜ epoll æ˜¯å¦‚ä½•å®ç° IO å¤šè·¯å¤ç”¨çš„ï¼</a></li><li><ahref="https://blog.csdn.net/zhpCSDN921011/article/details/125580548">ä¸€å›¾æ€»ç»“epoll çš„æ€»ä½“å·¥ä½œæµç¨‹</a></li><li><ahref="https://thetechsolo.wordpress.com/2016/02/29/scalable-io-events-vs-multithreading-based/">scalable-io-events-vs-multithreading-based</a></li><li><ahref="https://github.com/liexusong/linux-source-code-analyze/blob/master/epoll-principle.md">Epollå®ç°åŸç†</a></li><li><a href="https://zhuanlan.zhihu.com/p/667412830">ç½‘ç»œç¼–ç¨‹ä¹‹ epollæºç æ·±åº¦å‰–æ</a></li></ul>]]></content>
    
    
    <summary type="html">æœ¬æ–‡æ€»ç»“äº†é«˜æ€§èƒ½ç½‘ç»œæœåŠ¡å™¨ä¸­å¤§é‡ä½¿ç”¨çš„ I/O å¤šè·¯å¤ç”¨æŠ€æœ¯ epollï¼Œæ¶µç›–å·¥ä½œåŸç†ã€æ•°æ®ç»“æ„ã€äº‹ä»¶ç›‘å¬å’Œä¸­æ–­ç­‰ç›¸å…³å†…å®¹ã€‚</summary>
    
    
    
    <category term="è®¡ç®—æœºåŸºç¡€" scheme="https://hedon.top/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/"/>
    
    
    <category term="epoll" scheme="https://hedon.top/tags/epoll/"/>
    
    <category term="ç½‘ç»œç¼–ç¨‹" scheme="https://hedon.top/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"/>
    
    <category term="éé˜»å¡ I/0" scheme="https://hedon.top/tags/%E9%9D%9E%E9%98%BB%E5%A1%9E-I-0/"/>
    
  </entry>
  
  <entry>
    <title>Rust å®æˆ˜ä¸¨å¹¶å‘æ„å»ºå€’æ’ç´¢å¼•</title>
    <link href="https://hedon.top/2024/04/23/rust-action-inverted-index-concurrency/"/>
    <id>https://hedon.top/2024/04/23/rust-action-inverted-index-concurrency/</id>
    <published>2024-04-23T15:13:27.000Z</published>
    <updated>2024-04-23T15:49:04.234Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€">å¼•è¨€</h1><p>ç»§ä¸Šç¯‡ <ahref="https://hedon.top/2024/04/15/rust-action-inverted-index-demo/">Rustå®æˆ˜ä¸¨å€’æ’ç´¢å¼•</a>ï¼Œæœ¬ç¯‡æˆ‘ä»¬å°†å‚è€ƒã€ŠRustç¨‹åºè®¾è®¡ï¼ˆç¬¬äºŒç‰ˆï¼‰ã€‹ä¸­å¹¶å‘ç¼–ç¨‹ç¯‡ç« æ¥å®ç°é«˜å¹¶å‘æ„å»ºå€’æ’ç´¢å¼•ã€‚</p><p>æœ¬ç¯‡ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p><ol type="1"><li>åŠŸèƒ½å±•ç¤ºï¼šå±•ç¤ºæˆ‘ä»¬æœ€ç»ˆå®ç°çš„ 2ä¸ªå·¥å…·çš„æ•ˆæœï¼ˆæ„å»ºç´¢å¼•ã€æœç´¢åŠŸèƒ½ï¼‰</li><li>é˜…è¯»æºç ï¼šé˜…è¯»ä¹¦ä¸­æºç çš„å®ç°ï¼Œç†æ¸…å¤§ä½“æ€è·¯ã€‚</li><li>æ„å»ºç´¢å¼•ï¼šå®æˆ˜æ„å»ºç´¢å¼•çš„æ¯ä¸ªå…·ä½“ç¯èŠ‚ï¼Œå¹¶å¯¹æ ¸å¿ƒé€»è¾‘è¿›è¡Œè§£é‡Šå’Œé˜è¿°ç¼˜ç”±ã€‚</li><li>æœç´¢åŠŸèƒ½ï¼šè¿™æ˜¯ä¹¦ä¸­æœªæ›¾æä¾›çš„åŠŸèƒ½ï¼Œç¬”è€…æ ¹æ®è‡ªèº«ç†è§£ï¼Œå¯¹é½ä¸Šç¯‡æä¾›çš„åŠŸèƒ½ï¼Œå®ç°äº†ä¸€ä¸ªæœç´¢åŠŸèƒ½ã€‚</li></ol><p>èƒ½å­¦åˆ°ï¼š</p><ul><li>Rust å„ç§è¿­ä»£å™¨çš„ä½¿ç”¨</li><li>Rust æ–‡ä»¶å¸¸ç”¨æ“ä½œ</li><li>Rust å­—ç¬¦ä¸²å¸¸ç”¨æ“ä½œ</li><li>Rust channel å®æˆ˜</li><li>Rust å¹¶å‘ç¼–ç¨‹</li><li>å¤šè·¯åˆå¹¶æ–‡ä»¶å®é™…åº”ç”¨</li><li>ä½¿ç”¨ <code>byteorder</code> è¿›è¡Œä½æ“ä½œ</li><li>ä½¿ç”¨ <code>clap</code> è¿›è¡Œ CLI å¼€å‘</li><li>ç»ˆç«¯é«˜äº®è¾“å‡º</li><li>æ·±å…¥ç†è§£å€’æ’ç´¢å¼•é«˜æ€§èƒ½çš„æ ¸å¿ƒç»†èŠ‚</li></ul><h1 id="é˜…è¯»å»ºè®®">é˜…è¯»å»ºè®®</h1><p>æœ¬ç¯‡å†…å®¹è¾ƒä¸ºå†—é•¿ï¼Œæ¶‰åŠåˆ°çš„ç»†èŠ‚è®²è§£å¯èƒ½æ¯”è¾ƒå•°å—¦ï¼Œæ¨è<strong>ç›´æ¥é˜…è¯»æºç ï¼Œç„¶åå¯¹ä¸ç†è§£çš„åœ°æ–¹å†æ¥æœ¬ç¯‡å¯¹åº”çš„ç« èŠ‚è¿›è¡Œé˜…è¯»</strong>ã€‚</p><p>å®Œæˆæºç ä½äºï¼šhttps://github.com/hedon-rust-road/inverted-index-concurrency</p><h1 id="ç‰ˆæœ¬å£°æ˜">ç‰ˆæœ¬å£°æ˜</h1><ul><li>Rust: 1.76</li><li>byteordrr: 1.5.0</li><li>clap: 4.5.0</li><li>è¿è¡Œç¯å¢ƒï¼šmacbookPro Apple M2 Max</li></ul><h1 id="åŠŸèƒ½å±•ç¤º">åŠŸèƒ½å±•ç¤º</h1><h2 id="create.rs">create.rs</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">Usage: create [OPTIONS] &lt;FILENAMES&gt;...<br><br>Arguments:<br>  &lt;FILENAMES&gt;...<br><br>Options:<br>  -s, --single-threaded  Default <span class="hljs-literal">false</span><br>  -h, --<span class="hljs-built_in">help</span>             Print <span class="hljs-built_in">help</span><br></code></pre></td></tr></table></figure><p>æŒ‡å®šæ–‡ä»¶ç›®å½•ï¼Œæ„å»ºç´¢å¼•ï¼Œå¯ä»¥ä½¿ç”¨ <code>-s</code>ä½¿ç”¨å•çº¿ç¨‹æ„å»ºï¼Œé»˜è®¤ä½¿ç”¨å¹¶å‘æ„å»ºã€‚</p><p>æ‰§è¡Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  inverted-index-concurrency git:(master) âœ— cargo run --bin create ./texts<br>    Finished dev [unoptimized + debuginfo] target(s) <span class="hljs-keyword">in</span> 0.08s<br>     Running `/Users/wangjiahan/rust-target/debug/create ./texts`<br>indexed document 0:<span class="hljs-string">&quot;./texts/text1.txt&quot;</span>, 22 bytes, 5 words<br>indexed document 1:<span class="hljs-string">&quot;./texts/text3.txt&quot;</span>, 27 bytes, 5 words<br>indexed document 2:<span class="hljs-string">&quot;./texts/text2.txt&quot;</span>, 39 bytes, 6 words<br>word count: 16<br>351 bytes main, 736 bytes total<br>wrote file <span class="hljs-string">&quot;./tmp00000001.dat&quot;</span><br></code></pre></td></tr></table></figure><h2 id="search.rs">search.rs</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">Usage: search --index-file &lt;INDEX_FILE&gt; --term &lt;TERM&gt;<br><br>Options:<br>  -i, --index-file &lt;INDEX_FILE&gt;  Specify index file path<br>  -t, --term &lt;TERM&gt;              Specify search term<br>  -h, --<span class="hljs-built_in">help</span>                     Print <span class="hljs-built_in">help</span><br></code></pre></td></tr></table></figure><p>æŒ‡å®šç´¢å¼•æ–‡ä»¶å’Œæœç´¢è¯æ¥è¿›è¡Œæœç´¢ã€‚</p><p>æ‰§è¡Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240423201406903.png"alt="search.rs æ‰§è¡Œç¤ºä¾‹" /><figcaption aria-hidden="true">search.rs æ‰§è¡Œç¤ºä¾‹</figcaption></figure><h1 id="é˜…è¯»æºç ">é˜…è¯»æºç </h1><blockquote><p>ä¹¦ä¸­çš„æºç ä½äºï¼š<ahref="https://github.com/ProgrammingRust/fingertips/tree/master">fingertips</a></p></blockquote><p>ç¬¬ä¸€éƒ¨åˆ†æˆ‘ä»¬å…ˆæ¥é˜…è¯»æºç ï¼Œä¹¦ä¸­å±•ç¤ºäº†è¿™æ ·ä¸€å¼ å›¾ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image00882.jpeg"alt="ç´¢å¼•æ„å»ºå™¨ç®¡é“ï¼Œå…¶ä¸­ç®­å¤´è¡¨ç¤ºé€šè¿‡é€šé“å°†å€¼ä»ä¸€ä¸ªçº¿ç¨‹å‘é€åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼ˆæœªå±•ç¤ºç£ç›˜ I/Oï¼‰" /><figcaptionaria-hidden="true">ç´¢å¼•æ„å»ºå™¨ç®¡é“ï¼Œå…¶ä¸­ç®­å¤´è¡¨ç¤ºé€šè¿‡é€šé“å°†å€¼ä»ä¸€ä¸ªçº¿ç¨‹å‘é€åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼ˆæœªå±•ç¤ºç£ç›˜I/Oï¼‰</figcaption></figure><p>ä»è¿™å¼ å›¾æˆ‘ä»¬å¤§æ¦‚å¯ä»¥çŒœæƒ³æœ¬æ¡ˆä¾‹ä¸­æ„å»ºå¹¶å‘ç´¢å¼•çš„è¿‡ç¨‹å¯èƒ½æ˜¯ï¼š</p><ol type="1"><li>è¯»å–æ–‡ä»¶å†…å®¹ï¼›</li><li>æ ¹æ®æ–‡ä»¶å†…å®¹æ„å»ºç´¢å¼•ï¼›</li><li>å¤šä¸ªç´¢å¼•è¿›è¡Œåˆå¹¶ï¼›</li><li>å°†ç´¢å¼•å†™å…¥æ–‡ä»¶ï¼›</li><li>å¤šä¸ªç´¢å¼•æ–‡ä»¶è¿›è¡Œåˆå¹¶ã€‚</li></ol><p>æŒ‰ç…§è¿™ä¸ªæ€è·¯çš„æŒ‡å¼•ï¼Œæˆ‘ä»¬æ‰“å¼€æºç ï¼Œä» <code>main.rs</code> çš„<code>main()</code> å‡ºå‘ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">single_threaded</span> = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">filenames</span> = <span class="hljs-built_in">vec!</span>[];<br><br>  <span class="hljs-comment">// å‘½ä»¤è¡Œå‚æ•°è§£æ</span><br>    &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">ap</span> = ArgumentParser::<span class="hljs-title function_ invoke__">new</span>();<br>        ap.<span class="hljs-title function_ invoke__">set_description</span>(<span class="hljs-string">&quot;Make an inverted index for searching documents.&quot;</span>);<br>        ap.<span class="hljs-title function_ invoke__">refer</span>(&amp;<span class="hljs-keyword">mut</span> single_threaded).<span class="hljs-title function_ invoke__">add_option</span>(<br>            &amp;[<span class="hljs-string">&quot;-1&quot;</span>, <span class="hljs-string">&quot;--single-threaded&quot;</span>],<br>            StoreTrue,<br>            <span class="hljs-string">&quot;Do all the work on a single thread.&quot;</span>,<br>        );<br>        ap.<span class="hljs-title function_ invoke__">refer</span>(&amp;<span class="hljs-keyword">mut</span> filenames).<span class="hljs-title function_ invoke__">add_argument</span>(<br>            <span class="hljs-string">&quot;filenames&quot;</span>,<br>            Collect,<br>            <span class="hljs-string">&quot;Names of files/directories to index. \</span><br><span class="hljs-string">                           For directories, all .txt files immediately \</span><br><span class="hljs-string">                           under the directory are indexed.&quot;</span>,<br>        );<br>        ap.<span class="hljs-title function_ invoke__">parse_args_or_exit</span>();<br>    &#125;<br><br>  <span class="hljs-comment">// æ„å»ºç´¢å¼•</span><br>    <span class="hljs-keyword">match</span> <span class="hljs-title function_ invoke__">run</span>(filenames, single_threaded) &#123;<br>        <span class="hljs-title function_ invoke__">Ok</span>(()) =&gt; &#123;&#125;<br>        <span class="hljs-title function_ invoke__">Err</span>(err) =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;error: &#123;&#125;&quot;</span>, err),<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol type="1"><li>è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Œè¿™é‡Œä½¿ç”¨ <code>argparse</code> è¿™ä¸ªæ¯”è¾ƒå¤è€çš„ crateæ¥è§£æï¼Œç°åœ¨ä¸€èˆ¬æ˜¯ä½¿ç”¨ <code>clap</code>ã€‚<ul><li><code>single_threaded:</code> æ˜¯å¦ä½¿ç”¨å•çº¿ç¨‹ï¼Œé»˜è®¤æ˜¯å¤šçº¿ç¨‹ã€‚</li><li><code>filenames</code>: æŒ‡å®šçš„æ–‡æœ¬æ–‡ä»¶æˆ–ç›®å½•ã€‚</li></ul></li><li><code>run</code> å‡½æ•°æ‰§è¡Œæ„å»ºç´¢å¼•ã€‚</li></ol><p>çœ‹ä¸€ä¸‹ <code>run</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">/// Generate an index for a bunch of text files.</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">run</span>(filenames: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">String</span>&gt;, single_threaded: <span class="hljs-type">bool</span>) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">output_dir</span> = PathBuf::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;.&quot;</span>);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">documents</span> = <span class="hljs-title function_ invoke__">expand_filename_arguments</span>(filenames)?;<br><br>    <span class="hljs-keyword">if</span> single_threaded &#123;<br>        <span class="hljs-title function_ invoke__">run_single_threaded</span>(documents, output_dir)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-title function_ invoke__">run_pipeline</span>(documents, output_dir)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>å•çº¿ç¨‹ï¼šrun_single_threaded</li><li>å¤šçº¿ç¨‹ï¼šrun_pipeline</li></ul><p>å…ˆä»ç®€å•çœ‹ï¼Œå•çº¿ç¨‹ï¼Œå¿½ç•¥æ‰æºç ä¸­å®šä¹‰çš„ç‰¹æ®Šæ•°æ®ç»“æ„ï¼Œå¯ä»¥å‘ç°è·Ÿæˆ‘ä»¬ä¸Šç¯‡ä»‹ç»çš„ç®€å•ç‰ˆå€’æ’ç´¢å¼•æ€è·¯åŸºæœ¬æ˜¯ä¸€è‡´çš„ï¼Œåªä¸è¿‡æœ¬æ¡ˆä¾‹ä¸­æ•°æ®æ˜¯ä»æ–‡ä»¶ä¸­è¯»ï¼Œæœ€ååˆä¼šå°†ç´¢å¼•å†™å…¥åˆ°æ–‡ä»¶ä¸­ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">run_single_threaded</span>(documents: <span class="hljs-type">Vec</span>&lt;PathBuf&gt;, output_dir: PathBuf) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">accumulated_index</span> = InMemoryIndex::<span class="hljs-title function_ invoke__">new</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">merge</span> = FileMerge::<span class="hljs-title function_ invoke__">new</span>(&amp;output_dir);<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">tmp_dir</span> = TmpDir::<span class="hljs-title function_ invoke__">new</span>(&amp;output_dir);<br><br>    <span class="hljs-comment">// è¿­ä»£æ¯ä¸ªæ–‡æœ¬æ–‡ä»¶</span><br>    <span class="hljs-keyword">for</span> (doc_id, filename) <span class="hljs-keyword">in</span> documents.<span class="hljs-title function_ invoke__">into_iter</span>().<span class="hljs-title function_ invoke__">enumerate</span>() &#123;<br>      <span class="hljs-comment">// æ‰“å¼€æ–‡ä»¶ï¼Œå¹¶å°†å†…å®¹è¯»å–åˆ° `text` ä¸Š</span><br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">f</span> = File::<span class="hljs-title function_ invoke__">open</span>(filename)?;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">text</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">new</span>();<br>        f.<span class="hljs-title function_ invoke__">read_to_string</span>(&amp;<span class="hljs-keyword">mut</span> text)?;<br><br>        <span class="hljs-comment">// æ„å»ºç´¢å¼•</span><br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">index</span> = InMemoryIndex::<span class="hljs-title function_ invoke__">from_single_document</span>(doc_id, text);<br>        accumulated_index.<span class="hljs-title function_ invoke__">merge</span>(index);<br>        <span class="hljs-keyword">if</span> accumulated_index.<span class="hljs-title function_ invoke__">is_large</span>() &#123;<br>            <span class="hljs-comment">// å½“ç´¢å¼•è¶³å¤Ÿå¤§çš„æ—¶å€™ï¼Œå°†å…¶å†™åˆ°æ–‡ä»¶ä¸­</span><br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">file</span> = <span class="hljs-title function_ invoke__">write_index_to_tmp_file</span>(accumulated_index, &amp;<span class="hljs-keyword">mut</span> tmp_dir)?;<br>            merge.<span class="hljs-title function_ invoke__">add_file</span>(file)?;<br>            accumulated_index = InMemoryIndex::<span class="hljs-title function_ invoke__">new</span>();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// å°†æœ€åä¸€ä¸ªç´¢å¼•å†™å…¥åˆ°æ–‡ä»¶ä¸­</span><br>    <span class="hljs-keyword">if</span> !accumulated_index.<span class="hljs-title function_ invoke__">is_empty</span>() &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">file</span> = <span class="hljs-title function_ invoke__">write_index_to_tmp_file</span>(accumulated_index, &amp;<span class="hljs-keyword">mut</span> tmp_dir)?;<br>        merge.<span class="hljs-title function_ invoke__">add_file</span>(file)?;<br>    &#125;<br>    merge.<span class="hljs-title function_ invoke__">finish</span>()<br>&#125;<br></code></pre></td></tr></table></figure><p>å†æ¥çœ‹æœ¬æ–‡çš„é‡å¤´æˆï¼Œå¤šçº¿ç¨‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">run_pipeline</span>(documents: <span class="hljs-type">Vec</span>&lt;PathBuf&gt;, output_dir: PathBuf) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-comment">// å°†æ„å»ºç´¢å¼•åˆ†ä¸º 5 ä¸ªè¿‡ç¨‹</span><br>    <span class="hljs-keyword">let</span> (texts, h1) = <span class="hljs-title function_ invoke__">start_file_reader_thread</span>(documents);<br>    <span class="hljs-keyword">let</span> (pints, h2) = <span class="hljs-title function_ invoke__">start_file_indexing_thread</span>(texts);<br>    <span class="hljs-keyword">let</span> (gallons, h3) = <span class="hljs-title function_ invoke__">start_in_memory_merge_thread</span>(pints);<br>    <span class="hljs-keyword">let</span> (files, h4) = <span class="hljs-title function_ invoke__">start_index_writer_thread</span>(gallons, &amp;output_dir);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">result</span> = <span class="hljs-title function_ invoke__">merge_index_files</span>(files, &amp;output_dir);<br><br>    <span class="hljs-comment">// ç­‰å¾…æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œå®Œæ¯•</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">r1</span> = h1.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br>    h2.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br>    h3.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">r4</span> = h4.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br><br>    r1?;<br>    r4?;<br>    result<br>&#125;<br></code></pre></td></tr></table></figure><p>é¦–å…ˆå°†ç´¢å¼•æ„å»ºåˆ†æˆ 5 ä¸ªé˜¶æ®µï¼š</p><p><strong>1. start_file_reader_thread</strong></p><p>å°±æ˜¯ä»æ–‡ä»¶ä¸­è¯»å–æ–‡æœ¬ä¿¡æ¯ï¼Œå¹¶å°†å…¶æ‰”è¿›<code>Receiver&lt;String&gt;</code> channel ä¸­ï¼Œä¼ åˆ°ä¸‹ä¸€ä¸ªé˜¶æ®µã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">start_file_reader_thread</span>(<br>    documents: <span class="hljs-type">Vec</span>&lt;PathBuf&gt;,<br>) <span class="hljs-punctuation">-&gt;</span> (Receiver&lt;<span class="hljs-type">String</span>&gt;, JoinHandle&lt;io::<span class="hljs-type">Result</span>&lt;()&gt;&gt;) &#123;<br>    <span class="hljs-keyword">let</span> (sender, receiver) = <span class="hljs-title function_ invoke__">channel</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">handle</span> = <span class="hljs-title function_ invoke__">spawn</span>(<span class="hljs-keyword">move</span> || &#123;<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">filename</span> <span class="hljs-keyword">in</span> documents &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">f</span> = File::<span class="hljs-title function_ invoke__">open</span>(filename)?;<br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">text</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">new</span>();<br>          <span class="hljs-comment">// è¯»å–æ–‡ä»¶å†…å®¹</span><br>            f.<span class="hljs-title function_ invoke__">read_to_string</span>(&amp;<span class="hljs-keyword">mut</span> text)?;<br>            <span class="hljs-keyword">if</span> sender.<span class="hljs-title function_ invoke__">send</span>(text).<span class="hljs-title function_ invoke__">is_err</span>() &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-title function_ invoke__">Ok</span>(())<br>    &#125;);<br>    (receiver, handle)<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>2. start_file_indexing_thread</strong></p><p>ä»ç¬¬ 1 æ­¥ä¼ è¿‡æ¥çš„æ–‡æœ¬ä¿¡æ¯ä¸­è°ƒç”¨<code>InMemoryIndex::from_single_document</code> æ„å»ºç´¢å¼•ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">start_file_indexing_thread</span>(<br>    texts: Receiver&lt;<span class="hljs-type">String</span>&gt;,<br>) <span class="hljs-punctuation">-&gt;</span> (Receiver&lt;InMemoryIndex&gt;, JoinHandle&lt;()&gt;) &#123;<br>    <span class="hljs-keyword">let</span> (sender, receiver) = <span class="hljs-title function_ invoke__">channel</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">handle</span> = <span class="hljs-title function_ invoke__">spawn</span>(<span class="hljs-keyword">move</span> || &#123;<br>        <span class="hljs-keyword">for</span> (doc_id, text) <span class="hljs-keyword">in</span> texts.<span class="hljs-title function_ invoke__">into_iter</span>().<span class="hljs-title function_ invoke__">enumerate</span>() &#123;<br>          <span class="hljs-comment">// æ„å»ºç´¢å¼•</span><br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">index</span> = InMemoryIndex::<span class="hljs-title function_ invoke__">from_single_document</span>(doc_id, text);<br>            <span class="hljs-keyword">if</span> sender.<span class="hljs-title function_ invoke__">send</span>(index).<span class="hljs-title function_ invoke__">is_err</span>() &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;);<br>    (receiver, handle)<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>3. start_in_memory_merge_thread</strong></p><p>å°†ç¬¬ 2 æ­¥æ„å»ºçš„å•ä¸€ç´¢å¼•è¿›è¡Œåˆå¹¶ï¼Œå¹¶å°†åˆå¹¶åçš„ç´¢å¼•ä¼ åˆ°ä¸‹ä¸€ä¸ªé˜¶æ®µã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">start_in_memory_merge_thread</span>(<br>    file_indexes: Receiver&lt;InMemoryIndex&gt;,<br>) <span class="hljs-punctuation">-&gt;</span> (Receiver&lt;InMemoryIndex&gt;, JoinHandle&lt;()&gt;) &#123;<br>    <span class="hljs-keyword">let</span> (sender, receiver) = <span class="hljs-title function_ invoke__">channel</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">handle</span> = <span class="hljs-title function_ invoke__">spawn</span>(<span class="hljs-keyword">move</span> || &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">accumulated_index</span> = InMemoryIndex::<span class="hljs-title function_ invoke__">new</span>();<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">fi</span> <span class="hljs-keyword">in</span> file_indexes &#123;<br>          <span class="hljs-comment">// å°†ç´¢å¼•è¿›è¡Œåˆå¹¶</span><br>            accumulated_index.<span class="hljs-title function_ invoke__">merge</span>(fi);<br>            <span class="hljs-keyword">if</span> accumulated_index.<span class="hljs-title function_ invoke__">is_large</span>() &#123;<br>              <span class="hljs-comment">// å¦‚æœç´¢å¼•å¤§å°åˆ°è¾¾é˜ˆå€¼ï¼Œåˆ™ä¼ åˆ°ä¸‹ä¸€é˜¶æ®µ</span><br>                <span class="hljs-keyword">if</span> sender.<span class="hljs-title function_ invoke__">send</span>(accumulated_index).<span class="hljs-title function_ invoke__">is_err</span>() &#123;<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>                accumulated_index = InMemoryIndex::<span class="hljs-title function_ invoke__">new</span>();<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> !accumulated_index.<span class="hljs-title function_ invoke__">is_empty</span>() &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">_</span> = sender.<span class="hljs-title function_ invoke__">send</span>(accumulated_index);<br>        &#125;<br>    &#125;);<br>    (receiver, handle)<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>4. start_index_writer_thread</strong></p><p>å°†ç¬¬ 3 æ­¥ä¼ æ¥çš„å†…å­˜ç´¢å¼•å†™å…¥åˆ°ä¸´æ—¶æ–‡ä»¶ä¸­ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">start_index_writer_thread</span>(<br>    big_indexes: Receiver&lt;InMemoryIndex&gt;,<br>    output_dir: &amp;Path,<br>) <span class="hljs-punctuation">-&gt;</span> (Receiver&lt;PathBuf&gt;, JoinHandle&lt;io::<span class="hljs-type">Result</span>&lt;()&gt;&gt;) &#123;<br>    <span class="hljs-keyword">let</span> (sender, receiver) = <span class="hljs-title function_ invoke__">channel</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">tmp_dir</span> = TmpDir::<span class="hljs-title function_ invoke__">new</span>(output_dir);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">handle</span> = <span class="hljs-title function_ invoke__">spawn</span>(<span class="hljs-keyword">move</span> || &#123;<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">index</span> <span class="hljs-keyword">in</span> big_indexes &#123;<br>          <span class="hljs-comment">// å°†ç´¢å¼•å†™å…¥ä¸´æ—¶æ–‡ä»¶ä¸­</span><br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">file</span> = <span class="hljs-title function_ invoke__">write_index_to_tmp_file</span>(index, &amp;<span class="hljs-keyword">mut</span> tmp_dir)?;<br>            <span class="hljs-keyword">if</span> sender.<span class="hljs-title function_ invoke__">send</span>(file).<span class="hljs-title function_ invoke__">is_err</span>() &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-title function_ invoke__">Ok</span>(())<br>    &#125;);<br>    (receiver, handle)<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>5. merge_index_files</strong></p><p>å°†ä¸´æ—¶æ–‡ä»¶è¿›è¡Œåˆå¹¶ï¼Œç”Ÿæˆæœ€ç»ˆçš„ç´¢å¼•æ–‡ä»¶ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">merge_index_files</span>(files: Receiver&lt;PathBuf&gt;, output_dir: &amp;Path) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">merge</span> = FileMerge::<span class="hljs-title function_ invoke__">new</span>(output_dir);<br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">file</span> <span class="hljs-keyword">in</span> files &#123;<br>        merge.<span class="hljs-title function_ invoke__">add_file</span>(file)?;<br>    &#125;<br>    merge.<span class="hljs-title function_ invoke__">finish</span>()<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ 5 ä¸ªæ­¥éª¤è·Ÿä¹¦ä¸­ç»™å‡ºçš„ç¤ºæ„å›¾åŸºæœ¬ä¸€è‡´ï¼Œæˆ‘ä»¬å†æ¥çœ‹<code>run_pipeline</code> æ˜¯å¦‚ä½•åˆå¹¶å¹¶è¡Œçš„ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// ä½¿ç”¨ join() ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ</span><br><span class="hljs-keyword">let</span> <span class="hljs-variable">r1</span> = h1.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br>h2.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br>h3.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br><span class="hljs-keyword">let</span> <span class="hljs-variable">r4</span> = h4.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br><br><span class="hljs-comment">// é˜¶æ®µ 2 å’Œé˜¶æ®µ 3 éƒ½æ˜¯çº¯å†…å­˜æ“ä½œï¼Œä¸ä¼šæœ‰é”™è¯¯</span><br><span class="hljs-comment">// é˜¶æ®µ 1 æ˜¯è¯»æ–‡ä»¶ï¼Œé˜¶æ®µ 4 æ˜¯å†™æ–‡ä»¶ï¼Œæ‰€ä»¥æœ‰å¯èƒ½ä¼šæŠ¥é”™</span><br>r1?;<br>r4?;<br></code></pre></td></tr></table></figure><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240416001044618.png"alt="run_pipeline ç¤ºæ„å›¾" /><figcaption aria-hidden="true">run_pipeline ç¤ºæ„å›¾</figcaption></figure><p>æºç é˜…è¯»éƒ¨åˆ†å·®ä¸å¤šå°±åˆ°è¿™äº†ï¼Œå¤§çš„æ€æƒ³æ¶æ„ä½ åº”è¯¥éƒ½èƒ½ Getåˆ°äº†ï¼Œå…¶ä¸­æ¯ä¸ªæ•°æ®ç»“æ„çš„å…·ä½“å®ç°ç»†èŠ‚ï¼Œæˆ‘ä»¬åœ¨åé¢çš„å®æˆ˜ä¸­è¿›è¡Œæ‹†è§£ã€‚</p><h1 id="æ„å»ºç´¢å¼•">æ„å»ºç´¢å¼•</h1><h2 id="ä»£ç ç»“æ„">ä»£ç ç»“æ„</h2><p>ä¹¦ä¸­æºç ä»£ç ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs stylus">âœ  fingertips git:(master) âœ— tree<br>.<br>â”œâ”€â”€ Cargo<span class="hljs-selector-class">.lock</span><br>â”œâ”€â”€ Cargo<span class="hljs-selector-class">.toml</span><br>â”œâ”€â”€ LICENSE-MIT<br>â”œâ”€â”€ README<span class="hljs-selector-class">.md</span><br>â”œâ”€â”€ <span class="hljs-attribute">src</span><br>â”‚   â”œâ”€â”€ index<span class="hljs-selector-class">.rs</span><br>â”‚   â”œâ”€â”€ <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.rs</span><br>â”‚   â”œâ”€â”€ merge<span class="hljs-selector-class">.rs</span><br>â”‚   â”œâ”€â”€ read<span class="hljs-selector-class">.rs</span><br>â”‚   â”œâ”€â”€ tmp<span class="hljs-selector-class">.rs</span><br>â”‚   â””â”€â”€ write.rs<br></code></pre></td></tr></table></figure><p>ä¹¦ä¸­ç»™å‡ºçš„æºç å¹¶æ²¡æœ‰å®ç°ä½¿ç”¨æ„å»ºå¥½çš„ç´¢å¼•æ–‡ä»¶è¿›è¡Œæœç´¢çš„åŠŸèƒ½ï¼Œç¬”è€…å°†åœ¨æ­¤åŸºç¡€ä¸Šå®ç°è¯¥åŠŸèƒ½ï¼Œæ‰€ä»¥å¯¹ä»£ç ç»“æ„è¿›è¡Œäº†ç®€å•çš„è°ƒæ•´ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs stylus">âœ  inverted_index git:(master) âœ— tree<br>.<br>â”œâ”€â”€ Cargo<span class="hljs-selector-class">.lock</span><br>â”œâ”€â”€ Cargo<span class="hljs-selector-class">.toml</span><br>â”œâ”€â”€ index<span class="hljs-selector-class">.bat</span><br>â”œâ”€â”€ <span class="hljs-attribute">src</span><br>â”‚   â”œâ”€â”€ bin<br>â”‚   â”‚   â”œâ”€â”€ create<span class="hljs-selector-class">.rs</span><br>â”‚   â”‚   â””â”€â”€ search<span class="hljs-selector-class">.rs</span><br>â”‚   â”œâ”€â”€ index<span class="hljs-selector-class">.rs</span><br>â”‚   â”œâ”€â”€ lib<span class="hljs-selector-class">.rs</span><br>â”‚   â”œâ”€â”€ merge<span class="hljs-selector-class">.rs</span><br>â”‚   â”œâ”€â”€ read<span class="hljs-selector-class">.rs</span><br>â”‚   â”œâ”€â”€ tmp<span class="hljs-selector-class">.rs</span><br>â”‚   â””â”€â”€ write<span class="hljs-selector-class">.rs</span><br>â””â”€â”€ texts<br>    â”œâ”€â”€ text1<span class="hljs-selector-class">.txt</span><br>    â”œâ”€â”€ text2<span class="hljs-selector-class">.txt</span><br>    â””â”€â”€ text3.txt<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æˆ‘å°†æ ¸å¿ƒä»£ç ä» <code>bin</code> æ”¹æˆäº† <code>lib</code>ï¼Œè¿™æ˜¯ä¸ºäº†æ”¯æŒæˆ‘åé¢è¦å®ç°çš„ä¸¤ä¸ª <code>bin</code>:</p><ul><li><code>create</code>: æ„å»ºç´¢å¼•ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯æºä»£ç ä¸­çš„<code>main.rs</code></li><li><code>search</code>: åŸºäºç”Ÿæˆçš„ç´¢å¼•æ–‡ä»¶å®ç°æœç´¢åŠŸèƒ½</li></ul><p><code>texts</code> æ˜¯æˆ‘æä¾›çš„æ–‡æœ¬æ–‡ä»¶æ ·ä¾‹ã€‚</p><p><code>src</code> ç›®å½•ä¸­çš„ä»£ç é˜…è¯»é¡ºåºåŠåŠŸèƒ½åˆ’åˆ†å¦‚ä¸‹ï¼š</p><ul><li><code>index</code>: å®šä¹‰äº†å†…å­˜ç´¢å¼•æ•°æ®ç»“æ„InMemoryIndexï¼Œå®ç°äº†ä»æ–‡ä»¶å†…å®¹ä¸­æ„å»ºå†…å­˜ç´¢å¼•çš„åŸºæœ¬é€»è¾‘ï¼Œä¹Ÿå®ç°äº†ä»ç´¢å¼•æ–‡ä»¶é‡å»ºå†…å­˜ç´¢å¼•çš„åŠŸèƒ½ã€‚</li><li><code>tmp</code>: å®šä¹‰äº†ä¸´æ—¶ç›®å½•æ•°æ®ç»“æ„TmpDirï¼Œç”¨äºå­˜æ”¾ä¸´æ—¶ç´¢å¼•æ–‡ä»¶ã€‚</li><li><code>write</code>: å®šä¹‰äº†ç´¢å¼•æ–‡ä»¶å†™å…¥å™¨ IndexFileWriterï¼Œå®ç°äº†å°†InMemoryIndex å†™å…¥æ–‡ä»¶ä¸­çš„é€»è¾‘ã€‚</li><li><code>merge</code>: å®šä¹‰äº†æ–‡ä»¶åˆå¹¶å™¨ FileMergeï¼Œç”¨äºåˆå¹¶ TmpDirçš„æ‰€æœ‰ç´¢å¼•æ–‡ä»¶ã€‚</li><li><code>read</code>: å®šä¹‰äº†ç´¢å¼•æ–‡ä»¶è¯»å–å™¨IndexFileWriteï¼Œå®ç°äº†è§£æç´¢å¼•æ–‡ä»¶çš„é€»è¾‘ã€‚</li></ul><h2 id="é¡¹ç›®å‡†å¤‡">é¡¹ç›®å‡†å¤‡</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo new --lib inverted_index_concurrency<br></code></pre></td></tr></table></figure><p>Cargo.toml</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs toml"><span class="hljs-section">[package]</span><br><span class="hljs-attr">name</span> = <span class="hljs-string">&quot;inverted-index-concurrency&quot;</span><br><span class="hljs-attr">version</span> = <span class="hljs-string">&quot;0.1.0&quot;</span><br><span class="hljs-attr">edition</span> = <span class="hljs-string">&quot;2021&quot;</span><br><span class="hljs-attr">license</span> = <span class="hljs-string">&quot;mit&quot;</span><br><span class="hljs-attr">authors</span> = [<span class="hljs-string">&quot;hedon&quot;</span>]<br><span class="hljs-attr">description</span> = <span class="hljs-string">&quot;a tool to concurrently build an inverted index.&quot;</span><br><br><span class="hljs-section">[[bin]]</span><br><span class="hljs-attr">name</span>=<span class="hljs-string">&quot;create&quot;</span><br><span class="hljs-attr">path</span>=<span class="hljs-string">&quot;src/bin/create.rs&quot;</span><br><br><span class="hljs-section">[[bin]]</span><br><span class="hljs-attr">name</span>=<span class="hljs-string">&quot;search&quot;</span><br><span class="hljs-attr">path</span>=<span class="hljs-string">&quot;src/bin/search.rs&quot;</span><br><br><span class="hljs-section">[dependencies]</span><br><span class="hljs-attr">byteorder</span> = <span class="hljs-string">&quot;1.5.0&quot;</span><br><span class="hljs-attr">clap</span> = &#123; version = <span class="hljs-string">&quot;4.5.4&quot;</span>, features = [<span class="hljs-string">&quot;derive&quot;</span>] &#125;<br></code></pre></td></tr></table></figure><h2 id="lib.rs">lib.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">mod</span> index;<br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">mod</span> merge;<br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">mod</span> read;<br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">mod</span> tmp;<br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">mod</span> write;<br></code></pre></td></tr></table></figure><p>åœ¨ <code>lib.rs</code> ä¸­æˆ‘ä»¬å°†è¿™ 5 ä¸ª mod å…¬å¼€å‡ºå»ï¼Œè¿™æ ·å°±å¯ä»¥ç»™<code>bin</code> ç›®å½•ä¸­çš„ <code>crate.rs</code> å’Œ<code>search.rs</code> ä½¿ç”¨äº†ã€‚</p><h2 id="index.rs">index.rs</h2><blockquote><p>å®Œæ•´æºç ï¼š<ahref="https://github.com/hedon-rust-road/inverted-index-concurrency/blob/master/src/index.rs">index.rs</a></p></blockquote><p>ç¬¬ä¸€éƒ¨åˆ†æ˜¯å†…å­˜ç´¢å¼•çš„æ„å»ºã€‚</p><h3 id="tokenize">tokenize</h3><p>æˆ‘ä»¬å…ˆå®šä¹‰ä¸€ä¸ªåˆ†è¯å‡½æ•°ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">tokenize</span>(text: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Vec</span>&lt;(&amp;<span class="hljs-type">str</span>, <span class="hljs-type">usize</span>, <span class="hljs-type">usize</span>)&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">res</span> = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">new</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">token_start</span> = <span class="hljs-literal">None</span>;<br>    <span class="hljs-keyword">for</span> (idx, ch) <span class="hljs-keyword">in</span> text.<span class="hljs-title function_ invoke__">char_indices</span>() &#123;<br>        <span class="hljs-keyword">match</span> (ch.<span class="hljs-title function_ invoke__">is_alphanumeric</span>(), token_start) &#123;<br>            (<span class="hljs-literal">true</span>, <span class="hljs-literal">None</span>) =&gt; token_start = <span class="hljs-title function_ invoke__">Some</span>(idx),  <span class="hljs-comment">// æ¯ä¸ªå•è¯çš„å¼€å§‹</span><br>            (<span class="hljs-literal">false</span>, <span class="hljs-title function_ invoke__">Some</span>(start)) =&gt; &#123;  <span class="hljs-comment">// æ¯ä¸ªå•è¯çš„ç»“å°¾</span><br>                res.<span class="hljs-title function_ invoke__">push</span>((&amp;text[start..idx], start, idx - <span class="hljs-number">1</span>));<br>                token_start = <span class="hljs-literal">None</span><br>            &#125;<br>            _ =&gt; &#123;&#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(start) = token_start &#123;<br>        res.<span class="hljs-title function_ invoke__">push</span>((&amp;text[start..], start, text.<span class="hljs-title function_ invoke__">len</span>() - <span class="hljs-number">1</span>))<br>    &#125;<br>    res<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªåˆ†è¯å‡½æ•°è·Ÿä¹¦ä¸­æºç æä¾›çš„ä¸ä¸€æ ·ï¼Œä¸ºäº†å®ç°æ–‡æœ¬é«˜äº®ï¼Œæˆ‘ä»¬éœ€è¦è®°å½•æ¯ä¸ªåˆ†è¯åœ¨åŸæ–‡æœ¬ä¸­çš„èµ·å§‹ä½ç½®å’Œç»“æŸä½ç½®ã€‚å®ƒçš„æ ¸å¿ƒé€»è¾‘å¦‚ä¸‹ï¼š</p><ol type="1"><li><p>é€šè¿‡ <code>char_indices()</code> è·å– <code>text</code>çš„å­—ç¬¦è¿­ä»£å™¨ï¼Œè¿™æ˜¯ä¸€ç§æ‡’åŠ è½½çš„æ–¹æ³•ï¼Œé¿å…ä¸€æ¬¡æ€§å°†æ‰€æœ‰ charåŠ è½½åˆ°å†…å­˜ä¸­ã€‚</p></li><li><p>åŒ¹é… <code>(ch.is_alphanumeric(), token_start)</code>ï¼š</p><ul><li>å¦‚æœæ˜¯ <code>(true, None)</code>åˆ™è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå•è¯çš„å¼€å§‹ï¼Œæˆ‘ä»¬çºªå½•å…¶å¼€å§‹çš„ä½ç½®<code>Some(idx)</code>ï¼›</li><li>å¦‚æœæ˜¯ <code>(false, Some(idx))</code>åˆ™è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå•è¯çš„ç»“æŸï¼Œæˆ‘ä»¬å°†å…¶åŠ å…¥åˆ° <code>res</code>ä¸­ï¼Œå¹¶è®°å½•èµ·å§‹ä½ç½®å’Œç»“æŸä½ç½®ã€‚</li><li>å…¶ä»–æƒ…å†µï¼Œä¸åšå¤„ç†ï¼Œè¦ä¹ˆæ˜¯éæ³•å­—ç¬¦ï¼Œè¦ä¹ˆæ˜¯å¤„äºå•è¯ä¸­é—´ã€‚</li></ul><p>ä»è¿™ä¸ªç®€å•çš„ç†è§£ä¸­ï¼Œä½ åº”è¯¥å¯ä»¥æ„Ÿå—åˆ° Rust ä¸­ match patternçš„å¼ºå¤§å’Œä¾¿æ·äº†ï¼Œ666 ğŸ‘ğŸ»</p></li></ol><h3 id="struct-inmemoryindex">struct: InMemoryIndex</h3><p>åœ¨ <code>index.rs</code> ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸‰ä¸ªæ•°æ®ç»“æ„ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">InMemoryIndex</span> &#123;<br>    <span class="hljs-keyword">pub</span> word_count: <span class="hljs-type">usize</span>,<br>    <span class="hljs-keyword">pub</span> terms: HashMap&lt;<span class="hljs-type">String</span>, <span class="hljs-type">Vec</span>&lt;Hit&gt;&gt;,<br>    <span class="hljs-keyword">pub</span> docs: HashMap&lt;<span class="hljs-type">usize</span>, Document&gt;,<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Document</span> &#123;<br>    <span class="hljs-keyword">pub</span> id: <span class="hljs-type">u32</span>,<br>    <span class="hljs-keyword">pub</span> path: PathBuf,<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">Hit</span> = <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">u8</span>&gt;;<br></code></pre></td></tr></table></figure><ul><li><p><code>Document</code>: æ–‡æ¡£å°è£…ã€‚</p><ul><li><code>id</code>: æ–‡æ¡£ idï¼Œå”¯ä¸€æ ‡è¯†ç¬¦ã€‚</li><li><code>path</code>: æºæ–‡ä»¶è·¯å¾„ã€‚</li></ul></li><li><p><code>Hit</code>:å®ƒæ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„ï¼Œæˆ‘ä»¬æŒ‰ç…§å°ç«¯åºè¿›è¡Œå­˜å‚¨ï¼Œå®ƒçš„å­˜å‚¨ç»“æ„å¦‚ä¸‹ï¼š</p><ul><li>[0..3] å­˜å‚¨ä¸€ä¸ª <code>HITS_SEPERATOR = -1</code>ï¼Œè¡¨ç¤ºä¸€ä¸ª<code>Hit</code> çš„å¼€å§‹ã€‚</li><li>[4..7] å­˜å‚¨ä¸€ä¸ª u32 çš„ <code>document_id</code>ã€‚</li><li>åé¢æ¯ 8 ä¸ª u8 ä¼šå­˜åœ¨ä¸€ä¸ª u32 çš„ <code>start_pos</code> å’Œä¸€ä¸ª u32çš„ <code>end_pos</code>ã€‚</li></ul></li><li><p><code>InMemoryIndex</code>: å†…å­˜ç´¢å¼•ã€‚</p><ul><li><code>word_count</code>:åŒ…å«çš„å•è¯ï¼ˆword/termï¼‰ä¸ªæ•°ï¼Œè®°å½•å®ƒæ˜¯ä¸ºäº†åˆ¤æ–­ç´¢å¼•æ˜¯å¦è¿‡å¤§ï¼Œä»¥ä¾¿å¯¹ç´¢å¼•è¿›è¡Œåˆ†ç‰‡å­˜å‚¨ã€‚</li><li><code>terms</code>: å­˜å‚¨ word åˆ° Hits çš„æ˜ å°„ï¼Œæ¯ä¸ª <code>word</code>æ˜¯ä¸€ä¸ªæœç´¢é¡¹ã€‚</li><li><code>docs</code>: å­˜å‚¨äº† document_idåˆ°æ–‡æ¡£çš„æ˜ å°„ï¼Œç”¨äºæŸ¥è¯¢åŸå§‹æ–‡æ¡£ä¿¡æ¯ã€‚</li></ul></li></ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä¸º <code>InMemoryIndex</code>å®ç°ä¸€ç³»åˆ—æ–¹æ³•ï¼Œå› ä¸ºæˆ‘ä»¬æœŸæœ›ä½¿ç”¨å°ç«¯åºå­˜å‚¨ <code>Hit</code>ä¸­çš„æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¼•å…¥ <code>byteorder</code> è¿™ä¸ª crate:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo add byteorder<br></code></pre></td></tr></table></figure><p>å…·ä½“å®ç°å¯å‚è€ƒæºç ï¼Œæ ¸å¿ƒé€»è¾‘æ˜¯ <code>from_single_document</code> å’Œ<code>merge</code>ã€‚</p><h3 id="from_single_document">from_single_document</h3><p><strong>from_single_document</strong>çš„æ ¸å¿ƒé€»è¾‘åœ¨è¿™ä¸€æ®µï¼Œå®ƒå…¶å®è·Ÿæˆ‘ä»¬ä¹‹å‰å®ç°çš„ç®€æ˜“ç‰ˆå€’æ’ç´¢å¼•å¾ˆç›¸ä¼¼ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">for</span> (token, start_pos, end_pos) <span class="hljs-keyword">in</span> tokens.<span class="hljs-title function_ invoke__">iter</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">hits</span> = index.terms.<span class="hljs-title function_ invoke__">entry</span>(token.<span class="hljs-title function_ invoke__">to_string</span>()).<span class="hljs-title function_ invoke__">or_insert_with</span>(|| &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">hits</span> = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">with_capacity</span>(<span class="hljs-number">4</span> + <span class="hljs-number">4</span> + <span class="hljs-number">4</span> + <span class="hljs-number">4</span>);<br>        hits.write_i32::&lt;LittleEndian&gt;(<span class="hljs-keyword">Self</span>::HITS_SEPERATOR)<br>            .<span class="hljs-title function_ invoke__">unwrap</span>();<br>        hits.write_u32::&lt;LittleEndian&gt;(document_id).<span class="hljs-title function_ invoke__">unwrap</span>();<br>        <span class="hljs-built_in">vec!</span>[hits]<br>    &#125;);<br><br>    hits[<span class="hljs-number">0</span>].write_u32::&lt;LittleEndian&gt;(*start_pos <span class="hljs-keyword">as</span> <span class="hljs-type">u32</span>).<span class="hljs-title function_ invoke__">unwrap</span>();<br>    hits[<span class="hljs-number">0</span>].write_u32::&lt;LittleEndian&gt;(*end_pos <span class="hljs-keyword">as</span> <span class="hljs-type">u32</span>).<span class="hljs-title function_ invoke__">unwrap</span>();<br>    index.word_count += <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>éå†æ¯ä¸ª <code>token</code> å’Œå®ƒåœ¨æ–‡æœ¬ä¸­çš„ä½ç½®ã€‚</li><li>å¯¹äºæ¯ä¸ª <code>token</code>ï¼Œå°è¯•åœ¨ç´¢å¼•çš„ <code>map</code>ä¸­æŸ¥æ‰¾ä¸€ä¸ªç°æœ‰çš„æ¡ç›®ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>Hit</code>è®°å½•ï¼Œå¹¶åˆå§‹åŒ–å®ƒï¼š<ul><li>åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>Hit</code> å‘é‡ï¼Œé¢„ç•™ 24å­—èŠ‚çš„å®¹é‡ï¼Œè¿™æ˜¯å› ä¸ºè‡³å°‘è¦å­˜å‚¨ 1 ä¸ªåˆ†éš”ç¬¦ã€1 ä¸ª document_idã€1 ä¸ªstart_pos å’Œ 1 ä¸ª end_posã€‚</li><li>é¦–å…ˆå†™å…¥ <code>HITS_SEPERATOR</code> å’Œ<code>document_id</code>ï¼ˆä½¿ç”¨å°ç«¯åºï¼‰ã€‚</li></ul></li><li>å‘å¯¹åº”çš„ <code>Hit</code> å‘é‡ä¸­æ·»åŠ å½“å‰å•è¯çš„ä½ç½®ã€‚</li><li>ç´¯åŠ å¤„ç†çš„å•è¯æ€»æ•°åˆ° <code>index.word_count</code>ã€‚</li></ul><p>è¿™é‡Œç»™ä¸ªç¤ºä¾‹ï¼Œå¸Œæœ›å¯ä»¥å¸®åŠ©ä½ ç†è§£ <code>InMemoryIndex</code>çš„å†…å­˜ç»“æ„ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">InMemoryIndex</span><br><span class="hljs-string">â”‚</span><br><span class="hljs-string">â”œâ”€â”€</span> <span class="hljs-attr">word_count:</span> <span class="hljs-string">usize</span><br><span class="hljs-string">â”‚</span><br><span class="hljs-string">â”œâ”€â”€</span> <span class="hljs-attr">terms:</span> <span class="hljs-string">HashMap&lt;String,</span> <span class="hljs-string">Vec&lt;Hit&gt;&gt;</span><br><span class="hljs-string">â”‚</span>   <span class="hljs-string">â”‚</span><br><span class="hljs-string">â”‚</span>   <span class="hljs-string">â”œâ”€â”€</span> <span class="hljs-attr">Key:</span> <span class="hljs-string">&quot;example&quot;</span> <span class="hljs-string">(String)</span><br><span class="hljs-string">â”‚</span>   <span class="hljs-string">â”‚</span>   <span class="hljs-string">â””â”€â”€</span> <span class="hljs-attr">Value:</span> <span class="hljs-string">Vec&lt;Hit&gt;</span><br><span class="hljs-string">â”‚</span>   <span class="hljs-string">â”‚</span>       <span class="hljs-string">â”œâ”€â”€</span> [<span class="hljs-string">HITS_SEPERATOR</span>, <span class="hljs-attr">Document ID:</span> <span class="hljs-number">1</span>, <span class="hljs-attr">Positions:</span> [<span class="hljs-number">10</span>, <span class="hljs-number">19</span>, <span class="hljs-number">30</span>, <span class="hljs-number">39</span>]] <span class="hljs-string">(Hit)</span><br><span class="hljs-string">â”‚</span>   <span class="hljs-string">â”‚</span>       <span class="hljs-string">â””â”€â”€</span> [<span class="hljs-string">HITS_SEPERATOR</span>, <span class="hljs-attr">Document ID:</span> <span class="hljs-number">2</span>, <span class="hljs-attr">Positions:</span> [<span class="hljs-number">15</span>, <span class="hljs-number">25</span>]] <span class="hljs-string">(Hit)</span><br><span class="hljs-string">â”‚</span>   <span class="hljs-string">â”‚</span><br><span class="hljs-string">â”‚</span>   <span class="hljs-string">â””â”€â”€</span> <span class="hljs-attr">Key:</span> <span class="hljs-string">&quot;test&quot;</span><br><span class="hljs-string">â”‚</span>       <span class="hljs-string">â””â”€â”€</span> <span class="hljs-attr">Value:</span> <span class="hljs-string">Vec&lt;Hit&gt;</span><br><span class="hljs-string">â”‚</span>           <span class="hljs-string">â””â”€â”€</span> [<span class="hljs-string">HITS_SEPERATOR</span>, <span class="hljs-attr">Document ID:</span> <span class="hljs-number">1</span>, <span class="hljs-attr">Positions:</span> [<span class="hljs-number">20</span>, <span class="hljs-number">24</span>, <span class="hljs-number">50</span>, <span class="hljs-number">69</span>]] <span class="hljs-string">(Hit)</span><br><span class="hljs-string">â”‚</span><br><span class="hljs-string">â””â”€â”€</span> <span class="hljs-attr">docs:</span> <span class="hljs-string">HashMap&lt;u32,</span> <span class="hljs-string">Document&gt;</span><br>    <span class="hljs-string">â”œâ”€â”€</span> <span class="hljs-attr">Key:</span> <span class="hljs-number">1</span> <span class="hljs-string">(u32)</span><br>    <span class="hljs-string">â”‚</span>   <span class="hljs-string">â””â”€â”€</span> <span class="hljs-attr">Value:</span> <span class="hljs-string">Document</span> &#123; <span class="hljs-attr">id:</span> <span class="hljs-number">1</span>, <span class="hljs-attr">path:</span> <span class="hljs-string">&quot;path/to/file1.txt&quot;</span>&#125;<br>    <span class="hljs-string">â””â”€â”€</span> <span class="hljs-attr">Key:</span> <span class="hljs-number">2</span><br>        <span class="hljs-string">â””â”€â”€</span> <span class="hljs-attr">Value:</span> <span class="hljs-string">Document</span> &#123; <span class="hljs-attr">id:</span> <span class="hljs-number">2</span>, <span class="hljs-attr">path:</span> <span class="hljs-string">&quot;path/to/file2.txt&quot;</span>&#125;<br></code></pre></td></tr></table></figure><h3 id="merge">merge</h3><p><strong>merge</strong> æ˜¯ç”¨äºåˆå¹¶å¤šä¸ª<code>InMemoryIndex</code>ï¼Œèµ·åˆ°æ‰¹å¤„ç†çš„ç›®çš„ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">merge</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, other: InMemoryIndex) &#123;<br>    <span class="hljs-keyword">for</span> (term, hits) <span class="hljs-keyword">in</span> other.terms &#123;<br>        <span class="hljs-keyword">self</span>.terms.<span class="hljs-title function_ invoke__">entry</span>(term).<span class="hljs-title function_ invoke__">or_default</span>().<span class="hljs-title function_ invoke__">extend</span>(hits)<br>    &#125;<br>    <span class="hljs-keyword">self</span>.word_count += other.word_count;<br>    <span class="hljs-keyword">self</span>.docs.<span class="hljs-title function_ invoke__">extend</span>(other.docs);<br>&#125;<br></code></pre></td></tr></table></figure><p>å®ç°å®Œäº† <code>InMemoryIndex</code> åï¼Œæˆ‘ä»¬å°±å¯ä»¥å…ˆæ¥å®Œæˆ<code>create.rs</code> çš„ <code>run_pipeline</code> çš„å‰ 3ä¸ªé˜¶æ®µäº†ã€‚</p><h3 id="step1-start_file_reader_thread">step1:start_file_reader_thread</h3><ol type="1"><li>è¯»å–æ–‡ä»¶ä¿¡æ¯ï¼šæˆ‘ä»¬éœ€è¦åœ¨ç‹¬ç«‹çš„çº¿ç¨‹ä¸­ä¾æ¬¡æ‰“å¼€ç»™å®šçš„æ–‡ä»¶åˆ—è¡¨ï¼Œå¹¶å°†æ–‡ä»¶å†…å®¹è¯»å–åˆ°ä¸€ä¸ªString ä¸­ï¼Œå¹¶åˆ©ç”¨ channel ä¼ é€å‡ºå»ã€‚</li></ol><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">start_file_reader_thread</span>(<br>    documents: <span class="hljs-type">Vec</span>&lt;PathBuf&gt;,<br>) <span class="hljs-punctuation">-&gt;</span> (Receiver&lt;(PathBuf, <span class="hljs-type">String</span>)&gt;, JoinHandle&lt;io::<span class="hljs-type">Result</span>&lt;()&gt;&gt;) &#123;<br>    <span class="hljs-keyword">let</span> (sender, receiver) = <span class="hljs-title function_ invoke__">channel</span>();<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">handler</span> = <span class="hljs-title function_ invoke__">spawn</span>(<span class="hljs-keyword">move</span> || &#123;<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">filename</span> <span class="hljs-keyword">in</span> documents &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">f</span> = File::<span class="hljs-title function_ invoke__">open</span>(filename.<span class="hljs-title function_ invoke__">clone</span>())?;<br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">text</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">new</span>();<br>            f.<span class="hljs-title function_ invoke__">read_to_string</span>(&amp;<span class="hljs-keyword">mut</span> text)?;<br>            <span class="hljs-keyword">if</span> sender.<span class="hljs-title function_ invoke__">send</span>((filename, text)).<span class="hljs-title function_ invoke__">is_err</span>() &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-title function_ invoke__">Ok</span>(())<br>    &#125;);<br><br>    (receiver, handler)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="step2-start_file_indexing_thread">step2:start_file_indexing_thread</h3><ol start="2" type="1"><li>æ„å»ºç´¢å¼•ï¼šé€šè¿‡ channel ä»ç¬¬ 1 é˜¶æ®µä¸­è·å–æ–‡æ¡£æ–‡æœ¬ä¿¡æ¯ï¼Œé€šè¿‡from_single_document æ„å»ºç´¢å¼• InMemoryIndex åï¼Œå°†ç´¢å¼•é€šè¿‡ channelä¼ é€å‡ºå»ã€‚</li></ol><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">start_file_indexing_thread</span>(<br>    docs: Receiver&lt;(PathBuf, <span class="hljs-type">String</span>)&gt;,<br>) <span class="hljs-punctuation">-&gt;</span> (Receiver&lt;InMemoryIndex&gt;, JoinHandle&lt;()&gt;) &#123;<br>    <span class="hljs-keyword">let</span> (sender, receiver) = <span class="hljs-title function_ invoke__">channel</span>();<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">handler</span> = <span class="hljs-title function_ invoke__">spawn</span>(<span class="hljs-keyword">move</span> || &#123;<br>        <span class="hljs-keyword">for</span> (doc_id, (path, text)) <span class="hljs-keyword">in</span> docs.<span class="hljs-title function_ invoke__">into_iter</span>().<span class="hljs-title function_ invoke__">enumerate</span>() &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">index</span> = InMemoryIndex::<span class="hljs-title function_ invoke__">from_single_document</span>(doc_id <span class="hljs-keyword">as</span> <span class="hljs-type">u32</span>, path, text);<br>            <span class="hljs-keyword">if</span> sender.<span class="hljs-title function_ invoke__">send</span>(index).<span class="hljs-title function_ invoke__">is_err</span>() &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;);<br><br>    (receiver, handler)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="step3-start_in_memory_merge_thread">step3:start_in_memory_merge_thread</h3><ol start="3" type="1"><li>åˆå¹¶ç´¢å¼•ï¼šé€šè¿‡ channel ä»ç¬¬ 2 é˜¶æ®µä¸­è·å¾—æ„å»ºçš„ InMemoryIndexå¹¶å°†å…¶åˆå¹¶æˆå¤§ç´¢å¼•ï¼Œç„¶åé€šè¿‡ channel ä¼ é€å‡ºå»ã€‚</li></ol><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">start_in_memory_merge_thread</span>(<br>    indexes: Receiver&lt;InMemoryIndex&gt;,<br>) <span class="hljs-punctuation">-&gt;</span> (Receiver&lt;InMemoryIndex&gt;, JoinHandle&lt;()&gt;) &#123;<br>    <span class="hljs-keyword">let</span> (sender, receiver) = <span class="hljs-title function_ invoke__">channel</span>();<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">handle</span> = <span class="hljs-title function_ invoke__">spawn</span>(<span class="hljs-keyword">move</span> || &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">accumulated_index</span> = InMemoryIndex::<span class="hljs-title function_ invoke__">new</span>();<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> indexes &#123;<br>            accumulated_index.<span class="hljs-title function_ invoke__">merge</span>(i);<br>            <span class="hljs-keyword">if</span> accumulated_index.<span class="hljs-title function_ invoke__">is_large</span>() &#123;<br>                <span class="hljs-keyword">if</span> sender.<span class="hljs-title function_ invoke__">send</span>(accumulated_index).<span class="hljs-title function_ invoke__">is_err</span>() &#123;<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>                accumulated_index = InMemoryIndex::<span class="hljs-title function_ invoke__">new</span>();<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> !accumulated_index.<span class="hljs-title function_ invoke__">is_empty</span>() &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">_</span> = sender.<span class="hljs-title function_ invoke__">send</span>(accumulated_index);<br>        &#125;<br>    &#125;);<br><br>    (receiver, handle)<br>&#125;<br></code></pre></td></tr></table></figure><div class="note note-info">            <p><big><strong>è¡¥å……ï¼šä¸ºä»€ä¹ˆé‡‡ç”¨è¿™ç§â€œå¤æ‚â€çš„æ–¹å¼æ¥å­˜å‚¨æ•°æ®å‘¢ï¼Ÿå¯å¦ä½¿ç”¨JSON æˆ–è€… Protobuf å‘¢ï¼Ÿ</strong></big></p><p>é€‰æ‹©å¦‚ä½•ç»„ç»‡å’Œå­˜å‚¨æ•°æ®ï¼Œç‰¹åˆ«æ˜¯åœ¨å®ç°ä¸€ä¸ªæœç´¢å¼•æ“æˆ–æ•°æ®åº“ç´¢å¼•æ—¶ï¼Œæ˜¯ä¸€ä¸ªå…³é”®å†³ç­–ï¼Œè¿™ä¼šç›´æ¥å½±å“åˆ°ç¨‹åºçš„æ€§èƒ½ã€å¯ç»´æŠ¤æ€§ä»¥åŠæ‰©å±•æ€§ã€‚åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œä½¿ç”¨åƒ<code>byteorder</code> è¿™æ ·çš„ä½çº§æ•°æ®æ ¼å¼å­˜å‚¨ç´¢å¼•ä¿¡æ¯å¯èƒ½æ¯”ä½¿ç”¨ JSON æˆ–Protobuf ç­‰é«˜çº§æ ¼å¼æ›´æœ‰ä¼˜åŠ¿ã€‚</p><p>è¯»å†™é€Ÿåº¦ï¼š</p><ul><li><strong>äºŒè¿›åˆ¶æ ¼å¼</strong>ï¼šç›´æ¥æ“ä½œäºŒè¿›åˆ¶æ ¼å¼é€šå¸¸æ¯”è§£ææ–‡æœ¬æˆ–åŠç»“æ„åŒ–çš„æ•°æ®æ ¼å¼ï¼ˆå¦‚JSONï¼‰è¦å¿«ï¼Œå› ä¸ºå®ƒå‡å°‘äº†è§£ææ—¶é—´å’Œå†…å­˜ä½¿ç”¨ã€‚åœ¨äºŒè¿›åˆ¶æ ¼å¼ä¸­ï¼Œæ•°æ®é€šå¸¸æ˜¯ç´§å¯†æ‰“åŒ…çš„ï¼Œæ²¡æœ‰é¢å¤–çš„æ ¼å¼æ ‡è®°ï¼ˆå¦‚JSON ä¸­çš„èŠ±æ‹¬å·å’Œé€—å·ï¼‰ï¼Œè¿™å‡å°‘äº†ç£ç›˜ I/O éœ€æ±‚ã€‚</li><li><strong>æ–‡æœ¬/åŠç»“æ„åŒ–æ ¼å¼</strong>ï¼šä¾‹å¦‚JSONï¼Œæ¯æ¬¡è¯»å–æ—¶éƒ½éœ€è¦è§£ææ–‡æœ¬ï¼Œè½¬æ¢æ•°æ®ç±»å‹ï¼Œè¿™ä¼šå¢åŠ  CPUçš„è´Ÿæ‹…ï¼Œå°¤å…¶æ˜¯åœ¨å¤§è§„æ¨¡æ•°æ®å¤„ç†æ—¶ã€‚</li></ul><p>ç©ºé—´æ•ˆç‡ï¼š</p><ul><li><strong>äºŒè¿›åˆ¶æ ¼å¼</strong>ï¼šä½¿ç”¨æœ€å°‘çš„å­—èŠ‚è¡¨ç¤ºæ•°æ®ï¼Œä¾‹å¦‚ä½¿ç”¨å®šé•¿çš„æ•´æ•°å­˜å‚¨æ–‡æ¡£ID å’Œä½ç½®ç´¢å¼•ï¼Œä¸ä»…èŠ‚çœç©ºé—´ï¼Œè¿˜èƒ½æé«˜ç¼“å­˜åˆ©ç”¨ç‡ã€‚</li><li><strong>æ–‡æœ¬/åŠç»“æ„åŒ–æ ¼å¼</strong>ï¼šæ–‡æœ¬æ ¼å¼éœ€è¦å­˜å‚¨é¢å¤–çš„å­—ç¬¦æ¥æ ‡è¯†æ•°æ®ï¼ˆä¾‹å¦‚å¼•å·å’Œé”®åï¼‰ï¼Œè¿™å¢åŠ äº†å­˜å‚¨éœ€æ±‚ã€‚</li></ul><p>é€‚ç”¨åœºæ™¯ï¼š</p><ul><li><strong>äºŒè¿›åˆ¶æ ¼å¼</strong>ï¼šéå¸¸é€‚åˆéœ€è¦é«˜æ€§èƒ½å’Œå¤§æ•°æ®å¤„ç†çš„åç«¯ç³»ç»Ÿï¼Œå¦‚æœç´¢å¼•æ“å’Œæ•°æ®åº“ç´¢å¼•ã€‚è¿™ç§æ ¼å¼å¯ä»¥æœ‰æ•ˆåœ°æ”¯æŒå¿«é€Ÿçš„æ•°æ®è¯»å–å’Œå†™å…¥ï¼Œç‰¹åˆ«æ˜¯åœ¨èµ„æºå—é™çš„ç¯å¢ƒä¸­ï¼ˆå¦‚åµŒå…¥å¼ç³»ç»Ÿæˆ–ä½å»¶è¿Ÿåº”ç”¨ï¼‰ã€‚</li><li><strong>JSON/Protobuf</strong>ï¼šæ›´é€‚åˆéœ€è¦è·¨å¹³å°å…¼å®¹æ€§å’Œæ˜“äºè°ƒè¯•çš„åº”ç”¨åœºæ™¯ã€‚ä¾‹å¦‚ï¼Œåœ¨Web åº”ç”¨ä¸­ä½¿ç”¨ JSON ä½œä¸ºæ•°æ®äº¤æ¢æ ¼å¼ï¼Œå¯ä»¥ç®€åŒ–å‰åç«¯çš„é›†æˆå’Œæµ‹è¯•ã€‚</li></ul>          </div><h2 id="tmp.rs">tmp.rs</h2><p>å®Œæˆå†…å­˜ç´¢å¼•çš„æ„å»ºåï¼Œæˆ‘ä»¬éœ€è¦å°†æ„å»ºè¿‡ç¨‹ä¸­äº§ç”Ÿçš„å¤§ç´¢å¼•å…ˆä¸´æ—¶è½ç›˜ï¼Œåé¢å†è¿›è¡Œåˆå¹¶ã€‚ä¸ºäº†ä¸´æ—¶å­˜å‚¨è¿™äº›æ•°æ®æ–‡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦å°†ä»–ä»¬æ”¾åœ¨ä¸€ä¸ªä¸´æ—¶ç›®å½•ä¸­ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬å®šä¹‰äº†<code>TmpDir</code> æ•°æ®ç»“æ„ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[derive(Clone)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">TmpDir</span> &#123;<br>    dir: PathBuf,<br>    n: <span class="hljs-type">usize</span>,<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>dir</code>: ç›®å½•</li><li><code>n</code>: è‡ªå¢å™¨ï¼Œç”¨äºåŒºåˆ†ä¸´æ—¶æ–‡ä»¶å‘½å</li></ul><p>æ¥ä¸‹æ¥ä¸º <code>TmpDir</code> å®ç° 2 ä¸ªæ–¹æ³•ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">TmpDir</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>&lt;P: <span class="hljs-built_in">AsRef</span>&lt;Path&gt;&gt;(dir: P) <span class="hljs-punctuation">-&gt;</span> TmpDir &#123;<br>        TmpDir &#123;<br>            dir: dir.<span class="hljs-title function_ invoke__">as_ref</span>().<span class="hljs-title function_ invoke__">to_owned</span>(),<br>            n: <span class="hljs-number">1</span>,<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">create</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;(PathBuf, BufWriter&lt;File&gt;)&gt; &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">r</span>#<span class="hljs-keyword">try</span> = <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">loop</span> &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">filename</span> = <span class="hljs-keyword">self</span><br>                .dir<br>                .<span class="hljs-title function_ invoke__">join</span>(PathBuf::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-built_in">format!</span>(<span class="hljs-string">&quot;tmp&#123;:08x&#125;.dat&quot;</span>, <span class="hljs-keyword">self</span>.n)));<br>            <span class="hljs-keyword">self</span>.n += <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">match</span> fs::OpenOptions::<span class="hljs-title function_ invoke__">new</span>()<br>                .<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-literal">true</span>)<br>                .<span class="hljs-title function_ invoke__">create_new</span>(<span class="hljs-literal">true</span>)<br>                .<span class="hljs-title function_ invoke__">open</span>(&amp;filename)<br>            &#123;<br>                <span class="hljs-title function_ invoke__">Ok</span>(f) =&gt; <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Ok</span>((filename, BufWriter::<span class="hljs-title function_ invoke__">new</span>(f))),<br>                <span class="hljs-title function_ invoke__">Err</span>(exc) =&gt; &#123;<br>                    <span class="hljs-keyword">if</span> r#<span class="hljs-keyword">try</span> &lt; <span class="hljs-number">999</span> &amp;&amp; exc.<span class="hljs-title function_ invoke__">kind</span>() == io::ErrorKind::AlreadyExists &#123;<br>                        <span class="hljs-comment">// keep going</span><br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Err</span>(exc);<br>                    &#125;<br>                &#125;<br>            &#125;<br>            r#<span class="hljs-keyword">try</span> += <span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>new</strong> æ–¹æ³•æ˜¯ <code>TmpDir</code>çš„æ„é€ å‡½æ•°ï¼Œå…¶ä¸­æˆ‘ä»¬å°† <code>n</code> è®¾ç½®ä¸º 1ï¼Œå³æ–‡ä»¶åä» 1å¼€å§‹ç”Ÿæˆã€‚<code>dir.as_ref().to_owned()</code>æ¥å—ä¸€ä¸ªå¯èƒ½æ˜¯ä»»ä½•ç±»å‹çš„è·¯å¾„ï¼Œå°†å…¶æ ‡å‡†åŒ–ä¸ºä¸€ä¸ª <code>Path</code>ç±»å‹çš„å¼•ç”¨ï¼Œç„¶åå†å¤åˆ¶è¿™ä¸ªå¼•ç”¨ï¼Œåˆ›å»ºä¸€ä¸ªå®Œå…¨ç‹¬ç«‹çš„ã€æ‹¥æœ‰æ‰€æœ‰æƒçš„<code>PathBuf</code> å¯¹è±¡ï¼Œ</p><p><strong>create</strong> æ–¹æ³•æ˜¯åœ¨ <code>TmpDir</code>ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ã€‚</p><h2 id="write.rs">write.rs</h2><blockquote><p>å®Œæ•´æºç ï¼š<ahref="https://github.com/hedon-rust-road/inverted-index-concurrency/blob/master/src/write.rs">write.rs</a></p></blockquote><p>å‡†å¤‡å¥½å†…å­˜ç´¢å¼•å’Œä¸´æ—¶æ–‡ä»¶ï¼Œé‚£æˆ‘ä»¬å°±éœ€è¦å®ç°å°†å†…å­˜ç´¢å¼•å†™å…¥åˆ°æ–‡ä»¶ä¸­çš„åŠŸèƒ½äº†ã€‚</p><h3 id="struct-inmemoryindex-1">struct: InMemoryIndex</h3><p>æˆ‘ä»¬å…ˆæ¥åˆ†æä¸€ä¸‹å¦‚ä½•å°† <code>InMemoryIndex</code> è½ç›˜ã€‚é¦–å…ˆ<code>InMemoryIndex</code> çš„ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">InMemoryIndex</span> &#123;<br>    <span class="hljs-keyword">pub</span> word_count: <span class="hljs-type">usize</span>,<br>    <span class="hljs-keyword">pub</span> terms: HashMap&lt;<span class="hljs-type">String</span>, <span class="hljs-type">Vec</span>&lt;Hit&gt;&gt;,<br>    <span class="hljs-keyword">pub</span> docs: HashMap&lt;<span class="hljs-type">u32</span>, Document&gt;,<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Document</span> &#123;<br>    <span class="hljs-keyword">pub</span> id: <span class="hljs-type">u32</span>,<br>    <span class="hljs-keyword">pub</span> path: PathBuf,<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>word_count</code>ä¸éœ€è¦å­˜å‚¨ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—å‡ºæ¥ã€‚é‚£æˆ‘ä»¬å°±éœ€è¦å­˜å‚¨ç´¢å¼• <code>map</code>å’Œæ–‡æ¡£åŸæ•°æ® <code>docs</code>ã€‚ä¸ºäº†èƒ½ç²¾ç¡®å®šä½åˆ°å„ä¸ªæ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦ï¼š</p><p>terms:</p><ul><li>å†™å…¥ Vec&lt;Hit&gt;</li></ul><p>docs:</p><ul><li>å†™å…¥ docs ä¸­çš„æ¯ä¸ª Document<ul><li>å†™å…¥ id</li><li>å†™å…¥ path å¤§å°</li><li>å†™å…¥ path</li></ul></li></ul><p>è€Œä¸ºäº†å¿«é€Ÿå®šä½åˆ°æ¯ä¸ª term å’Œ docçš„ä½ç½®ï¼Œæˆ‘ä»¬éœ€è¦ä¸‹é¢å‡ ä¸ªå€¼ï¼Œè¿™å‡ ä¸ªå€¼å°†ç»„åˆèµ·æ¥è¾…åŠ©æˆ‘ä»¬å¿«é€Ÿå®šä½ terms æˆ–docsï¼Œæˆ‘ä»¬åé¢ä¼šå°†å…¶ç§°ä¸º <strong>Entry</strong>ï¼Œå®ƒåŒ…å«ä»¥ä¸‹å‡ ä¸ªå€¼ï¼š</p><ul><li><code>term</code>: ç´¢å¼•å•è¯ã€‚ä¸ºäº†ç»Ÿä¸€ï¼Œå¦‚æœ <code>term</code>ä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºå½“å‰è¡¨ç¤ºçš„æ˜¯ docï¼Œå¦åˆ™ä¸º termsã€‚</li><li><code>df</code>: term çš„å‡ºç°æ¬¡æ•°ã€‚ä¸ºäº†ç»Ÿä¸€ï¼Œå¦‚æœ <code>df</code> ä¸º0ï¼Œåˆ™è¡¨ç¤ºå½“å‰è¡¨ç¤ºçš„æ˜¯ docï¼Œå¦åˆ™ä¸º termsã€‚</li><li><code>offset</code>: å¯¹åº”çš„ terms æˆ– docs åœ¨æ–‡ä»¶ä¸­çš„åç§»ã€‚</li><li><code>nbytes</code>: å¯¹åº”çš„ terms æˆ– docs çš„æ€»é•¿åº¦ã€‚</li></ul><p>æ‰€ä»¥æ–‡ä»¶çš„å†…å­˜ç»“æ„å¤§æ¦‚å¦‚ä¸‹ï¼š</p><table><thead><tr class="header"><th>æ–‡ä»¶åŒºåŸŸ</th><th>æè¿°</th><th>æŒ‡å‘å†…å®¹</th></tr></thead><tbody><tr class="odd"><td>å¤´éƒ¨ ï¼ˆ8 å­—èŠ‚ï¼‰</td><td>åŒ…å«ä¸€ä¸ªæŒ‡å‘ç›®å½•è¡¨å¼€å§‹ä½ç½®çš„åç§»é‡ã€‚</td><td>header</td></tr><tr class="even"><td>ä¸»æ¡ç›®</td><td>è¿™äº›æ¡ç›®æŒ‰é¡ºåºç´§å¯†å­˜å‚¨ï¼Œæ²¡æœ‰é¢å¤–çš„å…ƒæ•°æ®ã€‚è¿™éƒ¨åˆ†åŒ…å«å®é™…çš„æ•°æ®æ¡ç›®ã€‚</td><td>terms + docs</td></tr><tr class="odd"><td>ç›®å½•è¡¨</td><td>å­˜å‚¨åœ¨æ–‡ä»¶çš„æœ€åï¼ŒåŒ…æ‹¬æ¯ä¸ªæ¡ç›®çš„æœ¯è¯­ä¿¡æ¯ã€æ–‡æ¡£é¢‘ç‡ã€åç§»å’Œå¤§å°ã€‚</td><td>entries</td></tr></tbody></table><p>ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240423194529529.png"alt="ç´¢å¼•æ–‡ä»¶å†…å­˜ç»“æ„ç¤ºæ„å›¾" /><figcaption aria-hidden="true">ç´¢å¼•æ–‡ä»¶å†…å­˜ç»“æ„ç¤ºæ„å›¾</figcaption></figure><p>ä¸ºæ­¤æˆ‘ä»¬å®šä¹‰äº† <code>IndexFileWriter</code>ï¼Œå®ƒä¸“é—¨ç”¨äºå°†<code>InMemoryIndex</code> å†™å…¥åˆ°ä¸´æ—¶æ–‡ä»¶ä¸­ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">/// A structure to manage writing to an index file efficiently.</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">IndexFileWriter</span> &#123;<br>    offset: <span class="hljs-type">u64</span>,<br>    writer: BufWriter&lt;File&gt;,<br>    contents_buf: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">u8</span>&gt;,<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>offset</code>: ç”¨äºè¿½è¸ªæ–‡ä»¶ä¸­å½“å‰çš„å†™å…¥ä½ç½®ã€‚</li><li><code>writer</code>:ä¸€ä¸ªç¼“å†²å†™å…¥å™¨ï¼Œå®ƒåŒ…è£…äº†ä¸€ä¸ªæ–‡ä»¶ï¼Œç”¨äºè¾“å‡ºæ“ä½œã€‚</li><li><code>contents_buf</code>:ä¸€ä¸ªå‘é‡ï¼Œç”¨æ¥å­˜å‚¨å†…å®¹æ¡ç›®ï¼Œåœ¨å…¨éƒ¨å†™å…¥æ–‡ä»¶ä¹‹å‰æš‚å­˜åœ¨è¿™ä¸ªç¼“å†²åŒºã€‚</li></ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¸º <code>IndexFileWriter</code> å®ç°å‡ ä¸ªæ–¹æ³•ï¼š</p><ul><li><code>new</code>:è¿™æ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œå®ƒåˆå§‹åŒ–æ–‡ä»¶å¹¶è®¾ç½®åˆå§‹åç§»é‡ã€‚åœ¨æ–‡ä»¶çš„å¼€å§‹å¤„å†™å…¥ä¸€ä¸ªå ä½ç¬¦ä½œä¸ºå¤´éƒ¨ï¼Œè¿™ä¸ªå¤´éƒ¨æœ€ç»ˆä¼šå­˜å‚¨ä¸»æ•°æ®åŒºçš„å¤§å°ã€‚</li><li><code>write_document</code>:ç”¨äºå°†ä¸€ä¸ªæ–‡æ¡£ä»¥äºŒè¿›åˆ¶æ ¼å¼å†™å…¥åˆ°æ–‡ä»¶ä¸­ï¼ŒåŒæ—¶æ›´æ–°åç§»é‡ã€‚</li><li><code>write_main</code>:è¿™ä¸ªæ–¹æ³•æ¥å—ä¸€æ®µæ•°æ®ï¼Œå¹¶å°†å®ƒå†™å…¥æ–‡ä»¶ä¸­ï¼ŒåŒæ—¶æ›´æ–°åç§»é‡ã€‚</li><li><code>write_contents_entry</code>: å°†ä¸€ä¸ªå†…å®¹ Entryè¿½åŠ åˆ°å†…éƒ¨çš„ç¼“å†²åŒºä¸­ã€‚EntryåŒ…æ‹¬ä¸€ä¸ªæœ¯è¯­ã€æ–‡æ¡£é¢‘ç‡ã€æœ¯è¯­æ•°æ®çš„èµ·å§‹åç§»å’Œå¤§å°ï¼Œå®ƒç”¨äºå¿«é€Ÿå®šä½ termsæˆ– docsã€‚</li><li><code>finish</code>:å®Œæˆæ–‡ä»¶å†™å…¥è¿‡ç¨‹ï¼Œå°†å†…éƒ¨ç¼“å†²åŒºçš„å†…å®¹å†™å…¥æ–‡ä»¶ï¼Œå¹¶æ›´æ–°æ–‡ä»¶å¤´éƒ¨çš„ä¸»æ•°æ®å¤§å°ã€‚</li></ul><h3 id="new">new</h3><p>æˆ‘ä»¬å…ˆæ¥çœ‹æ„é€ æ–¹æ³•ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(<span class="hljs-keyword">mut</span> f: BufWriter&lt;File&gt;) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;IndexFileWriter&gt; &#123;<br>    <span class="hljs-keyword">const</span> HEADER_SIZE: <span class="hljs-type">u64</span> = <span class="hljs-number">8</span>;<br>    f.write_u64::&lt;LittleEndian&gt;(<span class="hljs-number">0</span>)?; <span class="hljs-comment">// content start</span><br>    <span class="hljs-title function_ invoke__">Ok</span>(IndexFileWriter &#123;<br>        offset: HEADER_SIZE,<br>        writer: f,<br>        contents_buf: <span class="hljs-built_in">vec!</span>[],<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>new</strong> åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š</p><ol type="1"><li><strong>å®šä¹‰å¤´éƒ¨å¤§å°</strong>ï¼š<code>const HEADER_SIZE: u64 = 8;</code>ï¼šå®šä¹‰ä¸€ä¸ªå¸¸é‡<code>HEADER_SIZE</code>ï¼Œå…¶å€¼ä¸º 8å­—èŠ‚ï¼Œè¿™è¡¨ç¤ºæ–‡ä»¶å¤´éƒ¨çš„å¤§å°ã€‚è¿™ä¸ªå¤´éƒ¨å°†ç”¨äºåç»­åœ¨æ–‡ä»¶çš„å¼€å§‹å¤„å†™å…¥ä¸»æ•°æ®åŒºçš„èµ·å§‹ä½ç½®ã€‚</li><li><strong>å†™å…¥å¤´éƒ¨å ä½ç¬¦</strong>ï¼š<code>f.write_u64::&lt;LittleEndian&gt;(0)?;</code>ï¼šåœ¨æ–‡ä»¶çš„å¼€å§‹å¤„å†™å…¥ä¸€ä¸ª8å­—èŠ‚çš„å ä½ç¬¦ï¼Œè¿™ä¸ªå€¼æ˜¯ä»¥å°ç«¯å­—èŠ‚åºï¼ˆ<code>LittleEndian</code>ï¼‰å­˜å‚¨çš„ã€‚åˆå§‹æ—¶è¿™é‡Œå†™å…¥çš„æ˜¯0ï¼Œæ„å‘³ç€â€œä¸»æ•°æ®åŒºçš„èµ·å§‹ä½ç½®æœªçŸ¥â€ï¼Œè¿™ä¸ªå€¼åœ¨åç»­çš„ <code>finish</code>å‡½æ•°ä¸­ä¼šè¢«æ›´æ–°ã€‚</li><li><strong>è¿”å›ä¸€ä¸ªæ–°çš„ IndexFileWriterå®ä¾‹</strong>ï¼š<code>Ok(IndexFileWriter &#123; offset: HEADER_SIZE, writer: f, contents_buf: vec![], &#125;)</code>ï¼šæ„é€ å¹¶è¿”å›ä¸€ä¸ª<code>IndexFileWriter</code> å®ä¾‹ã€‚è¿™ä¸ªå®ä¾‹çš„ <code>offset</code>å­—æ®µè¢«åˆå§‹åŒ–ä¸º <code>HEADER_SIZE</code>ï¼ˆ8å­—èŠ‚ï¼‰ï¼Œè¡¨ç¤ºå®é™…æ•°æ®å°†ä»æ–‡ä»¶çš„ç¬¬ 17 ä¸ªå­—èŠ‚å¼€å§‹å†™å…¥ã€‚<code>writer</code>å­—æ®µå°±æ˜¯ä¼ å…¥çš„æ–‡ä»¶å†™å…¥å™¨ï¼Œ<code>contents_buf</code>æ˜¯ä¸€ä¸ªæ–°çš„ç©ºå‘é‡ï¼Œç”¨äºä¸´æ—¶å­˜å‚¨å†…å®¹æ¡ç›®æ•°æ®ã€‚</li></ol><div class="note note-info">            <p><big><strong>ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ</strong></big></p><p>è¿™ä¸ªå®ç°æ–¹å¼æœ‰å‡ ä¸ªè®¾è®¡ä¸Šçš„è€ƒè™‘ï¼š</p><ol type="1"><li><strong>é¢„ç•™å¤´éƒ¨ç©ºé—´</strong>ï¼šé€šè¿‡åœ¨æ–‡ä»¶å¼€å§‹å¤„é¢„ç•™ 8å­—èŠ‚ç©ºé—´æ¥å­˜å‚¨ä¸»æ•°æ®åŒºçš„å¤§å°ï¼Œè¿™æ ·åšå¯ä»¥åœ¨æ•°æ®å†™å…¥å®Œæˆåï¼Œæ–¹ä¾¿åœ°å›å¡«è¿™ä¸ªä¿¡æ¯ã€‚è¿™æ˜¯æ–‡ä»¶æ ¼å¼è®¾è®¡ä¸­å¸¸è§çš„åšæ³•ï¼Œå…è®¸è¯»å–è€…å¿«é€Ÿå®šä½ä¸»æ•°æ®åŒºå’Œå†…å®¹ç´¢å¼•åŒºã€‚</li><li><strong>ä½¿ç”¨å°ç«¯å­—èŠ‚åº</strong>ï¼šå°ç«¯å­—èŠ‚åºæ˜¯ä¸€ç§åœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­å¸¸ç”¨çš„å­—èŠ‚åºï¼Œå°¤å…¶æ˜¯åœ¨Windowså¹³å°ä¸‹ã€‚ä½¿ç”¨å°ç«¯å­—èŠ‚åºå¯ä»¥æé«˜æ–‡ä»¶çš„å…¼å®¹æ€§ï¼Œå¹¶ä¸”å¯¹äºå¤šæ•°å¤„ç†å™¨æ¶æ„æ¥è¯´ï¼Œå°ç«¯å­—èŠ‚åºçš„è¯»å†™æ“ä½œæ›´ä¸ºé«˜æ•ˆã€‚</li><li><strong>çµæ´»çš„æ•°æ®å†™å…¥</strong>ï¼šé€šè¿‡å°† <code>writer</code> å’Œ<code>contents_buf</code>ç»„åˆä½¿ç”¨ï¼Œè¿™ä¸ªç»“æ„ä½“å¯ä»¥çµæ´»åœ°å¤„ç†ä¸åŒçš„æ•°æ®å†™å…¥éœ€æ±‚ã€‚<code>writer</code>ç›´æ¥å†™å…¥æ–‡ä»¶ï¼Œé€‚åˆè¿ç»­å¤§å—æ•°æ®çš„å†™å…¥ï¼›è€Œ <code>contents_buf</code>ç”¨äºèšé›†å¤šä¸ªå°ç‰‡æ®µçš„æ•°æ®ï¼Œå¯ä»¥åœ¨æœ€åç»Ÿä¸€å†™å…¥ï¼Œå‡å°‘ç£ç›˜æ“ä½œæ¬¡æ•°ã€‚</li></ol><p>æ€»çš„æ¥è¯´ï¼Œè¿™ä¸ªæ„é€ å‡½æ•°çš„å®ç°ä¸ºé«˜æ•ˆå’Œçµæ´»çš„æ–‡ä»¶å†™æ“ä½œæä¾›äº†è‰¯å¥½çš„åŸºç¡€ï¼ŒåŒæ—¶é€šè¿‡åˆç†çš„é”™è¯¯å¤„ç†å’Œæ•°æ®ç»„ç»‡æ–¹å¼ï¼Œç¡®ä¿äº†ç¨‹åºçš„å¥å£®æ€§å’Œé«˜æ€§èƒ½ã€‚</p>          </div><h3 id="write_main">write_main</h3><p>Hit æœ¬èº«å°±æ˜¯ä¸€ä¸ª Vec&lt;u8&gt;ï¼Œ å°†å…¶å†™å…¥æ–‡ä»¶å¾ˆç®€å•ï¼Œè°ƒç”¨<code>write_all</code>ï¼Œå³å¯ï¼Œæˆ‘ä»¬ä¸ºå…¶å°è£… <code>write_main</code>æ–¹æ³•ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">write_main</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, buf: &amp;[<span class="hljs-type">u8</span>]) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-keyword">self</span>.writer.<span class="hljs-title function_ invoke__">write_all</span>(buf)?;<br>    <span class="hljs-keyword">self</span>.offset += buf.<span class="hljs-title function_ invoke__">len</span>() <span class="hljs-keyword">as</span> <span class="hljs-type">u64</span>;<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="write_document">write_document</h3><p>ä¸ºäº†å°† Docuemntæœ¬ä»¥äºŒè¿›åˆ¶ç»“æ„å†™å…¥åˆ°æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ‹†åˆ†æˆå‡ ä¸ªéƒ¨åˆ†ï¼š</p><ol type="1"><li>æ–‡ä»¶ id</li><li>æ–‡ä»¶è·¯å¾„å¤§å°</li><li>æ–‡ä»¶è·¯å¾„</li></ol><p>ä¸ºæ­¤æˆ‘ä»¬ä¸º <code>IndexFileWriter</code> å°è£…äº†<code>write_document</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">write_document</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, doc: &amp;Document) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-keyword">self</span>.writer.write_u32::&lt;LittleEndian&gt;(doc.id)?;<br>    <span class="hljs-keyword">self</span>.writer<br>        .write_u64::&lt;LittleEndian&gt;(doc.path.<span class="hljs-title function_ invoke__">as_os_str</span>().<span class="hljs-title function_ invoke__">len</span>() <span class="hljs-keyword">as</span> <span class="hljs-type">u64</span>)?;<br>    <span class="hljs-keyword">self</span>.writer.<span class="hljs-title function_ invoke__">write_all</span>(doc.path.<span class="hljs-title function_ invoke__">as_os_str</span>().<span class="hljs-title function_ invoke__">as_bytes</span>())?;<br>    <span class="hljs-keyword">self</span>.offset += <span class="hljs-number">4</span> + <span class="hljs-number">8</span> + doc.path.<span class="hljs-title function_ invoke__">as_os_str</span>().<span class="hljs-title function_ invoke__">len</span>() <span class="hljs-keyword">as</span> <span class="hljs-type">u64</span>;<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="write_contents_entry">write_contents_entry</h3><p>Entryçš„æ•°æ®é‡ä¸€èˆ¬è¾ƒå°ï¼Œæˆ‘ä»¬ä¼šå…ˆå†™å…¥ç¼“å†²ä¸­ï¼Œåé¢å†ä¸€æ¬¡æ€§åˆ·ç›˜ï¼Œä¸ºæ­¤æˆ‘ä»¬ä¸º<code>IndexFileWriter</code> å°è£…äº†<code>write_contents_entry</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">/// Appends a content entry to the internal buffer.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// # Arguments</span><br><span class="hljs-comment">/// * `term` - The term associated with the entry</span><br><span class="hljs-comment">/// * `df` - Document frequency for the term</span><br><span class="hljs-comment">/// * `offset` - Offset where the term data starts in the file</span><br><span class="hljs-comment">/// * `nbytes` - Number of bytes of the term data</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">write_contents_entry</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, term: <span class="hljs-type">String</span>, df: <span class="hljs-type">u32</span>, offset: <span class="hljs-type">u64</span>, nbytes: <span class="hljs-type">u64</span>) &#123;<br>    <span class="hljs-keyword">self</span>.contents_buf.write_u64::&lt;LittleEndian&gt;(offset).<span class="hljs-title function_ invoke__">unwrap</span>();<br>    <span class="hljs-keyword">self</span>.contents_buf.write_u64::&lt;LittleEndian&gt;(nbytes).<span class="hljs-title function_ invoke__">unwrap</span>();<br>    <span class="hljs-keyword">self</span>.contents_buf.write_u32::&lt;LittleEndian&gt;(df).<span class="hljs-title function_ invoke__">unwrap</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">bytes</span> = term.<span class="hljs-title function_ invoke__">bytes</span>();<br>    <span class="hljs-keyword">self</span>.contents_buf<br>        .write_u32::&lt;LittleEndian&gt;(bytes.<span class="hljs-title function_ invoke__">len</span>() <span class="hljs-keyword">as</span> <span class="hljs-type">u32</span>)<br>        .<span class="hljs-title function_ invoke__">unwrap</span>();<br>    <span class="hljs-keyword">self</span>.contents_buf.<span class="hljs-title function_ invoke__">extend</span>(bytes);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="finish">finish</h3><p>åˆ·ç›˜çš„è¿‡ç¨‹æˆ‘ä»¬å°è£…åœ¨ <code>finish</code> ä¸­ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">finish</span>(<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">contents_start</span> = <span class="hljs-keyword">self</span>.offset;<br>    <span class="hljs-keyword">self</span>.writer.<span class="hljs-title function_ invoke__">write_all</span>(&amp;<span class="hljs-keyword">self</span>.contents_buf)?;<br>    <span class="hljs-keyword">self</span>.writer.<span class="hljs-title function_ invoke__">seek</span>(SeekFrom::<span class="hljs-title function_ invoke__">Start</span>(<span class="hljs-number">0</span>))?;<br>    <span class="hljs-keyword">self</span>.writer.write_u64::&lt;LittleEndian&gt;(contents_start)?;<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="write_index_to_tmp_file">write_index_to_tmp_file</h3><p>ç»¼åˆä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®ç°æœ€æ ¸å¿ƒçš„å‡½æ•°<code>write_index_to_tmp_file</code> äº†ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">write_index_to_tmp_file</span>(index: InMemoryIndex, tmp_dir: &amp;<span class="hljs-keyword">mut</span> TmpDir) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;PathBuf&gt; &#123;<br>    <span class="hljs-keyword">let</span> (filename, f) = tmp_dir.<span class="hljs-title function_ invoke__">create</span>()?;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">writer</span> = IndexFileWriter::<span class="hljs-title function_ invoke__">new</span>(f)?;<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">index_as_vec</span>: <span class="hljs-type">Vec</span>&lt;_&gt; = index.terms.<span class="hljs-title function_ invoke__">into_iter</span>().<span class="hljs-title function_ invoke__">collect</span>();<br>    index_as_vec.<span class="hljs-title function_ invoke__">sort_by</span>(|(a, _), (b, _)| a.<span class="hljs-title function_ invoke__">cmp</span>(b));<br><br>    <span class="hljs-keyword">for</span> (term, hits) <span class="hljs-keyword">in</span> index_as_vec &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">df</span> = hits.<span class="hljs-title function_ invoke__">len</span>() <span class="hljs-keyword">as</span> <span class="hljs-type">u32</span>;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">start</span> = writer.offset;<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">buffer</span> <span class="hljs-keyword">in</span> hits &#123;<br>            writer.<span class="hljs-title function_ invoke__">write_main</span>(&amp;buffer)?;<br>        &#125;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">stop</span> = writer.offset;<br>        writer.<span class="hljs-title function_ invoke__">write_contents_entry</span>(term, df, start, stop - start);<br>    &#125;<br><br>    <span class="hljs-comment">// if term == &quot;&quot; &amp;&amp; df == 0 &#123; type = document &#125;</span><br>    <span class="hljs-keyword">for</span> (_, doc) <span class="hljs-keyword">in</span> index.docs &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">start</span> = writer.offset;<br>        writer.<span class="hljs-title function_ invoke__">write_document</span>(&amp;doc)?;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">stop</span> = writer.offset;<br>        writer.<span class="hljs-title function_ invoke__">write_contents_entry</span>(<span class="hljs-string">&quot;&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), <span class="hljs-number">0</span>, start, stop - start)<br>    &#125;<br><br>    writer.<span class="hljs-title function_ invoke__">finish</span>()?;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;wrote file &#123;:?&#125;&quot;</span>, filename);<br>    <span class="hljs-title function_ invoke__">Ok</span>(filename)<br>&#125;<br></code></pre></td></tr></table></figure><ol type="1"><li>æˆ‘ä»¬åœ¨ä¸´æ—¶ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ï¼Œå¹¶åˆå§‹åŒ– IndexFileWriterï¼›</li><li>å°†ç´¢å¼•çš„ <code>terms</code> è½¬æ¢æˆä¸€ä¸ªå‘é‡å¹¶æŒ‰ç…§é”®æ’åºï¼›</li><li>å¯¹äºæ¯ä¸ª<code>term</code>ï¼Œè®¡ç®—æ–‡æ¡£é¢‘ç‡ï¼ˆ<code>df</code>ï¼‰ï¼Œè®°å½•å¼€å§‹å’Œç»“æŸä½ç½®ï¼Œç„¶åè°ƒç”¨<code>write_main</code> æ–¹æ³•å°†æ•°æ®å†™å…¥æ–‡ä»¶ï¼Œç„¶åä½¿ç”¨<code>write_contents_entry</code> æ–¹æ³•å†™å…¥ <code>Entry</code>çš„å…ƒæ•°æ®åˆ°ç›®å½•è¡¨ï¼›</li><li>å¯¹äº <code>index.docs</code>ä¸­çš„æ¯ä¸ªæ–‡æ¡£ï¼Œè®¡ç®—èµ·æ­¢ä½ç½®ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ªç‰¹æ®Šçš„æ¡ç›®ï¼ˆç©ºå­—ç¬¦ä¸²ä½œä¸ºæ¡ç›®åå’Œ 0ä½œä¸ºæ–‡æ¡£é¢‘ç‡ï¼‰æ ‡è®°åœ¨æ–‡ä»¶ä¸­ï¼›</li><li>æœ€åæˆ‘ä»¬ä½¿ç”¨ <code>finish</code> å°†ç¼“å­˜ä¸­æ‰€æœ‰çš„ <code>Entry</code>åˆ·ç›˜ï¼Œå¹¶è®¾ç½® <code>entries</code> çš„èµ·å§‹ä½ç½®ã€‚</li></ol><p>æ–‡ä»¶çš„å†…å­˜ç»“æ„å¦‚ä¸Šé¢ç»™å‡ºçš„å›¾ä¸€æ ·ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥å†çœ‹ä¸€æ¬¡ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240423194529529-20240423195227516.png"alt="ç´¢å¼•æ–‡ä»¶å†…å­˜ç»“æ„ç¤ºæ„å›¾" /><figcaption aria-hidden="true">ç´¢å¼•æ–‡ä»¶å†…å­˜ç»“æ„ç¤ºæ„å›¾</figcaption></figure><h3 id="step4-start_index_writer_thread">step4:start_index_writer_thread</h3><p>å®ç°äº†å°†å†…å­˜ç´¢å¼•å†™å…¥åˆ°æ–‡ä»¶çš„åŠŸèƒ½åï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»§ç»­åœ¨<code>create.rs</code> ä¸­å®ç°ä¸‹ä¸€ä¸ªæµç¨‹äº†ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">start_index_writer_thread</span>(<br>    big_indexes: Receiver&lt;InMemoryIndex&gt;,<br>    output_dir: &amp;Path,<br>) <span class="hljs-punctuation">-&gt;</span> (Receiver&lt;PathBuf&gt;, JoinHandle&lt;io::<span class="hljs-type">Result</span>&lt;()&gt;&gt;) &#123;<br>    <span class="hljs-keyword">let</span> (sender, receiver) = <span class="hljs-title function_ invoke__">channel</span>();<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">tmp_dir</span> = TmpDir::<span class="hljs-title function_ invoke__">new</span>(output_dir);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">handle</span> = <span class="hljs-title function_ invoke__">spawn</span>(<span class="hljs-keyword">move</span> || &#123;<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> big_indexes &#123;<br>            <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;word count: &#123;&#125;&quot;</span>, i.word_count);<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">file</span> = <span class="hljs-title function_ invoke__">write_index_to_tmp_file</span>(i, &amp;<span class="hljs-keyword">mut</span> tmp_dir)?;<br>            <span class="hljs-keyword">if</span> sender.<span class="hljs-title function_ invoke__">send</span>(file).<span class="hljs-title function_ invoke__">is_err</span>() &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-title function_ invoke__">Ok</span>(())<br>    &#125;);<br><br>    (receiver, handle)<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ <code>start_index_writer_thread</code>æµç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†æ„å»ºå¥½çš„å†…å­˜ç´¢å¼•ä¸€ä¸ªä¸ªå†™å…¥åˆ°æ–‡ä»¶ä¸­ï¼Œå¹¶å°†ç”Ÿæˆçš„æ–‡ä»¶å¥æŸ„ä¼ å…¥ä¸‹ä¸€ä¸ªæµç¨‹ã€‚</p><h2 id="merge.rs">merge.rs</h2><blockquote><p>å®Œæ•´æºç ï¼š<ahref="https://github.com/hedon-rust-road/inverted-index-concurrency/blob/master/src/merge.rs">merge.rs</a></p></blockquote><p>å‰é¢ <code>start_index_writer_thread</code> æ˜¯å°†ä¸€ä¸ªä¸ª<code>InMemoryIndex</code> å†™å…¥åˆ° <code>TmpDir</code>ä¸´æ—¶ç›®å½•ä¸­ã€‚ç°åœ¨æˆ‘ä»¬è¦å°†è¿™äº›ä¸´æ—¶æ–‡ä»¶åˆå¹¶æˆä¸€ä¸ªæœ€ç»ˆçš„ç´¢å¼•æ–‡ä»¶ï¼Œä»¥ä¼˜åŒ–æŸ¥è¯¢æ•ˆç‡å’ŒèŠ‚çœå­˜å‚¨ç©ºé—´ã€‚</p><h3 id="srtuct-filemerge">srtuct: FileMerge</h3><p>æˆ‘ä»¬å®šä¹‰ä¸€ä¸‹ç»“æ„ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">FileMerge</span> &#123;<br>    output_dir: PathBuf,<br>    tmp_dir: TmpDir,<br>    stacks: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">Vec</span>&lt;PathBuf&gt;&gt;,<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>output_dir</code>: ç”¨äºå­˜å‚¨æœ€ç»ˆåˆå¹¶æ–‡ä»¶çš„è¾“å‡ºç›®å½•ã€‚</li><li><code>tmp_dir</code>: å‰é¢ <code>tmp.rs</code>å®šä¹‰çš„ç»“æ„ï¼Œç”¨äºç®¡ç†åˆå¹¶è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸´æ—¶æ–‡ä»¶ã€‚</li><li><code>stacks</code>:è¿™æ˜¯ä¸€ä¸ªäºŒç»´å‘é‡ï¼Œæ¯ä¸ªå†…éƒ¨å‘é‡ä»£è¡¨ä¸€ä¸ªåˆå¹¶â€œå±‚â€ï¼Œå­˜å‚¨äº†è¯¥å±‚å¾…åˆå¹¶çš„æ–‡ä»¶è·¯å¾„ã€‚</li></ul><p>å…³äº <code>stacks</code>ï¼Œå†å¤šè¯´ä¸¤ç‚¹ï¼š</p><ul><li><strong>å¤šçº§åˆå¹¶ç­–ç•¥</strong>: <code>FileMerge</code>ä½¿ç”¨ä¸€ä¸ªå¤šå±‚åˆå¹¶ç­–ç•¥ï¼Œè¿™ç§ç­–ç•¥åœ¨å¤„ç†å¤§é‡æ–‡ä»¶æ—¶å°¤ä¸ºæœ‰æ•ˆã€‚åŸºæœ¬æ€æƒ³æ˜¯ï¼Œå½“ä¸€å±‚çš„æ–‡ä»¶æ•°é‡è¾¾åˆ°ä¸€ä¸ªé¢„è®¾çš„é˜ˆå€¼ï¼ˆ<code>NSTREAMS</code>ï¼‰æ—¶ï¼Œè¿™äº›æ–‡ä»¶ä¼šè¢«åˆå¹¶æˆä¸€ä¸ªæ–°çš„æ–‡ä»¶ï¼Œæ–°æ–‡ä»¶åˆ™è¢«æ¨é€åˆ°ä¸Šä¸€å±‚ã€‚è¿™ç§å±‚çº§å¼çš„å¤„ç†æ–¹å¼å¯ä»¥æ˜¾è‘—å‡å°‘æœ€ç»ˆåˆå¹¶æ­¥éª¤éœ€è¦å¤„ç†çš„æ–‡ä»¶æ•°é‡ï¼Œä»è€Œä¼˜åŒ–æ€§èƒ½ã€‚</li><li><strong>åŠ¨æ€æ‰©å±•</strong>ï¼šä½¿ç”¨<code>Vec&lt;Vec&lt;PathBuf&gt;&gt;</code>å…è®¸åŠ¨æ€åœ°æ·»åŠ æ–°çš„åˆå¹¶å±‚ï¼Œè¿™åœ¨å¤„ç†ä¸ç¡®å®šæ•°é‡çš„æ–‡ä»¶æ—¶éå¸¸æœ‰ç”¨ã€‚å‘é‡çš„çµæ´»æ€§æ„å‘³ç€æ— éœ€é¢„å…ˆçŸ¥é“å°†å¤„ç†å¤šå°‘æ–‡ä»¶ï¼Œå®ƒå¯ä»¥æ ¹æ®å®é™…éœ€è¦è¿›è¡Œæ‰©å±•ã€‚</li></ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šä¸º <code>FileMerge</code> å®ç° 2 ä¸ªæ–¹æ³•ï¼š</p><ul><li><code>add_file</code>:æ·»åŠ ä¸€ä¸ªæ–‡ä»¶åˆ°åˆå¹¶æ ˆä¸­ï¼Œå¹¶ä½¿ç”¨å¤šçº§åˆå¹¶ç­–ç•¥è¿›è¡Œåˆå¹¶ã€‚</li><li><code>finish</code>: æ‰§è¡Œæœ€åçš„åˆå¹¶æ“ä½œï¼Œç”Ÿæˆæœ€ç»ˆçš„ç´¢å¼•æ–‡ä»¶ï¼Œè¾“å‡ºåˆ°<code>output_dir</code> ä¸­ã€‚</li></ul><h3 id="add_file">add_file</h3><p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹<code>add_file</code>ï¼Œå®ƒçš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">add_file</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, <span class="hljs-keyword">mut</span> file: PathBuf) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br><span class="hljs-comment">// ä»ç¬¬ä¸€å±‚å¼€å§‹æ£€æŸ¥</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">level</span> = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-comment">// ä½¿ç”¨å¾ªç¯æ¥å¤„ç†æ–‡ä»¶çš„æ·»åŠ å’Œå¯èƒ½çš„åˆå¹¶ã€‚</span><br>    <span class="hljs-keyword">loop</span> &#123;<br><br>      <span class="hljs-comment">// å¦‚æœå½“å‰çš„ level ï¼ˆå±‚çº§ï¼‰ä¸å­˜åœ¨äº stacks ä¸­ï¼Œ</span><br>        <span class="hljs-comment">// å°±åœ¨ stacks ä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„ç©ºå‘é‡ã€‚</span><br>        <span class="hljs-comment">// è¿™æ˜¯ä¸ºäº†å­˜æ”¾è¯¥å±‚çº§çš„æ–‡ä»¶ã€‚</span><br>        <span class="hljs-keyword">if</span> level == <span class="hljs-keyword">self</span>.stacks.<span class="hljs-title function_ invoke__">len</span>() &#123;<br>            <span class="hljs-keyword">self</span>.stacks.<span class="hljs-title function_ invoke__">push</span>(<span class="hljs-built_in">vec!</span>[]);<br>        &#125;<br><br>        <span class="hljs-comment">// å°†å½“å‰çš„æ–‡ä»¶æ·»åŠ åˆ°å¯¹åº”å±‚çº§çš„å‘é‡ä¸­ã€‚</span><br>        <span class="hljs-keyword">self</span>.stacks[level].<span class="hljs-title function_ invoke__">push</span>(file);<br><br>        <span class="hljs-comment">// å¦‚æœè¿™ä¸ªçº§åˆ«çš„å †æ ˆå·²æ»¡ï¼Œå°±åˆå¹¶è¿™ä¸ªçº§åˆ«çš„æ–‡ä»¶ã€‚</span><br>      <span class="hljs-comment">// å¦‚æœæ²¡æ»¡ï¼Œåˆ™ä¸è¿›è¡Œåˆå¹¶ï¼Œç›´æ¥é€€å‡ºã€‚</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.stacks[level].<span class="hljs-title function_ invoke__">len</span>() &lt; NSTREAMS &#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶æ¥å­˜å‚¨åˆå¹¶ç»“æœï¼Œå¹¶æ›´æ–°å †æ ˆã€‚</span><br>        <span class="hljs-keyword">let</span> (filename, out) = <span class="hljs-keyword">self</span>.tmp_dir.<span class="hljs-title function_ invoke__">create</span>()?;<br><br>        <span class="hljs-comment">// åˆå§‹åŒ–ä¸€ä¸ªç©ºçš„ to_merge å‘é‡ï¼Œ</span><br>      <span class="hljs-comment">// ç„¶åä½¿ç”¨ mem::swap äº¤æ¢å½“å‰å±‚çº§çš„æ–‡ä»¶åˆ—è¡¨å’Œè¿™ä¸ªç©ºå‘é‡ï¼Œ</span><br>        <span class="hljs-comment">// è¿™æ · to_merge å‘é‡å°±åŒ…å«äº†éœ€è¦åˆå¹¶çš„æ–‡ä»¶ï¼Œ</span><br>        <span class="hljs-comment">// è€Œå½“å‰å±‚çº§å˜ä¸ºç©ºï¼Œå¯ä»¥ç”¨æ¥å­˜æ”¾æ–°çš„åˆå¹¶æ–‡ä»¶ã€‚</span><br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">to_merge</span> = <span class="hljs-built_in">vec!</span>[];<br>        mem::<span class="hljs-title function_ invoke__">swap</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>.stacks[level], &amp;<span class="hljs-keyword">mut</span> to_merge);<br><br>        <span class="hljs-comment">// è°ƒç”¨ merge_streams å‡½æ•°å°† to_merge ä¸­çš„æ–‡ä»¶åˆå¹¶åˆ°æ–°åˆ›å»ºçš„æ–‡ä»¶ä¸­ã€‚</span><br>        <span class="hljs-title function_ invoke__">merge_streams</span>(to_merge, out)?;<br><br>        <span class="hljs-comment">// å°†åˆå¹¶åå¾—åˆ°çš„æ–°æ–‡ä»¶è·¯å¾„èµ‹å€¼ç»™ file å˜é‡ï¼Œç”¨äºä¸‹ä¸€è½®å¾ªç¯ã€‚</span><br>        file = filename;<br>        <span class="hljs-comment">// level åŠ ä¸€ï¼Œè¡¨ç¤ºç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå±‚çº§ã€‚</span><br>        level += <span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•é€šè¿‡å±‚çº§çš„æ–¹å¼ç®¡ç†æ–‡ä»¶åˆå¹¶ï¼Œæ¯ä¸ªå±‚çº§å¯ä»¥æœ‰å¤šä¸ªæ–‡ä»¶ï¼Œä½†æ•°é‡ä¸Šé™ä¸º<code>NSTREAMS</code>ã€‚å¦‚æœæŸå±‚æ»¡äº†ï¼Œå°±å°†è¯¥å±‚çš„æ–‡ä»¶åˆå¹¶æˆä¸€ä¸ªæ–°æ–‡ä»¶ï¼Œå¹¶å°†è¿™ä¸ªæ–°æ–‡ä»¶ç§»åŠ¨åˆ°ä¸Šä¸€å±‚ç»§ç»­å‚ä¸åˆå¹¶ã€‚è¿™ç§è®¾è®¡æœ‰æ•ˆåœ°å°†å¤šä¸ªæ–‡ä»¶é€æ­¥åˆå¹¶æˆä¸€ä¸ªæ–‡ä»¶ï¼ŒåŒæ—¶æ§åˆ¶å†…å­˜å’ŒI/O èµ„æºçš„ä½¿ç”¨ã€‚</p><p>å…¶ä¸­ <code>merge_streams</code>å°±æ˜¯å…·ä½“çš„åˆå¹¶è¿‡ç¨‹ï¼Œå®ƒçš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">merge_streams</span>(files: <span class="hljs-type">Vec</span>&lt;PathBuf&gt;, out: BufWriter&lt;File&gt;) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>  <span class="hljs-comment">// ä»ç´¢å¼•æ–‡ä»¶ä¸­æ„å»º IndexFileReader åˆ—è¡¨</span><br>  <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">streams</span>: <span class="hljs-type">Vec</span>&lt;IndexFileReader&gt; = files<br>        .<span class="hljs-title function_ invoke__">into_iter</span>()<br>        .<span class="hljs-title function_ invoke__">map</span>(|p| IndexFileReader::<span class="hljs-title function_ invoke__">open_and_delete</span>(p, <span class="hljs-literal">true</span>))<br>        .collect::&lt;io::<span class="hljs-type">Result</span>&lt;_&gt;&gt;()?;<br><br>  <span class="hljs-comment">// é’ˆå¯¹è¾“å‡ºæ–‡ä»¶ç”Ÿæˆä¸€ä¸ª IndexFileWriter ç”¨äºå†™å…¥ç´¢å¼•ä¿¡æ¯</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">output</span> = IndexFileWriter::<span class="hljs-title function_ invoke__">new</span>(out)?;<br>  <span class="hljs-comment">// ç”¨äºè®°å½•å½“å‰å†™å…¥çš„ä½ç½®ï¼ˆæˆ–è€…æ•°æ®åç§»é‡ï¼‰ã€‚</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">point</span>: <span class="hljs-type">u64</span> = <span class="hljs-number">0</span>;<br>  <span class="hljs-comment">// è®°å½•è¿˜æœ‰æ•°æ®æœªå¤„ç†çš„æ–‡ä»¶æµæ•°é‡ï¼Œç”¨ peek() æ–¹æ³•æ£€æŸ¥ã€‚</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">count</span> = streams.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">filter</span>(|s| s.<span class="hljs-title function_ invoke__">peek</span>().<span class="hljs-title function_ invoke__">is_some</span>()).<span class="hljs-title function_ invoke__">count</span>();<br><br>  <span class="hljs-comment">// åªè¦ count å¤§äº0ï¼Œè¡¨ç¤ºè¿˜æœ‰æ–‡ä»¶æœªå®Œå…¨å¤„ç†ï¼Œå°±ç»§ç»­å¾ªç¯ã€‚</span><br>    <span class="hljs-keyword">while</span> count &gt; <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">term</span> = <span class="hljs-literal">None</span>;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">nbytes</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">df</span> = <span class="hljs-number">0</span>;<br><br>        <span class="hljs-comment">// è¿™æ®µä»£ç é€šè¿‡éå†æ¯ä¸ªæ–‡ä»¶æµï¼Œä½¿ç”¨ peek() æ–¹æ³•é¢„è§ˆæ¯ä¸ªæ–‡ä»¶çš„å½“å‰æ•°æ®æ¡ç›®</span><br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">s</span> <span class="hljs-keyword">in</span> &amp;streams &#123;<br>            <span class="hljs-keyword">match</span> s.<span class="hljs-title function_ invoke__">peek</span>() &#123;<br>                <span class="hljs-literal">None</span> =&gt; &#123;&#125;<br>                <span class="hljs-title function_ invoke__">Some</span>(entry) =&gt; &#123;<br>                  <span class="hljs-comment">// term æ˜¯ç©ºçš„ï¼Œåˆ™è¯´æ˜è¿™æ˜¯è¡¨ç¤º doc çš„ entryã€‚</span><br>                  <span class="hljs-comment">// ç›´æ¥é€€å‡º for å¾ªç¯ï¼Œå› ä¸º doc çš„ entry æ²¡æœ‰é¡ºåºä¸”å”¯ä¸€ï¼Œä¸ä¼šè¿›è¡Œç´¯åŠ ã€‚</span><br>                    <span class="hljs-keyword">if</span> entry.term.<span class="hljs-title function_ invoke__">is_empty</span>() &#123;<br>                        term = <span class="hljs-title function_ invoke__">Some</span>(entry.term.<span class="hljs-title function_ invoke__">clone</span>());<br>                        nbytes = entry.nbytes;<br>                        df = entry.df;<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br><br>                  <span class="hljs-comment">// term ä¸æ˜¯ç©ºçš„ï¼Œåˆ™è¯´æ˜è¿™æ˜¯è¡¨ç¤º terms çš„ entryã€‚</span><br>                    <span class="hljs-comment">// é€‰æ‹©è¯æ¡æœ€å°çš„ä¸€ä¸ªï¼ˆå­—å…¸åºï¼‰ï¼Œå¹¶ä¸”ç´¯åŠ å…¶å‡ºç°çš„é¢‘æ¬¡å’Œå­—èŠ‚å¤§å°ã€‚</span><br>                    <span class="hljs-comment">// è¿™æ˜¯å¤šè·¯å½’å¹¶çš„æ ¸å¿ƒï¼Œç¡®ä¿è¾“å‡ºæ–‡ä»¶æ˜¯æœ‰åºçš„ã€‚</span><br>                    <span class="hljs-keyword">if</span> term.<span class="hljs-title function_ invoke__">is_none</span>() || entry.term &lt; *term.<span class="hljs-title function_ invoke__">as_ref</span>().<span class="hljs-title function_ invoke__">unwrap</span>() &#123;<br>                        term = <span class="hljs-title function_ invoke__">Some</span>(entry.term.<span class="hljs-title function_ invoke__">clone</span>());<br>                        nbytes = entry.nbytes;<br>                        df = entry.df<br>                    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> entry.term == *term.<span class="hljs-title function_ invoke__">as_ref</span>().<span class="hljs-title function_ invoke__">unwrap</span>() &#123;<br>                        nbytes += entry.nbytes;<br>                        df += entry.df<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">term</span> = term.<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">&quot;bug in algorithm&quot;</span>);<br><br>      <span class="hljs-comment">// å¯¹äºæ¯ä¸ªæ–‡ä»¶æµï¼Œå¦‚æœå½“å‰æ•°æ®æ¡ç›®ä¸é€‰æ‹©çš„ term ç›¸åŒï¼Œ</span><br>        <span class="hljs-comment">// åˆ™å°†è¯¥æ¡ç›®å†™å…¥è¾“å‡ºæ–‡ä»¶ï¼Œå¹¶æ›´æ–°è¯¥æµçš„è¯»å–ä½ç½®ã€‚</span><br>      <span class="hljs-keyword">for</span> <span class="hljs-variable">s</span> <span class="hljs-keyword">in</span> &amp;<span class="hljs-keyword">mut</span> streams &#123;<br>            <span class="hljs-keyword">if</span> s.<span class="hljs-title function_ invoke__">is_at</span>(&amp;term) &#123;<br>                s.<span class="hljs-title function_ invoke__">move_entry_to</span>(&amp;<span class="hljs-keyword">mut</span> output)?;<br>                <span class="hljs-keyword">if</span> s.<span class="hljs-title function_ invoke__">peek</span>().<span class="hljs-title function_ invoke__">is_none</span>() &#123;<br>                    count -= <span class="hljs-number">1</span>;<br>                &#125;<br>                <span class="hljs-keyword">if</span> term.<span class="hljs-title function_ invoke__">is_empty</span>() &#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        output.<span class="hljs-title function_ invoke__">write_contents_entry</span>(term, df, point, nbytes);<br>        point += nbytes<br>    &#125;<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæ¶‰åŠåˆ°äº†ä¸€ä¸ªæ–°çš„ç»“æ„<code>IndexFileReader</code>ï¼Œå®ƒæ˜¯ç´¢å¼•æ–‡ä»¶çš„è¯»å–å™¨ï¼Œæˆ‘ä»¬å°†åœ¨<code>read.rs</code> ä¸­å®ç°å®ƒã€‚è¿™é‡Œå…ˆä¸å±•å¼€ï¼Œä½ åªéœ€è¦çŸ¥é“ï¼š</p><ul><li><code>IndexFileReader::open_and_delete(p, true)</code>:æ‰“å¼€ä¸€ä¸ªç´¢å¼•æ–‡ä»¶ï¼Œå¹¶æ ¹æ®ä¼ å…¥çš„å‚æ•°åˆ¤æ–­æ˜¯å¦è¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶ï¼Œåœ¨åˆå¹¶è¿‡ç¨‹ä¸­ï¼Œå› ä¸ºéƒ½æ˜¯ä¸´æ—¶æ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šæŒ‡å®šä¸ºåˆ é™¤æ–‡ä»¶ã€‚ä½†æ˜¯åœ¨åé¢ä»ç´¢å¼•æ–‡ä»¶ä¸­é‡å»º<code>InMemoryIndex</code> çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›åˆ é™¤åŸå§‹çš„ç´¢å¼•æ–‡ä»¶ã€‚</li><li><code>s.peek()</code>: æŸ¥çœ‹ä¸‹ä¸€ä¸ª Entryï¼Œå®ƒçš„è¿”å›å€¼æ˜¯Option&lt;Entry&gt;ã€‚</li><li><code>s.move_entry_to(&amp;mut output)</code>: å°†<code>s.peek()</code> æŒ‡å‘çš„ Entry å†™å…¥åˆ° output æ–‡ä»¶ä¸­ï¼Œå¹¶ç§»åŠ¨åˆ°ä¸€ä¸‹Entryã€‚</li></ul><p>æ€»ç»“ä¸‹æ¥ï¼Œè¿™ä¸ªå‡½æ•°å®ç°å¤šè·¯å½’å¹¶çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œå®ƒå°†å¤šä¸ªç´¢å¼•æ–‡ä»¶åˆå¹¶æˆä¸€ä¸ªå•ä¸€çš„æœ‰åºæ–‡ä»¶ã€‚</p><h3 id="finish-1">finish</h3><p>æˆ‘ä»¬å†æ¥çœ‹ <code>FileMerge</code> çš„å¦å¤–ä¸€ä¸ªæ–¹æ³•<code>finish</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">finish</span>(<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br><br>    <span class="hljs-comment">// åˆå§‹åŒ–ä¸€ä¸ªä¸´æ—¶å‘é‡ tmpï¼Œç”¨æ¥æš‚å­˜éœ€è¦åˆå¹¶çš„æ–‡ä»¶è·¯å¾„ã€‚</span><br>    <span class="hljs-comment">// è¿™ä¸ªå‘é‡çš„å®¹é‡è®¾ç½®ä¸º NSTREAMSï¼Œè¿™æ˜¯é¢„å…ˆå®šä¹‰çš„å¸¸é‡ï¼Œè¡¨ç¤ºä¸€æ¬¡å¯ä»¥åˆå¹¶çš„æœ€å¤§æ–‡ä»¶æ•°ã€‚</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">tmp</span> = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">with_capacity</span>(NSTREAMS);<br><br>    <span class="hljs-comment">// æ–¹æ³•éå† self.stacks ä¸­çš„æ¯ä¸ªå †æ ˆã€‚æ¯ä¸ªå †æ ˆä»£è¡¨ä¸€ä¸ªåˆå¹¶å±‚çº§ï¼ŒåŒ…å«è‹¥å¹²å¾…åˆå¹¶çš„æ–‡ä»¶ã€‚</span><br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">stack</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.stacks &#123;<br>        <span class="hljs-comment">// å¯¹äºæ¯ä¸ªå †æ ˆï¼Œæ–¹æ³•ä½¿ç”¨ .into_iter().rev() è¿­ä»£å™¨åå‘éå†æ–‡ä»¶ï¼Œ</span><br>      <span class="hljs-comment">// ä»¥ç¡®ä¿æŒ‰æ­£ç¡®çš„é¡ºåºå¤„ç†ï¼ˆå…ˆè¿›åå‡ºï¼‰ã€‚</span><br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">file</span> <span class="hljs-keyword">in</span> stack.<span class="hljs-title function_ invoke__">into_iter</span>().<span class="hljs-title function_ invoke__">rev</span>() &#123;<br>            <span class="hljs-comment">// å°†æ–‡ä»¶é€ä¸ªæ·»åŠ åˆ° tmp å‘é‡ä¸­ã€‚</span><br>            tmp.<span class="hljs-title function_ invoke__">push</span>(file);<br>            <span class="hljs-comment">// å½“ tmp çš„é•¿åº¦è¾¾åˆ° NSTREAMS æ—¶ï¼Œ</span><br>          <span class="hljs-comment">// è°ƒç”¨ merge_reversed å‡½æ•°è¿›è¡Œåˆå¹¶ã€‚</span><br>            <span class="hljs-keyword">if</span> tmp.<span class="hljs-title function_ invoke__">len</span>() == NSTREAMS &#123;<br>                <span class="hljs-title function_ invoke__">merge_reversed</span>(&amp;<span class="hljs-keyword">mut</span> tmp, &amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>.tmp_dir)?;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>  <span class="hljs-comment">// å¯¹äºå‰©ä½™æ–‡ä»¶è¿›è¡Œæœ€ç»ˆçš„åˆå¹¶ã€‚</span><br>    <span class="hljs-keyword">if</span> tmp.<span class="hljs-title function_ invoke__">len</span>() &gt; <span class="hljs-number">1</span> &#123;<br>        <span class="hljs-title function_ invoke__">merge_reversed</span>(&amp;<span class="hljs-keyword">mut</span> tmp, &amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>.tmp_dir)?;<br>    &#125;<br><br>  <span class="hljs-comment">// æœ€ååº”è¯¥åªæœ‰ä¸€ä¸ªæœ€ç»ˆæ–‡ä»¶</span><br>    <span class="hljs-built_in">assert!</span>(tmp.<span class="hljs-title function_ invoke__">len</span>() == <span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">match</span> tmp.<span class="hljs-title function_ invoke__">pop</span>() &#123;<br>      <span class="hljs-comment">// å¯¹æ–‡ä»¶è¿›è¡Œé‡å‘½å</span><br>        <span class="hljs-title function_ invoke__">Some</span>(last_file) =&gt; fs::<span class="hljs-title function_ invoke__">rename</span>(last_file, <span class="hljs-keyword">self</span>.output_dir.<span class="hljs-title function_ invoke__">join</span>(MERGED_FILENAME)),<br>        <span class="hljs-literal">None</span> =&gt; <span class="hljs-title function_ invoke__">Err</span>(io::Error::<span class="hljs-title function_ invoke__">new</span>(<br>            io::ErrorKind::Other,<br>            <span class="hljs-string">&quot;no ducuments were parsed or none contained any words&quot;</span>,<br>        )),<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæ¶‰åŠåˆ°äº†å¦å¤–ä¸€ä¸ªå‡½æ•° <code>merge_reversed</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">merge_reversed</span>(filenames: &amp;<span class="hljs-keyword">mut</span> <span class="hljs-type">Vec</span>&lt;PathBuf&gt;, tmp_dir: &amp;<span class="hljs-keyword">mut</span> TmpDir) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    filenames.<span class="hljs-title function_ invoke__">reverse</span>();<br>    <span class="hljs-keyword">let</span> (merge_filename, out) = tmp_dir.<span class="hljs-title function_ invoke__">create</span>()?;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">to_merge</span> = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">with_capacity</span>(NSTREAMS);<br>    mem::<span class="hljs-title function_ invoke__">swap</span>(filenames, &amp;<span class="hljs-keyword">mut</span> to_merge);<br>    <span class="hljs-title function_ invoke__">merge_streams</span>(to_merge, out)?;<br>    filenames.<span class="hljs-title function_ invoke__">push</span>(merge_filename);<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></td></tr></table></figure><p>å®ƒå…¶å®å°±æ˜¯å°† <code>filenames</code> ç¿»è½¬ï¼Œæ¸…ç©ºå¹¶å°†å†…å®¹è½¬ç§»åˆ°<code>to_merge</code>ï¼Œç„¶åè°ƒç”¨ <code>merge_streams</code>åˆå¹¶ï¼Œå¹¶å°†åˆå¹¶åçš„æ–‡ä»¶é‡æ–°æ”¾å›è¢«æ¸…ç©ºçš„<code>filenames</code>ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨ <code>finish</code> ä¸­å£°æ˜çš„<code>tmp</code> å˜é‡ã€‚</p><div class="note note-info">            <p><big><strong>ä¸ºä»€ä¹ˆè¿™é‡Œéœ€è¦ç¿»è½¬ filenamesï¼Ÿ</strong></big></p><p>å‡è®¾ NSTREAMS = 3ï¼Œæˆ‘ä»¬æ‰§è¡Œ <code>add_file</code>ï¼Œä»<code>file1</code> åˆ° <code>file8</code>ï¼Œé‚£ä¹ˆè¿‡ç¨‹å¦‚ä¸‹ï¼š</p><table><thead><tr class="header"><th>Action</th><th>Stack 0</th><th>Stack 1</th><th>Notes</th></tr></thead><tbody><tr class="odd"><td>Add file1</td><td>file1</td><td></td><td></td></tr><tr class="even"><td>Add file2</td><td>file1, file2</td><td></td><td></td></tr><tr class="odd"><td>Add file3</td><td>file1, file2, file3</td><td></td><td></td></tr><tr class="even"><td>Merge S1</td><td>(empty)</td><td>merge1</td><td><code>merge1</code> is the result of merging file1-file3</td></tr><tr class="odd"><td>Add file4</td><td>file4</td><td>merge1</td><td></td></tr><tr class="even"><td>Add file5</td><td>file4, file5</td><td>merge1</td><td></td></tr><tr class="odd"><td>Add file6</td><td>file4, file5, file6</td><td>merge1</td><td></td></tr><tr class="even"><td>Merge S2</td><td>(empty)</td><td>merge1, merge2</td><td><code>merge2</code> is the result of merging file4-file6</td></tr><tr class="odd"><td>Add file7</td><td>file7</td><td>merge1, merge2</td><td></td></tr><tr class="even"><td>Add file8</td><td>file7, file8</td><td>merge1, merge2</td><td>Trigger merge because 8 files are reached</td></tr></tbody></table><p>æœ€åæˆ‘ä»¬è·å¾—çš„ç»“æœæ˜¯ï¼š</p><table><thead><tr class="header"><th>stack0</th><th>stack1</th></tr></thead><tbody><tr class="odd"><td>file7, file8</td><td>merge1, merge2</td></tr></tbody></table><p>æŒ‰ç…§æ–‡ä»¶çš„æ·»åŠ é¡ºåºï¼Œæˆ‘ä»¬æœŸæœ›åœ¨ <code>finish</code>ä¸­åˆå¹¶çš„é¡ºåºåº”è¯¥æ˜¯ï¼šmerge1, merge2, file7, file8ã€‚æ‰€ä»¥æˆ‘ä»¬éå†<code>stacks</code> çš„æ—¶å€™ï¼Œä»ç¬¬ 1 å±‚å¼€å§‹éå†çš„è¯ï¼Œæˆ‘ä»¬å°±éœ€è¦åå‘éå†<code>rev()</code>ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬ç»„æˆçš„ <code>tmp</code> å°±æ˜¯ï¼šfile8,file7, merge2, merge1ã€‚æœ€åæˆ‘ä»¬ä¼ å…¥ <code>merge_reversed</code>çš„æ—¶å€™ï¼Œå†è¿›è¡Œ <code>reverse()</code>ï¼Œå°±å¯ä»¥è·å¾—æˆ‘ä»¬æœŸæœ›çš„é¡ºåº merge1,merge2, file7, file8ã€‚</p>          </div><p>å›è¿‡å¤´æ¥ï¼Œæˆ‘ä»¬æ€»ç»“ä¸€ä¸‹<code>finish</code>ï¼šè¿™ä¸ªæ–¹æ³•é€šè¿‡å¤šçº§åˆå¹¶çš„æ–¹å¼ï¼Œé€å±‚å¤„ç†å¹¶æœ€ç»ˆåˆå¹¶æ‰€æœ‰æ–‡ä»¶åˆ°ä¸€ä¸ªæ–‡ä»¶ã€‚è¿™ä¸ªæ–¹æ³•ç¡®ä¿åœ¨å¤šä¸ªæ–‡ä»¶é¢‘ç¹åˆå¹¶çš„ç¯å¢ƒä¸­ï¼Œèƒ½æœ‰æ•ˆåœ°ç®¡ç†å’Œå‡å°‘ä¸´æ—¶å­˜å‚¨ä½¿ç”¨ï¼Œå¹¶ä¿æŒåˆå¹¶æ“ä½œçš„æ•ˆç‡ã€‚é€šè¿‡æœ€åçš„é‡å‘½åæ“ä½œï¼Œå®ƒè¿˜å¤„ç†äº†æ–‡ä»¶çš„æœ€ç»ˆå­˜æ”¾ï¼Œç¡®ä¿åˆå¹¶ç»“æœçš„æ­£ç¡®æ€§å’Œå¯ç”¨æ€§ã€‚</p><p>å®ç°äº† <code>merge.rs</code> çš„ç›¸å…³å†…å®¹ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¥å®ç°<code>create.rs</code> ä¸­çš„æœ€åä¸€æ­¥äº†ã€‚</p><h3 id="step5-merge_index_files">step5: merge_index_files</h3><p>æˆ‘ä»¬å°†ç¬¬ 4 é˜¶æ®µæ„å»ºçš„ä¸´æ—¶æ–‡ä»¶åˆå¹¶æˆä¸€ä¸ªæœ€ç»ˆçš„ç´¢å¼•æ–‡ä»¶å¹¶è¾“å‡ºåˆ°<code>output_dir</code> ç›®å½•ä¸­ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">merge_index_files</span>(files: Receiver&lt;PathBuf&gt;, output_dir: &amp;Path) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">merge</span> = FileMerge::<span class="hljs-title function_ invoke__">new</span>(output_dir);<br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">file</span> <span class="hljs-keyword">in</span> files &#123;<br>        merge.<span class="hljs-title function_ invoke__">add_file</span>(file)?;<br>    &#125;<br>    merge.<span class="hljs-title function_ invoke__">finish</span>()<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="run_pipeline">run_pipeline</h3><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†å¹¶å‘æ„å»ºå€’æ’ç´¢å¼•çš„ 5ä¸ªæ­¥éª¤äº†ï¼Œå¯¹å…¶è¿›è¡Œç»„ç»‡ï¼Œå°±å¯ä»¥å®ç°æˆ‘ä»¬çš„å¹¶å‘æ„å»ºå‡½æ•°<code>run_pipeline</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">run_pipeline</span>(documents: <span class="hljs-type">Vec</span>&lt;PathBuf&gt;, output_dir: PathBuf) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-comment">// Launch all five stages of the pipeline.</span><br>    <span class="hljs-keyword">let</span> (texts, h1) = <span class="hljs-title function_ invoke__">start_file_reader_thread</span>(documents);<br>    <span class="hljs-keyword">let</span> (pints, h2) = <span class="hljs-title function_ invoke__">start_file_indexing_thread</span>(texts);<br>    <span class="hljs-keyword">let</span> (gallons, h3) = <span class="hljs-title function_ invoke__">start_in_memory_merge_thread</span>(pints);<br>    <span class="hljs-keyword">let</span> (files, h4) = <span class="hljs-title function_ invoke__">start_index_writer_thread</span>(gallons, &amp;output_dir);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">result</span> = <span class="hljs-title function_ invoke__">merge_index_files</span>(files, &amp;output_dir);<br><br>    <span class="hljs-comment">// Wait for threads to finish, holding on to any errors that they encounter.</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">r1</span> = h1.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br>    h2.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br>    h3.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">r4</span> = h4.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br><br>    <span class="hljs-comment">// Return the first error encountered, if any.</span><br>    <span class="hljs-comment">// (As it happens, h2 and h3 can&#x27;t fail: those threads</span><br>    <span class="hljs-comment">// are pure in-memory data processing.)</span><br>    r1?;<br>    r4?;<br>    result<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="read.rs">read.rs</h2><blockquote><p>å®Œæ•´æºç ï¼š<ahref="https://github.com/hedon-rust-road/inverted-index-concurrency/blob/master/src/read.rs">read.rs</a></p></blockquote><p>åœ¨ <code>merge.rs</code> ä¸­ï¼Œæˆ‘ä»¬è¿˜å‰©æœ€åä¸€ä¸ªç»“æ„æ²¡æœ‰è§£æï¼Œé‚£å°±æ˜¯<code>IndexFileReader</code>ï¼Œå®ƒæ˜¯ç´¢å¼•æ–‡ä»¶çš„è¯»å–å™¨ã€‚</p><h3 id="struct-indexfilereader">struct: IndexFileReader</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">IndexFileReader</span> &#123;<br>    <span class="hljs-keyword">pub</span> terms_docs: BufReader&lt;File&gt;,<br>    entries: BufReader&lt;File&gt;,<br>    next: <span class="hljs-type">Option</span>&lt;Entry&gt;,<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Entry</span> &#123;<br>    <span class="hljs-keyword">pub</span> term: <span class="hljs-type">String</span>,<br>    <span class="hljs-keyword">pub</span> df: <span class="hljs-type">u32</span>,<br>    <span class="hljs-keyword">pub</span> offset: <span class="hljs-type">u64</span>,<br>    <span class="hljs-keyword">pub</span> nbytes: <span class="hljs-type">u64</span>,<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬åœ¨ <code>IndexFileReader</code> ç»“æ„ä½“ä¸­å®šä¹‰ä¸¤ä¸ª<code>BufReader&lt;File&gt;</code>ï¼Œè¿™æ˜¯ä¸ºäº†æœ‰æ•ˆç®¡ç†å’Œæ“ä½œç´¢å¼•æ–‡ä»¶ä¸­çš„ä¸åŒæ•°æ®æ®µã€‚å…·ä½“æ¥è¯´ï¼Œè¿™ç§è®¾è®¡ä½¿å¾—ä»£ç èƒ½å¤Ÿæ›´åŠ çµæ´»å’Œé«˜æ•ˆåœ°å¤„ç†ç´¢å¼•æ–‡ä»¶ä¸­çš„â€œä¸»æ•°æ®åŒºâ€å’Œâ€œå†…å®¹è¡¨åŒºâ€ã€‚</p><p>å³ç”¨æ¥åˆ†åˆ«å¤„ç†ä¸‹å›¾çš„ <code>terms&amp;doc</code> å’Œ<code>entries</code> ä¸¤ä¸ªåŒºåŸŸï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240423194529529-20240423195227516.png"alt="ç´¢å¼•æ–‡ä»¶å†…å­˜ç»“æ„ç¤ºæ„å›¾" /><figcaption aria-hidden="true">ç´¢å¼•æ–‡ä»¶å†…å­˜ç»“æ„ç¤ºæ„å›¾</figcaption></figure><p>è¿™æœ‰å‡ ä¸ªå¥½å¤„ï¼š</p><ul><li><strong>ç‹¬ç«‹çš„æ–‡ä»¶æŒ‡é’ˆ</strong>ï¼šæ¯ä¸ª<code>BufReader&lt;File&gt;</code>ç»´æŠ¤è‡ªå·±çš„æ–‡ä»¶è¯»å–ä½ç½®ï¼ˆæ–‡ä»¶æŒ‡é’ˆï¼‰ã€‚è¿™æ„å‘³ç€è¯»å–æˆ–æœç´¢å†…å®¹è¡¨æ—¶ï¼Œä¸ä¼šå½±å“ä¸»æ•°æ®åŒºçš„æ–‡ä»¶æŒ‡é’ˆï¼Œåä¹‹äº¦ç„¶ã€‚è¿™æ ·å¯ä»¥é¿å…é¢‘ç¹åœ°é‡æ–°å®šä½æ–‡ä»¶æŒ‡é’ˆï¼Œæé«˜æ–‡ä»¶æ“ä½œçš„æ•ˆç‡ã€‚</li><li><strong>ç¼“å†²è¯»å–</strong>ï¼š<code>BufReader</code>æä¾›äº†ç¼“å†²è¯»å–åŠŸèƒ½ï¼Œå¯ä»¥å‡å°‘ç›´æ¥å¯¹ç¡¬ç›˜çš„è¯»å–æ¬¡æ•°ï¼Œä»è€Œä¼˜åŒ–è¯»å–æ€§èƒ½ã€‚å¯¹äºéœ€è¦é¢‘ç¹è¯»å–å°å—æ•°æ®çš„ç´¢å¼•æ“ä½œï¼Œä½¿ç”¨ç¼“å†²è¯»å–å¯ä»¥æ˜¾è‘—æé«˜æ•ˆç‡ã€‚</li><li><strong>å¹¶è¡Œæ“ä½œ</strong>ï¼šåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œå¯èƒ½éœ€è¦åŒæ—¶è¯»å–ä¸»æ•°æ®åŒºå’Œå†…å®¹è¡¨åŒºã€‚ä½¿ç”¨ä¸¤ä¸ªç‹¬ç«‹çš„<code>BufReader</code>å®ä¾‹å¯ä»¥ç®€åŒ–å¹¶è¡Œè¯»å–çš„ç®¡ç†ï¼Œæ¯ä¸ªè¯»å–æ“ä½œéƒ½å¯ä»¥åœ¨ä¸å¹²æ‰°å¦ä¸€ä¸ªæ“ä½œçš„æƒ…å†µä¸‹ç‹¬ç«‹è¿›è¡Œã€‚</li></ul><p><code>Entry</code> å°±æ˜¯æˆ‘ä»¬åœ¨ <code>write.rs</code> ä¸­<code>write_contents_entry</code> æ—¶ä¼ å…¥çš„å‚æ•°ï¼Œè¿™é‡Œæˆ‘ä»¬å°†å…¶å°è£…æˆä¸€ä¸ªstructï¼Œå†æ¬¡å›é¡¾ä¸‹è¿™å‡ ä¸ªå­—æ®µçš„å«ä¹‰ï¼š</p><ul><li><code>term</code>: ç´¢å¼•å•è¯ã€‚ä¸ºäº†ç»Ÿä¸€ï¼Œå¦‚æœ <code>term</code>ä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºå½“å‰è¡¨ç¤ºçš„æ˜¯ docï¼Œå¦åˆ™ä¸º termsã€‚</li><li><code>df</code>: term çš„å‡ºç°æ¬¡æ•°ã€‚ä¸ºäº†ç»Ÿä¸€ï¼Œå¦‚æœ <code>df</code> ä¸º0ï¼Œåˆ™è¡¨ç¤ºå½“å‰è¡¨ç¤ºçš„æ˜¯ docï¼Œå¦åˆ™ä¸º termsã€‚</li><li><code>offset</code>: å¯¹åº”çš„ terms æˆ– docs åœ¨æ–‡ä»¶ä¸­çš„åç§»ã€‚</li><li><code>nbytes</code>: å¯¹åº”çš„ terms æˆ– docs çš„æ€»é•¿åº¦ã€‚</li></ul><h3 id="read_entry">read_entry</h3><p>è¿™é‡Œæˆ‘ä»¬é‡ç‚¹è§£é‡Šä¸€ä¸‹ <code>read_entry</code>æ–¹æ³•ï¼Œå…¶ä»–çš„éƒ½æ¯”è¾ƒç®€å•ï¼Œè¯·åœ¨æºç ä¸­æŸ¥æ‰¾ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">read_entry</span>(f: &amp;<span class="hljs-keyword">mut</span> BufReader&lt;File&gt;) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;<span class="hljs-type">Option</span>&lt;Entry&gt;&gt; &#123;<br>  <span class="hljs-comment">// è·å–åç§»å€¼</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">offset</span> = <span class="hljs-keyword">match</span> f.read_u64::&lt;LittleEndian&gt;() &#123;<br>        <span class="hljs-title function_ invoke__">Ok</span>(value) =&gt; value,<br>        <span class="hljs-title function_ invoke__">Err</span>(err) =&gt; &#123;<br>            <span class="hljs-keyword">if</span> err.<span class="hljs-title function_ invoke__">kind</span>() == io::ErrorKind::UnexpectedEof &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Ok</span>(<span class="hljs-literal">None</span>);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Err</span>(err);<br>            &#125;<br>        &#125;<br>    &#125;;<br><br>  <span class="hljs-comment">// è¯»å– nbytes</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">nbytes</span> = f.read_u64::&lt;LittleEndian&gt;()?;<br>  <span class="hljs-comment">// è¯»å– df</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">df</span> = f.read_u32::&lt;LittleEndian&gt;()?;<br>  <span class="hljs-comment">// è¯»å– term_lenï¼Œå¹¶åˆå§‹åŒ–ä¸€å—å†…å­˜ bytes ç”¨æ¥è¯»å–å®Œæ•´çš„ term</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">term_len</span> = f.read_u32::&lt;LittleEndian&gt;()? <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">bytes</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">0</span>; term_len];<br>    f.<span class="hljs-title function_ invoke__">read_exact</span>(&amp;<span class="hljs-keyword">mut</span> bytes)?;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">term</span> = <span class="hljs-keyword">match</span> <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from_utf8</span>(bytes) &#123;<br>        <span class="hljs-title function_ invoke__">Ok</span>(s) =&gt; s,<br>        <span class="hljs-title function_ invoke__">Err</span>(_) =&gt; <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Err</span>(io::Error::<span class="hljs-title function_ invoke__">new</span>(io::ErrorKind::Other, <span class="hljs-string">&quot;unicode fail&quot;</span>)),<br>    &#125;;<br><br>  <span class="hljs-comment">// è¿”å›æ„å»ºçš„ Entry</span><br>    <span class="hljs-title function_ invoke__">Ok</span>(<span class="hljs-title function_ invoke__">Some</span>(Entry &#123;<br>        term,<br>        df,<br>        offset,<br>        nbytes,<br>    &#125;))<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»“åˆä¸‹é¢è¿™å¼ å›¾ï¼Œå¾ˆå®¹æ˜“ç†è§£ <code>read_entry</code> å°±æ˜¯å‰é¢<code>write_contents_entry</code> çš„é€†å‘è¿‡ç¨‹ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240423224035544.png"alt="entries åŒºåŸŸå¸ƒå±€ï¼Œæ¯ä¸ª entry ç´§è´´æ’å¸ƒ" /><figcaption aria-hidden="true">entries åŒºåŸŸå¸ƒå±€ï¼Œæ¯ä¸ª entryç´§è´´æ’å¸ƒ</figcaption></figure><h2 id="create.rs-1">create.rs</h2><blockquote><p>å®Œæ•´æºç ï¼š<ahref="https://github.com/hedon-rust-road/inverted-index-concurrency/blob/master/src/bin/create.rs">create.rs</a></p></blockquote><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±åˆ†æå®Œå¹¶å‘æ„å»ºç´¢å¼•çš„æ•´ä¸ªè¿‡ç¨‹äº†ï¼Œåœ¨ <code>create.rs</code>ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>clap</code> å‘½ä»¤è§£ææ¡†æ¶æ¥æ„å»ºä¸€ä¸ª CLIå·¥å…·ç”¨ä»¥æ”¯æŒæ„å»ºç´¢å¼•ï¼Œæˆ‘ä»¬åŒæ—¶æ”¯æŒå•çº¿ç¨‹æ„å»ºå’Œå¹¶å‘æ„å»ºï¼Œå…·ä½“å¯çœ‹å®Œæ•´æºç ã€‚</p><p>å¦‚æœå¯¹ <code>clap</code> ä¸ç†Ÿæ‚‰çš„è¯»è€…ï¼Œå¯å‚è€ƒï¼š<ahref="https://hedon.top/2024/03/02/rust-crate-clap/">æ·±å…¥æ¢ç´¢ Rust çš„clap åº“ï¼šå‘½ä»¤è¡Œè§£æçš„è‰ºæœ¯</a></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Opts</span> &#123;<br>    <span class="hljs-meta">#[arg(short, long, default_value_t = false, help = <span class="hljs-string">&quot;Default false&quot;</span>)]</span><br>    single_threaded: <span class="hljs-type">bool</span>,<br><br>    <span class="hljs-meta">#[arg(required = true)]</span><br>    filenames: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">String</span>&gt;,<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">opts</span> = Opts::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-keyword">match</span> <span class="hljs-title function_ invoke__">run</span>(opts.filenames, opts.single_threaded) &#123;<br>        <span class="hljs-title function_ invoke__">Ok</span>(()) =&gt; &#123;&#125;<br>        <span class="hljs-title function_ invoke__">Err</span>(err) =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;error: &#123;&#125;&quot;</span>, err),<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="æœç´¢åŠŸèƒ½">æœç´¢åŠŸèƒ½</h1><p>åœ¨ã€ŠRustç¨‹åºè®¾è®¡ï¼ˆç¬¬äºŒç‰ˆï¼‰ã€‹ä¸­ï¼Œä½œè€…å¹¶æ²¡æœ‰å®ç°æœç´¢åŠŸèƒ½ï¼Œç¬”è€…å¯¹å…¶è¿›è¡Œæ‰©å±•ï¼Œç›®æ ‡æ˜¯å¯¹æ ‡æˆ‘ä»¬å‰ç¯‡æ‰€æ„å»ºçš„<ahref="https://hedon.top/2024/04/15/rust-action-inverted-index-demo/">Rustå®æˆ˜ä¸¨å€’æ’ç´¢å¼•</a>ã€‚è¿™ä¸ªæœç´¢åŠŸèƒ½ï¼Œä¼šæ ¹æ®ç°æœ‰çš„ç´¢å¼•æ–‡ä»¶é‡å»ºå†…å­˜ç´¢å¼•<code>InMemoryIndex</code>ï¼Œæ”¯æŒæŒ‡å®š <code>term</code>è¿›è¡Œæœç´¢ï¼Œå¹¶å°†åŒ…å«è¿™ä¸ª <code>term</code>çš„æ–‡ä»¶åœ¨å“åº”çš„ä½ç½®ä¸­è¿›è¡Œé«˜äº®æ˜¾ç¤ºå¹¶è¾“å‡ºåˆ°ç»ˆç«¯ã€‚</p><h2 id="search.rs-1">search.rs</h2><blockquote><p>å®Œæ•´æºç ï¼š<ahref="https://github.com/hedon-rust-road/inverted-index-concurrency/blob/master/src/bin/search.rs">search.rs</a></p></blockquote><p>ç¨‹åºå…¥å£å¦‚ä¸‹æ‰€ç¤ºï¼Œæ¯”è¾ƒç®€å•ï¼Œå°±ä¸èµ˜è¿°äº†ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Opts</span> &#123;<br>    <span class="hljs-meta">#[arg(short, long, required = true, help = <span class="hljs-string">&quot;Specify index file path&quot;</span>)]</span><br>    index_file: <span class="hljs-type">String</span>,<br>    <span class="hljs-meta">#[arg(short, long, required = true, help = <span class="hljs-string">&quot;Specify search term&quot;</span>)]</span><br>    term: <span class="hljs-type">String</span>,<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">opts</span> = Opts::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">index</span> = InMemoryIndex::<span class="hljs-title function_ invoke__">from_index_file</span>(opts.index_file)?;<br>    index.<span class="hljs-title function_ invoke__">search</span>(&amp;opts.term)?;<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ 2 ä¸ªæ ¸å¿ƒé€»è¾‘ï¼š</p><ul><li><code>InMemoryIndex::from_index_file</code>:æ ¹æ®ç´¢å¼•æ–‡ä»¶é‡å»ºå†…å­˜ç´¢å¼•ã€‚</li><li><code>index.search(term)</code>: æœç´¢ã€‚</li></ul><h2 id="index.rs-1">index.rs</h2><p>æˆ‘ä»¬åœ¨ <code>index.rs</code> ä¸­ä¸º <code>InMemoryIndex</code> å®ç°ä¸Šè¿°2 ä¸ªæ–¹æ³•ã€‚</p><h3 id="from_index_file">from_index_file</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from_index_file</span>&lt;P: <span class="hljs-built_in">AsRef</span>&lt;Path&gt;&gt;(filename: P) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;InMemoryIndex&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">index</span> = InMemoryIndex::<span class="hljs-title function_ invoke__">new</span>();<br><br>  <span class="hljs-comment">// è·å– IndexFileReader</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">reader</span> = IndexFileReader::<span class="hljs-title function_ invoke__">open_and_delete</span>(filename, <span class="hljs-literal">false</span>)?;<br><br>  <span class="hljs-comment">// ä¾æ¬¡è§£ææ¯ä¸ª Entry</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(entry) = reader.<span class="hljs-title function_ invoke__">iter_next_entry</span>() &#123;<br>        <span class="hljs-keyword">if</span> entry.term.<span class="hljs-title function_ invoke__">is_empty</span>() &amp;&amp; entry.df == <span class="hljs-number">0</span> &#123;<br>            <span class="hljs-comment">// å½“å‰ Entry æŒ‡å‘çš„æ˜¯ä¸€ä¸ª Documentã€‚</span><br>          <span class="hljs-comment">// é€šè¿‡ terms_docs è¯»å– Document æ‰€åœ¨ä½ç½®å¹¶è¿›è¡Œè§£æã€‚</span><br>            reader.terms_docs.<span class="hljs-title function_ invoke__">seek</span>(io::SeekFrom::<span class="hljs-title function_ invoke__">Start</span>(entry.offset))?;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">doc_id</span> = reader.terms_docs.read_u32::&lt;LittleEndian&gt;()?;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">path_len</span> = reader.terms_docs.read_u64::&lt;LittleEndian&gt;()?;<br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">path</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">0u8</span>; path_len <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>];<br>            reader.terms_docs.<span class="hljs-title function_ invoke__">read_exact</span>(&amp;<span class="hljs-keyword">mut</span> path)?;<br>            index.docs.<span class="hljs-title function_ invoke__">insert</span>(<br>                doc_id,<br>                Document &#123;<br>                    id: doc_id,<br>                    path: <span class="hljs-title function_ invoke__">vec_to_pathbuf</span>(path),<br>                &#125;,<br>            );<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// å½“å‰ Entry æŒ‡å‘çš„æ˜¯ä¸€ä¸ª termsã€‚</span><br>          <span class="hljs-comment">// é€šè¿‡ terms_docs è¯»å– terms æ‰€åœ¨ä½ç½®å¹¶è¿›è¡Œè§£æã€‚</span><br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">hits</span> = <span class="hljs-built_in">vec!</span>[];<br>            reader.terms_docs.<span class="hljs-title function_ invoke__">seek</span>(io::SeekFrom::<span class="hljs-title function_ invoke__">Start</span>(entry.offset))?;<br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">data</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">0u8</span>; entry.nbytes <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>];<br>            reader.terms_docs.<span class="hljs-title function_ invoke__">read_exact</span>(&amp;<span class="hljs-keyword">mut</span> data)?;<br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">cursor</span> = Cursor::<span class="hljs-title function_ invoke__">new</span>(data);<br><br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">i</span> = entry.df;<br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">has_hit</span> = <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">quit</span> = <span class="hljs-literal">false</span>;<br><br>            <span class="hljs-keyword">while</span> i &gt; <span class="hljs-number">0</span> &amp;&amp; !quit &#123;<br>                <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">hit</span> = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">with_capacity</span>(<span class="hljs-number">4</span> + <span class="hljs-number">4</span> + <span class="hljs-number">4</span>); <span class="hljs-comment">// cannot use vec![0;12]</span><br>                <span class="hljs-keyword">loop</span> &#123;<br>                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Ok</span>(item) = cursor.read_i32::&lt;LittleEndian&gt;() &#123;<br>                        <span class="hljs-comment">// the start of next hit</span><br>                        <span class="hljs-keyword">if</span> item == <span class="hljs-keyword">Self</span>::HITS_SEPERATOR &amp;&amp; has_hit &#123;<br>                            hits.<span class="hljs-title function_ invoke__">push</span>(hit);<br>                            i -= <span class="hljs-number">1</span>;<br>                            index.word_count -= <span class="hljs-number">2</span>;<br>                            hit = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">with_capacity</span>(<span class="hljs-number">4</span> + <span class="hljs-number">4</span> + <span class="hljs-number">4</span>);<br>                        &#125;<br>                        has_hit = <span class="hljs-literal">true</span>;<br>                        hit.write_u32::&lt;LittleEndian&gt;(item <span class="hljs-keyword">as</span> <span class="hljs-type">u32</span>).<span class="hljs-title function_ invoke__">unwrap</span>();<br>                        index.word_count += <span class="hljs-number">1</span>;<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        quit = <span class="hljs-literal">true</span>;<br>                        <span class="hljs-keyword">if</span> !hit.<span class="hljs-title function_ invoke__">is_empty</span>() &#123;<br>                            hits.<span class="hljs-title function_ invoke__">push</span>(hit);<br>                            index.word_count -= <span class="hljs-number">2</span>;<br>                        &#125;<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br>            index.terms.<span class="hljs-title function_ invoke__">insert</span>(entry.term, hits);<br>        &#125;<br>    &#125;<br>    index.word_count /= <span class="hljs-number">2</span>;<br>    <span class="hljs-title function_ invoke__">Ok</span>(index)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="search">search</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">search</span>(&amp;<span class="hljs-keyword">self</span>, term: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>  <span class="hljs-comment">// è·å– term å‡ºç°çš„ä½ç½®</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">m</span>: <span class="hljs-type">Option</span>&lt;&amp;<span class="hljs-type">Vec</span>&lt;<span class="hljs-type">Vec</span>&lt;<span class="hljs-type">u8</span>&gt;&gt;&gt; = <span class="hljs-keyword">self</span>.terms.<span class="hljs-title function_ invoke__">get</span>(term);<br>    <span class="hljs-keyword">if</span> m.<span class="hljs-title function_ invoke__">is_none</span>() &#123;<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;can not found &#123;&#125; in all documents&quot;</span>, term);<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Ok</span>(());<br>    &#125;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">hits</span> = m.<span class="hljs-title function_ invoke__">unwrap</span>();<br><br>  <span class="hljs-comment">// éå†æ¯ä¸ªå‡ºç°çš„ä½ç½®</span><br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">hit</span> <span class="hljs-keyword">in</span> hits &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">cursor</span> = Cursor::<span class="hljs-title function_ invoke__">new</span>(hit);<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">_</span> = cursor.read_i32::&lt;LittleEndian&gt;().<span class="hljs-title function_ invoke__">unwrap</span>();<br><br>      <span class="hljs-comment">// è·å–æ–‡æ¡£åŸå§‹ä¿¡æ¯</span><br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">document_id</span> = cursor.read_u32::&lt;LittleEndian&gt;().<span class="hljs-title function_ invoke__">unwrap</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">doc</span> = <span class="hljs-keyword">self</span>.docs.<span class="hljs-title function_ invoke__">get</span>(&amp;document_id);<br>        <span class="hljs-keyword">if</span> doc.<span class="hljs-title function_ invoke__">is_none</span>() &#123;<br>            <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;cannot found document &#123;&#125;&quot;</span>, document_id);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">doc</span> = doc.<span class="hljs-title function_ invoke__">unwrap</span>();<br><br>      <span class="hljs-comment">// hits å­˜å‚¨çš„å†…å®¹ï¼š[HITS_SEPERATOR, document_id, start_pos1, end_pos1, ...]</span><br>      <span class="hljs-comment">// è§£æ term å‡ºç°åœ¨ doc ä¸­çš„æ¯ä¸ªä½ç½®</span><br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">poss</span> = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">with_capacity</span>(hits.<span class="hljs-title function_ invoke__">len</span>() / <span class="hljs-number">4</span>);<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">pos</span> = TokenPos::<span class="hljs-title function_ invoke__">default</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">has_pos</span> = <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Ok</span>(p) = cursor.read_u32::&lt;LittleEndian&gt;() &#123;<br>            <span class="hljs-keyword">if</span> !has_pos &#123;<br>                pos.start_pos = p;<br>                has_pos = <span class="hljs-literal">true</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                pos.end_pos = p;<br>                poss.<span class="hljs-title function_ invoke__">push</span>(pos);<br>                pos = TokenPos::<span class="hljs-title function_ invoke__">default</span>();<br>                has_pos = <span class="hljs-literal">false</span>;<br>            &#125;<br>        &#125;<br><br>      <span class="hljs-comment">// å¯¹æ¯ä¸ªå‡ºç°çš„ä½ç½®è¿›è¡Œé«˜äº®å¤„ç†</span><br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">result</span> = <span class="hljs-title function_ invoke__">highlight_file</span>(doc.path.<span class="hljs-title function_ invoke__">clone</span>(), &amp;<span class="hljs-keyword">mut</span> poss)?;<br>      <span class="hljs-comment">// è¾“å‡ºé«˜äº®åçš„ç»“æœ</span><br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;\n&#123;:?&#125;: \n&#123;&#125;&quot;</span>, doc.path, result);<br>    &#125;<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></td></tr></table></figure><hr /><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®ç°äº†é«˜å¹¶å‘æ„å»ºç´¢å¼•å’Œæ ¹æ®ç´¢å¼•è¿›è¡Œæœç´¢çš„åŠŸèƒ½ï¼Œæœ¬ç¯‡æŸäº›éƒ¨åˆ†å¯èƒ½æ¯”è¾ƒå¤æ‚ï¼Œç¯‡å¹…ä¹Ÿæ¯”è¾ƒå†—é•¿ï¼Œç¬”è€…åœ¨é˜…è¯»ä¹¦ä¸­åŸå®ç°çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯è·ç›Šé¢‡ä¸°ï¼Œæƒ³ä¸åˆ°ä¸€ä¸ªç®€å•çš„å€’æ’ç´¢å¼•ç«Ÿæ¶‰åŠè¿™ä¹ˆå¤šçš„å¤„ç†ç»†èŠ‚ã€‚ä¹Ÿå¸Œæœ›æœ¬ç¯‡æ–‡ç« èƒ½å¯¹æ„Ÿå…´è¶£çš„è¯»è€…æœ‰äº›è®¸å¸®åŠ©ã€‚</p><p>peace! enjoy coding~</p><h1 id="ç»˜å›¾å·¥å…·">ç»˜å›¾å·¥å…·</h1><ul><li><ahref="https://link.zhihu.com/?target=https%3A//excalidraw.com/">https://excalidraw.com/</a></li></ul><h1 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h1><ul><li><ahref="https://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Inverted_index">ç»´åŸºç™¾ç§‘Â·å€’æ’ç´¢å¼•</a></li><li><ahref="https://link.zhihu.com/?target=https%3A//book.douban.com/subject/36547630/">Rustç¨‹åºè®¾è®¡ï¼ˆç¬¬äºŒç‰ˆï¼‰</a></li></ul>]]></content>
    
    
    <summary type="html">æœ¬æ–‡è¯¦ç»†é˜è¿°äº†ä½¿ç”¨ Rust channel å¹¶å‘æ„å»ºå€’æ’ç´¢å¼•çš„è¯¦ç»†è¿‡ç¨‹ã€‚</summary>
    
    
    
    <category term="Rust" scheme="https://hedon.top/categories/Rust/"/>
    
    <category term="Rust å®æˆ˜" scheme="https://hedon.top/categories/Rust/Rust-%E5%AE%9E%E6%88%98/"/>
    
    
    <category term="Rust" scheme="https://hedon.top/tags/Rust/"/>
    
    <category term="å€’æ’ç´¢å¼•" scheme="https://hedon.top/tags/%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95/"/>
    
    <category term="å¹¶å‘ç¼–ç¨‹" scheme="https://hedon.top/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"/>
    
    <category term="é€šé“" scheme="https://hedon.top/tags/%E9%80%9A%E9%81%93/"/>
    
  </entry>
  
  <entry>
    <title>Rust å®æˆ˜ä¸¨å€’æ’ç´¢å¼•</title>
    <link href="https://hedon.top/2024/04/15/rust-action-inverted-index-demo/"/>
    <id>https://hedon.top/2024/04/15/rust-action-inverted-index-demo/</id>
    <published>2024-04-15T02:24:17.000Z</published>
    <updated>2024-04-21T15:53:41.028Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€">å¼•è¨€</h1><p>å€’æ’ç´¢å¼•ï¼ˆInvertedIndexï¼‰æ˜¯ä¸€ç§ç´¢å¼•æ•°æ®ç»“æ„ï¼Œç”¨äºå­˜å‚¨æŸä¸ªå•è¯ï¼ˆè¯é¡¹ï¼‰åœ¨ä¸€ç»„æ–‡æ¡£ä¸­çš„æ‰€æœ‰å‡ºç°æƒ…å†µçš„æ˜ å°„ã€‚å®ƒæ˜¯æœç´¢å¼•æ“æ‰§è¡Œå¿«é€Ÿå…¨æ–‡æœç´¢çš„æ ¸å¿ƒæŠ€æœ¯ï¼Œä¹Ÿå¹¿æ³›ç”¨äºæ•°æ®åº“ä¸­è¿›è¡Œæ–‡æœ¬æœç´¢ã€‚æˆ‘ä»¬ç†ŸçŸ¥çš„ElasticSearch æœ€æ ¸å¿ƒåº•å±‚åŸç†ä¾¿å°±æ˜¯å€’æ’ç´¢å¼•ã€‚</p><p>å€’æ’ç´¢å¼•çš„åŸºæœ¬åŸç†æ˜¯<strong>å°†æ–‡æ¡£ä¸­çš„è¯æ±‡è¿›è¡Œåè½¬ï¼Œå½¢æˆå€’æ’åˆ—è¡¨</strong>ã€‚åœ¨å€’æ’åˆ—è¡¨ä¸­ï¼Œæ¯ä¸ªè¯æ±‡éƒ½å¯¹åº”ä¸€ä¸ªæ–‡æ¡£æ ‡è¯†ç¬¦çš„åˆ—è¡¨ï¼Œè¿™äº›æ ‡è¯†ç¬¦æŒ‡æ˜äº†è¯¥è¯æ±‡å‡ºç°åœ¨å“ªäº›æ–‡æ¡£ä¸­ã€‚é€šè¿‡æŸ¥è¯¢å€’æ’åˆ—è¡¨ï¼Œå¯ä»¥å¿«é€Ÿåœ°æ‰¾åˆ°åŒ…å«ç‰¹å®šè¯æ±‡çš„æ–‡æ¡£ã€‚</p><p>æœ¬æ–‡å°†ä½¿ç”¨ Rustè¯­è¨€æ¥å®ç°ä¸€ä¸ªç®€å•çš„å€’æ’ç´¢å¼•ï¼ŒåŒ…æ‹¬å€’æ’ç´¢å¼•çš„æ„å»ºå’Œæœç´¢è¿‡ç¨‹ã€‚åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œç¬”è€…ä¼šåŸºäºã€ŠRustç¨‹åºè®¾è®¡ï¼ˆç¬¬äºŒç‰ˆï¼‰ã€‹å¹¶å‘ç¼–ç¨‹ç¯‡ç« ï¼Œè§£è¯»è¯¥ä¹¦ä½œè€…æ˜¯å¦‚ä½•åŸºäº Rusté€šé“å®ç°æ›´ä¼˜ç§€ã€æ›´é«˜æ€§èƒ½çš„å€’æ’ç´¢å¼•ã€‚</p><h1 id="å¯ä»¥å­¦åˆ°">å¯ä»¥å­¦åˆ°</h1><ol type="1"><li>å€’æ’ç´¢å¼•çš„åŸç†ã€ä¼˜åŠ¿å’Œä½¿ç”¨</li><li>å¸¸ç”¨ crateï¼š<code>colored</code>ã€<code>regex</code></li><li>Rust HashMap</li><li>Rust è¿­ä»£å™¨</li></ol><h1 id="å¼€å‘æ€è·¯">å¼€å‘æ€è·¯</h1><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/imgimage-20240414112337590.png"alt="å€’æ’ç´¢å¼•æ„å»ºè¿‡ç¨‹" /><figcaption aria-hidden="true">å€’æ’ç´¢å¼•æ„å»ºè¿‡ç¨‹</figcaption></figure><p>ä¸€ä¸ªç®€å•çš„å€’æ’ç´¢å¼•å¼€å‘æ€è·¯å¤§æ¦‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼š</p><ol type="1"><li>è¯»å–æ–‡æ¡£</li><li>åˆ†è¯</li><li>æ„å»ºæ¯ä¸ªè¯åˆ°æ¯ä¸ªæ–‡æ¡£çš„æ˜ å°„</li></ol><h1 id="å¼€å‘è¿‡ç¨‹">å¼€å‘è¿‡ç¨‹</h1><blockquote><p>å®Œæ•´æºç ä½äºï¼š<ahref="https://github.com/hedon-rust-road/inverted-index">inverted_index</a>ã€‚</p></blockquote><h2 id="æœ€ç»ˆæ•ˆæœ">æœ€ç»ˆæ•ˆæœ</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">index</span> = InvertedIndex::<span class="hljs-title function_ invoke__">new</span>();<br>    index.<span class="hljs-title function_ invoke__">add</span>(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;Rust is safe and fast.&quot;</span>);<br>    index.<span class="hljs-title function_ invoke__">add</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;Rust is a systems programming language.&quot;</span>);<br>    index.<span class="hljs-title function_ invoke__">add</span>(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;Programming in Rust is fun.&quot;</span>);<br><br>    <span class="hljs-comment">// query &quot;Rust&quot;</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">results</span> = index.<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-string">&quot;Rust&quot;</span>);<br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">result</span> <span class="hljs-keyword">in</span> results &#123;<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, result);<br>    &#125;<br><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&quot;</span>);<br><br>    <span class="hljs-comment">// query &quot;Programming&quot;</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">results</span> = index.<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-string">&quot;Programming&quot;</span>);<br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">result</span> <span class="hljs-keyword">in</span> results &#123;<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, result);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo run<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/imgimage-20240414122848805.png"alt="inverted index è¾“å‡ºç¤ºä¾‹" /><figcaption aria-hidden="true">inverted index è¾“å‡ºç¤ºä¾‹</figcaption></figure><h2 id="ç‰ˆæœ¬å£°æ˜">ç‰ˆæœ¬å£°æ˜</h2><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs toml"><span class="hljs-section">[package]</span><br><span class="hljs-attr">name</span> = <span class="hljs-string">&quot;inverted_index&quot;</span><br><span class="hljs-attr">version</span> = <span class="hljs-string">&quot;0.1.0&quot;</span><br><span class="hljs-attr">edition</span> = <span class="hljs-string">&quot;2021&quot;</span><br><br><span class="hljs-section">[dependencies]</span><br><span class="hljs-attr">colored</span> = <span class="hljs-string">&quot;2.1.0&quot;</span><br><span class="hljs-attr">regex</span> = <span class="hljs-string">&quot;1.10.4&quot;</span><br></code></pre></td></tr></table></figure><h2 id="é¡¹ç›®å‡†å¤‡">é¡¹ç›®å‡†å¤‡</h2><p>é¦–å…ˆæˆ‘ä»¬åˆ›å»ºé¡¹ç›®ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo new inverted_index<br></code></pre></td></tr></table></figure><p>å‡†å¤‡ä¾èµ–ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo add regex<br>cargo add colored<br></code></pre></td></tr></table></figure><ul><li>colored:ç»ˆç«¯é«˜äº®ï¼Œåé¢æˆ‘ä»¬å°†å®ç°æœç´¢è¯çš„é«˜äº®æ˜¾ç¤ºï¼Œä½¿ç»“æœæ›´ç¾è§‚ã€‚</li><li>regex: æ­£åˆ™åº“ï¼Œç”¨äºå®ç°ä¸åŒºåˆ†å¤§å°å†™æ›¿æ¢åŒ¹é…åˆ°çš„æœç´¢è¯ã€‚</li></ul><h2 id="å®ç°è¿‡ç¨‹">å®ç°è¿‡ç¨‹</h2><p>é¦–å…ˆæˆ‘ä»¬å®šä¹‰ä¸¤ä¸ªæ•°æ®ç»“æ„ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Document</span> &#123;<br>    id: <span class="hljs-type">usize</span>,<br>    content: <span class="hljs-type">String</span>,<br>&#125;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">InvertedIndex</span> &#123;<br>    indexes: HashMap&lt;<span class="hljs-type">String</span>, <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">usize</span>&gt;&gt;,<br>    documents: HashMap&lt;<span class="hljs-type">usize</span>, Document&gt;,<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">InvertedIndex</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>() <span class="hljs-punctuation">-&gt;</span> InvertedIndex &#123;<br>        InvertedIndex &#123;<br>            indexes: HashMap::<span class="hljs-title function_ invoke__">new</span>(),<br>            documents: HashMap::<span class="hljs-title function_ invoke__">new</span>(),<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>Document: å°è£…åŸå§‹æ–‡æ¡£</li><li>IndexedIndex: æˆ‘ä»¬å°†æ„å»ºçš„å€’æ’ç´¢å¼•</li></ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬è¦å®ç° 2 ä¸ªè¾…åŠ©å‡½æ•°ï¼Œä¸€ä¸ªæ˜¯<code>tokenize</code>ï¼Œç”¨äºå°†åŸå§‹çš„æ–‡æ¡£ä¿¡æ¯æ‹†åˆ†æˆç‹¬ç«‹çš„è¯ï¼ˆword/termï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯<code>hightlight</code>ï¼Œç”¨äºå°†åŒ¹é…åˆ°çš„æ–‡æœ¬è¿›è¡Œæ›¿æ¢ï¼Œä½¿å…¶åœ¨ä¸­æ–­å¯ä»¥ä»¥<font color="purple">ç´«è‰²</font>è¾“å‡ºã€‚</p><p><code>tokenize</code> å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">tokenize</span>(text: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Vec</span>&lt;&amp;<span class="hljs-type">str</span>&gt; &#123;<br>    text.<span class="hljs-title function_ invoke__">split</span>(|ch: <span class="hljs-type">char</span>| !ch.<span class="hljs-title function_ invoke__">is_alphanumeric</span>())<br>        .<span class="hljs-title function_ invoke__">filter</span>(|c| !c.<span class="hljs-title function_ invoke__">is_empty</span>())<br>        .<span class="hljs-title function_ invoke__">collect</span>()<br>&#125;<br><br><span class="hljs-meta">#[test]</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">tokenize_test</span>() &#123;<br>    <span class="hljs-built_in">assert_eq!</span>(<br>        <span class="hljs-title function_ invoke__">tokenize</span>(<span class="hljs-string">&quot;This is\nhedon&#x27;s tokenize function.&quot;</span>),<br>        <span class="hljs-built_in">vec!</span>[<span class="hljs-string">&quot;This&quot;</span>, <span class="hljs-string">&quot;is&quot;</span>, <span class="hljs-string">&quot;hedon&quot;</span>, <span class="hljs-string">&quot;s&quot;</span>, <span class="hljs-string">&quot;tokenize&quot;</span>, <span class="hljs-string">&quot;function&quot;</span>]<br>    )<br>&#125;<br></code></pre></td></tr></table></figure><p><code>highlight</code> å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">highlight</span>(term: &amp;<span class="hljs-type">str</span>, content: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">regex</span> = Regex::<span class="hljs-title function_ invoke__">new</span>(&amp;<span class="hljs-built_in">format!</span>(<span class="hljs-string">r&quot;(?i)&#123;&#125;&quot;</span>, term)).<span class="hljs-title function_ invoke__">unwrap</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">highlighted_content</span> = regex<br>        .<span class="hljs-title function_ invoke__">replace_all</span>(content, |caps: &amp;regex::Captures| &#123;<br>            caps[<span class="hljs-number">0</span>].<span class="hljs-title function_ invoke__">to_string</span>().<span class="hljs-title function_ invoke__">purple</span>().<span class="hljs-title function_ invoke__">to_string</span>()<br>        &#125;)<br>        .<span class="hljs-title function_ invoke__">to_string</span>();<br>    highlighted_content<br>&#125;<br><br><span class="hljs-meta">#[test]</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">highlight_test</span>() &#123;<br>    <span class="hljs-built_in">assert_eq!</span>(<br>        <span class="hljs-title function_ invoke__">highlight</span>(<span class="hljs-string">&quot;programming&quot;</span>, <span class="hljs-string">&quot;I like programming with Rust Programming&quot;</span>),<br>        <span class="hljs-string">&quot;I like \u&#123;1b&#125;[35mprogramming\u&#123;1b&#125;[0m with Rust \u&#123;1b&#125;[35mProgramming\u&#123;1b&#125;[0m&quot;</span><br>    );<br>&#125;<br></code></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥ä¸º <code>InvertedIndex</code> å®ç°æ„å»ºç´¢å¼•çš„æ–¹æ³•<code>add</code>äº†ï¼Œå®ƒä¼šæ¥æ”¶åŸå§‹æ–‡æ¡£ï¼Œå¯¹å…¶è¿›è¡Œåˆ†è¯ï¼Œå¹¶å°†è®°å½•æ¯ä¸ªåˆ†è¯å’Œæ–‡æ¡£ idçš„æ˜ å°„ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">InvertedIndex</span> &#123;<br>  <span class="hljs-keyword">fn</span> <span class="hljs-title function_">add</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, doc_id: <span class="hljs-type">usize</span>, content: &amp;<span class="hljs-type">str</span>) &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">content_lowercase</span> = content.<span class="hljs-title function_ invoke__">to_lowercase</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">words</span> = <span class="hljs-title function_ invoke__">tokenize</span>(&amp;content_lowercase);<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">word</span> <span class="hljs-keyword">in</span> words &#123;<br>            <span class="hljs-keyword">self</span>.indexes<br>                .<span class="hljs-title function_ invoke__">entry</span>(word.<span class="hljs-title function_ invoke__">to_string</span>())<br>                .<span class="hljs-title function_ invoke__">or_insert</span>(<span class="hljs-built_in">vec!</span>[])<br>                .<span class="hljs-title function_ invoke__">push</span>(doc_id)<br>        &#125;<br><br>        <span class="hljs-keyword">self</span>.documents.<span class="hljs-title function_ invoke__">insert</span>(<br>            doc_id,<br>            Document &#123;<br>                id: doc_id,<br>                content: content.<span class="hljs-title function_ invoke__">to_string</span>(),<br>            &#125;,<br>        );<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬å†å®ç°å¯¹åº”çš„æ ¹æ®åˆ†è¯ <code>term</code>æœç´¢åŸå§‹æ–‡æ¡£çš„æ–¹æ³•ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">InvertedIndex</span> &#123;<br>  <span class="hljs-keyword">fn</span> <span class="hljs-title function_">query</span>(&amp;<span class="hljs-keyword">self</span>, term: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">String</span>&gt; &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">term_lowercase</span> = term.<span class="hljs-title function_ invoke__">to_lowercase</span>();<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(doc_ids) = <span class="hljs-keyword">self</span>.indexes.<span class="hljs-title function_ invoke__">get</span>(&amp;term_lowercase) &#123;<br>            doc_ids<br>                .<span class="hljs-title function_ invoke__">iter</span>()<br>                .<span class="hljs-title function_ invoke__">filter_map</span>(|doc_id| &#123;<br>                    <span class="hljs-keyword">self</span>.documents<br>                        .<span class="hljs-title function_ invoke__">get</span>(doc_id)<br>                        .<span class="hljs-title function_ invoke__">map</span>(|doc| <span class="hljs-title function_ invoke__">highlight</span>(&amp;term_lowercase, &amp;doc.content))<br>                &#125;)<br>                .<span class="hljs-title function_ invoke__">collect</span>()<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">new</span>()<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ ·ä¸€ä¸ªç®€å•çš„å€’æ’ç´¢å¼•æ„å»ºå’Œæœç´¢åŠŸèƒ½å°±å®Œæˆäº†ï¼Œå…·ä½“çš„æ‰§è¡Œæ•ˆæœä½ å¯ä»¥å›åˆ°å‰é¢çš„ã€Œæœ€ç»ˆæ•ˆæœã€è¿›è¡ŒæŸ¥é˜…ã€‚</p><h1 id="æ€»ç»“é¢„å‘Š">æ€»ç»“é¢„å‘Š</h1><p>æœ¬æ–‡å®ç°çš„å€’æ’ç´¢å¼•è™½ç„¶éå¸¸ç®€å•ï¼Œä½†æ˜¯ä¹ŸåŸºæœ¬ä½“ç°äº†å€’æ’ç´¢å¼•çš„æœ€æ ¸å¿ƒæ€æƒ³å’Œåº”ç”¨æ–¹å¼äº†ã€‚åœ¨ã€ŠRustç¨‹åºè®¾è®¡ï¼ˆç¬¬äºŒç‰ˆï¼‰ã€‹çš„å¹¶å‘ç¼–ç¨‹ç¯‡ç« ä¸­ï¼Œè¯¥ä¹¦æå‡ºäº†ä½¿ç”¨é€šé“ channelæ¥å¹¶å‘æ„å»ºå€’æ’ç´¢å¼•ï¼ŒåŒæ—¶ç»™å‡ºäº†æ›´åŠ ä¸°å¯Œå’Œä¼˜é›…çš„å®ç°ã€‚åœ¨ä¸‹ç¯‡æ–‡ç« ä¸­ï¼Œç¬”è€…å°†é˜…è¯»è¿™éƒ¨åˆ†çš„æºç ï¼Œè§£æå¹¶é‡ç°å½“ä¸­çš„å®æˆ˜è¿‡ç¨‹ï¼Œå¹¶è¿›è¡Œé€‚å½“æ‰©å±•ã€‚</p><p>peace! enjoy coding~</p><h1 id="ç»˜å›¾å·¥å…·">ç»˜å›¾å·¥å…·</h1><ul><li>https://excalidraw.com/</li></ul><h1 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h1><ul><li><ahref="https://en.wikipedia.org/wiki/Inverted_index">ç»´åŸºç™¾ç§‘Â·å€’æ’ç´¢å¼•</a></li><li><a href="https://book.douban.com/subject/36547630/">Rustç¨‹åºè®¾è®¡ï¼ˆç¬¬äºŒç‰ˆï¼‰</a></li></ul>]]></content>
    
    
    <summary type="html">æœ¬æ–‡å°†ä½¿ç”¨ Rust å®ç°ä¸€ä¸ªç®€å•çš„å€’æ’ç´¢å¼•ã€‚</summary>
    
    
    
    <category term="Rust" scheme="https://hedon.top/categories/Rust/"/>
    
    <category term="Rust å®æˆ˜" scheme="https://hedon.top/categories/Rust/Rust-%E5%AE%9E%E6%88%98/"/>
    
    
    <category term="Rust" scheme="https://hedon.top/tags/Rust/"/>
    
    <category term="å€’æ’ç´¢å¼•" scheme="https://hedon.top/tags/%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥æµ…å‡º Go è¯­è¨€çš„ defer æœºåˆ¶</title>
    <link href="https://hedon.top/2024/03/28/go-defer/"/>
    <id>https://hedon.top/2024/03/28/go-defer/</id>
    <published>2024-03-28T12:34:50.000Z</published>
    <updated>2024-04-14T15:12:49.119Z</updated>
    
    <content type="html"><![CDATA[<p>Goè¯­è¨€ä»¥å…¶ç®€æ´çš„è¯­æ³•å’Œå¼ºå¤§çš„å¹¶å‘æ”¯æŒè€Œé—»åã€‚åœ¨è¿™äº›ç‰¹æ€§ä¸­ï¼Œ<code>defer</code>è¯­å¥æ˜¯ Goè¯­è¨€æä¾›çš„ä¸€é¡¹ç‹¬ç‰¹åŠŸèƒ½ï¼Œå®ƒå…è®¸æˆ‘ä»¬æ¨è¿Ÿå‡½æ•°çš„æ‰§è¡Œç›´åˆ°åŒ…å«å®ƒçš„å‡½æ•°å³å°†è¿”å›ã€‚è¿™ä¸ªç®€å•è€Œå¼ºå¤§çš„æœºåˆ¶ä¸ä»…å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¤„ç†èµ„æºé‡Šæ”¾å’Œé”™è¯¯å¤„ç†ï¼Œè¿˜èƒ½è®©ä»£ç æ›´åŠ ç®€æ´å’Œå®‰å…¨ã€‚æœ¬æ–‡å°†æ·±å…¥æµ…å‡ºåœ°ä»‹ç»<code>defer</code>çš„å·¥ä½œåŸç†ï¼Œæ¢ç©¶å…¶èƒŒåçš„æœºåˆ¶ï¼Œå¹¶é€šè¿‡ä¸°å¯Œçš„æ¡ˆä¾‹æ¥å±•ç¤ºå®ƒçš„å®é™…åº”ç”¨ã€‚</p><p>ç¬”è€…æœ¬æ¥ä»¥ä¸º Go è¯­è¨€çš„ <code>defer</code>å…¶å®ä¸œè¥¿ä¸å¤šï¼Œå°±æ˜¯ç±»ä¼¼äºâ€œæ ˆâ€çš„æ“ä½œç½¢äº†ï¼Œæ— éå°±æ˜¯ç”¨äºé‡Šæ”¾èµ„æºã€åè¿›å…ˆå‡ºè€Œå·²ã€‚ä½†æ˜¯æœ€è¿‘åœ¨é˜…è¯»å®Œã€Šæ·±å…¥ç†è§£Go è¯­è¨€ã€‹ã€ã€ŠGo åº•å±‚åŸç†å‰–æã€‹å’Œã€ŠGo è¯­è¨€è®¾è®¡ä¸å®ç°ã€‹ä¸­å…³äº<code>defer</code>çš„ç¯‡ç« ã€‚å‘ç°å…¶ä¸­éšå«çš„é“é“å’Œå‘è¿˜æ˜¯æ¯”è¾ƒæœ‰æ„æ€çš„ï¼Œç‰¹æ­¤æ•´ç†è¿™ç¯‡æ–‡ç« ï¼Œå¸Œæœ›èƒ½å¯¹Go <code>defer</code> åŸç†æ„Ÿå…´è¶£çš„è¯»è€…å¸¦æ¥ä¸€äº›å¸®åŠ©ã€‚</p><p>æœ¬æ–‡å…·ä½“ä¼šåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š</p><ul><li><strong><code>defer</code> æœºåˆ¶ç®€ä»‹</strong>ï¼šä»‹ç»<code>defer</code> å…³é”®å­—çš„åŸºæœ¬æ¦‚å¿µå’Œå®ƒåœ¨ Go è¯­è¨€ä¸­çš„ä½œç”¨ã€‚</li><li><strong><code>defer</code> çš„å·¥ä½œåŸç†</strong>ï¼šæ·±å…¥æ¢è®¨<code>defer</code> åœ¨å‡½æ•°æ‰§è¡Œç»“æŸæ—¶å¦‚ä½•å·¥ä½œçš„ç»†èŠ‚ã€‚</li><li><strong><code>defer</code> çš„æ‰§è¡Œé¡ºåº</strong>ï¼šè§£é‡Š<code>defer</code> è¯­å¥æ˜¯å¦‚ä½•æŒ‰ç…§åè¿›å…ˆå‡ºï¼ˆLIFOï¼‰çš„é¡ºåºæ‰§è¡Œçš„ã€‚</li><li><strong>å‚æ•°é¢„è®¡ç®—å’Œå€¼ä¼ é€’</strong>ï¼šè®¨è®º <code>defer</code>è¯­å¥ä¸­å‚æ•°æ˜¯å¦‚ä½•è¢«é¢„å…ˆè®¡ç®—å’Œä¼ é€’çš„ã€‚</li><li><strong>ç¯å¢ƒå˜é‡å’Œé—­åŒ…</strong>ï¼šæ¢è®¨ <code>defer</code>å¦‚ä½•ä¸é—­åŒ…ä¸€èµ·å·¥ä½œï¼Œä»¥åŠå¦‚ä½•æ•è·å’Œå½±å“ç¯å¢ƒå˜é‡ã€‚</li><li><strong><code>defer</code> ä¸é”™è¯¯å¤„ç†</strong>ï¼šè¯´æ˜å¦‚ä½•åˆ©ç”¨<code>defer</code> å’Œ <code>recover</code> è¿›è¡Œé”™è¯¯å¤„ç†å’Œå¼‚å¸¸æ•è·ã€‚</li><li><strong><code>defer</code> çš„å®ç°ç»†èŠ‚</strong>ï¼šæ·±å…¥åˆ†æ<code>defer</code>çš„ä¸åŒå®ç°ç­–ç•¥ï¼ŒåŒ…æ‹¬å †ä¸Šåˆ†é…ã€æ ˆä¸Šåˆ†é…å’Œå¼€æ”¾ç¼–ç ã€‚</li></ul><h1 id="ç‰ˆæœ¬å£°æ˜">ç‰ˆæœ¬å£°æ˜</h1><ul><li>Go1.22</li></ul><h1 id="æ€ç»´å¯¼å›¾">æ€ç»´å¯¼å›¾</h1><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/Go%20defer.png"alt="Go defer" /><figcaption aria-hidden="true">Go defer</figcaption></figure><h1 id="æ ¸å¿ƒè¦ç‚¹">æ ¸å¿ƒè¦ç‚¹</h1><p>å¯¹äºåé¢å°†è¦åˆ†æçš„å„ç§å„æ ·çš„æƒ…å†µï¼Œåœ¨åˆ†æçš„æ—¶å€™åªè¦éµå¾ªä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒç‚¹ï¼ŒåŸºæœ¬ä¸Šå°±ä¸ä¼šè·‘åï¼š</p><ol type="1"><li>å»¶è¿Ÿæ‰§è¡Œï¼šåœ¨å‡½æ•°ç»“æŸæ—¶æ‰§è¡Œï¼ŒåŒ…æ‹¬æ­£å¸¸è¿”å›æˆ–é­é‡ panicã€‚</li><li>æ ˆå¼æ‰§è¡Œé¡ºåºï¼šåå®šä¹‰çš„ <code>defer</code> å…ˆæ‰§è¡Œï¼ˆLIFOï¼‰ã€‚</li><li>å‚æ•°é¢„è®¡ç®—ï¼š<code>defer</code> è¯­å¥å®šä¹‰æ—¶å³è®¡ç®—å¹¶å›ºå®šå‚æ•°å€¼ã€‚</li><li>å€¼ä¼ é€’åŸåˆ™ï¼š<code>defer</code> æ‹·è´å‚æ•°ï¼Œä½¿ç”¨å®šä¹‰æ—¶çš„å€¼ã€‚</li><li>ç¯å¢ƒå˜é‡æ•è·ï¼šåœ¨ <code>defer</code>ä¸­å¯ä»¥è·Ÿä¸€ä¸ªé—­åŒ…ï¼Œé—­åŒ…å¯ä»¥æ•è·ç¯å¢ƒå˜é‡ï¼Œå½“ç„¶è¿™åŒ…æ‹¬å…·åè¿”å›å€¼ã€‚</li></ol><p>ç‰¹åˆ«è¯´æ˜çš„æ˜¯ï¼Œè™½ç„¶æˆ‘ä»¬é€šå¸¸å°† <code>defer</code>æƒ³è±¡ä¸ºä½¿ç”¨æ ˆè¿›è¡Œç®¡ç†ï¼Œä½†æ˜¯å®é™…å®ç°ä¸Šï¼Œ<code>defer</code>å¹¶ä¸éƒ½æ˜¯å­˜æ”¾åœ¨æ ˆä¸Šçš„ï¼Œæˆ‘ä»¬åé¢ä¼šå…·ä½“åˆ†æåˆ°ã€‚è¿™ç§å®ç°ç»†èŠ‚é€šå¸¸å¯¹äºç¼–å†™æ­£ç¡®çš„Goä»£ç å¹¶ä¸é‡è¦ï¼Œä½†äº†è§£è¿™ä¸€ç‚¹å¯¹äºæ·±å…¥ç†è§£è¯­è¨€å†…éƒ¨æœºåˆ¶å¯èƒ½æ˜¯æœ‰å¸®åŠ©çš„ã€‚</p><h1 id="åŸºæœ¬ç”¨æ³•">åŸºæœ¬ç”¨æ³•</h1><p>åœ¨ Go è¯­è¨€ä¸­ï¼Œ<code>defer</code>è¯­å¥é€šå¸¸ç”¨äºç¡®ä¿ä¸€ä¸ªå‡½æ•°è°ƒç”¨åœ¨ç¨‹åºæ‰§è¡Œç»“æŸæ—¶å‘ç”Ÿï¼Œå¸¸è§çš„ç”¨ä¾‹åŒ…æ‹¬æ–‡ä»¶å…³é—­ã€é”é‡Šæ”¾ã€èµ„æºå›æ”¶ç­‰ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">readFile</span><span class="hljs-params">(filename <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">error</span> &#123;<br>    f, err := os.Open(filename)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> err<br>    &#125;<br>    <span class="hljs-comment">// ç¡®ä¿æ–‡ä»¶åœ¨å‡½æ•°è¿”å›æ—¶å…³é—­</span><br>    <span class="hljs-keyword">defer</span> f.Close()<br><br>    <span class="hljs-comment">// ... å¤„ç†æ–‡ä»¶ ...</span><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ<code>defer f.Close()</code> ä¿è¯äº†æ— è®º<code>readFile</code>å‡½æ•°å¦‚ä½•è¿”å›ï¼ˆæ­£å¸¸è¿”å›æˆ–å‘ç”Ÿé”™è¯¯ï¼‰ï¼Œ<code>f.Close()</code>éƒ½ä¼šè¢«è°ƒç”¨ï¼Œä»è€Œé¿å…äº†èµ„æºæ³„éœ²ã€‚</p><h1 id="æ‰§è¡Œé¡ºåº">æ‰§è¡Œé¡ºåº</h1><p><code>defer</code>çš„æ‰§è¡Œé¡ºåºæ˜¯å…ˆè¿›åå‡ºï¼Œå³â€œæ ˆâ€æ“ä½œã€‚è¿™é‡Œå€Ÿç”¨åˆ˜ä¸¹å†°è€å¸ˆçš„ä¸€å¼ å›¾æ¥æ¼”ç¤ºè¿™ä¸ªè¿‡ç¨‹ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/1651037338287-fd17c81d-a1ad-4bc7-ae7e-eec8a264af5f.jpeg"alt="Go defer æ‰§è¡Œé¡ºåº" /><figcaption aria-hidden="true">Go defer æ‰§è¡Œé¡ºåº</figcaption></figure><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹ä»£ç è¿›è¡ŒéªŒè¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">func1</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;func1...&quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">func2</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;func2...&quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">func3</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;func3...&quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> func1()<br><span class="hljs-keyword">defer</span> func2()<br><span class="hljs-keyword">defer</span> func3()<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-function"><span class="hljs-title">func3</span></span>...<br><span class="hljs-function"><span class="hljs-title">func2</span></span>...<br><span class="hljs-function"><span class="hljs-title">func1</span></span>...<br></code></pre></td></tr></table></figure><h1 id="å‚æ•°æ±‚å€¼ä¸é™·é˜±">å‚æ•°æ±‚å€¼ä¸é™·é˜±</h1><p>å…³äº <code>defer</code>å‚æ•°è¿™ä¸€å—ï¼Œæ˜¯ä¸€ä¸ªæ¯”è¾ƒå®¹æ˜“å‡ºé”™çš„åœ°æ–¹ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼Œä½ å¯ä»¥åˆ†æä¸‹å®ƒçš„è¾“å‡ºä¼šæ˜¯ä»€ä¹ˆï¼Ÿ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">printI</span><span class="hljs-params">(i <span class="hljs-type">int</span>)</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;printI i:&quot;</span>, i)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>i := <span class="hljs-number">10</span><br><span class="hljs-keyword">defer</span> printI(i * <span class="hljs-number">10</span>)<br>i = i + <span class="hljs-number">1</span><br>fmt.Println(<span class="hljs-string">&quot;main i:&quot;</span>, i)<br>&#125;<br></code></pre></td></tr></table></figure><p>æŒ‰ç…§æˆ‘ä»¬ä¹‹å‰æ€»ç»“çš„æ ¸å¿ƒç‚¹ï¼š<strong>å‚æ•°é¢„è®¡ç®—ï¼š<code>defer</code>è¯­å¥å®šä¹‰æ—¶å³è®¡ç®—å¹¶å›ºå®šå‚æ•°å€¼</strong>ã€‚å…·ä½“æ¥è¯´ï¼Œåœ¨æŠŠ <code>defer</code>å‹å…¥â€œæ ˆâ€æ—¶ï¼Œä¼šåŒæ—¶å‹å…¥<strong>å‡½æ•°åœ°å€</strong>å’Œ<strong>å‡½æ•°å½¢å‚</strong>ï¼Œä¹Ÿå°±æ˜¯ä¼šåœ¨è¿™ä¸ªæ—¶å€™å°±æŠŠå‚æ•°å…ˆç®—å¥½ã€‚æ‰€ä»¥åœ¨æ‰§è¡Œåˆ°ç¬¬7 è¡Œä»£ç çš„æ—¶å€™ï¼Œå°±ä¼šæŠŠ <code>i*10</code> ç®—å¥½ï¼Œç„¶ååŒ<code>printI</code> ä¸€åŒå‹å…¥åˆ°å»¶è¿Ÿæ‰§è¡Œæ ˆä¸­ã€‚</p><p>æ‰€ä»¥æœ€åçš„ç»“æœå°±æ˜¯ï¼š</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-selector-tag">main</span> <span class="hljs-selector-tag">i</span>: <span class="hljs-number">11</span><br><span class="hljs-selector-tag">printI</span> <span class="hljs-selector-tag">i</span>: <span class="hljs-number">100</span><br></code></pre></td></tr></table></figure><p>å…³äº<strong>å‚æ•°å€¼ä¼ é€’</strong>ï¼Œç¬”è€…è¿™é‡Œå†ä¸¾ä¸¤ä¸ªä¾‹å­è¿›è¡Œæ¯”è¾ƒï¼Œä½“ä¼šåä½ åº”è¯¥å°±ç†è§£äº†ã€‚</p><p>ç¬¬ä¸€ä¸ªä¾‹å­ä¸­ï¼Œ<code>defer</code>åé¢å‚æ•°æ˜¯æŒ‡é’ˆï¼Œæœ¬è´¨ä¸Š<strong>å€¼ä¼ é€’</strong>ï¼Œä½†æ˜¯æ‹·è´çš„æ˜¯æŒ‡é’ˆï¼Œæ‰€ä»¥åœ¨<code>defer</code> ä¸­ä¿®æ”¹çš„ä¸œè¥¿ï¼Œæœ€åä¼šåé¦ˆåˆ°æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡ï¼Œæ‰€ä»¥å¯¹<code>testUser</code> çš„è¿”å›å€¼æ˜¯æœ‰å½±å“çš„ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span>&#123;<br>name <span class="hljs-type">string</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">testUser</span><span class="hljs-params">()</span></span> *User &#123;<br>user := &amp;User&#123;&#125;<br>user.name = <span class="hljs-string">&quot;name-1&quot;</span><br><br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(u *User)</span></span> &#123;<br>u.name = <span class="hljs-string">&quot;name-defer&quot;</span><br>&#125;(user)<br><br>user.name = <span class="hljs-string">&quot;name-2&quot;</span><br><span class="hljs-keyword">return</span> user<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>user := testUser()<br>fmt.Println(user)<br>&#125;<br><span class="hljs-comment">// &amp;&#123;name-defer&#125;</span><br></code></pre></td></tr></table></figure><p>ç¬¬äºŒä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä¼ å…¥çš„å°±æ˜¯ç»“æ„ä½“ç¤ºä¾‹æœ¬èº«äº†ï¼Œå› ä¸ºå€¼ä¼ é€’ï¼Œå³æ‹·è´äº†ä¸€ä»½æ–°çš„<code>user</code>ï¼Œæ‰€ä»¥é—­åŒ…å†…çš„ä¿®æ”¹å¯¹å¤–é¢æ˜¯ä¸äº§ç”Ÿå½±å“çš„ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> &#123;<br>name <span class="hljs-type">string</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">testUser</span><span class="hljs-params">()</span></span> User &#123;<br>user := User&#123;&#125;<br>user.name = <span class="hljs-string">&quot;name-1&quot;</span><br><br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(u User)</span></span> &#123;<br>u.name = <span class="hljs-string">&quot;name-defer&quot;</span><br>&#125;(user)<br><br>user.name = <span class="hljs-string">&quot;name-2&quot;</span><br><span class="hljs-keyword">return</span> user<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>user := testUser()<br>fmt.Println(user)<br>&#125;<br><span class="hljs-comment">// &#123;name-2&#125;</span><br></code></pre></td></tr></table></figure><h1 id="ç¯å¢ƒå˜é‡æ•è·">ç¯å¢ƒå˜é‡æ•è·</h1><p>å°†ä¸Šé¢çš„ä¸€ä¸ªä¾‹å­è¿›è¡Œç®€å•ä¿®æ”¹ï¼Œä¼šè¾“å‡ºä»€ä¹ˆå‘¢ï¼Ÿ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">printI</span><span class="hljs-params">(i <span class="hljs-type">int</span>)</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;printI i:&quot;</span>, i)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>i := <span class="hljs-number">10</span><br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>printI(i * <span class="hljs-number">10</span>)<br>&#125;()<br>i = i + <span class="hljs-number">1</span><br>fmt.Println(<span class="hljs-string">&quot;main i:&quot;</span>, i)<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™å…¶å®æ²¡æœ‰å‚æ•°ï¼Œæ‰€ä»¥ä¼šç›´æ¥å°†ä¸‹é¢é—­åŒ…å‹å…¥å»¶è¿Ÿæ ˆä¸­ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>  printI(i * <span class="hljs-number">10</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>è€Œé—­åŒ…æ˜¯å¯ä»¥æ•è·ç¯å¢ƒå˜é‡çš„ï¼Œæ‰€ä»¥åœ¨ <code>main</code> returnåï¼Œ<code>defer</code> å¯ä»¥æ•è·åˆ° <code>i</code> çš„å€¼ï¼Œä¸ºæ›´æ–°åçš„<code>i+1</code>ï¼Œæœ€åå†è¿›è¡Œ <code>printI(i * 10)</code>ã€‚</p><p>æ‰€ä»¥è¾“å‡ºç»“æœæ˜¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">main i: <span class="hljs-number">11</span><br>printI i: <span class="hljs-number">110</span><br></code></pre></td></tr></table></figure><p>æ‰€ä»¥è¯´ï¼Œ<code>defer</code>åé¢çš„é—­åŒ…ï¼Œæ˜¯å¯ä»¥æ•è·ç¯å¢ƒå˜é‡çš„ï¼Œå¦‚æœè¿™ä¸ªå˜é‡æ˜¯è¿”å›å€¼çš„è¯ï¼Œé‚£ä¹ˆç†æ‰€åº”å½“ä¹Ÿæ˜¯å¯ä»¥å¯¹å…¶äº§ç”Ÿä½œç”¨çš„ï¼Œå¦‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getI</span><span class="hljs-params">()</span></span> (i <span class="hljs-type">int</span>) &#123;<br>i = <span class="hljs-number">1</span><br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>i *= <span class="hljs-number">10</span><br>&#125;()<br><span class="hljs-keyword">return</span> <span class="hljs-number">20</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(getI())<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ä¸­ï¼Œ<code>getI</code> çš„è¿”å›å€¼æ˜¯æœ‰åå­—çš„<code>i</code>ï¼Œ<code>getI</code> æ‰§è¡Œäº†<code>return 20</code>ï¼Œå…¶å®å°±æ˜¯å°† <code>i</code> è®¾ç½®ä¸º<code>20</code>ï¼Œæ‰€ä»¥åœ¨æ‰§è¡Œåˆ° <code>defer</code> é—­åŒ…çš„æ—¶å€™ï¼Œæ•è·åˆ°äº†<code>i=20</code>ï¼Œå¹¶å°†å…¶è¿›è¡Œäº†ä¿®æ”¹ã€‚æ‰€ä»¥æœ€ç»ˆè¾“å‡ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-number">200</span><br></code></pre></td></tr></table></figure><h1 id="é”™è¯¯å¤„ç†ä¸-defer">é”™è¯¯å¤„ç†ä¸ defer</h1><p>æˆ‘ä»¬éƒ½çŸ¥é“ Go ç¨‹åºä¸­é‡åˆ° <code>panic</code>å°±ä¼šä¸­æ–­åé¢çš„æ‰§è¡Œæµç¨‹ç›´æ¥è¿”å›ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥åœ¨ <code>defer</code>ä¸­ç»“åˆ <code>recover</code> æ¥æ•è·è¿™ä¸ª<code>panic</code>ï¼Œä»è€Œä¿æŠ¤ç¨‹åºä¸å´©æºƒã€‚</p><p>å¦‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">panicAndRecover</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> err := <span class="hljs-built_in">recover</span>(); err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(err)<br>&#125;<br>&#125;()<br>fmt.Println(<span class="hljs-string">&quot;å‡½æ•°ä¸­æ­£å¸¸æµç¨‹&quot;</span>)<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;å‡ºç°å¼‚å¸¸&quot;</span>)<br>fmt.Println(<span class="hljs-string">&quot;panic åçš„è¯­å¥æ°¸è¿œæ‰§è¡Œä¸åˆ°&quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>panicAndRecover()<br>fmt.Println(<span class="hljs-string">&quot;æ­£å¸¸å›åˆ° main&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// å‡½æ•°ä¸­æ­£å¸¸æµç¨‹</span><br><span class="hljs-comment">// å‡ºç°å¼‚å¸¸</span><br><span class="hljs-comment">// æ­£å¸¸å›åˆ° main</span><br></code></pre></td></tr></table></figure><p>æ›´è¿›ä¸€æ­¥ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ <code>defer</code> ä¸­ä¹Ÿæœ‰ <code>panic</code>å‘¢ï¼Ÿè¯·æ€è€ƒä¸‹åˆ—ä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">panicAndRecover</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;ç¬¬ 1 ä¸ªå…¥æ ˆçš„ defer&quot;</span>)<br><span class="hljs-keyword">if</span> err := <span class="hljs-built_in">recover</span>(); err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;æœ€ç»ˆæ•è·çš„ panic:&quot;</span>, err)<br>&#125;<br>&#125;()<br><br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;ç¬¬ 2 ä¸ªå…¥æ ˆçš„ defer&quot;</span>)<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;ç¬¬ 2 ä¸ªå…¥æ ˆçš„ defer å‘ç”Ÿ panic&quot;</span>)<br>&#125;()<br><br>fmt.Println(<span class="hljs-string">&quot;panicAndRecover å‡½æ•°ä¸­æ­£å¸¸æµç¨‹&quot;</span>)<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;panicAndRecover å‡ºç°å¼‚å¸¸&quot;</span>)<br>fmt.Println(<span class="hljs-string">&quot;panic åçš„è¯­å¥æ°¸è¿œæ‰§è¡Œä¸åˆ°&quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>panicAndRecover()<br>fmt.Println(<span class="hljs-string">&quot;æ­£å¸¸å›åˆ° main&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬åœ¨ <code>panicAndRecover</code> å¼ºè¡ŒæŠ›å‡º<code>panic</code>ï¼Œç”±äº <code>defer</code> å…ˆè¿›åå‡ºï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šå…ˆæ‰§è¡Œç¬¬2 ä¸ª <code>defer</code>ï¼Œå…¶ä¸­ä¹Ÿå‘ç”Ÿäº† <code>panic</code>ï¼Œæˆ‘ä»¬åœ¨ç¬¬ 1 ä¸ª<code>defer</code> ä¸­å¯¹ <code>panic</code> è¿›è¡Œ<code>recover</code>ï¼Œæœ€ç»ˆçš„ç°è±¡æ˜¯åªæ•è·åˆ°äº†åé¢æŠ›å‡ºçš„<code>panic</code>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go">panicAndRecover å‡½æ•°ä¸­æ­£å¸¸æµç¨‹<br>ç¬¬ <span class="hljs-number">2</span> ä¸ªå…¥æ ˆçš„ <span class="hljs-keyword">defer</span><br>ç¬¬ <span class="hljs-number">1</span> ä¸ªå…¥æ ˆçš„ <span class="hljs-keyword">defer</span><br>æœ€ç»ˆæ•è·çš„ <span class="hljs-built_in">panic</span>: ç¬¬ <span class="hljs-number">2</span> ä¸ªå…¥æ ˆçš„ <span class="hljs-keyword">defer</span> å‘ç”Ÿ <span class="hljs-built_in">panic</span><br>æ­£å¸¸å›åˆ° main<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p>åœ¨ Go è¯­è¨€ä¸­ï¼Œ<code>panic</code> å‡½æ•°å®é™…ä¸Šæ˜¯åˆ›å»ºäº†ä¸€ä¸ª<code>panic</code> å¯¹è±¡ï¼Œå¹¶æŠ›å‡ºè¿™ä¸ªå¯¹è±¡ã€‚</p><p>å½“ä¸€ä¸ª <code>panic</code> å‘ç”Ÿå¹¶å¼€å§‹å‘ä¸Šä¼ æ’­æ—¶ï¼ŒGo è¿è¡Œæ—¶ä¼šæ£€æŸ¥æ¯ä¸ª<code>defer</code>ã€‚å¦‚æœ <code>defer</code> ä¸­åŒ…å« <code>recover</code>è°ƒç”¨ï¼Œå¹¶ä¸”å®ƒè¢«æ‰§è¡Œï¼Œé‚£ä¹ˆ <code>recover</code> ä¼šæ•è·å½“å‰çš„<code>panic</code>ï¼Œå¹¶ä¸”é˜²æ­¢å®ƒç»§ç»­å‘ä¸Šä¼ æ’­ã€‚å¦‚æœ <code>defer</code>ä¸­å†æ¬¡å‘ç”Ÿ <code>panic</code>ï¼Œé‚£ä¹ˆåŸæ¥çš„ <code>panic</code> å°±ä¸ä¼šè¢«<code>recover</code> æ•è·ï¼Œå› ä¸º <code>defer</code>å‡½æ•°å·²ç»é€€å‡ºäº†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ–°çš„ <code>panic</code>ä¼šå¯¼è‡´ç¨‹åºå´©æºƒï¼Œå› ä¸ºæ²¡æœ‰æ›´å¤šçš„ <code>defer</code> å‡½æ•°å»<code>recover</code> è¿™ä¸ªæ–°çš„ <code>panic</code>ã€‚</p><p>è¿™è¯´æ˜äº† Go ç¨‹åºä¸­ä¸å…è®¸åŒæ—¶æœ‰å¤šä¸ªæ´»è·ƒçš„ <code>panic</code>å­˜åœ¨ï¼Œè¿™ä¸ªè®¾è®¡ç¡®ä¿äº†åœ¨ä»»ä½•ç»™å®šçš„æ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ª <code>panic</code>èƒ½å¤Ÿè¢«å¤„ç†ã€‚è¿™æ ·åšæœ‰å‡ ä¸ªåŸå› ï¼š</p><ol type="1"><li><strong>ç®€åŒ–é”™è¯¯å¤„ç†ï¼š</strong> å¦‚æœåŒæ—¶å­˜åœ¨å¤šä¸ª<code>panic</code>ï¼Œå°±ä¼šå˜å¾—éå¸¸å¤æ‚å»ç¡®å®šå¦‚ä½•å¤„ç†å®ƒä»¬ï¼Œå°¤å…¶æ˜¯åœ¨å®ƒä»¬ä¹‹é—´å­˜åœ¨ä¾èµ–å…³ç³»çš„æ—¶å€™ã€‚ä¸€ä¸ª<code>panic</code>åº”è¯¥è¡¨ç¤ºä¸€ä¸ªä¸å¯æ¢å¤çš„é”™è¯¯ï¼Œå¦‚æœæœ‰å¤šä¸ªè¿™æ ·çš„é”™è¯¯åŒæ—¶å­˜åœ¨ï¼Œç¨‹åºçš„çŠ¶æ€å¯èƒ½ä¼šå˜å¾—éå¸¸ä¸ç¡®å®šã€‚</li><li><strong>ä¿æŒä¸€è‡´æ€§ï¼š</strong> <code>panic</code>é€šå¸¸è¡¨ç¤ºç¨‹åºä¸­å‡ºç°äº†ä¸¥é‡é”™è¯¯ï¼Œå¯èƒ½ä¼šç ´åç¨‹åºçš„ä¸€è‡´æ€§æˆ–å®‰å…¨æ€§ã€‚å¦‚æœå…è®¸å¤šä¸ª<code>panic</code> åŒæ—¶å­˜åœ¨ï¼Œå°±å¾ˆéš¾ä¿è¯ç¨‹åºçŠ¶æ€çš„ä¸€è‡´æ€§ï¼Œå› ä¸ºä¸åŒçš„<code>panic</code> å¯èƒ½éœ€è¦å›é€€ä¸åŒçš„æ“ä½œã€‚</li><li><strong>é¿å…èµ„æºæ³„æ¼ï¼š</strong> <code>defer</code>è¯­å¥ç”¨äºç¡®ä¿èµ„æºè¢«é‡Šæ”¾ï¼Œä¾‹å¦‚æ–‡ä»¶å’Œé”ã€‚å¦‚æœåœ¨å¤„ç†ä¸€ä¸ª <code>panic</code>çš„è¿‡ç¨‹ä¸­ï¼Œåˆå‘ç”Ÿäº†å¦ä¸€ä¸ª <code>panic</code>ï¼Œå¯èƒ½ä¼šå¯¼è‡´<code>defer</code> è¯­å¥ä¸­å‰©ä½™çš„æ¸…ç†ä»£ç æ— æ³•æ‰§è¡Œï¼Œä»è€Œå¼•èµ·èµ„æºæ³„æ¼ã€‚</li><li><strong>æ§åˆ¶æµç¨‹æ¸…æ™°ï¼š</strong> <code>panic</code> å’Œ<code>recover</code> çš„è®¾è®¡ä½¿å¾—é”™è¯¯çš„æ§åˆ¶æµç¨‹æ¸…æ™°ä¸”å¯é¢„æµ‹ã€‚ä¸€æ—¦ä¸€ä¸ª<code>panic</code> è¢« <code>recover</code>æ•è·ï¼Œç¨‹åºå¯ä»¥é€‰æ‹©æ˜¯å¦ç»§ç»­æ‰§è¡Œï¼Œæˆ–è€…æ˜¯é€šè¿‡é‡æ–° <code>panic</code>æ¥ç»ˆæ­¢ç¨‹åºã€‚è¿™ç§å†³ç­–è¿‡ç¨‹åœ¨å¤šä¸ª <code>panic</code>æƒ…å†µä¸‹ä¼šå˜å¾—å¤æ‚ä¸”éš¾ä»¥ç®¡ç†ã€‚</li></ol><p>å› æ­¤ï¼Œåœ¨ Go çš„è®¾è®¡ä¸­ï¼Œä¸å…è®¸åŒæ—¶å­˜åœ¨å¤šä¸ªæ´»è·ƒçš„<code>panic</code>ã€‚ä¸€æ—¦å‘ç”Ÿ <code>panic</code>ï¼Œå®ƒå¿…é¡»è¢«<code>recover</code>å¤„ç†ï¼Œå¦åˆ™ç¨‹åºå°†ä¼šç»ˆæ­¢ã€‚è¿™ç¡®ä¿äº†é”™è¯¯å¤„ç†çš„æ¸…æ™°æ€§å’Œç¨‹åºçš„ç¨³å®šæ€§ã€‚</p><h1 id="defer-æ”¾åœ¨å“ª">defer æ”¾åœ¨å“ª</h1><p><code>defer</code> å®é™…ä¸Šä¸ä¸€å®šæ˜¯æ”¾åœ¨æ ˆä¸Šçš„ï¼Œæˆªæ­¢Go1.22ï¼Œ<code>defer</code> å…¶å®ç”¨ 3 ç§åˆ†é…ç­–ç•¥ï¼š</p><ul><li>å †ä¸Šåˆ†é…</li><li>æ ˆä¸Šåˆ†é…</li><li>å¼€æ”¾ç¼–ç </li></ul><h2 id="æ‰§è¡Œæœºåˆ¶">æ‰§è¡Œæœºåˆ¶</h2><p>åœ¨ <ahref="https://github.com/golang/go/blob/release-branch.go1.22/src/cmd/compile/internal/ssagen/ssa.go">ssa.go</a>æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ° <code>state.stmt()</code>ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯è´Ÿè´£åœ¨ Goç¨‹åºç¼–è¯‘è¿‡ç¨‹ä¸­ä¸­é—´ä»£ç ç”Ÿæˆé˜¶æ®µæ—¶å¯¹ä¸åŒè¯­å¥çš„å¤„ç†è¿‡ç¨‹ï¼Œå…¶ä¸­å¯¹äº<code>ODEFER</code> å³ <code>defer</code> è¯­å¥çš„å¤„ç†é€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// stmt converts the statement n to SSA and adds it to s.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *state)</span></span> stmt(n ir.Node) &#123;<br>s.stmtList(n.Init())<br><span class="hljs-keyword">switch</span> n.Op() &#123;<br><span class="hljs-keyword">case</span> ir.ODEFER:<br>      n := n.(*ir.GoDeferStmt)<br>      <span class="hljs-keyword">if</span> base.Debug.Defer &gt; <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">var</span> defertype <span class="hljs-type">string</span><br>        <span class="hljs-keyword">if</span> s.hasOpenDefers &#123;<br>          defertype = <span class="hljs-string">&quot;open-coded&quot;</span><br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> n.Esc() == ir.EscNever &#123;<br>          defertype = <span class="hljs-string">&quot;stack-allocated&quot;</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          defertype = <span class="hljs-string">&quot;heap-allocated&quot;</span><br>        &#125;<br>        base.WarnfAt(n.Pos(), <span class="hljs-string">&quot;%s defer&quot;</span>, defertype)<br>      &#125;<br>...<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œæ€»å…±æœ‰ 3 ç§åˆ†é…ç­–ç•¥ï¼š</p><ul><li><strong>open-coded</strong>: s.hasOpenDefers == true</li><li><strong>stack-allocated</strong>: n.Esc() == ir.EscNever</li><li><strong>heap-allocated</strong>: é»˜è®¤</li></ul><p>é»˜è®¤æ˜¯å †åˆ†é…ï¼Œåœ¨ Go1.13ä»¥å‰ï¼Œä¹Ÿåªæœ‰å †åˆ†é…è¿™ä¸€ç§ç­–ç•¥ï¼Œä¸è¿‡è¯¥å®ç°çš„æ€§èƒ½è¾ƒå·®ã€‚Go è¯­è¨€åœ¨ 1.13ä¸­å¼•å…¥æ ˆä¸Šåˆ†é…çš„ç»“æ„ä½“ï¼Œ<ahref="https://go-review.googlesource.com/c/go/+/171758">å‡å°‘äº† 30%çš„é¢å¤–å¼€é”€</a>ï¼Œå¹¶åœ¨ 1.14 ä¸­å¼•å…¥äº†åŸºäºå¼€æ”¾ç¼–ç çš„<code>defer</code>ï¼Œä½¿å¾—è¯¥å…³é”®å­—çš„é¢å¤–å¼€é”€<ahref="https://go-review.googlesource.com/c/go/+/190098/6">å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡</a>ã€‚</p><p>æœ¬æ–‡ä¸­ä¸å¯¹å…·ä½“çš„åˆ†é…æœºåˆ¶è¿›è¡Œåˆ†æï¼Œè¿™ä¸€å—ä¼šæ¯”è¾ƒå¤æ‚ï¼Œç¬”è€…æœ¬èº«ä¹Ÿä¸æ˜¯å¾ˆæ„Ÿå…´è¶£ï¼Œä¾¿å†³å®šå¯¹æ­¤ä¸è¿‡åˆ†æ·±ç©¶ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…æ¨èè¯¦ç»†é˜…è¯»ã€ŠGoè¯­è¨€è®¾è®¡ä¸å®ç°ã€‹ä¸­å…³äº <code>defer</code>å…³é”®å­—çš„åˆ†æï¼šhttps://draveness.me/golang/docs/part2-foundation/ch05-keyword/golang-defer/ã€‚</p><p>æœ¬æ–‡åªè®¨è®ºä»€ä¹ˆæƒ…å†µä¸‹ä¼šä½¿ç”¨ä»€ä¹ˆåˆ†é…ç­–ç•¥ã€‚ç”±äºå †åˆ†é…æ˜¯é»˜è®¤çš„ï¼Œæˆ‘ä»¬å°±ä¸ä½œåˆ†æäº†ï¼Œå…·ä½“æ¥çœ‹çœ‹<code>s.hasOpenDefers == true</code> å’Œ<code>n.Esc() == ir.EscNever</code> ä»€ä¹ˆæ—¶å€™ä¼šæˆç«‹ã€‚</p><h2 id="æ ˆä¸Šåˆ†é…">æ ˆä¸Šåˆ†é…</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹æ ˆä¸Šåˆ†é…ï¼Œè¦æ»¡è¶³æ ˆä¸Šåˆ†é…ï¼Œåˆ™éœ€è¦æ»¡è¶³<code>n.Esc() == ir.EscNever</code>ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">const</span> (<br>EscUnknown = <span class="hljs-literal">iota</span><br>EscNone    <span class="hljs-comment">// Does not escape to heap, result, or parameters.</span><br>EscHeap    <span class="hljs-comment">// Reachable from the heap</span><br>EscNever   <span class="hljs-comment">// By construction will not escape.</span><br>)<br></code></pre></td></tr></table></figure><p>å½“ <code>n</code> çš„é€ƒé€¸åˆ†æç»“æœæ˜¯ <code>ir.EscNever</code>ï¼Œåˆ™è¡¨æ˜è¯¥<code>defer</code>è¯­å¥ä»ä¸é€ƒé€¸ï¼ˆä¸ä¼šåœ¨å‡½æ•°è°ƒç”¨ç»“æŸåä»ç„¶è¢«å¼•ç”¨ï¼‰ï¼Œè¿™ç§æƒ…å†µä¸‹<code>defer</code> å°†è¢«åˆ†é…åˆ°æ ˆä¸Šï¼ˆstack-allocatedï¼‰ã€‚å¦åˆ™ï¼Œå¦‚æœ<code>defer</code> é€ƒé€¸äº†ï¼Œå°±ä¼šè¢«åˆ†é…åˆ°å †ä¸Šï¼ˆheap-allocatedï¼‰ã€‚</p><p>é‚£ <code>defer</code> è¯­å¥ä»€ä¹ˆæ—¶å€™ä¼šé€ƒé€¸å‘¢ï¼Ÿ</p><blockquote><p>åœ¨ Goä¸­ï¼Œä¸€ä¸ªå˜é‡çš„é€ƒé€¸æ„å‘³ç€å®ƒçš„ç”Ÿå‘½å‘¨æœŸè¶…å‡ºäº†å½“å‰å‡½æ•°çš„èŒƒå›´ã€‚åœ¨å‡½æ•°å†…å®šä¹‰çš„å˜é‡é€šå¸¸åˆ†é…åœ¨æ ˆä¸Šï¼Œè€Œåœ¨å †ä¸Šåˆ†é…å†…å­˜éœ€è¦æ›´å¤æ‚çš„ç®¡ç†ã€‚åœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨å¯èƒ½ä¼šé€‰æ‹©å°†å˜é‡åˆ†é…åœ¨å †ä¸Šï¼Œè¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬ç§°ä¹‹ä¸ºé€ƒé€¸ã€‚</p></blockquote><p>å¯¹äº <code>defer</code> è¯­å¥ï¼Œå¦‚æœå®ƒå¼•ç”¨äº†å‡½æ•°å¤–çš„å˜é‡ï¼Œè¿™ä¸ª<code>defer</code> å°±ä¼šé€ƒé€¸ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> x = <span class="hljs-number">10</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">someFunction</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        fmt.Println(x) <span class="hljs-comment">// è¿™é‡Œå¼•ç”¨äº†å¤–éƒ¨å˜é‡ x</span><br>    &#125;()<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>defer</code> å‡½æ•°å†…éƒ¨å¼•ç”¨äº† <code>x</code>è¿™ä¸ªå¤–éƒ¨å˜é‡ï¼Œå› æ­¤ <code>defer</code> è¯­å¥éœ€è¦ç¡®ä¿ <code>x</code> åœ¨<code>defer</code> å‡½æ•°æ‰§è¡Œæ—¶ä»ç„¶æœ‰æ•ˆã€‚ä¸ºäº†æ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼Œç¼–è¯‘å™¨å¯èƒ½ä¼šå°†<code>x</code> åˆ†é…åœ¨å †ä¸Šï¼Œè€Œä¸æ˜¯æ ˆä¸Šã€‚</p><h2 id="å¼€æ”¾ç¼–ç ">å¼€æ”¾ç¼–ç </h2><p>å…ˆç»™ç»“è®ºï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œè¦ä½¿ç”¨å¼€æ”¾ç¼–ç ç­–ç•¥ï¼Œä½ åªéœ€è¦å…³æ³¨ä»¥ä¸‹ 4ç‚¹å³å¯ï¼š</p><ol type="1"><li>å‡½æ•°çš„ <code>defer</code> æ•°é‡ä¸èƒ½è¶…è¿‡ 8 ä¸ªï¼›</li><li>å‡½æ•°çš„ <code>defer</code> å…³é”®å­—ä¸èƒ½åœ¨å¾ªç¯ä¸­æ‰§è¡Œï¼›</li><li>å‡½æ•°çš„ <code>defer</code> ä¸­ä¸èƒ½å‘ç”Ÿé€ƒé€¸ï¼›</li><li>å‡½æ•°çš„ <code>return</code> è¯­å¥ä¸ <code>defer</code>è¯­å¥çš„ä¹˜ç§¯å°äºæˆ–è€…ç­‰äº 15 ä¸ªï¼›</li></ol><hr /><p>Okï¼Œä¸‹é¢æ˜¯å…·ä½“çš„åˆ†æè¿‡ç¨‹ã€‚</p><p>å€ŸåŠ© Goland çš„èƒ½åŠ›ï¼Œå°†é¼ æ ‡å…‰æ ‡æ”¾åœ¨ <code>s.hasOpenDefers</code>ä¸Šï¼ŒæŒ‰ä½ <strong>Command</strong>åŠ ç‚¹å‡»é¼ æ ‡ï¼Œå¯ä»¥çœ‹åˆ°è¯¥å±æ€§çš„ä½¿ç”¨æƒ…å†µï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/imgimage-20240328133312845-20240328202233278.png"alt="s.hasOpenDefers" /><figcaption aria-hidden="true">s.hasOpenDefers</figcaption></figure><p>å¯ä»¥çœ‹åˆ°è¯¥å±æ€§çš„åˆ¤æ–­é€»è¾‘éƒ½åœ¨ <ahref="https://github.com/golang/go/blob/release-branch.go1.22/src/cmd/compile/internal/ssagen/ssa.go">ssa.go</a>æ–‡ä»¶ä¸­çš„ <code>buildssa()</code>å‡½æ•°ä¸­ã€‚å»æ‰ä¸€äº›æ— å…³çš„ä»£ç ï¼Œæ ¸å¿ƒé€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// buildssa builds an SSA function for fn.</span><br><span class="hljs-comment">// worker indicates which of the backend workers is doing the processing.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">buildssa</span><span class="hljs-params">(fn *ir.Func, worker <span class="hljs-type">int</span>)</span></span> *ssa.Func &#123;<br>...<br>  <span class="hljs-comment">// â‘ </span><br>s.hasOpenDefers = base.Flag.N == <span class="hljs-number">0</span> &amp;&amp; s.hasdefer &amp;&amp; !s.curfn.OpenCodedDeferDisallowed()<br><span class="hljs-keyword">switch</span> &#123;<br>  <span class="hljs-comment">// â‘¡</span><br><span class="hljs-keyword">case</span> base.Debug.NoOpenDefer != <span class="hljs-number">0</span>:<br>s.hasOpenDefers = <span class="hljs-literal">false</span><br><span class="hljs-keyword">case</span> s.hasOpenDefers &amp;&amp; (base.Ctxt.Flag_shared || base.Ctxt.Flag_dynlink) &amp;&amp; base.Ctxt.Arch.Name == <span class="hljs-string">&quot;386&quot;</span>:<br>    <span class="hljs-comment">// â‘¢</span><br><span class="hljs-comment">// Don&#x27;t support open-coded defers for 386 ONLY when using shared</span><br><span class="hljs-comment">// libraries, because there is extra code (added by rewriteToUseGot())</span><br><span class="hljs-comment">// preceding the deferreturn/ret code that we don&#x27;t track correctly.</span><br>s.hasOpenDefers = <span class="hljs-literal">false</span><br>&#125;<br>  <span class="hljs-comment">// â‘£</span><br><span class="hljs-keyword">if</span> s.hasOpenDefers &amp;&amp; <span class="hljs-built_in">len</span>(s.curfn.Exit) &gt; <span class="hljs-number">0</span> &#123;<br><span class="hljs-comment">// Skip doing open defers if there is any extra exit code (likely</span><br><span class="hljs-comment">// race detection), since we will not generate that code in the</span><br><span class="hljs-comment">// case of the extra deferreturn/ret segment.</span><br>s.hasOpenDefers = <span class="hljs-literal">false</span><br>&#125;<br>  <span class="hljs-comment">// â‘¤</span><br><span class="hljs-keyword">if</span> s.hasOpenDefers &#123;<br><span class="hljs-comment">// Similarly, skip if there are any heap-allocated result</span><br><span class="hljs-comment">// parameters that need to be copied back to their stack slots.</span><br><span class="hljs-keyword">for</span> _, f := <span class="hljs-keyword">range</span> s.curfn.Type().Results().FieldSlice() &#123;<br><span class="hljs-keyword">if</span> !f.Nname.(*ir.Name).OnStack() &#123;<br>s.hasOpenDefers = <span class="hljs-literal">false</span><br><span class="hljs-keyword">break</span><br>&#125;<br>&#125;<br>&#125;<br>  <span class="hljs-comment">// â‘¥</span><br><span class="hljs-keyword">if</span> s.hasOpenDefers &amp;&amp;<br>s.curfn.NumReturns*s.curfn.NumDefers &gt; <span class="hljs-number">15</span> &#123;<br><span class="hljs-comment">// Since we are generating defer calls at every exit for</span><br><span class="hljs-comment">// open-coded defers, skip doing open-coded defers if there are</span><br><span class="hljs-comment">// too many returns (especially if there are multiple defers).</span><br><span class="hljs-comment">// Open-coded defers are most important for improving performance</span><br><span class="hljs-comment">// for smaller functions (which don&#x27;t have many returns).</span><br>s.hasOpenDefers = <span class="hljs-literal">false</span><br>&#125;<br>  ...<br><span class="hljs-keyword">return</span> s.f<br>&#125;<br><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ€»å…±æœ‰ 6ä¸ªæ¡ä»¶ï¼Œæˆ‘å·²åœ¨æ³¨é‡Šä¸­è¿›è¡Œæ ‡æ³¨ï¼Œæˆ‘ä»¬æ¥è¿›è¡Œé€ä¸€åˆ†æï¼š</p><h3 id="base.flag.n-0-s.hasdefer-s.curfn.opencodeddeferdisallowed">â‘ base.Flag.N == 0 &amp;&amp; s.hasdefer &amp;&amp;!s.curfn.OpenCodedDeferDisallowed()</h3><blockquote><p>å¦‚æœ<code>base.Flag.N</code> ç­‰äº 0ä¸”å½“å‰å‡½æ•°æœ‰å»¶è¿Ÿè°ƒç”¨ä¸”æ²¡æœ‰ç¦æ­¢å¼€æ”¾å¼å»¶è¿Ÿï¼Œé‚£ä¹ˆè®¾ç½®<code>s.hasOpenDefers</code>ä¸º<code>true</code>ã€‚</p></blockquote><p>åœ¨ Goç¼–è¯‘å™¨ä¸­ï¼Œ<code>-N</code>æ ‡å¿—é€šå¸¸ç”¨äºç¦ç”¨ä¼˜åŒ–ã€‚åœ¨è¿™æ®µä»£ç ä¸­ï¼Œå¦‚æœ<code>base.Flag.N</code>ç­‰äº0ï¼Œæ„å‘³ç€æ²¡æœ‰ç¦ç”¨ä¼˜åŒ–ï¼Œå› æ­¤ç¼–è¯‘å™¨å¯èƒ½ä¼šå°è¯•ä½¿ç”¨æ›´é«˜çº§çš„ä¼˜åŒ–æŠ€æœ¯ï¼Œæ¯”å¦‚å¼€æ”¾å¼å»¶è¿Ÿï¼ˆopen-codeddefersï¼‰ã€‚</p><p><code>OpenCodedDeferDisallowed()</code>å³ç¦ç”¨å¼€æ”¾ç¼–ç ï¼Œå®ƒçš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">const</span> funcOpenCodedDeferDisallowed <span class="hljs-comment">// can&#x27;t do open-coded defers</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f *Func)</span></span> OpenCodedDeferDisallowed() <span class="hljs-type">bool</span> &#123; <span class="hljs-keyword">return</span> f.flags&amp;funcOpenCodedDeferDisallowed != <span class="hljs-number">0</span> &#125;<br></code></pre></td></tr></table></figure><p>æŒ‰ä½ Command åç‚¹å‡» <code>funcOpenCodedDeferDisallowed</code>å¯ä»¥çœ‹åˆ°åªæœ‰ <code>funcOpenCodedDeferDisallowed(b)</code>å¯ä»¥ä¿®æ”¹å®ƒçš„å€¼ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/imgimage-20240328140733594.png"alt="funcOpenCodedDeferDisallowed" /><figcaption aria-hidden="true">funcOpenCodedDeferDisallowed</figcaption></figure><p>æˆ‘ä»¬æ¥çœ‹çœ‹å“ªä¸ªåœ°æ–¹ä¼šè°ƒç”¨<code>funcOpenCodedDeferDisallowed()</code>ï¼Œå¹¶å°†<code>funcOpenCodedDeferDisallowed</code> è®¾ç½®ä¸º <code>true</code>ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/imgimage-20240328140859879.png"alt="å°† funcOpenCodedDeferDisallowed è®¾ç½®ä¸º true çš„åœ°æ–¹" /><figcaption aria-hidden="true">å°† funcOpenCodedDeferDisallowed è®¾ç½®ä¸ºtrue çš„åœ°æ–¹</figcaption></figure><p>è°ƒç”¨å®ƒçš„åœ°æ–¹åœ¨ <ahref="https://github.com/golang/go/blob/release-branch.go1.22/src/cmd/compile/internal/walk/stmt.go">stmt.go</a>æ–‡ä»¶ä¸­çš„ <code>walkStmt()</code> å‡½æ•°ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// The max number of defers in a function using open-coded defers. We enforce this</span><br><span class="hljs-comment">// limit because the deferBits bitmask is currently a single byte (to minimize code size)</span><br><span class="hljs-keyword">const</span> maxOpenDefers = <span class="hljs-number">8</span><br><br><span class="hljs-comment">// The result of walkStmt MUST be assigned back to n, e.g.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//n.Left = walkStmt(n.Left)</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">walkStmt</span><span class="hljs-params">(n ir.Node)</span></span> ir.Node &#123;<br>  ...<br><span class="hljs-keyword">switch</span> n.Op() &#123;<br>    ...<br>    <span class="hljs-keyword">case</span> ir.ODEFER:<br>      n := n.(*ir.GoDeferStmt)<br>      ir.CurFunc.SetHasDefer(<span class="hljs-literal">true</span>)<br>      ir.CurFunc.NumDefers++<br>      <span class="hljs-keyword">if</span> ir.CurFunc.NumDefers &gt; maxOpenDefers &#123;<br>        <span class="hljs-comment">// Don&#x27;t allow open-coded defers if there are more than</span><br>        <span class="hljs-comment">// 8 defers in the function, since we use a single</span><br>        <span class="hljs-comment">// byte to record active defers.</span><br>        ir.CurFunc.SetOpenCodedDeferDisallowed(<span class="hljs-literal">true</span>)<br>      &#125;<br>      <span class="hljs-keyword">if</span> n.Esc() != ir.EscNever &#123;<br>        <span class="hljs-comment">// If n.Esc is not EscNever, then this defer occurs in a loop,</span><br>        <span class="hljs-comment">// so open-coded defers cannot be used in this function.</span><br>        ir.CurFunc.SetOpenCodedDeferDisallowed(<span class="hljs-literal">true</span>)<br>      &#125;<br>      <span class="hljs-keyword">fallthrough</span><br>    ...<br>  &#125;<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€ç‚¹æ˜¯ï¼šå½“å‰å‡½æ•°ä¸­ <code>defer</code> ä¸ªæ•°è¶…è¿‡ 8çš„è¯ï¼Œåˆ™ç¦ç”¨å¼€æ”¾ç¼–ç ã€‚</p><p>ç¬¬äºŒç‚¹æ˜¯å½“ <code>n.Esc() != ir.EscNever</code>ä½¿ï¼Œå°±ç¦ç”¨å¼€æ”¾ç¼–ç ã€‚è¿™ä¸ªè¦æ±‚è·Ÿå‰é¢åˆ†æçš„â€œæ ˆä¸Šåˆ†é…â€è¦æ±‚æ˜¯ä¸€æ ·çš„ã€‚</p><p>è¿™é‡Œå†è¡¥å……ä¸€ç‚¹ï¼šä»€ä¹ˆæ—¶å€™ <code>n.Esc()</code> ä¼šè¢«è®¾ç½®ä¸º<code>ir.EscNever</code> å‘¢ï¼Ÿ</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/imgimage-20240328192005520.png"alt="n.SetEsc(ir.EscNever)" /><figcaption aria-hidden="true">n.SetEsc(ir.EscNever)</figcaption></figure><p>è¿™é‡Œé¢æ ¸å¿ƒç‚¹æ˜¯ç¬¬ä¸€ä¸ªï¼Œå®ƒå¯¹åº”çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *escape)</span></span> goDeferStmt(n *ir.GoDeferStmt) &#123;<br>k := e.heapHole()<br><span class="hljs-keyword">if</span> n.Op() == ir.ODEFER &amp;&amp; e.loopDepth == <span class="hljs-number">1</span> &#123;<br>...<br>n.SetEsc(ir.EscNever)<br>&#125;<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><p><code>e.loopDepth == 1</code> æ—¶å°±è®¾ç½®ï¼Œæ¢è¨€ä¹‹ï¼Œ<code>defer</code>ä¸åœ¨å¾ªç¯ä¸­çš„æ—¶å€™ï¼Œæ‰å…è®¸å¼€æ”¾ç¼–ç ã€‚</p><p>æ€»è€Œè¨€ä¹‹ï¼Œç¬¬ â‘  ä¸ªæ¡ä»¶çº¦æŸäº†è¦é‡‡ç”¨<code>open-coded å¼€æ”¾ç¼–ç </code>ç­–ç•¥çš„ 3 ä¸ªæ¡ä»¶ï¼š</p><ol type="1"><li>å‡½æ•°ä¸­ <code>defer</code> ä¸ªæ•°ä¸èƒ½è¶…è¿‡ <strong>8</strong>ï¼›</li><li><code>defer</code> ä¸èƒ½åœ¨å¾ªç¯ä¸­ï¼›</li><li><code>defer</code> ä¸èƒ½å‘ç”Ÿé€ƒé€¸ã€‚</li></ol><h3 id="base.debug.noopendefer-0">â‘¡ base.Debug.NoOpenDefer != 0</h3><blockquote><p>å¦‚æœ<code>base.Debug.NoOpenDefer</code>ä¸ä¸º0ï¼Œé‚£ä¹ˆç¦ç”¨å¼€æ”¾å¼å»¶è¿Ÿã€‚</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">NoOpenDefer           <span class="hljs-type">int</span>    <span class="hljs-string">`help:&quot;disable open-coded defers&quot; concurrent:&quot;ok&quot;`</span><br></code></pre></td></tr></table></figure><h3id="base.ctxt.flag_shared-base.ctxt.flag_dynlink-base.ctxt.arch.name-386">â‘¢(base.Ctxt.Flag_shared || base.Ctxt.Flag_dynlink) &amp;&amp;base.Ctxt.Arch.Name == "386"</h3><blockquote><p>å¦‚æœå½“å‰æ¶æ„æ˜¯<code>386</code>ï¼Œå¹¶ä¸”ä½¿ç”¨å…±äº«åº“æˆ–åŠ¨æ€é“¾æ¥ï¼Œé‚£ä¹ˆä¸æ”¯æŒå¼€æ”¾å¼å»¶è¿Ÿï¼Œå› ä¸ºå­˜åœ¨ä¸€äº›é¢å¤–çš„ä»£ç ï¼ˆç”±<code>rewriteToUseGot()</code>æ·»åŠ ï¼‰å¯èƒ½æ— æ³•æ­£ç¡®è¿½è¸ªã€‚</p></blockquote><h3 id="lens.curfn.exit">â‘£ len(s.curfn.Exit)</h3><blockquote><p>å¦‚æœå­˜åœ¨ä»»ä½•é¢å¤–çš„é€€å‡ºä»£ç ï¼ˆæ¯”å¦‚å¯èƒ½æ˜¯ç«æ€æ£€æµ‹ç›¸å…³çš„ä»£ç ï¼‰ï¼Œåˆ™è·³è¿‡å¼€æ”¾å¼å»¶è¿Ÿã€‚</p></blockquote><h3 id="f.nname.ir.name.onstack">â‘¤ !f.Nname.(*ir.Name).OnStack()</h3><blockquote><p>å¦‚æœæœ‰ä»»ä½•å †åˆ†é…çš„ç»“æœå‚æ•°éœ€è¦å¤åˆ¶å›å®ƒä»¬çš„æ ˆæ§½ï¼Œä¹Ÿè·³è¿‡å¼€æ”¾å¼å»¶è¿Ÿã€‚</p></blockquote><h3 id="s.curfn.numreturnss.curfn.numdefers-15">â‘¥s.curfn.NumReturns*s.curfn.NumDefers &gt; 15</h3><blockquote><p>å¦‚æœå‡½æ•°çš„è¿”å›æ•°ä¹˜ä»¥å»¶è¿Ÿè°ƒç”¨æ•°å¤§äº<strong>15</strong>ï¼Œè€ƒè™‘åˆ°æ¯ä¸ªé€€å‡ºç‚¹éƒ½è¦ç”Ÿæˆå»¶è¿Ÿè°ƒç”¨ï¼Œå¹¶ä¸”å¼€æ”¾å¼å»¶è¿Ÿå¯¹äºå°å‡½æ•°ï¼ˆæ²¡æœ‰å¤šä¸ªè¿”å›ï¼‰çš„æ€§èƒ½æå‡æœ€ä¸ºé‡è¦ï¼Œæ‰€ä»¥åœ¨è¿™ç§æƒ…å†µä¸‹ä¹Ÿä¸ä½¿ç”¨å¼€æ”¾å¼å»¶è¿Ÿã€‚</p></blockquote><h2 id="å †ä¸Šåˆ†é…">å †ä¸Šåˆ†é…</h2><p>å½“ä¸æ»¡è¶³å¼€æ”¾ç¼–ç å’Œæ ˆä¸Šåˆ†é…çš„æ—¶å€™ï¼Œé»˜è®¤å°±æ˜¯å †ä¸Šåˆ†é…ï¼ˆheap-allocatedï¼‰ï¼Œæ€§èƒ½æœ€å·®ï¼Œè¿™é‡Œä¸åšåˆ†æã€‚</p><hr /><p>ä»¥ä¸Šå°±æ˜¯æœ¬æ–‡å…³äº Go è¯­è¨€ä¸­ <code>defer</code> å…³é”®å­—çš„å…·ä½“åˆ†æï¼ŒHappyCoding! Peace~</p><h1 id="å‚è€ƒ">å‚è€ƒ</h1><ul><li><a href="https://book.douban.com/subject/36403287/">æ·±å…¥ç†è§£ Goè¯­è¨€</a></li><li><a href="https://book.douban.com/subject/35556889/">Goè¯­è¨€åº•å±‚åŸç†å‰–æ</a></li><li><ahref="https://draveness.me/golang/docs/part2-foundation/ch05-keyword/golang-defer/">Goè¯­è¨€è®¾è®¡ä¸å®ç°</a></li><li>ChatGPT4</li></ul>]]></content>
    
    
    <summary type="html">æœ¬æ–‡å°†æ·±å…¥æµ…å‡ºåœ°ä»‹ç» defer çš„å·¥ä½œåŸç†ï¼Œæ¢ç©¶å…¶èƒŒåçš„æœºåˆ¶ï¼Œå¹¶é€šè¿‡ä¸°å¯Œçš„æ¡ˆä¾‹æ¥å±•ç¤ºå®ƒçš„å®é™…åº”ç”¨ã€‚</summary>
    
    
    
    <category term="Go" scheme="https://hedon.top/categories/Go/"/>
    
    
    <category term="Go" scheme="https://hedon.top/tags/Go/"/>
    
  </entry>
  
</feed>
