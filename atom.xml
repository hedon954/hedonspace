<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>HedonWang</title>
  
  <subtitle>å›å­æ±‚è¯¸å·±ï¼Œå¾‹å·±åˆ™å®‰ã€‚</subtitle>
  <link href="https://hedon.top/atom.xml" rel="self"/>
  
  <link href="https://hedon.top/"/>
  <updated>2025-11-17T07:32:27.379Z</updated>
  <id>https://hedon.top/</id>
  
  <author>
    <name>Hedon Wang</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Go åº•å±‚åŸç†ä¸¨åƒåœ¾å›æ”¶</title>
    <link href="https://hedon.top/2025/11/17/go/go-gc/"/>
    <id>https://hedon.top/2025/11/17/go/go-gc/</id>
    <published>2025-11-17T07:30:00.000Z</published>
    <updated>2025-11-17T07:32:27.379Z</updated>
    
    <content type="html"><![CDATA[]]></content>
    
    
    <summary type="html">æœ¬æ–‡åŸºäº Go 1.25.3 æºç ï¼Œä»ç¬¬ä¸€æ€§åŸç†å‡ºå‘ï¼Œæ·±å…¥æ¢è®¨ Go çš„åƒåœ¾å›æ”¶æœºåˆ¶ï¼ŒåŒ…æ‹¬åƒåœ¾å›æ”¶çš„åŸç†ã€å®ç°ç»†èŠ‚ã€ä½¿ç”¨åœºæ™¯ä»¥åŠæœ€æ–°ç‰¹æ€§ã€‚</summary>
    
    
    
    <category term="Go" scheme="https://hedon.top/categories/Go/"/>
    
    
    <category term="Go" scheme="https://hedon.top/tags/Go/"/>
    
    <category term="åƒåœ¾å›æ”¶" scheme="https://hedon.top/tags/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/"/>
    
  </entry>
  
  <entry>
    <title>Go åº•å±‚åŸç†ä¸¨å†…å­˜æ¨¡å‹</title>
    <link href="https://hedon.top/2025/11/17/go/go-memory-model/"/>
    <id>https://hedon.top/2025/11/17/go/go-memory-model/</id>
    <published>2025-11-17T06:30:00.000Z</published>
    <updated>2025-11-17T07:30:47.829Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>[!NOTE]</p><p>ğŸ’¡ æœ¬æ–‡åŸºäº Go 1.25.3 æºç ç¼–å†™ï¼Œç›¸æ¯” Go 1.16 ç‰ˆæœ¬ï¼Œå¢åŠ äº† UserArenaã€Weak Pointerã€Cleanupæœºåˆ¶ç­‰é‡è¦ç‰¹æ€§ã€‚åç»­ç‰ˆæœ¬å¯èƒ½ä¼šæœ‰å˜åŒ–ã€‚å»ºè®®ç»“åˆå®é™…ä½¿ç”¨çš„ Goç‰ˆæœ¬é˜…è¯»ç›¸å…³æºç ã€‚</p></blockquote><h2 id="ç»“è®ºå…ˆè¡Œ">ç»“è®ºå…ˆè¡Œ</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/68747470733a2f2f747661312e73696e61696d672e636e2f6c617267652f6536633964323465677931683575666b306f3079756a3231657a3075303736662e6a7067.jpeg"alt="Goå†…å­˜æ¨¡å‹æ¶æ„" /><figcaption aria-hidden="true">Goå†…å­˜æ¨¡å‹æ¶æ„</figcaption></figure><p>Go çš„å†…å­˜åˆ†é…å™¨è®¾è®¡æºäº<strong>TCMalloc</strong>ï¼Œé‡‡ç”¨äº†å¤šå±‚çº§ç¼“å­˜æ¶æ„æ¥å‡å°‘é”ç«äº‰å¹¶æé«˜æ€§èƒ½ã€‚æ ¸å¿ƒè®¾è®¡å¦‚ä¸‹ï¼š</p><h3 id="æ ¸å¿ƒæ¶æ„">æ ¸å¿ƒæ¶æ„</h3><ul><li>Go å°†å †å†…å­˜æŠ½è±¡ä¸º <strong>mheap</strong> ç»“æ„ä½“ï¼›</li><li>Go è¿›ç¨‹ä¼šä»è™šæ‹Ÿå†…å­˜ä¸­ç”³è¯· n ä¸ª<strong>heapArena</strong>ï¼ˆ64ä½ç³»ç»Ÿæ¯ä¸ª 64MBï¼‰ï¼›</li><li>æ¯ä¸ª heapArena è¢«æŒ‰éœ€åˆ’åˆ†æˆä¸åŒ class çš„<strong>mspan</strong>ï¼Œå…±æœ‰ <strong>68</strong> ä¸ª size classï¼›</li><li>æ¯ä¸ª mspan ç”± n ä¸ªç›¸åŒå¤§å°çš„ span ç»„æˆï¼›</li><li>ä¸ºäº†å¿«é€Ÿå®šä½åˆé€‚çš„ spanï¼Œä¸º mheap å»ºç«‹äº† <strong>136</strong>ä¸ªä¸­å¤®ç´¢å¼• <strong>mcentral</strong>ï¼›</li><li>æ¯ä¸ª mcentral å­˜å‚¨å¯¹åº” class çš„ mspanï¼Œæ¯ç§ mspan åˆåˆ’åˆ†ä¸º gc scanå’Œ no scan ä¸¤ç§ï¼Œæ•…å…±æœ‰ 68 Ã— 2 = 136 ä¸ª mcentralï¼›</li><li>ä¸ºäº†è§£å†³ä¸­å¤®ç´¢å¼•çš„å¹¶å‘é”ç«äº‰é—®é¢˜ï¼Œä¸ºæ¯ä¸€ä¸ª Pï¼ˆçº¿ç¨‹ï¼‰å»ºç«‹ä¸€ä¸ªæœ¬åœ°ç¼“å­˜<strong>mcache</strong>ï¼›</li><li>æ¯ä¸ª mcache å­˜å‚¨ <strong>136</strong> ä¸ª spanï¼Œåˆ†åˆ«æ˜¯æ¯ç§ class çš„mspan çš„ä¸€ä¸ª scan å’Œ noscan çš„ spanã€‚</li></ul><h3 id="å†…å­˜åˆ†é…ç­–ç•¥">å†…å­˜åˆ†é…ç­–ç•¥</h3><ul><li>Go ä¸­æ ¹æ®å¯¹è±¡å¤§å°åˆ†ä¸º <strong>tiny</strong>ã€<strong>small</strong>å’Œ <strong>large</strong> ä¸‰ç§å¯¹è±¡ï¼›</li><li>tiny (0~16B æ— æŒ‡é’ˆ) å¯¹è±¡ä¸»è¦åˆ†é…åˆ° class 2 çš„ span ä¸­ï¼ˆé€šè¿‡ tinyallocatorï¼‰ï¼›</li><li>small (16B~32KB) å¯¹è±¡ä¼šè¢«åˆ†é…åˆ° class 2 ~ class 67 çš„ span ä¸­ï¼›</li><li>class 1 (8B) ä»…ç”¨äº 64 ä½å¹³å°ä¸Šçš„å•æŒ‡é’ˆå¯¹è±¡ï¼Œä½¿ç”¨æå°‘ï¼›</li><li>large (&gt;32KB) å¯¹è±¡ä¼šé‡èº«å®šåšåˆ†é…åˆ° class0 çš„ span ä¸­ï¼Œç›´æ¥ä»mheap ä¸Šç”³è¯·ï¼›</li><li>ä¸ºå¯¹è±¡åˆ†é…å†…å­˜æ—¶ï¼Œä¼šå…ˆä» mcache ä¸Šæ‰¾ spanï¼Œæ‰¾ä¸åˆ°å°±å» mcentralä¸Šäº¤æ¢ï¼Œè¿˜æ‰¾ä¸åˆ°å°±å» mheap ä¸Šç”³è¯·ï¼Œæœ€åæ‰¾ä¸åˆ°å°± OOMã€‚</li></ul><h2 id="ä¸€åç¨‹æ ˆ">ä¸€ã€åç¨‹æ ˆ</h2><h3 id="ä½œç”¨">1.1 ä½œç”¨</h3><p>åç¨‹æ ˆæ˜¯ Go åç¨‹æ‰§è¡Œçš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œä¸»è¦ç”¨äºï¼š</p><ul><li><strong>è®°å½•æ‰§è¡Œè·¯å¾„</strong>ï¼šè¿½è¸ªå‡½æ•°è°ƒç”¨é“¾</li><li><strong>å­˜å‚¨å±€éƒ¨å˜é‡</strong>ï¼šæ¯ä¸ªæ ˆå¸§ä¿å­˜å‡½æ•°çš„å±€éƒ¨å˜é‡</li><li><strong>å‡½æ•°ä¼ å‚</strong>ï¼šé€šè¿‡æ ˆä¼ é€’å‡½æ•°å‚æ•°</li><li><strong>ä¿å­˜è¿”å›å€¼</strong>ï¼šå­˜å‚¨å‡½æ•°çš„è¿”å›å€¼</li></ul><h3 id="ä½ç½®">1.2 ä½ç½®</h3><ul><li>Go åç¨‹æ ˆä½äº <strong>Go å †å†…å­˜</strong>ä¸Šï¼ˆè€Œéæ“ä½œç³»ç»Ÿæ ˆï¼‰</li><li>Go å †å†…å­˜ä½äº<strong>æ“ä½œç³»ç»Ÿè™šæ‹Ÿå†…å­˜</strong>ä¸Š</li><li>è¿™ç§è®¾è®¡ä½¿å¾— Go å¯ä»¥çµæ´»ç®¡ç†åç¨‹æ ˆçš„å¤§å°</li></ul><h3 id="å›¾è§£">1.3 å›¾è§£</h3><p>ä»¥ä¸‹é¢çš„ä»£ç ä¸ºä¾‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sum</span><span class="params">(a, b <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">  sum := <span class="number">0</span></span><br><span class="line">  sum = a + b</span><br><span class="line">  <span class="keyword">return</span> sum</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  a := <span class="number">3</span></span><br><span class="line">  b := <span class="number">5</span></span><br><span class="line">  <span class="built_in">print</span>(sum(a, b))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ˆå¸§ç»“æ„å¦‚ä¸‹ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/68747470733a2f2f747661312e73696e61696d672e636e2f6c617267652f65366339643234656779316835746934766b3936356a32316937307530676f772e6a7067.jpeg"alt="åç¨‹æ ˆç»“æ„" /><figcaption aria-hidden="true">åç¨‹æ ˆç»“æ„</figcaption></figure><h3 id="å‚æ•°ä¼ é€’">1.4 å‚æ•°ä¼ é€’</h3><p><strong>Go é‡‡ç”¨å€¼ä¼ é€’</strong></p><ul><li>ä¼ é€’ç»“æ„ä½“æ—¶ï¼š<strong>æ‹·è´ç»“æ„ä½“ä¸­çš„å…¨éƒ¨å†…å®¹</strong></li><li>ä¼ é€’ç»“æ„ä½“æŒ‡é’ˆæ—¶ï¼š<strong>æ‹·è´ç»“æ„ä½“æŒ‡é’ˆ</strong>ï¼ˆ8 å­—èŠ‚ï¼‰</li></ul><h3 id="æ ˆå¤§å°">1.5 æ ˆå¤§å°</h3><p>Go 1.25.3 ä¸­ï¼Œåç¨‹æ ˆçš„åˆå§‹å¤§å°ä¸º<strong>2KB</strong>ï¼Œç›¸æ¯”æ—©æœŸç‰ˆæœ¬ï¼ˆå¦‚ Go 1.2 çš„ 8KBï¼‰æ›´åŠ è½»é‡ã€‚</p><h3 id="é€ƒé€¸åˆ†æ">1.6 é€ƒé€¸åˆ†æ</h3><p>ä¸æ˜¯æ‰€æœ‰çš„å˜é‡éƒ½èƒ½æ”¾åœ¨åç¨‹æ ˆä¸Šã€‚ä»¥ä¸‹ä¸‰ç§æƒ…å†µä¼šå¯¼è‡´å˜é‡<strong>é€ƒé€¸åˆ°å †</strong>ä¸Šï¼š</p><h4 id="æŒ‡é’ˆé€ƒé€¸">1. æŒ‡é’ˆé€ƒé€¸</h4><p>å‡½æ•°è¿”å›å±€éƒ¨å˜é‡çš„æŒ‡é’ˆï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newInt</span><span class="params">()</span></span> *<span class="type">int</span> &#123;</span><br><span class="line">    x := <span class="number">42</span></span><br><span class="line">    <span class="keyword">return</span> &amp;x  <span class="comment">// x é€ƒé€¸åˆ°å †</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ç©ºæ¥å£é€ƒé€¸">2. ç©ºæ¥å£é€ƒé€¸</h4><p>å‡½æ•°å‚æ•°ä¸º <code>interface&#123;&#125;</code>ï¼Œç¼–è¯‘å™¨æ— æ³•ç¡®å®šå…·ä½“ç±»å‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">println</span><span class="params">(v <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;  <span class="comment">// v å¯èƒ½é€ƒé€¸</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å¤§å˜é‡é€ƒé€¸">3. å¤§å˜é‡é€ƒé€¸</h4><p>å˜é‡å¤ªå¤§ï¼Œæ ˆå¸§æ”¾ä¸ä¸‹ã€‚åœ¨ 64 ä½æœºå™¨ä¸­ï¼Œä¸€èˆ¬è¶…è¿‡ <strong>64KB</strong>çš„å˜é‡å°±ä¼šé€ƒé€¸ã€‚</p><h3 id="æ ˆæ‰©å®¹">1.7 æ ˆæ‰©å®¹</h3><p>Go æ ˆçš„åˆå§‹ç©ºé—´ä¸º 2KBã€‚åœ¨å‡½æ•°è°ƒç”¨å‰ä¼šæ‰§è¡Œ <code>morestack</code>åˆ¤æ–­æ ˆç©ºé—´æ˜¯å¦è¶³å¤Ÿã€‚</p><h4 id="æ ˆæ‰©å®¹ç­–ç•¥æ¼”è¿›">æ ˆæ‰©å®¹ç­–ç•¥æ¼”è¿›</h4><ul><li><strong>åˆ†æ®µæ ˆ</strong>ï¼ˆGo 1.3 ä¹‹å‰ï¼‰<ul><li>ä¼˜ç‚¹ï¼šæ²¡æœ‰ç©ºé—´æµªè´¹</li><li>ç¼ºç‚¹ï¼šæ ˆå¸§åœ¨ä¸è¿ç»­çš„ç©ºé—´ä¹‹é—´æ¨ªè·³ï¼Œæ€§èƒ½è¾ƒå·®ï¼ˆ"çƒ­åˆ†è£‚"é—®é¢˜ï¼‰</li></ul></li><li><strong>è¿ç»­æ ˆ</strong>ï¼ˆGo 1.3 åŠä¹‹åï¼‰<ul><li>ä¼˜ç‚¹ï¼šç©ºé—´è¿ç»­ï¼Œæ€§èƒ½æ›´å¥½</li><li>ç¼ºç‚¹ï¼šæ‰©å®¹æ—¶éœ€è¦æ‹·è´ï¼Œå¼€é”€è¾ƒå¤§</li><li>ç­–ç•¥ï¼šå°äº 1KB æ—¶ç¿»å€ï¼Œå¦åˆ™å¢é•¿ 25%</li></ul></li></ul><hr /><h2 id="äºŒè™šæ‹Ÿå†…å­˜å•å…ƒ-heaparena">äºŒã€è™šæ‹Ÿå†…å­˜å•å…ƒ heapArena</h2><h3 id="æ¦‚è¿°">2.1 æ¦‚è¿°</h3><ul><li>åœ¨ç‰©ç†å†…å­˜ä¸º 64GB çš„æœºå™¨ä¸­ï¼Œæ¯ä¸ª Go è¿›ç¨‹æœ€å¤šå¯è¢«åˆ†é…åˆ°<strong>256TB</strong> çš„è™šæ‹Ÿå†…å­˜</li><li>Go çš„è™šæ‹Ÿå†…å­˜å•å…ƒä¸º <code>heapArena</code>ï¼Œæ¯æ¬¡ç”³è¯·<strong>64MB</strong>ï¼ˆ64 ä½é Windows ç³»ç»Ÿï¼‰</li><li>æœ€å¤šå¯ä»¥ç”³è¯· <strong>2Â²â°</strong> (çº¦ 100 ä¸‡) ä¸ª heapArena</li><li>æ‰€æœ‰çš„ <code>heapArena</code> ç»„æˆäº† <code>mheap</code>ï¼ˆGoå †å†…å­˜ï¼‰</li></ul><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/68747470733a2f2f747661312e73696e61696d672e636e2f6c617267652f6536633964323465677931683575647a7a6c3436316a3231696130656b6468772e6a7067.jpeg"alt="heapArena ç»“æ„" /><figcaption aria-hidden="true">heapArena ç»“æ„</figcaption></figure><blockquote><p>ğŸ’¡ <strong>ç›¸å…³é˜…è¯»</strong>ï¼š<ahref="https://hedon954.github.io/noteSite/cs/os/04-os-store.html#_6-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98">æ“ä½œç³»ç»Ÿ- è™šæ‹Ÿå†…å­˜</a></p></blockquote><h3 id="åº•å±‚ç»“æ„">2.2 åº•å±‚ç»“æ„</h3><p><code>heapArena</code> å®šä¹‰åœ¨ <ahref="https://github.com/golang/go/blob/go1.25.3/src/runtime/mheap.go#L266">runtime/mheap.go#L266</a>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> heapArena <span class="keyword">struct</span> &#123;</span><br><span class="line">    _ sys.NotInHeap</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// spans å°† arena ä¸­çš„è™šæ‹Ÿé¡µ ID æ˜ å°„åˆ° mspan</span></span><br><span class="line">    spans [pagesPerArena]*mspan</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// pageInUse æ˜¯ä½å›¾ï¼Œæ ‡è®°å“ªäº›é¡µæ­£åœ¨è¢«ä½¿ç”¨</span></span><br><span class="line">    pageInUse [pagesPerArena / <span class="number">8</span>]<span class="type">uint8</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// pageMarks ç”¨äº GCï¼Œæ ‡è®°å“ªäº› span æœ‰è¢«æ ‡è®°çš„å¯¹è±¡</span></span><br><span class="line">    pageMarks [pagesPerArena / <span class="number">8</span>]<span class="type">uint8</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// pageSpecials æ ‡è®°å“ªäº› span æœ‰ special è®°å½•ï¼ˆfinalizer ç­‰ï¼‰</span></span><br><span class="line">    pageSpecials [pagesPerArena / <span class="number">8</span>]<span class="type">uint8</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// pageUseSpanInlineMarkBits æ ‡è®°ä½¿ç”¨å†…è” mark bits çš„ span</span></span><br><span class="line">    pageUseSpanInlineMarkBits [pagesPerArena / <span class="number">8</span>]<span class="type">uint8</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// checkmarks ç”¨äº GC è°ƒè¯•</span></span><br><span class="line">    checkmarks *checkmarksMap</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// zeroedBase æ ‡è®°ç¬¬ä¸€ä¸ªæœªä½¿ç”¨ä¸”å·²å½’é›¶çš„é¡µ</span></span><br><span class="line">    zeroedBase <span class="type">uintptr</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åˆ†é…ç­–ç•¥å¯¹æ¯”">2.3 åˆ†é…ç­–ç•¥å¯¹æ¯”</h3><table><colgroup><col style="width: 33%" /><col style="width: 33%" /><col style="width: 33%" /></colgroup><thead><tr><th>çº¿æ€§åˆ†é…</th><th>é“¾è¡¨åˆ†é…</th><th>åˆ†çº§åˆ†é…</th></tr></thead><tbody><tr><td><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/e6c9d24egy1h5uebsvbasj21ei0ne76j.jpg"alt="çº¿æ€§åˆ†é…" /></td><td><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/e6c9d24egy1h5ueba2f53j21fi0n641m.jpg"alt="é“¾è¡¨åˆ†é…" /></td><td><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/e6c9d24egy1h5uedvcmcdj21dw0mm79w.jpg"alt="åˆ†çº§åˆ†é…" /></td></tr><tr><td>å®ç°ç®€å•ï¼Œä½†å†…å­˜ç¢ç‰‡è¾ƒå¤š</td><td>å°†ç©ºé—²å—è¿æ¥èµ·æ¥ï¼Œç‰ºç‰²éƒ¨åˆ†æ€§èƒ½æ¥ç¼“è§£å†…å­˜ç¢ç‰‡</td><td>å°†å†…å­˜æŒ‰çº§åˆ«åˆ†æˆå¾ˆå¤šå—ï¼Œæ ¹æ®å¯¹è±¡å¤§å°å­˜æ”¾åœ¨èƒ½å®¹çº³å®ƒçš„æœ€å°å—ä¸­</td></tr></tbody></table><blockquote><p><strong>Go é‡‡ç”¨åˆ†çº§åˆ†é…ç­–ç•¥</strong>ï¼Œå‚è€ƒäº† <ahref="http://goog-perftools.sourceforge.net/doc/tcmalloc.html">TCMalloc</a>ï¼Œå°†æ¯ä¸€ä¸ªçº§å®šä¹‰ä¸º<code>mspan</code>ã€‚</p></blockquote><h2 id="ä¸‰å†…å­˜ç®¡ç†å•å…ƒ-mspan">ä¸‰ã€å†…å­˜ç®¡ç†å•å…ƒ mspan</h2><h3 id="æ¦‚è¿°-1">3.1 æ¦‚è¿°</h3><ul><li>Go ä½¿ç”¨å†…å­˜æ—¶çš„åŸºæœ¬å•ä½æ˜¯ <code>mspan</code></li><li>æ¯ä¸ª <code>mspan</code> ç”± N ä¸ªç›¸åŒå¤§å°çš„ <code>span</code>ç»„æˆ</li><li>Go 1.25.3 ä¸­æœ‰ <strong>68</strong> ç§ size classï¼ˆclass 0 ~ class67ï¼‰</li></ul><h4 id="size-class-è¡¨éƒ¨åˆ†">Size Class è¡¨ï¼ˆéƒ¨åˆ†ï¼‰</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// runtime/sizeclasses.go</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// class  bytes/obj  bytes/span  objects  tail waste  max waste</span></span><br><span class="line"><span class="comment">//     0          0           0        0           0      0.00%</span></span><br><span class="line"><span class="comment">//     1          8        8192     1024           0     87.50%</span></span><br><span class="line"><span class="comment">//     2         16        8192      512           0     43.75%</span></span><br><span class="line"><span class="comment">//     3         24        8192      341           8     29.24%</span></span><br><span class="line"><span class="comment">//     4         32        8192      256           0     11.72%</span></span><br><span class="line"><span class="comment">//   ...</span></span><br><span class="line"><span class="comment">//    64      24576       24576        1           0     11.45%</span></span><br><span class="line"><span class="comment">//    65      27264       81920        3         128     10.00%</span></span><br><span class="line"><span class="comment">//    66      28672       57344        2           0      4.91%</span></span><br><span class="line"><span class="comment">//    67      32768       32768        1           0     12.50%</span></span><br></pre></td></tr></table></figure><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/e6c9d24egy1h5uemrzou7j217a0kwadr.jpg"alt="mspan ç»“æ„" /><figcaption aria-hidden="true">mspan ç»“æ„</figcaption></figure><h3 id="åº•å±‚ç»“æ„-1">3.2 åº•å±‚ç»“æ„</h3><p><code>mspan</code> å®šä¹‰åœ¨ <ahref="https://github.com/golang/go/blob/go1.25.3/src/runtime/mheap.go#L420">runtime/mheap.go#L420</a>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> mspan <span class="keyword">struct</span> &#123;</span><br><span class="line">    _ sys.NotInHeap</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åŒå‘é“¾è¡¨</span></span><br><span class="line">    next *mspan</span><br><span class="line">    prev *mspan</span><br><span class="line">    list *mSpanList</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å†…å­˜åœ°å€å’Œå¤§å°</span></span><br><span class="line">    startAddr <span class="type">uintptr</span>    <span class="comment">// èµ·å§‹åœ°å€</span></span><br><span class="line">    npages    <span class="type">uintptr</span>    <span class="comment">// é¡µæ•°ï¼ˆæ¯é¡µ 8KBï¼‰</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ†é…ä¿¡æ¯</span></span><br><span class="line">    freeindex        <span class="type">uint16</span>      <span class="comment">// ä¸‹ä¸€ä¸ªç©ºé—²å¯¹è±¡çš„ç´¢å¼•</span></span><br><span class="line">    freeIndexForScan <span class="type">uint16</span>      <span class="comment">// GC æ‰«æå™¨ä½¿ç”¨çš„ç´¢å¼•ï¼ˆGo 1.19+ï¼‰</span></span><br><span class="line">    nelems           <span class="type">uint16</span>      <span class="comment">// å¯¹è±¡æ€»æ•°</span></span><br><span class="line">    allocCount       <span class="type">uint16</span>      <span class="comment">// å·²åˆ†é…å¯¹è±¡æ•°</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä½å›¾</span></span><br><span class="line">    allocBits  *gcBits   <span class="comment">// åˆ†é…ä½å›¾</span></span><br><span class="line">    gcmarkBits *gcBits   <span class="comment">// GC æ ‡è®°ä½å›¾</span></span><br><span class="line">    pinnerBits *gcBits   <span class="comment">// å›ºå®šå¯¹è±¡ä½å›¾ï¼ˆGo 1.21+ï¼‰</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å…ƒæ•°æ®</span></span><br><span class="line">    spanclass  spanClass      <span class="comment">// size class å’Œ noscan æ ‡å¿—</span></span><br><span class="line">    elemsize   <span class="type">uintptr</span>        <span class="comment">// å¯¹è±¡å¤§å°</span></span><br><span class="line">    state      mSpanStateBox  <span class="comment">// mspan çŠ¶æ€</span></span><br><span class="line">    sweepgen   <span class="type">uint32</span>         <span class="comment">// æ¸…æ‰«ä»£æ•°</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ–°å¢å­—æ®µï¼ˆGo 1.20+ï¼‰</span></span><br><span class="line">    isUserArenaChunk <span class="type">bool</span>       <span class="comment">// æ˜¯å¦ä¸º user arena chunk</span></span><br><span class="line">    userArenaChunkFree addrRange <span class="comment">// user arena ç®¡ç†</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// GreenTeaGC å®éªŒå­—æ®µï¼ˆGo 1.24+ï¼‰</span></span><br><span class="line">    scanIdx <span class="type">uint16</span>  <span class="comment">// æ‰«æç´¢å¼•</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¤§å¯¹è±¡ç±»å‹ä¿¡æ¯ï¼ˆGo 1.22+ï¼‰</span></span><br><span class="line">    largeType *_type</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Special è®°å½•</span></span><br><span class="line">    speciallock mutex</span><br><span class="line">    specials    *special</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å…³é”®å­—æ®µè¯´æ˜">3.3 å…³é”®å­—æ®µè¯´æ˜</h3><h4 id="åˆ†é…ä½å›¾allocbits">1. åˆ†é…ä½å›¾ï¼ˆallocBitsï¼‰</h4><p>ä½¿ç”¨ä½å›¾æ ‡è®°å¯¹è±¡æ˜¯å¦å·²åˆ†é…ï¼š - <code>0</code> è¡¨ç¤ºç©ºé—² -<code>1</code> è¡¨ç¤ºå·²åˆ†é…</p><h4 id="åŒç´¢å¼•è®¾è®¡go-1.19">2. åŒç´¢å¼•è®¾è®¡ï¼ˆGo 1.19+ï¼‰</h4><ul><li><code>freeindex</code>ï¼šåˆ†é…å™¨ä½¿ç”¨</li><li><code>freeIndexForScan</code>ï¼šGC æ‰«æå™¨ä½¿ç”¨</li></ul><p>è¿™æ ·è®¾è®¡é¿å…äº†ç«äº‰æ¡ä»¶ï¼Œç¡®ä¿ GC åªåœ¨å¯¹è±¡å®Œå…¨åˆå§‹åŒ–åæ‰èƒ½çœ‹åˆ°å®ƒã€‚</p><h4 id="çŠ¶æ€æœº">3. çŠ¶æ€æœº</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    mSpanDead   mSpanState = <span class="literal">iota</span>  <span class="comment">// æœªä½¿ç”¨</span></span><br><span class="line">    mSpanInUse                     <span class="comment">// æ­£åœ¨ä½¿ç”¨</span></span><br><span class="line">    mSpanManual                    <span class="comment">// æ‰‹åŠ¨ç®¡ç†ï¼ˆå¦‚æ ˆï¼‰</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><hr /><h2 id="å››ä¸­å¿ƒç´¢å¼•-mcentral">å››ã€ä¸­å¿ƒç´¢å¼• mcentral</h2><h3 id="æ¦‚è¿°-2">4.1 æ¦‚è¿°</h3><p>heapArena ä¸­çš„ <code>mspan</code>ä¸æ˜¯ä¸€å¼€å§‹å°±å…¨éƒ¨åˆ’åˆ†å¥½çš„ï¼Œè€Œæ˜¯<strong>æŒ‰éœ€åˆ’åˆ†</strong>ã€‚</p><p>ç”±äºæ¯ä¸ª heapArena ä¸­çš„ mspanåˆ†å¸ƒæ˜¯åŠ¨æ€çš„ï¼Œä¸ºäº†ç»™è¦åˆ†é…ç©ºé—´çš„å¯¹è±¡å¿«é€Ÿå®šä½åˆ°åˆé€‚çš„ mspanï¼ŒGoå®šä¹‰äº†ä¸­å¿ƒç´¢å¼• <code>mcentral</code>ã€‚</p><ul><li>æ€»å…±æœ‰ <strong>136</strong> ä¸ª <code>mcentral</code> ç»“æ„ä½“</li><li>å…¶ä¸­ <strong>68</strong> ä¸ªç”¨äºéœ€è¦ GC æ‰«æçš„å¯¹è±¡ï¼ˆscanï¼‰</li><li>å¦å¤– <strong>68</strong> ä¸ªç”¨äºæ— éœ€ GC æ‰«æçš„å¯¹è±¡ï¼ˆnoscanï¼‰</li></ul><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/e6c9d24egy1h5uf0kf27jj21iw0rg0xy.jpg"alt="mcentral ç»“æ„" /><figcaption aria-hidden="true">mcentral ç»“æ„</figcaption></figure><h3 id="åº•å±‚ç»“æ„-2">4.2 åº•å±‚ç»“æ„</h3><p><code>mcentral</code> å®šä¹‰åœ¨ <ahref="https://github.com/golang/go/blob/go1.25.3/src/runtime/mcentral.go#L22">runtime/mcentral.go#L22</a>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> mcentral <span class="keyword">struct</span> &#123;</span><br><span class="line">    _ sys.NotInHeap</span><br><span class="line">    </span><br><span class="line">    spanclass spanClass  <span class="comment">// size class çº§åˆ«</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åŒç¼“å†²è®¾è®¡ï¼šé…åˆ GC çš„ sweepgen</span></span><br><span class="line">    partial [<span class="number">2</span>]spanSet  <span class="comment">// æœ‰ç©ºé—²å¯¹è±¡çš„ span åˆ—è¡¨</span></span><br><span class="line">    full    [<span class="number">2</span>]spanSet  <span class="comment">// æ— ç©ºé—²å¯¹è±¡çš„ span åˆ—è¡¨</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åŒç¼“å†²æœºåˆ¶">4.3 åŒç¼“å†²æœºåˆ¶</h3><p><code>mcentral</code> ä½¿ç”¨åŒç¼“å†²é…åˆ GC çš„æ¸…æ‰«æœºåˆ¶ï¼š</p><ul><li><code>sweepgen</code> æ¯æ¬¡ GC å¢åŠ  2</li><li><code>partial[sweepgen/2%2]</code> æ˜¯å·²æ¸…æ‰«çš„ span</li><li><code>partial[1-sweepgen/2%2]</code> æ˜¯æœªæ¸…æ‰«çš„ span</li></ul><p>è¿™ç§è®¾è®¡ä½¿å¾— GC å’Œåˆ†é…å¯ä»¥å¹¶å‘è¿›è¡Œï¼Œæ— éœ€ç­‰å¾…æ‰€æœ‰ spanéƒ½æ¸…æ‰«å®Œæ¯•ã€‚</p><h2 id="äº”çº¿ç¨‹ç¼“å­˜-mcache">äº”ã€çº¿ç¨‹ç¼“å­˜ mcache</h2><h3 id="æ¦‚è¿°-3">5.1 æ¦‚è¿°</h3><p><code>mcentral</code>æ˜¯ä¸€ä¸ªä¸­å¿ƒç´¢å¼•ï¼Œä¿®æ”¹å®ƒéœ€è¦ä½¿ç”¨äº’æ–¥é”è¿›è¡Œä¿æŠ¤ï¼Œé”ç«äº‰ä¼šé€ æˆæ€§èƒ½é—®é¢˜ã€‚</p><p>Go å‚è€ƒ <strong>GMP æ¨¡å‹</strong>ï¼Œä¸ºæ¯ä¸ªPï¼ˆé€»è¾‘å¤„ç†å™¨ï¼‰å»ºç«‹äº†<strong>çº¿ç¨‹æœ¬åœ°ç¼“å­˜</strong><code>mcache</code>ï¼Œæå¤§ç¼“è§£äº†å¹¶å‘é”äº‰å¤ºçš„æ€§èƒ½æ¶ˆè€—ã€‚</p><p>è®¾è®¡è¦ç‚¹ï¼š - æ¯ä¸ª <strong>P</strong> æœ‰ä¸€ä¸ª <code>mcache</code> -å¯¹äºæ¯ä¸€ç§ size classï¼Œå–ä¸€ä¸ª scan å’Œä¸€ä¸ª noscan span - ä¸€ä¸ª<code>mcache</code> æ‹¥æœ‰ <strong>136</strong> ä¸ª <code>mspan</code>ï¼ˆ68ä¸ª scan + 68 ä¸ª noscanï¼‰ - å½“æœ¬åœ°ç¼“å­˜ç”¨å®Œåï¼Œæ‰éœ€è¦ä¸Šé”å» mcentraläº¤æ¢</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/e6c9d24egy1h5ufd5lnvxj21ez0u0n3h.jpg"alt="mcache ç»“æ„" /><figcaption aria-hidden="true">mcache ç»“æ„</figcaption></figure><h3 id="åº•å±‚ç»“æ„-3">5.2 åº•å±‚ç»“æ„</h3><p><code>mcache</code> å®šä¹‰åœ¨ <ahref="https://github.com/golang/go/blob/go1.25.3/src/runtime/mcache.go#L20">runtime/mcache.go#L20</a>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> mcache <span class="keyword">struct</span> &#123;</span><br><span class="line">    _ sys.NotInHeap</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å†…å­˜åˆ†æç›¸å…³</span></span><br><span class="line">    nextSample  <span class="type">int64</span>   <span class="comment">// è§¦å‘å †é‡‡æ ·çš„å­—èŠ‚æ•°</span></span><br><span class="line">    memProfRate <span class="type">int</span>     <span class="comment">// ç¼“å­˜çš„å†…å­˜åˆ†æé€Ÿç‡</span></span><br><span class="line">    scanAlloc   <span class="type">uintptr</span> <span class="comment">// å¯æ‰«æå¯¹è±¡çš„å·²åˆ†é…å­—èŠ‚æ•°</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¾®å¯¹è±¡åˆ†é…å™¨ï¼ˆ&lt;16B çš„å¯¹è±¡ï¼‰</span></span><br><span class="line">    tiny       <span class="type">uintptr</span>  <span class="comment">// å½“å‰ tiny block çš„èµ·å§‹åœ°å€</span></span><br><span class="line">    tinyoffset <span class="type">uintptr</span>  <span class="comment">// tiny block ä¸­çš„åç§»</span></span><br><span class="line">    tinyAllocs <span class="type">uintptr</span>  <span class="comment">// tiny åˆ†é…æ¬¡æ•°</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ ¸å¿ƒï¼š136 ä¸ª mspan</span></span><br><span class="line">    alloc [numSpanClasses]*mspan  <span class="comment">// numSpanClasses = 136</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ ˆç¼“å­˜</span></span><br><span class="line">    stackcache [_NumStackOrders]stackfreelist</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// GC ç›¸å…³</span></span><br><span class="line">    flushGen atomic.Uint32  <span class="comment">// ä¸Šæ¬¡ flush æ—¶çš„ sweepgen</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä¸-p-çš„å…³ç³»">5.3 ä¸ P çš„å…³ç³»</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> p <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    mcache *mcache</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯ä¸ª P æŒæœ‰ä¸€ä¸ª mcache æŒ‡é’ˆï¼Œå®ç°<strong>æ— é”å¿«é€Ÿè·¯å¾„</strong>ã€‚</p><h2 id="å…­å †-mheap">å…­ã€å † mheap</h2><p><code>mheap</code> æ˜¯ Go å †å†…å­˜çš„å…¨å±€ç®¡ç†è€…ï¼Œç»Ÿç­¹æ‰€æœ‰å†…å­˜åˆ†é…ã€‚</p><h3 id="åº•å±‚ç»“æ„-4">6.1 åº•å±‚ç»“æ„</h3><p><code>mheap</code> å®šä¹‰åœ¨ <ahref="https://github.com/golang/go/blob/go1.25.3/src/runtime/mheap.go#L64">runtime/mheap.go#L64</a>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> mheap <span class="keyword">struct</span> &#123;</span><br><span class="line">    _ sys.NotInHeap</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å…¨å±€é”ï¼ˆå¿…é¡»åœ¨ç³»ç»Ÿæ ˆä¸Šè·å–ï¼‰</span></span><br><span class="line">    lock mutex</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é¡µåˆ†é…å™¨</span></span><br><span class="line">    pages pageAlloc</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// GC ç›¸å…³</span></span><br><span class="line">    sweepgen       <span class="type">uint32</span>           <span class="comment">// æ¸…æ‰«ä»£æ•°</span></span><br><span class="line">    pagesInUse     atomic.Uintptr   <span class="comment">// ä½¿ç”¨ä¸­çš„é¡µæ•°</span></span><br><span class="line">    pagesSwept     atomic.Uint64    <span class="comment">// å·²æ¸…æ‰«çš„é¡µæ•°</span></span><br><span class="line">    sweepPagesPerByte <span class="type">float64</span>       <span class="comment">// æ¯”ä¾‹æ¸…æ‰«é€Ÿç‡</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Arena ç®¡ç†ï¼ˆäºŒçº§æ˜ å°„ï¼‰</span></span><br><span class="line">    arenas [<span class="number">1</span> &lt;&lt; arenaL1Bits]*[<span class="number">1</span> &lt;&lt; arenaL2Bits]*heapArena</span><br><span class="line">    heapArenas []arenaIdx  <span class="comment">// æ‰€æœ‰å·²åˆ†é…çš„ arena</span></span><br><span class="line">    curArena <span class="keyword">struct</span> &#123;      <span class="comment">// å½“å‰æ­£åœ¨å¢é•¿çš„ arena</span></span><br><span class="line">        base, end <span class="type">uintptr</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¸­å¿ƒç´¢å¼•ï¼ˆ136 ä¸ªï¼‰</span></span><br><span class="line">    central [numSpanClasses]<span class="keyword">struct</span> &#123;</span><br><span class="line">        mcentral mcentral</span><br><span class="line">        pad [cpu.CacheLinePadSize - unsafe.Sizeof(mcentral&#123;&#125;)%cpu.CacheLinePadSize]<span class="type">byte</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// mspan æ˜¯æŒ‰éœ€åˆ†çº§çš„ï¼Œè¿™é‡Œä¿å­˜æ‰€æœ‰å·²åˆ’åˆ†çš„ mspan</span></span><br><span class="line">    allspans []*mspan</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å„ç§ fixalloc åˆ†é…å™¨</span></span><br><span class="line">    spanalloc             fixalloc  <span class="comment">// åˆ†é… mspan</span></span><br><span class="line">    cachealloc            fixalloc  <span class="comment">// åˆ†é… mcache</span></span><br><span class="line">    specialfinalizeralloc fixalloc  <span class="comment">// åˆ†é… finalizer</span></span><br><span class="line">    specialWeakHandleAlloc fixalloc <span class="comment">// åˆ†é…å¼±æŒ‡é’ˆï¼ˆGo 1.23+ï¼‰</span></span><br><span class="line">    specialCleanupAlloc   fixalloc  <span class="comment">// åˆ†é… cleanupï¼ˆGo 1.24+ï¼‰</span></span><br><span class="line">    specialPinCounterAlloc fixalloc <span class="comment">// åˆ†é… pin counterï¼ˆGo 1.21+ï¼‰</span></span><br><span class="line">    <span class="comment">// ... æ›´å¤š special åˆ†é…å™¨</span></span><br><span class="line">    </span><br><span class="line">    speciallock mutex  <span class="comment">// ä¿æŠ¤ special åˆ†é…å™¨</span></span><br><span class="line">    arenaHintAlloc fixalloc</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ã€æ–°ç‰¹æ€§ã€‘User Arena çŠ¶æ€ï¼ˆGo 1.20+ï¼‰</span></span><br><span class="line">    userArena <span class="keyword">struct</span> &#123;</span><br><span class="line">        arenaHints     *arenaHint</span><br><span class="line">        quarantineList mSpanList  <span class="comment">// ç­‰å¾…é‡Šæ”¾çš„ span</span></span><br><span class="line">        readyList      mSpanList  <span class="comment">// å¯å¤ç”¨çš„ span</span></span><br><span class="line">    &#125;</span><br><span class="line">    userArenaArenas []arenaIdx</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ã€æ–°ç‰¹æ€§ã€‘Cleanup ID è®¡æ•°å™¨ï¼ˆGo 1.24+ï¼‰</span></span><br><span class="line">    cleanupID <span class="type">uint64</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ã€æ–°ç‰¹æ€§ã€‘å¼±æŒ‡é’ˆæ˜ å°„ï¼ˆGo 1.23+ï¼‰</span></span><br><span class="line">    immortalWeakHandles immortalWeakHandleMap</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å…³é”®è®¾è®¡">6.2 å…³é”®è®¾è®¡</h3><h4 id="äºŒçº§æ˜ å°„arenas">1. äºŒçº§æ˜ å°„ï¼ˆarenasï¼‰</h4><p>ä¸ºäº†æ”¯æŒç¨€ç–çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œä½¿ç”¨äºŒçº§æ•°ç»„ï¼š - L1 mapï¼šç´¢å¼• arena ç»„ -L2 mapï¼šç´¢å¼•å…·ä½“çš„ heapArena</p><p>åœ¨å¤§å¤šæ•° 64ä½å¹³å°ä¸Šï¼Œ<code>arenaL1Bits = 0</code>ï¼Œé€€åŒ–ä¸ºå•çº§æ˜ å°„ã€‚</p><h4 id="cache-line-å¯¹é½">2. Cache Line å¯¹é½</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pad [(cpu.CacheLinePadSize - unsafe.Sizeof(mcentral&#123;&#125;)%cpu.CacheLinePadSize) % cpu.CacheLinePadSize]<span class="type">byte</span></span><br></pre></td></tr></table></figure><p>å¡«å……å­—èŠ‚é¿å…ä¼ªå…±äº«ï¼ˆfalse sharingï¼‰ï¼Œæå‡å¤šæ ¸æ€§èƒ½ã€‚</p><h4 id="é¡µå›æ”¶å™¨">3. é¡µå›æ”¶å™¨</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reclaimIndex  atomic.Uint64  <span class="comment">// ä¸‹ä¸€ä¸ªè¦å›æ”¶çš„é¡µç´¢å¼•</span></span><br><span class="line">reclaimCredit atomic.Uintptr <span class="comment">// é¢å¤–å›æ”¶çš„é¡µçš„ä¿¡ç”¨</span></span><br></pre></td></tr></table></figure><p>åå°å¼‚æ­¥å›æ”¶æœªä½¿ç”¨çš„é¡µï¼Œå‡å°‘å†…å­˜å ç”¨ã€‚</p><h2 id="ä¸ƒå†…å­˜åˆ†é…">ä¸ƒã€å†…å­˜åˆ†é…</h2><h3 id="å¯¹è±¡åˆ†çº§">7.1 å¯¹è±¡åˆ†çº§</h3><p>Go æ ¹æ®å¯¹è±¡å¤§å°å°†åˆ†é…åˆ†ä¸ºä¸‰ç±»ï¼š</p><table><thead><tr><th>ç±»å‹</th><th>å¤§å°èŒƒå›´</th><th>åˆ†é…æ–¹å¼</th><th>Size Class</th></tr></thead><tbody><tr><td><strong>Tiny</strong></td><td>0 ~ 16Bï¼ˆæ— æŒ‡é’ˆï¼‰</td><td>å¤šä¸ªå¯¹è±¡åˆå¹¶åˆ° 16B</td><td>class 2</td></tr><tr><td><strong>Tiny</strong></td><td>8Bï¼ˆå•æŒ‡é’ˆï¼‰</td><td>64 ä½ä¸Šä½¿ç”¨ class 1</td><td>class1</td></tr><tr><td><strong>Small</strong></td><td>16B ~ 32KB</td><td>ä» mcache åˆ†é…</td><td>class 2 ~ 67</td></tr><tr><td><strong>Large</strong></td><td>&gt; 32KB</td><td>ç›´æ¥ä» mheap åˆ†é…</td><td>class 0</td></tr></tbody></table><blockquote><p><strong>æ³¨æ„</strong>ï¼šClass 1 (8B) åœ¨å®è·µä¸­ä½¿ç”¨æå°‘ï¼Œä»…åœ¨ 64ä½å¹³å°ä¸Šåˆ†é…æ°å¥½ 8 å­—èŠ‚ä¸”åŒ…å«æŒ‡é’ˆçš„å¯¹è±¡æ—¶ä½¿ç”¨ã€‚ç»å¤§å¤šæ•° 8å­—èŠ‚å¯¹è±¡è¦ä¹ˆæ— æŒ‡é’ˆï¼ˆèµ° tiny allocatorï¼‰ï¼Œè¦ä¹ˆæ˜¯ç»“æ„ä½“çš„ä¸€éƒ¨åˆ†ã€‚</p></blockquote><h4 id="tiny-å¯¹è±¡åˆ†é…">7.1.1 Tiny å¯¹è±¡åˆ†é…</h4><p>å¯¹äº <strong>&lt; 16B</strong> ä¸”<strong>æ— æŒ‡é’ˆ</strong>çš„å¯¹è±¡ï¼ŒGoä½¿ç”¨ç‰¹æ®Šçš„ <strong>tiny allocator</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mcache ä¸­çš„ tiny allocator</span></span><br><span class="line">tiny       <span class="type">uintptr</span>  <span class="comment">// å½“å‰ tiny block èµ·å§‹åœ°å€</span></span><br><span class="line">tinyoffset <span class="type">uintptr</span>  <span class="comment">// å·²ä½¿ç”¨çš„åç§»é‡</span></span><br><span class="line">tinyAllocs <span class="type">uintptr</span>  <span class="comment">// tiny åˆ†é…è®¡æ•°</span></span><br></pre></td></tr></table></figure><ol type="1"><li>å°è¯•åœ¨å½“å‰ tiny block ä¸­åˆ†é…ï¼ˆæ ¹æ®å¯¹é½è¦æ±‚ï¼‰</li><li>å¦‚æœç©ºé—´ä¸è¶³ï¼Œä» class 2 (16B) çš„ span ä¸­è·å–æ–°çš„ tiny block</li><li>å¤šä¸ª tiny å¯¹è±¡å…±äº«åŒä¸€ä¸ª 16B å—ï¼Œå‡å°‘å†…å­˜æµªè´¹</li></ol><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/e6c9d24egy1h5ulg364i2j21nk09uq4s.jpg"alt="Tiny å¯¹è±¡åˆ†é…" /><figcaption aria-hidden="true">Tiny å¯¹è±¡åˆ†é…</figcaption></figure><blockquote><p><strong>Class 1 çš„ç‰¹æ®Šæ€§</strong>ï¼šClass 1 (8B)åœ¨å®è·µä¸­ä½¿ç”¨æå°‘ï¼Œä»…åœ¨ 64 ä½å¹³å°ä¸Šåˆ†é…æ°å¥½ 8å­—èŠ‚ä¸”åŒ…å«æŒ‡é’ˆçš„å¯¹è±¡æ—¶ä½¿ç”¨ã€‚å…¸å‹ä¾‹å­å¦‚å•ä¸ªé€ƒé€¸çš„æŒ‡é’ˆå˜é‡ã€‚ç”±äºè¿™ç§åœºæ™¯éå¸¸ç½•è§ï¼Œclass1 åŸºæœ¬å¤„äº"ä¿ç•™ä½†ä¸å¸¸ç”¨"çš„çŠ¶æ€ã€‚å¤§å¤šæ•° 8 å­—èŠ‚å¯¹è±¡è¦ä¹ˆï¼š</p><ul><li>æ— æŒ‡é’ˆ â†’ èµ° tiny allocatorï¼ˆclass 2ï¼‰</li><li>æ˜¯ç»“æ„ä½“å­—æ®µçš„ä¸€éƒ¨åˆ† â†’ éšç»“æ„ä½“ä¸€èµ·åˆ†é…</li><li>æ˜¯æ ˆä¸Šå˜é‡ â†’ ä¸è¿›è¡Œå †åˆ†é…</li></ul></blockquote><h4 id="small-å¯¹è±¡åˆ†é…">7.1.2 Small å¯¹è±¡åˆ†é…</h4><p>å¯¹äº <strong>16B ~ 32KB</strong> çš„å¯¹è±¡ï¼š</p><ol type="1"><li>æ ¹æ®å¯¹è±¡å¤§å°æŸ¥è¡¨ç¡®å®š size class</li><li>åœ¨ mcache ä¸­å¯»æ‰¾å¯¹åº” class çš„ span</li><li>ä» span çš„ allocBits ä¸­æ‰¾åˆ°ç©ºé—² slot</li><li>å¦‚æœ mcache ä¸­ span å·²æ»¡ï¼Œå» mcentral äº¤æ¢</li><li>å¦‚æœ mcentral ä¹Ÿæ²¡æœ‰ï¼Œå» mheap ç”³è¯·</li></ol><h4 id="large-å¯¹è±¡åˆ†é…">7.1.3 Large å¯¹è±¡åˆ†é…</h4><p>å¯¹äº <strong>&gt; 32KB</strong> çš„å¤§å¯¹è±¡ï¼šé‡èº«å®šåš class0ï¼Œç›´æ¥ä»mheap ä¸Šç”³è¯·å†…å­˜ã€‚</p><h3 id="mcache-æ›¿æ¢">7.2 mcache æ›¿æ¢</h3><p>åœ¨ mcache ä¸­ï¼Œæ¯ä¸ª class çš„ mspan åªæœ‰ä¸€ä¸ªï¼Œå½“ mspan æ»¡äº†ä¹‹åï¼Œä¼šä»mcentral ä¸­å…‘æ¢ä¸€ä¸ªæ–°çš„ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *mcache)</span></span> refill(spc spanClass) &#123;</span><br><span class="line">    <span class="comment">// 1. é‡Šæ”¾å½“å‰ span å› mcentral</span></span><br><span class="line">    s := c.alloc[spc]</span><br><span class="line">    <span class="keyword">if</span> s != &amp;emptymspan &#123;</span><br><span class="line">        <span class="keyword">if</span> s.sweepgen != mheap_.sweepgen+<span class="number">3</span> &#123;</span><br><span class="line">            throw(<span class="string">&quot;bad sweepgen in refill&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        mheap_.central[spc].mcentral.uncacheSpan(s)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ä» mcentral è·å–æ–°çš„ span</span></span><br><span class="line">    s = mheap_.central[spc].mcentral.cacheSpan()</span><br><span class="line">    <span class="keyword">if</span> s == <span class="literal">nil</span> &#123;</span><br><span class="line">        throw(<span class="string">&quot;out of memory&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. æ›´æ–° mcache</span></span><br><span class="line">    c.alloc[spc] = s</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="mcentral-æ‰©å®¹">7.3 mcentral æ‰©å®¹</h3><p>mcentral ä¸­ï¼Œåªæœ‰æœ‰é™æ•°é‡çš„ mspanï¼Œå½“ mspan ç¼ºå°‘æ—¶ï¼Œä¼šåƒ mheapä¸­å¼€è¾Ÿæ–°çš„ heapArenaï¼Œå¹¶ç”³è¯·å¯¹åº” class çš„ spanã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *mcentral)</span></span> grow() *mspan &#123;</span><br><span class="line">    <span class="comment">// 1. è®¡ç®—éœ€è¦çš„é¡µæ•°</span></span><br><span class="line">    npages := <span class="type">uintptr</span>(class_to_allocnpages[c.spanclass.sizeclass()])</span><br><span class="line">    size := <span class="type">uintptr</span>(class_to_size[c.spanclass.sizeclass()])</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ä» mheap åˆ†é…æ–°çš„ span</span></span><br><span class="line">    s := mheap_.alloc(npages, c.spanclass)</span><br><span class="line">    <span class="keyword">if</span> s == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. åˆå§‹åŒ– span</span></span><br><span class="line">    n := (npages &lt;&lt; pageShift) / size</span><br><span class="line">    s.limit = s.base() + size*n</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="mallocgc-æºç åˆ†æ">7.4 mallocgc æºç åˆ†æ</h3><p><ahref="https://github.com/golang/go/blob/release-branch.go1.25/src/runtime/malloc.go#L1014">mallocgc</a>æ˜¯ Go å†…å­˜åˆ†é…çš„æ ¸å¿ƒå‡½æ•°ï¼Œæ ¸å¿ƒç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mallocgc</span><br><span class="line"><span class="code">    â”œâ”€â”€ mallocgcTiny          // Tiny å¯¹è±¡ (0~16B, æ— æŒ‡é’ˆ)</span></span><br><span class="line"><span class="code">    â”œâ”€â”€ mallocgcSmallNoscan   // Small å¯¹è±¡ (16B~32KB, æ— æŒ‡é’ˆ)</span></span><br><span class="line"><span class="code">    â”œâ”€â”€ mallocgcSmallScanNoHeader   // Small å¯¹è±¡ (å¸¦æŒ‡é’ˆ, æ—  header)</span></span><br><span class="line"><span class="code">    â”œâ”€â”€ mallocgcSmallScanHeader     // Small å¯¹è±¡ (å¸¦æŒ‡é’ˆ, æœ‰ header)</span></span><br><span class="line"><span class="code">    â””â”€â”€ mallocgcLarge         // Large å¯¹è±¡ (&gt;32KB)</span></span><br></pre></td></tr></table></figure><p>æºç æ³¨é‡Šå¦‚ä¸‹ï¼ˆçœç•¥äº†ä¸å†…å­˜åˆ†é…æ— å…³çš„æ¬¡è¦ä»£ç ï¼‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mallocgc</span><span class="params">(size <span class="type">uintptr</span>, typ *_type, needzero <span class="type">bool</span>)</span></span> unsafe.Pointer &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é›¶å¤§å°åˆ†é…çš„å¿«é€Ÿè·¯å¾„</span></span><br><span class="line">    <span class="keyword">if</span> size == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> unsafe.Pointer(&amp;zerobase)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== æ ¸å¿ƒåˆ†é…é€»è¾‘ ==========</span></span><br><span class="line">    <span class="keyword">var</span> x unsafe.Pointer</span><br><span class="line">    <span class="keyword">var</span> elemsize <span class="type">uintptr</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> size &lt;= maxSmallSize-gc.MallocHeaderSize &#123;</span><br><span class="line">        <span class="comment">// å°å¯¹è±¡åˆ†é…</span></span><br><span class="line">        <span class="keyword">if</span> typ == <span class="literal">nil</span> || !typ.Pointers() &#123;</span><br><span class="line">            <span class="comment">// æ— æŒ‡é’ˆå¯¹è±¡</span></span><br><span class="line">            <span class="keyword">if</span> size &lt; maxTinySize &#123;</span><br><span class="line">                x, elemsize = mallocgcTiny(size, typ)        <span class="comment">// Tiny è·¯å¾„</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                x, elemsize = mallocgcSmallNoscan(size, typ, needzero)  <span class="comment">// Small Noscan</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æœ‰æŒ‡é’ˆå¯¹è±¡ï¼ˆå¿…é¡»å½’é›¶ï¼‰</span></span><br><span class="line">            <span class="keyword">if</span> !needzero &#123;</span><br><span class="line">                throw(<span class="string">&quot;objects with pointers must be zeroed&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> heapBitsInSpan(size) &#123;</span><br><span class="line">                x, elemsize = mallocgcSmallScanNoHeader(size, typ)  <span class="comment">// ä½å›¾åœ¨ span ä¸­</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                x, elemsize = mallocgcSmallScanHeader(size, typ)    <span class="comment">// éœ€è¦ malloc header</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å¤§å¯¹è±¡åˆ†é…</span></span><br><span class="line">        x, elemsize = mallocgcLarge(size, typ, needzero)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> x</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="tiny-å¯¹è±¡åˆ†é…mallocgctiny">7.4.1 Tinyå¯¹è±¡åˆ†é…ï¼šmallocgcTiny</h4><blockquote><p>ç”¨äº &lt; 16B ä¸”æ— æŒ‡é’ˆçš„å¯¹è±¡ï¼Œå¤šä¸ªå¯¹è±¡åˆå¹¶åˆ° 16Bå—ä¸­ã€‚<code>mallocgcTiny</code> è¿›è¡Œäº†ä»¥ä¸‹ä¼˜åŒ–ï¼š</p></blockquote><ul><li><p>å¯¹é½ä¼˜åŒ–ï¼šæ ¹æ®å¤§å°é€‰æ‹©åˆé€‚çš„å¯¹é½</p></li><li><p>ç©ºé—´å¤ç”¨ï¼šå¤šä¸ªå¯¹è±¡å…±äº« 16B å—</p></li><li><p>æ— é”å¿«é€Ÿè·¯å¾„ï¼šnextFreeFast å°è¯•æ— é”è·å–</p></li><li><p>å¹³å‡æµªè´¹ç‡ï¼šçº¦ 12.5%ï¼ˆè¿œä½äºç‹¬ç«‹åˆ†é…çš„ 87.5%ï¼‰</p></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mallocgcTiny</span><span class="params">(size <span class="type">uintptr</span>, typ *_type)</span></span> (unsafe.Pointer, <span class="type">uintptr</span>) &#123;</span><br><span class="line">    <span class="comment">// ========== 1. è·å– M å’Œ mcache ==========</span></span><br><span class="line">    mp := acquirem()</span><br><span class="line">    mp.mallocing = <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    c := getMCache(mp)</span><br><span class="line">    off := c.tinyoffset</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 2. å¯¹é½è®¡ç®— ==========</span></span><br><span class="line">    <span class="keyword">if</span> size&amp;<span class="number">7</span> == <span class="number">0</span> &#123;</span><br><span class="line">        off = alignUp(off, <span class="number">8</span>)   <span class="comment">// 8 å­—èŠ‚å¯¹é½</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> goarch.PtrSize == <span class="number">4</span> &amp;&amp; size == <span class="number">12</span> &#123;</span><br><span class="line">        off = alignUp(off, <span class="number">8</span>)   <span class="comment">// 32 ä½ç‰¹æ®Šæƒ…å†µ</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> size&amp;<span class="number">3</span> == <span class="number">0</span> &#123;</span><br><span class="line">        off = alignUp(off, <span class="number">4</span>)   <span class="comment">// 4 å­—èŠ‚å¯¹é½</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> size&amp;<span class="number">1</span> == <span class="number">0</span> &#123;</span><br><span class="line">        off = alignUp(off, <span class="number">2</span>)   <span class="comment">// 2 å­—èŠ‚å¯¹é½</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 3. å°è¯•åœ¨ç°æœ‰ tiny block ä¸­åˆ†é… ==========</span></span><br><span class="line">    <span class="keyword">if</span> off+size &lt;= maxTinySize &amp;&amp; c.tiny != <span class="number">0</span> &#123;</span><br><span class="line">        x := unsafe.Pointer(c.tiny + off)</span><br><span class="line">        c.tinyoffset = off + size</span><br><span class="line">        c.tinyAllocs++</span><br><span class="line">        mp.mallocing = <span class="number">0</span></span><br><span class="line">        releasem(mp)</span><br><span class="line">        <span class="keyword">return</span> x, maxTinySize</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 4. éœ€è¦æ–°çš„ tiny block ==========</span></span><br><span class="line">    span := c.alloc[tinySpanClass]</span><br><span class="line">    v := nextFreeFast(span)</span><br><span class="line">    <span class="keyword">if</span> v == <span class="number">0</span> &#123;</span><br><span class="line">        v, span, _ = c.nextFree(tinySpanClass)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    x := unsafe.Pointer(v)</span><br><span class="line">    (*[<span class="number">2</span>]<span class="type">uint64</span>)(x)[<span class="number">0</span>] = <span class="number">0</span>  <span class="comment">// æ¸…é›¶å‰ 16 å­—èŠ‚</span></span><br><span class="line">    (*[<span class="number">2</span>]<span class="type">uint64</span>)(x)[<span class="number">1</span>] = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 5. æ›´æ–° tiny allocator çŠ¶æ€ ==========</span></span><br><span class="line">    <span class="keyword">if</span> !raceenabled &amp;&amp; (size &lt; c.tinyoffset || c.tiny == <span class="number">0</span>) &#123;</span><br><span class="line">        c.tiny = <span class="type">uintptr</span>(x)</span><br><span class="line">        c.tinyoffset = size</span><br><span class="line">    &#125;</span><br><span class="line">    size = maxTinySize</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... å‘å¸ƒå±éšœå’Œè¿”å›</span></span><br><span class="line">    publicationBarrier()</span><br><span class="line">    <span class="keyword">return</span> x, size</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å°å¯¹è±¡æ— æ‰«æåˆ†é…mallocgcsmallnoscan">7.4.2å°å¯¹è±¡æ— æ‰«æåˆ†é…ï¼šmallocgcSmallNoscan</h4><blockquote><p>ç”¨äº 16B~32KB ä¸”æ— æŒ‡é’ˆçš„å¯¹è±¡ã€‚</p></blockquote><p>å…³é”®ç‚¹ï¼š</p><ul><li><p>æŸ¥è¡¨ä¼˜åŒ–ï¼šä¸¤ä¸ªæŸ¥æ‰¾è¡¨è¦†ç›–ä¸åŒå¤§å°èŒƒå›´</p></li><li><p>å»¶è¿Ÿå½’é›¶ï¼šåªåœ¨éœ€è¦æ—¶å½’é›¶</p></li><li><p>GC åä½œï¼šé»‘è‰²åˆ†é…æˆ–è®¾ç½® freeIndexForScan</p></li><li><p>å‘å¸ƒå±éšœï¼šç¡®ä¿å†…å­˜å¯è§æ€§</p></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mallocgcSmallNoscan</span><span class="params">(size <span class="type">uintptr</span>, typ *_type, needzero <span class="type">bool</span>)</span></span> (unsafe.Pointer, <span class="type">uintptr</span>) &#123;</span><br><span class="line">    mp := acquirem()</span><br><span class="line">    mp.mallocing = <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    c := getMCache(mp)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 1. ç¡®å®š size class ==========</span></span><br><span class="line">    <span class="keyword">var</span> sizeclass <span class="type">uint8</span></span><br><span class="line">    <span class="keyword">if</span> size &lt;= gc.SmallSizeMax<span class="number">-8</span> &#123;</span><br><span class="line">        sizeclass = gc.SizeToSizeClass8[divRoundUp(size, gc.SmallSizeDiv)]</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sizeclass = gc.SizeToSizeClass128[divRoundUp(size-gc.SmallSizeMax, gc.LargeSizeDiv)]</span><br><span class="line">    &#125;</span><br><span class="line">    size = <span class="type">uintptr</span>(gc.SizeClassToSize[sizeclass])</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 2. ä» mcache åˆ†é… ==========</span></span><br><span class="line">    spc := makeSpanClass(sizeclass, <span class="literal">true</span>)  <span class="comment">// true = noscan</span></span><br><span class="line">    span := c.alloc[spc]</span><br><span class="line">    v := nextFreeFast(span)</span><br><span class="line">    <span class="keyword">if</span> v == <span class="number">0</span> &#123;</span><br><span class="line">        v, span, checkGCTrigger = c.nextFree(spc)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 3. æŒ‰éœ€å½’é›¶ ==========</span></span><br><span class="line">    x := unsafe.Pointer(v)</span><br><span class="line">    <span class="keyword">if</span> needzero &amp;&amp; span.needzero != <span class="number">0</span> &#123;</span><br><span class="line">        memclrNoHeapPointers(x, size)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 4. å‘å¸ƒå±éšœ ==========</span></span><br><span class="line">    publicationBarrier()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 5. GC æœŸé—´åˆ†é…é»‘è‰² ==========</span></span><br><span class="line">    <span class="keyword">if</span> writeBarrier.enabled &#123;</span><br><span class="line">        gcmarknewobject(span, <span class="type">uintptr</span>(x))</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        span.freeIndexForScan = span.freeindex</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> x, size</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å°å¯¹è±¡æœ‰æ‰«æåˆ†é…æ— -headermallocgcsmallscannoheader">7.4.3å°å¯¹è±¡æœ‰æ‰«æåˆ†é…ï¼ˆæ—  Headerï¼‰ï¼šmallocgcSmallScanNoHeader</h4><blockquote><p>ç”¨äºå¸¦æŒ‡é’ˆçš„å°å¯¹è±¡ï¼Œä¸”å †ä½å›¾åœ¨ span ä¸­ã€‚</p></blockquote><p>å…³é”®ç‚¹ï¼š</p><ul><li><p>å †ä½å›¾è®¾ç½®ï¼šheapSetTypeNoHeader æ ¹æ®ç±»å‹è®¾ç½®æŒ‡é’ˆä½å›¾</p></li><li><p>æ‰«æç»Ÿè®¡ï¼šç´¯åŠ  scanAlloc ç”¨äº GC è°ƒåº¦</p></li><li><p>8å­—èŠ‚ä¼˜åŒ–ï¼š64ä½å¹³å°çš„ç‰¹æ®Šå¤„ç†</p></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mallocgcSmallScanNoHeader</span><span class="params">(size <span class="type">uintptr</span>, typ *_type)</span></span> (unsafe.Pointer, <span class="type">uintptr</span>) &#123;</span><br><span class="line">    mp := acquirem()</span><br><span class="line">    mp.mallocing = <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    c := getMCache(mp)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 1. ç¡®å®š size class ==========</span></span><br><span class="line">    sizeclass := gc.SizeToSizeClass8[divRoundUp(size, gc.SmallSizeDiv)]</span><br><span class="line">    spc := makeSpanClass(sizeclass, <span class="literal">false</span>)  <span class="comment">// false = scan</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 2. åˆ†é…å’Œå½’é›¶ ==========</span></span><br><span class="line">    span := c.alloc[spc]</span><br><span class="line">    v := nextFreeFast(span)</span><br><span class="line">    <span class="keyword">if</span> v == <span class="number">0</span> &#123;</span><br><span class="line">        v, span, checkGCTrigger = c.nextFree(spc)</span><br><span class="line">    &#125;</span><br><span class="line">    x := unsafe.Pointer(v)</span><br><span class="line">    <span class="keyword">if</span> span.needzero != <span class="number">0</span> &#123;</span><br><span class="line">        memclrNoHeapPointers(x, size)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 3. è®¾ç½®å †ä½å›¾ï¼ˆç±»å‹ä¿¡æ¯ï¼‰==========</span></span><br><span class="line">    <span class="keyword">if</span> goarch.PtrSize == <span class="number">8</span> &amp;&amp; sizeclass == <span class="number">1</span> &#123;</span><br><span class="line">        <span class="comment">// 8 å­—èŠ‚ class åœ¨ 64 ä½å¹³å°å·²é¢„è®¾æŒ‡é’ˆä½</span></span><br><span class="line">        c.scanAlloc += <span class="number">8</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        c.scanAlloc += heapSetTypeNoHeader(<span class="type">uintptr</span>(x), size, typ, span)</span><br><span class="line">    &#125;</span><br><span class="line">    size = <span class="type">uintptr</span>(gc.SizeClassToSize[sizeclass])</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 4. å‘å¸ƒå±éšœ + GC åä½œ ==========</span></span><br><span class="line">    publicationBarrier()</span><br><span class="line">    <span class="keyword">if</span> writeBarrier.enabled &#123;</span><br><span class="line">        gcmarknewobject(span, <span class="type">uintptr</span>(x))</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        span.freeIndexForScan = span.freeindex</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> x, size</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å°å¯¹è±¡æœ‰æ‰«æåˆ†é…æœ‰-headermallocgcsmallscanheader">7.4.4å°å¯¹è±¡æœ‰æ‰«æåˆ†é…ï¼ˆæœ‰ Headerï¼‰ï¼šmallocgcSmallScanHeader</h4><blockquote><p>ç”¨äºå¸¦æŒ‡é’ˆçš„å°å¯¹è±¡ï¼Œéœ€è¦ malloc header å­˜å‚¨ç±»å‹ä¿¡æ¯ã€‚</p></blockquote><p>Malloc Header è®¾è®¡ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+------------------+</span><br><span class="line">| *_type (header)  ä¸¨  &lt;- æŒ‡å‘ç±»å‹å…ƒæ•°æ®çš„æŒ‡é’ˆ</span><br><span class="line">+------------------+</span><br><span class="line">| å®é™…å¯¹è±¡æ•°æ®       |  &lt;- x æŒ‡å‘è¿™é‡Œ</span><br><span class="line">+------------------+</span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆéœ€è¦ Headerï¼š</p><ul><li><p>å½“å¯¹è±¡è¾ƒå¤§ä¸”å †ä½å›¾ä¸åœ¨ span ä¸­æ—¶ï¼Œéœ€è¦é¢å¤–å­˜å‚¨ç±»å‹ä¿¡æ¯</p></li><li><p>Header å­˜å‚¨ç±»å‹æŒ‡é’ˆï¼ŒGC å¯ä»¥å¿«é€Ÿæ‰¾åˆ°å¯¹è±¡çš„ç±»å‹ä¿¡æ¯</p></li><li><p>æƒè¡¡ï¼šå¢åŠ å°‘é‡ç©ºé—´æ¢å–æ›´å¿«çš„ GC æ‰«æ</p></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mallocgcSmallScanHeader</span><span class="params">(size <span class="type">uintptr</span>, typ *_type)</span></span> (unsafe.Pointer, <span class="type">uintptr</span>) &#123;</span><br><span class="line">    mp := acquirem()</span><br><span class="line">    mp.mallocing = <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    c := getMCache(mp)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 1. å¢åŠ  header ç©ºé—´ ==========</span></span><br><span class="line">    size += gc.MallocHeaderSize</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 2. ç¡®å®š size class ==========</span></span><br><span class="line">    <span class="keyword">var</span> sizeclass <span class="type">uint8</span></span><br><span class="line">    <span class="keyword">if</span> size &lt;= gc.SmallSizeMax<span class="number">-8</span> &#123;</span><br><span class="line">        sizeclass = gc.SizeToSizeClass8[divRoundUp(size, gc.SmallSizeDiv)]</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sizeclass = gc.SizeToSizeClass128[divRoundUp(size-gc.SmallSizeMax, gc.LargeSizeDiv)]</span><br><span class="line">    &#125;</span><br><span class="line">    size = <span class="type">uintptr</span>(gc.SizeClassToSize[sizeclass])</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 3. åˆ†é…å’Œå½’é›¶ ==========</span></span><br><span class="line">    spc := makeSpanClass(sizeclass, <span class="literal">false</span>)</span><br><span class="line">    span := c.alloc[spc]</span><br><span class="line">    v := nextFreeFast(span)</span><br><span class="line">    <span class="keyword">if</span> v == <span class="number">0</span> &#123;</span><br><span class="line">        v, span, checkGCTrigger = c.nextFree(spc)</span><br><span class="line">    &#125;</span><br><span class="line">    x := unsafe.Pointer(v)</span><br><span class="line">    <span class="keyword">if</span> span.needzero != <span class="number">0</span> &#123;</span><br><span class="line">        memclrNoHeapPointers(x, size)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 4. è®¾ç½® malloc header ==========</span></span><br><span class="line">    header := (**_type)(x)</span><br><span class="line">    x = add(x, gc.MallocHeaderSize)  <span class="comment">// è·³è¿‡ header</span></span><br><span class="line">    c.scanAlloc += heapSetTypeSmallHeader(<span class="type">uintptr</span>(x), size-gc.MallocHeaderSize, typ, header, span)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 5. å‘å¸ƒå±éšœ + GC åä½œ ==========</span></span><br><span class="line">    publicationBarrier()</span><br><span class="line">    <span class="keyword">if</span> writeBarrier.enabled &#123;</span><br><span class="line">        gcmarknewobject(span, <span class="type">uintptr</span>(x)-gc.MallocHeaderSize)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        span.freeIndexForScan = span.freeindex</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> x, size</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å¤§å¯¹è±¡åˆ†é…mallocgclarge">7.4.5 å¤§å¯¹è±¡åˆ†é…ï¼šmallocgcLarge</h4><blockquote><p>ç”¨äº &gt; 32KB çš„å¯¹è±¡ã€‚</p></blockquote><p>å¤§å¯¹è±¡ä¼˜åŒ–ï¼š</p><ul><li><p>ç›´æ¥åˆ†é…ï¼šç»•è¿‡ mcache/mcentralï¼Œç›´æ¥ä» mheap</p></li><li><p>largeType å­—æ®µï¼šé¿å…ä¸ºå¤§å¯¹è±¡åˆ›å»ºå¤æ‚çš„ä½å›¾</p></li><li><p>åˆ†å—å½’é›¶ï¼šå…è®¸æŠ¢å ï¼Œå‡å°‘å»¶è¿Ÿ</p></li><li><p>é‡èº«å®šåšï¼šæ¯ä¸ªå¤§å¯¹è±¡æœ‰ä¸“å±çš„ span</p></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mallocgcLarge</span><span class="params">(size <span class="type">uintptr</span>, typ *_type, needzero <span class="type">bool</span>)</span></span> (unsafe.Pointer, <span class="type">uintptr</span>) &#123;</span><br><span class="line">    mp := acquirem()</span><br><span class="line">    mp.mallocing = <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    c := getMCache(mp)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 1. ç›´æ¥ä» mheap åˆ†é… ==========</span></span><br><span class="line">    span := c.allocLarge(size, typ == <span class="literal">nil</span> || !typ.Pointers())</span><br><span class="line">    span.freeindex = <span class="number">1</span></span><br><span class="line">    span.allocCount = <span class="number">1</span></span><br><span class="line">    span.largeType = <span class="literal">nil</span>  <span class="comment">// æš‚æ—¶è®¾ä¸º nilï¼Œé˜²æ­¢ GC è¿‡æ—©æ‰«æ</span></span><br><span class="line">    </span><br><span class="line">    size = span.elemsize</span><br><span class="line">    x := unsafe.Pointer(span.base())</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 2. å‘å¸ƒå±éšœ ==========</span></span><br><span class="line">    publicationBarrier()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 3. GC åä½œ ==========</span></span><br><span class="line">    <span class="keyword">if</span> writeBarrier.enabled &#123;</span><br><span class="line">        gcmarknewobject(span, <span class="type">uintptr</span>(x))</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        span.freeIndexForScan = span.freeindex</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 4. è®¾ç½®ç±»å‹ä¿¡æ¯ ==========</span></span><br><span class="line">    <span class="keyword">if</span> typ != <span class="literal">nil</span> &amp;&amp; typ.Pointers() &#123;</span><br><span class="line">        <span class="keyword">if</span> !heapBitsInSpan(span.elemsize) &#123;</span><br><span class="line">            <span class="comment">// å¤§å¯¹è±¡ä½¿ç”¨ largeType å­—æ®µ</span></span><br><span class="line">            span.largeType = typ</span><br><span class="line">            <span class="comment">// å‘å¸ƒå±éšœç¡®ä¿ largeType å¯è§</span></span><br><span class="line">            publicationBarrier()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            c.scanAlloc += heapSetTypeLarge(<span class="type">uintptr</span>(x), span.elemsize, typ, span)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 5. æŒ‰éœ€å½’é›¶ï¼ˆå¯æŠ¢å ï¼‰ ==========</span></span><br><span class="line">    <span class="keyword">if</span> needzero &amp;&amp; span.needzero != <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> goexperiment.AllocHeaders &#123;</span><br><span class="line">            memclrNoHeapPointersChunked(size, x)  <span class="comment">// åˆ†å—å½’é›¶</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            memclrNoHeapPointers(x, size)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> x, size</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å…«go-1.20-æ–°å¢ç‰¹æ€§">å…«ã€Go 1.20+ æ–°å¢ç‰¹æ€§</h2><p>Go åœ¨ 1.16 ä¹‹åçš„ç‰ˆæœ¬ä¸­å¼•å…¥äº†å¤šé¡¹é‡è¦çš„å†…å­˜ç®¡ç†ç‰¹æ€§ï¼Œæå¤§åœ°å¢å¼ºäº† Goçš„èƒ½åŠ›å’Œçµæ´»æ€§ã€‚</p><h3 id="user-arenago-1.20">8.1 User Arenaï¼ˆGo 1.20+ï¼‰</h3><h4 id="æ¦‚è¿°-4">æ¦‚è¿°</h4><p>User Arenaå…è®¸åº”ç”¨ç¨‹åº<strong>æ‰‹åŠ¨ç®¡ç†</strong>ä¸€ç»„å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ‰€æœ‰å¯¹è±¡åœ¨åŒä¸€ä¸ªarena ä¸­åˆ†é…ï¼Œå¯ä»¥ä¸€æ¬¡æ€§é‡Šæ”¾æ•´ä¸ª arenaã€‚</p><h4 id="ä½¿ç”¨åœºæ™¯">ä½¿ç”¨åœºæ™¯</h4><ul><li><strong>ä¸´æ—¶æ•°æ®å¤„ç†</strong>ï¼šè¯·æ±‚å¤„ç†å®Œåæ‰¹é‡é‡Šæ”¾</li><li><strong>è¯·æ±‚çº§åˆ«å†…å­˜æ± </strong>ï¼šæ¯ä¸ªè¯·æ±‚ä¸€ä¸ª arena</li><li><strong>å‡å°‘ GC å‹åŠ›</strong>ï¼šå¤§é‡ä¸´æ—¶å¯¹è±¡ä¸è¿›å…¥ GC æ‰«æ</li></ul><h4 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> mheap <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// mheap ä¸­çš„ user arena çŠ¶æ€</span></span><br><span class="line">userArena <span class="keyword">struct</span> &#123;</span><br><span class="line">    arenaHints     *arenaHint   <span class="comment">// åˆ†é…æç¤º</span></span><br><span class="line">    quarantineList mSpanList    <span class="comment">// éš”ç¦»åˆ—è¡¨ï¼ˆç­‰å¾…æ— æŒ‡é’ˆå¼•ç”¨ï¼‰</span></span><br><span class="line">    readyList      mSpanList    <span class="comment">// å°±ç»ªåˆ—è¡¨ï¼ˆå¯å¤ç”¨ï¼‰</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> mspan <span class="keyword">struct</span> &#123;</span><br><span class="line">  <span class="comment">// mspan ä¸­çš„æ ‡è®°</span></span><br><span class="line">  isUserArenaChunk   <span class="type">bool</span>      <span class="comment">// æ˜¯å¦ä¸º user arena chunk</span></span><br><span class="line">  userArenaChunkFree addrRange <span class="comment">// chunk åˆ†é…ç®¡ç†</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä½¿ç”¨ç¤ºä¾‹">ä½¿ç”¨ç¤ºä¾‹</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;arena&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processRequest</span><span class="params">(data []<span class="type">byte</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»º arena</span></span><br><span class="line">    a := arena.NewArena()</span><br><span class="line">    <span class="keyword">defer</span> a.Free()  <span class="comment">// æ‰¹é‡é‡Šæ”¾</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åœ¨ arena ä¸­åˆ†é…å¯¹è±¡</span></span><br><span class="line">    obj := arena.New[MyStruct](a)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä½¿ç”¨å¯¹è±¡...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="weak-pointergo-1.23">8.2 Weak Pointerï¼ˆGo 1.23+ï¼‰</h3><h4 id="æ¦‚è¿°-5">æ¦‚è¿°</h4><p>å¼±å¼•ç”¨æœºåˆ¶å…è®¸æŒæœ‰å¯¹è±¡çš„å¼•ç”¨ï¼Œä½†<strong>ä¸é˜»æ­¢ GCå›æ”¶</strong>è¯¥å¯¹è±¡ã€‚</p><h4 id="ä½¿ç”¨åœºæ™¯-1">ä½¿ç”¨åœºæ™¯</h4><ul><li><strong>ç¼“å­˜</strong>ï¼šç¼“å­˜æ¡ç›®å¯ä»¥è¢« GC å›æ”¶</li><li><strong>Observer æ¨¡å¼</strong>ï¼šè§‚å¯Ÿè€…ä¸é˜»æ­¢è¢«è§‚å¯Ÿå¯¹è±¡å›æ”¶</li><li><strong>å¾ªç¯å¼•ç”¨æ‰“ç ´</strong>ï¼šé¿å…å†…å­˜æ³„æ¼</li></ul><h4 id="æ•°æ®ç»“æ„-1">æ•°æ®ç»“æ„</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mheap ä¸­çš„å¼±æŒ‡é’ˆæ˜ å°„</span></span><br><span class="line">immortalWeakHandles immortalWeakHandleMap  <span class="comment">// ä¸æœ½å¯¹è±¡çš„å¼±æŒ‡é’ˆ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Special è®°å½•</span></span><br><span class="line">specialWeakHandle <span class="keyword">struct</span> &#123;</span><br><span class="line">    special special</span><br><span class="line">    handle *atomic.Uintptr  <span class="comment">// å¼±æŒ‡é’ˆå¥æŸ„</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä½¿ç”¨ç¤ºä¾‹-1">ä½¿ç”¨ç¤ºä¾‹</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;weak&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Cache <span class="keyword">struct</span> &#123;</span><br><span class="line">    items <span class="keyword">map</span>[<span class="type">string</span>]weak.Pointer[*Item]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Cache)</span></span> Get(key <span class="type">string</span>) *Item &#123;</span><br><span class="line">    wp := c.items[key]</span><br><span class="line">    <span class="keyword">return</span> wp.Value()  <span class="comment">// å¯èƒ½è¿”å› nilï¼ˆå·²è¢« GCï¼‰</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Cache)</span></span> Set(key <span class="type">string</span>, item *Item) &#123;</span><br><span class="line">    c.items[key] = weak.Make(item)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å®ç°ç»†èŠ‚">å®ç°ç»†èŠ‚</h4><ul><li>å¼±æŒ‡é’ˆæœ¬èº«ä¸å ç”¨ GC æ‰«ææ—¶é—´</li><li>å¯¹è±¡è¢«å›æ”¶åï¼Œå¼±æŒ‡é’ˆè‡ªåŠ¨å˜ä¸º nil</li><li>å¼±æŒ‡é’ˆè½¬å¼ºæŒ‡é’ˆéœ€è¦ç¡®ä¿ span å·²æ¸…æ‰«</li></ul><h3 id="cleanup-æœºåˆ¶go-1.24">8.3 Cleanup æœºåˆ¶ï¼ˆGo 1.24+ï¼‰</h3><h4 id="æ¦‚è¿°-6">æ¦‚è¿°</h4><p>ç±»ä¼¼ finalizerä½†æ›´å®‰å…¨çš„èµ„æºæ¸…ç†æœºåˆ¶ï¼Œ<strong>ä¸ä¼šä½¿å¯¹è±¡å¤æ´»</strong>ã€‚</p><h4 id="cleanup-vs-finalizer">Cleanup vs Finalizer</h4><table><thead><tr><th>ç‰¹æ€§</th><th>Finalizer</th><th>Cleanup</th></tr></thead><tbody><tr><td>å¯¹è±¡å¤æ´»</td><td>ä¼š</td><td>ä¸ä¼š</td></tr><tr><td>æ‰§è¡Œæ—¶æœº</td><td>ç¬¬ä¸€æ¬¡å˜æˆä¸å¯è¾¾</td><td>å¯¹è±¡çœŸæ­£é‡Šæ”¾å‰</td></tr><tr><td>å¤šä¸ªå›è°ƒ</td><td>ä¸æ”¯æŒ</td><td>æ”¯æŒ</td></tr><tr><td>GC å»¶è¿Ÿ</td><td>è¾ƒå¤§</td><td>è¾ƒå°</td></tr></tbody></table><h4 id="æ•°æ®ç»“æ„-2">æ•°æ®ç»“æ„</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mheap ä¸­çš„ cleanup ID</span></span><br><span class="line">cleanupID <span class="type">uint64</span>  <span class="comment">// å…¨å±€å”¯ä¸€ ID è®¡æ•°å™¨</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Special è®°å½•</span></span><br><span class="line">specialCleanup <span class="keyword">struct</span> &#123;</span><br><span class="line">    special special</span><br><span class="line">    fn *funcval  <span class="comment">// æ¸…ç†å‡½æ•°</span></span><br><span class="line">    id <span class="type">uint64</span>    <span class="comment">// å…¨å±€å”¯ä¸€ ID</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä½¿ç”¨ç¤ºä¾‹-2">ä½¿ç”¨ç¤ºä¾‹</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;runtime&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Resource <span class="keyword">struct</span> &#123;</span><br><span class="line">    handle <span class="type">uintptr</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewResource</span><span class="params">()</span></span> *Resource &#123;</span><br><span class="line">    r := &amp;Resource&#123;handle: openResource()&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ³¨å†Œ cleanupï¼ˆä¸ä¼šä½¿ r å¤æ´»ï¼‰</span></span><br><span class="line">    runtime.AddCleanup(r, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        closeResource(r.handle)</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="pinner-æœºåˆ¶go-1.21">8.4 Pinner æœºåˆ¶ï¼ˆGo 1.21+ï¼‰</h3><h4 id="æ¦‚è¿°-7">æ¦‚è¿°</h4><p>å›ºå®šå¯¹è±¡åœ¨å†…å­˜ä¸­çš„ä½ç½®ï¼Œé˜²æ­¢ GC ç§»åŠ¨ï¼ˆä¸ºæœªæ¥çš„ç§»åŠ¨å¼ GCåšå‡†å¤‡ï¼‰ã€‚</p><h4 id="ä½¿ç”¨åœºæ™¯-2">ä½¿ç”¨åœºæ™¯</h4><ul><li><strong>CGO äº¤äº’</strong>ï¼šC ä»£ç æŒæœ‰ Go å¯¹è±¡æŒ‡é’ˆ</li><li><strong>DMA æ“ä½œ</strong>ï¼šç¡¬ä»¶ç›´æ¥è®¿é—®å†…å­˜</li><li><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼šé¿å…æŸäº›çƒ­ç‚¹å¯¹è±¡ç§»åŠ¨</li></ul><h4 id="æ•°æ®ç»“æ„-3">æ•°æ®ç»“æ„</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mspan ä¸­çš„ pin ä½å›¾</span></span><br><span class="line">pinnerBits *gcBits  <span class="comment">// æ ‡è®°å“ªäº›å¯¹è±¡è¢«å›ºå®š</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Special è®°å½•ï¼ˆæ”¯æŒå¤šæ¬¡ pinï¼‰</span></span><br><span class="line">specialPinCounter <span class="keyword">struct</span> &#123;</span><br><span class="line">    special special</span><br><span class="line">    counter <span class="type">uintptr</span>  <span class="comment">// pin è®¡æ•°</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä½¿ç”¨ç¤ºä¾‹-3">ä½¿ç”¨ç¤ºä¾‹</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;runtime&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">passToC</span><span class="params">(data []<span class="type">byte</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> pinner runtime.Pinner</span><br><span class="line">    pinner.Pin(&amp;data[<span class="number">0</span>])  <span class="comment">// å›ºå®šåˆ‡ç‰‡åº•å±‚æ•°ç»„</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è°ƒç”¨ C å‡½æ•°</span></span><br><span class="line">    C.processData(unsafe.Pointer(&amp;data[<span class="number">0</span>]), C.<span class="type">int</span>(<span class="built_in">len</span>(data)))</span><br><span class="line">    </span><br><span class="line">    pinner.Unpin()  <span class="comment">// è§£é™¤å›ºå®š</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="greenteagcå®éªŒæ€§go-1.24">8.5 GreenTeaGCï¼ˆå®éªŒæ€§ï¼ŒGo 1.24+ï¼‰</h3><h4 id="æ¦‚è¿°-8">æ¦‚è¿°</h4><p>å®éªŒæ€§çš„æ–° GC ç®—æ³•ï¼Œæ—¨åœ¨è¿›ä¸€æ­¥é™ä½å»¶è¿Ÿã€‚</p><h4 id="å…³é”®æ”¹è¿›">å…³é”®æ”¹è¿›</h4><ul><li><strong>Span Inline Mark Bits</strong>ï¼šå°† mark bits å†…è”åˆ° spanä¸­</li><li><strong>å¢é‡æ ‡è®°</strong>ï¼šæ›´ç»†ç²’åº¦çš„æ ‡è®°æ§åˆ¶</li><li><strong>å‡å°‘åœé¡¿</strong>ï¼šä¼˜åŒ– STW é˜¶æ®µ</li></ul><h4 id="æ•°æ®ç»“æ„-4">æ•°æ®ç»“æ„</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mspan ä¸­çš„ GreenTeaGC å­—æ®µ</span></span><br><span class="line">scanIdx <span class="type">uint16</span>  <span class="comment">// æ‰«æç´¢å¼•</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// heapArena ä¸­çš„ä½å›¾</span></span><br><span class="line">pageUseSpanInlineMarkBits [pagesPerArena / <span class="number">8</span>]<span class="type">uint8</span></span><br></pre></td></tr></table></figure><h4 id="å¯ç”¨æ–¹å¼">å¯ç”¨æ–¹å¼</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GOEXPERIMENT=greentea go build myapp.go</span><br></pre></td></tr></table></figure><h2 id="ä¹æ€§èƒ½ä¼˜åŒ–æŠ€å·§">ä¹ã€æ€§èƒ½ä¼˜åŒ–æŠ€å·§</h2><h3 id="å‡å°‘å†…å­˜åˆ†é…">9.1 å‡å°‘å†…å­˜åˆ†é…</h3><h4 id="å¤ç”¨å¯¹è±¡sync.pool">1. å¤ç”¨å¯¹è±¡ï¼ˆsync.Poolï¼‰</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bufferPool = sync.Pool&#123;</span><br><span class="line">    New: <span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">new</span>(bytes.Buffer)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">()</span></span> &#123;</span><br><span class="line">    buf := bufferPool.Get().(*bytes.Buffer)</span><br><span class="line">    <span class="keyword">defer</span> bufferPool.Put(buf)</span><br><span class="line">    buf.Reset()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä½¿ç”¨ buf...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="é¢„åˆ†é…åˆ‡ç‰‡">2. é¢„åˆ†é…åˆ‡ç‰‡</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸å¥½</span></span><br><span class="line"><span class="keyword">var</span> items []Item</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</span><br><span class="line">    items = <span class="built_in">append</span>(items, Item&#123;&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¥½</span></span><br><span class="line">items := <span class="built_in">make</span>([]Item, <span class="number">0</span>, <span class="number">1000</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</span><br><span class="line">    items = <span class="built_in">append</span>(items, Item&#123;&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å­—ç¬¦ä¸²æ‹¼æ¥ä¼˜åŒ–">3. å­—ç¬¦ä¸²æ‹¼æ¥ä¼˜åŒ–</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸å¥½</span></span><br><span class="line">s := <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100</span>; i++ &#123;</span><br><span class="line">    s += <span class="string">&quot;a&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¥½</span></span><br><span class="line"><span class="keyword">var</span> b strings.Builder</span><br><span class="line">b.Grow(<span class="number">100</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100</span>; i++ &#123;</span><br><span class="line">    b.WriteString(<span class="string">&quot;a&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">s := b.String()</span><br></pre></td></tr></table></figure><h3 id="é¿å…é€ƒé€¸">9.2 é¿å…é€ƒé€¸</h3><h4 id="è¿”å›å€¼è€ŒéæŒ‡é’ˆ">1. è¿”å›å€¼è€ŒéæŒ‡é’ˆ</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é€ƒé€¸</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newPoint</span><span class="params">()</span></span> *Point &#123;</span><br><span class="line">    p := Point&#123;x: <span class="number">1</span>, y: <span class="number">2</span>&#125;</span><br><span class="line">    <span class="keyword">return</span> &amp;p  <span class="comment">// é€ƒé€¸</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸é€ƒé€¸</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newPoint</span><span class="params">()</span></span> Point &#123;</span><br><span class="line">    <span class="keyword">return</span> Point&#123;x: <span class="number">1</span>, y: <span class="number">2</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä½¿ç”¨ç¡®å®šå¤§å°çš„æ•°ç»„">2. ä½¿ç”¨ç¡®å®šå¤§å°çš„æ•°ç»„</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é€ƒé€¸</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">()</span></span> &#123;</span><br><span class="line">    data := <span class="built_in">make</span>([]<span class="type">byte</span>, n)  <span class="comment">// å¦‚æœ n ä¸æ˜¯å¸¸é‡ï¼Œå¯èƒ½é€ƒé€¸</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸é€ƒé€¸</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> data [<span class="number">1024</span>]<span class="type">byte</span>  <span class="comment">// æ•°ç»„åœ¨æ ˆä¸Š</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ£€æµ‹å·¥å…·">9.3 æ£€æµ‹å·¥å…·</h3><h4 id="é€ƒé€¸åˆ†æ-1">é€ƒé€¸åˆ†æ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go build -gcflags=<span class="string">&quot;-m&quot;</span> main.go</span><br></pre></td></tr></table></figure><h4 id="å†…å­˜åˆ†æ">å†…å­˜åˆ†æ</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> _ <span class="string">&quot;net/http/pprof&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        http.ListenAndServe(<span class="string">&quot;localhost:6060&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line">    &#125;()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¿é—® http://localhost:6060/debug/pprof/heap</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="trace-åˆ†æ">Trace åˆ†æ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go <span class="built_in">test</span> -trace=trace.out</span><br><span class="line">go tool trace trace.out</span><br></pre></td></tr></table></figure><hr /><h2 id="åæ€»ç»“">åã€æ€»ç»“</h2><h3 id="å†…å­˜æ¨¡å‹æ¼”è¿›">10.1 å†…å­˜æ¨¡å‹æ¼”è¿›</h3><p>ä» Go 1.16 åˆ° Go 1.25.3ï¼Œå†…å­˜æ¨¡å‹çš„ä¸»è¦æ¼”è¿›æ–¹å‘ï¼š</p><ol type="1"><li><strong>æ›´çµæ´»çš„å†…å­˜ç®¡ç†</strong><ul><li>User Arenaï¼šç”¨æˆ·å¯æ§çš„æ‰¹é‡åˆ†é…/é‡Šæ”¾</li><li>é€‚åº”æ›´å¤šåœºæ™¯éœ€æ±‚</li></ul></li><li><strong>æ›´ä¸°å¯Œçš„å¼•ç”¨è¯­ä¹‰</strong><ul><li>Weak Pointerï¼šæ”¯æŒå¼±å¼•ç”¨</li><li>æ‰“ç ´å¾ªç¯å¼•ç”¨ï¼Œä¼˜åŒ–ç¼“å­˜</li></ul></li><li><strong>æ›´å®‰å…¨çš„èµ„æºç®¡ç†</strong><ul><li>Cleanup æœºåˆ¶ï¼šä¸ä¼šä½¿å¯¹è±¡å¤æ´»</li><li>å‡å°‘ finalizer å¸¦æ¥çš„é—®é¢˜</li></ul></li><li><strong>æ›´å¥½çš„ CGO æ”¯æŒ</strong><ul><li>Pinner æœºåˆ¶ï¼šå›ºå®šå¯¹è±¡ä½ç½®</li><li>å®‰å…¨åœ°ä¸ C ä»£ç äº¤äº’</li></ul></li><li><strong>æŒç»­çš„ GC ä¼˜åŒ–</strong><ul><li>GreenTeaGCï¼šå®éªŒæ€§çš„ä½å»¶è¿Ÿ GC</li><li>Inline mark bitsï¼šå‡å°‘å†…å­˜å¼€é”€</li></ul></li></ol><h3 id="æ ¸å¿ƒè®¾è®¡åŸåˆ™">10.2 æ ¸å¿ƒè®¾è®¡åŸåˆ™</h3><p>Go å†…å­˜åˆ†é…å™¨çš„æ ¸å¿ƒè®¾è®¡åŸåˆ™å§‹ç»ˆå¦‚ä¸€ï¼š</p><ol type="1"><li><strong>å¤šå±‚çº§ç¼“å­˜</strong>ï¼š<ul><li><strong>æœ¬åœ°ç¼“å­˜</strong>ï¼šmcacheï¼ˆPer-Pï¼Œæ— é”ï¼‰</li><li><strong>ä¸­å¤®ç´¢å¼•</strong>ï¼šmcentralï¼ˆæŒ‰ size classï¼Œéœ€è¦é”ï¼‰</li><li><strong>å…¨å±€å †</strong>ï¼šmheapï¼ˆå…¨å±€ï¼Œéœ€è¦å…¨å±€é”ï¼‰</li><li><strong>è™šæ‹Ÿå†…å­˜</strong>ï¼šheapArenaï¼ˆ64MB å•å…ƒï¼‰</li></ul></li><li><strong>å‡å°‘é”ç«äº‰</strong>ï¼šPer-P ç¼“å­˜ + ç»†ç²’åº¦é”</li><li><strong>åˆ†çº§ç®¡ç†</strong>ï¼š68 ä¸ª size class å‡å°‘ç¢ç‰‡</li><li><strong>å»¶è¿Ÿå½’é›¶</strong>ï¼šæŒ‰éœ€æ¸…é›¶æé«˜æ€§èƒ½</li><li><strong>ä¸ GC åä½œ</strong>ï¼šåŒç¼“å†²ã€sweepgen ç­‰æœºåˆ¶</li></ol><h3 id="æœ€ä½³å®è·µ">10.3 æœ€ä½³å®è·µ</h3><ol type="1"><li><strong>ç†è§£å†…å­˜åˆ†é…è·¯å¾„</strong>ï¼šä¼˜å…ˆä½¿ç”¨ mcacheçš„æ— é”å¿«é€Ÿè·¯å¾„</li><li><strong>å‡å°‘é€ƒé€¸</strong>ï¼šè®©å¯¹è±¡å°½é‡åœ¨æ ˆä¸Šåˆ†é…</li><li><strong>å¤ç”¨å¯¹è±¡</strong>ï¼šä½¿ç”¨ sync.Pool å‡å°‘åˆ†é…</li><li><strong>é¢„åˆ†é…å®¹é‡</strong>ï¼šé¿å… slice/map åå¤æ‰©å®¹</li><li><strong>é€‰æ‹©åˆé€‚çš„ç‰¹æ€§</strong>ï¼šæ ¹æ®åœºæ™¯ä½¿ç”¨ User Arenaã€WeakPointer ç­‰</li></ol><h3 id="å‚è€ƒèµ„æ–™">10.4 å‚è€ƒèµ„æ–™</h3><ul><li><a href="https://go.dev/doc/">Go å®˜æ–¹æ–‡æ¡£</a></li><li><a href="https://github.com/golang/go/tree/master/src/runtime">Goè¿è¡Œæ—¶æºç </a></li><li><ahref="http://goog-perftools.sourceforge.net/doc/tcmalloc.html">TCMallocè®ºæ–‡</a></li><li><ahref="https://github.com/golang/proposal/blob/master/design/44167-gc-pacer-redesign.md">GoGC è®¾è®¡æ–‡æ¡£</a></li></ul><h2 id="é™„å½•å¸¸ç”¨å‘½ä»¤">é™„å½•ï¼šå¸¸ç”¨å‘½ä»¤</h2><h3 id="å†…å­˜ç›¸å…³ç¯å¢ƒå˜é‡">å†…å­˜ç›¸å…³ç¯å¢ƒå˜é‡</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GOGC=100          <span class="comment"># GC è§¦å‘æ—¶çš„å †å¢é•¿ç™¾åˆ†æ¯”</span></span><br><span class="line">GOMEMLIMIT=4GiB   <span class="comment"># å†…å­˜é™åˆ¶ï¼ˆGo 1.19+ï¼‰</span></span><br><span class="line">GODEBUG=gctrace=1 <span class="comment"># æ‰“å° GC è·Ÿè¸ªä¿¡æ¯</span></span><br></pre></td></tr></table></figure><h3 id="æ€§èƒ½åˆ†æ">æ€§èƒ½åˆ†æ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CPU profile</span></span><br><span class="line">go <span class="built_in">test</span> -cpuprofile=cpu.prof</span><br><span class="line">go tool pprof cpu.prof</span><br><span class="line"></span><br><span class="line"><span class="comment"># Memory profile</span></span><br><span class="line">go <span class="built_in">test</span> -memprofile=mem.prof</span><br><span class="line">go tool pprof mem.prof</span><br><span class="line"></span><br><span class="line"><span class="comment"># Trace</span></span><br><span class="line">go <span class="built_in">test</span> -trace=trace.out</span><br><span class="line">go tool trace trace.out</span><br></pre></td></tr></table></figure><h3 id="é€ƒé€¸åˆ†æ-2">é€ƒé€¸åˆ†æ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¼–è¯‘æ—¶æŸ¥çœ‹é€ƒé€¸åˆ†æ</span></span><br><span class="line">go build -gcflags=<span class="string">&quot;-m -m&quot;</span> main.go</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ±‡ç¼–ä»£ç </span></span><br><span class="line">go tool compile -S main.go</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">æœ¬æ–‡åŸºäº Go 1.25.3 æºç ï¼Œä»ç¬¬ä¸€æ€§åŸç†å‡ºå‘ï¼Œæ·±å…¥æ¢è®¨ Go çš„å†…å­˜æ¨¡å‹ï¼ŒåŒ…æ‹¬å†…å­˜åˆ†é…æœºåˆ¶ã€å®ç°åŸç†ã€ä½¿ç”¨åœºæ™¯ä»¥åŠæœ€æ–°ç‰¹æ€§ã€‚</summary>
    
    
    
    <category term="Go" scheme="https://hedon.top/categories/Go/"/>
    
    
    <category term="Go" scheme="https://hedon.top/tags/Go/"/>
    
    <category term="å†…å­˜ç®¡ç†" scheme="https://hedon.top/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"/>
    
    <category term="malloc" scheme="https://hedon.top/tags/malloc/"/>
    
  </entry>
  
  <entry>
    <title>Go åº•å±‚åŸç†ä¸¨interface</title>
    <link href="https://hedon.top/2025/11/17/go/go-interface/"/>
    <id>https://hedon.top/2025/11/17/go/go-interface/</id>
    <published>2025-11-17T05:00:00.000Z</published>
    <updated>2025-11-17T06:27:49.199Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€ä»ç¬¬ä¸€æ€§åŸç†ç†è§£-go-çš„ç±»å‹ç³»ç»Ÿè®¾è®¡">ä¸€ã€ä»ç¬¬ä¸€æ€§åŸç†ç†è§£ Goçš„ç±»å‹ç³»ç»Ÿè®¾è®¡</h2><p>æƒ³è¦ä»æ ¹æœ¬ä¸Šç†è§£ Go çš„<code>interface</code>ï¼Œæˆ‘ä»¬ä¸ä»…è¦çŸ¥é“å®ƒæ˜¯æ€ä¹ˆå®ç°çš„ï¼Œæ›´è¦çŸ¥é“ä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Œå®ƒçš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³ä»€ä¹ˆé—®é¢˜ã€‚</p><p>åœ¨é™æ€ç±»å‹è¯­è¨€ä¸­ï¼Œæˆ‘ä»¬é¢ä¸´ä¸€ä¸ªæ ¹æœ¬æ€§çš„çŸ›ç›¾ï¼š<strong><u>é™æ€ç±»å‹è¯­è¨€å¦‚ä½•å®ç°åŠ¨æ€å¤šæ€ï¼Ÿ</u></strong></p><ul><li><p>ç¼–è¯‘æœŸï¼šéœ€è¦ç±»å‹æ£€æŸ¥ï¼Œç¡®ä¿ç±»å‹å®‰å…¨</p></li><li><p>è¿è¡ŒæœŸï¼šéœ€è¦åŠ¨æ€åˆ†å‘ï¼Œå®ç°å¤šæ€</p></li></ul><p>Go é€šè¿‡æ¥å£ <code>interface</code> ä¼˜é›…åœ°è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚</p><p>Go åœ¨è¿è¡Œæ—¶å°†æ¥å£åˆ†ä¸ºä¸¤ç§è¡¨ç¤ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> iface <span class="keyword">struct</span> &#123;</span><br><span class="line">tab  *itab</span><br><span class="line">data unsafe.Pointer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> eface <span class="keyword">struct</span> &#123;</span><br><span class="line">_type *_type</span><br><span class="line">data  unsafe.Pointer</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>efaceï¼ˆEmpty Interfaceï¼‰ï¼šè¡¨ç¤ºç©ºæ¥å£ interface{} æˆ– any</p></li><li><p>ifaceï¼ˆNon-empty Interfaceï¼‰ï¼šè¡¨ç¤ºåŒ…å«æ–¹æ³•çš„æ¥å£</p></li></ul><h2 id="äºŒæ·±å…¥ç†è§£-iface-ç»“æ„">äºŒã€æ·±å…¥ç†è§£ iface ç»“æ„</h2><h3 id="iface-å†…å­˜å¸ƒå±€">2.1 iface å†…å­˜å¸ƒå±€</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> iface <span class="keyword">struct</span> &#123;</span><br><span class="line">    tab  *itab          <span class="comment">// æ¥å£è¡¨æŒ‡é’ˆï¼ˆ8å­—èŠ‚ï¼‰</span></span><br><span class="line">    data unsafe.Pointer <span class="comment">// å®é™…æ•°æ®æŒ‡é’ˆï¼ˆ8å­—èŠ‚ï¼‰</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ª 16 å­—èŠ‚ï¼ˆ64 ä½ç³»ç»Ÿï¼‰çš„ç»“æ„ï¼ŒåŒ…å«ä¸¤ä¸ªæŒ‡é’ˆï¼š</p><ul><li>tabï¼šæŒ‡å‘æ¥å£è¡¨ï¼ˆinterface tableï¼‰ï¼Œå­˜å‚¨ç±»å‹ä¿¡æ¯å’Œæ–¹æ³•é›†</li><li>dataï¼šæŒ‡å‘å®é™…çš„æ•°æ®</li></ul><h3 id="itab-çš„æ ¸å¿ƒç»“æ„">2.2 itab çš„æ ¸å¿ƒç»“æ„</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> itab = abi.ITab</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ITab <span class="keyword">struct</span> &#123;</span><br><span class="line">Inter *InterfaceType</span><br><span class="line">Type  *Type</span><br><span class="line">Hash  <span class="type">uint32</span>     <span class="comment">// copy of Type.Hash. Used for type switches.</span></span><br><span class="line">Fun   [<span class="number">1</span>]<span class="type">uintptr</span> <span class="comment">// variable sized. fun[0]==0 means Type does not implement Inter.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>itab</code> æ˜¯æ•´ä¸ªæ¥å£ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œå®ƒåŒ…å«ï¼š</p><ul><li><code>Inter</code>ï¼šæŒ‡å‘æ¥å£ç±»å‹çš„å…ƒæ•°æ®ï¼ˆæ¥å£å®šä¹‰äº†å“ªäº›æ–¹æ³•ï¼‰</li><li><code>Type</code>ï¼šæŒ‡å‘å…·ä½“ç±»å‹çš„å…ƒæ•°æ®ï¼ˆå®é™…å­˜å‚¨çš„æ˜¯ä»€ä¹ˆç±»å‹ï¼‰</li><li><code>Hash</code>ï¼šç±»å‹çš„å“ˆå¸Œå€¼ï¼Œç”¨äº type switch å¿«é€ŸåŒ¹é…</li><li><code>Fun</code>ï¼šæ–¹æ³•è¡¨ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯å˜é•¿åº¦æ•°ç»„ï¼Œå­˜å‚¨è¯¥å…·ä½“ç±»å‹å®ç°æ¥å£æ–¹æ³•çš„å‡½æ•°æŒ‡é’ˆ</li></ul><h3 id="ä¸ºä»€ä¹ˆéœ€è¦-itab">2.3 ä¸ºä»€ä¹ˆéœ€è¦ itab</h3><p>ä¸ºä»€ä¹ˆä¸ç›´æ¥åœ¨ <code>iface</code>ä¸­å­˜å‚¨ç±»å‹ä¿¡æ¯å’Œæ–¹æ³•ï¼Ÿæ˜¯ä¸ºäº†<strong>æ€§èƒ½ä¼˜åŒ– + å†…å­˜å…±äº«</strong>ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Reader <span class="keyword">interface</span> &#123;</span><br><span class="line">    Read(p []<span class="type">byte</span>) (n <span class="type">int</span>, err <span class="type">error</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> r1 Reader = &amp;File&#123;...&#125;</span><br><span class="line"><span class="keyword">var</span> r2 Reader = &amp;File&#123;...&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœ <code>r1</code> å’Œ <code>r2</code> éƒ½æ˜¯ <code>*File</code>ç±»å‹å®ç° <code>Reader</code> æ¥å£ï¼š</p><ul><li><p>å®ƒä»¬çš„ <code>data</code> æŒ‡é’ˆä¸åŒï¼ˆæŒ‡å‘ä¸åŒçš„ <code>File</code>å®ä¾‹ï¼‰</p></li><li><p>ä½†å®ƒä»¬çš„ <code>tab</code> æŒ‡é’ˆç›¸åŒï¼ˆæŒ‡å‘åŒä¸€ä¸ª<code>itab</code>ï¼‰</p></li></ul><p><code>itab</code> æ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œå¯¹äºç›¸åŒçš„ (æ¥å£ç±»å‹, å…·ä½“ç±»å‹)å¯¹ï¼Œè¿è¡Œæ—¶åªä¼šåˆ›å»ºä¸€ä¸ª<code>itab</code>ï¼Œå¹¶è¢«æ‰€æœ‰ç›¸åŒç±»å‹ç»„åˆçš„æ¥å£å€¼å…±äº«ã€‚</p><h2 id="ä¸‰æ¥å£èµ‹å€¼çš„è¿è¡Œæ—¶è¿‡ç¨‹">ä¸‰ã€æ¥å£èµ‹å€¼çš„è¿è¡Œæ—¶è¿‡ç¨‹</h2><h3 id="ä»å…·ä½“ç±»å‹åˆ°æ¥å£ç±»å‹">3.1 ä»å…·ä½“ç±»å‹åˆ°æ¥å£ç±»å‹</h3><p>ä¸‹é¢è¿™ä¸ªè¿‡ç¨‹ï¼Œåœ¨è¿è¡Œæ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MyInt <span class="type">int</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m MyInt)</span></span> String() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> strconv.Itoa(<span class="type">int</span>(m))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> i fmt.Stringer = MyInt(<span class="number">42</span>)</span><br></pre></td></tr></table></figure><p><strong>1. æŸ¥æ‰¾å¹¶åˆ›å»º itab</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getitab</span><span class="params">(inter *interfacetype, typ *_type, canfail <span class="type">bool</span>)</span></span> *itab &#123;</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(inter.Methods) == <span class="number">0</span> &#123;</span><br><span class="line">throw(<span class="string">&quot;internal error - misuse of itab&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// easy case</span></span><br><span class="line"><span class="keyword">if</span> typ.TFlag&amp;abi.TFlagUncommon == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">if</span> canfail &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">name := toRType(&amp;inter.Type).nameOff(inter.Methods[<span class="number">0</span>].Name)</span><br><span class="line"><span class="built_in">panic</span>(&amp;TypeAssertionError&#123;<span class="literal">nil</span>, typ, &amp;inter.Type, name.Name()&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> m *itab</span><br><span class="line"></span><br><span class="line"><span class="comment">// First, look in the existing table to see if we can find the itab we need.</span></span><br><span class="line"><span class="comment">// This is by far the most common case, so do it without locks.</span></span><br><span class="line"><span class="comment">// Use atomic to ensure we see any previous writes done by the thread</span></span><br><span class="line"><span class="comment">// that updates the itabTable field (with atomic.Storep in itabAdd).</span></span><br><span class="line">t := (*itabTableType)(atomic.Loadp(unsafe.Pointer(&amp;itabTable)))</span><br><span class="line"><span class="keyword">if</span> m = t.find(inter, typ); m != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">goto</span> finish</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Not found.  Grab the lock and try again.</span></span><br><span class="line">lock(&amp;itabLock)</span><br><span class="line"><span class="keyword">if</span> m = itabTable.find(inter, typ); m != <span class="literal">nil</span> &#123;</span><br><span class="line">unlock(&amp;itabLock)</span><br><span class="line"><span class="keyword">goto</span> finish</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Entry doesn&#x27;t exist yet. Make a new entry &amp; add it.</span></span><br><span class="line">m = (*itab)(persistentalloc(unsafe.Sizeof(itab&#123;&#125;)+<span class="type">uintptr</span>(<span class="built_in">len</span>(inter.Methods)<span class="number">-1</span>)*goarch.PtrSize, <span class="number">0</span>, &amp;memstats.other_sys))</span><br><span class="line">m.Inter = inter</span><br><span class="line">m.Type = typ</span><br><span class="line"><span class="comment">// The hash is used in type switches. However, compiler statically generates itab&#x27;s</span></span><br><span class="line"><span class="comment">// for all interface/type pairs used in switches (which are added to itabTable</span></span><br><span class="line"><span class="comment">// in itabsinit). The dynamically-generated itab&#x27;s never participate in type switches,</span></span><br><span class="line"><span class="comment">// and thus the hash is irrelevant.</span></span><br><span class="line"><span class="comment">// Note: m.Hash is _not_ the hash used for the runtime itabTable hash table.</span></span><br><span class="line">m.Hash = <span class="number">0</span></span><br><span class="line">itabInit(m, <span class="literal">true</span>)</span><br><span class="line">itabAdd(m)</span><br><span class="line">unlock(&amp;itabLock)</span><br><span class="line">finish:</span><br><span class="line"><span class="keyword">if</span> m.Fun[<span class="number">0</span>] != <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> m</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> canfail &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// this can only happen if the conversion</span></span><br><span class="line"><span class="comment">// was already done once using the , ok form</span></span><br><span class="line"><span class="comment">// and we have a cached negative result.</span></span><br><span class="line"><span class="comment">// The cached result doesn&#x27;t record which</span></span><br><span class="line"><span class="comment">// interface function was missing, so initialize</span></span><br><span class="line"><span class="comment">// the itab again to get the missing function name.</span></span><br><span class="line"><span class="built_in">panic</span>(&amp;TypeAssertionError&#123;concrete: typ, asserted: &amp;inter.Type, missingMethod: itabInit(m, <span class="literal">false</span>)&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>è¿è¡Œæ—¶è°ƒç”¨ getitab(interfaceType, concreteType)</p></li><li><p>å…ˆåœ¨å…¨å±€ itabTable ä¸­æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨</p></li><li><p>å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„ itab å¹¶åˆå§‹åŒ–æ–¹æ³•è¡¨</p></li></ul><p><strong>2. åˆå§‹åŒ–æ–¹æ³•è¡¨ itabInit</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// itabInit fills in the m.Fun array with all the code pointers for</span></span><br><span class="line"><span class="comment">// the m.Inter/m.Type pair. If the type does not implement the interface,</span></span><br><span class="line"><span class="comment">// it sets m.Fun[0] to 0 and returns the name of an interface function that is missing.</span></span><br><span class="line"><span class="comment">// If !firstTime, itabInit will not write anything to m.Fun (see issue 65962).</span></span><br><span class="line"><span class="comment">// It is ok to call this multiple times on the same m, even concurrently</span></span><br><span class="line"><span class="comment">// (although it will only be called once with firstTime==true).</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">itabInit</span><span class="params">(m *itab, firstTime <span class="type">bool</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">inter := m.Inter</span><br><span class="line">typ := m.Type</span><br><span class="line">x := typ.Uncommon()</span><br><span class="line"></span><br><span class="line"><span class="comment">// both inter and typ have method sorted by name,</span></span><br><span class="line"><span class="comment">// and interface names are unique,</span></span><br><span class="line"><span class="comment">// so can iterate over both in lock step;</span></span><br><span class="line"><span class="comment">// the loop is O(ni+nt) not O(ni*nt).</span></span><br><span class="line">ni := <span class="built_in">len</span>(inter.Methods)</span><br><span class="line">nt := <span class="type">int</span>(x.Mcount)</span><br><span class="line">xmhdr := (*[<span class="number">1</span> &lt;&lt; <span class="number">16</span>]abi.Method)(add(unsafe.Pointer(x), <span class="type">uintptr</span>(x.Moff)))[:nt:nt]</span><br><span class="line">j := <span class="number">0</span></span><br><span class="line">methods := (*[<span class="number">1</span> &lt;&lt; <span class="number">16</span>]unsafe.Pointer)(unsafe.Pointer(&amp;m.Fun[<span class="number">0</span>]))[:ni:ni]</span><br><span class="line"><span class="keyword">var</span> fun0 unsafe.Pointer</span><br><span class="line">imethods:</span><br><span class="line"><span class="keyword">for</span> k := <span class="number">0</span>; k &lt; ni; k++ &#123;</span><br><span class="line">i := &amp;inter.Methods[k]</span><br><span class="line">itype := toRType(&amp;inter.Type).typeOff(i.Typ)</span><br><span class="line">name := toRType(&amp;inter.Type).nameOff(i.Name)</span><br><span class="line">iname := name.Name()</span><br><span class="line">ipkg := pkgPath(name)</span><br><span class="line"><span class="keyword">if</span> ipkg == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">ipkg = inter.PkgPath.Name()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> ; j &lt; nt; j++ &#123;</span><br><span class="line">t := &amp;xmhdr[j]</span><br><span class="line">rtyp := toRType(typ)</span><br><span class="line">tname := rtyp.nameOff(t.Name)</span><br><span class="line"><span class="keyword">if</span> rtyp.typeOff(t.Mtyp) == itype &amp;&amp; tname.Name() == iname &#123;</span><br><span class="line">pkgPath := pkgPath(tname)</span><br><span class="line"><span class="keyword">if</span> pkgPath == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">pkgPath = rtyp.nameOff(x.PkgPath).Name()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> tname.IsExported() || pkgPath == ipkg &#123;</span><br><span class="line">ifn := rtyp.textOff(t.Ifn)</span><br><span class="line"><span class="keyword">if</span> k == <span class="number">0</span> &#123;</span><br><span class="line">fun0 = ifn <span class="comment">// we&#x27;ll set m.Fun[0] at the end</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> firstTime &#123;</span><br><span class="line">methods[k] = ifn</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">continue</span> imethods</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// didn&#x27;t find method</span></span><br><span class="line"><span class="comment">// Leaves m.Fun[0] set to 0.</span></span><br><span class="line"><span class="keyword">return</span> iname</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> firstTime &#123;</span><br><span class="line">m.Fun[<span class="number">0</span>] = <span class="type">uintptr</span>(fun0)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>éå†æ¥å£å®šä¹‰çš„æ–¹æ³•</p></li><li><p>åœ¨å…·ä½“ç±»å‹çš„æ–¹æ³•é›†ä¸­æŸ¥æ‰¾å¯¹åº”çš„å®ç°</p></li><li><p>å°†å‡½æ•°æŒ‡é’ˆå¡«å…¥ Fun æ•°ç»„</p></li><li><p>å¦‚æœæ‰¾ä¸åˆ°å®ç°ï¼Œè®¾ç½® Fun[0] = 0 è¡¨ç¤ºç±»å‹ä¸åŒ¹é…</p></li></ul><p><strong>3. æ„é€  iface</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iface &#123;</span><br><span class="line">    tab:  æŒ‡å‘ (fmt.Stringer, MyInt) çš„ itab,</span><br><span class="line">    data: æŒ‡å‘ MyInt(<span class="number">42</span>) çš„å†…å­˜åœ°å€</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ¥å£æ–¹æ³•è°ƒç”¨">3.2 æ¥å£æ–¹æ³•è°ƒç”¨</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i.String()  <span class="comment">// è°ƒç”¨æ¥å£æ–¹æ³•</span></span><br></pre></td></tr></table></figure><p>ç¼–è¯‘å™¨ç”Ÿæˆçš„ä¼ªä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. ä» iface ä¸­å–å‡º tab</span></span><br><span class="line">tab := i.tab</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. ä» tab.Fun ä¸­å–å‡ºç¬¬ä¸€ä¸ªæ–¹æ³•ï¼ˆString æ˜¯ç¬¬0ä¸ªæ–¹æ³•ï¼‰</span></span><br><span class="line">fn := tab.Fun[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. è°ƒç”¨è¯¥æ–¹æ³•ï¼Œä¼ å…¥ data ä½œä¸ºæ¥æ”¶è€…</span></span><br><span class="line"><span class="keyword">return</span> fn(i.data)</span><br></pre></td></tr></table></figure><h2 id="å››eface-vs-iface-çš„è®¾è®¡å“²å­¦">å››ã€eface vs iface çš„è®¾è®¡å“²å­¦</h2><h3 id="ä¸ºä»€ä¹ˆåŒºåˆ†ç©ºæ¥å£å’Œéç©ºæ¥å£">4.1ä¸ºä»€ä¹ˆåŒºåˆ†ç©ºæ¥å£å’Œéç©ºæ¥å£ï¼Ÿ</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> eface <span class="keyword">struct</span> &#123;</span><br><span class="line">_type *_type</span><br><span class="line">data  unsafe.Pointer</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç©ºæ¥å£ any ä¸éœ€è¦æ–¹æ³•è¡¨ï¼Œå› æ­¤ç›´æ¥å­˜å‚¨ç±»å‹æŒ‡é’ˆï¼Œçœå»äº† itabçš„å¼€é”€ï¼š</p><table><thead><tr><th style="text-align: left;">æ¥å£ç±»å‹</th><th style="text-align: left;">ç»“æ„</th><th style="text-align: left;">ç”¨é€”</th></tr></thead><tbody><tr><td style="text-align: left;">eface</td><td style="text-align: left;">_type + data</td><td style="text-align: left;">ä¸éœ€è¦æ–¹æ³•è°ƒç”¨ï¼Œåªéœ€è¦ç±»å‹ä¿¡æ¯</td></tr><tr><td style="text-align: left;">iface</td><td style="text-align: left;">itab + data</td><td style="text-align: left;">éœ€è¦åŠ¨æ€æ–¹æ³•åˆ†å‘</td></tr></tbody></table><p>è¿™æ˜¯ä¸€ç§é’ˆå¯¹æ€§ä¼˜åŒ–ï¼š</p><ul><li><p>ç©ºæ¥å£åœºæ™¯ï¼ˆå¦‚ fmt.Println(any)ï¼‰éå¸¸å¸¸è§</p></li><li><p>é€šè¿‡ç®€åŒ–ç»“æ„å‡å°‘å†…å­˜å ç”¨å’Œé—´æ¥è®¿é—®</p></li></ul><h3 id="ç±»å‹æ–­è¨€çš„å®ç°">4.2 ç±»å‹æ–­è¨€çš„å®ç°</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> v, ok := i.(MyInt); ok &#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨ v</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œæ—¶é€»è¾‘ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯¹äº iface</span></span><br><span class="line"><span class="keyword">if</span> i.tab.Type == TypeOf(MyInt) &#123;</span><br><span class="line">    <span class="keyword">return</span> *(*MyInt)(i.data), <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> zero, <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¹äº eface</span></span><br><span class="line"><span class="keyword">if</span> i._type == TypeOf(MyInt) &#123;</span><br><span class="line">    <span class="keyword">return</span> *(*MyInt)(i.data), <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> zero, <span class="literal">false</span></span><br></pre></td></tr></table></figure><h2 id="äº”ç±»å‹ç³»ç»Ÿçš„å®Œæ•´å›¾æ™¯">äº”ã€ç±»å‹ç³»ç»Ÿçš„å®Œæ•´å›¾æ™¯</h2><h3 id="ç±»å‹å…ƒæ•°æ®-_type">5.1 ç±»å‹å…ƒæ•°æ® _type</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Type <span class="keyword">struct</span> &#123;</span><br><span class="line">Size_       <span class="type">uintptr</span></span><br><span class="line">PtrBytes    <span class="type">uintptr</span> <span class="comment">// number of (prefix) bytes in the type that can contain pointers</span></span><br><span class="line">Hash        <span class="type">uint32</span>  <span class="comment">// hash of type; avoids computation in hash tables</span></span><br><span class="line">TFlag       TFlag   <span class="comment">// extra type information flags</span></span><br><span class="line">Align_      <span class="type">uint8</span>   <span class="comment">// alignment of variable with this type</span></span><br><span class="line">FieldAlign_ <span class="type">uint8</span>   <span class="comment">// alignment of struct field with this type</span></span><br><span class="line">Kind_       Kind    <span class="comment">// enumeration for C</span></span><br><span class="line"><span class="comment">// function for comparing objects of this type</span></span><br><span class="line"><span class="comment">// (ptr to object A, ptr to object B) -&gt; ==?</span></span><br><span class="line">Equal <span class="function"><span class="keyword">func</span><span class="params">(unsafe.Pointer, unsafe.Pointer)</span></span> <span class="type">bool</span></span><br><span class="line"><span class="comment">// GCData stores the GC type data for the garbage collector.</span></span><br><span class="line"><span class="comment">// Normally, GCData points to a bitmask that describes the</span></span><br><span class="line"><span class="comment">// ptr/nonptr fields of the type. The bitmask will have at</span></span><br><span class="line"><span class="comment">// least PtrBytes/ptrSize bits.</span></span><br><span class="line"><span class="comment">// If the TFlagGCMaskOnDemand bit is set, GCData is instead a</span></span><br><span class="line"><span class="comment">// **byte and the pointer to the bitmask is one dereference away.</span></span><br><span class="line"><span class="comment">// The runtime will build the bitmask if needed.</span></span><br><span class="line"><span class="comment">// (See runtime/type.go:getGCMask.)</span></span><br><span class="line"><span class="comment">// Note: multiple types may have the same value of GCData,</span></span><br><span class="line"><span class="comment">// including when TFlagGCMaskOnDemand is set. The types will, of course,</span></span><br><span class="line"><span class="comment">// have the same pointer layout (but not necessarily the same size).</span></span><br><span class="line">GCData    *<span class="type">byte</span></span><br><span class="line">Str       NameOff <span class="comment">// string form</span></span><br><span class="line">PtrToThis TypeOff <span class="comment">// type for pointer to this type, may be zero</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯ä¸ª Go ç±»å‹åœ¨ç¼–è¯‘æ—¶éƒ½ä¼šç”Ÿæˆä¸€ä¸ª <code>_type</code> ç»“æ„ï¼ŒåŒ…å«ï¼š</p><ul><li><p>ç±»å‹å¤§å°ã€å¯¹é½</p></li><li><p>GC ä¿¡æ¯ï¼ˆå“ªäº›å­—æ®µæ˜¯æŒ‡é’ˆï¼‰</p></li><li><p>ç±»å‹çš„å”¯ä¸€æ ‡è¯†ï¼ˆHashï¼‰</p></li><li><p>ç±»å‹çš„ Kindï¼ˆint, string, struct, ...ï¼‰</p></li></ul><h3 id="æ¥å£ç±»å‹-interfacetype">5.2 æ¥å£ç±»å‹ InterfaceType</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> InterfaceType <span class="keyword">struct</span> &#123;</span><br><span class="line">Type</span><br><span class="line">PkgPath Name      <span class="comment">// import path</span></span><br><span class="line">Methods []Imethod <span class="comment">// sorted by hash</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥å£ç±»å‹çš„å…ƒæ•°æ®ï¼ŒåŒ…å«ï¼š</p><ul><li><p>åŸºç¡€çš„ Type ä¿¡æ¯</p></li><li><p>æ–¹æ³•åˆ—è¡¨ï¼ˆæŒ‰å“ˆå¸Œæ’åºï¼Œç”¨äºå¿«é€ŸæŸ¥æ‰¾ï¼‰</p></li></ul><h3 id="å…¨å±€-itabtable">5.3 å…¨å±€ itabTable</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> itabInitSize = <span class="number">512</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">itabLock      mutex                               <span class="comment">// lock for accessing itab table</span></span><br><span class="line">itabTable     = &amp;itabTableInit                    <span class="comment">// pointer to current table</span></span><br><span class="line">itabTableInit = itabTableType&#123;size: itabInitSize&#125; <span class="comment">// starter table</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> itabTableType <span class="keyword">struct</span> &#123;</span><br><span class="line">size    <span class="type">uintptr</span>             <span class="comment">// length of entries array. Always a power of 2.</span></span><br><span class="line">count   <span class="type">uintptr</span>             <span class="comment">// current number of filled entries.</span></span><br><span class="line">entries [itabInitSize]*itab <span class="comment">// really [size] large</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªå…¨å±€å“ˆå¸Œè¡¨ï¼Œé”®æ˜¯ (æ¥å£ç±»å‹, å…·ä½“ç±»å‹) å¯¹ï¼Œå€¼æ˜¯ itabï¼š</p><ul><li><p>é¿å…é‡å¤åˆ›å»ºç›¸åŒçš„ itab</p></li><li><p>ä½¿ç”¨æ— é”è¯»å–ï¼ˆlock-free readï¼‰ä¼˜åŒ–çƒ­è·¯å¾„</p></li><li><p>åŠ¨æ€æ‰©å®¹ï¼ˆ75% è´Ÿè½½å› å­ï¼‰</p></li></ul><h2 id="å…­è®¾è®¡æƒè¡¡ä¸ä¼˜åŠ¿">å…­ã€è®¾è®¡æƒè¡¡ä¸ä¼˜åŠ¿</h2><h3 id="æ€§èƒ½ä¼˜åŠ¿">6.1 æ€§èƒ½ä¼˜åŠ¿</h3><ol type="1"><li>æ–¹æ³•è°ƒç”¨åªéœ€ä¸¤æ¬¡é—´æ¥å¯»å€ï¼š<code>iface.tab.Fun[i]</code></li><li><code>itab</code> å…¨å±€å…±äº«ï¼šå†…å­˜æ•ˆç‡é«˜</li><li>æ— é”å¿«é€Ÿè·¯å¾„ï¼šå¤§å¤šæ•°æƒ…å†µä¸‹ä¸éœ€è¦åŠ é”</li></ol><h3 id="ç±»å‹å®‰å…¨">6.2 ç±»å‹å®‰å…¨</h3><ol type="1"><li>ç¼–è¯‘æœŸæ£€æŸ¥ï¼šç¼–è¯‘å™¨ç¡®ä¿æ¥å£å®ç°å®Œæ•´</li><li>è¿è¡ŒæœŸéªŒè¯ï¼š<code>itabInit</code> æ—¶å†æ¬¡éªŒè¯æ–¹æ³•åŒ¹é…</li><li>ç±»å‹æ–­è¨€å®‰å…¨ï¼šé€šè¿‡æ¯”è¾ƒ <code>_type</code> æŒ‡é’ˆå®ç°</li></ol><h3 id="çµæ´»æ€§">6.3 çµæ´»æ€§</h3><ol type="1"><li>é¸­å­ç±»å‹ï¼šä¸éœ€è¦æ˜¾å¼å£°æ˜å®ç°æ¥å£</li><li>åŠ¨æ€ç»„åˆï¼šè¿è¡Œæ—¶å¯ä»¥å°†ä»»ä½•åŒ¹é…çš„ç±»å‹èµ‹å€¼ç»™æ¥å£</li><li>åå°„åŸºç¡€ï¼š<code>reflect</code> åŒ…é€šè¿‡ <code>_type</code> å’Œ<code>itab</code> å®ç°</li></ol><h2id="ä¸ƒç»“æ„ä½“å’Œå…¶æŒ‡é’ˆå®ç°æ¥å£çš„é—®é¢˜">ä¸ƒã€ç»“æ„ä½“å’Œå…¶æŒ‡é’ˆå®ç°æ¥å£çš„é—®é¢˜</h2><p>å¦‚æœæ˜¯ç”¨ç»“æ„ä½“ç±»å‹å»å®ç°æ¥å£ï¼ŒGoåœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨å†ä¸ºå…¶å¯¹åº”çš„æŒ‡é’ˆç±»å‹å®ç°æ¥å£ï¼›</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‰‹åŠ¨å†™</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t Truck)</span></span> Drive() &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Go åº•å±‚ä¼šå¸®æˆ‘ä»¬è‡ªåŠ¨å†™è¿™ä¸ª</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Truck)</span></span> Drive() &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœåªæ˜¯ç”¨ç»“æ„ä½“æŒ‡é’ˆç±»å‹å»å®ç°æ¥å£ï¼ŒGoåœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œå°±ä¸ä¼šä¸ºç»“æ„ä½“ç±»å‹å»å®ç°æ¥å£ï¼›</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‰‹åŠ¨å†™</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Truck)</span></span> Drive() &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   Go åº•å±‚ä¸ä¼šå¸®æˆ‘ä»¬å†™è¿™ä¸ª</span></span><br><span class="line"><span class="comment">func (t Truck) Drive() &#123;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><h2 id="å…«nil-ç©ºç»“æ„ä½“-ç©ºæŒ‡é’ˆ">å…«ã€nil &amp; ç©ºç»“æ„ä½“ &amp; ç©ºæŒ‡é’ˆ</h2><ul><li>nil æ˜¯å…­ç§ç±»å‹çš„é›¶å€¼ï¼Œä¸åŒ…æ‹¬åŸºæœ¬ç±»å‹å’Œ structï¼›</li><li>ç©ºæ¥å£å¯ä»¥æ‰¿è½½ä»»æ„ç±»å‹ï¼Œåªæœ‰å½“ <code>_type</code> å’Œ<code>data</code> éƒ½ä¸ºç©ºçš„æ—¶å€™ï¼Œå®ƒæ‰æ˜¯ nilï¼›</li><li>ç©ºç»“æ„ä½“çš„æŒ‡é’ˆå’Œå€¼éƒ½ä¸æ˜¯ nilï¼›</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// nil is a predeclared identifier representing the zero value for a</span></span><br><span class="line"><span class="comment">// pointer, channel, func, interface, map, or slice type.</span></span><br><span class="line"><span class="keyword">var</span> <span class="literal">nil</span> Type <span class="comment">// Type must be a pointer, channel, func, interface, map, or slice type</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Type is here for the purposes of documentation only. It is a stand-in</span></span><br><span class="line"><span class="comment">// for any Go type, but represents the same type for any given function</span></span><br><span class="line"><span class="comment">// invocation.</span></span><br><span class="line"><span class="keyword">type</span> Type <span class="type">int</span></span><br></pre></td></tr></table></figure><h2 id="ä¹æ€»ç»“">ä¹ã€æ€»ç»“</h2><p>Go çš„æ¥å£ç³»ç»Ÿæ˜¯ä¸€ä¸ªç²¾å¦™çš„å·¥ç¨‹è®¾è®¡ï¼š</p><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20251117142112190.png" /></p><ol type="1"><li><strong>åˆ†ç¦»ç±»å‹ä¿¡æ¯å’Œæ•°æ®</strong>ï¼šä½¿å¾—æ¥å£å¯ä»¥å®¹çº³ä»»ä½•ç±»å‹</li><li><strong>åˆ†ç¦»æ¥å£å®šä¹‰å’Œå®ç°</strong>ï¼šé€šè¿‡ itab è¿æ¥ä¸¤è€…</li><li><strong>ç¼“å­˜å’Œå…±äº«</strong>ï¼šå…¨å±€ itabTable æå‡æ€§èƒ½</li><li><strong>é’ˆå¯¹æ€§ä¼˜åŒ–</strong>ï¼šç©ºæ¥å£å’Œéç©ºæ¥å£ä½¿ç”¨ä¸åŒè¡¨ç¤º</li></ol><p>è¿™ç§è®¾è®¡è®© Goåœ¨ä¿æŒé™æ€ç±»å‹å®‰å…¨çš„åŒæ—¶ï¼Œå®ç°äº†æ¥è¿‘åŠ¨æ€è¯­è¨€çš„çµæ´»æ€§ï¼Œå¹¶ä¸”æ€§èƒ½å¼€é”€æå°ã€‚è¿™å°±æ˜¯Go ç±»å‹ç³»ç»Ÿçš„ç¬¬ä¸€æ€§åŸç†ï¼</p>]]></content>
    
    
    <summary type="html">æœ¬æ–‡ç³»ç»Ÿè§£æ Go interface çš„åº•å±‚å®ç°åŸç†ï¼Œå‰–æç©ºæ¥å£ï¼ˆefaceï¼‰ä¸å«æ–¹æ³•æ¥å£ï¼ˆifaceï¼‰çš„å†…å­˜ç»“æ„ã€ç±»å‹æ–¹æ³•è¡¨ï¼ˆitabï¼‰ã€åŠ¨æ€ç±»å‹åŒ¹é…åŠå¤šæ€åˆ†å‘æœºåˆ¶ï¼Œå¹¶æ¢è®¨å…¶è®¾è®¡å“²å­¦ä¸åº”ç”¨åœºæ™¯ã€‚</summary>
    
    
    
    <category term="Go" scheme="https://hedon.top/categories/Go/"/>
    
    
    <category term="Go" scheme="https://hedon.top/tags/Go/"/>
    
  </entry>
  
  <entry>
    <title>Go åº•å±‚åŸç†ä¸¨mapï¼ˆSwiss Table ç‰ˆæœ¬ï¼‰</title>
    <link href="https://hedon.top/2025/11/16/go/go-map-swiss/"/>
    <id>https://hedon.top/2025/11/16/go/go-map-swiss/</id>
    <published>2025-11-16T08:00:00.000Z</published>
    <updated>2025-11-16T13:34:52.376Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€æ•´ä½“è®¾è®¡æ€æƒ³">ä¸€ã€æ•´ä½“è®¾è®¡æ€æƒ³</h2><p>Go mapï¼ˆSwiss Table ç‰ˆæœ¬ï¼‰æ˜¯åŸºäº <strong>Google Abseil çš„ "SwissTable"</strong> è®¾è®¡çš„ç°ä»£åŒ–å“ˆå¸Œè¡¨å®ç°ï¼Œé‡‡ç”¨ä»¥ä¸‹æ ¸å¿ƒè®¾è®¡ï¼š</p><ol type="1"><li><strong>æ§åˆ¶å­—å¹¶è¡ŒåŒ¹é…</strong>ï¼šä½¿ç”¨ 8 å­—èŠ‚æ§åˆ¶å­—ä¸€æ¬¡æ€§æ£€æŸ¥ 8ä¸ªæ§½ä½</li><li><strong>å¼€æ”¾å¯»å€ +äºŒæ¬¡æ¢æµ‹</strong>ï¼šæ— éœ€é“¾è¡¨ï¼Œæ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨è¿ç»­æ•°ç»„ä¸­</li><li><strong>å¯æ‰©å±•å“ˆå¸Œ</strong>ï¼šä½¿ç”¨ç›®å½•æœºåˆ¶å®ç°å¢é‡æ‰©å®¹ï¼Œå•è¡¨å¤§å°å—é™</li><li><strong>SIMD åŠ é€Ÿ</strong>ï¼šAMD64 æ¶æ„ä½¿ç”¨ SIMDæŒ‡ä»¤å¹¶è¡Œæ¯”è¾ƒæ§åˆ¶å­—</li></ol><p><strong>è®¾è®¡çµæ„Ÿæ¥æº</strong>ï¼š<ahref="https://abseil.io/about/design/swisstables">Abseil SwissTables</a></p><h2 id="äºŒæ ¸å¿ƒæ•°æ®ç»“æ„">äºŒã€æ ¸å¿ƒæ•°æ®ç»“æ„</h2><p>æœ¬ç¯‡ä»¥ Go1.25 ç‰ˆæœ¬çš„æºç ä¸ºåŸºå‡†ï¼Œå®Œæ•´æºç å‚è€ƒï¼š - Runtime å°è£…ï¼š<ahref="https://github.com/golang/go/blob/release-branch.go1.25/src/runtime/map_swiss.go">map_swiss.go</a>- æ ¸å¿ƒå®ç°ï¼š<ahref="https://github.com/golang/go/blob/release-branch.go1.25/src/internal/runtime/maps/">internal/runtime/maps/</a></p><h3 id="mapé¡¶å±‚ç»“æ„">1. Mapï¼ˆé¡¶å±‚ç»“æ„ï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Map <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// å…ƒç´ æ€»æ•°ï¼ˆå¿…é¡»åœ¨ç¬¬ä¸€ä½ï¼Œä¾› len() ä½¿ç”¨ï¼‰</span></span><br><span class="line">    used <span class="type">uint64</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å“ˆå¸Œç§å­ï¼ˆæ¯ä¸ª map ç‹¬ç«‹éšæœºï¼‰</span></span><br><span class="line">    seed <span class="type">uintptr</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç›®å½•æŒ‡é’ˆï¼šæŒ‡å‘ table æ•°ç»„æˆ–å•ä¸ª group</span></span><br><span class="line">    <span class="comment">// å° map ä¼˜åŒ–ï¼šâ‰¤8 ä¸ªå…ƒç´ æ—¶ï¼ŒdirPtr ç›´æ¥æŒ‡å‘å•ä¸ª group</span></span><br><span class="line">    <span class="comment">// å¤§ mapï¼šdirPtr æŒ‡å‘ *[dirLen]*table</span></span><br><span class="line">    dirPtr unsafe.Pointer</span><br><span class="line">    dirLen <span class="type">int</span>  <span class="comment">// ç›®å½•é•¿åº¦ = 1 &lt;&lt; globalDepth</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯æ‰©å±•å“ˆå¸Œçš„å…¨å±€æ·±åº¦ï¼ˆä½¿ç”¨å“ˆå¸Œé«˜ä½çš„ bit æ•°ï¼‰</span></span><br><span class="line">    globalDepth <span class="type">uint8</span></span><br><span class="line">    globalShift <span class="type">uint8</span>  <span class="comment">// 64 - globalDepthï¼ˆç”¨äºå¿«é€Ÿè®¡ç®—ç´¢å¼•ï¼‰</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¹¶å‘å†™æ£€æµ‹æ ‡å¿—</span></span><br><span class="line">    writing <span class="type">uint8</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¢“ç¢‘å­˜åœ¨æ ‡è®°</span></span><br><span class="line">    tombstonePossible <span class="type">bool</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…ç©ºåºåˆ—å·ï¼ˆç”¨äºæ£€æµ‹è¿­ä»£ä¸­çš„ clearï¼‰</span></span><br><span class="line">    clearSeq <span class="type">uint64</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å…³é”®å­—æ®µè¯´æ˜</strong>ï¼š</p><ul><li><code>dirPtr</code> +<code>dirLen</code>ï¼šå®ç°å¯æ‰©å±•å“ˆå¸Œçš„ç›®å½•ç»“æ„</li><li><code>globalDepth</code>ï¼šå½“å‰ä½¿ç”¨å“ˆå¸Œé«˜ä½çš„ bit æ•°</li><li>å° map ä¼˜åŒ–ï¼šâ‰¤8 ä¸ªå…ƒç´ æ—¶æ— éœ€åˆ†é… table</li></ul><h3 id="tableå“ˆå¸Œè¡¨">2. Tableï¼ˆå“ˆå¸Œè¡¨ï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> table <span class="keyword">struct</span> &#123;</span><br><span class="line">    used     <span class="type">uint16</span>  <span class="comment">// å·²ä½¿ç”¨æ§½ä½æ•°</span></span><br><span class="line">    capacity <span class="type">uint16</span>  <span class="comment">// æ€»æ§½ä½æ•°ï¼ˆ= groupsæ•° Ã— 8ï¼‰</span></span><br><span class="line">    growthLeft <span class="type">uint16</span>  <span class="comment">// å‰©ä½™å¯å¡«å……æ§½ä½</span></span><br><span class="line"></span><br><span class="line">    localDepth <span class="type">uint8</span>  <span class="comment">// è¡¨çš„å±€éƒ¨æ·±åº¦</span></span><br><span class="line">    index <span class="type">int</span>  <span class="comment">// åœ¨ç›®å½•ä¸­çš„ç´¢å¼•</span></span><br><span class="line"></span><br><span class="line">    groups groupsReference  <span class="comment">// group æ•°ç»„</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å•è¡¨æœ€å¤§å®¹é‡</strong>ï¼š1024 ä¸ªæ§½ä½ï¼ˆé™åˆ¶å•æ¬¡æ‰©å®¹å¼€é”€ï¼‰</p><h3 id="groupç»„ç»“æ„">3. Groupï¼ˆç»„ç»“æ„ï¼‰</h3><p>æ¯ä¸ª group åŒ…å«ï¼š - <strong>1 ä¸ªæ§åˆ¶å­—</strong>ï¼ˆ8å­—èŠ‚ï¼‰ï¼šæ¯å­—èŠ‚å¯¹åº”ä¸€ä¸ªæ§½ä½çš„çŠ¶æ€ - <strong>8ä¸ªæ§½ä½</strong>ï¼šæ¯ä¸ªæ§½ä½å­˜å‚¨ä¸€ä¸ª key-value å¯¹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> groupReference <span class="keyword">struct</span> &#123;</span><br><span class="line">    data unsafe.Pointer  <span class="comment">// æŒ‡å‘å®é™…çš„ group å†…å­˜</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å†…å­˜å¸ƒå±€</span></span><br><span class="line"><span class="keyword">type</span> group <span class="keyword">struct</span> &#123;</span><br><span class="line">    ctrls ctrlGroup  <span class="comment">// 8 å­—èŠ‚æ§åˆ¶å­—</span></span><br><span class="line">    slots [<span class="number">8</span>]<span class="keyword">struct</span> &#123;</span><br><span class="line">        key  K</span><br><span class="line">        elem V</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ§åˆ¶å­—ç¼–ç </strong>ï¼š <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  empty: 1000 0000  (0x80)</span><br><span class="line">deleted: 1111 1110  (0xFE) - å¢“ç¢‘æ ‡è®°</span><br><span class="line">   full: 0xxx xxxx  (0x00-0x7F) - ä½ 7 ä½å­˜å‚¨ H2 å“ˆå¸Œå€¼</span><br></pre></td></tr></table></figure></p><h3 id="æ€»ç»“å›¾">4. æ€»ç»“å›¾</h3><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20251116170218340.png" /></p><h2 id="ä¸‰æ ¸å¿ƒç®—æ³•">ä¸‰ã€æ ¸å¿ƒç®—æ³•</h2><h3 id="å“ˆå¸Œå€¼åˆ†å‰²">1. å“ˆå¸Œå€¼åˆ†å‰²</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">64 ä½å“ˆå¸Œå€¼åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚           H1 (é«˜ 57 ä½)                      â”‚ H2 (ä½7ä½) â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">      ç”¨äºå®šä½ group                           å­˜å‚¨åœ¨æ§åˆ¶å­—ä¸­</span><br></pre></td></tr></table></figure><p><strong>H1</strong>ï¼šç”¨äºå®šä½ groupï¼ˆäºŒæ¬¡æ¢æµ‹ï¼‰<strong>H2</strong>ï¼šå­˜å‚¨åœ¨æ§åˆ¶å­—ä¸­ï¼Œç”¨äºå¿«é€Ÿè¿‡æ»¤</p><h3 id="å¹¶è¡ŒåŒ¹é…ç®—æ³•">2. å¹¶è¡ŒåŒ¹é…ç®—æ³•</h3><p>ä¼ ç»Ÿæ–¹å¼ï¼ˆnon-Swissï¼‰ï¼š <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">8</span>; i++ &#123;</span><br><span class="line">    <span class="keyword">if</span> tophash[i] == target &#123;</span><br><span class="line">        <span class="comment">// é€ä¸ªä¸²è¡Œæ¯”è¾ƒ</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>Swiss æ–¹å¼ï¼š <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸€æ¬¡æ“ä½œæ£€æŸ¥æ‰€æœ‰ 8 ä¸ªæ§½ä½ï¼</span></span><br><span class="line">matches := ctrlGroup.matchH2(target)</span><br><span class="line"><span class="comment">// matches æ˜¯ bitsetï¼Œæ¯ä½è¡¨ç¤ºä¸€ä¸ªæ§½ä½æ˜¯å¦åŒ¹é…</span></span><br></pre></td></tr></table></figure></p><p>å®ç°åŸç†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ctrlGroupMatchH2</span><span class="params">(g ctrlGroup, h <span class="type">uintptr</span>)</span></span> bitset &#123;</span><br><span class="line">    <span class="comment">// 1. XORï¼šå°†åŒ¹é…çš„å­—èŠ‚å˜ä¸º 0x00</span></span><br><span class="line">    v := <span class="type">uint64</span>(g) ^ (<span class="number">0x0101010101010101</span> * <span class="type">uint64</span>(h))</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. å‡æ³•æŠ€å·§ï¼š0x00 - 0x01 ä¼šå€Ÿä½å˜æˆ 0xFF</span></span><br><span class="line">    <span class="comment">//    å…¶ä»–å€¼å‡ 0x01 ä¸ä¼šè®¾ç½®æœ€é«˜ä½</span></span><br><span class="line">    result := (v - <span class="number">0x0101010101010101</span>) &amp;^ v</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. æå–æ¯å­—èŠ‚çš„æœ€é«˜ä½</span></span><br><span class="line">    <span class="keyword">return</span> bitset(result &amp; <span class="number">0x8080808080808080</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>AMD64 ä¼˜åŒ–</strong>ï¼šä½¿ç”¨ SIMD æŒ‡ä»¤ï¼ˆSSE2PCMPEQBï¼‰è¿›ä¸€æ­¥åŠ é€Ÿ</p><h3 id="äºŒæ¬¡æ¢æµ‹åºåˆ—">3. äºŒæ¬¡æ¢æµ‹åºåˆ—</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> probeSeq <span class="keyword">struct</span> &#123;</span><br><span class="line">    mask   <span class="type">uint64</span>  <span class="comment">// ç»„æ•° - 1</span></span><br><span class="line">    offset <span class="type">uint64</span>  <span class="comment">// å½“å‰åç§»</span></span><br><span class="line">    index  <span class="type">uint64</span>  <span class="comment">// æ¢æµ‹ç´¢å¼•</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s probeSeq)</span></span> next() probeSeq &#123;</span><br><span class="line">    s.index++</span><br><span class="line">    <span class="comment">// ä¸‰è§’æ•°åºåˆ—ï¼šoffset[i+1] = offset[i] + i + 1</span></span><br><span class="line">    s.offset = (s.offset + s.index) &amp; s.mask</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ¢æµ‹å…¬å¼</strong>ï¼š<code>p(i) = (iÂ² + i)/2 + hash (mod ç»„æ•°)</code></p><p><strong>ä¼˜åŠ¿</strong>ï¼š - å½“ç»„æ•°ä¸º 2 çš„å¹‚æ—¶ï¼Œä¿è¯éå†æ‰€æœ‰ç»„ -è·³è·ƒå¼åˆ†å¸ƒï¼Œå‡å°‘èšé›†ï¼ˆclusteringï¼‰ - ç¼“å­˜å‹å¥½æ€§ä¼˜äºçº¿æ€§æ¢æµ‹</p><h3 id="æŸ¥æ‰¾æµç¨‹">4. æŸ¥æ‰¾æµç¨‹</h3><p>åº•å±‚è°ƒç”¨äº† <code>runtime/maps/runtime_swiss.go</code> ä¸­çš„<code>mapaccess1()</code> æˆ–è€… <code>mapaccess2</code> å‡½æ•°ï¼š</p><ul><li>v := m[k] è°ƒç”¨ <code>runtime_mapaccess1()</code></li><li>v,k := m[k] è°ƒç”¨ <code>runtime_mapaccess2()</code></li></ul><p>æˆ‘ä»¬é‡ç‚¹æ¥çœ‹ <ahref="https://github.com/golang/go/blob/release-branch.go1.25/src/internal/runtime/maps/runtime_swiss.go#L40">runtime_mapaccess1()</a>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">runtime_mapaccess1</span><span class="params">(typ *abi.SwissMapType, m *Map, key unsafe.Pointer)</span></span> unsafe.Pointer &#123;</span><br><span class="line"><span class="comment">// ç©ºmapæ£€æŸ¥</span></span><br><span class="line"><span class="keyword">if</span> m == <span class="literal">nil</span> || m.Used() == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := mapKeyError(typ, key); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> unsafe.Pointer(&amp;zeroVal[<span class="number">0</span>])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¹¶å‘å†™æ£€æµ‹</span></span><br><span class="line"><span class="keyword">if</span> m.writing != <span class="number">0</span> &#123;</span><br><span class="line">fatal(<span class="string">&quot;concurrent map read and map write&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line"><span class="comment">// æ­¥éª¤ 1ï¼šè®¡ç®—å“ˆå¸Œå€¼</span></span><br><span class="line">  <span class="comment">// hash å°†è¢«åˆ†ä¸º H1ï¼ˆé«˜57ä½ï¼‰å’Œ H2ï¼ˆä½7ä½ï¼‰</span></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line">hash := typ.Hasher(key, m.seed)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line"><span class="comment">// æ­¥éª¤ 2ï¼šå° map å¿«é€Ÿè·¯å¾„ï¼ˆâ‰¤8ä¸ªå…ƒç´ ï¼‰</span></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line"><span class="keyword">if</span> m.dirLen &lt;= <span class="number">0</span> &#123;</span><br><span class="line"><span class="comment">// å°mapï¼šæ•°æ®ç›´æ¥å­˜å‚¨åœ¨å•ä¸ªgroupä¸­ï¼Œæ— éœ€æ¢æµ‹</span></span><br><span class="line">_, elem, ok := m.getWithKeySmall(typ, hash, key)</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line"><span class="keyword">return</span> unsafe.Pointer(&amp;zeroVal[<span class="number">0</span>]) </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> elem</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line"><span class="comment">// æ­¥éª¤ 3ï¼šå¤§ map è·¯å¾„ - é€‰æ‹© table</span></span><br><span class="line">  <span class="comment">// ä½¿ç”¨å“ˆå¸Œå€¼çš„é«˜ä½ç´¢å¼•ç›®å½•ï¼Œé€‰æ‹©å¯¹åº”çš„ table</span></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line">idx := m.directoryIndex(hash)  <span class="comment">// idx = hash &gt;&gt; globalShift</span></span><br><span class="line">t := m.directoryAt(idx)         <span class="comment">// è·å– table æŒ‡é’ˆ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line"><span class="comment">// æ­¥éª¤ 4ï¼šäºŒæ¬¡æ¢æµ‹å¾ªç¯</span></span><br><span class="line">  <span class="comment">// åˆå§‹åŒ–æ¢æµ‹åºåˆ—ï¼šä½¿ç”¨ H1ï¼ˆé«˜57ä½ï¼‰å®šä½åˆå§‹ group</span></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line">seq := makeProbeSeq(h1(hash), t.groups.lengthMask)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ; ; seq = seq.next() &#123;  <span class="comment">// æ— é™å¾ªç¯ï¼Œç›´åˆ°æ‰¾åˆ°æˆ–é‡åˆ°ç©ºæ§½</span></span><br><span class="line"><span class="comment">// ----------------------------------------</span></span><br><span class="line"><span class="comment">// æ­¥éª¤ 4.1ï¼šè·å–å½“å‰æ¢æµ‹çš„ group</span></span><br><span class="line"><span class="comment">// ----------------------------------------</span></span><br><span class="line">g := t.groups.group(typ, seq.offset)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ----------------------------------------</span></span><br><span class="line"><span class="comment">// æ­¥éª¤ 4.2ï¼šå¹¶è¡ŒåŒ¹é…æ§åˆ¶å­—ï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼ï¼‰</span></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ H2ï¼ˆä½7ä½ï¼‰ä¸æ§åˆ¶å­—è¿›è¡Œå¹¶è¡ŒåŒ¹é…</span></span><br><span class="line">    <span class="comment">// ä¸€æ¬¡æ“ä½œæ£€æŸ¥ 8 ä¸ªæ§½ä½çš„æ§åˆ¶å­—</span></span><br><span class="line"><span class="comment">// ----------------------------------------</span></span><br><span class="line">match := g.ctrls().matchH2(h2(hash)) <span class="comment">// match æ˜¯ bitsetï¼Œæ¯ä½ä»£è¡¨ä¸€ä¸ªæ§½ä½æ˜¯å¦åŒ¹é…</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ----------------------------------------</span></span><br><span class="line"><span class="comment">// æ­¥éª¤ 4.3ï¼šéå†æ‰€æœ‰åŒ¹é…çš„æ§½ä½</span></span><br><span class="line"><span class="comment">// ----------------------------------------</span></span><br><span class="line"><span class="keyword">for</span> match != <span class="number">0</span> &#123;</span><br><span class="line"><span class="comment">// è·å–ç¬¬ä¸€ä¸ªåŒ¹é…æ§½ä½çš„ç´¢å¼•</span></span><br><span class="line">i := match.first()</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–æ§½ä½ä¸­çš„ key æŒ‡é’ˆ</span></span><br><span class="line">slotKey := g.key(typ, i)</span><br><span class="line">slotKeyOrig := slotKey  <span class="comment">// ä¿å­˜åŸå§‹æŒ‡é’ˆï¼ˆè®¡ç®— elem åç§»ç”¨ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœæ˜¯é—´æ¥keyï¼ˆkeyå¤ªå¤§ï¼Œå­˜çš„æ˜¯æŒ‡é’ˆï¼‰</span></span><br><span class="line"><span class="keyword">if</span> typ.IndirectKey() &#123;</span><br><span class="line">slotKey = *((*unsafe.Pointer)(slotKey))  <span class="comment">// è§£å¼•ç”¨</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ----------------------------------------</span></span><br><span class="line"><span class="comment">// æ­¥éª¤ 4.4ï¼šå®Œæ•´ key æ¯”è¾ƒ</span></span><br><span class="line"><span class="comment">// ----------------------------------------</span></span><br><span class="line"><span class="keyword">if</span> typ.Key.Equal(key, slotKey) &#123;</span><br><span class="line"><span class="comment">// æ‰¾åˆ°äº†ï¼è®¡ç®— elem çš„åœ°å€</span></span><br><span class="line"><span class="comment">// elem ç´§è·Ÿåœ¨ key åé¢ï¼Œåç§»é‡ä¸º typ.ElemOff</span></span><br><span class="line">slotElem := unsafe.Pointer(<span class="type">uintptr</span>(slotKeyOrig) + typ.ElemOff)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœæ˜¯é—´æ¥elemï¼ˆelemå¤ªå¤§ï¼Œå­˜çš„æ˜¯æŒ‡é’ˆï¼‰</span></span><br><span class="line"><span class="keyword">if</span> typ.IndirectElem() &#123;</span><br><span class="line">slotElem = *((*unsafe.Pointer)(slotElem))  <span class="comment">// è§£å¼•ç”¨</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> slotElem  <span class="comment">// è¿”å›å…ƒç´ æŒ‡é’ˆ</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// keyä¸åŒ¹é…ï¼ˆæ§åˆ¶å­—ç¢°æ’ï¼‰ï¼Œç§»é™¤å½“å‰åŒ¹é…ä½ï¼Œæ£€æŸ¥ä¸‹ä¸€ä¸ª</span></span><br><span class="line">match = match.removeFirst()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ----------------------------------------</span></span><br><span class="line"><span class="comment">// æ­¥éª¤ 4.5ï¼šæ£€æŸ¥ç©ºæ§½ï¼ˆæ¢æµ‹ç»ˆæ­¢æ¡ä»¶ï¼‰</span></span><br><span class="line"><span class="comment">// ----------------------------------------</span></span><br><span class="line">match = g.ctrls().matchEmpty()</span><br><span class="line"><span class="keyword">if</span> match != <span class="number">0</span> &#123;</span><br><span class="line"><span class="comment">// æ‰¾åˆ°ç©ºæ§½ â†’ æ¢æµ‹åºåˆ—ç»“æŸ â†’ keyä¸å­˜åœ¨ â†’ è¿”å›å¯¹åº”ç±»å‹çš„é›¶å€¼</span></span><br><span class="line"><span class="keyword">return</span> unsafe.Pointer(&amp;zeroVal[<span class="number">0</span>])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“å‰groupæ²¡æœ‰åŒ¹é…ä¸”æ— ç©ºæ§½ï¼Œç»§ç»­æ¢æµ‹ä¸‹ä¸€ä¸ªgroup</span></span><br><span class="line"><span class="comment">// seq.next() ä¼šåº”ç”¨äºŒæ¬¡æ¢æµ‹å…¬å¼ï¼šoffset += index+1</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æŸ¥æ‰¾æ­¥éª¤</strong>ï¼š</p><ol type="1"><li>è®¡ç®—å“ˆå¸Œå¹¶åˆ†å‰²ä¸º H1/H2</li><li>ä½¿ç”¨ H1 å®šä½åˆå§‹ group</li><li>å¹¶è¡ŒåŒ¹é… H2ï¼ˆä¸€æ¬¡æ£€æŸ¥ 8 ä¸ªæ§½ä½ï¼‰</li><li>å¯¹åŒ¹é…çš„æ§½ä½è¿›è¡Œå®Œæ•´ key æ¯”è¾ƒ</li><li>æœªæ‰¾åˆ°åˆ™äºŒæ¬¡æ¢æµ‹ä¸‹ä¸€ä¸ª group</li></ol><pre class="mermaid">flowchart TD    Start([mapaccess1]) --> Hash[è®¡ç®—å“ˆå¸Œ<br/>hash = Hasher key, seed]        Hash --> Size{å°map?<br/>dirLen <= 0}        Size -->|æ˜¯| SmallMap[å•groupæŸ¥æ‰¾<br/>getWithKeySmall]    SmallMap --> Result1{æ‰¾åˆ°?}    Result1 -->|æ˜¯| Return1[è¿”å› elem]    Result1 -->|å¦| Return2[è¿”å› zeroVal]        Size -->|å¦| SelectTable[é€‰æ‹©table<br/>idx = directoryIndex hash]        SelectTable --> ProbeLoop[äºŒæ¬¡æ¢æµ‹å¾ªç¯]        ProbeLoop --> GetGroup[è·å–group<br/>g = groups seq.offset]        GetGroup --> ParallelMatch[â­ å¹¶è¡ŒåŒ¹é…æ§åˆ¶å­—<br/>matches = g.ctrls.matchH2 H2]        ParallelMatch --> HasMatch{æœ‰åŒ¹é…?}        HasMatch -->|æ˜¯| KeyCompare[å®Œæ•´keyæ¯”è¾ƒ<br/>key == slotKey?]        KeyCompare -->|æ˜¯| Return3[è¿”å› slotElem]        KeyCompare -->|å¦| NextMatch{ä¸‹ä¸€ä¸ªåŒ¹é…?}    NextMatch -->|æœ‰| KeyCompare    NextMatch -->|æ— | CheckEmpty        HasMatch -->|å¦| CheckEmpty[æ£€æŸ¥ç©ºæ§½<br/>matchEmpty]        CheckEmpty --> IsEmpty{æœ‰ç©ºæ§½?}        IsEmpty -->|æ˜¯| Return4[è¿”å› zeroVal<br/>keyä¸å­˜åœ¨]        IsEmpty -->|å¦| NextGroup[ä¸‹ä¸€ä¸ªgroup<br/>seq = seq.next]        NextGroup --> GetGroup        Return1 --> End([ç»“æŸ])    Return2 --> End    Return3 --> End    Return4 --> End        style ParallelMatch fill:#ffeb3b,stroke:#f57f17,stroke-width:3px    style KeyCompare fill:#4caf50,stroke:#2e7d32,stroke-width:2px    style Return3 fill:#2196f3,stroke:#1565c0,stroke-width:2px    style Return4 fill:#f44336,stroke:#c62828,stroke-width:2px</pre><h3 id="æ’å…¥æµç¨‹">5. æ’å…¥æµç¨‹</h3><p>æ’å…¥åº•å±‚è°ƒç”¨äº† <code>runtime/maps/runtime_swiss.go</code> ä¸­çš„ <ahref="https://github.com/golang/go/blob/release-branch.go1.25/src/internal/runtime/maps/runtime_swiss.go#L188">runtime_mapassign()</a>å‡½æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">runtime_mapassign</span><span class="params">(typ *abi.SwissMapType, m *Map, key unsafe.Pointer)</span></span> unsafe.Pointer &#123;</span><br><span class="line"><span class="comment">// å¹¶å‘å†™æ£€æµ‹</span></span><br><span class="line"><span class="keyword">if</span> m.writing != <span class="number">0</span> &#123;</span><br><span class="line">fatal(<span class="string">&quot;concurrent map writes&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line"><span class="comment">// æ­¥éª¤ 1ï¼šè®¡ç®—å“ˆå¸Œå¹¶è®¾ç½®å†™æ ‡å¿—</span></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line">hash := typ.Hasher(key, m.seed)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨è°ƒç”¨Hasherä¹‹åè®¾ç½®writingæ ‡å¿—ï¼ˆHasherå¯èƒ½panicï¼‰</span></span><br><span class="line">m.writing ^= <span class="number">1</span>  <span class="comment">// toggleå†™æ ‡å¿—</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line"><span class="comment">// æ­¥éª¤ 2ï¼šç¡®ä¿mapå·²åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line"><span class="keyword">if</span> m.dirPtr == <span class="literal">nil</span> &#123;</span><br><span class="line">m.growToSmall(typ)  <span class="comment">// åˆå§‹åŒ–ä¸ºå°map</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line"><span class="comment">// æ­¥éª¤ 3ï¼šå° map å¿«é€Ÿè·¯å¾„ï¼ˆâ‰¤8ä¸ªå…ƒç´ ï¼‰</span></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line"><span class="keyword">if</span> m.dirLen == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">if</span> m.used &lt; abi.SwissMapGroupSlots &#123;</span><br><span class="line"><span class="comment">// å°mapè¿˜æœ‰ç©ºé—´ï¼Œç›´æ¥æ’å…¥</span></span><br><span class="line">elem := m.putSlotSmall(typ, hash, key)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> m.writing == <span class="number">0</span> &#123;</span><br><span class="line">fatal(<span class="string">&quot;concurrent map writes&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">m.writing ^= <span class="number">1</span>  <span class="comment">// æ¸…é™¤å†™æ ‡å¿—</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> elem</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°mapæ»¡äº†ï¼Œæ‰©å±•ä¸ºå¤§map</span></span><br><span class="line">m.growToTable(typ)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line"><span class="comment">// æ­¥éª¤ 4ï¼šå¤§ map è·¯å¾„ - å¤–å±‚å¾ªç¯ï¼ˆå¤„ç†rehashï¼‰</span></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line"><span class="keyword">var</span> slotElem unsafe.Pointer</span><br><span class="line">outer:</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="comment">// ----------------------------------------</span></span><br><span class="line"><span class="comment">// æ­¥éª¤ 4.1ï¼šé€‰æ‹© table</span></span><br><span class="line"><span class="comment">// ----------------------------------------</span></span><br><span class="line">idx := m.directoryIndex(hash)</span><br><span class="line">t := m.directoryAt(idx)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ----------------------------------------</span></span><br><span class="line"><span class="comment">// æ­¥éª¤ 4.2ï¼šåˆå§‹åŒ–æ¢æµ‹åºåˆ—</span></span><br><span class="line"><span class="comment">// ----------------------------------------</span></span><br><span class="line">seq := makeProbeSeq(h1(hash), t.groups.lengthMask)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®°å½•ç¬¬ä¸€ä¸ªåˆ é™¤æ§½ä½ï¼ˆå¢“ç¢‘å¤ç”¨ä¼˜åŒ–ï¼‰</span></span><br><span class="line"><span class="keyword">var</span> firstDeletedGroup groupReference</span><br><span class="line"><span class="keyword">var</span> firstDeletedSlot <span class="type">uintptr</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ----------------------------------------</span></span><br><span class="line"><span class="comment">// æ­¥éª¤ 4.3ï¼šäºŒæ¬¡æ¢æµ‹å†…å±‚å¾ªç¯</span></span><br><span class="line"><span class="comment">// ----------------------------------------</span></span><br><span class="line"><span class="keyword">for</span> ; ; seq = seq.next() &#123;</span><br><span class="line">g := t.groups.group(typ, seq.offset)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¹¶è¡ŒåŒ¹é…æ§åˆ¶å­—</span></span><br><span class="line">match := g.ctrls().matchH2(h2(hash))</span><br><span class="line"></span><br><span class="line"><span class="comment">// ====================================</span></span><br><span class="line"><span class="comment">// åœºæ™¯ 1ï¼šæŸ¥æ‰¾å·²å­˜åœ¨çš„ keyï¼ˆæ›´æ–°æ“ä½œï¼‰</span></span><br><span class="line"><span class="comment">// ====================================</span></span><br><span class="line"><span class="keyword">for</span> match != <span class="number">0</span> &#123;</span><br><span class="line">i := match.first()</span><br><span class="line"></span><br><span class="line">slotKey := g.key(typ, i)</span><br><span class="line">slotKeyOrig := slotKey</span><br><span class="line"><span class="keyword">if</span> typ.IndirectKey() &#123;</span><br><span class="line">slotKey = *((*unsafe.Pointer)(slotKey))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰¾åˆ°ç›¸åŒçš„key â†’ æ›´æ–°æ“ä½œ</span></span><br><span class="line"><span class="keyword">if</span> typ.Key.Equal(key, slotKey) &#123;</span><br><span class="line"><span class="comment">// æŸäº›ç±»å‹éœ€è¦æ›´æ–°keyï¼ˆå¦‚float NaNï¼‰</span></span><br><span class="line"><span class="keyword">if</span> typ.NeedKeyUpdate() &#123;</span><br><span class="line">typedmemmove(typ.Key, slotKey, key)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¡ç®—elemåœ°å€å¹¶è¿”å›</span></span><br><span class="line">slotElem = unsafe.Pointer(<span class="type">uintptr</span>(slotKeyOrig) + typ.ElemOff)</span><br><span class="line"><span class="keyword">if</span> typ.IndirectElem() &#123;</span><br><span class="line">slotElem = *((*unsafe.Pointer)(slotElem))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">t.checkInvariants(typ, m)</span><br><span class="line"><span class="keyword">break</span> outer  <span class="comment">// å®Œæˆæ›´æ–°ï¼Œé€€å‡ºæ‰€æœ‰å¾ªç¯</span></span><br><span class="line">&#125;</span><br><span class="line">match = match.removeFirst()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ====================================</span></span><br><span class="line"><span class="comment">// åœºæ™¯ 2ï¼šé‡åˆ°ç©ºæ§½ â†’ æ’å…¥æ–° key</span></span><br><span class="line"><span class="comment">// ====================================</span></span><br><span class="line">match = g.ctrls().matchEmpty()</span><br><span class="line"><span class="keyword">if</span> match != <span class="number">0</span> &#123;</span><br><span class="line"><span class="comment">// æ‰¾åˆ°ç©ºæ§½ï¼Œæ¢æµ‹åºåˆ—ç»“æŸ</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> i <span class="type">uintptr</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¼˜å…ˆå¤ç”¨åˆ é™¤æ§½ä½ï¼ˆé¿å…æ¶ˆè€—growthLeftï¼‰</span></span><br><span class="line"><span class="keyword">if</span> firstDeletedGroup.data != <span class="literal">nil</span> &#123;</span><br><span class="line">g = firstDeletedGroup</span><br><span class="line">i = firstDeletedSlot</span><br><span class="line">t.growthLeft++  <span class="comment">// è¡¥å¿åé¢çš„--æ“ä½œ</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// ä½¿ç”¨ç©ºæ§½</span></span><br><span class="line">i = match.first()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// --------------------------------</span></span><br><span class="line"><span class="comment">// æ£€æŸ¥æ˜¯å¦æœ‰å¢é•¿ç©ºé—´</span></span><br><span class="line"><span class="comment">// --------------------------------</span></span><br><span class="line"><span class="keyword">if</span> t.growthLeft &gt; <span class="number">0</span> &#123;</span><br><span class="line"><span class="comment">// æœ‰ç©ºé—´ï¼Œç›´æ¥æ’å…¥æ–°entry</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å‡†å¤‡keyå­˜å‚¨</span></span><br><span class="line">slotKey := g.key(typ, i)</span><br><span class="line">slotKeyOrig := slotKey</span><br><span class="line"><span class="keyword">if</span> typ.IndirectKey() &#123;</span><br><span class="line"><span class="comment">// å¤§keyï¼šåˆ†é…å †å†…å­˜ï¼Œå­˜æŒ‡é’ˆ</span></span><br><span class="line">kmem := newobject(typ.Key)</span><br><span class="line">*(*unsafe.Pointer)(slotKey) = kmem</span><br><span class="line">slotKey = kmem</span><br><span class="line">&#125;</span><br><span class="line">typedmemmove(typ.Key, slotKey, key)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‡†å¤‡elemå­˜å‚¨</span></span><br><span class="line">slotElem = unsafe.Pointer(<span class="type">uintptr</span>(slotKeyOrig) + typ.ElemOff)</span><br><span class="line"><span class="keyword">if</span> typ.IndirectElem() &#123;</span><br><span class="line"><span class="comment">// å¤§elemï¼šåˆ†é…å †å†…å­˜ï¼Œå­˜æŒ‡é’ˆ</span></span><br><span class="line">emem := newobject(typ.Elem)</span><br><span class="line">*(*unsafe.Pointer)(slotElem) = emem</span><br><span class="line">slotElem = emem</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®æ§åˆ¶å­—ä¸ºH2</span></span><br><span class="line">g.ctrls().set(i, ctrl(h2(hash)))</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ›´æ–°è®¡æ•°å™¨</span></span><br><span class="line">t.growthLeft--</span><br><span class="line">t.used++</span><br><span class="line">m.used++</span><br><span class="line"></span><br><span class="line">t.checkInvariants(typ, m)</span><br><span class="line"><span class="keyword">break</span> outer  <span class="comment">// å®Œæˆæ’å…¥ï¼Œé€€å‡ºæ‰€æœ‰å¾ªç¯</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// --------------------------------</span></span><br><span class="line"><span class="comment">// æ²¡æœ‰å¢é•¿ç©ºé—´ï¼Œè§¦å‘rehash</span></span><br><span class="line"><span class="comment">// --------------------------------</span></span><br><span class="line">t.rehash(typ, m)</span><br><span class="line"><span class="keyword">continue</span> outer  <span class="comment">// é‡æ–°å¼€å§‹ï¼ˆtableç»“æ„å·²å˜åŒ–ï¼‰</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ====================================</span></span><br><span class="line"><span class="comment">// åœºæ™¯ 3ï¼šè®°å½•ç¬¬ä¸€ä¸ªåˆ é™¤æ§½ä½ï¼ˆå»¶è¿Ÿé€‰æ‹©ï¼‰</span></span><br><span class="line"><span class="comment">// ====================================</span></span><br><span class="line"><span class="comment">// å½“å‰groupæ²¡æœ‰ç©ºæ§½ï¼Œç»§ç»­æ¢æµ‹ï¼Œä½†è®°å½•åˆ é™¤æ§½ä½</span></span><br><span class="line"><span class="keyword">if</span> firstDeletedGroup.data == <span class="literal">nil</span> &#123;</span><br><span class="line">match = g.ctrls().matchEmptyOrDeleted()</span><br><span class="line"><span class="keyword">if</span> match != <span class="number">0</span> &#123;</span><br><span class="line"><span class="comment">// æ‰¾åˆ°åˆ é™¤æ§½ä½ï¼Œè®°å½•ä¸‹æ¥</span></span><br><span class="line"><span class="comment">// ï¼ˆå¯èƒ½åç»­æ‰¾åˆ°existing keyï¼Œä¹Ÿå¯èƒ½ç”¨äºæ’å…¥ï¼‰</span></span><br><span class="line">firstDeletedGroup = g</span><br><span class="line">firstDeletedSlot = match.first()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»§ç»­æ¢æµ‹ä¸‹ä¸€ä¸ªgroup</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line"><span class="comment">// æ­¥éª¤ 5ï¼šæ¸…é™¤å†™æ ‡å¿—å¹¶è¿”å›</span></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line"><span class="keyword">if</span> m.writing == <span class="number">0</span> &#123;</span><br><span class="line">fatal(<span class="string">&quot;concurrent map writes&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">m.writing ^= <span class="number">1</span>  <span class="comment">// æ¸…é™¤å†™æ ‡å¿—</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> slotElem  <span class="comment">// è¿”å›elemæŒ‡é’ˆä¾›è°ƒç”¨è€…å†™å…¥å€¼</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å…³é”®ç­–ç•¥</strong>ï¼š - ä¼˜å…ˆé‡ç”¨å¢“ç¢‘æ§½ä½ï¼ˆé¿å…æµªè´¹ç©ºé—´ï¼‰ -æ¢æµ‹åˆ°ç©ºæ§½è¡¨ç¤º key ä¸å­˜åœ¨ - è‡ªåŠ¨è§¦å‘è¡¨åˆ†è£‚ï¼ˆå¦‚æœè´Ÿè½½è¿‡é«˜ï¼‰</p><pre class="mermaid">flowchart TD    Start([mapassign]) --> Hash[è®¡ç®—å“ˆå¸Œ<br/>è®¾ç½®å†™æ ‡å¿—]        Hash --> Init{å·²åˆå§‹åŒ–?}    Init -->|å¦| GrowSmall[growToSmall]    Init -->|æ˜¯| CheckSize    GrowSmall --> CheckSize        CheckSize{å°map?<br/>dirLen == 0}        CheckSize -->|æ˜¯| HasSpace{used < 8?}    HasSpace -->|æ˜¯| PutSmall[ç›´æ¥æ’å…¥<br/>putSlotSmall]    HasSpace -->|å¦| GrowTable[æ‰©å±•ä¸ºå¤§map<br/>growToTable]        PutSmall --> Return1[è¿”å› elem]    GrowTable --> BigMap        CheckSize -->|å¦| BigMap[å¤§mapè·¯å¾„]        BigMap --> SelectTable[é€‰æ‹©table<br/>idx = directoryIndex hash]        SelectTable --> ProbeLoop[äºŒæ¬¡æ¢æµ‹å¾ªç¯]        ProbeLoop --> GetGroup[è·å–group]        GetGroup --> Match[â­ å¹¶è¡ŒåŒ¹é…H2<br/>matchH2]        Match --> CheckExist{æ‰¾åˆ°existing<br/>key?}        CheckExist -->|æ˜¯| UpdateKey[æ›´æ–°æ“ä½œ<br/>NeedKeyUpdate?]    UpdateKey --> Return2[è¿”å› elem]        CheckExist -->|å¦| CheckEmpty{é‡åˆ°ç©ºæ§½?}        CheckEmpty -->|æ˜¯| HasDeleted{æœ‰è®°å½•çš„<br/>åˆ é™¤æ§½ä½?}        HasDeleted -->|æ˜¯| UseDeleted[å¤ç”¨åˆ é™¤æ§½ä½]    HasDeleted -->|å¦| UseEmpty[ä½¿ç”¨ç©ºæ§½]        UseDeleted --> CheckGrowth    UseEmpty --> CheckGrowth{growthLeft > 0?}        CheckGrowth -->|æ˜¯| InsertNew[æ’å…¥æ–°entry<br/>è®¾ç½®æ§åˆ¶å­—<br/>æ›´æ–°è®¡æ•°]    InsertNew --> Return3[è¿”å› elem]        CheckGrowth -->|å¦| Rehash[è§¦å‘rehash<br/>t.rehash]    Rehash --> SelectTable        CheckEmpty -->|å¦| RecordDeleted[è®°å½•åˆ é™¤æ§½ä½<br/>matchEmptyOrDeleted]        RecordDeleted --> NextGroup[ä¸‹ä¸€ä¸ªgroup<br/>seq.next]    NextGroup --> GetGroup        Return1 --> ClearFlag[æ¸…é™¤å†™æ ‡å¿—]    Return2 --> ClearFlag    Return3 --> ClearFlag    ClearFlag --> End([ç»“æŸ])        style Match fill:#ffeb3b,stroke:#f57f17,stroke-width:3px    style InsertNew fill:#4caf50,stroke:#2e7d32,stroke-width:2px    style UpdateKey fill:#2196f3,stroke:#1565c0,stroke-width:2px    style Rehash fill:#ff9800,stroke:#e65100,stroke-width:2px</pre><h3 id="åˆ é™¤æ“ä½œå¢“ç¢‘æœºåˆ¶">6. åˆ é™¤æ“ä½œï¼ˆå¢“ç¢‘æœºåˆ¶ï¼‰</h3><p>åˆ é™¤æ“ä½œåº•å±‚è°ƒç”¨äº† <code>runtime/map_swiss.go</code> ä¸­çš„ <ahref="http://github.com/golang/go/blob/release-branch.go1.25/src/runtime/map_swiss.go#L139">mapdelete()</a>å‡½æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mapdelete</span><span class="params">(t *abi.SwissMapType, m *maps.Map, key unsafe.Pointer)</span></span> &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">m.Delete(t, key)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span></span> Delete(typ *abi.SwissMapType, key unsafe.Pointer) &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> m.dirLen == <span class="number">0</span> &#123;</span><br><span class="line">    <span class="comment">// å° map åˆ é™¤</span></span><br><span class="line">m.deleteSmall(typ, hash, key)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å¤§ map åˆ é™¤</span></span><br><span class="line">idx := m.directoryIndex(hash)</span><br><span class="line"><span class="keyword">if</span> m.directoryAt(idx).Delete(typ, m, hash, key) &#123;</span><br><span class="line">m.tombstonePossible = <span class="literal">true</span> <span class="comment">// å¦‚æœè¿”å› trueï¼Œåˆ™è¡¨æ˜å¯èƒ½è®¾ç½®äº†å¢“ç¢‘</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ® map çš„å¤§å°å…·ä½“åˆ†ä¸º <code>m.deleteSmall(typ, hash, key)</code> å’Œ<code>m.directoryAt(idx).Delete(typ, m, hash, key)</code>ä¸¤ç§åˆ é™¤é€»è¾‘ã€‚æˆ‘ä»¬é‡ç‚¹æ¥çœ‹ä¸€ä¸‹ <ahref="https://github.com/golang/go/blob/release-branch.go1.25/src/internal/runtime/maps/table.go#L421">m.directoryAt(idx).Delete(typ,m, hash, key)</a>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Delete åˆ é™¤ keyï¼Œè¿”å›æ˜¯å¦æ”¾ç½®äº†å¢“ç¢‘</span></span><br><span class="line"><span class="comment">// è¿”å› trueï¼šæ”¾ç½®äº†å¢“ç¢‘ï¼ˆgroupå·²æ»¡ï¼Œéœ€è¦ä¿æŒæ¢æµ‹é“¾å®Œæ•´ï¼‰</span></span><br><span class="line"><span class="comment">// è¿”å› falseï¼šæœªæ‰¾åˆ°key æˆ– ç›´æ¥æ¸…ç©ºï¼ˆgroupæœ‰ç©ºæ§½ï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *table)</span></span> Delete(typ *abi.SwissMapType, m *Map, hash <span class="type">uintptr</span>, key unsafe.Pointer) <span class="type">bool</span> &#123;</span><br><span class="line">  <span class="comment">// 1ï¼šåˆå§‹åŒ–äºŒæ¬¡æ¢æµ‹åºåˆ—</span></span><br><span class="line">seq := makeProbeSeq(h1(hash), t.groups.lengthMask)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2ï¼šæ¢æµ‹å¾ªç¯ - æŸ¥æ‰¾ key</span></span><br><span class="line"><span class="keyword">for</span> ; ; seq = seq.next() &#123;</span><br><span class="line"><span class="comment">// è·å–å½“å‰ group</span></span><br><span class="line">g := t.groups.group(typ, seq.offset)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¹¶è¡ŒåŒ¹é…æ§åˆ¶å­—</span></span><br><span class="line">match := g.ctrls().matchH2(h2(hash))</span><br><span class="line"></span><br><span class="line"><span class="comment">// éå†æ‰€æœ‰åŒ¹é…çš„æ§½ä½</span></span><br><span class="line"><span class="keyword">for</span> match != <span class="number">0</span> &#123;</span><br><span class="line">i := match.first()</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–æ§½ä½ä¸­çš„ key</span></span><br><span class="line">slotKey := g.key(typ, i)</span><br><span class="line">origSlotKey := slotKey  <span class="comment">// ä¿å­˜åŸå§‹æŒ‡é’ˆ</span></span><br><span class="line"><span class="keyword">if</span> typ.IndirectKey() &#123;</span><br><span class="line">slotKey = *((*unsafe.Pointer)(slotKey))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3ï¼šæ‰¾åˆ°åŒ¹é…çš„ keyï¼Œæ‰§è¡Œåˆ é™¤</span></span><br><span class="line"><span class="keyword">if</span> typ.Key.Equal(key, slotKey) &#123;</span><br><span class="line">t.used--</span><br><span class="line">m.used--</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¸…é™¤ key çš„å†…å­˜</span></span><br><span class="line"><span class="keyword">if</span> typ.IndirectKey() &#123;</span><br><span class="line">*(*unsafe.Pointer)(origSlotKey) = <span class="literal">nil</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> typ.Key.Pointers() &#123;</span><br><span class="line">typedmemclr(typ.Key, slotKey)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¸…é™¤ elem çš„å†…å­˜</span></span><br><span class="line">slotElem := g.elem(typ, i)</span><br><span class="line"><span class="keyword">if</span> typ.IndirectElem() &#123;</span><br><span class="line">*(*unsafe.Pointer)(slotElem) = <span class="literal">nil</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">typedmemclr(typ.Elem, slotElem)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4ï¼šå†³å®šæ§åˆ¶å­—ç­–ç•¥ï¼ˆå…³é”®è®¾è®¡ï¼ï¼‰</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * æ ¸å¿ƒé€»è¾‘ï¼š</span></span><br><span class="line"><span class="comment"> * - æ¢æµ‹é“¾é‡åˆ°ç©ºæ§½ä¼šç»ˆæ­¢</span></span><br><span class="line"><span class="comment"> * - åªæœ‰&quot;æ»¡group&quot;æ‰ä¼šå‡ºç°åœ¨æ¢æµ‹é“¾ä¸­é—´</span></span><br><span class="line"><span class="comment"> * - groupä¸€æ—¦æ»¡äº†ï¼Œåœ¨rehashå‰ä¼šä¸€ç›´ä¿æŒæ»¡</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * å› æ­¤ï¼š</span></span><br><span class="line"><span class="comment"> * - groupæœ‰ç©ºæ§½ â†’ åˆ é™¤ä¸ä¼šç ´åæ¢æµ‹é“¾ â†’ ç›´æ¥æ¸…ç©º</span></span><br><span class="line"><span class="comment"> * - groupæ— ç©ºæ§½ â†’ åˆ é™¤å¯èƒ½ç ´åæ¢æµ‹é“¾ â†’ æ”¾ç½®å¢“ç¢‘</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> tombstone <span class="type">bool</span></span><br><span class="line"><span class="keyword">if</span> g.ctrls().matchEmpty() != <span class="number">0</span> &#123;</span><br><span class="line"><span class="comment">// --------------------------------</span></span><br><span class="line"><span class="comment">// åœºæ™¯ Aï¼šgroup æœ‰ç©ºæ§½ â†’ ç›´æ¥æ¸…ç©º</span></span><br><span class="line"><span class="comment">// --------------------------------</span></span><br><span class="line">g.ctrls().set(i, ctrlEmpty)</span><br><span class="line">t.growthLeft++  <span class="comment">// æ¢å¤å¢é•¿ç©ºé—´</span></span><br><span class="line">tombstone = <span class="literal">false</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// --------------------------------</span></span><br><span class="line"><span class="comment">// åœºæ™¯ Bï¼šgroup å·²æ»¡ â†’ æ”¾ç½®å¢“ç¢‘</span></span><br><span class="line"><span class="comment">// --------------------------------</span></span><br><span class="line">g.ctrls().set(i, ctrlDeleted)</span><br><span class="line">tombstone = <span class="literal">true</span></span><br><span class="line"><span class="comment">// æ³¨æ„ï¼šä¸å¢åŠ  growthLeft</span></span><br><span class="line"><span class="comment">// å¢“ç¢‘ä»å ç”¨ç©ºé—´ï¼Œä½†å¯è¢«åç»­æ’å…¥å¤ç”¨</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">t.checkInvariants(typ, m)</span><br><span class="line"><span class="keyword">return</span> tombstone  <span class="comment">// è¿”å›æ˜¯å¦æ”¾ç½®äº†å¢“ç¢‘</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// keyä¸åŒ¹é…ï¼Œæ£€æŸ¥ä¸‹ä¸€ä¸ªåŒ¹é…ä½</span></span><br><span class="line">match = match.removeFirst()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4ï¼šæ£€æŸ¥ç©ºæ§½ï¼ˆæ¢æµ‹ç»ˆæ­¢æ¡ä»¶ï¼‰</span></span><br><span class="line">match = g.ctrls().matchEmpty()</span><br><span class="line"><span class="keyword">if</span> match != <span class="number">0</span> &#123;</span><br><span class="line"><span class="comment">// é‡åˆ°ç©ºæ§½ â†’ æ¢æµ‹é“¾ç»“æŸ â†’ keyä¸å­˜åœ¨</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»§ç»­æ¢æµ‹ä¸‹ä¸€ä¸ª group</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><pre class="mermaid">flowchart TD    Start([table.Delete]) --> InitProbe[åˆå§‹åŒ–æ¢æµ‹<br/>seq = makeProbeSeq H1]        InitProbe --> ProbeLoop[æ¢æµ‹å¾ªç¯]        ProbeLoop --> GetGroup[è·å–group]        GetGroup --> Match[â­ å¹¶è¡ŒåŒ¹é…H2<br/>matchH2]        Match --> HasMatch{æœ‰åŒ¹é…?}        HasMatch -->|æ˜¯| KeyCompare[å®Œæ•´keyæ¯”è¾ƒ<br/>key == slotKey?]        KeyCompare -->|æ˜¯| UpdateCount[æ›´æ–°è®¡æ•°<br/>t.used--<br/>m.used--]        UpdateCount --> ClearKey[æ¸…é™¤keyå†…å­˜<br/>IndirectKey?<br/>Pointers?]        ClearKey --> ClearElem[æ¸…é™¤elemå†…å­˜<br/>æ€»æ˜¯æ¸…é™¤]        ClearElem --> CheckFull{â­ groupæœ‰<br/>ç©ºæ§½?}        CheckFull -->|æ˜¯| SetEmpty[è®¾ç½® ctrlEmpty<br/>growthLeft++]    SetEmpty --> ReturnFalse[è¿”å› false<br/>æœªæ”¾ç½®å¢“ç¢‘]        CheckFull -->|å¦| SetDeleted[è®¾ç½® ctrlDeleted<br/>ä¿æŒ growthLeft]    SetDeleted --> ReturnTrue[è¿”å› true<br/>å·²æ”¾ç½®å¢“ç¢‘]        KeyCompare -->|å¦| NextMatch{ä¸‹ä¸€ä¸ªåŒ¹é…?}    NextMatch -->|æœ‰| KeyCompare    NextMatch -->|æ— | CheckEmpty        HasMatch -->|å¦| CheckEmpty[æ£€æŸ¥ç©ºæ§½<br/>matchEmpty]        CheckEmpty --> IsEmpty{æœ‰ç©ºæ§½?}        IsEmpty -->|æ˜¯| ReturnFalse2[è¿”å› false<br/>keyä¸å­˜åœ¨]        IsEmpty -->|å¦| NextGroup[ä¸‹ä¸€ä¸ªgroup<br/>seq.next]    NextGroup --> GetGroup        ReturnTrue --> End([ç»“æŸ])    ReturnFalse --> End    ReturnFalse2 --> End        style Match fill:#ffeb3b,stroke:#f57f17,stroke-width:3px    style CheckFull fill:#ff9800,stroke:#e65100,stroke-width:3px    style SetEmpty fill:#4caf50,stroke:#2e7d32,stroke-width:2px    style SetDeleted fill:#f44336,stroke:#c62828,stroke-width:2px</pre><p>å¢“ç¢‘çš„æ ¸å¿ƒä½œç”¨æ˜¯ï¼š<strong>ä¿æŒæ¢æµ‹é“¾çš„å®Œæ•´æ€§ï¼Œé˜²æ­¢åç»­å…ƒç´ "å¤±è”"</strong>ã€‚</p><p>ä¸ç”¨å¢“ç¢‘ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">å‡è®¾æœ‰3ä¸ªè¿ç»­çš„æ»¡groupï¼ˆhashç¢°æ’å¯¼è‡´ï¼‰ï¼š</span><br><span class="line"></span><br><span class="line">åˆå§‹çŠ¶æ€ï¼ˆæ’å…¥é¡ºåºï¼šA â†’ B â†’ Cï¼‰ï¼š</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ Group 5: [A][X][X][X][X][X][X][X] â”‚ â† Açš„é¦–é€‰ä½ç½®ï¼Œä½†å·²æ»¡</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">           â†“ ç»§ç»­æ¢æµ‹</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ Group 6: [B][X][X][X][X][X][X][X] â”‚ â† Bçš„é¦–é€‰ä¹Ÿæ˜¯Group 5ï¼Œè¢«æŒ¤åˆ°è¿™é‡Œ</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">           â†“ ç»§ç»­æ¢æµ‹</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ Group 7: [C][X][X][X][X][X][X][X] â”‚ â† Cä¹Ÿæ˜¯ï¼Œè¢«æŒ¤åˆ°è¿™é‡Œ</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">           â†“</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ Group 8: [ ][...æœªä½¿ç”¨...] â”‚ â† ç©ºæ§½ï¼Œæ¢æµ‹ç»ˆæ­¢</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ç°åœ¨åˆ é™¤ Bï¼ˆå¦‚æœç›´æ¥è®¾ç½®ä¸º Emptyï¼‰ï¼š</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ Group 5: [A][X][X][X][X][X][X][X] â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">           â†“</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ Group 6: [Empty][X][X][X][X][X][X][X] â”‚ â† å˜æˆç©ºæ§½ï¼</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">           â†“ âš ï¸ æ¢æµ‹åœ¨è¿™é‡Œç»ˆæ­¢ï¼</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ Group 7: [C][X][X][X][X][X][X][X] â”‚ â† C&quot;å¤±è”&quot;äº†ï¼</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">æŸ¥æ‰¾ C æ—¶ï¼š</span><br><span class="line">1. è®¡ç®— hash â†’ é¦–é€‰ Group 5</span><br><span class="line">2. Group 5 æ²¡æœ‰ â†’ ç»§ç»­æ¢æµ‹åˆ° Group 6</span><br><span class="line">3. Group 6 å‘ç° Empty â†’ ç»ˆæ­¢æ¢æµ‹</span><br><span class="line">4. è¿”å›&quot;ä¸å­˜åœ¨&quot; âŒ ï¼ˆä½† C å®é™…åœ¨ Group 7ï¼ï¼‰</span><br></pre></td></tr></table></figure><p>è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨å¢“ç¢‘</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">åˆ é™¤ Bï¼ˆä½¿ç”¨å¢“ç¢‘ï¼‰ï¼š</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ Group 5: [A][X][X][X][X][X][X][X] â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">           â†“</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ Group 6: [Deleted][X][X][X][X][X][X][X] â”‚ â† å¢“ç¢‘ï¼Œæ¢æµ‹ç»§ç»­ï¼</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">           â†“ âœ“ æ¢æµ‹ç»§ç»­</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ Group 7: [C][X][X][X][X][X][X][X] â”‚ â† èƒ½æ‰¾åˆ° Cï¼</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">           â†“</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ Group 8: [ ][...æœªä½¿ç”¨...] â”‚ â† Empty æ‰ç»ˆæ­¢</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">æŸ¥æ‰¾ C æ—¶ï¼š</span><br><span class="line">1. è®¡ç®— hash â†’ é¦–é€‰ Group 5</span><br><span class="line">2. Group 5 æ²¡æœ‰ â†’ ç»§ç»­</span><br><span class="line">3. Group 6 å‘ç° Deleted â†’ è·³è¿‡ï¼Œç»§ç»­æ¢æµ‹ï¼</span><br><span class="line">4. Group 7 æ‰¾åˆ° C âœ“</span><br></pre></td></tr></table></figure><p>ä¸‰ç§æ§åˆ¶å­—ä»£è¡¨ä¸åŒçš„æ¢æµ‹è¡Œä¸ºï¼š</p><table><thead><tr><th>ctrlEmpty</th><th>ctrlDeleted</th><th>H2 (0-127)</th></tr></thead><tbody><tr><td>ç©ºæ§½</td><td>å¢“ç¢‘</td><td>æœ‰æ•ˆentry</td></tr><tr><td>åœæ­¢æ¢æµ‹ï¼Œkey ä¸å­˜åœ¨</td><td>è·³è¿‡ç»§ç»­æ‰¾</td><td>æ£€æŸ¥ keyï¼Œå¯èƒ½æ‰¾åˆ°</td></tr></tbody></table><p>å®é™…ä»£ç ä¸­çš„ä½“ç°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¢æµ‹å¾ªç¯ä¸­</span></span><br><span class="line">match = g.ctrls().matchEmpty()</span><br><span class="line"><span class="keyword">if</span> match != <span class="number">0</span> &#123;</span><br><span class="line">    <span class="comment">// é‡åˆ° Empty â†’ ç»ˆæ­¢</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>  <span class="comment">// keyä¸å­˜åœ¨</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// é‡åˆ° Deleted â†’ å¾ªç¯ç»§ç»­</span></span><br><span class="line"><span class="comment">// é‡åˆ° H2 â†’ æ£€æŸ¥key</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¢“ç¢‘å¿…é¡» != ctrlEmpty</span></span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆæœ‰äº›æƒ…å†µä¸éœ€è¦å¢“ç¢‘ï¼Ÿ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">å¦‚æœåˆ é™¤å group æœ‰ç©ºæ§½ï¼š</span><br><span class="line"></span><br><span class="line">åˆ é™¤å‰ï¼š</span><br><span class="line">Group 6: [B][X][X][ ][ ][ ][ ][ ]  â† æœ‰ç©ºæ§½</span><br><span class="line"></span><br><span class="line">åˆ é™¤ Bï¼š</span><br><span class="line">Group 6: [ ][X][X][ ][ ][ ][ ][ ]  â† ç›´æ¥æ¸…ç©º</span><br><span class="line"></span><br><span class="line">ä¸ºä»€ä¹ˆå®‰å…¨ï¼Ÿ</span><br><span class="line">å› ä¸ºæ¢æµ‹é“¾æœ¬æ¥å°±åœ¨è¿™ä¸ª group ç»ˆæ­¢ï¼</span><br><span class="line">ï¼ˆæœ‰ç©ºæ§½æ„å‘³ç€åç»­æ²¡æœ‰ç¢°æ’å…ƒç´ ï¼‰</span><br></pre></td></tr></table></figure><p>æ€»ç»“æ¥è¯´ï¼Œå¢“ç¢‘ =<strong>æ¢æµ‹é“¾çš„"è™šæ‹Ÿå ä½ç¬¦"</strong>ï¼Œå¦‚æœæ²¡æœ‰å¢“ç¢‘ï¼Œåˆ é™¤æ“ä½œä¼šç ´åå¼€æ”¾å¯»å€å“ˆå¸Œè¡¨çš„æ¢æµ‹é“¾ï¼Œå¯¼è‡´æŸäº›å…ƒç´ æ°¸è¿œæ‰¾ä¸åˆ°ï¼</p><table><thead><tr><th>ä½œç”¨</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>ğŸ”— <strong>ä¿æŒé“¾æ¥</strong></td><td>é˜²æ­¢æ¢æµ‹é“¾è¢«"æˆªæ–­"ï¼Œåç»­å…ƒç´ å¤±è”</td></tr><tr><td>â™»ï¸ <strong>å¯å¤ç”¨</strong></td><td>æ’å…¥æ—¶ä¼˜å…ˆä½¿ç”¨å¢“ç¢‘ä½ç½®ï¼ˆä¸æ¶ˆè€— growthLeftï¼‰</td></tr><tr><td>ğŸ§¹ <strong>å»¶è¿Ÿæ¸…ç†</strong></td><td>rehash æ—¶ä¸€æ¬¡æ€§æ¸…é™¤æ‰€æœ‰å¢“ç¢‘</td></tr><tr><td>âš–ï¸ <strong>æƒè¡¡</strong></td><td>å ç”¨ç©ºé—´ vs æ¢æµ‹é“¾å®Œæ•´æ€§</td></tr></tbody></table><h2 id="å››å¯æ‰©å±•å“ˆå¸Œä¸å¢é‡æ‰©å®¹">å››ã€å¯æ‰©å±•å“ˆå¸Œä¸å¢é‡æ‰©å®¹</h2><h3 id="å¯æ‰©å±•å“ˆå¸ŒåŸç†">1. å¯æ‰©å±•å“ˆå¸ŒåŸç†</h3><p>ä¼ ç»Ÿå•è¡¨æ‰©å®¹çš„é—®é¢˜ï¼š <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Table (100ä¸‡å…ƒç´ ) â†’ Table (200ä¸‡å…ƒç´ )</span><br><span class="line">                    â†‘ å»¶è¿Ÿå³°å€¼ï¼</span><br></pre></td></tr></table></figure></p><p>Swiss map çš„è§£å†³æ–¹æ¡ˆï¼š <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å°†å¤§ map æ‹†åˆ†æˆå¤šä¸ªå° table</span><br><span class="line">æ¯ä¸ª table ç‹¬ç«‹æ‰©å®¹</span><br></pre></td></tr></table></figure></p><p><strong>ç›®å½•ç»“æ„</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Hash = 0x1A2B3C4D</span><br><span class="line"></span><br><span class="line">globalDepth = 2 (ä½¿ç”¨é«˜ 2 ä½)</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ Directory (size=4) â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ [00] â†’ Table0      â”‚ â† localDepth=1</span><br><span class="line">â”‚ [01] â†’ Table0      â”‚ â† åŒä¸€ä¸ª table</span><br><span class="line">â”‚ [10] â†’ Table1      â”‚ â† localDepth=2</span><br><span class="line">â”‚ [11] â†’ Table2      â”‚ â† localDepth=2</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line">hash &gt;&gt; (64-2) = 00  â†’ ç´¢å¼• Table0</span><br></pre></td></tr></table></figure><h3 id="è¡¨åˆ†è£‚è¿‡ç¨‹">2. è¡¨åˆ†è£‚è¿‡ç¨‹</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> maxTableCapacity = <span class="number">1024</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *table)</span></span> rehash(typ *abi.SwissMapType, m *Map) &#123;</span><br><span class="line">newCapacity := <span class="number">2</span> * t.capacity</span><br><span class="line"><span class="keyword">if</span> newCapacity &lt;= maxTableCapacity &#123;</span><br><span class="line">t.grow(typ, m, newCapacity) <span class="comment">// è¡¨å†…æ‰©å®¹</span></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">t.split(typ, m) <span class="comment">// åˆ†è£‚</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è§¦å‘æ¡ä»¶</strong>ï¼š</p><ul><li>è´Ÿè½½å› å­ &gt; 7/8ï¼ˆå®¹é‡ Ã— 0.875ï¼‰</li><li>å•è¡¨å®¹é‡ â‰¤ 1024ï¼šè¡¨å†…æ‰©å®¹ï¼ˆå®¹é‡ç¿»å€ï¼‰</li><li>å•è¡¨å®¹é‡ &gt; 1024ï¼šåˆ†è£‚æˆä¸¤ä¸ªè¡¨</li></ul><p><strong>åˆ†è£‚ç¤ºä¾‹</strong>ï¼š <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">åˆå§‹çŠ¶æ€ (globalDepth=1):</span><br><span class="line">Directory: [0] â†’ Table0 (localDepth=1, å®¹é‡=1024)</span><br><span class="line">           [1] â†’ Table1 (localDepth=1, å®¹é‡=1024)</span><br><span class="line"></span><br><span class="line">Table1 æ»¡äº†ï¼Œéœ€è¦åˆ†è£‚ï¼š</span><br><span class="line">1. Table1 åˆ†è£‚ä¸º Table1a å’Œ Table1b</span><br><span class="line">2. globalDepth å¢åŠ åˆ° 2</span><br><span class="line">3. ç›®å½•æ‰©å±•ï¼š</span><br><span class="line">   Directory: [00] â†’ Table0  (localDepth=1)</span><br><span class="line">              [01] â†’ Table0  (åŒä¸€ä¸ª)</span><br><span class="line">              [10] â†’ Table1a (localDepth=2)</span><br><span class="line">              [11] â†’ Table1b (localDepth=2)</span><br></pre></td></tr></table></figure></p><p><strong>åˆ†è£‚è§„åˆ™</strong>ï¼š <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">æ—§ table çš„å…ƒç´ æ ¹æ®å“ˆå¸Œçš„æ–° bit åˆ†æµï¼š</span><br><span class="line">hash &amp; newbit == 0 â†’ Table1a (ä½ä½)</span><br><span class="line">hash &amp; newbit != 0 â†’ Table1b (é«˜ä½)</span><br></pre></td></tr></table></figure></p><h3 id="è´Ÿè½½å› å­">3. è´Ÿè½½å› å­</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> maxAvgGroupLoad = <span class="number">7</span>  <span class="comment">// 7/8 = 87.5%</span></span><br></pre></td></tr></table></figure><ul><li>Non-Swissï¼š6.5ï¼ˆçº¦ 81%ï¼‰</li><li>Swissï¼š7/8ï¼ˆ87.5%ï¼‰</li></ul><p><strong>æ›´é«˜çš„åŸå› </strong>ï¼šå¼€æ”¾å¯»å€ + å¢“ç¢‘é‡ç”¨æé«˜ç©ºé—´åˆ©ç”¨ç‡</p><h2 id="äº”ä¸-non-swiss-å¯¹æ¯”">äº”ã€ä¸ Non-Swiss å¯¹æ¯”</h2><table><thead><tr><th>ç»´åº¦</th><th>Non-Swiss</th><th>Swiss</th></tr></thead><tbody><tr><td><strong>æ ¸å¿ƒç»“æ„</strong></td><td>æ¡¶ + é“¾å¼æº¢å‡º</td><td>ç»„ + å¼€æ”¾å¯»å€</td></tr><tr><td><strong>æ¯æ¡¶/ç»„å¤§å°</strong></td><td>8 ä¸ªé”®å€¼å¯¹</td><td>8 ä¸ªæ§½ä½</td></tr><tr><td><strong>æŸ¥æ‰¾æ–¹å¼</strong></td><td>é¡ºåºæ¯”è¾ƒ tophash</td><td><strong>å¹¶è¡ŒåŒ¹é… H2</strong> â­</td></tr><tr><td><strong>å†²çªå¤„ç†</strong></td><td>æº¢å‡ºæ¡¶é“¾è¡¨</td><td>äºŒæ¬¡æ¢æµ‹</td></tr><tr><td><strong>æ‰©å®¹æ–¹å¼</strong></td><td>æ¸è¿›å¼è¿ç§»ï¼ˆå…¨å±€é”ï¼‰</td><td><strong>è¡¨åˆ†è£‚ï¼ˆç»†ç²’åº¦ï¼‰</strong> â­</td></tr><tr><td><strong>è´Ÿè½½å› å­</strong></td><td>6.5 (81%)</td><td>7/8 (87.5%)</td></tr><tr><td><strong>åˆ é™¤æ ‡è®°</strong></td><td>ç›´æ¥åˆ é™¤</td><td>å¢“ç¢‘æœºåˆ¶</td></tr><tr><td><strong>SIMD æ”¯æŒ</strong></td><td>æ— </td><td><strong>AMD64 ä¼˜åŒ–</strong> â­</td></tr><tr><td><strong>å†…å­˜å¸ƒå±€</strong></td><td>åˆ†ç¦» keys/values</td><td>äº¤é”™ key-value</td></tr></tbody></table><p><strong>Swiss çš„ä¼˜åŠ¿</strong>ï¼š 1. âœ… å¹¶è¡ŒåŒ¹é…ï¼šä¸€æ¬¡æ£€æŸ¥ 8 ä¸ªæ§½ä½ 2.âœ… SIMD åŠ é€Ÿï¼šç¡¬ä»¶çº§ä¼˜åŒ– 3. âœ… ç»†ç²’åº¦æ‰©å®¹ï¼šå•è¡¨é™åˆ¶æ§åˆ¶å»¶è¿Ÿ 4. âœ…æ›´é«˜è´Ÿè½½å› å­ï¼šç©ºé—´åˆ©ç”¨ç‡æå‡</p><p><strong>Swiss çš„åŠ£åŠ¿</strong>ï¼š 1. âŒ å¢“ç¢‘ç®¡ç†ï¼šéœ€è¦å®šæœŸæ¸…ç† 2. âŒå®ç°å¤æ‚ï¼šä½è¿ç®— + SIMD å†…è” 3. âŒ ç›®å½•å¼€é”€ï¼šå¤§ map éœ€è¦é¢å¤–ç›®å½•</p><h2 id="å…­ä»æºå¤´ç†è§£-swiss-table-ç‰ˆæœ¬">å…­ã€ä»æºå¤´ç†è§£ Swiss Tableç‰ˆæœ¬</h2><p>swiss table ç‰ˆæœ¬çš„ mapå®ç°å¯¹ç¬”è€…æ¥è¯´è¿˜æ˜¯æ¯”è¾ƒæ–°å¥‡çš„ï¼Œæˆ‘ä¸€å¼€å§‹ä¸€ç›´æ— æ³•å½»åº•è¿™ç§è¿™ç§å®ç°æ€è·¯ã€‚å› ä¸ºå®ƒçš„æ ¸å¿ƒæ€æƒ³ç¡®å®ä¸æˆ‘ä»¬æ•™ç§‘ä¹¦ä¸Šå¸¸è§çš„æ‹‰é“¾æ³•ï¼ˆChainingï¼‰æˆ–çº¿æ€§æ¢æµ‹æ³•ï¼ˆLinearProbingï¼‰æœ‰å¾ˆå¤§ä¸åŒã€‚å¥½åœ¨ç°åœ¨æœ‰ LLMï¼Œæ‰€ä»¥ç¬”è€…è·Ÿ Geminiè¿›è¡Œäº†ä¸€ç•ªæ¢è®¨ï¼Œæ‰å¯¹ swiss table çš„åº•å±‚åŸç†æœ‰äº†æ›´æ·±çš„ç†è§£ã€‚</p><h3 id="ä¼ ç»Ÿ-hashmap-çš„é—®é¢˜">1. ä¼ ç»Ÿ HashMap çš„é—®é¢˜</h3><p>è¦ä»æ ¹æœ¬ä¸Šç†è§£ swiss table ç‰ˆæœ¬çš„HashMapï¼Œæˆ‘ä»¬å¿…é¡»å›å½’åˆ°<strong>ç¬¬ä¸€æ€§åŸç†</strong>ï¼šHashMap çš„ç›®æ ‡æ˜¯åœ¨O(1) çš„æ—¶é—´å¤æ‚åº¦å†…å®Œæˆæ’å…¥ã€æŸ¥æ‰¾å’Œåˆ é™¤ã€‚è€Œè¿™ä¸ª <code>1</code> åœ¨ç°ä»£CPU é¢å‰ï¼Œå…¶å«é‡‘é‡æ˜¯å®Œå…¨ä¸åŒçš„ã€‚</p><blockquote><p>[!IMPORTANT]</p><p>ç°ä»£ CPU çš„ç¬¬ä¸€æ€§åŸç†ï¼šç¼“å­˜ä¸ºç‹ (Cache is King)</p></blockquote><p>æˆ‘ä»¬å¸¸è¯´çš„ O(1) ç†è®ºä¸Šå‡è®¾å†…å­˜è®¿é—®æ˜¯ç­‰ä»·çš„ã€‚ä½†åœ¨ç°å®ä¸­ï¼š</p><ul><li><strong>CPU è®¿é—® L1 ç¼“å­˜</strong>ï¼š~1-2 çº³ç§’</li><li><strong>CPU è®¿é—® L2 ç¼“å­˜</strong>ï¼š~5-10 çº³ç§’</li><li><strong>CPU è®¿é—® L3 ç¼“å­˜</strong>ï¼š~30-50 çº³ç§’</li><li><strong>CPU è®¿é—®ä¸»å†…å­˜ (RAM)</strong>ï¼š~100-200 çº³ç§’</li></ul><p>ä¸€ä¸ª Cache Miss å¹¶ä»ä¸»å†…å­˜è¯»å–æ•°æ®çš„ä»£ä»·ï¼Œå¯èƒ½æ˜¯è®¿é—® L1 ç¼“å­˜çš„ 100å€ä»¥ä¸Šã€‚</p><p>ä¼ ç»Ÿçš„ HashMap æ˜¯ä¸€ä¸ª"æ•°ç»„ + é“¾è¡¨"çš„ç»“æ„ã€‚<code>hash(key)</code>ç®—å‡ºä¸€ä¸ªæ•°ç»„ä¸‹æ ‡ï¼ˆæ¡¶ B[i]ï¼‰ã€‚å¦‚æœå†²çªäº†ï¼Œå°±æŠŠè¿™ä¸ª (key, value) æŒ‚åœ¨<code>B[i]</code> åé¢çš„é“¾è¡¨ä¸Šã€‚è¿™å­˜åœ¨ 2 ä¸ªé—®é¢˜ï¼š</p><ul><li><strong>ç¼“å­˜æä¸å‹å¥½ï¼š</strong>é“¾è¡¨çš„èŠ‚ç‚¹åœ¨å†…å­˜ä¸­æ˜¯<strong>ç¦»æ•£åˆ†å¸ƒ</strong>çš„ã€‚å½“ä½ éå†ä¸€ä¸ªé•¿é“¾è¡¨æ¥æŸ¥æ‰¾key æ—¶ï¼Œæ¯è®¿é—®ä¸€ä¸ªèŠ‚ç‚¹ï¼Œéƒ½ææœ‰å¯èƒ½å¯¼è‡´ä¸€æ¬¡ <strong>CacheMiss</strong>ï¼ˆè¿™è¢«ç§°ä¸ºæŒ‡é’ˆè¿½é€ pointer chasingï¼‰ã€‚</li><li><strong>å…ƒæ•°æ®å¼€é”€ï¼š</strong>æ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦ä¸€ä¸ªé¢å¤–çš„æŒ‡é’ˆæ¥æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¿™åœ¨ 64 ä½ç³»ç»Ÿä¸Šå°±æ˜¯ 8ä¸ªå­—èŠ‚ã€‚å¦‚æœä½ çš„ (key, value) æœ¬èº«å¾ˆå°ï¼ˆæ¯”å¦‚<code>map[int]int</code>ï¼‰ï¼Œè¿™ä¸ªæŒ‡é’ˆçš„å¼€é”€å°±éå¸¸å·¨å¤§ã€‚</li></ul><p>æ‰€ä»¥ï¼šä¼ ç»Ÿæ‹‰é“¾æ³•çš„ä¸»è¦ç“¶é¢ˆä¸åœ¨äº CPUè®¡ç®—ï¼Œè€Œåœ¨äº<strong>å†…å­˜è®¿é—®å»¶è¿Ÿ</strong>ã€‚</p><h3 id="swiss-table-çš„åˆ›æ–°">2. Swiss Table çš„åˆ›æ–°</h3><p>Swiss Tableçš„æ ¸å¿ƒæ€æƒ³æ˜¯<strong>ç”¨å¯†é›†çš„è®¡ç®—æ¢å–ç¨€ç–çš„å†…å­˜è®¿é—®</strong>ã€‚å®ƒå±äºå¼€æ”¾å¯»å€æ³•ï¼ˆOpenAddressingï¼‰çš„ä¸€ç§ï¼Œä½†åˆåšå‡ºäº†é©å‘½æ€§çš„ä¼˜åŒ–ã€‚å®ƒåŒæ—¶è§£å†³äº†ä¸¤ä¸ªå±‚é¢çš„æ ¸å¿ƒé—®é¢˜ï¼š</p><ol type="1"><li><strong>å¾®è§‚é—®é¢˜ (Group å†…)ï¼š</strong> å¦‚ä½•åœ¨ 8 ä¸ªæ§½ä½ (slot)ä¸­<strong>ä¸€æ¬¡æ€§</strong>æ‰¾åˆ°ç›®æ ‡ï¼Ÿï¼ˆè§£å†³ CPU è¿ç®—å’Œ L1 ç¼“å­˜æ•ˆç‡ï¼‰</li><li><strong>å®è§‚é—®é¢˜ (Map çº§)ï¼š</strong> å¦‚ä½•åœ¨ mapå˜å¾—å·¨å¤§æ—¶ï¼Œå®ç°<strong>ä½å»¶è¿Ÿ</strong>çš„æ‰©å®¹ï¼Ÿï¼ˆè§£å†³å†…å­˜è®¿é—®å’Œå»¶è¿ŸæŠ–åŠ¨ï¼‰</li></ol><p>åœ¨æˆ‘çœ‹æ¥ï¼ŒSwiss Table æœ‰ 3 ç‚¹æœ€é‡è¦çš„æ ¸å¿ƒåˆ›æ–°ï¼š</p><h4 id="æ ¸å¿ƒåˆ›æ–°ä¸€æ§åˆ¶å­—-ctrls-ä¸å¹¶è¡ŒåŒ¹é…">2.1 æ ¸å¿ƒåˆ›æ–°ä¸€ï¼šæ§åˆ¶å­—(ctrls) ä¸å¹¶è¡ŒåŒ¹é…</h4><p>è¿™æ˜¯ Swiss Map å¯¹ç¼“å­˜ä¸ºç‹çš„æè‡´åº”ç”¨ã€‚</p><ul><li><p><strong>ç¬¬ä¸€æ€§åŸç†ï¼š</strong> CPU è®¿é—® 8 ä¸ªå®Œæ•´çš„<code>key</code> æ¥æ¯”è¾ƒï¼Œå³ä½¿å®ƒä»¬éƒ½åœ¨ L1 ç¼“å­˜ä¸­ï¼Œä¹Ÿæ˜¯æ˜‚è´µçš„ï¼ˆå› ä¸º<code>key</code> å¯èƒ½å¾ˆå¤§ï¼‰ã€‚æœ€å¿«çš„æ–¹å¼æ˜¯ï¼Œå…ˆç”¨å…ƒæ•°æ®è¿‡æ»¤æ‰ 99%çš„æ— æ•ˆæ¯”è¾ƒã€‚</p></li><li><p><strong>ç†è®ºï¼š</strong></p><ol type="1"><li><strong>æ•°æ®ç»“æ„ï¼š</strong> <code>group</code> ç»“æ„åŒ…å«ä¸€ä¸ª<strong>8 å­—èŠ‚çš„ <code>ctrls</code> æ§åˆ¶å­—</strong> å’Œ 8 ä¸ª<code>slots</code> (key/elem å¯¹)ã€‚</li><li><strong>å“ˆå¸Œåˆ†å‰²ï¼š</strong> 64 ä½å“ˆå¸Œè¢«åˆ†ä¸º H1ï¼ˆé«˜ 57ä½ï¼Œç”¨äºå®šä½ï¼‰å’Œ <strong>H2ï¼ˆä½ 7 ä½ï¼Œç”¨äºåŒ¹é…ï¼‰</strong>ã€‚</li><li><strong>æ§åˆ¶å­—ç¼–ç ï¼š</strong> è¿™ 8 å­—èŠ‚çš„ <code>ctrls</code>ä¸­ï¼Œæ¯ä¸ªå­—èŠ‚ä»£è¡¨ä¸€ä¸ªæ§½ä½ (slot) çš„çŠ¶æ€ã€‚<ul><li><code>0x80</code> (1000 0000) = <code>empty</code>ï¼ˆç©ºï¼‰</li><li><code>0xFE</code> (1111 1110) = <code>deleted</code>ï¼ˆå¢“ç¢‘ï¼‰</li><li><code>0x00-0x7F</code> (0xxx xxxx) =<code>full</code>ï¼ˆå·²å ç”¨ï¼‰</li></ul></li><li><strong>å…³é”®è®¾è®¡ï¼š</strong> å½“æ§½ä½ä¸º <code>full</code> æ—¶ï¼Œå®ƒçš„ 7 ä¸ª<code>x</code> ä½å­˜å‚¨çš„<strong>æ­£æ˜¯ H2 çš„ 7 ä½å“ˆå¸Œå€¼</strong>ã€‚</li></ol></li><li><p><strong>å®è·µï¼ˆå¹¶è¡ŒåŒ¹é…çš„é­”åŠ›ï¼‰ï¼š</strong>å½“æˆ‘ä»¬è¦æŸ¥æ‰¾ä¸€ä¸ª keyï¼ˆå…¶H2 å€¼ä¸º target_h2ï¼‰æ—¶ï¼Œæˆ‘ä»¬ä¸å†éœ€è¦ for å¾ªç¯ 8 æ¬¡ã€‚Go (Abseil)ä½¿ç”¨äº†ä¸€ç§ä½è¿ç®—çš„é­”æ³•ï¼š<code>ctrlGroup.matchH2(target_h2)</code>ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">v := <span class="type">uint64</span>(g) ^ (<span class="number">0x0101010101010101</span> * <span class="type">uint64</span>(h))</span><br><span class="line">result := (v - <span class="number">0x0101010101010101</span>) &amp;^ v</span><br><span class="line">matches := bitset(result &amp; <span class="number">0x8080808080808080</span>)</span><br></pre></td></tr></table></figure><p>è¿™ä¸€ç³»åˆ—æ“ä½œï¼ˆåœ¨ AMD64 ä¸Šç”šè‡³å¯ä»¥ç”¨ <strong>SIMD æŒ‡ä»¤</strong><code>PCMPEQB</code> åŠ é€Ÿï¼‰çš„<strong>å”¯ä¸€ç›®çš„</strong>æ˜¯ï¼š</p><blockquote><p><strong>ç”¨ 1-2 ä¸ª CPU æŒ‡ä»¤ï¼ŒåŒæ—¶å°† 8 ä¸ªæ§½ä½çš„ H2 å€¼ä¸<code>target_h2</code> è¿›è¡Œæ¯”è¾ƒ</strong>ï¼Œå¹¶è¿”å›ä¸€ä¸ª<code>bitset</code>ã€‚</p></blockquote><p>è¿™ä¸ª <code>bitset</code> (ä¾‹å¦‚ <code>0b00100100</code>)ä¼šç¬é—´å‘Šè¯‰æˆ‘ä»¬ï¼š"ç¬¬ 2 å·å’Œç¬¬ 5 å·æ§½ä½çš„ H2 åŒ¹é…äº†ï¼Œè¯·åªæ£€æŸ¥å®ƒä»¬ä¿©çš„å®Œæ•´<code>key</code>"ã€‚è¿™ä½¿å¾—æŸ¥æ‰¾ 8 ä¸ªæ§½ä½çš„å¼€é”€ï¼Œä» <strong>O(8)æ¬¡æ¯”è¾ƒ</strong> é™ä½åˆ°äº† <strong>O(1) æ¬¡å¹¶è¡Œæ¯”è¾ƒ</strong>ã€‚</p></li></ul><h4 id="æ ¸å¿ƒåˆ›æ–°äºŒå¼€æ”¾å¯»å€ä¸äºŒæ¬¡æ¢æµ‹">2.2æ ¸å¿ƒåˆ›æ–°äºŒï¼šå¼€æ”¾å¯»å€ä¸äºŒæ¬¡æ¢æµ‹</h4><p>è¿™æ˜¯ Swiss Mapè§£å†³å“ˆå¸Œå†²çªçš„æ–¹å¼ï¼Œä¹Ÿæ˜¯å®ƒä¼˜äºä¼ ç»Ÿæ‹‰é“¾æ³•çš„ç¬¬äºŒä¸ªå…³é”®ç‚¹ã€‚</p><ul><li><strong>ç¬¬ä¸€æ€§åŸç†ï¼š</strong> æ‹‰é“¾æ³•çš„ <code>overflow</code>é“¾è¡¨èŠ‚ç‚¹åœ¨å†…å­˜ä¸­æ˜¯<strong>ç¦»æ•£</strong>çš„ï¼Œéå†é“¾è¡¨ä¼šå¯¼è‡´å¤§é‡çš„æŒ‡é’ˆè¿½é€(pointer chasing)ï¼Œå¼•å‘<strong>ç¾éš¾æ€§çš„ Cache Miss</strong>ã€‚</li><li><strong>ç†è®ºï¼ˆå¼€æ”¾å¯»å€ï¼‰ï¼š</strong>Swiss Mapè§„å®šï¼Œæ‰€æœ‰æ•°æ®éƒ½å¿…é¡»å­˜å‚¨åœ¨è¿ç»­çš„ group æ•°ç»„ä¸­ã€‚å¦‚æœ<code>hash(key)</code> ç®—å‡ºçš„ä¸» group æ»¡äº†ï¼Œå®ƒä¸ä¼šæŒ‚ä¸€ä¸ªé“¾è¡¨ã€‚</li><li><strong>å®è·µï¼ˆäºŒæ¬¡æ¢æµ‹ï¼‰ï¼š</strong><ol type="1"><li>å¦‚æœä¸» <code>group</code> æ»¡äº†ï¼ˆæˆ–è€… H2æ²¡åŒ¹é…ä¸Šï¼Œä¸”æ²¡æœ‰ç©ºæ§½ï¼‰ï¼Œæˆ‘ä»¬æ€ä¹ˆåŠï¼Ÿ</li><li>æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªäºŒæ¬¡æ¢æµ‹ (Quadratic Probing) å…¬å¼ï¼š<code>p(i) = (iÂ² + i)/2 + hash (mod ç»„æ•°)</code>ï¼Œè®¡ç®—<strong>ä¸‹ä¸€ä¸ª</strong>è¦æ¢æµ‹çš„<code>group</code> çš„ç´¢å¼•ã€‚</li><li>è¿™ä¸ªå…¬å¼çš„é‡ç‚¹åœ¨äºå®ƒ<strong>å¯é¢„æµ‹ã€æ— æŒ‡é’ˆã€è®¡ç®—å¿«</strong>ï¼Œå¹¶ä¸”èƒ½ä¿è¯ï¼ˆåœ¨2 çš„å¹‚å®¹é‡ä¸‹ï¼‰éå†æ‰€æœ‰ <code>group</code>ã€‚</li><li><strong>æ ¹æœ¬æ”¶ç›Šï¼š</strong> æˆ‘ä»¬ç”¨ <strong>CPUè®¡ç®—ï¼ˆä¸‹ä¸€ä¸ªç´¢å¼•ï¼‰</strong> ä»£æ›¿äº†<strong>å†…å­˜è®¿é—®ï¼ˆæŒ‡é’ˆè·³è½¬ï¼‰</strong>ã€‚ç”±äº <code>group</code>æ•°ç»„æ˜¯è¿ç»­å†…å­˜ï¼Œä¸‹ä¸€ä¸ª <code>group</code> ææœ‰å¯èƒ½ä¹Ÿå·²åœ¨ CPUç¼“å­˜ä¸­ï¼Œè®¿é—®æå¿«ã€‚</li></ol></li><li><strong>å¸¦æ¥çš„é—®é¢˜ï¼ˆå¢“ç¢‘æœºåˆ¶ï¼‰ï¼š</strong>è¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆéœ€è¦<code>deleted (0xFE)</code>çŠ¶æ€ã€‚å¦‚æ–‡æ¡£æ‰€è¯´ï¼Œå¦‚æœä½ åˆ é™¤äº†æ¢æµ‹é“¾ä¸­é—´çš„ä¸€ä¸ªå…ƒç´ å¹¶å°†å…¶æ ‡è®°ä¸º<code>empty (0x80)</code>ï¼Œé‚£ä¹ˆæŸ¥æ‰¾å®ƒåé¢çš„å…ƒç´ æ—¶ï¼Œæ¢æµ‹é“¾ä¼šåœ¨è¿™é‡Œé”™è¯¯åœ°ç»ˆæ­¢ã€‚å› æ­¤ï¼Œåˆ é™¤æ—¶å¿…é¡»ç•™ä¸‹å¢“ç¢‘(tombstone)ï¼Œå‘Šè¯‰æŸ¥æ‰¾æ“ä½œï¼š"è¿™é‡Œæ›¾ç»æœ‰è¿‡äººï¼Œè¯·ç»§ç»­å¾€åæ‰¾"ã€‚</li></ul><h4 id="æ ¸å¿ƒåˆ›æ–°ä¸‰å¯æ‰©å±•å“ˆå¸Œä¸è¡¨åˆ†è£‚">2.3æ ¸å¿ƒåˆ›æ–°ä¸‰ï¼šå¯æ‰©å±•å“ˆå¸Œä¸è¡¨åˆ†è£‚</h4><p>è¿™æ˜¯ Swiss Map è§£å†³å®è§‚æ‰©å®¹é—®é¢˜çš„ç²¾å¦™ä¹‹ä¸¾ã€‚</p><ul><li><strong>ç¬¬ä¸€æ€§åŸç†ï¼š</strong> ä¼ ç»Ÿ map æ‰©å®¹æ—¶ï¼Œéœ€è¦åˆ†é…ä¸€ä¸ª 2å€å¤§çš„æ–°æ•°ç»„ï¼Œå¹¶æŠŠ<strong>æ‰€æœ‰</strong>å…ƒç´  rehash è¿‡å»ã€‚å¦‚æœ map æœ‰ 1äº¿ä¸ªå…ƒç´ ï¼Œè¿™ä¸ªå»¶è¿Ÿæ˜¯ä¸å¯æ¥å—çš„ã€‚</li><li><strong>ç†è®ºï¼ˆå¯æ‰©å±•å“ˆå¸Œï¼‰ï¼š</strong>Go çš„ Swiss Mapå¹¶æ²¡æœ‰ä¸€ä¸ªæ— é™å¤§çš„ group æ•°ç»„ã€‚å®ƒå¼•å…¥äº†ç›®å½• (Directory) ç»“æ„ã€‚<ol type="1"><li>é¡¶å±‚ <code>Map</code> ç»“æ„æœ‰ä¸€ä¸ª <code>dirPtr</code> å’Œ<code>dirLen</code>ã€‚</li><li><code>dirPtr</code> æŒ‡å‘ä¸€ä¸ª <code>[dirLen]*table</code>æŒ‡é’ˆæ•°ç»„ã€‚</li><li>æ¯ä¸ª <code>table</code> æ‰æ˜¯çœŸæ­£å­˜å‚¨ <code>group</code>çš„åœ°æ–¹ï¼Œä½†<strong>æ¯ä¸ª <code>table</code> çš„å®¹é‡æ˜¯å—é™çš„</strong>ï¼ˆä¾‹å¦‚1024 ä¸ªæ§½ä½ï¼‰ã€‚</li></ol></li><li><strong>å®è·µï¼ˆå¢é‡æ‰©å®¹ä¸è¡¨åˆ†è£‚ï¼‰ï¼š</strong><ol type="1"><li><strong>æŸ¥æ‰¾ï¼š</strong> <code>hash(key)</code> çš„é«˜ä½ï¼ˆç”±<code>globalDepth</code> å†³å®šï¼‰ç”¨äºåœ¨ <code>directory</code>ä¸­<strong>é€‰æ‹©ä½¿ç”¨å“ªä¸ª<code>table</code></strong>ã€‚<code>hash(key)</code> çš„ä½ä½ï¼ˆH1ï¼‰ç”¨äºåœ¨è¯¥<code>table</code> å†…è¿›è¡Œâ€œäºŒæ¬¡æ¢æµ‹â€ã€‚</li><li><strong>æ‰©å®¹ï¼ˆå…³é”®ï¼‰ï¼š</strong> å½“ä¸€ä¸ª <code>table</code>è´Ÿè½½è¿‡é«˜ï¼ˆä¾‹å¦‚ &gt; 7/8ï¼‰ ä¸”å·²è¾¾åˆ° 1024æ§½ä½çš„ä¸Šé™æ—¶ï¼Œæˆ‘ä»¬<strong>ä¸å†æ‰©å®¹æ•´ä¸ª map</strong>ã€‚</li><li>æˆ‘ä»¬åª<strong>åˆ†è£‚è¿™ä¸€ä¸ª <code>table</code></strong>ã€‚å¦‚<code>Table1</code> (localDepth=1) åˆ†è£‚ä¸º <code>Table1a</code> å’Œ<code>Table1b</code> (localDepth=2)ã€‚</li><li>ç„¶åï¼Œæˆ‘ä»¬å»æ›´æ–° <code>directory</code> ä¸­çš„æŒ‡é’ˆã€‚å¦‚æœ<code>directory</code>ä¸å¤Ÿå¤§ï¼ˆ<code>globalDepth &lt; new_localDepth</code>ï¼‰ï¼Œæˆ‘ä»¬å°±<strong>åªæ‰©å®¹<code>directory</code></strong>ï¼ˆè¿™å¾ˆå¿«ï¼Œå› ä¸ºå®ƒåªå­˜æŒ‡é’ˆï¼‰ã€‚</li><li><strong>æ ¹æœ¬æ”¶ç›Šï¼š</strong>æ‰©å®¹çš„å¼€é”€è¢«<strong>å‡æ‘Š</strong>äº†ã€‚å»¶è¿Ÿæ˜¯å¯æ§çš„ï¼Œå› ä¸ºæˆ‘ä»¬<strong>ä¸€æ¬¡æœ€å¤šåªè¿ç§»1024 ä¸ªå…ƒç´ </strong>ï¼Œè€Œä¸æ˜¯ 1 äº¿ä¸ªã€‚</li></ol></li></ul><h4 id="æ€»ç»“">2.4 æ€»ç»“</h4><p>æ€»çš„æ¥è¯´ï¼ŒGo Swiss Table æ˜¯ä¸‰ç§å…ˆè¿›æŠ€æœ¯çš„å®Œç¾ç»“åˆï¼š</p><ol type="1"><li><strong>å¾®è§‚ (Group å†…)ï¼š</strong> <strong>å¹¶è¡ŒåŒ¹é…</strong>ï¼ˆåŸºäºSIMD/ä½è¿ç®—ï¼‰ï¼Œå®ç° O(1) çš„ 8 æ§½ä½åŒ¹é…ã€‚</li><li><strong>ä¸­è§‚ (Table å†…)ï¼š</strong><strong>äºŒæ¬¡æ¢æµ‹</strong>ï¼ˆå¼€æ”¾å¯»å€ï¼‰ï¼Œå®ç°æ— æŒ‡é’ˆã€ç¼“å­˜å‹å¥½çš„å†²çªè§£å†³ã€‚</li><li><strong>å®è§‚ (Map çº§)ï¼š</strong><strong>å¯æ‰©å±•å“ˆå¸Œ</strong>ï¼ˆç›®å½•+è¡¨åˆ†è£‚ï¼‰ï¼Œå®ç°ä½å»¶è¿Ÿã€å¢é‡å¼çš„æ‰©å®¹ã€‚</li></ol><p>è¿™å¥—ç»„åˆæ‹³ï¼Œä» L1 ç¼“å­˜ã€CPUæŒ‡ä»¤é›†ï¼Œä¸€ç›´ä¼˜åŒ–åˆ°å…¨å±€å†…å­˜å¸ƒå±€å’Œå»¶è¿Ÿæ§åˆ¶ï¼Œæ˜¯ç°ä»£é«˜æ€§èƒ½ Hash Mapçš„å…¸èŒƒä¹‹ä½œã€‚</p><h3 id="swiss-table-çš„æ¼”è¿›çŒœæƒ³">3. Swiss Table çš„æ¼”è¿›çŒœæƒ³</h3><p>ç†è§£äº†æ˜¯ä»€ä¹ˆï¼ˆWhatï¼‰ä¹‹åï¼Œè¿½é—®ä¸ºä»€ä¹ˆï¼ˆWhyï¼‰å’Œå¦‚ä½•æ¼”è¿›ï¼ˆHowï¼‰æ˜¯æŒæ¡ä¸€ä¸ªå¤æ‚ç³»ç»Ÿæœ€æ ¹æœ¬çš„æ–¹æ³•ã€‚æœ¬å°èŠ‚æˆ‘ä»¬å°è¯•åƒä¸€ä¸ªç³»ç»Ÿè®¾è®¡å¸ˆä¸€æ ·ï¼Œä»é›¶å¼€å§‹æ¨æ¼”Go Swiss Table çš„å®ç°è¿‡ç¨‹ã€‚</p><h4 id="ç¬¬-0-æ­¥æ˜ç¡®ç›®æ ‡ä¸æ ¸å¿ƒçŸ›ç›¾">3.1 ç¬¬ 0 æ­¥ï¼šæ˜ç¡®ç›®æ ‡ä¸æ ¸å¿ƒçŸ›ç›¾</h4><ul><li><strong>åˆå§‹çŠ¶æ€ï¼š</strong> æ‹‰é“¾æ³•ã€‚</li><li><strong>è¦è§£å†³çš„æ ¸å¿ƒçŸ›ç›¾ï¼ˆç¬¬ä¸€æ€§åŸç†ï¼‰ï¼š</strong><ol type="1"><li><strong>æ€§èƒ½ç“¶é¢ˆï¼š</strong> ä¼ ç»Ÿ map çš„æ€§èƒ½ç“¶é¢ˆ<strong>ä¸åœ¨ CPUè®¡ç®—ï¼Œè€Œåœ¨å†…å­˜è®¿é—®</strong>ã€‚</li><li><strong>ç¼“å­˜å¤±æ•ˆ (Cache Miss)ï¼š</strong>æ‹‰é“¾æ³•çš„æº¢å‡ºæ¡¶é“¾è¡¨åœ¨å†…å­˜ä¸­æ˜¯<strong>ç¦»æ•£</strong>çš„ï¼Œéå†å®ƒä¼šå¯¼è‡´å¤§é‡çš„æŒ‡é’ˆè¿½é€ï¼Œæ¯ä¸€æ¬¡è·³è½¬éƒ½å¯èƒ½æ˜¯ä¸€æ¬¡æ˜‚è´µçš„Cache Missï¼ˆè®¿é—®ä¸»å†…å­˜ï¼‰ã€‚</li><li><strong>å»¶è¿ŸæŠ–åŠ¨ï¼š</strong> ä¼ ç»Ÿ mapæ‰©å®¹æ—¶ï¼Œéœ€è¦ä¸€æ¬¡æ€§è¿ç§»æ‰€æœ‰æ•°æ®ï¼Œå¯¼è‡´æœåŠ¡ï¼ˆSTWï¼‰çš„å»¶è¿Ÿæ¯›åˆºã€‚</li></ol></li><li><strong>æ–° map çš„ç›®æ ‡ï¼š</strong><ol type="1"><li><strong>ç¼“å­˜å‹å¥½ï¼š</strong> å¿…é¡»ç”¨è¿ç»­å†…å­˜å¸ƒå±€ï¼Œæ¶ˆé™¤æŒ‡é’ˆè¿½é€ã€‚</li><li><strong>ä½å»¶è¿Ÿï¼š</strong> å¿…é¡»å®ç°å¢é‡å¼æ‰©å®¹ï¼Œå¹³æ»‘å»¶è¿Ÿã€‚</li><li><strong>é«˜ååï¼š</strong> æŸ¥æ‰¾ã€æ’å…¥ã€åˆ é™¤æ“ä½œè¦å°½å¯èƒ½å¿«ã€‚</li></ol></li></ul><h4 id="ç¬¬-1-æ­¥ä»æ‹‰é“¾åˆ°å¼€æ”¾å¯»å€">3.2 ç¬¬ 1 æ­¥ï¼šä»æ‹‰é“¾åˆ°å¼€æ”¾å¯»å€</h4><p><strong>ä¸ºäº†å®ç°ç›®æ ‡ 1ï¼ˆç¼“å­˜å‹å¥½ï¼‰ï¼š</strong></p><ul><li><strong>è®¾è®¡å¸ˆçš„å†³ç­–ï¼š</strong>æŠ›å¼ƒæ‹‰é“¾æ³•ï¼Œå…¨é¢è½¬å‘<strong>å¼€æ”¾å¯»å€æ³•</strong> (Open Addressing)ã€‚</li><li><strong>ä¸ºä»€ä¹ˆï¼Ÿ</strong> å¼€æ”¾å¯»å€æ³•å°†æ‰€æœ‰ (key, value)å­˜å‚¨åœ¨ä¸€ä¸ª<strong>è¿ç»­çš„æ•°ç»„</strong>ä¸­ã€‚</li><li><strong>å¸¦æ¥çš„æ–°é—®é¢˜ï¼š</strong><ol type="1"><li><strong>å†²çªè§£å†³ï¼š</strong>å¦‚ä½•å¤„ç†å“ˆå¸Œå†²çªï¼Ÿï¼ˆæ‹‰é“¾æ³•ç”¨é“¾è¡¨ï¼Œç°åœ¨æ²¡é“¾è¡¨äº†ï¼‰</li><li><strong>æŸ¥æ‰¾æ•ˆç‡ï¼š</strong> å¦‚ä½•åœ¨è¿ç»­æ•°ç»„ä¸­å¿«é€Ÿæ‰¾åˆ°ç›®æ ‡ï¼Ÿ</li><li><strong>åˆ é™¤ï¼š</strong>æ‹‰é“¾æ³•åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹å¾ˆç®€å•ï¼Œå¼€æ”¾å¯»å€æ³•åˆ é™¤äº†ä¸€ä¸ªå…ƒç´ ï¼Œä¼šä¸ä¼šä¸­æ–­æ¢æµ‹é“¾ï¼Ÿ</li></ol></li></ul><h4 id="ç¬¬-2-æ­¥è§£å†³å†²çªä¸æŸ¥æ‰¾æ•ˆç‡">3.3 ç¬¬ 2 æ­¥ï¼šè§£å†³å†²çªä¸æŸ¥æ‰¾æ•ˆç‡</h4><p><strong>ä¸ºäº†è§£å†³ç¬¬ 1 æ­¥çš„æ–°é—®é¢˜ï¼ˆå†²çªä¸æŸ¥æ‰¾ï¼‰ï¼š</strong></p><ul><li><strong>å†³ç­– 1 - å†²çªè§£å†³ï¼š</strong> é‡‡ç”¨<strong>äºŒæ¬¡æ¢æµ‹</strong>(Quadratic Probing)ã€‚<ul><li><em>ä¸ºä»€ä¹ˆä¸ç”¨çº¿æ€§æ¢æµ‹ï¼Ÿ</em>çº¿æ€§æ¢æµ‹ï¼ˆ<code>hash + i</code>ï¼‰ä¼šå¯¼è‡´ä¸¥é‡çš„èšé›†ã€‚</li><li><em>ä¸ºä»€ä¹ˆç”¨äºŒæ¬¡æ¢æµ‹ï¼Ÿ</em> <code>p(i) = (iÂ² + i)/2 + hash</code>å…¬å¼èƒ½è·³è·ƒå¼åˆ†å¸ƒï¼Œå‡å°‘èšé›†ï¼Œä¸”è®¡ç®—å¼€é”€å°ã€‚</li></ul></li><li><strong>å†³ç­– 2 - æŸ¥æ‰¾æ•ˆç‡ï¼ˆSwiss Table çš„æ ¸å¿ƒï¼ï¼‰ï¼š</strong><ul><li><em>å¼€æ”¾å¯»å€çš„ç—›ç‚¹ï¼š</em> æ¢æµ‹ <code>i</code> ä½ç½®æ—¶ï¼Œå¿…é¡»æ¯”è¾ƒ<code>key == target_key</code>ã€‚å¦‚æœ <code>key</code>æ˜¯ä¸ªå¾ˆé•¿çš„å­—ç¬¦ä¸²ï¼Œè¿™ä¸ªæ¯”è¾ƒæœ¬èº«å°±éå¸¸æ˜‚è´µã€‚</li><li><strong>æ€è·¯ï¼š</strong> æˆ‘ä»¬èƒ½ä¸èƒ½<strong>å…ˆä¸è¿‡æ—©åœ°æ¯”è¾ƒå®Œæ•´çš„Key</strong>ï¼Ÿ</li><li><strong>è§£å†³æ–¹æ¡ˆï¼š</strong>å¼•å…¥å…ƒæ•°æ®ï¼å°†å“ˆå¸Œå€¼ä¸€åˆ†ä¸ºäºŒï¼š<strong>H1</strong>ï¼ˆç”¨äºæ¢æµ‹ï¼‰å’Œ<strong>H2</strong>ï¼ˆç”¨äºè¿‡æ»¤ï¼‰ã€‚</li><li><strong>æ¼”è¿›ï¼š</strong> æˆ‘ä»¬è®¾è®¡ä¸€ä¸ª<strong>æ§åˆ¶å­—</strong> (ControlWord) æ•°ç»„ï¼Œå®ƒä¸ <code>slots</code> æ•°ç»„å¹³è¡Œã€‚è¿™ä¸ª <code>ctrls</code>æ•°ç»„åªå­˜æ”¾ H2ï¼ˆä½ 7 ä½ï¼‰ã€‚</li><li><strong>æŸ¥æ‰¾æµç¨‹ä¼˜åŒ–ï¼š</strong><ol type="1"><li>ï¼ˆæ˜‚è´µï¼‰<code>for i... &#123; if array[i].key == my_key &#125;</code></li><li>ï¼ˆä¼˜åŒ–åï¼‰<code>for i... &#123; if ctrls[i] == H2 &#123; if array[i].key == my_key &#125; &#125;</code></li></ol></li><li><strong>æ”¶ç›Šï¼š</strong> 99% çš„æ¯”è¾ƒï¼Œéƒ½ä»æ˜‚è´µçš„ Key æ¯”è¾ƒå˜æˆäº†å»‰ä»·çš„1 å­—èŠ‚ H2 æ¯”è¾ƒã€‚</li></ul></li></ul><h4 id="ç¬¬-3-æ­¥å°†æŸ¥æ‰¾æ•ˆç‡æ¨å‘æè‡´">3.4 ç¬¬ 3 æ­¥ï¼šå°†æŸ¥æ‰¾æ•ˆç‡æ¨å‘æè‡´</h4><p><strong>ä¸ºäº†è§£å†³ç¬¬ 2 æ­¥çš„é—ç•™é—®é¢˜ï¼š</strong></p><ul><li><strong>æ–°ç—›ç‚¹ï¼š</strong> æŸ¥æ‰¾H2ï¼ˆ<code>ctrls[i] == H2</code>ï¼‰è™½ç„¶å»‰ä»·ï¼Œä½†æˆ‘ä»¬<strong>ä»ç„¶åœ¨<code>for</code> å¾ªç¯</strong>ï¼å¦‚æœä¸€ä¸ª <code>group</code> æœ‰ 8ä¸ªæ§½ä½ï¼Œæœ€åæƒ…å†µè¿˜æ˜¯è¦å¾ªç¯ 8 æ¬¡ã€‚</li><li><strong>è®¾è®¡å¸ˆçš„å†³ç­–ï¼š</strong> <strong>ä¸€æ¬¡æ€§æ¯”è¾ƒ 8ä¸ªæ§½ä½ï¼</strong></li><li><strong>ä¸ºä»€ä¹ˆï¼Ÿ</strong><ol type="1"><li>ç°ä»£ CPU æ‹¥æœ‰ <strong>SIMD</strong>ï¼ˆå•æŒ‡ä»¤å¤šæ•°æ®æµï¼‰æŒ‡ä»¤é›†ï¼ˆå¦‚ x86ä¸Šçš„ SSE2ï¼ŒARM ä¸Šçš„ NEONï¼‰ã€‚</li><li>CPU çš„ L1 ç¼“å­˜ä¸€æ¬¡åŠ è½½ 64 å­—èŠ‚ï¼ˆä¸€ä¸ª Cache Lineï¼‰ã€‚æˆ‘ä»¬ä¸€ä¸ª<code>group</code> é‡Œçš„ 8 å­—èŠ‚ <code>ctrls</code> å¿…å®šåœ¨åŒä¸€ä¸ª CacheLine é‡Œã€‚</li></ol></li><li><strong>è§£å†³æ–¹æ¡ˆï¼š</strong><ul><li>å°† 8 ä¸ª <code>ctrl</code> å­—èŠ‚è§†ä¸ºä¸€ä¸ª <code>uint64</code>ã€‚</li><li>ä½¿ç”¨ SIMD æŒ‡ä»¤ï¼ˆå¦‚<code>PCMPEQB</code>ï¼‰æˆ–ç­‰æ•ˆçš„ä½è¿ç®—ï¼Œ<strong>å¹¶è¡Œåœ°</strong>å°†è¿™ä¸ª<code>uint64</code> ä¸­çš„ 8 ä¸ªå­—èŠ‚ä¸æˆ‘ä»¬ç›®æ ‡çš„ H2 è¿›è¡Œæ¯”è¾ƒã€‚</li><li><strong>æ”¶ç›Šï¼š</strong> æŸ¥æ‰¾ <code>group</code> å†… 8ä¸ªæ§½ä½çš„å¤æ‚åº¦ï¼Œä» <strong>O(8)</strong>ï¼ˆä¸²è¡Œï¼‰ é™ä½åˆ°<strong>O(1)</strong>ï¼ˆå¹¶è¡Œï¼‰ã€‚</li></ul></li></ul><h4 id="ç¬¬-4-æ­¥è§£å†³åˆ é™¤çš„é—ç•™é—®é¢˜">3.5 ç¬¬ 4 æ­¥ï¼šè§£å†³åˆ é™¤çš„é—ç•™é—®é¢˜</h4><p><strong>ä¸ºäº†è§£å†³ç¬¬ 1 æ­¥ç•™ä¸‹çš„åˆ é™¤é—®é¢˜ï¼š</strong></p><ul><li><strong>ç—›ç‚¹ï¼š</strong> åœ¨ä¸€ä¸ªæ¢æµ‹é“¾ <code>A -&gt; B -&gt; C</code>ä¸­ï¼Œå¦‚æœåˆ é™¤äº† B å¹¶æ ‡è®°ä¸º <code>empty</code>ã€‚</li><li><strong>åæœï¼š</strong> æŸ¥æ‰¾ C æ—¶ï¼Œæ¢æµ‹åˆ° Aï¼Œä¸‹ä¸€ä¸ªæ˜¯<code>empty</code>ï¼Œ<strong>æŸ¥æ‰¾ä¼šæå‰ç»ˆæ­¢</strong>ï¼Œå¯¼è‡´ Cæ°¸è¿œæ‰¾ä¸åˆ°ã€‚</li><li><strong>è§£å†³æ–¹æ¡ˆï¼š</strong> å¼•å…¥<strong>å¢“ç¢‘</strong> (Tombstone)çŠ¶æ€ã€‚</li><li><strong>æ¼”è¿›ï¼š</strong> <code>ctrls</code> å­—èŠ‚ç°åœ¨å¿…é¡»æœ‰ 3 ç§çŠ¶æ€ï¼š<ol type="1"><li><code>empty</code> (0x80)ï¼šç©ºçš„ï¼Œæ¢æµ‹ç»ˆæ­¢ã€‚</li><li><code>deleted</code>(0xFE)ï¼šå¢“ç¢‘ï¼Œ<strong>æ’å…¥æ—¶å¯å¤ç”¨</strong>ï¼Œ<strong>æŸ¥æ‰¾æ—¶è¯·ç»§ç»­</strong>ã€‚</li><li><code>full</code> (0x00-0x7F)ï¼šæœ‰æ•°æ®ï¼ˆH2ï¼‰ã€‚</li></ol></li></ul><h4 id="ç¬¬-5-æ­¥è§£å†³æ‰©å®¹çš„å»¶è¿Ÿç›®æ ‡">3.6 ç¬¬ 5 æ­¥ï¼šè§£å†³æ‰©å®¹çš„å»¶è¿Ÿç›®æ ‡</h4><p><strong>ä¸ºäº†å®ç°ç›®æ ‡ 2ï¼ˆä½å»¶è¿Ÿï¼‰ï¼š</strong></p><ul><li><strong>ç—›ç‚¹ï¼š</strong> æˆ‘ä»¬çš„å¼€æ”¾å¯»å€è¡¨ï¼ˆ<code>group</code>æ•°ç»„ï¼‰å¦‚æœæ»¡äº†ï¼ˆä¾‹å¦‚è´Ÿè½½ &gt; 87.5%ï¼‰ï¼Œä¼ ç»Ÿçš„åšæ³•æ˜¯åˆ†é…ä¸€ä¸ª 2å€å¤§çš„æ–°è¡¨ï¼Œç„¶å rehash <strong>æ‰€æœ‰</strong>å…ƒç´ ã€‚</li><li><strong>åæœï¼š</strong> å¯¼è‡´å·¨å¤§çš„å»¶è¿Ÿæ¯›åˆºï¼Œè¿èƒŒäº†ç›®æ ‡ 2ã€‚</li><li><strong>è§£å†³æ–¹æ¡ˆï¼š</strong> <strong>å¯æ‰©å±•å“ˆå¸Œ</strong> (ExtensibleHashing)ã€‚</li><li><strong>æ¼”è¿›ï¼š</strong><ol type="1"><li>æˆ‘ä»¬ä¸ä½¿ç”¨ä¸€ä¸ªæ— é™å¤§çš„è¡¨ã€‚æˆ‘ä»¬å°†æ•°æ®æ‹†åˆ†åˆ°<strong>å¤šä¸ª</strong>ã€<strong>å›ºå®šå¤§å°</strong>ï¼ˆå¦‚1024 æ§½ä½ï¼‰çš„ <code>table</code> ä¸­ã€‚</li><li>æˆ‘ä»¬å¼•å…¥ä¸€ä¸ª<strong>ç›®å½•</strong> (Directory)ç»“æ„ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„ï¼ŒæŒ‡å‘è¿™äº› <code>table</code>ã€‚</li><li>ä½¿ç”¨å“ˆå¸Œçš„<strong>é«˜ä½</strong> (<code>globalDepth</code>)æ¥å†³å®šå»å“ªä¸ª <code>directory</code> æ§½ä½ï¼Œæ‰¾åˆ°å¯¹åº”çš„<code>table</code>ã€‚</li><li>ä½¿ç”¨å“ˆå¸Œçš„<strong>ä½ä½</strong> (H1) åœ¨ <code>table</code>å†…éƒ¨è¿›è¡ŒäºŒæ¬¡æ¢æµ‹ã€‚</li></ol></li><li><strong>æ”¶ç›Šï¼š</strong><ul><li>å½“ä¸€ä¸ª <code>table</code> æ»¡äº†ï¼Œæˆ‘ä»¬<strong>åªéœ€è¦åˆ†è£‚è¿™ä¸€ä¸ª<code>table</code></strong>ï¼</li><li>æ‰©å®¹çš„å¼€é”€è¢«<strong>å‡æ‘Š</strong>äº†ã€‚ä¸€æ¬¡è¿ç§»çš„å…ƒç´ ä¸Šé™æ˜¯1024ï¼Œè€Œä¸æ˜¯ Nï¼ˆN å¯èƒ½æ˜¯ 1 äº¿ï¼‰ã€‚è¿™å®Œç¾è§£å†³äº†å»¶è¿ŸæŠ–åŠ¨é—®é¢˜ã€‚</li></ul></li></ul><h4 id="ç¬¬-6-æ­¥é”¦ä¸Šæ·»èŠ±çš„ä¼˜åŒ–">3.7 ç¬¬ 6 æ­¥ï¼šé”¦ä¸Šæ·»èŠ±çš„ä¼˜åŒ–</h4><ul><li><strong>ç—›ç‚¹ï¼š</strong> å¦‚æœç”¨æˆ·åª <code>make(map[int]int)</code>å¹¶å­˜äº† 3 ä¸ªå…ƒç´ ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦åˆ†é… <code>directory</code> å’Œ<code>table</code> å—ï¼Ÿå¤ªæµªè´¹äº†ã€‚</li><li><strong>è§£å†³æ–¹æ¡ˆï¼š</strong> <strong>å° Map ä¼˜åŒ–</strong>ã€‚</li><li><strong>æ¼”è¿›ï¼š</strong><ul><li>å½“ <code>dirLen == 0</code> æ—¶ï¼Œ<code>dirPtr</code> ä¸æŒ‡å‘<code>directory</code>ï¼Œè€Œæ˜¯<strong>ç›´æ¥æŒ‡å‘å•ä¸ª<code>group</code></strong>ï¼ˆ8 ä¸ªæ§½ä½ï¼‰ã€‚</li><li><strong>æ”¶ç›Šï¼š</strong> å¯¹äºç»å¤§å¤šæ•°ï¼ˆ&lt; 8 ä¸ªå…ƒç´ ï¼‰çš„mapï¼Œå†…å­˜å¼€é”€æå°ï¼Œä¸”æ— éœ€ä»»ä½• <code>table</code> é—´æ¥å¯»å€ã€‚</li></ul></li></ul><h4 id="æ€»ç»“ä»-0-åˆ°-1-çš„æ¼”è¿›è·¯å¾„">3.8 æ€»ç»“ï¼šä» 0 åˆ° 1 çš„æ¼”è¿›è·¯å¾„</h4><p>è¿™ä¸ª 0 åˆ° 1 çš„å®ç°è·¯å¾„ï¼Œæ¸…æ™°åœ°å±•ç°äº†ä»ç¬¬ä¸€æ€§åŸç†å‡ºå‘çš„æ€è€ƒï¼š</p><p><strong>ç¼“å­˜å¤±æ•ˆï¼ˆé—®é¢˜ï¼‰</strong> â†’ <strong>1.å¼€æ”¾å¯»å€ï¼ˆæ–¹æ¡ˆï¼‰</strong> â†’ <strong>2.å…ƒæ•°æ®ï¼ˆH2ï¼‰è¿‡æ»¤ï¼ˆè§£å†³æ¯”è¾ƒæ•ˆç‡ï¼‰</strong> â†’ <strong>3.å¹¶è¡ŒåŒ¹é…ï¼ˆæè‡´ä¼˜åŒ–æ¯”è¾ƒï¼‰</strong> â†’ <strong>4.å¢“ç¢‘ï¼ˆè§£å†³åˆ é™¤é—ç•™é—®é¢˜ï¼‰</strong> â†’ <strong>5.å¯æ‰©å±•å“ˆå¸Œï¼ˆè§£å†³æ‰©å®¹å»¶è¿Ÿï¼‰</strong> â†’ <strong>6. å° Mapä¼˜åŒ–ï¼ˆè§£å†³å°å†…å­˜å¼€é”€ï¼‰</strong></p><h2 id="ä¸ƒå¹¶å‘sync.map-çš„-hashtriemap-å®ç°">ä¸ƒã€å¹¶å‘ï¼šsync.Map çš„HashTrieMap å®ç°</h2><h3 id="ä¸ºä»€ä¹ˆéœ€è¦æ–°å®ç°">1. ä¸ºä»€ä¹ˆéœ€è¦æ–°å®ç°ï¼Ÿ</h3><p><strong>ä¼ ç»Ÿ sync.Map çš„é—®é¢˜</strong>ï¼š - å…¨å±€é”ï¼šå†™æ“ä½œç«äº‰æ¿€çƒˆ - åŒmap å¼€é”€ï¼šread + dirty å†…å­˜ç¿»å€ - æå‡æœºåˆ¶ï¼šå‘¨æœŸæ€§å…¨é‡æ‹·è´</p><p><strong>HashTrieMap çš„è§£å†³æ–¹æ¡ˆ</strong>ï¼š - <strong>Hash-Trieç»“æ„</strong>ï¼šæ ‘å½¢ç»“æ„ï¼Œå¤©ç„¶æ”¯æŒåˆ†åŒº -<strong>ç»†ç²’åº¦é”</strong>ï¼šæ¯ä¸ªèŠ‚ç‚¹ç‹¬ç«‹é”ï¼Œå¹¶å‘åº¦é«˜ -<strong>æ— éœ€æå‡</strong>ï¼šæ²¡æœ‰ read/dirty åˆ‡æ¢</p><h3 id="hashtriemap-æ•°æ®ç»“æ„">2. HashTrieMap æ•°æ®ç»“æ„</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> HashTrieMap[K comparable, V any] <span class="keyword">struct</span> &#123;</span><br><span class="line">    root     atomic.Pointer[indirect[K, V]]</span><br><span class="line">    keyHash  hashFunc</span><br><span class="line">    valEqual equalFunc</span><br><span class="line">    seed     <span class="type">uintptr</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸­é—´èŠ‚ç‚¹ï¼ˆindirect nodeï¼‰</span></span><br><span class="line"><span class="keyword">type</span> indirect[K, V] <span class="keyword">struct</span> &#123;</span><br><span class="line">    mu       Mutex                      <span class="comment">// èŠ‚ç‚¹é”</span></span><br><span class="line">    dead     atomic.Bool                <span class="comment">// èŠ‚ç‚¹æ˜¯å¦å·²æ­»</span></span><br><span class="line">    children [<span class="number">64</span>]atomic.Pointer[node]   <span class="comment">// 64 ä¸ªå­èŠ‚ç‚¹</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¶å­èŠ‚ç‚¹ï¼ˆentry nodeï¼‰</span></span><br><span class="line"><span class="keyword">type</span> entry[K, V] <span class="keyword">struct</span> &#123;</span><br><span class="line">    overflow *entry[K, V]  <span class="comment">// å“ˆå¸Œå†²çªé“¾è¡¨</span></span><br><span class="line">    key      K</span><br><span class="line">    value    V</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Trie ç»“æ„</strong>ï¼ˆæ¯å±‚ä½¿ç”¨ 6 ä½å“ˆå¸Œï¼‰ï¼š <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">               root</span><br><span class="line">              /    \</span><br><span class="line">      [0-63]        [64-127]</span><br><span class="line">      /    \            |</span><br><span class="line"> [0-15]  [16-31]      [...]</span><br><span class="line">   |       |</span><br><span class="line">entries entries</span><br></pre></td></tr></table></figure></p><h3 id="æŸ¥æ‰¾æµç¨‹-1">3. æŸ¥æ‰¾æµç¨‹</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ht *HashTrieMap[K, V])</span></span> Load(key K) (V, <span class="type">bool</span>) &#123;</span><br><span class="line">    hash := Hash(key)</span><br><span class="line">    i := ht.root.Load()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä»æ ¹å‘ä¸‹éå†ï¼Œæ¯æ¬¡å– 6 ä½å“ˆå¸Œ</span></span><br><span class="line">    <span class="keyword">for</span> shift := <span class="number">58</span>; shift &gt;= <span class="number">0</span>; shift -= <span class="number">6</span> &#123;</span><br><span class="line">        idx := (hash &gt;&gt; shift) &amp; <span class="number">0x3F</span>  <span class="comment">// å– 6 ä½</span></span><br><span class="line">        n := i.children[idx].Load()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> n == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> zero, <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> n.isEntry &#123;</span><br><span class="line">            <span class="keyword">return</span> n.entry().lookup(key)</span><br><span class="line">        &#125;</span><br><span class="line">        i = n.indirect()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ— é”è¯»å–</strong>ï¼šè¯»æ“ä½œä¸éœ€è¦åŠ é”ï¼</p><h3 id="æ’å…¥æµç¨‹-1">4. æ’å…¥æµç¨‹</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ht *HashTrieMap[K, V])</span></span> LoadOrStore(key K, value V) (V, <span class="type">bool</span>) &#123;</span><br><span class="line">    hash := Hash(key)</span><br><span class="line">    </span><br><span class="line">retry:</span><br><span class="line">    <span class="comment">// æ— é”æŸ¥æ‰¾æ’å…¥ç‚¹</span></span><br><span class="line">    i, slot := ht.findInsertPoint(hash)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åŠ é”ï¼ˆåªé”ä¸€ä¸ªèŠ‚ç‚¹ï¼‰</span></span><br><span class="line">    i.mu.Lock()</span><br><span class="line">    <span class="keyword">defer</span> i.mu.Unlock()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åŒé‡æ£€æŸ¥</span></span><br><span class="line">    n := slot.Load()</span><br><span class="line">    <span class="keyword">if</span> n != <span class="literal">nil</span> &amp;&amp; n changed &#123;</span><br><span class="line">        <span class="keyword">goto</span> retry  <span class="comment">// èŠ‚ç‚¹å˜åŒ–ï¼Œé‡è¯•</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ’å…¥æ–° entry</span></span><br><span class="line">    newEntry := &amp;entry&#123;key: key, value: value&#125;</span><br><span class="line">    slot.Store(newEntry)</span><br><span class="line">    <span class="keyword">return</span> value, <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç»†ç²’åº¦é”</strong>ï¼š <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">      root (lock1)</span><br><span class="line">     /           \</span><br><span class="line"> indirect1    indirect2</span><br><span class="line"> (lock2)       (lock3)</span><br><span class="line">    â†“             â†“</span><br><span class="line">goroutine1  goroutine2</span><br><span class="line">å¯ä»¥åŒæ—¶ä¿®æ”¹ä¸åŒå­æ ‘ï¼</span><br></pre></td></tr></table></figure></p><h3 id="ä¸ä¼ ç»Ÿ-sync.map-å¯¹æ¯”">5. ä¸ä¼ ç»Ÿ sync.Map å¯¹æ¯”</h3><table><colgroup><col style="width: 15%" /><col style="width: 49%" /><col style="width: 35%" /></colgroup><thead><tr><th>ç»´åº¦</th><th>Read-Write sync.Map</th><th>HashTrieMap</th></tr></thead><tbody><tr><td><strong>æ•°æ®ç»“æ„</strong></td><td>åŒ mapï¼ˆread + dirtyï¼‰</td><td>Hash-Trie æ ‘</td></tr><tr><td><strong>å¹¶å‘ç­–ç•¥</strong></td><td>å…¨å±€é” + è¯»å†™åˆ†ç¦»</td><td><strong>ç»†ç²’åº¦é”ï¼ˆper-nodeï¼‰</strong></td></tr><tr><td><strong>è¯»æ€§èƒ½</strong></td><td>å‘½ä¸­ readï¼šO(1) æ— é”<br>æœªå‘½ä¸­ï¼šåŠ é”</td><td><strong>å§‹ç»ˆæ— é”ï¼ŒO(logâ‚†â‚„ n)</strong></td></tr><tr><td><strong>å†™æ€§èƒ½</strong></td><td>å¿«é€Ÿè·¯å¾„ï¼šåŸå­æ“ä½œ<br>æ…¢é€Ÿè·¯å¾„ï¼šå…¨å±€é”</td><td><strong>é”ç²’åº¦ç»†ï¼ŒO(logâ‚†â‚„ n)</strong></td></tr><tr><td><strong>å†…å­˜å¼€é”€</strong></td><td>ä¸¤ä»½ map</td><td>Trie èŠ‚ç‚¹å¼€é”€</td></tr><tr><td><strong>æå‡æœºåˆ¶</strong></td><td>éœ€è¦å‘¨æœŸæ€§æå‡</td><td><strong>æ— éœ€æå‡</strong></td></tr><tr><td><strong>ç±»å‹å®‰å…¨</strong></td><td><code>map[any]any</code></td><td><strong>æ³›å‹ <code>HashTrieMap[K,V]</code></strong></td></tr></tbody></table><p><strong>HashTrieMap çš„ä¼˜åŠ¿</strong>ï¼š 1. âœ…ç»†ç²’åº¦å¹¶å‘ï¼šé”ç«äº‰å¤§å¹…é™ä½ 2. âœ… æ— éœ€æå‡ï¼šæ²¡æœ‰å…¨é‡æ‹·è´å¼€é”€ 3. âœ…æ³›å‹æ”¯æŒï¼šç±»å‹å®‰å…¨ 4. âœ… è¯»æ— é”ï¼šå§‹ç»ˆæ— éœ€åŠ é”</p><p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š - é«˜å¹¶å‘å†™å…¥ - é”®ç©ºé—´å¤§ï¼ˆTrieçš„ç©ºé—´ä¼˜åŠ¿ï¼‰ - éœ€è¦æ³›å‹æ”¯æŒ</p><h2 id="å…«æ€»ç»“">å…«ã€æ€»ç»“</h2><h3 id="swiss-map-æ ¸å¿ƒåˆ›æ–°">Swiss Map æ ¸å¿ƒåˆ›æ–°</h3><ol type="1"><li><p><strong>å¹¶è¡ŒåŒ¹é…ç®—æ³•</strong>ï¼š <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ä¼ ç»Ÿï¼šé€ä¸ªæ¯”è¾ƒ 8 æ¬¡</span><br><span class="line">Swissï¼šå¹¶è¡Œæ¯”è¾ƒ 1 æ¬¡ï¼ˆ8 å€æå‡ï¼‰</span><br></pre></td></tr></table></figure></p></li><li><p><strong>å¯æ‰©å±•å“ˆå¸Œ</strong>ï¼š <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ä¼ ç»Ÿï¼šå•è¡¨æ‰©å®¹ï¼Œå»¶è¿Ÿå³°å€¼</span><br><span class="line">Swissï¼šå¤šè¡¨åˆ†è£‚ï¼Œå»¶è¿Ÿå¯æ§</span><br></pre></td></tr></table></figure></p></li><li><p><strong>SIMD åŠ é€Ÿ</strong>ï¼š <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AMD64ï¼šä½¿ç”¨ SSE2 æŒ‡ä»¤</span><br><span class="line">æ€§èƒ½æå‡ï¼š2-3 å€</span><br></pre></td></tr></table></figure></p></li></ol><h3 id="è®¾è®¡æƒè¡¡">è®¾è®¡æƒè¡¡</h3><p><strong>ä¼˜åŠ¿</strong>ï¼š - âœ… æŸ¥æ‰¾æ€§èƒ½ï¼šå¹¶è¡ŒåŒ¹é… + SIMD - âœ…ç©ºé—´æ•ˆç‡ï¼š87.5% è´Ÿè½½å› å­ - âœ… å¢é‡æ‰©å®¹ï¼šè¡¨åˆ†è£‚æ§åˆ¶å»¶è¿Ÿ</p><p><strong>åŠ£åŠ¿</strong>ï¼š - âŒ å¢“ç¢‘ç®¡ç†ï¼šéœ€è¦å®šæœŸæ¸…ç† - âŒå®ç°å¤æ‚ï¼šä½è¿ç®— + SIMD å†…è” - âŒ ç›®å½•å¼€é”€ï¼šå¤§ map éœ€è¦é¢å¤–ç»“æ„</p><h3 id="é€‰æ‹©å»ºè®®">é€‰æ‹©å»ºè®®</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ éœ€è¦å¹¶å‘ï¼Ÿ                           â”‚</span><br><span class="line">â”‚  â”œâ”€ å¦ â†’ ä½¿ç”¨ map (Swiss æˆ– non-Swiss)|</span><br><span class="line">â”‚  â””â”€ æ˜¯ â†“                            â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ å†™å¤šè¿˜æ˜¯è¯»å¤šï¼Ÿ                       â”‚</span><br><span class="line">â”‚  â”œâ”€ è¯»å¤š â†’ sync.Map (Read-Write)    â”‚</span><br><span class="line">â”‚  â””â”€ å†™å¤š â†’ sync.Map (HashTrieMap)   â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><p><strong>æœ€ä½³å®è·µ</strong>ï¼š</p><ol type="1"><li>é»˜è®¤ä½¿ç”¨ Swiss mapï¼ˆå·²å¯ç”¨å®éªŒç‰¹æ€§ï¼‰</li><li>é«˜å¹¶å‘åœºæ™¯ä½¿ç”¨ sync.Map</li><li>ç®€å•åœºæ™¯ç”¨ <code>RWMutex + map</code></li></ol><hr /><p><strong>å‚è€ƒèµ„æ–™</strong>ï¼š - <ahref="https://abseil.io/about/design/swisstables">Abseil SwissTables</a> - <a href="https://github.com/golang/go/issues/54766">GoSwiss Map PR</a> - <ahref="https://github.com/golang/go/issues/70155">Go HashTrieMapPR</a></p>]]></content>
    
    
    <summary type="html">æœ¬æ–‡ç³»ç»Ÿè§£æ Go mapï¼ˆSwiss Table ç‰ˆæœ¬ï¼‰çš„åº•å±‚å®ç°ï¼Œæ¶µç›–æ§åˆ¶å­—å¹¶è¡ŒåŒ¹é…ã€å¼€æ”¾å¯»å€æ¢æµ‹ã€å¯æ‰©å±•å“ˆå¸Œã€ç»†ç²’åº¦å¹¶å‘æ§åˆ¶ï¼Œå¹¶å¯¹æ¯” sync.Map çš„ HashTrieMap å®ç°ã€‚</summary>
    
    
    
    <category term="Go" scheme="https://hedon.top/categories/Go/"/>
    
    
    <category term="Go" scheme="https://hedon.top/tags/Go/"/>
    
  </entry>
  
  <entry>
    <title>Go åº•å±‚åŸç†ä¸¨mapï¼ˆé swiss ç‰ˆæœ¬ï¼‰</title>
    <link href="https://hedon.top/2025/11/16/go/go-map-no-swiss/"/>
    <id>https://hedon.top/2025/11/16/go/go-map-no-swiss/</id>
    <published>2025-11-16T06:00:00.000Z</published>
    <updated>2025-11-16T08:10:54.048Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€æ•´ä½“è®¾è®¡æ€æƒ³">ä¸€ã€æ•´ä½“è®¾è®¡æ€æƒ³</h2><p>Go mapï¼ˆno swiss ç‰ˆæœ¬ï¼‰æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª<strong>å“ˆå¸Œè¡¨</strong>ï¼Œé‡‡ç”¨ä»¥ä¸‹æ ¸å¿ƒè®¾è®¡ï¼š</p><ol type="1"><li><strong>æ¡¶å¼å“ˆå¸Œ</strong>ï¼šæ•°æ®è¢«ç»„ç»‡æˆæ¡¶ï¼ˆbucketï¼‰æ•°ç»„</li><li><strong>é“¾å¼æº¢å‡º</strong>ï¼šæ¯ä¸ªæ¡¶æœ€å¤šå­˜å‚¨ 8ä¸ªé”®å€¼å¯¹ï¼Œè¶…è¿‡åˆ™é“¾æ¥æº¢å‡ºæ¡¶</li><li><strong>æ¸è¿›å¼æ‰©å®¹</strong>ï¼šæ‰©å®¹æ—¶é‡‡ç”¨å¢é‡è¿ç§»ï¼Œé¿å…ä¸€æ¬¡æ€§æ‹·è´å¤§é‡æ•°æ®</li><li><strong>åˆ†ç¦»å­˜å‚¨</strong>ï¼šé”®å’Œå€¼åˆ†åˆ«è¿ç»­å­˜å‚¨ï¼ˆè€Œéäº¤æ›¿å­˜å‚¨ï¼‰ï¼Œå‡å°‘å†…å­˜å¯¹é½çš„å¡«å……å¼€é”€</li></ol><h2 id="äºŒæ ¸å¿ƒæ•°æ®ç»“æ„">äºŒã€æ ¸å¿ƒæ•°æ®ç»“æ„</h2><p>æœ¬ç¯‡ä»¥ Go1.25 ç‰ˆæœ¬çš„æºç ä¸ºåŸºå‡†è¿›è¡Œå±•å¼€ï¼Œå®Œæ•´æºç å¯å‚è€ƒå®˜æ–¹ä»£ç ï¼š<ahref="https://github.com/golang/go/blob/release-branch.go1.25/src/runtime/map_noswiss.go#L115">map_noswiss.go</a>ã€‚</p><h3 id="hmapmap-å¤´éƒ¨ç»“æ„">1. hmapï¼ˆmap å¤´éƒ¨ç»“æ„ï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> hmap <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// Note: the format of the hmap is also encoded in cmd/compile/internal/reflectdata/reflect.go.</span></span><br><span class="line"><span class="comment">// Make sure this stays in sync with the compiler&#x27;s definition.</span></span><br><span class="line">count     <span class="type">int</span> <span class="comment">// # live cells == size of map.  Must be first (used by len() builtin)</span></span><br><span class="line">flags     <span class="type">uint8</span></span><br><span class="line">B         <span class="type">uint8</span>  <span class="comment">// log_2 of # of buckets (can hold up to loadFactor * 2^B items)</span></span><br><span class="line">noverflow <span class="type">uint16</span> <span class="comment">// approximate number of overflow buckets; see incrnoverflow for details</span></span><br><span class="line">hash0     <span class="type">uint32</span> <span class="comment">// hash seed</span></span><br><span class="line"></span><br><span class="line">buckets    unsafe.Pointer <span class="comment">// array of 2^B Buckets. may be nil if count==0.</span></span><br><span class="line">oldbuckets unsafe.Pointer <span class="comment">// previous bucket array of half the size, non-nil only when growing</span></span><br><span class="line">nevacuate  <span class="type">uintptr</span>        <span class="comment">// progress counter for evacuation (buckets less than this have been evacuated)</span></span><br><span class="line">clearSeq   <span class="type">uint64</span></span><br><span class="line"></span><br><span class="line">extra *mapextra <span class="comment">// optional fields</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>count</code>ï¼šmap ä¸­å…ƒç´ ä¸ªæ•°</li><li><code>B</code>ï¼šæ¡¶æ•°é‡çš„å¯¹æ•°ï¼ˆæ¡¶æ•° = 2^Bï¼‰</li><li><code>buckets</code>ï¼šå½“å‰æ¡¶æ•°ç»„ <code>[]bmap</code> æŒ‡é’ˆ</li><li><code>oldbuckets</code>ï¼šæ‰©å®¹æ—¶çš„æ—§æ¡¶æ•°ç»„ <code>[]bmap</code></li><li><code>nevacuate</code>ï¼šæ‰©å®¹è¿ç§»è¿›åº¦è®¡æ•°å™¨</li><li><code>hash0</code>ï¼šå“ˆå¸Œç§å­ï¼ˆé˜²æ­¢å“ˆå¸Œç¢°æ’æ”»å‡»ï¼‰</li></ul><h3 id="bmapæ¡¶ç»“æ„">2. bmapï¼ˆæ¡¶ç»“æ„ï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A bucket for a Go map.</span></span><br><span class="line"><span class="keyword">type</span> bmap <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// tophash generally contains the top byte of the hash value</span></span><br><span class="line"><span class="comment">// for each key in this bucket. If tophash[0] &lt; minTopHash,</span></span><br><span class="line"><span class="comment">// tophash[0] is a bucket evacuation state instead.</span></span><br><span class="line">tophash [abi.OldMapBucketCount]<span class="type">uint8</span></span><br><span class="line"><span class="comment">// Followed by bucketCnt keys and then bucketCnt elems.</span></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> packing all the keys together and then all the elems together makes the</span></span><br><span class="line"><span class="comment">// code a bit more complicated than alternating key/elem/key/elem/... but it allows</span></span><br><span class="line"><span class="comment">// us to eliminate padding which would be needed for, e.g., map[int64]int8.</span></span><br><span class="line"><span class="comment">// Followed by an overflow pointer.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å†…å­˜å¸ƒå±€</strong>ï¼ˆè¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆï¼‰ï¼š <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[tophash0][tophash1]...[tophash7]</span><br><span class="line">[key0][key1]...[key7]</span><br><span class="line">[value0][value1]...[value7]</span><br><span class="line">[overflow pointer]</span><br></pre></td></tr></table></figure></p><p><strong>tophash çš„ä½œç”¨</strong>ï¼š - å­˜å‚¨å“ˆå¸Œå€¼çš„é«˜ 8 ä½ï¼Œç”¨äºå¿«é€Ÿæ¯”è¾ƒ- ç‰¹æ®Šå€¼æ ‡è®°æ¡¶çš„çŠ¶æ€ï¼ˆç©ºæ§½ã€å·²è¿ç§»ç­‰ï¼‰</p><h3 id="ç‰¹æ®ŠçŠ¶æ€å€¼">3. ç‰¹æ®ŠçŠ¶æ€å€¼</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Possible tophash values. We reserve a few possibilities for special marks.</span></span><br><span class="line"><span class="comment">// Each bucket (including its overflow buckets, if any) will have either all or none of its</span></span><br><span class="line"><span class="comment">// entries in the evacuated* states (except during the evacuate() method, which only happens</span></span><br><span class="line"><span class="comment">// during map writes and thus no one else can observe the map during that time).</span></span><br><span class="line">emptyRest      = <span class="number">0</span> <span class="comment">// this cell is empty, and there are no more non-empty cells at higher indexes or overflows.</span></span><br><span class="line">emptyOne       = <span class="number">1</span> <span class="comment">// this cell is empty</span></span><br><span class="line">evacuatedX     = <span class="number">2</span> <span class="comment">// key/elem is valid.  Entry has been evacuated to first half of larger table.</span></span><br><span class="line">evacuatedY     = <span class="number">3</span> <span class="comment">// same as above, but evacuated to second half of larger table.</span></span><br><span class="line">evacuatedEmpty = <span class="number">4</span> <span class="comment">// cell is empty, bucket is evacuated.</span></span><br><span class="line">minTopHash     = <span class="number">5</span> <span class="comment">// minimum tophash for a normal filled cell.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// flags</span></span><br><span class="line">iterator     = <span class="number">1</span> <span class="comment">// there may be an iterator using buckets</span></span><br><span class="line">oldIterator  = <span class="number">2</span> <span class="comment">// there may be an iterator using oldbuckets</span></span><br><span class="line">hashWriting  = <span class="number">4</span> <span class="comment">// a goroutine is writing to the map</span></span><br><span class="line">sameSizeGrow = <span class="number">8</span> <span class="comment">// the current map growth is to a new map of the same size</span></span><br></pre></td></tr></table></figure><h3 id="æ€»ç»“å›¾">4. æ€»ç»“å›¾</h3><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/e6c9d24egy1h54yxtuoa2j21w00qaadi.jpg" /></p><h2 id="ä¸‰æ ¸å¿ƒæ“ä½œ">ä¸‰ã€æ ¸å¿ƒæ“ä½œ</h2><h3 id="åˆå§‹åŒ–makemap">1. åˆå§‹åŒ–ï¼ˆmakemapï¼‰</h3><ul><li><p>make</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">m := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">int</span>]<span class="type">string</span>, <span class="number">10</span>)</span><br></pre></td></tr></table></figure><p>åº•å±‚ï¼šè°ƒç”¨ runtime/map.go ä¸­çš„ <code>makemap()</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">makemap</span><span class="params">(t *maptype, hint <span class="type">int</span>, h *hmap)</span></span> *hmap &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 1. è®¡ç®—é¢„æœŸçš„ map å¤§å°</span></span><br><span class="line">mem, overflow := math.MulUintptr(<span class="type">uintptr</span>(hint), t.bucket.size)</span><br><span class="line"><span class="keyword">if</span> overflow || mem &gt; maxAlloc &#123;</span><br><span class="line">hint = <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. åˆ›å»ºä¸€ä¸ªæ–°çš„ hmap</span></span><br><span class="line"><span class="keyword">if</span> h == <span class="literal">nil</span> &#123;</span><br><span class="line">h = <span class="built_in">new</span>(hmap)</span><br><span class="line">&#125;</span><br><span class="line">h.hash0 = fastrand()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. è®¡ç®— B</span></span><br><span class="line">B := <span class="type">uint8</span>(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> overLoadFactor(hint, B) &#123;</span><br><span class="line">B++</span><br><span class="line">&#125;</span><br><span class="line">h.B = B</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> h.B != <span class="number">0</span> &#123;</span><br><span class="line">    <span class="comment">// 4. æ ¹æ® B åˆ›å»ºæ¡¶å’Œæº¢å‡ºæ¡¶</span></span><br><span class="line"><span class="keyword">var</span> nextOverflow *bmap</span><br><span class="line">h.buckets, nextOverflow = makeBucketArray(t, h.B, <span class="literal">nil</span>)</span><br><span class="line"><span class="keyword">if</span> nextOverflow != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="comment">// 5. å°†æº¢å‡ºæ¡¶çš„æ•°æ®å­˜åœ¨ mapextra ä¸­</span></span><br><span class="line">h.extra = <span class="built_in">new</span>(mapextra)</span><br><span class="line">h.extra.nextOverflow = nextOverflow</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> h</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å­—é¢é‡ï¼ˆåº•å±‚è¿˜æ˜¯å…ˆè°ƒç”¨ makemapï¼Œç„¶åå†åšèµ‹å€¼ï¼‰</p><ul><li>å…ƒç´ å°‘äº 25 ä¸ªæ—¶ï¼Œä¸€ä¸ªä¸€ä¸ªç®€å•èµ‹å€¼</li><li>å…ƒç´ å¤šä¸ª 25 ä¸ªæ—¶ï¼Œè½¬ä¸ºå¾ªç¯èµ‹å€¼</li></ul></li></ul><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/e6c9d24egy1h54yxo97l4j21y20o0tbz.jpg" /></p><h3 id="æŸ¥æ‰¾æ“ä½œmapaccess1mapaccess2">2.æŸ¥æ‰¾æ“ä½œï¼ˆmapaccess1/mapaccess2ï¼‰</h3><p>åº•å±‚è°ƒç”¨äº† <code>runtime/map.go</code> ä¸­çš„ <code>mapaccess1()</code>æˆ–è€… <code>mapaccess2</code> æ–¹æ³•ï¼š</p><ul><li>v := m[k] è°ƒç”¨ <code>mapaccess1()</code></li><li>v,k := m[k] è°ƒç”¨ <code>mapaccess2()</code></li></ul><p><strong>æŸ¥æ‰¾æµç¨‹</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mapaccess1 å®ç° v := m[k] è¯­ä¹‰ï¼Œè¿”å›æŒ‡å‘å€¼çš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment">// æ ¸å¿ƒæ€è·¯ï¼šhashå®šä½æ¡¶ â†’ tophashå¿«é€Ÿè¿‡æ»¤ â†’ å®Œæ•´keyæ¯”è¾ƒ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mapaccess1</span><span class="params">(t *maptype, h *hmap, key unsafe.Pointer)</span></span> unsafe.Pointer &#123;</span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line"><span class="comment">// ç¬¬ä¸€éƒ¨åˆ†ï¼šå®‰å…¨æ€§æ£€æŸ¥ï¼ˆRace/Memory Sanitizerï¼‰</span></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line"><span class="keyword">if</span> raceenabled &amp;&amp; h != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="comment">// Race Detectorï¼šè®°å½•è¯»æ“ä½œï¼Œæ£€æµ‹å¹¶å‘ç«æ€æ¡ä»¶</span></span><br><span class="line">callerpc := sys.GetCallerPC()</span><br><span class="line">pc := abi.FuncPCABIInternal(mapaccess1)</span><br><span class="line">racereadpc(unsafe.Pointer(h), callerpc, pc)</span><br><span class="line">raceReadObjectPC(t.Key, key, callerpc, pc)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> msanenabled &amp;&amp; h != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="comment">// MSanï¼ˆMemory Sanitizerï¼‰ï¼šæ£€æŸ¥ key æ˜¯å¦å·²åˆå§‹åŒ–</span></span><br><span class="line">msanread(key, t.Key.Size_)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> asanenabled &amp;&amp; h != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="comment">// ASanï¼ˆAddress Sanitizerï¼‰ï¼šæ£€æŸ¥ key çš„å†…å­˜è®¿é—®æ˜¯å¦åˆæ³•</span></span><br><span class="line">asanread(key, t.Key.Size_)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line"><span class="comment">// ç¬¬äºŒéƒ¨åˆ†ï¼šè¾¹ç•Œæƒ…å†µå¤„ç†</span></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line"><span class="keyword">if</span> h == <span class="literal">nil</span> || h.count == <span class="number">0</span> &#123;</span><br><span class="line"><span class="comment">// nil map æˆ–ç©º mapï¼šæ£€æŸ¥ key ç±»å‹æ˜¯å¦æ”¯æŒä½œä¸º map çš„é”®</span></span><br><span class="line"><span class="comment">// ä¾‹å¦‚ï¼šä¸å¯æ¯”è¾ƒç±»å‹ï¼ˆsliceã€mapã€funcï¼‰ä¼šåœ¨è¿™é‡Œ panic</span></span><br><span class="line"><span class="keyword">if</span> err := maps.OldMapKeyError(t, key); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err) <span class="comment">// see issue 23734</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è¿”å›é›¶å€¼çš„å¼•ç”¨ï¼ˆæ‰€æœ‰é›¶å€¼å…±äº«åŒä¸€ä¸ªå…¨å±€ zeroValï¼‰</span></span><br><span class="line"><span class="keyword">return</span> unsafe.Pointer(&amp;zeroVal[<span class="number">0</span>])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line"><span class="comment">// ç¬¬ä¸‰éƒ¨åˆ†ï¼šå¹¶å‘å®‰å…¨æ£€æŸ¥</span></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line"><span class="keyword">if</span> h.flags&amp;hashWriting != <span class="number">0</span> &#123;</span><br><span class="line"><span class="comment">// æ£€æµ‹åˆ°å¹¶å‘è¯»å†™ï¼šmap ä¸æ”¯æŒå¹¶å‘ï¼Œç«‹å³ fatal</span></span><br><span class="line"><span class="comment">// æ³¨æ„ï¼šè¿™åªèƒ½æ£€æµ‹åˆ°éƒ¨åˆ†å¹¶å‘æƒ…å†µï¼Œä¸æ˜¯å®Œæ•´çš„å¹¶å‘ä¿æŠ¤</span></span><br><span class="line">fatal(<span class="string">&quot;concurrent map read and map write&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line"><span class="comment">// ç¬¬å››éƒ¨åˆ†ï¼šè®¡ç®—å“ˆå¸Œå€¼å¹¶å®šä½æ¡¶</span></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç±»å‹ç‰¹å®šçš„å“ˆå¸Œå‡½æ•°è®¡ç®— hash å€¼ï¼ˆåŒ…å«éšæœº seedï¼‰</span></span><br><span class="line">hash := t.Hasher(key, <span class="type">uintptr</span>(h.hash0))</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¡ç®—æ¡¶æ©ç ï¼šbucketMask(B) = 2^B - 1</span></span><br><span class="line"><span class="comment">// ç”¨äºå¿«é€Ÿå–æ¨¡ï¼šhash &amp; mask ç­‰ä»·äº hash % (2^B)</span></span><br><span class="line">m := bucketMask(h.B)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä½åˆ°ç›®æ ‡æ¡¶ï¼šä½¿ç”¨å“ˆå¸Œå€¼çš„ä½ B ä½ç´¢å¼•æ¡¶æ•°ç»„</span></span><br><span class="line"><span class="comment">// å…¬å¼ï¼šbucket_index = hash &amp; (2^B - 1)</span></span><br><span class="line">b := (*bmap)(add(h.buckets, (hash&amp;m)*<span class="type">uintptr</span>(t.BucketSize)))</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line"><span class="comment">// ç¬¬äº”éƒ¨åˆ†ï¼šå¤„ç†æ‰©å®¹ä¸­çš„æƒ…å†µ</span></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line"><span class="keyword">if</span> c := h.oldbuckets; c != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="comment">// map æ­£åœ¨æ‰©å®¹ä¸­ï¼Œéœ€è¦æ£€æŸ¥æ—§æ¡¶</span></span><br><span class="line"><span class="keyword">if</span> !h.sameSizeGrow() &#123;</span><br><span class="line"><span class="comment">// æƒ…å†µ1ï¼šç¿»å€æ‰©å®¹ï¼ˆå®¹é‡å˜ä¸º 2 å€ï¼‰</span></span><br><span class="line"><span class="comment">// æ—§æ¡¶æ•°é‡æ˜¯æ–°æ¡¶çš„ä¸€åŠï¼Œéœ€è¦å°†æ©ç å³ç§»ä¸€ä½</span></span><br><span class="line"><span class="comment">// ä¾‹å¦‚ï¼šB=4 æ—¶æœ‰ 16 ä¸ªæ¡¶ï¼Œæ‰©å®¹å B=5 æœ‰ 32 ä¸ªæ¡¶</span></span><br><span class="line">m &gt;&gt;= <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æƒ…å†µ2ï¼šç­‰é‡æ‰©å®¹ï¼ˆsameSizeGrowï¼‰</span></span><br><span class="line"><span class="comment">// æ¡¶æ•°é‡ä¸å˜ï¼Œåªæ˜¯æ•´ç†ç¢ç‰‡ï¼Œæ©ç ä¸å˜</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨æ—§æ¡¶æ•°ç»„ä¸­å®šä½å¯¹åº”çš„æ¡¶</span></span><br><span class="line">oldb := (*bmap)(add(c, (hash&amp;m)*<span class="type">uintptr</span>(t.BucketSize)))</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥æ—§æ¡¶æ˜¯å¦å·²è¿ç§»ï¼ˆevacuatedï¼‰</span></span><br><span class="line"><span class="keyword">if</span> !evacuated(oldb) &#123;</span><br><span class="line"><span class="comment">// æ—§æ¡¶è¿˜æœªè¿ç§»ï¼Œä»æ—§æ¡¶ä¸­æŸ¥æ‰¾</span></span><br><span class="line"><span class="comment">// è¿™æ˜¯æ¸è¿›å¼æ‰©å®¹çš„å…³é”®ï¼šè¯»æ“ä½œä¼šè¯»å–æœªè¿ç§»çš„æ—§æ¡¶</span></span><br><span class="line">b = oldb</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å¦‚æœæ—§æ¡¶å·²è¿ç§»ï¼Œç»§ç»­ä½¿ç”¨æ–°æ¡¶ bï¼ˆå‰é¢å·²è®¡ç®—ï¼‰</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line"><span class="comment">// ç¬¬å…­éƒ¨åˆ†ï¼štophash å¿«é€Ÿè¿‡æ»¤</span></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line"><span class="comment">// æå–å“ˆå¸Œå€¼çš„é«˜ 8 ä½ä½œä¸º tophash</span></span><br><span class="line"><span class="comment">// tophash ç”¨äºå¿«é€Ÿè¿‡æ»¤ï¼šåªæœ‰ tophash åŒ¹é…æ‰è¿›è¡Œå®Œæ•´ key æ¯”è¾ƒ</span></span><br><span class="line">top := tophash(hash)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line"><span class="comment">// ç¬¬ä¸ƒéƒ¨åˆ†ï¼šéå†æ¡¶é“¾è¡¨æŸ¥æ‰¾ key</span></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line">bucketloop:</span><br><span class="line"><span class="comment">// å¤–å±‚å¾ªç¯ï¼šéå†æº¢å‡ºæ¡¶é“¾è¡¨ï¼ˆå½“å‰æ¡¶ â†’ overflow â†’ overflow â†’ ...ï¼‰</span></span><br><span class="line"><span class="keyword">for</span> ; b != <span class="literal">nil</span>; b = b.overflow(t) &#123;</span><br><span class="line"><span class="comment">// å†…å±‚å¾ªç¯ï¼šéå†å½“å‰æ¡¶çš„ 8 ä¸ªæ§½ä½</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="type">uintptr</span>(<span class="number">0</span>); i &lt; abi.OldMapBucketCount; i++ &#123;</span><br><span class="line"><span class="comment">// ----------------------------------------</span></span><br><span class="line"><span class="comment">// æ­¥éª¤1ï¼štophash é¢„æ£€ï¼ˆå¿«é€Ÿè·¯å¾„ï¼‰</span></span><br><span class="line"><span class="comment">// ----------------------------------------</span></span><br><span class="line"><span class="keyword">if</span> b.tophash[i] != top &#123;</span><br><span class="line"><span class="comment">// tophash ä¸åŒ¹é…ï¼Œå¿«é€Ÿè·³è¿‡</span></span><br><span class="line"><span class="comment">// è¿™é¿å…äº†æ˜‚è´µçš„å®Œæ•´ key æ¯”è¾ƒ</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> b.tophash[i] == emptyRest &#123;</span><br><span class="line"><span class="comment">// ä¼˜åŒ–ï¼šé‡åˆ° emptyRest æ ‡è®°</span></span><br><span class="line"><span class="comment">// è¡¨ç¤ºå½“å‰ä½ç½®åŠåç»­æ‰€æœ‰æ§½ä½ï¼ˆåŒ…æ‹¬æº¢å‡ºæ¡¶ï¼‰éƒ½æ˜¯ç©ºçš„</span></span><br><span class="line"><span class="comment">// å¯ä»¥ç›´æ¥ç»“æŸæŸ¥æ‰¾ï¼Œæ— éœ€ç»§ç»­éå†</span></span><br><span class="line"><span class="keyword">break</span> bucketloop</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// tophash ä¸º emptyOne æˆ–å…¶ä»–å·²å ç”¨æ§½ä½ï¼šç»§ç»­æ£€æŸ¥ä¸‹ä¸€ä¸ª</span></span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ----------------------------------------</span></span><br><span class="line"><span class="comment">// æ­¥éª¤2ï¼štophash åŒ¹é…ï¼Œè·å– key æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment">// ----------------------------------------</span></span><br><span class="line"><span class="comment">// è®¡ç®— key çš„ä½ç½®ï¼šdataOffset + i * keySize</span></span><br><span class="line"><span class="comment">// å†…å­˜å¸ƒå±€ï¼š[tophashæ•°ç»„][key0][key1]...[key7][value0]...[value7][overflowæŒ‡é’ˆ]</span></span><br><span class="line">k := add(unsafe.Pointer(b), dataOffset+i*<span class="type">uintptr</span>(t.KeySize))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> t.IndirectKey() &#123;</span><br><span class="line"><span class="comment">// é—´æ¥ keyï¼škey å¤ªå¤§ï¼ˆ&gt;128å­—èŠ‚ï¼‰ï¼Œå®é™…å­˜å‚¨çš„æ˜¯æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment">// éœ€è¦è§£å¼•ç”¨è·å–çœŸå®çš„ key åœ°å€</span></span><br><span class="line">k = *((*unsafe.Pointer)(k))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ----------------------------------------</span></span><br><span class="line"><span class="comment">// æ­¥éª¤3ï¼šå®Œæ•´ key æ¯”è¾ƒï¼ˆæ…¢é€Ÿè·¯å¾„ï¼‰</span></span><br><span class="line"><span class="comment">// ----------------------------------------</span></span><br><span class="line"><span class="keyword">if</span> t.Key.Equal(key, k) &#123;</span><br><span class="line"><span class="comment">// key åŒ¹é…ï¼è®¡ç®—å¯¹åº”çš„ value åœ°å€</span></span><br><span class="line"><span class="comment">// value ç´§è·Ÿåœ¨æ‰€æœ‰ key ä¹‹å</span></span><br><span class="line"><span class="comment">// ä½ç½®ï¼šdataOffset + 8*keySize + i*valueSize</span></span><br><span class="line">e := add(unsafe.Pointer(b), dataOffset+abi.OldMapBucketCount*<span class="type">uintptr</span>(t.KeySize)+i*<span class="type">uintptr</span>(t.ValueSize))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> t.IndirectElem() &#123;</span><br><span class="line"><span class="comment">// é—´æ¥ elemï¼švalue å¤ªå¤§ï¼Œå­˜å‚¨çš„æ˜¯æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment">// è§£å¼•ç”¨è·å–çœŸå®çš„ value åœ°å€</span></span><br><span class="line">e = *((*unsafe.Pointer)(e))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿”å›æŒ‡å‘ value çš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="keyword">return</span> e</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// key ä¸åŒ¹é…ï¼ˆtophash ç¢°æ’ï¼Œfalse positiveï¼‰</span></span><br><span class="line"><span class="comment">// ç»§ç»­æ£€æŸ¥å½“å‰æ¡¶çš„ä¸‹ä¸€ä¸ªæ§½ä½</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å½“å‰æ¡¶çš„ 8 ä¸ªæ§½ä½éƒ½æ£€æŸ¥å®Œæ¯•ï¼Œç»§ç»­æ£€æŸ¥æº¢å‡ºæ¡¶</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line"><span class="comment">// ç¬¬å…«éƒ¨åˆ†ï¼šæœªæ‰¾åˆ° key</span></span><br><span class="line"><span class="comment">// ============================================</span></span><br><span class="line"><span class="comment">// éå†å®Œæ‰€æœ‰æ¡¶å’Œæº¢å‡ºæ¡¶éƒ½æœªæ‰¾åˆ° key</span></span><br><span class="line"><span class="comment">// è¿”å›é›¶å€¼å¼•ç”¨ï¼ˆè€Œä¸æ˜¯ nilï¼‰</span></span><br><span class="line"><span class="keyword">return</span> unsafe.Pointer(&amp;zeroVal[<span class="number">0</span>])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å…³é”®æ­¥éª¤</strong>ï¼š</p><ol type="1"><li>è®¡ç®— key çš„å“ˆå¸Œå€¼</li><li>ç”¨å“ˆå¸Œå€¼çš„ä½ä½å®šä½æ¡¶ï¼ˆ<code>hash &amp; bucketMask</code>ï¼‰</li><li>å¦‚æœæ­£åœ¨æ‰©å®¹ï¼Œæ£€æŸ¥æ—§æ¡¶æ˜¯å¦å·²è¿ç§»</li><li>ç”¨å“ˆå¸Œå€¼çš„é«˜ 8 ä½ï¼ˆtophashï¼‰å¿«é€Ÿæ¯”è¾ƒ</li><li>tophash åŒ¹é…åï¼Œå†è¿›è¡Œå®Œæ•´çš„ key æ¯”è¾ƒ</li><li>éå†æº¢å‡ºæ¡¶é“¾è¡¨</li></ol><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/e6c9d24egy1h54yxrocm7j21op0u0gqu.jpg" /></p><h3 id="æ’å…¥æ›´æ–°æ“ä½œmapassign">2. æ’å…¥/æ›´æ–°æ“ä½œï¼ˆmapassignï¼‰</h3><p>åº•å±‚è°ƒç”¨ <code>runtime/map.go</code> çš„ <code>mapassign()</code>æ–¹æ³•ï¼Œè·Ÿ <code>mapaccess()</code> éå¸¸åƒï¼Œåªä¸è¿‡ï¼š</p><ol type="1"><li>å…ˆæ‰¾æ‰¾çœ‹ key åœ¨ä¸åœ¨ï¼Œåœ¨çš„è¯ï¼Œåˆ™è¦†ç›–æ–°çš„ valueï¼›</li><li>å¦‚æœ key ä¸åœ¨ï¼Œåˆ™æ’å…¥æ–°çš„ key å’Œvalueï¼Œè¿™é‡Œåˆ™éœ€è¦è€ƒè™‘æ˜¯å¦éœ€è¦æ‰©å®¹äº†ï¼›</li></ol><h3 id="åˆ é™¤æ“ä½œmapdelete">3. åˆ é™¤æ“ä½œï¼ˆmapdeleteï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mapdelete</span><span class="params">(t *maptype, h *hmap, key unsafe.Pointer)</span></span> &#123;</span><br><span class="line"><span class="comment">// è®¡ç®—å“ˆå¸Œå€¼</span></span><br><span class="line">hash := t.Hasher(key, <span class="type">uintptr</span>(h.hash0))</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®å†™æ ‡å¿—ï¼ˆåœ¨Hasherä¹‹åï¼Œé¿å…panicæ—¶çŠ¶æ€ä¸ä¸€è‡´ï¼‰</span></span><br><span class="line">h.flags ^= hashWriting</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä½æ¡¶å¹¶è§¦å‘æ¸è¿›å¼è¿ç§»ï¼ˆå¦‚æœæ­£åœ¨æ‰©å®¹ï¼‰</span></span><br><span class="line">bucket := hash &amp; bucketMask(h.B)</span><br><span class="line"><span class="keyword">if</span> h.growing() &#123;</span><br><span class="line">growWork(t, h, bucket)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">b := (*bmap)(add(h.buckets, bucket*<span class="type">uintptr</span>(t.BucketSize)))</span><br><span class="line">bOrig := b  <span class="comment">// ä¿å­˜åŸå§‹æ¡¶ï¼Œç”¨äºemptyRestä¼˜åŒ–æ—¶å›æº¯</span></span><br><span class="line">top := tophash(hash)</span><br><span class="line"></span><br><span class="line">search:</span><br><span class="line"><span class="comment">// éå†æ¡¶é“¾è¡¨</span></span><br><span class="line"><span class="keyword">for</span> ; b != <span class="literal">nil</span>; b = b.overflow(t) &#123;</span><br><span class="line"><span class="comment">// éå†æ¡¶å†…8ä¸ªæ§½ä½</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="type">uintptr</span>(<span class="number">0</span>); i &lt; abi.OldMapBucketCount; i++ &#123;</span><br><span class="line"><span class="comment">// tophashä¸åŒ¹é…ï¼Œå¿«é€Ÿè·³è¿‡</span></span><br><span class="line"><span class="keyword">if</span> b.tophash[i] != top &#123;</span><br><span class="line"><span class="keyword">if</span> b.tophash[i] == emptyRest &#123;</span><br><span class="line"><span class="keyword">break</span> search</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–keyå¹¶æ¯”è¾ƒ</span></span><br><span class="line">k := add(unsafe.Pointer(b), dataOffset+i*<span class="type">uintptr</span>(t.KeySize))</span><br><span class="line">k2 := k</span><br><span class="line"><span class="keyword">if</span> t.IndirectKey() &#123;</span><br><span class="line">k2 = *((*unsafe.Pointer)(k2))</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> !t.Key.Equal(key, k2) &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰¾åˆ°äº†ï¼Œæ¸…ç†keyï¼ˆå¸®åŠ©GCï¼‰</span></span><br><span class="line"><span class="keyword">if</span> t.IndirectKey() &#123;</span><br><span class="line">*(*unsafe.Pointer)(k) = <span class="literal">nil</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> t.Key.Pointers() &#123;</span><br><span class="line">memclrHasPointers(k, t.Key.Size_)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¸…ç†valueï¼ˆå¸®åŠ©GCï¼‰</span></span><br><span class="line">e := add(unsafe.Pointer(b), dataOffset+abi.OldMapBucketCount*<span class="type">uintptr</span>(t.KeySize)+i*<span class="type">uintptr</span>(t.ValueSize))</span><br><span class="line"><span class="keyword">if</span> t.IndirectElem() &#123;</span><br><span class="line">*(*unsafe.Pointer)(e) = <span class="literal">nil</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> t.Elem.Pointers() &#123;</span><br><span class="line">memclrHasPointers(e, t.Elem.Size_)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">memclrNoHeapPointers(e, t.Elem.Size_)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ‡è®°ä¸ºemptyOne</span></span><br><span class="line">b.tophash[i] = emptyOne</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¼˜åŒ–ï¼šå¦‚æœåé¢éƒ½æ˜¯ç©ºçš„ï¼Œå°†è¿ç»­çš„emptyOneè½¬ä¸ºemptyRest</span></span><br><span class="line"><span class="comment">// è¿™æ ·åç»­æŸ¥æ‰¾é‡åˆ°emptyRestå¯ä»¥ç«‹å³ç»ˆæ­¢</span></span><br><span class="line"><span class="keyword">if</span> i == abi.OldMapBucketCount<span class="number">-1</span> &#123;</span><br><span class="line"><span class="keyword">if</span> b.overflow(t) != <span class="literal">nil</span> &amp;&amp; b.overflow(t).tophash[<span class="number">0</span>] != emptyRest &#123;</span><br><span class="line"><span class="keyword">goto</span> notLast</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> b.tophash[i+<span class="number">1</span>] != emptyRest &#123;</span><br><span class="line"><span class="keyword">goto</span> notLast</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‘å‰å›æº¯ï¼Œå°†emptyOneæ”¹ä¸ºemptyRest</span></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">b.tophash[i] = emptyRest</span><br><span class="line"><span class="keyword">if</span> i == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">if</span> b == bOrig &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è·³åˆ°å‰ä¸€ä¸ªæ¡¶çš„æœ€åä¸€ä¸ªæ§½ä½</span></span><br><span class="line">c := b</span><br><span class="line"><span class="keyword">for</span> b = bOrig; b.overflow(t) != c; b = b.overflow(t) &#123;</span><br><span class="line">&#125;</span><br><span class="line">i = abi.OldMapBucketCount - <span class="number">1</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">i--</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> b.tophash[i] != emptyOne &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">notLast:</span><br><span class="line">h.count--</span><br><span class="line"><span class="comment">// mapå˜ç©ºæ—¶é‡ç½®å“ˆå¸Œç§å­ï¼Œé˜²æ­¢å“ˆå¸Œç¢°æ’æ”»å‡»</span></span><br><span class="line"><span class="keyword">if</span> h.count == <span class="number">0</span> &#123;</span><br><span class="line">h.hash0 = <span class="type">uint32</span>(rand())</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span> search</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¸…é™¤å†™æ ‡å¿—</span></span><br><span class="line"><span class="keyword">if</span> h.flags&amp;hashWriting == <span class="number">0</span> &#123;</span><br><span class="line">fatal(<span class="string">&quot;concurrent map writes&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">h.flags &amp;^= hashWriting</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å…³é”®ä¼˜åŒ–</strong>ï¼š - åˆ é™¤åå°† tophash æ ‡è®°ä¸º<code>emptyOne</code> - å¦‚æœåç»­éƒ½æ˜¯ç©ºæ§½ï¼Œä¼˜åŒ–ä¸º<code>emptyRest</code>ï¼ˆåŠ é€ŸæŸ¥æ‰¾ï¼‰ - mapä¸ºç©ºæ—¶é‡ç½®å“ˆå¸Œç§å­ï¼ˆé˜²æ­¢æ”»å‡»ï¼‰</p><h2 id="å››æ‰©å®¹æœºåˆ¶">å››ã€æ‰©å®¹æœºåˆ¶</h2><h3 id="è§¦å‘æ¡ä»¶">1. è§¦å‘æ¡ä»¶</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// overLoadFactor reports whether count items placed in 1&lt;&lt;B buckets is over loadFactor.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">overLoadFactor</span><span class="params">(count <span class="type">int</span>, B <span class="type">uint8</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line"><span class="keyword">return</span> count &gt; abi.OldMapBucketCount &amp;&amp; <span class="type">uintptr</span>(count) &gt; loadFactorNum*(bucketShift(B)/loadFactorDen)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// tooManyOverflowBuckets reports whether noverflow buckets is too many for a map with 1&lt;&lt;B buckets.</span></span><br><span class="line"><span class="comment">// Note that most of these overflow buckets must be in sparse use;</span></span><br><span class="line"><span class="comment">// if use was dense, then we&#x27;d have already triggered regular map growth.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">tooManyOverflowBuckets</span><span class="params">(noverflow <span class="type">uint16</span>, B <span class="type">uint8</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line"><span class="comment">// If the threshold is too low, we do extraneous work.</span></span><br><span class="line"><span class="comment">// If the threshold is too high, maps that grow and shrink can hold on to lots of unused memory.</span></span><br><span class="line"><span class="comment">// &quot;too many&quot; means (approximately) as many overflow buckets as regular buckets.</span></span><br><span class="line"><span class="comment">// See incrnoverflow for more details.</span></span><br><span class="line"><span class="keyword">if</span> B &gt; <span class="number">15</span> &#123;</span><br><span class="line">B = <span class="number">15</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// The compiler doesn&#x27;t see here that B &lt; 16; mask B to generate shorter shift code.</span></span><br><span class="line"><span class="keyword">return</span> noverflow &gt;= <span class="type">uint16</span>(<span class="number">1</span>)&lt;&lt;(B&amp;<span class="number">15</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸¤ç§æ‰©å®¹æƒ…å†µï¼š 1. <strong>è´Ÿè½½å› å­è¿‡é«˜</strong>ï¼šå…ƒç´ æ•°é‡ &gt; 6.5 *æ¡¶æ•°é‡ â†’ <strong>ç¿»å€æ‰©å®¹</strong> 2.<strong>æº¢å‡ºæ¡¶è¿‡å¤š</strong>ï¼šæº¢å‡ºæ¡¶æ•°é‡ â‰ˆ ä¸»æ¡¶æ•°é‡ â†’<strong>ç­‰é‡æ‰©å®¹</strong>ï¼ˆæ•´ç†ç¢ç‰‡ï¼‰</p><h3 id="æ‰©å®¹å®ç°hashgrow">2. æ‰©å®¹å®ç°ï¼ˆhashGrowï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hashGrow åˆå§‹åŒ–mapæ‰©å®¹</span></span><br><span class="line"><span class="comment">// å®é™…çš„æ•°æ®è¿ç§»ç”± growWork() å’Œ evacuate() å¢é‡å®Œæˆ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hashGrow</span><span class="params">(t *maptype, h *hmap)</span></span> &#123;</span><br><span class="line"><span class="comment">// å†³å®šæ‰©å®¹ç­–ç•¥ï¼š</span></span><br><span class="line"><span class="comment">// 1. è´Ÿè½½å› å­è¿‡é«˜ â†’ ç¿»å€æ‰©å®¹ (bigger=1, å®¹é‡x2)</span></span><br><span class="line"><span class="comment">// 2. æº¢å‡ºæ¡¶è¿‡å¤š   â†’ ç­‰é‡æ‰©å®¹ (bigger=0, å®¹é‡ä¸å˜ï¼Œåªæ•´ç†ç¢ç‰‡)</span></span><br><span class="line">bigger := <span class="type">uint8</span>(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">if</span> !overLoadFactor(h.count+<span class="number">1</span>, h.B) &#123;</span><br><span class="line"><span class="comment">// å…ƒç´ ä¸å¤šä½†æº¢å‡ºæ¡¶å¤š â†’ ç­‰é‡æ‰©å®¹</span></span><br><span class="line">bigger = <span class="number">0</span></span><br><span class="line">h.flags |= sameSizeGrow</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿å­˜æ—§æ¡¶ï¼Œåˆ†é…æ–°æ¡¶æ•°ç»„</span></span><br><span class="line">oldbuckets := h.buckets</span><br><span class="line">newbuckets, nextOverflow := makeBucketArray(t, h.B+bigger, <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ›´æ–°è¿­ä»£å™¨æ ‡å¿—ï¼šå°†å½“å‰è¿­ä»£å™¨æ ‡è®°è½¬ç§»åˆ°æ—§è¿­ä»£å™¨æ ‡è®°</span></span><br><span class="line"><span class="comment">// è¿™æ ·æ­£åœ¨è¿›è¡Œçš„è¿­ä»£å™¨çŸ¥é“éœ€è¦æ£€æŸ¥oldbuckets</span></span><br><span class="line">flags := h.flags &amp;^ (iterator | oldIterator)</span><br><span class="line"><span class="keyword">if</span> h.flags&amp;iterator != <span class="number">0</span> &#123;</span><br><span class="line">flags |= oldIterator</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æäº¤æ‰©å®¹ï¼ˆåŸå­æ€§æ“ä½œï¼Œå¯¹GCå¯è§ï¼‰</span></span><br><span class="line">h.B += bigger           <span class="comment">// æ›´æ–°æ¡¶æ•°é‡æŒ‡æ•°</span></span><br><span class="line">h.flags = flags         <span class="comment">// æ›´æ–°æ ‡å¿—</span></span><br><span class="line">h.oldbuckets = oldbuckets  <span class="comment">// è®¾ç½®æ—§æ¡¶ï¼ˆè§¦å‘æ¸è¿›å¼è¿ç§»ï¼‰</span></span><br><span class="line">h.buckets = newbuckets  <span class="comment">// è®¾ç½®æ–°æ¡¶</span></span><br><span class="line">h.nevacuate = <span class="number">0</span>         <span class="comment">// é‡ç½®è¿ç§»è¿›åº¦</span></span><br><span class="line">h.noverflow = <span class="number">0</span>         <span class="comment">// é‡ç½®æº¢å‡ºæ¡¶è®¡æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤„ç†æº¢å‡ºæ¡¶ï¼šå°†å½“å‰çš„æº¢å‡ºæ¡¶è½¬ç§»åˆ°æ—§æº¢å‡ºæ¡¶</span></span><br><span class="line"><span class="keyword">if</span> h.extra != <span class="literal">nil</span> &amp;&amp; h.extra.overflow != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">if</span> h.extra.oldoverflow != <span class="literal">nil</span> &#123;</span><br><span class="line">throw(<span class="string">&quot;oldoverflow is not nil&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">h.extra.oldoverflow = h.extra.overflow</span><br><span class="line">h.extra.overflow = <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®é¢„åˆ†é…çš„æº¢å‡ºæ¡¶</span></span><br><span class="line"><span class="keyword">if</span> nextOverflow != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">if</span> h.extra == <span class="literal">nil</span> &#123;</span><br><span class="line">h.extra = <span class="built_in">new</span>(mapextra)</span><br><span class="line">&#125;</span><br><span class="line">h.extra.nextOverflow = nextOverflow</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨æ„ï¼šè¿™é‡Œåªæ˜¯åˆå§‹åŒ–æ‰©å®¹ï¼Œå®é™…æ•°æ®è¿ç§»æ˜¯å¢é‡è¿›è¡Œçš„</span></span><br><span class="line"><span class="comment">// æ¯æ¬¡å†™æ“ä½œï¼ˆinsert/deleteï¼‰æ—¶ä¼šè°ƒç”¨ growWork() è¿ç§»2ä¸ªæ¡¶</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">growWork</span><span class="params">(t *maptype, h *hmap, bucket <span class="type">uintptr</span>)</span></span> &#123;</span><br><span class="line">evacuate(t, h, bucket&amp;h.oldbucketmask())</span><br><span class="line"><span class="keyword">if</span> h.growing() &#123;</span><br><span class="line">evacuate(t, h, h.nevacuate)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol type="1"><li>åˆ†é…æ–°æ¡¶æ•°ç»„ï¼ˆ2 å€æˆ–ç›¸åŒå¤§å°ï¼‰</li><li>ä¿å­˜æ—§æ¡¶åˆ° <code>oldbuckets</code></li><li>ä¸ç«‹å³è¿ç§»æ•°æ®ï¼Œæ ‡è®°ä¸º"æ­£åœ¨æ‰©å®¹"</li><li>åç»­æ¯æ¬¡å†™æ“ä½œæ—¶å¢é‡è¿ç§»</li></ol><h3 id="æ¸è¿›å¼è¿ç§»evacuate">3. æ¸è¿›å¼è¿ç§»ï¼ˆevacuateï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// evacuate å°†æŒ‡å®šçš„æ—§æ¡¶è¿ç§»åˆ°æ–°æ¡¶</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">evacuate</span><span class="params">(t *maptype, h *hmap, oldbucket <span class="type">uintptr</span>)</span></span> &#123;</span><br><span class="line"><span class="comment">// å®šä½è¦è¿ç§»çš„æ—§æ¡¶</span></span><br><span class="line">b := (*bmap)(add(h.oldbuckets, oldbucket*<span class="type">uintptr</span>(t.BucketSize)))</span><br><span class="line">newbit := h.noldbuckets()  <span class="comment">// æ—§æ¡¶æ•°é‡ï¼ˆç”¨äºè®¡ç®—å“ˆå¸Œbitï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> !evacuated(b) &#123;</span><br><span class="line"><span class="comment">// å‡†å¤‡è¿ç§»ç›®æ ‡ï¼šxï¼ˆä½ä½ï¼‰å’Œ yï¼ˆé«˜ä½ï¼‰</span></span><br><span class="line"><span class="keyword">var</span> xy [<span class="number">2</span>]evacDst</span><br><span class="line">x := &amp;xy[<span class="number">0</span>]</span><br><span class="line"><span class="comment">// x ç›®æ ‡ï¼šä¸æ—§æ¡¶ç´¢å¼•ç›¸åŒçš„æ–°æ¡¶ä½ç½®</span></span><br><span class="line">x.b = (*bmap)(add(h.buckets, oldbucket*<span class="type">uintptr</span>(t.BucketSize)))</span><br><span class="line">x.k = add(unsafe.Pointer(x.b), dataOffset)</span><br><span class="line">x.e = add(x.k, abi.OldMapBucketCount*<span class="type">uintptr</span>(t.KeySize))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> !h.sameSizeGrow() &#123;</span><br><span class="line"><span class="comment">// ç¿»å€æ‰©å®¹ï¼šè¿˜éœ€è¦å‡†å¤‡ y ç›®æ ‡ï¼ˆæ–°å¢çš„é«˜ä½æ¡¶ï¼‰</span></span><br><span class="line"><span class="comment">// y çš„ä½ç½® = oldbucket + æ—§æ¡¶æ€»æ•°</span></span><br><span class="line">y := &amp;xy[<span class="number">1</span>]</span><br><span class="line">y.b = (*bmap)(add(h.buckets, (oldbucket+newbit)*<span class="type">uintptr</span>(t.BucketSize)))</span><br><span class="line">y.k = add(unsafe.Pointer(y.b), dataOffset)</span><br><span class="line">y.e = add(y.k, abi.OldMapBucketCount*<span class="type">uintptr</span>(t.KeySize))</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç­‰é‡æ‰©å®¹ï¼šåªä½¿ç”¨ xï¼Œæ‰€æœ‰å…ƒç´ ç•™åœ¨åŸä½</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// éå†æ—§æ¡¶åŠå…¶æº¢å‡ºé“¾</span></span><br><span class="line"><span class="keyword">for</span> ; b != <span class="literal">nil</span>; b = b.overflow(t) &#123;</span><br><span class="line">k := add(unsafe.Pointer(b), dataOffset)</span><br><span class="line">e := add(k, abi.OldMapBucketCount*<span class="type">uintptr</span>(t.KeySize))</span><br><span class="line"></span><br><span class="line"><span class="comment">// éå†æ¡¶å†…8ä¸ªæ§½ä½</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; abi.OldMapBucketCount; i, k, e = i+<span class="number">1</span>, add(k, <span class="type">uintptr</span>(t.KeySize)), add(e, <span class="type">uintptr</span>(t.ValueSize)) &#123;</span><br><span class="line">top := b.tophash[i]</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç©ºæ§½ä½ï¼šæ ‡è®°ä¸ºå·²è¿ç§»çš„ç©ºæ§½</span></span><br><span class="line"><span class="keyword">if</span> isEmpty(top) &#123;</span><br><span class="line">b.tophash[i] = evacuatedEmpty</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> top &lt; minTopHash &#123;</span><br><span class="line">throw(<span class="string">&quot;bad map state&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–key</span></span><br><span class="line">k2 := k</span><br><span class="line"><span class="keyword">if</span> t.IndirectKey() &#123;</span><br><span class="line">k2 = *((*unsafe.Pointer)(k2))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å†³å®šè¿ç§»åˆ°xè¿˜æ˜¯yï¼ˆä»…ç¿»å€æ‰©å®¹éœ€è¦ï¼‰</span></span><br><span class="line"><span class="keyword">var</span> useY <span class="type">uint8</span></span><br><span class="line"><span class="keyword">if</span> !h.sameSizeGrow() &#123;</span><br><span class="line"><span class="comment">// é‡æ–°è®¡ç®—å“ˆå¸Œï¼Œæ ¹æ®æ–°å¢çš„bitå†³å®šå»å‘</span></span><br><span class="line">hash := t.Hasher(k2, <span class="type">uintptr</span>(h.hash0))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> h.flags&amp;iterator != <span class="number">0</span> &amp;&amp; !t.ReflexiveKey() &amp;&amp; !t.Key.Equal(k2, k2) &#123;</span><br><span class="line"><span class="comment">// ç‰¹æ®Šæƒ…å†µï¼šNaN keyï¼ˆkey != keyï¼‰</span></span><br><span class="line"><span class="comment">// å“ˆå¸Œå€¼ä¸å¯é‡ç°ï¼Œä½¿ç”¨tophashçš„æœ€ä½bitå†³å®š</span></span><br><span class="line"><span class="comment">// è¿™æ ·å¯ä»¥ä¿è¯è¿­ä»£å™¨çœ‹åˆ°çš„ç»“æœä¸€è‡´</span></span><br><span class="line">useY = top &amp; <span class="number">1</span></span><br><span class="line">top = tophash(hash)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// æ­£å¸¸æƒ…å†µï¼šæ£€æŸ¥æ–°å¢çš„bitä½</span></span><br><span class="line"><span class="comment">// hash &amp; newbit == 0 â†’ å»xï¼ˆä½ä½ï¼‰</span></span><br><span class="line"><span class="comment">// hash &amp; newbit != 0 â†’ å»yï¼ˆé«˜ä½ï¼‰</span></span><br><span class="line"><span class="keyword">if</span> hash&amp;newbit != <span class="number">0</span> &#123;</span><br><span class="line">useY = <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ‡è®°æ—§æ§½ä½å·²è¿ç§»ï¼ˆevacuatedXæˆ–evacuatedYï¼‰</span></span><br><span class="line"><span class="keyword">if</span> evacuatedX+<span class="number">1</span> != evacuatedY || evacuatedX^<span class="number">1</span> != evacuatedY &#123;</span><br><span class="line">throw(<span class="string">&quot;bad evacuatedN&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">b.tophash[i] = evacuatedX + useY  <span class="comment">// evacuatedX=2, evacuatedY=3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é€‰æ‹©ç›®æ ‡æ¡¶</span></span><br><span class="line">dst := &amp;xy[useY]</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›®æ ‡æ¡¶æ»¡äº†ï¼Œåˆ†é…æ–°çš„æº¢å‡ºæ¡¶</span></span><br><span class="line"><span class="keyword">if</span> dst.i == abi.OldMapBucketCount &#123;</span><br><span class="line">dst.b = h.newoverflow(t, dst.b)</span><br><span class="line">dst.i = <span class="number">0</span></span><br><span class="line">dst.k = add(unsafe.Pointer(dst.b), dataOffset)</span><br><span class="line">dst.e = add(dst.k, abi.OldMapBucketCount*<span class="type">uintptr</span>(t.KeySize))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‹·è´tophash</span></span><br><span class="line">dst.b.tophash[dst.i&amp;(abi.OldMapBucketCount<span class="number">-1</span>)] = top</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‹·è´key</span></span><br><span class="line"><span class="keyword">if</span> t.IndirectKey() &#123;</span><br><span class="line">*(*unsafe.Pointer)(dst.k) = k2  <span class="comment">// æ‹·è´æŒ‡é’ˆ</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">typedmemmove(t.Key, dst.k, k)   <span class="comment">// æ‹·è´å€¼</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‹·è´value</span></span><br><span class="line"><span class="keyword">if</span> t.IndirectElem() &#123;</span><br><span class="line">*(*unsafe.Pointer)(dst.e) = *(*unsafe.Pointer)(e)  <span class="comment">// æ‹·è´æŒ‡é’ˆ</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">typedmemmove(t.Elem, dst.e, e)  <span class="comment">// æ‹·è´å€¼</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç§»åŠ¨ç›®æ ‡æŒ‡é’ˆåˆ°ä¸‹ä¸€ä¸ªæ§½ä½</span></span><br><span class="line">dst.i++</span><br><span class="line">dst.k = add(dst.k, <span class="type">uintptr</span>(t.KeySize))</span><br><span class="line">dst.e = add(dst.e, <span class="type">uintptr</span>(t.ValueSize))</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¸…ç†æ—§æ¡¶çš„key/valueï¼Œå¸®åŠ©GCï¼ˆå¦‚æœæ²¡æœ‰è¿­ä»£å™¨åœ¨ä½¿ç”¨ï¼‰</span></span><br><span class="line"><span class="keyword">if</span> h.flags&amp;oldIterator == <span class="number">0</span> &amp;&amp; t.Bucket.Pointers() &#123;</span><br><span class="line">b := add(h.oldbuckets, oldbucket*<span class="type">uintptr</span>(t.BucketSize))</span><br><span class="line"><span class="comment">// ä¿ç•™tophashï¼ˆç”¨äºæ ‡è®°è¿ç§»çŠ¶æ€ï¼‰</span></span><br><span class="line">ptr := add(b, dataOffset)</span><br><span class="line">n := <span class="type">uintptr</span>(t.BucketSize) - dataOffset</span><br><span class="line">memclrHasPointers(ptr, n)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœåˆšå¥½è¿ç§»çš„æ˜¯nevacuateæŒ‡å‘çš„æ¡¶ï¼Œæ¨è¿›è¿ç§»è¿›åº¦</span></span><br><span class="line"><span class="keyword">if</span> oldbucket == h.nevacuate &#123;</span><br><span class="line">advanceEvacuationMark(h, t, newbit)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿ç§»ç­–ç•¥ï¼š</p><ul><li><strong>ç¿»å€æ‰©å®¹</strong>ï¼šä¸€ä¸ªæ—§æ¡¶åˆ†è£‚åˆ°ä¸¤ä¸ªæ–°æ¡¶ï¼ˆX å’Œ Yï¼‰<ul><li>æ ¹æ®å“ˆå¸Œå€¼çš„æ–°æ¯”ç‰¹ä½å†³å®šå» X è¿˜æ˜¯ Y</li></ul></li><li><strong>ç­‰é‡æ‰©å®¹</strong>ï¼šç´§å‡‘åŒ–ï¼Œæ¶ˆé™¤ç¢ç‰‡</li><li>æ¯æ¬¡å†™æ“ä½œè¿ç§» 2 ä¸ªæ¡¶ï¼ˆå½“å‰æ¡¶ + nevacuate æ¡¶ï¼‰</li></ul><h3 id="æ€»ç»“å›¾-1">4. æ€»ç»“å›¾</h3><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/e6c9d24egy1h54yxszqbej21ra0u0n3v.jpg" /></p><h2 id="äº”è¿­ä»£å™¨å®ç°">äº”ã€è¿­ä»£å™¨å®ç°</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A hash iteration structure.</span></span><br><span class="line"><span class="comment">// If you modify hiter, also change cmd/compile/internal/reflectdata/reflect.go</span></span><br><span class="line"><span class="comment">// and reflect/value.go to match the layout of this structure.</span></span><br><span class="line"><span class="keyword">type</span> hiter <span class="keyword">struct</span> &#123;</span><br><span class="line">key         unsafe.Pointer <span class="comment">// Must be in first position.  Write nil to indicate iteration end (see cmd/compile/internal/walk/range.go).</span></span><br><span class="line">elem        unsafe.Pointer <span class="comment">// Must be in second position (see cmd/compile/internal/walk/range.go).</span></span><br><span class="line">t           *maptype</span><br><span class="line">h           *hmap</span><br><span class="line">buckets     unsafe.Pointer <span class="comment">// bucket ptr at hash_iter initialization time</span></span><br><span class="line">bptr        *bmap          <span class="comment">// current bucket</span></span><br><span class="line">overflow    *[]*bmap       <span class="comment">// keeps overflow buckets of hmap.buckets alive</span></span><br><span class="line">oldoverflow *[]*bmap       <span class="comment">// keeps overflow buckets of hmap.oldbuckets alive</span></span><br><span class="line">startBucket <span class="type">uintptr</span>        <span class="comment">// bucket iteration started at</span></span><br><span class="line">offset      <span class="type">uint8</span>          <span class="comment">// intra-bucket offset to start from during iteration (should be big enough to hold bucketCnt-1)</span></span><br><span class="line">wrapped     <span class="type">bool</span>           <span class="comment">// already wrapped around from end of bucket array to beginning</span></span><br><span class="line">B           <span class="type">uint8</span></span><br><span class="line">i           <span class="type">uint8</span></span><br><span class="line">bucket      <span class="type">uintptr</span></span><br><span class="line">checkBucket <span class="type">uintptr</span></span><br><span class="line">clearSeq    <span class="type">uint64</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å…³é”®ç‰¹æ€§</strong>ï¼š 1.<strong>éšæœºèµ·å§‹ä½ç½®</strong>ï¼šé˜²æ­¢ä¾èµ–è¿­ä»£é¡ºåº 2.<strong>å¿«ç…§æœºåˆ¶</strong>ï¼šè®°å½•è¿­ä»£å¼€å§‹æ—¶çš„ buckets æŒ‡é’ˆ 3.<strong>æ‰©å®¹å…¼å®¹</strong>ï¼šåŒæ—¶æ£€æŸ¥æ–°æ—§æ¡¶ï¼Œç¡®ä¿ä¸é‡å¤/é—æ¼</p><h2 id="å…­è´Ÿè½½å› å­é€‰æ‹©">å…­ã€è´Ÿè½½å› å­é€‰æ‹©</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Picking loadFactor: too large and we have lots of overflow</span></span><br><span class="line"><span class="comment">// buckets, too small and we waste a lot of space. I wrote</span></span><br><span class="line"><span class="comment">// a simple program to check some stats for different loads:</span></span><br><span class="line"><span class="comment">// (64-bit, 8 byte keys and elems)</span></span><br><span class="line"><span class="comment">//  loadFactor    %overflow  bytes/entry     hitprobe    missprobe</span></span><br><span class="line"><span class="comment">//        4.00         2.13        20.77         3.00         4.00</span></span><br><span class="line"><span class="comment">//        4.50         4.05        17.30         3.25         4.50</span></span><br><span class="line"><span class="comment">//        5.00         6.85        14.77         3.50         5.00</span></span><br><span class="line"><span class="comment">//        5.50        10.55        12.94         3.75         5.50</span></span><br><span class="line"><span class="comment">//        6.00        15.27        11.67         4.00         6.00</span></span><br><span class="line"><span class="comment">//        6.50        20.90        10.79         4.25         6.50</span></span><br><span class="line"><span class="comment">//        7.00        27.14        10.15         4.50         7.00</span></span><br><span class="line"><span class="comment">//        7.50        34.03         9.73         4.75         7.50</span></span><br><span class="line"><span class="comment">//        8.00        41.10         9.40         5.00         8.00</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// %overflow   = percentage of buckets which have an overflow bucket</span></span><br><span class="line"><span class="comment">// bytes/entry = overhead bytes used per key/elem pair</span></span><br><span class="line"><span class="comment">// hitprobe    = # of entries to check when looking up a present key</span></span><br><span class="line"><span class="comment">// missprobe   = # of entries to check when looking up an absent key</span></span><br></pre></td></tr></table></figure><p><strong>Go é€‰æ‹©äº† 6.5 çš„è´Ÿè½½å› å­</strong>ï¼ˆ13/16 â‰ˆ 0.8125ï¼‰ï¼š -åœ¨ç©ºé—´åˆ©ç”¨ç‡å’Œæ€§èƒ½ä¹‹é—´å–å¾—å¹³è¡¡ - çº¦ 20% çš„æ¡¶ä¼šæœ‰æº¢å‡ºæ¡¶</p><h2 id="ä¸ƒè®¾è®¡äº®ç‚¹">ä¸ƒã€è®¾è®¡äº®ç‚¹</h2><h3 id="åˆ†ç¦»å­˜å‚¨ä¼˜åŒ–">1. <strong>åˆ†ç¦»å­˜å‚¨ä¼˜åŒ–</strong></h3><p>å°† keys å’Œ values åˆ†åˆ«è¿ç»­å­˜å‚¨ï¼Œè€Œä¸æ˜¯äº¤æ›¿å­˜å‚¨<code>key1, val1, key2, val2...</code>ï¼Œè¿™æ ·å¯ä»¥ï¼š -å‡å°‘å†…å­˜å¯¹é½é€ æˆçš„å¡«å……æµªè´¹ - ä¾‹å¦‚<code>map[int64]int8</code>ï¼Œäº¤æ›¿å­˜å‚¨éœ€è¦å¤§é‡å¡«å……</p><h3 id="tophash-å¿«é€Ÿè¿‡æ»¤">2. <strong>tophash å¿«é€Ÿè¿‡æ»¤</strong></h3><ul><li>å…ˆæ¯”è¾ƒ 8 ä½ tophashï¼Œä¸åŒ¹é…ç›´æ¥è·³è¿‡</li><li>åªæœ‰ tophash åŒ¹é…æ‰è¿›è¡Œå®Œæ•´ key æ¯”è¾ƒ</li><li>å¤§å¹…å‡å°‘æ˜‚è´µçš„ key æ¯”è¾ƒæ¬¡æ•°</li></ul><h3 id="æ¸è¿›å¼æ‰©å®¹">3. <strong>æ¸è¿›å¼æ‰©å®¹</strong></h3><ul><li>é¿å…ä¸€æ¬¡æ€§è¿ç§»é€ æˆçš„å»¶è¿Ÿå³°å€¼</li><li>åˆ†æ‘Šåˆ°åç»­çš„æ¯æ¬¡å†™æ“ä½œ</li><li>é€‚åˆå®æ—¶ç³»ç»Ÿ</li></ul><h3 id="ç­‰é‡æ‰©å®¹æ•´ç†ç¢ç‰‡">4. <strong>ç­‰é‡æ‰©å®¹ï¼ˆæ•´ç†ç¢ç‰‡ï¼‰</strong></h3><ul><li>é¢‘ç¹å¢åˆ å¯¼è‡´æº¢å‡ºæ¡¶è¿‡å¤šæ—¶è§¦å‘</li><li>ä¿æŒæ¡¶æ•°é‡ä¸å˜ï¼Œé‡æ–°æ’åˆ—å…ƒç´ </li><li>æ¶ˆé™¤å†…å­˜ç¢ç‰‡ï¼Œæå‡æ€§èƒ½</li></ul><h3 id="å¹¶å‘å®‰å…¨æ£€æµ‹">5. <strong>å¹¶å‘å®‰å…¨æ£€æµ‹</strong></h3><ul><li>ä½¿ç”¨ <code>hashWriting</code> æ ‡å¿—æ£€æµ‹å¹¶å‘è¯»å†™</li><li>è™½ç„¶ä¸æä¾›å†…ç½®é”ï¼Œä½†èƒ½å¿«é€Ÿæ£€æµ‹åˆ°ç«æ€æ¡ä»¶</li><li>å¸®åŠ©å¼€å‘è€…å‘ç° bug</li></ul><h2 id="å…«å¹¶å‘">å…«ã€å¹¶å‘</h2><h3 id="é—®é¢˜">1. é—®é¢˜</h3><p>å‰é¢åˆ†æ map çš„è®¿é—®çš„æ—¶å€™ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“ mapæ˜ç¡®ä¸¥ç¦å¹¶å‘è¯»å†™ã€‚æ¯”å¦‚ï¼š</p><ul><li>ä¸€ä¸ªåç¨‹åœ¨è¯» mapï¼Œå¦ä¸€ä¸ªåç¨‹åœ¨é©±é€ï¼Œå°±å¯èƒ½å‡ºç°é—®é¢˜ã€‚</li></ul><p>æ‰€ä»¥å¦‚æœæˆ‘ä»¬éè¦åœ¨å¹¶å‘æƒ…å†µä¸‹ä½¿ç”¨ map çš„è¯ï¼Œå°±éœ€è¦ç”¨ mutexåŠ é”äº†ï¼Œä½†æ˜¯è¿™æ · map çš„æ€§èƒ½éå¸¸å·®ã€‚</p><h3 id="è§£å†³-sync.map">2. è§£å†³ â€”â€” sync.Map</h3><h4 id="åº•å±‚">2.1 åº•å±‚</h4><ul><li><p>Map</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Map <span class="keyword">struct</span> &#123;</span><br><span class="line">mu Mutex<span class="comment">// é”</span></span><br><span class="line">read atomic.Value <span class="comment">// æŒ‡å‘ä¸€ä¸ª readOnly ç»“æ„ä½“çš„å€¼</span></span><br><span class="line">dirty <span class="keyword">map</span>[any]*entry<span class="comment">// æŒ‡å‘ä¸€ä¸ª map</span></span><br><span class="line">misses <span class="type">int</span><span class="comment">// æ²¡æœ‰å‘½ä¸­çš„ä¸ªæ•°ï¼Œå³åœ¨ read ä¸­è¯»ä¸åˆ°çš„æ¬¡æ•°</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>readOnly</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// readOnly is an immutable struct stored atomically in the Map.read field.</span></span><br><span class="line"><span class="keyword">type</span> readOnly <span class="keyword">struct</span> &#123;</span><br><span class="line">m       <span class="keyword">map</span>[any]*entry<span class="comment">// å­˜å‚¨ map æ•°æ®</span></span><br><span class="line">amended <span class="type">bool</span><span class="comment">// å½“ dirtyMap ä¸­æœ‰ m æ²¡æœ‰çš„å…ƒç´ çš„æ—¶å€™ï¼Œamended å€¼ä¸º true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>entry</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> entry <span class="keyword">struct</span> &#123;</span><br><span class="line">p unsafe.Pointer <span class="comment">// ä¸‡èƒ½æŒ‡é’ˆï¼ŒæŒ‡å‘ value</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/e6c9d24egy1h54yxq23ulj21r80ledi6.jpg" /></p><h4 id="æ­£å¸¸è¯»å†™">2.2 æ­£å¸¸è¯»å†™</h4><ul><li>èµ° readï¼Œè¯»å‡º value æˆ–è€…è¦†ç›– value</li></ul><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/e6c9d24egy1h54yxngurcj21pk0o2ju9.jpg" /></p><h4 id="è¿½åŠ ">2.3 è¿½åŠ </h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span></span> Store(key, value <span class="keyword">interface</span>&#123;&#125;) &#123;</span><br><span class="line"><span class="comment">// 1. å…ˆå°è¯•åœ¨ read map ä¸­è¿›è¡Œå†™</span></span><br><span class="line">  read, _ := m.read.Load().(readOnly)</span><br><span class="line"><span class="keyword">if</span> e, ok := read.m[key]; ok &amp;&amp; e.tryStore(&amp;value) &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. read ä¸­æ²¡æœ‰å¯¹åº”çš„ keyï¼Œé‚£å°±åªèƒ½è¿½åŠ äº†ï¼Œä¸Šé”æ“ä½œ dirty map</span></span><br><span class="line">m.mu.Lock()</span><br><span class="line">  <span class="comment">// 3. å†è¯»ä¸€é read mapï¼Œå› ä¸ºæœ‰å¯èƒ½åœ¨æˆ‘ä»¬ä¸Šé”ä¹‹å‰çš„ä¸€ç¬é—´ï¼Œåˆ«çš„åç¨‹å°† dirty æå‡äº†</span></span><br><span class="line">read, _ = m.read.Load().(readOnly)</span><br><span class="line">  <span class="comment">// 4. read map ä¸­æœ‰äº†ï¼Œè¯´æ˜å·²ç»è¢«å…¶ä»–åç¨‹ dirty æå‡äº†ï¼Œ</span></span><br><span class="line"><span class="keyword">if</span> e, ok := read.m[key]; ok &#123;</span><br><span class="line">    <span class="comment">// 4-1. åˆ¤æ–­è¯»å‡ºæ¥çš„ entry æ˜¯å¦å·²ç»è¢«æ ‡è®°ä¸º unexpunged(å·²åˆ é™¤)</span></span><br><span class="line"><span class="keyword">if</span> e.unexpungeLocked() &#123;</span><br><span class="line"><span class="comment">// 4-2. è¯¥ enrty å·²è¢«æ ‡è®°ä¸ºåˆ é™¤ï¼Œé‚£ä¹ˆå°±éœ€è¦å°†å…¶æ”¾åˆ° dirty ä¸­</span></span><br><span class="line">m.dirty[key] = e</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">// 4-3 è¯»å‡ºæ¥</span></span><br><span class="line">e.storeLocked(&amp;value)</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> e, ok := m.dirty[key]; ok &#123;</span><br><span class="line">    <span class="comment">// 5. read map ä¸­è¿˜æ˜¯æ²¡æœ‰ï¼Œé‚£å°±è¯» dirty map</span></span><br><span class="line">e.storeLocked(&amp;value)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 6. dirty map ä¸­è¿˜æ˜¯æ²¡æœ‰ï¼Œé‚£å°±åªèƒ½å¾€ dirty map ä¸­è¿½åŠ äº†</span></span><br><span class="line"><span class="keyword">if</span> !read.amended &#123;</span><br><span class="line">m.dirtyLocked()</span><br><span class="line">m.read.Store(readOnly&#123;m: read.m, amended: <span class="literal">true</span>&#125;)</span><br><span class="line">&#125;</span><br><span class="line">m.dirty[key] = newEntry(value)</span><br><span class="line">&#125;</span><br><span class="line">  <span class="comment">// 7. è¿½åŠ å®Œï¼Œè§£é”</span></span><br><span class="line">m.mu.Unlock()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// unexpungeLocked å¯ç¡®ä¿ entry æœªæ ‡è®°ä¸ºå·²æ¸…é™¤ã€‚</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// å¦‚æœè¯¥ entry å·²ç»è¢«æ ‡è®°ä¸ºåˆ é™¤äº†ï¼Œåˆ™å¿…é¡»åœ¨è§£é” m.mu ä¹‹å‰å°†å…¶æ·»åŠ åˆ° dirty map ä¸­ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *entry)</span></span> unexpungeLocked() (wasExpunged <span class="type">bool</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> atomic.CompareAndSwapPointer(&amp;e.p, expunged, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/e6c9d24egy1h54yxmh3pyj21xy0rwgr2.jpg" /></p><h4 id="è¿½åŠ åçš„è¯»">2.4 è¿½åŠ åçš„è¯»</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span></span> Load(key <span class="keyword">interface</span>&#123;&#125;) (value <span class="keyword">interface</span>&#123;&#125;, ok <span class="type">bool</span>) &#123;</span><br><span class="line">  <span class="comment">// 1. å…ˆåœ¨ read ä¸­æ‰¾</span></span><br><span class="line">read, _ := m.read.Load().(readOnly)</span><br><span class="line">e, ok := read.m[key]</span><br><span class="line">  <span class="comment">// 2. read ä¸­æ‰¾ä¸åˆ°ï¼Œå°±åœ¨ dirty ä¸­æ‰¾</span></span><br><span class="line"><span class="keyword">if</span> !ok &amp;&amp; read.amended &#123;</span><br><span class="line">    <span class="comment">// 4. ä¸Šé”</span></span><br><span class="line">m.mu.Lock()</span><br><span class="line">    <span class="comment">// 5. å†è¯»ä¸€æ¬¡ read mapï¼Œå› ä¸ºæœ‰å¯èƒ½åœ¨æˆ‘ä»¬ä¸Šé”ä¹‹å‰çš„ä¸€ç¬é—´ï¼Œåˆ«çš„åç¨‹å°† dirty æå‡äº†</span></span><br><span class="line">read, _ = m.read.Load().(readOnly)</span><br><span class="line">e, ok = read.m[key]</span><br><span class="line">    <span class="comment">// 6. è¿˜æ˜¯æ²¡åœ¨ read ä¸­æ‰¾åˆ°ï¼Œå°±åªèƒ½åœ¨ dirty ä¸­æ‰¾äº†</span></span><br><span class="line"><span class="keyword">if</span> !ok &amp;&amp; read.amended &#123;</span><br><span class="line">e, ok = m.dirty[key]</span><br><span class="line">      <span class="comment">// 7. misses ++ å¹¶åˆ¤æ–­æ˜¯å¦éœ€è¦ dirty æå‡</span></span><br><span class="line">m.missLocked()</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">// 8. è§£é”</span></span><br><span class="line">m.mu.Unlock()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> e.load()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/e6c9d24egy1h550i4oryqj21ts0n043n.jpg" /></p><h4 id="dirty-æå‡">2.5 dirty æå‡</h4><p>å½“ <code>meisses = len(dirty)</code> çš„æ—¶å€™ï¼Œå°±ç æ‰ readï¼Œå°† dirtyæå‡åˆ° read çš„ä½ç½®ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span></span> missLocked() &#123;</span><br><span class="line">  <span class="comment">// 1. æ¯åœ¨ dirty ä¸­æŸ¥ä¸€æ¬¡ï¼Œå°± misses++</span></span><br><span class="line">m.misses++</span><br><span class="line"><span class="keyword">if</span> m.misses &lt; <span class="built_in">len</span>(m.dirty) &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">  <span class="comment">// 2. å½“ misses = len(m.dirty) çš„æ—¶å€™ï¼Œå°± dirty æå‡</span></span><br><span class="line">  <span class="comment">// 3. å°† dirtymap èµ‹å€¼ç»™ read map</span></span><br><span class="line">  <span class="comment">//     è¿™é‡Œæ²¡æœ‰æŒ‡å‡º amendedï¼Œä½†æ˜¯å› ä¸ºé»˜è®¤é›¶å€¼æ˜¯ falseï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿå°† amended ç½®ä¸º false äº†</span></span><br><span class="line">m.read.Store(readOnly&#123;m: m.dirty&#125;)</span><br><span class="line">  <span class="comment">// 4. dirty å…ˆä¸º nilï¼Œå½“è¦è¿½åŠ çš„æ—¶å€™ï¼Œå†æ¥å¤åˆ¶ read map</span></span><br><span class="line">m.dirty = <span class="literal">nil</span></span><br><span class="line">  <span class="comment">// 5. é‡ç½® misses</span></span><br><span class="line">m.misses = <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/e6c9d24egy1h550aoso7oj21u40kswhd.jpg" /></p><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/e6c9d24egy1h5511ernl4j21ji0f40uv.jpg" /></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span></span> Store(key, value <span class="keyword">interface</span>&#123;&#125;) &#123;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">if</span> e, ok := read.m[key]; ok &#123;</span><br><span class="line">...</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> e, ok := m.dirty[key]; ok &#123;</span><br><span class="line">...</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// ç¬¬ä¸€æ¬¡è¿½åŠ åˆ° dirty map çš„æ—¶å€™ï¼Œéœ€è¦åˆ¤æ–­çœ‹ dirty map ä¹‹å‰æ˜¯å¦å·²ç»è¢«æå‡äº†ï¼Œå¯èƒ½ä¸º nil</span></span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ nil çš„è¯ï¼Œå°±éœ€è¦å¤åˆ¶ read map</span></span><br><span class="line"><span class="keyword">if</span> !read.amended &#123;</span><br><span class="line">m.dirtyLocked()</span><br><span class="line">m.read.Store(readOnly&#123;m: read.m, amended: <span class="literal">true</span>&#125;)</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">// è¿½åŠ  key</span></span><br><span class="line">m.dirty[key] = newEntry(value)</span><br><span class="line">&#125;</span><br><span class="line">m.mu.Unlock()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“ dirty map ä¸º nil çš„æ—¶å€™</span></span><br><span class="line"><span class="comment">// è´Ÿè´£å°† read map å¤åˆ¶åˆ° dirty map</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span></span> dirtyLocked() &#123;</span><br><span class="line"><span class="keyword">if</span> m.dirty != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">read, _ := m.read.Load().(readOnly)</span><br><span class="line">m.dirty = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">interface</span>&#123;&#125;]*entry, <span class="built_in">len</span>(read.m))</span><br><span class="line"><span class="keyword">for</span> k, e := <span class="keyword">range</span> read.m &#123;</span><br><span class="line"><span class="keyword">if</span> !e.tryExpungeLocked() &#123;</span><br><span class="line">m.dirty[k] = e</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/e6c9d24egy1h559h4hywmj21iq0kmn01.jpg" /></p><h4 id="åˆ é™¤">2.6 åˆ é™¤</h4><ul><li><p>æ­£å¸¸åˆ é™¤</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Delete deletes the value for a key.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span></span> Delete(key <span class="keyword">interface</span>&#123;&#125;) &#123;</span><br><span class="line">m.LoadAndDelete(key)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// LoadAndDelete deletes the value for a key, returning the previous value if any.</span></span><br><span class="line"><span class="comment">// The loaded result reports whether the key was present.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span></span> LoadAndDelete(key <span class="keyword">interface</span>&#123;&#125;) (value <span class="keyword">interface</span>&#123;&#125;, loaded <span class="type">bool</span>) &#123;</span><br><span class="line">read, _ := m.read.Load().(readOnly)</span><br><span class="line">  <span class="comment">// 1. å…ˆä» read map ä¸­æ‰¾</span></span><br><span class="line">e, ok := read.m[key]</span><br><span class="line">...</span><br><span class="line">  <span class="comment">// 2. æ‰¾åˆ°äº†ï¼Œå°±ç›´æ¥åœ¨ read map ä¸­åˆ é™¤</span></span><br><span class="line"><span class="keyword">if</span> ok &#123;</span><br><span class="line"><span class="keyword">return</span> e.<span class="built_in">delete</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *entry)</span></span> <span class="built_in">delete</span>() (value <span class="keyword">interface</span>&#123;&#125;, ok <span class="type">bool</span>) &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">p := atomic.LoadPointer(&amp;e.p)</span><br><span class="line"><span class="keyword">if</span> p == <span class="literal">nil</span> || p == expunged &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">// 3. ç›´æ¥å°† *entry çš„ Pointer ç½®ä¸ºç©º</span></span><br><span class="line"><span class="keyword">if</span> atomic.CompareAndSwapPointer(&amp;e.p, p, <span class="literal">nil</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> *(*<span class="keyword">interface</span>&#123;&#125;)(p), <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/e6c9d24egy1h559grevtmj21jy0m0q6e.jpg" /></p></li><li><p>è¿½åŠ ååˆ é™¤</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span></span> LoadAndDelete(key <span class="keyword">interface</span>&#123;&#125;) (value <span class="keyword">interface</span>&#123;&#125;, loaded <span class="type">bool</span>) &#123;</span><br><span class="line">  <span class="comment">// 1. å…ˆåœ¨ read map ä¸­æ‰¾</span></span><br><span class="line">read, _ := m.read.Load().(readOnly)</span><br><span class="line">e, ok := read.m[key]</span><br><span class="line"><span class="keyword">if</span> !ok &amp;&amp; read.amended &#123;</span><br><span class="line">    <span class="comment">// 2. æ‰¾ä¸åˆ°ï¼Œå°±ä¸Šé”ï¼Œç„¶ååœ¨ dirty map ä¸­æ‰¾</span></span><br><span class="line">m.mu.Lock()</span><br><span class="line">    <span class="comment">// 3. æ‰¾çš„æ—¶å€™ä¸€æ ·ï¼Œè¿˜æ˜¯å†æ¬¡åœ¨ read map ä¸­æŸ¥ä¸€éï¼Œé˜²æ­¢æœ‰ dirty æå‡</span></span><br><span class="line">read, _ = m.read.Load().(readOnly)</span><br><span class="line">e, ok = read.m[key]</span><br><span class="line"><span class="keyword">if</span> !ok &amp;&amp; read.amended &#123;</span><br><span class="line">      <span class="comment">// 4. read map ä¸­è¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œé‚£å°±åœ¨ dirty map ä¸­æ‰¾ï¼Œåˆ çš„æ—¶å€™ï¼Œè¿˜æ˜¯ *entry.Pointer = nil</span></span><br><span class="line">e, ok = m.dirty[key]</span><br><span class="line"><span class="built_in">delete</span>(m.dirty, key)</span><br><span class="line">      <span class="comment">// 5. misses ++</span></span><br><span class="line">m.missLocked()</span><br><span class="line">&#125;</span><br><span class="line">m.mu.Unlock()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ok &#123;</span><br><span class="line"><span class="keyword">return</span> e.<span class="built_in">delete</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/e6c9d24egy1h559c3ywbuj21kk0n2430.jpg" /></p></li><li><p>åˆ é™¤åæå‡ dirty</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span></span> dirtyLocked() &#123;</span><br><span class="line"><span class="keyword">if</span> m.dirty != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">read, _ := m.read.Load().(readOnly)</span><br><span class="line">m.dirty = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">interface</span>&#123;&#125;]*entry, <span class="built_in">len</span>(read.m))</span><br><span class="line"><span class="keyword">for</span> k, e := <span class="keyword">range</span> read.m &#123;</span><br><span class="line">    <span class="comment">// ä¸å¤åˆ¶æ ‡è®°ä¸º expunged çš„</span></span><br><span class="line"><span class="keyword">if</span> !e.tryExpungeLocked() &#123;</span><br><span class="line">m.dirty[k] = e</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/e6c9d24egy1h559gbgjkqj21ig0fw40y.jpg" /></p><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/e6c9d24egy1h559irrt5kj21jy0iwgoj.jpg" /></p></li></ul><h3 id="æ€»ç»“">3. æ€»ç»“</h3><ul><li>sync.Map ä½¿ç”¨äº†ä¸¤ä¸ª mapï¼Œå°†â€œæ™®é€šè¯»å†™â€å’Œâ€œè¿½åŠ â€è¿›è¡Œåˆ†ç¦»ï¼›</li><li>ä¸ä¼šå¼•å‘æ‰©å®¹çš„æ“ä½œï¼ˆæŸ¥ã€æ”¹ï¼‰ä½¿ç”¨ read mapï¼›</li><li>å¯èƒ½å¼•èµ·æ‰©å®¹çš„æ“ä½œï¼ˆå¢ï¼‰ä½¿ç”¨ dirty mapï¼›</li></ul>]]></content>
    
    
    <summary type="html">æœ¬æ–‡ç³»ç»Ÿè§£æ Go mapï¼ˆé swiss ç‰ˆæœ¬ï¼‰çš„åº•å±‚å®ç°ï¼Œæ¶µç›–æ•°æ®ç»“æ„ã€å¯»å€ä¸æ‰©å®¹ã€å“ˆå¸Œå†²çªå¤„ç†ã€è¿­ä»£è¯­ä¹‰ä¸é€‚ç”¨åœºæ™¯ï¼Œå¹¶å¯¹ sync.Map çš„è®¾è®¡å–èˆä¸å®ç°è¦ç‚¹è¿›è¡Œå¯¹ç…§è¯´æ˜ã€‚</summary>
    
    
    
    <category term="Go" scheme="https://hedon.top/categories/Go/"/>
    
    
    <category term="Go" scheme="https://hedon.top/tags/Go/"/>
    
  </entry>
  
  <entry>
    <title>Go åº•å±‚åŸç†ä¸¨slice ä»ç¬¬ä¸€æ€§åŸç†åˆ°å®ç°ç»†èŠ‚</title>
    <link href="https://hedon.top/2025/11/16/go/go-slice/"/>
    <id>https://hedon.top/2025/11/16/go/go-slice/</id>
    <published>2025-11-16T05:00:00.000Z</published>
    <updated>2025-11-16T10:05:23.010Z</updated>
    
    <content type="html"><![CDATA[<p>è®©æˆ‘ä»ç¬¬ä¸€æ€§åŸç†å‡ºå‘ï¼Œå…¨é¢è§£æ Go çš„ slice è®¾è®¡å“²å­¦å’Œåº•å±‚å®ç°ã€‚</p><h2 id="æœ¬è´¨">1. æœ¬è´¨</h2><p>åœ¨è®¡ç®—æœºå†…å­˜ä¸­ï¼Œæœ€åŸºç¡€çš„æ•°æ®ç»“æ„æ˜¯<strong>è¿ç»­å†…å­˜å—</strong>ï¼ˆæ•°ç»„ï¼‰ã€‚ä½†æ•°ç»„æœ‰ä¸€ä¸ªè‡´å‘½ç¼ºé™·ï¼š</p><ul><li><strong>å›ºå®šå¤§å°</strong>ï¼šç¼–è¯‘æ—¶ç¡®å®šï¼Œæ— æ³•åŠ¨æ€å¢é•¿</li><li><strong>å€¼è¯­ä¹‰</strong>ï¼šä¼ é€’æ—¶æ•´ä½“æ‹·è´ï¼Œæ•ˆç‡ä½ä¸‹</li><li><strong>ç¼ºä¹å…ƒä¿¡æ¯</strong>ï¼šåªæœ‰æŒ‡é’ˆï¼Œä¸çŸ¥é“é•¿åº¦å’Œå®¹é‡</li></ul><p>Sliceæœ¬è´¨ä¸Šæ˜¯å¯¹æ•°ç»„çš„<strong>å¼•ç”¨å°è£…</strong>ï¼Œå®ƒè§£å†³äº†ä¸Šè¿°ä¸‰ä¸ªé—®é¢˜ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// runtime/slice.go</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> slice <span class="keyword">struct</span> &#123;</span><br><span class="line">array unsafe.Pointer  <span class="comment">// æŒ‡å‘åº•å±‚æ•°ç»„çš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="built_in">len</span>   <span class="type">int</span>             <span class="comment">// å½“å‰é•¿åº¦ï¼ˆå·²ä½¿ç”¨å…ƒç´ æ•°é‡ï¼‰</span></span><br><span class="line"><span class="built_in">cap</span>   <span class="type">int</span>             <span class="comment">// å®¹é‡ï¼ˆåº•å±‚æ•°ç»„çš„æ€»å¤§å°ï¼‰</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>array</code>ï¼šæŒ‡å‘çœŸæ­£çš„æ•°æ®å­˜å‚¨ä½ç½®ï¼ˆåº•å±‚æ•°ç»„ï¼‰</li><li><code>len</code>ï¼šå®šä¹‰äº† slice çš„<strong>å¯è§èŒƒå›´</strong>ï¼ˆ0 åˆ°len-1 å¯è®¿é—®ï¼‰</li><li><code>cap</code>ï¼šå®šä¹‰äº† slice çš„<strong>æ‰©å±•èƒ½åŠ›</strong>ï¼ˆlen åˆ°cap-1 å¯é€šè¿‡ reslice è®¿é—®ï¼‰</li></ul><p>æ‰€ä»¥è¯´ Slice ä¸æ˜¯å®¹å™¨ï¼Œè€Œæ˜¯<strong>è§†å›¾</strong>ï¼ˆViewï¼‰+<strong>å…ƒæ•°æ®</strong>ï¼ˆMetadataï¼‰çš„ç»„åˆã€‚</p><h2 id="åˆ›å»º">2. åˆ›å»º</h2><h3 id="makeslice">2.1 makeslice</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">3</span>)</span><br><span class="line">fmt.Println(s)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸‹è¿°å‘½ä»¤ï¼Œå¯ä»¥æŸ¥çœ‹ Plan9 æ±‡ç¼–ä»£ç ï¼Œä½ ä¼šå‘ç° <code>make</code>ä¸€ä¸ª slice åº•å±‚è°ƒç”¨çš„å°±æ˜¯ <ahref="https://github.com/golang/go/blob/release-branch.go1.25/src/runtime/slice.go#L101">makeslice</a>å‡½æ•°ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go build -gcflags -S main.go</span><br></pre></td></tr></table></figure><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LEAQ    type.int(SB), AX</span><br><span class="line">MOVL    $3, BX</span><br><span class="line">MOVQ    BX, CX</span><br><span class="line">PCDATA  $1, $0</span><br><span class="line">CALL    runtime.makeslice(SB) #ç›´æ¥è°ƒç”¨ makeslice æ–¹æ³•</span><br></pre></td></tr></table></figure><p><code>makeslice</code> çš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">makeslice</span><span class="params">(et *_type, <span class="built_in">len</span>, <span class="built_in">cap</span> <span class="type">int</span>)</span></span> unsafe.Pointer &#123;</span><br><span class="line">mem, overflow := math.MulUintptr(et.Size_, <span class="type">uintptr</span>(<span class="built_in">cap</span>))</span><br><span class="line"><span class="keyword">if</span> overflow || mem &gt; maxAlloc || <span class="built_in">len</span> &lt; <span class="number">0</span> || <span class="built_in">len</span> &gt; <span class="built_in">cap</span> &#123;</span><br><span class="line">mem, overflow := math.MulUintptr(et.Size_, <span class="type">uintptr</span>(<span class="built_in">len</span>))</span><br><span class="line"><span class="keyword">if</span> overflow || mem &gt; maxAlloc || <span class="built_in">len</span> &lt; <span class="number">0</span> &#123;</span><br><span class="line">panicmakeslicelen()</span><br><span class="line">&#125;</span><br><span class="line">panicmakeslicecap()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> mallocgc(mem, et, <span class="literal">true</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol type="1"><li><p><strong>å®‰å…¨æ£€æŸ¥ä¼˜å…ˆ</strong>ï¼š</p><ul><li>æ£€æŸ¥æ•´æ•°æº¢å‡ºï¼ˆ<code>overflow</code>ï¼‰</li><li>æ£€æŸ¥å†…å­˜é™åˆ¶ï¼ˆ<code>mem &gt; maxAlloc</code>ï¼‰</li><li>æ£€æŸ¥å‚æ•°åˆæ³•æ€§ï¼ˆ<code>len &lt; 0 || len &gt; cap</code>ï¼‰</li></ul></li><li><p><strong>æŒ‰å®¹é‡åˆ†é…å†…å­˜</strong>ï¼š<code>mem = et.Size_ Ã— cap</code></p><ul><li>åˆ†é…çš„æ˜¯ <code>cap</code> è€Œé <code>len</code> çš„å†…å­˜</li><li>è¿™ä¸ºåç»­å¢é•¿é¢„ç•™äº†ç©ºé—´ï¼Œé¿å…é¢‘ç¹é‡æ–°åˆ†é…</li></ul></li><li><p><strong>è°ƒç”¨ mallocgc</strong>ï¼šGo çš„æ ¸å¿ƒå†…å­˜åˆ†é…å™¨</p><ul><li>ä¸ GC é›†æˆï¼Œæ”¯æŒåƒåœ¾å›æ”¶</li><li>ç¬¬ä¸‰ä¸ªå‚æ•° <code>true</code> è¡¨ç¤ºéœ€è¦åˆå§‹åŒ–ä¸ºé›¶å€¼</li></ul></li></ol><h2 id="æ‰©å®¹">3. æ‰©å®¹</h2><h3 id="æ‰©å®¹è§¦å‘æ—¶æœº">3.1 æ‰©å®¹è§¦å‘æ—¶æœº</h3><p>å½“ <code>append</code> å¯¼è‡´ <code>len &gt; cap</code> æ—¶ï¼Œè§¦å‘ <ahref="https://github.com/golang/go/blob/release-branch.go1.25/src/runtime/slice.go#L177">growslice</a>å‡½æ•°ã€‚<code>groupslice</code> å¯ä»¥æ¦‚æ‹¬ä¸º 6 æ­¥ï¼š</p><ol type="1"><li><p>å‚æ•°éªŒè¯ï¼šæ£€æŸ¥æ–°é•¿åº¦æ˜¯å¦åˆæ³•ï¼Œé›¶å¤§å°ç±»å‹ç›´æ¥è¿”å›ç‰¹æ®Šå€¼ã€‚</p></li><li><p>è®¡ç®—æ–°å®¹é‡ï¼šè°ƒç”¨ <code>nextslicecap</code>ï¼šå®¹é‡å°äº 256æ—¶ç¿»å€ï¼Œå¤§äºç­‰äº 256 æ—¶çº¦ 1.25 å€å¢é•¿ã€‚</p></li><li><p>è®¡ç®—å†…å­˜å¤§å°ï¼šæ ¹æ®å…ƒç´ å¤§å°é€‰æ‹©ä¼˜åŒ–è·¯å¾„ï¼š1å­—èŠ‚æ— éœ€ä¹˜æ³•ï¼ŒæŒ‡é’ˆå¤§å°ç”¨ä½ç§»ï¼Œ2 çš„å¹‚ç”¨ä½ç§»ï¼Œå…¶ä»–ç”¨ä¹˜æ³•ã€‚</p></li><li><p>å†…å­˜å¯¹é½ï¼šç”¨ <code>roundupsize</code>å‘ä¸Šå–æ•´åˆ°åˆ†é…å™¨çš„æ ‡å‡†å¤§å°ï¼Œå……åˆ†åˆ©ç”¨ç©ºé—´ï¼ŒåŒæ—¶æ£€æŸ¥æº¢å‡ºå’Œå†…å­˜ä¸Šé™ã€‚</p></li><li><p>åˆ†é…æ–°å†…å­˜ï¼šéæŒ‡é’ˆç±»å‹å‘Šè¯‰ GC ä¸æ‰«æï¼›æŒ‡é’ˆç±»å‹éœ€è¦ GCæ‰«æå’Œå†™å±éšœã€‚åªæ¸…é›¶ <code>[newLen:newCap)</code> åŒºé—´ã€‚</p></li><li><p>å¤åˆ¶æ•°æ®ï¼šç”¨ <code>memmove</code> å¤åˆ¶æ—§å…ƒç´ åˆ°æ–°å†…å­˜ï¼Œè¿”å›æ–°sliceï¼ˆæ–°æŒ‡é’ˆã€æ–°é•¿åº¦ã€æ–°å®¹é‡ï¼‰ã€‚</p></li></ol><h3 id="å®¹é‡å¢é•¿ç®—æ³•">3.2 å®¹é‡å¢é•¿ç®—æ³•</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">nextslicecap</span><span class="params">(newLen, oldCap <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">newcap := oldCap</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœæ–°é•¿åº¦è¶…è¿‡ä¸¤å€æ—§å®¹é‡ï¼Œç›´æ¥ä½¿ç”¨æ–°é•¿åº¦</span></span><br><span class="line">doublecap := newcap + newcap</span><br><span class="line"><span class="keyword">if</span> newLen &gt; doublecap &#123;</span><br><span class="line"><span class="keyword">return</span> newLen</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å°äº 256ï¼ŒåŒå€å¢é•¿</span></span><br><span class="line"><span class="keyword">const</span> threshold = <span class="number">256</span></span><br><span class="line"><span class="keyword">if</span> oldCap &lt; threshold &#123;</span><br><span class="line"><span class="keyword">return</span> doublecap</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤§äº 256</span></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">    <span class="comment">// é€æ­¥ä» 2 å€æ‰©å®¹ç¼©å°åˆ° 1.25 å€æ‰©å®¹</span></span><br><span class="line">newcap += (newcap + <span class="number">3</span>*threshold) &gt;&gt; <span class="number">2</span></span><br><span class="line"><span class="keyword">if</span> <span class="type">uint</span>(newcap) &gt;= <span class="type">uint</span>(newLen) &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> newcap &lt;= <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> newLen</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> newcap</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol type="1"><li><p><strong>ç‰¹æ®Šæƒ…å†µ</strong>ï¼šå¦‚æœæ–°é•¿åº¦è¶…è¿‡ä¸¤å€æ—§å®¹é‡ï¼Œç›´æ¥ä½¿ç”¨æ–°é•¿åº¦</p><ul><li>é¿å…å¤šæ¬¡æ‰©å®¹</li></ul></li><li><p><strong>å°åˆ‡ç‰‡ï¼ˆcap &lt; 256ï¼‰</strong>ï¼šåŒå€å¢é•¿</p><ul><li>å¿«é€Ÿå¢é•¿ï¼Œå‡å°‘å°æ•°æ®é‡çš„å¤šæ¬¡åˆ†é…</li><li>æ—¶é—´å¤æ‚åº¦ï¼šå•æ¬¡ append çš„æ‘Šé”€æˆæœ¬ä¸º O(1)</li></ul></li><li><p><strong>å¤§åˆ‡ç‰‡ï¼ˆcap â‰¥ 256ï¼‰</strong>ï¼šä» 2 å€é€æ­¥é™åˆ° 1.25å€å¢é•¿</p><ul><li><code>newcap += (newcap + 3Ã—256) / 4</code></li><li>å¹³è¡¡äº†å¢é•¿é€Ÿåº¦å’Œå†…å­˜æµªè´¹</li><li>é¿å…å¤§åˆ‡ç‰‡æµªè´¹è¿‡å¤šå†…å­˜</li></ul></li></ol><h3 id="å†…å­˜å¯¹é½ä¼˜åŒ–">3.3 å†…å­˜å¯¹é½ä¼˜åŒ–</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> &#123;</span><br><span class="line"><span class="keyword">case</span> et.Size_ == <span class="number">1</span>:</span><br><span class="line">lenmem = <span class="type">uintptr</span>(oldLen)</span><br><span class="line">newlenmem = <span class="type">uintptr</span>(newLen)</span><br><span class="line">capmem = roundupsize(<span class="type">uintptr</span>(newcap), noscan)</span><br><span class="line">overflow = <span class="type">uintptr</span>(newcap) &gt; maxAlloc</span><br><span class="line">newcap = <span class="type">int</span>(capmem)</span><br><span class="line"><span class="keyword">case</span> et.Size_ == goarch.PtrSize:</span><br><span class="line">lenmem = <span class="type">uintptr</span>(oldLen) * goarch.PtrSize</span><br><span class="line">newlenmem = <span class="type">uintptr</span>(newLen) * goarch.PtrSize</span><br><span class="line">capmem = roundupsize(<span class="type">uintptr</span>(newcap)*goarch.PtrSize, noscan)</span><br><span class="line">overflow = <span class="type">uintptr</span>(newcap) &gt; maxAlloc/goarch.PtrSize</span><br><span class="line">newcap = <span class="type">int</span>(capmem / goarch.PtrSize)</span><br><span class="line"><span class="keyword">case</span> isPowerOfTwo(et.Size_):</span><br><span class="line"><span class="keyword">var</span> shift <span class="type">uintptr</span></span><br><span class="line"><span class="keyword">if</span> goarch.PtrSize == <span class="number">8</span> &#123;</span><br><span class="line"><span class="comment">// Mask shift for better code generation.</span></span><br><span class="line">shift = <span class="type">uintptr</span>(sys.TrailingZeros64(<span class="type">uint64</span>(et.Size_))) &amp; <span class="number">63</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">shift = <span class="type">uintptr</span>(sys.TrailingZeros32(<span class="type">uint32</span>(et.Size_))) &amp; <span class="number">31</span></span><br><span class="line">&#125;</span><br><span class="line">lenmem = <span class="type">uintptr</span>(oldLen) &lt;&lt; shift</span><br><span class="line">newlenmem = <span class="type">uintptr</span>(newLen) &lt;&lt; shift</span><br><span class="line">capmem = roundupsize(<span class="type">uintptr</span>(newcap)&lt;&lt;shift, noscan)</span><br><span class="line">overflow = <span class="type">uintptr</span>(newcap) &gt; (maxAlloc &gt;&gt; shift)</span><br><span class="line">newcap = <span class="type">int</span>(capmem &gt;&gt; shift)</span><br><span class="line">capmem = <span class="type">uintptr</span>(newcap) &lt;&lt; shift</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">lenmem = <span class="type">uintptr</span>(oldLen) * et.Size_</span><br><span class="line">newlenmem = <span class="type">uintptr</span>(newLen) * et.Size_</span><br><span class="line">capmem, overflow = math.MulUintptr(et.Size_, <span class="type">uintptr</span>(newcap))</span><br><span class="line">capmem = roundupsize(capmem, noscan)</span><br><span class="line">newcap = <span class="type">int</span>(capmem / et.Size_)</span><br><span class="line">capmem = <span class="type">uintptr</span>(newcap) * et.Size_</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ€§èƒ½ä¼˜åŒ–ç»†èŠ‚</strong>ï¼š</p><ol type="1"><li><p><strong>ç‰¹åŒ–å¸¸è§æƒ…å†µ</strong>ï¼š</p><ul><li><code>Size == 1</code>ï¼ˆbyte/uint8ï¼‰ï¼šç›´æ¥è®¡ç®—ï¼Œæ— éœ€ä¹˜æ³•</li><li><code>Size == PtrSize</code>ï¼ˆæŒ‡é’ˆå¤§å°ï¼‰ï¼šç¼–è¯‘å™¨å¯ä¼˜åŒ–ä¸ºä½ç§»</li><li><code>Size</code> ä¸º 2 çš„å¹‚ï¼šç”¨ä½ç§»æ›¿ä»£ä¹˜é™¤æ³•</li></ul></li><li><p><strong>roundupsize å‡½æ•°</strong>ï¼š</p><ul><li>å°†å†…å­˜å¤§å°å‘ä¸Šèˆå…¥åˆ°åˆ†é…å™¨çš„ size class</li><li>åˆ©ç”¨å†…å­˜åˆ†é…å™¨çš„å›ºå®šå¤§å°ç±»åˆ«ï¼Œé¿å…å†…å­˜ç¢ç‰‡</li><li><strong>ç»“æœ</strong>ï¼šå®é™…åˆ†é…çš„å®¹é‡å¯èƒ½å¤§äºè®¡ç®—çš„å®¹é‡</li></ul></li></ol><h3 id="æ•°æ®å¤åˆ¶ä¸-gc-åä½œ">3.4 æ•°æ®å¤åˆ¶ä¸ GC åä½œ</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> p unsafe.Pointer</span><br><span class="line"><span class="keyword">if</span> !et.Pointers() &#123;</span><br><span class="line">p = mallocgc(capmem, <span class="literal">nil</span>, <span class="literal">false</span>)</span><br><span class="line"><span class="comment">// The append() that calls growslice is going to overwrite from oldLen to newLen.</span></span><br><span class="line"><span class="comment">// Only clear the part that will not be overwritten.</span></span><br><span class="line"><span class="comment">// The reflect_growslice() that calls growslice will manually clear</span></span><br><span class="line"><span class="comment">// the region not cleared here.</span></span><br><span class="line">memclrNoHeapPointers(add(p, newlenmem), capmem-newlenmem)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// Note: can&#x27;t use rawmem (which avoids zeroing of memory), because then GC can scan uninitialized memory.</span></span><br><span class="line">p = mallocgc(capmem, et, <span class="literal">true</span>)</span><br><span class="line"><span class="keyword">if</span> lenmem &gt; <span class="number">0</span> &amp;&amp; writeBarrier.enabled &#123;</span><br><span class="line"><span class="comment">// Only shade the pointers in oldPtr since we know the destination slice p</span></span><br><span class="line"><span class="comment">// only contains nil pointers because it has been cleared during alloc.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// It&#x27;s safe to pass a type to this function as an optimization because</span></span><br><span class="line"><span class="comment">// from and to only ever refer to memory representing whole values of</span></span><br><span class="line"><span class="comment">// type et. See the comment on bulkBarrierPreWrite.</span></span><br><span class="line">bulkBarrierPreWriteSrcOnly(<span class="type">uintptr</span>(p), <span class="type">uintptr</span>(oldPtr), lenmem-et.Size_+et.PtrBytes, et)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">memmove(p, oldPtr, lenmem)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> slice&#123;p, newLen, newcap&#125;</span><br></pre></td></tr></table></figure><p><strong>GC åä½œçš„è®¾è®¡</strong>ï¼š</p><ol type="1"><li><p><strong>åŒºåˆ†æŒ‡é’ˆå’ŒéæŒ‡é’ˆç±»å‹</strong>ï¼š</p><ul><li>éæŒ‡é’ˆç±»å‹ï¼š<code>mallocgc(..., nil, false)</code> - ä¸éœ€è¦ GCæ‰«æ</li><li>æŒ‡é’ˆç±»å‹ï¼š<code>mallocgc(..., et, true)</code> - éœ€è¦ GC æ‰«æå’Œwrite barrier</li></ul></li><li><p><strong>Write Barrier</strong>ï¼š</p><ul><li>åœ¨å¹¶å‘ GC æ—¶ï¼Œä¿è¯æŒ‡é’ˆå†™å…¥çš„å¯è§æ€§</li><li>ä½¿ç”¨ <code>bulkBarrierPreWriteSrcOnly</code> æ‰¹é‡å¤„ç†ï¼Œæé«˜æ•ˆç‡</li></ul></li><li><p><strong>å†…å­˜æ¸…é›¶ç­–ç•¥</strong>ï¼š</p><ul><li>åªæ¸…é™¤ <code>[newLen, newCap)</code> åŒºé—´ï¼ŒèŠ‚çœæ—¶é—´</li><li><code>[oldLen, newLen)</code> ç”± append è¦†ç›–ï¼Œæ— éœ€æ¸…é›¶</li></ul></li></ol><h2 id="å…±äº«æœºåˆ¶">4. å…±äº«æœºåˆ¶</h2><h3 id="reslicing-åŸç†">4.1 Reslicing åŸç†</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s := []<span class="type">int</span>&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;</span><br><span class="line">s1 := s[<span class="number">1</span>:<span class="number">4</span>]  <span class="comment">// len=3, cap=5, å…±äº«åŒä¸€åº•å±‚æ•°ç»„</span></span><br><span class="line">s2 := s[<span class="number">2</span>:<span class="number">5</span>]  <span class="comment">// len=3, cap=4, ä¹Ÿå…±äº«</span></span><br></pre></td></tr></table></figure><p><strong>åº•å±‚å®ç°</strong>ï¼š</p><ul><li>ä¸‰ä¸ª slice çš„ <code>array</code> æŒ‡é’ˆæŒ‡å‘åŒä¸€å—å†…å­˜çš„ä¸åŒåç§»</li><li><code>s1.array = s.array + 1Ã—sizeof(int)</code></li><li><code>s2.array = s.array + 2Ã—sizeof(int)</code></li></ul><p><strong>è®¾è®¡æƒè¡¡</strong>ï¼š</p><ul><li><strong>ä¼˜åŠ¿</strong>ï¼šé›¶æ‹·è´ï¼Œé«˜æ•ˆçš„å­åºåˆ—æ“ä½œ</li><li><strong>é£é™©</strong>ï¼šä¿®æ”¹ä¸€ä¸ª slice ä¼šå½±å“å…¶ä»–å…±äº«åº•å±‚æ•°ç»„çš„slice</li><li><strong>å“²å­¦</strong>ï¼šGo é€‰æ‹©æ•ˆç‡ä¼˜å…ˆï¼Œç”±ç¨‹åºå‘˜ç®¡ç†å…±äº«è¯­ä¹‰</li></ul><h3 id="ç‰¹æ®Šæƒ…å†µå…ƒç´ å¤§å°ä¸º-0">4.2 ç‰¹æ®Šæƒ…å†µï¼šå…ƒç´ å¤§å°ä¸º 0</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> et.Size_ == <span class="number">0</span> &#123;</span><br><span class="line"><span class="comment">// append should not create a slice with nil pointer but non-zero len.</span></span><br><span class="line"><span class="comment">// We assume that append doesn&#x27;t need to preserve oldPtr in this case.</span></span><br><span class="line"><span class="keyword">return</span> slice&#123;unsafe.Pointer(&amp;zerobase), newLen, newLen&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äº <code>struct&#123;&#125;</code>ã€<code>[0]int</code> ç­‰é›¶å¤§å°ç±»å‹ï¼š</p><ul><li>æ‰€æœ‰å®ä¾‹å…±äº«åŒä¸€ä¸ªåœ°å€ <code>&amp;zerobase</code></li><li>ä¸åˆ†é…ä»»ä½•å®é™…å†…å­˜</li><li>len å’Œ cap çš„è¯­ä¹‰ä¾ç„¶ä¿æŒ</li></ul><h2 id="å®è·µ">5. å®è·µ</h2><h3 id="é¢„åˆ†é…çš„é‡è¦æ€§">5.1 é¢„åˆ†é…çš„é‡è¦æ€§</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å·®ï¼šå¤šæ¬¡æ‰©å®¹</span></span><br><span class="line"><span class="keyword">var</span> s []<span class="type">int</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++ &#123;</span><br><span class="line">    s = <span class="built_in">append</span>(s, i)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¥½ï¼šä¸€æ¬¡åˆ†é…</span></span><br><span class="line">s := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">0</span>, <span class="number">10000</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++ &#123;</span><br><span class="line">    s = <span class="built_in">append</span>(s, i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ³¨æ„å…±äº«é™·é˜±">5.2 æ³¨æ„å…±äº«é™·é˜±</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">(s []<span class="type">int</span>)</span></span> &#123;</span><br><span class="line">    s = <span class="built_in">append</span>(s, <span class="number">999</span>)  <span class="comment">// å¯èƒ½æ‰©å®¹ï¼Œä¸å½±å“åŸ slice</span></span><br><span class="line">    s[<span class="number">0</span>] = <span class="number">100</span>          <span class="comment">// å¯èƒ½å½±å“åŸ sliceï¼ˆå¦‚æœæœªæ‰©å®¹ï¼‰</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¤§-slice-çš„å­åˆ‡ç‰‡å†…å­˜æ³„æ¼">5.3 å¤§ Slice çš„å­åˆ‡ç‰‡å†…å­˜æ³„æ¼</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é—®é¢˜ï¼šæŒæœ‰æ•´ä¸ªåº•å±‚æ•°ç»„</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">leak</span><span class="params">()</span></span> []<span class="type">byte</span> &#123;</span><br><span class="line">    data := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">1</span>&lt;&lt;<span class="number">20</span>)  <span class="comment">// 1MB</span></span><br><span class="line">    <span class="keyword">return</span> data[:<span class="number">100</span>]             <span class="comment">// åªç”¨ 100 å­—èŠ‚ï¼Œä½†æŒæœ‰ 1MB</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§£å†³ï¼šæ‹·è´æ‰€éœ€æ•°æ®</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">noLeak</span><span class="params">()</span></span> []<span class="type">byte</span> &#123;</span><br><span class="line">    data := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">1</span>&lt;&lt;<span class="number">20</span>)</span><br><span class="line">    result := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">100</span>)</span><br><span class="line">    <span class="built_in">copy</span>(result, data[:<span class="number">100</span>])</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">æœ¬æ–‡ä»ç¬¬ä¸€æ€§åŸç†å‡ºå‘ï¼Œæ·±å…¥æ¢è®¨ slice çš„å®ç°ç»†èŠ‚ï¼ŒåŒ…æ‹¬ slice çš„åº•å±‚ç»“æ„ã€å®ç°åŸç†ã€ä½¿ç”¨åœºæ™¯ç­‰ã€‚</summary>
    
    
    
    <category term="Go" scheme="https://hedon.top/categories/Go/"/>
    
    
    <category term="Go" scheme="https://hedon.top/tags/Go/"/>
    
  </entry>
  
  <entry>
    <title>ä¸‰å¹´å·¥ä½œå¤ç›˜ä¸¨æŠ€æœ¯ç¯‡ï¼šè½¯ä»¶å·¥ç¨‹æ˜¯ä»€ä¹ˆä¸¨ï¼ˆä¸€ï¼‰ç®¡ç†å¤æ‚åº¦</title>
    <link href="https://hedon.top/2025/11/14/first-job-review-01-tech-01-manager-complexity/"/>
    <id>https://hedon.top/2025/11/14/first-job-review-01-tech-01-manager-complexity/</id>
    <published>2025-11-14T13:00:00.000Z</published>
    <updated>2025-11-14T14:12:46.807Z</updated>
    
    <content type="html"><![CDATA[<p>æˆ‘è§‰å¾—å¯ä»¥ç”¨<strong>é“æ³•æœ¯å™¨</strong>æ¥å¯¹å¤æ‚åº¦ç®¡ç†è¿›è¡Œä¸€ä¸ªé‡ç‚¹æ¦‚è¿°ï¼š</p><ul><li><strong>é“ï¼ˆç›®æ ‡ï¼‰</strong>ï¼šç®¡ç†å¤æ‚åº¦</li><li><strong>æ³•ï¼ˆåŸºçŸ³ï¼‰</strong>ï¼šæŠ½è±¡ã€åˆ†æ²»ã€åˆ†å±‚ã€æ¨¡å—åŒ–</li><li><strong>æœ¯ï¼ˆæ–¹æ³•ï¼‰</strong>ï¼šSOLIDåŸåˆ™ã€è®¾è®¡æ¨¡å¼ã€æ¶æ„æ¨¡å¼ã€é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰</li><li><strong>å™¨ï¼ˆå·¥å…·ï¼‰</strong>ï¼šå•å…ƒæµ‹è¯•ã€å¯è§‚æµ‹æ€§</li></ul><h1id="é“ç®¡ç†å¤æ‚åº¦æ˜¯æˆ‘ä»¬çš„ç»ˆæç›®æ ‡">é“ï¼šç®¡ç†å¤æ‚åº¦æ˜¯æˆ‘ä»¬çš„ç»ˆæç›®æ ‡</h1><p>"é“"æ˜¯æˆ‘ä»¬çš„ç»ˆæç›®æ ‡ï¼Œæ˜¯æˆ‘ä»¬å®æ–½è½¯ä»¶å·¥ç¨‹ä¸€åˆ‡çš„ WHYï¼Œ</p><p>åœ¨ä¸‰å¹´çš„å·¥ä½œç»å†ä¸­ï¼Œæˆ‘å¯¹"å±å±±"çš„ç†è§£å¤ªæ·±åˆ»äº†ã€‚æˆ‘äº²æ‰‹ç»´æŠ¤äº†å¤§é‡å‰äººç•™ä¸‹çš„å±å±±ä»£ç ï¼Œä¸åšåˆ†å±‚è®¾è®¡ã€æ¨¡å—åˆ’åˆ†ä¸æ°å½“ã€å…¨å±€å˜é‡åˆ°å¤„é£ã€å‘½åéšä¾¿èµ·ã€æ¦‚å¿µä¸æ˜æ™°ã€‚æˆ‘ä¹Ÿäº²çœ¼è§è¯æˆ‘ç”±æˆ‘ç»æ‰‹çš„ä»£ç æ˜¯å¦‚ä½•ä¸€æ­¥æ­¥å˜æˆå±å±±çš„ï¼Œéœ€æ±‚çš„éšæ„ä¿®æ”¹ã€ä¸ºäº†åº”ä»˜deadlineè€Œä¹ æƒ¯æˆè‡ªç„¶çš„"é¾™å·é£æˆ˜æœ¯"ã€è¿­ä»£æ—¶å¯¹ç°æœ‰å­—æ®µçš„æ¦‚å¿µèƒ¡ä¹±æ‰©å……ã€è§£å†³é—®é¢˜ä¸å¤„ç†æ ¹æºè€Œä¸ºäº†ç‚«æŠ€åœ¨å¤–é¢åŒ…è£…ä¸€å±‚ï¼Œé‡‘ç‰å…¶å¤–è´¥çµ®å…¶ä¸­ã€‚</p><p>è¿™äº›æŠ€æœ¯å€ºï¼Œä½¿å¾—ä»£ç é˜…è¯»éš¾åº¦é£™å‡ï¼ŒåŠŸèƒ½è¿­ä»£è´Ÿæ‹…å·¨å¤§ï¼Œé‡æ„é£é™©éš¾ä»¥ä¼°é‡ï¼Œå¯¹æ–°äººå¾ˆä¸å‹å¥½ã€‚éšç€ç ´çª—æ•ˆåº”çš„ä¸æ–­æ‰©å¤§ï¼Œä¸ºäº†å¿«é€Ÿåº”ä»˜å“ªäº›è«é¡»æœ‰çš„deadlineå’Œ"ç´§æ€¥"éœ€æ±‚ï¼Œé¢†å¯¼ä»¬å’Œåº•å±‚å‘˜å·¥éƒ½ä¹ æƒ¯äºé‡‡å–"é¾™å·é£æˆ˜æœ¯"æ¥å¿«é€Ÿå®Œå…¨éœ€æ±‚ï¼ŒåŠ å‰§äº†æ¶æ€§å¾ªç¯ã€‚æˆªæ­¢åˆ°æˆ‘ç¦»èŒä¹‹å‰ï¼Œè¿™äº›æŠ€æœ¯å€ºå·²ç»å¯¹ä¸šåŠ¡å‘å±•çš„æŠ€æœ¯æ”¯æŒåº¦ã€ç ”å‘æ•ˆç‡å’Œäº§å“è´¨é‡é€ æˆäº†ä¸¥é‡å½±å“äº†ã€‚</p><p>æˆ‘ä¹Ÿè¯•å›¾åšè¿‡ä¸€äº›åŠªåŠ›ï¼Œäº²è‡ªå…¨åŠ›æ¨è¿›äº†<strong>ä»£ç è´¨é‡å»ºè®¾</strong>å’Œ<strong>æœåŠ¡ç›‘æ§å»ºè®¾</strong>ä¸¤å¤§ä¸“é¡¹ï¼Œå¯¹äºæˆ‘ä¸ªäººæ¥è¯´æ”¹å˜æ˜¯å·¨å¤§çš„ï¼Œæˆ‘ä»å·¥ç¨‹è®¤çŸ¥ã€ç¼–ç æ€ç»´ã€ä¸šåŠ¡ç†è§£ç­‰å¤šæ–¹é¢éƒ½æœ‰å·¨å¤§çš„çªç ´ã€‚å¦ç™½è¯´ï¼Œä»å¦ä¸€ä¸ªå±‚é¢æ¥è¯´ï¼Œæˆ‘åº†å¹¸è¿‡è¿™äº›"å±å±±"çš„å­˜åœ¨ï¼Œæˆ‘ä¹Ÿå¾ˆåº†å¹¸è‡ªå·±åœ¨èŒä¸šåˆæœŸå°±æ‰“ä¸‹äº†åšå®çš„åŸºç¡€ï¼Œä¹Ÿè®¤å®šäº†è¦æˆä¸ºä¸€ä½ä¼˜ç§€çš„è½¯ä»¶å·¥ç¨‹å¸ˆçš„ç›®æ ‡ã€‚åªä¸è¿‡ï¼Œåœ¨å†å²é•¿æ²³ä¸­ï¼Œæˆ‘è¿™ä¸¤å¤§ä¸“é¡¹å¯¹äºå›¢é˜Ÿçš„å½±å“ï¼Œå´æ˜¯æ¯æ°´è½¦è–ªï¼ŒèŠèƒœäºæ— ç½¢äº†ã€‚</p><p>æˆ‘ä¸€ç›´åœ¨æ€è€ƒï¼Œä¸ºä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆå¤æ‚åº¦å°±åƒ"ç†µå¢"ä¸€æ ·ä¸å¯é¿å…ï¼Ÿæˆ‘ä»¬ç¨‹åºå‘˜çš„å®¿å‘½ï¼Œéš¾é“å°±æ˜¯ä¸æ–­åœ°åœ¨å±å±±ä¸Šé›•èŠ±å—ï¼Ÿè‹¥å°†æ¥æˆ‘æœ‰æœºä¼šæˆä¸ºä¸€ä½é¢†å¯¼è€…ï¼Œæˆ‘å¦‚ä½•é¿å…ä¸Šè¿°é—®é¢˜çš„å‘ç”Ÿï¼Ÿ</p><p>Fred Brooksåœ¨ã€Šäººæœˆç¥è¯ã€‹ä¸­æ—©å·²æ–­è¨€ï¼šè½¯ä»¶çš„å›°éš¾ï¼Œåœ¨äºå…¶<strong>å›ºæœ‰çš„å¤æ‚åº¦(Essential Complexity)</strong>ã€‚</p><ul><li><strong>å¤æ‚åº¦ä¸æ˜¯éš¾</strong>ï¼šä¸æ˜¯æŒ‡"è¿™ä¸ªç®—æ³•å¾ˆéš¾"ï¼Œè€Œæ˜¯æŒ‡"<strong>ç³»ç»Ÿä¸­ç»„ä»¶é—´ä¾èµ–å…³ç³»çš„æ•°é‡</strong>"ã€‚</li><li><strong>å¤æ‚åº¦æ˜¯éçº¿æ€§å¢é•¿çš„</strong>ï¼šä¸€ä¸ª 100ä¸ªæ¨¡å—çš„ç³»ç»Ÿï¼Œå…¶æ½œåœ¨çš„"ä¾èµ–"å’Œ"çŠ¶æ€ç»„åˆ"æ˜¯å¤©æ–‡æ•°å­—ã€‚å½“è®¤çŸ¥è´Ÿè·è¶…è¿‡äººè„‘ï¼ˆæˆ–å›¢é˜Ÿï¼‰çš„ä¸Šé™æ—¶ï¼Œç³»ç»Ÿå°±å¤±æ§äº†ã€‚</li><li><strong>å¤æ‚åº¦æ˜¯ä¸‡æ¶ä¹‹æº</strong>ï¼š<ul><li>ä½ ä¿®å¤ä¸€ä¸ª Bugï¼Œå´å¼•å‘äº†ä¸‰ä¸ªæ–° Bugï¼Ÿâ€”â€”<strong>å¤æ‚åº¦å¤±æ§</strong>ã€‚</li><li>ä½ æ— æ³•å®‰å…¨åœ°æ·»åŠ ä¸€ä¸ªæ–°åŠŸèƒ½ï¼Ÿâ€”â€” <strong>å¤æ‚åº¦å¤±æ§</strong>ã€‚</li><li>ä½ ä¸æ•¢é‡æ„ï¼Ÿâ€”â€” <strong>å¤æ‚åº¦å¤±æ§</strong>ã€‚</li></ul></li></ul><p>æ‰€ä»¥æˆ‘è§‰å¾—ä¸ç®¡æ˜¯ä»€ä¹ˆæ ·çš„æŠ€æœ¯æ ˆã€è®¾è®¡åŸåˆ™ã€ç¼–ç¨‹æ€ç»´ã€æ¶æ„æ¨¡å¼ï¼Œæˆ–æ˜¯é‚£ä¹ˆå¤šçš„è½¯ä»¶å·¥ç¨‹ç®¡ç†æ–¹æ³•è®ºï¼Œæ¯”å¦‚æ•æ·å¼€å‘ã€æé™ç¼–ç¨‹ï¼Œæˆ–æ˜¯ç°åœ¨çš„ç»ˆæå¤§æ€å™¨é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼Œéƒ½æ˜¯ä¸ºäº†ç®¡ç†å¤æ‚åº¦ã€‚å› æ­¤ï¼Œæœ¬ç¯‡åç»­çš„æ‰€æœ‰å†…å®¹éƒ½æ˜¯ä¸ºäº†æœåŠ¡äº"<strong>ç®¡ç†å¤æ‚åº¦</strong>"è¿™å”¯ä¸€ä¸”æ ¹æœ¬çš„é“ã€‚</p><h1 id="æ³•ç®¡ç†å¤æ‚åº¦çš„å››å¤§æ ¸å¿ƒåŸåˆ™">æ³•ï¼šç®¡ç†å¤æ‚åº¦çš„å››å¤§æ ¸å¿ƒåŸåˆ™</h1><p>æ—¢ç„¶æˆ‘ä»¬æ— æ³•æ¶ˆç­å¤æ‚åº¦ï¼Œæˆ‘ä»¬å°±åªèƒ½<strong>ç®¡ç†</strong>å®ƒã€‚åœ¨ä¼—å¤šç¼–ç¨‹æ€æƒ³ã€è®¾è®¡æ¨¡å¼ã€æ¶æ„æ¨¡å¼ä¸­ï¼Œæˆ‘è§‰å¾—å…¶ä¸­æœ€æœ€æœ€æ ¹æœ¬ã€ç”Ÿå‘½åŠ›æœ€æœ€æŒä¹…ã€æœ€æœ‰å¯èƒ½ä»¥ä¸å˜åº”ä¸‡å˜çš„æ˜¯ä»¥ä¸‹4 ç‚¹ï¼š</p><ul><li><strong>æŠ½è±¡</strong>ï¼šéšè—å®ç°ç»†èŠ‚ï¼Œåªæš´éœ²æ„å›¾å¥‘çº¦ã€‚</li><li><strong>åˆ†æ²»</strong>ï¼šå°†ä¸€ä¸ªå¤§é—®é¢˜ï¼Œæ‹†è§£ä¸ºä¸€å †å¯ç‹¬ç«‹è§£å†³çš„å°é—®é¢˜ã€‚</li><li><strong>åˆ†å±‚</strong>ï¼šè§„å®šæ¨¡å—é—´çš„ä¾èµ–å…³ç³»ï¼Œä¸”ä¾èµ–å¿…é¡»æ˜¯å•å‘çš„ã€‚</li><li><strong>æ¨¡å—åŒ–</strong>ï¼šé«˜å†…èš (High Cohesion)ï¼Œä½è€¦åˆ (LowCoupling)ã€‚</li></ul><h2 id="æŠ½è±¡">æŠ½è±¡</h2><h3 id="æŠ½è±¡çš„ä½œç”¨">æŠ½è±¡çš„ä½œç”¨</h3><p>æˆ‘å‘ç°ï¼æŠ½è±¡è¿™ä¸ªè¯æ˜¯çœŸçš„æŠ½è±¡ï¼æˆ‘ä»¬ç»å¸¸åœ¨èŠæŠ½è±¡ï¼Œå½“å‘ç°åŸæœ‰ä»£ç ä¸å¥½è¿­ä»£çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šè¯´"è¿™ä¸ªæŠ½è±¡å¾—ä¸å¤Ÿå¥½"ï¼Œå½“çœ‹åˆ°ä»£ç æ¯”è¾ƒæ··ä¹±ã€é‡å¤è¾ƒå¤šæ—¶ï¼Œæˆ‘ä»¬ä¼šè¯´"è¿™ä¸ªæœ‰ç©ºå¯ä»¥æŠ½è±¡ä¸€ä¸‹"ï¼Œå½“ç„¶æœ‰æ—¶å€™ä¹Ÿä¼šåæ§½"è¿™ä¸ªä»£ç å†™å¾—çœŸæŠ½è±¡"ï¼Œæˆ–è€…"è¿™æœ‰ç‚¹è¿‡åº¦æŠ½è±¡äº†"ã€‚</p><p>æˆ‘æ—¶å¸¸æƒ³ä¸æ˜ç™½å½“æˆ‘ä»¬åœ¨è°ˆæŠ½è±¡çš„æ—¶å€™ï¼Œæˆ‘ä»¬åˆ°åº•åœ¨è¯´äº›ä»€ä¹ˆï¼Ÿä»€ä¹ˆæ˜¯æŠ½è±¡ï¼Ÿæ€ä¹ˆåˆ¤æ–­è¦ä¸è¦æŠ½è±¡ï¼Ÿæ€ä¹ˆåšæŠ½è±¡ï¼Ÿè¦æŠ½è±¡çš„ä¸œè¥¿åˆ°åº•æ˜¯ä»€ä¹ˆï¼ŸæŠ½è±¡åˆ°ä»€ä¹ˆç¨‹åº¦æ˜¯æ°å½“çš„ï¼Ÿæ€ä¹ˆè¯„åˆ¤ä¸€ä¸ªæŠ½è±¡è¡Œä¸ºçš„å¥½åï¼Ÿå¦‚ä½•é¿å…è¿‡åº¦æŠ½è±¡ï¼Ÿå¦‚ä½•åœ¨ä¸æ–­å˜åŒ–çš„ä¸šåŠ¡éœ€æ±‚ä¸­åšä¸€ä¸ªç¨³å®šçš„æŠ½è±¡ï¼Ÿ</p><p>ç”¨ä¸€å¥è¯å½¢å®¹å°±æ˜¯ï¼š<font color="orange"><u>æˆ‘ä»¬ç»å¸¸åœ¨è°ˆæŠ½è±¡ï¼Œå®ƒåœ¨è½¯ä»¶å·¥ç¨‹ä¸­æ— å¤„ä¸åœ¨ï¼Œä½†åˆæå…¶"ä¸»è§‚"å’Œ"æš§æ˜§"ã€‚</u></font></p><p>ä¸ºäº†æ›´é è¿‘ä¸Šè¿°é—®é¢˜çš„ç­”æ¡ˆï¼Œæˆ–è®¸æˆ‘ä»¬åº”è¯¥é€€ä¸€æ­¥ï¼Œå›å½’å®ƒçš„ç¬¬ä¸€æ€§åŸç†ï¼š<strong>å®ƒä¸æ˜¯ä¸€ç§ä»£ç æŠ€å·§ï¼Œè€Œæ˜¯ä¸€ç§ç®¡ç†å¤æ‚åº¦çš„æ ¸å¿ƒæˆ˜ç•¥ã€‚</strong></p><p>æœ¬ç¯‡æˆ‘ä»¬åœ¨è°ˆç®¡ç†å¤æ‚åº¦çš„é—®é¢˜ï¼Œä½†æ˜¯äººè„‘çš„è®¤çŸ¥è´Ÿè·æ˜¯æœ‰é™çš„ï¼ˆç±³å‹’å®šå¾‹è¯´æˆ‘ä»¬åªèƒ½åŒæ—¶å¤„ç†7Â±2 ä¸ªä¿¡æ¯å—ï¼‰ã€‚ä¸€ä¸ªæ‹¥æœ‰ 100ä¸ªæ¨¡å—çš„ç³»ç»Ÿï¼Œå…¶æ½œåœ¨çš„ä¾èµ–å…³ç³»å’ŒçŠ¶æ€ç»„åˆæ˜¯å¤©æ–‡æ•°å­—ï¼Œè¿œè¶…äººè„‘ä¸Šé™ã€‚</p><p>è€ŒæŠ½è±¡æ˜¯æˆ‘ä»¬å¯¹æŠ—è®¤çŸ¥è´Ÿè·çš„ç¬¬ä¸€æ­¦å™¨ã€‚æ—¢ç„¶æˆ‘ä»¬æ²¡æ³•åŒæ—¶å¤„ç†é‚£ä¹ˆå¤šçš„ä¿¡æ¯å—ï¼Œé‚£å°±æƒ³åŠæ³•è®©è‡ªå·±åªéœ€è¦åŒæ—¶å¤„ç†å°‘æ•°ä¿¡æ¯å—ã€‚æ‰€ä»¥æŠ½è±¡çš„æœ¬è´¨æ˜¯å°±æ˜¯<strong>ä¿¡æ¯éšè—</strong>ã€‚å®ƒå°†ä¸€ä¸ªå¤æ‚ç³»ç»Ÿï¼Œæ‹†åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p><ul><li><strong>å¥‘çº¦æˆ– APIï¼š</strong>è¿™æ˜¯<strong>What</strong>ï¼Œå³å®ƒèƒ½åšä»€ä¹ˆã€‚å®ƒæ˜¯ç®€å•çš„ã€ç¨³å®šçš„ã€æ˜“äºç†è§£çš„ã€‚</li><li><strong>å®ç°ï¼š</strong> è¿™æ˜¯<strong>How</strong>ï¼Œå³å®ƒå¦‚ä½•åšçš„ã€‚å®ƒæ˜¯å¤æ‚çš„ã€æ˜“å˜çš„ã€è¢«éšè—çš„ã€‚</li></ul><p>å› æ­¤ï¼Œä¸€ä¸ªå¥½çš„æŠ½è±¡ï¼Œå°±æ˜¯ä¸€å¥—<strong>ç®€å•æ˜“æ‡‚çš„å¥‘çº¦</strong>ï¼›è€Œä¸€ä¸ªåçš„æŠ½è±¡ï¼Œå°±æ˜¯ä¸€å¥—<strong>è®©äººçŒœä¸é€çš„å¥‘çº¦</strong>ã€‚</p><h3 id="æŠ½è±¡çš„éš¾ç‚¹">æŠ½è±¡çš„éš¾ç‚¹</h3><p>åœ¨å®é™…ç¼–ç è¿‡ç¨‹ä¸­ï¼Œæœ€å¸¸è§çš„æŠ½è±¡è¡Œä¸ºå°±æ˜¯å®šä¹‰æ¥å£ã€‚ä½†æ˜¯æˆ‘ä»¬ç»å¸¸ä¼šå‘ç°å¾ˆå¤šæ¥å£çš„å®šä¹‰æ˜¯æ¯«æ— æ„ä¹‰ç”šè‡³æ˜¯è´Ÿä½œç”¨çš„ã€‚æˆ‘æ€»ç»“äº†è¿‡å»3 å¹´å·¥ä½œä¸­å­˜åœ¨çš„å…³äºæ¥å£å®šä¹‰é—®é¢˜æœ€å¤§çš„ 3 ä¸ªç‚¹ï¼š</p><ol type="1"><li><strong>æ¯«æ— æ¥å£å®šä¹‰</strong>ï¼šèµ·åˆåœ¨æˆ‘ä»¬çš„ WebæœåŠ¡ä¸­ï¼Œæ²¡æœ‰ä»»ä½•çš„æ¥å£å®šä¹‰ï¼Œç”šè‡³éƒ½åªæœ‰ä¸¤å±‚æ¶æ„ï¼Œåªèƒ½é¢å‘å®ç°ç¼–ç¨‹ï¼Œå„ä¸ªæ¨¡å—è€¦åˆä¸¥é‡ï¼Œå†™ä»£ç ç‰µä¸€å‘è€ŒåŠ¨å…¨èº«ï¼Œåœ¨ä»£ç ç†è§£ã€æ¨¡å—åˆ’åˆ†ã€èŒè´£æ˜æ™°ã€ç»„ä»¶å‡çº§ã€ä»£ç å¤ç”¨ã€æ¶æ„é‡æ„ã€å•å…ƒæµ‹è¯•ã€é—®é¢˜æ’æŸ¥å’Œä¸šåŠ¡è¿­ä»£ç­‰å„ä¸ªæ–¹é¢éƒ½å¸¦æ¥äº†å±‚å±‚é˜»åŠ›ã€‚</li><li><strong>å•ä¸€å®ç°å¤§æ¥å£</strong>ï¼šåœ¨æˆ‘ä»¬çš„è€åŒ¹é…æœä¸­ï¼Œå€’æ˜¯å®šä¹‰äº†ä¸€äº›æ¥å£ï¼Œä½†æ˜¯è¿™äº›æ¥å£éƒ½éå¸¸å¤§ï¼ŒåŠ¨è¾„ä¸‰å››åä¸ªæ–¹æ³•ï¼Œè€Œä¸”éƒ½åªæœ‰ä¸€ç§å®ç°ã€‚è¿™ç§æ¥å£å®šä¹‰ï¼Œé™¤äº†ç»™é˜…è¯»ä»£ç å¸¦æ¥å¤šä¸€å±‚è·³è½¬çš„å¿ƒæ™ºè´Ÿæ‹…ä¹‹å¤–ï¼Œæ¯«æ— æ„ä¹‰ã€‚</li><li><strong>æ¥å£ç¹å¤šä¸”èŒè´£ä¸åŒ¹é…</strong>ï¼šåœ¨æˆ‘ä»¬çš„æ–°åŒ¹é…æœä¸­ï¼Œå€’æ˜¯å¸å–äº†è¿‡å¾€ä¸å°‘çš„æ•™è®­ï¼Œä½†æ˜¯è¿‡çŠ¹ä¸åŠã€‚æˆ‘ä»¬å®šä¹‰äº†ä¸€å¤§å †æ¥å£ï¼Œå¼•å…¥äº†ä¸€å †çš„è®¾è®¡æ¨¡å¼å’Œç¼–ç æŠ€å·§ï¼Œä½¿å¾—ä»£ç æå…¶æŠ½è±¡ï¼Œé˜…è¯»éš¾åº¦å¾ˆé«˜ï¼Œç»å¸¸ä¸ºäº†ç†æ¸…ä¸€ä¸ªé€»è¾‘è¦è·³è½¬åå‡ æ¬¡ï¼Œçœ‹äº†åé¢å¿˜äº†å‰é¢ã€‚è€Œä¸”å¾ˆå¤šæ¥å£å®šä¹‰çš„æ–¹æ³•å’Œæ¥å£æœ¬èº«è¯¥æœ‰çš„èŒè´£æ˜¯ä¸åŒ¹é…çš„ï¼Œè¿™å¸¦æ¥äº†éå¸¸å¤§çš„å›°æ‰°ã€‚è¿™ç§æˆ‘ç»Ÿä¸€ç§°ä¸ºç‚«æŠ€ã€‚æ¯”å¦‚æ‰€ä»¥å¤–è¡¨è™½ç„¶çœ‹èµ·æ¥ç‰›é€¼ï¼Œä½†å®é™…ä¸Šä»£ç å¯è¯»æ€§æå·®ã€‚</li></ol><p>è‡³ä»Šæˆ‘ä¾ç„¶è§‰å¾—åšå¥½æ¥å£å®šä¹‰çœŸæ˜¯ä¸€ä»¶ä¸å®¹æ˜“çš„äº‹æƒ…ï¼Œè€Œä¸”æƒ³ä¸€æ¬¡å®šä¹‰ä¸€ä¸ªå¥½çš„æ¥å£ï¼Œä¹Ÿå‡ ä¹æ˜¯ä¸ç°å®çš„ã€‚ä¸è¿‡è‡³å°‘ç°åœ¨æˆ‘ä»¬å¯ä»¥å¾—å‡ºä¸€ä¸ªç»“è®ºï¼š</p><blockquote><p>[!IMPORTANT]</p><p>æŠ½è±¡æ˜¯æœ‰<strong>æˆæœ¬</strong>çš„ï¼šå®ƒå¢åŠ äº†<strong>é—´æ¥æ€§</strong>ï¼Œä»£ç ä¸å†æ˜¯å¹³é“ºç›´å™çš„ï¼Œéœ€è¦å¤šä¸€æ¬¡è·³è½¬ï¼Œè¿™æœ¬èº«ä¹Ÿä¼šå¢åŠ è®¤çŸ¥è´Ÿè·ã€‚</p><p><strong>å¦‚æœæ”¶ç›Š &lt;æˆæœ¬ï¼Œè¿™å°±æ˜¯è¿‡åº¦æŠ½è±¡ã€‚</strong>è¿‡åº¦æŠ½è±¡çš„æœ¬è´¨æ˜¯ï¼š<strong>ä½ ä¸ºä½ "çŒœæƒ³"çš„ã€ä½†"æ°¸è¿œä¸ä¼šå‘ç”Ÿ"çš„"å˜åŒ–"ï¼Œæå‰æ”¯ä»˜äº†"æŠ½è±¡çš„æˆæœ¬"ã€‚</strong></p></blockquote><h3 id="æŠ½è±¡çš„æœ¬è´¨">æŠ½è±¡çš„æœ¬è´¨</h3><p>ç°åœ¨éœ€è¦å›åˆ°ä¸€ä¸ªæœ€å…³é”®çš„é—®é¢˜ï¼Œå½“æˆ‘ä»¬åœ¨è°ˆæŠ½è±¡çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç©¶ç«Ÿåœ¨"æŠ½"ä»€ä¹ˆï¼Ÿå¦‚æœä¸çŸ¥é“"æŠ½"ä»€ä¹ˆï¼Œæˆ‘ä»¬å°±ä¼š"çæŠ½"ã€‚</p><blockquote><p>[!IMPORTANT]</p><p>ç­”æ¡ˆæ˜¯ï¼š<font color="red"><u>æˆ‘ä»¬æŠ½è±¡çš„ä¸æ˜¯"ä»£ç "ï¼Œæˆ‘ä»¬æŠ½è±¡çš„æ˜¯"å˜åŒ–"ã€‚</u></font>è½¯ä»¶çš„å®¿å‘½å°±æ˜¯ä¸æ–­å˜åŒ–ã€‚è€ŒæŠ½è±¡çš„<strong>ç›®çš„</strong>ï¼Œå°±æ˜¯<strong>éš”ç¦»å˜åŒ–</strong>â€”â€”æŠŠç³»ç»Ÿä¸­<strong>æ˜“å˜çš„éƒ¨åˆ†</strong>å’Œ<strong>ä¸å˜çš„éƒ¨åˆ†</strong>éš”ç¦»å¼€ï¼Œåœ¨å®ƒä»¬ä¹‹é—´å»ºç«‹ä¸€é“é˜²ç«å¢™ã€‚</p></blockquote><p>å…³äºå˜åŒ–ï¼Œæˆ‘è§‰å¾—å¯ä»¥ä» 2 ä¸ªæ–¹é¢è¿›è¡Œæ€è€ƒï¼š</p><ul><li><strong>æŠ€æœ¯æŠ½è±¡</strong>ï¼šæ˜¯<strong>ä¸å˜çš„ä¸šåŠ¡</strong> vs<strong>æ˜“å˜çš„æŠ€æœ¯</strong>ã€‚</li><li><strong>ä¸šåŠ¡æŠ½è±¡</strong>ï¼šæ˜¯<strong>ä¸å˜çš„ä¸šåŠ¡æœ¬è´¨</strong> vs<strong>æ˜“å˜çš„ä¸šåŠ¡æµç¨‹</strong>ã€‚</li></ul><h3 id="æŠ€æœ¯å±‚é¢çš„æŠ½è±¡">æŠ€æœ¯å±‚é¢çš„æŠ½è±¡</h3><p>è¿™é‡Œæˆ‘æƒ³ä»¥ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆServiceï¼‰å’ŒæŒä¹…åŒ–å±‚ï¼ˆRepositoryï¼‰ä¹‹é—´çš„äº¤äº’æ¥å±•å¼€è°ˆä¸€è°ˆã€‚</p><p>æ¯”å¦‚è¯´æˆ‘ä»¬æœ‰ä¸€ä¸ªè®¢å•æœåŠ¡OrderServiceï¼Œè¿™ä¸ªæ—¶å€™å¾ˆå¤šçš„æ•™å­¦è§†é¢‘éƒ½ä¼šè¯´ï¼Œé‚£æˆ‘ä»¬è¦ç»™æŒä¹…åŒ–å±‚å®šä¹‰ä¸€ä¸ªOrderRepositoryï¼Œè¿™æ ·åé¢æˆ‘ä»¬ä¸ç®¡æ˜¯ä½¿ç”¨ MySQLã€è¿˜æ˜¯æ¢æˆ Mongoã€Oracleéƒ½ä¸ä¼šå½±å“åˆ° Serviceå±‚çš„é€»è¾‘ã€‚æˆ‘ä¸ªäººè§‰å¾—å¦‚æœæ˜¯ä»¥è¿™æ ·çš„ç›®çš„å»åšçš„æ¥å£å®šä¹‰ï¼Œç¦»çœŸæ­£çš„æŠ½è±¡è¿˜æ˜¯æœ‰ä¸å°‘è·ç¦»çš„ã€‚äº‹å®ä¸Šï¼Œåœ¨ä¸€ä¸ªç³»ç»Ÿä¸­ï¼Œä½ å‡ ä¹ä¸ä¼šæ›´æ¢æ•°æ®åº“çš„ç±»å‹ï¼Œå› ä¸ºå®ƒçš„å½±å“é¢å’Œé£é™©å®åœ¨å¤ªå¤§äº†ï¼Œå³ä¾¿æœ‰ï¼Œé¢‘ç‡ä¹Ÿæ˜¯æä½çš„ï¼Œä¸ºäº†ä¸€ä¸ªæå¤§æ¦‚ç‡ä¸å‘ç”Ÿçš„"å˜åŒ–"æå‰æ”¯ä»˜äº†é•¿æ—¶é—´çš„"æŠ½è±¡æˆæœ¬"ï¼Œæ˜¯ä¸åˆ’ç®—çš„ã€‚</p><p>é‚£è¿˜æœ‰æ²¡æœ‰å¿…è¦å®šä¹‰ Repositoryæ¥å£å‘¢ï¼Ÿå½“ç„¶æ˜¯æœ‰å¿…è¦çš„ï¼Œä¸è¿‡å®ƒçš„å‡ºå‘ç‚¹åº”è¯¥æ˜¯ä¸ºäº†åº”ä»˜é‚£äº›æ—¥å¸¸ç ”å‘è¿‡ç¨‹ä¸­ç»å¸¸ä¼šç¢°åˆ°çš„"å˜åŒ–"ï¼Œæ¯”å¦‚ï¼š</p><ul><li><strong>ä¸ºäº†å¯æµ‹è¯•æ€§</strong>ï¼šå¦‚æœä½ ä¸ä¸º Repositoryå±‚å®šä¹‰æ¥å£ï¼Œé‚£ä½ æµ‹è¯• Serviceå±‚çš„æ—¶å€™ï¼Œå°±ä¸å¾—ä¸è¿æ¥åˆ°æ•°æ®åº“ï¼Œå¯æµ‹è¯•æ€§æå·®ã€‚</li><li><strong>ä¸ºäº†ä¸æ±¡æŸ“æ ¸å¿ƒä¸šåŠ¡</strong>ï¼šæ•°æ®åº“ä¸å¸¸å˜ï¼Œä½†æ˜¯è®¿é—®æ•°æ®åº“çš„æ–¹å¼å´æ˜¯æœ‰å¯èƒ½å˜åŒ–çš„ï¼ŒRepositoryå¯ä»¥ä¸º Service æä¾›ä¸€ä¸ªå¹²å‡€ç¨³å®šçš„æ•°æ®è®¿é—®å¥‘çº¦ï¼Œå±è”½æ‰æ˜“å˜åŒ–çš„ç»†èŠ‚ã€‚</li><li><strong>ä¸ºäº†å¯æ§çš„å¤–éƒ¨ä¾èµ–</strong>ï¼šå¦‚æœæˆ‘ä»¬ä¾èµ–çš„ä¸æ˜¯æ•°æ®åº“ï¼Œè€Œæ˜¯ç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œæ¯”å¦‚è¯´çŸ­ä¿¡APIæœåŠ¡ï¼Œé‚£ä¿®æ”¹ç¬¬ä¸‰æ–¹æœåŠ¡çš„å¯èƒ½æ€§ä¹Ÿå°±å¤§å¤§æå‡äº†ï¼Œä¸åŒå‚å•†æˆ–æ˜¯åŒä¸€å‚å•†çš„ä¸åŒç‰ˆæœ¬API æ‰€éœ€è¦çš„å‚æ•°ã€è¿”å›å€¼éƒ½å¯èƒ½æ˜¯ä¸ä¸€æ ·çš„ã€‚</li></ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¸¾ 3 ä¸ªä¾‹å­æ¥åˆ†åˆ«é˜è¿°ä¸€ä¸‹ã€‚</p><p>é¦–å…ˆæ˜¯ä¸ºäº†å¯æµ‹è¯•æ€§è€ŒæŠ½è±¡ï¼Œè¿™æ˜¯æŠ½è±¡åœ¨å·¥ç¨‹å®è·µä¸­<strong>æœ€åˆšéœ€ã€æœ€ä¸å¯è¾©é©³</strong>çš„ç†ç”±ã€‚å‡å¦‚è¯´æˆ‘ä»¬æ¥å£äº†ä¸€ä¸ªOrderServiceï¼Œå®ƒæ²¡æœ‰ä»»ä½•çš„æŠ½è±¡ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åä¾‹ï¼šæ²¡æœ‰æŠ½è±¡ï¼Œ&quot;ä¸šåŠ¡é€»è¾‘&quot; å’Œ &quot;æŠ€æœ¯å®ç°&quot; ç„Šæ­»</span></span><br><span class="line"><span class="keyword">type</span> OrderService <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// æ²¡æœ‰æ¥å£ï¼Œç›´æ¥ä¾èµ– &quot;å…·ä½“çš„&quot; æ•°æ®åº“è¿æ¥</span></span><br><span class="line">    db *gorm.DB</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *OrderService)</span></span> CreateOrder(order *Order) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 1. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ (æ¯”å¦‚æ£€æŸ¥åº“å­˜ã€è®¡ç®—ä»·æ ¼)</span></span><br><span class="line">    <span class="keyword">if</span> order.Price &lt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> errors.New(<span class="string">&quot;ä»·æ ¼é”™è¯¯&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. æŠ€æœ¯å®ç°é€»è¾‘ (ç¡¬ç¼–ç )</span></span><br><span class="line">    <span class="comment">// ä¸šåŠ¡é€»è¾‘å’Œ GORM çš„ API &quot;ç„Šæ­»&quot; åœ¨ä¸€èµ·</span></span><br><span class="line">    <span class="keyword">if</span> err := s.db.Create(order).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ ¹æœ¬æ— æ³•ä¸º <code>CreateOrder</code>æ–¹æ³•å†™å•å…ƒæµ‹è¯•ã€‚ä½ å†™çš„ä»»ä½•æµ‹è¯•ï¼Œéƒ½ä¼š<strong>çœŸçš„</strong>å»<code>s.db.Create</code>ï¼Œå®ƒä¼š<strong>çœŸçš„</strong>å°è¯•è¿æ¥MySQLã€‚è¿™æ˜¯ä¸€ä¸ªé›†æˆæµ‹è¯•ï¼Œå®ƒæ…¢ã€ä¾èµ–ç¯å¢ƒã€è€Œä¸”æå…¶è„†å¼±ã€‚ä½ ä¹Ÿæ— æ³•å•ç‹¬æµ‹è¯•<code>if order.Price &lt; 0</code> è¿™è¡Œæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ã€‚</p><p>é’ˆå¯¹è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬åšçš„æŠ½è±¡ï¼Œå°±æ˜¯è¦æŠŠé‚£ä¸ªæ˜“å˜çš„ <code>s.db</code>ä»å…·ä½“å®ç°<strong>æŠ½è±¡</strong>ä¸ºå¥‘çº¦ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ­£ä¾‹ï¼šæŠ½è±¡å‡º &quot;Repository&quot; å¥‘çº¦</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. å®šä¹‰ &quot;å¥‘çº¦&quot; (What)</span></span><br><span class="line"><span class="keyword">type</span> OrderRepository <span class="keyword">interface</span> &#123;</span><br><span class="line">    Save(order *Order) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. &quot;ä¸å˜&quot; çš„ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line"><span class="keyword">type</span> OrderService <span class="keyword">struct</span> &#123;</span><br><span class="line">    repo OrderRepository <span class="comment">// &lt;-- ä¾èµ– &quot;å¥‘çº¦&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *OrderService)</span></span> CreateOrder(order *Order) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 1. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ (100% çº¯ç²¹)</span></span><br><span class="line">    <span class="keyword">if</span> order.Price &lt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> errors.New(<span class="string">&quot;ä»·æ ¼é”™è¯¯&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. è°ƒç”¨ &quot;å¥‘çº¦&quot;ï¼Œä¸å…³å¿ƒ &quot;å®ç°&quot;</span></span><br><span class="line">    <span class="keyword">return</span> s.repo.Save(order)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬çš„æ”¶ç›Šæ˜¯ 100% å¯ä»¥å…‘ç°çš„ï¼Œå³ <code>OrderService</code>ç°åœ¨<strong>100% å¯è¢«å•å…ƒæµ‹è¯•</strong>ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// order_service_test.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestCreateOrder_PriceError</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 1. å‡†å¤‡ä¸€ä¸ª &quot;å‡çš„å®ç°&quot; (Mock)</span></span><br><span class="line">    mockRepo := <span class="built_in">new</span>(MockOrderRepo)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. æ³¨å…¥ &quot;å‡çš„å®ç°&quot;</span></span><br><span class="line">    service := &amp;OrderService&#123;repo: mockRepo&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 100% ç‹¬ç«‹åœ°æµ‹è¯• &quot;ä¸šåŠ¡é€»è¾‘&quot;</span></span><br><span class="line">    err := service.CreateOrder(&amp;Order&#123;Price: <span class="number">-100</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. æ–­è¨€</span></span><br><span class="line">    assert.Error(t, err, <span class="string">&quot;ä»·æ ¼é”™è¯¯&quot;</span>)</span><br><span class="line">    <span class="comment">// (mockRepo çš„ Save æ–¹æ³•æ ¹æœ¬ä¸ä¼šè¢«è°ƒç”¨)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ˜¯ä¸ºäº†ä¸æ±¡æŸ“æ ¸å¿ƒä¸šåŠ¡è€ŒæŠ½è±¡ï¼Œå‡å¦‚æˆ‘ä»¬çš„<code>OrderService</code> V1 è¿è¡Œè‰¯å¥½ã€‚è€æ¿è¯´ï¼šV1å¤ªæ…¢äº†ï¼Œç»™åˆ›å»ºè®¢å•åŠ ä¸€å±‚ Redis ç¼“å­˜ï¼</p><p>å¦‚æœæ²¡æœ‰æŠ½è±¡ï¼Œé‚£ä½ ä¼šè¢«è¿«å…¥ä¾µ <code>OrderService</code>çš„å®ç°ç»†èŠ‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åä¾‹ï¼šä¸šåŠ¡é€»è¾‘è¢« &quot;åŸºç¡€è®¾æ–½&quot; æ±¡æŸ“</span></span><br><span class="line"><span class="keyword">type</span> OrderService <span class="keyword">struct</span> &#123;</span><br><span class="line">    db    *gorm.DB</span><br><span class="line">    redis *redis.Client <span class="comment">// &lt;-- å¼•å…¥æ–°çš„ &quot;å®ç°&quot; ä¾èµ–</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *OrderService)</span></span> CreateOrder(order *Order) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> order.Price &lt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> errors.New(<span class="string">&quot;ä»·æ ¼é”™è¯¯&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &quot;ä¸šåŠ¡é€»è¾‘&quot; å’Œ &quot;åŸºç¡€è®¾æ–½é€»è¾‘&quot; åƒæ„å¤§åˆ©é¢ä¸€æ · &quot;è€¦åˆ&quot;</span></span><br><span class="line">    <span class="keyword">if</span> err := s.db.Create(order).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &quot;è„æ´»ç´¯æ´»&quot; æ··äº†è¿›æ¥</span></span><br><span class="line">    s.redis.Set(<span class="string">&quot;cache_key_for_orders&quot;</span>, order)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å™©æ¢¦æ˜¯ä»€ä¹ˆï¼š</p><ol type="1"><li><strong>èŒè´£æ··ä¹±ï¼š</strong> <code>OrderService</code>ä¸å†çº¯ç²¹ï¼Œå®ƒç°åœ¨<strong>åŒæ—¶</strong>å…³å¿ƒ"ä¸šåŠ¡è§„åˆ™"ã€"MySQLå†™å…¥"å’Œ"Redis ç¼“å­˜"ã€‚</li><li><strong>æµ‹è¯•ç¾éš¾ï¼š</strong>ä½ çš„å•å…ƒæµ‹è¯•ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ç°åœ¨<strong>åˆ</strong>éœ€è¦ Mock<code>redis.Client</code> äº†ã€‚</li><li><strong>ä¸‹ä¸€ä¸ªå™©æ¢¦ï¼š</strong> ä¸‹å‘¨è€æ¿è¯´å†åŠ ä¸€ä¸ª Kafkaæ¶ˆæ¯ï¼Œé€šçŸ¥å±¥çº¦â€™ä¸­å°ï¼Œä½ æ˜¯ä¸æ˜¯è¦åœ¨è¿™ä¸ªå‡½æ•°é‡Œå†åŠ <code>kafka.Producer</code>ï¼Ÿ</li></ol><p>æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆæ˜¯ <code>OrderService</code><strong>ä¸€è¡Œä»£ç éƒ½ä¸ç”¨æ”¹</strong>ã€‚å®ƒåªè®¤è¯† <code>OrderRepository</code>è¿™ä¸ªå¥‘çº¦ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ­£ä¾‹ï¼šæˆ‘ä»¬ &quot;å®ç°&quot; ä¸€ä¸ªæ–°çš„ &quot;How&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. æ–°çš„ &quot;å®ç°&quot;ï¼Œå®ƒ &quot;ç»„åˆ&quot; äº†è€çš„ &quot;å®ç°&quot;</span></span><br><span class="line"><span class="keyword">type</span> CachedOrderRepo <span class="keyword">struct</span> &#123;</span><br><span class="line">    nextRepo OrderRepository <span class="comment">// &quot;ä¸‹ä¸€å±‚&quot; (e.g., MySQLRepo)</span></span><br><span class="line">    redis    *redis.Client</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. CachedOrderRepo åŒæ ·å®ç°äº† &quot;å¥‘çº¦&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *CachedOrderRepo)</span></span> Save(order *Order) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// &quot;è„æ´»ç´¯æ´»&quot; (åŸºç¡€è®¾æ–½é€»è¾‘) è¢« &quot;å°è£…&quot; åœ¨è¿™é‡Œ</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. å…ˆè°ƒç”¨ &quot;ä¸‹ä¸€å±‚&quot;</span></span><br><span class="line">    <span class="keyword">if</span> err := c.nextRepo.Save(order); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2. å†å¤„ç†ç¼“å­˜</span></span><br><span class="line">    c.redis.Set(<span class="string">&quot;cache_key_for_orders&quot;</span>, order)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬åªéœ€è¦åˆå§‹åŒ–çš„æ—¶å€™ï¼Œåšå‡ºä»¥ä¸‹ä¿®æ”¹ï¼ŒOrderServiceå®Œå…¨ä¸ç”¨åŠ¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥äº«å—åˆ°æ‰©å±•æ—¶ä¸æ±¡æŸ“æ ¸å¿ƒä¸šåŠ¡çš„æ”¶ç›Šï¼Œè¿™ç§æ”¶ç›Šï¼Œæ˜¯æ—¶å¸¸ä¼šå‘ç”Ÿçš„ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// v1</span></span><br><span class="line">repo := &amp;MySQLOrderRepo&#123;db: db&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// v2</span></span><br><span class="line">mysqlRepo := &amp;MySQLOrderRepo&#123;db: db&#125;</span><br><span class="line">repo := &amp;CachedOrderRepo&#123;nextRepo: mysqlRepo, redis: redisClient&#125;</span><br></pre></td></tr></table></figure><p>æœ€åä¸€ä¸ªä¾‹å­æ˜¯ä¸ºäº†å¯æ§çš„å¤–éƒ¨ä¾èµ–è€ŒæŠ½è±¡ã€‚å‡å¦‚è¯´æˆ‘ä»¬æœ‰ä¸ªç”¨æˆ·æ³¨å†ŒæœåŠ¡ï¼Œéœ€è¦è°ƒç”¨è…¾è®¯äº‘çŸ­ä¿¡API å‘é€éªŒè¯ç ã€‚å¦‚æœæ²¡æœ‰æŠ½è±¡ï¼Œé‚£å°±ä¼šåœ¨ <code>UserService</code>ä¸­ç¡¬ç¼–ç äº†è…¾è®¯äº‘çš„ SDKã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åä¾‹ï¼šç„Šæ­» &quot;å¤–éƒ¨ä¾èµ–&quot;</span></span><br><span class="line"><span class="keyword">type</span> UserService <span class="keyword">struct</span> &#123;</span><br><span class="line">    db    *gorm.DB</span><br><span class="line">    <span class="comment">// ç›´æ¥ä¾èµ– &quot;å…·ä½“çš„&quot; SDK</span></span><br><span class="line">    txSmsClient *tx_sms.Client</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *UserService)</span></span> Register(phone <span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// &quot;ä¸šåŠ¡&quot; å’Œ &quot;å¤–éƒ¨ SDK&quot; ç„Šæ­»</span></span><br><span class="line">    code := <span class="string">&quot;123456&quot;</span></span><br><span class="line">    err := s.txSmsClient.Send(phone, code)</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å™©æ¢¦æ˜¯ä»€ä¹ˆï¼š</p><ul><li><strong>æµ‹è¯•åœ°ç‹±ï¼š</strong> ä½ æ¯è·‘ä¸€æ¬¡ <code>Register</code>çš„æµ‹è¯•ï¼Œå°±<strong>çœŸçš„</strong>ç»™æ‰‹æœºå‘äº†ä¸€æ¡çŸ­ä¿¡ï¼æµ‹è¯•æˆæœ¬é«˜æ˜‚ï¼Œä¸”ä¾èµ–ç½‘ç»œã€‚</li><li><strong>SLA ç»‘æ¶ï¼š</strong> è…¾è®¯äº‘çŸ­ä¿¡ APIæŒ‚äº†ï¼ˆè¿™<strong>ç»å¸¸</strong>å‘ç”Ÿï¼‰ï¼Œä½ çš„æ³¨å†ŒæœåŠ¡<strong>è·Ÿç€ä¸€èµ·æŒ‚</strong>ã€‚</li><li><strong>è¿ç§»ç¾éš¾ï¼š</strong>è€æ¿è¯´è…¾è®¯äº‘å¤ªè´µï¼Œæ¢æˆé˜¿é‡Œäº‘ã€‚ä½ <strong>å¿…é¡»</strong>å…¥ä¾µ<code>UserService</code> å†…éƒ¨ï¼ŒæŠŠ <code>tx_sms.Client</code> çš„æ‰€æœ‰ APIè°ƒç”¨ï¼Œ<strong>é€è¡Œ</strong>æ”¹æˆ <code>ali_sms.Client</code> çš„APIã€‚</li></ul><p>æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼šå®šä¹‰ä¸€ä¸ªä½ è‡ªå·±çš„<strong>é˜²è…å±‚</strong>ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ­£ä¾‹ï¼šæŠ½è±¡ &quot;çŸ­ä¿¡æœåŠ¡&quot; å¥‘çº¦</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. å®šä¹‰ &quot;å¥‘çº¦&quot; (What)</span></span><br><span class="line"><span class="keyword">type</span> SMSService <span class="keyword">interface</span> &#123;</span><br><span class="line">    Send(phone, code <span class="type">string</span>) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. &quot;ä¸šåŠ¡&quot; åªä¾èµ– &quot;å¥‘çº¦&quot;</span></span><br><span class="line"><span class="keyword">type</span> UserService <span class="keyword">struct</span> &#123;</span><br><span class="line">    db    *gorm.DB</span><br><span class="line">    sms   SMSService <span class="comment">// &lt;-- ä¾èµ– &quot;å¥‘çº¦&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *UserService)</span></span> Register(phone <span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    code := <span class="string">&quot;123456&quot;</span></span><br><span class="line">    err := s.sms.Send(phone, code) <span class="comment">// &lt;-- è°ƒç”¨ &quot;å¥‘çº¦&quot;</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. &quot;å®ç°&quot; (How)</span></span><br><span class="line"><span class="keyword">type</span> TencentSMSService <span class="keyword">struct</span> &#123; ... &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *TencentSMSService)</span></span> Send(...) <span class="type">error</span> &#123; <span class="comment">/* ... è…¾è®¯ SDK ... */</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AliyunSMSService <span class="keyword">struct</span> &#123; ... &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *AliyunSMSService)</span></span> Send(...) <span class="type">error</span> &#123; <span class="comment">/* ... é˜¿é‡Œ SDK ... */</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡ç‚¹ï¼šç”¨äº &quot;æµ‹è¯•&quot; å’Œ &quot;å¼€å‘&quot; çš„ &quot;å®ç°&quot;</span></span><br><span class="line"><span class="keyword">type</span> LogSMSService <span class="keyword">struct</span> &#123; ... &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *LogSMSService)</span></span> Send(phone, code <span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">    log.Printf(<span class="string">&quot;[Mock SMS] Send to %s, code: %s&quot;</span>, phone, code)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ”¶ç›Šæ˜¯ä»€ä¹ˆï¼š</p><ul><li><strong>å¯æµ‹è¯•æ€§ï¼š</strong> å•å…ƒæµ‹è¯•æ—¶ï¼Œä½ æ³¨å…¥<code>MockSMSService</code>ã€‚</li><li><strong>ç¯å¢ƒéš”ç¦»ï¼š</strong> å¼€å‘/æµ‹è¯•ç¯å¢ƒæ—¶ï¼Œä½ æ³¨å…¥<code>LogSMSService</code>ï¼ˆå®ƒåªæ‰“å°æ—¥å¿—ä¸å‘çŸ­ä¿¡ï¼‰ã€‚</li><li><strong>å¯è¿ç§»æ€§ï¼š</strong> ä»è…¾è®¯æ¢é˜¿é‡Œï¼Œ<code>UserService</code><strong>ä¸€è¡Œä¸ç”¨æ”¹</strong>ï¼Œä½ åªéœ€è¦åœ¨ <code>main.go</code>æ›¿æ¢å®ç°ç±»ã€‚</li><li><strong>å¥å£®æ€§ï¼š</strong> ä½ ç”šè‡³å¯ä»¥å®ç°ä¸€ä¸ª<code>FailoverSMSService</code>é«˜å¯ç”¨å®ç°ï¼Œå®ƒå†…éƒ¨å°è¯•å…ˆç”¨è…¾è®¯ã€å¤±è´¥åè‡ªåŠ¨é™çº§åˆ°é˜¿é‡Œã€‚è€Œ<code>UserService</code> <strong>æ¯«ä¸çŸ¥æƒ…</strong>ã€‚</li></ul><p>è¿™ç§æ”¶ç›Šåœ¨å®é™…ä¸šåŠ¡å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¹Ÿæ˜¯æ—¶å¸¸ä¼šå‘ç”Ÿçš„ã€‚</p><h3 id="ä¸šåŠ¡å±‚é¢çš„æŠ½è±¡">ä¸šåŠ¡å±‚é¢çš„æŠ½è±¡</h3><p>å‰é¢æåˆ°çš„ 3ä¸ªæŠ€æœ¯å±‚é¢çš„ä¾‹å­ï¼Œéš¾åº¦å°ã€ä»£ä»·ä½ã€æ”¶ç›Šé«˜ã€å¯å¤åˆ¶æ€§å¼ºï¼Œæ‰€ä»¥æˆ‘è§‰å¾—ä»»ä½•æ—¶å€™æˆ‘ä»¬å·¥ç¨‹å¸ˆéƒ½è¦å°½åŠ›æŠŠè¿™äº›æ–¹é¢åšå¥½ã€‚</p><p>ä½†æ˜¯ä¸šåŠ¡å±‚é¢çš„æŠ½è±¡å°±ä¸ä¸€æ ·äº†ï¼Œæˆ‘ä»¬å·¥ç¨‹å¸ˆçš„å™©æ¢¦ï¼Œå°±æ˜¯ä¸šåŠ¡æ–¹ï¼ˆPMï¼‰æ¯å¤©éƒ½åœ¨æ”¹éœ€æ±‚ï¼Œæˆ‘ä»¬è¢«<strong>æ˜“å˜çš„æµç¨‹</strong>ç‰µç€é¼»å­èµ°ï¼Œå¯¼è‡´æ ¸å¿ƒä»£ç æ—¥ç›Šè…åŒ–ã€‚æ‰€ä»¥ä¸šåŠ¡æŠ½è±¡çš„<strong>å”¯ä¸€ç›®çš„</strong>ï¼Œå°±æ˜¯<strong>åœ¨æ˜“å˜çš„ä¸šåŠ¡è§„åˆ™ï¼ˆæµç¨‹ï¼‰ä¸­ï¼Œä¿æŠ¤ä¸å˜çš„ä¸šåŠ¡æœ¬è´¨</strong>ã€‚</p><p>è¿™é‡Œæˆ‘æƒ³å¼•ç”¨ã€ŠæœåŠ¡ç«¯å¼€å‘Â·æŠ€æœ¯ã€æ–¹æ³•ä¸å®ç”¨è§£å†³æ–¹æ¡ˆã€‹ä¸€ä¹¦ä¸­çš„ä¸€ä¸ªä¾‹å­ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘åœ¨2024å¹´å¹´ä¸­ç»©æ•ˆæ€»ç»“æ—¶å¯¹å‰å¸éƒ¨é—¨æå‡ºçš„ä¸€ä¸ªå»ºè®®ï¼ˆè™½ç„¶äº‹å®ä¸Šå¹¶æ²¡èµ·åˆ°ä»€ä¹ˆä½œç”¨ï¼‰ã€‚ä¹¦ä¸­æå‡ºäº†ä¸€ä¸ªç–‘é—®ï¼š</p><blockquote><p>[!WARNING]</p><p>äº§å“éœ€æ±‚é€€åŒ–çš„æ ¹æœ¬åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ</p><p>â€”â€” æ˜¯ç¼ºä¹æŠ½è±¡</p></blockquote><p>é€šè¿‡æŠ½è±¡å¯ä»¥ç†æ¸…ä¸šåŠ¡çš„æ ¸å¿ƒé—®é¢˜å¹¶è®¾è®¡ä½“ç³»åŒ–çš„æ–¹æ¡ˆäºˆä»¥è§£å†³ï¼Œè€Œç¼ºä¹æŠ½è±¡åˆ™åªèƒ½é€šè¿‡å…·ä½“çš„ã€å¤æ‚çš„æè¿°æ¥åæ˜ äº‹åŠ¡çš„è¡¨é¢ç‰¹å¾ã€‚</p><p>æ¯”å¦‚æœ‰ä»¥ä¸‹éœ€æ±‚ï¼š</p><blockquote><p>"ä¼˜æƒ ç«‹å‡"æ´»åŠ¨ä¸Šçº¿åï¼Œåœ¨ Appä¸»é¡µï¼Œå¦‚æœç”¨æˆ·æ˜¯åœ¨æ´»åŠ¨å¼€å§‹åé¦–æ¬¡è¿›å…¥ï¼Œåˆ™å¼¹å‡ºä¸€ä¸ªæç¤ºçª—å£ï¼Œå±•ç¤º"ä¼˜æƒ ç«‹å‡"æ´»åŠ¨ä¿¡æ¯ï¼Œå¸å¼•ç”¨æˆ·å‚ä¸ï¼›å¦‚æœç”¨æˆ·ç‚¹å‡»å¼¹çª—ä¿¡æ¯ï¼Œåˆ™è·³è½¬è¿›å…¥åˆ°å¯¹åº”çš„æ´»åŠ¨é¡µé¢ï¼Œä¹‹ååœ¨App ä¸»é¡µä¸å†å¼¹çª—æç¤ºï¼Œé¿å…æ‰“æ‰°ç”¨æˆ·ï¼›å¦‚æœç”¨æˆ·ä¸ç‚¹å‡»å¼¹çª—ä¿¡æ¯ï¼Œåˆ™å¼¹çª— 5såè‡ªåŠ¨å…³é—­ï¼Œä¹‹åç”¨æˆ·è‹¥å†è¿›å…¥ App ä¸»é¡µï¼Œåˆ™ä»¥æ¯å‘¨å¼¹çª— 3æ¬¡çš„é¢‘ç‡æé†’ç”¨æˆ·ï¼Œç›´åˆ°ç”¨æˆ·ç‚¹å‡»å¼¹çª—ä¿¡æ¯ä¸ºæ­¢ã€‚</p></blockquote><p>å¦‚æœæˆ‘ä»¬å®Œå…¨æŒ‰ç…§è¿™ä¸ªéœ€æ±‚æ–¹æ¡ˆæ¥è¿›è¡Œç¼–ç ï¼Œé‚£ä¼°è®¡åˆæ˜¯ä¸€ä¸ªå‡½æ•°é‡Œé¢ç¡¬ç¼–ç äº†å¾ˆå¤šçš„é€»è¾‘ï¼Œé‚£åŠ¿å¿…ä¼šåœ¨éœ€æ±‚çš„æ¯æ—¥å˜åŒ–ä¸­ä¸æ–­è…åŒ–ã€‚é‚£è¿™ä¸ªä¸šåŠ¡çš„æœ¬è´¨æ˜¯ä»€ä¹ˆå‘¢ï¼š</p><blockquote><p>è¿™æ˜¯ä¸€ä¸ª"æ§åˆ¶ç–²åŠ³åº¦"ï¼ˆç–²åŠ³é¢‘æ¬¡ï¼‰çš„é—®é¢˜ï¼Œå³"ä¸šåŠ¡åœºæ™¯ S å¯¹åº” F æ¬¡/å‘¨æœŸQ"ã€‚</p><ul><li>Sï¼šä»»æ„åœºæ™¯</li><li>Fï¼šæ•´æ•°</li><li>Qï¼šæ—¶é—´å•ä½ï¼Œ å¤©ã€å‘¨ã€æœˆã€å¹´ã€ç»ˆèº«ç­‰</li></ul></blockquote><p>ä¸è¿‡æˆ‘è§‰å¾—ï¼Œç­–åˆ’å’Œè¿è¥å›¢é˜Ÿï¼Œå¯¹äº"è¿è¥æ´»åŠ¨"çš„æ¨¡å‹ç†è§£è·ŸæŠ€æœ¯å›¢é˜Ÿæ˜¯æœ‰åŒºåˆ«çš„ï¼ŒæŠ€æœ¯å›¢é˜Ÿé¢å¯¹çš„æ˜¯å…·ä½“åˆ°ä¸€ä¸ªä¸ªç»†èŠ‚ã€å®Œæ•´çš„éœ€æ±‚ï¼Œè€Œåœ¨ç­–åˆ’å’Œè¿è¥å›¢é˜Ÿé‚£ï¼Œå¯èƒ½æœ‰ä¸€å¥—ä¸ä¸€æ ·çš„åº•å±‚é€»è¾‘ã€‚æŠ€æœ¯å›¢é˜Ÿè¦åšåˆ°æŠ½è±¡ï¼Œåªèƒ½æ˜¯åœ¨æ¥è§¦äº†å¤šä¸ªæ˜æ˜¾ç›¸ä¼¼çš„éœ€æ±‚åï¼Œæ‰æœ‰å¯èƒ½è¿›è¡ŒæŠ½è±¡æå–ï¼Œå“ªæ€•æ˜¯è¿™ä¸ªæ—¶å€™ï¼Œè·Ÿä¸šåŠ¡æ–¹çš„ç†è§£ä¹Ÿå¯èƒ½æœ‰åå·®ã€‚æ‰€ä»¥å¦‚æœå¯ä»¥ä»ä¸šåŠ¡æ–¹æºå¤´å°±åšå¥½æŠ½è±¡ï¼Œé‚£çœŸæ˜¯å¯ä»¥èµ·åˆ°å››ä¸¤æ‹¨åƒæ–¤çš„ä½œç”¨ã€‚</p><hr /><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸¤ä¸ªç ”å‘è¿‡ç¨‹ä¸­æœ€å¸¸è§çš„ä¸šåŠ¡ç—›ç‚¹ï¼ˆå˜åŒ–ç‚¹ï¼‰ï¼šè§„åˆ™å’Œæµç¨‹ã€‚</p><p><strong>ç—›ç‚¹ä¸€ï¼šIf-Else æ€ªç‰© â€”â€” ä¸šåŠ¡è§„åˆ™çš„è…åŒ–</strong></p><p>ç°åœ¨æœ‰ä¸€ä¸ªè®¡ç®—è®¢å•ä»·æ ¼çš„æœåŠ¡<code>OrderService.CalculatePrice()</code>ï¼Œå®ƒç»å†äº†ä»¥ä¸‹å‡ ä¸ªç‰ˆæœ¬ï¼š</p><ul><li><strong>V1ï¼ˆä¸Šçº¿ï¼‰ï¼š</strong>é€»è¾‘å¾ˆç®€å•ï¼š<code>price = product.Price * quantity</code></li><li><strong>V2ï¼ˆåŒåä¸€ï¼‰ï¼š</strong> PMè·‘æ¥è¯´ï¼šåŠ ä¸ªåŒåä¸€è§„åˆ™ï¼Œæ‰€æœ‰å•†å“æ‰“ 8 æŠ˜ï¼<ul><li>ä½ å…¥ä¾µäº†<code>CalculatePrice</code>ï¼š<code>if (isDoubleEleven) &#123; price = price * 0.8 &#125;</code></li></ul></li><li><strong>V3ï¼ˆæ‹‰æ–°ï¼‰ï¼š</strong> PM åˆæ¥è¯´ï¼šæ–°ç”¨æˆ·ç¬¬ä¸€å•ï¼Œå†æ‰“ 9 æŠ˜ï¼<ul><li>ä½ å†æ¬¡å…¥ä¾µï¼š<code>if (isNewUser) &#123; price = price * 0.9 &#125; else if (isDoubleEleven) &#123; ... &#125;</code></li></ul></li><li><strong>V4ï¼ˆVIP ä¼šå‘˜ï¼‰ï¼š</strong> PMï¼šVIP ç”¨æˆ·ï¼ŒæŠ˜ä¸Šå†æ‰“ 95 æŠ˜ï¼<ul><li>ä½ ï¼š<code>if (isVIP) &#123; ... &#125; else if (isNewUser) &#123; ... &#125; else if ...</code></li></ul></li></ul><p><code>CalculatePrice</code> æ–¹æ³•å˜æˆäº† 500 è¡Œçš„ if-elseæ€ªç‰©ã€‚å®ƒè…åŒ–äº†ã€‚</p><ul><li><strong>è®¤çŸ¥è´Ÿè·</strong>ï¼šæ²¡äººï¼ˆåŒ…æ‹¬ä½ è‡ªå·±ï¼‰èƒ½è¯´æ¸…ä¸€ä¸ªä»·æ ¼åˆ°åº•æ˜¯æ€ä¹ˆç®—å‡ºæ¥çš„ã€‚</li><li><strong>æµ‹è¯•ç¾éš¾</strong>ï¼šä½ éœ€è¦ <code>2*2*2=8</code>ç§ï¼Œç”šè‡³æ›´å¤šçš„ç»„åˆæ¥æµ‹è¯•æ‰€æœ‰è§„åˆ™ã€‚</li><li><strong>ç»´æŠ¤åœ°ç‹±</strong>ï¼šPM è®©ä½ å»æ‰åŒåä¸€ï¼Œä¿ç•™VIPï¼Œä½ å¾—å°å¿ƒç¿¼ç¿¼åœ°å»<strong>ä¿®æ”¹</strong> <code>CalculatePrice</code>è¿™ä¸ªå‡½æ•°ï¼Œåˆ å¤šåˆ å°‘å’±ä¹Ÿå°±ä¸å¥½è¯´äº†ã€‚</li></ul><p>æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼š<strong>ç­–ç•¥æ¨¡å¼ (Strategy Pattern)</strong></p><ul><li><strong>ä¸å˜çš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ</strong>è®¢å•ä»·æ ¼éœ€è¦è¢«<strong>ä¸€ç³»åˆ—è§„åˆ™</strong>æ‰€è®¡ç®—ã€‚</li><li><strong>æ˜“å˜çš„æ˜¯ä»€ä¹ˆï¼Ÿ</strong> è§„åˆ™æœ¬èº«ï¼ˆä»Šå¤©åŒåä¸€ï¼Œæ˜å¤©618ï¼‰ã€‚</li></ul><p>æˆ‘ä»¬è¦æŠ½è±¡çš„ï¼Œå°±æ˜¯<strong>è§„åˆ™</strong>è¿™ä¸ª<strong>æ˜“å˜</strong>çš„ä¸œè¥¿ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. &quot;æŠ½è±¡&quot; å‡º &quot;å¥‘çº¦&quot;ï¼šä¸€ä¸ª &quot;ä¿ƒé”€è§„åˆ™&quot; (What)</span></span><br><span class="line"><span class="keyword">type</span> PromotionPolicy <span class="keyword">interface</span> &#123;</span><br><span class="line">    Apply(order *Order) *AppliedDiscount</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. &quot;ä¸å˜çš„æœ¬è´¨&quot; (OrderService)</span></span><br><span class="line"><span class="comment">// å®ƒ &quot;ä¸çŸ¥é“&quot; ä»»ä½•å…·ä½“è§„åˆ™ï¼Œå®ƒåª &quot;è®¤è¯†&quot; å¥‘çº¦</span></span><br><span class="line"><span class="keyword">type</span> OrderService <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// å®ƒåª &quot;èšåˆ&quot; äº†ä¸€ä¸ª &quot;è§„åˆ™åˆ—è¡¨&quot;</span></span><br><span class="line">    policies []PromotionPolicy</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *OrderService)</span></span> CalculatePrice(order *Order) &#123;</span><br><span class="line">    <span class="comment">// ä¸šåŠ¡æ ¸å¿ƒï¼š&quot;å¾ªç¯&quot; åº”ç”¨æ‰€æœ‰è§„åˆ™</span></span><br><span class="line">    <span class="keyword">for</span> _, policy := <span class="keyword">range</span> s.policies &#123;</span><br><span class="line">        discount := policy.Apply(order)</span><br><span class="line">        order.ApplyDiscount(discount)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. &quot;æ˜“å˜çš„å®ç°&quot; (How)</span></span><br><span class="line"><span class="comment">// æ¯ä¸€ä¸ª &quot;è§„åˆ™&quot; éƒ½æ˜¯ä¸€ä¸ª &quot;ç‹¬ç«‹çš„å®ç°&quot;</span></span><br><span class="line"><span class="keyword">type</span> DoubleElevenPolicy <span class="keyword">struct</span> &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *DoubleElevenPolicy)</span></span> Apply(order *Order) *AppliedDiscount &#123;</span><br><span class="line">    <span class="keyword">if</span> (isDoubleEleven) &#123; <span class="comment">/* ... 8æŠ˜é€»è¾‘ ... */</span> &#125;</span><br><span class="line">    <span class="keyword">return</span> ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> NewUserPolicy <span class="keyword">struct</span> &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *NewUserPolicy)</span></span> Apply(order *Order) *AppliedDiscount &#123;</span><br><span class="line">    <span class="keyword">if</span> (isNewUser) &#123; <span class="comment">/* ... 9æŠ˜é€»è¾‘ ... */</span> &#125;</span><br><span class="line">    <span class="keyword">return</span> ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ... VIPPolicy, SixEighteenPolicy ...</span></span><br></pre></td></tr></table></figure><p>æ”¶ç›Šæ˜¯ä»€ä¹ˆï¼š</p><ul><li><strong>è…åŒ–è¢«é˜»æ­¢äº†ï¼š</strong> ä½ çš„ <code>OrderService</code>ä¸ä¼šå†å˜äº†ã€‚å®ƒå˜å¾—<strong>æå…¶ç¨³å®šã€å¹²å‡€ã€ä¸”çº¯ç²¹</strong>ã€‚</li><li><strong>å¼€é—­åŸåˆ™çš„å®ç°ï¼š</strong><ul><li>PM è®©ä½ å»æ‰åŒåä¸€ï¼Ÿä½ åªéœ€è¦åœ¨ <code>policies</code>åˆ—è¡¨é‡Œï¼Œ<strong>åˆ é™¤</strong> <code>DoubleElevenPolicy</code>å³å¯ã€‚<strong>æ ¸å¿ƒä¸šåŠ¡ä»£ç  0 ä¿®æ”¹</strong>ã€‚</li><li>PM è®©ä½ æ–°å¢ 618ï¼Ÿä½ åªéœ€è¦<strong>æ–°å»º</strong>ä¸€ä¸ª<code>SixEighteenPolicy.go</code>æ–‡ä»¶ï¼Œç„¶ååŠ åˆ°åˆ—è¡¨é‡Œã€‚<strong>æ ¸å¿ƒä¸šåŠ¡ä»£ç  0 ä¿®æ”¹</strong>ã€‚</li></ul></li></ul><p>è¿™å°±æ˜¯ä¸šåŠ¡æŠ½è±¡çš„ç¬¬ä¸€ä¸ªå·¨å¤§ä»·å€¼ï¼š<strong>ç”¨ç»„åˆ (Composition) ä»£æ›¿ä¿®æ”¹(Modification)ï¼Œéš”ç¦»æ ¸å¿ƒä¸è§„åˆ™ã€‚</strong></p><hr /><p><strong>ç—›ç‚¹äºŒï¼šä¸Šå¸æœåŠ¡ â€”â€” ä¸šåŠ¡æµç¨‹çš„è†¨èƒ€</strong></p><p>è¿˜æ˜¯ <code>OrderService</code>ã€‚</p><ul><li><strong>V1ï¼ˆä¸Šçº¿ï¼‰ï¼š</strong> <code>CreateOrder</code>é€»è¾‘å¾ˆç®€å•ï¼š<code>repo.Save(order)</code>ã€‚</li><li><strong>V2ï¼ˆâ€œé€šçŸ¥â€ï¼‰ï¼š</strong> PMè·‘æ¥è¯´ï¼šè®¢å•åˆ›å»ºåï¼Œè¦ç»™ç”¨æˆ·å‘ä¸ªçŸ­ä¿¡ï¼<ul><li>ä½ å…¥ä¾µäº†<code>CreateOrder</code>ï¼š<code>repo.Save(order); sms.Send(...)</code></li></ul></li><li><strong>V3ï¼ˆåŠ ç§¯åˆ†ï¼‰ï¼š</strong> PMåˆæ¥è¯´ï¼šå‘çŸ­ä¿¡åï¼Œé¡ºä¾¿ç»™ç”¨æˆ·åŠ ä¸ªç§¯åˆ†ï¼<ul><li>ä½ å†æ¬¡å…¥ä¾µï¼š<code>...; sms.Send(...); loyalty.AddPoints(...)</code></li></ul></li><li><strong>V4ï¼ˆé€šçŸ¥å±¥çº¦ï¼‰ï¼š</strong>PMï¼šåŠ å®Œç§¯åˆ†ï¼Œè¿˜è¦é€šçŸ¥ä¸€ä¸‹å±¥çº¦ä¸­å°ï¼ˆWMSï¼‰ï¼â€<ul><li>ä½ ï¼š<code>...; loyalty.AddPoints(...); wms.Notify(...)</code></li></ul></li></ul><p><code>CreateOrder</code> æ–¹æ³•å˜æˆäº†ä¸Šå¸æ–¹æ³•ã€‚å®ƒä»€ä¹ˆéƒ½å¹²ã€‚</p><ul><li><strong>èŒè´£è†¨èƒ€ï¼š</strong> <code>OrderService</code>ä¸ä»…è¦ç®¡"è®¢å•"ï¼Œå®ƒç°åœ¨è¿˜è¢«è¿«è®¤è¯†äº†"çŸ­ä¿¡"ã€"ç§¯åˆ†"å’Œ"å±¥çº¦"ã€‚<strong>å®ƒé«˜è€¦åˆäº†</strong>ã€‚</li><li><strong>äº‹åŠ¡åœ°ç‹±ï¼š</strong> "ç§¯åˆ†"æŒ‚äº†ï¼Œ<code>CreateOrder</code>äº‹åŠ¡è¦ä¸è¦å›æ»šï¼Ÿ"çŸ­ä¿¡"è¶…æ—¶äº†ï¼Œè¦ä¸è¦è®©ç”¨æˆ·å¤šç­‰ 30 ç§’ï¼Ÿ</li><li><strong>æµ‹è¯•ç¾éš¾ï¼š</strong>ä¸ºäº†æµ‹è¯•"åˆ›å»ºè®¢å•"ï¼Œä½ <strong>è¢«è¿«</strong>è¦ Mock <code>sms</code>,<code>loyalty</code>, <code>wms</code> ä¸‰ä¸ªå¤–éƒ¨ä¾èµ–ã€‚</li></ul><p>æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼š<strong>é¢†åŸŸäº‹ä»¶ (Domain Events)</strong></p><ul><li><strong>ä¸å˜çš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ</strong> <code>OrderService</code>çš„<strong>æ ¸å¿ƒèŒè´£</strong>åªæœ‰ä¸€ä¸ªï¼š<strong>åˆ›å»ºè®¢å•</strong>ï¼ˆå³ï¼Œä¿è¯"è®¢å•"è¿™ä¸ªèšåˆæ ¹çš„çŠ¶æ€ä¸€è‡´æ€§ï¼‰ã€‚</li><li><strong>æ˜“å˜çš„æ˜¯ä»€ä¹ˆï¼Ÿ</strong>è®¢å•åˆ›å»ºåå¼•å‘çš„ä¸‹æ¸¸å‰¯ä½œç”¨ï¼ˆçŸ­ä¿¡ã€ç§¯åˆ†ã€å±¥çº¦...ï¼‰ã€‚</li></ul><p>æˆ‘ä»¬è¦æŠ½è±¡çš„ï¼Œå°±æ˜¯<strong>å‰¯ä½œç”¨</strong>è¿™ä¸ª<strong>æ˜“å˜</strong>çš„ä¸œè¥¿ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. &quot;æŠ½è±¡&quot; å‡º &quot;å¥‘çº¦&quot;ï¼šä¸€ä¸ª &quot;äº‹ä»¶&quot; (What)</span></span><br><span class="line"><span class="keyword">type</span> OrderCreatedEvent <span class="keyword">struct</span> &#123;</span><br><span class="line">    OrderID <span class="type">string</span></span><br><span class="line">    UserID  <span class="type">string</span></span><br><span class="line">    Time    time.Time</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. &quot;ä¸å˜çš„æœ¬è´¨&quot; (OrderService)</span></span><br><span class="line"><span class="comment">// å®ƒ &quot;ä¸è®¤è¯†&quot; ä»»ä½•ä¸‹æ¸¸ï¼Œå®ƒåª &quot;è®¤è¯†&quot; äº‹ä»¶</span></span><br><span class="line"><span class="keyword">type</span> OrderService <span class="keyword">struct</span> &#123;</span><br><span class="line">    repo      OrderRepository</span><br><span class="line">    publisher EventPublisher <span class="comment">// &lt;-- æŠ½è±¡çš„ &quot;äº‹ä»¶å‘å¸ƒå™¨&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *OrderService)</span></span> CreateOrder(order *Order) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 1. æ ¸å¿ƒèŒè´£ï¼šä¿è¯çŠ¶æ€ä¸€è‡´æ€§</span></span><br><span class="line">    <span class="keyword">if</span> err := s.repo.Save(order); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. æ ¸å¿ƒèŒè´£ï¼šå‘å¸ƒ &quot;å·²å‘ç”Ÿ&quot; çš„ &quot;äº‹å®&quot;</span></span><br><span class="line">    event := &amp;OrderCreatedEvent&#123;OrderID: order.ID, ...&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. &quot;å¼‚æ­¥&quot; å‘å¸ƒï¼Œä¸ &quot;ä¸‹æ¸¸&quot; è§£è€¦</span></span><br><span class="line">    <span class="comment">// (å®ƒå¯ä»¥æ˜¯ Kafka, ä¹Ÿå¯ä»¥æ˜¯ RabbitMQ, ç”šè‡³æ˜¯å†…å­˜ channel)</span></span><br><span class="line">    s.publisher.Publish(event)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// CreateOrder çš„ &quot;èŒè´£&quot; åˆ°æ­¤ &quot;ç»“æŸ&quot;ï¼</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. &quot;æ˜“å˜çš„å®ç°&quot; (How)</span></span><br><span class="line"><span class="comment">// æ¯ä¸€ä¸ª &quot;å‰¯ä½œç”¨&quot; éƒ½æ˜¯ä¸€ä¸ª &quot;ç‹¬ç«‹çš„è®¢é˜…è€…&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// &quot;çŸ­ä¿¡&quot; æœåŠ¡ (ä¸€ä¸ªç‹¬ç«‹çš„å¾®æœåŠ¡ï¼Œæˆ–ç‹¬ç«‹çš„ goroutine)</span></span><br><span class="line"><span class="keyword">type</span> SMSSubscriber <span class="keyword">struct</span> &#123; ... &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SMSSubscriber)</span></span> OnOrderCreated(event *OrderCreatedEvent) &#123;</span><br><span class="line">    <span class="comment">// ... sms.Send(...)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &quot;ç§¯åˆ†&quot; æœåŠ¡</span></span><br><span class="line"><span class="keyword">type</span> LoyaltySubscriber <span class="keyword">struct</span> &#123; ... &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *LoyaltySubscriber)</span></span> OnOrderCreated(event *OrderCreatedEvent) &#123;</span><br><span class="line">    <span class="comment">// ... loyalty.AddPoints(...)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ”¶ç›Šæ˜¯ä»€ä¹ˆï¼š</p><ul><li><strong>ä¸Šå¸æœåŠ¡è¢«æ‹†è§£äº†ï¼š</strong> <code>OrderService</code>çš„èŒè´£è¢«<strong>å‡€åŒ–</strong>äº†ã€‚å®ƒå›åˆ°äº†å®ƒä¸å˜çš„æœ¬è´¨â€”â€”åªç®¡"è®¢å•"ã€‚</li><li><strong>é«˜å†…èšã€ä½è€¦åˆçš„å®ç°ï¼š</strong><ul><li>PM è®©ä½ <strong>å»æ‰</strong>çŸ­ä¿¡é€šçŸ¥ï¼Ÿä½ åªéœ€è¦<strong>ä¸‹çº¿</strong><code>SMSSubscriber</code> å³å¯ã€‚<code>OrderService</code><strong>æ¯«ä¸çŸ¥æƒ…</strong>ã€‚</li><li>PMè®©ä½ <strong>æ–°å¢</strong>è´¢åŠ¡å¯¹è´¦é€šçŸ¥ï¼Ÿä½ åªéœ€è¦<strong>æ–°å»º</strong>ä¸€ä¸ª<code>FinanceSubscriber</code> å³å¯ã€‚<code>OrderService</code><strong>æ¯«ä¸çŸ¥æƒ…</strong>ã€‚</li></ul></li></ul><hr /><p>æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ï¼ŒæŠ€æœ¯æŠ½è±¡æ˜¯åœ¨å®ç°ï¼ˆHowï¼‰å±‚é¢åš<strong>æ›¿æ¢</strong>ï¼ˆ<code>MockRepo</code>æ›¿æ¢<code>MySQLRepo</code>ï¼‰ã€‚è€Œä¸šåŠ¡æŠ½è±¡æ˜¯åœ¨é€»è¾‘ï¼ˆWhatï¼‰å±‚é¢åš<strong>ç»„åˆ</strong>å’Œ<strong>è§£è€¦</strong>ï¼Œè¿™é‡Œæˆ‘ç»™å‡ºäº†2 ä¸ªæ€è·¯ï¼š</p><ul><li><strong>ç­–ç•¥æ¨¡å¼ï¼ˆåº”å¯¹è§„åˆ™ï¼‰ï¼š</strong> å½“ <code>if-else</code>å¼€å§‹è…åŒ–ä½ çš„<strong>æ ¸å¿ƒç®—æ³•</strong>æ—¶ï¼ŒæŠŠ<strong>è§„åˆ™(Rules)</strong>æŠ½è±¡æˆ<strong>ç­–ç•¥</strong>ï¼Œç”¨<strong>ç»„åˆ</strong>ä»£æ›¿<strong>ä¿®æ”¹</strong>ã€‚</li><li><strong>é¢†åŸŸäº‹ä»¶ï¼ˆåº”å¯¹æµç¨‹ï¼‰ï¼š</strong>å½“ä¸‹æ¸¸å¼€å§‹æ±¡æŸ“ä½ çš„<strong>æ ¸å¿ƒèŒè´£</strong>æ—¶ï¼ŒæŠŠ<strong>å‰¯ä½œç”¨ (SideEffects)</strong>æŠ½è±¡æˆ<strong>äº‹ä»¶</strong>ï¼Œç”¨<strong>å‘å¸ƒ/è®¢é˜…</strong>ä»£æ›¿<strong>ç›´æ¥è°ƒç”¨</strong>ã€‚</li></ul><h3 id="æ¥å£å®šä¹‰åœ¨å“ª">æ¥å£å®šä¹‰åœ¨å“ª</h3><p>è¿™é‡Œæˆ‘æƒ³å†å¤šè°ˆä¸€ä¸‹æ¥å£å®šä¹‰åœ¨å“ªé‡Œçš„é—®é¢˜ï¼Œè¿™ä¼šæ¶‰åŠåˆ°ä¸€ç»„æ¦‚å¿µï¼š<strong>éœ€æ±‚æ–¹æ¥å£</strong>å’Œ<strong>æä¾›æ–¹æ¥å£</strong>ã€‚è¿™ä¹Ÿæ˜¯æˆ‘åœ¨é˜…è¯»äº†ã€Šè½¯ä»¶è®¾è®¡Â·ä»ä¸“ä¸šåˆ°å“è¶Šã€‹ä¸€ä¹¦åï¼Œè§‰å¾—æ”¶è·éå¸¸å¤§çš„åœ°æ–¹ï¼Œä»é‚£ä¹‹åï¼Œè¿™ç»„æ¦‚å¿µä¸€ç›´æ˜¯æŒ‡å¯¼æˆ‘è¿›è¡Œä¸šåŠ¡æŠ½è±¡å’Œæ¥å£å®šä¹‰çš„æ ¸å¿ƒæ€æƒ³æ­¦å™¨ã€‚</p><p>å‰é¢æˆ‘ä»¬æåˆ°äº†è¦ä¸º <code>OrderService</code> é…ä¸€ä¸ª<code>OrderRepository</code>æ¥å£ï¼Œä»¥å®ç°å¯æµ‹è¯•æ€§ã€æ‰©å±•æ—¶ä¸æ±¡æŸ“ä¸šåŠ¡å’Œå¯æ§çš„å¤–éƒ¨ä¾èµ–ã€‚è¿™é‡Œæˆ‘æƒ³æå‡ºä¸€ä¸ªé—®é¢˜ï¼š<font color="red"><code>OrderRepository</code>æ˜¯å®šä¹‰åœ¨ service å±‚è¿˜æ˜¯å®šä¹‰åœ¨ repository å±‚ï¼Ÿ</font></p><p>ç­”æ¡ˆæ˜¯åº”è¯¥å®šä¹‰åœ¨ service å±‚ï¼è¿™å¯èƒ½ä¼šæœ‰ä¸€ç‚¹åç›´è§‰ï¼</p><p>å¦‚æœå®šä¹‰åœ¨äº† repositoryï¼Œé‚£å°±è¯´æ˜ service ä¾èµ–äº†repositoryï¼Œä¸ç®¡ä½ ä¾èµ–çš„æ˜¯æ¥å£ï¼Œè¿˜æ˜¯å…·ä½“çš„å®ç°ï¼Œéƒ½æ˜¯ä¾èµ–ï¼Œåœ¨ Goè¯­è¨€é‡Œé¢çš„ä½“ç°å°±æ˜¯ä½ éœ€è¦åœ¨ service package ä¸­ import å…³äº repositoryçš„ä¸œè¥¿ã€‚</p><p>ä½†æ˜¯å¦‚æœå®šä¹‰åœ¨ service å±‚ï¼Œé‚£ service package ä¸­å°†ä¸ä¼šå­˜åœ¨ä»»ä½•å…³äºrepository çš„å¼•ç”¨çš„ï¼Œä½ åªéœ€è¦åœ¨ä¾èµ–æ³¨å…¥çš„æ—¶å€™å» repository å±‚æ‰¾åˆ°èƒ½å®ç°service è¦æ±‚çš„æ¥å£å®ç°å³å¯ï¼Œè¿™ä¸ªæ—¶å€™åè€Œæ˜¯ repository ä¾èµ–äº†serviceï¼ˆçš„è¦æ±‚ï¼‰ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„<strong>ä¾èµ–å€’ç½®åŸåˆ™ (DIP)</strong>ï¼</p><p>é‚£ä¸ºä»€ä¹ˆè¦è¿™æ ·å‘¢ï¼Ÿæˆ‘ä»¬å‰é¢æåˆ°äº†æ¥å£æŠ½è±¡å°±æ˜¯å®šä¹‰å¥‘çº¦ï¼Œé‚£è¿™ä¸ªå¥‘çº¦ç”±è°æ¥å®šå‘¢ï¼Ÿåº”è¯¥ç”±éœ€æ±‚æ–¹æ¥å®šä¹‰ï¼Œå› ä¸ºåªæœ‰éœ€æ±‚æ–¹ï¼Œæ‰çŸ¥é“è‡ªå·±éœ€è¦ä»€ä¹ˆä¸œè¥¿ã€‚<code>OrderService</code>éœ€è¦ä¸€ä¸ª <code>Save(order)</code> çš„æ–¹æ³•ã€‚å®ƒä¸éœ€è¦ï¼ˆä¹Ÿä¸åº”è¯¥ï¼‰å…³å¿ƒ<code>MySQLOrderRepo</code> è¿˜æä¾›äº†ï¼ˆæˆ–è¢«è¿«å®ç°äº†ï¼‰å…¶ä»– 10ä¸ªå®ƒç”¨ä¸åˆ°çš„æ–¹æ³•ï¼ˆæ¯”å¦‚ <code>GetConnectionPoolStats</code>ï¼‰ã€‚</p><p>å…³äºéœ€æ±‚æ–¹æ¥å£å’Œæä¾›æ–¹æ¥å£çš„æ›´è¿›ä¸€æ­¥é˜è¿°ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥é˜…è¯»æˆ‘ä¹‹å‰æ•´ç†çš„ç¬”è®°ï¼š<ahref="https://www.notion.so/vs-f7b7f03169f14ce39c1b1e3aaf64cf6f?pvs=74">éœ€æ±‚æ–¹æ¥å£vs. æä¾›æ–¹æ¥å£</a>ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚</p><h3 id="æŠ½è±¡çš„æ—¶æœº">æŠ½è±¡çš„æ—¶æœº</h3><p>å‰é¢æˆ‘ä»¬æ€»ç»“äº†æŠ½è±¡çš„ä½œç”¨ã€éš¾ç‚¹å’Œæ ¸å¿ƒï¼Œä¹Ÿåœ¨æŠ€æœ¯å’Œä¸šåŠ¡ä¸¤ä¸ªå±‚é¢è¿›è¡Œäº†å±•å¼€å¹¶ç»™å‡ºäº†ä¸€äº›åˆ‡å®æœ‰æ•ˆçš„å®æ–½å»ºè®®ã€‚æˆ‘ä»¬å·²ç»çŸ¥é“"æŠ½"ä»€ä¹ˆï¼ˆå˜åŒ–ï¼‰ï¼Œä½†ä»€ä¹ˆæ—¶å€™"æŠ½"å‘¢ï¼Ÿé‚£æœ€åæˆ‘ä»¬å°±æ¥è°ˆä¸€è°ˆæŠ½è±¡çš„æ—¶æœºï¼Œå³å¦‚ä½•å°½å¯èƒ½å‡å°‘è¿‡æ—©æˆ–è¿‡åº¦æŠ½è±¡ï¼Ÿ</p><p>æˆ‘è§‰å¾—å¯ä»¥éµå¾ªä¸€ä¸ªåŸåˆ™ï¼ˆ<strong>æ”¶ç›Š &gt;ä»˜å‡º</strong>ï¼‰ä¸¤ä¸ªç­–ç•¥ï¼š</p><ul><li><strong>ç­–ç•¥ä¸€ï¼šä¸ºæµ‹è¯•è€ŒæŠ½è±¡ã€‚</strong>è¿™æ˜¯åˆšéœ€ï¼Œå½“ä½ çš„åˆ¤æ–­å‡ºä¸€ä¸ªä¸šåŠ¡é€»è¾‘å€¼å¾—æ’°å†™å•å…ƒæµ‹è¯•çš„æ—¶å€™ï¼Œä½ ä¸ºäº†è®©å®ƒï¼ˆ<code>OrderService</code>ï¼‰å¯è¢«å•å…ƒæµ‹è¯•ï¼Œä½ å¿…é¡»èƒ½å¤Ÿæ›¿æ¢å®ƒçš„ä¾èµ–ï¼ˆ<code>OrderRepository</code>ï¼‰ã€‚</li><li><strong>ç­–ç•¥äºŒï¼šäº‹ä¸è¿‡ä¸‰åŸåˆ™ã€‚</strong>è¿™æ˜¯å¯¹æŠ—è¿‡åº¦æŠ½è±¡çš„æœ€ä½³å¯å‘å¼è§„åˆ™ã€‚<ul><li><strong>ç¬¬ä¸€æ¬¡</strong>ï¼šä½ å†™äº†ä¸€ä¸ªåŠŸèƒ½ï¼Œ<strong>ä¸è¦æŠ½è±¡</strong>ã€‚å°±å†™å…·ä½“å®ç°ã€‚åšå®ˆ<strong>YAGNI</strong> (You Ain't Gonna Need It) åŸåˆ™ã€‚</li><li><strong>ç¬¬äºŒæ¬¡</strong>ï¼šä½ å†™ä¸€ä¸ªç±»ä¼¼åŠŸèƒ½ï¼Œä½ å¯èƒ½ä¼šå¤åˆ¶-ç²˜è´´-ä¿®æ”¹ã€‚<strong>å¿ä½ï¼Œè¿˜æ˜¯ä¸è¦æŠ½è±¡</strong>ã€‚ä½†ä½ è¦å¼€å§‹è­¦æƒ•äº†ã€‚</li><li><strong>ç¬¬ä¸‰æ¬¡</strong>ï¼šå½“ä½ å¤åˆ¶-ç²˜è´´ç¬¬ä¸‰æ¬¡æ—¶ï¼Œè¯´æ˜<strong>å˜åŒ–çš„æ¨¡å¼</strong>å·²ç»ç¨³å®šå‡ºç°ã€‚æ­¤æ—¶ï¼Œä½ ä¸å†æ˜¯çŒœæµ‹å˜åŒ–ï¼Œä½ æ˜¯åœ¨å“åº”å·²ç»å‘ç”Ÿçš„å˜åŒ–ã€‚<strong>è¿™æ˜¯æŠ½è±¡çš„æœ€ä½³æ—¶æœºã€‚</strong>ä»å…·ä½“çš„ä»£ç ä¸­æç‚¼å‡ºæŠ½è±¡çš„æ¥å£ï¼Œè¿œæ¯”å‡­ç©ºè®¾è®¡ä¸€ä¸ªæŠ½è±¡è¦é è°±å¾—å¤šã€‚</li></ul></li></ul><h2 id="åˆ†æ²»">åˆ†æ²»</h2><p>åˆ†æ²» (Decomposition)çš„ç¬¬ä¸€æ€§åŸç†æ˜¯å°†ä¸€ä¸ªå¤§è§„æ¨¡çš„ã€éš¾ä»¥ç›´æ¥å¤„ç†çš„å¤§é—®é¢˜ï¼Œæ‹†è§£ä¸ºä¸€ç³»åˆ—å¯ç‹¬ç«‹è§£å†³çš„å°é—®é¢˜ï¼Œç„¶åé€šè¿‡ç»„åˆè¿™äº›å°é—®é¢˜çš„è§£ï¼Œæ¥å¾—åˆ°å¤§é—®é¢˜çš„è§£ã€‚</p><p>è¿™ä¸ªé“ç†æˆ‘ä»¬éƒ½æ‡‚ï¼Œå› ä¸ºäººè„‘çš„è®¤çŸ¥è´Ÿè·æœ‰é™ã€‚ä¸€ä¸ªåºå¤§ä¸” All-in-Oneçš„ç³»ç»Ÿï¼Œå…¶å†…éƒ¨çŠ¶æ€å’Œä¾èµ–å…³ç³»çš„ç»„åˆå‘ˆæŒ‡æ•°çº§å¢é•¿ï¼Œå¾ˆå¿«ä¼šè¶…è¿‡ä»»ä½•å·¥ç¨‹å¸ˆï¼ˆæˆ–å›¢é˜Ÿï¼‰çš„å¤„ç†ä¸Šé™ã€‚</p><p>åœ¨æˆ‘çš„ä¸‰å¹´ç»éªŒé‡Œï¼Œæˆ‘æœ€ææƒ§çš„ï¼Œè«è¿‡äºåœ¨ ğŸ’©ä»£ç ä¸­ï¼Œä¸€å¤´æ‰è¿›ä¸€ä¸ªå‡ åƒè¡Œçš„å‡½æ•°ä¸­ï¼š</p><ul><li>ä½ æ ¹æœ¬ä¸çŸ¥é“å®ƒçš„<strong>ä¸»çº¿</strong>æ˜¯ä»€ä¹ˆï¼Œå› ä¸º<code>if-else</code>çš„<strong>æ”¯çº¿</strong>å·²ç»æŠŠå®ƒå˜æˆäº†æ„å¤§åˆ©é¢æ¡ã€‚</li><li>ä½ ä¸æ•¢<strong>é‡æ„</strong>ï¼Œå› ä¸ºä½ æ ¹æœ¬ä¸çŸ¥é“ä½ æ‰‹é‡Œè¿™ä¸ªå°é—®é¢˜ï¼Œæ˜¯å¤šå°‘ä¸ªå¤§é—®é¢˜å…±äº«çš„<strong>å†…è„</strong>ï¼Œè´Ÿè´Ÿå¾—æ­£ä½ å—å¾—äº†å—ï¼Ÿ</li><li>ä½ æ— æ³•<strong>æµ‹è¯•</strong>ï¼Œå› ä¸ºä½ è¿<strong>å•å…ƒ</strong>çš„è¾¹ç•Œéƒ½æ‰¾ä¸åˆ°ã€‚</li></ul><h3 id="åˆ†æ²»çš„æœ¬è´¨">åˆ†æ²»çš„æœ¬è´¨</h3><p>åœ¨æˆ‘çœ‹æ¥ï¼Œåˆ†æ²»çš„æœ¬è´¨åœ¨äºæ²»ï¼Œè€Œä¸åœ¨äºåˆ†ã€‚<strong>åˆ†ï¼ˆdivideï¼‰åªæ˜¯æ‰‹æ®µï¼Œè€Œæ²»ï¼ˆConquerï¼‰æ‰æ˜¯ç›®çš„</strong>ã€‚</p><p>"åˆ†"ï¼ˆDivideï¼‰æ˜¯ä¸ºäº†ä»€ä¹ˆï¼Ÿ</p><ul><li><p>é™ä½è®¤çŸ¥è´Ÿè·</p></li><li><p>éš”ç¦»å˜åŒ–</p></li><li><p>æé«˜å¯æµ‹è¯•æ€§</p></li><li><p>å®ç°å¤ç”¨</p></li></ul><p>ä½†è¿™äº›éƒ½æ˜¯ä¸ºäº†"æ²»"ï¼ˆConquerï¼‰æœåŠ¡çš„ï¼š</p><ul><li><p>èƒ½å¤Ÿç‹¬ç«‹ç†è§£æ¯ä¸ªéƒ¨åˆ†</p></li><li><p>èƒ½å¤Ÿç‹¬ç«‹å¼€å‘æ¯ä¸ªéƒ¨åˆ†</p></li><li><p>èƒ½å¤Ÿç‹¬ç«‹æµ‹è¯•æ¯ä¸ªéƒ¨åˆ†</p></li><li><p>èƒ½å¤Ÿç‹¬ç«‹ä¿®æ”¹æ¯ä¸ªéƒ¨åˆ†</p></li><li><p>æœ€ç»ˆèƒ½å¤Ÿæœ‰æ•ˆåœ°æ§åˆ¶å¤æ‚åº¦</p></li></ul><p>å¦‚æœåª"åˆ†"ä¸"æ²»"ï¼Œå°±ä¼šå‡ºç°ï¼š</p><ul><li><p>è¿‡åº¦æ‹†åˆ†ï¼Œåè€Œå¢åŠ å¤æ‚åº¦</p></li><li><p>å½¢å¼ä¸Šåˆ†ç¦»ï¼Œä½†ä¾èµ–å…³ç³»æ··ä¹±</p></li><li><p>çœ‹èµ·æ¥æ¨¡å—åŒ–ï¼Œä½†å®é™…ä¸Šæ”¹ä¸€å¤„ç‰µä¸€å‘è€ŒåŠ¨å…¨èº«</p></li></ul><h3 id="åˆ†æ²»çš„è¾¹ç•Œ">åˆ†æ²»çš„è¾¹ç•Œ</h3><p><strong>åˆ†æ²»æœ€å¤§çš„é£é™©ï¼Œæ˜¯é”™è¯¯çš„è¾¹ç•Œåˆ’åˆ†ã€‚</strong>ä¸€ä¸ªé”™è¯¯çš„åˆ†æ²»ï¼Œå³å°†ä¸€ä¸ªæœ¬åº”å†…èšçš„æ•´ä½“å¼ºè¡Œæ‹†å¼€ï¼Œè¿™éä½†ä¸èƒ½é™ä½å¤æ‚åº¦ï¼Œåè€Œä¼šå› ä¸ºå¼•å…¥é«˜è€¦åˆå’Œé€šä¿¡å¼€é”€ï¼ˆå¦‚ä¸å¿…è¦çš„ç½‘ç»œè°ƒç”¨ï¼‰ï¼Œè€Œå¢åŠ äº†ç³»ç»Ÿçš„æ„å¤–å¤æ‚åº¦ã€‚</p><p>å…³äºåˆ†çš„è¾¹ç•Œï¼Œæˆ‘ä¸ªäººè§‰å¾—å¯ä»¥ä»ä¸¤ä¸ªå±‚çº§è¿›è¡Œè€ƒè™‘ï¼š</p><ul><li>ä»£ç å±‚çº§ï¼šå•ä¸€èŒè´£ï¼ˆSRPï¼‰</li><li>ç³»ç»Ÿå±‚çº§ï¼šé™ç•Œä¸Šä¸‹æ–‡ï¼ˆBounded Contextï¼‰</li></ul><hr /><p>åœ¨ä»£ç çº§åˆ«ï¼Œæˆ‘ä»¬é¢å¯¹çš„é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿæ˜¯<strong>å˜æ›´</strong>ã€‚ä¸€ä¸ªè½¯ä»¶çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œæœ€å¤§çš„æˆæœ¬æ˜¯ç»´æŠ¤ï¼Œè€Œç»´æŠ¤çš„æ ¸å¿ƒå°±æ˜¯åº”å¯¹å˜æ›´éœ€æ±‚ã€‚</p><blockquote><p>A class should have only one reason to change. â€”â€” Robert C. Martin(Uncle Bob)</p><p>ä¸€ä¸ªç±»åº”è¯¥åªæœ‰ä¸€ä¸ªå˜æ›´çš„ç†ç”±ã€‚</p></blockquote><ul><li><strong>åˆ† (Divide)ï¼š</strong> å¦‚ä½•åˆ†ï¼ŸSRPå‘Šè¯‰æˆ‘ä»¬ï¼Œ<strong>å˜æ›´çš„ç†ç”± (Reason to Change)å°±æ˜¯ä½ åˆ†çš„è¾¹ç•Œã€‚</strong><ul><li><strong>é—®é¢˜ï¼š</strong> å‡è®¾ä¸€ä¸ª <code>Employee</code>ç±»ï¼Œå®ƒæ—¢è´Ÿè´£è®¡ç®—è–ªé…¬ (A ç†ç”±ï¼šè´¢åŠ¡è§„åˆ™å˜æ›´)ï¼Œåˆè´Ÿè´£ä¿å­˜æ•°æ®åˆ°æ•°æ®åº“ (Bç†ç”±ï¼šDBA å˜æ›´è¡¨ç»“æ„)ï¼Œè¿˜è´Ÿè´£ç”ŸæˆæŠ¥è¡¨ (C ç†ç”±ï¼šHR å˜æ›´æŠ¥è¡¨æ ¼å¼)ã€‚</li><li><strong>å¤æ‚åº¦ï¼š</strong> è¿™ 3 ä¸ªç†ç”±ï¼ˆA, B,Cï¼‰è¢«è€¦åˆåœ¨åŒä¸€ä¸ªç±»é‡Œã€‚A çš„å˜æ›´å¯èƒ½ä¼šç ´å B çš„åŠŸèƒ½ï¼›B çš„å˜æ›´åˆå¯èƒ½å½±å“Cã€‚è¿™å°±æ˜¯ <span class="math inline">\(N^2\)</span> å¤æ‚åº¦çš„é›å½¢ã€‚</li></ul></li><li><strong>æ²» (Conquer)ï¼š</strong> æˆ‘ä»¬å°†è¿™ä¸ªå¤§é—®é¢˜åˆ†è§£ã€‚<ul><li><code>PayrollCalculator</code> ï¼ˆåªå›  A è€Œå˜ï¼‰</li><li><code>EmployeeRepository</code> ï¼ˆåªå›  B è€Œå˜ï¼‰</li><li><code>EmployeeReporter</code> ï¼ˆåªå›  C è€Œå˜ï¼‰</li></ul></li><li><strong>åˆ (Combine)ï¼š</strong>é€šè¿‡æ¸…æ™°çš„æ¥å£å°†å®ƒä»¬ç»„åˆèµ·æ¥ï¼Œå®Œæˆå®Œæ•´çš„ä¸šåŠ¡ã€‚</li></ul><p>æ‰€ä»¥åœ¨ä»£ç çº§åˆ«ï¼Œ<strong>SRPå°±æ˜¯åˆ†æ²»æ€æƒ³åœ¨ç®¡ç†å˜æ›´å¤æ‚åº¦è¿™ä¸ªç‰¹å®šåœºæ™¯ä¸‹çš„åº”ç”¨ã€‚</strong>å®ƒçš„åˆ†æ˜¯<strong>ä»¥"å˜æ›´çš„ç†ç”±"ä¸ºè¾¹ç•Œ</strong>ï¼ŒæŠŠä¸åŒå˜æ›´è½´å¿ƒä¸Šçš„é€»è¾‘ï¼ˆèŒè´£ï¼‰éš”ç¦»å¼€ï¼Œä»è€Œå®ç°é«˜å†…èšã€ä½è€¦åˆï¼Œé™ä½ä»£ç çš„è®¤çŸ¥å’Œè€¦åˆå¤æ‚åº¦ã€‚</p><hr /><p>åœ¨ç³»ç»Ÿçº§åˆ«ï¼ˆç‰¹åˆ«æ˜¯å¤§å‹ä¼ä¸šåº”ç”¨ï¼‰ï¼Œæˆ‘ä»¬é¢å¯¹çš„é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿæ˜¯<strong>ä¸šåŠ¡çš„è§„æ¨¡å’Œè¯­ä¹‰çš„æ¨¡ç³Šæ€§</strong>ã€‚å½“ä¸€ä¸ªç³»ç»Ÿå¤§åˆ°éœ€è¦å‡ åä¸Šç™¾äººåä½œæ—¶ï¼Œæœ€å¤§çš„é—®é¢˜ä¸å†æ˜¯"å˜æ›´ç†ç”±"ï¼Œè€Œæ˜¯"æˆ‘ä»¬è¯´çš„'å®¢æˆ·'æ˜¯åŒä¸€ä¸ªä¸œè¥¿å—ï¼Ÿ"</p><ul><li>é”€å”®å›¢é˜Ÿçš„å®¢æˆ· (Customer)ï¼šæœ‰è´­ä¹°æ„å‘çš„æ½œåœ¨ä¸ªä½“ã€‚</li><li>å®¢æœå›¢é˜Ÿçš„å®¢æˆ· (Customer)ï¼šæœ‰æœåŠ¡å·¥å•çš„å·²æ³¨å†Œç”¨æˆ·ã€‚</li><li>è´¢åŠ¡å›¢é˜Ÿçš„å®¢æˆ· (Customer)ï¼šæœ‰ä»˜æ¬¾è®°å½•çš„æ³•å¾‹å®ä½“ã€‚</li></ul><p>å¦‚æœè¯•å›¾å»ºç«‹ä¸€ä¸ªç»Ÿä¸€çš„ God Modelæ¥æ»¡è¶³æ‰€æœ‰äººï¼Œè¿™ä¸ªæ¨¡å‹å°†å˜å¾—æ— æ¯”å¤æ‚ã€å……æ»¡<code>if-else</code>ï¼Œå¹¶ä¸”å¯¹æ‰€æœ‰äººæ¥è¯´éƒ½æ˜¯é”™çš„ã€‚</p><blockquote><p>é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰æå‡ºçš„é™ç•Œä¸Šä¸‹æ–‡ï¼ˆBoundedContextï¼‰å°±æ˜¯æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚</p></blockquote><p><strong>åˆ† (Divide)ï¼š</strong> å¦‚ä½•åˆ†ï¼ŸBCå‘Šè¯‰æˆ‘ä»¬ï¼Œ<strong>ä¸šåŠ¡çš„é¢†åŸŸè¾¹ç•Œå’Œå›¢é˜Ÿçš„ç»„ç»‡è¾¹ç•Œå°±æ˜¯ä½ åˆ†çš„è¾¹ç•Œã€‚</strong></p><ul><li><strong>é—®é¢˜ï¼š</strong> è¯•å›¾ç”¨ä¸€ä¸ªç»Ÿä¸€æ¨¡å‹æè¿°æ•´ä¸ªä¼ä¸šçš„ä¸šåŠ¡ã€‚</li><li><strong>å¤æ‚åº¦ï¼š</strong> è¯­ä¹‰å†²çªï¼ˆSemanticConflictï¼‰å’Œç»„ç»‡æ²Ÿé€šçš„å¼€é”€ï¼ˆ<span class="math inline">\(N^2\)</span>æ²Ÿé€šè·¯å¾„ï¼‰ã€‚</li></ul><p><strong>æ²» (Conquer)ï¼š</strong>æˆ‘ä»¬å°†è¿™ä¸ªå¤§é¢†åŸŸåˆ†è§£ä¸ºå¤šä¸ªå­é¢†åŸŸã€‚</p><ul><li><strong>é”€å”®ä¸Šä¸‹æ–‡ (Sales Context)ï¼š</strong>åœ¨è¿™ä¸ªè¾¹ç•Œå†…ï¼Œå®¢æˆ·æ¨¡å‹åªåŒ…å«é”€å”®æ‰€éœ€çš„å±æ€§ã€‚</li><li><strong>å®¢æœä¸Šä¸‹æ–‡ (Support Context)ï¼š</strong>åœ¨è¿™ä¸ªè¾¹ç•Œå†…ï¼Œå®¢æˆ·æ¨¡å‹åªåŒ…å«æœåŠ¡æ‰€éœ€çš„å±æ€§ã€‚</li><li><strong>è´¢åŠ¡ä¸Šä¸‹æ–‡ (Billing Context)ï¼š</strong>åœ¨è¿™ä¸ªè¾¹ç•Œå†…ï¼Œå®¢æˆ·æ¨¡å‹åªåŒ…å«è´¦åŠ¡æ‰€éœ€çš„å±æ€§ã€‚</li></ul><p><strong>åˆ (Combine)ï¼š</strong> é€šè¿‡æ˜ç¡®çš„ä¸Šä¸‹æ–‡æ˜ å°„å›¾ï¼ˆContextMapï¼‰ï¼Œæ¯”å¦‚é˜²è…å±‚ï¼ˆACLï¼‰æˆ–å¼€æ”¾ä¸»æœºæœåŠ¡ï¼ˆOHSï¼‰ï¼Œæ¥å®šä¹‰è¿™äº›ä¸Šä¸‹æ–‡ä¹‹é—´çš„å…³ç³»ã€‚</p><p>åœ¨ç³»ç»Ÿçº§åˆ«ï¼Œ<strong>BCå°±æ˜¯åˆ†æ²»æ€æƒ³åœ¨ç®¡ç†ä¸šåŠ¡å’Œè¯­ä¹‰å¤æ‚åº¦è¿™ä¸ªç‰¹å®šåœºæ™¯ä¸‹çš„åº”ç”¨ã€‚</strong>å®ƒçš„åˆ†æ˜¯<strong>ä»¥"è¯­ä¹‰ä¸€è‡´æ€§"ä¸ºè¾¹ç•Œ</strong>ï¼ŒæŠŠåºå¤§çš„ã€æ¨¡ç³Šçš„ä¸šåŠ¡é¢†åŸŸåˆ†è§£ä¸ºå¤šä¸ªè¾¹ç•Œæ¸…æ™°ã€è¯­ä¹‰æ˜ç¡®çš„å­åŸŸï¼Œä»è€Œè®©æ¯ä¸ªå­åŸŸï¼ˆå¾®æœåŠ¡ï¼‰å†…éƒ¨å®ç°é«˜å†…èšã€ä½è€¦åˆã€‚</p><h3 id="çœŸæ­£çš„åˆ†æ²»">çœŸæ­£çš„åˆ†æ²»</h3><p>å¦ç™½è¯´ï¼Œç›®å‰æˆ‘åœ¨ç³»ç»Ÿçº§åˆ«å±‚é¢çš„åˆ†æ²»èƒ½åŠ›è¿˜è¾ƒä¸ºæ¬ ç¼ºï¼Œè¿™æ–¹é¢è¿˜éœ€è¦æ›´å¤šçš„æ²‰æ·€å’Œå­¦ä¹ ï¼Œæ‰€ä»¥ç°åœ¨æˆ‘è¿˜æ— æ³•åšæ›´è¿›ä¸€æ­¥çš„é˜è¿°ã€‚ä½†æ˜¯è¿™é‡Œæˆ‘æƒ³é€šè¿‡æˆ‘è¿‡å»å·¥ä½œä¸­çš„ä¸€ä¸ªä¾‹å­ï¼Œæ¥å°è¯•é˜è¿°ä¸€ä¸‹æˆ‘æ‰€è®¤ä¸ºçš„çœŸæ­£çš„åˆ†æ²»ã€‚</p><p>åœ¨æˆ‘æ‰€è´Ÿè´£çš„æ¸¸æˆä¸šåŠ¡ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªæ¥å£è´Ÿè´£æ¸¸æˆç»“ç®—çš„ï¼Œå®ƒæ‰€åŒ…å«çš„éœ€æ±‚ï¼ˆéƒ¨åˆ†ï¼‰åŠŸèƒ½å¤§æ¦‚å¦‚ä¸‹ï¼š</p><blockquote><p>å®ƒè¦è´Ÿè´£å¤šæ¬¾è”æœºæ¸¸æˆæ¨¡å¼çš„ç»“ç®—é€»è¾‘ï¼Œå³è¦è®¡ç®—æˆç»©ã€ä¿å­˜æˆç»©ã€æ›´æ–°å†å²è£èª‰ï¼Œè¿˜è¦æ¶‰åŠå¸ˆå¾’ç³»ç»Ÿã€ä»»åŠ¡ç³»ç»Ÿçš„å„ä¸ªåŠ æˆã€å¥–åŠ±å’Œæ´»è·ƒåº¦æ›´æ–°ï¼Œæœ‰æ—¶å€™è¿˜è¦æ¶‰åŠå„ç§è¿è¥æ´»åŠ¨çš„å‘å¥–é€»è¾‘ï¼ˆè€Œä¸”å®ƒä»¬å‘çš„å¥–åŠ±è¦åœ¨ç»“ç®—æ¥å£è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œä¸èƒ½çº¯å¼‚æ­¥ï¼‰ã€‚</p></blockquote><p>HTTP å±‚ç®€åŒ–çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(api *Api)</span></span> Settle(c *gin.Context) &#123;</span><br><span class="line"><span class="comment">// å‚æ•°è§£æ</span></span><br><span class="line">  <span class="keyword">var</span> ps <span class="keyword">struct</span> &#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> err := c.ShouldBind(&amp;ps); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ ¼å¼åŒ–æˆç»©</span></span><br><span class="line">roomScorePtr, err := api.parseUploadScoreParam(&amp;ps)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤„ç†ä¸åŒçš„æ¸¸æˆæ¨¡å¼</span></span><br><span class="line"><span class="keyword">if</span> mode == GameMode1 &#123;</span><br><span class="line"><span class="comment">// æ¸¸æˆæ¨¡å¼1å¤„ç†é€»è¾‘</span></span><br><span class="line">result = api.processGameMode1(ctx, roomScorePtr)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// æ¸¸æˆæ¨¡å¼2å¤„ç†é€»è¾‘</span></span><br><span class="line">result = api.processGameMode2(ctx, roomScorePtr)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘å¸ƒäº‹ä»¶</span></span><br><span class="line">eventbus.AsyncPublish(<span class="string">&quot;settle_game_mode_1&quot;</span>, roomScorePtr)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä»»åŠ¡é€šçŸ¥</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// å“åº”ç»“æœ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…‰è¿™ä¸€å±‚å°±å­˜åœ¨äº†éå¸¸å¤šçš„é—®é¢˜ï¼Œå…·ä½“æ¥è¯´ï¼š</p><ol type="1"><li><p>æ··æ‚äº†ä¸‰ä¸ªæŠ½è±¡å±‚æ¬¡</p><ul><li><p>HTTP å±‚ï¼šå‚æ•°ç»‘å®šã€å“åº”æ„å»º</p></li><li><p>ä¸šåŠ¡ç¼–æ’å±‚ï¼šæ¨¡å¼åˆ¤æ–­ã€æµç¨‹æ§åˆ¶</p></li><li><p>ä¸šåŠ¡æ‰§è¡Œå±‚ï¼šè®¡åˆ†é€»è¾‘ã€äº‹ä»¶å‘å¸ƒã€ä»»åŠ¡æ£€æŸ¥</p></li></ul></li><li><p>èŒè´£è¿‡è½½ï¼ˆè‡³å°‘ 5 ä¸ªèŒè´£ï¼‰</p><ul><li><p>HTTP è¯·æ±‚å¤„ç†</p></li><li><p>å‚æ•°éªŒè¯å’Œè§£æ</p></li><li><p>ä¸šåŠ¡æ¨¡å¼è·¯ç”±</p></li><li><p>å‰¯ä½œç”¨ç®¡ç†ï¼ˆäº‹ä»¶å‘å¸ƒã€ä»»åŠ¡é€šçŸ¥ï¼‰</p></li><li><p>å“åº”æ„å»º</p></li></ul></li></ol><p>ä¸šåŠ¡é€»è¾‘å±‚å°±æ›´å¤¸å¼ äº†ï¼Œå‡ ç™¾è¡Œçš„æ„å¤§åˆ©é¢æ¡ä»£ç ï¼Œè¿™é‡Œæˆ‘å°±ä¸è´´äº†ï¼Œä½ å¯ä»¥æƒ³æƒ³å¾—åˆ°ï¼Œé‡Œé¢å°±æ˜¯å¹³é“ºç›´å™å†™æŠŠä¸šåŠ¡è¦çš„é€»è¾‘ä¸€è¡Œè¡Œå®ç°èµ·æ¥ã€‚ä½ å¯ä»¥ä¼šè¯´ï¼Œæˆ‘æŠŠä»–ä»¬éƒ½æŠ½æˆä¸€ä¸ªä¸ªå‡½æ•°ï¼Œè¿™æ ·ä¸å°±å¯ä»¥äº†å—ï¼Ÿæ¯”å¦‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(api *Api)</span></span> processGameMode1(ctx context.Context, score *Score) <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line"><span class="comment">// åŸæ¥ 500 è¡Œä»£ç ï¼Œç°åœ¨æ‹†æˆè¿™æ ·ï¼š</span></span><br><span class="line">  result1 := step1(ctx, score)</span><br><span class="line">  result2 := step2(ctx, score, result1)</span><br><span class="line">  result3 := step3(ctx, score, result2)</span><br><span class="line">  result4 := step4(ctx, score, result3)</span><br><span class="line">  result  := step5(ctx, score, result4)</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹èµ·æ¥"åˆ†"äº†ï¼Œä½†è¿™ç§æ‹†åˆ†æ²¡æœ‰å®ç°"æ²»ç†"ï¼Œåªæ˜¯æŠŠæ··ä¹±ä»ä¸€ä¸ªåœ°æ–¹æ¬åˆ°äº†äº”ä¸ªåœ°æ–¹ã€‚</p><p>âŒ æ— æ³•ç‹¬ç«‹ç†è§£ï¼šå¿…é¡»çœ‹å®Œæ•´æµç¨‹æ‰èƒ½ç†è§£æ¯ä¸ªå‡½æ•°</p><p>âŒ æ— æ³•ç‹¬ç«‹æµ‹è¯•ï¼šæ¯ä¸ªå‡½æ•°éƒ½ä¾èµ–ä¸Šä¸‹æ–‡</p><p>âŒ æ— æ³•ç‹¬ç«‹ä¿®æ”¹ï¼šæ”¹ä¸€ä¸ªå‡½æ•°ä¼šå½±å“å…¶ä»–å‡½æ•°</p><p>âŒ æ— æ³•ç‹¬ç«‹å¤ç”¨ï¼šå‡½æ•°ä¸ç‰¹å®šæµç¨‹å¼ºè€¦åˆ</p><p>é‚£æ€æ ·æ‰ç®—æ˜¯çœŸæ­£çš„æ²»ç†å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ä» 4 ä¸ªç»´åº¦è¿›è¡Œæ€è€ƒï¼š</p><ul><li><p>å¯ç‹¬ç«‹ç†è§£ï¼ˆè®¤çŸ¥æ²»ç†ï¼‰</p></li><li><p>å¯ç‹¬ç«‹ä¿®æ”¹ï¼ˆæ¼”åŒ–æ²»ç†ï¼‰</p></li><li><p>å¯ç‹¬ç«‹éªŒè¯ï¼ˆæµ‹è¯•æ²»ç†ï¼‰</p></li><li><p>å¯çµæ´»ç»„åˆï¼ˆç»„åˆæ²»ç†ï¼‰</p></li></ul><blockquote><p>å¥½çš„æ¶æ„è®©å¤æ‚åº¦å¯æ§ â€”â€”ä¸æ˜¯æ¶ˆé™¤å¤æ‚åº¦ï¼ˆä¸šåŠ¡æœ¬æ¥å°±å¤æ‚ï¼‰ï¼Œè€Œæ˜¯è®©å¤æ‚åº¦åœ¨æ¯ä¸ªå±€éƒ¨éƒ½æ˜¯å¯ç®¡ç†çš„ã€‚</p></blockquote><p>é¦–å…ˆæˆ‘ä»¬çœ‹è®¤çŸ¥æ²»ç†ï¼šæ¯ä¸ªå•å…ƒå¯ä»¥ç‹¬ç«‹ç†è§£ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ æ— æ³•ç‹¬ç«‹ç†è§£ï¼ˆå½“å‰ä»£ç çš„é—®é¢˜ï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processGameMode1</span><span class="params">(...)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 500+ è¡Œä»£ç </span></span><br><span class="line">    <span class="comment">// æ—¢ç®—åˆ†ï¼Œåˆå¤„ç†æˆ˜é˜Ÿï¼Œåˆæ„å»ºå“åº”ï¼Œåˆå­˜å‚¨</span></span><br><span class="line">    <span class="comment">// å¿…é¡»ä»å¤´åˆ°å°¾è¯»å®Œæ‰èƒ½ç†è§£ä»»ä½•ä¸€éƒ¨åˆ†</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… å¯ä»¥ç‹¬ç«‹ç†è§£</span></span><br><span class="line"><span class="keyword">type</span> ScoreCalculationProcessor <span class="keyword">struct</span> &#123;</span><br><span class="line">    calculator ScoreCalculator</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *ScoreCalculationProcessor)</span></span> Process(ctx context.Context, input *SettlementContext, result *SettlementResult) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 10è¡Œä»£ç ï¼Œä¸€çœ¼å°±èƒ½çœ‹æ‡‚ï¼š</span></span><br><span class="line">    <span class="comment">// 1. éå†ç©å®¶</span></span><br><span class="line">    <span class="comment">// 2. è°ƒç”¨ calculator è®¡ç®—åˆ†æ•°</span></span><br><span class="line">    <span class="comment">// 3. è½¬æ¢ä¸ºå¥–åŠ±</span></span><br><span class="line">    <span class="comment">// 4. å­˜å…¥ result</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, player := <span class="keyword">range</span> input.Players &#123;</span><br><span class="line">        score := p.calculator.Calculate(player, input)</span><br><span class="line">        reward := p.calculator.ConvertToReward(score)</span><br><span class="line">        result.PlayerRewards[player.ID] = &amp;PlayerReward&#123;</span><br><span class="line">            PlayerID:    player.ID,</span><br><span class="line">            BaseReward:  reward,</span><br><span class="line">            TotalReward: reward.Clone(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &quot;æ²»ç†&quot;çš„ä½“ç°ï¼š</span></span><br><span class="line"><span class="comment">// - ä¸éœ€è¦ç†è§£ HTTP å±‚æ€ä¹ˆå·¥ä½œ</span></span><br><span class="line"><span class="comment">// - ä¸éœ€è¦ç†è§£å…¶ä»– Processor åšä»€ä¹ˆ</span></span><br><span class="line"><span class="comment">// - ä¸éœ€è¦ç†è§£æ•°æ®å¦‚ä½•å­˜å‚¨</span></span><br><span class="line"><span class="comment">// - åªéœ€è¦ç†è§£ï¼šè¾“å…¥ç©å®¶åˆ†æ•° â†’ è¾“å‡ºå¥–åŠ±</span></span><br></pre></td></tr></table></figure><p>å†æ¥çœ‹æ¼”åŒ–æ²»ç†ï¼šæ¯ä¸ªå•å…ƒå¯ä»¥ç‹¬ç«‹ä¿®æ”¹ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ æ— æ³•ç‹¬ç«‹ä¿®æ”¹</span></span><br><span class="line"><span class="comment">// å½“å‰ä»£ç ï¼šè¦ä¿®æ”¹å¸ˆå¾’åŠ æˆé€»è¾‘</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processGameMode1</span><span class="params">(...)</span></span> &#123;</span><br><span class="line">    <span class="comment">// ... 150è¡Œå…¶ä»–é€»è¾‘ ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¸ˆå¾’é€»è¾‘åŸ‹åœ¨è¿™é‡Œ</span></span><br><span class="line">    <span class="keyword">if</span> masterRelation != <span class="literal">nil</span> &#123;</span><br><span class="line">        bonus = baseReward * <span class="number">0.2</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... åˆæ˜¯100è¡Œå…¶ä»–é€»è¾‘ ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// é—®é¢˜ï¼š</span></span><br><span class="line"><span class="comment">// 1. è¦ä¿®æ”¹å¸ˆå¾’åŠ æˆç‡ï¼Œå¿…é¡»æ‰¾åˆ°è¿™æ®µä»£ç ï¼ˆåœ¨200+è¡Œä¸­å®šä½ï¼‰</span></span><br><span class="line"><span class="comment">// 2. ä¿®æ”¹åè¦æµ‹è¯•æ•´ä¸ª processGameMode1ï¼ˆå½±å“é¢ä¸æ¸…æ™°ï¼‰</span></span><br><span class="line"><span class="comment">// 3. æ— æ³•ç¡®å®šæ˜¯å¦å½±å“äº†å…¶ä»–é€»è¾‘</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… å¯ä»¥ç‹¬ç«‹ä¿®æ”¹</span></span><br><span class="line"><span class="keyword">type</span> MasterApprenticeProcessor <span class="keyword">struct</span> &#123;</span><br><span class="line">    masterSvc MasterApprenticeService</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *MasterApprenticeProcessor)</span></span> Process(...) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// æ‰€æœ‰å¸ˆå¾’é€»è¾‘éƒ½åœ¨è¿™é‡Œ</span></span><br><span class="line">    <span class="comment">// ä¿®æ”¹æ—¶ï¼š</span></span><br><span class="line">    <span class="comment">// 1. ç›´æ¥å®šä½åˆ°è¿™ä¸ªæ–‡ä»¶</span></span><br><span class="line">    <span class="comment">// 2. åªéœ€è¦æµ‹è¯•è¿™ä¸ª Processor</span></span><br><span class="line">    <span class="comment">// 3. æ˜ç¡®ä¸ä¼šå½±å“å…¶ä»–é€»è¾‘</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &quot;æ²»ç†&quot;çš„ä½“ç°ï¼š</span></span><br><span class="line"><span class="comment">// - éœ€æ±‚å˜æ›´æœ‰æ˜ç¡®çš„ä¿®æ”¹è¾¹ç•Œ</span></span><br><span class="line"><span class="comment">// - å½±å“èŒƒå›´å¯æ§</span></span><br><span class="line"><span class="comment">// - å›å½’æµ‹è¯•èŒƒå›´å¯æ§</span></span><br></pre></td></tr></table></figure><p>å†æ¥çœ‹æµ‹è¯•æ²»ç†ï¼šæ¯ä¸ªå•å…ƒå¯ä»¥ç‹¬ç«‹éªŒè¯ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ æ— æ³•ç‹¬ç«‹éªŒè¯</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestProcessGameMode1</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    <span class="comment">// è¦æµ‹è¯•å¸ˆå¾’åŠ æˆï¼Œéœ€è¦ï¼š</span></span><br><span class="line">    <span class="comment">// - å‡†å¤‡å®Œæ•´çš„æˆ¿é—´æ•°æ®</span></span><br><span class="line">    <span class="comment">// - Mock æ‰€æœ‰æ•°æ®åº“è°ƒç”¨</span></span><br><span class="line">    <span class="comment">// - Mock æ’åç³»ç»Ÿ</span></span><br><span class="line">    <span class="comment">// - Mock ä»»åŠ¡ç³»ç»Ÿ</span></span><br><span class="line">    <span class="comment">// - Mock æ´»åŠ¨ç³»ç»Ÿ</span></span><br><span class="line">    <span class="comment">// ... å¯èƒ½éœ€è¦ 500+ è¡Œæµ‹è¯•ä»£ç </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è€Œä¸”æ— æ³•ç²¾ç¡®æµ‹è¯•å¸ˆå¾’åŠ æˆé€»è¾‘</span></span><br><span class="line">    <span class="comment">// åªèƒ½æµ‹è¯•æ•´ä½“æ˜¯å¦å·¥ä½œ</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… å¯ä»¥ç‹¬ç«‹éªŒè¯</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestMasterApprenticeProcessor</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    <span class="comment">// åªéœ€è¦ mock ä¸€ä¸ªæ¥å£</span></span><br><span class="line">    mockSvc := &amp;MockMasterApprenticeService&#123;&#125;</span><br><span class="line">    processor := &amp;MasterApprenticeProcessor&#123;masterSvc: mockSvc&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‡†å¤‡æœ€å°åŒ–çš„è¾“å…¥</span></span><br><span class="line">    input := &amp;SettlementContext&#123;&#125;</span><br><span class="line">    result := &amp;SettlementResult&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰§è¡Œ</span></span><br><span class="line">    err := processor.Process(ctx, input, result)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç²¾ç¡®éªŒè¯å¸ˆå¾’åŠ æˆé€»è¾‘</span></span><br><span class="line">    assert...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &quot;æ²»ç†&quot;çš„ä½“ç°ï¼š</span></span><br><span class="line"><span class="comment">// - 20è¡Œä»£ç å°±èƒ½æµ‹è¯•æ ¸å¿ƒé€»è¾‘</span></span><br><span class="line"><span class="comment">// - æµ‹è¯•ç”¨ä¾‹æ¸…æ™°ï¼ˆè¾“å…¥100é‡‘å¸ï¼ŒåŠ æˆ20%ï¼Œå¾—åˆ°20é‡‘å¸ï¼‰</span></span><br><span class="line"><span class="comment">// - æµ‹è¯•å¿«é€Ÿï¼ˆæ— éœ€æ•°æ®åº“ï¼Œæ— éœ€ HTTPï¼‰</span></span><br><span class="line"><span class="comment">// - æµ‹è¯•ç¨³å®šï¼ˆä¸ä¾èµ–å¤–éƒ¨çŠ¶æ€ï¼‰</span></span><br></pre></td></tr></table></figure><p>æœ€åçœ‹ç»„åˆæ²»ç†ï¼šæ•´ä½“å¯ä»¥çµæ´»ç»„è£…ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ æ— æ³•çµæ´»ç»„åˆ</span></span><br><span class="line"><span class="comment">// å½“å‰ä»£ç ï¼šè¦æ”¯æŒæ–°çš„æ¸¸æˆæ¨¡å¼</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(api *Api)</span></span> Settle(c *gin.Context) &#123;</span><br><span class="line">    <span class="keyword">if</span> mode == GameMode1 &#123;</span><br><span class="line">        result = api.processGameMode1(...)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> mode == GameMode2 &#123;</span><br><span class="line">        result = api.processGameMode2(...)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> mode == GameModeNew &#123;</span><br><span class="line">        <span class="comment">// è¦æ·»åŠ æ–°æ¨¡å¼ï¼Œå¿…é¡»ï¼š</span></span><br><span class="line">        <span class="comment">// 1. ä¿®æ”¹è¿™ä¸ªä¸»æµç¨‹</span></span><br><span class="line">        <span class="comment">// 2. å®ç°ä¸€ä¸ªæ–°çš„ processGameModeXXX å‡½æ•°</span></span><br><span class="line">        <span class="comment">// 3. æ¯ä¸ªå‡½æ•°å†…éƒ¨é‡å¤å¤§é‡ç›¸åŒé€»è¾‘</span></span><br><span class="line">        result = api.processGameModeXXX(...)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… å¯ä»¥çµæ´»ç»„åˆ</span></span><br><span class="line"><span class="comment">// æ–°å¢æ¸¸æˆæ¨¡å¼æ—¶ï¼š</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. åˆ›å»ºæ–°çš„ Pipelineï¼ˆä¸éœ€è¦ä¿®æ”¹ç°æœ‰ä»£ç ï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *SettlementPipelineFactory)</span></span> CreateNewModePipeline() *SettlementPipeline &#123;</span><br><span class="line">    <span class="keyword">return</span> NewSettlementPipeline(</span><br><span class="line">        f.scoreCalc,       <span class="comment">// å¤ç”¨</span></span><br><span class="line">        f.ranking,         <span class="comment">// å¤ç”¨</span></span><br><span class="line">        f.activity,        <span class="comment">// å¤ç”¨</span></span><br><span class="line">        <span class="comment">// ä¸éœ€è¦å¸ˆå¾’ç³»ç»Ÿ</span></span><br><span class="line">        <span class="comment">// ä¸éœ€è¦ä»»åŠ¡ç³»ç»Ÿ</span></span><br><span class="line">        NewSpecialProcessor(), <span class="comment">// æ–°æ¨¡å¼ç‰¹æœ‰çš„å¤„ç†å™¨</span></span><br><span class="line">        f.persistence,     <span class="comment">// å¤ç”¨</span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. æ³¨å†Œæ–°æ¥å£</span></span><br><span class="line">router.POST(<span class="string">&quot;/game/newmode/settle&quot;</span>, &amp;NewModeHandler&#123;</span><br><span class="line">    pipeline: factory.CreateNewModePipeline(),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// &quot;æ²»ç†&quot;çš„ä½“ç°ï¼š</span></span><br><span class="line"><span class="comment">// - 90%çš„ä»£ç å¤ç”¨ï¼ˆProcessor éƒ½æ˜¯é€šç”¨çš„ï¼‰</span></span><br><span class="line"><span class="comment">// - åªéœ€è¦å®ç° 10%çš„ç‰¹æ®Šé€»è¾‘</span></span><br><span class="line"><span class="comment">// - ä¸å½±å“ç°æœ‰æ¨¡å¼</span></span><br><span class="line"><span class="comment">// - æ¸…æ™°çš„æ‰©å±•ç‚¹</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ç»™ä¸€ä¸ªåˆ†æ²»åçš„æ¶æ„ä¾›å„ä½è¯»è€…å‚è€ƒï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">ç¬¬1å±‚ï¼šæ¥å£éš”ç¦»</span><br><span class="line">  â”œâ”€â”€ /game/mode1/settle</span><br><span class="line">  â”œâ”€â”€ /game/mode2/settle</span><br><span class="line">  â””â”€â”€ /game/mode3/settle</span><br><span class="line"></span><br><span class="line">ç¬¬2å±‚ï¼šHTTPå¤„ç†å±‚</span><br><span class="line">  â”œâ”€â”€ è¯·æ±‚è§£æ</span><br><span class="line">  â”œâ”€â”€ è°ƒç”¨ä¸šåŠ¡é€»è¾‘å±‚</span><br><span class="line">  â””â”€â”€ å“åº”æ„å»º</span><br><span class="line"></span><br><span class="line">ç¬¬3å±‚ï¼šåº”ç”¨é€»è¾‘å±‚</span><br><span class="line">  â”œâ”€â”€ è°ƒç”¨Pipeline</span><br><span class="line">  â”œâ”€â”€ å¼‚æ­¥å‰¯ä½œç”¨å¤„ç†</span><br><span class="line">  â””â”€â”€ è¿”å›ç»“æœ</span><br><span class="line"></span><br><span class="line">ç¬¬4å±‚ï¼šPipelineç¼–æ’å±‚</span><br><span class="line">  â””â”€â”€ æŒ‰æ¸¸æˆæ¨¡å¼ç»„è£…ä¸åŒçš„Processoré“¾</span><br><span class="line"></span><br><span class="line">ç¬¬5å±‚ï¼šä¸šåŠ¡å¤„ç†å±‚ï¼ˆç‹¬ç«‹çš„Processorï¼‰</span><br><span class="line">  â”œâ”€â”€ ScoreCalculationProcessor åˆ†æ•°è®¡ç®—</span><br><span class="line">  â”œâ”€â”€ MasterApprenticeProcessor å¸ˆå¾’ç³»ç»Ÿ</span><br><span class="line">  â”œâ”€â”€ TaskSystemProcessor       ä»»åŠ¡ç³»ç»Ÿ</span><br><span class="line">  â”œâ”€â”€ ActivityProcessor         æ´»åŠ¨ç³»ç»Ÿ</span><br><span class="line">  â”œâ”€â”€ RankingUpdateProcessor    æ’åç³»ç»Ÿ</span><br><span class="line">  â”œâ”€â”€ AchievementProcessor      æˆå°±ç³»ç»Ÿ</span><br><span class="line">  â”œâ”€â”€ HonorUpdateProcessor      è£èª‰ç³»ç»Ÿ</span><br><span class="line">  â””â”€â”€ PersistenceProcessor      æˆç»©ä¿å­˜</span><br><span class="line"></span><br><span class="line">ç¬¬6å±‚ï¼šé¢†åŸŸæœåŠ¡å±‚</span><br><span class="line">  â”œâ”€â”€ ScoreCalculator           åˆ†æ•°è®¡ç®—</span><br><span class="line">  â”œâ”€â”€ MasterApprenticeService   å¸ˆå¾’ç³»ç»Ÿ</span><br><span class="line">  â”œâ”€â”€ TaskService               ä»»åŠ¡æœåŠ¡</span><br><span class="line">  â”œâ”€â”€ ActivityService           æ´»åŠ¨æœåŠ¡</span><br><span class="line">  â””â”€â”€ RankingService            æ’è¡Œæ¦œæœåŠ¡</span><br></pre></td></tr></table></figure><p>å¥½å¤„æ˜¾è€Œæ˜“è§ï¼š</p><ol type="1"><li>èŒè´£å½»åº•åˆ†ç¦»ï¼šæ¯ä¸ª Processor åªåšä¸€ä»¶äº‹ï¼Œ15-30è¡Œä»£ç å°±èƒ½çœ‹æ¸…æ¥šé€»è¾‘ã€‚</li><li>å¯ç»„åˆæ€§ï¼šåº•å±‚çš„ä¸šåŠ¡é€»è¾‘å±‚å’Œé¢†åŸŸæœåŠ¡å±‚å¯ä»¥å¤ç”¨ç»™å„ä¸ªä¸åŒçš„æ¸¸æˆæ¨¡å¼ã€‚</li><li>å¯æµ‹è¯•æ€§ï¼šæ¯ä¸ªå•å…ƒéƒ½éå¸¸å°ï¼Œä¾èµ–å°½å¯èƒ½å°‘ï¼Œæµ‹è¯•éš¾åº¦å¤§å¤§é™ä½ã€‚</li><li>æ€§èƒ½å¯è§‚æµ‹æ€§ï¼šç®¡é“å¯ä»¥å®ç°è‡ªåŠ¨è®°å½•æ¯ä¸ª Processorçš„è€—æ—¶ï¼Œå¯ä»¥ç²¾å‡†å®šä½æ€§èƒ½ç“¶é¢ˆã€‚</li><li>é”™è¯¯éš”ç¦»ï¼šä»»ä½•ä¸€ä¸ª Processor å¤±è´¥ï¼Œéƒ½èƒ½æ¸…æ™°çŸ¥é“æ˜¯å“ªä¸ªç¯èŠ‚å‡ºé—®é¢˜</li><li>å¹¶è¡Œä¼˜åŒ–ï¼šå¦‚æœæŸäº› Processor ä¹‹é—´æ²¡æœ‰ä¾èµ–ï¼Œå¯ä»¥å¹¶è¡Œæ‰§è¡Œã€‚</li></ol><blockquote><p>[!IMPORTANT]</p><p>æ€»ç»“ä¸€ä¸‹ï¼Œ"åˆ†"åªæ˜¯æ‰‹æ®µï¼Œ"æ²»"æ‰æ˜¯ç›®çš„çš„æ·±åˆ»å«ä¹‰ï¼š</p><ul><li><p>ä¸è¦ä¸ºäº†æ‹†åˆ†è€Œæ‹†åˆ† â€”â€”å¦‚æœæ‹†åˆ†åæ²¡æœ‰æå‡æ²»ç†èƒ½åŠ›ï¼Œé‚£å°±æ˜¯è¿‡åº¦è®¾è®¡ã€‚</p></li><li><p>æ‹†åˆ†çš„ç›®æ ‡æ˜¯æ²»ç† â€”â€”æ¯æ¬¡æ‹†åˆ†éƒ½è¦é—®ï¼š<strong>è¿™æ ·æ‹†æ˜¯å¦è®©é—®é¢˜æ›´å®¹æ˜“æ§åˆ¶ï¼Ÿ</strong></p></li><li><p>æ²»ç†çš„å››ä¸ªæ ‡å‡†ï¼š</p><ul><li><p>å¯ç‹¬ç«‹ç†è§£ï¼ˆè®¤çŸ¥æ²»ç†ï¼‰</p></li><li><p>å¯ç‹¬ç«‹ä¿®æ”¹ï¼ˆæ¼”åŒ–æ²»ç†ï¼‰</p></li><li><p>å¯ç‹¬ç«‹éªŒè¯ï¼ˆæµ‹è¯•æ²»ç†ï¼‰</p></li><li><p>å¯çµæ´»ç»„åˆï¼ˆç»„åˆæ²»ç†ï¼‰</p></li></ul></li><li><p>å¥½çš„æ¶æ„è®©å¤æ‚åº¦å¯æ§ â€”â€”ä¸æ˜¯æ¶ˆé™¤å¤æ‚åº¦ï¼ˆä¸šåŠ¡æœ¬æ¥å°±å¤æ‚ï¼‰ï¼Œè€Œæ˜¯è®©å¤æ‚åº¦åœ¨æ¯ä¸ªå±€éƒ¨éƒ½æ˜¯å¯ç®¡ç†çš„</p></li></ul><p>æ¸¸æˆç»“ç®—æ¥å£çš„ä¾‹å­å®Œç¾è¯ é‡Šäº†è¿™ä¸€ç‚¹ï¼šä¸æ˜¯è¦æŠŠ 800 è¡Œä»£ç æ‹†æˆ 80ä¸ªå‡½æ•°ï¼Œè€Œæ˜¯è¦æŠŠä¸å¯æ§çš„å¤æ‚åº¦è½¬åŒ–ä¸ºå¯æ§çš„ã€ç‹¬ç«‹çš„ã€å¯ç»„åˆçš„å•å…ƒã€‚è¿™æ‰æ˜¯çœŸæ­£çš„"æ²»ç†"ã€‚</p></blockquote><h2 id="åˆ†å±‚">åˆ†å±‚</h2><p>åˆ†å±‚å’Œåˆ†æ²»çœ‹èµ·æ¥å¾ˆåƒï¼Œä¸è¿‡åœ¨æˆ‘çœ‹æ¥å®ƒä»¬çš„ä¾§é‡ç‚¹è¿˜æ˜¯æœ‰æ‰€ä¸åŒçš„ã€‚åœ¨æˆ‘çœ‹æ¥ï¼Œåˆ†æ²»é¢ä¸´çš„æ˜¯ä¸€ä¸ªé—®é¢˜<strong>è§„æ¨¡è¿‡å¤§</strong>ï¼Œå¯¼è‡´å•ä¸ªå¤„ç†å•å…ƒï¼ˆäººã€CPUã€æœåŠ¡ï¼‰æ— æ³•åœ¨æœ‰æ•ˆæ—¶é—´å†…è§£å†³ï¼Œæˆ–è€…é€»è¾‘è¿‡äºå¤æ‚ä»¥è‡³äºæ— æ³•ä¸€æ¬¡æ€§æ­£ç¡®å®ç°ã€‚å®ƒçš„æ€è·¯æ˜¯åˆ†è§£ã€è§£å†³å’Œåˆå¹¶ã€‚è€Œåˆ†å±‚é¢ä¸´çš„é—®é¢˜æ˜¯ç³»ç»Ÿçš„å„ä¸ªéƒ¨åˆ†<strong>è¿‡åº¦è€¦åˆ</strong>ã€‚å½“ä¸€ä¸ªæ¨¡å—çš„å®ç°ç»†èŠ‚ï¼ˆæ¯”å¦‚æ¢ä¸ªæ•°æ®åº“ï¼‰ä¼šå½±å“åˆ°å¦ä¸€ä¸ªæ¨¡å—ï¼ˆæ¯”å¦‚UI ç•Œé¢ï¼‰æ—¶ï¼Œç³»ç»Ÿå°±å˜å¾—åƒµåŒ–å’Œè„†å¼±ã€‚æ¦‚æ‹¬æ¥è¯´ï¼š</p><ul><li><strong>åˆ†æ²»</strong>ä¾§é‡äº<strong>é«˜å†…èš</strong>ï¼Œå…¶åŸåˆ™æ˜¯æŒ‰å•ä¸€å˜æ›´ç†ç”±ï¼ˆSRPï¼‰å°†é€»è¾‘<strong>èšåˆ</strong>åˆ°åŒä¸€å•å…ƒã€‚</li><li><strong>åˆ†å±‚</strong>ä¾§é‡äº<strong>ä½è€¦åˆ</strong>ï¼Œå…¶åŸåˆ™æ˜¯æŒ‰æŠ€æœ¯å…³æ³¨ç‚¹ï¼ˆSoCï¼‰<strong>ç®¡ç†ä¾èµ–æ–¹å‘</strong>ï¼Œéš”ç¦»å®ç°ç»†èŠ‚ã€‚</li></ul><p>OKï¼Œæˆ‘ä»¬è¿˜æ˜¯å°è¯•å›å½’åˆ°ç¬¬ä¸€æ€§åŸç†ä¸Šï¼š</p><blockquote><p>[!important]</p><p>åˆ†å±‚åˆ°åº•"åˆ†"çš„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ â€”â€” å˜åŒ–é€Ÿç‡ã€‚</p></blockquote><p>åˆ†å±‚çš„æœ€ç»ˆç›®çš„å…¶å®æ˜¯<strong>éš”ç¦»å˜åŒ–</strong>ã€‚ä¸€ä¸ªå¥½çš„åˆ†å±‚è®¾è®¡ï¼Œå…¶æ ¸å¿ƒæ ‡å‡†æ˜¯ï¼š<strong>å½“ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå…¶ä»–éƒ¨åˆ†åº”è¯¥å°½å¯èƒ½å°‘åœ°å—åˆ°å½±å“ã€‚</strong>è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œä¸ä»…ä»…æ˜¯ç”»å‡ºå‡ ä¸ªæ¡†æ¡†ç„¶åæŠŠä»£ç æ‰”è¿›å»é‚£ä¹ˆç®€å•ã€‚è¿™éœ€è¦ä¸€å¥—ä¸¥æ ¼çš„åŸåˆ™å’Œå®è·µã€‚</p><p>åšå¥½åˆ†å±‚ï¼Œå…³é”®åœ¨äºå›ç­”ä¸‰ä¸ªé—®é¢˜ï¼š<strong>â‘  æŒ‰ä»€ä¹ˆæ ‡å‡†åˆ†ï¼Ÿ â‘¡å±‚ä¸å±‚å¦‚ä½•å¯¹è¯ï¼Ÿ â‘¢ è°èƒ½ä¾èµ–è°ï¼Ÿ</strong></p><h3 id="åˆ†å±‚çš„åŸåˆ™">åˆ†å±‚çš„åŸåˆ™</h3><h4id="åŸåˆ™ä¸€æŒ‰ä»€ä¹ˆåˆ†ä»¥å˜åŒ–çš„é€Ÿç‡ä½œä¸ºåˆ‡åˆ†æ ‡å‡†">åŸåˆ™ä¸€ï¼šæŒ‰ä»€ä¹ˆåˆ†ï¼Ÿä»¥å˜åŒ–çš„é€Ÿç‡ä½œä¸ºåˆ‡åˆ†æ ‡å‡†</h4><p>è¿™æ˜¯æœ€æ ¹æœ¬çš„åŸåˆ™ã€‚ä¸ºä»€ä¹ˆè¡¨ç°å±‚å’Œæ•°æ®è®¿é—®å±‚è¦åˆ†å¼€ï¼Ÿå› ä¸º UIç•Œé¢ï¼ˆé¢œè‰²ã€å¸ƒå±€ï¼‰<strong>å˜åŒ–çš„é¢‘ç‡å’ŒåŸå› </strong>ï¼Œä¸æ•°æ®å­˜å‚¨æ–¹å¼ï¼ˆç”¨MySQL è¿˜æ˜¯PostgreSQLï¼‰<strong>å˜åŒ–çš„é¢‘ç‡å’ŒåŸå› </strong>æ˜¯å®Œå…¨ä¸åŒçš„ã€‚</p><ul><li><strong>é«˜å†…èšï¼š</strong>æŠŠå˜åŒ–åŸå› å’Œé€Ÿç‡ç›¸è¿‘çš„ä»£ç æ”¾åœ¨åŒä¸€å±‚ã€‚ä¾‹å¦‚æ‰€æœ‰å¤„ç† HTTP è¯·æ±‚ã€è§£æJSONã€å‚æ•°æ ¡éªŒçš„ä»£ç ï¼Œéƒ½å±äºè¡¨ç°å±‚çš„èŒè´£ï¼Œå®ƒä»¬ä¸€èµ·å˜åŒ–ã€‚</li><li><strong>ä½è€¦åˆï¼š</strong>å˜åŒ–é€Ÿç‡ä¸åŒçš„ä»£ç ï¼Œåº”è¯¥è¢«åšå†³åœ°<strong>éš”ç¦»</strong>åœ¨ä¸åŒçš„å±‚ã€‚</li></ul><p>å¾ˆå¤šå¤±è´¥çš„åˆ†å±‚ï¼Œæ˜¯å› ä¸ºåˆ†é”™äº†ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆServiceï¼‰é‡Œï¼Œæ—¢æœ‰æ ¸å¿ƒä¸šåŠ¡è§„åˆ™ï¼ˆè®¢å•æ€»ä»·&gt; 100 æ‰èƒ½å…è¿è´¹ï¼‰ï¼Œåˆæ··æ‚ç€æ•°æ®æ ¼å¼çš„è½¬æ¢ï¼ˆæŠŠ <code>Entity</code>è½¬æˆ <code>DTO</code>ï¼‰ã€‚æ ¸å¿ƒä¸šåŠ¡è§„åˆ™ï¼ˆå…è¿è´¹ç­–ç•¥ï¼‰å¯èƒ½å‡ ä¸ªæœˆä¸å˜ï¼Œè€Œ<code>DTO</code>ï¼ˆè¿”å›ç»™ App çš„ JSONæ ¼å¼ï¼‰å¯èƒ½æ¯å‘¨éƒ½åœ¨å˜ã€‚æŠŠå®ƒä»¬æ··åœ¨ä¸€èµ·ï¼Œå°±è¿åäº†æŒ‰å˜åŒ–é€Ÿç‡åˆ‡åˆ†çš„åŸåˆ™ã€‚</p><h4 id="åŸåˆ™äºŒè°ä¾èµ–è°ä¾èµ–å€’ç½®åŸåˆ™">åŸåˆ™äºŒï¼šè°ä¾èµ–è°ï¼Ÿä¾èµ–å€’ç½®åŸåˆ™</h4><p>è¿™æ˜¯<strong>åšå¥½åˆ†å±‚</strong>çš„å…³é”®ã€‚ç›¸ä¿¡ä¸å°‘è¯»è€…è·Ÿæˆ‘ä¸€æ ·ï¼Œåœ¨ä¸€å¼€å§‹å­¦ä¹ MVC æ¶æ„çš„æ—¶å€™ï¼Œéƒ½æ˜¯éµå¾ªä¼ ç»Ÿçš„æœ´ç´ åˆ†å±‚ï¼šè¡¨ç°å±‚ â†’ ä¸šåŠ¡å±‚ â†’æ•°æ®å±‚ã€‚è¿™ç§ä¾èµ–æ˜¯<strong>å…·ä½“</strong>çš„ï¼Œå³è¡¨ç°å±‚<strong>ç›´æ¥ä¾èµ–</strong>ä¸šåŠ¡å±‚çš„<strong>å…·ä½“å®ç°</strong>ï¼›ä¸šåŠ¡å±‚<strong>ç›´æ¥ä¾èµ–</strong>æ•°æ®å±‚çš„<strong>å…·ä½“å®ç°</strong>ã€‚ä¾‹å¦‚ï¼Œ<code>UserService</code>ç›´æ¥<code>new UserRepositoryImpl()</code>ï¼‰ã€‚å®ƒçš„é—®é¢˜åœ¨äºä¸šåŠ¡é€»è¾‘å±‚ï¼ˆé«˜å±‚ç­–ç•¥ï¼‰<strong>ä¾èµ–</strong>äº†æ•°æ®è®¿é—®å±‚ï¼ˆåº•å±‚ç»†èŠ‚ï¼‰ã€‚å½“åº•å±‚ç»†èŠ‚ï¼ˆå¦‚æ•°æ®åº“å®ç°ï¼‰æ›´æ¢æ—¶ï¼Œä¸šåŠ¡é€»è¾‘å±‚ä¹Ÿå¯èƒ½éœ€è¦ä¿®æ”¹ã€‚</p><p>è€Œä¾èµ–å€’ç½®å°±ä¸ä¸€æ ·äº†ï¼Œå®ƒçš„æ“ä½œè¿‡ç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p><ol type="1"><li><strong>é«˜å±‚ï¼ˆä¸šåŠ¡é€»è¾‘å±‚ï¼‰å®šä¹‰éœ€æ±‚æ–¹æ¥å£ï¼ˆInterfaceï¼‰</strong>ã€‚ä¾‹å¦‚ï¼š<code>UserService</code> å®šä¹‰ä¸€ä¸ª <code>IUserRepository</code>æ¥å£ï¼Œæ¥å£ä¸­å£°æ˜å®ƒéœ€è¦çš„æ–¹æ³•ï¼Œå¦‚<code>User GetUser(string id)</code>ã€‚</li><li><strong>é«˜å±‚ï¼ˆä¸šåŠ¡é€»è¾‘å±‚ï¼‰åªä¾èµ–è¿™ä¸ªéœ€æ±‚æ–¹æ¥å£ã€‚</strong><code>UserService</code>çš„ä»£ç åªè®¤è¯† <code>IUserRepository</code>ï¼Œå®Œå…¨ä¸çŸ¥é“æ•°æ®åº“ã€Redisæˆ–ä»€ä¹ˆ <code>Impl</code> çš„å­˜åœ¨ã€‚</li><li><strong>ä½å±‚ï¼ˆæ•°æ®è®¿é—®å±‚ï¼‰å»å®ç°è¿™ä¸ªéœ€æ±‚æ–¹æ¥å£ã€‚</strong><code>UserRepositoryImpl</code>å®ç° <code>IUserRepository</code> æ¥å£ã€‚</li><li>é€šè¿‡ä¾èµ–æ³¨å…¥å°†<strong>å…·ä½“å®ç°</strong>æ³¨å…¥ç»™é«˜å±‚ã€‚</li></ol><p>ç³»ç»Ÿçš„æ ¸å¿ƒä»·å€¼åœ¨äºå…¶<strong>ä¸šåŠ¡è§„åˆ™</strong>ï¼ˆé«˜å±‚ç­–ç•¥ï¼‰ï¼Œè€Œä¸æ˜¯å®ƒç”¨ä»€ä¹ˆæ•°æ®åº“ï¼ˆåº•å±‚ç»†èŠ‚ï¼‰ã€‚å› æ­¤ï¼Œ<strong>ç­–ç•¥ä¸åº”è¯¥ä¾èµ–ç»†èŠ‚ï¼Œè€Œåº”è¯¥æ˜¯ç»†èŠ‚ä¾èµ–äºç­–ç•¥</strong>ã€‚è¿™æ‰æ˜¯åˆ†å±‚çš„ç²¾é«“ï¼šä¿æŠ¤é«˜ä»·å€¼çš„<strong>ä¸šåŠ¡é€»è¾‘</strong>ä¸å—ä½ä»·å€¼çš„<strong>å®ç°ç»†èŠ‚</strong>çš„æ±¡æŸ“ã€‚</p><h4id="åŸåˆ™ä¸‰å±‚ä¸å±‚å¦‚ä½•å¯¹è¯ä¸¥æ ¼çš„æ¥å£ä¸å°è£…">åŸåˆ™ä¸‰ï¼šå±‚ä¸å±‚å¦‚ä½•å¯¹è¯ï¼Ÿä¸¥æ ¼çš„æ¥å£ä¸å°è£…</h4><p>å±‚ä¸å±‚ä¹‹é—´ç»å¯¹ä¸èƒ½è¶Šçº§è®¿é—®æˆ–æ³„éœ²å®ç°ç»†èŠ‚ã€‚ä¸Šå±‚åªåº”è¯¥çŸ¥é“å®ƒæ‰€éœ€è¦çš„<strong>æœ€å°æ¥å£</strong>ã€‚å½“æ•°æ®éœ€è¦è·¨è¶Šå±‚çš„è¾¹ç•Œæ—¶ï¼Œä½¿ç”¨æ•°æ®ä¼ è¾“å¯¹è±¡ï¼ˆDTO/ VO / POï¼‰æ¥ä¼ é€’ï¼Œè€Œä¸æ˜¯ç›´æ¥ä¼ é€’å†…éƒ¨å®ç°ã€‚</p><blockquote><p>åœ¨ç®€å•ä¸šåŠ¡ä¸­ï¼Œè¿™å¯èƒ½çœ‹èµ·æ¥å¾ˆç¹çï¼Œä½†è¿™æ˜¯ä¿æŒåˆ†å±‚çº¯æ´æ€§çš„ä»£ä»·ï¼Œéœ€è¦æƒè¡¡ï¼Œæ²¡æœ‰ç»å¯¹çš„ç­”æ¡ˆã€‚</p></blockquote><h3 id="åˆ†å±‚åå‘³é“">åˆ†å±‚åå‘³é“</h3><p>åœ¨æˆ‘çš„å·¥ä½œè¿‡ç¨‹ä¸­ï¼Œæ›¾ç»è§åˆ°è¿‡ä¸å°‘çš„ååˆ†å±‚ï¼Œå¯¼è‡´å„ç§å¾ªç¯ä¾èµ–ã€å±‚æ¬¡æ··ä¹±ï¼Œè¢«å®ƒä»¬æŠ˜ç£¨å¤Ÿå‘›ï¼Œæˆ‘å°†å®ƒä»¬è¿›è¡Œç®€å•æ€»ç»“ï¼Œå¦‚æœåœ¨ä½ çš„ä»£ç ä¸­ä¹Ÿå‘ç°äº†è¿™äº›æƒ…å†µï¼Œé‚£å¯èƒ½å°±éœ€è¦å¼•èµ·é‡è§†äº†ã€‚</p><ol type="1"><li><strong>æ³„éœ²çš„æŠ½è±¡</strong>ï¼šä¸šåŠ¡é€»è¾‘å±‚ï¼ˆServiceï¼‰å‘ä¸Šï¼ˆControllerï¼‰è¿”å›äº†ä¸€ä¸ª<strong>æ•°æ®åº“ORM çš„å®ä½“å¯¹è±¡</strong>ã€‚è¿™é€¼å¾— Controllerè¢«è¿«çŸ¥é“äº†"æ•°æ®åº“é•¿ä»€ä¹ˆæ ·"ï¼Œè¡¨ç°å±‚å’Œæ•°æ®å±‚è¢«è€¦åˆäº†ã€‚</li><li><strong>å±‚è·³è·ƒ</strong>ï¼šController ä¸ºäº†å›¾æ–¹ä¾¿ï¼Œç»•è¿‡äº†Serviceï¼Œ<strong>ç›´æ¥è°ƒç”¨</strong>äº† Repositoryæ¥è·å–æ•°æ®ã€‚çŸ­æœŸå†…çœ‹ä¼¼æ›´ç®€æ´ï¼Œå®é™…ä¸Šå¯¼è‡´äº†ä¸šåŠ¡é€»è¾‘è¢«æ¶ç©ºã€‚æœªæ¥å¦‚æœè¿™ä¸ªè·å–æ•°æ®éœ€è¦å¢åŠ æƒé™æ ¡éªŒæˆ–ç¼“å­˜é€»è¾‘ï¼ˆæœ¬åº”åœ¨Service å±‚åšï¼‰ï¼ŒController é‡Œçš„è¿™å¤„è°ƒç”¨å°±ä¼šè¢«é—æ¼ã€‚</li><li><strong>èƒ–ç˜¦ä¸å‡</strong>ï¼šè¦ä¹ˆæ˜¯ Serviceå±‚éå¸¸"ç˜¦"ï¼Œé‡Œé¢æ²¡æœ‰ä»»ä½•ä¸šåŠ¡é€»è¾‘ï¼ˆæˆ–å¹²è„†æ²¡æœ‰ Serviceå±‚ï¼‰ï¼Œåªæ˜¯ç®€å•åœ°è°ƒç”¨ Repository çš„<code>save()</code>ã€<code>get()</code>ã€‚æ‰€æœ‰çš„ä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚æ ¡éªŒã€è®¡ç®—ï¼‰éƒ½å †ç§¯åœ¨Controller å±‚ã€‚è¦ä¹ˆä¸€ä¸ª GodServiceç±»åŒ…å«äº†ä¸Šä¸‡è¡Œä»£ç ï¼Œå¤„ç†äº†å‡ åç§ä¸ç›¸å…³çš„ä¸šåŠ¡ã€‚è¿™è¿åäº†é«˜å†…èšåŸåˆ™ï¼Œåˆ†å±‚å¤±å»äº†æ„ä¹‰ã€‚</li><li><strong>ä¾èµ–åå‘</strong>ï¼šRepository <strong>åè¿‡æ¥<code>import</code></strong> äº† Service/Controllerçš„ä»£ç ã€‚è¿™æ˜¯æœ€ç—›è‹¦çš„ï¼Œè¿™ä¼šé€ æˆå¾ªç¯ä¾èµ–ï¼Œè¿™åœ¨é€»è¾‘ä¸Šæ˜¯è‡´å‘½çš„ï¼Œè¯´æ˜èŒè´£åˆ’åˆ†å½»åº•æ··ä¹±ã€‚</li></ol><h3 id="åˆ†å±‚çš„å…¸èŒƒ">åˆ†å±‚çš„å…¸èŒƒ</h3><p>åœ¨ç°ä»£è½¯ä»¶å·¥ç¨‹ä¸­ï¼Œæ´‹è‘±æ¶æ„æˆ–æ•´æ´æ¶æ„ï¼ˆCleanArchitectureï¼‰æ˜¯ä¾èµ–å€’ç½®åŸåˆ™çš„æœ€ä½³å®è·µã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/308528-20170714161640900-366868890.jpg"alt="æ´‹è‘±æ¶æ„" /><figcaption aria-hidden="true">æ´‹è‘±æ¶æ„</figcaption></figure><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå®ƒå°†åˆ†å±‚æƒ³è±¡æˆä¸€ä¸ªæ´‹è‘±ï¼š</p><ol type="1"><li><p><strong>æœ€ä¸­å¿ƒï¼šé¢†åŸŸå®ä½“ (Entities)</strong></p><p>ä¼ä¸šçº§çš„æ ¸å¿ƒä¸šåŠ¡è§„åˆ™ï¼Œæœ€ç¨³å®šï¼Œå˜åŒ–æœ€å°‘ã€‚</p></li><li><p><strong>ç¬¬äºŒå±‚ï¼šç”¨ä¾‹/åº”ç”¨æœåŠ¡ (Use Cases / ApplicationServices)</strong></p><p>å…·ä½“çš„ä¸šåŠ¡æµç¨‹ï¼Œç¼–æ’â€œå®ä½“â€æ¥å®Œæˆä¸€ä¸ªæ“ä½œï¼ˆä¾‹å¦‚â€œç”¨æˆ·æ³¨å†Œâ€ç”¨ä¾‹ï¼‰ã€‚</p></li><li><p><strong>ç¬¬ä¸‰å±‚ï¼šæ¥å£é€‚é…å™¨ (Interface Adapters)</strong></p><p><code>Controller</code>ã€<code>Presenter</code>ã€<code>Repository</code>çš„å®ç°ã€‚å®ƒä»¬æ˜¯â€œç¿»è¯‘å®˜â€ã€‚</p></li><li><p><strong>æœ€å¤–å±‚ï¼šæ¡†æ¶ä¸é©±åŠ¨ (Frameworks &amp;Drivers)</strong></p><p>Web æ¡†æ¶ (Gin, Spring)ã€æ•°æ®åº“ (MySQL)ã€UI (Web) ç­‰ã€‚</p></li></ol><p><strong>è¿™ä¸ªæ¶æ„çš„å”¯ä¸€è§„åˆ™ï¼šä¾èµ–ç®­å¤´æ°¸è¿œæŒ‡å‘å†…éƒ¨ã€‚</strong></p><ul><li><code>Controller</code> (å¤–) ä¾èµ– <code>Use Case</code> (å†…)ã€‚</li><li><code>Repository</code> (å¤–) <strong>å®ç°</strong><code>Use Case</code> (å†…) <strong>å®šä¹‰çš„æ¥å£</strong>ã€‚</li></ul><p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæœ€æ ¸å¿ƒçš„ä¸šåŠ¡é€»è¾‘ï¼ˆEntities å’Œ UseCasesï¼‰<strong>å®Œå…¨ä¸çŸ¥é“</strong>å¤–éƒ¨ä¸–ç•Œæœ‰ Webã€æœ‰ MySQLçš„å­˜åœ¨ã€‚ä½ å¯ä»¥æŠŠ Web æ›¿æ¢æˆå‘½ä»¤è¡Œï¼ŒæŠŠ MySQLæ›¿æ¢æˆå†…å­˜æ•°æ®åº“ï¼Œè€Œ<strong>ä¸­å¿ƒçš„ä¸šåŠ¡ä»£ç ä¸€è¡Œéƒ½ä¸ç”¨æ”¹</strong>ã€‚</p><p>è¿™ï¼Œå°±æ˜¯åšå¥½åˆ†å±‚çš„ç»ˆæç›®æ ‡ï¼š<strong>ä¿æŠ¤æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œè®©å…¶ç‹¬ç«‹äºå¤–éƒ¨å®ç°ç»†èŠ‚è€Œå­˜åœ¨ã€‚</strong></p><h3 id="åˆ†å±‚çš„å®è·µ">åˆ†å±‚çš„å®è·µ</h3><p>åœ¨è½¯ä»¶å·¥ç¨‹å‡ºç°ä¹‹å‰ï¼Œåˆ†å±‚æ—©å·²æ˜¯ç³»ç»Ÿå·¥ç¨‹çš„åŸºçŸ³ã€‚æ‰€ä»¥è¿™ä¸€å°èŠ‚ï¼Œæˆ‘æƒ³å€Ÿè¿™ä¸ªæœºä¼šï¼Œæ¢³ç†ä¸€ä¸‹æˆ‘ä»¬å¸ç©ºè§æƒ¯çš„é‚£äº›è®¡ç®—æœºæ ¸å¿ƒæŠ€æœ¯å’Œç¼–ç¨‹è¯­è¨€ï¼ˆGo/Rustï¼‰ï¼Œå®ƒä»¬åœ¨å“ªäº›åœ°æ–¹éƒ½ç”¨åˆ°äº†åˆ†å±‚çš„æ€æƒ³ã€‚</p><h4 id="ç½‘ç»œåè®®">ç½‘ç»œåè®®</h4><p>æœ€ç»å…¸çš„åˆ†å±‚å®è·µå°±æ˜¯ OSI ä¸ƒå±‚åè®®äº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/008i3skNly1gt3mt2poj8j30u016idmo.jpg"alt="OSI ä¸ƒå±‚ç½‘ç»œåè®®" /><figcaption aria-hidden="true">OSI ä¸ƒå±‚ç½‘ç»œåè®®</figcaption></figure><p>åœ¨å®è·µä¸­ï¼ŒTCP/IP å››å±‚åè®®å¯¹å…¶è¿›è¡Œäº†ç®€åŒ–ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/008i3skNly1gt3mt1ojy7j31gq0katcz.jpg"alt="TCP/IP å››å±‚åè®® vs. OSI ä¸ƒå±‚åè®®" /><figcaption aria-hidden="true">TCP/IP å››å±‚åè®® vs. OSIä¸ƒå±‚åè®®</figcaption></figure><p>TCP/IP å››å±‚åè®®å®Œç¾è·µè¡Œäº†å…³æ³¨ç‚¹åˆ†ç¦»ï¼ˆSoCï¼‰ï¼š</p><ul><li><strong>åº”ç”¨å±‚</strong>(HTTP)ï¼š<strong>åª</strong>å…³æ³¨åº”ç”¨æ•°æ®çš„è¯­ä¹‰ï¼ˆæ¯”å¦‚<code>GET /user</code> è¿™ä¸ªè¯·æ±‚ï¼‰ã€‚</li><li><strong>ä¼ è¾“å±‚</strong>(TCP)ï¼š<strong>åª</strong>å…³æ³¨è¿›ç¨‹åˆ°è¿›ç¨‹çš„å¯é æ€§ï¼ˆå¦‚ä¸‰æ¬¡æ¡æ‰‹ã€ä¸¢åŒ…é‡ä¼ ï¼‰ã€‚</li><li><strong>ç½‘ç»œå±‚</strong>(IP)ï¼š<strong>åª</strong>å…³æ³¨ä¸»æœºåˆ°ä¸»æœºçš„è·¯ç”±å¯»å€ã€‚</li><li><strong>æ•°æ®é“¾è·¯å±‚</strong>(Ethernet)ï¼š<strong>åª</strong>å…³æ³¨ç‰©ç†å¸§çš„ç›¸é‚»ä¼ è¾“ã€‚</li></ul><p>å¹¶ä¸”å®ƒä¹Ÿä¸¥æ ¼æ‰§è¡Œäº†å•å‘ä¾èµ–çš„åŸåˆ™ï¼Œä¸Šå±‚ï¼ˆå¦‚HTTPï¼‰<strong>ä¾èµ–</strong>ä¸‹å±‚ï¼ˆTCPï¼‰æä¾›çš„å¯é å­—èŠ‚æµæœåŠ¡ã€‚ä½†TCPï¼ˆä¸‹å±‚ï¼‰<strong>å®Œå…¨ä¸</strong>è®¤è¯†ï¼ˆä¹Ÿ<strong>ä¸</strong>ä¾èµ–ï¼‰HTTPã€‚è¿™ç§åˆ†å±‚å¸¦æ¥çš„ä½è€¦åˆæ˜¯é©å‘½æ€§çš„ï¼š</p><ul><li>æˆ‘ä»¬å¯ä»¥åœ¨ä¸ä¿®æ”¹ TCP å’Œ IP çš„æƒ…å†µä¸‹ï¼Œå‘æ˜æ–°çš„åº”ç”¨å±‚åè®®ï¼ˆå¦‚WebSocketï¼ŒgRPCï¼‰ã€‚</li><li>æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ä¸ä¿®æ”¹ HTTP å’Œ TCP çš„æƒ…å†µä¸‹ï¼Œå°†ç½‘ç»œå±‚ä» IPv4<strong>æ— ç¼</strong>å‡çº§åˆ° IPv6ã€‚</li></ul><h4 id="æ“ä½œç³»ç»Ÿ">æ“ä½œç³»ç»Ÿ</h4><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/System-Call-in-Operating-System.jpg"alt="æ“ä½œç³»ç»Ÿç”¨æˆ·æ€ä¸å†…æ ¸æ€" /><figcaption aria-hidden="true">æ“ä½œç³»ç»Ÿç”¨æˆ·æ€ä¸å†…æ ¸æ€</figcaption></figure><p>æ“ä½œç³»ç»Ÿçš„ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹Ÿæ˜¯åˆ†å±‚çš„æ°ä½œã€‚</p><ul><li><strong>ç”¨æˆ·æ€ (User Mode)ï¼š</strong> å…³æ³¨ä¸šåŠ¡é€»è¾‘ï¼ˆä¾‹å¦‚ï¼Œæˆ‘ä»¬ç”¨ Goç¼–å†™ Web ç¨‹åºï¼‰ã€‚</li><li><strong>å†…æ ¸æ€ (Kernel Mode)ï¼š</strong>å…³æ³¨ç¡¬ä»¶èµ„æºç®¡ç†ï¼ˆå¦‚è¿›ç¨‹è°ƒåº¦ã€å†…å­˜åˆ†é…ã€I/O é©±åŠ¨ï¼‰ã€‚</li></ul><p>å®ƒä»¬ä¹‹é—´çš„å±‚å°±æ˜¯<strong>ç³»ç»Ÿè°ƒç”¨æ¥å£ (System CallInterface)</strong>ã€‚æˆ‘ä»¬çš„ Go ç¨‹åºï¼ˆä¸Šå±‚ï¼‰é€šè¿‡ç³»ç»Ÿè°ƒç”¨è¯·æ±‚I/Oï¼Œå®ƒ<strong>ä¸éœ€è¦</strong>ï¼ˆä¹Ÿ<strong>ä¸</strong>çŸ¥é“ï¼‰å†…æ ¸ï¼ˆä¸‹å±‚ï¼‰æ˜¯å¦‚ä½•ä¸Intel SATA é©±åŠ¨è¿˜æ˜¯ä¸‰æ˜Ÿ NVMe é©±åŠ¨çš„å®ç°ç»†èŠ‚æ‰“äº¤é“çš„ã€‚è¿™å¯¼è‡´äº†æˆ‘ä»¬çš„ Goç¨‹åº<strong>åª</strong>ä¾èµ– Linuxå†…æ ¸è¿™ä¸€å±‚ï¼Œå› æ­¤å®ƒå¯ä»¥ç§»æ¤åˆ°è¿è¡Œåœ¨ä»»ä½•å®ç°äº† Linux å†…æ ¸ APIçš„ç‰©ç†æœºå™¨ä¸Šï¼Œ<strong>éš”ç¦»</strong>äº†ç¡¬ä»¶è¿™ä¸ª<strong>æ˜“å˜</strong>çš„å®ç°ã€‚</p><h4 id="æ•°æ®åº“ç³»ç»Ÿ">æ•°æ®åº“ç³»ç»Ÿ</h4><p>å³ä½¿æ˜¯ä¸€ä¸ªå•ä¸€çš„ç¨‹åºï¼Œæ¯”å¦‚æˆ‘ä»¬å¸¸ç”¨çš„æ•°æ®åº“ç³»ç»ŸMySQLï¼Œå…¶å†…éƒ¨ä¹Ÿæ˜¯<strong>ä¸¥æ ¼åˆ†å±‚</strong>çš„ã€‚</p><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/6389433535043459524065439.png" /></p><ul><li><strong>æŸ¥è¯¢è§£æ/ä¼˜åŒ–å™¨ (Query Optimizer)ï¼š</strong><strong>åª</strong>å…³æ³¨ SQLè¯­å¥çš„è¯­ä¹‰å’Œæ‰§è¡Œè®¡åˆ’ï¼ˆå¦‚å†³å®šä½¿ç”¨å“ªä¸ªç´¢å¼•ï¼‰ã€‚</li><li><strong>å­˜å‚¨å¼•æ“ (Storage Engine) (å¦‚ InnoDB)ï¼š</strong><strong>åª</strong>å…³æ³¨æ•°æ®çš„ç‰©ç†å­˜å–ï¼ˆå¦‚å¦‚ä½•åœ¨ B+æ ‘ä¸Šè¯»/å†™ã€å¦‚ä½•ç®¡ç†äº‹åŠ¡æ—¥å¿—ï¼‰ã€‚</li></ul><p>å®ƒä»¬ä¹‹é—´é€šè¿‡<strong>å­˜å‚¨å¼•æ“ API</strong>è¿™ä¸€å±‚æ¥é€šä¿¡ã€‚è¿™ç§åˆ†å±‚ï¼Œä½¿å¾— MySQLå¯ä»¥<strong>å¯æ’æ‹”åœ°</strong>æ›¿æ¢å­˜å‚¨å¼•æ“ã€‚<code>Query Optimizer</code>ï¼ˆä¸Šå±‚ï¼‰<strong>ä¸</strong>ä¾èµ–<code>InnoDB</code>ï¼ˆä¸‹å±‚ï¼‰çš„å®ç°ï¼Œå®ƒåªä¾èµ–å¥‘çº¦ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ MySQLæ—¢å¯ä»¥æ”¯æŒ <code>InnoDB</code>ï¼ˆäº‹åŠ¡å‹ï¼‰ä¹Ÿå¯ä»¥æ”¯æŒ<code>MyISAM</code>ï¼ˆéäº‹åŠ¡å‹ï¼‰ã€‚</p><h4 id="go-ç½‘ç»œç¼–ç¨‹">Go ç½‘ç»œç¼–ç¨‹</h4><p>Goçš„ç½‘ç»œç¼–ç¨‹æ¨¡å‹åŒæ ·å®Œç¾è·µè¡Œäº†å…³æ³¨ç‚¹åˆ†ç¦»ï¼ˆSoCï¼‰ï¼Œä¸‹å›¾è‡ªé¡¶å‘ä¸‹æ¸…æ™°åœ°å±•ç¤ºäº†è¿™ç§åˆ†å±‚ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/e6c9d24egy1h5lh6uxgk3j21770u0773.jpg"alt="Go ç½‘ç»œç¼–ç¨‹" /><figcaption aria-hidden="true">Go ç½‘ç»œç¼–ç¨‹</figcaption></figure><ul><li><strong>L6: ä¸šåŠ¡å±‚ (Goroutine &amp; ç¼–ç é£æ ¼)ï¼š</strong>åªå…³æ³¨ä¸šåŠ¡é€»è¾‘ã€‚å¼€å‘è€…åªéœ€ç”¨åŒæ­¥é˜»å¡çš„é£æ ¼ï¼ˆå¦‚<code>conn.Read()</code>ï¼‰ç¼–å†™ä¸šåŠ¡ã€‚</li><li><strong>L5: Go å¹¶å‘è°ƒåº¦å±‚ (GMP è°ƒåº¦å™¨)ï¼š</strong> åªå…³æ³¨ Goroutineçš„å¹¶å‘è°ƒåº¦ã€‚å®ƒéšè—äº† L3ï¼ˆ<code>netpoller</code>ï¼‰çš„ I/O äº‹ä»¶æœºåˆ¶ï¼Œå½“ L3æŠ¥å‘Š I/O å°±ç»ªæ—¶ï¼Œå®ƒï¼ˆGMPï¼‰è´Ÿè´£å”¤é†’å¯¹åº”çš„ L6ï¼ˆGoroutineï¼‰ã€‚</li><li><strong>L4: Go åè®®å±‚ (net åŒ…)ï¼š</strong> åªå…³æ³¨ TCP/UDP/HTTPç­‰ç½‘ç»œåè®®çš„å®ç°ï¼Œå¹¶æä¾›äº†å¹³å°æ— å…³çš„ APIï¼ˆå¦‚<code>net.Conn</code>ï¼‰ã€‚</li><li><strong>L3: Go Runtime é€‚é…å±‚ (network poller)ï¼š</strong>åªå…³æ³¨è·¨å¹³å° I/O å¤šè·¯å¤ç”¨ã€‚å®ƒå°è£…ï¼ˆWrappingï¼‰å¹¶å±è”½äº†L2ï¼ˆ<code>epoll/kqueue/iocp</code>ï¼‰çš„å¹³å°å·®å¼‚ã€‚</li><li><strong>L2: OS I/O æœºåˆ¶å±‚ (epoll/kqueue/iocp)ï¼š</strong>åªå…³æ³¨é«˜æ€§èƒ½ I/O äº‹ä»¶çš„é€šçŸ¥æœºåˆ¶ã€‚</li><li><strong>L1: OS åè®®/èµ„æºå±‚ (socket)ï¼š</strong>åªå…³æ³¨ä¼ è¾“å±‚åè®®ï¼ˆTCP/UDPï¼‰çš„å†…æ ¸å®ç°å’Œèµ„æºç®¡ç†ï¼ˆæ–‡ä»¶æè¿°ç¬¦ï¼‰ã€‚</li></ul><p>å¹¶ä¸”å®ƒä¹Ÿä¸¥æ ¼æ‰§è¡Œäº†å¤šé‡çš„å•å‘ä¾èµ–åŸåˆ™ï¼š</p><ul><li>L6ï¼ˆä¸šåŠ¡ï¼‰ä¾èµ– L5ï¼ˆGMPï¼‰æä¾›çš„å¹¶å‘èƒ½åŠ›ã€‚</li><li>L5ï¼ˆGMPï¼‰ä¾èµ– L3ï¼ˆnetpollerï¼‰æä¾›çš„ I/O å°±ç»ªé€šçŸ¥ã€‚</li><li>L4ï¼ˆnet åŒ…ï¼‰ä¾èµ– L3ï¼ˆnetpollerï¼‰æä¾›çš„è·¨å¹³å° I/O èƒ½åŠ›ã€‚</li><li>L3ï¼ˆnetpollerï¼‰ä¾èµ– L2ï¼ˆepoll ç­‰ï¼‰æä¾›çš„ OS äº‹ä»¶èƒ½åŠ›ã€‚</li><li>L2ï¼ˆepoll ç­‰ï¼‰ä¾èµ– L1ï¼ˆsocketï¼‰æä¾›çš„èµ„æºã€‚</li></ul><p>è¿™ç§åˆ†å±‚å¸¦æ¥çš„ä½è€¦åˆæ˜¯é©å‘½æ€§çš„ï¼š</p><ul><li>å¼€å‘è€…å¯ä»¥åœ¨<strong>ä¸ä¿®æ”¹</strong>ä¸šåŠ¡ä»£ç çš„æƒ…å†µä¸‹ï¼Œäº«å— Go Runtimeå›¢é˜Ÿå¯¹åç¨‹è°ƒåº¦æˆ– network poller çš„æ€§èƒ½ä¼˜åŒ–ã€‚</li><li>Go å›¢é˜Ÿä¹Ÿå¯ä»¥åœ¨<strong>ä¸ä¿®æ”¹</strong> <code>net</code>åŒ…çš„æƒ…å†µä¸‹ï¼Œå°† <code>network poller</code>é€‚é…åˆ° Linux æœ€æ–°çš„<code>io_uring</code>ï¼Œå¼€å‘è€…<strong>æ— éœ€</strong>æ”¹åŠ¨ä»»ä½•ä»£ç å³å¯è·å¾—æ€§èƒ½æå‡ã€‚</li><li>æœ€é‡è¦çš„æ˜¯ï¼Œå¼€å‘è€…å¯ä»¥<strong>åª</strong>å…³æ³¨<code>goroutine-per-connection</code>è¿™ç§åŒæ­¥çš„ä¸šåŠ¡é€»è¾‘ï¼Œè€Œ<strong>ä¸</strong>å¿…å…³å¿ƒ Epoll/Kqueueè¿™äº›å¼‚æ­¥éé˜»å¡çš„åº•å±‚å®ç°ç»†èŠ‚ï¼Œæå¤§åœ°é™ä½äº†é«˜æ€§èƒ½ç½‘ç»œç¼–ç¨‹çš„è®¤çŸ¥è´Ÿè·ã€‚</li></ul><h2 id="æ¨¡å—åŒ–">æ¨¡å—åŒ–</h2><p>åˆ†æ²»æ˜¯åœ¨æ€ç»´å±‚é¢ä¸Šå°†å¤§é—®é¢˜æ‹†åˆ†ä¸ºå¤šä¸ªå°é—®é¢˜ï¼Œè€Œåˆ†å±‚æ›´å¤šä¸“æ³¨åœ¨æŠ€æœ¯å±‚é¢ä¸Šçš„å…³æ³¨ç‚¹åˆ†ç¦»ã€‚é‚£æ¨¡å—åŒ–å‘¢ï¼Ÿåœ¨æˆ‘çœ‹æ¥ï¼Œæ¨¡å—åŒ–æ˜¯å°†ä¸€ä¸ªæ›´åŠ å¹¿æ³›çš„æ¦‚å¿µï¼Œå®ƒè·Ÿåˆ†æ²»å’Œåˆ†å±‚ä¸€æ ·ï¼Œéƒ½æ˜¯ä¸ºäº†è§£å†³ä¸€ä¸ªé«˜å¤æ‚åº¦é—®é¢˜æ‰€é‡‡å–çš„æŠ½è±¡è¡Œä¸ºï¼Œåªä¸è¿‡æ¨¡å—åŒ–å®ƒçš„äº§ç‰©æ›´åŠ å…·ä½“åŒ–ï¼Œæ¯”å¦‚æ‹†åˆ†æˆä¸€ä¸ªä¸ªçš„å¾®æœåŠ¡ã€åŒä¸€ä¸ªç³»ç»Ÿå†…éƒ¨çš„å¤šä¸ªmodule/packageï¼Œæˆ–æ˜¯å…·ä½“åˆ°ä¸€ä¸ªä¸ªè´Ÿè´£ä¸åŒèŒè´£çš„ç±»ã€‚</p><p>å¯ä»¥ç†è§£ä¸ºåˆ†å±‚æ˜¯æ¨¡å—åŒ–çš„ä¸€ä¸ªç‰¹å®šåº”ç”¨ï¼Œå®ƒæŒ‰ç…§æŠ€æœ¯èŒè´£è¿›è¡Œæ¨¡å—åŒ–åŒºåˆ†ï¼Œå¦‚æœUIå±‚ã€æ¥å£å±‚ã€ä¸šåŠ¡é€»è¾‘å±‚ã€æ•°æ®è®¿é—®å±‚ç­‰ã€‚è€Œåˆ†æ²»çš„æŸäº›åœºæ™¯ä¸‹çš„è½åœ°å®ç°å°±æ˜¯æ¨¡å—åŒ–ï¼Œæ¯”å¦‚å¾®æœåŠ¡çš„æ‹†åˆ†ã€ä¸šåŠ¡ç³»ç»Ÿä¸åŒç»„ä»¶çš„æ‹†åˆ†ç­‰ã€‚</p><p>åœ¨æˆ‘çœ‹æ¥ï¼Œæ¨¡å—åŒ–çš„ç»ˆæç›®æ ‡å°±æ˜¯è€ç”Ÿå¸¸è°ˆçš„ï¼šé«˜å†…èšã€ä½è€¦åˆã€‚</p><ul><li>é«˜å†…èšï¼šä¸€ä¸ªæ¨¡å—åªåšä¸€ä»¶äº‹ï¼Œå¹¶æŠŠå®ƒåšå¥½ã€‚</li><li>ä½è€¦åˆï¼šæ¨¡å—ä¹‹é—´çš„äº’ä¸ä¾èµ–ï¼Œåªé€šè¿‡æ¥å£è¿›è¡Œäº¤äº’ã€‚</li></ul><p>è€Œè¦åšå¥½æ¨¡å—åŒ–ï¼Œä¸»è¦æ˜¯è¦åšå¥½ä¸¤æ­¥ï¼š</p><ol type="1"><li>å°è£…ï¼šéšè—ç§˜å¯†ã€‚æŠŠè‡ªå·±çš„å†…éƒ¨å®ç°ï¼ˆç§æœ‰å‡½æ•°ã€è¾…åŠ©å‡½æ•°ï¼‰è—å¥½ã€‚</li><li>æ¥å£ï¼šåšå‡ºæ‰¿è¯ºã€‚åªå¯¹å¤–æš´éœ²ä¸€ä¸ªæ¸…æ™°ã€ç¨³å®šã€æœ€å°åŒ–çš„æ¥å£ï¼ˆå¥‘çº¦ï¼‰ï¼Œå‘Šè¯‰åˆ«äººæˆ‘èƒ½åšä»€ä¹ˆã€‚</li></ol><h3 id="æ¨¡å—åŒ–çš„å®è·µ">æ¨¡å—åŒ–çš„å®è·µ</h3><h4 id="ç¡¬ä»¶ä¸è®¡ç®—æœºä½“ç³»ç»“æ„æ€»çº¿ä¸-pcle">ç¡¬ä»¶ä¸è®¡ç®—æœºä½“ç³»ç»“æ„ï¼šæ€»çº¿ä¸PCle</h4><p>åœ¨ç”µè„‘çš„ä¸»æ¿ä¸Šï¼ŒCPUã€å†…å­˜ã€æ˜¾å¡ï¼ˆGPUï¼‰ã€ç¡¬ç›˜ï¼ˆSSDï¼‰éƒ½æ˜¯ç‹¬ç«‹çš„æ¨¡å—ã€‚</p><ul><li>æ¥å£ï¼šå®ƒä»¬é€šè¿‡ç»Ÿä¸€çš„æ€»çº¿ï¼ˆå¦‚ PCleï¼‰è¿›è¡Œé€šä¿¡ã€‚PCleå°±æ˜¯ä¸€ä¸ªæ ‡å‡†åŒ–çš„æ¥å£ã€‚</li><li>å°è£…ï¼šNVIDIA åªéœ€è¦æŒ‰ç…§ PCle æ¥å£è§„èŒƒè®¾è®¡æ˜¾å¡ï¼Œå®ƒä¸çŸ¥é“çŸ¥é“ Intel çš„CPU å¦‚ä½•å·¥ä½œï¼ŒIntel çš„ CPU ä¹Ÿä¸éœ€è¦çŸ¥é“æ˜¾å¡å†…éƒ¨æ˜¯å¦‚ä½•æ¸²æŸ“å›¾å½¢çš„ã€‚</li><li>é«˜å†…èšï¼šæ˜¾å¡é«˜åº¦å†…èšï¼Œåªè´Ÿè´£å›¾å½¢å¤„ç†ã€‚</li><li>ä½è€¦åˆï¼šè¿™ä½¿å¾—æˆ‘ä»¬å¯ä»¥éšæ„æ’æ‹”ã€æ›´æ¢ä¸åŒå‚å•†çš„æ˜¾å¡æˆ–SSDï¼ˆåªè¦æ¥å£å…¼å®¹ï¼‰ï¼Œè€Œç³»ç»Ÿå…¶ä»–éƒ¨åˆ†å®Œå…¨ä¸å—å½±å“ã€‚</li></ul><h4 id="æ“ä½œç³»ç»Ÿä»é©±åŠ¨ç¨‹åºåˆ°å¾®å†…æ ¸">æ“ä½œç³»ç»Ÿï¼šä»é©±åŠ¨ç¨‹åºåˆ°å¾®å†…æ ¸</h4><p>æ“ä½œç³»ç»Ÿæ˜¯æ¨¡å—åŒ–è®¾è®¡çš„æ®¿å ‚ã€‚å®ƒé¢ä¸´çš„ç¬¬ä¸€ä¸ªå²è¯—çº§æŒ‘æˆ˜å°±æ˜¯ï¼šä¸–ç•Œä¸Šæœ‰æˆåƒä¸Šä¸‡ç§ç¡¬ä»¶ï¼ˆç½‘å¡ã€æ˜¾å¡ã€ç£ç›˜ï¼‰ï¼Œæ“ä½œç³»ç»Ÿå¦‚ä½•æ”¯æŒå®ƒä»¬ï¼Œè€Œä¸è®©è‡ªå·±å´©æºƒï¼Ÿifelse è‚¯å®šæ˜¯è¡Œä¸é€šçš„é“è·¯ï¼Œé‚£ Linux ç»™å‡ºçš„ç­”æ¡ˆå°±æ˜¯é©±åŠ¨ç¨‹åºæ¶æ„ã€‚</p><ul><li>æ¨¡å—ï¼šç¡¬ä»¶é©±åŠ¨ç¨‹åºï¼ˆå¦‚ NVIDIA æ˜¾å¡é©±åŠ¨ã€Intel ç½‘å¡é©±åŠ¨ï¼‰</li><li>æ¥å£ï¼šç”±æ“ä½œç³»ç»Ÿå†…æ ¸ï¼ˆå¦‚ LinuxKernelï¼‰å®šä¹‰çš„ä¸€ç»„æ ‡å‡†åŒ–çš„å‡½æ•°è°ƒç”¨ã€‚ä¾‹å¦‚ï¼Œå—é©±åŠ¨è®¾å¤‡å¿…é¡»å®ç°<code>read</code>ã€<code>write</code>ã€<code>ioctl</code>ç­‰æ¥å£ï¼›ç½‘ç»œé©±åŠ¨å¿…é¡»å®ç°<code>open</code>ã€<code>stop</code>ã€<code>xmit</code> ç­‰æ¥å£ã€‚</li><li>å°è£…ï¼š<ul><li>OS å†…æ ¸çš„å°è£…ï¼šNVIDIA ä¸éœ€è¦çŸ¥é“ Linux è¿›ç¨‹è°ƒåº¦å™¨å’ŒVFSï¼ˆè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼‰çš„å†…éƒ¨å®ç°ã€‚å®ƒåªéœ€è¦çŸ¥é“å†…æ ¸æä¾›çš„ç½‘ç»œè®¾å¤‡æ¥å£é•¿ä»€ä¹ˆæ ·ã€‚</li><li>é©±åŠ¨çš„å°è£…ï¼šLinux å†…æ ¸ä¸éœ€è¦çŸ¥é“æ˜¾å¡èŠ¯ç‰‡æ˜¯å¦‚ä½•é€šè¿‡ CUDAæ ¸å¿ƒè¿›è¡Œè®¡ç®—çš„ã€‚å†…æ ¸åªå…³å¿ƒä¸€ä»¶äº‹ï¼šæˆ‘å·²ç»æŠŠæ•°æ®åŒ…ç»™ä½ äº†ï¼ˆè°ƒç”¨<code>xmit</code> æ¥å£ï¼‰ï¼Œè¯·ä½ æŠŠå®ƒå‘å‡ºå»ã€‚</li></ul></li><li>é«˜å†…èš/ä½è€¦åˆï¼šå†…æ ¸ä¸é©±åŠ¨æ˜¯æç«¯çš„ä½è€¦åˆã€‚æˆ‘ä»¬å¯ä»¥éšæ„æ›´æ–°æ˜¾å¡é©±åŠ¨ï¼Œè€Œæ— éœ€é‡æ–°ç¼–è¯‘æ•´ä¸ªå†…æ ¸ç³»ç»Ÿã€‚åè€Œï¼Œå†…æ ¸å‡çº§æ—¶ï¼Œåªè¦ä¸æ”¹å˜é©±åŠ¨æ¥å£ï¼ˆä¿æŒABI ç¨³å®šï¼‰ï¼Œè€çš„é©±åŠ¨æ¨¡å—å°±å¯ä»¥ç»§ç»­å·¥ä½œã€‚</li></ul><h4 id="è®¡ç®—æœºç½‘ç»œtcpip-åè®®æ ˆ">è®¡ç®—æœºç½‘ç»œï¼šTCP/IP åè®®æ ˆ</h4><p>æˆ‘ä»¬ä¹‹å‰æåˆ°çš„ OSI ä¸ƒå±‚åè®®å’Œ TCP/IPå››å±‚åè®®ï¼Œå³æ˜¯åˆ†å±‚çš„å®Œç¾å®è·µä½“ç°ï¼Œä¹Ÿæ˜¯æ¨¡å—åŒ–çš„å…¸èŒƒã€‚åè®®æ ˆä¸­çš„æ¯ä¸€å±‚å°±æ˜¯ä¸€ä¸ªæ¨¡å—ï¼Œå®ƒä»¬ä¹‹å‰éƒ½å®šä¹‰äº†æ•°æ®ä¼ é€’æ¥å£ï¼Œä½¿å¾—æ¯ä¸€å±‚çš„å…³æ³¨ç‚¹åˆ†ç¦»ï¼Œä»è€Œå®ç°äº†é«˜å†…èšä½è€¦åˆã€‚</p><h4 id="æ•°æ®åº“ç³»ç»Ÿsql-ä¸å­˜å‚¨">æ•°æ®åº“ç³»ç»Ÿï¼šSQL ä¸å­˜å‚¨</h4><p>æ•°æ®åº“ç³»ç»Ÿä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œä»¥ MySQLä¸ºä¾‹ï¼Œå¯æ’æ‹”å­˜å‚¨å¼•æ“æ¶æ„å°±æ˜¯æ¨¡å—åŒ–çš„å®Œç¾ä½“ç°ã€‚</p><ul><li>æ¨¡å—ï¼šå­˜å‚¨å¼•æ“ï¼ˆå¦‚ InnoDBã€MyISAMï¼‰å’Œ SQL è§£æ/ä¼˜åŒ–å™¨ï¼ˆServerå±‚ï¼‰ã€‚</li><li>æ¥å£ï¼šMySQL å®šä¹‰äº†ä¸€å¥—å­˜å‚¨å¼•æ“APIã€‚ä»»ä½•å­˜å‚¨å¼•æ“ï¼Œåªè¦å®ç°äº†è¿™å¥—æ ‡å‡†æ¥å£ï¼Œå°±å¯ä»¥è¢«é›†æˆä¸º MySQLä¸­ã€‚</li><li>å°è£…ï¼š<ul><li>SQL å±‚çš„å°è£…ï¼šä¼˜åŒ–å™¨ï¼ˆServerå±‚æ¨¡å—ï¼‰åªè´Ÿè´£ç”Ÿæˆæœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’ã€‚å®ƒä¸éœ€è¦çŸ¥é“ InnoDB æ˜¯å¦‚ä½•å®ç° MVCCçš„ï¼Œä¹Ÿä¸éœ€è¦çŸ¥é“ MyISAM æ˜¯å¦‚ä½•å­˜å‚¨ç´¢å¼•çš„ã€‚å®ƒåªéœ€è¦é€šè¿‡æ¥å£æ‰‹ï¼šè¯·ä½ ä»<code>idx_user_name</code> ç´¢å¼•ä¸­å–å‡ºæ•°æ®ã€‚</li><li>å¼•æ“çš„å°è£…ï¼šInnoDBæ¨¡å—ï¼ˆå­˜å‚¨å¼•æ“ï¼‰åªè´Ÿè´£ç®¡ç†æ•°æ®é¡µã€äº‹åŠ¡æ—¥å¿—ã€é”ã€‚å®ƒä¸éœ€è¦çŸ¥é“ SQLæ˜¯å¦‚ä½•è¢«è§£æå’Œä¼˜åŒ–çš„ã€‚</li></ul></li><li>é«˜å†…èš/ä½è€¦åˆï¼šServer å±‚å’Œ Storage Engineå±‚æ˜¯ä¸¤ä¸ªé«˜åº¦è§£è€¦çš„æ¨¡å—ã€‚Server å±‚é«˜åº¦å†…èšï¼Œåªè´Ÿè´£ SQLè§£æã€ä¼˜åŒ–ã€ç½‘ç»œè¿æ¥ï¼›InnoDBé«˜åº¦å†…èšï¼Œåªè´Ÿè´£äº‹åŠ¡å’Œå­˜å‚¨ã€‚è¿™å®Œç¾å°†"å¦‚ä½•è§£æå’Œä¼˜åŒ–SQL"å’Œ"å¦‚ä½•å­˜å‚¨å’Œç®¡ç†æ•°æ®"è¿™ä¸¤ä¸ªæ ¸å¿ƒä¸”å¤æ‚çš„å…³æ³¨ç‚¹è¿›è¡Œå½»åº•åˆ†ç¦»ï¼Œä½¿å¾—å®ƒä»¬å¯ä»¥ç‹¬ç«‹æ¼”è¿›è€Œäº’ä¸å¹²æ‰°ã€‚</li></ul><h4 id="redisæ’ä»¶ç³»ç»Ÿ">Redisï¼šæ’ä»¶ç³»ç»Ÿ</h4><p>Redis Modules åŒæ ·çš„æ¨¡å—åŒ–è¿ç”¨çš„å…¸èŒƒã€‚</p><ul><li>æ¨¡å—ï¼šå¯åŠ è½½çš„ .so åŠ¨æ€åº“ï¼ˆå¦‚RediSearchã€RedisJSONã€RedisGraphï¼‰ã€‚</li><li>æ¥å£ï¼š<code>redismodule.h</code> å¤´æ–‡ä»¶ã€‚Redis æ ¸å¿ƒæš´éœ²äº†ä¸€æ•´å¥— CAPIï¼Œå…è®¸æ¨¡å—å‘ Redisæ³¨å†Œæ–°æ˜äº†ã€æ“ä½œå†…éƒ¨æ•°æ®ç»“æ„ã€ç”šè‡³å®ç°æ–°çš„æ•°æ®ç±»å‹ã€‚</li><li>å°è£…ï¼š<ul><li>Redis æ ¸å¿ƒçš„å°è£…ï¼šRediSearch æ¨¡å—ï¼ˆå…¨æ–‡æœç´¢å¼•æ“ï¼‰ä¸éœ€è¦çŸ¥é“ Redisæ˜¯å¦‚ä½•å¤„ç†ç½‘ç»œäº‹ä»¶å¾ªç¯æˆ– RDB å¿«ç…§çš„ã€‚å®ƒåªéœ€è¦é€šè¿‡ API è¯´ï¼šè¯·å¸®æˆ‘æ³¨å†Œä¸€ä¸ªFT.SEARCH å‘½ä»¤ã€‚</li><li>æ¨¡å—çš„å°è£…ï¼šRedis æ ¸å¿ƒå®Œå…¨ä¸çŸ¥é“ RediSearchå†…éƒ¨æ˜¯å¦‚ä½•æ„å»ºå€’æ’ç´¢å¼•çš„ã€‚å®ƒåªçŸ¥é“ RediSearchæ˜¯ä¸€ä¸ªå¯åŠ è½½çš„é»‘ç›’æ¨¡å—ã€‚</li></ul></li><li>é«˜å†…èš/ä½è€¦åˆï¼šRedis é€šè¿‡ Modules API å°†æ ¸å¿ƒ K-VåŠŸèƒ½ä¸æ‰©å±•åŠŸèƒ½å®Œç¾è§£è€¦ã€‚è¿™æ—¢ä¿è¯äº†æ ¸å¿ƒçš„è½»é‡ä¸ç¨³å®šï¼Œåˆæä¾›äº†æ— é™æ‰©å±•æ€§ã€‚</li></ul><h4 id="kafkaç®¡é“ä¸æ’å¤´çš„åˆ†ç¦»">Kafkaï¼šç®¡é“ä¸æ’å¤´çš„åˆ†ç¦»</h4><p>Kafkaçš„æ ¸å¿ƒï¼ˆBorkerï¼‰æ˜¯ä¸€ä¸ªé«˜å†…èšçš„æ¨¡å—ï¼Œå®ƒåªåšä¸€ä»¶äº‹ï¼šé«˜ååã€å¯æŒä¹…åŒ–çš„æ—¥å¿—ç³»ç»Ÿã€‚ä½†Kafka é¢ä¸´çš„æŒ‘æˆ˜æ˜¯ï¼š<font color="red"><u>æ•°æ®å¦‚ä½•æµå…¥ï¼ˆä¾‹å¦‚ä» MySQLBinlogï¼‰ï¼Œåˆå¦‚ä½•æµå‡ºï¼ˆä¾‹å¦‚åˆ° S3ï¼‰ï¼Ÿ</u></font>å¦‚æœè®© Kafkaæ ¸å¿ƒå›¢é˜Ÿå»å†™æ‰€æœ‰è¿™äº›è¿æ¥å™¨ï¼Œä»–ä»¬åŒ…é¡¶ä¸ä½çš„ï¼Œæ ¸å¿ƒç³»ç»Ÿä¹Ÿä¼šå˜å¾—å¼‚å¸¸è‡ƒè‚¿ã€‚é‚£Kafka ç»™å‡ºçš„ç­”æ¡ˆå°±æ˜¯ Kafka Connect æ¡†æ¶ã€‚</p><ul><li>æ¨¡å—ï¼šConnectæ¡†æ¶ä½œä¸ºä¸»æ¨¡å—ï¼Œè´Ÿè´£æ‰€æœ‰è„æ´»ç´¯æ´»ï¼Œå¦‚å®¹é”™ã€åç§»é‡æäº¤ã€å¹¶è¡ŒåŒ–ã€RESTAPIã€‚Connecor ä½œä¸ºå­æ¨¡å—ï¼Œå¦‚<code>debezium-connector-mysql</code> æ˜¯ä¸€ä¸ªSource æ¨¡å—ï¼Œ<code>kafka-connect-s3</code> æ˜¯ä¸€ä¸ª Sink æ¨¡å—ã€‚</li><li>æ¥å£ï¼šKafka Connect å®šä¹‰äº†ä¸€ç»„ APIï¼Œå¦‚SourceConnectorã€SinkConnectorã€Converter ç­‰ Java æ¥å£ã€‚</li><li>å°è£…ï¼š<ul><li>Kafka æ ¸å¿ƒçš„å°è£…ï¼š<code>debezium-connector-mysql</code>æ¨¡å—ä¸éœ€è¦çŸ¥é“ Kafka Broker æ˜¯å¦‚ä½•å®ç° Raft åè®®æˆ–ç®¡ç†ç£ç›˜ Logæ–‡ä»¶çš„ã€‚å®ƒåªéœ€è¦é€šè¿‡æ¥å£è¯´ï¼šè¯·æŠŠè¿™ä¸ª Change Eventï¼ˆæ•°æ®ï¼‰å‘é€åˆ°mysql-binlog topicã€‚</li><li>Connector çš„å°è£…ï¼šKafka Broker æ ¸å¿ƒå®Œå…¨ä¸çŸ¥é“ Debeziumæ˜¯å¦‚ä½•é€šè¿‡ä¼ªè£…æˆ MySQL ä»åº“æ¥è¯»å– binlog çš„ã€‚Brokeråªè®¤è¯†æ ‡å‡†çš„æ¥å£æ•°æ®ã€‚</li></ul></li><li>é«˜å†…èšä½è€¦åˆï¼šè¿™ç§æ¨¡å—åŒ–ä½¿å¾— Kafka Brokeré«˜åº¦å†…èšï¼Œåªè´Ÿè´£é«˜ååã€å¯æŒä¹…åŒ–çš„æ—¥å¿—ç³»ç»Ÿã€‚æ‰€æœ‰ä¸å¤–éƒ¨ç³»ç»Ÿçš„é›†æˆå…¨éƒ¨è¢«è§£è€¦åˆ°äº†Connect æ¨¡å—ä¸­ï¼Œè¿™ä½¿å¾— Kafkaæˆä¸ºäº†ä¸€ä¸ªä¸‡èƒ½æ’åº§ï¼Œä»»ä½•ç³»ç»Ÿéƒ½å¯ä»¥é€šè¿‡ç¼–å†™ä¸€ä¸ª Connectoræ¨¡å—æ¥æ¥å…¥ã€‚</li></ul><h4 id="rag-ä¸-ai-agentå¤©ç”Ÿçš„æ¨¡å—åŒ–">RAG ä¸ AI Agentï¼šå¤©ç”Ÿçš„æ¨¡å—åŒ–</h4><p>LLMä½œä¸ºä¸€ä¸ªå°é—­çš„å¤§è„‘ï¼Œå®ƒä¸ä¼šä½¿ç”¨å·¥ä½œï¼Œä¹Ÿæ²¡æœ‰é•¿æœŸè®°å¿†ï¼Œæ›´ä¸çŸ¥é“æˆ‘ä»¬ç§æœ‰çš„ä¸€äº›å†…éƒ¨æ–‡æ¡£å’Œèµ„æ–™ã€‚ä¸ºäº†AI èƒ½æ›´å¥½çš„æœåŠ¡æˆ‘ä»¬çš„å®é™…éœ€æ±‚ï¼ŒRAG å’Œ AI Agent åº”è¿è€Œç”Ÿã€‚åœ¨æˆ‘çœ‹æ¥ï¼ŒRAGå’Œ AI Agent çš„æ¶æ„å¤©ç”Ÿå°±æ˜¯æ¨¡å—çš„ã€‚</p><p>RAG æœ€ä¸»è¦å°±æ˜¯ä¸¤ä¸ªæ¨¡å—ï¼š</p><ul><li>Retrieverï¼ˆæ£€ç´¢å™¨æ¨¡å—ï¼‰ï¼šåªè´Ÿè´£æ ¹æ®æŸ¥è¯¢ä»çŸ¥è¯†åº“æ£€ç´¢ç›¸å…³æ–‡æ¡£</li><li>Generatorï¼ˆç”Ÿæˆå™¨æ¨¡å—ï¼Œå³LLMï¼‰ï¼šåªè´Ÿè´£æ ¹æ®ç»™å®šçš„ä¸Šä¸‹æ–‡å’ŒæŸ¥è¯¢ç”Ÿæˆç­”æ¡ˆã€‚</li></ul><p>è¿™ä½¿å¾—æˆ‘ä»¬å¯ä»¥éšæ„æ›¿æ¢ä¸åŒçš„å‘é‡æ•°æ®åº“ã€æ£€ç´¢ç­–ç•¥å’Œ LLMã€‚</p><p>AI Agent æœ€ä¸»è¦çš„æ˜¯ä¸‰ä¸ªæ¨¡å—ï¼š</p><ul><li>Orchestratorï¼ˆåè°ƒå™¨æ¨¡å— ï¼‰åªè´Ÿè´£è§£æ LLM æ„å›¾ã€å¾ªç¯æ‰§è¡Œã€‚</li><li>LLMï¼ˆå¤§è„‘æ¨¡å—ï¼‰ï¼šåªè´Ÿè´£æ€è€ƒå’Œé€‰æ‹©å·¥å…·ã€‚</li><li>Toolsï¼ˆå·¥å…·æ¨¡å—ï¼‰ï¼šåªè´Ÿè´£æ‰§è¡Œä¸€ä¸ªå…·ä½“çš„ä»»åŠ¡å¹¶ç»™å‡ºç»“æœã€‚</li></ul><p>LLM ä¸éœ€è¦çŸ¥é“å·¥å…·æ˜¯å¦‚ä½•å®ç° APIè°ƒç”¨çš„ï¼Œå®ƒåªçŸ¥é“è¿™ä¸ªå·¥å…·çš„æ¥å£æè¿°ã€‚è¿™ä½¿å¾—ä½ å¯ä»¥æ— é™åœ°æ’æ‹”æ–°å·¥å…·ï¼Œèµ‹äºˆAI Agent æ— é™æƒ³è±¡çš„æ–°èƒ½åŠ›ã€‚</p><h1 id="æœ¯æ„å»ºä¸è®¾è®¡çš„æŒ‡å¯¼æ¡†æ¶">æœ¯ï¼šæ„å»ºä¸è®¾è®¡çš„æŒ‡å¯¼æ¡†æ¶</h1><h2 id="solid-åŸåˆ™">SOLID åŸåˆ™</h2><p>SOLID åŸåˆ™ç”± Robert C. Martin (Uncle Bob)æç‚¼å¹¶æ¨å¹¿ï¼Œå¦‚æœæƒ³è¦ç†è§£å¹¶è¿ç”¨å¥½è¿™äº”å¤§åŸåˆ™ï¼Œæ ¸å¿ƒä¸åœ¨äºæˆ‘ä»¬æŠŠå®ƒä»¬èƒŒè¯µå¾—å¤šä¹ˆç†Ÿç»ƒï¼Œä¹Ÿä¸åœ¨äºæˆ‘ä»¬èƒ½å¤šå¿«é€Ÿåœ°è¯†åˆ«ç°æœ‰ä»£ç ç¬¦ä¸ç¬¦åˆå“ªäº›åŸåˆ™ï¼Œå…³é”®æ˜¯è¦å°†å®ƒä»¬çœ‹æˆä¸€ä¸ªæ•´ä½“ï¼Œå»æ€è€ƒå®ƒä»¬èƒŒååˆ°åº•æ˜¯åœ¨è§£å†³ä»€ä¹ˆé—®é¢˜ã€‚</p><p>å½“æˆ‘ä»¬èŠ SOLIDåŸåˆ™æ—¶ï¼Œæˆ‘ä»¬ä¸æ˜¯åœ¨è°ˆè®ºäº”æ¡ç‹¬ç«‹çš„è§„åˆ™ï¼Œè€Œæ˜¯åœ¨è°ˆè®ºä¸€ä¸ªç»Ÿä¸€çš„æ ¸å¿ƒæ€æƒ³ï¼šåœ¨é¢å‘å¯¹è±¡(OOP)èŒƒå¼ä¸‹ï¼Œå¦‚ä½•ç§‘å­¦åœ°ç®¡ç†ä¾èµ–å…³ç³»ï¼Œä»¥åº”å¯¹è½¯ä»¶çš„å¤æ‚æ€§å’ŒæŒç»­ä¸æ–­çš„å˜åŒ–ã€‚</p><blockquote><p>å½“ç„¶ï¼Œåœ¨éä¸¥æ ¼ OOP ç¼–ç¨‹è¯­è¨€ä¸Šï¼Œä¹Ÿæ˜¯å¯ä»¥å€Ÿé‰´ç±»ä¼¼æ€æƒ³çš„ï¼Œå¦‚ Go çš„struct/interface å’Œ Rust çš„ struct/traitã€‚</p></blockquote><p>ä¸€ä¸ªè½¯ä»¶ç³»ç»Ÿçš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œæœ€å¤§çš„æˆæœ¬ä¸æ˜¯æ¥è‡ªâ€œé¦–æ¬¡å¼€å‘â€ï¼Œè€Œæ˜¯æ¥è‡ªâ€œæŒç»­ç»´æŠ¤â€â€”â€”å³ä¿®å¤Bugã€ä¿®æ”¹åŠŸèƒ½å’Œæ·»åŠ æ–°åŠŸèƒ½ã€‚</p><p>ä¸€ä¸ªè…åŒ–çš„è½¯ä»¶ç³»ç»Ÿï¼ˆé«˜è€¦åˆã€ä½å†…èšï¼‰åœ¨é¢å¯¹å˜åŒ–æ—¶ï¼Œä¼šè¡¨ç°å‡ºä¸¤ä¸ªè‡´å‘½ç‰¹å¾ï¼š</p><ol type="1"><li><strong>åƒµåŒ–æ€§(Rigidity)</strong>ï¼šæ”¹åŠ¨ä¸€ä¸ªåœ°æ–¹å¾ˆå›°éš¾ï¼Œå› ä¸ºå®ƒç‰µè¿ç€è®¸å¤šå…¶ä»–æ¨¡å—ã€‚</li><li><strong>è„†å¼±æ€§(Fragility)</strong>ï¼šæ”¹åŠ¨ä¸€ä¸ªåœ°æ–¹ï¼Œå¯¼è‡´ç³»ç»Ÿä¸­è®¸å¤šä¸ç›¸å…³çš„åœ°æ–¹å‡ºç°äº†æ„æ–™ä¹‹å¤–çš„Bugã€‚</li></ol><p>SOLIDåŸåˆ™å°±æ˜¯ä¸€å¥—ç»„åˆæ‹³ï¼Œå®ƒä»¬å…±åŒçš„ç›®æ ‡æ˜¯åˆ›å»º<strong>é«˜å†…èšã€ä½è€¦åˆ</strong>çš„æ¨¡å—åŒ–ç»“æ„ï¼Œä»è€Œæˆ˜èƒœè¿™ä¸¤ç§ç‰¹å¾ã€‚æœ€ç»ˆäº§å‡ºçš„ç³»ç»Ÿåº”è¯¥æ˜¯ï¼š</p><ul><li><strong>æ˜“äºä¿®æ”¹çš„(Flexible)</strong>ï¼šæ·»åŠ æ–°åŠŸèƒ½æ—¶ï¼Œå¯¹ç°æœ‰ä»£ç çš„å½±å“æœ€å°ã€‚</li><li><strong>æ˜“äºç†è§£çš„(Understandable)</strong>ï¼šæ¨¡å—è¾¹ç•Œæ¸…æ™°ï¼ŒèŒè´£å•ä¸€ã€‚</li><li><strong>æ˜“äºæµ‹è¯•çš„(Testable)</strong>ï¼šæ¨¡å—å¯ä»¥è¢«ç‹¬ç«‹åœ°éš”ç¦»å’Œæµ‹è¯•ã€‚</li></ul><h3 id="å•ä¸€èŒè´£åŸåˆ™-srp---single-responsibility-principle">å•ä¸€èŒè´£åŸåˆ™(SRP - Single Responsibility Principle)</h3><ul><li><strong>å®ƒè§£å†³äº†ä»€ä¹ˆï¼š</strong> æ¨¡å—çš„"è¾¹ç•Œ"é—®é¢˜ã€‚</li><li><strong>å®ƒçš„è§’è‰²ï¼š</strong> <strong>è§£è€¦çš„èµ·ç‚¹</strong>ã€‚</li><li><strong>é€»è¾‘ï¼š</strong>å®ƒå¼ºåˆ¶æˆ‘ä»¬è¿›è¡Œ<strong>æ‹†åˆ†</strong>ã€‚å®ƒå®šä¹‰äº†ä¸€ä¸ªæ¨¡å—ï¼ˆåœ¨ OOP ä¸­é€šå¸¸æ˜¯Classï¼ŒGo/Rust é‡Œé¢æ˜¯structï¼‰åº”è¯¥å…·æœ‰é«˜å†…èšæ€§ã€‚é«˜å†…èšæ„å‘³ç€åªä¸ºä¸€ä¸ªå˜åŒ–çš„åŸå› è€Œå­˜åœ¨ã€‚å¦‚æœä¸€ä¸ªç±»æ··åˆäº†ä¸šåŠ¡é€»è¾‘ã€æ•°æ®æŒä¹…åŒ–å’Œæ—¥å¿—è®°å½•ï¼Œé‚£ä¹ˆè¿™ä¸‰ä¸ªå˜åŒ–çš„åŸå› ä¸­ä»»ä½•ä¸€ä¸ªå‘ç”Ÿï¼Œéƒ½å¯èƒ½ç ´åè¿™ä¸ªç±»ã€‚SRPé€šè¿‡æ‹†åˆ†ï¼Œ<strong>é¦–å…ˆåœ¨å¾®è§‚ä¸Šéš”ç¦»äº†å˜åŒ–</strong>ã€‚</li></ul><h3 id="å¼€æ”¾å°é—­åŸåˆ™-ocp---openclosed-principle">å¼€æ”¾å°é—­åŸåˆ™ (OCP -Open/Closed Principle)</h3><ul><li><strong>å®ƒè§£å†³äº†ä»€ä¹ˆï¼š</strong> ç³»ç»Ÿçš„"æ‰©å±•"é—®é¢˜ã€‚</li><li><strong>å®ƒçš„è§’è‰²ï¼š</strong> <strong>è§£è€¦çš„ç›®æ ‡</strong>ã€‚</li><li><strong>é€»è¾‘ï¼š</strong> è¿™æ˜¯ SOLIDçš„æ ¸å¿ƒç›®æ ‡ã€‚å®ƒæŒ‡å‡ºç³»ç»Ÿåº”è¯¥å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å°é—­ã€‚è¿™æ„å‘³ç€å½“æ–°éœ€æ±‚ï¼ˆå˜åŒ–ï¼‰åˆ°æ¥æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥é€šè¿‡<strong>æ·»åŠ æ–°ä»£ç </strong>ï¼ˆä¾‹å¦‚å®ç°ä¸€ä¸ªæ–°ç±»ï¼‰æ¥å®Œæˆï¼Œè€Œä¸æ˜¯é€šè¿‡<strong>ä¿®æ”¹æ—§çš„ã€å·²éªŒè¯çš„ä»£ç </strong>ã€‚</li><li><strong>å…³é”®é—®é¢˜ï¼š</strong> OCP åªæ˜¯ä¸€ä¸ªç›®æ ‡ï¼Œå®ƒæ²¡æœ‰è¯´ <em>å¦‚ä½•</em>åšåˆ°ã€‚SRP æ‹†åˆ†äº†æ¨¡å—ï¼Œä½† OCPå‘Šè¯‰æˆ‘ä»¬è¿™äº›æ¨¡å—ä¹‹é—´å¿…é¡»ä¾èµ–<strong>æŠ½è±¡</strong>ï¼Œè€Œä¸æ˜¯å…·ä½“å®ç°ã€‚</li></ul><h3 id="é‡Œæ°æ›¿æ¢åŸåˆ™-lsp---liskov-substitution-principle">é‡Œæ°æ›¿æ¢åŸåˆ™(LSP - Liskov Substitution Principle)</h3><ul><li><strong>å®ƒè§£å†³äº†ä»€ä¹ˆï¼š</strong> æŠ½è±¡çš„"å¯é æ€§"é—®é¢˜ã€‚</li><li><strong>å®ƒçš„è§’è‰²ï¼š</strong> <strong>å®ç° OCP çš„åŸºçŸ³</strong>ã€‚</li><li><strong>é€»è¾‘ï¼š</strong> OCP ä¾èµ–äºæŠ½è±¡ï¼ˆå¦‚æ¥å£æˆ–åŸºç±»ï¼‰å’Œå¤šæ€ã€‚LSPæä¾›äº†<strong>å®ç°å¤šæ€çš„æ­£ç¡®æ€§è§„èŒƒ</strong>ã€‚å®ƒç¡®ä¿ä»»ä½•å­ç±»ï¼ˆå…·ä½“å®ç°ï¼‰éƒ½å¿…é¡»èƒ½å¤Ÿæ›¿æ¢å…¶çˆ¶ç±»ï¼ˆæŠ½è±¡ï¼‰è€Œç¨‹åºçš„è¡Œä¸ºä¸å‘ç”Ÿä»»ä½•æ”¹å˜ã€‚å¦‚æœä¸€ä¸ªå­ç±»çš„å®ç°è¿åäº†çˆ¶ç±»çš„çº¦å®šï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ª<code>Square</code> ç±»ç»§æ‰¿ <code>Rectangle</code>ï¼Œå¹¶é‡å†™äº†<code>setHeight</code> æ–¹æ³•å¯¼è‡´å…¶ <code>Width</code>ä¹Ÿå‘ç”Ÿå˜åŒ–ï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªæŠ½è±¡å°±æ˜¯ä¸å¯é çš„ã€‚</li><li><strong>ä½œç”¨ï¼š</strong> LSP æ˜¯<strong>ä¿è¯ OCPå¾—ä»¥å®ç°çš„è¡Œä¸ºå¥‘çº¦</strong>ã€‚æ²¡æœ‰LSPï¼ŒæŠ½è±¡å°±æ¯«æ— æ„ä¹‰ï¼Œå¯¹ä¿®æ”¹å°é—­ä¹Ÿå°±æ— ä»è°ˆèµ·ã€‚</li></ul><h3 id="æ¥å£éš”ç¦»åŸåˆ™-isp---interface-segregation-principle">æ¥å£éš”ç¦»åŸåˆ™(ISP - Interface Segregation Principle)</h3><ul><li><strong>å®ƒè§£å†³äº†ä»€ä¹ˆï¼š</strong> æŠ½è±¡çš„"ç²’åº¦"é—®é¢˜ã€‚</li><li><strong>å®ƒçš„è§’è‰²ï¼š</strong> <strong>é™ä½ä¾èµ–çš„æˆæœ¬</strong>ã€‚</li><li><strong>é€»è¾‘ï¼š</strong> å³ä½¿æˆ‘ä»¬æœ‰äº† OCPï¼ˆä¾èµ–æŠ½è±¡ï¼‰å’ŒLSPï¼ˆæŠ½è±¡å¯é ï¼‰ï¼Œä½†å¦‚æœè¿™ä¸ªæŠ½è±¡ï¼ˆæ¥å£ï¼‰æœ¬èº«éå¸¸è‡ƒè‚¿ï¼Œå®ƒä¼šå¼ºè¿«å®¢æˆ·ç«¯ï¼ˆä½¿ç”¨è€…ï¼‰ä¾èµ–å®ƒä»¬æ ¹æœ¬ä¸éœ€è¦çš„æ–¹æ³•ã€‚è¿™ç§ä¸å¿…è¦çš„ä¾èµ–ä¼šé€ æˆè€¦åˆã€‚</li><li><strong>ä½œç”¨ï¼š</strong> ISPå‘Šè¯‰æˆ‘ä»¬ï¼ŒæŠ½è±¡åº”è¯¥<strong>ç²¾ç»†åŒ–ã€å®¢æˆ·åŒ–</strong>ã€‚å®ƒæœ¬è´¨ä¸Šæ˜¯ SRPåœ¨æ¥å£è®¾è®¡ä¸Šçš„åº”ç”¨ã€‚å®ƒé€šè¿‡æ‹†åˆ†å¤§æ¥å£ï¼Œç¡®ä¿äº†ä¾èµ–å…³ç³»çš„<strong>æœ€å°åŒ–</strong>å’Œ<strong>ç²¾å‡†åŒ–</strong>ã€‚</li></ul><h3 id="ä¾èµ–å€’ç½®åŸåˆ™-dip---dependency-inversion-principle">ä¾èµ–å€’ç½®åŸåˆ™(DIP - Dependency Inversion Principle)</h3><ul><li><strong>å®ƒè§£å†³äº†ä»€ä¹ˆï¼š</strong> ä¾èµ–çš„"æ–¹å‘"é—®é¢˜ã€‚</li><li><strong>å®ƒçš„è§’è‰²ï¼š</strong> <strong>è§£è€¦çš„æ¶æ„è“å›¾</strong>ã€‚</li><li><strong>é€»è¾‘ï¼š</strong> è¿™æ˜¯ SOLIDçš„æœ€é«˜å±‚æŒ‡å¯¼ã€‚å®ƒè§„å®šäº†ç³»ç»Ÿä¸­æ‰€æœ‰ä¾èµ–å…³ç³»çš„æ–¹å‘ã€‚<ul><li>A. é«˜å±‚æ¨¡å—ï¼ˆå¦‚ä¸šåŠ¡ç­–ç•¥ï¼‰ä¸åº”ä¾èµ–ä½å±‚æ¨¡å—ï¼ˆå¦‚æ•°æ®åº“å®ç°ï¼‰ã€‚</li><li>B. ä¸¤è€…éƒ½åº”ä¾èµ–äº<strong>æŠ½è±¡</strong>ï¼ˆå¦‚æ¥å£ï¼‰ã€‚</li></ul></li><li><strong>ä½œç”¨ï¼š</strong> DIP å°†ä¼ ç»Ÿçš„"é«˜å±‚ -&gt;ä½å±‚"çš„ä¾èµ–å…³ç³»ï¼Œ<strong>å€’ç½®</strong> ä¸º"é«˜å±‚ -&gt; æŠ½è±¡"å’Œ"ä½å±‚ -&gt;æŠ½è±¡"ã€‚è¿™ä½¿å¾—ç³»ç»Ÿçš„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆé«˜å±‚ï¼‰å®Œå…¨ç‹¬ç«‹äºä»»ä½•å…·ä½“çš„å®ç°ç»†èŠ‚ï¼ˆä½å±‚ï¼‰ã€‚<strong>è¿™æ˜¯å®ç°å¯¹ä¿®æ”¹å°é—­çš„æœ€å¼ºæœ‰åŠ›çš„æ¶æ„æ‰‹æ®µ</strong>ã€‚è¿™ä¹Ÿæ˜¯DDD å’Œæ´‹è‘±æ¶æ„çš„å…¸å‹å®ç°ã€‚</li></ul><h3 id="æ€»ç»“">æ€»ç»“</h3><p>SOLID åŸåˆ™æä¾›äº†ä¸€å¥—å®Œæ•´çš„ã€ä»å¾®è§‚åˆ°å®è§‚çš„è§£è€¦ç­–ç•¥ï¼š</p><ul><li><strong>SRP</strong> è´Ÿè´£åˆ›å»ºé«˜å†…èšçš„æ¨¡å—ã€‚</li><li><strong>OCP</strong> è®¾å®šäº†ä¾èµ–æŠ½è±¡çš„æœ€ç»ˆç›®æ ‡ã€‚</li><li><strong>LSP</strong> ä¿è¯äº†è¿™äº›æŠ½è±¡çš„å®ç°æ˜¯å¯é å’Œå¯æ›¿æ¢çš„ã€‚</li><li><strong>ISP</strong> ä¿è¯äº†è¿™äº›æŠ½è±¡æœ¬èº«æ˜¯ç²¾ç®€å’Œä½è€¦åˆçš„ã€‚</li><li><strong>DIP</strong>æœ€ç»ˆå®šä¹‰äº†æ•´ä¸ªç³»ç»Ÿçš„æ¶æ„ï¼Œç¡®ä¿äº†ä¾èµ–å…³ç³»æœå‘æ­£ç¡®çš„ï¼ˆå³ç¨³å®šçš„ï¼‰æ–¹å‘ã€‚</li></ul><h2 id="è®¾è®¡æ¨¡å¼">è®¾è®¡æ¨¡å¼</h2><h3 id="è®¾è®¡æ¨¡å¼æ¸…å•">è®¾è®¡æ¨¡å¼æ¸…å•</h3><ol type="1"><li><p>åˆ›å»ºå‹æ¨¡å¼ (CreationalPatterns)ï¼šè¿™äº›æ¨¡å¼æä¾›äº†ä¸åŒç§ç±»çš„å¯¹è±¡åˆ›å»ºæœºåˆ¶ï¼Œä½¿å¾—ä¸€ä¸ªç³»ç»Ÿåœ¨è¿è¡Œæ—¶å¯ä»¥é€‰æ‹©å…¶ä¸­çš„ä¸€ä¸ªé€‚å½“çš„åˆ›å»ºæ–¹æ³•æ¥åˆ›å»ºå¯¹è±¡ã€‚</p><ul><li>å•ä¾‹æ¨¡å¼ (SingletonPattern)ï¼šç¡®ä¿ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›å…¨å±€è®¿é—®ç‚¹æ¥è®¿é—®è¯¥å®ä¾‹ã€‚</li><li>å·¥å‚æ¨¡å¼ (FactoryPattern)ï¼šå®šä¹‰ä¸€ä¸ªç”¨äºåˆ›å»ºå¯¹è±¡çš„æ¥å£ï¼Œè®©å­ç±»å†³å®šå®ä¾‹åŒ–å“ªä¸ªç±»æ¥åˆ›å»ºå¯¹è±¡ã€‚</li><li>æŠ½è±¡å·¥å‚æ¨¡å¼ (Abstract FactoryPattern)ï¼šæä¾›ä¸€ä¸ªåˆ›å»ºä¸€ç³»åˆ—ç›¸å…³æˆ–ç›¸äº’ä¾èµ–å¯¹è±¡çš„æ¥å£ï¼Œè€Œæ— éœ€æŒ‡å®šå®ƒä»¬å…·ä½“çš„ç±»ã€‚</li><li>å»ºé€ è€…æ¨¡å¼ (BuilderPattern)ï¼šå°†ä¸€ä¸ªå¤æ‚å¯¹è±¡çš„æ„é€ ä¸å…¶è¡¨ç¤ºåˆ†ç¦»ï¼Œä½¿å¾—åŒæ ·çš„æ„é€ è¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„è¡¨ç¤ºã€‚</li><li>åŸå‹æ¨¡å¼ (Prototype Pattern)ï¼šé€šè¿‡å¤åˆ¶ç°æœ‰çš„å®ä¾‹æ¥åˆ›å»ºæ–°å®ä¾‹ã€‚</li></ul></li><li><p>ç»“æ„å‹æ¨¡å¼ (StructuralPatterns)ï¼šè¿™äº›æ¨¡å¼æè¿°å¦‚ä½•å°†ç±»æˆ–å¯¹è±¡ç»„åˆæˆæ›´å¤§çš„ç»“æ„ï¼Œä»¥æ»¡è¶³ç‰¹å®šçš„éœ€æ±‚ã€‚</p><ul><li>é€‚é…å™¨æ¨¡å¼ (AdapterPattern)ï¼šå°†ä¸€ä¸ªç±»çš„æ¥å£è½¬æ¢æˆå®¢æˆ·å¸Œæœ›çš„å¦å¤–ä¸€ä¸ªæ¥å£ã€‚é€‚é…å™¨æ¨¡å¼ä½¿å¾—åŸæœ¬ç”±äºæ¥å£ä¸å…¼å®¹è€Œä¸èƒ½ä¸€èµ·å·¥ä½œçš„é‚£äº›ç±»å¯ä»¥ä¸€èµ·å·¥ä½œã€‚</li><li>æ¡¥æ¥æ¨¡å¼ (BridgePattern)ï¼šå°†æŠ½è±¡éƒ¨åˆ†ä¸å®ƒçš„å®ç°éƒ¨åˆ†åˆ†ç¦»ï¼Œä½¿å¾—å®ƒä»¬éƒ½å¯ä»¥ç‹¬ç«‹åœ°å˜åŒ–ã€‚</li><li>è£…é¥°å™¨æ¨¡å¼ (DecoratorPattern)ï¼šåŠ¨æ€åœ°ç»™ä¸€ä¸ªå¯¹è±¡æ·»åŠ ä¸€äº›é¢å¤–çš„èŒè´£ã€‚å°±å¢åŠ åŠŸèƒ½è€Œè¨€ï¼Œè£…é¥°å™¨æ¨¡å¼æ¯”ç”Ÿæˆå­ç±»æ›´ä¸ºçµæ´»ã€‚</li><li>ç»„åˆæ¨¡å¼ (CompositePattern)ï¼šå°†å¯¹è±¡ç»„åˆæˆæ ‘å½¢ç»“æ„ä»¥è¡¨ç¤ºâ€œéƒ¨åˆ†-æ•´ä½“â€çš„å±‚æ¬¡ç»“æ„ã€‚</li><li>å¤–è§‚æ¨¡å¼ (FacadePattern)ï¼šä¸ºå­ç³»ç»Ÿä¸­çš„ä¸€ç»„æ¥å£æä¾›ä¸€ä¸ªä¸€è‡´çš„ç•Œé¢ï¼Œè¯¥æ¨¡å¼å®šä¹‰äº†ä¸€ä¸ªé«˜å±‚æ¥å£ï¼Œè¿™ä¸ªæ¥å£ä½¿å¾—è¿™ä¸€å­ç³»ç»Ÿæ›´åŠ å®¹æ˜“ä½¿ç”¨ã€‚</li><li>äº«å…ƒæ¨¡å¼ (FlyweightPattern)ï¼šè¿ç”¨å…±äº«æŠ€æœ¯æœ‰æ•ˆåœ°æ”¯æŒå¤§é‡ç»†ç²’åº¦çš„å¯¹è±¡ã€‚</li><li>ä»£ç†æ¨¡å¼ (ProxyPattern)ï¼šä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ç§ä»£ç†ä»¥æ§åˆ¶å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ã€‚</li></ul></li><li><p>è¡Œä¸ºå‹æ¨¡å¼ (BehavioralPatterns)ï¼šè¿™äº›æ¨¡å¼æ¶‰åŠåˆ°ç®—æ³•å’Œå¯¹è±¡é—´èŒè´£çš„åˆ†é…ï¼Œå¹¶æè¿°äº†åœ¨å¯¹è±¡ä¹‹é—´çš„é€šä¿¡æ¨¡å¼ã€‚</p><ul><li>è´£ä»»é“¾æ¨¡å¼ (Chain of ResponsibilityPattern)ï¼šä½¿å¤šä¸ªå¯¹è±¡éƒ½æœ‰æœºä¼šå¤„ç†è¯·æ±‚ï¼Œä»è€Œé¿å…è¯·æ±‚çš„å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´çš„è€¦åˆå…³ç³»ã€‚å°†è¿™äº›å¯¹è±¡è¿æˆä¸€æ¡é“¾ï¼Œå¹¶æ²¿ç€è¿™æ¡é“¾ä¼ é€’è¯¥è¯·æ±‚ï¼Œç›´åˆ°æœ‰ä¸€ä¸ªå¯¹è±¡å¤„ç†å®ƒä¸ºæ­¢ã€‚</li><li>å‘½ä»¤æ¨¡å¼ (CommandPattern)ï¼šå°†è¯·æ±‚å°è£…æˆå¯¹è±¡ï¼Œä»è€Œè®©ä½ ä½¿ç”¨ä¸åŒçš„è¯·æ±‚ã€é˜Ÿåˆ—æˆ–è€…æ—¥å¿—æ¥å‚æ•°åŒ–å…¶å®ƒå¯¹è±¡ã€‚å‘½ä»¤æ¨¡å¼ä¹Ÿå¯ä»¥æ”¯æŒæ’¤é”€æ“ä½œã€‚</li><li>è§£é‡Šå™¨æ¨¡å¼ (InterpreterPattern)ï¼šç»™å®šä¸€ä¸ªè¯­è¨€ï¼Œå®šä¹‰å®ƒçš„æ–‡æ³•çš„ä¸€ç§è¡¨ç¤ºï¼Œå¹¶å®šä¹‰ä¸€ä¸ªè§£é‡Šå™¨ï¼Œè¯¥è§£é‡Šå™¨ä½¿ç”¨è¯¥è¡¨ç¤ºæ¥è§£é‡Šè¯­è¨€ä¸­çš„å¥å­ã€‚</li><li>è¿­ä»£å™¨æ¨¡å¼ (IteratorPattern)ï¼šæä¾›ä¸€ç§æ–¹æ³•é¡ºåºè®¿é—®ä¸€ä¸ªèšåˆå¯¹è±¡ä¸­çš„å„ä¸ªå…ƒç´ ï¼Œè€Œåˆä¸æš´éœ²è¯¥å¯¹è±¡çš„å†…éƒ¨è¡¨ç¤ºã€‚</li><li>ä¸­ä»‹è€…æ¨¡å¼ (MediatorPattern)ï¼šç”¨ä¸€ä¸ªä¸­ä»‹å¯¹è±¡å°è£…ä¸€ç³»åˆ—çš„å¯¹è±¡äº¤äº’ã€‚ä¸­ä»‹è€…ä½¿å¾—å„ä¸ªå¯¹è±¡ä¹‹é—´ä¸éœ€è¦æ˜¾å¼åœ°ç›¸äº’å¼•ç”¨ï¼Œä»è€Œä½¿å…¶è€¦åˆæ¾æ•£ï¼Œè€Œä¸”å¯ä»¥ç‹¬ç«‹åœ°æ”¹å˜å®ƒä»¬ä¹‹é—´çš„äº¤äº’ã€‚</li><li>å¤‡å¿˜å½•æ¨¡å¼ (MementoPattern)ï¼šåœ¨ä¸ç ´åå°è£…æ€§çš„å‰æä¸‹ï¼Œæ•è·ä¸€ä¸ªå¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ï¼Œå¹¶åœ¨è¯¥å¯¹è±¡ä¹‹å¤–ä¿å­˜è¿™ä¸ªçŠ¶æ€ã€‚è¿™æ ·ä»¥åå°±å¯ä»¥å°†è¯¥å¯¹è±¡æ¢å¤åˆ°åŸå…ˆä¿å­˜çš„çŠ¶æ€ã€‚</li><li>è§‚å¯Ÿè€…æ¨¡å¼ (ObserverPattern)ï¼šå®šä¹‰äº†å¯¹è±¡ä¹‹é—´çš„ä¸€å¯¹å¤šä¾èµ–å…³ç³»ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå½“ä¸€ä¸ªå¯¹è±¡æ”¹å˜çŠ¶æ€æ—¶ï¼Œå®ƒçš„æ‰€æœ‰ä¾èµ–è€…éƒ½ä¼šæ”¶åˆ°é€šçŸ¥å¹¶è‡ªåŠ¨æ›´æ–°ã€‚</li><li>çŠ¶æ€æ¨¡å¼ (StatePattern)ï¼šå…è®¸å¯¹è±¡åœ¨å†…éƒ¨çŠ¶æ€æ”¹å˜æ—¶æ”¹å˜å®ƒçš„è¡Œä¸ºï¼Œå¯¹è±¡çœ‹èµ·æ¥ä¼¼ä¹ä¿®æ”¹äº†å®ƒæ‰€å±çš„ç±»ã€‚</li><li>ç­–ç•¥æ¨¡å¼ (StrategyPattern)ï¼šå®šä¹‰ä¸€ç³»åˆ—ç®—æ³•ï¼ŒæŠŠå®ƒä»¬ä¸€ä¸ªä¸ªå°è£…èµ·æ¥ï¼Œå¹¶ä½¿å®ƒä»¬å¯ä»¥ç›¸äº’æ›¿æ¢ã€‚æœ¬æ¨¡å¼ä½¿å¾—ç®—æ³•çš„å˜åŒ–å¯ç‹¬ç«‹äºä½¿ç”¨å®ƒçš„å®¢æˆ·ç«¯ã€‚</li><li>æ¨¡æ¿æ–¹æ³•æ¨¡å¼ (Template MethodPattern)ï¼šå®šä¹‰ä¸€ä¸ªæ“ä½œä¸­çš„ç®—æ³•çš„éª¨æ¶ï¼Œè€Œå°†ä¸€äº›æ­¥éª¤å»¶è¿Ÿåˆ°å­ç±»ä¸­ã€‚æ¨¡æ¿æ–¹æ³•ä½¿å¾—å­ç±»å¯ä»¥ä¸æ”¹å˜ä¸€ä¸ªç®—æ³•ç»“æ„å³å¯é‡å®šä¹‰è¯¥ç®—æ³•çš„æŸäº›ç‰¹å®šæ­¥éª¤ã€‚</li><li>è®¿é—®è€…æ¨¡å¼ (VisitorPattern)ï¼šè¡¨ç¤ºä¸€ä¸ªä½œç”¨äºæŸå¯¹è±¡ç»“æ„ä¸­çš„å„å…ƒç´ çš„æ“ä½œï¼Œå®ƒä½¿ä½ å¯ä»¥åœ¨ä¸æ”¹å˜å„å…ƒç´ çš„ç±»çš„å‰æä¸‹å®šä¹‰ä½œç”¨äºè¿™äº›å…ƒç´ çš„æ–°æ“ä½œã€‚</li></ul></li></ol><blockquote><p>è®¾è®¡æ¨¡å¼çš„ä»£ç å®æˆ˜å¯å‚è€ƒï¼šhttps://github.com/hedon954/go-designmode</p></blockquote><h3 id="ç†è§£è®¾è®¡æ¨¡å¼">ç†è§£è®¾è®¡æ¨¡å¼</h3><p>çœ‹å®Œå‰é¢æ¢³ç†çš„ 23ç§è®¾è®¡æ¨¡å¼ï¼Œç›¸ä¿¡å¤§å¤šæ•°äººè·Ÿæˆ‘ä¸€æ ·å¤´éƒ½å¤§äº†ï¼Œå³ä¾¿æˆ‘å·²ç»åšäº†ç®€å•çš„åˆ†ç±»ã€‚æˆ‘ä¸€ç›´åœ¨æ€è€ƒå¦‚ä½•æ›´å¥½åœ°ç†è§£å’Œè¿ç”¨è®¾è®¡æ¨¡å¼ï¼Œä»è€Œå†™å‡ºæ›´åŠ ä¼˜é›…çš„ä»£ç ã€‚AIçš„å‡ºç°ï¼ŒçœŸçš„è®©æˆ‘æ„Ÿè§‰éå¸¸å¹¸è¿ï¼ŒAIå¯ä»¥å¾ˆå¥½åœ°ä»ç¬¬ä¸€æ€§åŸç†å’Œæ ¹æœ¬æºå¤´ä¸Šå¯¹è®¾è®¡æ¨¡å¼è¿›è¡Œå±•ç¤ºå’Œé˜è¿°ï¼Œæ‰€ä»¥åœ¨æˆ‘è·ŸAIè¿›è¡Œæ·±å…¥æ¢è®¨ä¹‹åï¼Œæˆ‘å¯¹è®¾è®¡æ¨¡å¼çš„ç†è§£åˆæ›´è¿›ä¸€æ­¥äº†ï¼Œè¿™é‡Œåšä¸€ä¸‹ç®€å•æ€»ç»“ã€‚</p><p>ä»ç¬¬ä¸€æ€§åŸç†å‡ºå‘ï¼Œå½“æˆ‘ä»¬è°ˆè®ºè®¾è®¡æ¨¡å¼æ—¶ï¼Œæˆ‘ä»¬ä¸»è¦åœ¨è°ˆè®ºä¸¤ä»¶äº‹ï¼š</p><ol type="1"><li><strong>ä¸€ä¸ªå…±äº«çš„è¯æ±‡åº“</strong>ï¼šè®¾è®¡æ¨¡å¼æä¾›äº†ä¸€å¥—é«˜å¸¦å®½ã€æ— æ­§ä¹‰çš„ä¸“ä¸šè¯æ±‡ï¼Œå®ƒè®©æˆ‘ä»¬è°ˆè®ºå¤æ‚æŠ½è±¡çš„æ–¹æ¡ˆæ—¶ï¼Œå°±åƒè°ˆè®ºå˜é‡æˆ–å‡½æ•°ä¸€æ ·ç®€å•ã€‚</li><li><strong>ä¸€å¥—ç»éªŒçš„ç»“æ™¶</strong>ï¼šè®¾è®¡æ¨¡å¼å°±æ˜¯æŠŠè¿™äº›è¢«åå¤éªŒè¯ã€è¯æ˜æ˜¯å¥å£®çš„ã€ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆæå–å‡ºæ¥ï¼Œå¹¶ç»™å®ƒä»¬å‘½äº†åã€‚</li></ol><p>æ‰€ä»¥ï¼Œè®¾è®¡æ¨¡å¼<strong>ä¸æ˜¯æœ€ä½³å®è·µçš„æ¸…å•</strong>ï¼Œè€Œæ˜¯<strong>åœ¨ç‰¹å®šä¸Šä¸‹æ–‡(Context)ä¸­ï¼Œé’ˆå¯¹ç‰¹å®šé—®é¢˜ (Problem)çš„ä¸€ç§è§£å†³æ–¹æ¡ˆ(Solution)</strong>ã€‚å®ƒæœ¬è´¨ä¸Šæ˜¯å‰äººç»éªŒçš„å›ºåŒ–ã€‚</p><p>ç†è§£ 23ç§è®¾è®¡æ¨¡å¼çš„æœ€å¥½æ–¹æ³•ï¼Œä¸æ˜¯å»èƒŒè¯µå®ƒä»¬ï¼Œè€Œæ˜¯å»<strong>åˆ†ç±»</strong>å’Œ<strong>æŠ“æ„å›¾</strong>ã€‚ä½ ä¸éœ€è¦è®°ä½23 ç§æ¨¡å¼çš„å®ç°ç»†èŠ‚ï¼Œä½ åªéœ€è¦ç†è§£ 23ç§<strong>é—®é¢˜</strong>ï¼Œä»¥åŠå®ƒä»¬åˆ†åˆ«å±äºå“ªä¸€ç±»<strong>æ„å›¾</strong>ã€‚</p><h4 id="åˆ›å»ºå‹æ¨¡å¼">åˆ›å»ºå‹æ¨¡å¼</h4><blockquote><p>å¦‚ä½•æ‰èƒ½åœ¨<strong>ä¸æš´éœ²åˆ›å»ºç»†èŠ‚</strong>çš„æƒ…å†µä¸‹ï¼Œ<strong>çµæ´»ä¸”å¯æ§åœ°åˆ›å»ºå¯¹è±¡</strong>ï¼Ÿâ€”â€” <strong>è§£è€¦å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹</strong></p></blockquote><ol type="1"><li><strong>Singleton(å•ä¾‹æ¨¡å¼)</strong>ï¼šæˆ‘éœ€è¦ä¿è¯è¿™ä¸ªç±»åœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­ï¼Œ<strong>æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªå®ä¾‹</strong>ï¼ˆæ¯”å¦‚ï¼Œé…ç½®ç®¡ç†å™¨ã€æ—¥å¿—è®°å½•å™¨ï¼‰ã€‚</li><li><strong>Factory Method(å·¥å‚æ–¹æ³•)</strong>ï¼šæˆ‘æœ‰ä¸€ä¸ªåŸºç±»ï¼ˆæˆ–æ¥å£ï¼‰ï¼Œä½†æˆ‘<strong>ä¸æƒ³è®©å®¢æˆ·ç«¯</strong>ï¼ˆè°ƒç”¨æ–¹ï¼‰<strong>ç›´æ¥</strong><code>new</code> å®ƒçš„æŸä¸ªå…·ä½“å­ç±»ã€‚æˆ‘æƒ³æŠŠè¿™ä¸ª <code>new</code>çš„å†³å®šæƒ<strong>æ¨è¿Ÿåˆ°å­ç±»</strong>å»åšã€‚</li><li><strong>Abstract Factory(æŠ½è±¡å·¥å‚)</strong>ï¼šæˆ‘éœ€è¦åˆ›å»º<strong>ä¸€ç³»åˆ—ç›¸äº’å…³è”çš„å¯¹è±¡</strong>ï¼ˆä¸€ä¸ªäº§å“æ—ï¼Œæ¯”å¦‚<code>UI</code> çš„æ·±è‰²ä¸»é¢˜éœ€è¦<code>DarkButton</code>ã€<code>DarkCheckbox</code>ï¼‰ï¼Œå¹¶ä¸”æˆ‘æƒ³<strong>ä¸€é”®åˆ‡æ¢</strong>æ•´ä¸ªäº§å“æ—ï¼ˆæ¯”å¦‚ä¸€é”®åˆ‡æ¢åˆ°æµ…è‰²ä¸»é¢˜ï¼‰ã€‚</li><li><strong>Builder(å»ºé€ è€…æ¨¡å¼)</strong>ï¼šæˆ‘è¦åˆ›å»ºçš„è¿™ä¸ªå¯¹è±¡<strong>å¤ªå¤æ‚äº†</strong>ï¼Œå®ƒçš„æ„é€ å‡½æ•°æœ‰<strong>ä¸€å¤§å †å‚æ•°</strong>ï¼Œå…¶ä¸­å¾ˆå¤šè¿˜æ˜¯å¯é€‰çš„ã€‚æˆ‘ä¸æƒ³å†™ä¸€å †é‡è½½çš„æ„é€ å‡½æ•°ï¼Œä¹Ÿä¸æƒ³è®©å¯¹è±¡åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­å¤„äºä¸å®Œæ•´çŠ¶æ€ã€‚ï¼ˆåœ¨Go æˆ– Rust ä¸­å¯èƒ½æ›´ç†Ÿæ‚‰çš„æ˜¯ <code>Option</code> æ¨¡å¼ï¼Œè¿™æ˜¯ Builderçš„ä¸€ç§å˜ä½“ï¼‰</li><li><strong>Prototype(åŸå‹æ¨¡å¼)</strong>ï¼šåˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡çš„<strong>æˆæœ¬éå¸¸é«˜</strong>ï¼ˆæ¯”å¦‚æ¶‰åŠI/Oæˆ–å¤æ‚çš„è®¡ç®—ï¼‰ã€‚å¦‚æœæˆ‘æœ‰ä¸€ä¸ªå·²æœ‰çš„å¯¹è±¡ï¼Œé€šè¿‡<strong>å¤åˆ¶ï¼ˆcloneï¼‰</strong>å®ƒæ¥åˆ›å»ºæ–°å¯¹è±¡ä¼šå¿«å¾—å¤šã€‚</li></ol><h4 id="ç»“æ„å‹æ¨¡å¼">ç»“æ„å‹æ¨¡å¼</h4><blockquote><p>å¦‚ä½•æ‰èƒ½<strong>çµæ´»åœ°ç»„åˆ</strong>ç±»ä¸å¯¹è±¡ï¼Œå½¢æˆ<strong>æ›´å¤§çš„ã€åŠŸèƒ½æ›´å¼ºçš„ç»“æ„</strong>ï¼Ÿâ€”â€”<strong>è§£è€¦å¯¹è±¡çš„ç»„åˆæ–¹å¼</strong></p></blockquote><ol type="1"><li><strong>Adapter(é€‚é…å™¨æ¨¡å¼)</strong>ï¼šæˆ‘æœ‰ä¸€ä¸ªç°æˆçš„ç±»ï¼ˆAï¼‰ï¼Œå®ƒçš„åŠŸèƒ½å¾ˆæ£’ï¼Œä½†æˆ‘<strong>æ— æ³•ç›´æ¥ä½¿ç”¨</strong>ï¼Œå› ä¸ºå®¢æˆ·ä»£ç è¦æ±‚çš„æ˜¯å¦ä¸€ä¸ª<strong>ä¸å…¼å®¹çš„æ¥å£</strong>ï¼ˆBï¼‰ã€‚æˆ‘éœ€è¦ä¸€ä¸ª"è½¬æ¢æ’å¤´"ã€‚</li><li><strong>Decorator(è£…é¥°å™¨æ¨¡å¼)</strong>ï¼šæˆ‘æƒ³åœ¨<strong>ä¸ä¿®æ”¹</strong>ä¸€ä¸ªç±»ï¼ˆæˆ–å¯¹è±¡ï¼‰çš„ä»£ç çš„å‰æä¸‹ï¼Œ<strong>åŠ¨æ€åœ°</strong>ç»™å®ƒ<strong>æ·»åŠ </strong>æ–°çš„åŠŸèƒ½ï¼ˆèŒè´£ï¼‰ã€‚è€Œä¸”æˆ‘æƒ³å¯ä»¥<strong>å±‚å±‚åµŒå¥—</strong>åœ°æ·»åŠ ï¼ˆæ¯”å¦‚<code>Buffered</code> -&gt; <code>Gzipped</code> -&gt;<code>FileInputStream</code>ï¼‰ã€‚</li><li><strong>Proxy(ä»£ç†æ¨¡å¼)</strong>ï¼šæˆ‘ä¸æƒ³è®©å®¢æˆ·ç«¯<strong>ç›´æ¥</strong>è®¿é—®æŸä¸ªå¯¹è±¡ã€‚æˆ‘æƒ³åœ¨ä¸­é—´åŠ ä¸€å±‚ä»£ç†ï¼Œæ¥<strong>æ§åˆ¶</strong>å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ï¼ˆæ¯”å¦‚ï¼Œæƒé™æ£€æŸ¥ã€æ‡’åŠ è½½ã€æ—¥å¿—è®°å½•ã€RPCï¼‰ã€‚</li><li><strong>Facade(å¤–è§‚æ¨¡å¼)</strong>ï¼šæˆ‘è¿™é‡Œæœ‰ä¸€ä¸ª<strong>éå¸¸å¤æ‚çš„å­ç³»ç»Ÿ</strong>ï¼Œå†…éƒ¨æœ‰ä¸€å †ç±»å’Œå¤æ‚çš„è°ƒç”¨å…³ç³»ã€‚æˆ‘åªæƒ³ç»™å®¢æˆ·ç«¯æä¾›ä¸€ä¸ª<strong>æå…¶ç®€å•çš„ã€ç»Ÿä¸€çš„è®¿é—®å…¥å£</strong>ã€‚</li><li><strong>Bridge(æ¡¥æ¥æ¨¡å¼)</strong>ï¼šæˆ‘æœ‰<strong>ä¸¤ä¸ªç‹¬ç«‹å˜åŒ–çš„ç»´åº¦</strong>ï¼ˆæ¯”å¦‚å½¢çŠ¶å’Œé¢œè‰²ï¼‰ã€‚æˆ‘ä¸æƒ³ç”¨ç»§æ‰¿ï¼ˆæ¯”å¦‚<code>RedCircle</code>, <code>BlueCircle</code>, <code>RedSquare</code>â€¦å¯¼è‡´ç±»çš„çˆ†ç‚¸ï¼‰ï¼Œæˆ‘æƒ³æŠŠè¿™ä¸¤ä¸ªç»´åº¦<strong>åˆ†å¼€</strong>ï¼Œè®©å®ƒä»¬<strong>å„è‡ªç‹¬ç«‹æ¼”åŒ–</strong>ã€‚</li><li><strong>Composite(ç»„åˆæ¨¡å¼)</strong>ï¼šæˆ‘éœ€è¦å¤„ç†ä¸€ä¸ª<strong>æ ‘å½¢ç»“æ„</strong>ï¼ˆæ¯”å¦‚æ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ï¼‰ã€‚æˆ‘å¸Œæœ›èƒ½å¤Ÿç”¨<strong>å®Œå…¨ç›¸åŒçš„æ–¹å¼</strong>ï¼ˆåŒä¸€ä¸ªæ¥å£ï¼‰æ¥å¯¹å¾…å•ä¸ªå¯¹è±¡ï¼ˆå¶èŠ‚ç‚¹ï¼‰å’Œå¯¹è±¡ç»„åˆï¼ˆåˆ†æ”¯èŠ‚ç‚¹ï¼‰ã€‚</li><li><strong>Flyweight(äº«å…ƒæ¨¡å¼)</strong>ï¼šæˆ‘éœ€è¦åˆ›å»º<strong>æµ·é‡</strong>çš„å°å¯¹è±¡ï¼Œå®ƒä»¬ç»å¤§å¤šæ•°çš„<strong>å†…éƒ¨çŠ¶æ€</strong>éƒ½æ˜¯ç›¸åŒçš„ã€‚ä¸ºäº†<strong>èŠ‚çœå†…å­˜</strong>ï¼Œæˆ‘æƒ³æŠŠè¿™äº›ç›¸åŒçš„çŠ¶æ€<strong>å…±äº«</strong>ï¼ˆå¤ç”¨ï¼‰èµ·æ¥ã€‚</li></ol><h4 id="è¡Œä¸ºå‹æ¨¡å¼">è¡Œä¸ºå‹æ¨¡å¼</h4><blockquote><p>å¦‚ä½•æ‰èƒ½é«˜æ•ˆåœ°<strong>åˆ†é…èŒè´£</strong>ï¼Œå¹¶ç®¡ç†å¯¹è±¡ä¹‹é—´<strong>å¤æ‚çš„é€šä¿¡</strong>ï¼Ÿâ€”â€” <strong>è§£è€¦å¯¹è±¡é—´çš„é€šä¿¡ä¸èŒè´£</strong></p></blockquote><ol type="1"><li><strong>Strategy (ç­–ç•¥æ¨¡å¼)</strong>ï¼šæˆ‘æœ‰ä¸€å †<code>if...else if...else</code> æˆ–è€…ä¸€ä¸ªå·¨å¤§çš„<code>switch</code>ï¼Œå®ƒä»¬åœ¨æ ¹æ®ä¸åŒæ¡ä»¶<strong>é€‰æ‹©ä¸åŒçš„ç®—æ³•</strong>æˆ–è¡Œä¸ºã€‚æˆ‘æƒ³æŠŠè¿™äº›<strong>ç®—æ³•</strong>ï¼ˆç­–ç•¥ï¼‰<strong>ç‹¬ç«‹</strong>å‡ºæ¥ï¼Œè®©å®ƒä»¬å¯ä»¥<strong>äº’ç›¸æ›¿æ¢</strong>ã€‚</li><li><strong>Observer(è§‚å¯Ÿè€…æ¨¡å¼)</strong>ï¼šæˆ‘æœ‰ä¸€ä¸ª"ä¸»é¢˜"å¯¹è±¡ï¼Œå½“å®ƒçš„çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œéœ€è¦<strong>è‡ªåŠ¨é€šçŸ¥</strong>å…¶ä»–<strong>æ‰€æœ‰</strong>ä¾èµ–å®ƒçš„"è§‚å¯Ÿè€…"å¯¹è±¡ï¼Œä½†æˆ‘åˆä¸æƒ³è®©"ä¸»é¢˜"<strong>ç›´æ¥</strong>çŸ¥é“"è§‚å¯Ÿè€…"çš„å…·ä½“å®ç°ï¼ˆå®ç°å¹¿æ’­å¼è§£è€¦ï¼‰ã€‚</li><li><strong>Command(å‘½ä»¤æ¨¡å¼)</strong>ï¼šæˆ‘æƒ³æŠŠä¸€ä¸ª<strong>æ“ä½œï¼ˆè¯·æ±‚ï¼‰å°è£…æˆä¸€ä¸ªå¯¹è±¡</strong>ã€‚è¿™æ ·æˆ‘å°±å¯ä»¥æŠŠè¿™ä¸ª"å‘½ä»¤"<strong>ä¼ é€’</strong>ã€<strong>æ’é˜Ÿ</strong>ã€<strong>è®°å½•æ—¥å¿—</strong>ï¼Œç”šè‡³å®ç°<strong>æ’¤é”€ï¼ˆUndoï¼‰</strong>ã€‚</li><li><strong>Template Method(æ¨¡æ¿æ–¹æ³•)</strong>ï¼šæˆ‘æœ‰ä¸€ä¸ªç®—æ³•ï¼Œå®ƒçš„<strong>éª¨æ¶ï¼ˆæ­¥éª¤ï¼‰æ˜¯å›ºå®šä¸å˜çš„</strong>ï¼Œä½†å…¶ä¸­<strong>ä¸€ä¸¤ä¸ªæ­¥éª¤</strong>çš„å…·ä½“å®ç°æ˜¯<strong>æ˜“å˜</strong>çš„ã€‚æˆ‘æƒ³åœ¨åŸºç±»ä¸­å®šä¹‰å¥½"éª¨æ¶"ï¼Œè®©å­ç±»å»å®ç°é‚£äº›"æ˜“å˜"çš„æ­¥éª¤ã€‚</li><li><strong>Iterator(è¿­ä»£å™¨æ¨¡å¼)</strong>ï¼šæˆ‘æœ‰ä¸€ä¸ª<strong>èšåˆå¯¹è±¡</strong>ï¼ˆæ¯”å¦‚ List,Map,Setï¼‰ï¼Œæˆ‘æƒ³è®©å®¢æˆ·ç«¯èƒ½å¤Ÿ<strong>éå†</strong>å®ƒï¼Œä½†åˆ<strong>ä¸æƒ³æš´éœ²</strong>å®ƒçš„<strong>å†…éƒ¨å®ç°ç»†èŠ‚</strong>ã€‚</li><li><strong>Mediator(ä¸­ä»‹è€…æ¨¡å¼)</strong>ï¼šæˆ‘æœ‰ä¸€å †å¯¹è±¡ï¼Œå®ƒä»¬ä¹‹é—´<strong>äº’ç›¸é€šä¿¡</strong>ï¼Œå½¢æˆäº†ä¸€ä¸ª<strong>å¤æ‚çš„ç½‘çŠ¶ç»“æ„</strong>ï¼ˆM-Nå…³ç³»ï¼‰ï¼Œå¯¼è‡´é«˜è€¦åˆã€‚æˆ‘æƒ³å¼•å…¥ä¸€ä¸ª"ä¸­ä»‹"ï¼Œè®©æ‰€æœ‰å¯¹è±¡åªå’Œ"ä¸­ä»‹"é€šä¿¡ï¼ˆM-1-Nï¼‰ï¼Œ<strong>ç®€åŒ–</strong>è¿™ä¸ªé€šä¿¡ç½‘ã€‚</li><li><strong>State(çŠ¶æ€æ¨¡å¼)</strong>ï¼šä¸€ä¸ªå¯¹è±¡çš„<strong>è¡Œä¸º</strong>å®Œå…¨å–å†³äºå®ƒçš„<strong>å†…éƒ¨çŠ¶æ€</strong>ã€‚æˆ‘ç°åœ¨çš„ä»£ç é‡Œæœ‰<strong>ä¸€å †<code>switch</code></strong>åœ¨æ£€æŸ¥"å½“å‰çŠ¶æ€"æ¥å†³å®šä¸‹ä¸€æ­¥åšä»€ä¹ˆã€‚æˆ‘æƒ³æŠŠæ¯ç§"çŠ¶æ€"ä¸‹çš„è¡Œä¸ºå°è£…æˆ<strong>ç‹¬ç«‹</strong>çš„ç±»ã€‚</li><li><strong>Chain of Responsibility(è´£ä»»é“¾æ¨¡å¼)</strong>ï¼šä¸€ä¸ªè¯·æ±‚éœ€è¦è¢«<strong>å¤šä¸ªå¯¹è±¡</strong>ä¸­çš„<strong>æŸä¸€ä¸ª</strong>å¤„ç†ã€‚ä½†æˆ‘ä¸ç¡®å®šæ˜¯å“ªä¸€ä¸ªï¼Œæˆ–è€…æˆ‘æƒ³è®©å®ƒä»¬<strong>ä¾æ¬¡å°è¯•</strong>å¤„ç†ï¼ˆæ¯”å¦‚<code>HTTP</code>ä¸­é—´ä»¶ï¼‰ã€‚æˆ‘æƒ³æŠŠè¿™äº›å¯¹è±¡<strong>ä¸²æˆä¸€æ¡é“¾</strong>ï¼Œè®©è¯·æ±‚æ²¿ç€é“¾ä¼ é€’ä¸‹å»ã€‚</li><li><strong>Visitor(è®¿é—®è€…æ¨¡å¼)</strong>ï¼šæˆ‘æœ‰ä¸€ç»„<strong>ç¨³å®šçš„</strong>å¯¹è±¡ç»“æ„ï¼ˆæ¯”å¦‚ä¸€ä¸ªè¯­æ³•æ ‘ï¼‰ï¼Œä½†æˆ‘æƒ³ä¸ºå®ƒä»¬æ·»åŠ <strong>å„ç§å„æ ·çš„æ–°æ“ä½œ</strong>ï¼ˆæ¯”å¦‚ç±»å‹æ£€æŸ¥ã€ä»£ç ç”Ÿæˆï¼‰ã€‚æˆ‘ä¸æƒ³æ¯åŠ ä¸€ä¸ªæ“ä½œå°±å»<strong>ä¿®æ”¹</strong>é‚£äº›ç¨³å®šçš„å¯¹è±¡ç±»ã€‚</li><li><strong>Memento(å¤‡å¿˜å½•æ¨¡å¼)</strong>ï¼šæˆ‘éœ€è¦<strong>ä¿å­˜</strong>ä¸€ä¸ªå¯¹è±¡çš„<strong>å†…éƒ¨çŠ¶æ€</strong>ï¼ˆåˆ›å»ºå¿«ç…§ï¼‰ï¼Œä»¥ä¾¿åœ¨æœªæ¥æŸä¸ªæ—¶åˆ»èƒ½<strong>æ¢å¤</strong>åˆ°è¿™ä¸ªçŠ¶æ€ï¼ˆæ¯”å¦‚å®ç°æ’¤é”€æˆ–å­˜æ¡£ï¼‰ï¼ŒåŒæ—¶æˆ‘åˆä¸å¸Œæœ›<strong>æš´éœ²</strong>è¿™ä¸ªå¯¹è±¡å†…éƒ¨çš„å®ç°ç»†èŠ‚ã€‚</li><li><strong>Interpreter(è§£é‡Šå™¨æ¨¡å¼)</strong>ï¼šæˆ‘éœ€è¦ä¸ºä¸€ä¸ª<strong>ç®€å•çš„è¯­è¨€</strong>ï¼ˆæ¯”å¦‚æ­£åˆ™è¡¨è¾¾å¼ã€SQLæŸ¥è¯¢ï¼‰æ„å»ºä¸€ä¸ª<strong>è§£é‡Šå™¨</strong>ã€‚ï¼ˆè¿™æ˜¯æœ€ä¸å¸¸ç”¨çš„æ¨¡å¼ä¹‹ä¸€ï¼Œé€šå¸¸æœ‰ç°æˆçš„å·¥å…·ï¼‰</li></ol><h3 id="ç”¨å¥½è®¾è®¡æ¨¡å¼">ç”¨å¥½è®¾è®¡æ¨¡å¼</h3><p>æˆ‘è§‰å¾—æƒ³è¦ç”¨å¥½è®¾è®¡æ¨¡å¼ï¼Œåªæœ‰ä¸€ä¸ªé€”å¾„ï¼Œå°±æ˜¯å¤šç”¨ï¼Œç”šè‡³æ˜¯åˆ»æ„å¤šç”¨ï¼Œä¹Ÿå°±æ˜¯"æ‰‹é‡Œæ‹¿ç€é”¤å­ï¼Œçœ‹ä»€ä¹ˆéƒ½æ˜¯é’‰å­"é‚£æ ·çš„å¤šç”¨ã€‚ç”¨å¯¹äº†ï¼Œä½ æ‰èƒ½çœŸå®ä½“éªŒåˆ°è®¾è®¡æ¨¡å¼ç»™ä½ å¸¦æ¥çš„æ”¶ç›Šï¼Œä½ æ‰ä¼šæ›´ç†è§£å®ƒä»¬çš„ç”±æ¥ï¼Œä½ ä¹Ÿæ‰ä¼šæ›´æ„¿æ„åœ¨è¿™æ–¹é¢èŠ±æ›´å¤šçš„æ€è€ƒå’Œå®è·µã€‚ç”¨é”™äº†ï¼Œå‘ç°è¿‡åº¦è®¾è®¡äº†ï¼Œå‘ç°ä»£ç å˜å¾—æ›´éš¾ç†è§£å’Œç»´æŠ¤äº†ï¼Œä½ æ‰èƒ½çœŸæ­£æ„Ÿå—åˆ°ç†è®ºä¸å®è·µçš„å·®è·ï¼Œä½ æ‰èƒ½ä»å¦å¤–ä¸€ä¸ªè§’åº¦å»æ›´å…¨é¢ç†è§£ä½ æ‰€è¿ç”¨çš„è®¾è®¡æ¨¡å¼ã€‚å½“ç„¶ï¼Œè¿™ç§åˆ»æ„å¤šç”¨ï¼Œæœ€å¥½æ›´å¤šæ˜¯åœ¨è‡ªå·±çš„ä¸ªäººé¡¹ç›®ä¸­ï¼Œè€Œä¸æ˜¯åœ¨å·¥ä½œé¡¹ç›®ä¸Šï¼Œå› ä¸ºåè€…çš„çŠ¯é”™æˆæœ¬è¦æ›´é«˜ï¼Œé£é™©ä¹Ÿç›¸åº”æ›´å¤§ã€‚å½“ç„¶ï¼Œå·¥ä½œä¸Šçš„ä½¿ç”¨ï¼Œæ€»æœ‰ç¬¬ä¸€æ¬¡ï¼Œæ‰€ä»¥ä¸å¦¨å¤§èƒ†ä¸€ç‚¹ï¼Œåªè¦ä½ æ˜¯åœ¨æ€è€ƒï¼Œåªè¦ä½ æ˜¯åœ¨åŠªåŠ›åšå¥½äº‹æƒ…ï¼Œæˆ‘è§‰å¾—ï¼Œä¸€åˆ‡éƒ½æ˜¯ä¸äºçš„ã€‚</p><p>æˆ‘å¾ˆåº†å¹¸åœ¨æˆ‘åˆšå…¥èŒä¸¤ä¸‰ä¸ªæœˆçš„æ—¶å€™ï¼Œå°±æ¥æ‰‹äº†é‡æ„ä¸€å¨å±å±±ä»£ç çš„é‡ä»»ï¼Œå¹¶ä¸”åœ¨æˆ‘ä½¿ç”¨æ¨¡æ¿æ–¹æ³•è®¾è®¡æ¨¡å¼å¯¹å…¶è¿›è¡Œå½»åº•é‡æ„åï¼Œä»£ç å˜å¾—æå…¶ä¼˜é›…å¹¶åœ¨åé¢çš„ä¸¤å¹´å¤šä¸­æŒç»­ä¸ºæˆ‘å¸¦æ¥æ”¶ç›Šã€‚è¿™äº›ä½“éªŒå’Œæ­£åé¦ˆï¼Œè®©æˆ‘å¯¹è®¾è®¡æ¨¡å¼ä¸€ç›´æœ‰ä¸€å±‚æ»¤é•œï¼Œä½¿å¾—æˆ‘è¿™ä¸‰å¹´æ¥ä¸€ç›´æ„¿æ„ä¸»åŠ¨å»æ€è€ƒå¦‚ä½•å°†ä»£ç å†™å¾—æ›´åŠ ä¼˜é›…ã€‚</p><p>è¿™ä¸ªé¡¹ç›®æ˜¯è¿™æ ·çš„ï¼Œæˆ‘ä»¬å¯¹æ¥äº† 20å¤šä¸ªå¹¿å‘Šå•†ï¼Œæ¯ä¸ªå¹¿å‘Šå•†ä¸‹é¢æœ‰å¤šä¸ªä¸åŒå…¬å¸ä¸»ä½“ä¸‹çš„å¤šä¸ªä¸åŒ APPï¼Œå³å­˜åœ¨ 3ä¸ªç»´åº¦ï¼Œæˆ‘ä»¬è¦å»è¯·æ±‚å¹¿å‘Šå•†çš„ API å»ç»Ÿä¸€æ±‡æ€»æ‰€æœ‰ APPçš„å¹¿å‘Šæ”¶å…¥æ•°æ®ã€‚ä¹‹å‰çš„äººå¼€å‘çš„æ—¶å€™å°±æ˜¯çº¯å¤åˆ¶ç²˜è´´ï¼Œé‡å¤ä»£ç ç›´æ¥çˆ†äº†ï¼Œè€Œä¸”ç›¸åŒæ­¥éª¤è¿˜å­˜åœ¨éå¸¸å¤šä¸ä¸€è‡´çš„é€»è¾‘ï¼Œè¿™ç»™ä»£ç é˜…è¯»ã€é—®é¢˜æ’æŸ¥ã€æ–°å¢å¹¿å‘Šå•†/å…¬å¸ä¸»ä½“/APPã€ä¸šåŠ¡æ•°æ®è¯‰æ±‚ç­‰æ–¹é¢éƒ½å¸¦æ¥äº†ç©¶ææŠ˜ç£¨ã€‚æˆ‘å‘ç°å…¶å®æ‰€æœ‰å¹¿å‘Šæ•°æ®è·å–éƒ½éµå¾ªè¿™æ ·ä¸€ä¸ªæ­¥éª¤ï¼š<u>è¯·æ±‚æ•°æ®ã€æ ¼å¼ç»Ÿä¸€ã€åˆå¹¶æ•°æ®ã€å¼‚å¸¸å¤„ç†ã€è½¬å­˜æ•°æ®</u>ã€‚æˆ‘å‘ç°åªæœ‰è¯·æ±‚æ•°æ®å’Œæ ¼å¼ç»Ÿä¸€è¿™ä¸¤æ­¥æ˜¯è·Ÿå¹¿å‘Šå•†APIå¼ºç›¸å…³ä¸”å¿…é¡»å•ç‹¬å®šåˆ¶å¼€å‘çš„ï¼Œå…¶ä»–éƒ½æ˜¯ä¸€æ ·çš„é€»è¾‘ã€‚æ‰€ä»¥æˆ‘å°±é‡‡ç”¨äº†<strong>æ¨¡æ¿æ–¹æ³•è®¾è®¡æ¨¡å¼</strong>ï¼Œå¯¹è¿™ä¸ªæµç¨‹è¿›è¡Œäº†æŠ½è±¡å’Œé‡æ„ï¼Œå¹¶ä¸”ç”±äºéª¨æ¶éå¸¸å›ºå®šï¼Œæˆ‘è¿˜é¡ºå¸¦å¼€å‘äº†ä»£ç ç”ŸæˆCLIå·¥å…·ï¼Œè¿›ä¸€æ­¥æé«˜å¼€å‘æ•ˆç‡ã€‚å°±è¿™æ ·ç®€å•å¥—ç”¨äº†ä¸€ä¸ªè®¾è®¡æ¨¡å¼ï¼Œæ•´ä¸ªä»£ç çš„é£æ ¼å’Œç®€æ´åº¦ï¼Œç„•ç„¶ä¸€æ–°ï¼Œåˆç”±äºæ¶æ„çš„ç®€æ´ç»Ÿä¸€ï¼Œä½¿å¾—åç»­çš„æ•°æ®ä¿®å¤ã€é—®é¢˜æ’æŸ¥ã€æ–°å¢éœ€æ±‚ç­‰æ“ä½œéƒ½éå¸¸ç®€å•å’Œé«˜æ•ˆé«˜è´¨é‡ã€‚</p><p>åé¢ä¾‹å­ä¹Ÿæœ‰ï¼Œæˆ‘ä»¬ç»„å†…å…¶ä»–åŒå­¦åœ¨é‡æ„åŒ¹é…æœçš„æ—¶å€™ï¼Œç”±äºå¯¹æ¥å£å®šä¹‰ç†è§£çš„ä¸è¶³ï¼ŒåŒæ—¶å¯¹çŠ¶æ€æ¨¡å¼ã€ç­–ç•¥æ¨¡å¼çš„ç†è§£ä¸è¶³ï¼Œä½†åˆå¼ºè¡Œå¥—ç”¨ï¼ŒåŒæ—¶åˆæœ‰å¾ˆå¤šå…¶ä»–ä¸å¿…è¦çš„æŠ½è±¡æ“ä½œï¼Œæˆ‘ç§°ä¹‹ä¸ºç‚«æŠ€ã€‚è¿™ä¸€é¡¿æ“ä½œå¯¼è‡´äº†æˆ‘ä»¬çš„æ–°åŒ¹é…æœè¿‡åº¦æŠ½è±¡ã€æ¥å£å®šä¹‰ä¸åˆç†ã€æ¶æ„æ··ä¹±ï¼Œè¿›è€Œå¯¼è‡´äº†ä»£ç å¯è¯»æ€§è¾ƒå·®ã€æ–°äººæ¥æ‰‹éš¾åº¦é«˜ç­‰ä¸€ç³»åˆ—é—®é¢˜ã€‚ä½†æ˜¯å¦ç™½è¯´ï¼Œè¿™ä¸ªå¤±è´¥çš„ä¾‹å­ç»™æˆ‘å¸¦æ¥çš„æ”¶è·å’Œæ€è€ƒï¼Œå¹¶ä¸æ¯”ä¸Šé¢æåˆ°çš„æˆåŠŸçš„ä¾‹å­å°‘ã€‚</p><p>"æ‰‹é‡Œæ‹¿ç€é”¤å­ï¼Œçœ‹ä»€ä¹ˆéƒ½æ˜¯é’‰å­"æ˜¯æˆ‘ä»¬åˆšæ¥è§¦è®¾è®¡æ¨¡å¼æ—¶çš„é€šç—…ï¼Œè¿™å¾€å¾€ä¼šå¯¼è‡´è¿‡åº¦è®¾è®¡ã€‚æˆ‘ä¸ªäººè§‰å¾—æƒ³è¦å‡å°‘"ç¡¬å¥—"è®¾è®¡æ¨¡å¼çš„æ ¸å¿ƒåŸåˆ™æ˜¯ï¼š<strong><u>æ°¸è¿œè®©é—®é¢˜é©±åŠ¨æ¨¡å¼ï¼Œè€Œä¸æ˜¯åè¿‡æ¥</u></strong>ã€‚</p><ol type="1"><li><strong>KISS (Keep It Simple, Stupid) ä¼˜å…ˆï¼š</strong>æ°¸è¿œå…ˆå†™å‡ºæœ€ç®€å•ã€æœ€ç›´ç™½çš„ä»£ç ã€‚ä¸è¦ä¸€å¼€å§‹å°±æ€è€ƒæˆ‘è¯¥ç”¨å“ªä¸ªæ¨¡å¼ã€‚</li><li><strong>YAGNI (You Ain't Gonna Need It) åŸåˆ™ï¼š</strong>ä¸è¦ä¸ºäº†æœªæ¥å¯èƒ½çš„æ‰©å±•æ€§è€Œå»åº”ç”¨ä¸€ä¸ªå¤æ‚çš„æ¨¡å¼ã€‚å¦‚æœç°åœ¨ç®€å•çš„<code>if...else</code>å°±èƒ½è§£å†³é—®é¢˜ï¼Œå¹¶ä¸”æ²¡æœ‰æ˜ç¡®çš„è¿¹è±¡è¡¨æ˜å®ƒé©¬ä¸Šä¼šå˜å¾—å¤æ‚ï¼Œé‚£å°±ç”¨<code>if...else</code>ã€‚</li><li><strong>æŠŠæ¨¡å¼å½“ä½œé‡æ„çš„æ‰‹æ®µï¼š</strong> è¿™æ˜¯åº”ç”¨æ¨¡å¼çš„æœ€ä½³æ—¶æœºã€‚<ul><li>ä½ çš„ç®€å•ä»£ç è·‘èµ·æ¥äº†ã€‚</li><li>éšç€éœ€æ±‚ï¼ˆå˜åŒ–ï¼‰çš„åˆ°æ¥ï¼Œä½ çš„ç®€å•ä»£ç å¼€å§‹å˜å¾—è…åŒ–ã€‚</li><li><strong>æ­¤æ—¶</strong>ï¼Œä»£ç çš„åå‘³é“å·²ç»æ¸…æ™°åœ°æš´éœ²äº†é—®é¢˜ã€‚</li><li><strong>ç°åœ¨</strong>ï¼Œä½ æ‰åº”è¯¥å¼•å…¥è®¾è®¡æ¨¡å¼ï¼Œä½œä¸ºä¸€ç§<strong>é‡æ„</strong>æ‰‹æ®µï¼Œå»è§£å†³è¿™ä¸ªå·²ç»<strong>å®é™…å‘ç”Ÿ</strong>çš„ã€è€Œä¸æ˜¯è‡†æƒ³å‡ºæ¥çš„è®¾è®¡é—®é¢˜ã€‚</li></ul></li><li><strong>è¯„ä¼°å¼•å…¥çš„æˆæœ¬ï¼š</strong> æ²¡æœ‰ä»»ä½•æ¨¡å¼æ˜¯é“¶å¼¹ã€‚<ul><li><strong>Factory</strong> å¸¦æ¥äº†çµæ´»æ€§ï¼Œä½†ä¹Ÿå¢åŠ äº†ç±»çš„æ•°é‡ã€‚</li><li><strong>Observer</strong>å®ç°äº†å®Œç¾çš„è§£è€¦ï¼Œä½†ä¹Ÿè®©ç¨‹åºçš„æ§åˆ¶æµå˜å¾—éš¾ä»¥è¿½è¸ªï¼ˆå›è°ƒåœ°ç‹±ï¼‰ã€‚</li><li><strong>Singleton</strong>ç®€åŒ–äº†è®¿é—®ï¼Œä½†ä¹Ÿå¼•å…¥äº†å…¨å±€çŠ¶æ€ï¼Œä½¿æµ‹è¯•å˜å¾—æå…¶å›°éš¾ã€‚</li></ul></li></ol><p>å½“ä½ å†³å®šè¦å¥—ç”¨ä¸€ä¸ªæ¨¡å¼æ—¶ï¼Œå¿…é¡»æ˜ç¡®åœ°é—®è‡ªå·±ï¼š<strong>ä¸ºäº†è§£å†³æˆ‘çœ¼å‰çš„è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘æ˜¯å¦æ„¿æ„æ”¯ä»˜è¿™ä¸ªæ¨¡å¼å¸¦æ¥çš„é¢å¤–å¤æ‚æ€§çš„ä»£ä»·ï¼Ÿ</strong></p><h2 id="æ¶æ„æ¨¡å¼">æ¶æ„æ¨¡å¼</h2><h3 id="ä»€ä¹ˆæ˜¯æ¶æ„">ä»€ä¹ˆæ˜¯æ¶æ„</h3><p>æ¶æ„è¿™ä¸ªè¯ï¼Œå¾ˆå¤šäººéƒ½åœ¨è°ˆï¼Œé‚£åˆ°åº•ä»€ä¹ˆæ˜¯æ¶æ„å‘¢ï¼Ÿæ¶æ„å¸ˆåˆæ˜¯åšå•¥çš„å‘¢ï¼Ÿ<ahref="https://book.douban.com/subject/37055698/">ã€ŠP9å·¥ä½œæ³•ï¼šå¤¯å®æŠ€æœ¯ç¡¬å®åŠ›ã€æ¶æ„åŠ›å’Œé¢†å¯¼åŠ›ã€‹</a>ä¸€ä¹¦æ€»ç»“å¾—éå¸¸å¥½ã€‚</p><p>ä¹¦ä¸­è¯´ï¼Œæ¶æ„å¸ˆå°±æ˜¯<u>è¿ç”¨æŠ€æœ¯æ¶æ„çš„æ€ç»´æ¡†æ¶æ·±å…¥åˆ†æä¸šåŠ¡éœ€æ±‚ï¼Œè¯†åˆ«å…³é”®é—®é¢˜ï¼Œå¹¶é€šè¿‡æŒç»­çš„æ¼”è¿›å’Œè¿­ä»£æ¥æå‡ç³»ç»Ÿèƒ½åŠ›ï¼Œä»¥æ”¯æŒä¸šåŠ¡å®ç°å•†ä¸šæˆåŠŸ</u>ã€‚å¯ä»¥ç”¨ä¸¤ç»„è¯æ¥è¡¨è¿°æ¶æ„çš„æ¦‚å¿µï¼šæ¨¡å—ä¸å…³ç³»ã€è¿‡ç¨‹ä¸ç»“æœã€‚</p><ul><li><strong>æ¨¡å—ä¸å…³ç³»</strong>ï¼šè½¯ä»¶æ¶æ„æ˜¯ç”±å“ªäº›æ¨¡å—ç»„æˆï¼Œè¿™äº›æ¨¡å—ç”±å“ªäº›é¢†åŸŸæ¨¡å‹ç»„æˆï¼Œæ¯ä¸ªæ¨¡å—çš„æƒè´£è¾¹ç•Œæ˜¯ä»€ä¹ˆï¼Œä»¥åŠæ¨¡å—é—´å¦‚ä½•åä½œã€‚</li><li><strong>è¿‡ç¨‹ä¸ç»“æœ</strong>ï¼šè½¯ä»¶æ¶æ„æ˜¯ä¸€ä¸ªåŠ¨è¯ï¼Œä»£è¡¨ä¸€ç³»åˆ—å†³ç­–è¿‡ç¨‹ã€‚è¿™äº›å†³ç­–ä¸»è¦ä»å…¨å±€å’Œæœªæ¥è§†è§’å‡ºå‘ï¼Œå¯»æ‰¾è§£å†³å®é™…é—®é¢˜çš„æœ€ä½³æ¶æ„ã€‚è¿™å°±æ˜¯â€œæ¶æ„å³è¿‡ç¨‹â€çš„å«ä¹‰ã€‚åŒæ—¶ï¼Œè½¯ä»¶æ¶æ„ä¹Ÿæ˜¯ä¸€ä¸ªåè¯ï¼Œæ˜¯æŠ€æœ¯è§£å†³å®é™…é—®é¢˜ã€æ”¯æ’‘ä¸šåŠ¡å‘å±•çš„ç»“æœï¼Œä¹Ÿæ˜¯ä¸åŒè§’è‰²è¿›è¡Œåä½œçš„ç•Œé¢ã€‚</li></ul><p>å½“æˆ‘ä»¬èŠæ¶æ„è®¾è®¡çš„æ—¶å€™ï¼Œæˆ‘ä»¬å…¶å®æ˜¯åœ¨è°ˆè®ºä¸€ä¸ªå®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸï¼Œæˆ‘å°†å…¶æ¦‚æ‹¬ä¸ºä»¥ä¸‹6 ä¸ªæ­¥éª¤ï¼š</p><ol type="1"><li><strong>ç†è§£å•†ä¸šä¸ç»„ç»‡ä¸Šä¸‹æ–‡ï¼š</strong>æˆ‘ä»¬åœ¨è°ˆè®ºæ·±å…¥æŒ–æ˜åˆ©ç›Šç›¸å…³æ–¹çš„çœŸå®è¯‰æ±‚ã€æ˜ç¡®ç”¨æˆ·æ ¸å¿ƒç—›ç‚¹ã€å¯¹é½å…³é”®å•†ä¸šæŒ‡æ ‡ï¼Œå¹¶è¯šå®è¯„ä¼°æˆ‘ä»¬å›¢é˜Ÿç°æœ‰çš„æŠ€æœ¯æ ˆä¸ç»„ç»‡èƒ½åŠ›ã€‚</li><li><strong>å®šä¹‰æ¶æ„ç‰¹æ€§ä¸çº¦æŸï¼š</strong>æˆ‘ä»¬åœ¨è°ˆè®ºä»æ€§èƒ½ã€å¯ç”¨æ€§ã€æˆæœ¬ç­‰ä¼—å¤šç‰¹æ€§ä¸­ï¼Œè¯†åˆ«å‡ºå¯¹æœ¬æ¬¡è®¾è®¡æœ€å…³é”®çš„ 3-5ä¸ªï¼Œå¹¶æ¸…æ™°å®šä¹‰é‚£äº›ä¸å¯é€¾è¶Šçš„çº¦æŸçº¢çº¿ï¼Œä»¥æ­¤ä½œä¸ºåç»­æ‰€æœ‰æŠ€æœ¯æƒè¡¡(trade-off) çš„æ ¸å¿ƒåŸºå‡†ã€‚</li><li><strong>æ¢ç´¢æ–¹æ³•ä¸å†³ç­–ï¼š</strong>æˆ‘ä»¬åœ¨è°ˆè®ºé€šè¿‡ç³»ç»Ÿåœ°æ¢ç´¢å¤šç§å¯é€‰æ–¹æ¡ˆã€è¿›è¡Œå®¢è§‚çš„åˆ©å¼Šæƒè¡¡ä¸é£é™©è¯„ä¼°ï¼Œæœ€ç»ˆåšå‡ºç†æ€§çš„æŠ€æœ¯å†³ç­–å¹¶å°†å…¶ï¼ˆä¾‹å¦‚ä½¿ç”¨ADRï¼‰æ²‰æ·€ä¸ºæ–‡æ¡£ã€‚</li><li><strong>è®¾è®¡å®æ–½è·¯å¾„ä¸éªŒè¯æœºåˆ¶ï¼š</strong>æˆ‘ä»¬åœ¨è°ˆè®ºå¦‚ä½•å°†æ¶æ„è“å›¾è½¬åŒ–ä¸ºå¯æ‰§è¡Œçš„å®æ–½è®¡åˆ’ï¼ŒåŒ…æ‹¬é€šè¿‡ PoCéªŒè¯å…³é”®éš¾ç‚¹ã€æ‹†è§£ä»»åŠ¡ä¸é‡Œç¨‹ç¢‘ï¼Œå¹¶é€šè¿‡æ„å»ºé€‚åº”åº¦å‡½æ•°æ¥æŒç»­éªŒè¯æ¶æ„ç‰¹æ€§çš„è½åœ°ã€‚</li><li><strong>éƒ¨ç½²ã€è§‚æµ‹ä¸æ•ˆæœè¡¡é‡ï¼š</strong> æˆ‘ä»¬åœ¨è°ˆè®ºé€šè¿‡ CI/CDå°†è®¾è®¡äº¤ä»˜ä¸Šçº¿ï¼Œå¹¶å€ŸåŠ© APMå’Œä¸šåŠ¡æŒ‡æ ‡ç›‘æ§æ¥å®æ—¶è§‚æµ‹ç³»ç»Ÿçš„è¿è¡ŒçŠ¶æ€ä¸å•†ä¸šæ•ˆæœï¼Œä»¥æ­¤è·å–æœ€çœŸå®çš„åé¦ˆã€‚</li><li><strong>å¤ç›˜ã€æ²‰æ·€ä¸æ¼”è¿›ï¼š</strong>æˆ‘ä»¬åœ¨è°ˆè®ºå¯¹çº¿ä¸Šé—®é¢˜è¿›è¡Œå½»åº•çš„æ ¹å› åˆ†æã€å°†ç»éªŒæ•™è®­æ²‰æ·€ä¸ºæ”¹è¿›åçš„æµç¨‹ä¸åŸåˆ™ï¼Œæœ€ç»ˆæ¨åŠ¨äººå‘˜ä¸ç»„ç»‡çš„å…±åŒæˆé•¿ï¼Œå¹¶ä¸ºä¸‹ä¸€è½®æ¶æ„æ¼”è¿›åšå¥½å‡†å¤‡ã€‚</li></ol><h3 id="æ¶æ„é€‰æ‹©çš„ä¸¤å¤§åŸç†">æ¶æ„é€‰æ‹©çš„ä¸¤å¤§åŸç†</h3><ul><li>ç¬¬ä¸€åŸç†ï¼šä¸€åˆ‡éƒ½æ˜¯æƒè¡¡ã€‚</li><li>ç¬¬äºŒåŸç†ï¼šä¸ºä»€ä¹ˆæ¯”å¦‚ä½•æ›´é‡è¦ã€‚</li></ul><h3 id="æ¶æ„åŸåˆ™">æ¶æ„åŸåˆ™</h3><ul><li><strong>KISS (Keep It Simple, Stupid) åŸåˆ™ï¼š</strong>åœ¨æ‰€æœ‰è§£å†³æ–¹æ¡ˆä¸­ï¼Œä¼˜å…ˆé€‰æ‹©æœ€ç®€å•ã€æœ€æ¸…æ™°çš„é‚£ä¸€ä¸ªã€‚</li><li><strong>YAGNI (You Ain't Gonna Need It) åŸåˆ™ï¼š</strong>åªå®ç°ä½ å½“å‰æ˜ç¡®éœ€è¦çš„åŠŸèƒ½ï¼Œä¸è¦ä¸º"æœªæ¥å¯èƒ½çš„éœ€æ±‚"ç¼–å†™ä»£ç ã€‚</li><li><strong>DRY (Don't Repeat Yourself) åŸåˆ™ï¼š</strong>ç¡®ä¿ç³»ç»Ÿä¸­çš„æ¯ä¸€å¤„çŸ¥è¯†ï¼ˆé€»è¾‘ã€æ•°æ®ï¼‰éƒ½åªæœ‰ä¸€ä¸ªæƒå¨çš„ã€æ˜ç¡®çš„è¡¨ç¤ºã€‚</li><li><strong>TDA (Tell, Don't Ask) åŸåˆ™ï¼š</strong>ä½ åº”è¯¥"å‘Šè¯‰"å¯¹è±¡å»åšäº‹ï¼Œè€Œä¸æ˜¯"è¯¢é—®"å®ƒçš„å†…éƒ¨çŠ¶æ€æ¥æ›¿å®ƒåšå†³ç­–ã€‚</li><li><strong>SoC (Separation of Concerns) åŸåˆ™ï¼š</strong>å°†ä¸€ä¸ªå¤æ‚çš„ç³»ç»Ÿåˆ’åˆ†ä¸ºå¤šä¸ªç‹¬ç«‹çš„ã€åªå…³æ³¨ä¸€ä¸ªæ–¹é¢çš„æ¨¡å—ã€‚</li><li><strong>LoD (Law of Demeter) åŸåˆ™ï¼š</strong>ä¸€ä¸ªå¯¹è±¡åº”è¯¥å°½å¯èƒ½å°‘åœ°äº†è§£å…¶ä»–å¯¹è±¡çš„å†…éƒ¨ç»“æ„ï¼Œåªä¸å…¶å¿…è¦éƒ¨åˆ†é€šä¿¡ã€‚</li></ul><p>è¿™äº›åŸåˆ™å…±åŒæœåŠ¡äºä¸€ä¸ªç›®æ ‡ï¼š<strong>åˆ›å»ºä¸€ä¸ªæ˜“äºç†è§£ã€æ˜“äºä¿®æ”¹ã€æ˜“äºç»´æŠ¤çš„ç³»ç»Ÿ</strong>ï¼Œä»è€Œåœ¨è½¯ä»¶çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…ï¼Œ<strong>æœ€å¤§åŒ–åœ°æ§åˆ¶ä½"å¤æ‚åº¦"è¿™ä¸ªæ•Œäºº</strong>ã€‚</p><p>ä½ å¯ä»¥æŒ‰ç…§ä¸‹é¢çš„æ€è·¯åœ¨è¿ç”¨è¿™å…­å¤§åŸåˆ™ï¼š</p><ol type="1"><li>å½“ä¸€ä¸ªæ–°éœ€æ±‚æ¥äº†ï¼Œä½ é¦–å…ˆç”¨ <strong>YAGNI</strong> å’Œ<strong>KISS</strong>æ¥è¿‡æ»¤å®ƒï¼šæˆ‘ä»¬çœŸçš„éœ€è¦å®ƒå—ï¼Ÿæˆ‘ä»¬èƒ½ç”¨æœ€ç®€å•çš„æ–¹æ³•å®ç°å®ƒå—ï¼Ÿ</li><li>ä¸€æ—¦å†³å®šè¦åšï¼Œä½ ç”¨ <strong>SoC</strong>æ¥åˆ’åˆ†å®ƒçš„è¾¹ç•Œï¼šè¿™ä¸ªåŠŸèƒ½åº”è¯¥å±äºå“ªä¸ªå…³æ³¨ç‚¹ï¼Ÿå®ƒæ˜¯ä¸€ä¸ªæ–°æ¨¡å—å—ï¼Ÿ</li><li>åœ¨å®ç°è¿™ä¸ªæ¨¡å—æ—¶ï¼Œä½ ç”¨ <strong>DRY</strong>æ¥é¿å…å†…éƒ¨çš„é‡å¤ä»£ç ï¼Œé€šè¿‡æŠ½è±¡æ¥ä¿è¯çŸ¥è¯†çš„å”¯ä¸€æ€§ã€‚</li><li>å½“è¿™ä¸ªæ¨¡å—éœ€è¦ä¸å¤–éƒ¨æ¨¡å—é€šä¿¡æ—¶ï¼Œä½ ç”¨ <strong>LoD</strong> å’Œ<strong>TDA</strong>æ¥æŒ‡å¯¼ä½ çš„äº¤äº’è®¾è®¡ï¼šåªå’Œé‚»å±…è¯´è¯ï¼ˆLoDï¼‰ï¼Œå¹¶ä¸”æ˜¯å‘Šè¯‰å®ƒä»¬åšäº‹ï¼ˆTDAï¼‰ï¼Œè€Œä¸æ˜¯æ‰“å¬å®ƒä»¬çš„å†…éƒ¨çŠ¶æ€ã€‚</li></ol><h3 id="å¸¸ç”¨æ¶æ„æ¨¡å¼">å¸¸ç”¨æ¶æ„æ¨¡å¼</h3><p>è¿™é‡Œæˆ‘æ¢³ç†äº†<ahref="https://fundamentalsofsoftwarearchitecture.com/">ã€ŠFundamentals ofSoftwareArchitectureã€‹</a>ä¸€ä¹¦æåˆ°çš„æœ€å¸¸ç”¨ã€æœ€ç»å…¸çš„æ¶æ„æ¨¡å¼ï¼Œå…·ä½“çš„æè¿°å’Œæƒè¡¡ä¹‹é“å¯ä»¥å‚è€ƒæˆ‘æ¢³ç†çš„ç¬”è®°ï¼š<ahref="https://hedon.top/2025/07/24/note/note-fosa/">è¯»ä¹¦ç¬”è®°ä¸¨ã€ŠFundamentalsof Software Architectureã€‹</a>ã€‚</p><ol type="1"><li><strong>åˆ†å±‚æ¶æ„</strong>ï¼šåˆ†å±‚æ¶æ„çš„æ ¸å¿ƒé©±åŠ¨åŠ›æ˜¯å…³æ³¨ç‚¹åˆ†ç¦»ï¼ˆSeparationofConcernsï¼‰ã€‚å®ƒå°†ä¸€ä¸ªå¤æ‚çš„ç³»ç»ŸæŒ‰ç…§ä¸åŒçš„èŒè´£æˆ–æŠ€æœ¯å…³æ³¨ç‚¹ï¼Œå‚ç›´åœ°åˆ’åˆ†æˆè‹¥å¹²ä¸ªæ°´å¹³çš„â€œå±‚ï¼ˆLayerï¼‰â€ã€‚</li><li><strong>ç®¡é“æ¶æ„</strong>ï¼šåˆç§°ä¸ºç®¡é“ä¸è¿‡æ»¤å™¨æ¶æ„ï¼ˆPipes and FiltersArchitectureï¼‰ï¼Œæ˜¯ä¸€ç§ç”¨äºå¤„ç†æ•°æ®æµçš„å¼ºå¤§æ¨¡å¼ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³éå¸¸ç›´è§‚ï¼Œå°±åƒä¸€æ¡å·¥å‚çš„æµæ°´çº¿ï¼šåŸææ–™ä»ä¸€ç«¯è¿›å…¥ï¼Œç»è¿‡ä¸€ç³»åˆ—ç‹¬ç«‹å·¥ç«™çš„åŠ å·¥ã€å¤„ç†ã€æ£€éªŒï¼Œæœ€ç»ˆåœ¨å¦ä¸€ç«¯å½¢æˆæˆå“ã€‚</li><li><strong>å¾®æ ¸æ¶æ„</strong>ï¼šä¹Ÿè¢«ç§°ä¸ºæ’ä»¶åŒ–æ¶æ„ï¼ˆPlug-inArchitectureï¼‰ï¼Œæ˜¯ä¸€ç§èƒ½å¤Ÿæä¾›æé«˜æ‰©å±•æ€§ã€çµæ´»æ€§å’Œæ¼”åŒ–èƒ½åŠ›çš„ç³»ç»Ÿè®¾è®¡æ¨¡å¼ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†ç³»ç»ŸåŠŸèƒ½åˆ’åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šä¸€ä¸ªæœ€å°åŒ–çš„ã€ç¨³å®šçš„æ ¸å¿ƒç³»ç»Ÿï¼ˆCoreSystemï¼‰å’Œä¸€ä¸ªç”±ç‹¬ç«‹æ’ä»¶ç»„ä»¶ï¼ˆPlug-inComponentsï¼‰æ„æˆçš„å¯æ‰©å±•ç”Ÿæ€ã€‚</li><li><strong>åŸºäºæœåŠ¡çš„æ¶æ„</strong>ï¼šæœ¬è´¨æ˜¯ä¸€ç§å°†ä¸€ä¸ªå¤§å‹çš„å•ä½“åº”ç”¨ï¼Œåˆ†è§£ä¸ºå°‘æ•°å‡ ä¸ªã€é€»è¾‘ç‹¬ç«‹çš„ã€å¯ç‹¬ç«‹éƒ¨ç½²çš„"æœåŠ¡"çš„æ¶æ„é£æ ¼ã€‚SBA çš„æœåŠ¡æ•°é‡é€šå¸¸ä¸å¤šï¼Œä¸€èˆ¬åœ¨ 4 åˆ° 12ä¸ªä¹‹é—´ã€‚å®ƒä¸åƒå¾®æœåŠ¡é‚£æ ·è¿½æ±‚æè‡´çš„æ‹†åˆ†ï¼ˆå¯èƒ½ä¼šæœ‰å‡ åä¸Šç™¾ä¸ªæœåŠ¡ï¼‰ï¼Œè€Œæ˜¯å°†åº”ç”¨æŒ‰ç…§æ ¸å¿ƒçš„ä¸šåŠ¡é¢†åŸŸè¿›è¡Œåˆ’åˆ†ã€‚</li><li><strong>äº‹ä»¶é©±åŠ¨æ¶æ„</strong>ï¼šå¯¹ç‰¹å®šæƒ…å†µåšå‡ºååº”ï¼Œå¹¶æ ¹æ®è¯¥äº‹ä»¶é‡‡å–è¡ŒåŠ¨ã€‚åˆ†ä¸ºä»£ç†æ¨¡å¼ï¼ˆbrokerï¼‰å’Œä¸­ä»‹è€…æ¨¡å¼ï¼ˆmediatorï¼‰ä¸¤ç§æ¨¡å¼ï¼ŒäºŒè€…æœ€å¤§çš„åŒºåˆ«åœ¨äºåè€…å…·æœ‰ä¸€ä¸ªç»Ÿä¸€çš„åè°ƒè€…ï¼Œè¿™ä¼šå¯¹å¼‚å¸¸å¤„ç†ã€å…¨å±€ç»Ÿç­¹æœ‰å¾ˆå¥½çš„ç®¡æ§æ‰‹æ®µï¼Œå½“åŒæ—¶ä¹Ÿç‰ºç‰²äº†ç³»ç»Ÿçš„è§£è€¦ç¨‹åº¦ã€çµæ´»åº¦å’Œæ€§èƒ½ã€‚</li><li><strong>ç©ºé—´æ¶æ„</strong>ï¼šåç§°æ¥æºäºå…ƒç»„ç©ºé—´ï¼ˆTupleSpaceï¼‰å¤šä¸ªå¹¶è¡Œå¤„ç†å™¨é€šè¿‡å…±äº«å†…å­˜è¿›è¡Œé€šä¿¡ã€‚SBAçš„æ ¸å¿ƒç†å¿µä¾¿æ˜¯å°†åº”ç”¨æ•°æ®ä¿å­˜åœ¨å†…å­˜ä¸­ï¼ˆin-memoryï¼‰ï¼Œå¹¶åœ¨æ‰€æœ‰æ´»è·ƒçš„å¤„ç†å•å…ƒï¼ˆProcessingUnitsï¼‰å¤åˆ¶ï¼Œä»è€Œç§»é™¤ä¸­å¿ƒæ•°æ®åº“ä½œä¸ºåŒæ­¥çº¦æŸï¼Œå®ç°è¿‘ä¹æ— é™çš„ä¼¸ç¼©æ€§ã€‚</li><li><strong>å¾®æœåŠ¡æ¶æ„</strong>ï¼šæ ¸å¿ƒåœ¨äºé«˜åº¦è§£è€¦ã€‚å®ƒå€¾å‘äºå¤åˆ¶è€Œéè€¦åˆã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœæ¶æ„å¸ˆçš„ç›®æ ‡æ˜¯é«˜åº¦è§£è€¦ï¼Œé‚£ä¹ˆä»–ä»¬ä¼šé€‰æ‹©å¤åˆ¶è€Œä¸æ˜¯é‡ç”¨ã€‚å¾®æœåŠ¡é€šè¿‡ç‰©ç†ä¸Šå»ºæ¨¡é™ç•Œä¸Šä¸‹æ–‡ï¼ˆBoundedContextï¼‰çš„é€»è¾‘æ¦‚å¿µæ¥å®ç°é«˜åº¦è§£è€¦ã€‚</li></ol><h2 id="é¢†åŸŸé©±åŠ¨è®¾è®¡">é¢†åŸŸé©±åŠ¨è®¾è®¡</h2><p>åœ¨å¤æ‚åº¦ç®¡ç†çš„æœ¯ç¯‡æœ€åï¼Œæˆ‘æƒ³ç”¨DDDï¼ˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼‰æ¥æ”¶ä¸ªå°¾ã€‚å¾ˆé—æ†¾æˆ‘å¹¶æ²¡æœ‰åœ¨ä¸Šä»½å·¥ä½œä¸­ç§¯ç´¯ DDDçš„ç›¸å…³ç»éªŒï¼Œæˆ‘ä»¬çš„ä¸šåŠ¡å¤æ‚åº¦å…¶å®å·²ç»åˆ°äº†éš¾ä»¥ç®¡ç†ç”šè‡³å¤±æ§çš„ç¨‹åº¦äº†ï¼Œé¢†å¯¼ä¹Ÿæå‡ºäº†è¦å°è¯•ä½¿ç”¨DDDæ¥è¿›è¡Œæ²»ç†ï¼Œä¸è¿‡åé¢ä¹Ÿä¸çŸ¥ä¸ºä½•å°±æç½®äº†ã€‚å›¢é˜Ÿè¿™ç§ä¹ æƒ¯æ€§æœ‰å¤´æ— å°¾çš„é£æ ¼ï¼Œä¹Ÿæ˜¯æˆ‘ä¸‹å®šå†³å®šç¦»å¼€çš„åŸå› ä¹‹ä¸€ã€‚</p><h3 id="ddd-å­˜åœ¨çš„æ„ä¹‰">DDD å­˜åœ¨çš„æ„ä¹‰</h3><p>è¯å›æ­£é¢˜ï¼Œæˆ‘ä»¬ä¸€ç›´åœ¨è°ˆè®ºå¤æ‚åº¦ç®¡ç†ã€‚è½¯ä»¶çš„å¤æ‚åº¦æœ‰ä¸¤ä¸ªæ¥æºï¼š</p><ol type="1"><li><strong>æŠ€æœ¯å¤æ‚åº¦</strong>ï¼šç”±æŠ€æœ¯é€‰å‹ã€æ¡†æ¶ã€æ€§èƒ½ã€å¹¶å‘ç­‰å¼•å…¥çš„å¤æ‚åº¦ã€‚</li><li><strong>é¢†åŸŸå¤æ‚åº¦</strong>ï¼šä¸šåŠ¡æœ¬èº«å›ºæœ‰çš„å¤æ‚åº¦ã€‚æ¯”å¦‚ä¸€ä¸ªç”µå•†ç³»ç»Ÿçš„"ä¼˜æƒ åˆ¸è®¡ç®—è§„åˆ™"ï¼Œä¸€ä¸ªé‡‘èç³»ç»Ÿçš„"ä¼°å€¼æ¨¡å‹"ï¼Œä¸€åœºè”æœºæ¸¸æˆçš„"ç»“ç®—è¿‡ç¨‹"ã€‚</li></ol><p>ä¸ºä»€ä¹ˆä¼ ç»Ÿå¼€å‘çš„"æœ¯"åœ¨ä¸šåŠ¡å‘å±•åˆ°ä¸€å®šè§„æ¨¡çš„æ—¶å€™ï¼Œåœ¨ç®¡ç†å¤æ‚åº¦æ—¶å¾€å¾€ä¼šå¤±æ•ˆå‘¢ï¼Ÿ</p><p>åœ¨å¾ˆå¤šé¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬èŠ±äº†å¤§é‡æ—¶é—´åœ¨æŠ€æœ¯å¤æ‚åº¦ä¸Šï¼Œè€Œå¯¹é¢†åŸŸå¤æ‚åº¦çš„å¤„ç†ï¼Œå¾€å¾€æ˜¯æ•°æ®é©±åŠ¨çš„ï¼šå…ˆè®¾è®¡æ•°æ®åº“è¡¨(DAO/Models)ï¼Œç„¶åå†™æœåŠ¡ (Service)ï¼Œæœ€åå†™æ¥å£(Controller)ã€‚è¿™ç§æ–¹å¼åœ¨ä¸šåŠ¡åˆæœŸå¾ˆç®€å•ã€‚</p><p>ä½†éšç€ä¸šåŠ¡å‘å±•ï¼Œä¸šåŠ¡è§„åˆ™ä¼šå˜å¾—æå…¶å¤æ‚ï¼ˆæ¯”å¦‚ï¼Œä¸€åœºè”æœºæ¸¸æˆçš„ç»“ç®—ï¼Œå¯èƒ½è¦è°ƒç”¨10 ä¸ªå¾®æœåŠ¡ï¼Œæ¶‰åŠ 20 å¼ è¡¨ï¼Œå¤„ç† 30 ç§è¿è¥æ´»åŠ¨ç­–ç•¥ï¼‰ã€‚</p><p>æ­¤æ—¶ï¼Œä¸šåŠ¡é€»è¾‘è¢«<strong>åˆ‡å‰²</strong>å¹¶<strong>åˆ†æ•£</strong>åœ¨å„ä¸ªServiceã€Helperã€Utils ç”šè‡³ Controllerå±‚ä¸­ã€‚ä»£ç ï¼ˆæŠ€æœ¯å®ç°ï¼‰ä¸çœŸå®çš„ä¸šåŠ¡ï¼ˆé¢†åŸŸï¼‰ä¹‹é—´çš„<strong>è®¤çŸ¥é¸¿æ²Ÿ</strong>è¶Šæ¥è¶Šå¤§ã€‚æœ€ç»ˆï¼Œç³»ç»Ÿå˜å¾—æ— æ³•ç»´æŠ¤ï¼Œå› ä¸º<strong>æ²¡æœ‰äººèƒ½è¯´æ¸…æ¥šä¸€ä¸ªå®Œæ•´çš„ä¸šåŠ¡æµç¨‹åˆ°åº•æ˜¯æ€ä¹ˆè¿ä½œçš„</strong>ã€‚</p><p><strong>è½¯ä»¶çš„æ ¸å¿ƒæ˜¯å…¶ä¸ºç”¨æˆ·è§£å†³çš„é¢†åŸŸé—®é¢˜</strong>ã€‚å› æ­¤ï¼Œç®¡ç†å¤æ‚åº¦çš„æ ¹æœ¬ï¼Œåœ¨äº<strong>ç²¾å‡†åœ°æ•è·ã€è¡¨è¾¾å’Œéš”ç¦»é¢†åŸŸå¤æ‚åº¦</strong>ã€‚å®ƒè¦æ±‚æˆ‘ä»¬ä»æŠ€æœ¯å®ç°é©±åŠ¨è½¬å‘é¢†åŸŸæ¨¡å‹é©±åŠ¨ã€‚è¿™ä¾¿æ˜¯DDD å­˜åœ¨çš„æ„ä¹‰ã€‚</p><h3 id="ddd-ä¸¤å¤§æ ¸å¿ƒ">DDD ä¸¤å¤§æ ¸å¿ƒ</h3><p>è¦æƒ³ç†è§£ DDDçš„æ ¸å¿ƒæ€æƒ³ï¼Œé‡ç‚¹åœ¨äºå¼„æ¸…æ¥šå®ƒçš„æˆ˜ç•¥è®¾è®¡å’Œæˆ˜æœ¯è®¾è®¡ï¼Œä»¥åŠå…¶èƒŒåçš„ç¬¬ä¸€æ€§åŸç†ã€‚</p><h4 id="æˆ˜ç•¥è®¾è®¡åœ¨å®è§‚ä¸Šåˆ’åˆ†æˆ˜åœº">æˆ˜ç•¥è®¾è®¡ï¼šåœ¨å®è§‚ä¸Šåˆ’åˆ†æˆ˜åœº</h4><p>è¿™æ˜¯ DDD æœ€é‡è¦çš„éƒ¨åˆ†ï¼Œå®ƒå†³å®šäº†ç³»ç»Ÿçš„å®è§‚æ¶æ„ã€‚</p><ul><li><strong>ç»Ÿä¸€è¯­è¨€ (UbiquitousLanguage)</strong>ï¼šç»Ÿä¸€è¯­è¨€æ˜¯ä¸šåŠ¡ä¸“å®¶ã€äº§å“ç»ç†å’Œå¼€å‘å›¢é˜Ÿåœ¨åŒä¸€ä¸ªé™ç•Œä¸Šä¸‹æ–‡ä¸­å…±åŒé”¤ç‚¼ã€ä¸¥æ ¼éµå®ˆçš„ã€æ— æ­§ä¹‰çš„è¯æ±‡è¡¨ï¼Œå®ƒè´¯ç©¿äºæ‰€æœ‰æ²Ÿé€šã€æ–‡æ¡£å’Œä»£ç å®ç°ä¹‹ä¸­ï¼Œæ˜¯æ„å»ºé¢†åŸŸæ¨¡å‹çš„åŸºçŸ³ã€‚</li><li><strong>é™ç•Œä¸Šä¸‹æ–‡ (BoundedContext)</strong>ï¼šé™ç•Œä¸Šä¸‹æ–‡æ˜¯ä¸€ä¸ªæ˜ç¡®çš„ä¸šåŠ¡è¾¹ç•Œï¼ˆæ¯”å¦‚ä¸€ä¸ªå­ç³»ç»Ÿæˆ–å¾®æœåŠ¡ï¼‰ï¼Œå®ƒå°è£…å¹¶ä¿æŠ¤ä¸€ä¸ªç‹¬ç«‹çš„é¢†åŸŸæ¨¡å‹ï¼Œç¡®ä¿"ç»Ÿä¸€è¯­è¨€"åœ¨è¯¥è¾¹ç•Œå†…çš„å«ä¹‰æ˜¯å”¯ä¸€ä¸”è‡ªæ´½çš„ï¼Œä»è€Œå…è®¸ä¸åŒä¸Šä¸‹æ–‡å¯¹åŒä¸€ä¸šåŠ¡æ¦‚å¿µï¼ˆå¦‚å•†å“ï¼‰æ‹¥æœ‰ä¸åŒçš„æ¨¡å‹ã€‚</li><li><strong>ä¸Šä¸‹æ–‡æ˜ å°„ (ContextMap)</strong>ï¼šä¸Šä¸‹æ–‡æ˜ å°„æ˜¯ä¸€ç§å®è§‚æ¶æ„å›¾ï¼Œå®ƒé€šè¿‡å®šä¹‰ä¸åŒé™ç•Œä¸Šä¸‹æ–‡ä¹‹é—´çš„é›†æˆæ¨¡å¼ï¼ˆå¦‚é˜²è…å±‚ã€å…±äº«å†…æ ¸æˆ–éµä»è€…ï¼‰æ¥æ¸…æ™°åœ°æç»˜å®ƒä»¬ä¹‹é—´çš„æŠ€æœ¯ä¾èµ–å’Œå›¢é˜Ÿç»„ç»‡å…³ç³»ï¼Œä»è€Œåœ¨æˆ˜ç•¥å±‚é¢ç®¡ç†è·¨æ¨¡å‹çš„é›†æˆå¤æ‚åº¦ã€‚</li></ul><h4 id="æˆ˜æœ¯è®¾è®¡åœ¨å¾®è§‚ä¸Šä¿æŠ¤æ¨¡å‹">æˆ˜æœ¯è®¾è®¡ï¼šåœ¨å¾®è§‚ä¸Šä¿æŠ¤æ¨¡å‹</h4><p>å½“æˆ‘ä»¬é€šè¿‡æˆ˜ç•¥è®¾è®¡åˆ’åˆ†å¥½äº†è¾¹ç•Œä¹‹åï¼Œæˆ˜æœ¯è®¾è®¡æä¾›äº†å…·ä½“çš„ç¼–ç æ–¹å¼ï¼Œæ¥<strong>ç¡®ä¿</strong>æˆ‘ä»¬åœ¨ä»£ç ä¸­å®ç°çš„æ¨¡å‹ä¸è¢«ç ´åã€‚å…¶ä¸­æœ€æ ¸å¿ƒçš„æœ‰ä¸‰ç‚¹ï¼š</p><ul><li><strong>èšåˆ(Aggregate)</strong>ï¼šèšåˆæ˜¯å°†ä¸€ä¸ªæˆ–å¤šä¸ªå®ä½“ä¸å€¼å¯¹è±¡ï¼ˆå¦‚è®¢å•å’Œè®¢å•é¡¹ï¼‰ç»„åˆæˆä¸€ä¸ªä¸šåŠ¡ä¸Šçš„ä¸€è‡´æ€§å•å…ƒï¼Œå¤–ç•Œåªèƒ½é€šè¿‡å…¶èšåˆæ ¹è¿™å”¯ä¸€å…¥å£æ¥è®¿é—®ï¼Œä»è€Œå¼ºåˆ¶å°è£…æ‰€æœ‰ä¸šåŠ¡è§„åˆ™ï¼ˆä¸å˜é‡ï¼‰å¹¶ç¡®ä¿å…¶ä½œä¸ºä¸€ä¸ªæ•´ä½“è¢«äº‹åŠ¡æ€§åœ°æŒä¹…åŒ–ã€‚</li><li><strong>å€¼å¯¹è±¡ (ValueObject)</strong>ï¼šå€¼å¯¹è±¡æ˜¯ä¸€ç§é€šè¿‡å…¶å±æ€§ï¼ˆè€Œéå”¯ä¸€IDï¼‰æ¥å®šä¹‰çš„å¯¹è±¡ï¼ˆå¦‚é‡‘é¢æˆ–åœ°å€ï¼‰ï¼Œå®ƒè¢«è®¾è®¡ä¸ºä¸å¯å˜çš„ä»¥æ¶ˆé™¤å‰¯ä½œç”¨ï¼Œå¹¶åœ¨é¢†åŸŸæ¨¡å‹ä¸­æ‰¿è½½é‚£äº›ç”¨äºåº¦é‡ã€æè¿°æˆ–é™å®šä¸šåŠ¡æ¦‚å¿µçš„å€¼ã€‚</li><li><strong>èµ„æºåº“(Repository)</strong>ï¼šèµ„æºåº“æ˜¯å®šä¹‰åœ¨é¢†åŸŸå±‚çš„ä¸€ä¸ªæ¥å£ï¼Œå®ƒé€šè¿‡æ¨¡æ‹Ÿä¸€ä¸ªå†…å­˜ä¸­çš„é›†åˆæ¥å°è£…æ•°æ®æŒä¹…åŒ–çš„æ‰€æœ‰æŠ€æœ¯ç»†èŠ‚ï¼Œå…¶å…·ä½“å®ç°ï¼ˆå¦‚SQLæŸ¥è¯¢ï¼‰åˆ™è¢«éš”ç¦»åœ¨åŸºç¡€è®¾æ–½å±‚ï¼Œä»è€Œä½¿é¢†åŸŸæ¨¡å‹ï¼ˆå°¤å…¶æ˜¯èšåˆæ ¹ï¼‰ä¿æŒçº¯æ´ï¼Œæ— éœ€å…³å¿ƒæ•°æ®æ˜¯å¦‚ä½•å­˜å–çš„ã€‚</li></ul><p>ç›®å‰æˆ‘å¯¹äº DDD çš„ç†è§£å’Œå®è·µä»…åœ¨äºé˜…è¯»äº†<ahref="https://book.douban.com/subject/37102014/">ã€Šæ‚Ÿé“é¢†åŸŸé©±åŠ¨è®¾è®¡ã€‹</a>ä¸€ä¹¦ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥å‚è€ƒæˆ‘æ¢³ç†çš„<ahref="https://hedon.top/2025/03/11/note/note-ddd-awareness/">è¯»ä¹¦ç¬”è®°ä¸¨ã€Šæ‚Ÿé“é¢†åŸŸé©±åŠ¨è®¾è®¡ã€‹</a>ã€‚</p><h1 id="å™¨éªŒè¯ä¸æ´å¯Ÿçš„è´¨é‡æ‰‹æ®µ">å™¨ï¼šéªŒè¯ä¸æ´å¯Ÿçš„è´¨é‡æ‰‹æ®µ</h1><p>å¦‚æœè¯´å¿ƒæ³•æ˜¯é“ï¼Œæœ¯æ˜¯æ‹›å¼ï¼Œé‚£ä¹ˆå™¨å°±æ˜¯"çœ¼ç›"å’Œ"æ ‡å°º"ã€‚æ²¡æœ‰å™¨ï¼Œæˆ‘ä»¬æ°¸è¿œä¸çŸ¥é“æ‹›å¼æ‰“å¾—å¯¹ä¸å¯¹ï¼Œä¹Ÿæ— ä»å¾—çŸ¥æˆ‘ä»¬çš„é“æ˜¯ä¸æ˜¯èµ°åäº†ã€‚è¿™é‡Œæˆ‘æƒ³é‡ç‚¹æ€»ç»“æˆ‘è®¤ä¸º2ä¸ªæœ€é‡è¦çš„å·¥å…·ï¼š<strong>å•å…ƒæµ‹è¯•</strong>å’Œ<strong>å¯è§‚æµ‹æ€§</strong>ã€‚è¿™ä¹Ÿæ˜¯æˆ‘åœ¨ç¬¬ä¸€ä»½å·¥ä½œä¸­åšçš„æœ€æœ‰æˆå°±æ„Ÿã€ä¹Ÿæ˜¯æˆ‘è¿›æ­¥æœ€å¤§çš„ä¸¤ä¸ªä¸“é¡¹ï¼šä»£ç è´¨é‡å»ºè®¾ä¸“é¡¹å’ŒæœåŠ¡ç›‘æ§å»ºè®¾ä¸“é¡¹ã€‚</p><p>æˆ‘ä¹‹æ‰€ä»¥è®¤ä¸ºå•å…ƒæµ‹è¯•å’Œå¯è§‚æµ‹æ€§æ˜¯ç®¡ç†è½¯ä»¶å¤æ‚åº¦çš„ä¸¤å¤§åˆ©å™¨ï¼Œæ˜¯å› ä¸ºå®ƒä»¬åˆ†åˆ«ä¸ºè½¯ä»¶ç”Ÿå‘½å‘¨æœŸä¸­ä¸¤ä¸ªæˆªç„¶ä¸åŒçš„å¤æ‚åº¦é˜¶æ®µâ€”â€”<strong>é™æ€å¤æ‚åº¦</strong>å’Œ<strong>åŠ¨æ€å¤æ‚åº¦</strong>â€”â€”æä¾›äº†å¿…ä¸å¯å°‘çš„<strong>åé¦ˆä¸æ§åˆ¶æœºåˆ¶</strong>ã€‚</p><ul><li><strong>é™æ€å¤æ‚åº¦</strong>ï¼šä»£ç åœ¨"å†™ä¸‹æ—¶"çš„å¤æ‚åº¦ã€‚å®ƒå…³ä¹ä»£ç çš„ç»“æ„ã€ä¾èµ–ã€æ­£ç¡®æ€§å’Œå¯è¯»æ€§ã€‚</li><li><strong>åŠ¨æ€å¤æ‚åº¦</strong>ï¼šç³»ç»Ÿåœ¨"è¿è¡Œæ—¶"çš„å¤æ‚åº¦ã€‚å®ƒå…³ä¹æˆåƒä¸Šä¸‡ä¸ªæ¨¡å—äº¤äº’æ—¶æ‰€<strong>æ¶Œç°</strong>å‡ºçš„ã€éš¾ä»¥é¢„æµ‹å’Œè·Ÿè¸ªçš„è¡Œä¸ºã€‚</li></ul><h2 id="å•å…ƒæµ‹è¯•">å•å…ƒæµ‹è¯•</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/81R7v9lnljL._CR2,0,1276,720_SR684,386_.jpeg"alt="Unit Testing Principles, Practices, and Patterns" /><figcaption aria-hidden="true">Unit Testing Principles, Practices, andPatterns</figcaption></figure><p>è¿™é‡Œæˆ‘å¼ºçƒˆå»ºè®®æ‰€æœ‰è½¯ä»¶å·¥ç¨‹å¸ˆéƒ½å»é˜…è¯»<ahref="https://book.douban.com/subject/34429421/">ã€ŠUnit TestingPrinciples, Practices, andPatternsã€‹</a>è¿™æœ¬ä¹¦ï¼ç»ä¸–å¥½ä¹¦ï¼è€Œä¸”æœ€å¥½çš„é˜…è¯»è‹±æ–‡åŸç‰ˆï¼æˆ‘ä½¿ç”¨äº† 2ä¸ªæœˆçš„æ—¶é—´ï¼ˆæ¯å¤© 1 ä¸ªå°æ—¶ï¼‰å®Œå®Œæ•´æ•´é˜…è¯»äº†è¿™æœ¬ä¹¦ 2æ¬¡ï¼Œå®ƒå¯¹æˆ‘åœ¨å•å…ƒæµ‹è¯•å’Œä»£ç è´¨é‡ä¸Šçš„ç†è§£å’Œå®è·µèƒ½åŠ›éƒ½èµ·åˆ°äº†éå¸¸å¤§çš„å¸®åŠ©ã€‚</p><p>è¿™é‡Œæˆ‘å°±ä¸å†é‡å¤æ­¤ä¹¦çš„å†…å®¹ï¼Œä½†æ˜¯å¦‚æœä½ æ›¾ç»æˆ–æ˜¯ç°åœ¨ä¾æ—§è¢«ä»¥ä¸‹é—®é¢˜æ‰€å›°æ‰°çš„è¯ï¼Œå»ºè®®ä½ å»ä»”ç»†é˜…è¯»ä¸€ä¸‹è¿™æœ¬ä¹¦ï¼Œä¹Ÿå¯ä»¥å‚è€ƒæˆ‘æ•´ç†çš„<ahref="https://hedon.top/2025/04/09/note/note-unit-testing/">è¯»ä¹¦ç¬”è®°ä¸¨ã€ŠUnitTesting Principles, Practices, and Patternsã€‹</a>ã€‚</p><ol type="1"><li>ä¸ºä»€ä¹ˆè¦å†™å•å…ƒæµ‹è¯•ï¼Ÿå•å…ƒæµ‹è¯•çš„ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>å•å…ƒæµ‹è¯•çš„ç²’åº¦æ˜¯æ€æ ·çš„ï¼Ÿä»€ä¹ˆå«å•å…ƒï¼Ÿa class, a function, or abehavior, or an observable behavior?</li><li>å•æµ‹è¦†ç›–ç‡çœŸçš„æœ‰ç”¨å—ï¼Ÿæœ‰ä»€ä¹ˆç”¨ï¼Ÿåˆæœ‰å“ªäº›é™åˆ¶ï¼Ÿ</li><li>æ€æ ·æ‰èƒ½å†™å¥½å•å…ƒæµ‹è¯•ï¼Ÿæ€æ ·æ‰èƒ½å†™å‡ºæ€§ä»·æ¯”æœ€é«˜çš„å•å…ƒæµ‹è¯•ï¼Ÿ</li><li>å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå•å…ƒæµ‹è¯•çš„å¥½åï¼Ÿæœ‰æ²¡æœ‰å…·ä½“å¯ä¾›å‚é˜…çš„ç»´åº¦ï¼Ÿ</li><li>å“ªäº›ä»£ç éœ€è¦å†™å•å…ƒæµ‹è¯•ï¼Œå“ªäº›ä»£ç æ²¡å¿…è¦å†™å•å…ƒæµ‹è¯•ï¼Ÿ</li><li>å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•çš„è¾¹ç•Œæ˜¯ä»€ä¹ˆï¼Ÿ</li><li>ï¼ˆå•å…ƒä¸¨é›†æˆï¼‰æµ‹è¯•åˆ°åº•æ˜¯è¦æµ‹ä»€ä¹ˆä¸œè¥¿ï¼Ÿ</li><li>å•å…ƒæµ‹è¯•çš„ä¾§é‡ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿé›†æˆæµ‹è¯•çš„ä¾§é‡ç‚¹æ˜¯ä»€ä¹ˆï¼ŸäºŒè€…çš„æ¯”ä¾‹è¯¥æ˜¯æ€æ ·çš„ï¼Ÿ</li><li>å¦‚ä½•ä½¿ç”¨ Mockï¼Ÿå“ªäº›ä¸œè¥¿æ˜¯éœ€è¦ Mock çš„ï¼Ÿå“ªäº›ä¸œè¥¿æ˜¯ä¸åº”è¯¥ Mockçš„ï¼Ÿéœ€è¦ Mock çš„ä¸œè¥¿ï¼Œåº”è¯¥åœ¨å“ªä¸ªå±‚æ¬¡è¿›è¡Œ Mockï¼Ÿï¼ˆä½ çš„ repository å±‚éœ€è¦Mock å—ï¼Ÿï¼‰</li><li>ä¸ºä»€ä¹ˆä½ çš„æµ‹è¯•ä»£ç å¾ˆè„†å¼±ï¼Œæ€»æ˜¯éœ€è¦é¢‘ç¹ä¿®æ”¹ï¼Œç»´æŠ¤èµ·æ¥éš¾åº¦å¾ˆå¤§ï¼Ÿ</li><li>å¦‚ä½•å‡å°‘æµ‹è¯•ç»“æœçš„å‡é˜³æ€§å’Œå‡é˜´æ€§ï¼Ÿ</li></ol><p>æœ¬ç¯‡æˆ‘æƒ³å¼ºè°ƒçš„æ˜¯ï¼Œå•å…ƒæµ‹è¯•çš„ä»·å€¼<strong>è¿œè¿œå¤§äº</strong>æ‰¾Bugã€‚å®ƒé¦–å…ˆæ˜¯ä¸€ç§<strong>è®¾è®¡å·¥å…·</strong>ï¼Œå…¶æ¬¡æ‰æ˜¯ä¸€ç§<strong>æµ‹è¯•å·¥å…·</strong>ã€‚å®ƒåœ¨ä¸‰ä¸ªå±‚é¢ä¸Šç®¡ç†äº†é™æ€å¤æ‚åº¦ã€‚</p><p><strong>1. å®ƒæ˜¯é«˜å†…èšä½è€¦åˆçš„è®¾è®¡åé¦ˆæœºåˆ¶</strong></p><p>åœ¨è½¯ä»¶è®¾è®¡ä¸­ï¼Œé«˜å†…èšã€ä½è€¦åˆï¼ˆ<code>æ¨¡å—åŒ–</code>å¿ƒæ³•ï¼‰æ˜¯æœ€é‡è¦çš„ç›®æ ‡ä¹‹ä¸€ã€‚å•å…ƒæµ‹è¯•æ˜¯æ£€éªŒè¿™ä¸€ç›®æ ‡æ˜¯å¦è¾¾æˆçš„<strong>ç¬¬ä¸€ä¸ªï¼Œä¹Ÿæ˜¯æœ€å¿«çš„åé¦ˆå·¥å…·</strong>ã€‚</p><p>å½“ä½ è¯•å›¾ä¸ºä¸€ä¸ªæ¨¡å—ï¼ˆä¸€ä¸ªå‡½æ•°æˆ–ä¸€ä¸ªç±»ï¼‰ç¼–å†™å•å…ƒæµ‹è¯•æ—¶ï¼Œå¦‚æœå‘ç°æµ‹è¯•å¾ˆéš¾å†™ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªæ˜ç¡®çš„è®¾è®¡ç¼ºé™·ä¿¡å·ã€‚éš¾å†™é€šå¸¸æ„å‘³ç€è¯¥æ¨¡å—<strong>ä¾èµ–äº†è¿‡å¤šå…·ä½“å®ç°</strong>ï¼ˆé«˜è€¦åˆï¼‰ï¼Œè€Œä¸æ˜¯ä¾èµ–æŠ½è±¡ï¼ˆæ¥å£ï¼‰ã€‚ä¾‹å¦‚ï¼Œä½ ä¸ºäº†æµ‹è¯•<code>A</code>ï¼Œä¸å¾—ä¸å»å®ä¾‹åŒ–<code>B</code>ã€<code>C</code>ã€<code>D</code> ç­‰å¤šä¸ªçœŸå®å¯¹è±¡ã€‚</p><p>ä¸ºäº†ä½¿ <code>A</code>å˜å¾—å¯æµ‹è¯•ï¼Œå·¥ç¨‹å¸ˆ<strong>è¢«è¿«</strong>ä½¿ç”¨<code>æŠ½è±¡</code>å¿ƒæ³•å’Œ<code>ä¾èµ–å€’ç½®</code>ï¼ˆæœ¯ï¼‰ã€‚ä¸å†è®©<code>A</code> ç›´æ¥ä¾èµ– <code>B</code>ï¼Œè€Œæ˜¯ä¾èµ–ä¸€ä¸ª <code>IB</code>æ¥å£ã€‚è¿™æ ·ï¼Œåœ¨æµ‹è¯•ä¸­å°±å¯ä»¥ä¼ å…¥ä¸€ä¸ªæ¨¡æ‹Ÿï¼ˆMockï¼‰çš„ <code>B</code>ã€‚</p><p>è¿™ä¸ªæ—¶å€™ï¼Œå•å…ƒæµ‹è¯•åå‘å¼ºè¿«å·¥ç¨‹å¸ˆåœ¨è®¾è®¡æ—¶å°±å¿…é¡»éµå®ˆ"ä½è€¦åˆ"å’Œ"å¼ºæŠ½è±¡"çš„å¿ƒæ³•å’Œæœ¯ã€‚</p><p><strong>2. å®ƒæ˜¯å°è£…å’Œé‡æ„çš„å®‰å…¨ä¿éšœ</strong></p><p>è½¯ä»¶çš„å¤æ‚åº¦ä¼šéšæ—¶é—´è…åŒ–ã€‚å°è£…ï¼ˆ<code>æŠ½è±¡</code>å¿ƒæ³•ï¼‰çš„ç›®çš„æ˜¯éšè—å†…éƒ¨å®ç°ï¼Œä»¥ä¾¿æœªæ¥å¯ä»¥å®‰å…¨åœ°ä¿®æ”¹å®ƒã€‚å•å…ƒæµ‹è¯•æ˜¯å®ç°è¿™ä¸€ç›®æ ‡çš„<strong>å®‰å…¨ä¿éšœ</strong>ã€‚</p><p>å½“ä¸€ä¸ªæ¨¡å—æ‹¥æœ‰å®Œå¤‡çš„å•å…ƒæµ‹è¯•è¦†ç›–æ—¶ï¼Œå·¥ç¨‹å¸ˆï¼ˆå°¤å…¶æ˜¯æ–°æ¥æ‰‹çš„å·¥ç¨‹å¸ˆï¼‰è·å¾—äº†<strong>é‡æ„çš„ä¿¡å¿ƒ</strong>ã€‚ä»–ä»¬å¯ä»¥<strong>å¤§èƒ†åœ°</strong>ä¿®æ”¹æ¨¡å—çš„å†…éƒ¨å®ç°ï¼ˆä¾‹å¦‚ä¼˜åŒ–ç®—æ³•ã€æ›´æ¢æ•°æ®ç»“æ„ï¼‰ï¼Œè€Œ<strong>æ— éœ€</strong>åœ¨è®¤çŸ¥ä¸Šæ‰¿è½½è¯¥æ¨¡å—çš„å…¨éƒ¨å†å²é€»è¾‘ã€‚</p><p>åªè¦åœ¨é‡æ„åï¼Œæ‰€æœ‰çš„å•å…ƒæµ‹è¯•ä¾ç„¶é€šè¿‡ï¼Œå·¥ç¨‹å¸ˆå°±èƒ½è·å¾—æå¤§çš„ä¿¡å¿ƒâ€”â€”<strong>å†…éƒ¨å®ç°è¢«ä¼˜åŒ–äº†ï¼Œä½†å¤–éƒ¨æ‰¿è¯ºæœªè¢«ç ´å</strong>ã€‚è¿™ä»æ ¹æœ¬ä¸ŠæŠ‘åˆ¶äº†ä»£ç çš„è…åŒ–ï¼Œç®¡ç†äº†ç»´æŠ¤çš„å¤æ‚åº¦ã€‚</p><p><strong>3. å®ƒæ˜¯æ¨¡å—è¾¹ç•Œçš„ç²¾ç¡®å®šä¹‰</strong></p><p>æ–‡æ¡£ä¼šè¿‡æ—¶ï¼Œä½†ä»£ç ä¸ä¼šã€‚å•å…ƒæµ‹è¯•æ˜¯ä¸€ç§<strong>å¯æ‰§è¡Œçš„ã€æ´»çš„æ–‡æ¡£</strong>ã€‚</p><p>ä¸€ä¸ªå†™å¾—å¥½çš„æµ‹è¯•ç”¨ä¾‹ï¼ˆä¾‹å¦‚<code>Test_Login_Fails_When_Password_Incorrect</code>ï¼‰ï¼Œå®ƒä»¥ä»£ç çš„å½¢å¼ï¼Œ<strong>ç²¾ç¡®åœ°ã€æ— æ­§ä¹‰åœ°</strong>å®šä¹‰äº†ç™»å½•æ¨¡å—è¿™ä¸ªæŠ½è±¡åœ¨ç‰¹å®šè¾“å…¥ä¸‹çš„è¡Œä¸ºè¾¹ç•Œã€‚</p><p>å•å…ƒæµ‹è¯•æ˜¯ç†è§£ä¸€ä¸ªæ¨¡å—åŠŸèƒ½å’Œæ¥å£æ‰¿è¯ºçš„æœ€å¿«ã€æœ€å‡†ç¡®çš„é€”å¾„ï¼Œå®ƒæå¤§åœ°é™ä½äº†æ–°æˆå‘˜ç†è§£ç³»ç»Ÿçš„è®¤çŸ¥å¤æ‚åº¦ã€‚</p><h2 id="å¯è§‚æµ‹æ€§">å¯è§‚æµ‹æ€§</h2><p>å•å…ƒæµ‹è¯•åœ¨æœ¬åœ°æ˜¯å®Œç¾çš„ï¼Œä½†å®ƒå¯¹è¿è¡Œæ—¶çš„åŠ¨æ€å¤æ‚åº¦åˆ™æ— èƒ½ä¸ºåŠ›ã€‚å½“ 1000ä¸ªé€šè¿‡äº†å•å…ƒæµ‹è¯•çš„å¾®æœåŠ¡ï¼ˆæ¨¡å—ï¼‰è¢«éƒ¨ç½²åˆ°ç½‘ç»œä¸Šæ—¶ï¼Œå®ƒä»¬äº¤äº’æ‰€äº§ç”Ÿçš„æ¶Œç°è¡Œä¸ºï¼Œæ˜¯å•å…ƒæµ‹è¯•æ— æ³•è¦†ç›–çš„ã€‚</p><p>åœ¨æˆ‘çœ‹æ¥ï¼Œå¯è§‚æµ‹æ€§ä¸€èˆ¬åŒ…å« <code>metrics</code>ã€<code>trace</code>å’Œ <code>logs</code> ä¸‰å¤§éƒ¨åˆ†ã€‚</p><table><colgroup><col style="width: 4%" /><col style="width: 13%" /><col style="width: 81%" /></colgroup><thead><tr><th>ç»„ä»¶</th><th>æ ¸å¿ƒ</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>metrics</td><td>å¸®åŠ©ä½ åˆ¤æ–­æ˜¯å¦æœ‰é—®é¢˜</td><td>ç»Ÿè®¡åŸ‹ç‚¹ï¼ŒåŒ…æ‹¬ç³»ç»Ÿç›‘æ§ã€æœåŠ¡ç›‘æ§ã€ä¸šåŠ¡ç›‘æ§ã€‚</td></tr><tr><td>trace</td><td>å‘Šè¯‰ä½ é—®é¢˜åœ¨å“ªé‡Œ</td><td>å®ç°é“¾è·¯è¿½è¸ªï¼Œå±•ç¤ºç³»ç»Ÿæ‹“æ‰‘å›¾ï¼Œæ¢³ç†æœåŠ¡è°ƒç”¨é“¾è·¯ï¼Œæ´å¯Ÿæ€§èƒ½ç“¶é¢ˆç‚¹ã€‚</td></tr><tr><td>logs</td><td>å¸®åŠ©ä½ å®šä½åˆ°é—®é¢˜æ ¹æº</td><td>åˆ¶å®šæ—¥å¿—è§„èŒƒï¼Œå°†è§„èŒƒçŒè¾“åˆ°æ—¥å¸¸å¼€å‘çš„è®¤çŸ¥ä¹ æƒ¯ä¸­ï¼Œå°è¯•å°†éƒ¨åˆ†è§„èŒƒé›†æˆåˆ°æ—¥å¿—ç»„ä»¶ä¸­ï¼Œæ‰“æ›´æœ‰æ„ä¹‰çš„æ—¥å¿—ï¼Œæé«˜é—®é¢˜æ’æŸ¥æ•ˆç‡ã€‚</td></tr></tbody></table><p>åˆ©ç”¨å¥½è¿™ 3 ä¸ªç»„ä»¶ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬ï¼š</p><ol type="1"><li><p>å‡ºç°é—®é¢˜æ—¶ï¼Œæé«˜é—®é¢˜æ’æŸ¥æ•ˆç‡ã€‚</p></li><li><p>é—®é¢˜å¿«æ¥æ—¶ï¼Œæä¾›å…¨å±€è§†é‡ï¼Œæä¾›é¢„çŸ¥é—®é¢˜çš„èƒ½åŠ›ã€‚</p></li><li><p>é—®é¢˜æ²¡å‡ºç°æ—¶ï¼Œæé«˜å¼€å‘è´¨é‡ï¼Œå‡å°‘é—®é¢˜ã€‚</p></li></ol><h3 id="å¯è§‚æµ‹æ€§çš„ä½œç”¨">å¯è§‚æµ‹æ€§çš„ä½œç”¨</h3><p>å…·ä½“æ¥è¯´ï¼Œå¯è§‚æµ‹æ€§åœ¨ä¸‰ä¸ªå±‚é¢ä¸Šç®¡ç†äº†åŠ¨æ€å¤æ‚åº¦ã€‚</p><p><strong>1. å®ƒæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„äº¤äº’å¯è§†åŒ–å·¥å…·</strong></p><p>åœ¨æ¨¡å—åŒ–çš„æ¶æ„ä¸­ï¼Œç³»ç»Ÿæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼é»‘ç›’ã€‚ä»»ä½•ä¸€ä¸ªè¯·æ±‚éƒ½å¯èƒ½è·¨è¶Šå‡ åä¸ªæ¨¡å—ï¼ˆæœåŠ¡ï¼‰ã€‚å•ä¸ªæ¨¡å—ï¼ˆå·²é€šè¿‡å•å…ƒæµ‹è¯•ï¼‰æ˜¯æ­£ç¡®çš„ï¼Œä½†å®ƒä»¬ç»„åˆè¿è¡Œæ—¶çš„äº¤äº’å¯èƒ½å¯¼è‡´<strong>æ€§èƒ½ç“¶é¢ˆ</strong>ã€<strong>çº§è”å¤±è´¥</strong>æˆ–<strong>æ•°æ®ä¸ä¸€è‡´</strong>ã€‚</p><p><strong>åˆ†å¸ƒå¼è¿½è¸ª (Tracing)</strong>æä¾›äº†è¯·æ±‚çº§çš„å¯è§†åŒ–ã€‚å®ƒèƒ½ç²¾ç¡®åœ°æç»˜å‡ºä¸€ä¸ªè¯·æ±‚ä» <code>Service-A</code>åˆ° <code>Service-B</code> å†åˆ° <code>Service-C</code>çš„å®é™…è·¯å¾„å’Œè€—æ—¶åˆ†å¸ƒã€‚å®ƒå°†é»‘ç›’çš„åŠ¨æ€äº¤äº’å¤æ‚åº¦ï¼Œé™ç»´ä¸ºä¸€å¼ æ¸…æ™°çš„ç€‘å¸ƒå›¾æˆ–ä¾èµ–æ‹“æ‰‘å›¾ï¼Œä½¿å·¥ç¨‹å¸ˆèƒ½<strong>å®šä½</strong>æ¶Œç°å‡ºçš„æ€§èƒ½ç“¶é¢ˆæˆ–é”™è¯¯è·¯å¾„ã€‚</p><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/d20fefdb-e245-4b5a-ad23-ebef7ed07633.original.png" /></p><p><strong>2. å®ƒæ˜¯è®¾è®¡æƒè¡¡çš„è¿è¡Œæ—¶æ•°æ®</strong></p><p>æˆ‘ä»¬æ‰€æœ‰çš„å¿ƒæ³•ï¼ˆ<code>æŠ½è±¡</code>ã€<code>åˆ†æ²»</code>ã€<code>åˆ†å±‚</code>ã€<code>æ¨¡å—åŒ–</code>ï¼‰éƒ½æ˜¯æœ‰<strong>æ€§èƒ½ä»£ä»·</strong>çš„ã€‚åˆ†å±‚å¸¦æ¥äº†æ•°æ®å¤åˆ¶çš„ä»£ä»·ï¼›æ¨¡å—åŒ–å¸¦æ¥äº†ç½‘ç»œè°ƒç”¨çš„ä»£ä»·ï¼›æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆæŠ½è±¡ï¼‰å¸¦æ¥äº†å»¶è¿Ÿçš„ä»£ä»·ã€‚</p><p><strong>æŒ‡æ ‡ (Metrics)</strong>æä¾›äº†<strong>é‡åŒ–</strong>è¿™äº›ä»£ä»·çš„æ•°æ®ã€‚ä¾‹å¦‚ P99 å»¶è¿Ÿã€GCå‹åŠ›ã€é˜Ÿåˆ—æ·±åº¦ä¼šç²¾ç¡®åœ°å‘Šè¯‰ä½ ï¼š"ä½ ä¸ºè¿™ä¸ªåˆ†å±‚ä»˜å‡ºäº† 30% çš„ GCé¢å¤–å¼€é”€"ï¼Œ"ä½ ä¸ºè¿™ä¸ªæ¨¡å—åŒ–ï¼ˆå¾®æœåŠ¡è°ƒç”¨ï¼‰ä»˜å‡ºäº† 40ms çš„ P99 å»¶è¿Ÿ"ã€‚</p><p><strong>å¯è§‚æµ‹æ€§æä¾›äº†è¿è¡Œæ—¶çš„çœŸå®æ•°æ®ï¼Œä½¿è®¾è®¡æƒè¡¡ï¼ˆTrade-offï¼‰ä»æ‹è„‘è¢‹å˜æˆäº†æ•°æ®é©±åŠ¨</strong>ã€‚å·¥ç¨‹å¸ˆå¯ä»¥åŸºäºæ•°æ®ï¼Œå†³å®šä½•æ—¶æ‰“ç ´åˆ†å±‚ï¼ˆä¾‹å¦‚åˆå¹¶DTO å’Œ Modelï¼‰æˆ–åˆå¹¶æ¨¡å—ï¼ˆä¾‹å¦‚åˆå¹¶å¾®æœåŠ¡ï¼‰ä»¥æ¢å–æ€§èƒ½ã€‚</p><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/apm_vs_dt_metrics.webp" /></p><p><strong>3. å®ƒæ˜¯æœªçŸ¥é—®é¢˜çš„ä¸Šä¸‹æ–‡</strong></p><p>å•å…ƒæµ‹è¯•åªèƒ½éªŒè¯å·²çŸ¥ï¼ˆKnownï¼‰çš„åœºæ™¯ã€‚è€Œç³»ç»Ÿåœ¨çœŸå®è¿è¡Œæ—¶ï¼Œä¼šé‡åˆ°å¤§é‡æœªçŸ¥ï¼ˆUnknownï¼‰çš„ã€æ¶Œç°çš„å¤æ‚é—®é¢˜ã€‚</p><p><strong>æ—¥å¿—(Logs)</strong>ï¼Œå°¤å…¶æ˜¯ç»“æ„åŒ–å’Œé«˜åŸºæ•°çš„æ—¥å¿—ï¼Œæä¾›äº†é«˜ç»´åº¦çš„<strong>ä¸Šä¸‹æ–‡</strong>ã€‚</p><p>å½“é»‘å¤©é¹…äº‹ä»¶ï¼ˆä¾‹å¦‚é«˜å¹¶å‘+ç‰¹å®šç½‘ç»œåˆ†åŒºï¼‰å‘ç”Ÿæ—¶ï¼Œåªæœ‰<code>Traces</code>ã€<code>Metrics</code> å’Œ <code>Logs</code>ç»“åˆï¼Œæ‰èƒ½æä¾›è¶³å¤Ÿçš„<strong>ç°åœºä¿¡æ¯</strong>ï¼Œè®©å·¥ç¨‹å¸ˆèƒ½äº‹åå›æº¯ã€å®šä½å’Œç†è§£é‚£äº›å•å…ƒæµ‹è¯•æ°¸è¿œæ— æ³•å¤ç°çš„åŠ¨æ€å¤æ‚åº¦ã€‚</p><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/p699774.png" /></p><h3 id="å¯è§‚æµ‹æ€§çš„æœ¬è´¨">å¯è§‚æµ‹æ€§çš„æœ¬è´¨</h3><p>å¯è§‚æµ‹æ€§åˆ°åº•åœ¨è§‚æµ‹ä»€ä¹ˆï¼Ÿ<u>æˆ‘ä»¬è§‚æµ‹çš„æ˜¯ä¸€ä¸ªç³»ç»Ÿï¼ˆå°¤å…¶æ˜¯æ¨¡å—åŒ–å’Œåˆ†å±‚åçš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼‰åœ¨è¿è¡Œæ—¶æ‰€æ¶Œç°å‡ºçš„ã€ä¸å¯é¢„æµ‹çš„åŠ¨æ€å¤æ‚åº¦ã€‚</u></p><p>æˆ‘ä»¬è§‚æµ‹çš„ä¸æ˜¯å·¥å…·ï¼ˆmetricsã€traceã€logsï¼‰ï¼Œè€Œæ˜¯ç³»ç»Ÿåœ¨çœŸå®å‹åŠ›ä¸‹çš„ï¼š</p><ol type="1"><li>å¤–åœ¨è¡Œä¸º (External Behavior)</li><li>å†…åœ¨çŠ¶æ€ (Internal State)</li><li>äº¤äº’å…³ç³» (Interactions)</li></ol><p><strong>1. è§‚æµ‹å¤–åœ¨è¡Œä¸ºï¼šç³»ç»Ÿåœ¨åšä»€ä¹ˆï¼Ÿ</strong></p><p>è¿™æ˜¯ä»å¤–éƒ¨çœ‹ï¼Œæˆ‘ä»¬çš„æ¨¡å—ï¼ˆæœåŠ¡ï¼‰æ‰€æ‰¿è¯ºçš„æ¥å£ï¼ˆåŠŸèƒ½ï¼‰æ˜¯å¦æ­£å¸¸ã€‚è¿™é€šå¸¸å¯¹åº”Google SRE çš„é»„é‡‘å››ä¿¡å·ä¸­çš„å‰ä¸‰ä¸ªã€‚</p><ul><li><strong>å»¶è¿Ÿ (Latency)</strong>ï¼šä¸€ä¸ªæŠ½è±¡çš„æ¥å£ï¼ˆå¦‚APIï¼‰å®Œæˆå®ƒçš„æ‰¿è¯ºéœ€è¦å¤šé•¿æ—¶é—´ï¼Ÿè¿™æ˜¯<strong>æ€§èƒ½</strong>çš„ç›´æ¥ä½“ç°ã€‚</li><li><strong>æµé‡(Traffic)</strong>ï¼šæœ‰å¤šå°‘è¯·æ±‚æˆ–ä»»åŠ¡æ­£åœ¨å‹å‘æœåŠ¡ï¼Ÿè¿™æ˜¯<strong>è´Ÿè½½</strong>çš„ç›´æ¥ä½“ç°ã€‚</li><li><strong>é”™è¯¯ (Errors)</strong>ï¼šæœ‰å¤šå°‘æ‰¿è¯ºæ²¡æœ‰è¢«å…‘ç°ï¼ˆä¾‹å¦‚ HTTP500ï¼‰ï¼Ÿè¿™æ˜¯<strong>æ­£ç¡®æ€§</strong>çš„ç›´æ¥ä½“ç°ã€‚</li></ul><p><strong>2. è§‚æµ‹å†…åœ¨çŠ¶æ€ï¼šç³»ç»ŸèŠ±å¤šå¤§ä»£ä»·åœ¨åšï¼Ÿ</strong></p><p>è¿™æ˜¯ä»å†…éƒ¨çœ‹ï¼Œæˆ‘ä»¬çš„æ¨¡å—ï¼ˆæœåŠ¡ï¼‰ä¸ºäº†å®Œæˆä¸Šè¿°å¤–åœ¨è¡Œä¸ºï¼Œ<strong>å†…éƒ¨</strong>çš„èµ„æºå’ŒçŠ¶æ€æ˜¯ä»€ä¹ˆæ ·çš„ã€‚</p><ul><li><strong>é¥±å’Œåº¦ (Saturation)</strong>ï¼šä¾‹å¦‚ï¼ŒCPUä½¿ç”¨ç‡ã€å†…å­˜å ç”¨ã€ç£ç›˜I/Oã€è¿æ¥æ± å¤§å°ã€é˜Ÿåˆ—ï¼ˆKafkaï¼‰çš„ç§¯å‹é•¿åº¦ã€‚è¿™æ˜¯<strong>å®¹é‡</strong>å’Œ<strong>å¥åº·åº¦</strong>çš„ç›´æ¥ä½“ç°ã€‚ä¸€ä¸ªå¤–åœ¨è¡Œä¸ºçœ‹èµ·æ¥æ­£å¸¸ï¼ˆä¾‹å¦‚å»¶è¿Ÿä½ï¼‰ï¼Œä½†å…¶å†…éƒ¨çŠ¶æ€å¯èƒ½å·²ç»å¤„äºå´©æºƒè¾¹ç¼˜ï¼ˆä¾‹å¦‚é˜Ÿåˆ—ç§¯å‹99%ï¼‰ã€‚</li><li><strong>å…³é”®ä¸šåŠ¡æŒ‡æ ‡ (BusinessMetrics)</strong>ï¼šä¾‹å¦‚ï¼Œè®¢å•åˆ›å»ºæ•°ã€æ”¯ä»˜æˆåŠŸç‡ã€ç”¨æˆ·æ³¨å†Œæ•°ã€‚è¿™è¿æ¥äº†æŠ€æœ¯å¤æ‚åº¦ä¸<strong>ä¸šåŠ¡ä»·å€¼</strong>ã€‚</li></ul><p><strong>3. è§‚æµ‹äº¤äº’å…³ç³»ï¼šè¡Œä¸ºå’ŒçŠ¶æ€æ˜¯å¦‚ä½•å…³è”çš„ï¼Ÿ</strong></p><p>åŠ¨æ€å¤æ‚åº¦çš„æ ¹æºåœ¨äº<strong>â€œäº¤äº’â€</strong>â€”â€”<code>æ¨¡å—A</code> è°ƒç”¨<code>æ¨¡å—B</code>ï¼Œ<code>B</code> å†è°ƒç”¨<code>C</code>ã€‚å½“ä¸‹å•è¿™ä¸ªè¡Œä¸ºå˜æ…¢æ—¶ï¼Œæˆ‘ä»¬<strong>å¿…é¡»</strong>è§‚æµ‹è¿™ä¸ªäº¤äº’é“¾æ¡ã€‚</p><ul><li><strong>ä¸Šä¸‹æ–‡çš„ä¼ æ’­</strong>ï¼šè§‚æµ‹ä¸€ä¸ªè¯·æ±‚<strong>å¦‚ä½•ç©¿é€</strong>æŠ½è±¡è¾¹ç•Œã€æ¨¡å—è¾¹ç•Œå’Œåˆ†å±‚è¾¹ç•Œã€‚è¿™å°±æ˜¯<code>TraceID</code> æ‰€åšçš„å·¥ä½œã€‚</li><li><strong>é«˜åŸºæ•°çš„ä¸Šä¸‹æ–‡</strong>ï¼šæˆ‘ä»¬ä¸ä»…è§‚æµ‹<code>Latency = 500ms</code>ï¼Œæˆ‘ä»¬è§‚æµ‹çš„æ˜¯ï¼š<code>Latency&#123;service="payment", user_id="12345", region="eu-west", error="true"&#125;</code>ã€‚è¿™å…è®¸æˆ‘ä»¬äº‹åå»æ¢ç´¢é‚£äº›"<strong>æœªçŸ¥çš„æœªçŸ¥</strong>"ã€‚ä¾‹å¦‚ï¼šä¸ºä»€ä¹ˆåªæœ‰<code>eu-west</code> åœ°åŒºçš„ <code>VIP</code> ç”¨æˆ·çš„æ”¯ä»˜è¡Œä¸ºä¼šå¤±è´¥ï¼Ÿ</li></ul><h3 id="å¯è§‚æµ‹æ€§çš„æ–¹æ¡ˆ">å¯è§‚æµ‹æ€§çš„æ–¹æ¡ˆ</h3><p>å¯¹äºè½åœ°å¯è§‚æµ‹æ€§ï¼Œæˆ‘çš„å»ºè®®æ˜¯å°½å¯èƒ½æ‹¥æŠ±OpenTelemetryï¼Œå®ƒå¯ä»¥è¯´æ˜¯ç›®å‰ä¸šç•Œçš„å”¯ä¸€æ ‡å‡†ã€‚ä¸è¦è‡ªå·±å»é€ è½®å­ï¼Œä¸è¦åœ¨è‡ªå·±çš„ä¸šåŠ¡é¡¹ç›®ä¸­å»"åˆ›é€ "ä¸€ä¸ªè‡ªå·±çš„traceIDï¼Œå»æ‹¥æŠ±å¼€æºæ ‡å‡†ï¼Œä½ ä¼šäº«å—åˆ°å®ƒçš„å¼ºå¤§å’Œéå†ã€‚</p><p>æˆ‘åœ¨å·¥ä½œè¿‡ç¨‹ä¸­ï¼Œå¼€æºäº†ä¸€å¥— Goè¯­è¨€çš„å¯è§‚æµ‹æ€§æ–¹æ¡ˆï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯å‚è€ƒï¼š<ahref="https://github.com/hedon954/goapm">goapm</a>ã€‚</p><h1 id="æ€»ç»“-1">æ€»ç»“</h1><p>è¡Œæ–‡è‡³æ­¤ï¼Œæˆ‘ä»¬å®Œæ•´åœ°æ„å»ºäº†"ç®¡ç†å¤æ‚åº¦"çš„"é“ã€æ³•ã€æœ¯ã€å™¨"å››å±‚ä½“ç³»ã€‚</p><p>æˆ‘ä»¬ä»"é“"å‡ºå‘ï¼Œæ˜ç¡®äº†è½¯ä»¶å·¥ç¨‹çš„ç»ˆæç›®æ ‡â€”â€”å¯¹æŠ—"å¤æ‚åº¦"è¿™å”¯ä¸€ä¸”æ ¹æœ¬çš„æ•Œäººã€‚æˆ‘ä»¬äº²å†çš„"å±å±±"ã€é‚£äº›"é¾™å·é£æˆ˜æœ¯"ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯å¤æ‚åº¦å¤±æ§åçš„"ç†µå¢"è¡¨è±¡ã€‚</p><p>ä¸ºäº†å¯¹æŠ—"ç†µå¢"ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†"æ³•"â€”â€”æŠ½è±¡ã€åˆ†æ²»ã€åˆ†å±‚ã€æ¨¡å—åŒ–ã€‚è¿™ä¸æ˜¯ç©ºæ´çš„ç†è®ºï¼Œè€Œæ˜¯æ— æ•°å‰è¾ˆæ€»ç»“å‡ºçš„ã€åº”å¯¹"è®¤çŸ¥å±€é™"è¿™ä¸€ä¸å˜çº¦æŸçš„å››å¤§â€œä¸å˜æ³•åˆ™â€ã€‚å®ƒä»¬æ˜¯æˆ‘ä»¬çš„ç¬¬ä¸€æ€§åŸç†ï¼Œæ˜¯æˆ‘ä»¬æ„å»ºä¸€åˆ‡â€œæœ¯â€çš„åŸºçŸ³ã€‚</p><p>"æœ¯"æ˜¯æˆ‘ä»¬æ‰‹ä¸­çš„"æ‹›å¼"ä¸"å¥—è·¯"ã€‚æ— è®ºæ˜¯SOLIDã€è®¾è®¡æ¨¡å¼ï¼Œè¿˜æ˜¯å®è§‚çš„æ¶æ„æ¨¡å¼ä¸DDDï¼Œå®ƒä»¬éƒ½æ˜¯"æ³•"åœ¨ç‰¹å®šåœºæ™¯ä¸‹çš„å…·è±¡åŒ–åº”ç”¨ã€‚å®ƒä»¬æ˜¯"æ³•"çš„å®è·µå·¥å…·ç®±ï¼Œæ˜¯ç¡®ä¿æˆ‘ä»¬çš„â€œæ‹›å¼â€ä¸èµ°å½¢ã€æœ‰æ®å¯ä¾çš„â€œæˆ˜æ³•â€ã€‚</p><p>æœ€åï¼Œæˆ‘ä»¬å¿…é¡»æ‹¥æœ‰"å™¨"â€”â€”å•å…ƒæµ‹è¯•ä¸å¯è§‚æµ‹æ€§ã€‚å®ƒä»¬æ˜¯æˆ‘ä»¬æ„å»ºå¤æ‚ç³»ç»Ÿçš„"åŒçœ¼"ã€‚å•å…ƒæµ‹è¯•æ˜¯æˆ‘ä»¬ç®¡ç†"é™æ€å¤æ‚åº¦"çš„æ ‡å°ºï¼Œå®ƒåœ¨"è®¾è®¡æ—¶"å¼ºè¿«æˆ‘ä»¬éµå®ˆ"æ³•"ä¸"æœ¯"ï¼›å¯è§‚æµ‹æ€§æ˜¯æˆ‘ä»¬ç®¡ç†"åŠ¨æ€å¤æ‚åº¦"çš„æ˜é•œï¼Œå®ƒåœ¨"è¿è¡Œæ—¶"ä¸ºæˆ‘ä»¬æ­ç¤º"æ¶Œç°"å‡ºçš„æœªçŸ¥ã€‚æ²¡æœ‰"å™¨"ï¼Œæˆ‘ä»¬æ‰€æœ‰çš„"æ³•"ä¸"æœ¯"éƒ½åªæ˜¯ç›²äººæ‘¸è±¡ã€‚</p><p>å›é¡¾è¿™ä¸‰å¹´çš„å·¥ä½œï¼Œæˆ‘æ›¾æ·±é™·"å±å±±"ï¼Œä¹Ÿæ›¾äº²æ‰‹é€ "å±±"ã€‚æˆ‘æ‰€ç»å†çš„ç—›è‹¦ã€è¿·èŒ«ä¸æŒ£æ‰ï¼Œå…¶æ ¹æºå°±åœ¨äºï¼Œæˆ‘è¯•å›¾ç”¨"æœ¯"ï¼ˆä¾‹å¦‚æŸä¸ªè®¾è®¡æ¨¡å¼ï¼‰å»è§£å†³"é“"ï¼ˆå¤æ‚åº¦å¤±æ§ï¼‰çš„é—®é¢˜ï¼Œå´åˆç¼ºä¹"å™¨"ï¼ˆå¯è§‚æµ‹æ€§ï¼‰æ¥åº¦é‡ç»“æœã€‚</p><p>è¿™ç¯‡å¤ç›˜ï¼Œä¾¿æ˜¯æˆ‘ä¸ºé‚£æ®µç»å†å¯»æ‰¾çš„ç­”æ¡ˆã€‚</p><p>"é“ã€æ³•ã€æœ¯ã€å™¨"ä¸æ˜¯ä¸€ä¸ªéœ€è¦èƒŒè¯µçš„æ¸…å•ï¼Œå®ƒæ˜¯ä¸€ä¸ª<strong>å®Œæ•´çš„ã€è‡ªæ´½çš„ã€å¾ªç¯åé¦ˆçš„ä½œæˆ˜ä½“ç³»</strong>ã€‚å®ƒå®šä¹‰äº†ä¸€ä¸ªè½¯ä»¶å·¥ç¨‹å¸ˆä»â€œç¼–ç â€èµ°å‘â€œå·¥ç¨‹â€çš„å¿…ç»ä¹‹è·¯ã€‚</p><p>ç†è§£è¿™å¥—ä½“ç³»ï¼Œä¸æ˜¯ä¸ºäº†åœ¨â€œå±å±±â€ä¸Šâ€œé›•èŠ±â€ï¼Œè€Œæ˜¯ä¸ºäº†è®©æˆ‘ä»¬åœ¨é¢å¯¹ä¸‹ä¸€ä¸ª"ç´§æ€¥"éœ€æ±‚ã€ä¸‹ä¸€æ¬¡"é¾™å·é£æˆ˜æœ¯"æ—¶ï¼Œæ‹¥æœ‰<strong>æ‹’ç»â€œç†µå¢â€çš„æ­¦å™¨å’Œåº•æ°”</strong>ã€‚</p><h1 id="ai-æ—¶ä»£ä¸‹é“æ³•æœ¯å™¨çš„è¿›åŒ–">AI æ—¶ä»£ä¸‹é“æ³•æœ¯å™¨çš„è¿›åŒ–</h1><p>å¯¹äºç®¡ç†å¤æ‚åº¦è¿™ä¸€è¯é¢˜ï¼Œæˆ‘ä¸æƒ³æ­¢æ­¥äºæ­¤ï¼Œæˆ‘æƒ³å¤šæ€è€ƒä¸€ä¸‹ï¼š</p><blockquote><p>[!CAUTION]</p><p>åœ¨ AI æ—¶ä»£ä¸‹çš„ AIåº”ç”¨å¼€å‘ä¸­ï¼Œè½¯ä»¶å·¥ç¨‹è¿˜æœ‰å­˜åœ¨çš„æ„ä¹‰å—ï¼Ÿå®ƒçš„é“æ³•æœ¯å™¨æœ‰ä»€ä¹ˆå˜åŒ–å—ï¼Ÿ</p></blockquote><p>æˆ‘çš„ç»“è®ºæ˜¯ï¼š</p><blockquote><p>[!IMPORTANT]</p><p>AI åº”ç”¨å¼€å‘ï¼Œå®ƒé¦–å…ˆæ˜¯ä¸€ä¸ªè½¯ä»¶å·¥ç¨‹é—®é¢˜ï¼Œç„¶åæ‰æ˜¯ä¸€ä¸ª AIé—®é¢˜ã€‚è½¯ä»¶å·¥ç¨‹çš„åœ°ä½ä¾æ—§æ— å¯æ’¼åŠ¨ï¼Œå¹¶ä¸”å®ƒç®¡ç†å¤æ‚åº¦çš„"é“"å¹¶æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œä½†æ˜¯"æ³•"ã€"æœ¯"å’Œ"å™¨"å¿…é¡»è¿›åŒ–ï¼Œä»¥åº”å¯¹æ–°çš„å˜åŒ–å’ŒæŒ‘æˆ˜ã€‚</p></blockquote><p>åœ¨ AI æ—¶ä»£ï¼Œå°¤å…¶æ˜¯å¤§æ¨¡å‹ (LLM)æ—¶ä»£ï¼Œ<strong>æŠ½è±¡ã€åˆ†æ²»ã€åˆ†å±‚ã€æ¨¡å—åŒ–</strong>è¿™å››å¤§æ³•åˆ™ä¸ä»…æ²¡æœ‰è¿‡æ—¶ï¼Œåè€Œå˜å¾—<strong>å‰æ‰€æœªæœ‰åœ°é‡è¦</strong>ã€‚å› ä¸ºAI å¼•å…¥äº†ä¸€ç§å…¨æ–°çš„ã€æ›´æ£˜æ‰‹çš„å¤æ‚åº¦ï¼š<strong>éç¡®å®šæ€§ (Non-Determinism)å¤æ‚åº¦</strong>ã€‚</p><p>ä¼ ç»Ÿçš„è½¯ä»¶å·¥ç¨‹å¯¹æŠ—çš„æ˜¯<strong>é€»è¾‘å¤æ‚åº¦</strong>ï¼ˆ"If-Then-Else"çš„å¤æ‚åº¦ï¼‰ã€‚ AI æ—¶ä»£çš„è½¯ä»¶å·¥ç¨‹å¯¹æŠ—çš„æ˜¯<strong>é€»è¾‘å¤æ‚åº¦ +éç¡®å®šæ€§å¤æ‚åº¦</strong>ï¼ˆé»‘ç›’æ¨¡å‹ã€æ¦‚ç‡æ€§è¾“å‡ºã€æ•°æ®ä¾èµ–ï¼‰ã€‚</p><h2 id="é“çš„è¿›åŒ–ä»ç®¡ç†åˆ°é©¾é©­">é“çš„è¿›åŒ–ï¼šä»ç®¡ç†åˆ°é©¾é©­</h2><p>AI æ—¶ä»£çš„è½¯ä»¶å·¥ç¨‹ï¼Œé“ä¾ç„¶æ˜¯<strong>ç®¡ç†å¤æ‚åº¦</strong>ã€‚ä½† AIæ—¶ä»£ï¼Œå¤æ‚åº¦æœ¬èº«å‘ç”Ÿäº†æ ¹æœ¬æ€§çš„å˜åŒ–ã€‚</p><ul><li><strong>æ—§çš„å¤æ‚åº¦</strong>ï¼šæ˜¯<strong>ç¡®å®šæ€§</strong>çš„ã€‚æºäºæˆ‘ä»¬è‡ªå·±ä»£ç ä¸­ç»„ä»¶é—´ä¾èµ–å…³ç³»çš„æ•°é‡ã€‚å®ƒæ˜¯å¯è¢«æ¨å¯¼çš„ï¼Œåªæ˜¯è¿‡äºåºå¤§ã€‚</li><li><strong>æ–°çš„å¤æ‚åº¦</strong>ï¼šæ˜¯<strong>éç¡®å®šæ€§</strong>å’Œ<strong>æ¶Œç°æ€§</strong>çš„ã€‚æºäºLLMè¿™ä¸ªé»‘ç›’çš„æ¦‚ç‡æ€§æœ¬è´¨ã€‚æˆ‘ä»¬ä»ç®¡ç†"ä»£ç é€»è¾‘"è½¬å‘ç®¡ç†"æ¨¡å‹è¡Œä¸º"ï¼›æˆ‘ä»¬ä»"è°ƒè¯•Bug"è½¬å‘"å¯¹æŠ—å¹»è§‰"ã€‚</li></ul><p>å› æ­¤ï¼Œé“çš„ç›®æ ‡ï¼Œåœ¨"ç®¡ç†å¤æ‚åº¦"ä¹‹å¤–ï¼Œå¢åŠ äº†ä¸¤ä¸ªæ–°çš„ç»´åº¦ï¼š</p><ol type="1"><li><strong>ç®¡ç†éç¡®å®šæ€§</strong>ï¼šæˆ‘ä»¬å¦‚ä½•ä¸º"å±å±±"æ‰¾åˆ°æ ¹æºï¼Ÿæˆ‘ä»¬å¦‚ä½•ä¸º"å¹»è§‰"æ„å»ºæŠ¤æ ï¼Ÿæˆ‘ä»¬å¦‚ä½•ä¸º"æ¦‚ç‡"è®¾è®¡"é‡è¯•"ä¸"æ ¡éªŒ"ï¼Ÿ</li><li><strong>é©¾é©­æ¶Œç°æ€§</strong>ï¼šAI Agentæ‰€å±•ç°çš„è‡ªä¸»è§„åˆ’èƒ½åŠ›æ˜¯ä¸€ç§æ¶Œç°ã€‚æˆ‘ä»¬çš„é“ä¸å†æ˜¯"è‡ªé¡¶å‘ä¸‹"åœ°æ§åˆ¶ä¸€åˆ‡ï¼Œè€Œæ˜¯è‡ªåº•å‘ä¸Šåœ°<strong>å¼•å¯¼</strong>å’Œ<strong>é©¾é©­</strong>è¿™ç§æ¶Œç°èƒ½åŠ›ï¼Œè®©å®ƒåœ¨å¯æ§çš„è¾¹ç•Œå†…è§£å†³é—®é¢˜ã€‚</li></ol><h2id="æ³•çš„è¿›åŒ–ä»é€»è¾‘æŠ½è±¡åˆ°èƒ½åŠ›æŠ½è±¡">æ³•çš„è¿›åŒ–ï¼šä»é€»è¾‘æŠ½è±¡åˆ°èƒ½åŠ›æŠ½è±¡</h2><h3 id="æŠ½è±¡-1">æŠ½è±¡</h3><blockquote><p>[!IMPORTANT]</p><p>ä¸å˜çš„ç¬¬ä¸€æ€§åŸç† â€”â€” éšè—å®ç°ç»†èŠ‚ï¼Œæä¾›ä¸€ä¸ªç®€æ´ã€ç¨³å®šçš„"æ¥å£"ã€‚</p></blockquote><p>ä¼ ç»Ÿçš„æŠ½è±¡éšè—çš„æ˜¯<strong>æ¸…æ™°çš„é€»è¾‘</strong>ï¼ˆä¾‹å¦‚ï¼Œ<code>sort(list)</code>éšè—äº†å¿«æ’çš„å®ç°ï¼‰ã€‚è€Œ AIæ—¶ä»£çš„æŠ½è±¡éœ€è¦éšè—çš„æ˜¯ä¸€ä¸ª<strong>æ¨¡ç³Šçš„ã€æ¦‚ç‡æ€§çš„é»‘ç›’</strong>ï¼ˆä¾‹å¦‚ï¼Œ<code>summarize(text)</code>éšè—äº† LLM å†…éƒ¨ä¸Šåƒäº¿ä¸ªå‚æ•°çš„å¤æ‚æ¨ç†ï¼‰ã€‚</p><p>å®ƒçš„è¿›åŒ–ï¼š</p><ol type="1"><li><strong>ä»åŠŸèƒ½æŠ½è±¡åˆ°èƒ½åŠ›æŠ½è±¡ï¼š</strong><ul><li><em>ä¼ ç»Ÿï¼š</em> æˆ‘ä»¬æŠ½è±¡ä¸€ä¸ªå‡½æ•°(Function)ï¼Œå®ƒæ¥å—ç¡®å®šçš„è¾“å…¥ï¼Œäº§ç”Ÿç¡®å®šçš„è¾“å‡ºï¼ˆä¾‹å¦‚<code>getUser(id)</code>ï¼‰ã€‚</li><li><em>è¿›åŒ–ï¼š</em> æˆ‘ä»¬æŠ½è±¡ä¸€ç§èƒ½åŠ›(Capability)ã€‚ä¾‹å¦‚ï¼Œ<code>OpenAI API</code>æœ¬èº«å°±æ˜¯ä¸€ç§å¼ºå¤§çš„æŠ½è±¡ã€‚æˆ‘ä»¬ä¸å…³å¿ƒå®ƒå†…éƒ¨æ˜¯ Transformer è¿˜æ˜¯MoEï¼Œæˆ‘ä»¬åªå…³å¿ƒå®ƒæš´éœ²äº†æ–‡æœ¬ç”Ÿæˆã€å›¾åƒç†è§£çš„èƒ½åŠ›ã€‚</li></ul></li><li><strong>Prompt æˆä¸ºæ–°çš„ APIï¼š</strong><ul><li><em>ä¼ ç»Ÿï¼š</em> API æ˜¯é€šè¿‡ä¸¥æ ¼çš„å‡½æ•°ç­¾å (Signature) å®šä¹‰çš„ã€‚</li><li><em>è¿›åŒ–ï¼š</em> <strong>Prompt Engineeringæœ¬èº«å°±æ˜¯ä¸€ç§æ–°çš„æŠ½è±¡å®è·µ</strong>ã€‚ä¸€ä¸ªç²¾å¿ƒè®¾è®¡çš„Promptï¼ˆä¾‹å¦‚ï¼Œ"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ³•å¾‹åŠ©æ‰‹ï¼Œè¯·..."ï¼‰å°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ã€æ›´å¯æ§çš„æŠ½è±¡å±‚ï¼Œå®ƒå°†ä¸€ä¸ªé€šç”¨çš„LLMï¼ˆåŸå§‹èƒ½åŠ›ï¼‰æŠ½è±¡æˆäº†ä¸€ä¸ªç‰¹å®šé¢†åŸŸçš„ä¸“å®¶ï¼ˆå°è£…åçš„èƒ½åŠ›ï¼‰ã€‚</li></ul></li><li><strong>ç‰¹å¾å­˜å‚¨æˆä¸ºæ•°æ®æŠ½è±¡ï¼š</strong><ul><li><em>ä¼ ç»Ÿï¼š</em> æˆ‘ä»¬æŠ½è±¡æ•°æ®è®¿é—®å±‚ (DAO / Repository)ã€‚</li><li><em>è¿›åŒ–ï¼š</em> åœ¨ MLOps ä¸­ï¼Œ<strong>Feature Store(ç‰¹å¾å­˜å‚¨)</strong>æˆä¸ºäº†å…³é”®çš„æ•°æ®æŠ½è±¡ã€‚å®ƒå‘æ¨¡å‹è®­ç»ƒå’Œæ¨ç†éšè—äº†æ•°æ®æ¸…æ´—ã€è½¬æ¢ã€èšåˆçš„å¤æ‚ETL è¿‡ç¨‹ã€‚æ¨¡å‹å¼€å‘è€…ï¼ˆé«˜å±‚ï¼‰ä¸å†å…³å¿ƒæ•°æ®ï¼ˆä½å±‚ï¼‰æ˜¯æ¥è‡ª Kafka è¿˜æ˜¯MySQLï¼Œä»–ä»¬åªå…³å¿ƒè·å–<code>user_7day_purchase_amount</code>è¿™ä¸ªè¢«æŠ½è±¡å‡ºæ¥çš„ç‰¹å¾ã€‚</li></ul></li></ol><h3 id="åˆ†æ²»-1">åˆ†æ²»</h3><blockquote><p>[!IMPORTANT]</p><p>ä¸å˜çš„ç¬¬ä¸€æ€§åŸç† â€”â€”å°†ä¸€ä¸ªæ— æ³•ä¸€æ¬¡æ€§è§£å†³çš„å¤§é—®é¢˜ï¼Œåˆ†è§£ä¸ºå¤šä¸ªåŒç±»å‹ã€å¯ç‹¬ç«‹è§£å†³çš„å°é—®é¢˜ï¼Œæœ€åå†åˆå¹¶ã€‚</p></blockquote><p>åœ¨ AI æ—¶ä»£çš„æ–°æŒ‘æˆ˜ä¸€ä¸ªå•ä¸€çš„ã€å·¨å¤§çš„å…¨èƒ½æ¨¡å‹éš¾ä»¥è®­ç»ƒã€éš¾ä»¥è°ƒè¯•ã€æˆæœ¬é«˜æ˜‚ã€‚åŒæ—¶ï¼Œä¸€ä¸ªå¤æ‚çš„ç°å®é—®é¢˜ï¼ˆä¾‹å¦‚å¸®æˆ‘è§„åˆ’ä¸€æ¬¡ä¸œäº¬æ—…è¡Œï¼‰ä¹Ÿè¶…å‡ºäº†å•ä¸ªLLM çš„èƒ½åŠ›èŒƒå›´ã€‚</p><p>å®ƒçš„è¿›åŒ–ï¼š</p><ol type="1"><li><strong>æ¨¡å‹è®­ç»ƒä¸­çš„åˆ†æ²» (MoE)ï¼š</strong><ul><li><em>ä¼ ç»Ÿï¼š</em> å½’å¹¶æ’åºã€MapReduceã€‚</li><li><em>è¿›åŒ–ï¼š</em> <strong>æ··åˆä¸“å®¶æ¨¡å‹ (Mixture of Experts,MoE)</strong> æ˜¯åˆ†æ²»æ€æƒ³åœ¨æ¨¡å‹æ¶æ„ä¸Šçš„æè‡´ä½“ç°ã€‚<ul><li><em>åˆ†è§£ (Divide)ï¼š</em> ä¸è®­ç»ƒä¸€ä¸ª 1.7ä¸‡äº¿å‚æ•°çš„å·¨æ— éœ¸æ¨¡å‹ï¼Œè€Œæ˜¯è®­ç»ƒï¼ˆæ¯”å¦‚ï¼‰ 8 ä¸ª 2000 äº¿å‚æ•°çš„ä¸“å®¶æ¨¡å‹ã€‚</li><li><em>è§£å†³ (Conquer)ï¼š</em> å½“ä¸€ä¸ª Token è¿›æ¥æ—¶ï¼Œä¸€ä¸ªè·¯ç”±å™¨ (GatingNetwork) è´Ÿè´£åˆ¤æ–­è¿™ä¸ªé—®é¢˜è¯¥ç”±å“ªä¸¤ä¸ªä¸“å®¶æ¥è§£å†³ï¼Ÿ</li><li><em>åˆå¹¶ (Combine)ï¼š</em> å°†è¿™ä¸¤ä¸ªä¸“å®¶çš„è¾“å‡ºåŠ æƒåˆå¹¶ã€‚</li></ul></li></ul></li><li><strong>åº”ç”¨æ¶æ„ä¸Šçš„åˆ†æ²» (RAG)ï¼š</strong><ul><li><em>ä¼ ç»Ÿï¼š</em> å¾®æœåŠ¡æ¶æ„ã€‚</li><li><em>è¿›åŒ–ï¼š</em> <strong>RAG (Retrieval-AugmentedGenerationï¼Œæ£€ç´¢å¢å¼ºç”Ÿæˆ)</strong> æ˜¯åˆ†æ²»åœ¨ AI åº”ç”¨æ¶æ„ä¸Šçš„æœ€ä½³å®è·µã€‚<ul><li><em>å¤§é—®é¢˜ï¼š</em> å¦‚ä½•è®© LLM å›ç­”å…³äºæˆ‘ç§æœ‰çŸ¥è¯†åº“çš„æœ€æ–°é—®é¢˜ï¼Ÿ</li><li><em>åˆ†è§£ (Divide)ï¼š</em> å¼ºè¿« LLMçŸ¥é“ä¸€åˆ‡æ˜¯ä¸å¯è¡Œçš„ã€‚æˆ‘ä»¬å°†é—®é¢˜åˆ†è§£ä¸ºï¼šâ‘  æ£€ç´¢ å’Œ â‘¡ ç”Ÿæˆã€‚</li><li><em>è§£å†³ (Conquer)ï¼š</em><ul><li>ç”¨ä¸€ä¸ªä¸“é—¨çš„æ£€ç´¢æ¨¡å—ï¼ˆä¾‹å¦‚å‘é‡æ•°æ®åº“ï¼‰è§£å†³ç‹¬ç«‹çš„å°é—®é¢˜ï¼šæ‰¾åˆ°æœ€ç›¸å…³çš„çŸ¥è¯†ç‰‡æ®µã€‚</li><li>ç”¨ LLM è§£å†³å¦ä¸€ä¸ªç‹¬ç«‹çš„å°é—®é¢˜ï¼šåŸºäºè¿™äº›ç‰‡æ®µï¼Œç”Ÿæˆé€šé¡ºçš„å›ç­”ã€‚</li></ul></li><li><em>åˆå¹¶ (Combine)ï¼š</em>å°†æ£€ç´¢åˆ°çš„ç‰‡æ®µï¼ˆContextï¼‰å’ŒåŸå§‹é—®é¢˜ï¼ˆQueryï¼‰ä¸€èµ·åˆå¹¶åï¼Œå‘ç»™ LLMã€‚</li></ul></li></ul></li><li><strong>AI æ™ºèƒ½ä½“ (Agents) å’Œå·¥å…·ä½¿ç”¨ (Tool Use)ï¼š</strong><ul><li><em>è¿›åŒ–ï¼š</em> å½“ LLMé‡åˆ°ä¸€ä¸ªå¤æ‚ä»»åŠ¡ï¼ˆä¾‹å¦‚æ˜å¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿï¼‰æ—¶ï¼Œå®ƒä½¿ç”¨åˆ†æ²»ï¼š<ul><li><em>åˆ†è§£ï¼š</em> â‘  æˆ‘éœ€è¦çŸ¥é“"æ˜å¤©"å’Œ"åœ°ç‚¹"ã€‚â‘¡æˆ‘éœ€è¦ä¸€ä¸ªå·¥å…·æ¥æŸ¥å¤©æ°”ã€‚â‘¢ æˆ‘éœ€è¦ç»„ç»‡è¯­è¨€ã€‚</li><li><em>è§£å†³ï¼š</em> å®ƒè°ƒç”¨<code>call_weather_api("beijing", "tomorrow")</code>ï¼Œè·å¾— JSONç»“æœã€‚</li><li><em>åˆå¹¶ï¼š</em> å®ƒå°† JSONç»“æœåˆå¹¶åˆ°å®ƒçš„ä¸Šä¸‹æ–‡ä¸­ï¼Œç”Ÿæˆæœ€ç»ˆç­”æ¡ˆã€‚</li></ul></li></ul></li></ol><h3 id="åˆ†å±‚-1">åˆ†å±‚</h3><blockquote><p>[!IMPORTANT]</p><p>ä¸å˜çš„ç¬¬ä¸€æ€§åŸç† â€”â€”æŒ‰"å˜åŒ–çš„é€Ÿç‡"æˆ–"èŒè´£"åˆ’åˆ†ï¼Œç®¡ç†çºµå‘ä¾èµ–ï¼Œä¸Šå±‚ä¾èµ–ä¸‹å±‚ï¼Œéš”ç¦»å˜åŒ–ã€‚</p></blockquote><p>AIç³»ç»Ÿçš„ä¾èµ–å˜å¾—æå…¶å¤æ‚ã€‚å®ƒä¸å†åªæ˜¯ä»£ç ä¾èµ–ï¼Œè¿˜åŒ…æ‹¬<strong>æ•°æ®ä¾èµ–</strong>ã€<strong>æ¨¡å‹ä¾èµ–</strong>ã€<strong>ç¯å¢ƒä¾èµ–</strong>ã€‚</p><p>å®ƒçš„è¿›åŒ–ï¼š</p><ol type="1"><li><strong>MLOps æˆä¸ºæ–°çš„åˆ†å±‚æ ‡å‡†ï¼š</strong><ul><li><em>ä¼ ç»Ÿï¼š</em> è¡¨ç°å±‚ â†’ ä¸šåŠ¡å±‚ â†’ æ•°æ®å±‚ã€‚</li><li><em>è¿›åŒ–ï¼š</em> <strong>AIç³»ç»Ÿçš„æŠ€æœ¯æ ˆè¢«é‡æ–°åˆ†å±‚</strong>ï¼Œæ¯ä¸€å±‚éƒ½éš”ç¦»äº†ä¸åŒé€Ÿç‡çš„å˜åŒ–ï¼š<ul><li><strong>åº”ç”¨å±‚ (Application Layer)ï¼š</strong> ä¼ ç»Ÿçš„ Webåç«¯ã€‚å®ƒå˜åŒ–æœ€å¿«ï¼ˆä¾‹å¦‚ UI è°ƒæ•´ï¼‰ã€‚</li><li><strong>AI ç¼–æ’å±‚ (Orchestration Layer)ï¼š</strong> Prompt æ¨¡æ¿ã€RAGæµç¨‹ã€Agent é€»è¾‘ã€‚å˜åŒ–è¾ƒå¿«ï¼ˆä¾‹å¦‚è°ƒæ•´ Promptï¼‰ã€‚</li><li><strong>æ¨¡å‹æœåŠ¡å±‚ (Model Serving Layer)ï¼š</strong> APIGatewayã€æ¨¡å‹æ¨ç†æœåŠ¡ (Triton,vLLM)ã€‚å˜åŒ–ä¸­ç­‰ï¼ˆä¾‹å¦‚æ¨¡å‹ç‰ˆæœ¬åˆ‡æ¢ï¼‰ã€‚</li><li><strong>æ¨¡å‹è®­ç»ƒå±‚ (Model Training Layer)ï¼š</strong>è®­ç»ƒæµæ°´çº¿ã€å®éªŒè·Ÿè¸ª (MLflow)ã€‚å˜åŒ–è¾ƒæ…¢ï¼ˆä¾‹å¦‚é‡è®­æ¨¡å‹ï¼‰ã€‚</li><li><strong>æ•°æ®/ç‰¹å¾å±‚ (Data/Feature Layer)ï¼š</strong>ç‰¹å¾å­˜å‚¨ã€æ•°æ®æ¹–ã€‚å˜åŒ–æœ€æ…¢ï¼ˆä¾‹å¦‚å¢åŠ æ–°æ•°æ®æºï¼‰ã€‚</li></ul></li><li>è¿™ç§åˆ†å±‚ç¡®ä¿äº†ï¼šæˆ‘å¯ä»¥æ›´æ–°ä¸€ä¸ªPromptï¼ˆç¼–æ’å±‚ï¼‰ï¼Œè€Œ<strong>æ— éœ€</strong>é‡æ–°è®­ç»ƒæ¨¡å‹ï¼ˆè®­ç»ƒå±‚ï¼‰æˆ–é‡å¯æœåŠ¡ï¼ˆæœåŠ¡å±‚ï¼‰ã€‚</li></ul></li><li><strong>"æ•°æ®-æ¨¡å‹-ä»£ç " çš„ä¾èµ–åˆ†å±‚ï¼š</strong><ul><li><em>è¿›åŒ–ï¼š</em> æˆ‘ä»¬å¿…é¡»ä¸¥æ ¼åŒºåˆ†ä¸‰ç§ä¾èµ–ã€‚åœ¨ AIå·¥ç¨‹ä¸­ï¼Œ<strong>æ•°æ®æ˜¯æ–°çš„ä»£ç </strong>ã€‚</li><li>æˆ‘ä»¬å¿…é¡»å»ºç«‹æ–°çš„åˆ†å±‚ä¾èµ–è§„åˆ™ï¼š<strong>ä»£ç  (Code) â†’ æ¨¡å‹ (Model) â†’æ•°æ® (Data)</strong>ã€‚</li><li>è¿™æ„å‘³ç€ï¼Œæ•°æ®çš„å˜æ›´ä¼šè§¦å‘æ¨¡å‹çš„é‡è®­ï¼›æ¨¡å‹çš„å˜æ›´ä¼šè§¦å‘ä»£ç çš„é€‚é…ã€‚ç®¡ç†è¿™äº›"ä¾èµ–é“¾"å’Œ"ç¼“å­˜å¤±æ•ˆ"ï¼ˆä¾‹å¦‚ï¼Œæ•°æ®å˜äº†ï¼Œå“ªäº›ç‰¹å¾å’Œæ¨¡å‹éœ€è¦é‡ç®—ï¼Ÿï¼‰æ˜¯AI æ—¶ä»£åˆ†å±‚çš„æ ¸å¿ƒä»»åŠ¡ã€‚</li></ul></li></ol><h3 id="æ¨¡å—åŒ–-1">æ¨¡å—åŒ–</h3><blockquote><p>[!IMPORTANT]</p><p>ä¸å˜çš„ç¬¬ä¸€æ€§åŸç† â€”â€”é«˜å†…èšã€ä½è€¦åˆã€‚å°†ç³»ç»Ÿåˆ’åˆ†ä¸º"æ¨ªå‘"çš„åŠŸèƒ½å•å…ƒï¼Œé€šè¿‡æ¸…æ™°çš„æ¥å£åä½œã€‚</p></blockquote><p>åœ¨ AI æ—¶ä»£çš„æ–°æŒ‘æˆ˜æ˜¯å¦‚ä½•å°è£… AIçš„éç¡®å®šæ€§ï¼Ÿå¦‚ä½•è®©ä¸€ä¸ªæ¦‚ç‡æ€§çš„æ¨¡å—ä¸ä¸€ä¸ªç¡®å®šæ€§çš„ç³»ç»Ÿï¼ˆä¾‹å¦‚æ”¯ä»˜æ¨¡å—ï¼‰å®‰å…¨åœ°åä½œï¼Ÿ</p><p>å®ƒçš„è¿›åŒ–ï¼š</p><ol type="1"><li><strong>æ¨¡å‹å³æ¨¡å— (Model as a Module)ï¼š</strong><ul><li><em>ä¼ ç»Ÿï¼š</em> ä¸€ä¸ª <code>.jar</code> åŒ…æˆ–ä¸€ä¸ª Go<code>package</code> æ˜¯ä¸€ä¸ªæ¨¡å—ã€‚</li><li><em>è¿›åŒ–ï¼š</em> <strong>ä¸€ä¸ªç»è¿‡è®­ç»ƒå¹¶æ‰“åŒ…çš„æ¨¡å‹ï¼ˆä¾‹å¦‚ä¸€ä¸ª HuggingFace ä»“åº“ï¼‰å°±æ˜¯ AIæ—¶ä»£çš„æ–°æ¨¡å—</strong>ã€‚å®ƒå…·æœ‰æé«˜çš„å†…èšæ€§ï¼ˆå°è£…äº†è§£å†³ç‰¹å®šä»»åŠ¡çš„æ‰€æœ‰çŸ¥è¯†ï¼‰å’Œæä½çš„è€¦åˆæ€§ï¼ˆé€šè¿‡æ ‡å‡†çš„API æš´éœ²æœåŠ¡ï¼‰ã€‚</li></ul></li><li><strong>å¯è§‚æµ‹æ€§æˆä¸ºæ¥å£çš„ä¸€éƒ¨åˆ†ï¼š</strong><ul><li><em>ä¼ ç»Ÿï¼š</em> æ¨¡å—çš„æ¥å£æ˜¯ API ç­¾åã€‚</li><li><em>è¿›åŒ–ï¼š</em> AIæ¨¡å—çš„æ¥å£ä¸ä»…è¦åŒ…æ‹¬è¾“å…¥/è¾“å‡ºï¼Œè¿˜å¿…é¡»åŒ…æ‹¬<strong>å¯è§‚æµ‹æ€§</strong>ã€‚å› ä¸ºæˆ‘ä»¬æ— æ³•100% ä¿¡ä»»å®ƒçš„è¾“å‡ºï¼Œæ‰€ä»¥æ¨¡å—å¿…é¡»æš´éœ²å®ƒçš„å†…éƒ¨çŠ¶æ€ï¼šä¾‹å¦‚ï¼Œå®ƒè¾“å‡º "A"çš„ç½®ä¿¡åº¦æ˜¯å¤šå°‘ï¼Ÿå®ƒåœ¨æ¨ç†æ—¶å‚è€ƒäº†å“ªäº›çŸ¥è¯†æ¥æºï¼Ÿ</li></ul></li><li><strong>ç¡®å®šæ€§å¤–å£³æ¨¡å—ï¼š</strong><ul><li><em>è¿›åŒ–ï¼š</em>è¿™æ˜¯æ¨¡å—åŒ–æ€æƒ³æœ€é‡è¦çš„è¿›åŒ–ã€‚æˆ‘ä»¬<strong>ä¸èƒ½</strong>è®©éç¡®å®šæ€§æ³„éœ²åˆ°ç³»ç»Ÿçš„å…¶ä»–éƒ¨åˆ†ã€‚</li><li>æˆ‘ä»¬å¿…é¡»åˆ›å»ºä¸€ä¸ªç¡®å®šæ€§å¤–å£³æ¨¡å—ï¼ˆä¸€ä¸ªé«˜å†…èšçš„å°è£…ï¼‰ï¼š<ul><li><strong>å†…éƒ¨ (éç¡®å®šæ€§)ï¼š</strong> å®ƒè°ƒç”¨ LLMã€å¤„ç†æ¦‚ç‡æ€§è¾“å‡ºã€‚</li><li><strong>å¤–å£³ (ç¡®å®šæ€§)ï¼š</strong> å®ƒåŒ…å«é˜²æŠ¤æ ã€‚ä¾‹å¦‚ï¼š<ol type="1"><li><strong>è§£æä¸æ ¡éªŒï¼š</strong> å¼ºè¿« LLM è¾“å‡ºJSONï¼Œå¦‚æœè§£æå¤±è´¥åˆ™é‡è¯•æˆ–è¿”å›é”™è¯¯ã€‚</li><li><strong>è¿‡æ»¤ï¼š</strong> æ£€æŸ¥è¾“å‡ºæ˜¯å¦åŒ…å«æ•æ„Ÿè¯æˆ–å¹»è§‰ã€‚</li><li><strong>å›é€€ï¼š</strong> å¦‚æœ AIå¤±è´¥æˆ–ç½®ä¿¡åº¦ä½ï¼Œåˆ™å›é€€åˆ°ä¼ ç»Ÿçš„ç¡®å®šæ€§é€»è¾‘ï¼ˆä¾‹å¦‚<code>if-else</code>ï¼‰ã€‚</li></ol></li></ul></li><li>è¿™ä¸ªå¤–å£³æ¨¡å—å¯¹å¤–æä¾›äº†ä¸€ä¸ª<strong>çœ‹ä¼¼ç¡®å®š</strong>ã€<strong>å®‰å…¨</strong>çš„æ¥å£ï¼Œä½¿å¾—ç³»ç»Ÿçš„å…¶ä»–éƒ¨åˆ†ï¼ˆå¦‚è®¢å•å¤„ç†ã€æ”¯ä»˜é€»è¾‘ï¼‰å¯ä»¥å®‰å…¨åœ°è°ƒç”¨å®ƒã€‚</li></ul></li></ol><h2id="æœ¯çš„è¿›åŒ–ä»ç®¡ç†é€»è¾‘åˆ°é©¾é©­æ¦‚ç‡">æœ¯çš„è¿›åŒ–ï¼šä»ç®¡ç†é€»è¾‘åˆ°é©¾é©­æ¦‚ç‡</h2><p>AIæ—¶ä»£å‚¬ç”Ÿäº†ä¸€ç³»åˆ—å…¨æ–°çš„"æœ¯"ï¼Œå®ƒä»¬çš„æ ¸å¿ƒä¸å†æ˜¯ç®¡ç†"é€»è¾‘çš„ç¡®å®šæ€§"ï¼Œè€Œæ˜¯è½¬å‘<strong>ç®¡ç†"è¯­ä¹‰çš„éç¡®å®šæ€§"å’Œ"ç¼–æ’è®¤çŸ¥ï¼ˆCognitionï¼‰"</strong>ã€‚</p><p>ä»¥ä¸‹æ˜¯æˆ‘è®¤ä¸ºæœ€é‡è¦çš„å››å¤§æœ¯ä¹‹è¿›åŒ–ï¼š</p><h3 id="æ ¸å¿ƒæç¤ºè¯å·¥ç¨‹ä¸-ai-ç¼–æ’">æ ¸å¿ƒï¼šæç¤ºè¯å·¥ç¨‹ä¸ AI ç¼–æ’</h3><p>è¿™æ˜¯ AIæ—¶ä»£<strong>æœ€æ ¹æœ¬çš„æ–°"æœ¯"</strong>ï¼Œå®ƒå‡ ä¹é‡å¡‘äº†"æ³•"ä¸­çš„æŠ½è±¡å’Œåˆ†æ²»ã€‚</p><ul><li><strong>Promptå³æ¥å£</strong>ï¼šä¼ ç»Ÿçš„æœ¯æ˜¯å†™ä»£ç æ¥å®šä¹‰é€»è¾‘ã€‚å…¨æ–°çš„æœ¯æ˜¯å†™<code>Prompt</code>ï¼ˆè‡ªç„¶è¯­è¨€ï¼‰æ¥<strong>å®šä¹‰èƒ½åŠ›å’Œå¥‘çº¦</strong>ã€‚<code>Prompt</code>æˆä¸ºäº†æˆ‘ä»¬ä¸ AI è¿™ä¸ªéç¡®å®šæ€§é»‘ç›’äº¤äº’çš„<strong>æ–° API</strong>ã€‚</li><li><strong>ç¼–æ’å³åˆ†æ²»</strong>ï¼šå•ä¸€ <code>Prompt</code>æ— æ³•è§£å†³å¤æ‚é—®é¢˜ã€‚å› æ­¤ï¼Œæœ¯è¿›åŒ–ä¸º<strong>AIç¼–æ’</strong>ï¼ˆOrchestrationï¼‰ï¼Œå¦‚ LangChain æˆ– LlamaIndex æ‰€åšçš„é‚£æ ·ã€‚<ul><li><strong>RAG(æ£€ç´¢å¢å¼ºç”Ÿæˆ)</strong>ï¼šå°±æ˜¯ä¸€ç§ç¼–æ’"æœ¯"ã€‚å®ƒå°†æ£€ç´¢å’Œç”Ÿæˆè¿™ä¸¤ä¸ªæ­¥éª¤åˆ†æ²»å¼€æ¥ï¼Œå¹¶é€šè¿‡ç¼–æ’åˆå¹¶ç»“æœã€‚</li><li><strong>é“¾å¼æ€è€ƒ (Chain-of-Thought)</strong>ï¼šè¿™æ˜¯ä¸€ç§å¼•å¯¼ AIåˆ†æ²»å…¶å†…éƒ¨æ€ç»´çš„"æœ¯"ã€‚</li><li><strong>AI ç¼–æ’å±‚</strong>ï¼šåœ¨ MLOpsåˆ†å±‚ä¸­ï¼Œè¿™ä¸€å±‚æˆä¸ºäº†æ–°çš„æ ¸å¿ƒã€‚</li></ul></li></ul><h3 id="æ¶Œç°æ™ºèƒ½ä½“æ¶æ„ä¸å·¥å…·è°ƒç”¨">æ¶Œç°ï¼šæ™ºèƒ½ä½“æ¶æ„ä¸å·¥å…·è°ƒç”¨</h3><p>å¦‚æœè¯´ RAG æ˜¯"åˆ†æ²»"çš„åˆçº§å½¢æ€ï¼Œé‚£ä¹ˆ Agentæ¶æ„å°±æ˜¯"æœ¯"åœ¨"åˆ†æ²»"æ€æƒ³ä¸Šçš„é«˜çº§è¿›åŒ–ï¼Œå®ƒæœåŠ¡äº"é“"ä¸­"é©¾é©­æ¶Œç°æ€§"çš„ç›®æ ‡ã€‚</p><ul><li><strong>LLMå³è®¤çŸ¥å¼•æ“</strong>ï¼šä¼ ç»Ÿçš„"æœ¯"æ˜¯å·¥ç¨‹å¸ˆè‡ªé¡¶å‘ä¸‹è®¾è®¡ä¸€åˆ‡ã€‚Agent "æœ¯"åˆ™å°†LLM è§†ä¸ºä¸€ä¸ªå¯ä»¥<strong>è‡ªä¸»è§„åˆ’</strong>çš„è®¤çŸ¥å¼•æ“æˆ–ä¸­å¤®å¤„ç†å™¨ã€‚</li><li><strong>å·¥å…·å³èƒ½åŠ›æ¨¡å—</strong>ï¼šè¿™å¯¹åº”äº†"æ³•"ä¸­çš„"æ¨¡å—åŒ–"ã€‚<code>Agent</code>é€šè¿‡å·¥å…·è°ƒç”¨æ¥æ‰©å±•å…¶èƒ½åŠ›ã€‚</li><li><strong>ReActå¾ªç¯</strong>ï¼š<code>Reason -&gt; Act -&gt; Observe</code> çš„å¾ªç¯ï¼Œæ˜¯<code>Agent</code> æ¶æ„ä¸­æœ€æ ¸å¿ƒçš„"æœ¯"ï¼Œå®ƒä¸º AIçš„æ¶Œç°è¡Œä¸ºæä¾›äº†ä¸€ä¸ªå¯æ§çš„æ‰§è¡Œæ¡†æ¶ã€‚</li></ul><h3 id="é˜²æŠ¤ç¡®å®šæ€§å¤–å£³">é˜²æŠ¤ï¼šç¡®å®šæ€§å¤–å£³</h3><p>è¿™æ˜¯ AIæ—¶ä»£<strong>ä¿éšœç³»ç»Ÿå®‰å…¨å’Œå¯é æ€§</strong>çš„ç¬¬ä¸€é˜²å«æœ¯ï¼Œå®ƒæºäº"æ³•"ä¸­"æ¨¡å—åŒ–"çš„æ€æƒ³ã€‚</p><p>AIçš„éç¡®å®šæ€§æ˜¯å‰§æ¯’çš„ï¼Œå®ƒç»ä¸èƒ½æ³„éœ²åˆ°ä½ çš„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ä¸­ï¼ˆæ¯”å¦‚æ”¯ä»˜ã€è®¢å•ï¼‰ã€‚è¿™ä¸ª"æœ¯"çš„æ ¸å¿ƒå°±æ˜¯<strong>å°è£…é»‘ç›’ã€ç®¡ç†è¾¹ç•Œ</strong>ã€‚</p><p>è¿™ä¸ªå¤–å£³æ¨¡å— è´Ÿè´£æ‰€æœ‰è„æ´»ç´¯æ´»ï¼š</p><ol type="1"><li><strong>è¾“å…¥é˜²æŠ¤</strong>ï¼šæ£€æŸ¥ <code>Prompt</code>æ˜¯å¦åˆè§„ï¼ˆé˜²æ³¨å…¥ï¼‰ã€‚</li><li><strong>è¾“å‡ºè§£æ</strong>ï¼šå¼ºè¿« AI è¾“å‡ºJSONï¼Œå¹¶è¿›è¡Œä¸¥æ ¼çš„<strong>æ ¡éªŒ</strong>ã€<code>pydantic</code>é£æ ¼çš„ç±»å‹è½¬æ¢ã€‚</li><li><strong>å®‰å…¨è¿‡æ»¤</strong>ï¼šæ£€æŸ¥ AIè¾“å‡ºæ˜¯å¦æœ‰å®³ã€æœ‰åè§ã€æˆ–åŒ…å«æ•æ„Ÿä¿¡æ¯ã€‚</li><li><strong>å›é€€æœºåˆ¶</strong>ï¼šå½“ AIå¤±è´¥ã€è¶…æ—¶æˆ–è¾“å‡º"æˆ‘ä¸çŸ¥é“"æ—¶ï¼Œ<strong>å›é€€</strong> åˆ°ä¸€ä¸ªç¡®å®šçš„ã€ç»å…¸çš„<code>if-else</code> é€»è¾‘ã€‚</li></ol><h3 id="å·¥ä¸šmlops-ä¸-ai-èµ„äº§ç®¡ç†">å·¥ä¸šï¼šMLOps ä¸ AI èµ„äº§ç®¡ç†</h3><p>ä¼ ç»Ÿçš„"æœ¯"ç®¡ç†"ä»£ç "ã€‚AIæ—¶ä»£çš„"æœ¯"å¿…é¡»ç®¡ç†<strong>"ä»£ç ã€æ¨¡å‹ã€æ•°æ®"ä¸‰ä½ä¸€ä½“çš„å¤æ‚ä¾èµ–é“¾</strong>ã€‚è¿™å°±æ˜¯MLOpsã€‚</p><ul><li><strong>æ¨¡å‹å³æ¨¡å—</strong>ï¼šAI æ—¶ä»£ï¼Œä¸€ä¸ªï¼ˆä¾‹å¦‚<code>Hugging Face</code>ä¸Šçš„ï¼‰æ¨¡å‹ï¼Œå°±æ˜¯ä¸€ä¸ª<strong>å¯ç‰ˆæœ¬åŒ–ã€å¯éƒ¨ç½²</strong>çš„æ–°æ¨¡å—ã€‚</li><li><strong>æ•°æ®å³ä»£ç </strong>ï¼šæ•°æ®æ˜¯æ–°çš„ä»£ç ã€‚å› æ­¤ï¼Œ"æœ¯"å¿…é¡»è¿›åŒ–åˆ°åŒ…å«<strong>æ•°æ®ç‰ˆæœ¬ç®¡ç†(DVC)</strong>ã€<strong>ç‰¹å¾å·¥ç¨‹ (Feature Engineering)</strong>å’Œ<strong>ç‰¹å¾å­˜å‚¨ (Feature Store)</strong>ã€‚</li></ul><h2id="å™¨çš„è¿›åŒ–ä»ç¡®å®šæ€§æ ‡å°ºåˆ°éç¡®å®šæ€§æ˜é•œ">å™¨çš„è¿›åŒ–ï¼šä»ç¡®å®šæ€§æ ‡å°ºåˆ°éç¡®å®šæ€§æ˜é•œ</h2><h3 id="æµ‹è¯•">æµ‹è¯•</h3><p>åœ¨ AI æ—¶ä»£ï¼Œå°¤å…¶æ˜¯ LLMæ—¶ä»£ï¼Œä¼ ç»Ÿæµ‹è¯•çš„ç¬¬ä¸€æ€§åŸç†å—åˆ°äº†æ ¹æœ¬æ€§çš„æŒ‘æˆ˜ã€‚</p><ul><li><strong>ä¼ ç»Ÿæµ‹è¯•ï¼š</strong> <strong>éªŒè¯(Verification)</strong>ã€‚å…¶æ ¸å¿ƒæ˜¯ <strong>ç¡®å®šæ€§(Determinism)</strong>ã€‚æˆ‘ä»¬è¦æ±‚ 1+1 å¿…é¡»ç­‰äº 2ã€‚</li><li><strong>AI æ—¶ä»£çš„æµ‹è¯•ï¼š</strong> <strong>è¯„ä¼°(Evaluation)</strong>ã€‚å…¶æ ¸å¿ƒæ˜¯ <strong>æ¦‚ç‡æ€§ (Probabilism)</strong> å’Œ<strong>æ¨¡ç³Šæ€§(Fuzziness)</strong>ã€‚æˆ‘ä»¬æ²¡æœ‰æ‰€è°“çš„å”¯ä¸€ç¡®å®šçš„æ­£ç¡®ç­”æ¡ˆï¼Œä½†æˆ‘ä»¬çŸ¥é“å®ƒåº”è¯¥æ˜¯"ç®€æ´çš„"ã€"å¿ äºåŸæ–‡çš„"ã€"é€šé¡ºçš„"ã€‚</li></ul><p>å› æ­¤ï¼Œä¼ ç»Ÿæµ‹è¯•åœ¨ AIæ—¶ä»£<strong>ä»ç„¶æç«¯é‡è¦ï¼Œä½†å·²è¿œè¿œä¸å¤Ÿ</strong>ã€‚å®ƒå¿…é¡»è¿›åŒ–ã€‚</p><h4 id="å•å…ƒæµ‹è¯•-1">å•å…ƒæµ‹è¯•</h4><p>åœ¨ AIç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬ä¹‹å‰è®¨è®ºè¿‡ï¼Œæ¨¡å—åŒ–çš„è¿›åŒ–æ˜¯ä½¿ç”¨ç¡®å®šæ€§å¤–å£³æ¥åŒ…è£¹éç¡®å®šæ€§çš„ AIå†…æ ¸ã€‚<strong>ä¼ ç»Ÿå•å…ƒæµ‹è¯•çš„èŒè´£ï¼Œå°±æ˜¯æå«è¿™ä¸ªç¡®å®šæ€§å¤–å£³ã€‚</strong>å®ƒä»¬ä¸æµ‹è¯•AI <em>æœ¬èº«</em>ï¼Œè€Œæ˜¯æµ‹è¯•æ‰€æœ‰ä¸ AIäº¤äº’çš„ã€ç¡®å®šæ€§çš„<strong>ç®¡é“å’ŒæŠ¤æ </strong>ã€‚</p><ul><li><strong>æµ‹è¯• Prompt æ¨¡æ¿</strong></li><li><strong>æµ‹è¯•è¾“å‡ºè§£æå™¨ (Parsers)</strong></li><li><strong>æµ‹è¯•å›é€€é€»è¾‘ (Fallbacks)</strong></li><li><strong>æµ‹è¯•å·¥å…·è°ƒç”¨ (Tool Use)</strong></li></ul><p>å•å…ƒæµ‹è¯•ä»"æµ‹è¯•ä¸šåŠ¡é€»è¾‘"åé€€åˆ°"æµ‹è¯• AI çš„è¾“å…¥è¾“å‡ºç®¡é“"ã€‚å®ƒä¿è¯äº†æ— è®ºAIè¡¨ç°å¾—å¤šç³Ÿç³•ï¼ˆä¾‹å¦‚èƒ¡è¨€ä¹±è¯­ï¼‰ï¼Œæˆ‘ä»¬çš„ç³»ç»Ÿéƒ½ä¸ä¼šå´©æºƒï¼Œè€Œæ˜¯ä¼šä¼˜é›…åœ°å¤„ç†å¤±è´¥ã€‚</p><h4 id="é›†æˆæµ‹è¯•">é›†æˆæµ‹è¯•</h4><p><strong>é›†æˆæµ‹è¯•çš„èŒè´£ï¼Œæ˜¯æå« AIå·¥ä½œæµçš„è¿é€šæ€§ã€‚</strong>å®ƒæµ‹è¯•çš„æ˜¯æˆ‘ä»¬ä¹‹å‰è®¨è®ºçš„åˆ†å±‚ä¸åˆ†æ²»æ¶æ„ä¸­ï¼Œå„ä¸ªæ¨¡å—ï¼ˆæœåŠ¡ã€æ•°æ®åº“ã€æ¨¡å‹APIï¼‰ä¹‹é—´çš„èƒ¶æ°´å±‚ã€‚</p><ul><li>æµ‹è¯• RAG æµç¨‹çš„é›†æˆ</li><li>æµ‹è¯•å¤–éƒ¨ API çš„ Mocking</li></ul><p>é›†æˆæµ‹è¯•ä¿è¯äº† AI åº”ç”¨çš„éª¨æ¶æ˜¯é€šçš„ã€‚å®ƒä¿è¯äº†æ•°æ®æµï¼ˆData Flowï¼‰åœ¨ RAGç®¡é“ã€å¾®æœåŠ¡å’Œå¤–éƒ¨ API ä¹‹é—´èƒ½æ­£ç¡®æµè½¬ã€‚</p><h4 id="æ–°å‹æµ‹è¯•">æ–°å‹æµ‹è¯•</h4><p>è¿™æ˜¯å…¨æ–°çš„ã€æœ€é‡è¦çš„ä¸€å±‚ã€‚ä¼ ç»Ÿæµ‹è¯•éªŒè¯<code>func(in) == out</code>ï¼ŒAI æµ‹è¯•è¯„ä¼°<code>eval(func(in), criteria)</code> æ˜¯å¦ä¸º<code>True</code>ã€‚æˆ‘ä»¬ä¸å†æ–­è¨€ç›¸ç­‰ï¼Œè€Œæ˜¯è¯„ä¼°å“è´¨ã€‚</p><ul><li>åŸºäº"é»„é‡‘æ•°æ®é›†"çš„å›å½’æµ‹è¯•ï¼šæ£€æµ‹"æ–°å›ç­”"ä¸"ç†æƒ³çš„å›ç­”èŒƒä¾‹"ä¹‹é—´çš„<strong>è¯­ä¹‰ç›¸ä¼¼åº¦</strong>ã€‚é˜²æ­¢æœ‰ç›Šçš„ä¿®æ”¹å¯¼è‡´æ„å¤–çš„è¡°é€€ã€‚</li><li>åŸºäº"å¯å‘å¼"çš„è¯„ä¼°ï¼šå®šä¹‰ä¸€ç³»åˆ—å¯è®¡ç®—çš„è§„åˆ™ï¼Œå¦‚ä¸Šä¸‹æ–‡ç›¸å…³æ€§ã€ä¸Šä¸‹æ–‡ç²¾ç¡®åº¦ã€ç­”æ¡ˆç›¸å…³æ€§ã€ç­”æ¡ˆæœ‰ç”¨åº¦ã€‚</li><li>åŸºäº"å¯¹æŠ—æ€§"çš„æµ‹è¯•ï¼šä¼ ç»Ÿå®‰å…¨æµ‹è¯•ä¸­çš„æ¸—é€æµ‹è¯•ï¼Œä¸“é—¨æµ‹è¯• AIçš„ç‹¬ç‰¹æ¼æ´ã€‚å¦‚ Prompt æ³¨å…¥ã€åè§ä¸å®‰å…¨å’Œé²æ£’æ€§ã€‚</li><li>LLM ä½œä¸ºè¯„ä¼°è€…ï¼šä½¿ç”¨ä¸€ä¸ªæ›´å¼ºå¤§çš„ LLM ä½œä¸ºè‡ªåŠ¨åŒ–è¯„ä¼°çš„æ³•å®˜ã€‚</li></ul><h4 id="æµ‹è¯•é‡‘å­—å¡”">æµ‹è¯•é‡‘å­—å¡”</h4><p>AI æ—¶ä»£çš„æµ‹è¯•ä¸å†æ˜¯ä¸€ä¸ªç®€å•çš„é‡‘å­—å¡”ï¼Œå®ƒæ¼”å˜æˆäº†ä¸€ä¸ªåŒé‡ç»“æ„ï¼š</p><ol type="1"><li><strong>ç¡®å®šæ€§é‡‘å­—å¡” (ä¼ ç»Ÿè½¯ä»¶ 1.0)ï¼š</strong><ul><li><strong>å•å…ƒæµ‹è¯•</strong> (æµ‹è¯•ç®¡é“ã€è§£æå™¨ã€æŠ¤æ )</li><li><strong>é›†æˆæµ‹è¯•</strong> (æµ‹è¯• RAG æµç¨‹ã€API è¿é€šæ€§)</li><li><strong>E2E æµ‹è¯•</strong> (æµ‹è¯• UI äº¤äº’)</li></ul></li><li><strong>æ¦‚ç‡æ€§è¯„ä¼°å±‚ (AI è½¯ä»¶ 2.0)ï¼š</strong><ul><li><strong>è´¨é‡è¯„ä¼°</strong> (åŸºäºé»„é‡‘é›†ã€å¯å‘å¼ã€LLM-as-Judge)</li><li><strong>å®‰å…¨è¯„ä¼°</strong> (å¯¹æŠ—æ€§æµ‹è¯•ã€åè§æµ‹è¯•)</li><li><strong>ç”Ÿäº§ç›‘æ§ (CI/CT)</strong> (A/Bæµ‹è¯•ã€ç”¨æˆ·åé¦ˆã€æ•°æ®æ¼‚ç§»æ£€æµ‹)</li></ul></li></ol><p>æœ€åï¼Œæµ‹è¯•<strong>ä»éƒ¨ç½²å‰å»¶ä¼¸åˆ°äº†éƒ¨ç½²å</strong>ã€‚A/Bæµ‹è¯•å’Œç”Ÿäº§ç¯å¢ƒçš„ç”¨æˆ·åé¦ˆæˆä¸ºäº†æŒç»­æµ‹è¯• (Continuous Testing)çš„æœ€ç»ˆé—­ç¯ã€‚</p><h3 id="å¯è§‚æµ‹æ€§-1">å¯è§‚æµ‹æ€§</h3><p>ä¼ ç»Ÿçš„åŠ¨æ€å¤æ‚åº¦æ˜¯"æœåŠ¡ A è°ƒç”¨ B å˜æ…¢äº†"ã€"ä¸ºä»€ä¹ˆæœåŠ¡ Açªç„¶è°ƒä¸é€šæœåŠ¡ B äº†ï¼Ÿ"ã€‚AI æ—¶ä»£çš„åŠ¨æ€å¤æ‚åº¦æ˜¯"<strong><u>ä¸ºä»€ä¹ˆ AIçªç„¶å¼€å§‹èƒ¡è¨€ä¹±è¯­äº†ï¼Ÿ</u></strong>"ã€‚æˆ‘ä»¬å¿…é¡»è§‚æµ‹é‚£ä¸ª<strong>éç¡®å®šæ€§é»‘ç›’çš„å¿ƒæ™ºè¿‡ç¨‹</strong>ã€‚</p><p>AI æ—¶ä»£çš„å¯è§‚æµ‹æ€§ï¼Œ<strong>å…¶è¿›åŒ–æœ¬è´¨æ˜¯ä»"ç›‘æ§ç³»ç»Ÿå¥åº·"æ‰©å±•åˆ°"è¯„ä¼° AIè¡Œä¸ºä¸è´¨é‡"</strong>ã€‚ä¼ ç»Ÿçš„ä¸‰å¤§æ”¯æŸ±ï¼ˆmetricsã€traceã€logï¼‰ä»ç„¶æ˜¯åœ°åŸºï¼Œä½†æˆ‘ä»¬å¿…é¡»åœ¨ä¸Šé¢åŠ ç›–å…¨æ–°çš„æ¥¼å±‚ã€‚</p><h4 id="ä»ä¸‰å¤§æ”¯æŸ±åˆ°å››å¤§æ”¯æŸ±">ä»ä¸‰å¤§æ”¯æŸ±åˆ°å››å¤§æ”¯æŸ±</h4><p>ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œå¯è§‚æµ‹æ€§æ­£åœ¨æ¼”åŒ–ï¼Œå¢åŠ äº†ä¸€ä¸ªå…¨æ–°çš„ã€ä¸“ä¸º AIæœåŠ¡çš„æ”¯æŸ±ï¼Œæˆ‘ç§°ä¹‹ä¸º <strong>AI äº¤äº’ (AIInteractions)</strong>ã€‚è¿™æœ‰æ—¶ä¹Ÿè¢«ç§°ä¸º <strong>LLM O11y</strong> æˆ–<strong>Trace-centric Observability</strong>ã€‚</p><p>è¿™ä¸ªæ–°æ”¯æŸ±ä¸“é—¨æ•è· AI é»‘ç›’çš„"è¾“å…¥-å¤„ç†-è¾“å‡º"å…¨è²Œã€‚</p><ul><li><strong>ä¼ ç»Ÿ Logsï¼š</strong><code>&#123;"level": "info", "service": "payment", "msg": "payment processed"&#125;</code></li><li><strong>AI Logs/Traces ï¼š</strong><ul><li><strong>Inputsï¼š</strong> æ•è·å®Œæ•´çš„<strong>Prompt</strong>ï¼ˆåŒ…æ‹¬æˆ‘ä»¬æ³¨å…¥çš„ RAG ä¸Šä¸‹æ–‡ã€Few-shotç¤ºä¾‹ï¼‰ã€‚</li><li><strong>Outputsï¼š</strong> æ•è·å®Œæ•´çš„ <strong>Response</strong>ï¼ˆLLMçš„åŸå§‹å›ç­”ï¼‰ã€‚</li><li><strong>Metadataï¼š</strong><ul><li><strong>æ¨¡å‹å‚æ•°ï¼š</strong> <code>model_name</code> (gpt-4o,claude-3-sonnet), <code>temperature</code>,<code>max_tokens</code>ã€‚</li><li><strong>ä½¿ç”¨æƒ…å†µ (Usage)ï¼š</strong> <code>prompt_tokens</code>,<code>completion_tokens</code>, <code>total_tokens</code>ã€‚</li><li><strong>æˆæœ¬ (Cost)ï¼š</strong> <code>cost_in_usd</code> (ä¾‹å¦‚$0.0015)ã€‚</li><li><strong>å»¶è¿Ÿ (Latency)ï¼š</strong> <code>time_to_first_token</code>,<code>total_time</code>ã€‚</li></ul></li></ul></li></ul><p>è¿™ä¸ªæ–°æ”¯æŸ±æ˜¯åç»­æ‰€æœ‰è¿›åŒ–çš„æ•°æ®åŸºç¡€ã€‚</p><h4 id="metricsä»ç³»ç»Ÿå¥åº·åˆ°-ai-è´¨é‡">metricsï¼šä»ç³»ç»Ÿå¥åº·åˆ° AI è´¨é‡</h4><p>ä¼ ç»Ÿ Metrics å…³æ³¨ <strong>RED</strong>ï¼ˆé€Ÿç‡, é”™è¯¯ç‡, è€—æ—¶ï¼‰ã€‚åœ¨ AIæ—¶ä»£ï¼Œæˆ‘ä»¬å¢åŠ äº†å…¨æ–°çš„ AI è´¨é‡æŒ‡æ ‡ã€‚</p><table><colgroup><col style="width: 9%" /><col style="width: 45%" /><col style="width: 45%" /></colgroup><thead><tr><th><strong>æŒ‡æ ‡ç»´åº¦</strong></th><th><strong>ä¼ ç»Ÿå¯è§‚æµ‹æ€§</strong></th><th><strong>AI æ—¶ä»£å¯è§‚æµ‹æ€§</strong></th></tr></thead><tbody><tr><td><strong>ç³»ç»Ÿå¥åº·</strong></td><td><code>http_requests_total</code><br><code>http_errors_rate</code><br> <code>cpu_usage</code></td><td>(å…¨éƒ¨ä¿ç•™)<br> <code>llm_api_error_rate</code> (å¦‚ 429 é™æµ)</td></tr><tr><td><strong>æ€§èƒ½</strong></td><td><code>http_request_duration_p99</code></td><td><code>llm_time_to_first_token_p95</code><br><code>llm_token_generation_speed</code> (tokens/sec)</td></tr><tr><td><strong>AI è´¨é‡</strong></td><td>(æ— )</td><td><code>hallucination_rate</code> (å¹»è§‰ç‡)<br><code>toxicity_score</code> (æœ‰æ¯’å†…å®¹è¯„åˆ†) <br><code>pii_leakage_count</code> (ä¸ªäººéšç§æ³„éœ²è®¡æ•°) <br><code>user_feedback_score</code> (ç”¨æˆ·ç‚¹èµ/ç‚¹è¸©ç‡)</td></tr><tr><td><strong>æˆæœ¬</strong></td><td>(æ— ï¼Œæˆ–æ¨¡ç³Šçš„æœåŠ¡å™¨æˆæœ¬)</td><td><code>total_cost_per_day</code> (æŒ‰æ¨¡å‹/æŒ‰ç”¨æˆ·)<br><code>cost_per_request</code> (å•æ¬¡è¯·æ±‚æˆæœ¬)<br><code>total_tokens_per_service</code></td></tr></tbody></table><p>è¿™æ„å‘³ç€å¯è§‚æµ‹æ€§å¹³å° (å¦‚ Grafana) ä¸Šï¼Œé™¤äº† CPUå’Œå»¶è¿Ÿçš„å›¾è¡¨ï¼Œ<strong>è¿˜å¿…é¡»æœ‰"æ¯æ—¥æˆæœ¬"ã€"å¹»è§‰ç‡"å’Œ"ç”¨æˆ·æ»¡æ„åº¦"çš„å›¾è¡¨</strong>ã€‚</p><h4 id="tracingä»è°ƒç”¨é“¾åˆ°æ€ç»´é“¾">tracingï¼šä»è°ƒç”¨é“¾åˆ°æ€ç»´é“¾</h4><ul><li><strong>ä¼ ç»Ÿ Trace (OpenTelemetry)ï¼š</strong>å…³æ³¨çš„æ˜¯<strong>æ“ä½œ(Operations)</strong>ã€‚ä¸€ä¸ª Span (è·¨åº¦) ä»£è¡¨ä¸€ä¸ªå‡½æ•°è°ƒç”¨æˆ–ä¸€æ¬¡ RPCã€‚å¦‚<code>Service A</code> -&gt; <code>Service B (Redis GET)</code> -&gt;<code>Service C (DB Query)</code>ã€‚å®ƒå›ç­”çš„æ˜¯è¯·æ±‚çš„ç“¶é¢ˆå’Œé—®é¢˜ç‚¹å‡ºç°åœ¨å“ªé‡Œï¼Ÿ</li><li><strong>AI Trace (å¦‚ LangSmith,OpenInference)ï¼š</strong>å…³æ³¨çš„æ˜¯<strong>ä¸Šä¸‹æ–‡ (Context)</strong> å’Œ<strong>AI çš„æ€è€ƒæ­¥éª¤</strong>ã€‚<ul><li>ä¸€ä¸ª Span ä¸ä»…ä»£è¡¨æ“ä½œï¼Œæ›´ä»£è¡¨ AIé“¾æ¡ä¸­çš„ä¸€æ­¥ï¼Œå¹¶<strong>å¯Œå«è¯­ä¹‰ä¿¡æ¯</strong>ã€‚</li><li>ä»¥ä¸€ä¸ª RAG (æ£€ç´¢å¢å¼ºç”Ÿæˆ) åº”ç”¨ä¸ºä¾‹ï¼Œä¸€ä¸ª AI Trace å¿…é¡»æ¸…æ™°åœ°å±•ç¤ºï¼š<ol type="1"><li><strong>[Span 1: Parse Query]</strong> ç”¨æˆ·çš„åŸå§‹é—®é¢˜ã€‚</li><li><strong>[Span 2: Embed Query]</strong>ç”¨æˆ·çš„æŸ¥è¯¢è¢«è½¬æ¢æˆäº†å“ªä¸ªå‘é‡ã€‚</li><li><strong>[Span 3: Vector Search]</strong>ä»å‘é‡æ•°æ®åº“ä¸­<strong>æ£€ç´¢åˆ°äº†å“ªå‡ å—(Chunks)æ–‡æœ¬</strong>ï¼Ÿ</li><li><strong>[Span 4: Build Prompt]</strong> ç³»ç»Ÿå°†è¿™äº› Chunkså’ŒåŸå§‹é—®é¢˜<strong>ç»„è£…æˆäº†ä»€ä¹ˆæ ·çš„æœ€ç»ˆ Prompt</strong>ï¼Ÿ</li><li><strong>[Span 5: LLM Call]</strong> è°ƒç”¨ LLM (é™„å¸¦ Tokens, Costç­‰å…ƒæ•°æ®)ã€‚</li><li><strong>[Span 6: Parse Output]</strong> å¾—åˆ° LLMçš„åŸå§‹å›ç­”ï¼Œå¹¶è§£æã€‚</li></ol></li></ul></li></ul><p>AI Trace æ˜¯<strong>å¯Œä¸Šä¸‹æ–‡</strong>çš„ã€‚å½“ä¸€ä¸ª RAG å›ç­”é”™è¯¯æ—¶ï¼ŒSREæˆ–å·¥ç¨‹å¸ˆéœ€è¦æ‰“å¼€è¿™ä¸ª Traceï¼Œ<strong>ä¸€ç›®äº†ç„¶åœ°çœ‹åˆ°æ˜¯ Vector Searchæ²¡æŸ¥åˆ°ç›¸å…³æ–‡æ¡£ï¼Œè¿˜æ˜¯ Prompt ç»„è£…é”™äº†ï¼Œè¿˜æ˜¯ LLM äº§ç”Ÿäº†å¹»è§‰</strong>ã€‚</p><h4 id="logä»äº‹ä»¶è®°å½•åˆ°è¯„ä¼°æ•°æ®é›†">logï¼šä»äº‹ä»¶è®°å½•åˆ°è¯„ä¼°æ•°æ®é›†</h4><ul><li><strong>ä¼ ç»Ÿ Logsï¼š</strong> ä¸»è¦ç”¨äºäº‹åæ’éšœã€‚</li><li><strong>AI Logsï¼š</strong><ol type="1"><li><strong>ä¸»åŠ¨æ’éšœ (Proactive)ï¼š</strong> AI Logs (å°¤å…¶æ˜¯æ•è·çš„Prompt/Response) ä¼šè¢«<strong>å®æ—¶</strong>é€å…¥ä¸€ä¸ªè¯„ä¼°æ¨¡å‹(Evaluator)ã€‚ä¾‹å¦‚ï¼Œç”¨ä¸€ä¸ª LLM (å¦‚ GPT-4) å»è¯„ä¼°å¦ä¸€ä¸ª LLM (å¦‚ Llama 3)çš„å›ç­”æ˜¯å¦æœ‰å®³ã€‚å¦‚æœè¯„ä¼°ä¸é€šè¿‡ï¼Œ<strong>ç«‹å³è§¦å‘å‘Šè­¦</strong>ã€‚</li><li><strong>é»„é‡‘æ•°æ®é›† (Golden Dataset)ï¼š</strong>ç”Ÿäº§ç¯å¢ƒä¸­çš„é«˜è´¨é‡é—®ç­”å¯¹ (æ¥è‡ª AI Logs) ä¼šè¢«ç­›é€‰å‡ºæ¥ï¼Œç”¨äºå¾®è°ƒ(Fine-tuning) æœªæ¥çš„æ¨¡å‹ï¼Œå½¢æˆä¸€ä¸ªæŒç»­æ”¹è¿›çš„é—­ç¯ã€‚</li></ol></li></ul><p>å¯è§‚æµ‹æ€§ç³»ç»Ÿä¸å†åªæ˜¯ä¸€ä¸ª"çœ‹"çš„ç³»ç»Ÿï¼Œå®ƒæˆäº†ä¸€ä¸ª"è¯„ä¼°"å’Œ"å†è®­ç»ƒ"çš„æ•°æ®æºå¤´ã€‚</p><h4 id="æ€»ç»“-2">æ€»ç»“</h4><table><colgroup><col style="width: 9%" /><col style="width: 37%" /><col style="width: 53%" /></colgroup><thead><tr><th><strong>æ–¹é¢</strong></th><th><strong>ä¼ ç»Ÿå¯è§‚æµ‹æ€§ (O11y 1.0)</strong></th><th><strong>AI æ—¶ä»£å¯è§‚æµ‹æ€§ (O11y 2.0)</strong></th></tr></thead><tbody><tr><td><strong>æ ¸å¿ƒç›®æ ‡</strong></td><td>ç›‘æ§ç³»ç»Ÿ<strong>å¥åº·</strong> (Health)</td><td>ç›‘æ§ç³»ç»Ÿå¥åº· + è¯„ä¼° AI <strong>è´¨é‡</strong> (Quality)</td></tr><tr><td><strong>ä¸»è¦æŒ‘æˆ˜</strong></td><td>åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¤æ‚æ€§</td><td>LLM çš„éç¡®å®šæ€§ã€é»‘ç›’æ€§ã€å¹»è§‰</td></tr><tr><td><strong>Metrics</strong></td><td>RED æŒ‡æ ‡ (é€Ÿç‡ã€é”™è¯¯ã€è€—æ—¶)</td><td>RED + <strong>è´¨é‡æŒ‡æ ‡</strong> (å¹»è§‰ç‡ã€æ»¡æ„åº¦) +<strong>æˆæœ¬æŒ‡æ ‡</strong> (Tokens, Cost)</td></tr><tr><td><strong>Tracing</strong></td><td><strong>æ“ä½œé“¾</strong> (Operation Chain) (å¦‚ OpenTelemetry)</td><td><strong>æ€ç»´é“¾ / ä¸Šä¸‹æ–‡é“¾</strong> (Context Chain) (å¦‚ LangSmith,OpenInference)</td></tr><tr><td><strong>Logs</strong></td><td>äº‹åæ’éšœçš„<strong>äº‹ä»¶è®°å½•</strong></td><td><strong>è¯„ä¼°æ•°æ®é›†</strong>ï¼Œç”¨äºå®æ—¶å‘Šè­¦å’Œæ¨¡å‹å¾®è°ƒ</td></tr><tr><td><strong>æ ¸å¿ƒå·¥å…·</strong></td><td>Prometheus, Grafana, Jaeger, ELK</td><td>(ä¿ç•™ä¸Šè¿°å·¥å…·) + <strong>LLM O11y å¹³å°</strong> (å¦‚ LangSmith, ArizeAI, W&amp;B)</td></tr></tbody></table><p>æ€»è€Œè¨€ä¹‹ï¼ŒAI æ—¶ä»£çš„å¯è§‚æµ‹æ€§ï¼Œæ˜¯ä¼ ç»Ÿ SRE/DevOps å’Œ MLOps/Data Scienceä¸¤ä¸ªé¢†åŸŸçš„<strong>å¼ºåˆ¶èåˆ</strong>ã€‚æˆ‘ä»¬ä¸ä»…éœ€è¦å·¥ç¨‹å¸ˆï¼Œè¿˜éœ€è¦æ‡‚ AIè´¨é‡è¯„ä¼°çš„ä¸“å®¶ï¼Œå…±åŒç›¯ç€ä»ªè¡¨ç›˜ã€‚</p>]]></content>
    
    
    <summary type="html">ä¸‰å¹´å·¥ä½œå¤ç›˜ä¸¨æŠ€æœ¯ç¯‡ï¼šè½¯ä»¶å·¥ç¨‹æ˜¯ä»€ä¹ˆä¸¨ï¼ˆä¸€ï¼‰ç®¡ç†å¤æ‚åº¦</summary>
    
    
    
    <category term="ä¸‰å¹´å·¥ä½œå¤ç›˜" scheme="https://hedon.top/categories/%E4%B8%89%E5%B9%B4%E5%B7%A5%E4%BD%9C%E5%A4%8D%E7%9B%98/"/>
    
    
    <category term="ä¸‰å¹´å·¥ä½œå¤ç›˜" scheme="https://hedon.top/tags/%E4%B8%89%E5%B9%B4%E5%B7%A5%E4%BD%9C%E5%A4%8D%E7%9B%98/"/>
    
    <category term="æŠ€æœ¯ç¯‡" scheme="https://hedon.top/tags/%E6%8A%80%E6%9C%AF%E7%AF%87/"/>
    
    <category term="è½¯ä»¶å·¥ç¨‹" scheme="https://hedon.top/tags/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/"/>
    
    <category term="ç®¡ç†å¤æ‚åº¦" scheme="https://hedon.top/tags/%E7%AE%A1%E7%90%86%E5%A4%8D%E6%9D%82%E5%BA%A6/"/>
    
  </entry>
  
  <entry>
    <title>è¯»ä¹¦ç¬”è®°ä¸¨ã€Šä¸Šå¤´Obsidianï¼šæ‰‹æŠŠæ‰‹æ•™ä½ ç”¨AIåšå¥½çŸ¥è¯†ç®¡ç†ã€‹</title>
    <link href="https://hedon.top/2025/10/14/note/note-obsidian/"/>
    <id>https://hedon.top/2025/10/14/note/note-obsidian/</id>
    <published>2025-10-14T09:36:00.000Z</published>
    <updated>2025-10-14T09:40:49.779Z</updated>
    
    <content type="html"><![CDATA[<h2 id="é“">é“</h2><p>çŸ¥è¯†ç®¡ç†çš„æœ€ç»ˆç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿâ€”â€” è¡¨è¾¾ï¼ˆè¾“å‡ºï¼‰ã€‚æ‰€ä»¥çŸ¥è¯†ç®¡ç†çš„åº•å±‚é€»è¾‘åŸºæœ¬æ˜¯ä¸å˜çš„ï¼šâ€è¾“å…¥ â†’ å…³è” â†’ è¡¨è¾¾â€œã€‚</p><p>ã€Šä¸Šå¤´ Obsidianã€‹çš„ä½œè€…æå‡ºäº†ä¸€ç§æ„å»ºçŸ¥è¯†åº“çš„æ€è·¯ï¼šGAPï¼Œå³ï¼š</p><ul><li>Gï¼ˆGraspï¼‰ï¼šé‡‡é›†</li><li>Aï¼ˆArrangeï¼‰ï¼šå½’ç±»</li><li>Pï¼ˆPresentï¼‰ï¼šè¡¨è¾¾</li></ul><p>æ‰€ä»¥æˆ‘ä»¬è¦å¦‚ä½•åšé‡‡é›†å’Œå½’ç±»ï¼Œæ‰èƒ½å¸®åŠ©æˆ‘ä»¬åšæ›´å¥½çš„è¡¨è¾¾å‘¢ï¼Ÿæˆ‘ä»¬ä¸€å®šè¦å›´ç»•æˆ‘ä»¬çš„æœ€ç»ˆç›®æ ‡â€è¡¨è¾¾â€œæ¥æ€è€ƒï¼Œå³åœ¨é‡‡é›†ç¯èŠ‚ï¼Œåªé‡‡é›†é‚£äº›æˆ‘ä»¬éœ€è¦çš„ææ–™ï¼Œè€Œä¸æ˜¯çœ‹åˆ°ä»€ä¹ˆè§‰å¾—å¥½åƒä¸é”™ã€å¯èƒ½æœ‰ç”¨å°±ä¸€è‚¡è„‘æ”¶é›†èµ·æ¥ï¼Œæœ€åå½¢æˆäº†ä¸€ä¸ªå †æ»¡åƒåœ¾çš„ä»“åº“ã€‚</p><p>çŸ¥è¯†é‡‡é›†å¯ä»¥åˆ†ä¸ºä¸‰æ­¥èµ°ï¼š</p><ol type="1"><li>æ˜ç¡®ç›®æ ‡ï¼šæ”¶é›†è¦è§£å†³çš„é—®é¢˜ã€æƒ³è¦è¡¨è¾¾çš„å†…å®¹ã€éœ€è¦å®Œæˆçš„ä»»åŠ¡ã€å¯¹è‡ªå·±å¯å‘çš„ä¿¡æ¯ã€‚</li><li>å–‚å…»å¤§è„‘ï¼šé€‰æ‹©â€ä¸èˆ’æœã€é•¿ã€ç»å…¸â€œçš„é«˜è´¨é‡èµ„æ–™æºï¼Œé¿å…æ— æ„ä¹‰çš„ä¿¡æ¯å †ç§¯ã€‚</li><li>å¿«é€Ÿæ”¶é›†ï¼šé…ç½®é¡ºæ‰‹çš„å‰ªè—å·¥ä½œä¸æ¸…æ™°çš„é‡‡é›†æ¨¡æ¿ï¼Œä¿è¯çµæ„Ÿç¬¬ä¸€æ—¶é—´è¢«æ•è·ã€‚</li></ol><p>å¦‚æœè¯´é‡‡é›†é˜¶æ®µæ˜¯ç§¯ç´¯åŸæ–™ï¼Œé‚£ä¹ˆå½’ç±»é˜¶æ®µå°±æ˜¯å¼€å§‹æ­å»ºç»“æ„ï¼ŒæŠŠé›¶æ•£çš„ä¿¡æ¯ç»„ç»‡æˆå¯ç”¨çš„æ¨¡å—ã€‚åªæœ‰ç»è¿‡åˆç†å½’ç±»çš„å†…å®¹ï¼Œæ‰èƒ½æˆä¸ºåç»­è¾“å‡ºçš„åŸºçŸ³ã€‚</p><p>çŸ¥è¯†å½’ç±»ä¸»è¦åšä¸‰ä»¶äº‹æƒ…ï¼š</p><ol type="1"><li>å®šæœŸæ•´ç†æœªå¤„ç†çš„ç¬”è®°ï¼›</li><li>è¿›è¡Œç¬”è®°å…³è”ï¼š<ol type="1"><li>ç¬¬ä¸€æ¬¡æ”¶é›†è¯¥ä¸»é¢˜çš„ç›¸å…³å†…å®¹ï¼Œåˆ™éœ€è¦æ–°å»ºä¸€ä¸ªå½’ç±»ç¬”è®°ï¼Œå¹¶å°†å½“å‰è¿™æ¡é‡‡é›†ç¬”è®°ä½œä¸ºç¬¬ä¸€æ¡ææ–™æ·»åŠ è¿›å»ã€‚</li><li>åœ¨å½’ç±»æ–‡ä»¶å¤¹ä¸­ï¼Œå·²ç»å½¢æˆäº†å¯¹åº”çš„ä¸»é¢˜ç¬”è®°ï¼Œåªéœ€è¦å°†æ–°çš„é‡‡é›†ç¬”è®°é“¾æ¥åˆ°å·²æœ‰çš„å½’ç±»ç¬”è®°ä¸­å³å¯ã€‚</li></ol></li><li>æ•´ç†å½’ç±»ç¬”è®°<ol type="1"><li>æ‹†åˆ†å½’ç±»ç¬”è®°ï¼Œå¦‚æœä¸€ç±»ç¬”è®°ä¸­ç§¯ç´¯äº†å¾ˆå¤šå†…å®¹ï¼Œåˆ™éœ€è¦è¿›ä¸€æ­¥è¿›è¡Œæ–¹å‘æ‹†åˆ†ã€‚</li><li>å‡†å¤‡äº§å‡ºï¼Œå¦‚æœæŸä¸ªå½’ç±»ç¬”è®°ä¸‹çš„å†…å®¹å·²ç»è¶³å¤Ÿæˆç†Ÿã€ç»“æ„ä¹Ÿå¾ˆæ¸…æ™°ï¼Œé‚£å°±å¯ä»¥å¼€å§‹è¡¨è¾¾è¾“å‡ºäº†ã€‚</li></ol></li></ol><p>è¡¨è¾¾æ˜¯æœ€å¥½çš„å­¦ä¹ æ–¹å¼ï¼Œå¯åˆ†å››æ­¥èµ°ï¼š</p><ol type="1"><li>æœ‰è¡¨è¾¾éœ€æ±‚æ—¶ï¼Œç«‹å³æ–°å»ºè¡¨è¾¾ç¬”è®°ï¼›</li><li>ä½¿ç”¨åˆ†å±ã€AI ç­‰å·¥å…·é«˜æ•ˆå®Œæˆå†…å®¹æ’°å†™ï¼›</li><li>ä¿®æ”¹çŠ¶æ€ã€å»ºç«‹é“¾æ¥ã€èå…¥çŸ¥è¯†ç½‘ç»œï¼›</li><li>å°†è¡¨è¾¾ç¬”è®°å‘å¸ƒåˆ°åˆé€‚çš„å¹³å°ï¼Œè·å–å¤–éƒ¨åé¦ˆã€‚</li></ol><h2 id="æœ¯">æœ¯</h2><p>é‚£ä¸ºä»€ä¹ˆé€‰æ‹© Obsidian å‘¢ï¼Ÿä¸ºä»€ä¹ˆ Obsidian å¯ä»¥åœ¨ GAPçš„å„ä¸ªé˜¶æ®µå¯¹æˆ‘ä»¬å½¢æˆåŠ©åŠ›å‘¢ï¼Ÿä¸ºä»€ä¹ˆåœ¨ AI æ—¶ä»£ï¼ŒObsidiançš„èƒ½åŠ›å¯ä»¥å¾—åˆ°è¿›ä¸€æ­¥åŠ å¼ºå‘¢ï¼Ÿ</p><p>æ ¸å¿ƒåˆ†ä¸ºä¸¤å¤§éƒ¨åˆ†ï¼š</p><ul><li>çŸ¥è¯†åº“ï¼šæœ‰ä¸€ä¸ªåœ°æ–¹å¯ä»¥å­˜å‚¨æˆ‘ä»¬çš„ææ–™ï¼Œæ˜¯èƒ½ä¿è¯ä¿¡æ¯æ”¾å¾—åˆç†ã€æœ‰åºã€èƒ½éšæ—¶è¢«è°ƒå–ã€‚</li><li>å·¥ä½œæµï¼šæ˜ç¡®çš„å¤„ç†æ­¥éª¤ã€ä»ä¿¡æ¯çš„é‡‡é›†ã€å½’ç±»ã€åŠ å·¥åˆ°è¾“å‡ºåˆ°æœ‰æ—¢å®šçš„è·¯å¾„ä¾èµ–ï¼Œé™ä½å¿ƒæ™ºè´Ÿæ‹…ã€‚èƒ½æä¾›å¯é‡å¤ä½¿ç”¨çš„å†…å®¹æ¨¡ç‰ˆï¼Œå‡å°‘é‡å¤åŠ³åŠ¨ï¼Œå‡å°‘ä¸ä¸€è‡´æ€§ï¼Œæé«˜æ“ä½œæ•ˆç‡ã€‚</li></ul><p>åœ¨è¿™ 2 ä¸ªæ–¹é¢ä¸Šï¼ŒObsidian ä¸€äº›ç‰¹æ€§å¯ä»¥æä¾›å¾ˆå¥½çš„æ”¯æŒï¼š</p><ol type="1"><li>Obsidian æœ¬èº«å°±æ˜¯ä¸€ä¸ªç¬”è®°è½¯ä»¶ï¼Œä¸”ç¬”è®°éƒ½æ˜¯ä»¥ markdownæ–‡ä»¶å­˜å‚¨åœ¨æœ¬åœ°çš„ï¼Œæ”¯æŒ iCloudç­‰å¤šç§æ–¹å¼å®ç°å¤šç«¯åŒæ­¥ï¼Œææ–™çš„å®‰å…¨æ€§ã€å®Œæ•´æ€§å’Œå¯è¿ç§»æ€§éƒ½éå¸¸å¼ºã€‚</li><li>Obsidiançš„åŒé“¾ã€æ ‡ç­¾ã€æ–‡ä»¶å¤¹åŠŸèƒ½ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬å»ºç«‹åˆç†ã€æœ‰åºçš„çŸ¥è¯†ç½‘ç»œï¼Œæ›´ç¬¦åˆäººè„‘å¯¹çŸ¥è¯†çš„åˆ©ç”¨é€»è¾‘ã€‚</li><li>Obsidianæ”¯æŒå¤šç§æ’ä»¶ã€æ¨¡æ¿åŠŸèƒ½ï¼Œæ–¹ä¾¿æˆ‘ä»¬å»ºç«‹å¼ºå¤§çš„å·¥ä½œæµï¼Œåœ¨å¤§å¤§å‡å°‘é‡å¤åŠ³åŠ¨ã€æé«˜æ“ä½œæ•ˆç‡çš„åŒæ—¶ï¼Œè¿˜èƒ½å¸®åŠ©æˆ‘ä»¬äº§å‡ºæ›´å…·ä¸€è‡´æ€§ã€é«˜è´¨é‡çš„çŸ¥è¯†åº“ã€‚å°¤å…¶æ˜¯åœ¨AI èƒ½åŠ›çš„åŠ æŒä¸‹ï¼Œè¿™äº›èƒ½åŠ›ä¼šè¢«è¿›ä¸€æ­¥å¢å¼ºã€‚</li></ol><p>å…·ä½“åˆ° GAP æ¯ä¸€ä¸ªæ­¥éª¤ä¸Šï¼ŒObsidian å¯ä»¥æä¾›ä»¥ä¸‹çš„å¸®åŠ©ã€‚</p><h3id="ggraspé‡‡é›†é‡ç‚¹æ˜¯å¿«ä¾¿æ·æ— å¿ƒæ™ºè´Ÿæ‹…">Gï¼ˆGraspï¼‰é‡‡é›†ï¼šé‡ç‚¹æ˜¯å¿«ã€ä¾¿æ·ã€æ— å¿ƒæ™ºè´Ÿæ‹…</h3><ol type="1"><li>å®šä¹‰â€é‡‡é›†ç¬”è®°æ¨¡ç‰ˆâ€œï¼Œè®¾ç«‹â€tagsã€createdã€linkâ€œé€šç”¨å±æ€§ï¼Œæ–¹ä¾¿åˆ©ç”¨dataviewã€æ ‡ç­¾è¿‡æ»¤å’ŒåŒé“¾åŠŸèƒ½å»ºç«‹çŸ¥è¯†ç½‘ç»œå’Œè¿‡æ»¤èƒ½åŠ›ã€‚</li><li>åˆ©ç”¨æ’ä»¶å’Œ AI å¿«é€Ÿæå–ææ–™ï¼š<ol type="1"><li>å¯ä»¥ä½¿ç”¨å®˜æ–¹æ’ä»¶ Obsidian Web Clipper é‡‡é›†ç½‘é¡µå†…å®¹ï¼Œå®ƒæ”¯æŒ AIHookï¼Œå¯ä»¥åœ¨å­˜å‚¨ä¸ºé‡‡é›†ææ–™ä¹‹å‰å…ˆè®© AIè¿›è¡Œä¸€è½®æ€»ç»“å’Œå…³é”®æå–ï¼Œè¿›ä¸€æ­¥æé«˜æ•ˆç‡ã€‚</li><li>é’ˆå¯¹æœ¬åœ°çš„å½•éŸ³ã€è§†é¢‘ï¼Œå¯ä»¥ç”¨â€é€šä¹‰å¬æ‚Ÿâ€œç­‰ AIè½¯ä»¶æŠŠå†…å®¹è½¬å½•ä¸ºæ–‡å­—å¹¶æå–é‡ç‚¹ã€‚</li><li>é’ˆå¯¹åœ¨çº¿è§†é¢‘ï¼ˆYoutubeï¼ŒBilibiliï¼‰ï¼Œå¯ä»¥ä½¿ç”¨â€BilliGPTâ€œç­‰è½¯ä»¶è¿›è¡Œå†…å®¹æå–å’Œæ€»ç»“ã€‚</li><li>å¯ä»¥ä½¿ç”¨ Doubanæ’ä»¶ï¼Œå¿«é€ŸæŠ“å–ä¹¦ç±ã€ç”µå½±ç­‰ææ–™å…ƒä¿¡æ¯ï¼Œæ›´æ–¹ä¾¿åšæ™ºèƒ½å½’çº³å’Œæ•´ç†ã€‚</li><li>å¯ä»¥ä½¿ç”¨ weread æ’ä»¶ï¼Œå¿«é€Ÿæ‹‰å–å¾®ä¿¡è¯»ä¹¦çš„æ‘˜å½•ã€ç¬”è®°å’Œè¯„è®ºï¼Œå†åˆ©ç”¨ AIå¿«é€Ÿç”Ÿæˆä¸ªæ€§åŒ–çš„è¯»ä¹¦ç¬”è®°ã€‚</li></ol></li><li>å¯ä»¥ä½¿ç”¨ iCloud è¿›è¡Œå¤šç«¯åŒæ­¥ï¼ŒåŒæ—¶åœ¨ iPhoneä¸Šä½¿ç”¨ä¾¿æ·æŒ‡ä»¤å¿«é€Ÿé‡‡é›†ç½‘ç»œä¸Šéœ€è¦çš„ææ–™ã€‚</li><li>æ”¯æŒå¤šç§æ’ä»¶ï¼Œé™¤äº† markdownæ–‡å­—ä¹‹å¤–ï¼Œè¿˜å¯ä»¥åœ¨ç¬”è®°ä¸­åµŒå…¥å¤šä¸­ç±»å‹çš„ææ–™ï¼Œå¦‚å›¾ç‰‡ï¼ˆImageToolkitï¼‰ã€è§†é¢‘ï¼ˆConvert url to previewï¼ˆiframeï¼‰ã€PDFï¼ˆPDF++ï¼‰ã€‚</li></ol><h3id="aarrangeå½’ç±»è¿™ä¸€æ­¥å¤§éƒ¨åˆ†éœ€è¦äººå·¥æ“ä½œ">Aï¼ˆArrangeï¼‰å½’ç±»ï¼šè¿™ä¸€æ­¥å¤§éƒ¨åˆ†éœ€è¦äººå·¥æ“ä½œ</h3><ol type="1"><li>å®šä¹‰â€å½’ç±»ç¬”è®°æ¨¡ç‰ˆâ€œï¼Œè®¾ç«‹â€tagsã€createdã€linkâ€œé€šç”¨å±æ€§ï¼Œæ–¹ä¾¿åˆ©ç”¨dataviewã€æ ‡ç­¾è¿‡æ»¤å’ŒåŒé“¾åŠŸèƒ½å»ºç«‹çŸ¥è¯†ç½‘ç»œå’Œè¿‡æ»¤èƒ½åŠ›ã€‚</li><li>å¯ä»¥åœ¨æ—¥è®°ä¸­ï¼Œåˆ©ç”¨â€æ•°æ®åº“baseâ€œèƒ½åŠ›ï¼Œå¿«é€Ÿç­›é€‰å‡ºâ€å½“æ—¥æ–°å»ºç¬”è®°â€œï¼Œæ–¹é¢æ¯æ—¥å®šæ—¶è¿›è¡Œç¬”è®°æ¢³ç†å’Œæ¸…ç†ï¼Œä¿æŒçŸ¥è¯†åº“çš„æ•´æ´å’Œæœ‰åºã€‚</li><li>é€šè¿‡åŒé“¾åŠŸèƒ½ï¼Œè§£å†³äº†ä¿¡æ¯å­¤å²›çš„é—®é¢˜ï¼Œè®©ä¸åŒçš„ç¬”è®°ä¹‹é—´äº§ç”Ÿå…³è”å…³ç³»ã€‚</li></ol><h3 id="ppresentè¡¨è¾¾æœ€æ ¹æœ¬çš„ç›®æ ‡">Pï¼ˆPresentï¼‰è¡¨è¾¾ï¼šæœ€æ ¹æœ¬çš„ç›®æ ‡</h3><ol type="1"><li>å®šä¹‰â€è¡¨è¾¾ç¬”è®°æ¨¡ç‰ˆâ€œï¼Œè®¾ç«‹â€tagsã€createdã€linkâ€œé€šç”¨å±æ€§ï¼Œæ–¹ä¾¿åˆ©ç”¨dataviewã€æ ‡ç­¾è¿‡æ»¤å’ŒåŒé“¾åŠŸèƒ½å»ºç«‹çŸ¥è¯†ç½‘ç»œå’Œè¿‡æ»¤èƒ½åŠ›ã€‚</li><li>å½“å‰é¢ 2æ­¥æ˜¯å›´ç»•â€è¡¨è¾¾â€œè¿™ä¸€ç›®æ ‡æ¥æ‰§è¡Œåˆåšå¾—è¶³å¤Ÿå¥½çš„æ—¶å€™ï¼Œè¡¨è¾¾å°±æ˜¯è‡ªç„¶è€Œç„¶æ˜¯äº‹æƒ…äº†ï¼Œå› ä¸ºææ–™å·²ç»æœ‰åºæ•´ç†å¥½äº†ï¼Œå‰©ä¸‹çš„å°±æ˜¯ç»„ç»‡å’Œå¸æ”¶å†…åŒ–çš„éƒ¨åˆ†äº†ã€‚</li><li>å¯ä»¥åˆ©ç”¨ Copilot æ’ä»¶ï¼Œå°†ç›¸é“¾æ¥çš„ææ–™äº¤ç»™AIï¼Œç”Ÿæˆå¤§çº²æˆ–è¾“å‡ºæ–‡ç« çš„åˆç¨¿ã€‚è¿™é‡Œä¸€å®šè¦è‡ªå·±å»åšè¡¨è¾¾å’Œè¾“å‡ºï¼Œä¸è¦è¿‡åº¦ä¾èµ–AI çš„æ€è€ƒï¼Œåªæœ‰è‡ªå·±çš„å¤§è„‘ä¸æ–­æ€è€ƒå’Œå˜å¼ºï¼ŒçŸ¥è¯†ç®¡ç†æ‰æ˜¯æœ‰æ„ä¹‰çš„ã€‚</li><li>å½“è¡¨è¾¾ç¬”è®°äº§å‡ºå®Œæ¯•åï¼Œå†æ¬¡å°†å…¶ä¸çŸ¥è¯†åº“å·²æœ‰çš„å½’ç±»ç¬”è®°é“¾æ¥èµ·æ¥ï¼Œè¿™æ ·å®ƒåˆæˆä¸ºäº†ä¸€ä¸ªå¯å¤ç”¨çš„é«˜è´¨é‡ç´ æï¼Œä»¥æ­¤é€æ­¥å½¢æˆå¤åˆ©æ•ˆåº”ã€‚</li></ol><h2 id="ä¸‰å¤§åœºæ™¯">ä¸‰å¤§åœºæ™¯</h2><h3 id="æ—¥è®°å¤ç›˜">æ—¥è®°å¤ç›˜</h3><blockquote><p>Obsidian + Journals</p></blockquote><ol type="1"><li>ä½¿ç”¨ Journalsæ’ä»¶ï¼Œå®ç°æŒ‰æ—¥ã€å‘¨ã€æœˆã€å­£ã€å¹´è‡ªåŠ¨ç”Ÿæˆæ—¥è®°ç›®æ ‡å’Œé¡µé¢ã€‚</li><li>ä½¿ç”¨ Dataview ä»£ç ã€æ•°æ®åº“Baseï¼Œæ‰“é€ ç™¾å¹´æ—¥è®°è§†è§’ï¼Œå›é¡¾æ¯å¹´åŒä¸€å¤©ã€å‘¨ã€æœˆå‘ç”Ÿçš„äº‹æƒ…ã€‚</li><li>å€Ÿé‰´â€æœºä¼šæ—¥è®°â€œæ–¹æ³•ï¼Œæ¯å¤©è®°å½• 3 ä¸ªæœºä¼šã€3 ä¸ªåæ€ã€1ä¸ªæ„Ÿæ©ï¼Œå…»æˆæ•é”æ„ŸçŸ¥å’Œè°ƒæ•´çš„ä¹ æƒ¯ã€‚</li><li>åœ¨ Copilot æ’ä»¶ä¸­è®¾ç½®æç¤ºè¯æ¨¡æ¿ï¼Œè®© AIå·¥å…·è‡ªåŠ¨åˆ†æä¸€å‘¨çš„æ—¥è®°ï¼Œè¾“å‡ºæ€»ç»“å’Œæ”¹è¿›å»ºè®®ã€‚</li><li>ç”¨ AIå·¥å…·ç”Ÿæˆçš„å‘¨å¤ç›˜ï¼Œç»§ç»­ä½œä¸ºæœˆå¤ç›˜ã€å¹´å¤ç›˜çš„è¾“å…¥ææ–™ï¼Œå½¢æˆè¿è´¯çš„å¤ç›˜é“¾æ¡ã€‚</li></ol><h3 id="è¯»ä¹¦ç¬”è®°">è¯»ä¹¦ç¬”è®°</h3><blockquote><p>Obsidian + æ‘˜å½•å·¥å…· + AI</p></blockquote><ol type="1"><li>ä½¿ç”¨ Wereadï¼ˆå¾®ä¿¡è¯»ä¹¦ï¼‰ã€iBookï¼ˆè‹¹æœè¯»ä¹¦ï¼‰ã€KindleHighlightsï¼ˆKindleï¼‰ã€Readwise Officialç­‰æ’ä»¶å¯ä»¥å¿«é€Ÿå°†å„ä¸ªè¯»ä¹¦å¹³å°çš„åˆ’çº¿ã€ç¬”è®°å’Œè¯„è®ºåŒæ­¥åˆ° Obsidian ä¸­ã€‚</li><li>ä½¿ç”¨ Doubanæ’ä»¶è‡ªåŠ¨æŠ“å–è±†ç“£ä¸­çš„å›¾ä¹¦ã€ç”µå½±ã€ç”µè§†å‰§ç­‰å†…å®¹å…ƒä¿¡æ¯ï¼Œé«˜æ•ˆç‡å®Œå–„ç¬”è®°å†…å®¹ã€‚</li><li>ä½¿ç”¨ Dateviewæ’ä»¶ï¼Œå¯è‡ªåŠ¨æ±‡æ€»å·²å®Œæˆã€è¿›è¡Œä¸­ã€æœªå¼€å§‹çš„è¯»ä¹¦ç¬”è®°ã€‚</li><li>æ ¹æ®éœ€è¦å‡†å¤‡è¯»ä¹¦æ€»ç»“æç¤ºè¯ï¼Œä½¿ç”¨ Copilot æ’ä»¶åˆ©ç”¨ AIè¿›è¡Œè¾“å‡ºï¼ˆè¯»ä¹¦ç¬”è®°åˆç¨¿ã€å…¬ä¼—å·æ–‡ç« ã€å°çº¢ä¹¦å›¾æ–‡ã€æ’­å®¢å½•åˆ¶ç­‰ï¼‰ã€‚</li></ol><h3 id="çŸ¥è¯†ç®¡ç†">çŸ¥è¯†ç®¡ç†</h3><p>æœ¬ç¯‡æœ€å¼€å§‹æåˆ°çš„ [[ä¸Šå¤´Obsidianï¼šæ‰‹æŠŠæ‰‹æ•™ä½ ç”¨AIåšå¥½çŸ¥è¯†ç®¡ç†#é“]] å’Œ[[ä¸Šå¤´Obsidianï¼šæ‰‹æŠŠæ‰‹æ•™ä½ ç”¨AIåšå¥½çŸ¥è¯†ç®¡ç†#æœ¯]] å°†çš„å°±æ˜¯åŸºäº GAPé€»è¾‘è¿›è¡ŒçŸ¥è¯†ç®¡ç†ã€‚</p><p>è¿™é‡Œå†æ¬¡æ€»ç»“ä¸€ä¸‹æ ¸å¿ƒæµç¨‹ï¼š</p><ol type="1"><li>ææ–™é‡‡é›†<ol type="1"><li>ç½‘é¡µã€å…¬ä¼—å·æ–‡æ¡£ã€å°çº¢ä¹¦æ–‡ç« ï¼šObsidian Web Clipper + AIInterpreter</li><li>ä¹¦ç±ã€ç”µå½±ã€ç”µè§†å‰§å…ƒä¿¡æ¯ï¼šDouban</li><li>æœ¬åœ°è§†é¢‘ã€éŸ³é¢‘ï¼šé€šä¹‰å¬æ‚Ÿ</li><li>åœ¨çº¿è§†é¢‘ï¼šBilliGPT</li><li>ä¹¦ç±é˜…è¯»ï¼šWereadã€iBookã€Kindle Highlightsã€Readwise Official</li></ol></li><li>ææ–™å½’ç±»ï¼š<ol type="1"><li>åˆ†ç±»</li><li>é“¾æ¥</li></ol></li><li>è¡¨è¾¾è¾“å‡ºï¼š<ol type="1"><li>ç¡®å®šç›®æ ‡</li><li>AI è¾…åŠ©è¾“å‡º</li><li>é“¾æ¥å¤ç”¨</li></ol></li></ol>]]></content>
    
    
    <summary type="html">ã€Šä¸Šå¤´Obsidianï¼šæ‰‹æŠŠæ‰‹æ•™ä½ ç”¨AIåšå¥½çŸ¥è¯†ç®¡ç†ã€‹æå‡ºäº†ä¸€å¥—ä»¥â€œè¡¨è¾¾â€ä¸ºæ ¸å¿ƒçš„çŸ¥è¯†ç®¡ç†æ–¹æ³•â€”â€”GAPæ¨¡å‹ï¼šé‡‡é›†ï¼ˆGraspï¼‰ã€å½’ç±»ï¼ˆArrangeï¼‰ã€è¡¨è¾¾ï¼ˆPresentï¼‰ã€‚é€šè¿‡æ˜ç¡®ç›®æ ‡ã€é«˜æ•ˆé‡‡é›†ã€åˆç†å½’ç±»ï¼Œæœ€ç»ˆå€ŸåŠ©Obsidianä¸AIå·¥å…·å®ç°é«˜è´¨é‡è¾“å‡ºï¼Œå°†ç¢ç‰‡ä¿¡æ¯è½¬åŒ–ä¸ºç»“æ„åŒ–çŸ¥è¯†ç³»ç»Ÿï¼Œå¸®åŠ©ç”¨æˆ·ä»â€œä¿¡æ¯ç„¦è™‘â€èµ°å‘â€œçŸ¥è¯†æŒæ§â€ã€‚</summary>
    
    
    
    <category term="è¯»ä¹¦ç¬”è®°" scheme="https://hedon.top/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="AI" scheme="https://hedon.top/tags/AI/"/>
    
    <category term="è¯»ä¹¦ç¬”è®°" scheme="https://hedon.top/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
    <category term="Obsidian" scheme="https://hedon.top/tags/Obsidian/"/>
    
    <category term="çŸ¥è¯†ç®¡ç†" scheme="https://hedon.top/tags/%E7%9F%A5%E8%AF%86%E7%AE%A1%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€æ¬¡ç”± MySQL Gap é”å¯¼è‡´çš„é˜»å¡æ’æŸ¥å®å½•</title>
    <link href="https://hedon.top/2025/09/23/record-of-mysql-gap-lock/"/>
    <id>https://hedon.top/2025/09/23/record-of-mysql-gap-lock/</id>
    <published>2025-09-23T10:30:20.000Z</published>
    <updated>2025-10-14T09:34:14.711Z</updated>
    
    <content type="html"><![CDATA[<h2 id="èƒŒæ™¯ä¸ç—‡çŠ¶">èƒŒæ™¯ä¸ç—‡çŠ¶</h2><p>åœ¨ä¸€æ¬¡å¸¸è§„æ“ä½œä¸­ï¼Œä¸€æ¡ <code>INSERT</code> è¯­å¥ï¼ˆç›®æ ‡<code>id=664</code>ï¼‰è¢«é•¿æ—¶é—´é˜»å¡ï¼Œæœ€ååœ¨ Go åº”ç”¨å±‚æŠ¥é”™<code>invalid connection</code>ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT INTO</span> `chip_info`(`info`,`display_order`,`id`)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;&#123;...&#125;&#x27;</span>, <span class="number">519</span>, <span class="number">664</span>)</span><br><span class="line"><span class="keyword">ON</span> DUPLICATE KEY <span class="keyword">UPDATE</span> `info`<span class="operator">=</span><span class="keyword">VALUES</span>(`info`), `display_order`<span class="operator">=</span><span class="keyword">VALUES</span>(`display_order`);</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆæ’æŸ¥å®šä½ï¼Œé˜»å¡çš„æ ¹æºæ˜¯ MySQL çš„ Gapé”ï¼ˆé—´éš™é”ï¼‰ã€‚é€šè¿‡ç»ˆæ­¢æŒæœ‰è¯¥é”çš„æ‚¬æŒ‚äº‹åŠ¡ï¼Œæ“ä½œç«‹å³æ¢å¤æ­£å¸¸ã€‚</p><h2 id="gap-é”ä¸-next-key-é”çš„å®šä¹‰">Gap é”ä¸ Next-Key é”çš„å®šä¹‰</h2><ul><li><strong>Gap é” (GapLock)</strong>ï¼šè¿™æ˜¯ä¸€ç§é”æœºåˆ¶ï¼Œå®ƒé”å®šçš„ä¸æ˜¯å…·ä½“çš„æŸä¸€è¡Œè®°å½•ï¼Œè€Œæ˜¯ç´¢å¼•è®°å½•ä¹‹é—´çš„"é—´éš™"ã€‚å…¶å”¯ä¸€ç›®çš„æ˜¯é˜²æ­¢å…¶ä»–äº‹åŠ¡åœ¨è¿™ä¸ªé—´éš™ä¸­æ‰§è¡Œ<code>INSERT</code> æ“ä½œã€‚</li><li><strong>Next-Key é” (Next-Key Lock)</strong>ï¼šè¿™æ˜¯ InnoDB åœ¨<code>REPEATABLE READ</code>éš”ç¦»çº§åˆ«ä¸‹çš„é»˜è®¤é”ç­–ç•¥ã€‚å®ƒæœ¬è´¨ä¸Šæ˜¯<strong>è¡Œé” (Record Lock)</strong>ä¸è¯¥è¡Œè®°å½•ä¹‹å‰<strong>é—´éš™çš„ Gap é”</strong>çš„ç»„åˆã€‚Next-Keyé”æ˜¯è§£å†³å¹»è¯»é—®é¢˜çš„æ ¸å¿ƒæœºåˆ¶ã€‚</li></ul><h2 id="ç¬¬ä¸€æ€§åŸç†ä¸ºä»€ä¹ˆéœ€è¦-gap-é”">ç¬¬ä¸€æ€§åŸç†ï¼šä¸ºä»€ä¹ˆéœ€è¦ Gapé”ï¼Ÿ</h2><p><strong>æ ¸å¿ƒç›®æ ‡ï¼šå®ç°å¯é‡å¤è¯» (Repeatable Read)</strong></p><p>åœ¨ <code>REPEATABLE READ</code>éš”ç¦»çº§åˆ«ä¸‹ï¼Œæ•°æ®åº“æ‰¿è¯ºåœ¨ä¸€ä¸ªäº‹åŠ¡å†…ï¼Œå¯¹åŒä¸€æ¡ä»¶çš„å¤šæ¬¡æŸ¥è¯¢å°†è¿”å›å®Œå…¨ç›¸åŒçš„ç»“æœé›†ã€‚å¦‚æœä¸å­˜åœ¨Gap é”ï¼Œå¹¶å‘çš„ INSERT æ“ä½œä¼šç ´åè¿™ä¸€æ‰¿è¯ºï¼Œå¯¼è‡´å¹»è¯» (Phantom Read)ã€‚</p><p><strong>å¹»è¯»åœºæ™¯ç¤ºä¾‹ (æ—  Gap é”çš„æƒ…å†µä¸‹)</strong></p><ul><li>T1: <code>SELECT * FROM t WHERE id &lt; 25;</code> è¿”å› 5æ¡è®°å½•ã€‚</li><li>T2: <code>INSERT INTO t(id) VALUES (15);</code> å¹¶æäº¤ã€‚</li><li>T1: å†æ¬¡æ‰§è¡Œ<code>SELECT * FROM t WHERE id &lt;25;</code>ï¼Œæ­¤æ—¶å°†è¿”å› 6 æ¡è®°å½•ã€‚äº‹åŠ¡T1 å†…çš„æŸ¥è¯¢ç»“æœé›†å‘ç”Ÿäº†å˜åŒ–ï¼Œè¿åäº†å¯é‡å¤è¯»çš„åŸåˆ™ã€‚</li></ul><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250923193114676.png" style="zoom:50%;" /></p><p><strong>Gap é”çš„è§£å†³æ–¹æ¡ˆ</strong></p><p>ä¸ºäº†é˜²æ­¢å¹»è¯»ï¼ŒInnoDB å¼•å…¥äº† Gap/Next-Key é”ã€‚å½“äº‹åŠ¡ T1æ‰§è¡ŒèŒƒå›´æŸ¥è¯¢æ—¶ï¼ŒInnoDBä¸ä»…ä¼šé”ä½æ»¡è¶³æ¡ä»¶çš„å·²æœ‰è¡Œï¼Œè¿˜ä¼šé”ä½æŸ¥è¯¢èŒƒå›´å†…çš„æ‰€æœ‰"é—´éš™"ã€‚è¿™æ ·ï¼Œäº‹åŠ¡T2 çš„ INSERT æ“ä½œå› æ— æ³•åœ¨é”å®šçš„é—´éš™ä¸­æ’å…¥æ•°æ®è€Œè¢«é˜»å¡ï¼Œç›´åˆ° T1æäº¤æˆ–å›æ»šï¼Œä»è€Œä¿è¯äº† T1 çš„æŸ¥è¯¢ç»“æœä¸€è‡´æ€§ã€‚</p><p><strong>ç†è®ºä¸å®è·µçš„å¹³è¡¡</strong></p><p>Gap é”å¯ä»¥çœ‹ä½œæ˜¯ç†è®ºä¸Šè°“è¯é” (Predicate Lock)çš„ä¸€ç§å·¥ç¨‹åŒ–ã€é«˜æ€§èƒ½çš„è¿‘ä¼¼å®ç°ã€‚å®ƒé€šè¿‡é”å®šç´¢å¼•åŒºé—´æ¥é—´æ¥å®ç°å¯¹æŸ¥è¯¢è°“è¯çš„ä¿æŠ¤ã€‚åŒæ—¶ï¼Œè¿™ç§æœºåˆ¶ä¹Ÿä¿è¯äº†åŸºäºè¯­å¥çš„å¤åˆ¶ï¼ˆSBRï¼‰åœ¨ä¸»ä»ç¯å¢ƒä¸‹æ‰§è¡Œç»“æœçš„ç¡®å®šæ€§ã€‚</p><h2 id="gap-é”çš„è§¦å‘åœºæ™¯">Gap é”çš„è§¦å‘åœºæ™¯</h2><p>Gapé”çš„äº§ç”Ÿä¸<strong>éš”ç¦»çº§åˆ«</strong>ã€<strong>ç´¢å¼•ä½¿ç”¨</strong>å’Œ<strong>æŸ¥è¯¢ç±»å‹</strong>å¯†åˆ‡ç›¸å…³ã€‚</p><p><strong>åœ¨ <code>REPEATABLE READ</code> éš”ç¦»çº§åˆ«ä¸‹</strong>ï¼š</p><ul><li><strong>èŒƒå›´æŸ¥è¯¢</strong>ï¼šæ‰§è¡Œ<code>SELECT ... FOR UPDATE</code>ã€<code>SELECT ... LOCK IN SHARE MODE</code>ã€<code>UPDATE</code>ã€<code>DELETE</code>æ—¶ï¼Œè‹¥ <code>WHERE</code> æ¡ä»¶æ˜¯èŒƒå›´æ‰«æï¼ˆå¦‚<code>&gt;</code>ã€<code>&lt;</code>ã€<code>BETWEEN</code>ï¼‰ï¼Œä¼šé”å®šæ‰«æè¿‡çš„ç´¢å¼•åŒºé—´ã€‚</li><li><strong>å”¯ä¸€ç´¢å¼•ç­‰å€¼æŸ¥è¯¢æœªå‘½ä¸­</strong>ï¼šå½“ä½¿ç”¨å”¯ä¸€ç´¢å¼•ï¼ˆåŒ…æ‹¬ä¸»é”®ï¼‰è¿›è¡Œç­‰å€¼æŸ¥è¯¢ï¼Œä½†è¯¥è®°å½•<strong>ä¸å­˜åœ¨</strong>æ—¶ï¼Œä¸ºé˜²æ­¢å¹¶å‘æ’å…¥è¯¥å€¼ï¼ŒInnoDBä¼šåœ¨å¯¹åº”ä½ç½®åŠ ä¸Š Gap é”ã€‚</li></ul><p><strong>åœ¨ <code>READ COMMITTED</code> éš”ç¦»çº§åˆ«ä¸‹</strong>ï¼š</p><ul><li>è¯¥çº§åˆ«ä¸‹é»˜è®¤<strong>ç¦ç”¨</strong> Gapé”ï¼Œå› æ­¤å¤§å¤§å‡å°‘äº†é˜»å¡æ¦‚ç‡ã€‚</li><li>ä½†åœ¨å¤–é”®çº¦æŸæ£€æŸ¥å’Œå”¯ä¸€æ€§æ£€æŸ¥è¿™ä¸¤ç§ç‰¹æ®Šåœºæ™¯ä¸‹ï¼Œä¸ºäº†ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œä»ç„¶å¯èƒ½ä¼šäº§ç”ŸGap é”ã€‚</li></ul><h2 id="è¯Šæ–­ä¸å®šä½æ–¹æ³•-mysql-8.0">è¯Šæ–­ä¸å®šä½æ–¹æ³• (MySQL 8.0+)</h2><p>å½“æ€€ç–‘å‘ç”Ÿ Gap é”é˜»å¡æ—¶ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹è§†å›¾è¿›è¡Œè¯Šæ–­ï¼š</p><ol type="1"><li><p><strong>æŸ¥è¯¢é”ç­‰å¾…å…³ç³»</strong>ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> performance_schema.data_lock_waits;</span><br></pre></td></tr></table></figure><p>è¯¥è¡¨ç›´æ¥å±•ç¤ºäº†å“ªä¸ªäº‹åŠ¡æ­£åœ¨ç­‰å¾…å“ªä¸ªäº‹åŠ¡æ‰€æŒæœ‰çš„é”ã€‚</p></li><li><p><strong>æŸ¥è¯¢æ´»è·ƒäº‹åŠ¡</strong>ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.INNODB_TRX;</span><br></pre></td></tr></table></figure><p>è¯¥è¡¨åˆ—å‡ºäº†æ‰€æœ‰å½“å‰æ­£åœ¨è¿è¡Œçš„äº‹åŠ¡åŠå…¶çŠ¶æ€ã€æ‰§è¡Œçš„ SQLç­‰ä¿¡æ¯ã€‚</p></li><li><p><strong>å…³è”æŸ¥è¯¢ï¼ˆæ¨èï¼‰ï¼š</strong></p><p>é€šè¿‡ä»¥ä¸‹æŸ¥è¯¢å¯ä»¥å°†äº‹åŠ¡ä¿¡æ¯ä¸é”ä¿¡æ¯å…³è”ï¼Œå¿«é€Ÿå®šä½æŒæœ‰é”çš„äº‹åŠ¡ ID(trx_id) å’Œå…¶å¯¹åº”çš„æ•°æ®åº“è¿æ¥ ID (trx_mysql_thread_id)ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  t.trx_id, t.trx_state, t.trx_started, t.trx_mysql_thread_id, t.trx_query</span><br><span class="line"><span class="keyword">FROM</span> information_schema.INNODB_TRX t</span><br><span class="line"><span class="keyword">JOIN</span> performance_schema.data_locks dl</span><br><span class="line">  <span class="keyword">ON</span> t.trx_id <span class="operator">=</span> dl.ENGINE_TRANSACTION_ID</span><br><span class="line"><span class="keyword">WHERE</span> dl.LOCK_STATUS <span class="operator">=</span> <span class="string">&#x27;GRANTED&#x27;</span> <span class="comment">-- æ‰¾åˆ°æŒæœ‰é”çš„äº‹åŠ¡</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> t.trx_started;</span><br></pre></td></tr></table></figure></li></ol><h2 id="åº”æ€¥è§£å†³æ–¹æ¡ˆ">åº”æ€¥è§£å†³æ–¹æ¡ˆ</h2><p>å®šä½åˆ°æŒæœ‰é”çš„äº‹åŠ¡åï¼Œæœ€ç›´æ¥çš„è§£å†³æ–¹æ³•æ˜¯ç»ˆæ­¢å…¶æ•°æ®åº“è¿æ¥ã€‚</p><ol type="1"><li><p><strong>è·å–è¿æ¥ ID (thread_id)ï¼š</strong></p><p>é€šè¿‡ä¸Šè¿°è¯Šæ–­æŸ¥è¯¢ï¼Œæ‰¾åˆ° <code>trx_mysql_thread_id</code>ã€‚</p></li><li><p><strong>ç»ˆæ­¢è¿æ¥</strong>ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">KILL [trx_mysql_thread_id]; <span class="comment">-- å°† ID æ›¿æ¢ä¸ºå®é™…å€¼</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ <code>KILL</code>å‘½ä»¤åï¼Œè¯¥äº‹åŠ¡ä¼šç«‹å³å›æ»šï¼Œé‡Šæ”¾å…¶æŒæœ‰çš„æ‰€æœ‰é”ï¼Œä»è€Œè§£å†³é˜»å¡é—®é¢˜ã€‚</p></li></ol><h2 id="å¦‚ä½•è§„é¿-gap-é”é—®é¢˜">å¦‚ä½•è§„é¿ Gap é”é—®é¢˜</h2><ul><li><strong>ç¼©çŸ­äº‹åŠ¡ç”Ÿå‘½å‘¨æœŸ</strong>ï¼šä¿æŒäº‹åŠ¡ç®€çŸ­ï¼Œå°½å¿«<code>COMMIT</code> æˆ– <code>ROLLBACK</code>ï¼Œå‡å°‘é”çš„æŒæœ‰æ—¶é—´ã€‚</li><li><strong>é€‰æ‹©åˆé€‚çš„éš”ç¦»çº§åˆ«</strong>ï¼šå¦‚æœä¸šåŠ¡é€»è¾‘å…è®¸ï¼Œå°†éš”ç¦»çº§åˆ«è®¾ç½®ä¸º<code>READ COMMITTED</code> æ˜¯æœ€æœ‰æ•ˆçš„è§„é¿æ–¹æ³•ã€‚</li><li><strong>ä¼˜åŒ–æŸ¥è¯¢ï¼Œç²¾å‡†é”å®š</strong>ï¼š<ul><li>å°½é‡ä½¿ç”¨å”¯ä¸€ç´¢å¼•è¿›è¡Œç­‰å€¼æŸ¥è¯¢å’Œæ›´æ–°ï¼Œé¿å…èŒƒå›´æ‰«æã€‚</li><li>ç¡®ä¿æŸ¥è¯¢æ¡ä»¶èƒ½å¤Ÿå‘½ä¸­é«˜æ•ˆçš„ç´¢å¼•ï¼Œé¿å…å› ç´¢å¼•ä¸å½“å¯¼è‡´é”èŒƒå›´æ‰©å¤§ã€‚</li></ul></li><li><strong>è°¨æ…ä½¿ç”¨é”å®šè¯»</strong>ï¼šä»…åœ¨å¿…è¦æ—¶ä½¿ç”¨<code>SELECT ... FOR UPDATE</code>ï¼Œå¹¶ç¡®ä¿ <code>WHERE</code>æ¡ä»¶å°½å¯èƒ½ç²¾ç¡®ã€‚</li><li><strong>è®¾ç½®é”ç­‰å¾…è¶…æ—¶</strong>ï¼šåˆç†é…ç½®<code>innodb_lock_wait_timeout</code>ï¼Œé¿å…åº”ç”¨å› é•¿æ—¶é—´ç­‰å¾…é”è€Œæ— å“åº”ã€‚</li></ul>]]></content>
    
    
    <summary type="html">è®°å½•ä¸€æ¬¡çº¿ä¸Š INSERT è¢«é•¿æ—¶é—´é˜»å¡çš„å®šä½è¿‡ç¨‹ï¼Œæœ€ç»ˆç¡®è®¤ç”± MySQL Gap/Next-Key é”å¼•èµ·ï¼›æ–‡ä¸­è¯´æ˜é”çš„åŸç†ä¸è§¦å‘åœºæ™¯ï¼Œæä¾› MySQL 8.0 çš„ data_lock_waits/INNODB_TRX è¯Šæ–­æ–¹æ³•ã€KILL åº”æ€¥ï¼Œä»¥åŠéš”ç¦»çº§åˆ«ã€ç´¢å¼•ä¸è¯­å¥ä¼˜åŒ–ç­‰è§„é¿å»ºè®®ã€‚</summary>
    
    
    
    <category term="æ•…éšœæ’æŸ¥" scheme="https://hedon.top/categories/%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5/"/>
    
    
    <category term="æœåŠ¡å™¨" scheme="https://hedon.top/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    
    <category term="MySQL" scheme="https://hedon.top/tags/MySQL/"/>
    
    <category term="Gapé”" scheme="https://hedon.top/tags/Gap%E9%94%81/"/>
    
  </entry>
  
  <entry>
    <title>Redis æ•°æ®ç±»å‹ä¸¨Sorted Setä¸¨listpack vs. skiplist+dict</title>
    <link href="https://hedon.top/2025/09/18/redis/redis-datatype-sorted-set/"/>
    <id>https://hedon.top/2025/09/18/redis/redis-datatype-sorted-set/</id>
    <published>2025-09-18T11:41:00.000Z</published>
    <updated>2025-10-14T09:34:14.711Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ Redis çš„æ•°æ®ä¸–ç•Œé‡Œï¼Œå¦‚æœè¯´ String æ˜¯åŸºçŸ³ï¼ŒHash æ˜¯å¯¹è±¡çš„æ˜ å°„ï¼Œé‚£ä¹ˆSorted Set (ZSet)åˆ™æ˜¯é‚£ä¸ªå°†<strong>æ’åº</strong>ä¸<strong>é›†åˆ</strong>ä¸¤å¤§ç‰¹æ€§å®Œç¾èåˆçš„ç‘å£«å†›åˆ€ã€‚å®ƒä¸ä»…èƒ½èƒœä»»å„ç§æ’è¡Œæ¦œç³»ç»Ÿï¼Œè¿˜èƒ½åœ¨å»¶è¿Ÿé˜Ÿåˆ—ã€èŒƒå›´æŸ¥æ‰¾ç­‰é«˜çº§åœºæ™¯ä¸­å¤§æ”¾å¼‚å½©ã€‚</p><p>ç„¶è€Œï¼Œä½ æ˜¯å¦æƒ³è¿‡ï¼š</p><ul><li>ä¸ºä»€ä¹ˆ <code>ZADD</code> ä¸€ä¸ªæ–°æˆå‘˜çš„æ—¶é—´å¤æ‚åº¦æ˜¯ <spanclass="math inline">\(O(logN)\)</span>ï¼Ÿ</li><li>ä¸ºä»€ä¹ˆ Redis æ—¢éœ€è¦ä¸€ä¸ªå“ˆå¸Œè¡¨ (dict) åˆéœ€è¦ä¸€ä¸ªè·³è¡¨ (skiplist)æ¥å®ç°å®ƒï¼Ÿ</li><li>åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ï¼Œå®ƒåˆä¼šå˜èº«ä¸ºä¸€ç§å«åš <code>listpack</code>çš„ç´§å‡‘ç»“æ„ï¼Ÿ</li></ul><p>ä»Šå¤©ï¼Œå°±è®©æˆ‘ä»¬ä»ç¬¬ä¸€æ€§åŸç†å‡ºå‘ï¼Œç©¿é€ API çš„è¡¨è±¡ï¼Œç›´æŠµ Sorted Setçš„è®¾è®¡æ ¸å¿ƒï¼Œå½»åº•ç†è§£å®ƒåœ¨æ€§èƒ½ä¸å†…å­˜ä¹‹é—´çš„æè‡´å¹³è¡¡ã€‚</p><h2 id="sorted-set-è¦è§£å†³çš„æ ¸å¿ƒçŸ›ç›¾">Sorted Set è¦è§£å†³çš„æ ¸å¿ƒçŸ›ç›¾</h2><p>ä»»ä½•ç²¾å¦™è®¾è®¡çš„èƒŒåï¼Œéƒ½æ˜¯ä¸ºäº†è§£å†³ä¸€ä¸ªæ ¹æœ¬æ€§çš„çŸ›ç›¾ã€‚Sorted Setè¦è§£å†³çš„æ ¸å¿ƒçŸ›ç›¾æ˜¯ï¼š<strong>å¦‚ä½•åˆ›å»ºä¸€ä¸ªæ—¢èƒ½é€šè¿‡æˆå‘˜ï¼ˆmemberï¼‰å¿«é€ŸæŸ¥æ‰¾ã€åˆèƒ½æ ¹æ®åˆ†æ•°ï¼ˆscoreï¼‰é«˜æ•ˆæ’åºå’ŒèŒƒå›´æŸ¥æ‰¾çš„æ•°æ®é›†åˆï¼Ÿ</strong></p><p>è®©æˆ‘ä»¬æ¥æ¨æ¼”ä¸€ä¸‹ï¼š</p><ol type="1"><li><strong>å¦‚æœåªæœ‰"é›†åˆ"éœ€æ±‚</strong>ï¼šæˆ‘ä»¬éœ€è¦ä¸€ä¸ªèƒ½å­˜å‚¨å”¯ä¸€æˆå‘˜å¹¶èƒ½<span class="math inline">\(O(1)\)</span>å¿«é€ŸæŸ¥æ‰¾çš„æ•°æ®ç»“æ„ã€‚æ¯«æ— ç–‘é—®ï¼Œ<strong>å“ˆå¸Œè¡¨ (Hash Table /Dictionary)</strong> æ˜¯æœ€ä½³é€‰æ‹©ã€‚ä½†å®ƒçš„è‡´å‘½å¼±ç‚¹æ˜¯â€”â€”æ— åºã€‚</li><li><strong>å¦‚æœåªæœ‰"æ’åº"éœ€æ±‚</strong>ï¼šæˆ‘ä»¬å¯ä»¥ç”¨<strong>æœ‰åºæ•°ç»„</strong>æˆ–<strong>å¹³è¡¡äºŒå‰æœç´¢æ ‘</strong>ã€‚<ul><li><strong>æœ‰åºæ•°ç»„</strong>ï¼šèŒƒå›´æŸ¥æ‰¾æ€§èƒ½æä½³ï¼ˆäºŒåˆ†æ³•ï¼‰ï¼Œä½†æ’å…¥å’Œåˆ é™¤çš„æˆæœ¬å¤ªé«˜(<span class="math inline">\(O(N)\)</span>)ï¼Œå› ä¸ºéœ€è¦ç§»åŠ¨å¤§é‡å…ƒç´ ã€‚</li><li><strong>å¹³è¡¡äºŒå‰æœç´¢æ ‘</strong>ï¼ˆå¦‚çº¢é»‘æ ‘ï¼‰ï¼šæ’å…¥ã€åˆ é™¤ã€æŸ¥æ‰¾éƒ½æ˜¯<spanclass="math inline">\(O(logN)\)</span>ï¼Œæ€§èƒ½å¾ˆå¥½ã€‚ä½†å®ç°éå¸¸å¤æ‚ï¼Œä¸”åœ¨èŒƒå›´æŸ¥æ‰¾ä¸Šä¸å¦‚è·³è¡¨ç›´è§‚ã€‚</li></ul></li></ol><p>å¯ä»¥çœ‹åˆ°ï¼Œå•ä¸€çš„æ•°æ®ç»“æ„æ— æ³•åŒæ—¶æ»¡è¶³"é›†åˆ"å’Œ"æ’åº"ä¸¤å¤§éœ€æ±‚ã€‚å› æ­¤ï¼ŒRediså¿…é¡»é‡‡ç”¨ä¸€ç§<strong>å¤åˆå‹</strong>çš„è®¾è®¡ã€‚è¿™æ­£æ˜¯ Sorted Setå†…éƒ¨"åŒå¼•æ“"æ¨¡å¼çš„ç†è®ºåŸºç¡€ã€‚</p><h2 id="æ­ç§˜-sorted-set-çš„å†…éƒ¨ç¼–ç ">æ­ç§˜ Sorted Set çš„å†…éƒ¨ç¼–ç </h2><p>ä¸ºäº†åœ¨ä¸åŒåœºæ™¯ä¸‹éƒ½è¾¾åˆ°æœ€ä¼˜çš„æ€§èƒ½ä¸å†…å­˜å¹³è¡¡ï¼ŒRedis ä¸º Sorted Setæä¾›äº†ä¸¤ç§å†…éƒ¨ç¼–ç ï¼ˆEncodingï¼‰ï¼Œå¯¹ç”¨æˆ·é€æ˜ï¼Œä½†å†…éƒ¨ä¼šè‡ªåŠ¨è½¬æ¢ã€‚</p><h3 id="listpackæè‡´ç´§å‡‘çš„æ•°ç»„æ¨¡å¼">1.<code>listpack</code>ï¼šæè‡´ç´§å‡‘çš„"æ•°ç»„"æ¨¡å¼</h3><p>å½“ Sorted Set ä¸­å­˜å‚¨çš„å…ƒç´ æ•°é‡å¾ˆå°‘ï¼Œå¹¶ä¸”æ¯ä¸ªå…ƒç´ çš„å€¼éƒ½ä¸å¤§æ—¶ï¼ŒRedisä¼šé€‰æ‹© <code>listpack</code> ç¼–ç ã€‚</p><ul><li><strong>è§¦å‘æ¡ä»¶</strong> (redis.conf é»˜è®¤é…ç½®):<ul><li>å…ƒç´ æ•°é‡å°äº <code>zset-max-listpack-entries 128</code></li><li>æ‰€æœ‰å…ƒç´ å€¼çš„å­—èŠ‚é•¿åº¦å°äº<code>zset-max-listpack-value 64</code></li></ul></li><li>åº•å±‚åŸç†ï¼š<code>listpack</code> æœ¬è´¨ä¸Šæ˜¯ä¸€å—è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œå®ƒå°†æ¯ä¸ª(member, score)å¯¹ç´§å‡‘åœ°åºåˆ—åŒ–å­˜å‚¨ã€‚ä¸ºäº†ä¿æŒæœ‰åºï¼Œæ¯æ¬¡æ’å…¥éƒ½éœ€è¦æ‰¾åˆ°æ­£ç¡®çš„ä½ç½®ï¼Œè¿™å¯èƒ½å¯¼è‡´å…¶åçš„æ•°æ®å‘ç”Ÿç§»åŠ¨ã€‚</li><li><strong>æ€§èƒ½æƒè¡¡</strong>:<ul><li><strong>ä¼˜ç‚¹</strong>ï¼šå†…å­˜åˆ©ç”¨ç‡æé«˜ï¼Œå› ä¸ºå®ƒæ¶ˆé™¤äº†æ‰€æœ‰æŒ‡é’ˆå¼€é”€ã€‚</li><li><strong>ç¼ºç‚¹</strong>ï¼šæ’å…¥ã€åˆ é™¤ã€æŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ <spanclass="math inline">\(O(N)\)</span>ã€‚</li><li><strong>è®¾è®¡å“²å­¦</strong>ï¼šè¿™æ˜¯ä¸€ç§å…¸å‹çš„<strong>ç”¨æ—¶é—´æ¢ç©ºé—´</strong>çš„ç­–ç•¥ã€‚å½“<code>N</code> éå¸¸å°ï¼ˆä¾‹å¦‚å°äº128ï¼‰æ—¶ï¼Œ<spanclass="math inline">\(O(N)\)</span>çš„æ“ä½œæˆæœ¬æä½ï¼Œå‡ ä¹æ˜¯ç¬æ—¶çš„ï¼Œè€ŒèŠ‚çœä¸‹æ¥çš„å†…å­˜å´éå¸¸å¯è§‚ã€‚</li></ul></li></ul><blockquote><p>å…³äº listpack çš„å…·ä½“è¯´æ˜ï¼Œå¯ä»¥å‚è€ƒä¹‹å‰çš„<ahref="https://hedon.top/2025/08/20/redis/redis-datatype-list/#%E5%AE%8C%E7%BE%8E%E8%BF%9B%E5%8C%96listpack-%E7%9A%84%E6%9C%80%E7%BB%88%E5%BD%A2%E6%80%81">Redisæ•°æ®ç±»å‹ä¸¨Listä¸¨ä»åŒå‘é“¾è¡¨åˆ° Listpack çš„æ¼”è¿›ä¹‹è·¯ (åŸºäº Redis 8.2.1æºç )</a>ï¼Œå®ƒä»¬å…¶å®æ˜¯ä¸€ä¸ªä¸œè¥¿ï¼</p></blockquote><h3 id="skiplist-dicté«˜æ€§èƒ½åŒå¼•æ“æ¨¡å¼">2. <code>skiplist</code> +<code>dict</code>ï¼šé«˜æ€§èƒ½"åŒå¼•æ“"æ¨¡å¼</h3><p>ä¸€æ—¦ <code>listpack</code> çš„ä»»ä¸€è§¦å‘æ¡ä»¶è¢«æ‰“ç ´ï¼ŒRedisä¼šè‡ªåŠ¨å°†å…¶è½¬æ¢ä¸º <code>skiplist</code> + <code>dict</code> ç¼–ç ã€‚è¿™æ‰æ˜¯Sorted Set çš„å®Œå…¨ä½“å½¢æ€ã€‚</p><ul><li><strong><code>dict</code>(å­—å…¸/å“ˆå¸Œè¡¨)</strong>ï¼šè´Ÿè´£"é›†åˆ"çš„éƒ¨åˆ†ã€‚å®ƒå»ºç«‹äº†ä¸€ä¸ªä»<code>member</code> åˆ° <code>score</code> çš„æ˜ å°„ã€‚è¿™ä½¿å¾—<code>ZSCORE</code> è¿™ç§é€šè¿‡æˆå‘˜è·å–åˆ†æ•°çš„æ“ä½œï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯å®Œç¾çš„ <spanclass="math inline">\(O(1)\)</span>ã€‚</li><li><strong><code>zskiplist</code>(è·³è¡¨)</strong>ï¼šè´Ÿè´£"æ’åº"çš„éƒ¨åˆ†ã€‚å®ƒå°†æ‰€æœ‰çš„<code>(score, member)</code> å¯¹æŒ‰ç…§ <code>score</code>ï¼ˆåˆ†æ•°ç›¸åŒåˆ™æŒ‰<code>member</code>å­—å…¸åºï¼‰è¿›è¡Œæ’åºã€‚è·³è¡¨çš„ç‰¹æ€§ä½¿å¾—æ’å…¥ã€åˆ é™¤å’ŒæŒ‰æ’å/åˆ†æ•°èŒƒå›´æŸ¥æ‰¾çš„å¹³å‡æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯<span class="math inline">\(O(logN)\)</span>ã€‚</li></ul><p><strong>æ•°æ®å…±äº«</strong>ï¼šä¸ºäº†èŠ‚çº¦å†…å­˜ï¼Œ<code>dict</code> å’Œ<code>skiplist</code> ä¸­çš„ <code>member</code>å­—ç¬¦ä¸²æ˜¯å…±äº«çš„ï¼Œå³å®ƒä»¬éƒ½æŒ‡å‘åŒä¸€ä¸ª<code>SDS (Simple Dynamic String)</code> å¯¹è±¡ã€‚</p><p>è·³è¡¨çš„æ ¸å¿ƒæ€æƒ³æ˜¯<strong>ç©ºé—´æ¢æ—¶é—´</strong>å’Œ<strong>éšæœºåŒ–</strong>ã€‚</p><p>æƒ³è±¡ä¸€ä¸‹ï¼Œä¸€ä¸ªæ™®é€šçš„å•é“¾è¡¨ï¼ŒæŸ¥æ‰¾æ•ˆç‡æ˜¯ <spanclass="math inline">\(O(N)\)</span>ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬ä»è¿™ä¸ªé“¾è¡¨ä¸­ï¼ŒéšæœºæŠ½å–ä¸€äº›èŠ‚ç‚¹ï¼Œç»™å®ƒä»¬å¢åŠ ä¸€ä¸ª"ä¸Šå±‚æŒ‡é’ˆ"ï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªè¢«æŠ½å–çš„èŠ‚ç‚¹ã€‚è¿™æ ·æˆ‘ä»¬å°±æ„å»ºäº†ç¬¬2 å±‚"å¿«é€Ÿé€šé“"ã€‚æˆ‘ä»¬å¯ä»¥ä¸æ–­é‡å¤è¿™ä¸ªè¿‡ç¨‹ï¼Œæ„å»ºå‡ºå¤šå±‚å¿«é€Ÿé€šé“ã€‚</p><p>å½“æˆ‘ä»¬è¦æŸ¥æ‰¾ä¸€ä¸ªå…ƒç´ æ—¶ï¼š</p><ol type="1"><li>ä»æœ€é«˜å±‚çš„"å¿«é€Ÿé€šé“"å¼€å§‹ã€‚</li><li>åœ¨å½“å‰å±‚å‘å³æŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ¯”ç›®æ ‡å¤§ï¼Œæˆ–è€…åˆ°äº†é“¾è¡¨æœ«å°¾ã€‚</li><li>ç„¶åä»å½“å‰èŠ‚ç‚¹ä¸‹é™ä¸€å±‚ï¼Œé‡å¤æ­¥éª¤ 2ã€‚</li><li>æœ€ç»ˆåœ¨æœ€åº•å±‚ï¼ˆåŸå§‹é“¾è¡¨ï¼‰æ‰¾åˆ°ç›®æ ‡ä½ç½®ã€‚</li></ol><p>å› ä¸ºé«˜å±‚ç´¢å¼•å¯ä»¥è®©ä½ "è·³è¿‡"å¤§é‡èŠ‚ç‚¹ï¼Œæ‰€ä»¥å¹³å‡æŸ¥æ‰¾æ•ˆç‡è¢«æå‡åˆ°äº† <spanclass="math inline">\(O(logN)\)</span>ã€‚è€Œè¿™ç§å±‚çº§çš„å»ºç«‹æ˜¯å®Œå…¨éšæœºçš„ï¼Œå®ƒé€šè¿‡æ¦‚ç‡æ¥ç»´æŒæ•´ä½“çš„å¹³è¡¡ï¼Œé¿å…äº†çº¢é»‘æ ‘é‚£æ ·å¤æ‚çš„å¹³è¡¡æ“ä½œã€‚</p><p>è¿™å°±æ˜¯ Redisé€‰æ‹©è·³è¡¨çš„åŸå› ï¼š<strong>ç”¨æ›´ç®€å•çš„å®ç°ï¼Œè¾¾åˆ°äº†ä¸å¹³è¡¡æ ‘ç›¸åª²ç¾çš„æ€§èƒ½ã€‚</strong></p><h2 id="æ•°æ®ç»“æ„ä¸æ ¸å¿ƒç®—æ³•">æ•°æ®ç»“æ„ä¸æ ¸å¿ƒç®—æ³•</h2><p>ç†è§£äº†é¡¶å±‚è®¾è®¡ï¼Œæˆ‘ä»¬æ·±å…¥åˆ° Redis çš„ Cæºç ï¼Œçœ‹çœ‹è¿™äº›ç»“æ„æ˜¯å¦‚ä½•å®šä¹‰çš„ï¼Œåœ¨ Redis 8.2.1 çš„æºç ä¸­ï¼Œå…³äº<code>zset</code> çš„ç±»å‹å®šä¹‰ä½äº <ahref="https://github.com/redis/redis/blob/8.2.1/src/server.h#L1544">server.h</a>æ–‡ä»¶ä¸­ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼Œå®ƒä¸»è¦åŒ…å« 3ä¸ªæ ¸å¿ƒæ•°æ®ç»“æ„ï¼š<code>zset</code>ã€<code>zskiplist</code> å’Œ<code>zskiplistNode</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Sorted Set æ•´ä½“ç»“æ„ */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zset</span> &#123;</span></span><br><span class="line">    dict *dict;         <span class="comment">// å“ˆå¸Œè¡¨ï¼Œå®ç° member -&gt; score çš„ O(1) æŸ¥æ‰¾</span></span><br><span class="line">    zskiplist *zsl;     <span class="comment">// è·³è¡¨ï¼Œå®ç°æ’åºä¸èŒƒå›´æŸ¥æ‰¾</span></span><br><span class="line">&#125; zset;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è·³è¡¨ç»“æ„ */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zskiplist</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">header</span>, *<span class="title">tail</span>;</span> <span class="comment">// å¤´ã€å°¾èŠ‚ç‚¹</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> length;                 <span class="comment">// èŠ‚ç‚¹æ•°é‡</span></span><br><span class="line">    <span class="type">int</span> level;                            <span class="comment">// å½“å‰æœ€å¤§å±‚æ•°</span></span><br><span class="line">&#125; zskiplist;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è·³è¡¨èŠ‚ç‚¹ç»“æ„ */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> &#123;</span></span><br><span class="line">    sds ele;                          <span class="comment">// æˆå‘˜ (member)</span></span><br><span class="line">    <span class="type">double</span> score;                     <span class="comment">// åˆ†æ•° (score)</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">backward</span>;</span>   <span class="comment">// åé€€æŒ‡é’ˆ (ä»…åœ¨ L0 å±‚)</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistLevel</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">forward</span>;</span> <span class="comment">// å‰è¿›æŒ‡é’ˆ</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> span;            <span class="comment">// è·¨åº¦ (åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„è·ç¦»)</span></span><br><span class="line">    &#125; level[];                        <span class="comment">// æŸ”æ€§æ•°ç»„ï¼Œå­˜å‚¨æ¯ä¸€å±‚çš„ä¿¡æ¯</span></span><br><span class="line">&#125; zskiplistNode;</span><br></pre></td></tr></table></figure><p>ä»æ¯”è¾ƒç›´è§‚çš„è§’åº¦æ¥è®²çš„è¯ï¼Œè·³è¡¨çš„ç»“æ„å¯ä»¥ç”¨ä¸‹å›¾æ¥æ¼”ç¤ºï¼š</p><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250918190254554.png" /></p><p>å¦‚æœè¦å®Œå…¨å¤åˆ»ä¸Šè¿°æ‰€å®šä¹‰å‡ºæ¥çš„æ•°æ®ç»“æ„ï¼Œé‚£è¡¨ç¤ºèµ·æ¥å¯èƒ½ä¼šæœ‰ç‚¹å¤æ‚ï¼Œè¿™é‡Œæˆ‘ç”»äº†å¼ å›¾ï¼Œä¾›ä½ å‚è€ƒï¼š</p><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250918190417220.png" /></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä»ä¸€ä¸ªæœ€æ ¸å¿ƒçš„<strong>æ’å…¥</strong>é€»è¾‘æ¥æ›´è¿›ä¸€æ­¥äº†è§£è·³è¡¨çš„å®ç°ç»†èŠ‚ã€‚<code>zset</code> çš„æ ¸å¿ƒå®ç°é€»è¾‘ä½äº <ahref="https://github.com/redis/redis/blob/8.2.1/src/t_zset.c#L122">t_zset.c</a>æ–‡ä»¶ä¸­ï¼Œå…¶ä¸­æ’å…¥æ“ä½œç”± <code>zslInsert</code>å‡½æ•°æ¥å®ç°ã€‚è¿™é‡Œæˆ‘å…ˆæŠŠå®Œæ•´çš„ä»£ç å’Œæ³¨é‡Šç»™ä½ ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å†ä¸€ä¸€æ‹†è§£ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Insert a new node in the skiplist. Assumes the element does not already</span></span><br><span class="line"><span class="comment"> * exist (up to the caller to enforce that). The skiplist takes ownership</span></span><br><span class="line"><span class="comment"> * of the passed SDS string &#x27;ele&#x27;. */</span></span><br><span class="line">zskiplistNode *<span class="title function_">zslInsert</span><span class="params">(zskiplist *zsl, <span class="type">double</span> score, sds ele)</span> &#123;</span><br><span class="line">    <span class="comment">// update: è®°å½•æ–°èŠ‚ç‚¹åœ¨æ¯ä¸€å±‚çš„å‰é©±èŠ‚ç‚¹ï¼ˆéœ€è¦è¢«æ›´æ–°çš„èŠ‚ç‚¹ï¼‰</span></span><br><span class="line">    <span class="comment">// rank:   è®°å½•ä» header åˆ°æ¯ä¸€å±‚å‰é©±èŠ‚ç‚¹æ—¶ï¼Œè·¨è¶Šäº†å¤šå°‘ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rank[ZSKIPLIST_MAXLEVEL];</span><br><span class="line">    <span class="type">int</span> i, level;</span><br><span class="line"></span><br><span class="line">    serverAssert(!isnan(score));</span><br><span class="line">    x = zsl-&gt;header; <span class="comment">// ä»è·³è¡¨çš„å¤´èŠ‚ç‚¹å¼€å§‹</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 1. ä¾¦å¯Ÿä¸é™è½ï¼šä»é¡¶å±‚å‘ä¸‹æŸ¥æ‰¾æ’å…¥ä½ç½® */</span></span><br><span class="line">    <span class="comment">// ä»è·³è¡¨ç°æœ‰çš„æœ€é«˜å±‚å¼€å§‹ï¼Œé€å±‚ä¸‹é™</span></span><br><span class="line">    <span class="keyword">for</span> (i = zsl-&gt;level<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="comment">// rank[i] ç»§æ‰¿äº†ä¸Šä¸€å±‚ï¼ˆi+1ï¼‰çš„æ’åã€‚</span></span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯æœ€é«˜å±‚ï¼Œåˆå§‹æ’åä¸º 0ã€‚</span></span><br><span class="line">        rank[i] = i == (zsl-&gt;level<span class="number">-1</span>) ? <span class="number">0</span> : rank[i+<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åœ¨å½“å‰å±‚å‘å³å‰è¿›ï¼Œç›´åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„åˆ†æ•°å¤§äºç›®æ ‡åˆ†æ•°ï¼Œ</span></span><br><span class="line">        <span class="comment">// æˆ–è€…åˆ†æ•°ç›¸åŒä½†å…ƒç´ çš„å­—å…¸åºå¤§äºç›®æ ‡å…ƒç´ ã€‚</span></span><br><span class="line">        <span class="keyword">while</span> (x-&gt;level[i].forward &amp;&amp;</span><br><span class="line">               (x-&gt;level[i].forward-&gt;score &lt; score ||</span><br><span class="line">                   (x-&gt;level[i].forward-&gt;score == score &amp;&amp;</span><br><span class="line">                    sdscmp(x-&gt;level[i].forward-&gt;ele,ele) &lt; <span class="number">0</span>)))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// æ¯è·¨è¶Šä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°±å°†è¯¥èŠ‚ç‚¹çš„è·¨åº¦(span)ç´¯åŠ åˆ°æ’åä¸­</span></span><br><span class="line">            rank[i] += x-&gt;level[i].span;</span><br><span class="line">            x = x-&gt;level[i].forward; <span class="comment">// å‰è¿›åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ‰¾åˆ°äº†ï¼x æ˜¯æ–°èŠ‚ç‚¹åœ¨ç¬¬ i å±‚çš„å‰é©±èŠ‚ç‚¹ã€‚è®°å½•ä¸‹æ¥ã€‚</span></span><br><span class="line">        update[i] = x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 2. éšæœºå†³å®šæ–°èŠ‚ç‚¹çš„å±‚æ•° */</span></span><br><span class="line">    <span class="comment">// zslRandomLevel() é€šè¿‡ä¸€ä¸ªæ¦‚ç‡ç®—æ³•ï¼ˆå¹‚æ¬¡å®šå¾‹ï¼‰è¿”å›ä¸€ä¸ªéšæœºçš„å±‚æ•°ã€‚</span></span><br><span class="line">    <span class="comment">// å¤§éƒ¨åˆ†èŠ‚ç‚¹çš„å±‚æ•°å¾ˆä½ï¼ˆå¦‚1ï¼‰ï¼Œæå°‘æ•°èŠ‚ç‚¹çš„å±‚æ•°ä¼šå¾ˆé«˜ã€‚</span></span><br><span class="line">    level = zslRandomLevel();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœéšæœºå‡ºçš„å±‚æ•°æ¯”å½“å‰è·³è¡¨çš„æœ€é«˜å±‚è¿˜é«˜</span></span><br><span class="line">    <span class="keyword">if</span> (level &gt; zsl-&gt;level) &#123;</span><br><span class="line">        <span class="comment">// ä¸ºæ–°çš„ã€æ›´é«˜çš„å±‚çº§åˆå§‹åŒ– update[] å’Œ rank[]</span></span><br><span class="line">        <span class="keyword">for</span> (i = zsl-&gt;level; i &lt; level; i++) &#123;</span><br><span class="line">            rank[i] = <span class="number">0</span>;</span><br><span class="line">            update[i] = zsl-&gt;header;</span><br><span class="line">            <span class="comment">// åœ¨æ–°å±‚çº§ï¼Œheader çš„è·¨åº¦æ˜¯æ•´ä¸ªè·³è¡¨çš„é•¿åº¦</span></span><br><span class="line">            update[i]-&gt;level[i].span = zsl-&gt;length;</span><br><span class="line">        &#125;</span><br><span class="line">        zsl-&gt;level = level; <span class="comment">// æ›´æ–°è·³è¡¨çš„æ€»å±‚æ•°</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 3. åˆ›å»ºæ–°èŠ‚ç‚¹ï¼Œå¹¶è¿›è¡Œâ€œç©¿é’ˆå¼•çº¿â€èˆ¬çš„é“¾æ¥æ“ä½œ */</span></span><br><span class="line">    x = zslCreateNode(level,score,ele);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; level; i++) &#123;</span><br><span class="line">        <span class="comment">// a. é“¾æ¥ forward æŒ‡é’ˆ</span></span><br><span class="line">        <span class="comment">// å°†æ–°èŠ‚ç‚¹çš„ forward æŒ‡é’ˆæŒ‡å‘å…¶å‰é©±èŠ‚ç‚¹åŸæ¥çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        x-&gt;level[i].forward = update[i]-&gt;level[i].forward;</span><br><span class="line">        <span class="comment">// å°†å‰é©±èŠ‚ç‚¹çš„ forward æŒ‡é’ˆæŒ‡å‘æ–°èŠ‚ç‚¹</span></span><br><span class="line">        update[i]-&gt;level[i].forward = x;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// b. æ›´æ–° spanï¼ˆè·¨åº¦ï¼‰ï¼Œè¿™æ˜¯ ZRANK å‘½ä»¤èƒ½å®ç° O(logN) çš„å…³é”®</span></span><br><span class="line">        <span class="comment">// æ–°èŠ‚ç‚¹çš„ span = å‰é©±èŠ‚ç‚¹åŸæ¥çš„ span - (ä»å‰é©±èŠ‚ç‚¹åˆ°æ’å…¥ä½ç½®çš„è·ç¦»)</span></span><br><span class="line">        x-&gt;level[i].span = update[i]-&gt;level[i].span - (rank[<span class="number">0</span>] - rank[i]);</span><br><span class="line">        <span class="comment">// å‰é©±èŠ‚ç‚¹çš„ span = (ä»å‰é©±èŠ‚ç‚¹åˆ°æ’å…¥ä½ç½®çš„è·ç¦») + 1</span></span><br><span class="line">        update[i]-&gt;level[i].span = (rank[<span class="number">0</span>] - rank[i]) + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 4. æ›´æ–°æœªè¢«è§¦åŠçš„é«˜å±‚çº§çš„ span */</span></span><br><span class="line">    <span class="comment">// å¯¹äºé‚£äº›é«˜äºæ–°èŠ‚ç‚¹å±‚æ•°çš„å±‚çº§ï¼Œæ–°èŠ‚ç‚¹å¹¶æœªæ’å…¥å…¶ä¸­ã€‚</span></span><br><span class="line">    <span class="comment">// ä½†å› ä¸ºè·³è¡¨æ€»é•¿åº¦å¢åŠ äº†1ï¼Œæ‰€ä»¥è¿™äº›å±‚çº§ä¸­ï¼Œæ–°èŠ‚ç‚¹å‰é©±èŠ‚ç‚¹çš„ span éœ€è¦åŠ  1ã€‚</span></span><br><span class="line">    <span class="keyword">for</span> (i = level; i &lt; zsl-&gt;level; i++) &#123;</span><br><span class="line">        update[i]-&gt;level[i].span++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 5. æ›´æ–° backward æŒ‡é’ˆï¼ˆåŒå‘é“¾è¡¨éƒ¨åˆ†ï¼‰ */</span></span><br><span class="line">    <span class="comment">// backward æŒ‡é’ˆåªå­˜åœ¨äºæœ€åº•å±‚ï¼ˆlevel 0ï¼‰ï¼Œç”¨äº ZREVRANGE ç­‰åå‘éå†å‘½ä»¤</span></span><br><span class="line">    x-&gt;backward = (update[<span class="number">0</span>] == zsl-&gt;header) ? <span class="literal">NULL</span> : update[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">if</span> (x-&gt;level[<span class="number">0</span>].forward)</span><br><span class="line">        x-&gt;level[<span class="number">0</span>].forward-&gt;backward = x;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        zsl-&gt;tail = x; <span class="comment">// å¦‚æœæ–°èŠ‚ç‚¹æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ›´æ–°è·³è¡¨çš„ tail æŒ‡é’ˆ</span></span><br><span class="line"></span><br><span class="line">    zsl-&gt;length++; <span class="comment">// è·³è¡¨æ€»é•¿åº¦åŠ  1</span></span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>zslInsert</code> çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œå¯ä»¥æ¯”å–»ä¸ºä¸€æ¬¡ç²¾å‡†çš„ç©ºé™è¡ŒåŠ¨ï¼š</p><ol type="1"><li><strong>ä¾¦å¯Ÿ</strong>ï¼šä»æœ€é«˜ç©ºï¼ˆé¡¶å±‚ç´¢å¼•ï¼‰å¼€å§‹ï¼Œç¡®å®šç©ºé™çš„å¤§è‡´åŒºåŸŸã€‚</li><li><strong>é™è½</strong>ï¼šé€å±‚ä¸‹é™ï¼Œä¸æ–­ä¿®æ­£ä½ç½®ï¼Œæœ€ç»ˆåœ¨åœ°é¢ï¼ˆæœ€åº•å±‚ï¼‰æ‰¾åˆ°ç²¾å‡†çš„ç€é™†ç‚¹ã€‚</li><li><strong>å»ºè®¾</strong>ï¼šå»ºç«‹æ–°çš„èŠ‚ç‚¹ï¼Œå¹¶å°†å…¶æ¥å…¥åˆ°å„ä¸ªå±‚çº§çš„äº¤é€šç½‘ç»œä¸­ã€‚</li></ol><p>æ›´å…·ä½“æ¥è¯´ï¼Œå…¶è¿‡ç¨‹å¯ä»¥åˆ†è§£ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p><ol type="1"><li><strong>è·¯å¾„è®°å½•</strong>ï¼šåˆ›å»ºä¸€ä¸ª <code>update[]</code>æ•°ç»„ã€‚ä»è·³è¡¨çš„æœ€é«˜å±‚å¼€å§‹ï¼Œé€å±‚å‘å³æŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°æ–°èŠ‚ç‚¹åº”æ’å…¥çš„ä½ç½®ã€‚å°†æ¯ä¸€å±‚"é™è½"å‰çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹è®°å½•åœ¨<code>update[]</code>æ•°ç»„ä¸­ï¼Œå½¢æˆä¸€æ¡æ’å…¥è·¯å¾„ã€‚åŒæ—¶ï¼Œ<code>rank[]</code>æ•°ç»„è®°å½•è·¯å¾„ä¸Šè·¨è¶Šçš„èŠ‚ç‚¹æ€»æ•°ï¼Œç”¨äºåç»­æ›´æ–° <code>span</code>ã€‚</li><li><strong>éšæœºå±‚é«˜ </strong>ï¼šä¸ºæ–°èŠ‚ç‚¹éšæœºç”Ÿæˆä¸€ä¸ªå±‚æ•°(<code>level</code>)ã€‚è¿™æ˜¯è·³è¡¨ç»´æŒå¹³è¡¡å’Œ O(logN)æ€§èƒ½çš„å…³é”®ï¼Œå®ƒé€šè¿‡æ¦‚ç‡è®ºé¿å…äº†å¹³è¡¡æ ‘å¤æ‚çš„æ—‹è½¬æ“ä½œã€‚</li><li><strong>èŠ‚ç‚¹é“¾æ¥</strong>ï¼šåˆ›å»ºæ–°èŠ‚ç‚¹ï¼Œå¹¶åˆ©ç”¨ <code>update[]</code>æ•°ç»„ä¸­è®°å½•çš„è·¯å¾„ï¼Œåœ¨ <code>0</code> åˆ° <code>level-1</code>çš„æ¯ä¸€å±‚ä¸­ï¼Œåƒæ“ä½œé“¾è¡¨ä¸€æ ·ï¼Œå°†æ–°èŠ‚ç‚¹ç²¾å‡†åœ°æ’å…¥åˆ°å‰é©±å’Œåç»§èŠ‚ç‚¹ä¹‹é—´ã€‚</li><li><strong>è·¨åº¦æ›´æ–°</strong>ï¼šè¿™æ˜¯ <code>ZRANK</code> ç­‰æ’åå‘½ä»¤èƒ½å®ç°<span class="math inline">\(O(logN)\)</span>çš„ç²¾é«“ã€‚åœ¨é“¾æ¥èŠ‚ç‚¹çš„åŒæ—¶ï¼Œç²¾ç¡®åœ°æ›´æ–° <code>update[]</code>è·¯å¾„ä¸Šæ‰€æœ‰èŠ‚ç‚¹çš„ <code>span</code> å€¼ä»¥åŠæ–°èŠ‚ç‚¹è‡ªèº«çš„ <code>span</code>å€¼ã€‚</li></ol><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä¸€ä¸€æ‹†è§£è¿™æ®µä»£ç çš„æ¯ä¸€ä¸ªç»†èŠ‚ã€‚</p><p><strong>ç¬¬ 1 æ­¥ï¼šåˆå§‹åŒ–ä¸å‡†å¤‡</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">zskiplistNode *<span class="title function_">zslInsert</span><span class="params">(zskiplist *zsl, <span class="type">double</span> score, sds ele)</span> &#123;</span><br><span class="line">    <span class="comment">// update: è®°å½•æ–°èŠ‚ç‚¹åœ¨æ¯ä¸€å±‚çš„å‰é©±èŠ‚ç‚¹ï¼ˆéœ€è¦è¢«æ›´æ–°çš„èŠ‚ç‚¹ï¼‰</span></span><br><span class="line">    <span class="comment">// rank:   è®°å½•ä» header åˆ°æ¯ä¸€å±‚å‰é©±èŠ‚ç‚¹æ—¶ï¼Œè·¨è¶Šäº†å¤šå°‘ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rank[ZSKIPLIST_MAXLEVEL];</span><br><span class="line">    <span class="type">int</span> i, level;</span><br></pre></td></tr></table></figure><ul><li><code>zskiplistNode *update[ZSKIPLIST_MAXLEVEL]</code>:<strong>è·¯å¾„è®°å½•ä»ª</strong>ã€‚å®ƒæ˜¯ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„ï¼Œ<code>update[i]</code>å°†ç”¨äºå­˜å‚¨æ–°èŠ‚ç‚¹åœ¨ç¬¬ <code>i</code>å±‚çš„å‰é©±èŠ‚ç‚¹ã€‚ä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Ÿå› ä¸ºæ’å…¥æ“ä½œçš„æœ¬è´¨å°±æ˜¯åœ¨<code>update[i]</code>å’Œå®ƒåŸæ¥çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¹‹é—´ï¼Œæ’å…¥æˆ‘ä»¬çš„æ–°èŠ‚ç‚¹ã€‚è¿™ä¸ªæ•°ç»„ä¸ºæˆ‘ä»¬ä¿å­˜äº†æ‰€æœ‰éœ€è¦ä¿®æ”¹çš„è¿æ¥ç‚¹ã€‚</li><li><code>unsigned long rank[ZSKIPLIST_MAXLEVEL]</code>:<strong>è·ç¦»è®¡æ•°å™¨</strong>ã€‚<code>rank[i]</code> ç”¨äºè®°å½•ä»è·³è¡¨<code>header</code> å¤´èŠ‚ç‚¹å‡ºå‘ï¼Œåˆ°è¾¾ <code>update[i]</code>è¿™ä¸ªèŠ‚ç‚¹æ—¶ï¼Œåœ¨æœ€åº•å±‚ï¼ˆç¬¬ 0å±‚ï¼‰æ€»å…±è·¨è¶Šäº†å¤šå°‘ä¸ªèŠ‚ç‚¹ã€‚å®ƒçš„æ ¸å¿ƒä½œç”¨æ˜¯ä¸ºåç»­ç²¾ç¡®è®¡ç®—å’Œæ›´æ–°èŠ‚ç‚¹çš„<code>span</code>ï¼ˆè·¨åº¦ï¼‰æä¾›æ•°æ®æ”¯æŒï¼Œè¿™æ˜¯ <code>ZRANK</code>å‘½ä»¤èƒ½å¤Ÿå®ç° <span class="math inline">\(O(logN)\)</span> çš„åŸºçŸ³ã€‚</li></ul><p><strong>ç¬¬ 2 æ­¥ï¼šæŸ¥æ‰¾æ’å…¥ä½ç½®å¹¶è®°å½•è·¯å¾„</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">x = zsl-&gt;header; <span class="comment">// ä»è·³è¡¨çš„å¤´èŠ‚ç‚¹å¼€å§‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»è·³è¡¨ç°æœ‰çš„æœ€é«˜å±‚å¼€å§‹ï¼Œé€å±‚ä¸‹é™</span></span><br><span class="line"><span class="keyword">for</span> (i = zsl-&gt;level<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">    <span class="comment">// rank[i] ç»§æ‰¿äº†ä¸Šä¸€å±‚ï¼ˆi+1ï¼‰çš„æ’åã€‚</span></span><br><span class="line">    rank[i] = i == (zsl-&gt;level<span class="number">-1</span>) ? <span class="number">0</span> : rank[i+<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨å½“å‰å±‚å‘å³å‰è¿›</span></span><br><span class="line">    <span class="keyword">while</span> (x-&gt;level[i].forward &amp;&amp;</span><br><span class="line">           (x-&gt;level[i].forward-&gt;score &lt; score ||</span><br><span class="line">               (x-&gt;level[i].forward-&gt;score == score &amp;&amp;</span><br><span class="line">                sdscmp(x-&gt;level[i].forward-&gt;ele,ele) &lt; <span class="number">0</span>)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// æ¯è·¨è¶Šä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°±å°†è¯¥èŠ‚ç‚¹çš„è·¨åº¦(span)ç´¯åŠ åˆ°æ’åä¸­</span></span><br><span class="line">        rank[i] += x-&gt;level[i].span;</span><br><span class="line">        x = x-&gt;level[i].forward; <span class="comment">// å‰è¿›åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®°å½•ç¬¬ i å±‚çš„å‰é©±èŠ‚ç‚¹</span></span><br><span class="line">    update[i] = x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯è·³è¡¨ç®—æ³•çš„ç²¾é«“æ‰€åœ¨â€”â€”<strong>åˆ†å±‚æŸ¥æ‰¾</strong>ã€‚</p><ul><li><code>for (i = zsl-&gt;level-1; i &gt;= 0; i--)</code>:å¾ªç¯ä»æœ€é«˜å±‚ï¼ˆ<code>zsl-&gt;level-1</code>ï¼‰å¼€å§‹ï¼Œé€å±‚ä¸‹é™åˆ°æœ€åº•å±‚ï¼ˆ<code>0</code>ï¼‰ã€‚è¿™æ¨¡ä»¿äº†æˆ‘ä»¬åœ¨åœ°å›¾ä¸ŠæŸ¥æ‰¾ä½ç½®çš„è¿‡ç¨‹ï¼šå…ˆçœ‹æ´²é™…åœ°å›¾ï¼ˆé«˜å±‚ï¼‰ï¼Œå†çœ‹å›½å®¶åœ°å›¾ï¼ˆä¸­å±‚ï¼‰ï¼Œæœ€åçœ‹åŸå¸‚è¡—é“å›¾ï¼ˆåº•å±‚ï¼‰ã€‚é«˜å±‚çº§çš„"å¿«é€Ÿé€šé“"å¯ä»¥è®©æˆ‘ä»¬ä¸€æ¬¡æ€§è·³è¿‡å¤§é‡èŠ‚ç‚¹ã€‚</li><li><code>while (...)</code>: åœ¨å½“å‰å±‚çº§ï¼Œä¸æ–­å‘å³ç§»åŠ¨ã€‚åˆ¤æ–­æ¡ä»¶<code>(score &lt; ... || (score == ... &amp;&amp; ele &lt; ...))</code>ä¿è¯äº†è·³è¡¨çš„æ’åºè§„åˆ™ï¼šä¼˜å…ˆæŒ‰ <code>score</code> å‡åºï¼Œå¦‚æœ<code>score</code> ç›¸åŒï¼Œåˆ™æŒ‰ <code>member</code> çš„å­—å…¸åºå‡åºã€‚</li><li><code>rank[i] += x-&gt;level[i].span;</code>: è¿™æ˜¯ <code>rank</code>æ•°ç»„å·¥ä½œçš„æ ¸å¿ƒã€‚æ¯å½“æˆ‘ä»¬ä» <code>x</code>èŠ‚ç‚¹è·³åˆ°å®ƒçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œå¹¶ä¸æ˜¯åªå‰è¿›äº†ä¸€æ­¥ï¼Œè€Œæ˜¯å‰è¿›äº†<code>x-&gt;level[i].span</code> æ­¥ã€‚æˆ‘ä»¬å°†è¿™ä¸ªè·¨åº¦ç´¯åŠ åˆ°<code>rank[i]</code> ä¸­ï¼Œ<code>rank[i]</code>å°±å®æ—¶è®°å½•äº†æˆ‘ä»¬è·ç¦»èµ·ç‚¹çš„æ€»æ­¥æ•°ã€‚</li><li><code>update[i] = x;</code>: å½“ <code>while</code>å¾ªç¯ç»“æŸæ—¶ï¼Œ<code>x</code> èŠ‚ç‚¹å°±æ˜¯æ–°èŠ‚ç‚¹åœ¨ç¬¬ <code>i</code>å±‚çš„å‰é©±èŠ‚ç‚¹ã€‚æˆ‘ä»¬å°†å…¶è®°å½•åœ¨ <code>update[i]</code> ä¸­ã€‚å½“æ•´ä¸ª<code>for</code> å¾ªç¯ç»“æŸåï¼Œ<code>update</code>æ•°ç»„å°±å®Œæ•´è®°å½•äº†ä»æœ€é«˜å±‚åˆ°æœ€åº•å±‚çš„ä¸€æ¡æ’å…¥è·¯å¾„ã€‚</li></ul><p><strong>ç¬¬ 3 æ­¥ï¼šç¡®å®šæ–°èŠ‚ç‚¹å±‚é«˜å¹¶å¤„ç†æ–°å±‚çº§</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">level = zslRandomLevel();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (level &gt; zsl-&gt;level) &#123;</span><br><span class="line">    <span class="keyword">for</span> (i = zsl-&gt;level; i &lt; level; i++) &#123;</span><br><span class="line">        rank[i] = <span class="number">0</span>;</span><br><span class="line">        update[i] = zsl-&gt;header;</span><br><span class="line">        update[i]-&gt;level[i].span = zsl-&gt;length;</span><br><span class="line">    &#125;</span><br><span class="line">    zsl-&gt;level = level;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>level = zslRandomLevel()</code>:<strong>æ¦‚ç‡ä¹‹ç¾</strong>ã€‚æ–°èŠ‚ç‚¹å°†æ‹¥æœ‰å‡ å±‚"å¿«é€Ÿé€šé“"ï¼Ÿè¿™é‡Œä¸æ˜¯ç”±å¤æ‚çš„å¹³è¡¡ç®—æ³•å†³å®šï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ªç®€å•çš„æ¦‚ç‡å‡½æ•°éšæœºç”Ÿæˆã€‚å¤§éƒ¨åˆ†èŠ‚ç‚¹åªæœ‰1å±‚ï¼Œæå°‘æ•°èŠ‚ç‚¹ä¼šæœ‰å¾ˆé«˜çš„å±‚æ•°ã€‚æ­£æ˜¯è¿™ç§éšæœºæ€§ï¼Œä½¿å¾—è·³è¡¨åœ¨æ•´ä½“ä¸Šèƒ½å¤Ÿç»´æŒä¸€ä¸ªé«˜æ•ˆçš„å¯¹æ•°çº§ç»“æ„ã€‚</li><li><code>if (level &gt; zsl-&gt;level)</code>:å¤„ç†ä¸€ä¸ªç‰¹æ®Šæƒ…å†µã€‚å¦‚æœéšæœºå‡ºçš„ <code>level</code>æ¯”å½“å‰è·³è¡¨çš„æœ€å¤§å±‚æ•°è¿˜å¤§ï¼Œæ„å‘³ç€æˆ‘ä»¬éœ€è¦ä¸ºæ•´ä¸ªè·³è¡¨åŠ ç›–æ–°çš„æ¥¼å±‚ã€‚åœ¨è¿™äº›æ–°æ¥¼å±‚ï¼Œè·¯å¾„ä¸Šçš„å‰é©±èŠ‚ç‚¹è‡ªç„¶å°±æ˜¯<code>header</code> èŠ‚ç‚¹ï¼Œå¹¶ä¸”å®ƒåˆ° <code>NULL</code>çš„è·¨åº¦å°±æ˜¯æ•´ä¸ªè·³è¡¨çš„é•¿åº¦ <code>zsl-&gt;length</code>ã€‚</li></ul><p><strong>ç¬¬ 4 æ­¥ï¼šèŠ‚ç‚¹åˆ›å»ºã€é“¾æ¥ä¸è·¨åº¦æ›´æ–°</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">x = zslCreateNode(level,score,ele);</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; level; i++) &#123;</span><br><span class="line">    <span class="comment">// a. é“¾æ¥ forward æŒ‡é’ˆ</span></span><br><span class="line">    x-&gt;level[i].forward = update[i]-&gt;level[i].forward;</span><br><span class="line">    update[i]-&gt;level[i].forward = x;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// b. æ›´æ–° spanï¼ˆè·¨åº¦ï¼‰</span></span><br><span class="line">    x-&gt;level[i].span = update[i]-&gt;level[i].span - (rank[<span class="number">0</span>] - rank[i]);</span><br><span class="line">    update[i]-&gt;level[i].span = (rank[<span class="number">0</span>] - rank[i]) + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// c. æ›´æ–°é«˜å±‚åŠè·¨åº¦</span></span><br><span class="line"><span class="keyword">for</span> (i = level; i &lt; zsl-&gt;level; i++) &#123;</span><br><span class="line">    update[i]-&gt;level[i].span++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯æ•´ä¸ªæ’å…¥è¿‡ç¨‹ä¸­æœ€æ ¸å¿ƒçš„é€»è¾‘ï¼š</p><ul><li><p><strong>é“¾æ¥ <code>forward</code> æŒ‡é’ˆ</strong>:è¿™ä¸¤è¡Œæ˜¯ç»å…¸çš„é“¾è¡¨æ’å…¥æ“ä½œã€‚å‡è®¾åŸæ¥æ˜¯<code>A -&gt; C</code>ï¼Œ<code>A</code> å°±æ˜¯<code>update[i]</code>ï¼Œ<code>C</code> å°±æ˜¯<code>update[i]-&gt;level[i].forward</code>ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å°†æ–°èŠ‚ç‚¹<code>x</code> æ’å…¥å…¶ä¸­ï¼Œå˜ä¸º <code>A -&gt; x -&gt; C</code>ã€‚</p></li><li><p><strong>æ›´æ–° <code>span</code> (è·¨åº¦)</strong>:è¿™æ˜¯æœ€ç²¾å¦™çš„éƒ¨åˆ†ï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜ã€‚</p><ul><li>å‡è®¾åœ¨ç¬¬ <code>i</code> å±‚ï¼Œå‰é©±èŠ‚ç‚¹ <code>A</code> (å³<code>update[i]</code>) åŸæ¥çš„ <code>span</code> æ˜¯<code>10</code>ï¼Œå®ƒç›´æ¥æŒ‡å‘ <code>C</code>ã€‚</li><li>æˆ‘ä»¬åœ¨ç¬¬ 0 å±‚ï¼ˆæœ€åº•å±‚ï¼‰çš„æŸ¥æ‰¾è¿‡ç¨‹ä¸­ï¼Œä» <code>A</code>ä¹‹åï¼Œåˆå‰è¿›äº† 3 æ­¥æ‰æ‰¾åˆ°æ’å…¥ç‚¹ã€‚è¿™æ„å‘³ç€ <code>rank[0] - rank[i]</code>çš„å€¼æ˜¯ 3ï¼ˆå¯ä»¥ç†è§£ä¸º A åœ¨é«˜å±‚å’Œåº•å±‚ä¹‹é—´çš„æŠ•å½±åå·®ï¼‰ã€‚</li><li><code>update[i]-&gt;level[i].span = (rank[0] - rank[i]) + 1;</code>:<code>A</code> çš„æ–° <code>span</code> å˜ä¸º<code>3 + 1 = 4</code>ã€‚å› ä¸ºå®ƒç°åœ¨æŒ‡å‘æ–°èŠ‚ç‚¹<code>x</code>ï¼Œå®ƒä¿©ä¹‹é—´è·¨è¶Šäº† <code>3</code> ä¸ªæ—§èŠ‚ç‚¹ï¼ŒåŠ ä¸Š<code>x</code> æœ¬èº«ï¼Œæ€»å…±æ˜¯ <code>4</code> æ­¥ã€‚</li><li><code>x-&gt;level[i].span = update[i]-&gt;level[i].span - (rank[0] - rank[i]);</code>:æ–°èŠ‚ç‚¹ <code>x</code> çš„ <code>span</code> ç­‰äº <code>A</code>çš„<strong>æ—§</strong> <code>span</code> (<code>10</code>)å‡å»å®ƒä¿©ä¹‹é—´çš„è·ç¦» (<code>3</code>)ï¼Œç­‰äº <code>7</code>ã€‚</li></ul><blockquote><p><strong>éªŒè¯</strong>: æ’å…¥åï¼Œ<code>A</code> çš„æ–° <code>span</code>(4) + <code>x</code> çš„æ–° <code>span</code> (7) = <code>11</code>ã€‚è€Œ<code>A</code> çš„æ—§ <code>span</code> æ˜¯ <code>10</code>ã€‚æ€»è·¨åº¦å¢åŠ äº†<code>1</code>ï¼Œæ­£å¥½ç­‰äºæ–°åŠ å…¥çš„èŠ‚ç‚¹æ•°é‡ã€‚å®Œç¾ï¼</p></blockquote></li></ul><p>å¦å¤–ï¼Œå¯¹äºé‚£äº›é«˜äºæ–°èŠ‚ç‚¹ <code>level</code>çš„å±‚çº§ï¼Œæ–°èŠ‚ç‚¹å¹¶ä¸ä¼šè¢«æ’å…¥ã€‚ä½†æ˜¯ï¼Œç”±äºæ•´ä¸ªè·³è¡¨çš„æ€»é•¿åº¦å¢åŠ äº†1ï¼Œè¿™äº›æ›´é«˜å±‚çº§ä¸Šã€ä½äºæ’å…¥è·¯å¾„ä¸Šçš„å‰é©±èŠ‚ç‚¹ï¼ˆ<code>update[i]</code>ï¼‰ï¼Œå®ƒä»¬æŒ‡å‘çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„ç›¸å¯¹è·ç¦»ä¹Ÿå¢åŠ 1ã€‚å› æ­¤ï¼Œå®ƒä»¬çš„ <code>span</code> å€¼éœ€è¦é€’å¢ã€‚</p><p><strong>ç¬¬ 5 æ­¥ï¼šæ›´æ–°åé€€æŒ‡é’ˆå’Œè¡¨å°¾</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">x-&gt;backward = (update[<span class="number">0</span>] == zsl-&gt;header) ? <span class="literal">NULL</span> : update[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">if</span> (x-&gt;level[<span class="number">0</span>].forward)</span><br><span class="line">    x-&gt;level[<span class="number">0</span>].forward-&gt;backward = x;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    zsl-&gt;tail = x;</span><br><span class="line"></span><br><span class="line">zsl-&gt;length++;</span><br></pre></td></tr></table></figure><p>æœ€åçš„æ”¶å°¾å·¥ä½œã€‚</p><ul><li><code>x-&gt;backward = ...</code>:è·³è¡¨çš„æœ€åº•å±‚ï¼ˆ<code>level[0]</code>ï¼‰æ˜¯ä¸€ä¸ª<strong>åŒå‘é“¾è¡¨</strong>ï¼Œ<code>backward</code>æŒ‡é’ˆç”¨äºæ”¯æŒ <code>ZREVRANGE</code>ç­‰åå‘éå†å‘½ä»¤ã€‚è¿™é‡Œå°†æ–°èŠ‚ç‚¹çš„åé€€æŒ‡é’ˆæ­£ç¡®åœ°æŒ‡å‘å®ƒçš„å‰é©±èŠ‚ç‚¹<code>update[0]</code>ã€‚</li><li><code>if...else...</code>: æ›´æ–°æ–°èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹çš„<code>backward</code> æŒ‡é’ˆï¼Œè®©å®ƒæŒ‡å‘æ–°èŠ‚ç‚¹<code>x</code>ã€‚å¦‚æœæ–°èŠ‚ç‚¹æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ™æ›´æ–°æ•´ä¸ªè·³è¡¨çš„<code>tail</code> æŒ‡é’ˆã€‚</li><li><code>zsl-&gt;length++</code>: æœ€åï¼Œå°†è·³è¡¨çš„æ€»é•¿åº¦åŠ  1ã€‚</li></ul><p>è‡³æ­¤ï¼Œä¸€ä¸ªæ–°èŠ‚ç‚¹è¢«å¤©è¡£æ— ç¼åœ°ç»‡å…¥äº†è·³è¡¨è¿™å¼ å¤§ç½‘ä¸­ï¼Œæ‰€æœ‰ç›¸å…³çš„æŒ‡é’ˆå’Œè·¨åº¦ä¿¡æ¯éƒ½å¾—åˆ°äº†åŸå­æ€§çš„æ›´æ–°ã€‚</p><h2 id="sorted-set-çš„å…¸å‹åº”ç”¨åœºæ™¯">Sorted Set çš„å…¸å‹åº”ç”¨åœºæ™¯</h2><p>ç†è®ºçš„ä»·å€¼åœ¨äºå®è·µã€‚Sorted Setçš„å¼ºå¤§èƒ½åŠ›ä½¿å…¶åœ¨ä¼—å¤šä¸šåŠ¡åœºæ™¯ä¸­æˆä¸ºå…³é”®å…ˆç”Ÿã€‚</p><h3 id="æ’è¡Œæ¦œ">1. æ’è¡Œæ¦œ</h3><p>è¿™æ˜¯æœ€ç»å…¸çš„åº”ç”¨ã€‚ä¾‹å¦‚ï¼Œæ¸¸æˆç©å®¶ç§¯åˆ†æ¦œã€æ–‡ç« ç‚¹èµæ¦œã€‚</p><ul><li><strong>æ›´æ–°æ’å</strong>ï¼š<code>ZADD leaderboard 100 user1</code>(åˆ†æ•°å˜åŒ–æ—¶ï¼Œå†æ¬¡ ZADD å³å¯è¦†ç›–)</li><li><strong>è·å– Top10</strong>ï¼š<code>ZREVRANGE leaderboard 0 9 WITHSCORES</code></li><li><strong>æŸ¥è¯¢æˆ‘çš„æ’å</strong>ï¼š<code>ZREVRANK leaderboard user1</code>(è¿”å›ä» 0 å¼€å§‹çš„æ’å)</li></ul><h3 id="å»¶è¿Ÿæ¶ˆæ¯é˜Ÿåˆ—">2. å»¶è¿Ÿæ¶ˆæ¯é˜Ÿåˆ—</h3><p>ä¸€ä¸ªéå¸¸å·§å¦™ä¸”å®ç”¨çš„é«˜çº§ç”¨æ³•ã€‚</p><ul><li><p><strong>ç”Ÿäº§è€…</strong>ï¼šå°†æ¶ˆæ¯çš„æ‰§è¡Œæ—¶é—´ï¼ˆtimestampï¼‰ä½œä¸ºscoreï¼Œæ¶ˆæ¯å†…å®¹ä½œä¸º memberï¼Œæ·»åŠ åˆ° ZSet ä¸­ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZADD delay_queue 1758153600 &#x27;&#123;&quot;job_id&quot;: 123, &quot;task&quot;: &quot;send_email&quot;&#125;&#x27;</span><br></pre></td></tr></table></figure></li><li><p><strong>æ¶ˆè´¹è€…</strong>ï¼šå®šæœŸè½®è¯¢ ZSetï¼Œå–å‡º <code>score</code>å°äºç­‰äºå½“å‰æ—¶é—´çš„ä»»åŠ¡ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZRANGEBYSCORE delay_queue -inf (current_timestamp) LIMIT 0 1</span><br></pre></td></tr></table></figure><p>å¦‚æœæ‹‰å–æˆåŠŸï¼Œç«‹å³ç”¨ <code>ZREM</code>å°†å…¶ä»é˜Ÿåˆ—ä¸­åˆ é™¤ï¼Œé˜²æ­¢è¢«å…¶ä»–æ¶ˆè´¹è€…é‡å¤æ‰§è¡Œã€‚</p></li></ul><h3 id="å¸¦æƒé‡çš„è‡ªåŠ¨è¡¥å…¨">3. å¸¦æƒé‡çš„è‡ªåŠ¨è¡¥å…¨</h3><p>ä¾‹å¦‚ï¼Œåœ¨æœç´¢æ¡†ä¸­ï¼Œæ ¹æ®è¾“å…¥çš„å‰ç¼€ï¼Œæ¨èå‡ºé¢‘ç‡æ›´é«˜ï¼ˆæƒé‡æ›´é«˜ï¼‰çš„è¯æ¡ã€‚</p><ul><li><p><strong>æ•°æ®å‡†å¤‡</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZADD autocomplete 100 &quot;redis&quot; 90 &quot;reids&quot; 80 &quot;reload&quot;</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥è¯¢å®ç°ï¼šåˆ©ç”¨ <code>ZRANGEBYLEX</code> å‘½ä»¤æŸ¥æ‰¾æ‰€æœ‰ä»¥ "re"å¼€å¤´çš„è¯æ¡</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZRANGEBYLEX autocomplete &quot;[re&quot; &quot;[re\xff&quot;</span><br></pre></td></tr></table></figure></li></ul><h2 id="å‘½ä»¤é€ŸæŸ¥è¡¨">å‘½ä»¤é€ŸæŸ¥è¡¨</h2><table><colgroup><col style="width: 11%" /><col style="width: 58%" /><col style="width: 29%" /></colgroup><thead><tr><th>åˆ†ç±»</th><th>å‘½ä»¤</th><th>æè¿°</th></tr></thead><tbody><tr><td><strong>å†™æ“ä½œ</strong></td><td><code>ZADD key [NX|XX] [GT|LT] [CH] [INCR] score member [score member ...]</code></td><td>æ·»åŠ æˆ–æ›´æ–°ä¸€ä¸ªæˆ–å¤šä¸ªæˆå‘˜çš„åˆ†æ•°</td></tr><tr><td></td><td><code>ZINCRBY key increment member</code></td><td>ä¸ºæˆå‘˜çš„åˆ†æ•°å¢åŠ æŒ‡å®šå¢é‡</td></tr><tr><td><strong>è¯»æ“ä½œ</strong></td><td><code>ZSCORE key member</code></td><td>è·å–æˆå‘˜çš„åˆ†æ•°</td></tr><tr><td></td><td><code>ZCARD key</code></td><td>è·å–é›†åˆä¸­çš„æˆå‘˜æ•°é‡</td></tr><tr><td></td><td><code>ZCOUNT key min max</code></td><td>ç»Ÿè®¡æŒ‡å®šåˆ†æ•°åŒºé—´çš„æˆå‘˜æ•°é‡</td></tr><tr><td></td><td><code>ZRANK key member</code></td><td>è·å–æˆå‘˜çš„æ’å (å‡åº)</td></tr><tr><td></td><td><code>ZREVRANK key member</code></td><td>è·å–æˆå‘˜çš„æ’å (é™åº)</td></tr><tr><td></td><td><code>ZRANGE key start stop [WITHSCORES]</code></td><td>æŒ‰æ’åèŒƒå›´è·å–æˆå‘˜ (å‡åº)</td></tr><tr><td></td><td><code>ZREVRANGE key start stop [WITHSCORES]</code></td><td>æŒ‰æ’åèŒƒå›´è·å–æˆå‘˜ (é™åº)</td></tr><tr><td></td><td><code>ZRANGEBYSCORE key min max [WITHSCORES] [LIMIT offset count]</code></td><td>æŒ‰åˆ†æ•°èŒƒå›´è·å–æˆå‘˜</td></tr><tr><td></td><td><code>ZRANGEBYLEX key min max [LIMIT offset count]</code></td><td>æŒ‰å­—å…¸åºèŒƒå›´è·å–æˆå‘˜</td></tr><tr><td><strong>åˆ é™¤æ“ä½œ</strong></td><td><code>ZREM key member [member ...]</code></td><td>åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ªæˆå‘˜</td></tr><tr><td></td><td><code>ZREMRANGEBYRANK key start stop</code></td><td>æŒ‰æ’åèŒƒå›´åˆ é™¤æˆå‘˜</td></tr><tr><td></td><td><code>ZREMRANGEBYSCORE key min max</code></td><td>æŒ‰åˆ†æ•°èŒƒå›´åˆ é™¤æˆå‘˜</td></tr><tr><td><strong>å¼¹å‡ºæ“ä½œ</strong></td><td><code>ZPOPMIN key [count]</code> /<code>ZPOPMAX key [count]</code></td><td>å¼¹å‡ºåˆ†æ•°æœ€ä½/æœ€é«˜çš„æˆå‘˜</td></tr><tr><td><strong>é›†åˆè¿ç®—</strong></td><td><code>ZUNIONSTORE dest numkeys key [key ...] [WEIGHTS ...] [AGGREGATE ...]</code></td><td>è®¡ç®—å¤šä¸ªZSetçš„å¹¶é›†å¹¶å­˜å‚¨</td></tr><tr><td></td><td><code>ZINTERSTORE dest numkeys key [key ...] [WEIGHTS ...] [AGGREGATE ...]</code></td><td>è®¡ç®—å¤šä¸ªZSetçš„äº¤é›†å¹¶å­˜å‚¨</td></tr></tbody></table><h2 id="æ€»ç»“">æ€»ç»“</h2><p>Sorted Set æ˜¯ Redisä¸­è®¾è®¡æœ€ä¸ºç²¾å·§çš„æ•°æ®ç»“æ„ä¹‹ä¸€ã€‚å®ƒæ·±åˆ»ä½“ç°äº†è®¡ç®—æœºç§‘å­¦ä¸­çš„<strong>æƒè¡¡ï¼ˆTrade-offï¼‰</strong>æ€æƒ³ã€‚</p><ul><li>é€šè¿‡<strong><code>listpack</code></strong> ä¸<strong><code>skiplist</code>+<code>dict</code></strong>çš„åŒç¼–ç ç­–ç•¥ï¼Œå®ƒåœ¨å†…å­˜å ç”¨å’Œæ‰§è¡Œæ•ˆç‡ä¹‹é—´æ‰¾åˆ°äº†åŠ¨æ€çš„å¹³è¡¡ç‚¹ã€‚</li><li>é€šè¿‡<strong><code>dict</code></strong> ä¸<strong><code>skiplist</code></strong>çš„åŒå¼•æ“å¤åˆç»“æ„ï¼Œå®ƒå®Œç¾åœ°è§£å†³äº†â€œæŒ‰æˆå‘˜æŸ¥æ‰¾â€ä¸â€œæŒ‰åˆ†æ•°æ’åºâ€çš„æ ¸å¿ƒçŸ›ç›¾ã€‚</li></ul><p>ç†è§£äº†è¿™äº›åº•å±‚åŸç†ï¼Œä½ å°†ä¸ä»…ä»…æ˜¯ä¸€ä¸ª Redis APIçš„ä½¿ç”¨è€…ï¼Œæ›´èƒ½æˆä¸ºä¸€åèƒ½å¤Ÿæ ¹æ®åœºæ™¯é¢„åˆ¤æ€§èƒ½ã€ä¼˜åŒ–ç»“æ„ã€å°† Redisçš„å¨åŠ›å‘æŒ¥åˆ°æè‡´çš„æ¶æ„å¸ˆã€‚</p>]]></content>
    
    
    <summary type="html">æœ¬ç¯‡åŸºäº Redis 8.2.1 æºç ï¼Œå¸¦ä½ æ·±å…¥ç†è§£ Redis çš„ Sorted Set æ•°æ®ç±»å‹ã€‚</summary>
    
    
    
    <category term="Redis" scheme="https://hedon.top/categories/Redis/"/>
    
    
    <category term="Redis" scheme="https://hedon.top/tags/Redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis æ•°æ®ç±»å‹ä¸¨Hash&amp;Set</title>
    <link href="https://hedon.top/2025/09/08/redis/redis-datatype-hash-and-set/"/>
    <id>https://hedon.top/2025/09/08/redis/redis-datatype-hash-and-set/</id>
    <published>2025-09-08T11:41:00.000Z</published>
    <updated>2025-10-14T09:34:14.711Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡æ—¨åœ¨å¯¹ Redis çš„ä¸¤ç§æ ¸å¿ƒæ•°æ®ç»“æ„â€”â€”<code>Hash</code> ä¸<code>Set</code>â€”â€”è¿›è¡Œä¸€æ¬¡ä»å¤–éƒ¨åº”ç”¨åˆ°å†…éƒ¨æºç å®ç°çš„å®Œæ•´ã€è´¯é€šçš„æ·±åº¦åˆ†æã€‚æ–‡ç« å°†é¦–å…ˆä»‹ç»å…¶æ•°æ®æ¨¡å‹ä¸åº”ç”¨åœºæ™¯ï¼Œç„¶åæ·±å…¥åˆ°åº•å±‚çš„æ•°æ®ç»“æ„ä¸ç¼–ç æ–¹å¼ï¼Œå¹¶ç›´æ¥ä»¥Redis 8.2.1 æºç ä¸ºå‚ç…§ï¼Œé€å­—æ®µè§£æ<code>dict</code>ã€<code>dictEntry</code> åŠ <code>intset</code>ç­‰æ ¸å¿ƒç»“æ„ï¼Œæœ€ç»ˆé˜æ˜æ¸è¿›å¼Rehashã€ç¼–ç è½¬æ¢ç­‰å…³é”®æœºåˆ¶ã€‚æœ¬æ–‡çš„ç›®æ ‡æ˜¯ä¸ºéœ€è¦æ·±åº¦ç†è§£å’Œä½¿ç”¨ Redisçš„å¼€å‘è€…æä¾›ä¸€ä»½ç²¾ç¡®ã€è¯¦å°½çš„æŠ€æœ¯å‚è€ƒã€‚</p><h2 id="hash">Hash</h2><p>Hashç±»å‹æ˜¯ä¸€ç§é”®å€¼ï¼ˆKey-Valueï¼‰æ•°æ®ç»“æ„ï¼Œå…¶é¡¶å±‚é”®ï¼ˆkeyï¼‰æ˜ å°„åˆ°ä¸€ä¸ªåŒ…å«å¤šä¸ªå­—æ®µ-å€¼ï¼ˆfield-valueï¼‰å¯¹çš„é›†åˆã€‚æ­¤ç»“æ„éå¸¸é€‚ç”¨äºå¯¹ç»“æ„åŒ–æ•°æ®ï¼ˆå¦‚å¯¹è±¡ï¼‰çš„å»ºæ¨¡ï¼Œå› ä¸ºå®ƒå…è®¸å¯¹å•ä¸ªå­—æ®µè¿›è¡ŒåŸå­åŒ–çš„è¯»å†™æ“ä½œï¼ˆ<code>HGET</code>,<code>HSET</code>ï¼‰ï¼Œè€Œæ— éœ€è¯»å–æˆ–é‡å†™æ•´ä¸ªå¯¹è±¡ã€‚</p><p><strong>å…¸å‹åº”ç”¨åœºæ™¯</strong>ï¼šç¼“å­˜æ•°æ®åº“è¡Œè®°å½•ã€å­˜å‚¨ç”¨æˆ·ç”»åƒã€è´­ç‰©è½¦ç­‰ã€‚</p><h3 id="å‘½ä»¤æ¸…å•">å‘½ä»¤æ¸…å•</h3><table><colgroup><col style="width: 8%" /><col style="width: 15%" /><col style="width: 26%" /><col style="width: 25%" /><col style="width: 24%" /></colgroup><thead><tr><th>å‘½ä»¤</th><th>ä½œç”¨</th><th>å¸¸ç”¨ç”¨æ³•</th><th>æ—¶é—´å¤æ‚åº¦</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>HSET</td><td>è®¾ç½®ä¸€ä¸ªæˆ–å¤šä¸ªå­—æ®µå€¼</td><td>HSET key field value [field value ...]</td><td>O(N)ï¼ˆN ä¸ºè®¾ç½®å­—æ®µæ•°ï¼‰</td><td>è¿”å›æ–°å¢å­—æ®µæ•°é‡ï¼›å¯åŒæ—¶è®¾ç½®å¤šä¸ªå­—æ®µ</td></tr><tr><td>HSETNX</td><td>ä»…å½“å­—æ®µä¸å­˜åœ¨æ—¶è®¾ç½®</td><td>HSETNX key field value</td><td>O(1)</td><td>åŸå­æ¡ä»¶å†™ï¼›å­˜åœ¨åˆ™ä¸å˜</td></tr><tr><td>HGET</td><td>è·å–å•ä¸ªå­—æ®µå€¼</td><td>HGET key field</td><td>O(1)</td><td>ä¸å­˜åœ¨è¿”å› nil</td></tr><tr><td>HMGET</td><td>æ‰¹é‡è·å–å¤šä¸ªå­—æ®µå€¼</td><td>HMGET key field [field ...]</td><td>O(N)ï¼ˆN ä¸ºå­—æ®µæ•°ï¼‰</td><td>è¿”å›æŒ‰å­—æ®µé¡ºåºçš„åˆ—è¡¨</td></tr><tr><td>HGETALL</td><td>è·å–æ‰€æœ‰å­—æ®µä¸å€¼</td><td>HGETALL key</td><td>O(N)</td><td>å¤§å“ˆå¸Œæ¨èç”¨ HSCAN è¿­ä»£</td></tr><tr><td>HDEL</td><td>åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ªå­—æ®µ</td><td>HDEL key field [field ...]</td><td>O(N)ï¼ˆN ä¸ºåˆ é™¤å­—æ®µæ•°ï¼‰</td><td>è¿”å›æˆåŠŸåˆ é™¤çš„å­—æ®µä¸ªæ•°</td></tr><tr><td>HEXISTS</td><td>åˆ¤æ–­å­—æ®µæ˜¯å¦å­˜åœ¨</td><td>HEXISTS key field</td><td>O(1)</td><td>å­˜åœ¨è¿”å› 1ï¼Œå¦åˆ™ 0</td></tr><tr><td>HINCRBY</td><td>æ•´æ•°è‡ªå¢</td><td>HINCRBY key field increment</td><td>O(1)</td><td>å­—æ®µéæ•´æ•°ä¼šæŠ¥é”™ï¼›å¯åˆ›å»ºæ–°å­—æ®µ</td></tr><tr><td>HINCRBYFLOAT</td><td>æµ®ç‚¹è‡ªå¢</td><td>HINCRBYFLOAT key field increment</td><td>O(1)</td><td>æ³¨æ„äºŒè¿›åˆ¶æµ®ç‚¹ç²¾åº¦</td></tr><tr><td>HLEN</td><td>å­—æ®µæ•°é‡</td><td>HLEN key</td><td>O(1)</td><td>è¿”å›å“ˆå¸Œå†…å­—æ®µæ€»æ•°</td></tr><tr><td>HKEYS</td><td>æ‰€æœ‰å­—æ®µå</td><td>HKEYS key</td><td>O(N)</td><td>ä»…è¿”å›å­—æ®µå</td></tr><tr><td>HVALS</td><td>æ‰€æœ‰å­—æ®µå€¼</td><td>HVALS key</td><td>O(N)</td><td>ä»…è¿”å›å­—æ®µå€¼</td></tr><tr><td>HRANDFIELD</td><td>éšæœºè¿”å›å­—æ®µï¼ˆå¯å¸¦å€¼ï¼‰</td><td>HRANDFIELD key [count [WITHVALUES]]</td><td>O(N)ï¼ˆN ä¸ºè¿”å›ä¸ªæ•°ï¼›å•ä¸ªæ—¶è¿‘ä¼¼ O(1)ï¼‰</td><td>count&gt;0 å»é‡ï¼Œ&lt;0 å…è®¸é‡å¤</td></tr><tr><td>HSTRLEN</td><td>å­—æ®µå€¼é•¿åº¦</td><td>HSTRLEN key field</td><td>O(1)</td><td>ä¸å­˜åœ¨è¿”å› 0</td></tr><tr><td>HSCAN</td><td>è¿­ä»£æ‰«æå­—æ®µ</td><td>HSCAN key cursor [MATCH pat] [COUNT c]</td><td>å•æ¬¡ O(1)ï¼Œå®Œæ•´éå† O(N)</td><td>æ¸¸æ ‡å¼éé˜»å¡éå†</td></tr><tr><td>HMSET</td><td>æ‰¹é‡è®¾ç½®å­—æ®µï¼ˆå·²å¼ƒç”¨ï¼‰</td><td>HMSET key field value [field value ...]</td><td>O(N)</td><td>å·²è¢« HSET å¤šå­—æ®µè¯­æ³•å–ä»£</td></tr></tbody></table><h3 id="æ ‡å‡†ç¼–ç hashtable">æ ‡å‡†ç¼–ç ï¼šhashtable</h3><p>ä¸ºåœ¨ä¸åŒè´Ÿè½½ä¸‹å®ç°æ€§èƒ½ä¸ç©ºé—´çš„æœ€ä¼˜å¹³è¡¡ï¼ŒHashé‡‡ç”¨äº†åŒé‡ç¼–ç ç­–ç•¥ã€‚å…¶æ ‡å‡†å®ç°æ˜¯ <code>hashtable</code>ç¼–ç ï¼Œå³å­—å…¸ç»“æ„ã€‚</p><p>æ„æˆ Redis å“ˆå¸Œè¡¨çš„æ ¸å¿ƒæ˜¯ <code>dict</code> åŠå…¶èŠ‚ç‚¹<code>dictEntry</code> ç»“æ„ï¼Œæºç å¯çœ‹ï¼š<ahref="https://github.com/redis/redis/blob/8.2.1/src/dict.c">dict.c</a>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å“ˆå¸Œè¡¨èŠ‚ç‚¹</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span> &#123;</span></span><br><span class="line">    <span class="type">void</span> *key; <span class="comment">// é”®</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="type">void</span> *val;</span><br><span class="line">        <span class="type">uint64_t</span> u64;</span><br><span class="line">        <span class="type">int64_t</span> s64;</span><br><span class="line">        <span class="type">double</span> d;</span><br><span class="line">    &#125; v; <span class="comment">// å€¼</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span> *<span class="title">next</span>;</span>   <span class="comment">/* åŒä¸€å“ˆå¸Œæ¡¶ä¸­çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å­—å…¸/å“ˆå¸Œè¡¨</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dict</span> &#123;</span></span><br><span class="line">    dictType *type;</span><br><span class="line"></span><br><span class="line">    dictEntry **ht_table[<span class="number">2</span>]; <span class="comment">// ä¸¤ä¸ªå“ˆå¸Œè¡¨</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> ht_used[<span class="number">2</span>]; <span class="comment">// å·²ç”¨èŠ‚ç‚¹æ•°</span></span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> rehashidx; <span class="comment">/* rehash æ¸¸æ ‡, -1 è¡¨ç¤ºæœªè¿›è¡Œä¸­ */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ... å…¶ä»–å…ƒæ•°æ®å­—æ®µ ... */</span></span><br><span class="line">    <span class="type">signed</span> <span class="type">char</span> ht_size_exp[<span class="number">2</span>]; <span class="comment">/* å“ˆå¸Œè¡¨å¤§å°çš„æŒ‡æ•° (size = 1&lt;&lt;exp) */</span></span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>dictEntry</code> æ„æˆäº†å“ˆå¸Œè¡¨çš„æœ€å°æ•°æ®å•å…ƒï¼Œå³ä¸€ä¸ªé”®å€¼å¯¹ã€‚</p><ul><li><code>void *key</code>ï¼šè¯¥æŒ‡é’ˆæŒ‡å‘å®é™…çš„é”®å¯¹è±¡ï¼Œåœ¨ Redisä¸­é€šå¸¸æ˜¯ä¸€ä¸ª <code>sds</code> (åŠ¨æ€å­—ç¬¦ä¸²) ç»“æ„ã€‚</li><li><code>union v</code>ï¼šè¿™æ˜¯ä¸€ä¸ªå…³é”®çš„æ€§èƒ½ä¼˜åŒ–ã€‚<code>union</code> åœ¨C è¯­è¨€ä¸­å…è®¸å¤šä¸ªæˆå‘˜å…±äº«åŒä¸€å—å†…å­˜ã€‚åœ¨è¿™é‡Œï¼š<ul><li>å½“å€¼ä¸ºæŒ‡é’ˆç±»å‹ï¼ˆå¦‚å¦ä¸€ä¸ª <code>sds</code> æˆ– Redis å¯¹è±¡ï¼‰æ—¶ï¼Œä½¿ç”¨<code>void *val</code>ã€‚</li><li>å½“å€¼å¯ä»¥è¢«ä¸€ä¸ª 64 ä½æ•´å‹æˆ–åŒç²¾åº¦æµ®ç‚¹æ•°è¡¨ç¤ºæ—¶ï¼ŒRedisä¼šç›´æ¥å°†æ•°æ®å­˜å‚¨åœ¨ <code>u64</code>, <code>s64</code>, æˆ– <code>d</code>å­—æ®µä¸­ã€‚è¿™<strong>é¿å…äº†ä¸€æ¬¡é¢å¤–çš„å†…å­˜åˆ†é…å’Œä¸€æ¬¡æŒ‡é’ˆè§£å¼•ç”¨</strong>ï¼Œå¯¹äºå­˜å‚¨å¤§é‡å°æ•´æ•°å€¼çš„Hash æ¥è¯´ï¼Œèƒ½å¸¦æ¥æ˜¾è‘—çš„æ€§èƒ½æå‡ã€‚</li></ul></li><li><code>struct dictEntry *next</code>ï¼š<strong>è¿™æ˜¯é“¾åœ°å€æ³•è§£å†³å“ˆå¸Œå†²çªçš„ç›´æ¥å®ç°</strong>ã€‚å½“å¤šä¸ª<code>key</code> å“ˆå¸Œåˆ°åŒä¸€ä¸ªæ¡¶ (bucket) æ—¶ï¼Œå®ƒä»¬ä¼šé€šè¿‡<code>next</code> æŒ‡é’ˆå½¢æˆä¸€ä¸ªå•å‘é“¾è¡¨ã€‚</li></ul><pre class="mermaid">graph LR    subgraph "å“ˆå¸Œæ¡¶ (Hash Bucket)"        Bucket["ht_table[0][i] (æŒ‡é’ˆ)"]    end    subgraph "dictEntry 1 (é“¾è¡¨å¤´)"        Node1_Key["key: 'user:name'"]        Node1_Val["v (union): 'Alice'"]        Node1_Next["next (æŒ‡é’ˆ)"]    end    subgraph "dictEntry 2 (å†²çªèŠ‚ç‚¹)"        Node2_Key["key: 'user:email'"]        Node2_Val["v (union): 'a@b.com'"]        Node2_Next["next (æŒ‡é’ˆ)"]    end    Bucket --> Node1_Key;    Node1_Key -- " " --> Node1_Val;    Node1_Val -- " " --> Node1_Next;    Node1_Next --> Node2_Key;    Node2_Key -- " " --> Node2_Val;    Node2_Val -- " " --> Node2_Next;    Node2_Next --> NULL["NULL"];</pre><p><code>dict</code>ç»“æ„æ˜¯å“ˆå¸Œè¡¨çš„ç®¡ç†å™¨ï¼Œå…¶è®¾è®¡å®Œå…¨æœåŠ¡äºé«˜æ€§èƒ½å’ŒåŠ¨æ€ä¼¸ç¼©ã€‚</p><ul><li><code>dictEntry **ht_table[2]</code>ï¼šè¿™æ˜¯æ•´ä¸ªå­—å…¸ç»“æ„çš„æ ¸å¿ƒã€‚å®ƒæ˜¯ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªå…ƒç´ çš„æ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ª<code>dictht</code> (å“ˆå¸Œè¡¨) çš„æŒ‡é’ˆã€‚<ul><li><code>ht_table[0]</code>æ˜¯ä¸»å“ˆå¸Œè¡¨ï¼Œæ­£å¸¸æƒ…å†µä¸‹æ‰€æœ‰æ•°æ®éƒ½å­˜å‚¨äºæ­¤ã€‚</li><li><code>ht_table[1]</code> æ˜¯å¤‡ç”¨å“ˆå¸Œè¡¨ï¼Œ<strong>ä»…åœ¨è¿›è¡Œæ¸è¿›å¼ rehashæ—¶ä½¿ç”¨</strong>ï¼Œç”¨äºå­˜æ”¾ä» <code>ht_table[0]</code>è¿ç§»è¿‡æ¥çš„æ•°æ®å’Œæ–°å†™å…¥çš„æ•°æ®ã€‚</li></ul></li><li><code>unsigned long ht_used[2]</code>ï¼šè¿™ä¸¤ä¸ªå­—æ®µåˆ†åˆ«ç²¾ç¡®åœ°è®¡æ•°<code>ht_table[0]</code> å’Œ <code>ht_table[1]</code> ä¸­å·²æœ‰çš„<code>dictEntry</code> æ•°é‡ã€‚</li><li><code>long rehashidx</code>ï¼š<strong>è¿™æ˜¯æ¸è¿›å¼ rehashæœºåˆ¶çš„å‘½è„‰</strong>ã€‚<ul><li>å½“ <code>rehashidx == -1</code> æ—¶ï¼Œç³»ç»Ÿå¤„äºé <code>rehash</code>çŠ¶æ€ã€‚</li><li>å½“ <code>rehashidx &gt; -1</code> æ—¶ï¼Œè¡¨ç¤º <code>rehash</code>æ­£åœ¨è¿›è¡Œä¸­ï¼Œå…¶å€¼æ˜¯å½“å‰æ­£åœ¨ä» <code>ht_table[0]</code> å¾€<code>ht_table[1]</code>è¿ç§»çš„æ¡¶çš„ç´¢å¼•ã€‚æ¯æ¬¡è¿ç§»ä¸€éƒ¨åˆ†æ•°æ®åï¼Œ<code>rehashidx</code>å°±ä¼šé€’å¢ï¼Œç›´åˆ°æ‰€æœ‰æ¡¶è¿ç§»å®Œæ¯•ï¼Œ<code>rehashidx</code> é‡ç½®ä¸º -1ã€‚</li></ul></li><li><code>signed char ht_size_exp[2];</code> è¿™æ˜¯ä¸€ä¸ªç©ºé—´ä¼˜åŒ–ã€‚ç”±äºRedis çš„å“ˆå¸Œè¡¨å¤§å°æ€»æ˜¯ 2 çš„å¹‚æ¬¡æ–¹ï¼Œè¿™é‡Œä¸ç›´æ¥å­˜å‚¨å¤§å°<code>size</code>ï¼Œè€Œæ˜¯å­˜å‚¨å…¶æŒ‡æ•° <code>exp</code>(<code>size = 1 &lt;&lt; exp</code>)ã€‚è¿™ä½¿å¾—ä»…ç”¨ä¸€ä¸ªæœ‰ç¬¦å·å­—ç¬¦å°±èƒ½è¡¨ç¤ºéå¸¸å¤§çš„å“ˆå¸Œè¡¨å°ºå¯¸ï¼ŒèŠ‚çœäº†å…ƒæ•°æ®ç©ºé—´ã€‚</li></ul><pre class="mermaid">graph TD    subgraph DictStruct ["dict ç»“æ„ä½“ (Rehash è¿›è¡Œä¸­)"]        style DictStruct fill:#FEF9E7,stroke:#9A7D0A        direction LR        Field_ht0["<b>ht_table[0]</b> (æŒ‡é’ˆ)"]        Field_ht1["<b>ht_table[1]</b> (æŒ‡é’ˆ)"]        Field_used["<b>ht_used</b>: [5, 3]"]        Field_rehashidx["<b>rehashidx</b> = 2"]    end    subgraph HT0 ["ht_table[0] (æ—§è¡¨)"]        style HT0 fill:#FFDDDD,stroke:#900        direction TB        B0["Bucket 0<br/>(å·²è¿ç§»)"]        B1["Bucket 1<br/>(å·²è¿ç§»)"]        B2["Bucket 2"]        B3["..."]        BN["Bucket N-1"]    end    subgraph HT1 ["ht_table[1] (æ–°è¡¨, å®¹é‡æ›´å¤§)"]        style HT1 fill:#D4FCD7,stroke:#070        direction TB        NB0["..."]        NBK["Bucket K<br/>(å·²è¿ç§»æ•°æ®)"]        NBL["Bucket L<br/>(æ–°å†™å…¥æ•°æ®)"]        NBM["..."]    end    Field_ht0 --> HT0;    Field_ht1 --> HT1;    subgraph Cursor["è¿ç§»æ¸¸æ ‡"]        style Cursor stroke-width:3px,stroke:#F39C12,color:#F39C12        Field_rehashidx -.-> B2;    end</pre><h3 id="ç´§å‡‘ç¼–ç listpack-çš„å†…å­˜ä¼˜åŒ–">ç´§å‡‘ç¼–ç ï¼šlistpack çš„å†…å­˜ä¼˜åŒ–</h3><p>å½“ Hash å¯¹è±¡åŒ…å«çš„å…ƒç´ è¾ƒå°‘ä¸”ä½“ç§¯è¾ƒå°æ—¶ï¼ŒRedis ä¼šé‡‡ç”¨<code>listpack</code> ç¼–ç ã€‚<code>listpack</code>æ˜¯ä¸€å—è¿ç»­å†…å­˜ï¼Œå®ƒå°†å­—æ®µå’Œå€¼åºåˆ—åŒ–å­˜å‚¨ã€‚ç›¸è¾ƒäºå…¶å‰èº«<code>ziplist</code>ï¼Œ<code>listpack</code>é€šè¿‡åœ¨æ¯ä¸ªæ¡ç›®ä¸­å­˜å‚¨è‡ªèº«é•¿åº¦è€Œéå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦ï¼Œä»æ ¹æœ¬ä¸Šè§£å†³äº†<code>ziplist</code> åœ¨æ›´æ–°æ—¶å¯èƒ½å‡ºç°çš„ O(N2)å¤æ‚åº¦çš„è¿é”æ›´æ–°é—®é¢˜ï¼Œä¿è¯äº†æ“ä½œæ€§èƒ½çš„ç¨³å®šæ€§ã€‚</p><blockquote><p>è¿™é‡Œçš„ listpack å’Œ ziplist è·Ÿæˆ‘ä»¬åœ¨ <ahref="https://hedon.top/2025/08/20/redis/redis-datatype-list/">Redisæ•°æ®ç±»å‹ä¸¨ List ä¸¨ä»åŒå‘é“¾è¡¨åˆ° Listpack çš„æ¼”è¿›ä¹‹è·¯</a>è¯´çš„å°±æ˜¯ä¸€å›äº‹ï¼</p></blockquote><pre class="mermaid">graph LR;    subgraph sg1 ["user:1 (Hash Key)"]        A[listpack encoding];    end    subgraph sg_mem ["è¿ç»­çš„å†…å­˜å— (Compact Memory Block)"]        B("field: name") --> C("value: Alice");        C --> D("field: age");        D --> E("value: 30");    end    A --> B;    style sg1 fill:#f9f,stroke:#333,stroke-width:2px</pre><p><strong>ç¼–ç è½¬æ¢</strong>: <code>listpack</code> åˆ°<code>hashtable</code> çš„è½¬æ¢æ˜¯å•å‘çš„ï¼Œåœ¨æ»¡è¶³ä»¥ä¸‹ä»»ä¸€æ¡ä»¶æ—¶è§¦å‘ï¼š</p><ol type="1"><li>å…ƒç´ æ•°é‡è¶…è¿‡ <code>hash-max-listpack-entries</code>ï¼ˆé»˜è®¤ 512ï¼‰</li><li>ä»»ä¸€å€¼çš„é•¿åº¦è¶…è¿‡ <code>hash-max-listpack-value</code>ï¼ˆé»˜è®¤ 64å­—èŠ‚ï¼‰</li></ol><p><strong>å¤æ‚åº¦</strong>:</p><ul><li><code>hashtable</code>:<code>HSET</code>/<code>HGET</code>/<code>HDEL</code> çš„å¹³å‡æ—¶é—´å¤æ‚åº¦ä¸ºO(1)</li><li><code>listpack</code>: ä¸Šè¿°æ“ä½œçš„æ—¶é—´å¤æ‚åº¦ä¸º O(N)ï¼ŒNä¸ºå…ƒç´ æ•°é‡</li></ul><h3 id="æ¸è¿›å¼-rehashrehashidx-çš„è¿ä½œæœºåˆ¶">æ¸è¿›å¼ Rehashï¼šrehashidxçš„è¿ä½œæœºåˆ¶</h3><p>æ¸è¿›å¼ Rehash æ˜¯ Redisä¸ºè§£å†³å•çº¿ç¨‹æ¨¡å‹ä¸‹æ‰©å®¹é˜»å¡é—®é¢˜çš„å…³é”®æœºåˆ¶ã€‚è¯¥è¿‡ç¨‹å®Œå…¨ç”± <code>dict</code>ç»“æ„ä¸­çš„ <code>ht_table[1]</code> å’Œ <code>rehashidx</code>å­—æ®µååŒå®Œæˆã€‚</p><ol type="1"><li><strong>å¯åŠ¨</strong>: å½“æ»¡è¶³æ‰©å®¹æ¡ä»¶ï¼Œ<code>ht_table[1]</code>è¢«åˆ†é…ç©ºé—´ï¼Œ<code>rehashidx</code> ä» <code>-1</code> ç½®ä¸º<code>0</code>ã€‚</li><li><strong>è¿ç§»</strong>: åœ¨åç»­çš„æ¯æ¬¡ä¿®æ”¹å‹å‘½ä»¤ä¸­ï¼ŒRedis ä¼šæ£€æŸ¥<code>rehashidx</code>ã€‚è‹¥å…¶ä¸ä¸º <code>-1</code>ï¼Œåˆ™ä»<code>ht_table[0]</code> çš„ <code>rehashidx</code>ç´¢å¼•ä½ç½®çš„æ¡¶å¼€å§‹ï¼Œå°†æ•°æ®è¿ç§»è‡³ <code>ht_table[1]</code>ï¼Œç„¶å<code>rehashidx++</code>ã€‚åŒæ—¶ï¼Œ<code>serverCron</code>å‘¨æœŸæ€§ä»»åŠ¡ä¹Ÿä¼šä¸»åŠ¨è¿›è¡Œå°‘é‡è¿ç§»ã€‚</li><li><strong>æ“ä½œè·¯ç”±</strong>: åœ¨æ­¤æœŸé—´ï¼Œæ–°å¢æ“ä½œç›´æ¥å†™å…¥<code>ht_table[1]</code>ï¼ŒæŸ¥è¯¢æ“ä½œéœ€æ£€æŸ¥ <code>ht_table[0]</code> å’Œ<code>ht_table[1]</code>ã€‚</li><li><strong>å®Œæˆ</strong>: å½“ <code>ht_table[0]</code>çš„æ‰€æœ‰æ•°æ®è¿ç§»å®Œæ¯•ï¼ˆ<code>rehashidx</code> åˆ°è¾¾ <code>ht_table[0]</code>çš„å®¹é‡ä¸Šé™ï¼‰ï¼Œ<code>ht_table[0]</code> è¢«é‡Šæ”¾ï¼Œ<code>ht_table[1]</code>æˆä¸ºæ–°çš„ <code>ht_table[0]</code>ï¼Œ<code>ht_table[1]</code> æŒ‡é’ˆç½®<code>NULL</code>ï¼Œ<code>rehashidx</code> é‡ç½®ä¸º <code>-1</code>ã€‚</li></ol><p>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ›å»ºä¸€ç»„ä¸‰è”å›¾æ¥å°è¯•å±•ç¤º<strong>æ¸è¿›å¼ Rehash</strong>çš„ä¸‰ä¸ªå…³é”®é˜¶æ®µï¼š<strong>å¼€å§‹å‰</strong>ã€<strong>è¿›è¡Œä¸­</strong> å’Œ<strong>å®Œæˆå</strong>ã€‚</p><h4 id="ç¬¬ä¸€é˜¶æ®µrehash-å¼€å§‹å‰">ç¬¬ä¸€é˜¶æ®µï¼šRehash å¼€å§‹å‰</h4><p>æ­¤æ—¶ï¼Œæ‰€æœ‰æ•°æ®éƒ½å­˜æ”¾åœ¨å“ˆå¸Œè¡¨ <code>ht[0]</code>ä¸­ã€‚éšç€æ•°æ®ä¸æ–­å†™å…¥ï¼Œ<code>ht[0]</code> çš„è´Ÿè½½å› å­å‡é«˜ï¼Œå³å°†è¾¾åˆ°è§¦å‘<code>rehash</code> çš„é˜ˆå€¼ã€‚<code>ht[1]</code> å°šæœªè¢«åˆ†é…ä»»ä½•ç©ºé—´ã€‚</p><pre class="mermaid">graph TD;    subgraph dict ["å­—å…¸å¯¹è±¡ (dict)"]        direction LR;        ht0["ht[0] (æ—§å“ˆå¸Œè¡¨)"];        ht1["ht[1] (æ–°å“ˆå¸Œè¡¨)"];    end    subgraph ht0_buckets ["ht[0] Buckets (å¤§å°: N)"]        direction LR;        b0["Bucket 0"] -- "k1, v1" --> n1["(Data)"];        b1["Bucket 1"] -- "k2, v2" --> n2["(Data)"];        b2["..."];        bn["Bucket N-1"] -- "kN, vN" --> nN["(Data)"];    end    ht0 --> ht0_buckets;    ht1 --> NULL["NULL"];    subgraph legend [çŠ¶æ€è¯´æ˜]        L1["ht[0] å·²æ»¡ï¼Œå³å°†è§¦å‘ Rehash"];    end    style dict fill:#eee,stroke:#333,stroke-width:2px</pre><h4 id="ç¬¬äºŒé˜¶æ®µrehash-è¿›è¡Œä¸­">ç¬¬äºŒé˜¶æ®µï¼šRehash è¿›è¡Œä¸­</h4><p>è¿™æ˜¯æ•´ä¸ªè¿‡ç¨‹çš„æ ¸å¿ƒã€‚Rehash è¢«è§¦å‘åï¼š</p><ol type="1"><li>Redis ä¸º <code>ht[1]</code> åˆ†é…äº†ä¸€ä¸ªæ›´å¤§çš„ç©ºé—´ï¼ˆé€šå¸¸æ˜¯<code>ht[0]</code> å®¹é‡çš„ä¸¤å€ï¼‰ã€‚</li><li>å­—å…¸è¢«æ ‡è®°ä¸º "rehash è¿›è¡Œä¸­"ã€‚</li><li>æ•°æ®å¼€å§‹ä» <code>ht[0]</code> é€æ­¥è¿ç§»åˆ° <code>ht[1]</code>ã€‚</li></ol><p><strong>å›¾è§£å±•ç¤ºäº†æ­¤é˜¶æ®µçš„å…³é”®è¡Œä¸º</strong>:</p><ul><li><strong>è¿ç§» (Migration)</strong>: <code>ht[0]</code> çš„<code>Bucket 0</code> ä¸­çš„æ•°æ® <code>(k1, v1)</code> å·²è¢«è¿ç§»åˆ°<code>ht[1]</code> çš„æ–°ä½ç½®ã€‚</li><li><strong>æŸ¥è¯¢ (Lookup)</strong>: å¿…é¡»å…ˆæ£€æŸ¥<code>ht[0]</code>ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œå†æ£€æŸ¥ <code>ht[1]</code>ã€‚</li><li><strong>å†™å…¥ (Insert)</strong>: <strong>æ–°</strong>çš„é”®å€¼å¯¹<code>(k_new, v_new)</code> è¢«<strong>ç›´æ¥å†™å…¥</strong><code>ht[1]</code>ã€‚</li><li><strong>æ›´æ–°/åˆ é™¤ (Update/Delete)</strong>: å¯¹ <code>ht[0]</code>ä¸­ç°æœ‰æ•°æ®çš„æ“ä½œï¼Œä¼š<strong>é¡ºä¾¿è§¦å‘</strong>ä¸€å°æ‰¹æ•°æ®çš„è¿ç§»ã€‚</li></ul><pre class="mermaid">graph TD    subgraph "Rehash è¿›è¡Œä¸­: å­—å…¸çŠ¶æ€"        direction LR        subgraph dict ["å­—å…¸å¯¹è±¡ (dict)"]            dht0["ht[0] (æ—§è¡¨æŒ‡é’ˆ)"]            dht1["ht[1] (æ–°è¡¨æŒ‡é’ˆ)"]        end        subgraph ht0 ["ht[0] Buckets (æ­£åœ¨è¢«è¿ç§»)"]            style ht0 fill:#FFDDDD,stroke:#900            b0["Bucket 0<br/>(å·²è¿ç§»)"]            b1["..."]            bn["Bucket N-1<br/>(å‰©ä½™æ•°æ®)"]        end        subgraph ht1 ["ht[1] Buckets (æ¥æ”¶æ–°æ•°æ®å’Œè¿ç§»æ•°æ®)"]            style ht1 fill:#D4FCD7,stroke:#070            nb0["..."]            nbk["Bucket K<br/>(ä» ht[0] è¿ç§»è€Œæ¥)"]            nbl["Bucket L<br/>(æ–°å†™å…¥çš„æ•°æ®)"]            nb2n["..."]        end        dht0 --> ht0        dht1 --> ht1    end    subgraph desc ["æ­¤é˜¶æ®µçš„æ“ä½œè§„åˆ™"]        direction LR        lookup["<b>æŸ¥è¯¢ (Lookup)</b><br/>1. å…ˆåœ¨ ht[0] ä¸­æŸ¥æ‰¾<br/>2. å¦‚æœæ‰¾ä¸åˆ°ï¼Œå†å» ht[1] ä¸­æŸ¥æ‰¾"]        insert["<b>å†™å…¥ (Insert)</b><br/>æ‰€æœ‰æ–°é”®å€¼å¯¹<br/>ä¸€å¾‹å†™å…¥ ht[1]"]        migrate["<b>è¿ç§» (Migration)</b><br/>å¯¹ ht[0] ä¸­å…ƒç´ çš„<br/>ä»»ä½•ä¿®æ”¹æˆ–åˆ é™¤æ“ä½œï¼Œ<br/>éƒ½ä¼šè§¦å‘è¯¥å…ƒç´ æ‰€åœ¨æ¡¶(bucket)<br/>çš„æ•´ä½“è¿ç§»"]    end    style desc fill:#f5f5f5,stroke:#333</pre><h4 id="ç¬¬ä¸‰é˜¶æ®µrehash-å®Œæˆå">ç¬¬ä¸‰é˜¶æ®µï¼šRehash å®Œæˆå</h4><p>å½“ <code>ht[0]</code> ä¸­æ‰€æœ‰çš„æ•°æ®éƒ½è¿ç§»åˆ° <code>ht[1]</code>åï¼Œ<code>rehash</code> è¿‡ç¨‹ç»“æŸã€‚</p><ol type="1"><li><code>ht[0]</code> çš„å†…å­˜è¢«é‡Šæ”¾ã€‚</li><li><code>ht[1]</code> æˆä¸ºæ–°çš„ <code>ht[0]</code>ã€‚</li><li>å­—å…¸ä¸­çš„ <code>ht[1]</code> æŒ‡é’ˆé‡æ–°æŒ‡å‘<code>NULL</code>ï¼Œä¸ºä¸‹ä¸€æ¬¡å¯èƒ½çš„ <code>rehash</code> åšå‡†å¤‡ã€‚</li></ol><pre class="mermaid">graph TD;    subgraph dict ["å­—å…¸å¯¹è±¡ (dict)"]        direction LR;        ht0["ht[0] (æ–°å“ˆå¸Œè¡¨)"];        ht1["ht[1]"];    end    subgraph ht0_new_buckets ["ht[0] Buckets (å¤§å°: 2N)"]        b1_0["Bucket 0"];        b1_1["..."];        b1_k["Bucket K"] -- "k1, v1" --> n1_new["(Data)"];        b1_l["Bucket L"] -- "k_new, v_new" --> n_new["(Data)"];        b1_m["..."];        b1_2n["Bucket 2N-1"];    end    ht0 --> ht0_new_buckets;    ht1 --> NULL["NULL"];    subgraph legend [çŠ¶æ€è¯´æ˜]        L1["æ‰€æœ‰æ•°æ®è¿ç§»å®Œæ¯•"];        L2["ht[1] æˆä¸ºæ–°çš„ ht[0]"];        L3["ç³»ç»Ÿæ¢å¤æ­£å¸¸çŠ¶æ€ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡æ‰©å®¹"];    end    style dict fill:#eee,stroke:#333,stroke-width:2px</pre><h2 id="set">Set</h2><p>Setæ˜¯ä¸€ä¸ªæ— åºã€å”¯ä¸€çš„å­—ç¬¦ä¸²å…ƒç´ é›†åˆã€‚å…¶æ ¸å¿ƒä»·å€¼åœ¨äºé«˜æ•ˆçš„æˆå‘˜å…³ç³»åˆ¤æ–­ï¼ˆ<code>SISMEMBER</code>ï¼‰å’ŒæœåŠ¡å™¨ç«¯çš„é›†åˆè¿ç®—ï¼ˆ<code>SINTER</code>,<code>SUNION</code>, <code>SDIFF</code>ï¼‰ã€‚</p><p><strong>å…¸å‹åº”ç”¨åœºæ™¯</strong>ï¼šæ ‡ç­¾ç³»ç»Ÿã€ç”¨æˆ·å…³æ³¨/ç²‰ä¸æ¨¡å‹ã€ç‹¬ç«‹è®¿å®¢ç»Ÿè®¡ã€‚</p><h3 id="å‘½ä»¤æ¸…å•-1">å‘½ä»¤æ¸…å•</h3><table><colgroup><col style="width: 8%" /><col style="width: 16%" /><col style="width: 34%" /><col style="width: 21%" /><col style="width: 18%" /></colgroup><thead><tr><th>å‘½ä»¤</th><th>ä½œç”¨</th><th>å¸¸ç”¨ç”¨æ³•</th><th>æ—¶é—´å¤æ‚åº¦</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>SADD</td><td>æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªæˆå‘˜</td><td>SADD key member [member ...]</td><td>O(N)ï¼ˆN ä¸ºæ·»åŠ æˆå‘˜æ•°ï¼‰</td><td>è¿”å›æ–°å¢æˆå‘˜ä¸ªæ•°</td></tr><tr><td>SREM</td><td>ç§»é™¤ä¸€ä¸ªæˆ–å¤šä¸ªæˆå‘˜</td><td>SREM key member [member ...]</td><td>O(N)ï¼ˆN ä¸ºç§»é™¤æˆå‘˜æ•°ï¼‰</td><td>è¿”å›æˆåŠŸç§»é™¤ä¸ªæ•°</td></tr><tr><td>SISMEMBER</td><td>åˆ¤æ–­æˆå‘˜æ˜¯å¦å­˜åœ¨</td><td>SISMEMBER key member</td><td>O(1)</td><td>å­˜åœ¨è¿”å› 1ï¼Œå¦åˆ™ 0</td></tr><tr><td>SMISMEMBER</td><td>æ‰¹é‡åˆ¤æ–­æˆå‘˜æ˜¯å¦å­˜åœ¨</td><td>SMISMEMBER key member [member ...]</td><td>O(N)</td><td>è¿”å›æŒ‰è¾“å…¥é¡ºåºçš„ 0/1 åˆ—è¡¨</td></tr><tr><td>SMEMBERS</td><td>è¿”å›æ‰€æœ‰æˆå‘˜</td><td>SMEMBERS key</td><td>O(N)</td><td>å¤§é›†åˆå»ºè®®ä½¿ç”¨ SSCAN è¿­ä»£</td></tr><tr><td>SCARD</td><td>æˆå‘˜æ•°é‡</td><td>SCARD key</td><td>O(1)</td><td>è¿”å›é›†åˆåŸºæ•°</td></tr><tr><td>SPOP</td><td>éšæœºå¼¹å‡ºæˆå‘˜ï¼ˆå¯å¤šä¸ªï¼‰</td><td>SPOP key [count]</td><td>å•ä¸ª O(1)ï¼Œå¤šä¸ª O(N)</td><td>ç§»é™¤å¹¶è¿”å›ï¼›ç”¨äºæŠ½æ ·åˆ é™¤</td></tr><tr><td>SRANDMEMBER</td><td>éšæœºè¿”å›æˆå‘˜ï¼ˆä¸ç§»é™¤ï¼‰</td><td>SRANDMEMBER key [count]</td><td>å•ä¸ª O(1)ï¼Œå¤šä¸ª O(N)</td><td>count&gt;0 å»é‡ï¼Œ&lt;0 å…è®¸é‡å¤</td></tr><tr><td>SMOVE</td><td>ä»æºé›†åˆç§»åŠ¨åˆ°ç›®æ ‡</td><td>SMOVE source destination member</td><td>O(1)</td><td>åŸå­æ“ä½œï¼Œæºåˆ ç›®æ ‡åŠ </td></tr><tr><td>SDIFF</td><td>å·®é›†</td><td>SDIFF key [key ...]</td><td>O(N)ï¼ˆN ä¸ºå‚ä¸é›†åˆå…ƒç´ æ€»æ•°ï¼‰</td><td>ä»…è¿”å›ç»“æœï¼Œä¸å­˜å‚¨</td></tr><tr><td>SDIFFSTORE</td><td>å·®é›†å¹¶å­˜å‚¨</td><td>SDIFFSTORE destination key [key ...]</td><td>O(N)</td><td>ç»“æœå†™å…¥ destination</td></tr><tr><td>SINTER</td><td>äº¤é›†</td><td>SINTER key [key ...]</td><td>O(N)</td><td>è¿”å›äº¤é›†æˆå‘˜</td></tr><tr><td>SINTERCARD</td><td>äº¤é›†åŸºæ•°</td><td>SINTERCARD numkeys key [key ...] [LIMIT limit]</td><td>O(N)</td><td>ä»…è¿”å›æ•°é‡ï¼Œé¿å…ç‰©åŒ–ç»“æœ</td></tr><tr><td>SINTERSTORE</td><td>äº¤é›†å¹¶å­˜å‚¨</td><td>SINTERSTORE destination key [key ...]</td><td>O(N)</td><td>ç»“æœå†™å…¥ destination</td></tr><tr><td>SUNION</td><td>å¹¶é›†</td><td>SUNION key [key ...]</td><td>O(N)</td><td>è¿”å›å¹¶é›†æˆå‘˜</td></tr><tr><td>SUNIONSTORE</td><td>å¹¶é›†å¹¶å­˜å‚¨</td><td>SUNIONSTORE destination key [key ...]</td><td>O(N)</td><td>ç»“æœå†™å…¥ destination</td></tr><tr><td>SSCAN</td><td>è¿­ä»£æ‰«æé›†åˆ</td><td>SSCAN key cursor [MATCH pat] [COUNT c]</td><td>å•æ¬¡ O(1)ï¼Œå®Œæ•´éå† O(N)</td><td>æ¸¸æ ‡å¼éé˜»å¡éå†</td></tr></tbody></table><p>Set åŒæ ·é‡‡ç”¨äº†åŒé‡ç¼–ç ç­–ç•¥ï¼Œåˆ†åˆ«æ˜¯ <code>hashtable</code> å’Œ<code>intset</code>ã€‚</p><h3 id="æ ‡å‡†ç¼–ç hashtable-1">æ ‡å‡†ç¼–ç ï¼šhashtable</h3><p>å…¶ä¸­ <code>hashtable</code> å®Œå…¨å¤ç”¨ä¸Šæ–‡æ‰€è¿°çš„ dictç»“æ„ã€‚é›†åˆä¸­çš„æ¯ä¸ªå…ƒç´ è¢«å­˜å‚¨ä¸º <code>dictEntry</code> ä¸­çš„<code>key</code>ï¼Œè€Œ <code>union v</code> (å€¼) éƒ¨åˆ†åˆ™è¢«å¿½ç•¥ï¼ˆç»Ÿä¸€è®¾ä¸ºNULLï¼‰ã€‚è¿™ç§è®¾è®¡ç›´æ¥åˆ©ç”¨äº† dict é”®çš„å”¯ä¸€æ€§æ¥ä¿è¯ Setå…ƒç´ çš„å”¯ä¸€æ€§ï¼Œå¹¶ç»§æ‰¿äº†å…¶ O(1) çš„æŸ¥æ‰¾æ€§èƒ½ã€‚</p><h3 id="æ•´æ•°é›†åˆintset">æ•´æ•°é›†åˆï¼šintset</h3><p>å½“ä¸€ä¸ª Set æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ—¶ï¼Œä¼šé‡‡ç”¨ <code>intset</code> ç¼–ç ï¼š</p><ol type="1"><li>é›†åˆä¸­æ‰€æœ‰å…ƒç´ å‡ä¸ºæ•´æ•°ã€‚</li><li>å…ƒç´ æ•°é‡æœªè¶…è¿‡ <code>set-max-intset-entries</code>é…ç½®é¡¹çš„é˜ˆå€¼ï¼ˆé»˜è®¤ä¸º 512ï¼‰ã€‚</li></ol><p><code>intset</code>æ˜¯ä¸€ç§è‡ªé€‚åº”æ•´æ•°ç¼–ç çš„æœ‰åºæ•°ç»„ã€‚å®ƒå¯ä»¥æ ¹æ®å­˜å…¥æ•´æ•°çš„èŒƒå›´ï¼Œå°†å†…éƒ¨å­˜å‚¨æ ¼å¼åŠ¨æ€å‡çº§ä¸º<code>int16_t</code>, <code>int32_t</code> æˆ–<code>int64_t</code>ï¼Œä»¥æœ€å°çš„å†…å­˜ç©ºé—´å­˜å‚¨æ•°æ®ã€‚æˆå‘˜æŸ¥æ‰¾é€šè¿‡äºŒåˆ†æœç´¢ç®—æ³•å®ç°ã€‚æºç å¯å‚è€ƒï¼š<ahref="https://github.com/redis/redis/blob/8.2.1/src/intset.h">iniset.h</a>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">intset</span> &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> encoding; <span class="comment">// ç¼–ç æ–¹å¼</span></span><br><span class="line">    <span class="type">uint32_t</span> length;   <span class="comment">// å…ƒç´ æ•°é‡</span></span><br><span class="line">    <span class="type">int8_t</span> contents[]; <span class="comment">// æŸ”æ€§æ•°ç»„æˆå‘˜ï¼Œå­˜æ”¾æ•´æ•°</span></span><br><span class="line">&#125; intset;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INTSET_ENC_INT16 (sizeof(int16_t))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INTSET_ENC_INT32 (sizeof(int32_t))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INTSET_ENC_INT64 (sizeof(int64_t))</span></span><br></pre></td></tr></table></figure><ul><li><p><code>uint32_t encoding;</code> è¯¥å­—æ®µå†³å®šäº†<code>contents</code> æ•°ç»„ä¸­æ¯ä¸ªæ•´æ•°çš„å­˜å‚¨å®½åº¦ã€‚å®ƒçš„å€¼æ˜¯<code>INTSET_ENC_INT16</code>, <code>INTSET_ENC_INT32</code>, æˆ–<code>INTSET_ENC_INT64</code> ä¹‹ä¸€ã€‚<strong>è¿™æ˜¯ <code>intset</code>å®ç°è‡ªé€‚åº”ç¼–ç çš„æ ¸å¿ƒ</strong>ã€‚</p></li><li><p><code>uint32_t length;</code> è®°å½•é›†åˆä¸­æ•´æ•°çš„ä¸ªæ•°ã€‚</p></li><li><p><code>int8_t contents[];</code> è¿™æ˜¯ä¸€ä¸ª<strong>æŸ”æ€§æ•°ç»„æˆå‘˜(Flexible Array Member)</strong>ï¼Œæ˜¯ C99 çš„ä¸€ä¸ªç‰¹æ€§ã€‚å®ƒæœ¬èº«ä¸å ç”¨<code>intset</code>ç»“æ„ä½“çš„ç©ºé—´ï¼Œä»…ä½œä¸ºä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘ç´§éšç»“æ„ä½“åˆ†é…çš„è¿ç»­å†…å­˜åŒºåŸŸã€‚å®é™…è®¿é—®æ—¶ï¼Œä»£ç ä¼šæ ¹æ®<code>encoding</code> å­—æ®µçš„å€¼ï¼Œå°† <code>contents</code>æŒ‡é’ˆå¼ºåˆ¶è½¬æ¢ä¸ºå¯¹åº”çš„æ•´æ•°ç±»å‹æŒ‡é’ˆï¼ˆå¦‚<code>(int16_t *)is-&gt;contents</code>ï¼‰æ¥è¯»å†™æ•°æ®ã€‚</p><p><strong>å…³é”®ç‰¹æ€§</strong>ï¼š<code>contents</code>æ•°ç»„ä¸­çš„æ‰€æœ‰æ•´æ•°å§‹ç»ˆä¿æŒ<strong>æœ‰åºæ’åˆ—</strong>ï¼Œè¿™ä½¿å¾—é€šè¿‡äºŒåˆ†æŸ¥æ‰¾ç®—æ³•è¿›è¡Œæˆå‘˜å­˜åœ¨æ€§åˆ¤æ–­æˆä¸ºå¯èƒ½ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(logN)ã€‚</p></li></ul><pre class="mermaid">graph LR;    subgraph sg3 ["article:1:likes (Set Key)"]        A[intset encoding];    end    subgraph sg_intset ["æœ‰åºæ•´æ•°æ•°ç»„ (Sorted Integer Array)"]        direction LR;        B(101) --> C(256) --> D(1024) --> E(8192);    end    A --> B;    style sg3 fill:#ccf,stroke:#333,stroke-width:2px</pre><p>å½“å‘ä¸€ä¸ª <code>intset</code> æ·»åŠ çš„æ–°æ•´æ•°æ— æ³•ç”¨å½“å‰çš„<code>encoding</code> è¡¨ç¤ºæ—¶ï¼ˆä¾‹å¦‚ï¼Œå‘ä¸€ä¸ª <code>INTSET_ENC_INT16</code>çš„é›†åˆä¸­æ·»åŠ  65535ï¼‰ï¼Œä¼šè§¦å‘ <code>intsetUpgradeAndAdd</code> å‡½æ•°ã€‚è¯¥å‡½æ•°çš„æ ¸å¿ƒé€»è¾‘æ˜¯ï¼š</p><ol type="1"><li>ç¡®å®šæ–°çš„ã€æ›´é«˜ç²¾åº¦çš„ç¼–ç ï¼ˆå¦‚ <code>INTSET_ENC_INT32</code>ï¼‰ã€‚</li><li>åˆ†é…ä¸€å—è¶³å¤Ÿå¤§çš„æ–°å†…å­˜ï¼Œå…¶å¤§å°è¶³ä»¥å®¹çº³æ‰€æœ‰æ—§å…ƒç´ ä»¥æ–°ç¼–ç å­˜å‚¨ï¼Œå¹¶å¤–åŠ ä¸€ä¸ªæ–°å…ƒç´ ã€‚</li><li>éå†æ—§çš„ <code>contents</code> æ•°ç»„ï¼Œå°†æ¯ä¸ªå…ƒç´ ä»æ—§ç¼–ç ï¼ˆå¦‚<code>int16_t</code>ï¼‰è¯»å–å‡ºæ¥ï¼Œç„¶åä»¥æ–°ç¼–ç ï¼ˆå¦‚<code>int32_t</code>ï¼‰å†™å…¥æ–°å†…å­˜å—çš„ç›¸åº”ä½ç½®ã€‚</li><li>åœ¨åˆé€‚çš„ä½ç½®æ’å…¥æ–°å…ƒç´ ï¼Œç»´æŒæ•°ç»„çš„æœ‰åºæ€§ã€‚</li><li>é‡Šæ”¾æ—§çš„ <code>intset</code> å†…å­˜ï¼Œå¹¶æ›´æ–°æŒ‡é’ˆæŒ‡å‘æ–°çš„<code>intset</code>ã€‚åŒæ—¶ï¼Œç»“æ„ä½“å†…çš„ <code>encoding</code> å’Œ<code>length</code> å­—æ®µä¹Ÿè¢«æ›´æ–°ã€‚</li></ol><h2 id="ç»“è®º">ç»“è®º</h2><p>Redis çš„ Hash ä¸ Set æ•°æ®ç»“æ„æ˜¯å…¶é«˜æ€§èƒ½å’Œé«˜æ•ˆç‡çš„é›†ä¸­ä½“ç°ã€‚é€šè¿‡åœ¨<code>hashtable</code> ä¸å¤šç§ç´§å‡‘ç¼–ç ï¼ˆ<code>listpack</code>,<code>intset</code>ï¼‰ä¹‹é—´çš„åŠ¨æ€è½¬æ¢ï¼ŒRedisåœ¨ä¸åŒæ•°æ®è§„æ¨¡å’Œç±»å‹ä¸‹å®ç°äº†æ—¶ç©ºå¤æ‚åº¦çš„ä¼˜åŒ–ã€‚æ ¸å¿ƒæœºåˆ¶å¦‚æ¸è¿›å¼ Rehashåˆ™ä»æ ¹æœ¬ä¸Šè§£å†³äº†å•çº¿ç¨‹æ¨¡å‹ä¸‹å¯èƒ½å‡ºç°çš„æ€§èƒ½ç“¶é¢ˆã€‚</p><p>åœ¨æŠ€æœ¯é€‰å‹æ—¶ï¼Œåº”åŸºäºä»¥ä¸‹åŸåˆ™ï¼š</p><ul><li><strong>Hash</strong>:é€‚ç”¨äºå¯¹å®ä½“å¯¹è±¡çš„å±æ€§é›†åˆè¿›è¡Œå»ºæ¨¡ï¼Œå°¤å…¶æ˜¯éœ€è¦é¢‘ç¹å¯¹å•ä¸ªå±æ€§è¿›è¡Œè¯»å†™çš„åœºæ™¯ã€‚</li><li><strong>Set</strong>:é€‚ç”¨äºéœ€è¦ä¿è¯å…ƒç´ å”¯ä¸€æ€§ï¼Œæˆ–è¿›è¡Œæˆå‘˜å…³ç³»åˆ¤æ–­åŠé›†åˆä»£æ•°è¿ç®—çš„åœºæ™¯ã€‚</li></ul><p>å¯¹è¿™äº›åº•å±‚å®ç°çš„æ·±å…¥ç†è§£ï¼Œæ˜¯åˆç†è®¾è®¡æ•°æ®æ¨¡å‹ã€ä¼˜åŒ– Redisæ€§èƒ½ã€ä»¥åŠè¿›è¡Œç²¾ç¡®æ•…éšœè¯Šæ–­çš„åŸºç¡€ã€‚</p>]]></content>
    
    
    <summary type="html">æœ¬ç¯‡åŸºäº Redis 8.2.1 æºç ï¼Œå¸¦ä½ æ·±å…¥ç†è§£ Redis çš„ Hash å’Œ Set æ•°æ®ç±»å‹ã€‚</summary>
    
    
    
    <category term="Redis" scheme="https://hedon.top/categories/Redis/"/>
    
    
    <category term="Redis" scheme="https://hedon.top/tags/Redis/"/>
    
  </entry>
  
  <entry>
    <title>Q&amp;Aä¸¨AI è§†è§’ä¸‹çš„åç«¯æŠ€æœ¯é‡å¡‘</title>
    <link href="https://hedon.top/2025/09/05/qa/qa-traditional-backend-to-ai-engineer/"/>
    <id>https://hedon.top/2025/09/05/qa/qa-traditional-backend-to-ai-engineer/</id>
    <published>2025-09-05T09:13:00.000Z</published>
    <updated>2025-09-06T01:36:15.016Z</updated>
    
    <content type="html"><![CDATA[<p>ç°åœ¨ï¼ˆ2025.9ï¼‰ï¼ŒAIæŠ€æœ¯çªé£çŒ›è¿›ï¼Œæ—¢æ˜¯æœºä¼šï¼Œä¹Ÿæ˜¯å‹åŠ›ã€‚ä½œä¸ºä¸€åä¼ ç»Ÿåç«¯å·¥ç¨‹å¸ˆï¼ˆGo/Rustï¼‰ï¼Œç¬”è€…ä¸€ç›´åœ¨æƒ³ï¼š<u>å¦‚ä½•é¡ºåŠ¿å®Œæˆä»åç«¯å¼€å‘åˆ°AI åº”ç”¨å¼€å‘çš„è½¬å‹ï¼Ÿ</u></p><p>åœ¨æ‘¸ç´¢è¿™æ¡è·¯çš„è¿‡ç¨‹ä¸­ï¼Œç„¦è™‘å¸¸å¸¸å¤šäºç¬ƒå®šã€‚AI æ¡†æ¶ã€AI Agentåº”ç”¨ã€æ–°æŠ€æœ¯ã€æ–°å·¥å…·å±‚å‡ºä¸ç©·ï¼Œæ ‡é¢˜ä¸€ä¸ªæ¯”ä¸€ä¸ªçŒ›â€”â€”<code>"å®ƒç»ˆäºæ¥äº† xxx"</code>ã€<code>"ğŸ‘‹ğŸ» å†è§ xxx"</code>ã€<code>"å²ä¸Šæœ€å¼º xxx"</code>â€¦â€¦</p><p>ä¸ºäº†æŠŠç„¦è™‘å˜æˆè·¯å¾„ï¼Œç¬”è€…å†³å®šå’Œ Geminiæ¥ä¸€åœºæ›´ç³»ç»Ÿçš„æ¢è®¨ï¼š<u>ä¸ç©ºè°ˆå®è®ºï¼Œè€Œæ˜¯è¯·å®ƒåœ¨åç«¯å·¥ç¨‹å¸ˆæ—¥å¸¸ç”¨åˆ°çš„æŠ€æœ¯ä¸Šè¡¥ä¸Šä¸€å±‚"AIè§†è§’"ï¼Œç”¨ä¸€æ¡ä»å·²çŸ¥èµ°å‘æœªçŸ¥çš„å­¦ä¹ è·¯çº¿æŠŠé—®é¢˜è¯´æ¸…æ¥šã€‚</u></p><p>å…·ä½“æ¥è¯´ï¼Œç¬”è€…å¸Œæœ› Gemini å›´ç»•Go/Rustã€MySQL/Redis/Kafkaï¼Œä»¥åŠã€ŠDDIAï¼ˆè®¾è®¡æ•°æ®å¯†é›†å‹åº”ç”¨ï¼‰ã€‹å’Œã€Šäº¿çº§æµé‡ç³»ç»Ÿæ¶æ„è®¾è®¡ä¸å®æˆ˜ã€‹è¿™ä¸¤æœ¬ä¹¦å±•å¼€ï¼Œä¸ºè¿™äº›ç†Ÿæ‚‰çš„ä¸»é¢˜éƒ½åŠ ä¸Šä¸€ä¸ª"AIè§†è§’"ã€‚</p><p>åºŸè¯ä¸å¤šè¯´ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹ Gemini ç»™å‡ºçš„ç­”å·å§~</p><hr /><h1 id="æœ¯">æœ¯</h1><h2 id="ä¸€ai-æ—¶ä»£çš„åŸºç¡€æ¶æ„è½¬å˜">ä¸€ã€AI æ—¶ä»£çš„åŸºç¡€æ¶æ„è½¬å˜</h2><p>äººå·¥æ™ºèƒ½ï¼ˆAIï¼‰çš„å‘å±•å¹¶éè¦å–ä»£ç»å…¸çš„åç«¯å·¥ç¨‹åŸåˆ™ï¼Œè€Œæ˜¯è¦æ±‚æˆ‘ä»¬å¯¹å…¶è¿›è¡Œæ¼”è¿›ã€‚æˆ‘ä»¬å°†æ·±å…¥å‰–æä»ç¡®å®šæ€§çš„ã€ä½å»¶è¿Ÿçš„WebæœåŠ¡åˆ°æ¦‚ç‡æ€§çš„ã€é«˜å»¶è¿Ÿçš„ã€æœ‰çŠ¶æ€ç³»ç»Ÿçš„æ ¹æœ¬æ€§è½¬å˜ã€‚è¿™ä¸€è½¬å˜æ˜¯ç†è§£å’Œæ„å»ºä¸‹ä¸€ä»£AI åŸç”Ÿåº”ç”¨çš„åŸºç¡€ã€‚</p><h3 id="ä»åŒæ­¥è¯·æ±‚å“åº”åˆ°å¼‚æ­¥ä»»åŠ¡ç¼–æ’">1.1ä»åŒæ­¥è¯·æ±‚/å“åº”åˆ°å¼‚æ­¥ä»»åŠ¡ç¼–æ’</h3><p>ä¼ ç»Ÿçš„åç«¯æ¶æ„å»ºç«‹åœ¨åŒæ­¥è¯·æ±‚/å“åº”æ¨¡å‹ä¹‹ä¸Šï¼Œå®¢æˆ·ç«¯å‘èµ·ä¸€ä¸ª HTTPè¯·æ±‚ï¼Œå¹¶é˜»å¡ç­‰å¾…æœåŠ¡å™¨åœ¨å‡ ç™¾æ¯«ç§’å†…è¿”å›ç»“æœã€‚ç„¶è€Œï¼Œå¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰çš„å¼•å…¥å½»åº•é¢ è¦†äº†è¿™ä¸€èŒƒå¼ã€‚ä¸€æ¬¡LLMè°ƒç”¨å¯èƒ½éœ€è¦æ•°ç§’ç”šè‡³æ•°åˆ†é’Ÿæ‰èƒ½å®Œæˆï¼Œè¿™åœ¨ä¼ ç»ŸåŒæ­¥æ¨¡å‹ä¸­æ˜¯ä¸å¯æ¥å—çš„ã€‚å› æ­¤ï¼Œæ¶æ„çš„æ ¸å¿ƒå¿…é¡»è½¬å‘å¼‚æ­¥ä»»åŠ¡ç¼–æ’ã€‚</p><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250905183444729.png" /></p><h4 id="ä»»åŠ¡é˜Ÿåˆ—æ¶æ„">ä»»åŠ¡é˜Ÿåˆ—æ¶æ„</h4><p>ä»»åŠ¡é˜Ÿåˆ—æ¶æ„ï¼ˆTask QueueArchitectureï¼‰æ˜¯åº”å¯¹é«˜å»¶è¿ŸæŒ‘æˆ˜çš„é¦–è¦æ¨¡å¼ã€‚å®ƒå°†è€—æ—¶çš„æ“ä½œä¸å³æ—¶å“åº”è§£è€¦ï¼Œä»è€Œä¿è¯äº†ç”¨æˆ·ä½“éªŒçš„æµç•…æ€§ã€‚å…¶æ ‡å‡†æµç¨‹å¦‚ä¸‹ï¼š</p><ol type="1"><li><strong>ä»»åŠ¡æäº¤</strong>ï¼šå®¢æˆ·ç«¯é€šè¿‡ä¸€ä¸ªåˆå§‹ API è°ƒç”¨ï¼ˆä¾‹å¦‚<code>POST /api/v1/generate_report</code>ï¼‰æäº¤ä¸€ä¸ªé•¿è€—æ—¶ä»»åŠ¡ã€‚è¯·æ±‚ä½“ä¸­åŒ…å«æ‰€æœ‰å¿…è¦å‚æ•°ï¼Œå¦‚æŠ¥å‘Šä¸»é¢˜ã€æ•°æ®æºç­‰ã€‚</li><li><strong>ä»»åŠ¡å…¥é˜Ÿä¸å³æ—¶å“åº”</strong>ï¼šAPIæœåŠ¡å™¨æ¥æ”¶åˆ°è¯·æ±‚åï¼Œå¹¶ä¸ç›´æ¥æ‰§è¡Œä»»åŠ¡ã€‚ç›¸åï¼Œå®ƒå°†ä»»åŠ¡å°è£…æˆä¸€ä¸ªæ¶ˆæ¯ï¼Œæ¨é€åˆ°ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¦‚Kafka æˆ– RabbitMQï¼‰ä¸­ã€‚éšåï¼ŒæœåŠ¡å™¨ç«‹å³å‘å®¢æˆ·ç«¯è¿”å›ä¸€ä¸ªå”¯ä¸€çš„<code>task_id</code>ï¼Œè¿™ä¸ªè¿‡ç¨‹é€šå¸¸åœ¨å‡ åæ¯«ç§’å†…å®Œæˆï¼Œä»è€Œé‡Šæ”¾å®¢æˆ·ç«¯è¿æ¥ï¼Œé¿å…äº†è¶…æ—¶ã€‚</li><li><strong>å¼‚æ­¥å¤„ç†</strong>ï¼šä¸€ä¸ªç‹¬ç«‹çš„ã€å¯æ°´å¹³æ‰©å±•çš„å·¥ä½œè€…ï¼ˆWorkerï¼‰é›†ç¾¤æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚è¿™äº›å·¥ä½œè€…è´Ÿè´£æ‰§è¡Œå®é™…çš„ã€è€—æ—¶çš„LLM è°ƒç”¨ã€æ•°æ®å¤„ç†å’Œç»“æœç”Ÿæˆã€‚</li><li><strong>ç»“æœæŒä¹…åŒ–</strong>ï¼šä»»åŠ¡å®Œæˆåï¼Œå·¥ä½œè€…å°†ç»“æœï¼ˆæˆ–æŒ‡å‘ç»“æœçš„å¼•ç”¨ï¼‰å­˜å‚¨åœ¨ä¸€ä¸ªæŒä¹…åŒ–å­˜å‚¨ç³»ç»Ÿä¸­ï¼Œå¦‚å…³ç³»å‹æ•°æ®åº“æˆ–Redisï¼Œå¹¶ä¸ <code>task_id</code> å…³è”ã€‚</li></ol><h4 id="ç»“æœäº¤ä»˜æœºåˆ¶">ç»“æœäº¤ä»˜æœºåˆ¶</h4><p>ä¸€æ—¦ä»»åŠ¡è¢«å¼‚æ­¥å¤„ç†ï¼Œå®¢æˆ·ç«¯éœ€è¦ä¸€ç§æœºåˆ¶æ¥è·å–æœ€ç»ˆç»“æœã€‚ä¸»è¦æœ‰ä¸¤ç§æ¨¡å¼ï¼š</p><ul><li><strong>è½®è¯¢ï¼ˆPollingï¼‰</strong>ï¼šå®¢æˆ·ç«¯ä½¿ç”¨è·å–åˆ°çš„<code>task_id</code>ï¼Œå‘¨æœŸæ€§åœ°è°ƒç”¨ä¸€ä¸ªçŠ¶æ€æŸ¥è¯¢ APIï¼ˆä¾‹å¦‚<code>GET /api/v1/tasks/&#123;task_id&#125;/status</code>ï¼‰ã€‚æœåŠ¡å™¨è¿”å›ä»»åŠ¡çš„å½“å‰çŠ¶æ€ï¼ˆå¦‚<code>PENDING</code>, <code>IN_PROGRESS</code>, <code>SUCCESS</code>,<code>FAILED</code>ï¼‰ã€‚å½“çŠ¶æ€ä¸º <code>SUCCESS</code>æ—¶ï¼Œå“åº”ä¸­ä¼šåŒ…å«æœ€ç»ˆç»“æœæˆ–ç»“æœçš„è®¿é—®é“¾æ¥ã€‚è¿™ç§æ–¹æ³•å®ç°ç®€å•ï¼Œä½†ä¼šäº§ç”Ÿå¤§é‡æ— æ•ˆè¯·æ±‚ï¼Œæ•ˆç‡è¾ƒä½ã€‚</li><li><strong>WebSocket æˆ–æœåŠ¡å™¨æ¨é€äº‹ä»¶ï¼ˆServer-Sent Events,SSEï¼‰</strong>ï¼šè¿™æ˜¯ä¸€ç§æ›´é«˜æ•ˆã€ç”¨æˆ·ä½“éªŒæ›´ä½³çš„æ¨¡å¼ã€‚å®¢æˆ·ç«¯åœ¨æäº¤ä»»åŠ¡åï¼Œä¸æœåŠ¡å™¨å»ºç«‹ä¸€ä¸ªæŒä¹…è¿æ¥ã€‚å½“ä»»åŠ¡å®Œæˆæ—¶ï¼ŒæœåŠ¡å™¨é€šè¿‡æ­¤è¿æ¥ä¸»åŠ¨å°†ç»“æœæ¨é€ç»™å®¢æˆ·ç«¯ã€‚å¯¹äºLLM çš„æµå¼ç”Ÿæˆï¼ˆtoken-by-token streamingï¼‰ï¼ŒSSEå°¤å…¶é€‚ç”¨ï¼Œå®ƒèƒ½è®©ç”¨æˆ·å®æ—¶çœ‹åˆ°æ–‡æœ¬çš„ç”Ÿæˆè¿‡ç¨‹ï¼Œæå¤§åœ°æ”¹å–„äº†æ„ŸçŸ¥å»¶è¿Ÿã€‚</li></ul><h4 id="å¼‚æ­¥ç³»ç»Ÿä¸­çš„éŸ§æ€§è®¾è®¡">å¼‚æ­¥ç³»ç»Ÿä¸­çš„éŸ§æ€§è®¾è®¡</h4><p>å¼‚æ­¥æ¶æ„çš„å¼•å…¥ä¹Ÿå¸¦æ¥äº†æ–°çš„éŸ§æ€§æŒ‘æˆ˜ã€‚å€Ÿé‰´ã€Šè®¾è®¡æ•°æ®å¯†é›†å‹åº”ç”¨ã€‹ï¼ˆDDIAï¼‰å’Œç°ä»£ç³»ç»Ÿè®¾è®¡çš„åŸåˆ™ï¼Œå¿…é¡»æ„å»ºä¸€ä¸ªèƒ½å¤Ÿ"ä¸ºå¤±è´¥è€Œè®¾è®¡"çš„ç³»ç»Ÿã€‚</p><ul><li><strong>æ­»ä¿¡é˜Ÿåˆ—ï¼ˆDead-Letter Queues, DLQï¼‰</strong>ï¼šå½“ä¸€ä¸ªä»»åŠ¡å› ä¸ºLLM APIé”™è¯¯ã€æ•°æ®æ ¼å¼é—®é¢˜æˆ–å…¶ä»–åŸå› å¤„ç†å¤±è´¥ï¼Œå¹¶ä¸”é‡è¯•æ¬¡æ•°è¾¾åˆ°ä¸Šé™åï¼Œè¯¥ä»»åŠ¡æ¶ˆæ¯ä¸åº”è¢«ä¸¢å¼ƒï¼Œè€Œåº”è¢«å‘é€åˆ°ä¸€ä¸ªä¸“é—¨çš„DLQã€‚è¿™ä½¿å¾—å¼€å‘äººå‘˜å¯ä»¥åç»­åˆ†æå¤±è´¥åŸå› ï¼Œè¿›è¡Œæ‰‹åŠ¨å¹²é¢„æˆ–ä¿®å¤ï¼Œè€Œä¸ä¼šä¸¢å¤±ç”¨æˆ·è¯·æ±‚ã€‚</li><li><strong>æŒ‡æ•°é€€é¿é‡è¯•ï¼ˆExponential BackoffRetriesï¼‰</strong>ï¼šå¯¹å¤–éƒ¨æœåŠ¡ï¼ˆå¦‚ LLMAPIï¼‰çš„è°ƒç”¨å¯èƒ½ä¼šé‡åˆ°ç¬æ—¶æ•…éšœæˆ–é€Ÿç‡é™åˆ¶ã€‚å·¥ä½œè€…åœ¨å¤„ç†å¤±è´¥æ—¶ï¼Œåº”é‡‡ç”¨å¸¦æŠ–åŠ¨çš„æŒ‡æ•°é€€é¿ç­–ç•¥è¿›è¡Œé‡è¯•ï¼Œé¿å…åœ¨çŸ­æ—¶é—´å†…ç”¨å¤§é‡é‡è¯•è¯·æ±‚å†²å‡»ä¸‹æ¸¸æœåŠ¡ã€‚</li><li><strong>å¹‚ç­‰æ€§ï¼ˆIdempotencyï¼‰</strong>ï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæ¶ˆæ¯å¯èƒ½ä¼šè¢«é‡å¤æŠ•é€’ã€‚å·¥ä½œè€…å¿…é¡»è®¾è®¡æˆå¹‚ç­‰çš„ï¼Œå³å¤šæ¬¡å¤„ç†åŒä¸€ä¸ªä»»åŠ¡æ¶ˆæ¯åº”äº§ç”Ÿä¸ä¸€æ¬¡å¤„ç†ç›¸åŒçš„ç»“æœã€‚è¿™é€šå¸¸é€šè¿‡åœ¨ä»»åŠ¡æ¶ˆæ¯ä¸­åŒ…å«ä¸€ä¸ªå”¯ä¸€çš„å¹‚ç­‰æ€§å¯†é’¥æ¥å®ç°ï¼Œå·¥ä½œè€…åœ¨å¤„ç†å‰æ£€æŸ¥è¯¥å¯†é’¥æ˜¯å¦å·²è¢«å¤„ç†è¿‡ã€‚</li></ul><h3 id="åœ¨åˆ†å¸ƒå¼å¯¹è¯å¼ä¸–ç•Œä¸­ç®¡ç†çŠ¶æ€">1.2åœ¨åˆ†å¸ƒå¼ã€å¯¹è¯å¼ä¸–ç•Œä¸­ç®¡ç†çŠ¶æ€</h3><p>ä¼ ç»Ÿçš„é«˜å¹¶å‘åç«¯æœåŠ¡é€šå¸¸è¢«è®¾è®¡ä¸ºæ— çŠ¶æ€çš„ï¼Œä»¥ä¾¿äºæ°´å¹³æ‰©å±•å’Œè´Ÿè½½å‡è¡¡ã€‚ç„¶è€Œï¼ŒAIå¯¹è¯å¤©ç”Ÿå°±æ˜¯æœ‰çŠ¶æ€çš„ã€‚ç”¨æˆ·å‘å‡ºçš„ç¬¬äºŒå¥"é‚£ç¬¬äºŒä¸ªå‘¢ï¼Ÿ"å®Œå…¨ä¾èµ–äºç¬¬ä¸€å¥çš„ä¸Šä¸‹æ–‡ã€‚å¦‚æœè¿™ä¸¤æ¬¡è¯·æ±‚è¢«è´Ÿè½½å‡è¡¡åˆ°ä¸åŒçš„æœåŠ¡å®ä¾‹ä¸Šï¼Œç³»ç»Ÿå°†æ— æ³•ç†è§£å¯¹è¯çš„å»¶ç»­æ€§ã€‚</p><h4 id="å¤–éƒ¨åŒ–çŠ¶æ€å­˜å‚¨">å¤–éƒ¨åŒ–çŠ¶æ€å­˜å‚¨</h4><p>è§£å†³è¿™ä¸ªçŸ›ç›¾çš„è§„èŒƒæ–¹æ¡ˆæ˜¯å°†çŠ¶æ€ä»æœåŠ¡å†…å­˜ä¸­å‰¥ç¦»ï¼Œå­˜å‚¨åˆ°å¤–éƒ¨å…±äº«çš„å­˜å‚¨ç³»ç»Ÿä¸­ã€‚è¿™ç§"å¤–éƒ¨åŒ–çŠ¶æ€å­˜å‚¨"æ¨¡å¼ç¡®ä¿äº†ä»»ä½•æœåŠ¡å®ä¾‹éƒ½å¯ä»¥é€šè¿‡è®¿é—®å…±äº«å­˜å‚¨æ¥è·å–å®Œæ•´çš„å¯¹è¯ä¸Šä¸‹æ–‡ã€‚</p><ul><li><strong>MySQL/PostgreSQL</strong>ï¼šä½œä¸ºå¯¹è¯å†å²çš„é•¿æœŸã€æŒä¹…åŒ–å­˜å‚¨ç³»ç»Ÿã€‚ä¸€ä¸ªè®¾è®¡è‰¯å¥½çš„schema åº”è‡³å°‘åŒ…å« <code>users</code>ã€<code>sessions</code> å’Œ<code>messages</code> ä¸‰å¼ è¡¨ã€‚<code>messages</code>è¡¨è®°å½•æ¯ä¸€æ¡æ¶ˆæ¯çš„å†…å®¹ã€å‘é€è€…ï¼ˆç”¨æˆ·æˆ–AIï¼‰ã€æ—¶é—´æˆ³ï¼Œå¹¶é€šè¿‡å¤–é”®å…³è”åˆ°ç‰¹å®šçš„ <code>sessions</code>è¡¨ï¼Œ<code>sessions</code> è¡¨å†å…³è”åˆ° <code>users</code>è¡¨ã€‚è¿™ç§ç»“æ„åŒ–çš„å­˜å‚¨ä¸ä»…ä¿è¯äº†æ•°æ®çš„æŒä¹…æ€§ï¼Œè¿˜ä¾¿äºè¿›è¡Œåç»­çš„åˆ†æå’Œå®¡è®¡ã€‚</li><li><strong>Redis</strong>ï¼šä½œä¸º AIçš„é«˜æ€§èƒ½çŸ­æœŸå·¥ä½œè®°å¿†ã€‚å¯¹äºæ­£åœ¨è¿›è¡Œçš„æ´»è·ƒå¯¹è¯ï¼Œå°†å…¶æœ€è¿‘çš„å‡ è½®äº¤äº’å†å²ç¼“å­˜åœ¨Redis ä¸­ï¼Œå¯ä»¥æå¤§åœ°é™ä½å¯¹ä¸»æ•°æ®åº“çš„è¯»å–å‹åŠ›ã€‚ä½¿ç”¨ Redis çš„<code>LIST</code> æˆ– <code>HASH</code>æ•°æ®ç»“æ„ï¼Œå¹¶ä¸ºæ¯ä¸ªä¼šè¯è®¾ç½®ä¸€ä¸ªåˆç†çš„è¿‡æœŸæ—¶é—´ï¼ˆTTLï¼‰ï¼Œä¾‹å¦‚ 30åˆ†é’Ÿï¼Œæ˜¯ä¸€ç§å¸¸è§çš„å®è·µã€‚è¿™ç¡®ä¿äº†åœ¨å¯¹è¯æœŸé—´å¯ä»¥å¿«é€ŸåŠ è½½ä¸Šä¸‹æ–‡ï¼ŒåŒæ—¶è‡ªåŠ¨æ¸…ç†ä¸æ´»è·ƒçš„ä¼šè¯æ•°æ®ã€‚</li></ul><h4 id="æƒè¡¡åˆ†æç²˜æ€§ä¼šè¯">æƒè¡¡åˆ†æï¼šç²˜æ€§ä¼šè¯</h4><p>ç²˜æ€§ä¼šè¯æ˜¯ä¸€ç§åœ¨è´Ÿè½½å‡è¡¡å±‚å®ç°çš„ç®€å•æ–¹æ¡ˆï¼Œå®ƒå°†æ¥è‡ªåŒä¸€ç”¨æˆ·çš„æ‰€æœ‰è¯·æ±‚éƒ½è·¯ç”±åˆ°åŒä¸€ä¸ªæœåŠ¡å™¨å®ä¾‹ã€‚è™½ç„¶è¿™å¯ä»¥è§£å†³çŸ­æœŸå†…çš„çŠ¶æ€ç®¡ç†é—®é¢˜ï¼Œä½†å¯¹äºä¸¥è‚ƒã€å¯æ‰©å±•çš„AI åº”ç”¨è€Œè¨€ï¼Œå®ƒæ˜¯ä¸€ç§åæ¨¡å¼ã€‚å…¶ä¸»è¦ç¼ºé™·åŒ…æ‹¬ï¼š</p><ul><li><strong>å•ç‚¹æ•…éšœ</strong>ï¼šå¦‚æœè¯¥æœåŠ¡å™¨å®ä¾‹å®•æœºï¼Œç”¨æˆ·çš„æ‰€æœ‰ä¼šè¯çŠ¶æ€å°†ä¸¢å¤±ï¼Œå¯¹è¯æ— æ³•ç»§ç»­ã€‚</li><li><strong>è´Ÿè½½ä¸å‡</strong>ï¼šæ— æ³•å®ç°çœŸæ­£çš„è´Ÿè½½å‡è¡¡ï¼Œå¯èƒ½å¯¼è‡´æŸäº›æœåŠ¡å™¨å®ä¾‹æˆä¸ºçƒ­ç‚¹ï¼Œèµ„æºåˆ©ç”¨ç‡ä½ä¸‹ã€‚</li><li><strong>æ‰©å±•æ€§å·®</strong>ï¼šåœ¨æœåŠ¡æ‰©ç¼©å®¹æ—¶ï¼Œä¼šè¯çŠ¶æ€çš„ç®¡ç†å˜å¾—å¤æ‚ï¼Œå¯èƒ½å¯¼è‡´ä¼šè¯ä¸­æ–­ã€‚</li></ul><p>è¿™äº›ç¼ºé™·è¿èƒŒäº†ç°ä»£åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡çš„æ ¸å¿ƒåŸåˆ™â€”â€”éŸ§æ€§å’Œå¯æ‰©å±•æ€§ã€‚å› æ­¤ï¼Œå¤–éƒ¨åŒ–çŠ¶æ€å­˜å‚¨æ˜¯æ›´åŠ æ¨èçš„ç”Ÿäº§çº§æ–¹æ¡ˆã€‚</p><h4 id="å¯¹è¯å†å²æ‘˜è¦">å¯¹è¯å†å²æ‘˜è¦</h4><p>å½“å¯¹è¯å˜å¾—éå¸¸é•¿æ—¶ï¼Œå°†å®Œæ•´çš„å†å²è®°å½•é™„åŠ åˆ°æ¯ä¸ª LLM è¯·æ±‚ä¸­ä¼šæ¶ˆè€—å¤§é‡çš„Tokenï¼Œä»è€Œå¢åŠ æˆæœ¬å’Œå»¶è¿Ÿã€‚ä¸€ç§é«˜çº§çš„ä¼˜åŒ–ç­–ç•¥æ˜¯å¼•å…¥å¯¹è¯æ‘˜è¦æœºåˆ¶ã€‚ç³»ç»Ÿå¯ä»¥è®¾è®¡ä¸€ä¸ªåå°ä»»åŠ¡ï¼Œå½“æ£€æµ‹åˆ°æŸä¸ªä¼šè¯çš„å†å²è®°å½•è¶…è¿‡ç‰¹å®šé•¿åº¦ï¼ˆä¾‹å¦‚5000 ä¸ª Tokenï¼‰æ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨ä¸€ä¸ª LLMæ¥å°†ä¹‹å‰çš„å¯¹è¯å†…å®¹æµ“ç¼©æˆä¸€æ®µæ‘˜è¦ã€‚åœ¨åç»­çš„è¯·æ±‚ä¸­ï¼Œç³»ç»Ÿåªéœ€ä¼ é€’è¿™æ®µæ‘˜è¦å’Œæœ€è¿‘å‡ è½®çš„å¯¹è¯ï¼Œå³å¯åœ¨ä¿ç•™å…³é”®ä¸Šä¸‹æ–‡çš„åŒæ—¶ï¼Œæ˜¾è‘—èŠ‚çœToken æ¶ˆè€— ã€‚</p><h3 id="ä¸ºæ¦‚ç‡æ€§ç³»ç»Ÿè®¾è®¡éŸ§æ€§å’Œå¯è§‚æµ‹æ€§">1.3ä¸ºæ¦‚ç‡æ€§ç³»ç»Ÿè®¾è®¡éŸ§æ€§å’Œå¯è§‚æµ‹æ€§</h3><p>ä¼ ç»Ÿç³»ç»Ÿçš„éŸ§æ€§è®¾è®¡ä¸»è¦å…³æ³¨ç¡¬ä»¶æ•…éšœã€ç½‘ç»œåˆ†åŒºå’Œè½¯ä»¶ç¼ºé™·ç­‰ç¡®å®šæ€§é—®é¢˜ã€‚AIç³»ç»Ÿå¼•å…¥äº†ä¸€ç§å…¨æ–°çš„ã€æ›´éšè”½çš„å¤±è´¥æ¨¡å¼ï¼šæ¦‚ç‡æ€§æ–¹å·®ã€‚ç³»ç»Ÿå¯èƒ½åœ¨åŸºç¡€è®¾æ–½å±‚é¢å®Œå…¨â€œå¥åº·â€ï¼Œä½†å…¶è¾“å‡ºçš„å†…å®¹å´æ˜¯é”™è¯¯çš„ã€å¸¦æœ‰åè§çš„æˆ–æœ‰å®³çš„ã€‚</p><h4 id="é¢å‘-llm-çš„å¯è§‚æµ‹æ€§æŠ€æœ¯æ ˆ">é¢å‘ LLM çš„å¯è§‚æµ‹æ€§æŠ€æœ¯æ ˆ</h4><p>ä¼ ç»Ÿçš„ç›‘æ§ï¼ˆMetrics, Logging, Tracingï¼‰éœ€è¦æ‰©å±•ä»¥é€‚åº” LLMçš„ç‰¹æ€§ã€‚ä¸€ä¸ªå®Œæ•´çš„ LLM å¯è§‚æµ‹æ€§æŠ€æœ¯æ ˆåº”åŒ…æ‹¬ï¼š</p><ul><li><strong>æ€§èƒ½æŒ‡æ ‡</strong>ï¼š<ul><li>å»¶è¿Ÿï¼šé¦– Token ç”Ÿæˆæ—¶é—´ï¼ˆTime-to-First-Token,TTFTï¼‰ã€æ€»ç”Ÿæˆæ—¶é—´ã€‚</li><li>ååé‡ï¼šæ¯ç§’è¯·æ±‚æ•°ï¼ˆRPSï¼‰ã€æ¯åˆ†é’Ÿå¤„ç†çš„ Token æ•°ï¼ˆTPMï¼‰ã€‚</li></ul></li><li><strong>æˆæœ¬æŒ‡æ ‡</strong>ï¼š<ul><li>Token æ¶ˆè€—ï¼šç²¾ç¡®è¿½è¸ªæ¯æ¬¡è¯·æ±‚ã€æ¯ä¸ªç”¨æˆ·ã€æ¯ä¸ªåŠŸèƒ½æ¨¡å—çš„è¾“å…¥ä¸è¾“å‡ºToken æ•°é‡ã€‚</li><li>API æˆæœ¬ï¼šå°† Token æ¶ˆè€—ä¸æ¨¡å‹å®šä»·å…³è”ï¼Œå®ç°å®æ—¶çš„æˆæœ¬ç›‘æ§ã€‚</li></ul></li><li><strong>è´¨é‡æŒ‡æ ‡</strong>ï¼š<ul><li>å¹»è§‰ç‡ï¼šè¿½è¸ªæ¨¡å‹ç”Ÿæˆäº‹å®æ€§é”™è¯¯çš„é¢‘ç‡ã€‚</li><li>å›ç­”ç›¸å…³æ€§ï¼šè¯„ä¼°å›ç­”æ˜¯å¦åˆ‡ä¸­ç”¨æˆ·é—®é¢˜ã€‚</li><li>å®‰å…¨æ€§ï¼šæ£€æµ‹æç¤ºæ³¨å…¥ï¼ˆPrompt Injectionï¼‰æ”»å‡»ã€æœ‰å®³å†…å®¹ç”Ÿæˆç­‰ã€‚</li><li>æ¨¡å‹æ¼‚ç§»ï¼šç›‘æ§æ¨¡å‹è¾“å‡ºçš„ç»Ÿè®¡åˆ†å¸ƒéšæ—¶é—´çš„å˜åŒ–ï¼Œä»¥å‘ç°æ€§èƒ½è¡°é€€ã€‚</li><li>è¿™äº›è´¨é‡æŒ‡æ ‡é€šå¸¸éœ€è¦äººå·¥åé¦ˆï¼ˆä¾‹å¦‚ï¼Œç”¨æˆ·ç‚¹å‡»â€œèµâ€æˆ–â€œè¸©â€ï¼‰æˆ–è‡ªåŠ¨åŒ–çš„è¯„ä¼°æµæ°´çº¿æ¥è¡¡é‡ã€‚</li></ul></li><li><strong>è¿½è¸ªï¼ˆTracingï¼‰</strong>ï¼šå¯¹äºç”±å¤šä¸ª LLMè°ƒç”¨å’Œå·¥å…·ä½¿ç”¨ç»„æˆçš„å¤æ‚ Agenté“¾ï¼Œç«¯åˆ°ç«¯çš„åˆ†å¸ƒå¼è¿½è¸ªè‡³å…³é‡è¦ã€‚å®ƒèƒ½å¯è§†åŒ–æ•´ä¸ªæ‰§è¡Œæµç¨‹ï¼Œå¸®åŠ©å®šä½å»¶è¿Ÿç“¶é¢ˆæˆ–é€»è¾‘é”™è¯¯ã€‚è¯¸å¦‚Langfuse è¿™æ ·çš„ä¸“ç”¨å·¥å…·åœ¨æ­¤é¢†åŸŸæä¾›äº†å¼ºå¤§çš„æ”¯æŒ ã€‚</li></ul><h4 id="ä¼˜é›…é™çº§æ¨¡å¼">ä¼˜é›…é™çº§æ¨¡å¼</h4><p>å½“ AI ç³»ç»Ÿé¢ä¸´å‹åŠ›æˆ–æ•…éšœæ—¶ï¼Œåº”èƒ½ä¼˜é›…åœ°é™çº§ï¼Œè€Œä¸æ˜¯å®Œå…¨å´©æºƒã€‚</p><ul><li><strong>æ¨¡å‹å›é€€ï¼ˆModelFallbacksï¼‰</strong>ï¼šè®¾è®¡ä¸€ä¸ªæ¨¡å‹ä¼˜å…ˆçº§ç­–ç•¥ã€‚å½“ä¸»åŠ›çš„ã€æ˜‚è´µçš„é«˜æ€§èƒ½æ¨¡å‹ï¼ˆå¦‚GPT-4ï¼‰è°ƒç”¨å¤±è´¥ã€è¶…æ—¶æˆ–è¿”å›é”™è¯¯æ—¶ï¼Œç³»ç»Ÿå¯ä»¥è‡ªåŠ¨æ•è·å¼‚å¸¸ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ªæ›´ä¾¿å®œã€æ›´å¿«çš„æ¬¡çº§æ¨¡å‹ï¼ˆå¦‚Claude 3.5 Sonnet æˆ–æœ¬åœ°éƒ¨ç½²çš„ Llamaæ¨¡å‹ï¼‰æ¥å¤„ç†è¯·æ±‚ã€‚è¿™ä¿è¯äº†æœåŠ¡çš„å¯ç”¨æ€§ï¼Œå°½ç®¡è¾“å‡ºè´¨é‡å¯èƒ½ç•¥æœ‰ä¸‹é™ ã€‚</li><li><strong>æ–­è·¯å™¨ï¼ˆCircuit Breakersï¼‰</strong>ï¼šåœ¨è°ƒç”¨å¤–éƒ¨ LLM APIçš„å®¢æˆ·ç«¯ä¸­å®ç°æ–­è·¯å™¨æ¨¡å¼ã€‚å½“ APIçš„é”™è¯¯ç‡è¶…è¿‡é¢„è®¾é˜ˆå€¼æ—¶ï¼Œæ–­è·¯å™¨ä¼šè·³é—¸ï¼Œåœ¨ä¸€æ®µæ—¶é—´å†…ç›´æ¥æ‹’ç»æ–°çš„è¯·æ±‚ï¼Œè€Œä¸æ˜¯è®©å®ƒä»¬è¶…æ—¶ã€‚è¿™å¯ä»¥é˜²æ­¢å•ä¸ªä¸‹æ¸¸æœåŠ¡çš„æ•…éšœå¼•å‘æ•´ä¸ªç³»ç»Ÿçš„çº§è”å´©æºƒã€‚</li><li><strong>ç¡®å®šæ€§å›é€€ï¼ˆDeterministicFallbacksï¼‰</strong>ï¼šå¯¹äºé‚£äº›å¿…é¡»è¿”å›ç»“æ„åŒ–æ•°æ®ï¼ˆå¦‚JSONï¼‰çš„å…³é”®ä»»åŠ¡ï¼Œå¦‚æœ LLMåœ¨å¤šæ¬¡é‡è¯•åä»ç„¶æ— æ³•ç”Ÿæˆæ ¼å¼æ­£ç¡®çš„è¾“å‡ºï¼Œç³»ç»Ÿåº”æ”¾å¼ƒ LLMè°ƒç”¨ï¼Œè½¬è€Œæ‰§è¡Œä¸€ä¸ªç®€å•çš„ã€åŸºäºè§„åˆ™çš„ç¡®å®šæ€§é€»è¾‘ï¼Œä»¥ç¡®ä¿æ ¸å¿ƒåŠŸèƒ½çš„å¥å£®æ€§ã€‚</li></ul><h4 id="å¤±è´¥å®šä¹‰çš„æ¼”è¿›">"å¤±è´¥"å®šä¹‰çš„æ¼”è¿›</h4><p>åœ¨ AIé©±åŠ¨çš„ç³»ç»Ÿä¸­ï¼Œ"å¤±è´¥"ä¸å†æ˜¯ä¸€ä¸ªç®€å•çš„äºŒå…ƒçŠ¶æ€ï¼ˆæ­£å¸¸/å®•æœºï¼‰ï¼Œè€Œæ˜¯ä¸€ä¸ªè´¨é‡é™çº§çš„è¿ç»­è°±ã€‚ä¼ ç»ŸæœåŠ¡çš„å¤±è´¥æ˜¯æ˜ç¡®çš„ï¼Œä¾‹å¦‚è¿”å›ä¸€ä¸ªHTTP 500 é”™è¯¯æˆ–è¯·æ±‚è¶…æ—¶ã€‚è€Œä¸€ä¸ª LLMæœåŠ¡çš„"å¤±è´¥"åˆ™å¯èƒ½æ˜¯è¿”å›ä¸€ä¸ªè¯­æ³•å®Œç¾ã€ç»“æ„æ­£ç¡®çš„ JSONå¯¹è±¡ï¼Œä½†å…¶ä¸­å´åŒ…å«ç€å¾®å¦™çš„å¹»è§‰ã€é€»è¾‘çŸ›ç›¾æˆ–åè§è¨€è®º ã€‚</p><p>è¿™ç§è½¬å˜æ„å‘³ç€ä¼ ç»Ÿçš„å¥åº·æ£€æŸ¥ï¼ˆhealthcheckï¼‰æœºåˆ¶ï¼Œå³ç®€å•åœ°æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿”å› HTTP200ï¼Œå·²ç»å˜å¾—æ¯«æ— æ„ä¹‰ã€‚ä¸€ä¸ªçœŸæ­£å…·æœ‰éŸ§æ€§çš„ AIç³»ç»Ÿï¼Œå…¶å¥åº·çš„æ¦‚å¿µå¿…é¡»ä»"å¯ç”¨æ€§"æ‰©å±•åˆ°"è´¨é‡"ã€‚è¿™è¦æ±‚å»ºç«‹ä¸€ä¸ª"<strong>è¯­ä¹‰å¥åº·æ£€æŸ¥</strong>"å±‚ã€‚è¯¥å±‚ä¼šæŒç»­åœ°è¿è¡Œä¸€ç»„é¢„å®šä¹‰çš„é»„é‡‘æµ‹è¯•ç”¨ä¾‹ï¼ˆgoldentest casesï¼‰ï¼Œæˆ–æ ¹æ®ä¸šåŠ¡è§„åˆ™å¯¹æ¨¡å‹çš„å®æ—¶è¾“å‡ºè¿›è¡Œè¯„ä¼°ï¼Œä»è€Œé‡åŒ–æ¨¡å‹çš„è´¨é‡ã€‚</p><p>å› æ­¤ï¼ŒAI ç³»ç»Ÿçš„éŸ§æ€§å·¥ç¨‹ä¸MLOpsï¼ˆæœºå™¨å­¦ä¹ è¿ç»´ï¼‰å˜å¾—å¯†ä¸å¯åˆ†ã€‚åç«¯å›¢é˜Ÿç°åœ¨å¿…é¡»å°†è‡ªåŠ¨åŒ–è¯„ä¼°æµæ°´çº¿ï¼ˆEvalspipelineï¼‰ä½œä¸ºç”Ÿäº§å‡†å¤‡å’Œç›‘æ§çš„æ ¸å¿ƒç»„æˆéƒ¨åˆ†ã€‚æ¨¡å‹çš„è´¨é‡ä¸¥é‡ä¸‹é™åº”è¢«è§†ä¸ºä¸æœåŠ¡å®•æœºåŒç­‰çº§åˆ«çš„P1 çº§äº‹æ•…ï¼Œå¹¶è§¦å‘ç›¸åº”çš„å‘Šè­¦å’Œåº”æ€¥å“åº”æµç¨‹</p><h2 id="äºŒæ•°æ®å±‚çš„é‡æ„ä¸º-ai-è®¾è®¡å­˜å‚¨äºæ£€ç´¢">äºŒã€æ•°æ®å±‚çš„é‡æ„ï¼šä¸º AIè®¾è®¡å­˜å‚¨äºæ£€ç´¢</h2><p>åœ¨ AIæ—¶ä»£ï¼Œæ•°æ®å±‚çš„åŠŸèƒ½è¢«æå¤§åœ°æ‰©å±•äº†ã€‚å®ƒä¸å†ä»…ä»…æ˜¯å­˜å‚¨ä¸šåŠ¡æ•°æ®çš„ä»“åº“ï¼Œè€Œæ˜¯æ‰®æ¼”ç€AIç³»ç»Ÿçš„é•¿æœŸè®°å¿†ã€çŸ­æœŸè®°å¿†å’Œè¯­ä¹‰è®°å¿†çš„è§’è‰²ã€‚æœ¬éƒ¨åˆ†å°†é‡æ–°å®¡è§†æ•°æ®åº“æŠ€æœ¯ï¼Œå¹¶æ¢è®¨å¦‚ä½•ä¸ºAI åº”ç”¨æ„å»ºä¸€ä¸ªé«˜æ•ˆã€å¯æ‰©å±•çš„æ•°æ®åŸºçŸ³ã€‚</p><h3 id="å…³ç³»å‹æ•°æ®åº“mysqlpostgresai-çš„è®°å¿†ç³»ç»Ÿ">2.1å…³ç³»å‹æ•°æ®åº“ï¼ˆMySQL/Postgresï¼‰ï¼šAI çš„è®°å¿†ç³»ç»Ÿ</h3><p>å°½ç®¡å‘é‡æ•°æ®åº“åœ¨ AIé¢†åŸŸå¤‡å—å…³æ³¨ï¼Œä½†å…³ç³»å‹æ•°æ®åº“ï¼ˆRDBMSï¼‰ä»ç„¶æ˜¯ä»»ä½•ç”Ÿäº§çº§æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRetrieval-AugmentedGeneration, RAGï¼‰ç³»ç»Ÿçš„æ ¸å¿ƒæ”¯æŸ±ã€‚å®ƒä¸º LLMå¤„ç†çš„éç»“æ„åŒ–æ•°æ®æä¾›äº†ç»“æ„åŒ–çš„å…ƒæ•°æ®å’Œ"åœ°é¢å®å†µ"ï¼ˆgroundtruthï¼‰ï¼Œæ˜¯ç³»ç»Ÿå¯ä¿¡åº¦å’Œå¯è¿½æº¯æ€§çš„ä¿éšœã€‚</p><p><strong>é«˜çº§ RAG æ•°æ®åº“ Schema è®¾è®¡</strong></p><p>ä¸€ä¸ªç”Ÿäº§å°±ç»ªçš„ RAG ç³»ç»Ÿéœ€è¦ä¸€ä¸ªç²¾å¿ƒè®¾è®¡çš„æ•°æ®åº“schemaï¼Œä»¥ç®¡ç†ä»åŸå§‹æ–‡æ¡£åˆ°æœ€ç»ˆå¯¹è¯çš„å…¨ç”Ÿå‘½å‘¨æœŸã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç»è¿‡éªŒè¯çš„schema èŒƒä¾‹ ï¼š</p><ul><li><strong><code>documents</code> è¡¨</strong>ï¼šå­˜å‚¨æºæ–‡æ¡£çš„å…ƒæ•°æ®ã€‚<ul><li><code>id</code> (PK), <code>file_name</code>,<code>source_url</code>, <code>document_type</code> (e.g., PDF,Markdown), <code>uploader_id</code> (FK), <code>processing_status</code>(e.g., PENDING, PROCESSED, FAILED), <code>created_at</code>,<code>updated_at</code>ã€‚</li></ul></li><li><strong><code>document_chunks</code> è¡¨</strong>ï¼šè¿™æ˜¯ RAGçš„æ ¸å¿ƒè¡¨ï¼Œå­˜å‚¨åˆ‡åˆ†åçš„æ•°æ®å—ã€‚<ul><li><code>id</code> (PK), <code>document_id</code> (FK to<code>documents</code>), <code>chunk_text</code> (TEXT),<code>chunk_metadata</code> (JSONB, e.g., page number, section headers),<code>vector_id</code> (VARCHAR, indexed)ã€‚</li><li><code>vector_id</code>å­—æ®µè‡³å…³é‡è¦ï¼Œå®ƒå»ºç«‹äº†å…³ç³»å‹æ•°æ®ä¸å‘é‡æ•°æ®åº“ä¸­åµŒå…¥å‘é‡ä¹‹é—´çš„ä¸€ä¸€å¯¹åº”å…³ç³»ã€‚è¿™ä½¿å¾—å½“ä»å‘é‡æ•°æ®åº“æ£€ç´¢åˆ°ä¸€ä¸ªç›¸ä¼¼çš„å‘é‡æ—¶ï¼Œç³»ç»Ÿå¯ä»¥å¿«é€Ÿå›æº¯åˆ°å…¶åŸå§‹æ–‡æ¡£ã€ä¸Šä¸‹æ–‡å’Œå…ƒæ•°æ®ï¼Œå®ç°äº†å®Œæ•´çš„å¯è¿½æº¯æ€§ã€‚</li></ul></li><li><strong><code>prompts</code> è¡¨</strong>ï¼šç”¨äºç‰ˆæœ¬åŒ–ç®¡ç† Promptæ¨¡æ¿ã€‚<ul><li><code>id</code> (PK), <code>prompt_name</code> (VARCHAR, unique),<code>version</code> (INT), <code>template_text</code> (TEXT),<code>variables</code> (JSONB), <code>is_active</code> (BOOLEAN)ã€‚</li><li>å°† Promptä¸åº”ç”¨ä»£ç è§£è€¦ï¼Œå…è®¸è¿è¥æˆ–ç®—æ³•äººå‘˜åœ¨ä¸é‡æ–°éƒ¨ç½²æœåŠ¡çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡ä¿®æ”¹æ•°æ®åº“ä¸­çš„æ¨¡æ¿æ¥ä¼˜åŒ–ã€æµ‹è¯•å’Œå›æ»šPromptï¼Œè¿™æ˜¯å…³é”®çš„ MLOps å®è·µã€‚</li></ul></li><li><strong><code>conversation_history</code> è¡¨</strong>ï¼šå¦‚ 1.2èŠ‚æ‰€è¿°ï¼Œç”¨äºæŒä¹…åŒ–å­˜å‚¨å¯¹è¯å†å²ã€‚<ul><li><code>id</code> (PK), <code>session_id</code> (FK),<code>user_id</code> (FK), <code>message_content</code> (TEXT),<code>sender_role</code> (e.g., 'user', 'ai'),<code>timestamp</code>ã€‚</li></ul></li></ul><h3 id="å†…å­˜æ•°æ®åº“redisai-çš„å·¥ä½œè®°å¿†">2.2 å†…å­˜æ•°æ®åº“ï¼ˆRedisï¼‰ï¼šAIçš„å·¥ä½œè®°å¿†</h3><p>Redis çš„äºšæ¯«ç§’çº§å»¶è¿Ÿä½¿å…¶æˆä¸º AI ç³»ç»Ÿç†æƒ³çš„ L1ç¼“å­˜æˆ–å·¥ä½œè®°å¿†ï¼Œèƒ½å¤Ÿæ˜¾è‘—é™ä½é‡å¤æ€§æˆ–çŠ¶æ€ä¾èµ–æ“ä½œçš„å»¶è¿Ÿå’Œæˆæœ¬ã€‚</p><p><strong>è¯­ä¹‰ç¼“å­˜ï¼ˆSemantic Cachingï¼‰</strong></p><p>è¿™æ˜¯ Redis åœ¨ AIé¢†åŸŸæœ€å…·å˜é©æ€§çš„åº”ç”¨ã€‚ä¼ ç»Ÿçš„ç¼“å­˜åŸºäºé”®çš„ç²¾ç¡®åŒ¹é…ï¼Œè€Œè¯­ä¹‰ç¼“å­˜åˆ™åŸºäºå«ä¹‰çš„ç›¸ä¼¼æ€§ã€‚å…¶å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š</p><ol type="1"><li>å½“ç³»ç»Ÿæ”¶åˆ°ä¸€ä¸ªæ–°çš„ç”¨æˆ·æŸ¥è¯¢æ—¶ï¼Œé¦–å…ˆè°ƒç”¨åµŒå…¥æ¨¡å‹å°†å…¶è½¬æ¢ä¸ºä¸€ä¸ªå‘é‡ã€‚</li><li>ç„¶åï¼Œåœ¨ä¸€ä¸ªä¸“é—¨ç”¨äºå­˜å‚¨"å†å²æŸ¥è¯¢åŠå…¶ç­”æ¡ˆ"çš„ Rediså‘é‡ç´¢å¼•ä¸­ï¼Œæ‰§è¡Œä¸€æ¬¡å‘é‡ç›¸ä¼¼æ€§æœç´¢ã€‚</li><li>å¦‚æœæ‰¾åˆ°äº†ä¸€ä¸ªæˆ–å¤šä¸ªåœ¨è¯­ä¹‰ä¸Šé«˜åº¦ç›¸ä¼¼ï¼ˆä¾‹å¦‚ï¼Œä½™å¼¦ç›¸ä¼¼åº¦ &gt;0.95ï¼‰ä¸”å·²è¢«å›ç­”è¿‡çš„æŸ¥è¯¢ï¼Œç³»ç»Ÿå¯ä»¥ç›´æ¥è¿”å›å…¶ç¼“å­˜çš„ç­”æ¡ˆï¼Œä»è€Œå®Œå…¨è·³è¿‡å¯¹æ˜‚è´µçš„LLM API çš„è°ƒç”¨ã€‚</li><li>å¯¹äºé—®ç­”æœºå™¨äººã€å®¢æœç­‰åœºæ™¯ï¼Œå¤§é‡ç”¨æˆ·çš„æé—®åœ¨è¯­ä¹‰ä¸Šæ˜¯é‡å¤çš„ã€‚è¯­ä¹‰ç¼“å­˜è¿™ä¸€æ¨¡å¼èƒ½å¤Ÿæ‹¦æˆªå¤§éƒ¨åˆ†æ­¤ç±»è¯·æ±‚ï¼Œæå¤§åœ°é™ä½API è°ƒç”¨æˆæœ¬å’Œå“åº”å»¶è¿Ÿã€‚</li></ol><p><strong>å¯¹è¯å†å²ç¼“å­˜</strong></p><p>å¦‚ 1.2 èŠ‚æ‰€è¿°ï¼Œå°†æ´»è·ƒå¯¹è¯çš„æœ€è¿‘å‡ è½®äº¤äº’ç¼“å­˜åœ¨ Redis ä¸­ï¼Œå¹¶è®¾ç½®TTLã€‚è¿™é¿å…äº†åœ¨å¯¹è¯çš„æ¯ä¸€æ¬¡è½®è½¬ä¸­éƒ½å»æŸ¥è¯¢ä¸»æ•°æ®åº“ï¼Œæ˜¾è‘—æå‡äº†äº¤äº’çš„æµç•…æ€§ã€‚</p><p><strong>Agent ä¸­é—´æ­¥éª¤ç¼“å­˜</strong></p><p>å¯¹äºå¤æ‚çš„ã€å¤šæ­¥éª¤çš„ Agentå·¥ä½œæµï¼ˆä¾‹å¦‚ï¼šè§„åˆ’ä¸€æ¬¡ä¸ºæœŸäº”å¤©çš„ä¸œäº¬æ—…è¡Œï¼‰ï¼ŒAgentå¯èƒ½éœ€è¦ä¾æ¬¡è°ƒç”¨å¤šä¸ªå·¥å…·ï¼ˆæŸ¥è¯¢èˆªç­ã€æœç´¢é…’åº—ã€è§„åˆ’è¡Œç¨‹ç­‰ï¼‰ã€‚å¯ä»¥å°†æ¯ä¸€æ­¥å·¥å…·æ‰§è¡ŒæˆåŠŸåçš„ç»“æœç¼“å­˜åœ¨Redis ä¸­ï¼Œé”®ä¸º <code>task_id</code> å’Œ <code>step_number</code>ã€‚å¦‚æœAgent åœ¨ç¬¬å››æ­¥å¤±è´¥éœ€è¦é‡è¯•ï¼Œå®ƒå¯ä»¥ç›´æ¥ä» Redisä¸­åŠ è½½å‰ä¸‰æ­¥çš„ç¼“å­˜ç»“æœï¼Œè€Œæ— éœ€ä»å¤´å¼€å§‹æ‰§è¡Œï¼Œè¿™èŠ‚çœäº†å¤§é‡çš„æ—¶é—´å’Œ APIè°ƒç”¨æˆæœ¬ã€‚</p><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250905215321383.png" /></p><h3 id="rag-æ‘„å…¥æµæ°´çº¿æ•°æ®å¯†é›†å‹è®¾è®¡çš„æ¡ˆä¾‹ç ”ç©¶">2.3 RAGæ‘„å…¥æµæ°´çº¿ï¼šæ•°æ®å¯†é›†å‹è®¾è®¡çš„æ¡ˆä¾‹ç ”ç©¶</h3><p>ç”Ÿäº§çº§çš„ RAG é¦–å…ˆæ˜¯ä¸€ä¸ªæ•°æ®å·¥ç¨‹é—®é¢˜ï¼Œå…¶æ¬¡æ‰æ˜¯ä¸€ä¸ª LLMé—®é¢˜ã€‚æœ€ç»ˆè¾“å‡ºçš„è´¨é‡éµå¾ª"åƒåœ¾è¿›ï¼Œåƒåœ¾å‡º"çš„åŸåˆ™ï¼Œè€Œè®¸å¤š"åƒåœ¾"æ­£æ˜¯åœ¨æ•°æ®æ‘„å…¥å’Œåˆ‡å—ï¼ˆChunkingï¼‰é˜¶æ®µäº§ç”Ÿçš„ã€‚</p><p><strong>æµæ°´çº¿é˜¶æ®µ</strong></p><p>ä¸€ä¸ªå¥å£®çš„ RAG æ‘„å…¥æµæ°´çº¿åº”åŒ…å«ä»¥ä¸‹é˜¶æ®µï¼š</p><ol type="1"><li><strong>åŠ è½½ (Load)</strong>ï¼šä½¿ç”¨æ–‡æ¡£åŠ è½½å™¨ä»å„ç§æ•°æ®æºï¼ˆå¦‚S3ã€ç½‘é¡µã€Notionã€Confluenceï¼‰æ‘„å…¥åŸå§‹æ–‡æ¡£ ã€‚</li><li><strong>æå–ä¸æ¸…æ´— (Extract &amp; Clean)</strong>ï¼šä» PDFã€HTMLç­‰æ ¼å¼ä¸­è§£æå‡ºçº¯æ–‡æœ¬ã€‚ç„¶åè¿›è¡Œæ•°æ®æ¸…æ´—ï¼ŒåŒ…æ‹¬ç§»é™¤æ¨¡æ¿åŒ–çš„é¡µçœ‰é¡µè„šã€æ ‡å‡†åŒ–æ–‡æœ¬æ ¼å¼ï¼ˆå¦‚ç»Ÿä¸€ç¼–ç ï¼‰ã€çº æ­£å¸¸è§æ‹¼å†™é”™è¯¯ç­‰ã€‚</li><li><strong>åˆ‡å—(Chunk)</strong>ï¼šè¿™æ˜¯æ•´ä¸ªæµæ°´çº¿ä¸­æœ€å…³é”®ã€ä¹Ÿæœ€éœ€è¦æŠ€å·§çš„ä¸€æ­¥ã€‚åˆ‡å—çš„è´¨é‡ç›´æ¥å†³å®šäº†æ£€ç´¢ç»“æœçš„è´¨é‡ã€‚</li></ol><p><strong>åˆ‡å—ç­–ç•¥å¯¹æ¯”åˆ†æ</strong></p><p>åˆ‡å—æ˜¯ä¸€ä¸ªçœ‹ä¼¼ç®€å•ä½†å®åˆ™å¤æ‚çš„é—®é¢˜ï¼Œé”™è¯¯çš„é€‰æ‹©ä¼šå¯¼è‡´å¤§æµ·æé’ˆæˆ–ä¸Šä¸‹æ–‡ä¸­ä¸¢å¤±ç­‰é—®é¢˜ï¼Œå³ç›¸å…³ä¿¡æ¯è¢«åˆ‡åˆ†åˆ°ä¸åŒå—ä¸­æˆ–è¢«æ·¹æ²¡åœ¨å¤§é‡ä¸ç›¸å…³ä¿¡æ¯ä¸­ï¼Œä»è€Œå½±å“LLM çš„æœ€ç»ˆè¡¨ç°ã€‚å°†åˆ‡å—ä»ä¸€é—¨è‰ºæœ¯è½¬å˜ä¸ºä¸€é¡¹å·¥ç¨‹å†³ç­–ï¼Œéœ€è¦å¯¹ä¸åŒç­–ç•¥è¿›è¡Œç³»ç»Ÿæ€§è¯„ä¼°ã€‚</p><p>å³ç›¸å…³ä¿¡æ¯è¢«åˆ‡åˆ†åˆ°ä¸åŒå—ä¸­æˆ–è¢«æ·¹æ²¡åœ¨å¤§é‡ä¸ç›¸å…³ä¿¡æ¯ä¸­ï¼Œä»è€Œå½±å“ LLMçš„æœ€ç»ˆè¡¨ç°ã€‚å°†åˆ‡å—ä»ä¸€é—¨â€œè‰ºæœ¯â€è½¬å˜ä¸ºä¸€é¡¹å·¥ç¨‹å†³ç­–ï¼Œéœ€è¦å¯¹ä¸åŒç­–ç•¥è¿›è¡Œç³»ç»Ÿæ€§è¯„ä¼°ã€‚</p><table><colgroup><col style="width: 13%" /><col style="width: 28%" /><col style="width: 19%" /><col style="width: 18%" /><col style="width: 19%" /></colgroup><thead><tr><th>ç­–ç•¥åç§°</th><th>æè¿°</th><th>ä¼˜ç‚¹</th><th>ç¼ºç‚¹</th><th>æœ€ä½³é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td><strong>å›ºå®šå¤§å°åˆ‡å— (Fixed-Size)</strong></td><td>æŒ‰å›ºå®šæ•°é‡çš„å­—ç¬¦æˆ– Token è¿›è¡Œåˆ‡åˆ†ï¼Œå¯è®¾ç½®é‡å éƒ¨åˆ†</td><td>å®ç°ç®€å•ï¼Œå—å¤§å°å¯é¢„æµ‹ï¼Œä¾¿äºæ‰¹å¤„ç†ã€‚</td><td>å¸¸å¸¸ä¼šç²—æš´åœ°åˆ‡æ–­å¥å­å’Œå®Œæ•´çš„è¯­ä¹‰å•å…ƒï¼Œç ´åä¸Šä¸‹æ–‡ã€‚</td><td>æ ¼å¼ç»Ÿä¸€ã€æ— æ˜æ˜¾ç»“æ„ç‰¹å¾çš„ç®€å•æ–‡æœ¬ï¼Œå¦‚æ—¥å¿—æ–‡ä»¶ã€‚</td></tr><tr><td><strong>é€’å½’å­—ç¬¦åˆ‡å— (Recursive Character)</strong></td><td>ä½¿ç”¨ä¸€ä¸ªä¼˜å…ˆçº§åˆ—è¡¨ï¼ˆå¦‚ <code>\n\n</code>, <code>\n</code>,<code></code>ï¼‰è¿›è¡Œé€’å½’åˆ‡åˆ†ï¼Œç›´åˆ°å—å¤§å°è¾¾æ ‡</td><td>åŠªåŠ›å°Šé‡åŸæ–‡çš„æ®µè½ã€å¥å­ç­‰è¯­ä¹‰è¾¹ç•Œï¼Œæ˜¯å¾ˆå¥½çš„é€šç”¨é€‰æ‹©ã€‚</td><td>å¯¹äºæ ¼å¼æ··ä¹±çš„æ–‡æœ¬ï¼Œä»å¯èƒ½äº§ç”Ÿä¸ç†æƒ³çš„åˆ‡åˆ†ã€‚</td><td>å¤§å¤šæ•°é€šç”¨æ–‡æœ¬æ–‡æ¡£ï¼Œå¦‚æ–°é—»æ–‡ç« ã€åšå®¢ã€ç½‘é¡µå†…å®¹ã€‚</td></tr><tr><td><strong>æ–‡æ¡£æ„ŸçŸ¥åˆ‡å— (Document-Aware)</strong></td><td>æ ¹æ®æ–‡æ¡£è‡ªèº«çš„ç»“æ„è¿›è¡Œåˆ‡åˆ†ï¼Œå¦‚æŒ‰ Markdown çš„æ ‡é¢˜ã€HTMLçš„æ ‡ç­¾ã€ä»£ç çš„å‡½æ•°æˆ–ç±»</td><td>ç”Ÿæˆçš„å—å…·æœ‰æé«˜çš„è¯­ä¹‰å†…èšæ€§å’Œä¸Šä¸‹æ–‡å®Œæ•´æ€§ã€‚</td><td>éœ€è¦ä¸ºæ¯ç§æ–‡æ¡£ç±»å‹ç¼–å†™æˆ–ä½¿ç”¨ç‰¹å®šçš„è§£æå™¨ã€‚</td><td>ç»“æ„åŒ–æˆ–åŠç»“æ„åŒ–æ–‡æ¡£ï¼Œå¦‚ Markdownã€HTMLã€æºä»£ç æ–‡ä»¶ã€‚</td></tr><tr><td><strong>è¯­ä¹‰åˆ‡å— (Semantic)</strong></td><td>ä½¿ç”¨åµŒå…¥å‘é‡å°†è¯­ä¹‰ä¸Šç›¸ä¼¼çš„å¥å­èšåˆåœ¨ä¸€èµ·ï¼Œå½¢æˆä¸€ä¸ªå—</td><td>è¯­ä¹‰å†…èšæ€§æœ€é«˜ï¼›å—çš„åˆ’åˆ†åŸºäºâ€œæ„ä¹‰â€è€Œéè¯­æ³•æˆ–æ ¼å¼ã€‚</td><td>è®¡ç®—æˆæœ¬é«˜ï¼Œéœ€è¦åœ¨åˆ‡å—é˜¶æ®µé¢å¤–è¿›è¡Œä¸€æ¬¡åµŒå…¥å’Œèšç±»ã€‚</td><td>å†…å®¹å¯†é›†ã€å™äº‹æ€§å¼ºçš„æ–‡æœ¬ï¼Œå…¶ä¸­æ¦‚å¿µå’Œä¸»é¢˜æ¯”ç»“æ„æ›´é‡è¦ã€‚</td></tr><tr><td><strong>Agentic åˆ‡å— (Agentic)</strong></td><td>åˆ©ç”¨ LLM è‡ªèº«æ¥åˆ¤æ–­æ–‡æ¡£ä¸­æœ€åˆç†çš„åˆ‡åˆ†è¾¹ç•Œ</td><td>æ½œåŠ›å·¨å¤§ï¼Œèƒ½æ¨¡æ‹Ÿäººç±»ç¼–è¾‘çš„é€»è¾‘æ¥åˆ‡åˆ†å¤æ‚æ–‡æ¡£ã€‚</td><td>é€Ÿåº¦ææ…¢ã€æˆæœ¬é«˜æ˜‚ä¸”ç»“æœä¸ç¡®å®šï¼Œç›®å‰ä»å¤„äºå®éªŒé˜¶æ®µã€‚</td><td>å…¶ä»–æ–¹æ³•å‡å‘Šå¤±è´¥çš„ã€é«˜åº¦å¤æ‚å’Œå¼‚æ„çš„æ–‡æ¡£ã€‚</td></tr></tbody></table><h2 id="ä¸‰ç¥ç»ç³»ç»Ÿä½¿ç”¨-kafka-è¿›è¡Œå¼‚æ­¥å¤„ç†">ä¸‰ã€ç¥ç»ç³»ç»Ÿï¼šä½¿ç”¨ Kafkaè¿›è¡Œå¼‚æ­¥å¤„ç†</h2><p>åœ¨æœ¬éƒ¨åˆ†ä¸­ï¼ŒKafkaçš„è§’è‰²è¢«é‡æ–°å®šä¹‰ï¼šå®ƒä¸å†ä»…ä»…æ˜¯ä¸€ä¸ªç”¨äºæœåŠ¡è§£è€¦çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè€Œæ˜¯æ•´ä¸ª AIç³»ç»Ÿçš„ä¸­å¤®æ•°æ®æ€»çº¿å’Œ"ç¥ç»ç³»ç»Ÿ"ï¼Œè´Ÿè´£ç¼–æ’ä»æ•°æ®æ‘„å…¥åˆ°æ™ºèƒ½ä½“åä½œçš„å„ç§å¤æ‚å·¥ä½œæµã€‚</p><h3 id="kafka-ä½œä¸º-rag-å’Œå¾®è°ƒæµæ°´çº¿çš„æ”¯æŸ±">3.1 Kafka ä½œä¸º RAGå’Œå¾®è°ƒæµæ°´çº¿çš„æ”¯æŸ±</h3><p><strong>RAG æ‘„å…¥æµæ°´çº¿</strong></p><p>å¦‚å‰æ‰€è¿°ï¼ŒKafka æ˜¯æ„å»ºå¯æ‰©å±•ã€å¯è§‚æµ‹çš„ RAGæ‘„å…¥æµæ°´çº¿çš„ç†æƒ³é€‰æ‹©ã€‚ä¸€ä¸ªæ ‡å‡†çš„ Kafka æ‹“æ‰‘ç»“æ„å¦‚ä¸‹ ï¼š</p><ol type="1"><li><strong><code>documents-to-process</code> ä¸»é¢˜(Topic)</strong>ï¼šå½“æ–°æ–‡æ¡£è¢«ä¸Šä¼ æˆ–å‘ç°æ—¶ï¼Œä¸€ä¸ªç”Ÿäº§è€…æœåŠ¡å°†æ–‡æ¡£çš„ URIæˆ–å¼•ç”¨å‘å¸ƒåˆ°æ­¤ä¸»é¢˜ã€‚</li><li><strong><code>chunks-to-embed</code>ä¸»é¢˜</strong>ï¼šä¸€ä¸ªåˆ‡å—å™¨ï¼ˆChunkerï¼‰æœåŠ¡æ¶ˆè´¹<code>documents-to-process</code>ä¸»é¢˜ã€‚å®ƒä¸‹è½½æ–‡æ¡£ã€æ ¹æ®é¢„å®šç­–ç•¥è¿›è¡Œåˆ‡å—ï¼Œç„¶åå°†æ¯ä¸ªæ•°æ®å—ï¼ˆåŒ…å«æ–‡æœ¬å’Œå…ƒæ•°æ®ï¼‰ä½œä¸ºç‹¬ç«‹æ¶ˆæ¯å‘å¸ƒåˆ°æ­¤ä¸»é¢˜ã€‚</li><li><strong><code>chunks-to-index</code>ä¸»é¢˜</strong>ï¼šä¸€ä¸ªåµŒå…¥å™¨ï¼ˆEmbedderï¼‰æœåŠ¡æ¶ˆè´¹<code>chunks-to-embed</code>ä¸»é¢˜ã€‚å®ƒè°ƒç”¨åµŒå…¥æ¨¡å‹ä¸ºæ¯ä¸ªæ•°æ®å—ç”Ÿæˆå‘é‡ï¼Œç„¶åå°†åŒ…å«æ•°æ®å—ã€å…ƒæ•°æ®å’Œå‘é‡çš„æ¶ˆæ¯å‘å¸ƒåˆ°æ­¤ä¸»é¢˜ã€‚</li><li><strong>ç´¢å¼•</strong>ï¼šæœ€åï¼Œä¸€ä¸ªç´¢å¼•å™¨ï¼ˆIndexerï¼‰æœåŠ¡æ¶ˆè´¹<code>chunks-to-index</code>ä¸»é¢˜ï¼Œå¹¶å°†æ•°æ®å—çš„å…ƒæ•°æ®å†™å…¥å…³ç³»å‹æ•°æ®åº“ï¼ŒåŒæ—¶å°†å‘é‡å†™å…¥å‘é‡æ•°æ®åº“ã€‚</li></ol><p>è¿™ç§åŸºäº Kafkaçš„æµæ°´çº¿æ¶æ„å…·æœ‰é«˜åº¦çš„è§£è€¦æ€§ã€‚æ¯ä¸ªæœåŠ¡ï¼ˆåˆ‡å—å™¨ã€åµŒå…¥å™¨ã€ç´¢å¼•å™¨ï¼‰éƒ½å¯ä»¥ç‹¬ç«‹å¼€å‘ã€éƒ¨ç½²ã€æ‰©å±•å’Œç›‘æ§ï¼Œä»è€Œæ„å»ºä¸€ä¸ªæå…·å¼¹æ€§å’Œæ€§èƒ½çš„ç³»ç»Ÿã€‚</p><p><strong>å¾®è°ƒåé¦ˆé—­ç¯</strong></p><p>é™¤äº†æ•°æ®æ‘„å…¥ï¼ŒKafkaè¿˜èƒ½æ„å»ºä¸€ä¸ªå®æ—¶çš„æ¨¡å‹å¾®è°ƒï¼ˆFine-Tuningï¼‰åé¦ˆé—­ç¯ï¼Œå®ç°æ¨¡å‹çš„æŒç»­å­¦ä¹ å’Œä¼˜åŒ–ã€‚</p><ol type="1"><li><strong>æ”¶é›†åé¦ˆ</strong>ï¼šåº”ç”¨å‰ç«¯æˆ–åç«¯æœåŠ¡å°†ç”¨æˆ·çš„éšå¼æˆ–æ˜¾å¼åé¦ˆï¼ˆä¾‹å¦‚ï¼Œå¯¹å›ç­”ç‚¹"èµ"æˆ–"è¸©"ã€ç”¨æˆ·æ‰‹åŠ¨ä¿®æ­£AI çš„å›ç­”ã€å¯¹è¯çš„æœ€ç»ˆæ»¡æ„åº¦è¯„åˆ†ç­‰ï¼‰ä½œä¸ºäº‹ä»¶å‘å¸ƒåˆ° Kafka çš„<code>feedback</code> ä¸»é¢˜ã€‚</li><li><strong>å®æ—¶å¤„ç†</strong>ï¼šä¸€ä¸ªæµå¤„ç†åº”ç”¨ï¼ˆå¦‚ä½¿ç”¨ Apache Flink æˆ–Kafka Streamsï¼‰æ¶ˆè´¹ <code>feedback</code>ä¸»é¢˜ã€‚å®ƒå¯¹åé¦ˆæ•°æ®è¿›è¡Œå®æ—¶èšåˆã€è¿‡æ»¤å’Œæ¸…æ´—ï¼Œç­›é€‰å‡ºé«˜è´¨é‡çš„è®­ç»ƒæ ·æœ¬ï¼ˆä¾‹å¦‚ï¼Œè¢«ç”¨æˆ·æ˜ç¡®æ ‡è®°ä¸º"å¥½"çš„é—®ç­”å¯¹ï¼‰ã€‚</li><li><strong>æ•°æ®æ²‰æ·€</strong>ï¼šå¤„ç†åçš„é«˜è´¨é‡æ•°æ®è¢«å†™å…¥ä¸€ä¸ªä¸“é—¨ç”¨äºæ¨¡å‹è®­ç»ƒçš„æ•°æ®æ¹–æˆ–æ•°æ®ä»“åº“ã€‚</li><li><strong>è§¦å‘å¾®è°ƒ</strong>ï¼šå½“ç§¯ç´¯çš„æ–°è®­ç»ƒæ ·æœ¬è¾¾åˆ°ä¸€å®šæ•°é‡ï¼ˆä¾‹å¦‚ 1000æ¡ï¼‰æ—¶ï¼Œæµå¤„ç†åº”ç”¨ä¼šå‘å¸ƒä¸€ä¸ªäº‹ä»¶åˆ° <code>trigger-finetuning-job</code>ä¸»é¢˜ã€‚</li><li><strong>è‡ªåŠ¨åŒ–è®­ç»ƒ</strong>ï¼šä¸€ä¸ª MLOpsæœåŠ¡ç›‘å¬æ­¤ä¸»é¢˜ï¼Œå¹¶è‡ªåŠ¨å¯åŠ¨ä¸€ä¸ªæ–°çš„æ¨¡å‹å¾®è°ƒä½œä¸šï¼Œä½¿ç”¨æœ€æ–°çš„æ•°æ®å¯¹åŸºç¡€æ¨¡å‹è¿›è¡Œä¼˜åŒ–ã€‚</li></ol><p>è¿™ä¸ªé—­ç¯å°†ç”¨æˆ·äº¤äº’ä¸æ¨¡å‹è¿­ä»£æ— ç¼è¿æ¥èµ·æ¥ï¼Œä½¿ LLMèƒ½å¤ŸåŠ¨æ€åœ°é€‚åº”ç‰¹å®šé¢†åŸŸçš„éœ€æ±‚å’Œç”¨æˆ·åå¥½ã€‚</p><h3 id="ä¸º-llm-å·¥ä½œè´Ÿè½½è®¾è®¡-kafka">3.2 ä¸º LLM å·¥ä½œè´Ÿè½½è®¾è®¡ Kafka</h3><p>å°† Kafka åº”ç”¨äº LLM å·¥ä½œè´Ÿè½½æ—¶ï¼Œéœ€è¦è€ƒè™‘å…¶ç‹¬ç‰¹çš„æ•°æ®ç‰¹æ€§ã€‚</p><p><strong>ä¸»é¢˜ä¸åˆ†åŒºç­–ç•¥</strong></p><p>ä¸ºäº†ä¿è¯å¯¹è¯çš„ä¸Šä¸‹æ–‡é¡ºåºï¼Œä½¿ç”¨ä¸€ä¸ªä¸å¯¹è¯æˆ–ç”¨æˆ·ç›¸å…³çš„æ ‡è¯†ç¬¦ï¼ˆå¦‚<code>user_id</code> æˆ–<code>session_id</code>ï¼‰ä½œä¸ºæ¶ˆæ¯çš„åˆ†åŒºé”®ï¼ˆPartitionKeyï¼‰è‡³å…³é‡è¦ã€‚è¿™ç¡®ä¿äº†æ¥è‡ªåŒä¸€ä¸ªå¯¹è¯çš„æ‰€æœ‰äº‹ä»¶éƒ½ä¼šè¢«å‘é€åˆ°åŒä¸€ä¸ªåˆ†åŒºï¼Œå¹¶ç”±åŒä¸€ä¸ªæ¶ˆè´¹è€…å®ä¾‹æŒ‰é¡ºåºå¤„ç†ï¼Œä»è€Œé¿å…äº†ä¸Šä¸‹æ–‡é”™ä¹±çš„é—®é¢˜ã€‚</p><p><strong>æ¶ˆæ¯è´Ÿè½½ç®¡ç†</strong></p><p>LLMçš„è¯·æ±‚å’Œå“åº”ï¼Œå°¤å…¶æ˜¯åŒ…å«é•¿å¯¹è¯å†å²çš„ï¼Œå¯èƒ½ä¼šéå¸¸å¤§ã€‚å¤„ç†å¤§æ¶ˆæ¯è´Ÿè½½æœ‰ä»¥ä¸‹ç­–ç•¥ï¼š</p><ul><li><strong>åºåˆ—åŒ–ä¸å‹ç¼©</strong>ï¼šä½¿ç”¨å¦‚ Avroè¿™æ ·çš„äºŒè¿›åˆ¶åºåˆ—åŒ–æ¡†æ¶ï¼Œå®ƒæä¾›äº† schema æ¼”è¿›çš„æ”¯æŒï¼Œæ¯” JSONæ›´ç´§å‡‘ã€‚åŒæ—¶ï¼Œå¯ç”¨é«˜æ•ˆçš„å‹ç¼©ç®—æ³•ï¼ˆå¦‚ lz4 æˆ–zstdï¼‰å¯ä»¥æ˜¾è‘—å‡å°‘æ¶ˆæ¯çš„ä½“ç§¯ï¼Œé™ä½ç½‘ç»œä¼ è¾“å’Œå­˜å‚¨å¼€é”€ ã€‚</li><li><strong>å£°æ˜æ£€æŸ¥æ¨¡å¼</strong>ï¼šå¯¹äºè¶…è¿‡ Kafka æ¶ˆæ¯å¤§å°é™åˆ¶ï¼ˆé€šå¸¸ä¸º1MBï¼‰çš„è¶…å¤§è´Ÿè½½ï¼Œå¯ä»¥é‡‡ç”¨å£°æ˜æ£€æŸ¥æ¨¡å¼ã€‚å³å°†å®é™…çš„å¤§è´Ÿè½½å†…å®¹ï¼ˆå¦‚æ•´ä¸ªæ–‡æ¡£ï¼‰å­˜å‚¨åœ¨å¤–éƒ¨å¯¹è±¡å­˜å‚¨ï¼ˆå¦‚S3ï¼‰ä¸­ï¼Œè€Œåœ¨ Kafka æ¶ˆæ¯ä¸­åªä¼ é€’è¯¥å¯¹è±¡çš„å¼•ç”¨ï¼ˆURI æˆ–keyï¼‰ã€‚æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œå†æ ¹æ®å¼•ç”¨å» S3 ä¸‹è½½å®Œæ•´å†…å®¹ã€‚</li></ul><p><strong>æ¶ˆè´¹è€…ç»„æ‰©å±•</strong></p><ul><li><strong>æ— çŠ¶æ€ä»»åŠ¡</strong>ï¼šå¯¹äºåƒ"åµŒå…¥å™¨"è¿™æ ·æ— çŠ¶æ€çš„ä»»åŠ¡ï¼Œå¯ä»¥é€šè¿‡å¢åŠ æ¶ˆè´¹è€…ç»„ä¸­çš„æ¶ˆè´¹è€…å®ä¾‹æ•°é‡æ¥è½»æ¾å®ç°æ°´å¹³æ‰©å±•ï¼Œä»è€Œæé«˜å¤„ç†ååé‡ã€‚</li><li><strong>æœ‰çŠ¶æ€ä»»åŠ¡</strong>ï¼šå¯¹äºéœ€è¦ç»´æŠ¤é¡ºåºçš„æœ‰çŠ¶æ€ä»»åŠ¡ï¼ˆå¦‚å¤„ç†ç‰¹å®šç”¨æˆ·çš„å¯¹è¯æµï¼‰ï¼Œæ‰©å±•æ€§å–å†³äºåˆ†åŒºçš„æ•°é‡ã€‚å¢åŠ åˆ†åŒºæ•°å¯ä»¥æé«˜å¹¶è¡Œåº¦ï¼Œä½†éœ€è¦é¢„å…ˆè§„åˆ’ã€‚</li></ul><h3 id="ä»æœåŠ¡è§£è€¦åˆ°æ™ºèƒ½ä½“ç¼–æ’">3.3 ä»æœåŠ¡è§£è€¦åˆ°æ™ºèƒ½ä½“ç¼–æ’</h3><p>Kafka åœ¨ AIç³»ç»Ÿä¸­çš„åº”ç”¨ï¼Œä»£è¡¨äº†ä¸€æ¬¡æ·±åˆ»çš„æ¶æ„èŒƒå¼æ¼”è¿›ã€‚åœ¨ä¼ ç»Ÿçš„å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒKafkaä¸»è¦ç”¨äºæœåŠ¡è§£è€¦ï¼Œä»¥æå‡ç³»ç»Ÿçš„éŸ§æ€§å’Œå¯æ‰©å±•æ€§ã€‚è€Œåœ¨å¤šæ™ºèƒ½ä½“ï¼ˆMulti-Agentï¼‰AIç³»ç»Ÿä¸­ï¼ŒKafkaçš„è§’è‰²å‡åä¸ºæ™ºèƒ½ä½“ä¹‹é—´çš„å‘ç°ã€åä½œä¸é€šä¿¡æ€»çº¿ï¼Œä»è€Œå‚¬ç”Ÿå‡ºé¢„å…ˆæœªæ˜ç¡®è®¾è®¡çš„å¤æ‚ã€æ¶Œç°å¼å·¥ä½œæµã€‚</p><p><strong>åŸºäº Kafka çš„æ™ºèƒ½ä½“æ¶æ„</strong></p><p>ä¸€ä¸ªå¤æ‚çš„ä»»åŠ¡ï¼Œå¦‚â€œåˆ†ææŸå…¬å¸çš„æœ€æ–°å­£åº¦è´¢æŠ¥â€ï¼Œå¯ä»¥è¢«åˆ†è§£å¹¶ç”±å¤šä¸ªä¸“èŒæ™ºèƒ½ä½“é€šè¿‡Kafka åä½œå®Œæˆ ï¼š</p><ol type="1"><li>ä¸€ä¸ª<strong>ç¼–æ’è€…æ™ºèƒ½ä½“ (Orchestrator Agent)</strong>æ¥æ”¶åˆ°é«˜å±‚ç›®æ ‡åï¼Œå°†å…¶åˆ†è§£ï¼Œå¹¶å‘ <code>tasks</code>ä¸»é¢˜å‘å¸ƒä¸€ä¸ªåˆå§‹ä»»åŠ¡ï¼Œä¾‹å¦‚<code>&#123;"task_type": "fetch_financial_report", "company": "XYZ"&#125;</code>ã€‚</li><li>ä¸€ä¸ªä¸“é—¨çš„<strong>æœç´¢æ™ºèƒ½ä½“ (Search Agent)</strong> è®¢é˜…äº†<code>fetch_financial_report</code>ç±»å‹çš„ä»»åŠ¡ã€‚å®ƒç›‘å¬åˆ°è¯¥ä»»åŠ¡åï¼Œæ‰§è¡Œç½‘ç»œæœç´¢æˆ– APIè°ƒç”¨ï¼Œæ‰¾åˆ°è´¢æŠ¥ï¼Œç„¶åå°†è´¢æŠ¥çš„åŸå§‹å†…å®¹å‘å¸ƒåˆ° <code>data-to-analyze</code>ä¸»é¢˜ã€‚</li><li>ä¸€ä¸ª<strong>åˆ†ææ™ºèƒ½ä½“ (Analysis Agent)</strong> è®¢é˜…äº†<code>data-to-analyze</code>ä¸»é¢˜ã€‚å®ƒè¯»å–è´¢æŠ¥å†…å®¹ï¼Œè¿›è¡Œå…³é”®æŒ‡æ ‡æå–å’Œåˆ†æï¼Œç„¶åå°†ç»“æ„åŒ–çš„åˆ†æç»“æœå‘å¸ƒåˆ°<code>analysis-results</code> ä¸»é¢˜ã€‚</li><li>ä¸€ä¸ª<strong>æ€»ç»“æ™ºèƒ½ä½“ (Summarization Agent)</strong> è®¢é˜…äº†<code>analysis-results</code>ä¸»é¢˜ï¼Œè¯»å–åˆ†æç»“æœå¹¶ç”Ÿæˆä¸€ä»½äººç±»å¯è¯»çš„æ‘˜è¦æŠ¥å‘Šï¼Œå‘å¸ƒåˆ°<code>final-reports</code> ä¸»é¢˜ã€‚</li><li>æœ€åï¼Œç¼–æ’è€…æ™ºèƒ½ä½“ä» <code>final-reports</code>ä¸»é¢˜è·å–æœ€ç»ˆæŠ¥å‘Šï¼Œå¹¶å°†å…¶å‘ˆç°ç»™ç”¨æˆ·ã€‚</li></ol><p>è¿™ç§æ¶æ„æ˜¯å»ä¸­å¿ƒåŒ–ä¸”é«˜åº¦å¯æ‰©å±•çš„ã€‚æœªæ¥å¦‚æœéœ€è¦å¢åŠ æ–°çš„èƒ½åŠ›ï¼Œä¾‹å¦‚"æƒ…æ„Ÿåˆ†æ"ï¼Œåªéœ€å¼€å‘ä¸€ä¸ªæ–°çš„<strong>æƒ…æ„Ÿåˆ†ææ™ºèƒ½ä½“</strong>ï¼Œè®©å®ƒè®¢é˜…<code>data-to-analyze</code> ä¸»é¢˜ï¼Œå¹¶å°†ç»“æœå‘å¸ƒåˆ°ä¸€ä¸ªæ–°çš„<code>sentiment-results</code> ä¸»é¢˜å³å¯ï¼Œè€Œæ— éœ€ä¿®æ”¹ä»»ä½•ç°æœ‰æ™ºèƒ½ä½“çš„ä»£ç ã€‚</p><p><strong>Kafka ä½œä¸ºæ¶Œç°å¼æ™ºèƒ½çš„åŸºç¡€</strong></p><p>ä¼ ç»Ÿäº‹ä»¶é©±åŠ¨æ¶æ„ï¼ˆEDAï¼‰ä¸­çš„äº‹ä»¶é€šå¸¸æ˜¯äº‹å®çš„å®£å‘Šï¼Œä¾‹å¦‚<code>OrderCreated</code>ã€‚å·¥ä½œæµæ˜¯ç›¸å¯¹å›ºå®šçš„ï¼ŒæœåŠ¡çš„å“åº”æ˜¯è¢«åŠ¨å’Œé¢„å®šä¹‰çš„ã€‚</p><p>ç›¸æ¯”ä¹‹ä¸‹ï¼Œå¤šæ™ºèƒ½ä½“ç³»ç»Ÿä¸­çš„é€šä¿¡æ›´å…·åŠ¨æ€æ€§å’Œç›®çš„æ€§ã€‚ä¸€ä¸ªæ™ºèƒ½ä½“å‘å¸ƒçš„æ¶ˆæ¯å¯èƒ½ä¸æ˜¯ä¸€ä¸ªäº‹å®ï¼Œè€Œæ˜¯ä¸€ä¸ªå­ç›®æ ‡ã€ä¸€ä¸ªè¯æ®ç‰‡æ®µæˆ–ä¸€ä¸ªæ±‚åŠ©è¯·æ±‚ã€‚Kafkaåœ¨æ­¤æ‰®æ¼”äº†ç»å…¸ AI ä¸­çš„é»‘æ¿ç³»ç»Ÿï¼ˆBlackboardSystemï¼‰è§’è‰²ï¼šä¸€ä¸ªå…±äº«çš„åä½œç©ºé—´ã€‚ä¸€ä¸ªæ™ºèƒ½ä½“çš„è¾“å‡ºå¯ä»¥æˆä¸ºå¦ä¸€ä¸ªæ™ºèƒ½ä½“è‡ªå‘è¡ŒåŠ¨çš„è¾“å…¥ï¼Œè€Œæ— éœ€ä¸€ä¸ªä¸­å¿ƒåŒ–çš„ç¼–æ’å™¨å¯¹å®ƒä»¬è¿›è¡Œæ˜¾å¼çš„ç¡¬ç¼–ç è¿æ¥ã€‚</p><p>è¿™æ„å‘³ç€ç³»ç»Ÿçš„æ•´ä½“æ™ºèƒ½è¶…è¶Šäº†å…¶å„ä¸ªç»„æˆéƒ¨åˆ†æ™ºèƒ½çš„æ€»å’Œã€‚åç«¯æ¶æ„å¸ˆçš„è§’è‰²ä¹Ÿéšä¹‹æ¼”å˜ï¼š<u>ä¸å†ä»…ä»…æ˜¯è®¾è®¡æ•°æ®ç®¡é“çš„ç®¡é“å·¥ï¼Œè€Œæ˜¯è®¾è®¡ä¸€ä¸ªèƒ½è®©æ™ºèƒ½ä½“é«˜æ•ˆäº’åŠ¨çš„æ•°å­—ç”Ÿæ€ç³»ç»Ÿçš„è®¾è®¡å¸ˆ</u>ã€‚è¿™ç§æ¶æ„èŒƒå¼çš„è½¬å˜ï¼Œå°†æ˜¯æœªæ¥æ„å»ºæ›´é«˜çº§ã€æ›´è‡ªä¸»AI ç³»ç»Ÿçš„å…³é”®ã€‚</p><h2 id="å››é«˜æ€§èƒ½å®ç°go-ä¸-rust">å››ã€é«˜æ€§èƒ½å®ç°ï¼šGo ä¸ Rust</h2><p>å°†æ¶æ„ç†å¿µè½¬åŒ–ä¸ºç°å®ï¼Œéœ€è¦é€‰æ‹©åˆé€‚çš„ç¼–ç¨‹è¯­è¨€ã€‚æœ¬éƒ¨åˆ†å°†æ¢è®¨ä¸ºä»€ä¹ˆ Goå’Œ Rust è¿™ä¸¤ç§ç°ä»£è¯­è¨€åœ¨ AIåç«¯å †æ ˆçš„ä¸åŒå±‚æ¬¡ä¸Šè¡¨ç°å‡ºè‰²ï¼Œå¹¶å¦‚ä½•ååŒå·¥ä½œä»¥æ„å»ºé«˜æ€§èƒ½ç³»ç»Ÿã€‚</p><h3 id="goå¹¶å‘-ai-ç¼–æ’è¯­è¨€">4.1 Goï¼šå¹¶å‘ AI ç¼–æ’è¯­è¨€</h3><p>Go è¯­è¨€çš„å¹¶å‘æ¨¡å‹ï¼Œç‰¹åˆ«æ˜¯å…¶è½»é‡çº§çº¿ç¨‹ Goroutine å’Œç”¨äºé€šä¿¡çš„Channelï¼Œä¸ AI åç«¯çš„æ ¸å¿ƒå·¥ä½œè´Ÿè½½â€”â€”ç¼–æ’å¤§é‡å¹¶å‘çš„ã€I/O å¯†é›†çš„å¯¹ LLM APIå’Œå…¶ä»–å¤–éƒ¨æœåŠ¡çš„è°ƒç”¨â€”â€”å‡ ä¹å®Œç¾å¥‘åˆ ã€‚</p><p>Go ä¸­çš„ç”Ÿäº§çº§å¹¶å‘æ¨¡å¼ï¼š</p><ul><li><p><strong>æ‰‡å‡º/æ‰‡å…¥æ¨¡å¼ (Fan-out/Fan-in) ç”¨äºå¹¶è¡Œ RAGæ£€ç´¢</strong>ï¼šåœ¨ RAGçš„æ£€ç´¢é˜¶æ®µï¼Œä¸ºäº†è·å–æœ€å…¨é¢çš„ä¸Šä¸‹æ–‡ï¼Œé€šå¸¸éœ€è¦åŒæ—¶ä»å¤šä¸ªæ•°æ®æºï¼ˆå¦‚å‘é‡æ•°æ®åº“ã€å…³ç³»å‹æ•°æ®åº“ã€å…¨æ–‡æœç´¢å¼•æ“ã€WebAPIï¼‰è¿›è¡ŒæŸ¥è¯¢ã€‚ä½¿ç”¨ Go çš„ <code>sync.WaitGroup</code> å’ŒChannelï¼Œå¯ä»¥è½»æ¾å®ç°å¹¶è¡Œæ£€ç´¢ï¼Œä»è€Œå°†æ€»å»¶è¿Ÿé™ä½åˆ°æœ€æ…¢çš„é‚£ä¸ªæ•°æ®æºçš„å»¶è¿Ÿæ°´å¹³ã€‚</p><p>ä¸€ä¸ªå…·ä½“çš„å®ç°æ¨¡å¼æ˜¯ï¼šä¸ºæ¯ä¸ªæ•°æ®æºå¯åŠ¨ä¸€ä¸ª Goroutine è¿›è¡ŒæŸ¥è¯¢ã€‚æ‰€æœ‰Goroutine å°†å…¶ç»“æœå‘é€åˆ°åŒä¸€ä¸ª Channelã€‚ä¸» Goroutineç­‰å¾…æ‰€æœ‰æŸ¥è¯¢å®Œæˆåï¼ˆé€šè¿‡ <code>WaitGroup</code>ï¼‰ï¼Œå†ä» Channelä¸­æ”¶é›†å¹¶åˆå¹¶æ‰€æœ‰ç»“æœã€‚</p></li><li><p><strong>å·¥ä½œè€…æ±  (Worker Pools) ç”¨äº API é€Ÿç‡é™åˆ¶</strong>ï¼šLLMAPI é€šå¸¸æœ‰æ¯åˆ†é’Ÿè¯·æ±‚æ•°ï¼ˆRPMï¼‰å’Œæ¯åˆ†é’Ÿ Tokenæ•°ï¼ˆTPMï¼‰çš„é™åˆ¶ã€‚ä¸ºäº†é¿å…å› è¶…å‡ºé™åˆ¶è€Œè¢«æ‹’ç»æœåŠ¡ï¼ˆHTTP 429é”™è¯¯ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ Go å®ç°ä¸€ä¸ªå·¥ä½œè€…æ± ã€‚è¯¥æ± ç»´æŠ¤å›ºå®šæ•°é‡çš„Goroutineï¼Œä»ä¸€ä¸ªä»»åŠ¡ Channel ä¸­è·å–è¯·æ±‚å¹¶æ‰§è¡Œã€‚è¿™å¯ä»¥æœ‰æ•ˆåœ°æ§åˆ¶å¯¹å¤–éƒ¨API çš„å¹¶å‘è°ƒç”¨æ•°é‡ï¼Œå¹³æ»‘è¯·æ±‚å³°å€¼ï¼Œå¹¶å®ç°ä¼˜é›…çš„èƒŒå‹ï¼ˆbackpressureï¼‰ã€‚</p></li><li><p><strong>ä½¿ç”¨ Channelå®ç°æµå¼å“åº”</strong>ï¼šä¸ºäº†æä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒï¼ŒLLMçš„å“åº”é€šå¸¸ä»¥æµå¼ï¼ˆtoken-by-tokenï¼‰æ–¹å¼è¿”å›ã€‚Go çš„ Channelæ˜¯å®ç°è¿™ä¸€åŠŸèƒ½çš„ç†æƒ³å·¥å…·ã€‚åç«¯æœåŠ¡åœ¨æ¥æ”¶åˆ° LLM API è¿”å›çš„ tokenæµæ—¶ï¼Œå¯ä»¥ç«‹å³å°†å…¶å†™å…¥ä¸€ä¸ª Channelã€‚å¦ä¸€ä¸ª Goroutine åˆ™ä»è¯¥ Channel è¯»å–tokenï¼Œå¹¶é€šè¿‡æœåŠ¡å™¨æ¨é€äº‹ä»¶ï¼ˆSSEï¼‰æˆ– WebSocketå°†å…¶è½¬å‘ç»™å‰ç«¯å®¢æˆ·ç«¯ã€‚</p></li></ul><h3 id="rusté«˜æ€§èƒ½æ¨ç†è¯­è¨€">4.2 Rustï¼šé«˜æ€§èƒ½æ¨ç†è¯­è¨€</h3><p>å¦‚æœè¯´ Go æ˜¯ AI ç¼–æ’å±‚çš„ç‹è€…ï¼Œé‚£ä¹ˆ Rust åˆ™åœ¨ AIæŠ€æœ¯æ ˆæ€§èƒ½æœ€å…³é”®çš„æ ¸å¿ƒâ€”â€”æ¨ç†å¼•æ“â€”â€”ä¸­å¤§æ”¾å¼‚å½©ã€‚Rustå¯¹å†…å­˜å®‰å…¨çš„æè‡´è¿½æ±‚ã€é›¶æˆæœ¬æŠ½è±¡ä»¥åŠå¯¹åº•å±‚ç¡¬ä»¶çš„ç²¾ç»†æ§åˆ¶ï¼Œä½¿å…¶æˆä¸ºä» GPUç¡¬ä»¶ä¸­å‹æ¦¨å‡ºæ¯ä¸€åˆ†æ€§èƒ½çš„ç†æƒ³é€‰æ‹© ã€‚</p><p>Rust åœ¨ AI æŠ€æœ¯æ ˆä¸­çš„è§’è‰²ï¼š</p><ul><li><strong>æ¨ç†å¼•æ“</strong>ï¼šå°½ç®¡è®¸å¤šæµè¡Œçš„æ¨ç†æ¡†æ¶ï¼ˆå¦‚ vLLMï¼‰ä½¿ç”¨Pythonæ„å»ºï¼Œä½†åœ¨è¿½æ±‚æè‡´æ•ˆç‡å’Œä½èµ„æºæ¶ˆè€—çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¶Šæ¥è¶Šå¤šçš„å…¬å¸å¼€å§‹è½¬å‘Rustã€‚ä¾‹å¦‚ï¼ŒCloudflare ä½¿ç”¨ Rust å¼€å‘å…¶ä¸‹ä¸€ä»£ LLM æ¨ç†å¼•æ“Infireï¼Œä»¥æœŸåœ¨ä½çº§åˆ«å®ç°ç»†èŠ‚ä¸Šè·å¾—å®Œå…¨æ§åˆ¶ï¼Œä»è€Œæœ€å¤§åŒ–å†…å­˜ã€ç½‘ç»œ I/O å’ŒGPU çš„åˆ©ç”¨ç‡ï¼Œè¶…è¶Š Python æ–¹æ¡ˆçš„æ€§èƒ½æé™ ã€‚</li><li><strong>æ€§èƒ½å…³é”®çš„æ•°æ®ç®¡é“ç»„ä»¶</strong>ï¼šåœ¨æ•°æ®å¤„ç†æµæ°´çº¿ä¸­ï¼ŒæŸäº›ç¯èŠ‚ï¼ˆå¦‚è‡ªå®šä¹‰çš„åˆ†è¯å™¨ã€é«˜æ•ˆçš„æ•°æ®åºåˆ—åŒ–/ååºåˆ—åŒ–å±‚ï¼‰å¯¹æ€§èƒ½è¦æ±‚æé«˜ã€‚Rustæ˜¯æ„å»ºè¿™äº›ç»„ä»¶çš„ç»ä½³é€‰æ‹©ï¼Œå…¶æ€§èƒ½å¯ä»¥åª²ç¾C/C++ï¼ŒåŒæ—¶æä¾›äº†ç°ä»£è¯­è¨€çš„å†…å­˜å®‰å…¨ä¿éšœã€‚</li></ul><h3 id="gorust-ååŒå·¥ä½œçš„å¤šè¯­è¨€æ¶æ„">4.3 Go/RustååŒå·¥ä½œçš„å¤šè¯­è¨€æ¶æ„</h3><p>å¯¹äºå¤æ‚çš„ AIç³»ç»Ÿï¼Œæ¨èé‡‡ç”¨å¤šè¯­è¨€ï¼ˆPolyglotï¼‰æ¶æ„ï¼Œä»¥å‘æŒ¥ä¸åŒè¯­è¨€çš„ä¼˜åŠ¿ï¼š</p><ul><li><strong>Go ä½œä¸ºç¼–æ’å±‚</strong>ï¼šè´Ÿè´£å¤„ç† APIç½‘å…³ã€ä¸šåŠ¡é€»è¾‘ã€æœåŠ¡é—´é€šä¿¡ã€å·¥ä½œæµç¼–æ’ç­‰ä¸Šå±‚ä»»åŠ¡ã€‚å…¶å¼ºå¤§çš„å¹¶å‘èƒ½åŠ›å’Œç®€æ´çš„è¯­æ³•éå¸¸é€‚åˆå¿«é€Ÿå¼€å‘å’Œç»´æŠ¤å¤æ‚çš„åˆ†å¸ƒå¼æœåŠ¡ã€‚</li><li><strong>Rustä½œä¸ºæ€§èƒ½æ ¸å¿ƒ</strong>ï¼šè´Ÿè´£å®ç°æ€§èƒ½æœ€æ•æ„Ÿçš„"çƒ­è·¯å¾„"ç»„ä»¶ï¼Œå¦‚æ¨ç†æœåŠ¡ã€åµŒå…¥æ¨¡å‹æœåŠ¡æˆ–é«˜æ€§èƒ½æ•°æ®é¢„å¤„ç†åº“ã€‚è¿™äº›Rust ç»„ä»¶å¯ä»¥ä½œä¸ºç‹¬ç«‹çš„æœåŠ¡éƒ¨ç½²ï¼Œæˆ–é€šè¿‡å¤–éƒ¨å‡½æ•°æ¥å£ï¼ˆFFIï¼‰è¢« GoæœåŠ¡è°ƒç”¨ã€‚</li></ul><p>è¿™ç§æ¶æ„ç»„åˆäº† Go çš„å¼€å‘æ•ˆç‡å’Œ Rust çš„è¿è¡Œæ•ˆç‡ï¼Œæ˜¯æ„å»ºç”Ÿäº§çº§ã€é«˜æ€§èƒ½AI ç³»ç»Ÿçš„ç†æƒ³èŒƒå¼</p><h2 id="äº”é«˜çº§æ¶æ„èŒƒå¼ä¸ç»¼åˆ">äº”ã€é«˜çº§æ¶æ„èŒƒå¼ä¸ç»¼åˆ</h2><p>æœ¬éƒ¨åˆ†å°†ç»¼åˆå‰è¿°å†…å®¹ï¼Œæ¢è®¨å¦‚ä½•åº”å¯¹ AIç³»ç»Ÿä¸­æœ€æ£˜æ‰‹çš„æŒ‘æˆ˜ï¼Œå¹¶å±•æœ›æœªæ¥çš„æ¶æ„å‘å±•è¶‹åŠ¿ã€‚</p><h3 id="é©¯æœä¸ç¡®å®šæ€§ç”Ÿäº§å°±ç»ªå·¥ä½œæµçš„å·¥å…·ç®±">5.1é©¯æœä¸ç¡®å®šæ€§ï¼šç”Ÿäº§å°±ç»ªå·¥ä½œæµçš„å·¥å…·ç®±</h3><p>LLMçš„å†…åœ¨ä¸ç¡®å®šæ€§ï¼ˆNon-determinismï¼‰æ˜¯å…¶åœ¨é‡‘èã€åŒ»ç–—ç­‰ä»»åŠ¡å…³é”®å‹ä¼ä¸šç³»ç»Ÿä¸­åº”ç”¨çš„æœ€å¤§éšœç¢ã€‚å³ä½¿è®¾ç½®<code>temperature=0</code>ï¼Œç›¸åŒçš„è¾“å…¥åœ¨ä¸åŒæ—¶é—´ä¹Ÿå¯èƒ½äº§ç”Ÿä¸å®Œå…¨ç›¸åŒçš„è¾“å‡ºï¼Œè¿™ç»™ç³»ç»Ÿçš„å¯é æ€§å’Œå¯æµ‹è¯•æ€§å¸¦æ¥äº†å·¨å¤§æŒ‘æˆ˜ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªæ—¨åœ¨ä¸ºæ¦‚ç‡æ€§æ¨¡å‹æ„å»ºç¡®å®šæ€§â€œæŠ¤æ â€çš„ç»¼åˆå·¥å…·ç®±ã€‚</p><p>æå‡å¯é æ€§çš„ç­–ç•¥ï¼š</p><ol type="1"><li><strong>å¼ºåˆ¶ç»“æ„åŒ–è¾“å‡º (Structured Outputs)</strong>ï¼šåˆ©ç”¨ LLMæä¾›å•†çš„ç‰¹å®šåŠŸèƒ½ï¼ˆå¦‚ OpenAI çš„ JSON æ¨¡å¼ã€Anthropicçš„å·¥å…·è°ƒç”¨åŠŸèƒ½ï¼‰ï¼Œå¼ºåˆ¶æ¨¡å‹è¿”å›ç¬¦åˆé¢„å®šä¹‰ JSON schemaçš„è¾“å‡ºã€‚è¿™ä»æ ¹æœ¬ä¸Šæ¶ˆé™¤äº†å› æ ¼å¼é”™è¯¯å¯¼è‡´çš„è§£æå¤±è´¥ï¼Œæ˜¯ä¿è¯ç³»ç»Ÿå¥å£®æ€§çš„ç¬¬ä¸€æ­¥ã€‚</li><li><strong>ä¸¥æ ¼çš„éªŒè¯å±‚ (Validation Layer)</strong>ï¼šåœ¨æ¥æ”¶åˆ° LLMçš„ç»“æ„åŒ–è¾“å‡ºåï¼Œç»ä¸èƒ½ç›´æ¥ä¿¡ä»»å…¶å†…å®¹ã€‚å¿…é¡»å°†å…¶ä¼ é€’ç»™ä¸€ä¸ªä¸¥æ ¼çš„éªŒè¯å±‚ï¼ˆä¾‹å¦‚ï¼Œåœ¨Python ä¸­ä½¿ç”¨ Pydanticï¼Œåœ¨ Goä¸­ä½¿ç”¨ç»“æ„ä½“éªŒè¯åº“ï¼‰è¿›è¡Œæ•°æ®ç±»å‹ã€èŒƒå›´å’Œä¸šåŠ¡é€»è¾‘çš„æ ¡éªŒï¼Œç„¶åå†ä¼ é€’ç»™ä¸‹æ¸¸ç³»ç»Ÿã€‚</li><li><strong>å¸¦åé¦ˆçš„æ™ºèƒ½é‡è¯• (Intelligent Retries withFeedback)</strong>ï¼šå¦‚æœéªŒè¯å¤±è´¥ï¼Œç®€å•çš„é‡è¯•ï¼ˆå³é‡å¤å‘é€ç›¸åŒçš„Promptï¼‰æ•ˆæœä¸ä½³ã€‚æ›´æ™ºèƒ½çš„æ–¹æ³•æ˜¯æ„å»ºä¸€ä¸ªæ–°çš„ Promptï¼Œå…¶ä¸­åŒ…å«åŸå§‹Promptã€æ¨¡å‹è¿”å›çš„é”™è¯¯è¾“å‡ºä»¥åŠå…·ä½“çš„éªŒè¯é”™è¯¯ä¿¡æ¯ï¼Œç„¶åè¯·æ±‚ LLM"è¯·æ ¹æ®ä»¥ä¸‹é”™è¯¯ä¿®æ­£ä½ çš„è¾“å‡º"ã€‚è¿™ç§"è‡ªæˆ‘ä¿®æ­£"çš„å¾ªç¯èƒ½æ˜¾è‘—æé«˜æœ€ç»ˆæˆåŠŸçš„æ¦‚ç‡ã€‚</li><li><strong>ç¡®å®šæ€§è§£ç  (DeterministicDecoding)</strong>ï¼šåœ¨è¦æ±‚é«˜åº¦ä¸€è‡´æ€§çš„åœºæ™¯ä¸‹ï¼Œå¯ä»¥é€šè¿‡è§£ç ç­–ç•¥æ¥é™ä½éšæœºæ€§ã€‚<ul><li><strong>è´ªå¿ƒè§£ç  (Greedy Decoding)</strong>ï¼šå°†æ¨¡å‹çš„<code>temperature</code> å‚æ•°è®¾ç½®ä¸º 0ï¼Œä½¿æ¨¡å‹åœ¨æ¯ä¸€æ­¥éƒ½é€‰æ‹©æ¦‚ç‡æœ€é«˜çš„Tokenã€‚</li><li><strong>å›ºå®šéšæœºç§å­ (Fixing theSeed)</strong>ï¼šåœ¨æ”¯æŒè®¾ç½®éšæœºç§å­çš„æ¨¡å‹æˆ–æ¡†æ¶ä¸­ï¼Œå›ºå®šè¯¥å€¼ã€‚</li><li>è™½ç„¶è¿™äº›æ–¹æ³•ä¸èƒ½ 100%ä¿è¯ç¡®å®šæ€§ï¼ˆå› ä¸ºåº•å±‚ç¡¬ä»¶å’Œè½¯ä»¶ä¼˜åŒ–ä¹Ÿå¯èƒ½å¼•å…¥éšæœºæ€§ï¼‰ï¼Œä½†å®ƒä»¬èƒ½æå¤§åœ°å‡å°‘è¾“å‡ºçš„å¯å˜æ€§ã€‚</li></ul></li><li><strong>é›†æˆæ–¹æ³• (EnsembleMethods)</strong>ï¼šå‘å¤šä¸ªä¸åŒçš„æ¨¡å‹ï¼ˆæˆ–åŒä¸€ä¸ªæ¨¡å‹å¤šæ¬¡ï¼‰æäº¤ç›¸åŒçš„è¯·æ±‚ï¼Œç„¶åå¯¹è¿”å›çš„å¤šä¸ªç»“æœè¿›è¡ŒæŠ•ç¥¨æˆ–åˆå¹¶å¤„ç†ã€‚ä¾‹å¦‚ï¼Œå¯¹äºåˆ†ç±»ä»»åŠ¡ï¼Œé‡‡ç”¨å°‘æ•°æœä»å¤šæ•°çš„åŸåˆ™ï¼›å¯¹äºå†…å®¹ç”Ÿæˆä»»åŠ¡ï¼Œå¯ä»¥é€‰æ‹©æœ€ä¸€è‡´æˆ–æœ€å…¨é¢çš„ç­”æ¡ˆã€‚è¿™ç§æ–¹æ³•ä»¥å¢åŠ æˆæœ¬å’Œå»¶è¿Ÿä¸ºä»£ä»·ï¼Œæ¢å–äº†æ›´é«˜çš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚</li></ol><h3 id="æ™ºèƒ½ä½“æ¶æ„çš„å…´èµ·">5.2 æ™ºèƒ½ä½“æ¶æ„çš„å…´èµ·</h3><p>è®¸å¤š AI åº”ç”¨çš„æœªæ¥æ­£ä»ç®€å•çš„æç¤º-å“åº”æˆ– RAGæ¨¡å¼ï¼Œè½¬å‘æ›´è‡ªä¸»çš„æ™ºèƒ½ä½“ï¼ˆAgentï¼‰æ¨¡å¼ã€‚æ™ºèƒ½ä½“èƒ½å¤Ÿè¿›è¡Œæ¨ç†ã€è§„åˆ’ï¼Œå¹¶ä½¿ç”¨å·¥å…·æ¥å®Œæˆå¤æ‚çš„å¤šæ­¥éª¤ç›®æ ‡ã€‚</p><p>å…³é”®çš„æ™ºèƒ½ä½“è®¾è®¡æ¨¡å¼ï¼š</p><ul><li><strong>å·¥å…·ä½¿ç”¨ (ToolUse)</strong>ï¼šè¿™æ˜¯æ™ºèƒ½ä½“æ¶æ„çš„æ ¸å¿ƒã€‚ç³»ç»Ÿéœ€è¦è®¾è®¡æˆå…è®¸ LLMæ ¹æ®ç”¨æˆ·æ„å›¾ï¼Œè‡ªä¸»å†³å®šè°ƒç”¨å“ªäº›å¤–éƒ¨å·¥å…·ï¼ˆå¦‚APIã€æ•°æ®åº“æŸ¥è¯¢ã€ä»£ç æ‰§è¡Œå™¨ï¼‰æ¥è·å–ä¿¡æ¯æˆ–æ‰§è¡Œæ“ä½œã€‚æ¶æ„å¸ˆçš„æ ¸å¿ƒä»»åŠ¡æ˜¯ä¸ºè¿™äº›å·¥å…·çš„è°ƒç”¨è®¾è®¡ä¸€ä¸ªå®‰å…¨ã€å¯é ä¸”å¯è§‚æµ‹çš„æ‰§è¡Œç¯å¢ƒã€‚</li><li><strong>åæ€/è‡ªæˆ‘æ‰¹åˆ¤ (Reflection /Self-Critique)</strong>ï¼šè¿™æ˜¯ä¸€ç§å¼ºå¤§çš„æ¨¡å¼ï¼Œæ™ºèƒ½ä½“èƒ½å¤Ÿè¯„ä¼°å¹¶è¿­ä»£æ”¹è¿›è‡ªå·±çš„è¾“å‡ºã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªæ™ºèƒ½ä½“é¦–å…ˆç”ŸæˆæŠ¥å‘Šçš„åˆç¨¿ï¼›ç„¶åï¼Œç³»ç»Ÿå¯åŠ¨ä¸€ä¸ªæ‰¹è¯„å®¶æ™ºèƒ½ä½“ï¼ˆæˆ–ä½¿ç”¨ä¸åŒPromptçš„åŒä¸€ä¸ªæ™ºèƒ½ä½“ï¼‰æ¥å®¡æŸ¥åˆç¨¿ï¼ŒæŒ‡å‡ºå…¶ä¸­çš„é€»è¾‘è°¬è¯¯ã€äº‹å®é”™è¯¯æˆ–é£æ ¼é—®é¢˜ï¼›æœ€åï¼Œåˆä»£æ™ºèƒ½ä½“æ ¹æ®æ‰¹è¯„æ„è§ç”Ÿæˆä¸€ä»½ç»è¿‡ä¿®è®¢çš„ç»ˆç¨¿ã€‚è¿™ä¸ªè¿‡ç¨‹æ¨¡æ‹Ÿäº†äººç±»çš„å†™ä½œå’Œå®¡æŸ¥æµç¨‹ï¼Œèƒ½å¤Ÿæ˜¾è‘—æå‡è¾“å‡ºè´¨é‡ã€‚</li><li><strong>è§„åˆ’(Planning)</strong>ï¼šå¯¹äºå¤æ‚ä»»åŠ¡ï¼ˆä¾‹å¦‚ï¼Œä¸ºæˆ‘çš„å›¢é˜Ÿç»„ç»‡ä¸€æ¬¡å¼‚åœ°å›¢å»ºï¼‰ï¼Œæ™ºèƒ½ä½“éœ€è¦å…·å¤‡å°†å…¶åˆ†è§£ä¸ºä¸€ç³»åˆ—å¯æ‰§è¡Œå­ä»»åŠ¡çš„èƒ½åŠ›ï¼ˆä¾‹å¦‚ï¼š1.æ”¶é›†å›¢é˜Ÿæˆå‘˜çš„åå¥½ï¼›2. æœç´¢ç¬¦åˆæ¡ä»¶çš„åœºåœ°ï¼›3. æ£€æŸ¥åœºåœ°å¯ç”¨æ€§ï¼›4.é¢„è®¢åœºåœ°å’Œäº¤é€šç­‰ï¼‰ã€‚åƒ LangGraphè¿™æ ·çš„æ–°å…´æ¡†æ¶ï¼Œæ­£è‡´åŠ›äºä¸ºè¿™ç§æœ‰çŠ¶æ€çš„ã€å¾ªç¯çš„æ™ºèƒ½ä½“å·¥ä½œæµæä¾›ç»“æ„åŒ–çš„ç¼–ç¨‹æ¨¡å‹ã€‚</li></ul><h2 id="æ€»ç»“ç°ä»£-ai-å·¥ç¨‹å¸ˆçš„èåˆæŠ€èƒ½æ ˆ">æ€»ç»“ï¼šç°ä»£ AIå·¥ç¨‹å¸ˆçš„èåˆæŠ€èƒ½æ ˆ</h2><p>"æœ¯"ç¯‡ç³»ç»Ÿæ€§åœ°å‰–æäº†åœ¨ AIæ—¶ä»£ï¼Œåç«¯æ¶æ„å¸ˆæ‰€é¢ä¸´çš„æ ¸å¿ƒæŒ‘æˆ˜ä¸èŒƒå¼è½¬å˜ã€‚ä»æ ¹æœ¬ä¸Šè¯´ï¼Œæ„å»º AIåŸç”Ÿåº”ç”¨ä¸æ˜¯å¯¹ä¼ ç»Ÿåˆ†å¸ƒå¼ç³»ç»ŸçŸ¥è¯†çš„é¢ è¦†ï¼Œè€Œæ˜¯ä¸€æ¬¡æ·±åˆ»çš„æ¼”è¿›å’Œèåˆã€‚</p><p>ç°ä»£é«˜çº§åç«¯å·¥ç¨‹å¸ˆå¿…é¡»æˆä¸ºä¸€ä¸ªå¤šé¢æ‰‹ï¼Œå…¶æŠ€èƒ½æ ˆéœ€è¦èåˆä¸‰å¤§é¢†åŸŸçš„æ·±åº¦ä¸“ä¸šçŸ¥è¯†ï¼š</p><ol type="1"><li><strong>åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡</strong>ï¼šDDIAä¸­å…³äºå¯é æ€§ã€å¯æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§çš„åŸåˆ™ä¾ç„¶æ˜¯åŸºçŸ³ã€‚ä½†ç°åœ¨å¿…é¡»ç”¨æ–°çš„è§†è§’å»åº”ç”¨å®ƒä»¬ï¼Œä»¥åº”å¯¹é«˜å»¶è¿Ÿã€æœ‰çŠ¶æ€å’Œæ¦‚ç‡æ€§å¤±è´¥ç­‰æ–°æŒ‘æˆ˜ã€‚</li><li><strong>æ•°æ®å·¥ç¨‹</strong>ï¼šç²¾é€š Kafkaè¿™æ ·çš„æ•°æ®æµå¹³å°ï¼Œä»¥åŠæŒæ¡ä»æ•°æ®æ‘„å…¥ã€æ¸…æ´—ã€åˆ‡å—åˆ°ç´¢å¼•çš„å…¨å¥— RAGæµæ°´çº¿æ„å»ºèƒ½åŠ›ï¼Œå·²æˆä¸ºæ ¸å¿ƒç«äº‰åŠ›ã€‚æ•°æ®è´¨é‡ç›´æ¥å†³å®šäº† AIç³»ç»Ÿçš„æ™ºèƒ½ä¸Šé™ã€‚</li><li><strong>æœºå™¨å­¦ä¹ è¿ç»´(MLOps)</strong>ï¼šåç«¯å·¥ç¨‹å¸ˆä¸å†èƒ½å°†æ¨¡å‹è§†ä¸ºé»‘ç›’ã€‚å¿…é¡»æ„å»ºå’Œç»´æŠ¤é¢å‘ LLMçš„å¯è§‚æµ‹æ€§ç³»ç»Ÿï¼Œå»ºç«‹è‡ªåŠ¨åŒ–çš„æ¨¡å‹è¯„ä¼°å’Œåé¦ˆé—­ç¯ï¼Œå¹¶å°†æ¨¡å‹çš„è´¨é‡é—®é¢˜è§†ä¸ºä¸ç³»ç»Ÿå®•æœºåŒç­‰é‡è¦çš„ç”Ÿäº§äº‹æ•…ã€‚</li></ol><p>æœ€ç»ˆï¼Œè¡¡é‡å“è¶Šå·¥ç¨‹èƒ½åŠ›çš„æ–°æ ‡å‡†ï¼Œåœ¨äºæ˜¯å¦èƒ½æ¶æ„å‡ºä¸ä»…å¯æ‰©å±•ã€å¯é ï¼Œè€Œä¸”åœ¨é¢å¯¹æ¦‚ç‡æ€§ä¸ç¡®å®šæ€§æ—¶ä¾ç„¶å…·æœ‰é€‚åº”æ€§å’ŒéŸ§æ€§çš„ç³»ç»Ÿã€‚æŒæ¡è¿™ç§åœ¨ç¡®å®šæ€§å·¥ç¨‹ä¸æ¦‚ç‡æ€§æ™ºèƒ½ä¹‹é—´æ¸¸åˆƒæœ‰ä½™çš„èƒ½åŠ›ï¼Œå°†æ˜¯å®šä¹‰ä¸‹ä¸€ä»£é¡¶å°–æŠ€æœ¯ä¸“å®¶çš„å…³é”®ã€‚</p><h1 id="é“">é“</h1><p>å‰é¢æˆ‘ä»¬æ·±å…¥æ¢è®¨äº†åœ¨ AIæ—¶ä»£å¦‚ä½•åº”ç”¨å„é¡¹åç«¯æŠ€æœ¯çš„"æœ¯"ã€‚ç„¶è€Œï¼Œä»»ä½•ç²¾å¦™çš„"æœ¯"éƒ½æºäºå…¶èƒŒåçš„"é“"â€”â€”é‚£äº›ä¸éšå…·ä½“æŠ€æœ¯æ›´è¿­è€Œæ”¹å˜çš„æ ¹æœ¬æ€§åŸåˆ™ã€‚è‹¥æƒ³åœ¨AI æµªæ½®ä¸­ç«‹äºä¸è´¥ä¹‹åœ°ï¼Œæˆ‘ä»¬å¿…é¡»æŒæ¡è¿™äº›ç¬¬ä¸€æ€§åŸç†ã€‚</p><p>æ‰€ä»¥åœ¨äº†è§£äº†ä¸Šç¯‡ Gemini ç»™å‡ºçš„ç§ç§ AIåº”ç”¨å¼€å‘è§£å†³æ–¹æ¡ˆä¹‹åï¼Œæˆ‘ä»¬å°è¯•è®© Gemini ä¸ºæˆ‘ä»¬æ¢³ç†åœ¨ AIåç«¯æ¶æ„ä¸‹çš„å››å¤§ä¸å˜æ³•åˆ™ï¼Œå®ƒä»¬æ˜¯æ„å»ºæœªæ¥æ™ºèƒ½ç³»ç»Ÿçš„æ€æƒ³åŸºçŸ³ï¼Œå¸®åŠ©æˆ‘ä»¬ç†è§£ä¸‡å˜ä¸­çš„æ ¹æœ¬ã€‚</p><h2 id="æ³•åˆ™ä¸€ä¸–ç•Œè§‚çš„é©å‘½-ä»ç¡®å®šæ€§åˆ°æ¦‚ç‡æ€§">æ³•åˆ™ä¸€ï¼šä¸–ç•Œè§‚çš„é©å‘½ â€”â€”ä»ç¡®å®šæ€§åˆ°æ¦‚ç‡æ€§</h2><p>è½¯ä»¶å·¥ç¨‹ï¼Œåœ¨å…¶è¯ç”Ÿä»¥æ¥çš„å¤§éƒ¨åˆ†æ—¶é—´é‡Œï¼Œéƒ½æ˜¯ä¸€ä¸ªå»ºç«‹åœ¨ç¡®å®šæ€§ï¼ˆDeterminismï¼‰åŸºçŸ³ä¸Šçš„ç†æƒ³å›½ã€‚åœ¨è¿™é‡Œ <code>2+2</code> æ°¸è¿œç­‰äº<code>4</code>ï¼Œä¸€ä¸ªå‡½æ•°å¯¹ç›¸åŒçš„è¾“å…¥ï¼Œæ°¸è¿œè¿”å›ç›¸åŒçš„è¾“å‡ºã€‚æˆ‘ä»¬çš„æ ¸å¿ƒæŒ‘æˆ˜æ˜¯ç®¡ç†å¤æ‚çš„ã€ä½†å¯é¢„æµ‹çš„é€»è¾‘äº¤äº’ã€‚è¿™ä½¿å¾—è½¯ä»¶å·¥ç¨‹é•¿æœŸä»¥æ¥æˆä¸ºå·¥ç¨‹é¢†åŸŸçš„å¼‚ç±»ã€‚ä¸€ä½åœŸæœ¨å·¥ç¨‹å¸ˆè®¾è®¡çš„æ¡¥æ¢å¿…é¡»è€ƒè™‘ææ–™å¼ºåº¦çš„å…¬å·®ã€é£è½½è·çš„éšæœºæ€§ï¼Œå…¶è®¾è®¡ç›®æ ‡æ˜¯"å¤§æ¦‚ç‡ä¸ä¼šåå¡Œ"ï¼›è€Œè½¯ä»¶å·¥ç¨‹å¸ˆåˆ™è¿½æ±‚"ç»å¯¹æ­£ç¡®"ã€‚</p><p>å¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰çš„å‡ºç°ï¼Œå½»åº•é¢ è¦†äº†è¿™ä¸€ç¡®å®šæ€§çš„ä¸–ç•Œè§‚ã€‚å½“ä½ å‘ LLMå‘å‡ºä¸€ä¸ªæç¤ºï¼ˆPromptï¼‰æ—¶ï¼Œä½ å¹¶éåœ¨è°ƒç”¨ä¸€ä¸ªä¼ ç»Ÿçš„å‡½æ•°ï¼Œè€Œæ˜¯åœ¨<strong>ä»ä¸€ä¸ªåºå¤§çš„æ¦‚ç‡åˆ†å¸ƒä¸­è¿›è¡Œé‡‡æ ·</strong>ã€‚è¿™æ„å‘³ç€ï¼Œå³ä½¿æ‰€æœ‰å‚æ•°ï¼ˆå¦‚<code>temperature=0</code>ï¼‰éƒ½è®¾ä¸ºæœ€ç¡®å®šçš„æ¨¡å¼ï¼Œä¸¤æ¬¡å®Œå…¨ç›¸åŒçš„è¾“å…¥ä¹Ÿå¯èƒ½äº§ç”Ÿä¸å®Œå…¨ç›¸åŒçš„è¾“å‡ºï¼Œè¿™ç§ç°è±¡è¢«ç§°ä¸ºéç¡®å®šæ€§ï¼ˆNon-determinismï¼‰ã€‚</p><p>è¿™ä¸€æ ¹æœ¬æ€§çš„è½¬å˜ï¼Œè¦æ±‚æˆ‘ä»¬ä»"é“"çš„å±‚é¢é‡å¡‘å¯¹ç³»ç»Ÿè®¾è®¡çš„è®¤çŸ¥ï¼š</p><ol type="1"><li><strong>"æ­£ç¡®"çš„é‡æ–°å®šä¹‰</strong>ï¼šåœ¨ç¡®å®šæ€§ä¸–ç•Œé‡Œï¼Œæ­£ç¡®æ˜¯äºŒå…ƒçš„ï¼ˆå¯¹æˆ–é”™ï¼‰ã€‚åœ¨æ¦‚ç‡æ€§ä¸–ç•Œé‡Œï¼Œæ­£ç¡®å˜æˆäº†ä¸€ä¸ª<strong>ç»Ÿè®¡å­¦æ¦‚å¿µ</strong>ã€‚ä¸€ä¸ªAIç³»ç»Ÿçš„è¾“å‡ºä¸å†æ˜¯ç»å¯¹æ­£ç¡®ï¼Œè€Œæ˜¯"åœ¨å¤šå¤§ç½®ä¿¡åº¦ä¸Šæ˜¯å¯æ¥å—çš„"ã€‚ç³»ç»Ÿçš„ç›®æ ‡ä»"æœç»é”™è¯¯"è½¬å˜ä¸º"ç®¡ç†å’Œé‡åŒ–é”™è¯¯ç‡"ã€‚</li><li><strong>"æµ‹è¯•"çš„èŒƒå¼è¿ç§»</strong>ï¼šä¼ ç»Ÿçš„å•å…ƒæµ‹è¯•ä¾èµ–äºæ–­è¨€<code>assert function(input) == expected_output</code>ã€‚å½“<code>function</code>çš„è¾“å‡ºæ˜¯æ¦‚ç‡æ€§çš„ï¼Œè¿™ç§æµ‹è¯•æ–¹æ³•ä¾¿å¤±æ•ˆäº†ã€‚æ–°çš„æµ‹è¯•èŒƒå¼å¿…é¡»è½¬å‘<strong>ç»Ÿè®¡éªŒè¯</strong>ï¼šè¿è¡Œå¤§é‡æµ‹è¯•ç”¨ä¾‹ï¼Œè¯„ä¼°è¾“å‡ºçš„æ•´ä½“åˆ†å¸ƒæ˜¯å¦ç¬¦åˆé¢„æœŸï¼Œè¡¡é‡å¹»è§‰ç‡ã€ç›¸å…³æ€§ç­‰å®è§‚è´¨é‡æŒ‡æ ‡ã€‚</li><li><strong>"å¤±è´¥"çš„è®¤çŸ¥å‡çº§</strong>ï¼šä¼ ç»Ÿç³»ç»Ÿçš„å¤±è´¥æ˜¯æ˜¾æ€§çš„ï¼Œå¦‚æœåŠ¡å®•æœºã€APIè¿”å› 500 é”™è¯¯ã€‚AIç³»ç»Ÿçš„å¤±è´¥åˆ™æ›´åŠ éšè”½å’Œå¤æ‚ï¼Œå®ƒå¯èƒ½åœ¨åŸºç¡€è®¾æ–½å±‚é¢å®Œå…¨å¥åº·ï¼Œä½†å…¶è¾“å‡ºçš„å†…å®¹å´æ˜¯é”™è¯¯çš„ã€æœ‰å®³çš„æˆ–å¸¦æœ‰åè§çš„ã€‚å› æ­¤ï¼Œæ¶æ„å¸ˆå¿…é¡»å°†<strong>"è´¨é‡é™çº§"è§†ä¸ºä¸"æœåŠ¡å®•æœº"åŒç­‰çº§åˆ«çš„ç”Ÿäº§äº‹æ•…</strong>ï¼Œå¹¶ä¸ºæ­¤è®¾è®¡ç›¸åº”çš„ç›‘æ§ã€å‘Šè­¦å’Œä¼˜é›…é™çº§æœºåˆ¶ã€‚</li></ol><blockquote><p>[!IMPORTANT]</p><p><strong>æ ¸å¿ƒå¿ƒæ³•</strong>ï¼šæ”¾å¼ƒå¯¹ç»å¯¹æ§åˆ¶çš„æ‰§å¿µï¼Œæ‹¥æŠ±å¹¶ç®¡ç†ä¸ç¡®å®šæ€§ã€‚å°†ç³»ç»Ÿè®¾è®¡ä»è¿½æ±‚"ä¸å‡ºé”™çš„é€»è¾‘"è½¬å˜ä¸ºæ„å»ºä¸€ä¸ª<strong>èƒ½å¤ŸåŒ…å®¹ã€è¯„ä¼°å¹¶ä»æ¦‚ç‡æ€§ç»„ä»¶çš„é”™è¯¯ä¸­æ¢å¤çš„ã€å…·æœ‰éŸ§æ€§çš„ç¡®å®šæ€§æ¡†æ¶</strong>ã€‚</p></blockquote><h2 id="æ³•åˆ™äºŒæ€ç»´çš„è·ƒè¿-ä»æ— çŠ¶æ€æœåŠ¡åˆ°æœ‰çŠ¶æ€æ¨ç†">æ³•åˆ™äºŒï¼šæ€ç»´çš„è·ƒè¿ â€”â€”ä»æ— çŠ¶æ€æœåŠ¡åˆ°æœ‰çŠ¶æ€æ¨ç†</h2><p>åœ¨è¿‡å»çš„åå¹´é‡Œï¼Œä¸ºäº†åº”å¯¹æµ·é‡å¹¶å‘ï¼Œå¾®æœåŠ¡æ¶æ„çš„æ ¸å¿ƒä¿¡æ¡ä¹‹ä¸€å°±æ˜¯<strong>æ— çŠ¶æ€ï¼ˆStatelessï¼‰</strong>ã€‚ä»»ä½•ä¸€ä¸ªæœåŠ¡å®ä¾‹éƒ½å¯ä»¥å¤„ç†ä»»ä½•ä¸€ä¸ªè¯·æ±‚ï¼Œå› ä¸ºçŠ¶æ€è¢«å¤–éƒ¨åŒ–åˆ°äº†å…±äº«çš„æ•°æ®åº“æˆ–ç¼“å­˜ä¸­ã€‚è¿™æå¤§åœ°ç®€åŒ–äº†æ°´å¹³æ‰©å±•å’Œæ•…éšœæ¢å¤ã€‚</p><p>ç„¶è€Œï¼ŒAIçš„æ ¸å¿ƒèƒ½åŠ›â€”â€”æ— è®ºæ˜¯å¤šè½®å¯¹è¯è¿˜æ˜¯å¤æ‚çš„æ™ºèƒ½ä½“ï¼ˆAgentï¼‰è§„åˆ’â€”â€”éƒ½<strong>å¤©ç”Ÿå¼ºä¾èµ–äºä¸Šä¸‹æ–‡ï¼Œå³æœ¬è´¨ä¸Šæ˜¯æœ‰çŠ¶æ€çš„ï¼ˆStatefulï¼‰</strong>ã€‚ä¸€ä¸ªæ²¡æœ‰è®°å¿†çš„AIæ— æ³•è¿›è¡Œæœ‰æ„ä¹‰çš„æ¨ç†ã€‚è¿™ç§å¯¹çŠ¶æ€çš„å†…åœ¨éœ€æ±‚ï¼Œè¿«ä½¿æˆ‘ä»¬è¿›è¡Œä¸€æ¬¡æ·±åˆ»çš„æ€ç»´è·ƒè¿ã€‚</p><ol type="1"><li><strong>"çŠ¶æ€"çš„å†…æ¶µæ‰©å±•</strong>ï¼šåœ¨ä¼ ç»Ÿåç«¯è¯­å¢ƒä¸­ï¼ŒçŠ¶æ€é€šå¸¸æŒ‡ç”¨æˆ·çš„ä¼šè¯æ•°æ®ï¼ˆSessionï¼‰æˆ–è´­ç‰©è½¦ä¿¡æ¯ã€‚åœ¨AI è¯­å¢ƒä¸­ï¼ŒçŠ¶æ€çš„å†…æ¶µè¢«æå¤§åœ°ä¸°å¯Œäº†ï¼Œå®ƒæ¼”å˜æˆäº† AIçš„<strong>è®°å¿†ç³»ç»Ÿ</strong>ï¼Œä¸€ä¸ªå¤šå±‚æ¬¡ã€å¤šç»´åº¦çš„è®¤çŸ¥æ ¸å¿ƒ ã€‚<ul><li><strong>çŸ­æœŸè®°å¿†ï¼ˆå·¥ä½œè®°å¿†ï¼‰</strong>ï¼šå½“å‰å¯¹è¯çš„ä¸Šä¸‹æ–‡ï¼Œç”¨äºå³æ—¶äº¤äº’ï¼Œé€šå¸¸å­˜å‚¨åœ¨Redis ç­‰é«˜é€Ÿç¼“å­˜ä¸­ ã€‚</li><li><strong>é•¿æœŸè®°å¿†</strong>ï¼šè·¨è¶Šå¤šæ¬¡ä¼šè¯çš„çŸ¥è¯†å’Œç”¨æˆ·åå¥½ï¼Œæ˜¯å®ç°ä¸ªæ€§åŒ–çš„åŸºç¡€ã€‚</li><li><strong>æƒ…æ™¯è®°å¿†ï¼ˆEpisodicMemoryï¼‰</strong>ï¼šå¯¹ç‰¹å®šäº‹ä»¶å’Œè¿‡å»äº¤äº’çš„è®°å¿†ï¼Œç”¨äºä»å…·ä½“ç»éªŒä¸­å­¦ä¹ ã€‚</li><li><strong>è¯­ä¹‰è®°å¿†ï¼ˆSemanticMemoryï¼‰</strong>ï¼šå…³äºä¸–ç•Œçš„äº‹å®ã€è§„åˆ™å’ŒçŸ¥è¯†ï¼Œé€šå¸¸é€šè¿‡ RAGä»çŸ¥è¯†åº“ä¸­æ£€ç´¢ ã€‚</li></ul></li><li><strong>æ¶æ„è§’è‰²çš„è½¬å˜</strong>ï¼šè¿‡å»ï¼ŒçŠ¶æ€ç®¡ç†æ˜¯è¢«å‰¥ç¦»å’Œå¤–éƒ¨åŒ–çš„å¯¹è±¡ï¼Œä»¥ä¿è¯æ ¸å¿ƒæœåŠ¡çš„çº¯ç²¹æ— çŠ¶æ€ã€‚ç°åœ¨ï¼Œ<strong>è®°å¿†ç®¡ç†ï¼ˆMemoryManagementï¼‰æœ¬èº«æˆä¸ºäº† AIç³»ç»Ÿçš„æ ¸å¿ƒæ¶æ„ç»„ä»¶</strong>ã€‚æ¶æ„å¸ˆçš„å·¥ä½œä¸å†ä»…ä»…æ˜¯é€‰æ‹©ä¸€ä¸ªæ•°æ®åº“æ¥å­˜å‚¨çŠ¶æ€ï¼Œè€Œæ˜¯è¦è®¾è®¡ä¸€ä¸ªé«˜æ•ˆã€åˆ†å±‚çš„è®°å¿†ç³»ç»Ÿï¼Œç¡®ä¿AI èƒ½å¤Ÿåœ¨æ­£ç¡®çš„æ—¶é—´ã€ä»¥æ­£ç¡®çš„æˆæœ¬ï¼Œè®¿é—®åˆ°æ­£ç¡®çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ ã€‚</li></ol><blockquote><p>[!IMPORTANT]</p><p><strong>æ ¸å¿ƒå¿ƒæ³•</strong>ï¼šå°† AIçš„"çŠ¶æ€"ä»éœ€è¦ç®¡ç†çš„è´Ÿæ‹…ï¼Œå‡ç»´ä¸ºéœ€è¦ç²¾å¿ƒè®¾è®¡çš„æ ¸å¿ƒèµ„äº§ã€‚æ¶æ„çš„é‡å¿ƒä»"å¦‚ä½•æ¶ˆé™¤çŠ¶æ€"è½¬å˜ä¸º<strong>"å¦‚ä½•æ„å»ºä¸€ä¸ªé«˜æ•ˆã€æŒä¹…ä¸”å¯æ‰©å±•çš„è®¤çŸ¥è®°å¿†æ ¸å¿ƒ"</strong>ã€‚</p></blockquote><h2 id="æ³•åˆ™ä¸‰ä¼˜åŒ–çš„æ–°æ–¹ç¨‹-ä»æ•ˆç‡åˆ°ä»·å€¼">æ³•åˆ™ä¸‰ï¼šä¼˜åŒ–çš„æ–°æ–¹ç¨‹ â€”â€”ä»æ•ˆç‡åˆ°ä»·å€¼</h2><p>ä¼ ç»Ÿåç«¯ç³»ç»Ÿçš„ä¼˜åŒ–ç›®æ ‡éå¸¸çº¯ç²¹ï¼šåœ¨æœ‰é™çš„èµ„æºä¸‹ï¼Œè¿½æ±‚<strong>æ›´ä½å»¶è¿Ÿï¼ˆLatencyï¼‰</strong>å’Œ<strong>æ›´é«˜ååé‡ï¼ˆThroughputï¼‰</strong>ã€‚è¿™æ˜¯ä¸€ä¸ªäºŒç»´çš„ä¼˜åŒ–é—®é¢˜ï¼Œå·¥ç¨‹å¸ˆä»¬é€šè¿‡ç®—æ³•ä¼˜åŒ–ã€ç¼“å­˜ã€å¼‚æ­¥å¤„ç†ç­‰æ‰‹æ®µï¼Œåœ¨è¿™ä¸ªäºŒç»´ç©ºé—´é‡Œå¯»æ‰¾æœ€ä¼˜è§£ã€‚</p><p>LLMçš„å¼•å…¥ï¼Œä¸ºè¿™ä¸ªç»å…¸çš„ä¼˜åŒ–é—®é¢˜å¢åŠ äº†ä¸¤ä¸ªå…¨æ–°çš„ã€è‡³å…³é‡è¦çš„ç»´åº¦ï¼š<strong>å•æ¬¡è°ƒç”¨çš„è´§å¸æˆæœ¬ï¼ˆCostï¼‰</strong>å’Œ<strong>æ¦‚ç‡æ€§çš„è¾“å‡ºè´¨é‡ï¼ˆQualityï¼‰</strong>ã€‚æ¯ä¸€æ¬¡å¯¹LLM API çš„è°ƒç”¨éƒ½åœ¨ç›´æ¥æ¶ˆè€—é¢„ç®—ï¼Œå¹¶ä¸”å…¶è¿”å›ç»“æœçš„è´¨é‡æ˜¯æ³¢åŠ¨çš„ã€‚</p><p>è¿™ä½¿å¾—åç«¯æ¶æ„çš„ä¼˜åŒ–ç›®æ ‡ä»ä¸€ä¸ªçº¯ç²¹çš„æŠ€æœ¯æ•ˆç‡é—®é¢˜ï¼Œæ¼”å˜æˆä¸€ä¸ªå¤æ‚çš„<strong>å››ç»´ä»·å€¼æ–¹ç¨‹ï¼š<code>ä»·å€¼ = f(å»¶è¿Ÿ, ååé‡, æˆæœ¬, è´¨é‡)</code></strong>ã€‚</p><ol type="1"><li><strong>å†³ç­–çš„ä¸šåŠ¡åŒ–</strong>ï¼šé€‰æ‹©å“ªä¸ªæ¨¡å‹ã€æ˜¯å¦ä½¿ç”¨ç¼“å­˜ã€æ˜¯å¦å¯ç”¨æ›´å¤æ‚çš„Agenté“¾ï¼Œè¿™äº›ä¸å†ä»…ä»…æ˜¯æŠ€æœ¯å†³ç­–ï¼Œè€Œæ˜¯æ·±åˆ»çš„<strong>ä¸šåŠ¡å’Œäº§å“å†³ç­–</strong>ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªä½å»¶è¿Ÿã€ä½æˆæœ¬ä½†è´¨é‡ç¨é€Šçš„æ¨¡å‹å¯èƒ½é€‚ç”¨äºè‰ç¨¿ç”Ÿæˆï¼Œè€Œä¸€ä¸ªé«˜æˆæœ¬ã€é«˜å»¶è¿Ÿä½†è´¨é‡é¡¶å°–çš„æ¨¡å‹åˆ™é€‚ç”¨äºæœ€ç»ˆæŠ¥å‘Šçš„å®šç¨¿ã€‚æ¶æ„å¸ˆå¿…é¡»ä¸äº§å“ç»ç†ç´§å¯†åˆä½œï¼Œç†è§£ä¸åŒåœºæ™¯ä¸‹ç”¨æˆ·å¯¹è¿™å››ä¸ªç»´åº¦çš„ä¸åŒå®¹å¿åº¦ã€‚</li><li><strong>æ¶æ„çš„åŠ¨æ€åŒ–</strong>ï¼šæœ€ä¼˜è§£ä¸å†æ˜¯é™æ€çš„ã€‚ä¸€ä¸ªä¼˜ç§€çš„ AIåç«¯æ¶æ„åº”è¯¥æ˜¯<strong>ä»·å€¼é©±åŠ¨å’ŒåŠ¨æ€è‡ªé€‚åº”çš„</strong>ã€‚å®ƒåº”è¯¥èƒ½å¤Ÿæ ¹æ®è¯·æ±‚çš„ç±»å‹ã€ç”¨æˆ·çš„é‡è¦æ€§ã€å½“å‰çš„ç³»ç»Ÿè´Ÿè½½ï¼Œç”šè‡³é¢„ç®—çš„æ¶ˆè€—æƒ…å†µï¼ŒåŠ¨æ€åœ°åœ¨ä¸åŒçš„æ¨¡å‹ã€ç¼“å­˜ç­–ç•¥å’Œæ‰§è¡Œè·¯å¾„ä¹‹é—´è¿›è¡Œè·¯ç”±å’Œåˆ‡æ¢ã€‚ä¾‹å¦‚ï¼Œç³»ç»Ÿå¯ä»¥è®¾è®¡æˆï¼š<ul><li><strong>è¯­ä¹‰ç¼“å­˜ä¼˜å…ˆ</strong>ï¼šåœ¨è°ƒç”¨ LLMä¹‹å‰ï¼Œå…ˆæ£€æŸ¥æ˜¯å¦æœ‰è¯­ä¹‰ç›¸ä¼¼çš„é—®é¢˜å¯ä»¥ç›´æ¥è¿”å›ç¼“å­˜ç­”æ¡ˆï¼Œä»è€Œå°†æˆæœ¬é™ä¸ºé›¶ã€‚</li><li><strong>æ¨¡å‹åˆ†çº§ä¸å›é€€</strong>ï¼šä¼˜å…ˆå°è¯•å»‰ä»·å¿«é€Ÿçš„æ¨¡å‹ï¼Œå¦‚æœå…¶è¾“å‡ºè´¨é‡ä¸è¾¾æ ‡ï¼ˆé€šè¿‡è¯„ä¼°å‡½æ•°åˆ¤æ–­ï¼‰ï¼Œå†å‡çº§åˆ°æ›´æ˜‚è´µçš„æ¨¡å‹ã€‚æˆ–è€…åœ¨ä¸»åŠ›æ¨¡å‹ä¸å¯ç”¨æ—¶ï¼Œè‡ªåŠ¨é™çº§åˆ°å¤‡ç”¨æ¨¡å‹ã€‚</li><li><strong>æˆæœ¬é¢„ç®—æ§åˆ¶</strong>ï¼šå®æ—¶è¿½è¸ª Tokenæ¶ˆè€—ï¼Œå½“æ¥è¿‘é¢„ç®—é˜ˆå€¼æ—¶ï¼Œå¯ä»¥åˆ‡æ¢åˆ°æˆæœ¬æ›´ä½çš„æ¨¡å¼æˆ–å¯¹éæ ¸å¿ƒåŠŸèƒ½è¿›è¡Œç†”æ–­ã€‚</li></ul></li></ol><blockquote><p>[!IMPORTANT]</p><p><strong>æ ¸å¿ƒå¿ƒæ³•</strong>ï¼šå°†ç³»ç»Ÿä¼˜åŒ–çš„ç›®æ ‡ä»è¿½æ±‚å•ä¸€ç»´åº¦çš„"å¿«"ï¼Œè½¬å˜ä¸ºåœ¨å¤šç»´ç©ºé—´ä¸­å¯»æ‰¾"ä»·å€¼æœ€ä¼˜"ã€‚æ¶æ„å¸ˆçš„è§’è‰²ä»æ€§èƒ½å·¥ç¨‹å¸ˆæ‰©å±•ä¸º<strong>ç³»ç»Ÿç»æµå­¦å®¶</strong>ï¼Œå…¶è®¾è®¡çš„ç³»ç»Ÿåº”å…·å¤‡åœ¨å»¶è¿Ÿã€ååã€æˆæœ¬å’Œè´¨é‡ä¹‹é—´è¿›è¡Œæ™ºèƒ½æƒè¡¡ä¸åŠ¨æ€è°ƒæ•´çš„èƒ½åŠ›ã€‚</p></blockquote><h2 id="æ³•åˆ™å››ç³»ç»Ÿçš„è¿›åŒ–-ä»æŒ‡ä»¤å¼ç¼–æ’åˆ°æ¶Œç°å¼ç”Ÿæ€">æ³•åˆ™å››ï¼šç³»ç»Ÿçš„è¿›åŒ– â€”â€”ä»æŒ‡ä»¤å¼ç¼–æ’åˆ°æ¶Œç°å¼ç”Ÿæ€</h2><p>å¾®æœåŠ¡æ¶æ„é€šè¿‡å°†åºå¤§çš„å•ä½“åº”ç”¨åˆ†è§£ä¸ºç‹¬ç«‹çš„ã€åŠŸèƒ½å•ä¸€çš„æœåŠ¡ï¼Œæå¤§åœ°æå‡äº†å¼€å‘æ•ˆç‡å’Œç³»ç»Ÿçš„å¯æ‰©å±•æ€§ã€‚è¿™äº›æœåŠ¡ä¹‹é—´çš„åä½œé€šå¸¸æ˜¯<strong>æŒ‡ä»¤å¼å’Œé¢„å®šä¹‰</strong>çš„ï¼Œé€šè¿‡ APIè°ƒç”¨æˆ–æ¶ˆæ¯é˜Ÿåˆ—ï¼Œéµå¾ªç€ç”±å·¥ç¨‹å¸ˆç²¾å¿ƒè®¾è®¡çš„ã€ç›¸å¯¹å›ºå®šçš„å·¥ä½œæµï¼ˆWorkflowï¼‰ã€‚</p><p>AIæ™ºèƒ½ä½“ï¼ˆAgentï¼‰çš„å‡ºç°ï¼Œé¢„ç¤ºç€ä¸€ç§å…¨æ–°çš„ç³»ç»ŸèŒƒå¼ï¼šä»å·¥ç¨‹å¸ˆä¸»å¯¼çš„"ç¼–æ’"ï¼ˆOrchestrationï¼‰åˆ°<strong>æ™ºèƒ½ä½“è‡ªä¸»åä½œçš„"æ¶Œç°"ï¼ˆEmergenceï¼‰</strong>ã€‚</p><ol type="1"><li><strong>ä»"ç®¡é“å·¥"åˆ°"ç”Ÿæ€è®¾è®¡å¸ˆ"</strong>ï¼šåœ¨ä¼ ç»Ÿå¾®æœåŠ¡æ¶æ„ä¸­ï¼Œæ¶æ„å¸ˆçš„è§’è‰²åœ¨æŸç§ç¨‹åº¦ä¸Šåƒä¸€ä¸ªç®¡é“å·¥ï¼Œè´Ÿè´£è®¾è®¡å’Œè¿æ¥æœåŠ¡ä¹‹é—´çš„æ•°æ®ç®¡é“ã€‚åœ¨å¤šæ™ºèƒ½ä½“ç³»ç»Ÿä¸­ï¼Œæ¶æ„å¸ˆçš„è§’è‰²æ›´åƒä¸€ä¸ª<strong>ç”Ÿæ€è®¾è®¡å¸ˆ</strong>ã€‚å…¶æ ¸å¿ƒä»»åŠ¡ä¸å†æ˜¯ç¡¬ç¼–ç æ¯ä¸€ä¸ªäº¤äº’æ­¥éª¤ï¼Œè€Œæ˜¯åˆ›é€ ä¸€ä¸ªç¯å¢ƒå’Œä¸€å¥—è§„åˆ™ï¼Œè®©å¤šä¸ªä¸“èŒçš„ã€è‡ªä¸»çš„æ™ºèƒ½ä½“èƒ½å¤Ÿåœ¨è¿™ä¸ªç¯å¢ƒä¸­<strong>å‘ç°å½¼æ­¤ã€è¿›è¡Œé€šä¿¡ã€ååŒåˆä½œ</strong>ï¼Œä»¥å®Œæˆä¸€ä¸ªæ›´é«˜å±‚æ¬¡çš„ã€ç”šè‡³åœ¨è®¾è®¡ä¹‹åˆæœªè¢«å®Œå…¨é¢„æ–™åˆ°çš„å¤æ‚ç›®æ ‡ã€‚</li><li><strong>æ‹¥æŠ±"æ¶Œç°è¡Œä¸º"ä¸"å¯è§‚æµ‹æ€§"</strong>ï¼šå½“å¤šä¸ªè‡ªä¸»æ™ºèƒ½ä½“å¼€å§‹äº¤äº’æ—¶ï¼Œç³»ç»Ÿçš„æ•´ä½“è¡Œä¸ºå¯èƒ½è¶…è¶Šå…¶ä»»ä½•å•ä¸ªç»„æˆéƒ¨åˆ†çš„èƒ½åŠ›æ€»å’Œï¼Œäº§ç”Ÿæ‰€è°“çš„"æ¶Œç°è¡Œä¸º"ã€‚è¿™ç§è¡Œä¸ºæ—¢æ˜¯æ™ºèƒ½ä½“ç³»ç»Ÿå¨åŠ›çš„æ¥æºï¼Œä¹Ÿæ˜¯å…¶å¤æ‚æ€§å’Œé£é™©çš„æ ¹æºã€‚å®ƒå¯èƒ½å¸¦æ¥åˆ›æ–°çš„è§£å†³æ–¹æ¡ˆï¼Œä¹Ÿå¯èƒ½å¯¼è‡´æ„æƒ³ä¸åˆ°çš„ã€æœ‰å®³çš„è¿é”ååº”ã€‚å› æ­¤ï¼Œ<strong>å¯è§‚æµ‹æ€§ï¼ˆObservabilityï¼‰</strong>åœ¨æ™ºèƒ½ä½“æ¶æ„ä¸­çš„é‡è¦æ€§è¢«æå‡åˆ°äº†å‰æ‰€æœªæœ‰çš„é«˜åº¦ã€‚æˆ‘ä»¬éœ€è¦å…¨æ–°çš„å·¥å…·å’Œç†å¿µæ¥è¿½è¸ªå’Œç†è§£æ™ºèƒ½ä½“çš„å†³ç­–è·¯å¾„ã€å·¥å…·è°ƒç”¨ã€ä»¥åŠæ™ºèƒ½ä½“ä¹‹é—´çš„äº¤äº’æ¨¡å¼ï¼Œä»è€Œåœ¨å®ƒä»¬æ¶Œç°å‡ºé—®é¢˜æ—¶èƒ½å¤ŸåŠæ—¶å‘ç°ã€ç†è§£å¹¶å¹²é¢„ã€‚</li></ol><blockquote><p>[!IMPORTANT]</p><p><strong>æ ¸å¿ƒå¿ƒæ³•</strong>ï¼šå°†ç³»ç»Ÿè§†ä¸ºä¸€ä¸ªæ´»çš„ã€æ¼”åŒ–çš„ç”Ÿæ€ï¼Œè€Œéä¸€å°é™æ€çš„ã€ç²¾å¯†çš„æœºå™¨ã€‚æ¶æ„å¸ˆçš„ç›®æ ‡æ˜¯è®¾è®¡ä¸€ä¸ª<strong>ä¿ƒè¿›æœ‰ç›Šåä½œã€åŒæ—¶åˆèƒ½çº¦æŸå’Œè§‚æµ‹æ½œåœ¨é£é™©çš„æ™ºèƒ½ä½“ç¯å¢ƒ</strong>ï¼Œä»æ„å»ºå¯é¢„æµ‹çš„ç³»ç»Ÿï¼Œè½¬å‘å¼•å¯¼å’Œç®¡ç†ä¸€ä¸ªä¸æ–­æ¼”åŒ–çš„ã€å…·æœ‰æ¶Œç°æ™ºèƒ½çš„ç³»ç»Ÿã€‚</p></blockquote><h1 id="ç»“è®º">ç»“è®º</h1><p>æŠ€æœ¯çš„"æœ¯"æ—¥æ–°æœˆå¼‚ï¼Œä»Šå¤©æˆ‘ä»¬è®¨è®ºçš„ Kafkaã€Redisã€Go æˆ–Rustï¼Œæ˜å¤©å¯èƒ½ä¼šæœ‰æ–°çš„æ›¿ä»£è€…ã€‚ç„¶è€Œï¼Œä¸Šè¿°å››å¤§"é“"â€”â€”<strong>æ‹¥æŠ±æ¦‚ç‡æ€§ã€æ„å»ºè®°å¿†æ ¸å¿ƒã€ä¼˜åŒ–ä»·å€¼æ–¹ç¨‹ã€è®¾è®¡æ¶Œç°ç”Ÿæ€</strong>â€”â€”æ„æˆäº†AI æ—¶ä»£åç«¯æ¶æ„çš„æ ¹æœ¬ã€‚</p><p>æŒæ¡äº†è¿™äº›æ ¸å¿ƒæ€æƒ³ï¼Œæ— è®ºæœªæ¥çš„æŠ€æœ¯ç»†èŠ‚å¦‚ä½•æ¼”å˜ï¼Œæˆ‘ä»¬éƒ½èƒ½æŠ“ä½å…¶æœ¬è´¨ï¼Œè®¾è®¡å‡ºçœŸæ­£å¥å£®ã€é«˜æ•ˆä¸”æ™ºèƒ½çš„ç³»ç»Ÿï¼Œä»è€Œåœ¨è¿™åœºæ·±åˆ»çš„æŠ€æœ¯å˜é©ä¸­ï¼Œå§‹ç»ˆä¿æŒå‰ç»æ€§å’Œé¢†å¯¼åŠ›ã€‚</p>]]></content>
    
    
    <summary type="html">æœ¬æ–‡è·Ÿ Gemini æ¢è®¨åœ¨ AI æ—¶ä»£ä¸‹ï¼Œä¼ ç»Ÿåç«¯å·¥ç¨‹å¸ˆå¦‚ä½•ç»“åˆè‡ªèº«ä¼˜åŠ¿ï¼Œè½¬å‹ä¸º AI åº”ç”¨å¼€å‘å·¥ç¨‹å¸ˆã€‚</summary>
    
    
    
    <category term="aié—®ç­”" scheme="https://hedon.top/categories/ai%E9%97%AE%E7%AD%94/"/>
    
    
    <category term="æ€è€ƒ" scheme="https://hedon.top/tags/%E6%80%9D%E8%80%83/"/>
    
  </entry>
  
  <entry>
    <title>è¯»ä¹¦ç¬”è®°ä¸¨ã€Šä»é›¶æ„å»ºå¤§è¯­è¨€æ¨¡å‹ã€‹</title>
    <link href="https://hedon.top/2025/08/30/llm/note-llm-from-scratch/"/>
    <id>https://hedon.top/2025/08/30/llm/note-llm-from-scratch/</id>
    <published>2025-08-30T03:22:00.000Z</published>
    <updated>2025-09-05T10:19:08.128Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘åœ¨çœ‹ã€Šä»é›¶æ„å»ºå¤§è¯­è¨€æ¨¡å‹ã€‹è¿™æœ¬ä¹¦ï¼Œè·Ÿç€æ€è·¯è‡ªå·±ä¹ŸåŠ¨æ‰‹ç äº†ä¸€ä¸ªåŸºç¡€æ¬¾çš„LLMï¼Œä»£ç ä¸å¤šï¼Œæ‹¢å…± 500 æ¥è¡Œï¼Œå®Œæ•´ä»£ç  <ahref="https://github.com/hedon-ai-road/llm-from-scratch/blob/main/all_in_one.py">llm-from-scrtach</a>ã€‚</p><p>æ‰€ä»¥ï¼Œè¿™ç¯‡è¯»ä¹¦ç¬”è®°ä¸æ‰“ç®—ç©ºè°ˆç†è®ºï¼Œå°±æƒ³æ¢ä¸ªæ–¹å¼ï¼šè¯•ç€æŠŠè¿™ 500è¡Œä»£ç çš„æ¥é¾™å»è„‰è®²æ¸…æ¥šã€‚é€šè¿‡è§£è¯´ä»£ç ï¼ŒæŠŠä»é›¶æ„å»ºä¸€ä¸ªå¤§æ¨¡å‹éœ€è¦ç»å†å“ªäº›ç¯èŠ‚ã€æ¯ä¸ªç¯èŠ‚çš„ç›®æ ‡å’Œå¤§æ¦‚åŸç†ç»™ä¸²èµ·æ¥ã€‚</p><p>ç¬”è€…å¹¶éè¯¥æ–¹å‘çš„ä¸“ä¸šäººå£«ï¼Œå¾ˆå¤šä¸œè¥¿ä¸ä¼šè®²å¾—å¤ªæ·±ï¼ˆæˆ‘è‡ªå·±ä¹Ÿä¸æ‡‚ï¼‰ï¼Œæ‰€ä»¥å¾ˆå¤šæ—¶å€™éƒ½æ˜¯ç‚¹åˆ°å³æ­¢ã€‚è¿™ç¯‡æ–‡ç« æ›´é€‚åˆé‚£äº›å’Œæˆ‘ä¸€æ ·çš„å¼€å‘è€…ï¼Œå¸Œæœ›èƒ½ä»ä¸€ä¸ªæ¥åœ°æ°”çš„å·¥ç¨‹è§’åº¦ï¼Œå¯¹å¤§æ¨¡å‹çš„æ„å»ºåŸç†æœ‰ä¸ªå®è§‚çš„äº†è§£ã€‚</p><p>æˆ‘ä»¬å°†é‡‡ç”¨ä¸€ç§è´´è¿‘è½¯ä»¶å¼€å‘è€…æ€ç»´çš„<strong>ä»£ç æ‰§è¡Œæµ</strong>è§†è§’ï¼Œä»ç¨‹åºçš„å…¥å£<code>main</code>å‡½æ•°å¼€å§‹ï¼Œé¡ºç€è°ƒç”¨æ ˆé€å±‚æ·±å…¥ï¼Œæ¢ç©¶æ•°æ®å¤„ç†ã€æ¨¡å‹æ„å»ºã€è®­ç»ƒå¾ªç¯çš„æ¯ä¸€ä¸ªç»†èŠ‚ã€‚å½“ä¸€ä¸ªæ¨¡å—è¢«è°ƒç”¨æ—¶ï¼Œæˆ‘ä»¬ä¾¿æ·±å…¥å…¶ä¸­ï¼Œç›´è‡³æœ€åº•å±‚çš„å®ç°ã€‚</p><p>è¿™è¶Ÿæ—…ç¨‹å°†éµå¾ªä»¥ä¸‹è·¯çº¿å›¾ï¼š</p><ul><li><strong>ä» <code>main</code>å‡½æ•°å‡ºå‘</strong>ï¼šæ¢å¯»ç¨‹åºçš„å…¥å£ä¸æ€»è°ƒåº¦ä¸­å¿ƒã€‚</li><li><strong>æ·±å…¥æ•°æ®æµæ°´çº¿</strong>ï¼šçœ‹åŸå§‹æ–‡æœ¬å¦‚ä½•è¢«åŠ å·¥æˆæ¨¡å‹èƒ½å¤Ÿæ¶ˆåŒ–çš„é£Ÿç²®ã€‚</li><li><strong>è§£æ„æ ¸å¿ƒå¼•æ“</strong>ï¼šå±‚å±‚å‰–æ<code>GPTModel</code>ã€<code>TransformerBlock</code> ç›´è‡³æœ€æ·±å¤„çš„<code>MultiHeadAttention</code> æœºåˆ¶ã€‚</li><li><strong>å¯åŠ¨è®­ç»ƒå¾ªç¯</strong>ï¼šè§è¯æ¨¡å‹å¦‚ä½•é€šè¿‡æŸå¤±è®¡ç®—å’Œæƒé‡æ›´æ–°ï¼Œä»éšæœºå˜å¾—æ™ºèƒ½ã€‚</li><li><strong>è§è¯æ–‡æœ¬ç”Ÿæˆ</strong>ï¼šè§‚å¯Ÿè®­ç»ƒå¥½çš„æ¨¡å‹å¦‚ä½•åƒæˆ‘ä»¬ä¸€æ ·ï¼Œé€å­—é€å¥åœ°"æ€è€ƒ"å’Œ"åˆ›ä½œ"ã€‚</li></ul><p>è®©æˆ‘ä»¬å³åˆ»å‡ºå‘ï¼Œæ­å¼€å¤§è¯­è¨€æ¨¡å‹èƒŒåçš„ä»£ç ä¹‹è°œã€‚</p><h1 id="æ•°æ®å‡†å¤‡ä¸é‡‡æ ·">1. æ•°æ®å‡†å¤‡ä¸é‡‡æ ·</h1><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250831134803291.png" style="zoom:33%;" /></p><p><code>prepare_train_and_val_data</code> çš„å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">prepare_train_and_val_data</span>(<span class="params">file_path, tokenizer</span>) -&gt; <span class="built_in">tuple</span>[DataLoader, DataLoader]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å‡†å¤‡è®­ç»ƒå’ŒéªŒè¯æ•°æ®åŠ è½½å™¨&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ­¥éª¤ 1: è¯»å–åŸå§‹æ–‡æœ¬</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        text_data = file.read()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ­¥éª¤ 2: æŒ‰æ¯”ä¾‹åˆ†å‰²æˆè®­ç»ƒå’ŒéªŒè¯ä¸¤éƒ¨åˆ†ï¼š90%è®­ç»ƒï¼Œ10%éªŒè¯</span></span><br><span class="line">    train_ratio = <span class="number">0.9</span></span><br><span class="line">    split_idx = <span class="built_in">int</span>(train_ratio * <span class="built_in">len</span>(text_data))</span><br><span class="line">    train_data = text_data[:split_idx]</span><br><span class="line">    val_data = text_data[split_idx:]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ­¥éª¤ 3: åˆ†åˆ«ä¸ºä¸¤éƒ¨åˆ†æ–‡æœ¬åˆ›å»º DataLoader</span></span><br><span class="line">    train_loader = create_dataloader(</span><br><span class="line">        tokenizer,</span><br><span class="line">        train_data,</span><br><span class="line">        batch_size=<span class="number">2</span>,</span><br><span class="line">        max_length=GPT_CONFIG_124M[<span class="string">&quot;context_length&quot;</span>],</span><br><span class="line">        stride=GPT_CONFIG_124M[<span class="string">&quot;context_length&quot;</span>],</span><br><span class="line">        drop_last=<span class="literal">True</span>,</span><br><span class="line">        shuffle=<span class="literal">True</span>,</span><br><span class="line">        num_workers=<span class="number">0</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    val_loader = create_dataloader(</span><br><span class="line">        tokenizer,</span><br><span class="line">        val_data,</span><br><span class="line">        batch_size=<span class="number">2</span>,</span><br><span class="line">        max_length=GPT_CONFIG_124M[<span class="string">&quot;context_length&quot;</span>],</span><br><span class="line">        stride=GPT_CONFIG_124M[<span class="string">&quot;context_length&quot;</span>],</span><br><span class="line">        drop_last=<span class="literal">False</span>,</span><br><span class="line">        shuffle=<span class="literal">False</span>,</span><br><span class="line">        num_workers=<span class="number">0</span>,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> train_loader, val_loader</span><br></pre></td></tr></table></figure><h2 id="åˆ’åˆ†æ•°æ®é›†-prepare_train_and_val_data">1.1 åˆ’åˆ†æ•°æ®é›†prepare_train_and_val_data</h2><p><code>prepare_train_and_val_data</code>çš„ä»£ç å¹¶ä¸å¤æ‚ï¼Œå°±æ˜¯å°†æ•°æ®é›†åˆ’åˆ†ä¸ºè®­ç»ƒé›†å’ŒéªŒè¯é›†ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªé—®é¢˜å°±æ¥äº†ï¼š<strong><u>æ¨¡å‹ä¸ºä½•éœ€è¦è®­ç»ƒé›†å’ŒéªŒè¯é›†ï¼Ÿ</u></strong></p><p>å’Œäººç±»ä¸€æ ·ï¼Œæ¨¡å‹é€šè¿‡<strong>çœ‹ä¾‹å­</strong>æ¥å­¦ä¹ ã€‚æˆ‘ä»¬ç»™å®ƒä¸€æœ¬"æ•™ç§‘ä¹¦"å’Œé…å¥—çš„"ç»ƒä¹ å†Œ"ï¼ˆ<strong>è®­ç»ƒé›†</strong>ï¼‰ï¼Œè®©å®ƒåå¤ç»ƒä¹ ï¼Œå¯»æ‰¾è§„å¾‹ã€‚ä½†æˆ‘ä»¬å¦‚ä½•çŸ¥é“å®ƒæ˜¯çœŸçš„å­¦ä¼šäº†ï¼Œè¿˜æ˜¯ä»…ä»…èƒŒä¸‹äº†ç­”æ¡ˆï¼ˆè¿‡æ‹Ÿåˆï¼‰å‘¢ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯ï¼Œæˆ‘ä»¬éœ€è¦ä¸€åœºå®ƒä»æœªè§è¿‡çš„<strong>æ¨¡æ‹Ÿè€ƒè¯•</strong>ï¼ˆ<strong>éªŒè¯é›†</strong>ï¼‰ã€‚</p><ul><li><strong>è®­ç»ƒé›† (TrainingSet)</strong>ï¼šè¿™æ˜¯æ¨¡å‹å­¦ä¹ çš„<strong>å”¯ä¸€èµ„æ–™</strong>ã€‚æ¨¡å‹ä¼šå°½å…¨åŠ›å»æ‹Ÿåˆè®­ç»ƒé›†ä¸­çš„æ•°æ®ï¼Œç›®æ ‡æ˜¯åœ¨è¿™ä¸ªæ•°æ®é›†ä¸Šè·å¾—å°½å¯èƒ½ä½çš„å‡ºé”™ç‡ï¼ˆæŸå¤±ï¼‰ã€‚è¿™å¯¹åº”äº†ä»£ç ä¸­90% çš„æ–‡æœ¬æ•°æ® ã€‚</li><li><strong>éªŒè¯é›† (ValidationSet)</strong>ï¼šè¿™æ˜¯ä¸€ä»½<strong>è¢«éš”ç¦»çš„æ•°æ®</strong>ï¼Œæ¨¡å‹åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­<strong>ç»å¯¹ä¸èƒ½</strong>ç”¨å®ƒæ¥æ›´æ–°è‡ªå·±çš„æƒé‡ã€‚æˆ‘ä»¬åªåœ¨è®­ç»ƒçš„ç‰¹å®šé˜¶æ®µç”¨å®ƒæ¥â€œè€ƒâ€ä¸€ä¸‹æ¨¡å‹ï¼Œçœ‹çœ‹æ¨¡å‹åœ¨â€œæ–°é¢˜å‹â€ä¸Šçš„è¡¨ç°å¦‚ä½•ã€‚è¿™å¯¹åº”äº†ä»£ç ä¸­10% çš„æ–‡æœ¬æ•°æ® ã€‚</li></ul><p>å¦‚æœæ¨¡å‹åœ¨è®­ç»ƒé›†ä¸Šè¡¨ç°ä¼˜å¼‚ï¼ˆæ¯”å¦‚æŸå¤±å¾ˆä½ï¼‰ï¼Œä½†åœ¨éªŒè¯é›†ä¸Šè¡¨ç°ç³Ÿç³•ï¼Œè¿™å°±äº®èµ·äº†<strong>è¿‡æ‹Ÿåˆ</strong>çš„çº¢ç¯ã€‚è¿™è¯´æ˜æ¨¡å‹åªæ˜¯æ­»è®°ç¡¬èƒŒäº†è®­ç»ƒé¢˜ï¼Œè€Œæ²¡æœ‰å­¦åˆ°æ™®é€‚çš„è§„å¾‹ã€‚<code>prepare_train_and_val_data</code>å‡½æ•°çš„æ ¸å¿ƒä½¿å‘½ï¼Œå°±æ˜¯ä¸ºæ¨¡å‹å‡†å¤‡å¥½è¿™ä¸¤ä»½è‡³å…³é‡è¦çš„æ•°æ®é›†ã€‚</p><p>å®ƒè°ƒç”¨äº† <code>create_dataloader</code> å‡½æ•°ã€‚æˆ‘ä»¬å¿…é¡»æ³¨æ„<code>train_loader</code> å’Œ <code>val_loader</code>åœ¨é…ç½®ä¸Šçš„ä¸€ä¸ª<strong>å…³é”®åŒºåˆ«</strong>ï¼š</p><ul><li><p><strong><code>train_loader</code> çš„ <code>shuffle</code> è®¾ç½®ä¸º<code>True</code></strong> ã€‚</p><p>è¿™æ˜¯ä¸ºäº†<strong>ä¿è¯è®­ç»ƒçš„æœ‰æ•ˆæ€§</strong>ã€‚åœ¨æ¯ä¸€è½® (epoch)è®­ç»ƒå¼€å§‹æ—¶ï¼Œ<code>DataLoader</code>éƒ½ä¼šå°†è®­ç»ƒæ ·æœ¬çš„é¡ºåºå®Œå…¨æ‰“ä¹±ã€‚è¿™å°±åƒæˆ‘ä»¬å­¦ä¹ æ—¶ä¼šæ‰“ä¹±å•è¯å¡ç‰‡çš„é¡ºåºä¸€æ ·ï¼Œå¯ä»¥é˜²æ­¢æ¨¡å‹å­¦åˆ°æ ·æœ¬çš„å‡ºåœºé¡ºåºè¿™ç§æ— å…³ä¿¡æ¯ï¼Œä»è€Œè¿«ä½¿å®ƒå­¦ä¹ æ›´å…·æ³›åŒ–æ€§çš„è¯­è¨€è§„å¾‹ã€‚</p></li><li><p><strong><code>val_loader</code> çš„ <code>shuffle</code> è®¾ç½®ä¸º<code>False</code></strong> ã€‚</p><p>è¿™æ˜¯ä¸ºäº†<strong>ä¿è¯è¯„ä¼°çš„å®¢è§‚æ€§å’Œä¸€è‡´æ€§</strong>ã€‚éªŒè¯é›†æ˜¯æˆ‘ä»¬çš„æ¨¡æ‹Ÿè€ƒè¯•ï¼Œæˆ‘ä»¬å¸Œæœ›æ¯æ¬¡è€ƒè¯•çš„å·å­ï¼ˆé¢˜ç›®é¡ºåºï¼‰éƒ½æ˜¯ä¸€æ ·çš„ï¼Œè¿™æ ·æ‰èƒ½å®¢è§‚åœ°æ¯”è¾ƒæ¨¡å‹åœ¨ä¸åŒè®­ç»ƒé˜¶æ®µçš„å¾—åˆ†ï¼Œåˆ¤æ–­å®ƒæ˜¯å¦çœŸçš„åœ¨è¿›æ­¥ã€‚</p></li></ul><h2 id="æ„å»ºæ•°æ®é›†-create_dataloader">1.2 æ„å»ºæ•°æ®é›†create_dataloader</h2><p><code>prepare_train_and_val_data</code>åªæ˜¯ä¸€ä¸ªè°ƒåº¦è€…ï¼ŒçœŸæ­£çš„æ•°æ®åŠ å·¥å‘ç”Ÿåœ¨å®ƒè°ƒç”¨çš„<code>create_dataloader</code> å’Œ <code>GPTDataset</code> ä¸­ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">create_dataloader</span>(<span class="params">tokenizer, txt, batch_size=<span class="number">4</span>, max_length=<span class="number">256</span>, stride=<span class="number">128</span>, shuffle=<span class="literal">True</span>, drop_last=<span class="literal">True</span>, num_workers=<span class="number">0</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;åˆ›å»ºæ•°æ®åŠ è½½å™¨&quot;&quot;&quot;</span></span><br><span class="line">    dataset = GPTDataset(txt, tokenizer, max_length, stride)</span><br><span class="line">    dataloader = DataLoader(</span><br><span class="line">        dataset,</span><br><span class="line">        batch_size=batch_size,</span><br><span class="line">        shuffle=shuffle,</span><br><span class="line">        drop_last=drop_last,</span><br><span class="line">        num_workers=num_workers,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> dataloader</span><br></pre></td></tr></table></figure><p><code>create_dataloader</code>æ˜¯ä¸€ä¸ªç®€å•çš„å°è£…ï¼Œå®ƒçš„æ ¸å¿ƒæ˜¯åšäº†ä¸¤ä»¶äº‹ï¼š</p><ol type="1"><li><code>dataset = GPTDataset(txt, tokenizer, max_length, stride)</code>ï¼šå®ä¾‹åŒ–ä¸€ä¸ª<code>GPTDataset</code> å¯¹è±¡ã€‚</li><li><code>dataloader = DataLoader(dataset, ...)</code>ï¼šå°†è¿™ä¸ª<code>dataset</code> å¯¹è±¡åŒ…è£…æˆä¸€ä¸ª PyTorch çš„<code>DataLoader</code>ã€‚</li></ol><h3 id="dataset-dataloader">1.2.1 Dataset &amp; DataLoader</h3><p>åœ¨æ·±å…¥ <code>GPTDataset</code> ç»“æ„ä¹‹å‰ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆå¯¹ PyTorch ä¸­çš„ 2ä¸ªå…³é”®æ•°æ®ç±»å‹ <code>Dataset</code> å’Œ <code>DataLoader</code>è¿›è¡Œç®€è¦ä»‹ç»ï¼Œå¯¹äº Pytorch æ›´è¯¦ç»†çš„ä»‹ç»å¯å‚è€ƒç¬”è€…è¿™ç¯‡ <ahref="https://hedon.top/2025/08/18/llm/pytorch/">å‘Šåˆ«æ­»è®°ç¡¬èƒŒï¼šä¸€ä»½çœŸæ­£ç†è§£PyTorch æ ¸å¿ƒè®¾è®¡çš„æŒ‡å—</a>ã€‚</p><p>ç®€è€Œè¨€ä¹‹ï¼Œ<code>Dataset</code> å’Œ <code>DataLoader</code>æ˜¯ä¸ºäº†è§£å†³"æ•°æ®é›†æ˜¯ä»€ä¹ˆ"å’Œ"å¦‚ä½•ä½¿ç”¨æ•°æ®é›†"è¿™ 2ä¸ªæ ¸å¿ƒé—®é¢˜ï¼Œæ›´å…·ä½“çš„æ¥è¯´ï¼Œåœ¨æ•°æ®å‡†å¤‡é˜¶æ®µï¼Œæˆ‘ä»¬å¯èƒ½ä¼šé¢ä¸´ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š</p><ol type="1"><li>åŸå§‹æ•°æ®æ ¼å¼å„å¼‚ï¼Œå¦‚ä½•ç»Ÿä¸€è¯»å–ï¼Ÿ</li><li>æ•°æ®é›†å¯èƒ½éå¸¸å¤§ï¼Œæ— æ³•ä¸€æ¬¡æ€§è½½å…¥å†…å­˜ï¼Œæ€ä¹ˆåŠï¼Ÿ</li><li>è®­ç»ƒæ—¶éœ€è¦å¯¹æ•°æ®è¿›è¡Œæ‰¹é‡ (batching)ã€æ‰“ä¹± (shuffling) å’Œé¢„å¤„ç†(preprocessing)ï¼Œå¦‚ä½•é«˜æ•ˆå®ç°ï¼Ÿ</li><li>å¦‚ä½•åˆ©ç”¨å¤šæ ¸ CPU æ¥åŠ é€Ÿæ•°æ®åŠ è½½ï¼Œé¿å… GPU ç­‰å¾…ï¼Ÿ</li></ol><p>PyTorch çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯ <code>Dataset</code> å’Œ<code>DataLoader</code> ï¼š</p><ul><li><code>Dataset</code>ï¼š<strong>å®ƒå®šä¹‰äº†"æ•°æ®é›†"æ˜¯ä»€ä¹ˆ</strong>ã€‚è¿™æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œä½ åªéœ€è¦ç»§æ‰¿å®ƒå¹¶å®ç°ä¸¤ä¸ªæ–¹æ³•ï¼š<code>__len__</code>(è¿”å›æ•°æ®é›†å¤§å°)å’Œ <code>__getitem__</code> (æ ¹æ®ç´¢å¼• <code>idx</code>è¿”å›ä¸€æ¡æ•°æ®)ã€‚å®ƒè§£å†³äº†å¦‚ä½•è·å–å•æ¡æ•°æ®çš„é—®é¢˜ï¼Œå°†æ•°æ®è®¿é—®çš„é€»è¾‘å°è£…èµ·æ¥ã€‚</li><li><code>DataLoader</code>ï¼š<strong>å®ƒå®šä¹‰äº†"å¦‚ä½•ä½¿ç”¨æ•°æ®é›†"</strong>ã€‚å®ƒæ¥æ”¶ä¸€ä¸ª<code>Dataset</code>å¯¹è±¡ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šï¼Œä¼˜é›…åœ°è§£å†³äº†æ‰€æœ‰å·¥ç¨‹é—®é¢˜ï¼š<ul><li><code>batch_size</code>ï¼šè‡ªåŠ¨å°†å•æ¡æ•°æ®æ‰“åŒ…æˆä¸€ä¸ª batchã€‚</li><li><code>shuffle=True</code>ï¼šåœ¨æ¯ä¸ª epochå¼€å§‹æ—¶è‡ªåŠ¨æ‰“ä¹±æ•°æ®é¡ºåºã€‚</li><li><code>num_workers</code>ï¼šå¯åŠ¨å¤šä¸ªå­è¿›ç¨‹å¹¶è¡ŒåŠ è½½æ•°æ®ï¼Œæå¤§åœ°æé«˜äº†æ•°æ®ä¾›ç»™æ•ˆç‡ã€‚</li><li><code>collate_fn</code>ï¼šè‡ªå®šä¹‰å¦‚ä½•å°†å¤šæ¡æ ·æœ¬åˆå¹¶æˆä¸€ä¸ªbatchï¼Œå¯¹äºå¤„ç†éæ ‡å‡†æ•°æ®ï¼ˆå¦‚ä¸åŒé•¿åº¦çš„å¥å­ï¼‰éå¸¸æœ‰ç”¨ã€‚</li></ul></li></ul><p>å®ƒä»¬ä¹‹é—´çš„å…³ç³»å¦‚å›¾æ‰€ç¤ºï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250830165323656.png"alt="Dataset ä¸ DataLoader" /><figcaption aria-hidden="true">Dataset ä¸ DataLoader</figcaption></figure><h3 id="gptdataset">1.2.2 GPTDataset</h3><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥æ¥çœ‹ <code>GPTDataset</code> çš„å…·ä½“é€»è¾‘äº†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GPTDataset</span>(<span class="title class_ inherited__">Dataset</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;GPTè®­ç»ƒæ•°æ®é›†&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, txt, tokenizer, max_length, stride</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="variable language_">self</span>.input_ids = []</span><br><span class="line">        <span class="variable language_">self</span>.target_ids = []</span><br><span class="line"></span><br><span class="line">        token_ids = tokenizer.encode(txt)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ä½¿ç”¨æ»‘åŠ¨çª—å£åˆ›å»ºè®­ç»ƒæ ·æœ¬</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(token_ids) - max_length, stride):</span><br><span class="line">            input_chunk = token_ids[i:i+max_length]</span><br><span class="line">            target_chunk = token_ids[i+<span class="number">1</span>:i+max_length+<span class="number">1</span>]</span><br><span class="line">            <span class="variable language_">self</span>.input_ids.append(torch.tensor(input_chunk))</span><br><span class="line">            <span class="variable language_">self</span>.target_ids.append(torch.tensor(target_chunk))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(<span class="variable language_">self</span>.input_ids)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, idx</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.input_ids[idx], <span class="variable language_">self</span>.target_ids[idx]</span><br></pre></td></tr></table></figure><p><code>GPTDataset</code> ç»§æ‰¿äº† <code>PyTorch</code> çš„<code>Dataset</code> ç±»å‹ï¼Œæˆ‘ä»¬é‡ç‚¹æ¥çœ‹å®ƒçš„æ„é€ å‡½æ•°<code>__init__()</code>ï¼Œå®ƒåˆ†ä¸º 2 ä¸ªæ­¥éª¤ï¼š</p><ol type="1"><li>å°†æ–‡æœ¬æ•°æ®è½¬ä¸ºè¯å…ƒ ID åˆ—è¡¨ï¼›</li><li>ä½¿ç”¨æ»‘åŠ¨çª—å£é€ä¸ªæ„å»º<strong>è¾“å…¥-ç›®æ ‡å¯¹</strong>ï¼Œæ„å»ºæ•´ä¸ªæ•°æ®é›†ï¼Œåˆ†åˆ«ç½®äº<code>input_ids</code> å’Œ <code>target_ids</code> è¿™ 2 ä¸ªå­—æ®µä¸­ã€‚</li></ol><h4 id="æ–‡æœ¬è¯å…ƒåŒ–">1.2.2.1 æ–‡æœ¬è¯å…ƒåŒ–</h4><p>ç°åœ¨åˆ°äº†æœ¬ç¯‡çš„ç¬¬ä¸€ä¸ªçœŸæ­£æ„ä¹‰ä¸Šçš„ç†è®ºç¯èŠ‚ï¼Œæˆ‘ä»¬éœ€è¦å…ˆææ¸…æ¥šè¯å…ƒåŒ–ï¼ˆå³ä¸‹é¢è¿™ä¸€è¡Œä»£ç ï¼‰åˆ°åº•æ˜¯åœ¨åšä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆè¦è¿™æ ·ï¼Ÿæœ‰å“ªäº›å…·ä½“çš„æ–¹å¼æ–¹æ³•ï¼Ÿ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">token_ids = tokenizer.encode(txt)</span><br></pre></td></tr></table></figure><p>åŒ…æ‹¬å¤§è¯­è¨€æ¨¡å‹åœ¨å†…çš„æ·±åº¦ç¥ç»ç½‘ç»œæ¨¡å‹æ˜¯æ— æ³•ç›´æ¥å¤„ç†åŸå§‹æ–‡æœ¬çš„ã€‚ç”±äºæ–‡æœ¬æ•°æ®æ˜¯ç¦»æ•£çš„ï¼Œå› æ­¤æˆ‘ä»¬æ— æ³•ç›´æ¥ç”¨å®ƒæ¥æ‰§è¡Œç¥ç»ç½‘ç»œè®­ç»ƒæ‰€éœ€çš„æ•°å­¦è¿ç®—ã€‚æˆ‘ä»¬éœ€è¦ä¸€ç§å°†å•è¯è¡¨ç¤ºä¸ºè¿ç»­å€¼çš„å‘é‡æ ¼å¼çš„æ–¹æ³•ï¼ˆé€šå¸¸æ˜¯å¼ é‡Tensorï¼‰ã€‚</p><p>å°†æ•°æ®è½¬æ¢ä¸ºå‘é‡æ ¼å¼çš„è¿‡ç¨‹é€šå¸¸ç§°ä¸ºåµŒå…¥ï¼ˆembeddingï¼‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250830170327803.png" /></p><p>è¦ç†è§£<code>Tensor</code>ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå»ºç«‹ä¸€ä¸ªæœ€é‡è¦çš„å¿ƒæ™ºæ¨¡å‹ï¼š<strong>Tensorçš„æ¯ä¸€ä¸ªç»´åº¦ (dimension) éƒ½æœ‰å…¶ç‰¹å®šçš„è¯­ä¹‰å«ä¹‰</strong>ã€‚</p><p>ä¸€ä¸ªå…¸å‹çš„ 4D Tensor <code>(B, C, H, W)</code> åœ¨è®¡ç®—æœºè§†è§‰ä¸­ï¼Œå…¶å½¢çŠ¶<code>(16, 3, 224, 224)</code> å¹¶ä¸æ˜¯ä¸€ä¸²å­¤ç«‹çš„æ•°å­—ï¼Œå®ƒçš„æ„æ€æ˜¯ï¼š</p><ul><li><strong>B (Batch size) = 16</strong>: è¿™ä¸ª Tensor é‡Œæœ‰ 16å¼ ç‹¬ç«‹çš„å›¾åƒã€‚</li><li><strong>C (Channels) = 3</strong>: æ¯å¼ å›¾åƒæœ‰ 3 ä¸ªé€šé“ï¼ˆR, G,Bï¼‰ã€‚</li><li><strong>H (Height) = 224</strong>: æ¯å¼ å›¾åƒçš„é«˜åº¦æ˜¯ 224 åƒç´ ã€‚</li><li><strong>W (Width) = 224</strong>: æ¯å¼ å›¾åƒçš„å®½åº¦æ˜¯ 224 åƒç´ ã€‚</li></ul><p>åœ¨å¤šä¸ªç»´åº¦ç»¼åˆèµ·æ¥è¯­ä¹‰å«ä¹‰è¶Šæ¥è¿‘çš„è¯ï¼Œå®ƒä»¬çš„è¯åµŒå…¥å‘é‡åœ¨ç©ºé—´è¡¨ç¤ºä¸­å°±è¶Šç›¸è¿‘ï¼Œä¹Ÿå°±è¶Š"ç›¸ä¼¼"ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250830170432509.png" /></p><p>å½“æŠŠæ–‡æœ¬è½¬ä¸ºè¯åµŒå…¥å‘é‡ä¹‹åï¼Œæˆ‘ä»¬çš„è®­ç»ƒæ¨¡å‹å°±å¯ä»¥è¯†åˆ«è¿™äº›æ•°æ®å¹¶åˆ©ç”¨å®ƒä»¬è¿›è¡Œå­¦ä¹ äº†ã€‚</p><p>ä¸€ä¸ªå®Œæ•´çš„æ–‡æœ¬å¤„ç†æ­¥éª¤ï¼Œå¤§æ¦‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š <imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250830170953531.png" /></p><ol type="1"><li><p>è¾“å…¥æ–‡ä»¶<code>This is an example.</code>ï¼šè¿™æ˜¯æ‰€æœ‰å¤„ç†çš„èµ·ç‚¹ï¼Œæ˜¯æˆ‘ä»¬å¸Œæœ›æ¨¡å‹å»ç†è§£å’Œå›åº”çš„åŸå§‹ã€éç»“æ„åŒ–çš„äººç±»è¯­è¨€ã€‚</p></li><li><p>è¯å…ƒåŒ–ï¼šåŸå§‹æ–‡æœ¬è¢«åˆ‡åˆ†æˆç‹¬ç«‹çš„å•å…ƒï¼š<code>This</code>,<code>is</code>, <code>an</code>, <code>example</code>,<code>.</code>ã€‚</p><p>è®¡ç®—æœºæ¨¡å‹æ— æ³•ä¸€æ¬¡æ€§ç†è§£ä¸€æ•´ä¸ªå¥å­ã€‚å®ƒéœ€è¦å°†å¥å­åˆ†è§£æˆæ›´å°çš„ã€æ ‡å‡†åŒ–çš„å•å…ƒï¼Œè¿™äº›å•å…ƒè¢«ç§°ä¸º<strong>è¯å…ƒ(Token)</strong>ã€‚å¦‚å›¾ä¸­çš„æ–‡å­—æè¿°ï¼Œè¯å…ƒæ—¢å¯ä»¥æ˜¯å•è¯ï¼Œä¹Ÿå¯ä»¥æ˜¯æ ‡ç‚¹ç¬¦å·ä¹‹ç±»çš„ç‰¹æ®Šå­—ç¬¦ã€‚</p></li><li><p>è½¬æ¢ä¸ºè¯å…ƒ IDï¼šæ¯ä¸ªè¯å…ƒè¢«æ˜ å°„åˆ°ä¸€ä¸ªå”¯ä¸€çš„æ•´æ•°ï¼š<code>This</code>-&gt; <code>40134</code>, <code>is</code> -&gt; <code>2052</code>,<code>an</code> -&gt; <code>133</code>, <code>example</code> -&gt;<code>389</code>, <code>.</code> -&gt; <code>12</code>ã€‚</p><p>è®¡ç®—æœºä¸è®¤è¯†å­—ç¬¦ä¸² <code>This</code>ï¼Œä½†å®ƒèƒ½é«˜æ•ˆåœ°å¤„ç†æ•°å­—<code>40134</code>ã€‚è¿™ä¸€æ­¥æ˜¯<strong>å°†è¯­è¨€ä¸–ç•Œæ˜ å°„åˆ°æ•°å­—ä¸–ç•Œ</strong>çš„å…³é”®ã€‚æ¯ä¸€ä¸ªID éƒ½å¯¹åº”ç€æ¨¡å‹è¯æ±‡è¡¨ï¼ˆä¸€ä¸ªå·¨å¤§çš„â€œå­—å…¸â€ï¼‰ä¸­çš„ä¸€ä¸ªæ¡ç›®ã€‚</p></li><li><p>ç”Ÿæˆè¯å…ƒåµŒå…¥ï¼šä¸€ä¸²æ•°å­— IDå˜æˆäº†å¤šä¸ªå‘é‡ï¼ˆå…³äºè¯åµŒå…¥çš„å…·ä½“ç»†èŠ‚ï¼Œæˆ‘ä»¬ä¼šåœ¨åç»­è¿›è¡Œå±•å¼€ï¼‰ã€‚</p><p>å³æˆ‘ä»¬å‰é¢æåˆ°çš„ï¼Œå•ä¸ªæ•°å­— IDï¼ˆå¦‚<code>40134</code>ï¼‰æœ¬èº«æ˜¯å­¤ç«‹çš„ï¼Œä¸åŒ…å«ä»»ä½•è¯­ä¹‰ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†å…¶è½¬ä¸ºè¯åµŒå…¥å‘é‡ï¼Œåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæ¨¡å‹ä¼šä¸æ–­è°ƒæ•´è¿™äº›å‘é‡ï¼Œä½¿å¾—<strong>æ„æ€ç›¸è¿‘çš„è¯å…ƒï¼Œå…¶å‘é‡åœ¨ç©ºé—´ä¸­çš„ä½ç½®ä¹Ÿç›¸äº’é è¿‘</strong>ã€‚</p></li><li><p>æ¨¡å‹å¤„ç†ä¸è¾“å‡ºï¼šè¿™äº›åµŒå…¥å‘é‡ç»„æˆçš„åºåˆ—ï¼Œæœ€ç»ˆè¢«é€å…¥<strong>ç±» GPTçš„çº¯è§£ç å™¨ Transformer</strong> ã€‚è¿™æ˜¯æ¨¡å‹çš„æ ¸å¿ƒå¤§è„‘ã€‚Transformeræ¨¡å‹ä¼šåˆ†æè¿™äº›å‘é‡ä¹‹é—´çš„å…³ç³»ï¼Œç†è§£æ•´ä¸ªå¥å­çš„ä¸Šä¸‹æ–‡ï¼Œç„¶åè¿›è¡Œè®¡ç®—ã€‚ç»è¿‡<strong>åç»­å¤„ç†æ­¥éª¤</strong>ï¼ˆå¦‚é€‰æ‹©æ¦‚ç‡æœ€é«˜çš„è¯å…ƒï¼‰åï¼Œæ¨¡å‹ä¼šç”Ÿæˆä¸€ä¸ª<strong>è¾“å‡ºæ–‡æœ¬</strong>ã€‚</p></li></ol><blockquote><p>[!IMPORTANT]</p><p>å°ç»“ä¸€ä¸‹ï¼Œä»<strong>äººç±»è¯­è¨€ (å­—ç¬¦ä¸²) -&gt; è¯­è¨€å•å…ƒ (è¯å…ƒ) -&gt;æœºå™¨è¯­è¨€ (æ•°å­— ID) -&gt; æ•°å­¦å¯¹è±¡ (åµŒå…¥å‘é‡) -&gt;æ¨¡å‹è¾“å…¥</strong>ï¼Œæ¯ä¸€æ­¥éƒ½æ˜¯ä¸ºäº†è®©åŸå§‹çš„ã€éç»“æ„åŒ–çš„æ–‡æœ¬ï¼Œå˜å¾—ç»“æ„åŒ–ã€æ•°å€¼åŒ–ï¼Œå¹¶å¯Œå«è¯­ä¹‰ä¿¡æ¯ï¼Œæœ€ç»ˆæˆä¸ºèƒ½å¤Ÿè¢«ç¥ç»ç½‘ç»œé«˜æ•ˆå¤„ç†çš„åŸæ–™ã€‚</p></blockquote><p>ä¸€ä¸ªç®€å•çš„åˆ†è¯å™¨å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleTokenizer</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, vocab</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="variable language_">self</span>.str_to_int = vocab</span><br><span class="line">        <span class="variable language_">self</span>.int_to_str = &#123;i:s <span class="keyword">for</span> s, i <span class="keyword">in</span> vocab.items()&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encode</span>(<span class="params">self, text</span>):</span><br><span class="line">        preprocessed = re.split(<span class="string">r&#x27;([,.:;?_!&quot;()\&#x27;]|--|\s)&#x27;</span>, text)</span><br><span class="line">        preprocessed = [item.strip() <span class="keyword">for</span> item <span class="keyword">in</span> preprocessed <span class="keyword">if</span> item.strip()]</span><br><span class="line">        preprocessed = [item <span class="keyword">if</span> item <span class="keyword">in</span> <span class="variable language_">self</span>.str_to_int <span class="keyword">else</span> <span class="string">&quot;&lt;|unk|&gt;&quot;</span> <span class="keyword">for</span> item <span class="keyword">in</span> preprocessed]</span><br><span class="line">        ids = [<span class="variable language_">self</span>.str_to_int[s] <span class="keyword">for</span> s <span class="keyword">in</span> preprocessed]</span><br><span class="line">        <span class="keyword">return</span> ids</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decode</span>(<span class="params">self, ids</span>):</span><br><span class="line">        text = <span class="string">&quot; &quot;</span>.join([<span class="variable language_">self</span>.int_to_str[i] <span class="keyword">for</span> i <span class="keyword">in</span> ids])</span><br><span class="line">        <span class="comment"># Remove the spaces before specific punctuation marks.</span></span><br><span class="line">        text = re.sub(<span class="string">r&#x27;\s+([,.?!&quot;()\&#x27;])&#x27;</span>, <span class="string">r&#x27;\1&#x27;</span>, text)</span><br><span class="line">        <span class="keyword">return</span> text</span><br></pre></td></tr></table></figure><ol type="1"><li><code>__init__</code> åˆå§‹åŒ–è¯å…¸ï¼Œé‡Œé¢æ¯ä¸€ä¸ªè¯å…ƒéƒ½å”¯ä¸€å¯¹åº”ä¸€ä¸ªIDï¼›</li><li><code>encode</code> åŸå§‹æ–‡æœ¬è½¬ä¸ºä¸€ç³»åˆ—è¯å…ƒIDï¼Œå¯¹äºä¸è¯†åˆ«çš„è¯å…ƒï¼Œä¼šä½¿ç”¨ <code>&lt;|unk|&gt;</code>ç‰¹æ®Šæ ‡è¯†è¿›è¡Œå ä½ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œè¿˜ä¼šä½¿ç”¨è¯¸å¦‚<code>&lt;|endoftext|&gt;</code>ç­‰ç‰¹æ®Šæ ‡è¯†ç¬¦æ¥è¡¨ç¤ºæ–‡æœ¬ç»“æŸç­‰ç‰¹æ®Šè¯­ä¹‰ã€‚</li><li><code>decode</code> å°†è¯å…ƒ ID åˆ—è¡¨è½¬å›åŸå§‹æ–‡æœ¬ã€‚</li></ol><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250830172025895.png" /></p><p>å›åˆ°æœ¬ç¯‡çš„ä»£ç å®ç°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">token_ids = tokenizer.encode(txt)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ç°æœ‰çš„ Python å¼€æºåº“ <code>tiktoken</code>ï¼Œå®ƒåŸºäºRust çš„æºä»£ç éå¸¸é«˜æ•ˆåœ°å®ç°äº† BPEï¼ˆByte Pair Encoderï¼‰ ç®—æ³•ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tiktoken</span><br><span class="line"></span><br><span class="line">tokenizer = tiktoken.get_encoding(<span class="string">&quot;gpt2&quot;</span>)</span><br><span class="line">text1 = <span class="string">&quot;Hello, do you like tea?&quot;</span></span><br><span class="line">text2 = <span class="string">&quot;In the sunlit terraces of the palace.&quot;</span></span><br><span class="line">text = <span class="string">&quot; &lt;|endoftext|&gt; &quot;</span>.join((text1, text2))</span><br><span class="line">ids = tokenizer.encode(text, allowed_special=&#123;<span class="string">&quot;&lt;|endoftext|&gt;&quot;</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(ids)</span><br><span class="line"><span class="built_in">print</span>(tokenizer.decode(ids))</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[15496, 11, 466, 345, 588, 8887, 30, 220, 50256, 554, 262, 4252, 18250, 8812, 2114, 286, 262, 20562, 13]</span><br><span class="line">Hello, do you like tea? &lt;|endoftext|&gt; In the sunlit terraces of the palace.</span><br></pre></td></tr></table></figure><p>é€šè¿‡è¾“å‡ºï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>&lt;|endoftext|&gt;</code>è¯å…ƒè¢«åˆ†é…äº†ä¸€ä¸ªè¾ƒå¤§çš„è¯å…ƒ IDï¼Œå³ <code>50256</code>ã€‚äº‹å®ä¸Šï¼Œç”¨äºè®­ç»ƒGPT-2ã€GPT-3 å’Œ ChatGPT ä¸­ä½¿ç”¨çš„åŸå§‹æ¨¡å‹çš„ BPE åˆ†è¯å™¨çš„è¯æ±‡æ€»é‡ä¸º<code>50257</code>ï¼Œè¿™æ„å‘³ç€ <code>&lt;|endoftext|&gt;</code>è¢«åˆ†é…äº†æœ€å¤§çš„è¯å…ƒ IDã€‚</p><p>å¦å¤–ï¼ŒBPE åˆ†è¯å™¨å¯ä»¥æ­£ç¡®åœ°ç¼–ç å’Œè§£ç æœªçŸ¥å•è¯ï¼Œæ¯”å¦‚<code>someunknownPlace</code>ã€‚BPEåˆ†è¯å™¨æ˜¯å¦‚ä½•åšåˆ°åœ¨ä¸ä½¿ç”¨&lt;|unk|&gt;è¯å…ƒçš„å‰æä¸‹å¤„ç†ä»»ä½•æœªçŸ¥è¯æ±‡çš„å‘¢ï¼Ÿ</p><p>BPEç®—æ³•çš„åŸç†æ˜¯å°†ä¸åœ¨é¢„å®šä¹‰è¯æ±‡è¡¨ä¸­çš„å•è¯åˆ†è§£ä¸ºæ›´å°çš„å­è¯å•å…ƒç”šè‡³å•ä¸ªå­—ç¬¦ï¼Œä»è€Œèƒ½å¤Ÿå¤„ç†è¯æ±‡è¡¨ä¹‹å¤–çš„å•è¯ã€‚å› æ­¤ï¼Œå¾—ç›Šäº BPEç®—æ³•ï¼Œå¦‚æœåˆ†è¯å™¨åœ¨åˆ†è¯è¿‡ç¨‹ä¸­é‡åˆ°ä¸ç†Ÿæ‚‰çš„å•è¯ï¼Œå®ƒå¯ä»¥å°†å…¶è¡¨ç¤ºä¸ºå­è¯è¯å…ƒæˆ–å­—ç¬¦åºåˆ—ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250830172322896.png" /></p><p>å°†æœªçŸ¥å•è¯åˆ†è§£ä¸ºå•ä¸ªå­—ç¬¦çš„èƒ½åŠ›ç¡®ä¿äº†åˆ†è¯å™¨ä»¥åŠç”¨å…¶è®­ç»ƒçš„å¤§è¯­è¨€æ¨¡å‹èƒ½å¤Ÿå¤„ç†ä»»ä½•æ–‡æœ¬ï¼Œå³ä½¿æ–‡æœ¬ä¸­åŒ…å«è®­ç»ƒæ•°æ®ä¸­ä¸å­˜åœ¨çš„å•è¯ã€‚</p><h4 id="æ»‘åŠ¨çª—å£è¿›è¡Œæ•°æ®é‡‡æ ·">1.2.2.2 æ»‘åŠ¨çª—å£è¿›è¡Œæ•°æ®é‡‡æ ·</h4><p>åˆ†æå®Œäº†è¯å…ƒåŒ–çš„èƒŒååº•å±‚é€»è¾‘åï¼Œæˆ‘ä»¬æ¥çœ‹è¿™ä¸€éƒ¨åˆ†çš„ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GPTDataset</span>(<span class="title class_ inherited__">Dataset</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, txt, tokenizer, max_length, stride</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># ä½¿ç”¨æ»‘åŠ¨çª—å£åˆ›å»ºè®­ç»ƒæ ·æœ¬</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(token_ids) - max_length, stride):</span><br><span class="line">            input_chunk = token_ids[i:i+max_length]</span><br><span class="line">            target_chunk = token_ids[i+<span class="number">1</span>:i+max_length+<span class="number">1</span>]</span><br><span class="line">            <span class="variable language_">self</span>.input_ids.append(torch.tensor(input_chunk))</span><br><span class="line">            <span class="variable language_">self</span>.target_ids.append(torch.tensor(target_chunk))</span><br></pre></td></tr></table></figure><p>è¦ç†è§£è¿™æ®µä»£ç ï¼Œæˆ‘ä»¬éœ€è¦å›å½’åˆ°å¤§è¯­è¨€æ¨¡å‹ï¼ˆæ–‡æœ¬æ¨¡å‹ï¼‰æ˜¯å”¯ä¸€ä»»åŠ¡ï¼š<strong><u>æ ¹æ®ä½ ç»™å‡ºçš„ä¸Šæ–‡ï¼ŒçŒœå‡ºä¸‹ä¸€ä¸ªè¯åº”è¯¥æ˜¯ä»€ä¹ˆ</u></strong>ã€‚</p><p>ä¾‹å¦‚ï¼Œå¯¹äºå¥å­<code>Time is an illusion</code>ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæ¨¡å‹åˆ¶ä½œå¦‚ä¸‹ä¸€ç³»åˆ—çš„ç»ƒä¹ é¢˜ï¼š</p><ul><li><strong>é—®é¢˜</strong>ï¼š<code>Time</code> -&gt;<strong>ç­”æ¡ˆ</strong>ï¼š<code>is</code></li><li><strong>é—®é¢˜</strong>ï¼š<code>Time is</code> -&gt;<strong>ç­”æ¡ˆ</strong>ï¼š<code>an</code></li><li><strong>é—®é¢˜</strong>ï¼š<code>Time is an</code> -&gt;<strong>ç­”æ¡ˆ</strong>ï¼š<code>illusion</code></li></ul><p>æ¨¡å‹éœ€è¦é€šè¿‡æµ·é‡çš„è¿™ç±»"é—®ç­”å¯¹"è¿›è¡Œç»ƒä¹ ï¼Œæ‰èƒ½é€æ¸æŒæ¡è¯­è¨€çš„è§„å¾‹ã€‚å¦‚æœæ‰‹åŠ¨å»åˆ¶ä½œä¸Šäº¿ä¸ªè¿™æ ·çš„é—®ç­”å¯¹ï¼Œæ˜¾ç„¶æ˜¯ä¸ç°å®çš„ã€‚ä»£ç ä¸­çš„"æ»‘åŠ¨çª—å£"æœºåˆ¶ï¼Œå°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æˆ‘ä»¬ç”¨ä¸€ä¸ªå…·ä½“çš„ä¾‹å­æ¥è§£é‡Šè¿™ä¸ª<code>for</code> å¾ªç¯ï¼š</p><ul><li>å‡è®¾ <code>max_length = 5</code></li><li>å‡è®¾ä¸€æ®µæ–‡æœ¬åˆ†è¯åçš„ <code>token_ids</code> æ˜¯<code>[10, 20, 30, 40, 50, 60]</code></li></ul><p>å½“ <code>for</code> å¾ªç¯ç¬¬ä¸€æ¬¡æ‰§è¡Œæ—¶ (<code>i=0</code>)ï¼š</p><ul><li><strong><code>input_chunk = token_ids[0:5]</code></strong> ä¼šåˆ‡å‡º<code>[10, 20, 30, 40, 50]</code><ul><li>è¿™å°±æ˜¯æä¾›ç»™æ¨¡å‹çš„<strong>ä¸Šä¸‹æ–‡</strong>ï¼Œä¹Ÿå°±æ˜¯<strong>é—®é¢˜</strong>ã€‚</li></ul></li><li><strong><code>target_chunk = token_ids[1:6]</code></strong> ä¼šåˆ‡å‡º<code>[20, 30, 40, 50, 60]</code><ul><li>è¿™å°±æ˜¯æ¨¡å‹éœ€è¦é¢„æµ‹çš„<strong>æ­£ç¡®ç­”æ¡ˆ</strong>ã€‚</li></ul></li></ul><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250830172936403.png" alt="æ»‘åŠ¨çª—å£ç¤ºæ„å›¾" style="zoom:33%;" /></p><p>æ‰€ä»¥æˆ‘ä»¬é€šè¿‡è¿™æ ·ä¸€ä¸ª for å¾ªç¯ï¼Œå°±å¯ä»¥æ ¹æ®ä¼ å…¥çš„æ–‡æœ¬ <code>txt</code>å¿«é€Ÿç”Ÿæˆå¤§é‡çš„<strong>è¾“å…¥-ç›®æ ‡å¯¹</strong>ä¾›ç»™æ¨¡å‹è¿›è¡Œè®­ç»ƒå’Œæ£€éªŒã€‚</p><hr /><blockquote><p>[!IMPORTANT]</p><p>å›åˆ° <code>prepare_train_and_val_data</code>å‡½æ•°ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥ç”¨ä¸€å¥è¯æ¦‚æ‹¬å®ƒçš„å…¨éƒ¨å·¥ä½œï¼š<strong>å®ƒæ˜¯ä¸€ä¸ªæ•°æ®å‡†å¤‡æ€»ç®¡ï¼Œè´Ÿè´£å°†ä¸€æœ¬åŸå§‹å°è¯´ï¼Œä¸¥æ ¼åˆ’åˆ†ä¸ºç”¨äºå­¦ä¹ çš„è®­ç»ƒé›†å’Œç”¨äºè€ƒè¯•çš„éªŒè¯é›†ï¼Œå¹¶æœ€ç»ˆå°†å®ƒä»¬éƒ½åŠ å·¥æˆæ¨¡å‹å¯ä»¥ç›´æ¥ä½¿ç”¨çš„ã€ä¸€æ‰¹ä¸€æ‰¹çš„ã€åŒ…å«(è¾“å…¥-ç›®æ ‡)å¯¹çš„æ ‡å‡†åŒ–æ•°æ®ä¼ é€å¸¦ã€‚</strong></p></blockquote><h1 id="åˆå§‹åŒ–æ¨¡å‹ä¸ä¼˜åŒ–å™¨">2. åˆå§‹åŒ–æ¨¡å‹ä¸ä¼˜åŒ–å™¨</h1><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250831134830004.png" style="zoom:33%;" /></p><ol type="1"><li><code>GPTModel()</code> åˆå§‹åŒ–ä¸€ä¸ª GPT æ¨¡å‹å®ä¾‹ï¼›</li><li><code>model.to(device)</code> æ˜¯ PyTorchä¸­ç”¨äºå°†æ¨¡å‹ç§»åŠ¨åˆ°æŒ‡å®šè®¾å¤‡ï¼ˆCPU æˆ– GPUï¼‰çš„æ–¹æ³•ï¼Œæ·±åº¦å­¦ä¹ æ¨¡å‹åœ¨ GPUä¸Šè®­ç»ƒé€Ÿåº¦æ¯” CPUå¿«å¾ˆå¤šï¼Œé€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥ç¡®ä¿æ¨¡å‹å’Œè¾“å…¥æ•°æ®åœ¨åŒä¸€ä¸ªè®¾å¤‡ä¸Šã€‚</li><li><code>torch.optim.AdamW()</code>åˆ›å»ºä¸€ä¸ªä¼˜åŒ–å™¨ï¼ˆoptimizerï¼‰ï¼Œç”¨äºè®­ç»ƒç¥ç»ç½‘ç»œæ¨¡å‹ã€‚<code>AdamW</code>æ˜¯ä¸€ç§ä¼˜åŒ–ç®—æ³•ï¼Œåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œä¼˜åŒ–å™¨ä¼šæ¥æ”¶æŸå¤±å‡½æ•°è®¡ç®—å‡ºçš„æ¢¯åº¦ã€ä½¿ç”¨AdamWç®—æ³•æ›´æ–°æ¨¡å‹å‚æ•°å’Œå¸®åŠ©æ¨¡å‹é€æ­¥æ”¶æ•›åˆ°æœ€ä¼˜è§£ã€‚åœ¨æœ¬ç¯‡ä¸­ï¼Œæˆ‘ä»¬ä¸å¯¹è¿™ä¸ªè¿›è¡Œè¿‡å¤šçš„è§£é‡Šï¼Œå› ä¸ºè¿™å¹¶ä¸åœ¨æˆ‘ä»¬çš„æ ¸å¿ƒå­¦ä¹ ç›®æ ‡ä¸Šã€‚</li></ol><h2 id="æ¨¡å‹é…ç½®">2.1 æ¨¡å‹é…ç½®</h2><p>åœ¨æ·±å…¥ä»£ç ç»†èŠ‚ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ <code>GPT_CONFIG_124M</code>è¿™ä¸ª<strong>é…ç½®å­—å…¸</strong>ã€‚å®ƒå°±åƒæ˜¯å»ºé€  GPTæ¨¡å‹å¤§å¦çš„<strong>è®¾è®¡è“å›¾</strong>ï¼Œå®šä¹‰äº†æ¨¡å‹çš„è§„æ¨¡å’Œæ‰€æœ‰å…³é”®å‚æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GPT_CONFIG_124M = &#123;</span><br><span class="line">    <span class="string">&quot;vocab_size&quot;</span>: <span class="number">50257</span>,    <span class="comment"># è¯æ±‡è¡¨å¤§å°</span></span><br><span class="line">    <span class="string">&quot;context_length&quot;</span>: <span class="number">256</span>,  <span class="comment"># ä¸Šä¸‹æ–‡é•¿åº¦</span></span><br><span class="line">    <span class="string">&quot;emb_dim&quot;</span>: <span class="number">768</span>,         <span class="comment"># åµŒå…¥ç»´åº¦</span></span><br><span class="line">    <span class="string">&quot;n_heads&quot;</span>: <span class="number">12</span>,          <span class="comment"># æ³¨æ„åŠ›å¤´æ•°é‡</span></span><br><span class="line">    <span class="string">&quot;n_layers&quot;</span>: <span class="number">12</span>,         <span class="comment"># Transformerå±‚æ•°</span></span><br><span class="line">    <span class="string">&quot;drop_rate&quot;</span>: <span class="number">0.1</span>,       <span class="comment"># dropoutç‡</span></span><br><span class="line">    <span class="string">&quot;qkv_bias&quot;</span>: <span class="literal">False</span>       <span class="comment"># QKVçº¿æ€§å±‚æ˜¯å¦ä½¿ç”¨åç½®</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p><code>vocab_size</code>: è¯æ±‡è¡¨é‡Œæœ‰å¤šå°‘ä¸ªä¸åŒçš„è¯å…ƒ(Token)ã€‚<code>50257</code> æ˜¯ GPT-2ä½¿ç”¨çš„æ ‡å‡†è¯æ±‡è¡¨å¤§å°ï¼Œå³æˆ‘ä»¬å‰é¢è®¨è®ºçš„ BPE åˆ†è¯å™¨çš„è¯æ±‡è¡¨å¤§å°ã€‚</p></li><li><p><code>context_length</code>:æ¨¡å‹ä¸€æ¬¡èƒ½å¤„ç†çš„<strong>æœ€é•¿æ–‡æœ¬é•¿åº¦</strong>ï¼ˆä»¥è¯å…ƒè®¡ï¼‰ã€‚è¿™é‡Œæ˜¯256ï¼Œæ„å‘³ç€æ¨¡å‹ä¸€æ¬¡æœ€å¤šèƒ½çœ‹ 256 ä¸ªè¯å…ƒã€‚</p></li><li><p><code>emb_dim</code>:<strong>åµŒå…¥ç»´åº¦</strong>ã€‚è¿™æ˜¯æ¨¡å‹å†…éƒ¨è¡¨ç¤ºæ¯ä¸ªè¯å…ƒçš„å‘é‡é•¿åº¦ã€‚768ç»´æ„å‘³ç€æ¯ä¸ªè¯éƒ½ä¼šè¢«è½¬æ¢æˆä¸€ä¸ªåŒ…å« 768ä¸ªæ•°å­—çš„å‘é‡ï¼Œè¿™æ˜¯æ¨¡å‹ç†è§£è¯­è¨€çš„åŸºç¡€ã€‚</p></li><li><p><code>n_heads</code> å’Œ <code>n_layers</code>:è¿™ä¸¤ä¸ªå‚æ•°å…±åŒå†³å®šäº†æ¨¡å‹çš„<strong>æ·±åº¦å’Œå®½åº¦</strong>ã€‚<code>n_layers=12</code>è¡¨ç¤ºæˆ‘ä»¬çš„æ¨¡å‹ä¼šå †å  12 ä¸ª <code>TransformerBlock</code>ï¼Œè€Œ<code>n_heads=12</code> è¡¨ç¤ºåœ¨æ¯ä¸ª Block å†…éƒ¨çš„æ³¨æ„åŠ›æœºåˆ¶éƒ½æœ‰ 12ä¸ª"å¤´"ï¼Œè®©æ¨¡å‹èƒ½ä»å¤šä¸ªè§’åº¦åˆ†ææ–‡æœ¬ã€‚</p></li><li><p><code>drop_rate</code>: Dropoutæ¯”ç‡ã€‚è¿™æ˜¯é˜²æ­¢æ¨¡å‹è¿‡æ‹Ÿåˆçš„é‡è¦æŠ€æœ¯ã€‚0.1 è¡¨ç¤ºåœ¨è®­ç»ƒæ—¶ï¼Œæ¯ä¸ªç¥ç»å…ƒæœ‰ 10%çš„æ¦‚ç‡è¢«ä¸´æ—¶"å…³é—­"ï¼Œè¿«ä½¿æ¨¡å‹å­¦ä¹ æ›´é²æ£’çš„ç‰¹å¾è¡¨ç¤ºã€‚</p></li><li><p><code>qkv_bias</code>:æŸ¥è¯¢-é”®-å€¼åç½®ã€‚è¿™ä¸ªå‚æ•°æ§åˆ¶æ˜¯å¦åœ¨æ³¨æ„åŠ›è®¡ç®—ä¸­æ·»åŠ åç½®é¡¹ã€‚Falseè¡¨ç¤ºä¸ä½¿ç”¨åç½®ï¼Œè¿™æ˜¯ GPT-2 çš„è®¾è®¡é€‰æ‹©ï¼Œå¯èƒ½æœ‰åŠ©äºæ¨¡å‹çš„ç¨³å®šæ€§ã€‚</p></li></ul><blockquote><p>æœ‰äº›æ¦‚å¿µä½ å¯èƒ½è¿˜ä¸è®¤è¯†ï¼Œæ²¡å…³ç³»ï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹ï¼Œå¾…ä¼šå°±æ‡‚äº†ï¼Â· Â·</p></blockquote><h2 id="æ¨¡å‹ç»“æ„æ€»è§ˆ">2.2 æ¨¡å‹ç»“æ„æ€»è§ˆ</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GPTModel</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å®Œæ•´çš„GPTæ¨¡å‹å®ç°&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, cfg</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="variable language_">self</span>.tok_emb = nn.Embedding(cfg[<span class="string">&quot;vocab_size&quot;</span>], cfg[<span class="string">&quot;emb_dim&quot;</span>])</span><br><span class="line">        <span class="variable language_">self</span>.pos_emb = nn.Embedding(cfg[<span class="string">&quot;context_length&quot;</span>], cfg[<span class="string">&quot;emb_dim&quot;</span>])</span><br><span class="line">        <span class="variable language_">self</span>.drop_emb = nn.Dropout(cfg[<span class="string">&quot;drop_rate&quot;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å †å å¤šä¸ªTransformerå—</span></span><br><span class="line">        <span class="variable language_">self</span>.trf_blocks = nn.Sequential(</span><br><span class="line">            *[TransformerBlock(cfg) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(cfg[<span class="string">&quot;n_layers&quot;</span>])],</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.final_norm = LayerNorm(cfg[<span class="string">&quot;emb_dim&quot;</span>])</span><br><span class="line">        <span class="variable language_">self</span>.out_head = nn.Linear(cfg[<span class="string">&quot;emb_dim&quot;</span>], cfg[<span class="string">&quot;vocab_size&quot;</span>], bias=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, in_idx</span>):</span><br><span class="line">        batch_size, seq_len = in_idx.shape</span><br><span class="line">        <span class="comment"># è¯åµŒå…¥ + ä½ç½®åµŒå…¥</span></span><br><span class="line">        tok_embeds = <span class="variable language_">self</span>.tok_emb(in_idx)</span><br><span class="line">        pos_embeds = <span class="variable language_">self</span>.pos_emb(torch.arange(seq_len, device=in_idx.device))</span><br><span class="line">        x = tok_embeds + pos_embeds</span><br><span class="line">        x = <span class="variable language_">self</span>.drop_emb(x)</span><br><span class="line">        x = <span class="variable language_">self</span>.trf_blocks(x)</span><br><span class="line">        x = <span class="variable language_">self</span>.final_norm(x)</span><br><span class="line">        logits = <span class="variable language_">self</span>.out_head(x)</span><br><span class="line">        <span class="keyword">return</span> logits</span><br></pre></td></tr></table></figure><p>æ•´ä¸ª GPT æ¨¡å‹çš„æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250830175651213.png" /></p><p><code>GPTModel</code>ç±»æ˜¯æ•´ä¸ªè¯­è¨€æ¨¡å‹çš„é¡¶å±‚å°è£…ï¼Œå…¶è®¾è®¡ç›®æ ‡æ˜¯æ„å»ºä¸€ä¸ª<strong>ç«¯åˆ°ç«¯çš„ã€å…·å¤‡è‡ªå›å½’ï¼ˆauto-regressiveï¼‰ç”Ÿæˆèƒ½åŠ›</strong>çš„åºåˆ—å¤„ç†æ¶æ„ã€‚ä»æ ¹æœ¬ä¸Šè¯´ï¼Œä»»ä½•ä¸€ä¸ªæ­¤ç±»æ¨¡å‹éƒ½å¿…é¡»è§£å†³ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š</p><ol type="1"><li><strong>è¾“å…¥è¡¨ç¤º (InputRepresentation)</strong>ï¼šå¦‚ä½•å°†ç¦»æ•£çš„ã€ä¸€ç»´çš„è¯å…ƒ IDåºåˆ—ï¼Œè½¬åŒ–ä¸ºæ¨¡å‹èƒ½å¤Ÿå¤„ç†çš„ã€å¯Œå«ä¿¡æ¯çš„è¿ç»­å¤šç»´å‘é‡ï¼Ÿ</li><li><strong>ä¸Šä¸‹æ–‡ç¼–ç  (ContextualEncoding)</strong>ï¼šå¦‚ä½•å¯¹è¾“å…¥åºåˆ—ä¸­çš„æ¯ä¸ªå…ƒç´ è¿›è¡Œæ·±åº¦å¤„ç†ï¼Œä½¿å…¶å‘é‡è¡¨ç¤ºèƒ½å¤Ÿå……åˆ†èåˆæ•´ä¸ªåºåˆ—ï¼ˆå°¤å…¶æ˜¯å…¶ä¸Šæ–‡ï¼‰çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Ÿ</li><li><strong>è¾“å‡ºæŠ•å½± (OutputProjection)</strong>ï¼šå¦‚ä½•å°†æ¨¡å‹å†…éƒ¨ç»è¿‡æ·±åº¦å¤„ç†çš„ä¸Šä¸‹æ–‡å‘é‡ï¼Œé‡æ–°æ˜ å°„å›è¯æ±‡è¡¨ç©ºé—´ï¼Œä»¥ç”Ÿæˆå¯¹ä¸‹ä¸€ä¸ªè¯å…ƒçš„æ¦‚ç‡é¢„æµ‹ï¼Ÿ</li></ol><p><code>GPTModel</code>çš„ç»“æ„æ­£æ˜¯å›´ç»•è¿™ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜ï¼Œåˆ’åˆ†æˆäº†ä¸‰ä¸ªé€»è¾‘æ¸…æ™°çš„åŠŸèƒ½åŒºå—ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GPTModel</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, cfg</span>):</span><br><span class="line">        <span class="comment"># åŒºå—ä¸€ï¼šè¾“å…¥è¡¨ç¤ºå±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.tok_emb = nn.Embedding(...)</span><br><span class="line">        <span class="variable language_">self</span>.pos_emb = nn.Embedding(...)</span><br><span class="line">        <span class="variable language_">self</span>.drop_emb = nn.Dropout(...)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># åŒºå—äºŒï¼šä¸Šä¸‹æ–‡ç¼–ç å™¨å †æ ˆ</span></span><br><span class="line">        <span class="variable language_">self</span>.trf_blocks = nn.Sequential(...)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># åŒºå—ä¸‰ï¼šè¾“å‡ºæŠ•å½±å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.final_norm = LayerNorm(...)</span><br><span class="line">        <span class="variable language_">self</span>.out_head = nn.Linear(...)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, in_idx</span>):</span><br><span class="line">        <span class="comment"># æ‰§è¡ŒåŒºå—ä¸€çš„åŠŸèƒ½</span></span><br><span class="line">        tok_embeds = <span class="variable language_">self</span>.tok_emb(in_idx)</span><br><span class="line">        pos_embeds = <span class="variable language_">self</span>.pos_emb(...)</span><br><span class="line">        x = tok_embeds + pos_embeds</span><br><span class="line">        x = <span class="variable language_">self</span>.drop_emb(x)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ‰§è¡ŒåŒºå—äºŒçš„åŠŸèƒ½</span></span><br><span class="line">        x = <span class="variable language_">self</span>.trf_blocks(x)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ‰§è¡ŒåŒºå—ä¸‰çš„åŠŸèƒ½</span></span><br><span class="line">        x = <span class="variable language_">self</span>.final_norm(x)</span><br><span class="line">        logits = <span class="variable language_">self</span>.out_head(x)</span><br><span class="line">        <span class="keyword">return</span> logits</span><br></pre></td></tr></table></figure><h2 id="è¾“å…¥è¡¨ç¤ºå±‚ä»ç¦»æ•£ç¬¦å·åˆ°æƒ…å¢ƒåŒ–å‘é‡">2.3è¾“å…¥è¡¨ç¤ºå±‚ï¼šä»ç¦»æ•£ç¬¦å·åˆ°æƒ…å¢ƒåŒ–å‘é‡</h2><p>æ•°æ®æµçš„ç¬¬ä¸€æ­¥æ˜¯å°†è¾“å…¥çš„è¯å…ƒç´¢å¼• <code>in_idx</code>è½¬æ¢ä¸ºåŒ…å«ä½ç½®ä¿¡æ¯çš„å‘é‡è¡¨ç¤ºã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># GPTModel forward æ–¹æ³•çš„èµ·å§‹éƒ¨åˆ†</span></span><br><span class="line">tok_embeds = <span class="variable language_">self</span>.tok_emb(in_idx)</span><br><span class="line">pos_embeds = <span class="variable language_">self</span>.pos_emb(torch.arange(seq_len, device=in_idx.device))</span><br><span class="line">x = tok_embeds + pos_embeds</span><br><span class="line">x = <span class="variable language_">self</span>.drop_emb(x)</span><br></pre></td></tr></table></figure><h3 id="è¯å…ƒåµŒå…¥">2.3.1 è¯å…ƒåµŒå…¥</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">self</span>.tok_emb = nn.Embedding(cfg[<span class="string">&quot;vocab_size&quot;</span>], cfg[<span class="string">&quot;emb_dim&quot;</span>])</span><br></pre></td></tr></table></figure><p>æ­£å¦‚å‰æ–‡æ‰€è¯´çš„ï¼Œè®¡ç®—æœºæ— æ³•ç›´æ¥å¤„ç†"å•è¯"è¿™æ ·çš„ç¬¦å·ã€‚ä¸ºäº†è¿›è¡Œæ•°å­¦è¿ç®—ï¼Œå¿…é¡»å°†æ¯ä¸ªç¦»æ•£çš„è¯å…ƒæ˜ å°„åˆ°ä¸€ä¸ªé«˜ç»´çš„è¿ç»­å‘é‡ç©ºé—´ä¸­ã€‚è¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¸ºåµŒå…¥(Embedding)ã€‚<code>nn.Embedding</code>æ˜¯ä¸€ä¸ªç®€å•çš„æŸ¥æ‰¾è¡¨ã€‚å®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæƒé‡çŸ©é˜µï¼Œç»´åº¦ä¸º<code>(vocab_size, emb_dim)</code>ã€‚è¾“å…¥ä¸€ä¸ªè¯å…ƒçš„ç´¢å¼•ï¼Œå®ƒä¼šè¿”å›è¯¥ç´¢å¼•å¯¹åº”çš„è¡Œå‘é‡ã€‚è¿™ä¸ªå‘é‡æ˜¯å¯è®­ç»ƒçš„ï¼Œæ¨¡å‹åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ä¼šä¸æ–­è°ƒæ•´è¿™äº›å‘é‡ï¼Œä½¿å¾—åœ¨å‘é‡ç©ºé—´ä¸­è¯­ä¹‰ç›¸è¿‘çš„è¯å…ƒå½¼æ­¤é è¿‘ã€‚</p><h3 id="ä½ç½®åµŒå…¥">2.3.2 ä½ç½®åµŒå…¥</h3><p>ç†è®ºä¸Šï¼Œè¯å…ƒåµŒå…¥éå¸¸é€‚åˆä½œä¸ºå¤§è¯­è¨€æ¨¡å‹çš„è¾“å…¥ã€‚ç„¶è€Œï¼Œå¤§è¯­è¨€æ¨¡å‹å­˜åœ¨ä¸€ä¸ªå°ç¼ºé™·â€”â€”å®ƒä»¬çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶ï¼ˆè§åæ–‡ï¼‰æ— æ³•æ„ŸçŸ¥è¯å…ƒåœ¨åºåˆ—ä¸­çš„ä½ç½®æˆ–é¡ºåºã€‚åµŒå…¥å±‚çš„å·¥ä½œæœºåˆ¶æ˜¯ï¼Œæ— è®ºè¯å…ƒID åœ¨è¾“å…¥åºåˆ—ä¸­çš„ä½ç½®å¦‚ä½•ï¼Œç›¸åŒçš„è¯å…ƒ IDå§‹ç»ˆè¢«æ˜ å°„åˆ°ç›¸åŒçš„å‘é‡è¡¨ç¤ºï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250830193802429.png" /></p><p>ä¸¾ä¸ªæœ€ç®€å•çš„ä¾‹å­ï¼š"äººå’¬ç‹—"å’Œ"ç‹—å’¬äºº"åœ¨ä¸Šè¿°æœºåˆ¶çœ‹æ¥ï¼ŒåŒ…å«çš„è¯å…ƒé›†åˆæ˜¯ç›¸åŒçš„ã€‚ç„¶è€Œï¼Œé¡ºåºåœ¨è‡ªç„¶è¯­è¨€ä¸­è‡³å…³é‡è¦ã€‚</p><p>ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œå¯ä»¥å°†ä½ç½®ä¿¡æ¯è¿›è¡ŒåµŒå…¥ï¼Œä¸€èˆ¬æœ‰ä»¥ä¸‹ 3ç§ä½ç½®åµŒå…¥æ–¹å¼ï¼š</p><ul><li><strong>ç»å¯¹ä½ç½®åµŒå…¥ (absolute positionalembedding)</strong>ï¼šç›´æ¥ä¸åºåˆ—ä¸­çš„ç‰¹å®šä½ç½®ç›¸å…³è”ã€‚å¯¹äºè¾“å…¥åºåˆ—çš„æ¯ä¸ªä½ç½®ï¼Œè¯¥æ–¹æ³•éƒ½ä¼šå‘å¯¹åº”è¯å…ƒçš„åµŒå…¥å‘é‡ä¸­æ·»åŠ ä¸€ä¸ªç‹¬ç‰¹çš„ä½ç½®åµŒå…¥ï¼Œä»¥æ˜ç¡®æŒ‡ç¤ºå…¶åœ¨åºåˆ—ä¸­çš„ç¡®åˆ‡ä½ç½®ã€‚ä¾‹å¦‚ï¼Œåºåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªè¯å…ƒä¼šæœ‰ä¸€ä¸ªç‰¹å®šçš„ä½ç½®åµŒå…¥ï¼Œç¬¬äºŒä¸ªè¯å…ƒåˆ™ä¼šæœ‰å¦ä¸€ä¸ªä¸åŒçš„ä½ç½®åµŒå…¥ï¼Œä»¥æ­¤ç±»æ¨ã€‚è¿™ç§æ–¹å¼å¯ä»¥æ˜¯å¯å­¦ä¹ çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯é€šè¿‡å›ºå®šçš„æ•°å­¦å‡½æ•°ï¼ˆå¦‚æ­£å¼¦/ä½™å¼¦å‡½æ•°ï¼‰ç”Ÿæˆçš„ã€‚</li><li><strong>ç›¸å¯¹ä½ç½®åµŒå…¥ (relative positionalembedding)</strong>ï¼šå…³æ³¨çš„æ˜¯è¯å…ƒä¹‹é—´çš„ç›¸å¯¹ä½ç½®æˆ–è·ç¦»ï¼Œè€Œéå®ƒä»¬çš„ç»å¯¹ä½ç½®ã€‚è¯¥æ–¹æ³•é€šå¸¸åœ¨è®¡ç®—æ³¨æ„åŠ›åˆ†æ•°æ—¶ï¼Œå¼•å…¥ä¸€ä¸ªä¸è¯å…ƒé—´è·ç¦»ç›¸å…³çš„åç½®é¡¹ï¼Œä»è€Œè®©æ¨¡å‹å­¦ä¹ çš„æ˜¯è¯å…ƒä¹‹é—´çš„"é—´éš”"å…³ç³»ï¼Œè€Œä¸æ˜¯å®ƒä»¬åœ¨åºåˆ—ä¸­çš„"å…·ä½“åæ ‡"ã€‚è¿™ç§æ–¹æ³•ä½¿å¾—æ¨¡å‹èƒ½å¤Ÿæ›´å¥½åœ°é€‚åº”ä¸åŒé•¿åº¦ï¼ˆåŒ…æ‹¬åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ä»æœªè§è¿‡çš„é•¿åº¦ï¼‰çš„åºåˆ—ã€‚</li><li><strong>æ—‹è½¬ä½ç½®åµŒå…¥ (Rotary Positional Embedding,RoPE)</strong>ï¼šé€šè¿‡ä¸€ç§åˆ›æ–°çš„æ–¹å¼å°†ä½ç½®ä¿¡æ¯èå…¥è‡ªæ³¨æ„åŠ›æœºåˆ¶ä¸­ã€‚å®ƒå¹¶éå°†ä½ç½®å‘é‡ç›´æ¥æ·»åŠ åˆ°è¯å…ƒåµŒå…¥ä¸Šï¼Œè€Œæ˜¯æ ¹æ®è¯å…ƒçš„ç»å¯¹ä½ç½®ï¼Œå¯¹å…¶åœ¨æ³¨æ„åŠ›è®¡ç®—ä¸­ä½¿ç”¨çš„æŸ¥è¯¢ï¼ˆQueryï¼‰å’Œé”®ï¼ˆKeyï¼‰å‘é‡è¿›è¡Œæ—‹è½¬ã€‚è¿™ç§ç²¾å¦™çš„æ—‹è½¬æ“ä½œä½¿å¾—ä»»æ„ä¸¤ä¸ªè¯å…ƒä¹‹é—´çš„æ³¨æ„åŠ›åˆ†æ•°ï¼Œèƒ½å¤Ÿè‡ªç„¶åœ°è¡¨ç¤ºå‡ºå®ƒä»¬çš„ç›¸å¯¹ä½ç½®å…³ç³»ï¼Œä»è€Œè®©æ¨¡å‹åœ¨å¤„ç†ä½ç½®ä¿¡æ¯æ—¶æ—¢é«˜æ•ˆåˆå…·å¤‡å¼ºå¤§çš„é•¿åº¦æ³›åŒ–èƒ½åŠ›ã€‚</li></ul><p>GPT-2é‡‡ç”¨çš„æ˜¯å¯å­¦ä¹ çš„ç»å¯¹ä½ç½®åµŒå…¥ï¼Œè¿™ç§æ–¹å¼ç®€å•ç›´æ¥ï¼Œæ¨¡å‹å¯ä»¥åœ¨è®­ç»ƒä¸­è‡ªè¡Œå­¦ä¼šæ¯ä¸ªä½ç½®çš„'åæ ‡'ä¿¡æ¯ï¼Œå¯¹äºå…¶è®¾è®¡çš„å›ºå®šä¸Šä¸‹æ–‡é•¿åº¦ï¼ˆå¦‚1024ï¼‰æ¥è¯´å·²ç»è¶³å¤Ÿæœ‰æ•ˆã€‚è€Œåƒ RoPEè¿™æ ·çš„ç›¸å¯¹ä½ç½®åµŒå…¥ï¼Œåˆ™åœ¨å¤„ç†è¶…é•¿æ–‡æœ¬å’Œæå‡é•¿åº¦æ³›åŒ–èƒ½åŠ›æ–¹é¢è¡¨ç°æ›´ä¼˜ï¼Œå› æ­¤è¢«Llama ç­‰æ›´æ–°çš„æ¨¡å‹æ‰€é‡‡ç”¨ã€‚</p><p>æœ¬ä¹¦ä½¿ç”¨çš„æ˜¯<strong>ç»å¯¹ä½ç½®åµŒå…¥</strong>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GPTModel</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å®Œæ•´çš„GPTæ¨¡å‹å®ç°&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, cfg</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">        <span class="variable language_">self</span>.pos_emb = nn.Embedding(cfg[<span class="string">&quot;context_length&quot;</span>], cfg[<span class="string">&quot;emb_dim&quot;</span>])</span><br><span class="line">        <span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, in_idx</span>):</span><br><span class="line">        <span class="comment"># ...</span></span><br><span class="line">        pos_embeds = <span class="variable language_">self</span>.pos_emb(torch.arange(seq_len, device=in_idx.device))</span><br><span class="line">        x = tok_embeds + pos_embeds</span><br><span class="line">        <span class="comment"># ...</span></span><br></pre></td></tr></table></figure><ol type="1"><li><strong>å‚æ•°åˆå§‹åŒ–</strong>ï¼š<code>self.pos_emb = nn.Embedding(cfg["context_length"], cfg["emb_dim"])</code>è¿™è¡Œä»£ç ä¼šåˆå§‹åŒ–ä¸€ä¸ªæƒé‡çŸ©é˜µï¼Œä¹Ÿç§°ä¸ºæŸ¥æ‰¾è¡¨ã€‚è¯¥çŸ©é˜µçš„ç»´åº¦æ˜¯<code>(context_length, emb_dim)</code>ã€‚çŸ©é˜µçš„æ¯ä¸€è¡Œéƒ½æ˜¯ä¸€ä¸ªå‘é‡ï¼Œä¸”æ¯ä¸€è¡Œéƒ½å”¯ä¸€å¯¹åº”ä¸€ä¸ªä»<code>0</code> åˆ° <code>context_length - 1</code>çš„ç»å¯¹ä½ç½®ç´¢å¼•ã€‚è¿™äº›è¡Œå‘é‡æ˜¯æ¨¡å‹çš„å¯è®­ç»ƒå‚æ•°ï¼Œå…¶åˆå§‹å€¼é€šå¸¸æ˜¯éšæœºè®¾å®šçš„ã€‚</li><li><strong>å‘é‡æŸ¥æ‰¾</strong>ï¼šå½“æ¨¡å‹å¤„ç†ä¸€ä¸ªå…·ä½“è¾“å…¥æ—¶ï¼Œ<code>torch.arange(seq_len)</code>ä¼šé¦–å…ˆç”Ÿæˆä¸€ä¸ªåŒ…å«è¯¥è¾“å…¥åºåˆ—æ‰€æœ‰ä½ç½®ç´¢å¼•çš„å¼ é‡ (tensor)ï¼Œä¾‹å¦‚<code>[0, 1, 2, ..., seq_len-1]</code>ã€‚éšåï¼Œè¿™ä¸ªä½ç½®ç´¢å¼•å¼ é‡è¢«ä¼ é€’ç»™<code>self.pos_emb</code>å±‚ã€‚è¯¥å±‚ä¼šæ ¹æ®ç´¢å¼•å€¼ï¼Œä»ç¬¬ä¸€æ­¥åˆå§‹åŒ–çš„æƒé‡çŸ©é˜µä¸­ï¼Œç²¾ç¡®åœ°æŸ¥æ‰¾å¹¶æå–å‡ºæ¯ä¸€è¡Œå¯¹åº”çš„ä½ç½®å‘é‡ï¼Œæœ€ç»ˆæ„æˆä¸€ä¸ªç»´åº¦ä¸º<code>(seq_len, emb_dim)</code> çš„ä½ç½®åµŒå…¥å¼ é‡<code>pos_embeds</code>ã€‚</li><li><strong>ä¿¡æ¯èåˆ</strong>ï¼š<code>x = tok_embeds + pos_embeds</code>æ‰§è¡Œå‘é‡çš„é€å…ƒç´ åŠ æ³•æ“ä½œã€‚æ­¤æ“ä½œå°†ä»£è¡¨è¯å…ƒè¯­ä¹‰ä¿¡æ¯çš„<code>tok_embeds</code> å¼ é‡ä¸ä¸Šä¸€æ­¥ç”Ÿæˆçš„ä½ç½®ä¿¡æ¯<code>pos_embeds</code> å¼ é‡åˆå¹¶ã€‚</li></ol><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250830195222938.png" /></p><h3 id="dropout-æ©ç ">2.3.3 dropout æ©ç </h3><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»é€šè¿‡è¯å…ƒåµŒå…¥å’Œä½ç½®åµŒå…¥çš„ç»“åˆï¼Œå¾—åˆ°äº†ä¸€ä¸ªä¿¡æ¯å®Œå¤‡çš„è¾“å…¥å‘é‡ã€‚è¿™ä¸ªå‘é‡æ—¢åŒ…å«äº†è¯å…ƒçš„è¯­ä¹‰ä¿¡æ¯ï¼Œä¹Ÿæ˜ç¡®äº†å…¶åœ¨åºåˆ—ä¸­çš„é¡ºåºï¼Œå¯ä»¥è¯´æ˜¯ä¸ºæ¨¡å‹å‡†å¤‡äº†ä¸€ä»½å®Œç¾çš„"å­¦ä¹ ææ–™"ã€‚</p><p>ç„¶è€Œï¼Œåœ¨å°†è¿™ä»½å®Œç¾çš„ææ–™é€å…¥ Transformerçš„æ ¸å¿ƒè¿›è¡Œæ·±åº¦åŠ å·¥ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è¿›è¡Œä¸€ä¸ªçœ‹ä¼¼çŸ›ç›¾ï¼Œå´è‡³å…³é‡è¦çš„æ“ä½œâ€”â€”æ•…æ„å¼•å…¥ä¸€äº›ä¸ç¡®å®šæ€§ã€‚ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼Ÿ<strong><u>è¿™æ˜¯ä¸ºäº†é˜²æ­¢æ¨¡å‹åœ¨è®­ç»ƒä¸­å˜å¾—è¿‡äºä¾èµ–è¾“å…¥çš„æ¯ä¸€ä¸ªç»†èŠ‚ï¼Œä»è€Œé™·å…¥"æ­»è®°ç¡¬èƒŒ"çš„é™·é˜±ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„"è¿‡æ‹Ÿåˆ"ã€‚</u></strong>ä¸ºäº†è®©æ¨¡å‹å­¦ä¼šä»ä¸å®Œç¾çš„ä¿¡æ¯ä¸­ä¹Ÿèƒ½æå–æ ¸å¿ƒè§„å¾‹ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥ä¸€ç§æ­£åˆ™åŒ–æŠ€æœ¯ã€‚è¿™æ­£æ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥è¦è®¨è®ºçš„<strong>Dropout</strong>ã€‚</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/1*iWQzxhVlvadk6VAJjsgXgg.png" alt="Dropout æŠ€æœ¯ç¤ºæ„å›¾" style="zoom:50%;" /></p><p>å®ƒçš„ä¸»è¦ç›®çš„æ˜¯<strong>é˜²æ­¢æ¨¡å‹è¿‡æ‹Ÿåˆ</strong>ï¼Œæå‡æ¨¡å‹çš„<strong>æ³›åŒ–èƒ½åŠ›</strong>ã€‚åœ¨<strong>è®­ç»ƒæœŸé—´</strong>ï¼Œå®ƒä¼šéšæœºåœ°å°†ä¸€éƒ¨åˆ†è¾“å…¥æ•°æ®ç½®ä¸ºé›¶ï¼Œè¿«ä½¿æ¨¡å‹ä¸èƒ½è¿‡åº¦ä¾èµ–äºä»»ä½•å°‘æ•°çš„ç‰¹å¾ï¼Œä»è€Œå­¦ä¹ åˆ°æ›´åŠ é²æ£’çš„æ¨¡å¼ã€‚åœ¨<strong>è¯„ä¼°å’Œé¢„æµ‹æ—¶</strong>ï¼ŒDropoutä¼šè‡ªåŠ¨å¤±æ•ˆï¼Œä¸ä¼šå¯¹æ•°æ®åšä»»ä½•æ”¹åŠ¨ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GPTModel</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å®Œæ•´çš„GPTæ¨¡å‹å®ç°&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, cfg</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># ...</span></span><br><span class="line">        <span class="variable language_">self</span>.drop_emb = nn.Dropout(cfg[<span class="string">&quot;drop_rate&quot;</span>])</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, in_idx</span>):</span><br><span class="line">        <span class="comment"># ...</span></span><br><span class="line">        x = <span class="variable language_">self</span>.drop_emb(x)</span><br><span class="line">        <span class="comment"># ...</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æœ¬æ¬¡çš„å®ç°æ€»å…±ä¼šæœ‰ 2 ä¸ªåœ°æ–¹åº”ç”¨åˆ° dropout æŠ€æœ¯ï¼š</p><ol type="1"><li>åœ¨è¯å…ƒåµŒå…¥å’Œä½ç½®åµŒå…¥ç›¸åŠ ä¹‹åï¼Œè¿›å…¥ç¬¬ä¸€ä¸ª Transformer Blockä¹‹å‰ï¼Œå³ä¸Šé¢çš„ä»£ç æ‰€åšçš„äº‹æƒ…ã€‚è¿™æ˜¯æ¨¡å‹é‡åˆ°çš„<strong>ç¬¬ä¸€å±‚æ­£åˆ™åŒ–</strong>ã€‚å®ƒç›´æ¥ä½œç”¨äºèåˆäº†è¯­ä¹‰å’Œä½ç½®ä¿¡æ¯çš„åˆå§‹è¾“å…¥å‘é‡<code>x</code>ã€‚é€šè¿‡éšæœºå°†è¾“å…¥å‘é‡ä¸­çš„æŸäº›ç‰¹å¾ç½®ä¸ºé›¶ï¼Œå®ƒè¿«ä½¿<strong>åç»­æ‰€æœ‰</strong>çš„Transformer Blockéƒ½ä¸èƒ½è¿‡åº¦ä¾èµ–è¾“å…¥å‘é‡ä¸­çš„ä»»ä½•å•ä¸€ç»´åº¦ã€‚è¿™ç›¸å½“äºä»æºå¤´ä¸Šå¢åŠ äº†è®­ç»ƒéš¾åº¦ï¼Œè¦æ±‚æ•´ä¸ªæ¨¡å‹å­¦ä¹ åˆ°å¯¹è¾“å…¥ç‰¹å¾æ‰°åŠ¨ä¸æ•æ„Ÿçš„ã€æ›´æœ¬è´¨çš„è§„å¾‹ã€‚</li><li>åœ¨å¤šå¤´æ³¨æ„åŠ›æ¨¡å—å†…éƒ¨ï¼Œè®¡ç®—å‡ºæ³¨æ„åŠ›æƒé‡ <code>attn_weights</code>å¹¶ç»è¿‡ softmax å½’ä¸€åŒ–ä¹‹åï¼Œåœ¨ç”¨å®ƒå»åŠ æƒ <code>Value</code>å‘é‡ä¹‹å‰ã€‚è¿™ç§ dropout<strong>ä¸ä½œç”¨äºè¾“å…¥å‘é‡æœ¬èº«ï¼Œè€Œæ˜¯ä½œç”¨äºæ³¨æ„åŠ›æƒé‡</strong>ã€‚æ³¨æ„åŠ›æƒé‡å†³å®šäº†åœ¨ç”Ÿæˆä¸€ä¸ªè¯çš„è¡¨ç¤ºæ—¶ï¼Œåº”è¯¥å…³æ³¨ä¸Šä¸‹æ–‡ä¸­å…¶ä»–è¯çš„ç¨‹åº¦ã€‚åœ¨è¿™é‡Œåº”ç”¨dropoutï¼Œä¼šéšæœºåœ°å°†æŸäº›è¯ä¸è¯ä¹‹é—´çš„æ³¨æ„åŠ›è¿æ¥åˆ‡æ–­ï¼ˆæƒé‡ç½®ä¸º0ï¼‰ã€‚è¿™å¯ä»¥é˜²æ­¢æ¨¡å‹åœ¨å­¦ä¹ æ—¶èµ°æ·å¾„ï¼Œæ¯”å¦‚è¿‡åº¦ä¾èµ–äºæŸä¸ªç‰¹å®šçš„å‰æ–‡è¯æ±‡ã€‚å®ƒé¼“åŠ±æ¨¡å‹å»è€ƒè™‘æ›´å¹¿æ³›çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œè€Œä¸æ˜¯ä»…ä»…ä¾èµ–å‡ ä¸ªæœ€å¼ºçš„ä¿¡å·ã€‚ï¼ˆå…³äºæ³¨æ„åŠ›æ¨¡å—ï¼Œæˆ‘ä»¬åé¢ä¼šè¯¦ç»†è®¨è®ºï¼‰</li></ol><hr /><blockquote><p>[!IMPORTANT] åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»å®Œæ•´åœ°å‰–æäº† <code>GPTModel</code>çš„<strong>è¾“å…¥è¡¨ç¤ºå±‚</strong>ã€‚æˆ‘ä»¬ä»ç¬¬ä¸€æ€§åŸç†å‡ºå‘ï¼Œç†è§£äº†ä¸ºä»€ä¹ˆéœ€è¦å°†ç¦»æ•£çš„è¯å…ƒIDï¼Œé€šè¿‡<strong>è¯å…ƒåµŒå…¥ï¼ˆTokenEmbeddingï¼‰</strong>å’Œ<strong>ä½ç½®åµŒå…¥ï¼ˆPositionalEmbeddingï¼‰</strong>ï¼Œè½¬åŒ–ä¸ºä¸€ä¸ªèåˆäº†<strong>è¯­ä¹‰</strong>ä¸<strong>é¡ºåº</strong>ä¿¡æ¯çš„ã€ä¿¡æ¯å®Œå¤‡çš„é«˜ç»´å‘é‡<code>x</code>ã€‚</p><p>è¿™ä¸ªè¿‡ç¨‹çš„æœ¬è´¨ï¼Œæ˜¯å°†äººç±»çš„ç¬¦å·è¯­è¨€ï¼Œç¿»è¯‘æˆäº†ç¥ç»ç½‘ç»œèƒ½å¤Ÿè¿›è¡Œæ•°å­¦è¿ç®—çš„ã€ç»“æ„åŒ–çš„å†…éƒ¨è¯­è¨€ã€‚</p><p>æˆ‘ä»¬è¿˜æ¢è®¨äº† <code>Dropout</code>æŠ€æœ¯ã€‚å®ƒåƒä¸€ä¸ªä¸¥æ ¼çš„æ•™ç»ƒï¼Œé€šè¿‡åœ¨è®­ç»ƒä¸­éšæœºé®ç›–éƒ¨åˆ†ä¿¡æ¯ï¼Œå¼ºè¿«æ¨¡å‹ä¸èƒ½æ­»è®°ç¡¬èƒŒï¼Œå¿…é¡»å­¦ä¼šä»ä¸å®Œæ•´çš„ä¿¡æ¯ä¸­æç‚¼å‡ºæ›´æœ¬è´¨ã€æ›´é²æ£’çš„è§„å¾‹ï¼Œä»è€Œæå‡å…¶æ³›åŒ–èƒ½åŠ›ã€‚</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬æœ‰äº†ä¸€æ‰¹å‡†å¤‡å°±ç»ªã€ä¿¡æ¯ä¸°å¯Œä¸”ç»è¿‡åˆæ­¥æ­£åˆ™åŒ–å¤„ç†çš„è®­ç»ƒææ–™ã€‚ç„¶è€Œï¼Œæ­¤æ—¶æ­¤åˆ»ï¼Œåºåˆ—ä¸­çš„æ¯ä¸€ä¸ªå‘é‡è™½ç„¶çŸ¥é“äº†è‡ªå·±æ˜¯è°ä»¥åŠåœ¨å“ªï¼Œä½†å®ƒä»ç„¶æ˜¯ä¸€ä¸ª<strong>ç‹¬ç«‹çš„ã€ä¸Šä¸‹æ–‡æ— å…³çš„ä¸ªä½“</strong>ã€‚å®ƒå¹¶ä¸çŸ¥é“è‡ªå·±ä¸å…¶ä»–è¯å…ƒä¹‹é—´å­˜åœ¨ç€æ€æ ·å¤æ‚çš„å¥æ³•å’Œè¯­ä¹‰å…³è”ã€‚</p><p>é‚£ä¹ˆï¼Œæ¨¡å‹æ˜¯å¦‚ä½•è®©è¿™äº›å­¤ç«‹çš„å‘é‡å¼€å§‹"äº¤æµ"ï¼Œç†è§£å½¼æ­¤ä¹‹é—´çš„å…³ç³»ï¼Œå¹¶æœ€ç»ˆå½¢æˆå¯¹æ•´ä¸ªåºåˆ—çš„æ·±åº¦ç†è§£å‘¢ï¼Ÿ</p><p>ç­”æ¡ˆï¼Œå°±è—åœ¨ Transformer æ¶æ„çš„é©å‘½æ€§æ ¸å¿ƒâ€”â€”<strong>è‡ªæ³¨æ„åŠ›æœºåˆ¶(Self-Attention Mechanism)</strong> ä¹‹ä¸­ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥æ·±å…¥ LLMä¸­æœ€å…³é”®çš„éƒ¨åˆ†ï¼Œæ¢ç©¶ Transformer æ¶æ„çš„å±‚å±‚ç»†èŠ‚ï¼</p></blockquote><h2 id="æ ¸å¿ƒå¤„ç†å±‚transformer-å—çš„å †å ">2.4 æ ¸å¿ƒå¤„ç†å±‚ï¼šTransformerå—çš„å †å </h2><p>åœ¨ <code>GPTModel</code> ä¸­ï¼Œæˆ‘ä»¬å…±ä½¿ç”¨äº† <code>n_layers</code> ä¸ª<code>TransformerBlock</code>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GPTModel</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, cfg</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">       <span class="comment"># ...</span></span><br><span class="line">        <span class="comment"># å †å å¤šä¸ªTransformerå—</span></span><br><span class="line">        <span class="variable language_">self</span>.trf_blocks = nn.Sequential(</span><br><span class="line">            *[TransformerBlock(cfg) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(cfg[<span class="string">&quot;n_layers&quot;</span>])],</span><br><span class="line">        )</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆæ¥çœ‹ <code>TransformerBlock</code> çš„ç»“æ„ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TransformerBlock</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Transformerå—ï¼šå¤šå¤´æ³¨æ„åŠ› + å‰é¦ˆç½‘ç»œ + æ®‹å·®è¿æ¥&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, cfg</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="variable language_">self</span>.att = MultiHeadAttention(</span><br><span class="line">            d_in=cfg[<span class="string">&quot;emb_dim&quot;</span>],</span><br><span class="line">            d_out=cfg[<span class="string">&quot;emb_dim&quot;</span>],</span><br><span class="line">            context_length=cfg[<span class="string">&quot;context_length&quot;</span>],</span><br><span class="line">            num_heads=cfg[<span class="string">&quot;n_heads&quot;</span>],</span><br><span class="line">            dropout=cfg[<span class="string">&quot;drop_rate&quot;</span>],</span><br><span class="line">            qkv_bias=cfg[<span class="string">&quot;qkv_bias&quot;</span>],</span><br><span class="line">        )</span><br><span class="line">        <span class="variable language_">self</span>.ff = FeedForward(cfg)</span><br><span class="line">        <span class="variable language_">self</span>.norm1 = LayerNorm(cfg[<span class="string">&quot;emb_dim&quot;</span>])</span><br><span class="line">        <span class="variable language_">self</span>.norm2 = LayerNorm(cfg[<span class="string">&quot;emb_dim&quot;</span>])</span><br><span class="line">        <span class="variable language_">self</span>.drop_shortcut = nn.Dropout(cfg[<span class="string">&quot;drop_rate&quot;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="comment"># ç¬¬ä¸€ä¸ªå­å±‚ï¼šå¤šå¤´æ³¨æ„åŠ› + æ®‹å·®è¿æ¥</span></span><br><span class="line">        shortcut = x</span><br><span class="line">        x = <span class="variable language_">self</span>.norm1(x)</span><br><span class="line">        x = <span class="variable language_">self</span>.att(x)</span><br><span class="line">        x = <span class="variable language_">self</span>.drop_shortcut(x)</span><br><span class="line">        x = x + shortcut</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ç¬¬äºŒä¸ªå­å±‚ï¼šå‰é¦ˆç½‘ç»œ + æ®‹å·®è¿æ¥</span></span><br><span class="line">        shortcut = x</span><br><span class="line">        x = <span class="variable language_">self</span>.norm2(x)</span><br><span class="line">        x = <span class="variable language_">self</span>.ff(x)</span><br><span class="line">        x = <span class="variable language_">self</span>.drop_shortcut(x)</span><br><span class="line">        x = x + shortcut</span><br><span class="line">        <span class="keyword">return</span> x</span><br></pre></td></tr></table></figure><p>å®ƒçš„ç»“æ„ç¤ºæ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250830202334178.png" /></p><h3 id="æ³¨æ„åŠ›æœºåˆ¶">2.4.1 æ³¨æ„åŠ›æœºåˆ¶</h3><p>æ·±å…¥æ¢è®¨å¤§è¯­è¨€æ¨¡å‹æ ¸å¿ƒçš„è‡ªæ³¨æ„åŠ›æœºåˆ¶ä¹‹å‰ï¼Œè®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹åœ¨å¤§è¯­è¨€æ¨¡å‹å‡ºç°ä¹‹å‰çš„æ²¡æœ‰æ³¨æ„åŠ›æœºåˆ¶çš„æ¶æ„ä¸­æ‰€å­˜åœ¨çš„é—®é¢˜ã€‚å‡è®¾æˆ‘ä»¬æƒ³è¦å¼€å‘ä¸€ä¸ªå°†æ–‡æœ¬ä»ä¸€ç§è¯­è¨€ç¿»è¯‘æˆå¦ä¸€ç§è¯­è¨€çš„è¯­è¨€ç¿»è¯‘æ¨¡å‹ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç”±äºæºè¯­è¨€å’Œç›®æ ‡è¯­è¨€çš„è¯­æ³•ç»“æ„ä¸åŒï¼Œæˆ‘ä»¬æ— æ³•ç®€å•åœ°é€ä¸ªå•è¯è¿›è¡Œç¿»è¯‘ã€‚</p><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250830202911825.png" /></p><p>è¿™æ­£æ˜¯ä¼ ç»Ÿçš„åºåˆ—å¤„ç†æ¨¡å‹ï¼ˆå¦‚RNNï¼‰ä¸€ä¸ªæ ¹æœ¬ç¼ºé™·çš„ä½“ç°ï¼š<strong>ä¿¡æ¯ç“¶é¢ˆ</strong>ã€‚å®ƒä»¬é€šè¿‡ä¸€ä¸ªå¾ªç¯ç»“æ„é¡ºåºå¤„ç†æ–‡æœ¬ï¼Œå¯¼è‡´åºåˆ—æœ«ç«¯çš„ä¿¡æ¯å¾ˆéš¾ç›´æ¥å…³è”åˆ°åºåˆ—å¼€å¤´çš„é¥è¿œä¿¡æ¯ã€‚</p><blockquote><p>[!IMPORTANT]</p><p><strong>è‡ªæ³¨æ„åŠ›æœºåˆ¶ (Self-Attention)</strong>çš„æå‡ºï¼Œæ­£æ˜¯ä¸ºäº†æ‰“ç ´è¿™ç§ä¿¡æ¯ç“¶é¢ˆã€‚å…¶æ ¹æœ¬æ€æƒ³æ˜¯ï¼š<strong>ä¸ºåºåˆ—ä¸­çš„æ¯ä¸ªå…ƒç´ ï¼Œå»ºç«‹ä¸å…¶ä»–æ‰€æœ‰å…ƒç´ çš„ç›´æ¥è¿æ¥ï¼Œå¹¶åŠ¨æ€è®¡ç®—è¿™äº›è¿æ¥çš„å¼ºåº¦ï¼ˆå³æ³¨æ„åŠ›æƒé‡ï¼‰</strong>ã€‚è¿™æ ·ï¼Œæ¨¡å‹åœ¨å¤„ç†ä»»ä½•ä¸€ä¸ªè¯å…ƒæ—¶ï¼Œéƒ½èƒ½æ‹¥æœ‰ä¸€ä¸ªå…¨å±€è§†é‡ï¼Œç›´æ¥å®¡è§†å¹¶å€Ÿé‰´æ•´ä¸ªä¸Šä¸‹æ–‡ã€‚</p></blockquote><p>åœ¨ <code>TransformerBlock</code>çš„å†…éƒ¨ï¼Œ<code>MultiHeadAttention</code>æ¨¡å—æ˜¯å…¶ç¬¬ä¸€ä¸ªã€ä¹Ÿæ˜¯æœ€ä¸ºå…³é”®çš„å­å±‚ã€‚å®ƒæ˜¯æ•´ä¸ª GPTæ¨¡å‹"æ™ºèƒ½"çš„æ ¹æœ¬æ¥æºã€‚è¦ç†è§£å®ƒï¼Œæˆ‘ä»¬ä¸èƒ½ä¸€è¹´è€Œå°±ã€‚å¾ˆå¹¸è¿çš„æ˜¯ï¼Œã€Šä»é›¶æ„å»ºå¤§è¯­è¨€æ¨¡å‹ã€‹çš„ä½œè€…SebastianRaschkaï¼Œä¸ºæˆ‘ä»¬æä¾›äº†ä¸€æ¡ä»ç®€å•åˆ°å¤æ‚çš„æ¼”è¿›è·¯å¾„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¿™éƒ¨åˆ†çš„å†…å®¹éå¸¸ç²¾åä¸”é‡è¦ï¼Œæ‰€ä»¥ç¬”è€…å°†å°½å¯èƒ½å°†è¿™éƒ¨åˆ†çš„å†…å®¹è¿›è¡Œå®Œæ•´è®°å½•ï¼Œä»¥å¸®åŠ©è¯»è€…ä»¬æ›´å¥½çš„ç†è§£è‡ªæ³¨æ„åŠ›æœºåˆ¶ã€‚</p><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250830203719560.png" /></p><h4 id="æ²¡æœ‰å¯è®­ç»ƒæƒé‡çš„ç®€å•è‡ªæ³¨æ„åŠ›æœºåˆ¶">2.4.1.1æ²¡æœ‰å¯è®­ç»ƒæƒé‡çš„ç®€å•è‡ªæ³¨æ„åŠ›æœºåˆ¶</h4><p>åœ¨æ·±å…¥ç ”ç©¶åŒ…å«å¯è®­ç»ƒæƒé‡çš„å¤æ‚ç‰ˆæœ¬ä¹‹å‰ï¼Œä¹¦ä¸­é¦–å…ˆå®ç°äº†ä¸€ä¸ªä¸å«ä»»ä½•å¯è®­ç»ƒæƒé‡çš„ç®€åŒ–è‡ªæ³¨æ„åŠ›æœºåˆ¶ï¼Œä»¥ä¾¿é˜æ˜å…¶æ ¸å¿ƒæ¦‚å¿µã€‚</p><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250830204044917.png" /></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œè¿™ä¸ªæœºåˆ¶çš„ç›®æ ‡æ˜¯ä¸ºè¾“å…¥åºåˆ—ä¸­çš„æ¯ä¸€ä¸ªè¯å…ƒï¼ˆTokenï¼‰ï¼Œè®¡ç®—å‡ºä¸€ä¸ª<strong>ä¸Šä¸‹æ–‡å‘é‡ï¼ˆContextVectorï¼‰</strong>ã€‚è¿™ä¸ªä¸Šä¸‹æ–‡å‘é‡æ˜¯ä¸€ç§å¢å¼ºç‰ˆçš„åµŒå…¥ï¼Œå®ƒä¸ä»…åŒ…å«äº†å½“å‰è¯å…ƒè‡ªèº«çš„ä¿¡æ¯ï¼Œè¿˜èåˆäº†åºåˆ—ä¸­æ‰€æœ‰å…¶ä»–è¯å…ƒçš„ä¿¡æ¯ã€‚è¿™å¯¹äºç†è§£å¥å­ä¸­å•è¯é—´çš„å…³ç³»è‡³å…³é‡è¦ ã€‚</p><p>è®¡ç®—è¿™ä¸ªä¸Šä¸‹æ–‡å‘é‡çš„è¿‡ç¨‹åˆ†ä¸ºä¸‰æ­¥ï¼š</p><ol type="1"><li><strong>è®¡ç®—æ³¨æ„åŠ›åˆ†æ•°</strong>ï¼šè¡¡é‡æ¯ä¸ªè¯å¯¹å…¶ä»–è¯çš„"ç›¸å…³æ€§"æˆ–"ç›¸ä¼¼åº¦"ã€‚è®¡ç®—æ¯å¯¹è¯ä¹‹é—´çš„ç‚¹ç§¯ï¼Œå¾—åˆ°ç›¸ä¼¼åº¦åˆ†æ•°ã€‚ç‚¹ç§¯åœ¨è¿™é‡Œå¯ä»¥è¢«çœ‹ä½œæ˜¯ä¸€ç§è¡¡é‡ç›¸ä¼¼åº¦çš„æ–¹å¼ï¼šä¸¤ä¸ªå‘é‡çš„ç‚¹ç§¯è¶Šå¤§ï¼Œä»£è¡¨å®ƒä»¬ä¹‹é—´çš„å¯¹é½ç¨‹åº¦æˆ–ç›¸ä¼¼åº¦è¶Šé«˜ï¼Œæ³¨æ„åŠ›åˆ†æ•°ä¹Ÿè¶Šé«˜ã€‚</li><li><strong>å½’ä¸€åŒ–è·å–æ³¨æ„åŠ›æƒé‡</strong>ï¼šå¾—åˆ°çš„æ³¨æ„åŠ›åˆ†æ•°æ˜¯ä¸€äº›åŸå§‹çš„æ•°å€¼ï¼Œå®ƒä»¬çš„å°ºåº¦ä¸ä¸€ã€‚ä¸ºäº†ä½¿å…¶è§„èŒƒåŒ–å¹¶æ˜“äºè§£é‡Šï¼Œæˆ‘ä»¬ä½¿ç”¨<strong>Softmax å‡½æ•°</strong>å¯¹è¿™äº›åˆ†æ•°è¿›è¡Œå¤„ç† ã€‚Softmaxå‡½æ•°èƒ½å°†ä¸€ç»„ä»»æ„å®æ•°è½¬æ¢ä¸ºä¸€ä¸ªæ¦‚ç‡åˆ†å¸ƒï¼Œç¡®ä¿æ‰€æœ‰è¾“å‡ºå€¼çš„å’Œä¸º1ï¼Œå¹¶ä¸”æ¯ä¸ªå€¼éƒ½æ˜¯æ­£æ•°ã€‚è¿™æ ·å¾—åˆ°çš„æ•°å€¼å°±æ˜¯"æ³¨æ„åŠ›æƒé‡"ï¼Œä»£è¡¨äº†åœ¨å½“å‰æŸ¥è¯¢ä¸‹ï¼Œåºåˆ—ä¸­æ¯ä¸ªè¯å…ƒçš„é‡è¦æ€§ã€‚</li><li><strong>è®¡ç®—ä¸Šä¸‹æ–‡å‘é‡</strong>ï¼šæœ€åä¸€æ­¥ï¼Œå°†åºåˆ—ä¸­çš„æ¯ä¸€ä¸ªè¯å…ƒåµŒå…¥å‘é‡ä¸å…¶å¯¹åº”çš„æ³¨æ„åŠ›æƒé‡ç›¸ä¹˜ï¼Œç„¶åå°†æ‰€æœ‰ç»“æœå‘é‡ç›¸åŠ ã€‚æœ€ç»ˆå¾—åˆ°çš„å‘é‡å°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„ä¸Šä¸‹æ–‡å‘é‡ï¼Œå®ƒæ˜¯æ•´ä¸ªè¾“å…¥åºåˆ—çš„åŠ æƒå’Œï¼Œæƒé‡ç”±åˆšåˆšè®¡ç®—å‡ºçš„æ³¨æ„åŠ›æƒé‡å†³å®šã€‚</li></ol><p>è¿™ 3 ä¸ªæ­¥éª¤å®ç°äº†è‡ªæ³¨æ„åŠ›æœºåˆ¶çš„æ ¸å¿ƒæ€æƒ³ï¼š</p><ul><li>çœ‹ï¼šè®¡ç®—æ¯ä¸ªè¯å¯¹å…¶ä»–è¯çš„å…³æ³¨åº¦</li><li>æƒè¡¡ï¼šå°†å…³æ³¨åº¦è½¬æ¢ä¸ºæƒé‡</li><li>èåˆï¼šæ ¹æ®æƒé‡èåˆæ‰€æœ‰è¯çš„ä¿¡æ¯</li></ul><p>æœ€ç»ˆæ•ˆæœï¼šæ¯ä¸ªè¯çš„å‘é‡è¡¨ç¤ºéƒ½åŒ…å«äº†æ•´ä¸ªåºåˆ—çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œè€Œä¸ä»…ä»…æ˜¯è‡ªå·±çš„ä¿¡æ¯ã€‚è¿™æ ·æ¨¡å‹å°±èƒ½ç†è§£è¯ä¸è¯ä¹‹é—´çš„å…³ç³»ï¼Œæ¯”å¦‚<code>"journey starts"</code> ä¸­çš„ <code>"starts"</code> ä¼šæ›´å¤šåœ°å…³æ³¨<code>"journey"</code> çš„ä¿¡æ¯ã€‚</p><p>ç°åœ¨æˆ‘ä»¬ç”¨ä»£ç æ¥æ¼”ç¤ºä¸€ä¸‹ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä»¥ä¸‹è¾“å…¥ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">inputs = torch.tensor(</span><br><span class="line">    [</span><br><span class="line">        [<span class="number">0.43</span>, <span class="number">0.15</span>, <span class="number">0.89</span>],   <span class="comment"># Your</span></span><br><span class="line">        [<span class="number">0.55</span>, <span class="number">0.87</span>, <span class="number">0.66</span>],   <span class="comment"># journey</span></span><br><span class="line">        [<span class="number">0.57</span>, <span class="number">0.85</span>, <span class="number">0.64</span>],   <span class="comment"># starts</span></span><br><span class="line">        [<span class="number">0.22</span>, <span class="number">0.58</span>, <span class="number">0.33</span>],   <span class="comment"># with</span></span><br><span class="line">        [<span class="number">0.77</span>, <span class="number">0.25</span>, <span class="number">0.10</span>],   <span class="comment"># one</span></span><br><span class="line">        [<span class="number">0.05</span>, <span class="number">0.80</span>, <span class="number">0.55</span>],   <span class="comment"># step</span></span><br><span class="line">    ]</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>ç¬”è€…å°†å°è¯•ä»ç¬¬ä¸€æ€§åŸç†å‡ºå‘ï¼Œå¯¹ä»£ç è¿›è¡Œä¸€æ­¥æ­¥æ‹†è§£ï¼Œè¯´æ˜ç™½è¿™ä¸ªè¿‡ç¨‹ä¸ºä»€ä¹ˆèƒ½å¤Ÿå®ç°æˆ‘ä»¬æœŸæœ›çš„ç›®æ ‡ï¼š<strong>ä¸ºæ¯ä¸ªè¯å…ƒï¼ˆTokenï¼‰ç”Ÿæˆä¸€ä¸ªåŒ…å«äº†ä¸Šä¸‹æ–‡ä¿¡æ¯çš„å‘é‡</strong>ã€‚</p><p>è¿™ä¸ªé—®é¢˜çš„æ ¸å¿ƒåœ¨äºï¼Œæˆ‘ä»¬è¦è¯æ˜<strong>æœ€ç»ˆçš„ä¸Šä¸‹æ–‡å‘é‡ (ContextVector)çš„ç¡®èåˆäº†å…¶ä»–è¯å…ƒçš„ä¿¡æ¯ï¼Œå¹¶ä¸”æ˜¯æ ¹æ®"ç›¸å…³æ€§"æ¥èåˆçš„</strong>ã€‚</p><p>æˆ‘ä»¬å°†ä»¥ä½ ä¾‹å­ä¸­çš„è¯ <code>starts</code> (ç¬¬ä¸‰ä¸ªè¯å…ƒ)ä¸ºä¾‹ï¼Œæ¥å…¨ç¨‹è¿½è¸ªå®ƒçš„å˜åŒ–ã€‚</p><p><code>starts</code> çš„åŸå§‹è¾“å…¥å‘é‡æ˜¯:<code>[0.57, 0.85, 0.64]</code>ã€‚è¿™ä¸ªå‘é‡åªä»£è¡¨ <code>starts</code>æœ¬èº«ï¼Œå®ƒå¯¹å¥å­ä¸­çš„å…¶ä»–è¯ä¸€æ— æ‰€çŸ¥ï¼Œæ˜¯å­¤ç«‹çš„ã€‚<u>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ç”Ÿæˆä¸€ä¸ªæ–°çš„å‘é‡ï¼Œè®©è¿™ä¸ªæ–°çš„å‘é‡çŸ¥é“å®ƒå‰é¢æœ‰<code>Your journey</code>ï¼Œåé¢æœ‰ <code>with one step</code>ã€‚</u></p><p>ç¬¬ä¸€æ­¥æˆ‘ä»¬è®¡ç®—æ³¨æ„åŠ›åˆ†æ•°ï¼Œæ˜¯ä¸ºäº†å‘ç°"è°ä¸æˆ‘æœ€ç›¸å…³"ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">attn_scores = torch.empty(<span class="number">6</span>, <span class="number">6</span>)</span><br><span class="line"><span class="keyword">for</span> i, x_i <span class="keyword">in</span> <span class="built_in">enumerate</span>(inputs):</span><br><span class="line">    <span class="keyword">for</span> j, x_j <span class="keyword">in</span> <span class="built_in">enumerate</span>(inputs):</span><br><span class="line">        attn_scores[i, j] = torch.dot(x_i, x_j)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»“æœå¦‚ä¸‹ï¼š</span></span><br><span class="line"><span class="comment"># tensor([[0.9995, 0.9544, 0.9422, 0.4753, 0.4576, 0.6310],</span></span><br><span class="line"><span class="comment">#         [0.9544, 1.4950, 1.4754, 0.8434, 0.7070, 1.0865],</span></span><br><span class="line"><span class="comment">#         [0.9422, 1.4754, 1.4570, 0.8296, 0.7154, 1.0605],</span></span><br><span class="line"><span class="comment">#         [0.4753, 0.8434, 0.8296, 0.4937, 0.3474, 0.6565],</span></span><br><span class="line"><span class="comment">#         [0.4576, 0.7070, 0.7154, 0.3474, 0.6654, 0.2935],</span></span><br><span class="line"><span class="comment">#         [0.6310, 1.0865, 1.0605, 0.6565, 0.2935, 0.9450]])</span></span><br></pre></td></tr></table></figure><p><code>attn_scores</code> çš„ç¬¬ 3è¡Œæ˜¯ï¼š<code>[0.9422, 1.4754, 1.4570, 0.8296, 0.7154, 1.0605]</code>ã€‚è¿™è¡Œæ•°å­—å‘Šè¯‰æˆ‘ä»¬ï¼Œ<code>starts</code>è¿™ä¸ªè¯ä¸å¥å­ä¸­æ¯ä¸ªè¯çš„åŸå§‹ç›¸å…³æ€§å¾—åˆ†åˆ†åˆ«æ˜¯ï¼š</p><ul><li>ä¸ <code>Your</code> çš„ç›¸å…³æ€§: <code>0.9422</code></li><li>ä¸ <code>journey</code> çš„ç›¸å…³æ€§: <code>1.4754</code> &lt;--<strong>éå¸¸é«˜</strong></li><li>ä¸ <code>starts</code> (è‡ªèº«) çš„ç›¸å…³æ€§: <code>1.4570</code> &lt;--<strong>éå¸¸é«˜</strong></li><li>ä¸ <code>with</code> çš„ç›¸å…³æ€§: <code>0.8296</code></li><li>ä¸ <code>one</code> çš„ç›¸å…³æ€§: <code>0.7154</code></li><li>ä¸ <code>step</code> çš„ç›¸å…³æ€§: <code>1.0605</code></li></ul><p>ä»…ä»è¿™ä¸€æ­¥çœ‹ï¼Œè¿™ä¸ªæœºåˆ¶å·²ç»æˆåŠŸåœ°ä»æ•°å­¦ä¸Š<strong>å‘ç°</strong>äº†<code>starts</code> ä¸ <code>journey</code>ä¹‹é—´çš„ç´§å¯†å…³ç³»ï¼Œå› ä¸ºå®ƒä»¬çš„ç‚¹ç§¯åˆ†æ•°æ˜¯æœ€é«˜çš„ä¹‹ä¸€ã€‚è¿™å®Œå…¨ç¬¦åˆæˆ‘ä»¬å¯¹è¯­è¨€çš„ç›´è§‰ï¼ˆ"æ—…ç¨‹"å’Œ"å¼€å§‹"åœ¨è¯­ä¹‰ä¸Šå¼ºç›¸å…³ï¼‰ã€‚</p><p>ç¬¬ä¸€æ­¥å¾—åˆ°çš„åˆ†æ•°æ˜¯åŸå§‹çš„ã€æœªç»ç¼©æ”¾çš„æ•°å€¼ï¼Œä¸æ˜“äºä½œä¸ºæƒé‡ä½¿ç”¨ã€‚æ¯”å¦‚<code>1.4754</code>ç©¶ç«Ÿä»£è¡¨å¤šå¤§çš„é‡è¦æ€§ï¼Ÿæˆ‘ä»¬æ— æ³•ç›´æ¥åˆ¤æ–­ã€‚æ‰€ä»¥ç¬¬äºŒæ­¥å°±æ˜¯è¿›è¡Œå½’ä¸€åŒ–è·å–æ³¨æ„åŠ›æƒé‡ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 2. å½’ä¸€åŒ–è·å–æ³¨æ„åŠ›æƒé‡</span></span><br><span class="line">attn_weights = torch.softmax(attn_scores, dim=-<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(attn_weights)</span><br><span class="line"></span><br><span class="line"><span class="comment"># -1 è¡¨ç¤ºåœ¨æœ€åä¸€ä¸ªç»´åº¦è¿›è¡Œå½’ä¸€åŒ–ï¼Œå› ä¸º attn_scores æ˜¯ä¸€ä¸ª [è¡Œ, åˆ—]ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯åœ¨åˆ—ä¸Šè¿›è¡Œå½’ä¸€åŒ–ï¼Œä½¿å¾—æ¯è¡Œçš„å€¼ï¼ˆåœ¨åˆ—ç»´åº¦çš„æ€»å’Œï¼‰ä¸º 1</span></span><br><span class="line"><span class="comment"># &quot;æ²¿ç€åˆ—çš„æ–¹å‘&quot; = åœ¨æ¯ä¸€è¡Œå†…éƒ¨ï¼Œä»å·¦åˆ°å³ï¼ˆåˆ— 0 åˆ°åˆ— 5ï¼‰è¿›è¡Œå½’ä¸€åŒ–</span></span><br><span class="line"><span class="comment"># æ¯ä¸€è¡Œéƒ½ç‹¬ç«‹è¿›è¡Œè¿™ä¸ªè¿‡ç¨‹ï¼Œç»“æœæ¯ä¸€è¡Œçš„ 6 ä¸ªæ•°å­—åŠ èµ·æ¥éƒ½ç­‰äº 1</span></span><br><span class="line">row_2_sum = <span class="built_in">sum</span>([<span class="number">0.1385</span>, <span class="number">0.2379</span>, <span class="number">0.2333</span>, <span class="number">0.1240</span>, <span class="number">0.1082</span>, <span class="number">0.1581</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Row 2 sum:&quot;</span>, row_2_sum)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;All row sums:&quot;</span>, attn_weights.<span class="built_in">sum</span>(dim=-<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»“æœå¦‚ä¸‹ï¼š</span></span><br><span class="line"><span class="comment"># tensor([[0.2098, 0.2006, 0.1981, 0.1242, 0.1220, 0.1452],</span></span><br><span class="line"><span class="comment">#         [0.1385, 0.2379, 0.2333, 0.1240, 0.1082, 0.1581],</span></span><br><span class="line"><span class="comment">#         [0.1390, 0.2369, 0.2326, 0.1242, 0.1108, 0.1565],</span></span><br><span class="line"><span class="comment">#         [0.1435, 0.2074, 0.2046, 0.1462, 0.1263, 0.1720],</span></span><br><span class="line"><span class="comment">#         [0.1526, 0.1958, 0.1975, 0.1367, 0.1879, 0.1295],</span></span><br><span class="line"><span class="comment">#         [0.1385, 0.2184, 0.2128, 0.1420, 0.0988, 0.1896]])</span></span><br><span class="line"><span class="comment"># Row 2 sum: 1.0</span></span><br><span class="line"><span class="comment"># All row sums: tensor([1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000])</span></span><br></pre></td></tr></table></figure><p>ç°åœ¨ï¼Œè¿™äº›æ•°å­—çš„æ„ä¹‰å˜å¾—éå¸¸æ¸…æ™°äº†ï¼š å½“æ¨¡å‹åœ¨å¤„ç† <code>starts</code>è¿™ä¸ªè¯æ—¶ï¼Œå®ƒåº”è¯¥å°†å®ƒçš„æ³¨æ„åŠ›è¿™æ ·åˆ†é…ï¼š</p><ul><li><code>13.90%</code> çš„æ³¨æ„åŠ›ç»™ <code>Your</code></li><li><code>23.69%</code> çš„æ³¨æ„åŠ›ç»™ <code>journey</code> &lt;--<strong>æƒé‡æœ€é«˜</strong></li><li><code>23.26%</code> çš„æ³¨æ„åŠ›ç»™ <code>starts</code> (è‡ªèº«)</li><li><code>12.42%</code> çš„æ³¨æ„åŠ›ç»™ <code>with</code></li><li><code>11.08%</code> çš„æ³¨æ„åŠ›ç»™ <code>one</code></li><li><code>15.65%</code> çš„æ³¨æ„åŠ›ç»™ <code>step</code></li></ul><p>è¿™ä¸€æ­¥å°†ç¬¬ä¸€æ­¥å‘ç°çš„ç›¸å…³æ€§ï¼Œè½¬åŒ–ä¸ºäº†å…·ä½“çš„ã€å¯æ“ä½œçš„é‡è¦æ€§æƒé‡ã€‚å®ƒæ˜ç¡®åœ°å‘Šè¯‰æˆ‘ä»¬ï¼Œä¸ºäº†ç†è§£<code>starts</code>ï¼Œæˆ‘ä»¬éœ€è¦é‡ç‚¹å‚è€ƒ <code>journey</code> å’Œ<code>starts</code> è‡ªèº«çš„ä¿¡æ¯ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œè¿™æ˜¯æœ€å…³é”®çš„ä¸€æ­¥ï¼Œæˆ‘ä»¬ç»ˆäºè¦åˆ›é€ é‚£ä¸ª"å¢å¼ºç‰ˆ"çš„å‘é‡ï¼ˆä¸Šä¸‹æ–‡å‘é‡ï¼‰äº†ã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ä¸ºè¯<code>i</code> (ä¾‹å¦‚ <code>starts</code>)åˆ›å»ºä¸€ä¸ª<strong>æ–°çš„è¡¨ç¤º</strong> <spanclass="math inline">\(C_i\)</span>ã€‚è¿™ä¸ªæ–°çš„è¡¨ç¤º <spanclass="math inline">\(C_i\)</span> å¿…é¡»æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š</p><ol type="1"><li>å®ƒå¿…é¡»åŒ…å«<strong>æ‰€æœ‰</strong>å…¶ä»–è¯ <code>j</code> (ä»<code>Your</code> åˆ° <code>step</code>) çš„ä¿¡æ¯ã€‚</li><li>æ¯ä¸ªè¯ <code>j</code>è´¡çŒ®çš„ä¿¡æ¯é‡ï¼Œåº”è¯¥ç”±æˆ‘ä»¬åˆšåˆšç®—å‡ºçš„<strong>æ³¨æ„åŠ›æƒé‡</strong> <spanclass="math inline">\({w_{ij}}\)</span>æ¥å†³å®šã€‚æƒé‡è¶Šé«˜çš„è¯ï¼Œå½±å“è¶Šå¤§ã€‚</li></ol><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ€è€ƒä¸€ä¸‹ï¼Œåœ¨æ•°å­¦ä¸Šï¼Œç‰¹åˆ«æ˜¯å‘é‡ç©ºé—´ä¸­ï¼Œæœ‰ä»€ä¹ˆè¿ç®—å¯ä»¥åŒæ—¶æ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶ï¼Ÿ<strong>ç­”æ¡ˆå°±æ˜¯åŠ æƒå¹³å‡(Weighted Average) æˆ– åŠ æƒå’Œ (Weighted Sum)ã€‚</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 3. è®¡ç®—ä¸Šä¸‹æ–‡å‘é‡</span></span><br><span class="line">all_contexts_vec = attn_weights @ inputs</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»“æœå¦‚ä¸‹ï¼š</span></span><br><span class="line"><span class="comment"># tensor([[0.4421, 0.5931, 0.5790],</span></span><br><span class="line"><span class="comment">#         [0.4419, 0.6515, 0.5683],</span></span><br><span class="line"><span class="comment">#         [0.4431, 0.6496, 0.5671],</span></span><br><span class="line"><span class="comment">#         [0.4304, 0.6298, 0.5510],</span></span><br><span class="line"><span class="comment">#         [0.4671, 0.5910, 0.5266],</span></span><br><span class="line"><span class="comment">#         [0.4177, 0.6503, 0.5645]])</span></span><br></pre></td></tr></table></figure><p>çŸ©é˜µä¹˜æ³• <code>attn_weights @ inputs</code>æ˜¯ä¸€ç§éå¸¸é«˜æ•ˆçš„ã€ä¸€æ¬¡æ€§ä¸ºæ‰€æœ‰è¯è®¡ç®—åŠ æƒæ±‚å’Œçš„æ–¹å¼ã€‚æœ¬è´¨ä¸Šæ˜¯é€šè¿‡ä»¥ä¸‹æ–¹å¼è®¡ç®—çš„ï¼š</p><p><span class="math display">\[C_i = \sum_{j=1}^N w_{ij} \cdot V_j\]</span></p><p>å…¶ä¸­ï¼Œ<span class="math inline">\(w_{ij}\)</span> æ˜¯è¯ i å¯¹è¯ jçš„æ³¨æ„åŠ›æƒé‡ï¼Œ<span class="math inline">\(V_j\)</span> æ˜¯è¯ jçš„åŸå§‹å‘é‡ã€‚</p><p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹è¿™ä¸ªå…¬å¼çš„ä¸¤ä¸ªéƒ¨åˆ†ï¼š</p><p><strong>ç¬¬ä¸€éƒ¨åˆ†ï¼š<span class="math inline">\(w_{ij}\cdotV{j}\)</span>ï¼ˆç¼©æ”¾ï¼‰</strong>ï¼šé€šè¿‡è¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬ä¸ºå¥å­ä¸­çš„<strong>æ¯ä¸€ä¸ªè¯</strong>ï¼Œéƒ½ç”Ÿæˆäº†ä¸€ä¸ª<strong>å¾…è´¡çŒ®</strong>çš„å‘é‡ã€‚è¿™ä¸ªå‘é‡çš„æ„ä¹‰å’ŒåŸå§‹è¯ä¸€æ ·ï¼Œä½†å®ƒçš„å½±å“åŠ›å·²ç»è¢«å…¶å¯¹åº”çš„æ³¨æ„åŠ›æƒé‡ç²¾ç¡®åœ°è°ƒæ•´å¥½äº†ã€‚</p><p><strong>ç¬¬äºŒéƒ¨åˆ†ï¼šâˆ‘j=1Nï¼ˆæ±‚å’Œï¼‰</strong>ï¼šè¿™ä¸€æ­¥æ˜¯æŠŠæ‰€æœ‰è¿™äº›å¾…è´¡çŒ®çš„å‘é‡<strong>å…¨éƒ¨åŠ èµ·æ¥</strong>ï¼š<spanclass="math inline">\(C_{starts}=(w_{s,y}â‹…V_y)+(w_{s,j}â‹…V_j)+(w_{s,s}â‹…V_s)+â€¦\)</span>ã€‚è¿™ä¸€æ­¥çš„å‡ ä½•æ„ä¹‰æ˜¯ï¼šåœ¨é‚£ä¸ªé«˜ç»´çš„æ„ä¹‰ç©ºé—´é‡Œï¼Œæˆ‘ä»¬ä»åŸç‚¹å‡ºå‘ï¼Œå…ˆæ²¿ç€åŠ å¼ºç‰ˆ<code>journey</code> å‘é‡èµ°ä¸€æ®µï¼Œå†æ¥ç€èµ°å‰Šå¼±ç‰ˆ<code>one</code>å‘é‡çš„æ–¹å‘ï¼Œå†èµ°åŠ å¼ºç‰ˆ <code>starts</code>è‡ªèº«çš„æ–¹å‘......æŠŠæ‰€æœ‰è¯çš„è´¡çŒ®éƒ½èµ°å®Œï¼Œæœ€ç»ˆåˆ°è¾¾çš„é‚£ä¸ª<strong>æ–°çš„ä½ç½®</strong>ï¼Œå°±æ˜¯æˆ‘ä»¬çš„ä¸Šä¸‹æ–‡å‘é‡<span class="math inline">\(C_{starts}\)</span>ã€‚</p><p>è¿™ä¸ªä¸‰æ­¥è¿‡ç¨‹ä¹‹æ‰€ä»¥èƒ½èµ·åˆ°æˆ‘ä»¬æƒ³è¦çš„ä½œç”¨ï¼Œæ˜¯å› ä¸ºå®ƒå®Œç¾åœ°æ¨¡æ‹Ÿäº†äººç±»ç†è§£è¯­è¨€çš„ä¸€ä¸ªæ ¸å¿ƒé€»è¾‘ï¼š</p><ol type="1"><li><strong>å…³æ³¨ç„¦ç‚¹</strong>ï¼šå½“æˆ‘ä»¬è¯»åˆ°ä¸€ä¸ªè¯æ—¶ï¼Œæˆ‘ä»¬ä¼šæœ¬èƒ½åœ°å¯»æ‰¾ä¸å®ƒæœ€ç›¸å…³çš„è¯ã€‚è¿™ä¸ªæœºåˆ¶é€šè¿‡è®¡ç®—ç‚¹ç§¯ï¼Œ<strong>æ‰¾åˆ°äº†</strong>è¿™äº›ç›¸å…³è¯ã€‚</li><li><strong>åˆ†é…ç²¾åŠ›</strong>ï¼šæˆ‘ä»¬ä¸ä¼šå¯¹æ‰€æœ‰ç›¸å…³çš„è¯éƒ½æŠ•å…¥ç›¸åŒçš„ç²¾åŠ›ã€‚è¿™ä¸ªæœºåˆ¶é€šè¿‡Softmaxï¼Œå°†"ç›¸å…³æ€§"è½¬åŒ–ä¸º"é‡è¦æ€§"æƒé‡ï¼Œ<strong>é‡åŒ–äº†</strong>åº”è¯¥æŠ•å…¥å¤šå°‘ç²¾åŠ›ã€‚</li><li><strong>ç»¼åˆç†è§£</strong>ï¼šæˆ‘ä»¬åŸºäºè¿™äº›ç„¦ç‚¹å’Œç²¾åŠ›åˆ†é…ï¼Œåœ¨å¤§è„‘ä¸­å½¢æˆå¯¹å½“å‰è¯çš„ç»¼åˆç†è§£ã€‚è¿™ä¸ªæœºåˆ¶é€šè¿‡åŠ æƒæ±‚å’Œï¼Œå°†æ‰€æœ‰è¯çš„ä¿¡æ¯æ ¹æ®é‡è¦æ€§æƒé‡<strong>èåˆ</strong>åœ¨ä¸€èµ·ï¼Œç”Ÿæˆäº†æœ€ç»ˆçš„ä¸Šä¸‹æ–‡å‘é‡ã€‚</li></ol><p>é€šè¿‡è¿™ä¸ªè¿‡ç¨‹ï¼Œè¾“å‡ºçš„æ¯ä¸€ä¸ªå‘é‡éƒ½ä»"<u>æˆ‘æ˜¯è°</u>"çš„å­¤ç«‹çŠ¶æ€ï¼Œå˜æˆäº†"<u>åœ¨è¿™æ ·ä¸€ä¸ªå¥å­é‡Œï¼Œæˆ‘æ˜¯è°</u>"çš„ä¸Šä¸‹æ–‡æ„ŸçŸ¥çŠ¶æ€ï¼Œä»è€Œå®ç°äº†æˆ‘ä»¬çš„æœ€ç»ˆç›®æ ‡ã€‚</p><h4 id="å®ç°å¸¦å¯è®­ç»ƒæƒé‡çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶">2.4.1.2å®ç°å¸¦å¯è®­ç»ƒæƒé‡çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶</h4><p>åœ¨ä¸Šä¸ªé˜¶æ®µï¼Œ<strong>æ³¨æ„åŠ›æœºåˆ¶æœ¬èº«æ²¡æœ‰è‡ªå·±ç‹¬ç«‹çš„ã€å¯ä»¥åœ¨è®­ç»ƒä¸­è¢«ä¼˜åŒ–çš„å‚æ•°</strong>ã€‚æ¨¡å‹åœ¨è®­ç»ƒæ—¶ï¼Œè™½ç„¶å¯ä»¥å­¦ä¹ å’Œè°ƒæ•´è¾“å…¥çš„<code>x</code>å‘é‡ï¼ˆå³è¯åµŒå…¥æœ¬èº«ï¼‰ï¼Œä½†å®ƒ<strong>æ— æ³•å­¦ä¹ å¦‚ä½•æ›´å¥½åœ°è®¡ç®—æ³¨æ„åŠ›</strong>ã€‚æ— è®ºè¾“å…¥çš„å‘é‡å¦‚ä½•å˜åŒ–ï¼Œè®¡ç®—æ³¨æ„åŠ›çš„å…¬å¼å§‹ç»ˆä¸å˜ã€‚è€Œä¸”è¿™ç§æ–¹å¼è¿‡äºåƒµåŒ–ã€‚ä¸€ä¸ªè¯å…ƒçš„å‘é‡è¡¨ç¤º<code>x</code>éœ€è¦åŒæ—¶æ‰¿è½½å¤šç§ä¿¡æ¯ï¼Œå®ƒæ—¢è¦ä»£è¡¨è‡ªèº«çš„è¯­ä¹‰ï¼Œåˆè¦èƒ½å¾ˆå¥½åœ°è·Ÿå…¶ä»–è¯å…ƒçš„å‘é‡è¿›è¡Œç‚¹ç§¯æ¥åˆ¤æ–­ç›¸å…³æ€§ã€‚è¿™å°±åƒè¦æ±‚ä¸€ä¸ªäººåŒæ—¶æ‰®æ¼”è¿åŠ¨å‘˜å’Œè£åˆ¤å‘˜ï¼Œè§’è‰²å‘ç”Ÿäº†æ··æ·†ï¼Œéš¾ä»¥åšåˆ°æœ€ä¼˜ã€‚</p><p>æ‰€ä»¥ç¬¬äºŒä¸ªç‰ˆæœ¬çš„æ ¹æœ¬é—®é¢˜å°±æ˜¯ï¼š<u>å¦‚ä½•è®©æ¨¡å‹<strong>å­¦ä¼š</strong>å»å…³æ³¨ä»€ä¹ˆï¼Ÿå¦‚ä½•è®©ç›¸ä¼¼åº¦çš„è®¡ç®—æ–¹å¼æœ¬èº«å˜å¾—<strong>çµæ´»å’Œå¼ºå¤§</strong>ï¼Ÿ</u></p><p>è§£å†³æ–¹æ¡ˆæ˜¯å¼•å…¥è§’è‰²åˆ†å·¥ï¼Œè®©ä¸“ä¸šçš„è§’è‰²åšä¸“ä¸šçš„äº‹ã€‚ç¬¬äºŒä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬ä¸å†ç›´æ¥ä½¿ç”¨åŸå§‹çš„è¾“å…¥å‘é‡<code>x</code>ï¼Œè€Œæ˜¯å¼•å…¥ä¸‰ä¸ªç‹¬ç«‹çš„å¯è®­ç»ƒçº¿æ€§å˜æ¢å±‚(<code>nn.Linear</code>)ï¼š<strong>Query (Q)</strong>ã€<strong>Key(K)</strong> å’Œ <strong>Value (V)</strong>ã€‚</p><ul><li><strong>æŸ¥è¯¢å‘é‡(Query)</strong>ï¼šä»£è¡¨å½“å‰è¿™ä¸ªè¯ï¼Œä¸»åŠ¨å»æŸ¥è¯¢å¥å­ä¸­å…¶ä»–è¯ä¸è‡ªå·±çš„å…³ç³»ã€‚å¯ä»¥ç†è§£ä¸ºï¼šæˆ‘(starts) æ˜¯è°ï¼Ÿ</li><li><strong>é”®å‘é‡(Key)</strong>ï¼šä»£è¡¨å¥å­ä¸­çš„æ¯ä¸ªè¯ï¼Œç”¨æ¥è¢«å…¶ä»–è¯æŸ¥è¯¢çš„ã€‚å¯ä»¥ç†è§£ä¸ºï¼šæˆ‘æ˜¯(journey)ï¼Œä½ å¯ä»¥é€šè¿‡è¿™ä¸ªâ€˜é”®â€™æ¥äº†è§£æˆ‘ã€‚</li><li><strong>å€¼å‘é‡(Value)</strong>ï¼šä»£è¡¨å¥å­ä¸­æ¯ä¸ªè¯æ‰€æºå¸¦çš„çœŸæ­£ä¿¡æ¯ã€‚ä¸€æ—¦æŸ¥è¯¢å®Œæ¯•ï¼Œç¡®å®šäº†å…³ç³»å¯†åˆ‡åº¦ï¼Œæˆ‘ä»¬å°±ä»è¿™ä¸ªå€¼ä¸­æå–ä¿¡æ¯ã€‚</li></ul><p>è‡³å…³é‡è¦çš„æ˜¯ï¼Œè¿™ä¸‰ä¸ªæƒé‡çŸ©é˜µ <spanclass="math inline">\(W_q\)</span>ã€<spanclass="math inline">\(W_k\)</span>ã€<spanclass="math inline">\(W_v\)</span>æ˜¯<strong>å¯è®­ç»ƒçš„</strong>ã€‚è¿™æ„å‘³ç€åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæ¨¡å‹ä¼šä¸æ–­ä¼˜åŒ–å®ƒä»¬ï¼Œå­¦ä¼šå¦‚ä½•å°†åŸå§‹è¾“å…¥<code>x</code> è½¬æ¢æˆæœ€æœ‰æ•ˆçš„ Qã€K å’ŒVï¼Œä»è€Œå­¦ä¼š<strong>å¦‚ä½•æ›´å¥½åœ°å»å…³æ³¨</strong>ï¼Œè®©æ³¨æ„åŠ›çš„è®¡ç®—æœ¬èº«å˜å¾—çµæ´»è€Œå¼ºå¤§ã€‚ï¼ˆæ‰€ä»¥æ‰ç§°è¿™ä¸ªç‰ˆæœ¬æ˜¯å¸¦å¯è®­ç»ƒæƒé‡çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶ï¼‰</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/1*moKYjUdtx-uEyYMbhPWbIw.png"alt="Linear transformation of the word embedding to obtain Query, Key, and Value vectors â€” From(https://epichka.com/blog/2023/qkv-transformer/)" /><figcaption aria-hidden="true">Linear transformation of the wordembedding to obtain Query, Key, and Value vectors â€”From(https://epichka.com/blog/2023/qkv-transformer/)</figcaption></figure><p>ä»£ç å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SelfAttention_v2</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, d_in, d_out, qkv_bias=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        d_in (int): è¾“å…¥å‘é‡çš„ç»´åº¦ã€‚</span></span><br><span class="line"><span class="string">        d_out (int): æŸ¥è¯¢(Query)ã€é”®(Key)å’Œå€¼(Value)å‘é‡çš„è¾“å‡ºç»´åº¦ã€‚</span></span><br><span class="line"><span class="string">        qkv_bias (bool): æ˜¯å¦ä¸ºQ, K, Vçº¿æ€§å±‚æ·»åŠ åç½®é¡¹ã€‚</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="comment"># ä½¿ç”¨ nn.Linear å±‚æ¥å®šä¹‰ Q, K, V çš„çº¿æ€§å˜æ¢ã€‚</span></span><br><span class="line">        <span class="comment"># ç›¸æ¯”æ‰‹åŠ¨åˆ›å»º nn.Parameterï¼Œnn.Linear æä¾›äº†æ›´ä¼˜çš„æƒé‡åˆå§‹åŒ–ï¼Œå¹¶å¯é€‰æ‹©æ€§åœ°åŒ…å«åç½®é¡¹ï¼Œ</span></span><br><span class="line">        <span class="comment"># æ˜¯ PyTorch ä¸­å®ç°çº¿æ€§å˜æ¢çš„æ ‡å‡†åšæ³•ã€‚</span></span><br><span class="line">        <span class="variable language_">self</span>.W_query = nn.Linear(d_in, d_out, bias=qkv_bias)</span><br><span class="line">        <span class="variable language_">self</span>.W_key = nn.Linear(d_in, d_out, bias=qkv_bias)</span><br><span class="line">        <span class="variable language_">self</span>.W_value = nn.Linear(d_in, d_out, bias=qkv_bias)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        x (torch.Tensor): è¾“å…¥å¼ é‡ï¼Œå½¢çŠ¶ä¸º [æ‰¹é‡å¤§å°, åºåˆ—é•¿åº¦, d_in]ã€‚</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 1. çº¿æ€§æŠ•å½±ï¼šå°†è¾“å…¥ x è½¬æ¢ä¸º Q, K, V è¡¨ç¤º</span></span><br><span class="line">        <span class="comment"># æ¯ä¸ªè¾“å…¥è¯å…ƒçš„å‘é‡éƒ½ä¼šé€šè¿‡ç‹¬ç«‹çš„çº¿æ€§å±‚ï¼Œç”Ÿæˆå…¶åœ¨æŸ¥è¯¢ã€é”®ã€å€¼ä¸‰ä¸ªç©ºé—´ä¸­çš„æ–°è¡¨ç¤ºã€‚</span></span><br><span class="line">        keys = <span class="variable language_">self</span>.W_key(x)      <span class="comment"># å½¢çŠ¶: [æ‰¹é‡å¤§å°, åºåˆ—é•¿åº¦, d_out]</span></span><br><span class="line">        queries = <span class="variable language_">self</span>.W_query(x)  <span class="comment"># å½¢çŠ¶: [æ‰¹é‡å¤§å°, åºåˆ—é•¿åº¦, d_out]</span></span><br><span class="line">        values = <span class="variable language_">self</span>.W_value(x)    <span class="comment"># å½¢çŠ¶: [æ‰¹é‡å¤§å°, åºåˆ—é•¿åº¦, d_out]</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2. è®¡ç®—æ³¨æ„åŠ›åˆ†æ•°ï¼šé€šè¿‡ç‚¹ç§¯è¡¡é‡ Query å’Œ Key çš„ç›¸ä¼¼åº¦</span></span><br><span class="line">        <span class="comment"># queries ä¸ keys çš„è½¬ç½® (.T) è¿›è¡ŒçŸ©é˜µç›¸ä¹˜ï¼Œå¾—åˆ°ä¸€ä¸ªæ³¨æ„åŠ›åˆ†æ•°çŸ©é˜µã€‚</span></span><br><span class="line">        <span class="comment"># çŸ©é˜µä¸­çš„æ¯ä¸ªå…ƒç´  attn_scores[i, j] ä»£è¡¨ç¬¬ i ä¸ªæŸ¥è¯¢ä¸ç¬¬ j ä¸ªé”®ä¹‹é—´çš„åŸå§‹ç›¸å…³æ€§ã€‚</span></span><br><span class="line">        attn_scores = queries @ keys.T</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3. ç¼©æ”¾ä¸å½’ä¸€åŒ–ï¼šå°†åˆ†æ•°è½¬æ¢ä¸ºæœ€ç»ˆçš„æ³¨æ„åŠ›æƒé‡</span></span><br><span class="line">        <span class="comment"># a. ç¼©æ”¾(Scaling): å°†åˆ†æ•°é™¤ä»¥ key å‘é‡ç»´åº¦çš„å¹³æ–¹æ ¹ã€‚è¿™ä¸€æ­¥å¯¹äºç¨³å®šè®­ç»ƒè‡³å…³é‡è¦ï¼Œ</span></span><br><span class="line">        <span class="comment">#    å¯ä»¥é˜²æ­¢åœ¨ç»´åº¦è¿‡é«˜æ—¶ï¼Œç‚¹ç§¯ç»“æœè¿‡å¤§å¯¼è‡´ softmax æ¢¯åº¦æ¶ˆå¤±ã€‚</span></span><br><span class="line">        <span class="comment"># b. å½’ä¸€åŒ–(Normalization): ä½¿ç”¨ softmax å‡½æ•°å°†ç¼©æ”¾åçš„åˆ†æ•°è½¬æ¢ä¸ºæ¦‚ç‡åˆ†å¸ƒï¼Œ</span></span><br><span class="line">        <span class="comment">#    ç¡®ä¿æ¯ä¸€è¡Œï¼ˆä»£è¡¨æ¯ä¸ªæŸ¥è¯¢ï¼‰çš„æ³¨æ„åŠ›æƒé‡æ€»å’Œä¸º1ã€‚</span></span><br><span class="line">        attn_weights = torch.softmax(</span><br><span class="line">            attn_scores / keys.shape[-<span class="number">1</span>] ** <span class="number">0.5</span>, dim=-<span class="number">1</span>,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 4. è®¡ç®—ä¸Šä¸‹æ–‡å‘é‡ï¼šå¯¹ Value å‘é‡è¿›è¡ŒåŠ æƒæ±‚å’Œ</span></span><br><span class="line">        <span class="comment"># å°†ä¸Šä¸€æ­¥å¾—åˆ°çš„æ³¨æ„åŠ›æƒé‡çŸ©é˜µä¸ values çŸ©é˜µç›¸ä¹˜ã€‚</span></span><br><span class="line">        <span class="comment"># è¿™ä¸€æ­¥æ˜¯æ ¹æ®æ³¨æ„åŠ›æƒé‡ï¼Œå¯¹æ‰€æœ‰è¯å…ƒçš„ Value ä¿¡æ¯è¿›è¡ŒåŠ æƒèšåˆï¼Œ</span></span><br><span class="line">        <span class="comment"># æœ€ç»ˆä¸ºæ¯ä¸ªè¯å…ƒç”Ÿæˆä¸€ä¸ªèåˆäº†å…¨å±€ä¸Šä¸‹æ–‡ä¿¡æ¯çš„æ–°å‘é‡ã€‚</span></span><br><span class="line">        context_vec = attn_weights @ values</span><br><span class="line">        <span class="keyword">return</span> context_vec</span><br></pre></td></tr></table></figure><p>å¤§ä½“æµç¨‹å¯å‚è€ƒä¸‹å›¾ç†è§£ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/1*6BEwO4jKy9UC7AzU6nIPPg.png"alt="Dot-product attention procedure â€”From(https://epichka.com/blog/2023/qkv-transformer/)" /><figcaption aria-hidden="true">Dot-product attention procedureâ€”From(https://epichka.com/blog/2023/qkv-transformer/)</figcaption></figure><blockquote><p>[!NOTE]</p><p><strong>ç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›çš„åŸç†</strong>ï¼šå¯¹åµŒå…¥ç»´åº¦è¿›è¡Œå½’ä¸€åŒ–æ˜¯ä¸ºäº†é¿å…æ¢¯åº¦è¿‡å°ï¼Œä»è€Œæå‡è®­ç»ƒæ€§èƒ½ã€‚ä¾‹å¦‚ï¼Œåœ¨ç±»GPT å¤§è¯­è¨€æ¨¡å‹ä¸­ï¼ŒåµŒå…¥ç»´åº¦é€šå¸¸å¤§äº1000ï¼Œè¿™å¯èƒ½å¯¼è‡´ç‚¹ç§¯éå¸¸å¤§ï¼Œä»è€Œåœ¨åå‘ä¼ æ’­æ—¶ç”±äº softmaxå‡½æ•°çš„ä½œç”¨å¯¼è‡´æ¢¯åº¦éå¸¸å°ã€‚å½“ç‚¹ç§¯å¢å¤§æ—¶ï¼Œsoftmaxå‡½æ•°ä¼šè¡¨ç°å¾—æ›´åƒé˜¶è·ƒå‡½æ•°ï¼Œå¯¼è‡´æ¢¯åº¦æ¥è¿‘é›¶ã€‚è¿™äº›å°æ¢¯åº¦å¯èƒ½ä¼šæ˜¾è‘—å‡æ…¢å­¦ä¹ é€Ÿåº¦æˆ–ä½¿è®­ç»ƒåœæ»ã€‚</p><p>å› æ­¤ï¼Œé€šè¿‡åµŒå…¥ç»´åº¦çš„å¹³æ–¹æ ¹è¿›è¡Œç¼©æ”¾è§£é‡Šäº†ä¸ºä»€ä¹ˆè¿™ç§è‡ªæ³¨æ„åŠ›æœºåˆ¶ä¹Ÿè¢«ç§°ä¸ºç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›æœºåˆ¶ã€‚</p></blockquote><h4 id="åˆ©ç”¨å› æœæ³¨æ„åŠ›éšè—æœªæ¥è¯æ±‡">2.4.1.3åˆ©ç”¨å› æœæ³¨æ„åŠ›éšè—æœªæ¥è¯æ±‡</h4><p>å¯¹äºåƒ GPTè¿™æ ·ç”¨äºæ–‡æœ¬ç”Ÿæˆçš„æ¨¡å‹ï¼Œæœ‰ä¸€ä¸ªæ ¸å¿ƒè¦æ±‚ï¼š<u>åœ¨é¢„æµ‹åºåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªè¯å…ƒæ—¶ï¼Œæ¨¡å‹åªèƒ½çœ‹åˆ°å½“å‰ä½ç½®åŠä¹‹å‰çš„ä¿¡æ¯ï¼Œç»ä¸èƒ½å·çœ‹æœªæ¥çš„è¯å…ƒã€‚</u>æ ‡å‡†çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶ä¼šä¸€æ¬¡æ€§è®¿é—®æ•´ä¸ªè¾“å…¥åºåˆ—ï¼Œè¿™æ˜¾ç„¶ä¸ç¬¦åˆè¦æ±‚ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¼•å…¥äº†<strong>å› æœæ³¨æ„åŠ›ï¼ˆCausalAttentionï¼‰</strong>ï¼Œä¹Ÿç§°ä¸ºæ©ç æ³¨æ„åŠ›ï¼ˆMasked Attentionï¼‰ã€‚</p><p>å®ç°å› æœæ³¨æ„åŠ›çš„å…³é”®åœ¨äº<strong>æ©ç ï¼ˆMaskingï¼‰</strong>æ“ä½œã€‚å…·ä½“åšæ³•æ˜¯åœ¨è®¡ç®—å‡ºæ³¨æ„åŠ›åˆ†æ•°ä¹‹åã€åº”ç”¨Softmax å‡½æ•°ä¹‹å‰ï¼Œå¯¹æ³¨æ„åŠ›åˆ†æ•°çŸ©é˜µè¿›è¡Œä¿®æ”¹ã€‚æˆ‘ä»¬ä¼šåˆ›å»ºä¸€ä¸ª"ä¸Šä¸‰è§’"æ©ç çŸ©é˜µï¼Œå…¶ä¸­ä¸»å¯¹è§’çº¿åŠä»¥ä¸‹çš„å…ƒç´ ä¸º0ï¼Œè€Œä¸»å¯¹è§’çº¿ä»¥ä¸Šçš„å…ƒç´ ä¸ºè´Ÿæ— ç©·å¤§ (<code>-inf</code>) ã€‚</p><p>å½“è¿™ä¸ªæ©ç çŸ©é˜µè¢«åŠ åˆ°æ³¨æ„åŠ›åˆ†æ•°çŸ©é˜µä¸Šæ—¶ï¼Œæ‰€æœ‰ä»£è¡¨"æœªæ¥"ä½ç½®çš„åˆ†æ•°éƒ½ä¼šå˜æˆè´Ÿæ— ç©·å¤§ã€‚ç»è¿‡ Softmax å‡½æ•°å¤„ç†åï¼Œè¿™äº›è´Ÿæ— ç©·å¤§çš„å€¼å¯¹åº”çš„æ¦‚ç‡ä¼šå˜ä¸º 0ã€‚è¿™æ ·ä¸€æ¥ï¼Œä»»ä½•è¯å…ƒåœ¨è®¡ç®—å…¶ä¸Šä¸‹æ–‡å‘é‡æ—¶ï¼Œå…¶æ³¨æ„åŠ›æƒé‡éƒ½åªä¼šåˆ†å¸ƒåœ¨å®ƒè‡ªèº«åŠä¹‹å‰çš„ä½ç½®ä¸Šï¼Œä»è€Œæœ‰æ•ˆåœ°éšè—äº†æœªæ¥çš„è¯æ±‡ã€‚</p><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250830233836610.png" /></p><p>ä»£ç å®ç°é€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># diagonal=1 è¡¨ç¤ºä¸åŒ…å«ä¸»å¯¹è§’çº¿ï¼ŒåªåŒ…å«ä¸Šä¸‰è§’éƒ¨åˆ†</span></span><br><span class="line">mask = torch.triu(torch.ones(context_length, context_length), diagonal=<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(mask)</span><br><span class="line"><span class="comment"># masked_fill() ç”¨æŒ‡å®šå€¼å¡«å……æ©ç ä¸ºTrueçš„ä½ç½®</span></span><br><span class="line">masked = attn_scores.masked_fill(mask.<span class="built_in">bool</span>(), -torch.inf)</span><br><span class="line"><span class="built_in">print</span>(masked)</span><br><span class="line"><span class="comment"># masked / keys.shape[-1]**0.5 è¿›è¡Œç¼©æ”¾ï¼Œtorch.softmax è¿›è¡Œå½’ä¸€åŒ–</span></span><br><span class="line">attn_weights = torch.softmax(masked / keys.shape[-<span class="number">1</span>]**<span class="number">0.5</span>, dim=<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(attn_weights)</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">tensor([[<span class="number">0.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>],</span><br><span class="line">        [<span class="number">0.</span>, <span class="number">0.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>],</span><br><span class="line">        [<span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>],</span><br><span class="line">        [<span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">1.</span>, <span class="number">1.</span>],</span><br><span class="line">        [<span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">1.</span>],</span><br><span class="line">        [<span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>]])</span><br><span class="line">tensor([[-<span class="number">0.0763</span>,    -inf,    -inf,    -inf,    -inf,    -inf],</span><br><span class="line">        [-<span class="number">0.0408</span>,  <span class="number">0.0038</span>,    -inf,    -inf,    -inf,    -inf],</span><br><span class="line">        [-<span class="number">0.0423</span>,  <span class="number">0.0025</span>,  <span class="number">0.0074</span>,    -inf,    -inf,    -inf],</span><br><span class="line">        [-<span class="number">0.0090</span>,  <span class="number">0.0404</span>,  <span class="number">0.0416</span>,  <span class="number">0.0233</span>,    -inf,    -inf],</span><br><span class="line">        [-<span class="number">0.0586</span>, -<span class="number">0.0207</span>, -<span class="number">0.0141</span>, -<span class="number">0.0227</span>,  <span class="number">0.1097</span>,    -inf],</span><br><span class="line">        [ <span class="number">0.0040</span>,  <span class="number">0.0504</span>,  <span class="number">0.0502</span>,  <span class="number">0.0317</span>,  <span class="number">0.0320</span>,  <span class="number">0.0354</span>]],</span><br><span class="line">       grad_fn=&lt;MaskedFillBackward0&gt;)</span><br><span class="line">tensor([[<span class="number">1.0000</span>, <span class="number">0.0000</span>, <span class="number">0.0000</span>, <span class="number">0.0000</span>, <span class="number">0.0000</span>, <span class="number">0.0000</span>],</span><br><span class="line">        [<span class="number">0.4921</span>, <span class="number">0.5079</span>, <span class="number">0.0000</span>, <span class="number">0.0000</span>, <span class="number">0.0000</span>, <span class="number">0.0000</span>],</span><br><span class="line">        [<span class="number">0.3259</span>, <span class="number">0.3364</span>, <span class="number">0.3376</span>, <span class="number">0.0000</span>, <span class="number">0.0000</span>, <span class="number">0.0000</span>],</span><br><span class="line">        [<span class="number">0.2442</span>, <span class="number">0.2529</span>, <span class="number">0.2531</span>, <span class="number">0.2498</span>, <span class="number">0.0000</span>, <span class="number">0.0000</span>],</span><br><span class="line">        [<span class="number">0.1919</span>, <span class="number">0.1971</span>, <span class="number">0.1980</span>, <span class="number">0.1968</span>, <span class="number">0.2161</span>, <span class="number">0.0000</span>],</span><br><span class="line">        [<span class="number">0.1632</span>, <span class="number">0.1686</span>, <span class="number">0.1686</span>, <span class="number">0.1664</span>, <span class="number">0.1664</span>, <span class="number">0.1668</span>]],</span><br><span class="line">       grad_fn=&lt;SoftmaxBackward0&gt;)</span><br></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œä¸ºäº†é˜²æ­¢æ¨¡å‹åœ¨è®­ç»ƒä¸­è¿‡æ‹Ÿåˆï¼Œè¿˜å¯ä»¥åœ¨æ³¨æ„åŠ›æƒé‡çŸ©é˜µä¸Šåº”ç”¨æˆ‘ä»¬å‰é¢æåˆ°çš„<strong>Dropout</strong>æŠ€æœ¯ã€‚å³åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œéšæœºåœ°å°†ä¸€éƒ¨åˆ†æ³¨æ„åŠ›æƒé‡ç½®ä¸ºé›¶ï¼Œè¿™æœ‰åŠ©äºå¢å¼ºæ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ã€‚</p><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250830234226162.png" /></p><p>ä»£ç å®ç°é€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dropout = torch.nn.Dropout(<span class="number">0.5</span>) <span class="comment"># ä½¿ç”¨ 50% çš„ dropout ç‡</span></span><br><span class="line">example = torch.ones(<span class="number">6</span>, <span class="number">6</span>)</span><br><span class="line"><span class="built_in">print</span>(example)</span><br><span class="line"><span class="built_in">print</span>(dropout(example))</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¹æƒé‡çŸ©é˜µè¿›è¡Œ dropout</span></span><br><span class="line"><span class="built_in">print</span>(dropout(attn_weights))</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">tensor([[<span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>],</span><br><span class="line">        [<span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>],</span><br><span class="line">        [<span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>],</span><br><span class="line">        [<span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>],</span><br><span class="line">        [<span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>],</span><br><span class="line">        [<span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>]])</span><br><span class="line">tensor([[<span class="number">2.</span>, <span class="number">2.</span>, <span class="number">0.</span>, <span class="number">2.</span>, <span class="number">2.</span>, <span class="number">0.</span>],</span><br><span class="line">        [<span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">2.</span>, <span class="number">0.</span>, <span class="number">2.</span>],</span><br><span class="line">        [<span class="number">2.</span>, <span class="number">2.</span>, <span class="number">2.</span>, <span class="number">2.</span>, <span class="number">0.</span>, <span class="number">2.</span>],</span><br><span class="line">        [<span class="number">0.</span>, <span class="number">2.</span>, <span class="number">2.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">2.</span>],</span><br><span class="line">        [<span class="number">0.</span>, <span class="number">2.</span>, <span class="number">0.</span>, <span class="number">2.</span>, <span class="number">0.</span>, <span class="number">2.</span>],</span><br><span class="line">        [<span class="number">0.</span>, <span class="number">2.</span>, <span class="number">2.</span>, <span class="number">2.</span>, <span class="number">2.</span>, <span class="number">0.</span>]])</span><br><span class="line">tensor([[<span class="number">2.0000</span>, <span class="number">0.0000</span>, <span class="number">0.0000</span>, <span class="number">0.0000</span>, <span class="number">0.0000</span>, <span class="number">0.0000</span>],</span><br><span class="line">        [<span class="number">0.0000</span>, <span class="number">0.0000</span>, <span class="number">0.0000</span>, <span class="number">0.0000</span>, <span class="number">0.0000</span>, <span class="number">0.0000</span>],</span><br><span class="line">        [<span class="number">0.0000</span>, <span class="number">0.6790</span>, <span class="number">0.6818</span>, <span class="number">0.0000</span>, <span class="number">0.0000</span>, <span class="number">0.0000</span>],</span><br><span class="line">        [<span class="number">0.0000</span>, <span class="number">0.0000</span>, <span class="number">0.5059</span>, <span class="number">0.5040</span>, <span class="number">0.0000</span>, <span class="number">0.0000</span>],</span><br><span class="line">        [<span class="number">0.0000</span>, <span class="number">0.0000</span>, <span class="number">0.0000</span>, <span class="number">0.0000</span>, <span class="number">0.4336</span>, <span class="number">0.0000</span>],</span><br><span class="line">        [<span class="number">0.3242</span>, <span class="number">0.3345</span>, <span class="number">0.0000</span>, <span class="number">0.3339</span>, <span class="number">0.3433</span>, <span class="number">0.3292</span>]],</span><br><span class="line">       grad_fn=&lt;MulBackward0&gt;)</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å¤§çº¦ä¸€åŠçš„å€¼è¢«ç½®ä¸º0ï¼Œä¸”åŸæ¥çš„å€¼è¢«æ”¾å¤§äº†ï¼Œç”¨äºä½ç½®æƒé‡çš„æ•´ä½“å¹³è¡¡ã€‚</p><p>ä¸€ä¸ªå®Œæ•´çš„ç®€å•å› æœæ³¨æ„åŠ›ç±»çš„å‚è€ƒå®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CausalAttention</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ä¸€ä¸ªå®ç°äº†å› æœè‡ªæ³¨æ„åŠ›ï¼ˆCausal Self-Attentionï¼‰çš„æ¨¡å—ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    å› æœç‰¹æ€§ç¡®ä¿åœ¨å¤„ç†åºåˆ—ä¸­çš„ä»»ä½•ä¸€ä¸ªè¯å…ƒï¼ˆtokenï¼‰æ—¶ï¼Œ</span></span><br><span class="line"><span class="string">    æ³¨æ„åŠ›æœºåˆ¶åªèƒ½å…³æ³¨åˆ°å½“å‰ä½ç½®åŠä¹‹å‰ä½ç½®çš„è¯å…ƒï¼Œè€Œä¸èƒ½çœ‹åˆ°æœªæ¥çš„è¯å…ƒã€‚</span></span><br><span class="line"><span class="string">    è¿™å¯¹äºè‡ªå›å½’ï¼ˆauto-regressiveï¼‰çš„æ–‡æœ¬ç”Ÿæˆä»»åŠ¡è‡³å…³é‡è¦ã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, d_in, d_out, context_length, dropout, qkv_bias=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        åˆå§‹åŒ–æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        å‚æ•°:</span></span><br><span class="line"><span class="string">        d_in (int): è¾“å…¥åµŒå…¥å‘é‡çš„ç»´åº¦ã€‚</span></span><br><span class="line"><span class="string">        d_out (int): æŸ¥è¯¢(Query)ã€é”®(Key)å’Œå€¼(Value)å‘é‡çš„è¾“å‡ºç»´åº¦ã€‚</span></span><br><span class="line"><span class="string">        context_length (int): æ¨¡å‹çš„æœ€å¤§åºåˆ—é•¿åº¦ï¼Œç”¨äºåˆ›å»ºå› æœæ©ç ã€‚</span></span><br><span class="line"><span class="string">        dropout (float): åº”ç”¨äºæ³¨æ„åŠ›æƒé‡çŸ©é˜µçš„ dropout æ¯”ç‡ã€‚</span></span><br><span class="line"><span class="string">        qkv_bias (bool): æ˜¯å¦ä¸º Q, K, V çš„çº¿æ€§å±‚æ·»åŠ åç½®é¡¹ã€‚</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="variable language_">self</span>.d_out = d_out</span><br><span class="line">        <span class="comment"># å®šä¹‰ç”¨äºç”Ÿæˆ Query, Key, Value çš„çº¿æ€§å˜æ¢å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.W_query = nn.Linear(d_in, d_out, bias=qkv_bias)</span><br><span class="line">        <span class="variable language_">self</span>.W_key   = nn.Linear(d_in, d_out, bias=qkv_bias)</span><br><span class="line">        <span class="variable language_">self</span>.W_value = nn.Linear(d_in, d_out, bias=qkv_bias)</span><br><span class="line">        <span class="comment"># å®šä¹‰ Dropout å±‚ï¼Œç”¨äºæ­£åˆ™åŒ–ï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆ</span></span><br><span class="line">        <span class="variable language_">self</span>.dropout = nn.Dropout(dropout)</span><br><span class="line">        <span class="comment"># åˆ›å»ºå¹¶æ³¨å†Œå› æœæ©ç ï¼ˆcausal maskï¼‰</span></span><br><span class="line">        <span class="comment"># register_buffer å°†ä¸€ä¸ªå¼ é‡æ³¨å†Œä¸ºæ¨¡å—çš„ç¼“å†²åŒºï¼Œå®ƒä¸ä¼šè¢«è§†ä¸ºæ¨¡å‹å‚æ•°ï¼ˆå³ä¸ä¼šåœ¨è®­ç»ƒä¸­è¢«æ›´æ–°ï¼‰ï¼Œ</span></span><br><span class="line">        <span class="comment"># ä½†ä¼šéšç€æ¨¡å‹ç§»åŠ¨ï¼ˆä¾‹å¦‚ï¼Œ.to(device)ï¼‰ã€‚</span></span><br><span class="line">        <span class="variable language_">self</span>.register_buffer(</span><br><span class="line">            <span class="string">&#x27;mask&#x27;</span>,</span><br><span class="line">            <span class="comment"># torch.triu åˆ›å»ºä¸€ä¸ªä¸Šä¸‰è§’çŸ©é˜µã€‚diagonal=1 è¡¨ç¤ºä¸»å¯¹è§’çº¿ï¼ˆåŠä»¥ä¸‹ï¼‰çš„å…ƒç´ éƒ½ä¸º0ï¼Œ</span></span><br><span class="line">            <span class="comment"># åªæœ‰ä¸»å¯¹è§’çº¿ä¸Šæ–¹çš„å…ƒç´ ä¸º1ã€‚è¿™ä¸ªçŸ©é˜µç”¨äºå±è”½æœªæ¥çš„ä½ç½®ã€‚</span></span><br><span class="line">            torch.triu(torch.ones(context_length, context_length), diagonal=<span class="number">1</span>)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        æ‰§è¡Œå‰å‘ä¼ æ’­ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        å‚æ•°:</span></span><br><span class="line"><span class="string">        x (torch.Tensor): è¾“å…¥å¼ é‡ï¼Œå½¢çŠ¶ä¸º [æ‰¹é‡å¤§å°, åºåˆ—é•¿åº¦, è¾“å…¥åµŒå…¥ç»´åº¦ d_in]ã€‚</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># è·å–è¾“å…¥çš„ç»´åº¦ä¿¡æ¯</span></span><br><span class="line">        b, num_tokens, d_in = x.shape</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 1. å°†è¾“å…¥ x æŠ•å½±åˆ° Query, Key, Value ç©ºé—´</span></span><br><span class="line">        keys = <span class="variable language_">self</span>.W_key(x)      <span class="comment"># è¾“å‡ºå½¢çŠ¶: [b, num_tokens, d_out]</span></span><br><span class="line">        queries = <span class="variable language_">self</span>.W_query(x) <span class="comment"># è¾“å‡ºå½¢çŠ¶: [b, num_tokens, d_out]</span></span><br><span class="line">        values = <span class="variable language_">self</span>.W_value(x)  <span class="comment"># è¾“å‡ºå½¢çŠ¶: [b, num_tokens, d_out]</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2. è®¡ç®—æ³¨æ„åŠ›åˆ†æ•°</span></span><br><span class="line">        <span class="comment"># å°† keys çš„æœ€åä¸¤ä¸ªç»´åº¦è½¬ç½®ï¼Œä»¥ä¾¿è¿›è¡ŒçŸ©é˜µä¹˜æ³•</span></span><br><span class="line">        <span class="comment"># å½¢çŠ¶ä» [b, num_tokens, d_out] å˜ä¸º [b, d_out, num_tokens]</span></span><br><span class="line">        <span class="comment"># queries @ keys.transpose(...) è®¡ç®—æ¯ä¸ªæŸ¥è¯¢ä¸æ‰€æœ‰é”®çš„ç‚¹ç§¯</span></span><br><span class="line">        attn_scores = queries @ keys.transpose(<span class="number">1</span>, <span class="number">2</span>)  <span class="comment"># è¾“å‡ºå½¢çŠ¶: [b, num_tokens, num_tokens]</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3. åº”ç”¨å› æœæ©ç </span></span><br><span class="line">        <span class="comment"># masked_fill_ æ˜¯ä¸€ä¸ªåŸåœ°æ“ä½œï¼ˆin-placeï¼‰ï¼Œå®ƒä¼šç›´æ¥ä¿®æ”¹ attn_scores å¼ é‡</span></span><br><span class="line">        <span class="comment"># self.mask.bool()[:num_tokens, :num_tokens] ä¼šé€‰å–ä¸å½“å‰è¾“å…¥åºåˆ—é•¿åº¦åŒ¹é…çš„æ©ç éƒ¨åˆ†</span></span><br><span class="line">        <span class="comment"># å¹¶å°†æ‰€æœ‰éœ€è¦å±è”½çš„â€œæœªæ¥â€ä½ç½®çš„åˆ†æ•°å¡«å……ä¸ºè´Ÿæ— ç©·å¤§</span></span><br><span class="line">        attn_scores.masked_fill_(</span><br><span class="line">            <span class="variable language_">self</span>.mask.<span class="built_in">bool</span>()[:num_tokens, :num_tokens], -torch.inf</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 4. ç¼©æ”¾åˆ†æ•°å¹¶åº”ç”¨ softmax å¾—åˆ°æ³¨æ„åŠ›æƒé‡</span></span><br><span class="line">        <span class="comment"># a. ç¼©æ”¾ (Scaling): é™¤ä»¥ key ç»´åº¦çš„å¹³æ–¹æ ¹ï¼Œç¨³å®šæ¢¯åº¦</span></span><br><span class="line">        <span class="comment"># b. Softmax: å°†åˆ†æ•°è½¬æ¢ä¸ºæ¦‚ç‡åˆ†å¸ƒã€‚ç”±äºæœªæ¥ä½ç½®çš„åˆ†æ•°æ˜¯è´Ÿæ— ç©·ï¼Œ</span></span><br><span class="line">        <span class="comment">#    ç»è¿‡ softmax åå®ƒä»¬çš„æƒé‡å°†å˜ä¸º0ã€‚</span></span><br><span class="line">        attn_weights = torch.softmax(</span><br><span class="line">            attn_scores / keys.shape[-<span class="number">1</span>]**<span class="number">0.5</span>, dim=-<span class="number">1</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 5. åº”ç”¨ Dropout</span></span><br><span class="line">        <span class="comment"># åœ¨è®­ç»ƒé˜¶æ®µï¼Œéšæœºå°†ä¸€äº›æ³¨æ„åŠ›æƒé‡ç½®ä¸º0ï¼Œä»¥é˜²æ­¢è¿‡æ‹Ÿåˆ</span></span><br><span class="line">        attn_weights = <span class="variable language_">self</span>.dropout(attn_weights)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 6. è®¡ç®—ä¸Šä¸‹æ–‡å‘é‡</span></span><br><span class="line">        <span class="comment"># å°†æ³¨æ„åŠ›æƒé‡ä¸ value å‘é‡ç›¸ä¹˜ï¼Œå¾—åˆ°åŠ æƒå’Œ</span></span><br><span class="line">        context_vec = attn_weights @ values <span class="comment"># è¾“å‡ºå½¢çŠ¶: [b, num_tokens, d_out]</span></span><br><span class="line">        <span class="keyword">return</span> context_vec</span><br></pre></td></tr></table></figure><h4 id="å°†å•å¤´æ³¨æ„åŠ›æ‰©å±•åˆ°å¤šå¤´æ³¨æ„åŠ›">2.4.1.4å°†å•å¤´æ³¨æ„åŠ›æ‰©å±•åˆ°å¤šå¤´æ³¨æ„åŠ›</h4><p>è™½ç„¶å¸¦æœ‰å¯è®­ç»ƒæƒé‡çš„å› æœè‡ªæ³¨æ„åŠ›æœºåˆ¶å·²ç»éå¸¸å¼ºå¤§ï¼Œä½†å®ƒä»ç„¶æœ‰å±€é™æ€§ï¼š<u>æ¨¡å‹åœ¨æŸä¸ªä½ç½®åªèƒ½å­¦ä¹ åˆ°ä¸€ç§æ³¨æ„åŠ›æ¨¡å¼</u>ã€‚ä¸ºäº†è®©æ¨¡å‹èƒ½å¤Ÿä»ä¸åŒè§’åº¦ã€ä¸åŒè¡¨ç¤ºå­ç©ºé—´å…±åŒå…³æ³¨ä¿¡æ¯ï¼ŒåŸå§‹Transformer è®ºæ–‡å¼•å…¥äº†<strong>å¤šå¤´æ³¨æ„åŠ›ï¼ˆMulti-HeadAttentionï¼‰</strong>æœºåˆ¶ ã€‚</p><p>"å¤šå¤´"çš„æ ¸å¿ƒæ€æƒ³æ˜¯å¹¶è¡Œåœ°è¿è¡Œå¤šæ¬¡æ³¨æ„åŠ›è®¡ç®—ï¼Œè€Œä¸æ˜¯åªè¿›è¡Œä¸€æ¬¡ã€‚å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p><ol type="1"><li><strong>åˆ†å‰²æˆå¤šä¸ªå¤´</strong>ï¼šæˆ‘ä»¬ä¸å†åªæœ‰ä¸€ç»„ <spanclass="math inline">\(W_q\)</span>ã€<spanclass="math inline">\(W_k\)</span>ã€<spanclass="math inline">\(W_v\)</span>æƒé‡çŸ©é˜µï¼Œè€Œæ˜¯ä¸ºæ¯ä¸ªå¤´éƒ½åˆ›å»ºä¸€ç»„ç‹¬ç«‹çš„æƒé‡çŸ©é˜µ ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ 12ä¸ªå¤´ï¼Œé‚£æˆ‘ä»¬å°±æœ‰ 12 ç»„è¿™æ ·çš„çŸ©é˜µã€‚</li><li><strong>å¹¶è¡Œè®¡ç®—æ³¨æ„åŠ›</strong>ï¼šæ¯ä¸ªå¤´éƒ½ç‹¬ç«‹åœ°å¯¹è¾“å…¥æ‰§è¡Œç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›è®¡ç®—ï¼ˆåŒ…å«å› æœæ©ç ï¼‰ã€‚ç”±äºæ¯ä¸ªå¤´æ‹¥æœ‰ä¸åŒçš„æƒé‡çŸ©é˜µï¼Œå®ƒä»¬ä¼šå°†è¾“å…¥æŠ•å½±åˆ°ä¸åŒçš„è¡¨ç¤ºå­ç©ºé—´ï¼Œä»è€Œå­¦ä¹ åˆ°è¾“å…¥åºåˆ—çš„ä¸åŒæ–¹é¢ç‰¹å¾ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªå¤´å¯èƒ½å…³æ³¨è¯­æ³•ç»“æ„ï¼Œå¦ä¸€ä¸ªå¤´å¯èƒ½å…³æ³¨è¯­ä¹‰å…³è”ã€‚</li><li><strong>æ‹¼æ¥ä¸æŠ•å½±</strong>ï¼šåœ¨æ‰€æœ‰å¤´éƒ½å®Œæˆè®¡ç®—åï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°å¤šä¸ªè¾“å‡ºä¸Šä¸‹æ–‡å‘é‡ã€‚æˆ‘ä»¬å°†è¿™äº›å‘é‡<strong>æ‹¼æ¥ï¼ˆconcatenateï¼‰</strong>åœ¨ä¸€èµ·ï¼Œå½¢æˆä¸€ä¸ªæ›´é•¿çš„å‘é‡ã€‚</li><li><strong>æœ€ç»ˆçº¿æ€§æŠ•å½±</strong>ï¼šæœ€åï¼Œè¿™ä¸ªæ‹¼æ¥åçš„é•¿å‘é‡ä¼šé€šè¿‡ä¸€ä¸ªé¢å¤–çš„çº¿æ€§å±‚ï¼ˆ<code>out_proj</code>ï¼‰è¿›è¡ŒæŠ•å½±ï¼Œå°†å…¶ç»´åº¦æ¢å¤åˆ°æ¨¡å‹æœŸæœ›çš„ç»´åº¦ï¼Œå¹¶èåˆæ‰€æœ‰å¤´å­¦ä¹ åˆ°çš„ä¿¡æ¯ã€‚</li></ol><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250830235007200.png" /></p><p>åœ¨ä»£ç ä¸­ï¼Œå¯ä»¥é€šè¿‡å®ç°ä¸€ä¸ªç®€å•çš„<code>MultiHeadAttentionWrapper</code>ç±»æ¥è¾¾åˆ°è¿™ä¸€ç›®æ ‡ï¼Œ<code>MultiHeadAttentionWrapper</code>ç±»å †å äº†å¤šä¸ªä¹‹å‰å®ç°çš„ <code>CausalAttention</code> æ¨¡å—å®ä¾‹ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MultiHeadAttentionWrapper</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ä¸€ä¸ªå®ç°å¤šå¤´æ³¨æ„åŠ›çš„å°è£…ç±»&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, d_in, d_out, context_length,</span></span><br><span class="line"><span class="params">                dropout, num_heads, qkv_bias=<span class="literal">False</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="variable language_">self</span>.heads = nn.ModuleList(  <span class="comment"># å †å å¤šä¸ª CausalAttention</span></span><br><span class="line">            [CausalAttention(</span><br><span class="line">                d_in, d_out, context_length, dropout, qkv_bias,</span><br><span class="line">            ) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span> (num_heads)]</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="keyword">return</span> torch.cat([head(x) <span class="keyword">for</span> head <span class="keyword">in</span> <span class="variable language_">self</span>.heads], dim=-<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>ä¹¦ä¸­è¿˜æåˆ°äº†ä¸€ç§æ›´é«˜æ•ˆçš„å®ç°æ–¹å¼ï¼šä¸å…¶åˆ›å»ºå¤šç»„ç‹¬ç«‹çš„æƒé‡çŸ©é˜µï¼Œä¸å¦‚åˆ›å»ºä¸€ä¸ªæ›´å¤§çš„æƒé‡çŸ©é˜µï¼Œä¸€æ¬¡æ€§å®Œæˆå¯¹æ‰€æœ‰å¤´çš„æŸ¥è¯¢ã€é”®ã€å€¼å‘é‡çš„è®¡ç®—ï¼Œç„¶åé€šè¿‡é‡å¡‘ï¼ˆreshapeï¼‰å’Œè½¬ç½®ï¼ˆtransposeï¼‰æ“ä½œå°†ç»“æœåˆ†å‰²æˆå¤šä¸ªå¤´ã€‚è¿™ç§æ–¹æ³•åœ¨æ•°å­¦ä¸Šæ˜¯ç­‰ä»·çš„ï¼Œä½†åˆ©ç”¨äº†ç°ä»£ç¡¬ä»¶è¿›è¡Œå¤§è§„æ¨¡çŸ©é˜µè¿ç®—çš„ä¼˜åŠ¿ï¼Œè®¡ç®—æ•ˆç‡æ›´é«˜ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">è¾“å…¥: [2, 6, 3]</span></span><br><span class="line"><span class="string">    â†“</span></span><br><span class="line"><span class="string">Q,K,V: [2, 6, 2]</span></span><br><span class="line"><span class="string">    â†“</span></span><br><span class="line"><span class="string">é‡å¡‘: [2, 6, 2, 1] (2ä¸ªå¤´ï¼Œæ¯ä¸ªå¤´1ç»´)</span></span><br><span class="line"><span class="string">    â†“</span></span><br><span class="line"><span class="string">è½¬ç½®: [2, 2, 6, 1] (2ä¸ªå¤´å¹¶è¡Œè®¡ç®—)</span></span><br><span class="line"><span class="string">    â†“</span></span><br><span class="line"><span class="string">æ³¨æ„åŠ›: [2, 2, 6, 6] (æ¯ä¸ªå¤´æœ‰è‡ªå·±çš„æ³¨æ„åŠ›çŸ©é˜µ)</span></span><br><span class="line"><span class="string">    â†“</span></span><br><span class="line"><span class="string">ä¸Šä¸‹æ–‡: [2, 2, 6, 1] (æ¯ä¸ªå¤´çš„ç»“æœ)</span></span><br><span class="line"><span class="string">    â†“</span></span><br><span class="line"><span class="string">åˆå¹¶: [2, 6, 2] (æ‰€æœ‰å¤´çš„ç»“æœåˆå¹¶)</span></span><br><span class="line"><span class="string">    â†“</span></span><br><span class="line"><span class="string">è¾“å‡ºæŠ•å½±: [2, 6, 2]</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MultiHeadAttention</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ä¸€ä¸ªé«˜æ•ˆçš„å¤šå¤´æ³¨æ„åŠ›ç±»&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, d_in: <span class="built_in">int</span>, d_out: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">                context_length: <span class="built_in">int</span>, dropout: <span class="built_in">float</span>, num_heads: <span class="built_in">int</span>, qkv_bias=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="keyword">assert</span> (d_out % num_heads == <span class="number">0</span>), <span class="string">&quot;d_out must be divisible by num_heads&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.d_out = d_out  <span class="comment"># è¾“å‡ºç»´åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.num_heads = num_heads <span class="comment"># å¤´æ•°é‡</span></span><br><span class="line">        <span class="variable language_">self</span>.head_dim = d_out // num_heads <span class="comment"># æ¯ä¸ªå¤´çš„ç»´åº¦</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># åˆå§‹åŒ–å¯è®­ç»ƒçš„æƒé‡çŸ©é˜µï¼Œåˆ†åˆ«ä»£è¡¨æŸ¥è¯¢å‘é‡ã€é”®å‘é‡ã€å€¼å‘é‡</span></span><br><span class="line">        <span class="variable language_">self</span>.W_query = nn.Linear(d_in, d_out, bias=qkv_bias)</span><br><span class="line">        <span class="variable language_">self</span>.W_key = nn.Linear(d_in, d_out, bias=qkv_bias)</span><br><span class="line">        <span class="variable language_">self</span>.W_value = nn.Linear(d_in, d_out, bias=qkv_bias)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ä½¿ç”¨ä¸€ä¸ªçº¿æ€§å±‚æ¥ç»„åˆå¤´çš„è¾“å‡º</span></span><br><span class="line">        <span class="variable language_">self</span>.out_proj = nn.Linear(d_out, d_out)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ©ç  + dropout</span></span><br><span class="line">        <span class="variable language_">self</span>.dropout = nn.Dropout(dropout)</span><br><span class="line">        <span class="variable language_">self</span>.register_buffer(</span><br><span class="line">            <span class="string">&quot;mask&quot;</span>,</span><br><span class="line">            torch.triu(torch.ones(context_length, context_length), diagonal=<span class="number">1</span>)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="comment"># [batch_size, sequence_length, embedding_dim]</span></span><br><span class="line">        b, num_tokens, d_in = x.shape</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è®¡ç®—æƒé‡çŸ©é˜µ Q/K/V</span></span><br><span class="line">        keys: Tensor = <span class="variable language_">self</span>.W_key(x)</span><br><span class="line">        queries: Tensor = <span class="variable language_">self</span>.W_query(x)</span><br><span class="line">        values: Tensor = <span class="variable language_">self</span>.W_value(x)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># é‡å¡‘ä¸ºå¤šå¤´æ ¼å¼</span></span><br><span class="line">        <span class="comment"># å°† [batch, seq_len, d_out] é‡å¡‘ä¸º [batch, seq_len, num_heads, head_dim]</span></span><br><span class="line">        <span class="comment"># [2, 6, 4] -&gt; [2, 6, 2, 2]</span></span><br><span class="line">        keys = keys.view(b, num_tokens, <span class="variable language_">self</span>.num_heads, <span class="variable language_">self</span>.head_dim)</span><br><span class="line">        values = values.view(b, num_tokens, <span class="variable language_">self</span>.num_heads, <span class="variable language_">self</span>.head_dim)</span><br><span class="line">        queries = queries.view(b, num_tokens, <span class="variable language_">self</span>.num_heads, <span class="variable language_">self</span>.head_dim)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è°ƒæ•´ç»´åº¦é¡ºåºï¼Œè®©æ¯ä¸ªå¤´ç‹¬ç«‹è®¡ç®—æ³¨æ„åŠ›ï¼Œä¾¿äºæ‰¹é‡å¤„ç†æ‰€æœ‰å¤´</span></span><br><span class="line">        <span class="comment"># ä»å½¢çŠ¶ (b, num_tokens, num_heads, head_dim)</span></span><br><span class="line">        <span class="comment"># è½¬æ¢åˆ° (b, num_heads, num_tokens, head_dim)</span></span><br><span class="line">        keys = keys.transpose(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">        values = values.transpose(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">        queries = queries.transpose(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è®¡ç®—æ³¨æ„åŠ›åˆ†æ•°ï¼Œè¿™æ ·æ¯ä¸ªæ‰¹æ¬¡(2)çš„æ¯ä¸ªå¤´(2)éƒ½æœ‰äº†ä¸€ä¸ª 6Ã—6 çš„æ³¨æ„åŠ›åˆ†æ•°çŸ©é˜µ</span></span><br><span class="line">        attn_scores = queries @ keys.transpose(<span class="number">2</span>, <span class="number">3</span>) <span class="comment"># [2, 2, 6, 2] @ [2, 2, 2, 6] = [2, 2, 6, 6]</span></span><br><span class="line">        mask_bool: Tensor = <span class="variable language_">self</span>.mask.<span class="built_in">bool</span>()[:num_tokens, :num_tokens]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># åº”ç”¨å› æœæ©ç </span></span><br><span class="line">        attn_scores.masked_fill_(mask_bool, -torch.inf)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å½’ä¸€åŒ–æƒé‡</span></span><br><span class="line">        attn_weights = torch.softmax(attn_scores / keys.shape[-<span class="number">1</span>]**<span class="number">0.5</span>, dim=-<span class="number">1</span>) <span class="comment"># [2, 2, 6, 6]</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># ä½¿ç”¨ dropout æ©ç å‡å°‘è¿‡æ‹Ÿåˆ</span></span><br><span class="line">        attn_weights = <span class="variable language_">self</span>.dropout(attn_weights) <span class="comment"># [2, 2, 6, 6]</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ¯ä¸ªå¤´è®¡ç®—è‡ªå·±çš„ä¸Šä¸‹æ–‡å‘é‡</span></span><br><span class="line">        context_vec: Tensor = (attn_weights @ values).transpose(<span class="number">1</span>, <span class="number">2</span>) <span class="comment"># [2, 2, 6, 6] @ [2, 2, 6, 2] = [2, 2, 6, 2] -&gt; [2, 6, 2, 2]</span></span><br><span class="line">        <span class="comment"># é‡å¡‘å›åŸå§‹æ ¼å¼ [2, 6, 2, 2] -&gt; [2, 6, 4]</span></span><br><span class="line">        context_vec = context_vec.contiguous().view(b, num_tokens, <span class="variable language_">self</span>.d_out)</span><br><span class="line">        <span class="comment"># é€šè¿‡è¾“å‡ºæŠ•å½±å±‚ [2, 6, 4]</span></span><br><span class="line">        context_vec = <span class="variable language_">self</span>.out_proj(context_vec)</span><br><span class="line">        <span class="keyword">return</span> context_vec</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒä¸ªç‰ˆæœ¬ <code>MultiHeadAttention</code>ä¹‹æ‰€ä»¥æ›´å¥½ï¼Œæ ¹æœ¬åŸå› åœ¨äºå®ƒ<strong>å°†å¤šæ¬¡å°è§„æ¨¡çš„ç‹¬ç«‹è®¡ç®—ï¼Œæ•´åˆä¸ºä¸€æ¬¡å¤§è§„æ¨¡çš„å¹¶è¡Œè®¡ç®—</strong>ï¼Œä»è€Œæœ€å¤§åŒ–åœ°åˆ©ç”¨äº†ç°ä»£ç¡¬ä»¶ï¼ˆå°¤å…¶æ˜¯GPUï¼‰çš„å¹¶è¡Œå¤„ç†èƒ½åŠ›ã€‚</p><p>ç¬¬ä¸€ä¸ªç‰ˆæœ¬ <code>MultiHeadAttentionWrapper</code>çš„æ ¹æœ¬é—®é¢˜æ˜¯<strong>è®¡ç®—è¢«æ‹†æ•£äº†</strong>ã€‚å¯¹äºä¸€ä¸ªæœ‰ 12ä¸ªå¤´çš„æ¨¡å‹ï¼Œè¿™æ„å‘³ç€è¦æ‰§è¡Œ <strong>12 ç»„</strong>ç‹¬ç«‹çš„ Q, K, VçŸ©é˜µä¹˜æ³•ã€‚åœ¨ GPU ä¸Šï¼Œæ¯æ¬¡ç‹¬ç«‹çš„çŸ©é˜µä¹˜æ³•éƒ½éœ€è¦ä¸€æ¬¡å†…æ ¸å¯åŠ¨ï¼ˆkernellaunchï¼‰ï¼Œè¿™ä¸ªå¯åŠ¨æœ¬èº«æ˜¯æœ‰å¼€é”€çš„ã€‚æ‰§è¡Œ 12æ¬¡å°è§„æ¨¡çš„è®¡ç®—ï¼Œå…¶æ€»å¼€é”€è¿œå¤§äºæ‰§è¡Œ 1æ¬¡ç­‰æ•ˆçš„å¤§è§„æ¨¡è®¡ç®—ã€‚è¿™å°±åƒè®©ä¸€ä¸ªå·¥äººå»æ¬ 12æ¬¡ç®±å­ï¼Œæ¯æ¬¡åªæ¬ä¸€ä¸ªï¼Œè¿œä¸å¦‚è®©ä»–ç”¨æ¨è½¦ä¸€æ¬¡æ€§æ¬å®Œ 12 ä¸ªç®±å­æ¥å¾—å¿«ã€‚</p><p>è¿™é‡Œé¢çš„å‘é‡å˜åŒ–å¯èƒ½æœ‰ä¸€äº›å¤æ‚ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥å‚è€ƒä¸‹å›¾è¿›è¡Œè¾…åŠ©ç†è§£ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250830235453791.png"alt="å¤šå¤´æ³¨æ„åŠ›å®Œæ•´æµç¨‹å¯è§†åŒ–" /><figcaption aria-hidden="true">å¤šå¤´æ³¨æ„åŠ›å®Œæ•´æµç¨‹å¯è§†åŒ–</figcaption></figure><blockquote><p>[!IMPORTANT]</p><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»èµ°å®Œäº†ä¸€æ¡ä»æœ€ç®€é™‹åˆ°æœ€å®Œå¤‡çš„æ³¨æ„åŠ›æœºåˆ¶æ¼”è¿›ä¹‹è·¯ã€‚æˆ‘ä»¬ä»ä¸€ä¸ªä¸å¸¦ä»»ä½•å¯è®­ç»ƒå‚æ•°çš„ç®€å•ç‚¹ç§¯æ¨¡å‹å‡ºå‘ï¼Œç†è§£äº†"çœ‹-æƒè¡¡-èåˆ"çš„æ ¸å¿ƒæ€æƒ³ï¼›æ¥ç€ï¼Œé€šè¿‡å¼•å…¥å¯å­¦ä¹ çš„QKVçŸ©é˜µï¼Œèµ‹äºˆäº†æ¨¡å‹<strong>å­¦ä¼šå¦‚ä½•å»å…³æ³¨</strong>çš„èƒ½åŠ›ï¼›éšåï¼Œæˆ‘ä»¬ç”¨å› æœæ©ç ä¸ºæ¨¡å‹æˆ´ä¸Šäº†çœ¼ç½©ï¼Œå¼ºåˆ¶å®ƒéµå®ˆæ—¶é—´é¡ºåºï¼Œåªèƒ½å›é¡¾è¿‡å»ï¼›æœ€åï¼Œé€šè¿‡å¤šå¤´æœºåˆ¶å’Œé«˜æ•ˆçš„å¹¶è¡ŒåŒ–å®ç°ï¼Œæˆ‘ä»¬æ„å»ºå‡ºäº†GPT æ¨¡å‹çœŸæ­£çš„<strong>è®¤çŸ¥æ ¸å¿ƒ</strong>â€”â€”<code>MultiHeadAttention</code>æ¨¡å—ã€‚</p><p>è¿™ä¸ªæ¨¡å—æ˜¯ Transformeræ¶æ„çš„çµé­‚ã€‚å®ƒä¸ºæ¨¡å‹æä¾›äº†ä¸€ä¸ªåŠ¨æ€çš„ã€å¯å­¦ä¹ çš„æœºåˆ¶ï¼Œä½¿å…¶èƒ½å¤Ÿåœ¨å¤„ç†æ¯ä¸€ä¸ªè¯å…ƒæ—¶ï¼Œéƒ½èƒ½å®¡è§†å…¨å±€ï¼ˆæˆ–å…¨å±€çš„è¿‡å»ï¼‰ï¼Œå¹¶ç²¾ç¡®åœ°è®¡ç®—å‡ºä¸Šä¸‹æ–‡ä¸­æ¯ä¸€ä¸ªå…¶ä»–è¯å…ƒå¯¹å½“å‰è¯å…ƒçš„é‡è¦æ€§ï¼Œæœ€ç»ˆç”Ÿæˆä¸€ä¸ªå¯Œå«æ·±åº¦ä¸Šä¸‹æ–‡ä¿¡æ¯çš„æ–°è¡¨ç¤ºã€‚</p></blockquote><p>ç„¶è€Œï¼Œä¸€ä¸ªå¼ºå¤§çš„å¼•æ“ï¼ˆ<code>MultiHeadAttention</code>ï¼‰æœ¬èº«è¿˜ä¸è¶³ä»¥æ„æˆä¸€è¾†æ€§èƒ½ä¼˜è¶Šçš„èµ›è½¦ï¼ˆ<code>TransformerBlock</code>ï¼‰ã€‚æˆ‘ä»¬è¿˜éœ€è¦ç¨³å®šç³»ç»Ÿã€ä¼ åŠ¨è£…ç½®å’Œè¿›ä¸€æ­¥çš„åŠ å·¥ç¯èŠ‚ã€‚è¿™å°±å¼•å‡ºäº†æˆ‘ä»¬æ¥ä¸‹æ¥çš„é—®é¢˜ï¼š</p><ul><li>æ¨¡å‹åœ¨é€šè¿‡æ³¨æ„åŠ›æœºåˆ¶<strong>èåˆ</strong>äº†ä¸Šä¸‹æ–‡ä¿¡æ¯ä¹‹åï¼Œå¦‚ä½•å¯¹è¿™äº›æ–°ä¿¡æ¯è¿›è¡Œè¿›ä¸€æ­¥çš„<strong>åŠ å·¥å’Œæ€è€ƒ</strong>ï¼Ÿ</li><li>å½“æˆ‘ä»¬æŠŠ 12ä¸ªè¿™æ ·å¼ºå¤§çš„è®¡ç®—å±‚å †å åœ¨ä¸€èµ·æ—¶ï¼Œå¦‚ä½•ä¿è¯è®­ç»ƒè¿‡ç¨‹çš„ç¨³å®šï¼Œé˜²æ­¢æ¢¯åº¦æ¶ˆå¤±æˆ–çˆ†ç‚¸ï¼Ÿ</li><li>åœ¨ç»è¿‡å¦‚æ­¤å¤æ‚çš„å˜æ¢åï¼Œå¦‚ä½•ç¡®ä¿åŸå§‹çš„ã€æœªç»å¤„ç†çš„ä¿¡æ¯ä¸ä¼šåœ¨å±‚å±‚ä¼ é€’ä¸­ä¸¢å¤±ï¼Ÿ</li></ul><p>è®©æˆ‘ä»¬å…ˆæ¥å›é¡¾ä¸€ä¸‹ <code>TransformerBlock</code> çš„ç»“æ„ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TransformerBlock</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Transformerå—ï¼šå¤šå¤´æ³¨æ„åŠ› + å‰é¦ˆç½‘ç»œ + æ®‹å·®è¿æ¥&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, cfg</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="variable language_">self</span>.att = MultiHeadAttention(  <span class="comment"># &lt;----- æˆ‘ä»¬å·²ç»æå®šäº†ï¼</span></span><br><span class="line">            d_in=cfg[<span class="string">&quot;emb_dim&quot;</span>],</span><br><span class="line">            d_out=cfg[<span class="string">&quot;emb_dim&quot;</span>],</span><br><span class="line">            context_length=cfg[<span class="string">&quot;context_length&quot;</span>],</span><br><span class="line">            num_heads=cfg[<span class="string">&quot;n_heads&quot;</span>],</span><br><span class="line">            dropout=cfg[<span class="string">&quot;drop_rate&quot;</span>],</span><br><span class="line">            qkv_bias=cfg[<span class="string">&quot;qkv_bias&quot;</span>],</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># &lt;----- æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­æ¥è§£å†³åé¢çš„å†…å®¹</span></span><br><span class="line">        <span class="variable language_">self</span>.ff = FeedForward(cfg)</span><br><span class="line">        <span class="variable language_">self</span>.norm1 = LayerNorm(cfg[<span class="string">&quot;emb_dim&quot;</span>])</span><br><span class="line">        <span class="variable language_">self</span>.norm2 = LayerNorm(cfg[<span class="string">&quot;emb_dim&quot;</span>])</span><br><span class="line">        <span class="variable language_">self</span>.drop_shortcut = nn.Dropout(cfg[<span class="string">&quot;drop_rate&quot;</span>])</span><br></pre></td></tr></table></figure><p>ç­”æ¡ˆå°±è—åœ¨æ„æˆ <code>TransformerBlock</code>çš„å¦å¤–å‡ ä¸ªå…³é”®ç»„ä»¶ä¸­ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æŠŠç›®å…‰ä»æ³¨æ„åŠ›æœºåˆ¶æœ¬èº«ç§»å¼€ï¼Œå»æ¢ç´¢ç¯ç»•åœ¨å®ƒå‘¨å›´çš„å·¦è†€å³è‡‚â€”â€”<strong>å‰é¦ˆç½‘ç»œ(FeedForward Network)</strong>ã€<strong>å±‚å½’ä¸€åŒ– (LayerNormalization)</strong> å’Œ <strong>æ®‹å·®è¿æ¥ (Shortcut/ResidualConnections)</strong>ï¼Œçœ‹çœ‹å®ƒä»¬æ˜¯å¦‚ä½•ååŒå·¥ä½œï¼Œå…±åŒæ„æˆ Transformeræ¶æ„åšå®å¯é çš„æ ¸å¿ƒå¤„ç†å•å…ƒçš„ã€‚</p><ul><li><strong>å±‚å½’ä¸€åŒ– (LayerNorm)</strong>:å®ƒçš„æ ¹æœ¬ä½œç”¨æ˜¯<strong>ç¨³å®šè®­ç»ƒè¿‡ç¨‹</strong>ã€‚åœ¨æ•°æ®ç»è¿‡å¤æ‚çš„æ³¨æ„åŠ›è®¡ç®—æˆ–å‰é¦ˆç½‘ç»œå˜æ¢åï¼Œå…¶æ•°å€¼åˆ†å¸ƒå¯èƒ½ä¼šå˜å¾—éå¸¸ä¸ç¨³å®šã€‚å±‚å½’ä¸€åŒ–å°±åƒä¸€ä¸ªè°ƒèŠ‚å™¨ï¼Œåœ¨æ¯ä¸ªå­å±‚å¤„ç†ä¹‹å‰ï¼Œéƒ½å°†æ•°æ®æ‹‰å›åˆ°ä¸€ä¸ªæ ‡å‡†çš„ã€æ˜“äºå¤„ç†çš„åˆ†å¸ƒä¸Šï¼Œç¡®ä¿ä¿¡æ¯æµçš„ç¨³å®šã€‚</li><li><strong>å‰é¦ˆç¥ç»ç½‘ç»œ (FeedForward Network)</strong>:å¦‚æœè¯´æ³¨æ„åŠ›æœºåˆ¶è´Ÿè´£<strong>èåˆ</strong>æ¥è‡ªä¸Šä¸‹æ–‡çš„ä¿¡æ¯ï¼Œé‚£ä¹ˆå‰é¦ˆç½‘ç»œåˆ™è´Ÿè´£å¯¹è¿™äº›èåˆåçš„ä¿¡æ¯è¿›è¡Œ<strong>åŠ å·¥å’Œæ€è€ƒ</strong>ã€‚å®ƒæ˜¯ä¸€ä¸ªå°å‹çš„ã€ç‹¬ç«‹å¤„ç†æ¯ä¸ªè¯å…ƒä½ç½®çš„ç¥ç»ç½‘ç»œï¼Œç”¨äºæå–æ›´é«˜çº§ã€æ›´æŠ½è±¡çš„ç‰¹å¾ï¼Œå¢åŠ æ¨¡å‹çš„éçº¿æ€§è¡¨è¾¾èƒ½åŠ›ã€‚</li><li><strong>å¿«æ·è¿æ¥ (Shortcut/Residual Connection)</strong>:è¿™æ˜¯è®­ç»ƒæ·±åº¦ç½‘ç»œçš„å…³é”®æŠ€å·§ã€‚å®ƒå…è®¸ä¿¡æ¯ç»•è¿‡æŸä¸ªå¤„ç†å±‚ï¼ˆå¦‚æ³¨æ„åŠ›æˆ–å‰é¦ˆç½‘ç»œï¼‰ï¼Œç›´æ¥ä¼ é€’åˆ°ä¸‹ä¸€å±‚ã€‚è¿™ç¡®ä¿äº†å³ä½¿åœ¨ç»è¿‡å¤šè¾¾12å±‚ç”šè‡³æ›´å¤šçš„æ·±åº¦å˜æ¢åï¼Œæœ€åŸå§‹çš„è¾“å…¥ä¿¡æ¯ä¹Ÿä¸ä¼šå®Œå…¨ä¸¢å¤±ï¼ŒåŒæ—¶æå¤§åœ°ç¼“è§£äº†æ·±åº¦å­¦ä¹ ä¸­çš„æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ï¼Œè®©æ·±åº¦å †å æˆä¸ºå¯èƒ½ã€‚</li></ul><h3 id="ä½¿ç”¨å±‚å½’ä¸€åŒ–è¿›è¡Œå½’ä¸€åŒ–æ¿€æ´»">2.4.2ä½¿ç”¨å±‚å½’ä¸€åŒ–è¿›è¡Œå½’ä¸€åŒ–æ¿€æ´»</h3><p>ä¸€ä¸ªæ·±åº¦ç¥ç»ç½‘ç»œå°±åƒä¸€ä¸ªå¤šçº§ä¿¡æ¯åŠ å·¥æµæ°´çº¿ã€‚æ•°æ®ï¼ˆä¿¡å·ï¼‰åœ¨æ¯ä¸€å±‚éƒ½ä¼šè¢«æƒé‡çŸ©é˜µè¿›è¡Œå¤æ‚çš„æ•°å­¦å˜æ¢ã€‚å½“å±‚æ•°å¾ˆæ·±æ—¶ï¼Œæ¯ä¸€å±‚å¾®å°çš„å˜åŒ–éƒ½å¯èƒ½è¢«é€å±‚æ”¾å¤§ã€‚è¿™ä¼šå¯¼è‡´ä¸¤ä¸ªæç«¯é—®é¢˜ï¼š</p><ol type="1"><li><strong>ä¿¡å·çˆ†ç‚¸</strong>ï¼šæŸäº›å±‚çš„è¾“å‡ºå€¼å˜å¾—éå¸¸å¤§ï¼Œå¯¼è‡´åç»­è®¡ç®—æº¢å‡ºï¼Œè®­ç»ƒè¿‡ç¨‹å´©æºƒã€‚</li><li><strong>ä¿¡å·æ¶ˆå¤±</strong>ï¼šæŸäº›å±‚çš„è¾“å‡ºå€¼å˜å¾—éå¸¸å°ï¼Œæ¥è¿‘äºé›¶ï¼Œå¯¼è‡´ä¿¡æ¯æ— æ³•æœ‰æ•ˆä¼ é€’åˆ°æ›´æ·±å±‚ï¼Œæ¨¡å‹å­¦ä¸åˆ°ä¸œè¥¿ã€‚è¿™ä¸¤ç§æƒ…å†µç»Ÿç§°ä¸º<strong>å†…éƒ¨åå˜é‡åç§» (Internal CovariateShift)</strong>ï¼Œå®ƒä½¿å¾—è®­ç»ƒè¿‡ç¨‹æå…¶ä¸ç¨³å®šï¼Œå°±åƒåœ¨ä¸€æ¡å´å²–ä¸å¹³çš„å±±è·¯ä¸Šå¼€è½¦ï¼Œæ²¹é—¨ï¼ˆå­¦ä¹ ç‡ï¼‰ç¨æœ‰ä¸æ…å°±ä¼šå†²å‡ºèµ›é“ã€‚</li></ol><p><strong>ç¬¬ä¸€æ€§åŸç†è§£å†³æ–¹æ¡ˆï¼šå¼ºåˆ¶ä¿¡å·æ ‡å‡†åŒ–</strong></p><p>æœ€ç›´æ¥çš„è§£å†³æ–¹æ¡ˆï¼Œå°±æ˜¯åœ¨ä¿¡æ¯è¿›å…¥æ¯ä¸ªæ ¸å¿ƒå¤„ç†å•å…ƒï¼ˆå¦‚æ³¨æ„åŠ›å’Œå‰é¦ˆç½‘ç»œï¼‰ä¹‹å‰ï¼Œå¼ºåˆ¶è¿›è¡Œä¸€æ¬¡æ ¡å‡†æˆ–æ ‡å‡†åŒ–ã€‚<strong>å±‚å½’ä¸€åŒ–</strong>æ­£æ˜¯æ‰®æ¼”äº†è¿™ä¸ªè§’è‰²ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œä¸ç®¡ä¸Šä¸€å±‚ä¼ æ¥çš„æ•°æ®åˆ†å¸ƒå¦‚ä½•ï¼Œå®ƒéƒ½å¼ºè¡Œå°†è¿™æ‰¹æ•°æ®çš„å‡å€¼è°ƒæ•´ä¸º0ï¼Œæ–¹å·®è°ƒæ•´ä¸º 1ã€‚è¿™ç›¸å½“äºåœ¨æµæ°´çº¿çš„æ¯ä¸ªå…³é”®å·¥åºå‰éƒ½å®‰è£…äº†ä¸€ä¸ª<strong>ç¨³å‹å™¨</strong>ï¼Œç¡®ä¿æ— è®ºè¾“å…¥ä¿¡å·å¦‚ä½•æ³¢åŠ¨ï¼Œè¿›å…¥å·¥åºçš„ä¿¡å·å§‹ç»ˆæ˜¯ç¨³å®šã€æ ‡å‡†åŒ–çš„ã€‚</p><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250831000639468.png" /></p><p>åœ¨ <code>TransformerBlock</code>ä¸­ï¼Œå±‚å½’ä¸€åŒ–è¢«æ”¾ç½®åœ¨<strong>å¤šå¤´æ³¨æ„åŠ›å’Œå‰é¦ˆç½‘ç»œä¹‹å‰</strong>(<code>self.norm1</code> å’Œ <code>self.norm2</code>)ã€‚è¿™ç¡®ä¿äº†è¿™ä¸¤ä¸ªè¿›è¡Œæ ¸å¿ƒè®¡ç®—çš„æ¨¡å—æ¥æ”¶åˆ°çš„è¾“å…¥å§‹ç»ˆå¤„äºä¸€ä¸ªç¨³å®šä¸”æ˜“äºå¤„ç†çš„èŒƒå›´å†…ï¼Œä»è€Œæå¤§åœ°ç¨³å®šäº†æ•´ä¸ªæ·±åº¦æ¨¡å‹çš„è®­ç»ƒè¿‡ç¨‹ã€‚</p><p><code>LayerNorm</code> çš„ä»£ç å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LayerNorm</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å±‚å½’ä¸€åŒ–å®ç°&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, emb_dim</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="variable language_">self</span>.eps = <span class="number">1e-5</span></span><br><span class="line">        <span class="variable language_">self</span>.scale = nn.Parameter(torch.ones(emb_dim))</span><br><span class="line">        <span class="variable language_">self</span>.shift = nn.Parameter(torch.zeros(emb_dim))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        mean = x.mean(dim=-<span class="number">1</span>, keepdim=<span class="literal">True</span>)</span><br><span class="line">        var = x.var(dim=-<span class="number">1</span>, keepdim=<span class="literal">True</span>, unbiased=<span class="literal">False</span>)</span><br><span class="line">        norm_x = (x-mean) / torch.sqrt(var + <span class="variable language_">self</span>.eps)</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.scale * norm_x + <span class="variable language_">self</span>.shift</span><br></pre></td></tr></table></figure><p>è®©æˆ‘ä»¬ä»ç¬¬ä¸€æ€§åŸç†å‡ºå‘ï¼Œæ¥æ ¹æœ¬æ€§åœ°è§£é‡Š <code>LayerNorm</code>çš„è¿™ä»½ä»£ç å®ç°ã€‚å®ƒçš„æ¯ä¸€è¡Œéƒ½æœåŠ¡äºä¸€ä¸ªæ ¸å¿ƒç›®çš„ï¼š<strong>åœ¨ä¿æŒæ¨¡å‹è¡¨è¾¾èƒ½åŠ›çš„åŒæ—¶ï¼Œç¨³å®šæ·±åº¦ç½‘ç»œçš„è®­ç»ƒè¿‡ç¨‹</strong>ã€‚æˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªå®ç°æ‹†è§£ä¸ºä¸¤ä¸ªæ ¸å¿ƒéƒ¨åˆ†æ¥ç†è§£ï¼š<strong>å¼ºåˆ¶æ ‡å‡†åŒ–</strong>å’Œ <strong>å¯å­¦ä¹ çš„è‡ªé€‚åº”è°ƒæ•´</strong>ã€‚</p><h4 id="ç¬¬ä¸€éƒ¨åˆ†å¼ºåˆ¶æ ‡å‡†åŒ–---è§£å†³ä¿¡å·å¤±æ§é—®é¢˜">2.4.2.1ç¬¬ä¸€éƒ¨åˆ†ï¼šå¼ºåˆ¶æ ‡å‡†åŒ– - è§£å†³ä¿¡å·å¤±æ§é—®é¢˜</h4><p>è¿™æ˜¯ä»£ç çš„æ ¸å¿ƒè®¡ç®—éƒ¨åˆ†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># forward æ–¹æ³•ä¸­çš„æ ¸å¿ƒè®¡ç®—</span></span><br><span class="line">mean = x.mean(dim=-<span class="number">1</span>, keepdim=<span class="literal">True</span>)</span><br><span class="line">var = x.var(dim=-<span class="number">1</span>, keepdim=<span class="literal">True</span>, unbiased=<span class="literal">False</span>)</span><br><span class="line">norm_x = (x-mean) / torch.sqrt(var + <span class="variable language_">self</span>.eps)</span><br></pre></td></tr></table></figure><ul><li><code>mean = x.mean(dim=-1, keepdim=True)</code> å’Œ<code>var = x.var(dim=-1, ...)</code>ï¼šè¿™ä¸¤è¡Œä»£ç è®¡ç®—äº†<strong>æ¯ä¸€ä¸ª</strong>è¾“å…¥æ ·æœ¬<strong>åœ¨å…¶ç‰¹å¾ç»´åº¦ï¼ˆ<code>emb_dim</code>ï¼‰ä¸Š</strong>çš„å‡å€¼å’Œæ–¹å·®ã€‚<code>dim=-1</code>æ˜¯å…³é”®ï¼Œå®ƒæŒ‡å®šäº†å½’ä¸€åŒ–æ˜¯æ²¿ç€ç‰¹å¾ç»´åº¦è¿›è¡Œçš„ï¼Œè€Œä¸æ˜¯åƒæ‰¹å½’ä¸€åŒ–ï¼ˆBatchNormï¼‰é‚£æ ·è·¨æ‰¹æ¬¡è¿›è¡Œã€‚è¿™ä½¿å¾— <code>LayerNorm</code>çš„æ•ˆæœä¸æ‰¹æ¬¡å¤§å°æ— å…³ï¼Œåœ¨å¤„ç†å¯å˜é•¿åº¦åºåˆ—æ—¶å°¤å…¶ç¨³å®šã€‚</li><li><code>norm_x = (x-mean) / torch.sqrt(var + self.eps)</code>ï¼šè¿™æ˜¯æ ‡å‡†çš„<strong>æ ‡å‡†åŒ–å…¬å¼</strong>ï¼ˆå‡å»å‡å€¼ï¼Œå†é™¤ä»¥æ ‡å‡†å·®ï¼‰ã€‚å®ƒå°†åŸå§‹è¾“å…¥<code>x</code> è½¬æ¢ä¸ºäº†ä¸€ä¸ªå‡å€¼ä¸º 0ã€æ–¹å·®ä¸º 1 çš„æ–°å‘é‡<code>norm_x</code>ã€‚<ul><li><code>self.eps = 1e-5</code>ï¼š<code>eps</code> (epsilon)æ˜¯ä¸€ä¸ªæå°çš„å¸¸æ•°ï¼Œå®ƒçš„å”¯ä¸€ä½œç”¨æ˜¯<strong>é˜²æ­¢åˆ†æ¯ä¸ºé›¶</strong>ã€‚å¦‚æœæŸä¸ªæ ·æœ¬çš„æ–¹å·®æ°å¥½ä¸º0ï¼Œæ²¡æœ‰ <code>eps</code> å°±ä¼šå¯¼è‡´é™¤é›¶é”™è¯¯ï¼Œ<code>eps</code>ä¿è¯äº†è®¡ç®—çš„æ•°å€¼ç¨³å®šæ€§ 1ã€‚</li><li><code>unbiased=False</code>ï¼šè¿™æ˜¯ä¸€ä¸ªå®ç°ç»†èŠ‚ï¼Œè¡¨ç¤ºåœ¨è®¡ç®—æ–¹å·®æ—¶åˆ†æ¯æ˜¯<code>N</code> è€Œä¸æ˜¯ <code>N-1</code>ã€‚é€‰æ‹© <code>False</code>æ˜¯ä¸ºäº†<strong>ä¸åŸå§‹ GPT-2 æ¨¡å‹çš„å®ç°ä¿æŒå…¼å®¹</strong>ï¼Œå› ä¸ºå…¶æœ€åˆæ˜¯ä½¿ç”¨TensorFlow å®ç°çš„ï¼Œè€Œè¿™æ˜¯ TensorFlow çš„é»˜è®¤è¡Œä¸º 2ã€‚</li></ul></li></ul><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å¼ºåˆ¶å°†è¾“å…¥ä¿¡å·ç¨³å®šåœ¨ä¸€ä¸ª <code>N(0, 1)</code>çš„æ ‡å‡†æ­£æ€åˆ†å¸ƒä¸Šã€‚ä½†è¿™åˆå¸¦æ¥äº†æ–°çš„é—®é¢˜ã€‚</p><h4 id="ç¬¬äºŒéƒ¨åˆ†å¯å­¦ä¹ çš„è‡ªé€‚åº”è°ƒæ•´---æ¢å¤æ¨¡å‹çš„è¡¨è¾¾èƒ½åŠ›">2.4.2.2ç¬¬äºŒéƒ¨åˆ†ï¼šå¯å­¦ä¹ çš„è‡ªé€‚åº”è°ƒæ•´ - æ¢å¤æ¨¡å‹çš„è¡¨è¾¾èƒ½åŠ›</h4><p>è¿™æ˜¯åœ¨ <code>__init__</code> ä¸­å®šä¹‰å¹¶åœ¨ <code>forward</code>æœ€åä½¿ç”¨çš„éƒ¨åˆ†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># __init__ ä¸­</span></span><br><span class="line"><span class="variable language_">self</span>.scale = nn.Parameter(torch.ones(emb_dim))</span><br><span class="line"><span class="variable language_">self</span>.shift = nn.Parameter(torch.zeros(emb_dim))</span><br><span class="line"></span><br><span class="line"><span class="comment"># forward çš„æœ€åä¸€æ­¥</span></span><br><span class="line"><span class="keyword">return</span> <span class="variable language_">self</span>.scale * norm_x + <span class="variable language_">self</span>.shift</span><br></pre></td></tr></table></figure><p><strong>æ ¹æœ¬é—®é¢˜</strong>ï¼šå°†æ¯ä¸€å±‚çš„è¾“å…¥éƒ½å¼ºåˆ¶å˜ä¸ºå‡å€¼ä¸º 0ã€æ–¹å·®ä¸º 1çš„åˆ†å¸ƒï¼Œè¿™ç§åšæ³•å¯èƒ½<strong>è¿‡äºæš´åŠ›å’Œæ­»æ¿</strong>ã€‚å®ƒè™½ç„¶ç¨³å®šäº†è®­ç»ƒï¼Œä½†ä¹Ÿå¯èƒ½é™åˆ¶äº†æ¨¡å‹çš„è¡¨è¾¾èƒ½åŠ›ã€‚ä¹Ÿè®¸å¯¹äºæŸä¸ªç‰¹å®šå±‚æ¥è¯´ï¼Œä¸€ä¸ªå‡å€¼ä¸º10ã€æ–¹å·®ä¸º 5çš„è¾“å…¥åˆ†å¸ƒæ‰æ˜¯æœ€ä¼˜çš„ã€‚æˆ‘ä»¬ä¸å¸Œæœ›å› ä¸ºè¿½æ±‚ç¨³å®šè€Œæ‰¼æ€äº†æ¨¡å‹å­¦ä¹ è¿™ç§åˆ†å¸ƒçš„å¯èƒ½æ€§ã€‚</p><p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šåœ¨å¼ºåˆ¶æ ‡å‡†åŒ–ä¹‹åï¼Œå†èµ‹äºˆæ¨¡å‹<strong>æ’¤é”€æˆ–é‡æ–°è°ƒæ•´</strong>è¿™ç§æ ‡å‡†åŒ–çš„èƒ½åŠ›ã€‚è¿™æ˜¯é€šè¿‡ä¸¤ä¸ªå¯å­¦ä¹ çš„å‚æ•°<code>scale</code> å’Œ <code>shift</code> æ¥å®ç°çš„ã€‚</p><ul><li><code>self.scale</code>(å¢ç›Š)ï¼šè¿™æ˜¯ä¸€ä¸ªä¸ç‰¹å¾ç»´åº¦ç›¸åŒå¤§å°çš„å¯å­¦ä¹ å‘é‡ã€‚å®ƒä¸æ ‡å‡†åŒ–åçš„<code>norm_x</code> è¿›è¡Œé€å…ƒç´ ç›¸ä¹˜ã€‚å®ƒè¢«åˆå§‹åŒ–ä¸ºå…¨1ï¼Œæ‰€ä»¥åœ¨è®­ç»ƒåˆšå¼€å§‹æ—¶ï¼Œå®ƒä¸èµ·ä»»ä½•ä½œç”¨ï¼ˆä¹˜ä»¥ 1 ç­‰äºä¸å˜ï¼‰ã€‚</li><li><code>self.shift</code>(åç½®)ï¼šè¿™ä¹Ÿæ˜¯ä¸€ä¸ªå¯å­¦ä¹ çš„å‘é‡ã€‚å®ƒè¢«åŠ åˆ°ç¼©æ”¾åçš„ç»“æœä¸Šã€‚å®ƒè¢«åˆå§‹åŒ–ä¸ºå…¨0ï¼Œæ‰€ä»¥åœ¨è®­ç»ƒå¼€å§‹æ—¶ï¼Œå®ƒä¹Ÿä¸èµ·ä½œç”¨ï¼ˆåŠ ä¸Š 0 ç­‰äºä¸å˜ï¼‰ã€‚</li></ul><p><strong>è¿™æ­¥çš„ç²¾é«“åœ¨äº</strong>ï¼šæ¨¡å‹åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œå¯ä»¥é€šè¿‡åå‘ä¼ æ’­è‡ªç”±åœ°å­¦ä¹ <code>scale</code> å’Œ <code>shift</code> çš„æœ€ä½³å€¼ã€‚</p><ul><li>å¦‚æœæ¨¡å‹å‘ç°å¼ºåˆ¶æ ‡å‡†åŒ– <code>N(0, 1)</code>å¯¹å½“å‰å±‚æ¥è¯´æ˜¯æœ€å¥½çš„ï¼Œå®ƒå°±ä¼šè®© <code>scale</code> ä¿æŒæ¥è¿‘1ï¼Œ<code>shift</code> ä¿æŒæ¥è¿‘ 0ã€‚</li><li>å¦‚æœæ¨¡å‹å‘ç°ä¸€ä¸ªä¸åŒçš„åˆ†å¸ƒæ›´å¥½ï¼Œå®ƒå°±å¯ä»¥å­¦ä¼šç›¸åº”çš„<code>scale</code> å’Œ <code>shift</code> å€¼ï¼Œå°† <code>norm_x</code>çº¿æ€§å˜æ¢åˆ°ä»»ä½•å®ƒè®¤ä¸ºæœ€ä¼˜çš„å‡å€¼å’Œæ–¹å·®ã€‚</li></ul><p>æ€»çš„æ¥è¯´ï¼Œ<code>LayerNorm</code> çš„å®ç°æ˜¯ä¸€ä¸ªç²¾å¦™çš„ä¸¤æ­¥è¿‡ç¨‹ï¼š</p><ol type="1"><li><strong>å…ˆç¨³å®š</strong>ï¼šé€šè¿‡å¼ºåˆ¶çš„æ ‡å‡†åŒ–ï¼Œå°†å¯èƒ½å¤±æ§çš„è¾“å…¥ä¿¡å·æ‹‰å›åˆ°ä¸€ä¸ªç¨³å®šçš„<code>N(0, 1)</code> åˆ†å¸ƒï¼Œè§£å†³äº†æ·±åº¦ç½‘ç»œè®­ç»ƒä¸ç¨³å®šçš„æ ¹æœ¬é—®é¢˜ã€‚</li><li><strong>åæ”¾å¼€</strong>ï¼šé€šè¿‡å¼•å…¥å¯å­¦ä¹ çš„ <code>scale</code> å’Œ<code>shift</code>å‚æ•°ï¼Œèµ‹äºˆæ¨¡å‹æ¢å¤ç”šè‡³åˆ›é€ å…¨æ–°åˆ†å¸ƒçš„è‡ªç”±åº¦ï¼Œè§£å†³äº†å¼ºåˆ¶æ ‡å‡†åŒ–å¯èƒ½å¸¦æ¥çš„è¡¨è¾¾èƒ½åŠ›å—é™çš„é—®é¢˜ã€‚</li></ol><p>æœ€ç»ˆï¼Œè¿™ä¸ªå®ç°æ—¢ä¿è¯äº†è®­ç»ƒçš„<strong>ç¨³å®šæ€§</strong>ï¼Œåˆä¿ç•™äº†æ¨¡å‹çš„<strong>çµæ´»æ€§å’Œè¡¨è¾¾èƒ½åŠ›</strong>ã€‚</p><h3 id="å®ç°å…·æœ‰-gelu-æ¿€æ´»å‡½æ•°çš„å‰é¦ˆç¥ç»ç½‘ç»œ">2.4.3 å®ç°å…·æœ‰ GELUæ¿€æ´»å‡½æ•°çš„å‰é¦ˆç¥ç»ç½‘ç»œ</h3><p>è‡ªæ³¨æ„åŠ›æœºåˆ¶çš„æ ¸å¿ƒæ˜¯<strong>åŠ æƒæ±‚å’Œ</strong>(<code>attn_weights @ values</code>)ã€‚è™½ç„¶è®¡ç®—æƒé‡æ—¶æœ‰<code>softmax</code>å¼•å…¥äº†éçº¿æ€§ï¼Œä½†ä¿¡æ¯èåˆçš„æœ€åä¸€æ­¥æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªçº¿æ€§ç»„åˆã€‚å¦‚æœæ•´ä¸ª<code>TransformerBlock</code>åªä¾èµ–äºæ³¨æ„åŠ›æœºåˆ¶æ¥å¤„ç†ä¿¡æ¯ï¼Œé‚£ä¹ˆæ¨¡å‹çš„è¡¨è¾¾èƒ½åŠ›å°†å—åˆ°é™åˆ¶ã€‚å®ƒæ“…é•¿<strong>èåˆ</strong>ä¿¡æ¯ï¼Œä½†åœ¨å¯¹èåˆåçš„ä¿¡æ¯è¿›è¡Œ<strong>æ·±åº¦åŠ å·¥</strong>æ–¹é¢èƒ½åŠ›ä¸è¶³ã€‚</p><p><strong>ç¬¬ä¸€æ€§åŸç†è§£å†³æ–¹æ¡ˆï¼šä¸ºæ¯ä¸ªè¯å…ƒæä¾›ç‹¬ç«‹çš„éçº¿æ€§å¤„ç†ç©ºé—´</strong></p><p>ä¸ºäº†å¼¥è¡¥è¿™ä¸€ä¸è¶³ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªä¸“é—¨çš„ç»„ä»¶æ¥å¯¹æ³¨æ„åŠ›æœºåˆ¶è¾“å‡ºçš„ä¸Šä¸‹æ–‡å‘é‡è¿›è¡Œè¿›ä¸€æ­¥çš„ã€æ›´å¤æ‚çš„éçº¿æ€§å˜æ¢ã€‚<strong>å‰é¦ˆç½‘ç»œ(FFN)</strong> å°±æ˜¯è¿™ä¸ªç»„ä»¶ã€‚ å®ƒé€šå¸¸ç”±ä¸¤ä¸ªçº¿æ€§å±‚å’Œä¸€ä¸ªéçº¿æ€§æ¿€æ´»å‡½æ•°ï¼ˆå¦‚GELUï¼‰ç»„æˆã€‚å®ƒä¼šå¯¹åºåˆ—ä¸­çš„<strong>æ¯ä¸€ä¸ªè¯å…ƒå‘é‡ç‹¬ç«‹åœ°</strong>è¿›è¡Œä¸€æ¬¡"å‡ç»´-éçº¿æ€§æ¿€æ´»-é™ç»´"çš„æ“ä½œã€‚</p><ol type="1"><li><strong>å‡ç»´</strong>ï¼šç¬¬ä¸€ä¸ªçº¿æ€§å±‚å°†å‘é‡ç»´åº¦æ‰©å¤§ï¼ˆä¾‹å¦‚ä» 768ç»´æ‰©å±•åˆ° 3072ç»´ï¼‰ï¼Œè¿™ä¸ºæ¨¡å‹æä¾›äº†æ›´å¹¿é˜”çš„ç‰¹å¾ç©ºé—´æ¥è¡¨ç¤ºå’ŒåŠ å·¥ä¿¡æ¯ã€‚</li><li><strong>éçº¿æ€§æ¿€æ´»(GELU)</strong>ï¼šè¿™æ˜¯å…³é”®ä¸€æ­¥ï¼Œæ‰“ç ´äº†çº¿æ€§å˜æ¢çš„å±€é™ï¼Œå…è®¸æ¨¡å‹å­¦ä¹ è¾“å…¥å’Œè¾“å‡ºä¹‹é—´æ›´å¤æ‚ã€æ›´æŠ½è±¡çš„å…³ç³»ã€‚</li><li><strong>é™ç»´</strong>ï¼šç¬¬äºŒä¸ªçº¿æ€§å±‚å°†ç»´åº¦æ¢å¤åˆ°åŸå§‹å¤§å°ï¼Œä»¥ä¾¿äºä¸‹ä¸€å±‚<code>TransformerBlock</code> å¤„ç†ã€‚</li></ol><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250831001916054.png" /></p><p>å‰é¦ˆç¥ç»ç½‘ç»œ <code>FeedForward</code> çš„å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FeedForward</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å‰é¦ˆç¥ç»ç½‘ç»œ&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, cfg</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="variable language_">self</span>.layers = nn.Sequential(</span><br><span class="line">            nn.Linear(cfg[<span class="string">&quot;emb_dim&quot;</span>], <span class="number">4</span> * cfg[<span class="string">&quot;emb_dim&quot;</span>]),</span><br><span class="line">            GELU(),</span><br><span class="line">            nn.Linear(<span class="number">4</span> * cfg[<span class="string">&quot;emb_dim&quot;</span>], cfg[<span class="string">&quot;emb_dim&quot;</span>])</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.layers(x)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GELU</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;GELUæ¿€æ´»å‡½æ•°&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0.5</span> * x * (<span class="number">1</span> + torch.tanh(</span><br><span class="line">            torch.sqrt(torch.tensor(<span class="number">2.0</span> / torch.pi)) *</span><br><span class="line">            (x + <span class="number">0.044715</span> * torch.<span class="built_in">pow</span>(x, <span class="number">3</span>))</span><br><span class="line">        ))</span><br></pre></td></tr></table></figure><ol type="1"><li><strong>å¼•å…¥éçº¿æ€§</strong>ï¼šé€šè¿‡ <code>GELU</code>æ¿€æ´»å‡½æ•°ï¼Œè®©æ¨¡å‹æœ‰èƒ½åŠ›å­¦ä¹ å¤æ‚çš„æ•°æ®æ¨¡å¼ã€‚</li><li><strong>æ·±åº¦åŠ å·¥ä¿¡æ¯</strong>ï¼šé€šè¿‡"å‡ç»´-é™ç»´"çš„ç»“æ„ï¼Œä¸ºæ¨¡å‹æä¾›ä¸€ä¸ªæ›´å¹¿é˜”çš„è®¡ç®—ç©ºé—´æ¥æå–å’Œè½¬æ¢ç‰¹å¾ï¼ŒåŒæ—¶ä¿æŒæ•´ä¸ª<code>TransformerBlock</code>è¾“å…¥è¾“å‡ºç»´åº¦çš„ä¸€è‡´æ€§ï¼Œä½¿å…¶èƒ½å¤Ÿè¢«æ–¹ä¾¿åœ°æ·±åº¦å †å ã€‚</li></ol><h3 id="æ·»åŠ å¿«æ·è¿æ¥">2.4.4 æ·»åŠ å¿«æ·è¿æ¥</h3><p>å½“ç½‘ç»œéå¸¸æ·±æ—¶ï¼ˆä¾‹å¦‚å †å  12 å±‚ <code>Transformer</code>å—ï¼‰ï¼Œä¼šé‡åˆ°ä¸¤ä¸ªè‡´å‘½é—®é¢˜ï¼š</p><ol type="1"><li><strong>æ¢¯åº¦æ¶ˆå¤± (VanishingGradients)</strong>ï¼šåœ¨è®­ç»ƒæ—¶ï¼Œç”¨äºæ›´æ–°æƒé‡çš„æ¢¯åº¦ä¿¡å·éœ€è¦ä»æœ€åä¸€å±‚åå‘ä¼ æ’­åˆ°ç¬¬ä¸€å±‚ã€‚æ¯ç»è¿‡ä¸€å±‚ï¼Œæ¢¯åº¦éƒ½ä¼šè¢«ä¹˜ä»¥è¯¥å±‚çš„æƒé‡ã€‚åœ¨æ·±å±‚ç½‘ç»œä¸­ï¼Œè¿™äº›è¿ä¹˜æ“ä½œå¾ˆå¯èƒ½å¯¼è‡´æ¢¯åº¦ä¿¡å·è¿…é€Ÿè¡°å‡ï¼Œç­‰ä¼ åˆ°æµ…å±‚ç½‘ç»œæ—¶å·²ç»å¾®ä¹å…¶å¾®ï¼Œå¯¼è‡´æµ…å±‚å‚æ•°å‡ ä¹ä¸æ›´æ–°ï¼Œæ¨¡å‹æ— æ³•æœ‰æ•ˆè®­ç»ƒã€‚</li><li><strong>ä¿¡æ¯é€€åŒ– (Information Degradation)</strong>ï¼šè¾“å…¥å‘é‡<code>x</code> æ¯ç»è¿‡ä¸€ä¸ª <code>TransformerBlock</code>ï¼Œéƒ½ä¼šè¢«å¤æ‚çš„æ³¨æ„åŠ›æœºåˆ¶å’Œå‰é¦ˆç½‘ç»œå®Œå…¨é‡æ„ã€‚åœ¨ç»è¿‡å¤šå±‚å˜æ¢åï¼Œæœ€åŸå§‹ã€æœ€ç›´æ¥çš„è¯­ä¹‰å’Œä½ç½®ä¿¡æ¯å¯èƒ½ä¼šè¢«å†²æ·¡ç”šè‡³ä¸¢å¤±ã€‚</li></ol><p><strong>ç¬¬ä¸€æ€§åŸç†è§£å†³æ–¹æ¡ˆï¼šå»ºç«‹ä¿¡æ¯/æ¢¯åº¦çš„"é«˜é€Ÿå…¬è·¯"</strong></p><p>è§£å†³æ–¹æ¡ˆå‡ºå¥‡åœ°ç®€å•è€Œæœ‰æ•ˆï¼šåœ¨æ¯ä¸ªå¤æ‚å¤„ç†å•å…ƒï¼ˆå¦‚æ³¨æ„åŠ›å’Œå‰é¦ˆç½‘ç»œï¼‰æ—è¾¹ï¼Œå»ºç«‹ä¸€æ¡<strong>ç›´è¿é€šé“</strong>ï¼Œè®©è¾“å…¥å¯ä»¥ç›´æ¥è·³è¿‡è¿™ä¸ªå•å…ƒï¼Œä¸è¯¥å•å…ƒçš„è¾“å‡ºç›¸åŠ ã€‚è¿™å°±æ˜¯<strong>å¿«æ·è¿æ¥</strong>æˆ–<strong>æ®‹å·®è¿æ¥</strong>ã€‚</p><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250831002424412.png" /></p><p>åœ¨ <code>TransformerBlock</code> ä¸­ï¼Œæ®‹å·®è¿æ¥çš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TransformerBlock</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        shortcut = x      <span class="comment"># &lt; ------ ä¿å­˜åŸå§‹è¾“å…¥</span></span><br><span class="line">        x = <span class="variable language_">self</span>.norm1(x)</span><br><span class="line">        x = <span class="variable language_">self</span>.att(x)</span><br><span class="line">        x = <span class="variable language_">self</span>.drop_shortcut(x)</span><br><span class="line">        x = x + shortcut  <span class="comment"># &lt; ------ æ®‹å·®è¿æ¥</span></span><br><span class="line"></span><br><span class="line">        shortcut = x      <span class="comment"># &lt; ------ ä¿å­˜åŸå§‹è¾“å…¥</span></span><br><span class="line">        x = <span class="variable language_">self</span>.norm2(x)</span><br><span class="line">        x = <span class="variable language_">self</span>.ff(x)</span><br><span class="line">        x = <span class="variable language_">self</span>.drop_shortcut(x)</span><br><span class="line">        x = x + shortcut  <span class="comment"># &lt; ------ æ®‹å·®è¿æ¥</span></span><br><span class="line">        <span class="keyword">return</span> x</span><br></pre></td></tr></table></figure><p>æ®‹å·®è¿æ¥åœ¨è¿™æ®µä»£ç ä¸­ä½“ç°åœ¨ä»¥ä¸‹ä¸¤ä¸ªå…³é”®æ“ä½œä¸Šï¼š</p><ol type="1"><li><code>shortcut = x</code>:è¿™æ˜¯<strong>åˆ†å‰è·¯å£</strong>ï¼Œå°†åŸå§‹ä¿¡æ¯å¤‡ä»½åˆ° <code>shortcut</code>å˜é‡ä¸­ï¼Œå¼€è¾Ÿäº†ç›´è¿é€šé“ã€‚</li><li><code>x = x + shortcut</code>:è¿™æ˜¯<strong>åå­—è·¯å£æ±‡åˆ</strong>ï¼Œå°†ä¸»å¹²é“ä¸Šç»è¿‡å¤æ‚å¤„ç†çš„ä¿¡æ¯ä¸æ—è·¯ä¸Šçš„åŸå§‹ä¿¡æ¯é‡æ–°ç»„åˆã€‚</li></ol><p>å…·ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¬¬ä¸€ä¸ªå­å±‚ï¼šå¤šå¤´æ³¨æ„åŠ› + æ®‹å·®è¿æ¥</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------- æ®‹å·®è¿æ¥çš„èµ·ç‚¹ -------------------</span></span><br><span class="line"><span class="comment"># 1. ä¿å­˜åŸå§‹è¾“å…¥ï¼šåœ¨è¿›è¡Œä»»ä½•å˜æ¢ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæŠŠåŸå§‹çš„è¾“å…¥ x ä¿å­˜åˆ°ä¸€ä¸ªåä¸º shortcut çš„å˜é‡ä¸­ã€‚</span></span><br><span class="line"><span class="comment">#    è¿™å°±ç›¸å½“äºå¼€è¾Ÿäº†ä¸€æ¡â€œå¿«æ·é€šé“â€æˆ–â€œæ—è·¯â€ï¼Œè®©åŸå§‹ä¿¡æ¯å¯ä»¥ç»•è¿‡å¤æ‚çš„å¤„ç†ã€‚</span></span><br><span class="line">shortcut = x</span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------- ä¸»å¤„ç†è·¯å¾„ (F(x)) -------------------</span></span><br><span class="line"><span class="comment"># 2. å¯¹è¾“å…¥è¿›è¡Œå¤æ‚å˜æ¢ï¼š</span></span><br><span class="line"><span class="comment">#    - å…ˆè¿›è¡Œå±‚å½’ä¸€åŒ–</span></span><br><span class="line"><span class="comment">#    - å†é€šè¿‡å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶</span></span><br><span class="line"><span class="comment">#    - æœ€ååº”ç”¨ Dropout</span></span><br><span class="line"><span class="comment">#    è¿™ä¸€ç³»åˆ—æ“ä½œçš„ç»“æœï¼Œæ›´æ–°äº†å˜é‡ xã€‚ç°åœ¨çš„ x å·²ç»ä¸å†æ˜¯åŸå§‹è¾“å…¥ï¼Œ</span></span><br><span class="line"><span class="comment">#    è€Œæ˜¯ç»è¿‡æ³¨æ„åŠ›æ¨¡å—æ·±åº¦åŠ å·¥åçš„â€œå¢é‡ä¿¡æ¯â€æˆ–â€œæ®‹å·®â€ã€‚</span></span><br><span class="line">x = <span class="variable language_">self</span>.norm1(x)</span><br><span class="line">x = <span class="variable language_">self</span>.att(x)</span><br><span class="line">x = <span class="variable language_">self</span>.drop_shortcut(x)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------- æ®‹å·®è¿æ¥çš„ç»ˆç‚¹ -------------------</span></span><br><span class="line"><span class="comment"># 3. å°†åŸå§‹è¾“å…¥ä¸å˜æ¢åçš„ç»“æœç›¸åŠ ï¼š</span></span><br><span class="line"><span class="comment">#    è¿™è¡Œä»£ç æ˜¯æ®‹å·®è¿æ¥æœ€å…³é”®çš„ä½“ç°ã€‚æˆ‘ä»¬å°†â€œå¿«æ·é€šé“â€ä¸­çš„åŸå§‹ä¿¡æ¯ (shortcut)ï¼Œ</span></span><br><span class="line"><span class="comment">#    ä¸â€œä¸»å¤„ç†è·¯å¾„â€ä¸Šç»è¿‡å¤æ‚å˜æ¢åçš„å¢é‡ä¿¡æ¯ (x) è¿›è¡Œé€å…ƒç´ ç›¸åŠ ã€‚</span></span><br><span class="line"><span class="comment">#    è¿™æ ·ï¼Œæœ€ç»ˆçš„è¾“å‡ºæ—¢åŒ…å«äº†æ–°å­¦åˆ°çš„ä¸Šä¸‹æ–‡å…³ç³»ï¼Œåˆæ²¡æœ‰ä¸¢å¤±æœ€åŸå§‹çš„è¾“å…¥ä¿¡æ¯ã€‚</span></span><br><span class="line">x = x + shortcut</span><br></pre></td></tr></table></figure><h2 id="è¾“å‡ºå±‚ä»å‘é‡åˆ°æ¦‚ç‡åˆ†å¸ƒ">2.5 è¾“å‡ºå±‚ï¼šä»å‘é‡åˆ°æ¦‚ç‡åˆ†å¸ƒ</h2><p>æˆ‘ä»¬ä»é¡¶å±‚çš„ <code>GPTModel</code> å®¹å™¨å¼€å§‹ï¼Œæ„å»ºäº†å…¶æ ¸å¿ƒçš„å¯å †å å•å…ƒ<code>TransformerBlock</code>ã€‚åœ¨ <code>TransformerBlock</code>å†…éƒ¨ï¼Œæˆ‘ä»¬ä¸ä»…å®ç°äº†å…¶è¿›è¡Œä¸Šä¸‹æ–‡ä¿¡æ¯èåˆçš„æ ¸å¿ƒæ¨¡å—â€”â€”<code>MultiHeadAttention</code>ï¼Œè¿˜é›†æˆäº†ç¡®ä¿å…¶ç¨³å®šå’Œé«˜æ•ˆè¿è¡Œçš„å…³é”®è¾…åŠ©ç»„ä»¶ï¼š<code>LayerNorm</code>ã€<code>FeedForward</code>ç½‘ç»œå’Œæ®‹å·®è¿æ¥ã€‚</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬å›åˆ° <code>GPTModel</code>çš„ç»“æ„ä¸Šï¼Œçœ‹çœ‹è¿˜å‰©ä½™å“ªäº›éƒ¨åˆ†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GPTModel</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, cfg</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">       <span class="comment"># å‰é¢éƒ½å·²ç»ä»‹ç»äº†...</span></span><br><span class="line">        <span class="variable language_">self</span>.final_norm = LayerNorm(cfg[<span class="string">&quot;emb_dim&quot;</span>])</span><br><span class="line">        <span class="variable language_">self</span>.out_head = nn.Linear(cfg[<span class="string">&quot;emb_dim&quot;</span>], cfg[<span class="string">&quot;vocab_size&quot;</span>], bias=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, in_idx</span>):</span><br><span class="line">        <span class="comment"># å‰é¢éƒ½å·²ç»ä»‹ç»äº†...</span></span><br><span class="line">        x = <span class="variable language_">self</span>.final_norm(x)</span><br><span class="line">        logits = <span class="variable language_">self</span>.out_head(x)</span><br><span class="line">        <span class="keyword">return</span> logits</span><br></pre></td></tr></table></figure><p>ç»è¿‡ <code>n_layers</code> å±‚ <code>TransformerBlock</code>çš„æ·±åº¦å¤„ç†åï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªå¼ é‡ <code>x</code>ï¼Œå…¶ç»´åº¦ä¸º<code>(batch_size, context_length, emb_dim)</code>ã€‚è¿™ä¸ªå¼ é‡ä¸­çš„æ¯ä¸€ä¸ªå‘é‡éƒ½è•´å«äº†ä¸°å¯Œçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚ç„¶è€Œï¼Œè¿™ä»ç„¶æ˜¯æ¨¡å‹çš„<strong>å†…éƒ¨è¡¨ç¤º</strong>ã€‚æ¨¡å‹çš„æœ€ç»ˆä»»åŠ¡æ˜¯<strong>é¢„æµ‹ä¸‹ä¸€ä¸ªè¯å…ƒ</strong>ã€‚</p><p><strong>æ ¹æœ¬é—®é¢˜</strong>ï¼šå¦‚ä½•å°†è¿™ä¸ª <code>emb_dim</code>ç»´åº¦çš„ã€è¿ç»­çš„å†…éƒ¨çŠ¶æ€å‘é‡ï¼Œè½¬æ¢ä¸ºä¸€ä¸ªè¦†ç›–æ•´ä¸ªè¯æ±‡è¡¨ï¼ˆ<code>vocab_size</code>ï¼‰çš„ã€ç¦»æ•£çš„é¢„æµ‹ç»“æœï¼Ÿ</p><p><strong>ç¬¬ä¸€æ€§åŸç†è§£å†³æ–¹æ¡ˆï¼šæŠ•å½±å›è¯æ±‡ç©ºé—´</strong></p><p>è¿™ä¸ªè½¬æ¢è¿‡ç¨‹ç”±è¾“å‡ºå±‚å®Œæˆï¼Œå®ƒåŒ…å«ä¸¤ä¸ªæ­¥éª¤ï¼š</p><ol type="1"><li><strong>æœ€ç»ˆå½’ä¸€åŒ– (<code>self.final_norm</code>)</strong>:åœ¨è¿›è¡Œæœ€åçš„æŠ•å½±ä¹‹å‰ï¼Œå¯¹ <code>Transformer</code>æ ˆçš„è¾“å‡ºå†è¿›è¡Œä¸€æ¬¡å±‚å½’ä¸€åŒ–ã€‚è¿™å¯ä»¥çœ‹ä½œæ˜¯è¿›å…¥æœ€ç»ˆå†³ç­–é˜¶æ®µå‰çš„ä¸€æ¬¡ä¿¡å·æ•´ç†ï¼Œç¡®ä¿è¾“å…¥åˆ°è¾“å‡ºå¤´çš„æ•°å€¼åˆ†å¸ƒæ˜¯ç¨³å®šçš„ï¼Œè¿™æœ‰åŠ©äºåç»­æŸå¤±è®¡ç®—å’Œæ¢¯åº¦ä¼ æ’­çš„ç¨³å®šæ€§ã€‚</li><li><strong>è¾“å‡ºå¤´æŠ•å½± (<code>self.out_head</code>)</strong>:è¿™æ˜¯è‡³å…³é‡è¦çš„ä¸€æ­¥ã€‚<code>self.out_head</code>æ˜¯ä¸€ä¸ªæ ‡å‡†çš„çº¿æ€§å±‚ï¼Œå…¶æƒé‡çŸ©é˜µçš„ç»´åº¦æ˜¯<code>(emb_dim, vocab_size)</code>ã€‚<ul><li><strong>å®ƒçš„ä½œç”¨</strong>ï¼šå°†æ¯ä¸€ä¸ªç»è¿‡æ·±åº¦å¤„ç†çš„ã€ä»£è¡¨ç‰¹å®šä½ç½®ä¸Šä¸‹æ–‡ä¿¡æ¯çš„<code>emb_dim</code> ç»´å‘é‡ï¼Œ<strong>çº¿æ€§æŠ•å½±</strong>åˆ°ä¸€ä¸ª<code>vocab_size</code> ç»´çš„ç©ºé—´ä¸­ã€‚</li><li><strong>è¾“å‡ºçš„å«ä¹‰</strong>ï¼šè¿™ä¸ª <code>vocab_size</code>ç»´çš„æ–°å‘é‡è¢«ç§°ä¸º<strong>logits</strong>ã€‚å®ƒçš„æ¯ä¸€ä¸ªç»´åº¦éƒ½å”¯ä¸€å¯¹åº”è¯æ±‡è¡¨ä¸­çš„ä¸€ä¸ªè¯å…ƒã€‚è¯¥ç»´åº¦ä¸Šçš„æ•°å€¼ï¼Œå°±ä»£è¡¨æ¨¡å‹é¢„æµ‹è¯¥è¯å…ƒæ˜¯ä¸‹ä¸€ä¸ªè¯çš„<strong>åŸå§‹ç½®ä¿¡åº¦åˆ†æ•°</strong>ï¼ˆæœªç»å½’ä¸€åŒ–çš„å¯¹æ•°æ¦‚ç‡ï¼‰ã€‚åˆ†æ•°è¶Šé«˜ï¼Œæ¨¡å‹è®¤ä¸ºè¯¥è¯å…ƒå‡ºç°çš„å¯èƒ½æ€§è¶Šå¤§ã€‚</li></ul></li></ol><p>æœ€ç»ˆï¼Œ<code>forward</code> å‡½æ•°è¿”å›çš„ <code>logits</code>å¼ é‡ï¼Œå…¶ç»´åº¦ä¸º<code>(batch_size, context_length, vocab_size)</code>ï¼Œç²¾ç¡®åœ°åŒ…å«äº†æ¨¡å‹åœ¨æ¯ä¸€ä¸ªè¾“å…¥ä½ç½®ä¸Šï¼Œå¯¹è¯æ±‡è¡¨ä¸­æ‰€æœ‰è¯å…ƒçš„é¢„æµ‹åˆ†æ•°ã€‚è¿™æ˜¯æ¨¡å‹è¿›è¡Œæ€è€ƒå’Œè®¡ç®—åï¼Œç»™å‡ºçš„æœ€ç»ˆç­”å·ã€‚</p><h2 id="åŸºç¡€æ–‡æœ¬ç”Ÿæˆ">2.6 åŸºç¡€æ–‡æœ¬ç”Ÿæˆ</h2><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº† <code>GPTModel</code> çš„å…¨éƒ¨æ¶æ„ä»£ç å®ç°ã€‚</p><p>å½“å‰ï¼Œæˆ‘ä»¬æ‹¥æœ‰ä¸€ä¸ªç»“æ„ä¸Šå®Œæ•´ã€å‚æ•°å¯æ‰©å±•çš„ GPTæ¨¡å‹è“å›¾ã€‚ç„¶è€Œï¼Œå¿…é¡»æ˜ç¡®çš„æ˜¯ï¼Œè¿™ä¸ªæ¨¡å‹çš„æ‰€æœ‰å¯è®­ç»ƒå‚æ•°ï¼ˆ<code>nn.Embedding</code>ã€<code>nn.Linear</code>ã€<code>LayerNorm</code>ä¸­çš„æƒé‡å’Œåç½®ï¼‰å‡ç”±<strong>éšæœºå€¼</strong>åˆå§‹åŒ–ã€‚å› æ­¤ï¼Œå°½ç®¡æ¨¡å‹ç»“æ„å·²ç»å®Œå¤‡ï¼Œä½†å®ƒä¸å…·å¤‡ä»»ä½•è¯­è¨€çŸ¥è¯†ï¼Œæ— æ³•æ‰§è¡Œä»»ä½•æœ‰æ„ä¹‰çš„ä»»åŠ¡ï¼Œå…¶è¾“å‡ºå°†æ˜¯æ— æ„ä¹‰çš„éšæœºå†…å®¹ã€‚</p><p>ä¸è¿‡ï¼Œåœ¨è®©æˆ‘ä»¬çš„æ¨¡å‹å…·å¤‡è¾“å‡ºæœ‰æ„ä¹‰çš„å†…å®¹ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜æ˜¯å…ˆæ¥å®ç°æ¨¡å‹æ–‡æœ¬ç”Ÿæˆçš„èƒ½åŠ›ã€‚GPTæ¨¡å‹å°†è¾“å‡ºå¼ é‡è½¬åŒ–ä¸ºç”Ÿæˆæ–‡æœ¬çš„è¿‡ç¨‹æ¶‰åŠå¤šä¸ªæ­¥éª¤ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚è¿™äº›æ­¥éª¤åŒ…æ‹¬è§£ç è¾“å‡ºå¼ é‡ã€æ ¹æ®æ¦‚ç‡åˆ†å¸ƒé€‰æ‹©è¯å…ƒï¼Œä»¥åŠå°†è¿™äº›è¯å…ƒè½¬æ¢ä¸ºäººç±»å¯è¯»çš„æ–‡æœ¬ã€‚</p><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250831005826451.png" /></p><p>ä¸‹å›¾æ›´åŠ è¯¦ç»†åœ°å±•ç¤ºçš„ä¸‹ä¸€è¯å…ƒç”Ÿæˆè¿‡ç¨‹è¯´æ˜äº† GPTæ¨¡å‹å¦‚ä½•åœ¨ç»™å®šè¾“å…¥çš„æƒ…å†µä¸‹ç”Ÿæˆä¸‹ä¸€ä¸ªè¯å…ƒã€‚åœ¨æ¯ä¸€æ­¥ä¸­ï¼Œæ¨¡å‹è¾“å‡ºä¸€ä¸ªçŸ©é˜µï¼Œå…¶ä¸­çš„å‘é‡è¡¨ç¤ºæœ‰å¯èƒ½çš„ä¸‹ä¸€ä¸ªè¯å…ƒã€‚å°†ä¸ä¸‹ä¸€ä¸ªè¯å…ƒå¯¹åº”çš„å‘é‡æå–å‡ºæ¥ï¼Œå¹¶é€šè¿‡softmaxå‡½æ•°è½¬æ¢ä¸ºæ¦‚ç‡åˆ†å¸ƒã€‚åœ¨åŒ…å«è¿™äº›æ¦‚ç‡åˆ†æ•°çš„å‘é‡ä¸­ï¼Œæ‰¾åˆ°æœ€é«˜å€¼çš„ç´¢å¼•ï¼Œè¿™ä¸ªç´¢å¼•å¯¹åº”äºè¯å…ƒIDã€‚ç„¶åå°†è¿™ä¸ªè¯å…ƒ IDè§£ç ä¸ºæ–‡æœ¬ï¼Œç”Ÿæˆåºåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªè¯å…ƒã€‚æœ€åï¼Œå°†è¿™ä¸ªè¯å…ƒé™„åŠ åˆ°ä¹‹å‰çš„è¾“å…¥ä¸­ï¼Œå½¢æˆæ–°çš„è¾“å…¥åºåˆ—ï¼Œä¾›ä¸‹ä¸€æ¬¡è¿­ä»£ä½¿ç”¨ã€‚è¿™ä¸ªé€æ­¥çš„è¿‡ç¨‹ä½¿å¾—æ¨¡å‹èƒ½å¤ŸæŒ‰é¡ºåºç”Ÿæˆæ–‡æœ¬ï¼Œä»æœ€åˆçš„è¾“å…¥ä¸Šä¸‹æ–‡ä¸­æ„å»ºè¿è´¯çš„çŸ­è¯­å’Œå¥å­ã€‚</p><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250831005901397.png" /></p><p>è®©æˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªæ–‡æœ¬ç”Ÿæˆå·¥å…·ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼Œ<code>generate_and_print_sample</code>æ˜¯ä¸€ä¸ªç”¨äºå¿«é€ŸéªŒè¯å’Œå±•ç¤ºçš„ä¾¿æ·å·¥å…·ï¼Œå®ƒå°è£…äº†ä»ç¼–ç ã€ç”Ÿæˆåˆ°è§£ç çš„å…¨è¿‡ç¨‹ï¼Œå¹¶å¦¥å–„å¤„ç†äº†æ¨¡å‹çš„è®­ç»ƒ/è¯„ä¼°æ¨¡å¼åˆ‡æ¢ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">generate_and_print_sample</span>(<span class="params">model, tokenizer, device, start_context</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ç”Ÿæˆæ–‡æœ¬æ ·æœ¬&quot;&quot;&quot;</span></span><br><span class="line">    model.<span class="built_in">eval</span>()</span><br><span class="line">    context_size = model.pos_emb.weight.shape[<span class="number">0</span>]</span><br><span class="line">    encoded = text_to_token_ids(start_context, tokenizer).to(device)</span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        token_ids = generate_text_simple(</span><br><span class="line">            model=model, idx=encoded,</span><br><span class="line">            max_new_tokens=<span class="number">50</span>, context_length=context_size,</span><br><span class="line">        )</span><br><span class="line">    decoded_text = token_ids_to_text(token_ids, tokenizer)</span><br><span class="line">    <span class="built_in">print</span>(decoded_text.replace(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot; &quot;</span>))</span><br><span class="line">    model.train()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_text_simple</span>(<span class="params">model, idx, max_new_tokens, context_length</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ä½¿ç”¨æ¨¡å‹ç”Ÿæˆæ–‡æœ¬&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(max_new_tokens):</span><br><span class="line">        idx_cond = idx[:, -context_length:]</span><br><span class="line">        <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">            logits = model(idx_cond)</span><br><span class="line"></span><br><span class="line">        logits = logits[:, -<span class="number">1</span>, :]</span><br><span class="line">        probas = torch.softmax(logits, dim=-<span class="number">1</span>)</span><br><span class="line">        idx_next = torch.argmax(probas, dim=-<span class="number">1</span>, keepdim=<span class="literal">True</span>)</span><br><span class="line">        idx = torch.cat((idx, idx_next), dim=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> idx</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">text_to_token_ids</span>(<span class="params">text, tokenizer</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å°†æ–‡æœ¬è½¬æ¢ä¸ºtoken ID&quot;&quot;&quot;</span></span><br><span class="line">    encoded = tokenizer.encode(text, allowed_special=&#123;<span class="string">&#x27;&lt;|endoftext|&gt;&#x27;</span>&#125;)</span><br><span class="line">    encoded_tensor = torch.tensor(encoded).unsqueeze(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> encoded_tensor</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">token_ids_to_text</span>(<span class="params">token_ids, tokenizer</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å°†token IDè½¬æ¢å›æ–‡æœ¬&quot;&quot;&quot;</span></span><br><span class="line">    flat = token_ids.squeeze(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> tokenizer.decode(flat.tolist())</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å°è¯•è°ƒç”¨ä¸€ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">generate_and_print_sample(model, tokenizer, device, <span class="string">&quot;Every effort moves you&quot;</span>)</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¾“å‡ºæ˜¯æ¯«æ— æ„ä¹‰çš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Every effort moves you Mexican rarity implementing NouPsychCle...&quot; Contributamong enable lacked complications tendon conclud Nearly oddly insign Champions senseless poopuclear shuts dove aspirinentionrous Miniasions fearsomeRanked adore disadvantages disregkeepvocensed eased museums William glovesople Palace shooters increases felony chops Batteryracuse Advertising cease</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆï¼Œå¦‚ä½•å°†è¿™ä¸ªå‚æ•°éšæœºåŒ–çš„æ¶æ„ï¼Œè½¬å˜ä¸ºä¸€ä¸ªèƒ½å¤Ÿç†è§£å’Œç”Ÿæˆè¯­è¨€çš„åŠŸèƒ½æ€§æ¨¡å‹å‘¢ï¼Ÿç­”æ¡ˆæ˜¯é€šè¿‡<strong>æ¨¡å‹è®­ç»ƒ(Model Training)</strong>ã€‚</p><h1 id="è®­ç»ƒæ¨¡å‹">3. è®­ç»ƒæ¨¡å‹</h1><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250831134852813.png" style="zoom:33%;" /></p><p>æœ¬ç¯‡æˆ‘ä»¬å°†è¿›å…¥å°†æ¶æ„èµ‹äºˆç”Ÿå‘½çš„æ ¸å¿ƒç¯èŠ‚ï¼š<strong>å®ç°è®­ç»ƒå¾ªç¯(TrainingLoop)</strong>ã€‚æˆ‘ä»¬å°†è¯¦ç»†ä»‹ç»æ¨¡å‹å¦‚ä½•é€šè¿‡å¤„ç†å¤§é‡æ–‡æœ¬æ•°æ®ï¼Œåœ¨ä¸€ä¸ªåå¤è¿­ä»£çš„è¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿæ€§åœ°è°ƒæ•´å…¶å†…éƒ¨æ•°ä»¥äº¿è®¡çš„å‚æ•°ã€‚</p><p>æˆ‘ä»¬å°†å…·ä½“æ¢è®¨<strong>æŸå¤±å‡½æ•° (Loss Function)</strong>çš„è®¡ç®—ã€<strong>ä¼˜åŒ–å™¨ (Optimizer)</strong> çš„ä½œç”¨ä»¥åŠ<strong>åå‘ä¼ æ’­(Backpropagation)</strong>çš„æœºåˆ¶ï¼Œè¿™äº›æ˜¯é©±åŠ¨æ¨¡å‹ä»éšæœºçŠ¶æ€å‘æ™ºèƒ½çŠ¶æ€æ”¶æ•›çš„æ ¹æœ¬åŠ¨åŠ›ã€‚</p><h2 id="æ¨¡å‹è®­ç»ƒæµç¨‹">3.1 æ¨¡å‹è®­ç»ƒæµç¨‹</h2><p><strong>è®­ç»ƒæµç¨‹</strong>çš„æ ¹æœ¬ç›®çš„ï¼Œå°±æ˜¯é€šè¿‡ä¸€ä¸ªç³»ç»Ÿæ€§çš„ã€è¿­ä»£çš„ä¼˜åŒ–è¿‡ç¨‹ï¼Œè®©åˆå§‹åŒ–çš„<code>GPTModel</code>è¿™ä¸ª"ç©ºå£³å¤§è„‘"é€šè¿‡å­¦ä¹ æµ·é‡çš„æ•°æ®æ ·æœ¬ï¼Œé€æ­¥è°ƒæ•´å…¶å†…éƒ¨å‚æ•°ï¼Œæœ€ç»ˆæŒæ¡é¢„æµ‹ä¸‹ä¸€ä¸ªè¯å…ƒçš„è§„å¾‹ã€‚</p><p>æ¨¡å‹å­¦ä¹ çš„æ•°å­¦åŸºç¡€æ˜¯<strong>æ¢¯åº¦ä¸‹é™ (GradientDescent)</strong>ã€‚å…¶æ ¸å¿ƒæ€æƒ³å¯ä»¥å½’ç»“ä¸ºï¼š</p><ol type="1"><li><strong>å®šä¹‰ç›®æ ‡</strong>ï¼šæˆ‘ä»¬éœ€è¦ä¸€ä¸ª<strong>æŸå¤±å‡½æ•° (LossFunction)</strong>æ¥é‡åŒ–æ¨¡å‹å½“å‰é¢„æµ‹ä¸çœŸå®ç­”æ¡ˆä¹‹é—´çš„å·®è·ã€‚å·®è·è¶Šå¤§ï¼ŒæŸå¤±å€¼è¶Šé«˜ã€‚</li><li><strong>å¯»æ‰¾æ–¹å‘</strong>ï¼šé€šè¿‡å¾®ç§¯åˆ†è®¡ç®—æŸå¤±å‡½æ•°å¯¹æ¨¡å‹ä¸­æ¯ä¸€ä¸ªå‚æ•°çš„<strong>æ¢¯åº¦(Gradient)</strong>ã€‚æ¢¯åº¦æŒ‡æ˜äº†åœ¨è¯¥å‚æ•°ä¸Šï¼Œèƒ½è®©æŸå¤±å€¼<strong>ä¸Šå‡æœ€å¿«</strong>çš„æ–¹å‘ã€‚</li><li><strong>è¿›è¡Œä¿®æ­£</strong>ï¼šæˆ‘ä»¬è®©å‚æ•°æœç€æ¢¯åº¦çš„<strong>ç›¸åæ–¹å‘</strong>è¿ˆå‡ºä¸€å°æ­¥ã€‚è¿™ä¸€å°æ­¥çš„æ­¥é•¿ç”±<strong>å­¦ä¹ ç‡(Learning Rate)</strong> æ§åˆ¶ã€‚</li><li><strong>åå¤è¿­ä»£</strong>ï¼šä¸æ–­é‡å¤"é¢„æµ‹-&gt;è®¡ç®—æŸå¤±-&gt;è®¡ç®—æ¢¯åº¦-&gt;æ›´æ–°å‚æ•°"çš„è¿‡ç¨‹ï¼Œæ¨¡å‹çš„å‚æ•°å°±ä¼šè¢«é€æ­¥ä¼˜åŒ–ï¼Œä½¿å¾—æŸå¤±å€¼è¶Šæ¥è¶Šå°ï¼Œé¢„æµ‹è¶Šæ¥è¶Šå‡†ã€‚</li></ol><p><code>train_model_simple</code> å‡½æ•°å°±æ˜¯è¿™ä¸€åŸç†çš„ç²¾ç¡®ä»£ç å®ç°ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">train_model_simple</span>(<span class="params">model, train_loader, val_loader,</span></span><br><span class="line"><span class="params">                    optimizer, device, num_epochs,</span></span><br><span class="line"><span class="params">                    eval_freq, eval_iter, start_context, tokenizer</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è®­ç»ƒæ¨¡å‹çš„ä¸»å¾ªç¯&quot;&quot;&quot;</span></span><br><span class="line">    train_losses, val_losses, track_tokens_seen = [], [], []</span><br><span class="line">    tokens_seen, global_step = <span class="number">0</span>, -<span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(num_epochs):</span><br><span class="line">        model.train()</span><br><span class="line">        <span class="keyword">for</span> input_batch, target_batch <span class="keyword">in</span> train_loader:</span><br><span class="line">            optimizer.zero_grad()</span><br><span class="line">            loss = calc_loss_batch(input_batch, target_batch, model, device)</span><br><span class="line">            loss.backward()</span><br><span class="line">            optimizer.step()</span><br><span class="line">            tokens_seen += input_batch.numel()</span><br><span class="line">            global_step += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># å®šæœŸè¯„ä¼°</span></span><br><span class="line">            <span class="keyword">if</span> global_step % eval_freq == <span class="number">0</span>:</span><br><span class="line">                train_loss, val_loss = evaluate_model(</span><br><span class="line">                    model, train_loader, val_loader, device, eval_iter)</span><br><span class="line">                train_losses.append(train_loss)</span><br><span class="line">                val_losses.append(val_loss)</span><br><span class="line">                track_tokens_seen.append(tokens_seen)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Ep <span class="subst">&#123;epoch+<span class="number">1</span>&#125;</span> (Step <span class="subst">&#123;global_step:06d&#125;</span>):&quot;</span></span><br><span class="line">                    <span class="string">f&quot;Train loss <span class="subst">&#123;train_loss:<span class="number">.3</span>f&#125;</span>, &quot;</span></span><br><span class="line">                    <span class="string">f&quot;Val loss <span class="subst">&#123;val_loss:<span class="number">.3</span>f&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ¯3ä¸ªepochç”Ÿæˆæ ·æœ¬</span></span><br><span class="line">        <span class="keyword">if</span> epoch % <span class="number">3</span> == <span class="number">0</span>:</span><br><span class="line">            generate_and_print_sample(model, tokenizer, device, start_context)</span><br><span class="line">    <span class="keyword">return</span> train_losses, val_losses, track_tokens_seen</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªå‡½æ•°çš„ç»“æ„åˆ†è§£ä¸ºä¸‰ä¸ªå±‚æ¬¡ï¼š<strong>å¤–å±‚å¾ªç¯</strong>ã€<strong>æ ¸å¿ƒå­¦ä¹ å¾ªç¯</strong>å’Œ<strong>ç›‘æ§ç³»ç»Ÿ</strong>ã€‚</p><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250831011653589.png" /></p><h3 id="å¤–å±‚å¾ªç¯">3.1.1 å¤–å±‚å¾ªç¯</h3><p><code>for epoch in range(num_epochs):</code>å®šä¹‰äº†æ¨¡å‹éœ€è¦å®Œæ•´åœ°çœ‹å‡ éæ•´ä¸ªè®­ç»ƒæ•°æ®é›†ã€‚ä¸€ä¸ª <strong>Epoch</strong>ä»£è¡¨å¯¹æ‰€æœ‰è®­ç»ƒæ•°æ®çš„ä¸€æ¬¡å®Œæ•´éå†ã€‚è®©æ¨¡å‹åå¤çœ‹åŒæ ·çš„æ•°æ®ï¼Œæ˜¯ä¸ºäº†ä½¿å…¶æœ‰æœºä¼šä»ä¸åŒçš„æ‰¹æ¬¡ç»„åˆå’Œéšæœºé¡ºåºä¸­ï¼Œæ›´æ·±å…¥åœ°å­¦ä¹ æ•°æ®ä¸­çš„æ¨¡å¼ã€‚</p><h3 id="æ ¸å¿ƒå­¦ä¹ å¾ªç¯">3.1.2 æ ¸å¿ƒå­¦ä¹ å¾ªç¯</h3><p><code>for input_batch, target_batch in train_loader:</code>æ˜¯å­¦ä¹ å‘ç”Ÿçš„çœŸæ­£åœºæ‰€ã€‚å¯¹äºä» <code>train_loader</code>ä¸­å–å‡ºçš„æ¯ä¸€ä¸ªæ•°æ®æ‰¹æ¬¡ï¼Œæ¨¡å‹éƒ½ä¼šä¸¥æ ¼æ‰§è¡Œæ¢¯åº¦ä¸‹é™çš„"å››æ­¥æ›²"ï¼š</p><ol type="1"><li><p>æ¸…ç©ºæ—§æ¢¯åº¦<code>optimizer.zero_grad()</code></p><p>PyTorchçš„æ¢¯åº¦è®¡ç®—é»˜è®¤æ˜¯<strong>ç´¯åŠ </strong>çš„ã€‚å¦‚æœä¸æ‰‹åŠ¨æ¸…é›¶ï¼Œå½“å‰æ‰¹æ¬¡è®¡ç®—å‡ºçš„æ¢¯åº¦ä¼šå’Œä¹‹å‰æ‰€æœ‰æ‰¹æ¬¡çš„æ¢¯åº¦å åŠ åœ¨ä¸€èµ·ï¼Œå¯¼è‡´é”™è¯¯çš„æ›´æ–°æ–¹å‘ã€‚å› æ­¤ï¼Œåœ¨æ¯æ¬¡è®¡ç®—æ–°æ¢¯åº¦å‰ï¼Œå¿…é¡»å…ˆâ€œæ¸…ç©ºç¼“å­˜â€ã€‚</p></li><li><p>å‰å‘ä¼ æ’­ä¸è®¡ç®—æŸå¤± <code>loss = calc_loss_batch(...)</code></p><p>æˆ‘ä»¬éœ€è¦çŸ¥é“æ¨¡å‹åœ¨å½“å‰å‚æ•°ä¸‹çš„è¡¨ç°æœ‰å¤šå·®ã€‚<code>calc_loss_batch</code>å‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨<code>model(input_batch)</code>ï¼Œå®Œæˆä¸€æ¬¡<strong>å‰å‘ä¼ æ’­</strong>ï¼Œå¾—åˆ°é¢„æµ‹çš„logitsã€‚ç„¶åï¼Œä½¿ç”¨<strong>äº¤å‰ç†µæŸå¤±å‡½æ•°</strong><code>cross_entropy</code> æ¥è®¡ç®—é¢„æµ‹ logits å’ŒçœŸå®<code>target_batch</code> ä¹‹é—´çš„å·®è·ï¼Œå¾—åˆ°ä¸€ä¸ªé‡åŒ–è¯¯å·®çš„æ ‡é‡<code>loss</code>ã€‚</p></li><li><p>åå‘ä¼ æ’­è®¡ç®—æ¢¯åº¦ <code>loss.backward()</code></p><p>çŸ¥é“äº†æ€»è¯¯å·®ï¼ˆ<code>loss</code>ï¼‰åï¼Œæˆ‘ä»¬éœ€è¦å°†è¿™ä¸ªè¯¯å·®"åˆ†æ‘Š"åˆ°æ¯ä¸€ä¸ªå¯¼è‡´è¯¯å·®çš„å‚æ•°ä¸Šï¼Œå³è®¡ç®—æŸå¤±å¯¹æ¯ä¸€ä¸ªæ¨¡å‹å‚æ•°çš„åå¯¼æ•°ã€‚è¿™æ˜¯PyTorch <code>autograd</code>å¼•æ“çš„æ ¸å¿ƒåŠŸèƒ½ã€‚è¿™ä¸€è¡Œä»£ç ä¼šè‡ªåŠ¨åœ°ã€é«˜æ•ˆåœ°å®Œæˆæ•´ä¸ª<strong>åå‘ä¼ æ’­</strong>è¿‡ç¨‹ï¼Œè®¡ç®—å‡ºæ¨¡å‹ä¸­æ‰€æœ‰å¯è®­ç»ƒå‚æ•°çš„æ¢¯åº¦ï¼Œå¹¶å­˜å‚¨åœ¨å®ƒä»¬çš„<code>.grad</code> å±æ€§ä¸­ã€‚</p><blockquote><p>ä¸ç†Ÿæ‚‰åå‘ä¼ æ’­æ¦‚å¿µçš„è¯»è€…ï¼Œå¯å‚è€ƒï¼š<ahref="https://hedon.top/2025/07/27/llm/back-propagation/">å¤§ç™½è¯è§£é‡Šåå‘ä¼ æ’­ç®—æ³•</a></p></blockquote></li><li><p>æ›´æ–°æ¨¡å‹å‚æ•° <code>optimizer.step()</code></p><p>æœ‰äº†ä¿®æ­£æ–¹å‘ï¼ˆæ¢¯åº¦ï¼‰åï¼Œéœ€è¦ä¸€ä¸ªæ‰§è¡Œè€…æ¥å®é™…åœ°è°ƒæ•´å‚æ•°ã€‚ä¼˜åŒ–å™¨ï¼ˆå¦‚<code>AdamW</code>ï¼‰ä¼šæ ¹æ® <code>loss.backward()</code>è®¡ç®—å‡ºçš„æ¢¯åº¦ï¼Œä»¥åŠè‡ªèº«çš„æ›´æ–°è§„åˆ™ï¼ˆå¦‚å­¦ä¹ ç‡ï¼‰ï¼Œå»æ›´æ–°æ¨¡å‹ä¸­çš„æ¯ä¸€ä¸ªå‚æ•°ï¼Œå®Œæˆä¸€æ¬¡å­¦ä¹ å’Œè¿›åŒ–ã€‚</p></li></ol><h3 id="ç›‘æ§ç³»ç»Ÿ">3.1.3 ç›‘æ§ç³»ç»Ÿ</h3><p>ä»…ä»…é—·å¤´å­¦ä¹ æ˜¯ä¸å¤Ÿçš„ï¼Œæˆ‘ä»¬è¿˜éœ€è¦çŸ¥é“å­¦å¾—æ€ä¹ˆæ ·ã€‚è¿™ä¸ªå‡½æ•°å†…ç½®äº†ä¸¤å¥—ç›‘æ§ç³»ç»Ÿï¼š</p><ul><li><strong>å®šé‡è¯„ä¼°(<code>if global_step % eval_freq == 0</code>)</strong>ï¼šæ¯éš”<code>eval_freq</code> æ­¥ï¼Œå°±è°ƒç”¨ <code>evaluate_model</code>å‡½æ•°ã€‚è¯¥å‡½æ•°ä¼šæš‚åœè®­ç»ƒ (<code>model.eval()</code>)ï¼Œåœ¨ä¸è®¡ç®—æ¢¯åº¦(<code>torch.no_grad()</code>)çš„æ¨¡å¼ä¸‹ï¼Œå¿«é€Ÿè®¡ç®—æ¨¡å‹åœ¨<strong>è®­ç»ƒé›†</strong>å’Œ<strong>éªŒè¯é›†</strong>ä¸Šçš„æŸå¤±ã€‚é€šè¿‡è§‚å¯Ÿè¿™ä¸¤ä¸ªæŸå¤±çš„å˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ™°åœ°äº†è§£æ¨¡å‹çš„å­¦ä¹ çŠ¶æ€ã€‚</li><li><strong>å®šæ€§è§‚å¯Ÿ (<code>if epoch % 3 == 0</code>)</strong>ï¼šæ¯éš”å‡ ä¸ªepochï¼Œå°±è°ƒç”¨ <code>generate_and_print_sample</code>å‡½æ•°ã€‚å®ƒä¼šç»™æ¨¡å‹ä¸€ä¸ªå›ºå®šçš„å¼€å¤´(<code>start_context</code>)ï¼Œè®©æ¨¡å‹åœ¨å½“å‰çš„å­¦ä¹ çŠ¶æ€ä¸‹ç»­å†™ä¸€æ®µæ–‡æœ¬ã€‚é€šè¿‡è§‚å¯Ÿä»æœ€åˆçš„â€œèƒ¡è¨€ä¹±è¯­â€åˆ°é€æ¸ç”Ÿæˆé€šé¡ºå¥å­çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—æœ€ç›´è§‚çš„åé¦ˆã€‚</li></ul><h2 id="è®¡ç®—æ–‡æœ¬ç”ŸæˆæŸå¤±">3.2 è®¡ç®—æ–‡æœ¬ç”ŸæˆæŸå¤±</h2><p>åœ¨ <code>train_model_simple</code> ä¸­ï¼Œæœ‰ä¸¤ä¸ªå…³é”®çš„è¾…åŠ©å‡½æ•°ï¼š</p><ul><li><code>calc_loss_batch</code>ï¼šå¯¹äºç»™å®šçš„ä¸€ä¸ªæ‰¹æ¬¡æ•°æ®ï¼Œè®¡ç®—å‡ºæ¨¡å‹é¢„æµ‹ä¸çœŸå®ç­”æ¡ˆä¹‹é—´çš„å·®è·æœ‰å¤šå¤§ã€‚</li><li><code>evaluate_model</code>ï¼šåœ¨ä¸æ›´æ–°æ¨¡å‹å‚æ•°çš„å‰æä¸‹ï¼Œå®¢è§‚åœ°è¯„ä¼°æ¨¡å‹åœ¨å½“å‰é˜¶æ®µçš„å­¦ä¹ æ•ˆæœã€‚</li></ul><h3 id="æ‰¹é‡æŸå¤±è®¡ç®—">3.2.1 æ‰¹é‡æŸå¤±è®¡ç®—</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">calc_loss_batch</span>(<span class="params">input_batch, target_batch, model, device</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è®¡ç®—å•ä¸ªæ‰¹æ¬¡çš„æŸå¤±&quot;&quot;&quot;</span></span><br><span class="line">    input_batch = input_batch.to(device)</span><br><span class="line">    target_batch = target_batch.to(device)</span><br><span class="line">    logits = model(input_batch)</span><br><span class="line">    loss = torch.nn.functional.cross_entropy(</span><br><span class="line">        logits.flatten(<span class="number">0</span>, <span class="number">1</span>), target_batch.flatten(),</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> loss</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬é¦–å…ˆéœ€è¦å¼„æ¸…æ¥šä¸€ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š<strong><u>ä»€ä¹ˆå«åšæ¨¡å‹é¢„æµ‹ä¸çœŸå®ç­”æ¡ˆä¹‹é—´çš„å·®è·ï¼Ÿè¿™ä¸ªå·®è·æ€ä¹ˆç®—ï¼Ÿä¸ºä»€ä¹ˆèƒ½è¿™ä¹ˆç®—ï¼Ÿ</u></strong></p><h4 id="å·®è·çš„æœ¬è´¨æ˜¯ä»€ä¹ˆ">3.2.1.1 å·®è·çš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ</h4><ul><li><strong>æ¨¡å‹çš„é¢„æµ‹</strong>ï¼š<code>logits</code>ã€‚å¯¹äºè¾“å…¥åºåˆ—ä¸­çš„æ¯ä¸€ä¸ªä½ç½®ï¼Œæ¨¡å‹éƒ½ä¼šè¾“å‡ºä¸€ä¸ªé•¿åº¦ä¸º<code>vocab_size</code> (ä¾‹å¦‚ 50257)çš„å‘é‡ã€‚è¿™ä¸ªå‘é‡é‡Œçš„æ¯ä¸€ä¸ªæ•°å€¼ï¼Œä»£è¡¨æ¨¡å‹è®¤ä¸ºå¯¹åº”çš„è¯å…ƒæ˜¯æ­£ç¡®ç­”æ¡ˆçš„<strong>åŸå§‹ç½®ä¿¡åº¦åˆ†æ•°</strong>ã€‚åˆ†æ•°è¶Šé«˜ï¼Œä»£è¡¨æ¨¡å‹è¶Šç¡®ä¿¡ã€‚</li><li><strong>çœŸå®ç­”æ¡ˆ</strong>ï¼š<code>target_batch</code>ã€‚è¿™æ˜¯ä¸€ä¸ªå…·ä½“çš„ã€å”¯ä¸€çš„è¯å…ƒIDã€‚ä¾‹å¦‚ï¼Œå¯¹äºè¾“å…¥ <code>"Time is"</code>ï¼Œæ­£ç¡®çš„ä¸‹ä¸€ä¸ªè¯æ˜¯<code>"an"</code>ï¼Œé‚£ä¹ˆçœŸå®ç­”æ¡ˆå°±æ˜¯ <code>"an"</code> å¯¹åº”çš„é‚£ä¸ªå”¯ä¸€çš„IDã€‚</li><li><strong>å·®è·</strong>ï¼šå·®è·å°±æ˜¯<strong>æ¨¡å‹èµ‹äºˆ"çœŸå®ç­”æ¡ˆ"çš„é‚£ä¸ªç½®ä¿¡åº¦åˆ†æ•°ï¼Œä¸å®ƒæœ¬åº”è¾¾åˆ°çš„ç†æƒ³çŠ¶æ€ï¼ˆç»å¯¹ç¡®ä¿¡ï¼‰ä¹‹é—´çš„è·ç¦»</strong>ã€‚å¦‚æœæ¨¡å‹ç»™çœŸå®ç­”æ¡ˆçš„ç½®ä¿¡åº¦åˆ†æ•°å¾ˆé«˜ï¼Œè€Œç»™å…¶ä»–æ‰€æœ‰é”™è¯¯ç­”æ¡ˆçš„åˆ†æ•°éƒ½å¾ˆä½ï¼Œé‚£ä¹ˆè¿™ä¸ªå·®è·å°±å¾ˆå°ã€‚åä¹‹ï¼Œå¦‚æœæ¨¡å‹ç»™çœŸå®ç­”æ¡ˆçš„åˆ†æ•°å¾ˆä½ï¼Œé‚£ä¹ˆå·®è·å°±å¾ˆå¤§ã€‚</li></ul><h4 id="è¿™ä¸ªå·®è·æ€ä¹ˆç®—">3.2.1.2 è¿™ä¸ªå·®è·æ€ä¹ˆç®—ï¼Ÿ</h4><p><code>torch.nn.functional.cross_entropy</code>è¿™ä¸ªå‡½æ•°è™½ç„¶åªæœ‰ä¸€è¡Œï¼Œä½†å®ƒåœ¨å†…éƒ¨å®Œæˆäº†ä¸¤ä¸ªå…³é”®çš„æ•°å­¦æ­¥éª¤ï¼Œæ¥å°†æˆ‘ä»¬ä¸Šé¢æè¿°çš„æŠ½è±¡å·®è·è½¬åŒ–ä¸ºä¸€ä¸ªå¯é‡åŒ–çš„æ•°å€¼ï¼ˆæŸå¤±ï¼‰ã€‚</p><p><strong>ç¬¬ä¸€æ­¥ï¼šä½¿ç”¨ <code>Softmax</code>å°†ç½®ä¿¡åº¦åˆ†æ•°è½¬ä¸ºæ¦‚ç‡</strong></p><p>æ¨¡å‹çš„ <code>logits</code>åªæ˜¯åŸå§‹åˆ†æ•°ï¼Œæœ‰æ­£æœ‰è´Ÿï¼Œå¤§å°ä¸ä¸€ï¼Œä¸æ–¹ä¾¿ç›´æ¥æ¯”è¾ƒã€‚æˆ‘ä»¬éœ€è¦å°†å®ƒè½¬æ¢æˆä¸€ä¸ªæ ‡å‡†çš„<strong>æ¦‚ç‡åˆ†å¸ƒ</strong>ï¼Œå³æ‰€æœ‰å¯èƒ½ç­”æ¡ˆçš„æ¦‚ç‡åŠ èµ·æ¥ç­‰äº1ã€‚<code>Softmax</code> å‡½æ•°å°±æ˜¯åšè¿™ä¸ªçš„ã€‚</p><p>ä¾‹å¦‚ï¼Œå‡è®¾è¯æ±‡è¡¨åªæœ‰ 5 ä¸ªè¯ï¼Œå¯¹äºæŸä¸ªä½ç½®ï¼Œæ¨¡å‹è¾“å‡ºçš„<code>logits</code> æ˜¯ <code>[1.0, 4.0, 2.0, -1.0, 0.0]</code>ã€‚ç»è¿‡<code>Softmax</code> è½¬æ¢åï¼Œå®ƒä¼šå˜æˆç±»ä¼¼<code>[0.02, 0.68, 0.06, 0.00, 0.24]</code> çš„æ¦‚ç‡åˆ†å¸ƒã€‚</p><p>ç°åœ¨ï¼Œæ¨¡å‹çš„é¢„æµ‹å˜å¾—æ¸…æ™°äº†ï¼šå®ƒæœ‰ 68%çš„æŠŠæ¡è®¤ä¸ºç¬¬äºŒä¸ªè¯æ˜¯æ­£ç¡®ç­”æ¡ˆã€‚</p><p><strong>ç¬¬äºŒæ­¥ï¼šä½¿ç”¨è´Ÿå¯¹æ•°ä¼¼ç„¶ (Negative Log-Likelihood)è®¡ç®—æŸå¤±</strong></p><p>ç°åœ¨æˆ‘ä»¬æœ‰äº†æ¨¡å‹çš„æ¦‚ç‡é¢„æµ‹ï¼Œä¹ŸçŸ¥é“äº†å”¯ä¸€çš„æ­£ç¡®ç­”æ¡ˆï¼ˆæ¯”å¦‚å°±æ˜¯ç¬¬äºŒä¸ªè¯ï¼‰ã€‚æˆ‘ä»¬å¦‚ä½•é‡åŒ–è¿™ä¸ªé¢„æµ‹çš„å¥½åå‘¢ï¼Ÿ</p><p>æˆ‘ä»¬åªéœ€è¦çœ‹æ¨¡å‹<strong>èµ‹äºˆé‚£ä¸ªæ­£ç¡®ç­”æ¡ˆçš„æ¦‚ç‡å€¼</strong>ã€‚åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œæ˜¯<code>0.68</code>ã€‚</p><ul><li><strong>ç†æƒ³æƒ…å†µ</strong>ï¼šå¦‚æœæ¨¡å‹å®Œç¾ï¼Œå®ƒåº”è¯¥ç»™æ­£ç¡®ç­”æ¡ˆ 100%çš„æ¦‚ç‡ï¼Œå³ <code>1.0</code>ã€‚</li><li><strong>æˆ‘ä»¬å¸Œæœ›</strong>ï¼šè®©æ¨¡å‹èµ‹äºˆæ­£ç¡®ç­”æ¡ˆçš„æ¦‚ç‡å°½å¯èƒ½æ¥è¿‘<code>1.0</code>ã€‚</li></ul><p>è´Ÿå¯¹æ•°ä¼¼ç„¶å°±æ˜¯å®ç°è¿™ä¸ªç›®æ ‡çš„å®Œç¾å·¥å…·ã€‚å®ƒçš„å…¬å¼æ˜¯ <spanclass="math inline">\(Loss=âˆ’log(p_{correct})\)</span>ï¼Œå…¶ä¸­ <spanclass="math inline">\(p_{correct}\)</span>æ˜¯æ¨¡å‹èµ‹äºˆæ­£ç¡®ç­”æ¡ˆçš„æ¦‚ç‡ã€‚</p><p>è®©æˆ‘ä»¬çœ‹çœ‹å®ƒçš„ç‰¹æ€§ï¼š</p><ul><li>å½“ <span class="math inline">\(p_{correct}â†’1.0\)</span>ï¼ˆæ¨¡å‹é¢„æµ‹å¾ˆå‡†ï¼‰æ—¶ï¼Œ<span class="math inline">\(Loss=âˆ’log(1.0) â†’0\)</span> æŸå¤±éå¸¸å°ã€‚</li><li>å½“ <span class="math inline">\(p_{correct} â†’0\)</span>ï¼ˆæ¨¡å‹é¢„æµ‹ç¦»è°±ï¼‰æ—¶ï¼Œ<span class="math inline">\(Loss=âˆ’log(0) â†’infty\)</span> æŸå¤±ä¼šå˜å¾—éå¸¸å¤§ã€‚</li></ul><p>è¿™ä¸ªç‰¹æ€§æ£’æäº†ï¼å®ƒ<strong>æå¤§åœ°æƒ©ç½šäº†é‚£äº›ç¦»è°±çš„é”™è¯¯é¢„æµ‹</strong>ï¼Œä»è€Œåœ¨åå‘ä¼ æ’­æ—¶äº§ç”Ÿå·¨å¤§çš„æ¢¯åº¦ï¼Œè¿«ä½¿æ¨¡å‹å»ä¿®æ­£è¿™ä¸ªä¸¥é‡çš„é”™è¯¯ã€‚</p><p><code>cross_entropy</code> å‡½æ•°å°† <code>Softmax</code>å’Œ<strong>è´Ÿå¯¹æ•°ä¼¼ç„¶</strong>è¿™ä¸¤æ­¥åˆå¹¶åœ¨äº†ä¸€èµ·ï¼Œä¸ä»…æ–¹ä¾¿ä½¿ç”¨ï¼Œè€Œä¸”åœ¨æ•°å€¼è®¡ç®—ä¸Šæ›´åŠ ç¨³å®šã€‚</p><h4 id="ä¸ºä»€ä¹ˆèƒ½è¿™ä¹ˆç®—">3.2.1.3 ä¸ºä»€ä¹ˆèƒ½è¿™ä¹ˆç®—ï¼Ÿ</h4><p>ä»æ ¹æœ¬ä¸Šè¯´ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬å°†<strong>è¯­è¨€å»ºæ¨¡é—®é¢˜ï¼Œè½¬åŒ–ä¸ºäº†ä¸€ä¸ªåºåˆ—æ€§çš„å¤šåˆ†ç±»é—®é¢˜(Multi-Class Classification Problem)</strong>ã€‚</p><p>åœ¨åºåˆ—çš„æ¯ä¸€ä¸ªæ—¶é—´æ­¥ï¼Œæ¨¡å‹éƒ½åœ¨åšä¸€ä¸ªåˆ†ç±»ä»»åŠ¡ï¼šä»<code>vocab_size</code>ä¸ªå¯èƒ½çš„ç±»åˆ«ï¼ˆè¯å…ƒï¼‰ä¸­ï¼Œé€‰å‡ºæœ€æœ‰å¯èƒ½çš„é‚£ä¸€ä¸ªã€‚</p><p><strong>äº¤å‰ç†µ (Cross-Entropy)</strong>æºè‡ªä¿¡æ¯è®ºï¼Œæ˜¯è¡¡é‡ä¸¤ä¸ªæ¦‚ç‡åˆ†å¸ƒä¹‹é—´å·®å¼‚çš„æ ‡å‡†æ–¹æ³•ã€‚åœ¨è¿™é‡Œï¼Œè¿™ä¸¤ä¸ªåˆ†å¸ƒæ˜¯ï¼š</p><ol type="1"><li><strong>æ¨¡å‹çš„é¢„æµ‹åˆ†å¸ƒ</strong>ï¼šç»è¿‡ <code>Softmax</code>åçš„é‚£ä¸ªæ¦‚ç‡å‘é‡ã€‚</li><li><strong>çœŸå®çš„ç†æƒ³åˆ†å¸ƒ</strong>ï¼šä¸€ä¸ª <strong>one-hot</strong>å‘é‡ã€‚å³åœ¨æ­£ç¡®ç­”æ¡ˆçš„ç´¢å¼•ä½ç½®ä¸º 1ï¼Œå…¶ä»–æ‰€æœ‰ä½ç½®ä¸º 0 çš„å‘é‡ï¼ˆä¾‹å¦‚<code>[0, 1, 0, 0, 0]</code>ï¼‰ã€‚</li></ol><p>æœ€å°åŒ–äº¤å‰ç†µæŸå¤±ï¼Œå°±æ˜¯åœ¨<strong>è¿«ä½¿æ¨¡å‹çš„é¢„æµ‹åˆ†å¸ƒå»æ— é™é€¼è¿‘é‚£ä¸ªç†æƒ³çš„ã€å°–é”çš„çœŸå®åˆ†å¸ƒ</strong>ã€‚é€šè¿‡åœ¨æµ·é‡æ–‡æœ¬ä¸Šä¸æ–­åœ°åšè¿™ä»¶äº‹ï¼Œæ¨¡å‹å°±ä¸å¾—ä¸å»å­¦ä¹ è¯­è¨€çš„å†…åœ¨è§„å¾‹å’Œæ¨¡å¼ï¼Œä»¥ä¾¿åœ¨ä»»ä½•ç»™å®šçš„ä¸Šä¸‹æ–‡åï¼Œéƒ½èƒ½ç”Ÿæˆä¸€ä¸ªæœ€æ¥è¿‘çœŸå®ä¸–ç•Œçš„ä¸‹ä¸€ä¸ªè¯çš„æ¦‚ç‡åˆ†å¸ƒã€‚</p><p>æœ€åï¼Œä»£ç ä¸­çš„ <code>.flatten(0, 1)</code> æ“ä½œï¼Œæ˜¯å°†<code>(batch_size, context_length)</code>è¿™ä¸¤ä¸ªç»´åº¦å‹å¹³ã€‚è¿™ç›¸å½“äºå‘Šè¯‰æŸå¤±å‡½æ•°ï¼š"åˆ«æŠŠå®ƒä»¬çœ‹ä½œæ˜¯ä¸€æ‰¹å¥å­ï¼Œè¯·æŠŠè¿™æ‰¹æ•°æ®é‡Œ<strong>æ‰€æœ‰ä½ç½®çš„é¢„æµ‹ä»»åŠ¡ï¼Œéƒ½å½“ä½œæ˜¯ç‹¬ç«‹çš„åˆ†ç±»é—®é¢˜</strong>æ¥åŒç­‰å¯¹å¾…"ï¼Œä»è€Œé«˜æ•ˆåœ°ä¸€æ¬¡æ€§è®¡ç®—å‡ºæ•´ä¸ªæ‰¹æ¬¡çš„æ€»æŸå¤±ã€‚</p><blockquote><p>[!NOTE]</p><p>å¯¹äº¤å‰ç†µæŸå¤±æ¦‚å¿µä¾æ—§ä¸æ˜¯å¾ˆç†Ÿæ‚‰çš„è¯»è€…ï¼Œå¯ä»¥å‚è€ƒï¼š<ahref="https://hedon.top/2025/08/13/llm/cross-entropy-loss/">å¤§ç™½è¯è§£é‡Šäº¤å‰ç†µæŸå¤±</a></p></blockquote><h3 id="æ¨¡å‹è¯„ä¼°">3.2.2 æ¨¡å‹è¯„ä¼°</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">evaluate_model</span>(<span class="params">model, train_loader, val_loader, device, eval_iter</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è¯„ä¼°æ¨¡å‹æ€§èƒ½&quot;&quot;&quot;</span></span><br><span class="line">    model.<span class="built_in">eval</span>()</span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        train_loss = calc_loss_loader(train_loader, model, device, num_batches=eval_iter)</span><br><span class="line">        val_loss = calc_loss_loader(val_loader, model, device, num_batches=eval_iter)</span><br><span class="line">    model.train()</span><br><span class="line">    <span class="keyword">return</span> train_loss, val_loss</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calc_loss_loader</span>(<span class="params">data_loader, model, device, num_batches=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è®¡ç®—æ•°æ®åŠ è½½å™¨çš„å¹³å‡æŸå¤±&quot;&quot;&quot;</span></span><br><span class="line">    total_loss = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(data_loader) == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">float</span>(<span class="string">&quot;nan&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> num_batches <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        num_batches = <span class="built_in">len</span>(data_loader)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        num_batches = <span class="built_in">min</span>(num_batches, <span class="built_in">len</span>(data_loader))</span><br><span class="line">    <span class="keyword">for</span> i, (input_batch, target_batch) <span class="keyword">in</span> <span class="built_in">enumerate</span>(data_loader):</span><br><span class="line">        <span class="keyword">if</span> i &lt; num_batches:</span><br><span class="line">            loss = calc_loss_batch(input_batch, target_batch, model, device)</span><br><span class="line">            total_loss += loss.item()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> total_loss / num_batches</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç çš„ç»“æ„æ¸…æ™°åœ°ä½“ç°äº†è¯„ä¼°çš„æ ¸å¿ƒåŸåˆ™ï¼š</p><ol type="1"><li><strong>çŠ¶æ€åˆ‡æ¢ (<code>model.eval()</code> å’Œ<code>model.train()</code>)</strong>ï¼šè¿™æ˜¯è¯„ä¼°æµç¨‹çš„å¼€å…³ã€‚<code>model.eval()</code>ä¼šå…³é—­ <code>Dropout</code>ç­‰åªåœ¨è®­ç»ƒæ—¶ä½¿ç”¨çš„å±‚ï¼Œç¡®ä¿è¯„ä¼°ç»“æœçš„ç¨³å®šå’Œå¯å¤ç°ã€‚è¯„ä¼°ç»“æŸåï¼Œ<code>model.train()</code>ä¼šé‡æ–°æ‰“å¼€å®ƒä»¬ï¼Œè®©è®­ç»ƒç»§ç»­ã€‚</li><li><strong>éš”ç¦»ç¯å¢ƒ(<code>with torch.no_grad()</code>)</strong>ï¼šè¿™æ˜¯ä¸ºäº†ç¡®ä¿è¯„ä¼°çš„çº¯ç²¹æ€§ã€‚åœ¨è¿™ä¸ªä»£ç å—ä¸­ï¼ŒPyTorchä¸ä¼šè·Ÿè¸ªè®¡ç®—å›¾å’Œæ¢¯åº¦ã€‚è¿™ä¸ä»…èƒ½é˜²æ­¢ä»»ä½•æ„å¤–çš„å‚æ•°æ›´æ–°ï¼Œè¿˜èƒ½å¤§å¹…å‡å°‘å†…å­˜å ç”¨å’Œè®¡ç®—æ—¶é—´ï¼Œè®©è¯„ä¼°æ›´é«˜æ•ˆã€‚</li><li><strong>å§”æ‰˜è®¡ç®—(<code>calc_loss_loader</code>)</strong>ï¼š<code>evaluate_model</code>å°†å…·ä½“çš„è®¡ç®—ä»»åŠ¡å§”æ‰˜ç»™<code>calc_loss_loader</code>ã€‚è¿™ä¸ªå‡½æ•°æ˜¯ä¸€ä¸ªé€šç”¨çš„æŸå¤±è®¡ç®—å™¨ï¼Œå®ƒè¿­ä»£æŒ‡å®šæ•°é‡çš„æ‰¹æ¬¡ï¼Œè°ƒç”¨<code>calc_loss_batch</code>ç´¯åŠ æŸå¤±ï¼Œæœ€åè¿”å›å¹³å‡æŸå¤±ã€‚è¿™ç§åˆ†å±‚è®¾è®¡è®©ä»£ç æ›´æ•´æ´ã€‚</li><li><strong>åŒé‡æ£€éªŒ</strong>ï¼šåŒæ—¶è®¡ç®—<strong>è®­ç»ƒæŸå¤±</strong>å’Œ<strong>éªŒè¯æŸå¤±</strong>æ˜¯è‡³å…³é‡è¦çš„ã€‚<ul><li>è®­ç»ƒæŸå¤±æŒç»­ä¸‹é™ï¼Œè¯´æ˜æ¨¡å‹åœ¨åŠªåŠ›å­¦ä¹ ã€‚</li><li>éªŒè¯æŸå¤±ä¹Ÿéšä¹‹ä¸‹é™ï¼Œè¯´æ˜æ¨¡å‹å­¦åˆ°äº†æ™®é€‚çš„è§„å¾‹ï¼ˆæ³›åŒ–èƒ½åŠ›å¥½ï¼‰ã€‚</li><li>å¦‚æœè®­ç»ƒæŸå¤±ä¸‹é™ï¼Œä½†éªŒè¯æŸå¤±å¼€å§‹ä¸Šå‡ï¼Œè¿™å°±æ˜¯<strong>è¿‡æ‹Ÿåˆ</strong>çš„ä¿¡å·ï¼Œè¯´æ˜æ¨¡å‹å¼€å§‹"æ­»è®°ç¡¬èƒŒ"è®­ç»ƒé¢˜ï¼Œè€Œä¸æ˜¯çœŸæ­£ç†è§£ã€‚</li></ul></li></ol><h2 id="ä¿å­˜å’ŒåŠ è½½æ¨¡å‹">3.3 ä¿å­˜å’ŒåŠ è½½æ¨¡å‹</h2><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»è®¨è®ºäº†å¦‚ä½•ä»æ•°å€¼ä¸Šè¯„ä¼°è®­ç»ƒè¿›å±•ï¼Œå¹¶ä»å¤´å¼€å§‹é¢„è®­ç»ƒäº†ä¸€ä¸ªå¤§è¯­è¨€æ¨¡å‹ã€‚å°½ç®¡æ ·ä¾‹ä¸­ä½¿ç”¨çš„å¤§è¯­è¨€æ¨¡å‹å’Œæ•°æ®é›†éƒ½ç›¸å¯¹è¾ƒå°ï¼Œä½†è¿™è¶³ä»¥è¡¨æ˜é¢„è®­ç»ƒå¤§è¯­è¨€æ¨¡å‹ä»£ä»·é«˜æ˜‚ã€‚å› æ­¤ï¼Œä¿å­˜å¤§è¯­è¨€æ¨¡å‹çš„å‚æ•°éå¸¸é‡è¦ï¼Œè¿™æ ·å°±ä¸å¿…æ¯æ¬¡ä½¿ç”¨å®ƒæ—¶éƒ½é‡æ–°è¿è¡Œè®­ç»ƒã€‚</p><p>è¿™éƒ¨åˆ†å¾ˆç®€å•ï¼Œå¯ä»¥ç›´æ¥å‚è€ƒ <ahref="https://docs.pytorch.org/tutorials/beginner/saving_loading_models.html">PyTorch- Saving and Loading Models</a></p><ul><li><p>ä¿å­˜æ¨¡å‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dump_model_file = <span class="string">&quot;model_and_optimizer.pth&quot;</span></span><br><span class="line">torch.save(&#123;</span><br><span class="line">    <span class="string">&quot;model_state_dict&quot;</span>: model.state_dict(),</span><br><span class="line">    <span class="string">&quot;optimizer_state_dict&quot;</span>: optimizer.state_dict(),</span><br><span class="line">&#125;, dump_model_file)</span><br></pre></td></tr></table></figure></li><li><p>åŠ è½½æ¨¡å‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">checkpoint = torch.load(dump_model_file, map_location=device)</span><br><span class="line">model = GPTModel(GPT_CONFIG_124M)</span><br><span class="line">model.load_state_dict(checkpoint[<span class="string">&quot;model_state_dict&quot;</span>])</span><br><span class="line">optimizer = torch.optim.AdamW(</span><br><span class="line">    model.parameters(),</span><br><span class="line">    lr=<span class="number">5e-4</span>, weight_decay=<span class="number">0.1</span>,</span><br><span class="line">)</span><br><span class="line">optimizer.load_state_dict(checkpoint[<span class="string">&quot;optimizer_state_dict&quot;</span>])</span><br><span class="line">model.train()</span><br></pre></td></tr></table></figure></li></ul><p>æ—¢ç„¶æˆ‘ä»¬èƒ½åŠ è½½è‡ªå·±ä¹‹å‰è®­ç»ƒçš„æ¨¡å‹ï¼Œé‚£æ˜¯ä¸æ˜¯å¯ä»¥åŠ è½½åˆ«äººè®­ç»ƒçš„æ›´å¥½çš„æ¨¡å‹å‘¢ï¼Ÿå½“ç„¶ï¼å¹¸è¿çš„æ˜¯ï¼ŒOpenAIå…¬å¼€åˆ†äº«äº†å®ƒä»¬çš„ GPT-2æ¨¡å‹çš„æƒé‡ï¼Œä»è€Œçœå»äº†æˆ‘ä»¬è‡ªå·±åœ¨å¤§å‹è¯­æ–™åº“ä¸Šé‡æ–°è®­ç»ƒæ¨¡å‹æ‰€éœ€æŠ•å…¥çš„æ•°ä¸‡åˆ°æ•°åä¸‡ç¾å…ƒã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™äº›æƒé‡åŠ è½½åˆ°GPTModel ç±»ä¸­ï¼Œå¹¶ä½¿ç”¨è¯¥æ¨¡å‹è¿›è¡Œæ–‡æœ¬ç”Ÿæˆã€‚è¿™é‡Œï¼Œ æƒé‡æŒ‡çš„æ˜¯å­˜å‚¨åœ¨ PyTorchçš„ Linear å±‚å’Œ Embedding å±‚çš„ <code>.weight</code>å±æ€§ä¸­çš„æƒé‡å‚æ•°ã€‚å‰é¢åœ¨è®­ç»ƒæ¨¡å‹æ—¶ï¼Œæˆ‘ä»¬é€šè¿‡<code>model.parameters()</code> è®¿é—®è¿‡ã€‚</p><p>è¿™éƒ¨åˆ†ä¸åœ¨æœ¬ç¯‡çš„æ ¸å¿ƒè®¨è®ºç›®æ ‡ä¹‹ä¸­ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥å‚è€ƒï¼š<ahref="https://github.com/rasbt/LLMs-from-scratch/tree/main/ch05/01_main-chapter-code">LLMs-from-scratch-ch05</a>ã€‚</p><h1 id="æ–‡æœ¬ç”Ÿæˆ">4. æ–‡æœ¬ç”Ÿæˆ</h1><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250831135822616.png" style="zoom:33%;" /></p><p>ç»ˆäºæ¥åˆ°æˆ‘ä»¬æœ€åä¸€ä¸ªç¯èŠ‚äº†ï¼šæ–‡æœ¬ç”Ÿæˆï¼</p><p>å‰é¢æˆ‘ä»¬åœ¨ 2.6 ç« èŠ‚å·²ç»ä»‹ç»äº†ä½¿ç”¨ <code>generate_text_simple</code>è¿›è¡Œæœ€åŸºæœ¬çš„æ–‡æœ¬ç”Ÿæˆäº†ã€‚æœ¬ç¯‡æˆ‘ä»¬å°†ä»‹ç»ä¸€ä¸ªæ›´å…·å®é™…æ„ä¹‰çš„æ–‡æœ¬ç”Ÿæˆå‡½æ•°<code>generate</code>ï¼Œå®ƒæ˜¯ <code>generate_text_simple</code>ç»è¿‡ä¸¤ç§æŠ€æœ¯ï¼ˆæ¸©åº¦ç¼©æ”¾å’Œ Top-k é‡‡æ ·ï¼‰æ”¹è¿›è€Œæ¥çš„ã€‚</p><p>è¿˜æ˜¯å›åˆ°ç¬¬ä¸€æ€§åŸç†ä¸Šï¼Œ<strong><u>ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦é‡‡å–é¢å¤–çš„æŠ€æœ¯æ¥ä¼˜åŒ–æ–‡æœ¬ç”Ÿæˆï¼Ÿ</u></strong></p><p>è¦å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¿…é¡»ææ¸…æ¥š <code>generate_text_simple</code>ä¸­ä½¿ç”¨çš„æœ€åŸºæœ¬ç”Ÿæˆæ–¹æ³•â€”â€”<strong>è´ªå©ªè§£ç  (GreedyDecoding)</strong>â€”â€”çš„æ ¹æœ¬ç¼ºé™·æ˜¯ä»€ä¹ˆã€‚</p><p>åœ¨ <code>generate_text_simple</code> å‡½æ•°ä¸­ï¼Œæ ¸å¿ƒå†³ç­–æ­¥éª¤æ˜¯<code>idx_next = torch.argmax(probas, dim=-1, keepdim=True)</code>ã€‚è¿™è¡Œä»£ç çš„æ„æ€æ˜¯ï¼šåœ¨æ¨¡å‹é¢„æµ‹çš„æ‰€æœ‰è¯å…ƒçš„æ¦‚ç‡ä¸­ï¼Œæ°¸è¿œé€‰æ‹©é‚£ä¸ª<strong>æ¦‚ç‡æœ€é«˜</strong>çš„è¯å…ƒä½œä¸ºä¸‹ä¸€ä¸ªè¯ã€‚</p><p>è¿™ç§æ–¹æ³•è™½ç„¶ç®€å•ç›´æ¥ï¼Œä½†å­˜åœ¨ä¸‰ä¸ªè‡´å‘½çš„é—®é¢˜ï¼š</p><ol type="1"><li><strong>é‡å¤å’Œä¹å‘³</strong>ï¼šæ¨¡å‹å¾ˆå®¹æ˜“é™·å…¥é‡å¤çš„å¾ªç¯ä¸­ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ"the" æ˜¯æœ€å¸¸è§çš„ä¸‹ä¸€ä¸ªè¯ï¼Œæ¨¡å‹å¯èƒ½ä¼šä¸æ–­ç”Ÿæˆ "the thethe..."ã€‚å› ä¸ºå®ƒåªçœ‹çœ¼å‰æ¦‚ç‡æœ€é«˜çš„ä¸€æ­¥ï¼Œç¼ºä¹å…¨å±€è§†é‡ï¼Œå¯¼è‡´ç”Ÿæˆçš„æ–‡æœ¬éå¸¸å•è°ƒå’Œæœºæ¢°ã€‚</li><li><strong>ç¡®å®šæ€§å’Œå¯é¢„æµ‹æ€§</strong>ï¼šå¯¹äºåŒä¸€ä¸ªè¾“å…¥ï¼Œè´ªå©ªè§£ç çš„è¾“å‡ºæ°¸è¿œæ˜¯å®Œå…¨ç›¸åŒçš„ã€‚è¿™å¯¹äºéœ€è¦åˆ›é€ åŠ›å’Œå¤šæ ·æ€§çš„ä»»åŠ¡ï¼ˆå¦‚å†™æ•…äº‹ã€å›ç­”å¼€æ”¾æ€§é—®é¢˜ï¼‰æ¥è¯´æ˜¯ä¸å¯æ¥å—çš„ã€‚</li><li><strong>é”™å¤±æ›´ä¼˜è§£</strong>ï¼šæœ‰æ—¶ï¼Œæ¦‚ç‡ç¬¬äºŒæˆ–ç¬¬ä¸‰é«˜çš„è¯ï¼Œå¯èƒ½åœ¨é•¿è¿œæ¥çœ‹ä¼šå¼•å¯¼å‡ºä¸€ä¸ªæ›´é€šé¡ºã€æ›´æœ‰æ„ä¹‰çš„å¥å­ã€‚è´ªå©ªè§£ç è¿™ç§"çŸ­è§†"çš„ç­–ç•¥ï¼Œä¼šå› ä¸ºçœ¼å‰çš„"æœ€ä¼˜"é€‰æ‹©è€Œé”™å¤±å…¨å±€çš„"æ›´ä¼˜"è·¯å¾„ã€‚</li></ol><p><strong>æ ¹æœ¬é—®é¢˜åœ¨äºï¼Œè¯­è¨€æœ¬èº«ä¸æ˜¯ä¸€ä¸ªæ°¸è¿œé€‰æ‹©æœ€å¸¸è§å•è¯çš„ç¡®å®šæ€§è¿‡ç¨‹ï¼Œå®ƒå……æ»¡äº†å¤šæ ·æ€§å’Œä¸€å®šçš„éšæœºæ€§ã€‚</strong>æˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•ï¼Œæ—¢èƒ½è®©æ¨¡å‹ä¸»è¦é€‰æ‹©é‚£äº›é è°±çš„ã€æ¦‚ç‡é«˜çš„è¯ï¼Œåˆèƒ½å¼•å…¥é€‚åº¦çš„éšæœºæ€§ï¼Œè®©å®ƒå¶å°”èƒ½çµå…‰ä¸€é—ªï¼Œé€‰æ‹©ä¸€äº›ä¸é‚£ä¹ˆå¸¸è§ä½†åŒæ ·åˆç†çš„è¯ï¼Œä»è€Œç”Ÿæˆæ›´è‡ªç„¶ã€æ›´æœ‰è¶£çš„æ–‡æœ¬ã€‚</p><p><strong>æ¸©åº¦ç¼©æ”¾ (Temperature Scaling)</strong> å’Œ <strong>Top-k é‡‡æ ·(Top-k Sampling)</strong> å°±æ˜¯è§£å†³è¿™ä¸ªé—®é¢˜çš„ä¸¤ç§å¼ºå¤§æŠ€æœ¯ã€‚</p><h2 id="æ¸©åº¦ç¼©æ”¾">4.1 æ¸©åº¦ç¼©æ”¾</h2><p>æ¸©åº¦ç¼©æ”¾æ˜¯ä¸€ç§åœ¨ä» <code>logits</code>è®¡ç®—æœ€ç»ˆæ¦‚ç‡æ—¶ï¼Œè°ƒèŠ‚æ¨¡å‹"è‡ªä¿¡åº¦"çš„æŠ€æœ¯ã€‚</p><p>å®ƒçš„æ ¸å¿ƒå…¬å¼æ˜¯ï¼š</p><p><span class="math display">\[probabilities = Softmax(\frac{logits}{temperature})\]</span></p><blockquote><p>å› ä¸ºå…³é”®çš„ Softmax å‡½æ•°æ˜¯éçº¿æ€§çš„ï¼Œå®ƒä¼šå°† logitsè¢«æ¸©åº¦ç¼©æ”¾å<strong>å‡å°çš„å·®å€¼</strong>è½¬æ¢æˆæ›´<strong>å¹³ç¼“</strong>çš„æ¦‚ç‡åˆ†å¸ƒï¼Œæˆ–å°†<strong>æ”¾å¤§çš„å·®å€¼</strong>è½¬æ¢æˆæ›´<strong>å°–é”</strong>çš„æ¦‚ç‡åˆ†å¸ƒï¼Œæ‰€ä»¥æœ€ç»ˆç»“æœä¼šæ”¹å˜ã€‚</p></blockquote><ul><li><strong>å½“ <code>temperature</code> &gt; 1 (ä¾‹å¦‚1.5)</strong>ï¼š<code>logits</code>ä¼šè¢«ç¼©å°ï¼Œä½¿å¾—ä¸åŒè¯å…ƒä¹‹é—´çš„åˆ†æ•°å·®è·å˜å°ã€‚ç»è¿‡ <code>Softmax</code>åï¼Œæ¦‚ç‡åˆ†å¸ƒä¼šå˜å¾—æ›´<strong>å¹³ç¼“</strong>ã€‚è¿™æ„å‘³ç€ï¼Œæ¨¡å‹ä¼šé™ä½å¯¹é«˜æ¦‚ç‡è¯çš„æ‰§å¿µï¼ŒåŒæ—¶æå‡å¯¹ä½æ¦‚ç‡è¯çš„å…³æ³¨åº¦ï¼Œä»è€Œæœ‰æ›´å¤§çš„æœºä¼šé€‰æ‹©ä¸é‚£ä¹ˆå¸¸è§çš„è¯ã€‚è¿™ä¼šå¢åŠ ç”Ÿæˆæ–‡æœ¬çš„<strong>å¤šæ ·æ€§å’Œåˆ›é€ æ€§</strong>ï¼Œä½†è¿‡é«˜åˆ™å¯èƒ½å¯¼è‡´å†…å®¹ä¸è¿è´¯ã€‚</li><li><strong>å½“ <code>temperature</code> &lt; 1 (ä¾‹å¦‚0.7)</strong>ï¼š<code>logits</code>ä¼šè¢«æ”¾å¤§ï¼Œä½¿å¾—åˆ†æ•°å·®è·æ‹‰å¤§ã€‚<code>Softmax</code>åçš„æ¦‚ç‡åˆ†å¸ƒä¼šå˜å¾—æ›´<strong>é™¡å³­</strong>ã€‚æ¨¡å‹ä¼šæ›´åŠ ç¡®ä¿¡é‚£äº›å®ƒè®¤ä¸ºæ¦‚ç‡æœ€é«˜çš„è¯ï¼Œé™ä½é€‰æ‹©å…¶ä»–è¯çš„å¯èƒ½æ€§ã€‚è¿™ä½¿å¾—ç”Ÿæˆæ–‡æœ¬æ›´<strong>ç¨³å®šå’Œä¿å®ˆ</strong>ï¼Œæ›´è´´è¿‘è®­ç»ƒæ•°æ®çš„æ¨¡å¼ã€‚</li><li><strong>å½“ <code>temperature</code> è¶‹è¿‘äº0</strong>ï¼šè¿™ä¼šæç«¯åœ°æ”¾å¤§æœ€é«˜åˆ†æ•°çš„ <code>logit</code>ï¼Œä½¿å¾—<code>Softmax</code> çš„ç»“æœæ— é™æ¥è¿‘äº<code>argmax</code>ï¼Œæœ€ç»ˆæ•ˆæœç­‰åŒäºè´ªå©ªè§£ç ã€‚</li></ul><p>æ‰€ä»¥ä½ ç°åœ¨åº”è¯¥çŸ¥é“ ChatGPT æ¥å£ä¸­è¿™ä¸ªå‚æ•°çš„æ¥æºäº†å§ï¼</p><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250831141218682.png" /></p><h2 id="top-k-é‡‡æ ·">4.2 Top-k é‡‡æ ·</h2><p>å³ä¾¿æˆ‘ä»¬ç”¨æ¸©åº¦è°ƒèŠ‚äº†æƒ³è±¡åŠ›ï¼Œä»ç„¶å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šè¯æ±‡è¡¨éå¸¸å¤§ï¼Œæœ‰å¾ˆå¤šè¯å…ƒçš„æ¦‚ç‡è™½ç„¶ä¸ä¸ºé›¶ï¼Œä½†å®é™…ä¸Šæ˜¯å®Œå…¨ä¸åˆç†çš„ã€‚å¦‚æœåœ¨é‡‡æ ·æ—¶ä¸å¹¸é€‰ä¸­äº†å®ƒä»¬ï¼Œå°±ä¼šäº§ç”Ÿæ— æ„ä¹‰çš„æ–‡æœ¬ã€‚</p><p>Top-ké‡‡æ ·çš„æ€æƒ³éå¸¸ç›´è§‚ï¼š<strong>æˆ‘ä»¬åªåœ¨æœ€é è°±çš„ä¸€å°æ’®å€™é€‰è¯ä¸­è¿›è¡Œé‡‡æ ·ã€‚</strong></p><p>å®ƒçš„æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol type="1"><li><strong>ç­›é€‰</strong>ï¼šåœ¨æ¨¡å‹ç”Ÿæˆäº†æ‰€æœ‰è¯å…ƒçš„æ¦‚ç‡åˆ†å¸ƒåï¼Œæˆ‘ä»¬åªä¿ç•™å…¶ä¸­æ¦‚ç‡æœ€é«˜çš„<code>k</code> ä¸ªè¯å…ƒã€‚</li><li><strong>é‡æ–°åˆ†é…æ¦‚ç‡</strong>ï¼šå°†è¿™ <code>k</code>ä¸ªè¯å…ƒçš„æ¦‚ç‡è¿›è¡Œå½’ä¸€åŒ–ï¼Œä½¿å®ƒä»¬çš„æ¦‚ç‡ä¹‹å’Œä¸º 1ã€‚</li><li><strong>é‡‡æ ·</strong>ï¼šåœ¨è¿™ä¸ªå°å¾—å¤šçš„ã€ç”±é è°±å€™é€‰è¯ç»„æˆçš„é›†åˆä¸­ï¼Œæ ¹æ®æ–°çš„æ¦‚ç‡åˆ†å¸ƒè¿›è¡Œéšæœºé‡‡æ ·ã€‚</li></ol><p>ä¾‹å¦‚ï¼Œå¦‚æœè®¾ç½®<code>k=5</code>ï¼Œé‚£ä¹ˆæ¨¡å‹åœ¨å†³å®šä¸‹ä¸€ä¸ªè¯æ—¶ï¼Œåªä¼šä»å®ƒè®¤ä¸ºæœ€æœ‰å¯èƒ½çš„ 5ä¸ªè¯ä¸­è¿›è¡Œé€‰æ‹©ã€‚è¿™æå¤§åœ°<strong>é™ä½äº†ç”Ÿæˆç¦»è°±æˆ–ä¸ç›¸å…³è¯æ±‡çš„é£é™©</strong>ï¼ŒåŒæ—¶åˆé€šè¿‡åœ¨å°‘æ•°å‡ ä¸ªå¥½çš„é€‰é¡¹ä¸­è¿›è¡ŒéšæœºæŠ½æ ·ï¼Œä¿ç•™äº†æ–‡æœ¬çš„å¤šæ ·æ€§ã€‚å®ƒåœ¨æ¨¡å‹çš„"åˆ›é€ åŠ›"å’Œ"è¿è´¯æ€§"ä¹‹é—´å–å¾—äº†ç»ä½³çš„å¹³è¡¡ã€‚</p><p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œåœ¨ ChatGPT çš„ API ä¸­ï¼Œå¹¶æ²¡æœ‰æä¾› <code>top_k</code>è¿™ä¸ªå‚æ•°ï¼Œç›¸åçš„ï¼Œå®ƒæä¾›çš„æ˜¯ <code>top_p</code>ã€‚</p><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250831142404381.png" /></p><p><code>top_k</code> å’Œ <code>top_p</code>éƒ½æ˜¯ä¸ºäº†è§£å†³åŒæ ·çš„é—®é¢˜ï¼šå¦‚ä½•åœ¨ä¸€ä¸ªåˆç†çš„èŒƒå›´å†…è¿›è¡Œéšæœºé‡‡æ ·ï¼Œä»¥é¿å…æ¨¡å‹ç”Ÿæˆæ— æ„ä¹‰çš„è¯ã€‚ä½†å®ƒä»¬çš„å®ç°æ–¹å¼å†³å®šäº†å„è‡ªçš„ä¼˜åŠ£ã€‚</p><p><code>top_k</code> å¼ºåˆ¶æ¨¡å‹åªä»æ¦‚ç‡æœ€é«˜çš„ <code>k</code>ä¸ªè¯ä¸­é€‰æ‹©ã€‚é—®é¢˜åœ¨äºï¼Œè¿™ä¸ª <code>k</code>æ˜¯ä¸€ä¸ªå›ºå®šå€¼ï¼Œæ— æ³•é€‚åº”æ¨¡å‹åœ¨ä¸åŒæƒ…å†µä¸‹çš„è‡ªä¿¡åº¦ã€‚</p><ul><li><strong>å½“æ¨¡å‹éå¸¸ç¡®å®šæ—¶</strong>ï¼šæ¯”å¦‚åœ¨ "The capital of France is"ä¹‹åï¼Œæ¨¡å‹å¯¹ "Paris" çš„é¢„æµ‹æ¦‚ç‡å¯èƒ½é«˜è¾¾ 99%ã€‚æ­¤æ—¶å¦‚æœä½ çš„ <code>k</code>è®¾ç½®ä¸º 10ï¼Œä½ ä»ç„¶ä¼šæŠŠ 9 ä¸ªå‡ ä¹ä¸å¯èƒ½çš„é€‰é¡¹ï¼ˆæ¯”å¦‚ "London","Berlin"ï¼‰çº³å…¥é‡‡æ ·èŒƒå›´ï¼Œè¿™å¯èƒ½ä¼šå¼•å…¥ä¸å¿…è¦çš„å™ªå£°ã€‚</li><li><strong>å½“æ¨¡å‹éå¸¸ä¸ç¡®å®šæ—¶</strong>ï¼šæ¯”å¦‚åœ¨ä¸€ä¸ªå¼€æ”¾å¼åˆ›ä½œçš„å¼€å¤´"Once upon a time, there wasa"ï¼Œå¯èƒ½æœ‰éå¸¸å¤šåˆç†çš„è¯ï¼Œå®ƒä»¬çš„æ¦‚ç‡åˆ†å¸ƒå¯èƒ½éå¸¸å¹³ç¼“ï¼ˆä¾‹å¦‚ï¼Œå‰ 20ä¸ªè¯çš„æ¦‚ç‡éƒ½å·®ä¸å¤šï¼‰ã€‚æ­¤æ—¶å¦‚æœä½ çš„ <code>k</code> è®¾ç½®ä¸º5ï¼Œä½ å°±ä¼šæ­¦æ–­åœ°åˆ‡æ‰å¾ˆå¤šåŒæ ·åˆç†çš„é€‰é¡¹ï¼Œé™åˆ¶äº†æ¨¡å‹çš„åˆ›é€ åŠ›ã€‚</li></ul><p><code>top_p</code>ä¸é™åˆ¶å€™é€‰è¯çš„æ•°é‡ï¼Œè€Œæ˜¯é™åˆ¶å€™é€‰è¯çš„<strong>ç´¯ç§¯æ¦‚ç‡</strong>ã€‚ä¾‹å¦‚ï¼Œè®¾ç½®<code>top_p: 0.9</code>ï¼Œæ¨¡å‹ä¼šä»é«˜åˆ°ä½é€‰æ‹©è¯å…ƒï¼Œç›´åˆ°å®ƒä»¬çš„æ¦‚ç‡æ€»å’Œè¾¾åˆ°90%ï¼Œç„¶ååªåœ¨è¿™ä¸ªåŠ¨æ€ç”Ÿæˆçš„å€™é€‰é›†é‡Œè¿›è¡Œé‡‡æ ·ã€‚</p><ul><li><strong>åœ¨æ¨¡å‹éå¸¸ç¡®å®šçš„æƒ…å†µä¸‹</strong>ï¼š "Paris" çš„æ¦‚ç‡æ˜¯99%ï¼Œå·²ç»è¶…è¿‡äº† 90% çš„é˜ˆå€¼ã€‚å› æ­¤ï¼Œå€™é€‰é›†é‡Œ<strong>åªæœ‰ "Paris"ä¸€ä¸ªè¯</strong>ã€‚è¿™å®Œç¾åœ°ä¿ç•™äº†æ¨¡å‹çš„ç¡®å®šæ€§ã€‚</li><li><strong>åœ¨æ¨¡å‹éå¸¸ä¸ç¡®å®šçš„æƒ…å†µä¸‹</strong>ï¼šä¸ºäº†å‡‘å¤Ÿ 90%çš„æ¦‚ç‡ï¼Œå¯èƒ½éœ€è¦æŠŠ<strong>å‰ 20ä¸ªè¯</strong>éƒ½åŒ…å«è¿›æ¥ã€‚è¿™åŒæ ·å®Œç¾åœ°é€‚åº”äº†æ¨¡å‹çš„ä¸ç¡®å®šæ€§ï¼Œå…è®¸å®ƒåœ¨ä¸€ä¸ªæ›´å¹¿é˜”ã€æ›´å…·åˆ›é€ åŠ›çš„ç©ºé—´é‡Œè¿›è¡Œé€‰æ‹©ã€‚</li></ul><h2 id="ç»“åˆ">4.3 ç»“åˆ</h2><p>å°†ä¸Šè¿°ä¸¤ç§æŠ€æœ¯ç»“åˆèµ·æ¥ï¼Œå°±å¾—åˆ°äº†æˆ‘ä»¬æœ€ç»ˆå®ç°çš„æ–‡æœ¬ç”Ÿæˆå‡½æ•°<code>generate</code> äº†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">generate</span>(<span class="params">model, idx, max_new_tokens, context_length,</span></span><br><span class="line"><span class="params">        temperature=<span class="number">0.0</span>, top_k=<span class="literal">None</span>, eos_id=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å¸¦æ¸©åº¦ç¼©æ”¾ã€top_k ç­›é€‰çš„æ–‡æœ¬ç”Ÿæˆç­–ç•¥&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(max_new_tokens):</span><br><span class="line">        idx_cond = idx[:, -context_length:]</span><br><span class="line">        <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">            logits = model(idx_cond)</span><br><span class="line">        logits = logits[:, -<span class="number">1</span>, :]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ä½¿ç”¨ top_k é‡‡æ ·ç­›é€‰ logits</span></span><br><span class="line">        <span class="keyword">if</span> top_k <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            top_logits, _ = torch.topk(logits, top_k)</span><br><span class="line">            min_val = top_logits[:, -<span class="number">1</span>]</span><br><span class="line">            logits = torch.where(</span><br><span class="line">                logits &lt; min_val,</span><br><span class="line">                torch.tensor(<span class="built_in">float</span>(<span class="string">&#x27;-inf&#x27;</span>)).to(logits.device),</span><br><span class="line">                logits,</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> temperature &gt; <span class="number">0.0</span>:</span><br><span class="line">            <span class="comment"># ä½¿ç”¨æ¸©åº¦ç¼©æ”¾</span></span><br><span class="line">            logits = logits / temperature</span><br><span class="line">            probs = torch.softmax(logits, dim=-<span class="number">1</span>)</span><br><span class="line">            idx_next = torch.multinomial(probs, num_samples=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># å½“ä¸ä½¿ç”¨æ¸©åº¦ç¼©æ”¾æ—¶ï¼Œæ‰§è¡Œè´ªå¿ƒè§£ç ï¼Œé€‰å–ä¸‹ä¸€ä¸ªè¯å…ƒ</span></span><br><span class="line">            idx_next = torch.argmax(logits, dim=-<span class="number">1</span>, keepdim=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å¦‚æœé‡åˆ°åºåˆ—ç»“æŸè¯å…ƒï¼Œåˆ™æå‰åœæ­¢ç”Ÿæˆ</span></span><br><span class="line">        <span class="keyword">if</span> idx_next == eos_id:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        idx = torch.cat((idx, idx_next), dim=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> idx</span><br></pre></td></tr></table></figure><h2 id="å…¶ä»–æ€è·¯">4.4 å…¶ä»–æ€è·¯</h2><p>é™¤äº†å¸¸è§çš„æ¸©åº¦é‡‡æ ·å’Œ top-k/top-pé‡‡æ ·ï¼Œè¿˜æœ‰å¤šç§æŠ€æœ¯å¯ä»¥ç”¨æ¥æ§åˆ¶æ¨¡å‹çš„æ–‡æœ¬ç”Ÿæˆç­–ç•¥ï¼Œæ¯ç§æŠ€æœ¯éƒ½æœ‰å…¶ç‹¬ç‰¹çš„ä¼˜ç¼ºç‚¹å’Œé€‚ç”¨åœºæ™¯ã€‚</p><p><strong>1. Beam Search (é›†æŸæœç´¢)</strong></p><p>è¿™æ˜¯ä¸€ç§åŸºäºæœç´¢çš„å¯å‘å¼ç®—æ³•ï¼Œæ—¨åœ¨æ‰¾åˆ°ä¸€ä¸ªæ•´ä½“æ¦‚ç‡æœ€é«˜çš„åºåˆ—ï¼Œè€Œä¸æ˜¯ä»…ä»…å…³æ³¨æ¯ä¸€æ­¥çš„æœ€ä¼˜é€‰æ‹©ã€‚</p><ul><li><strong>å·¥ä½œåŸç†</strong>ï¼šåœ¨ç”Ÿæˆçš„æ¯ä¸€æ­¥ï¼Œå®ƒä¼šä¿ç•™ <code>k</code>ä¸ªï¼ˆ<code>k</code> åœ¨è¿™é‡Œè¢«ç§°ä¸ºé›†æŸå®½åº¦æˆ– beamwidthï¼‰æœ€å¯èƒ½çš„å€™é€‰åºåˆ—ã€‚åœ¨ä¸‹ä¸€æ­¥ï¼Œå®ƒä¼šä»è¿™ <code>k</code>ä¸ªåºåˆ—å‡ºå‘ï¼Œç”Ÿæˆæ‰€æœ‰å¯èƒ½çš„ä¸‹ä¸€ä¸ªè¯ï¼Œå¹¶è®¡ç®—æ–°åºåˆ—çš„æ€»æ¦‚ç‡ï¼Œç„¶åå†æ¬¡åªä¿ç•™æ€»æ¦‚ç‡æœ€é«˜çš„<code>k</code> ä¸ªåºåˆ—ã€‚è¿™ä¸ªè¿‡ç¨‹ä¼šä¸€ç›´æŒç»­åˆ°ç”Ÿæˆç»“æŸã€‚</li><li><strong>ä¼˜åŠ¿</strong>ï¼šé€šè¿‡æ¢ç´¢å¤šç§å¯èƒ½æ€§ï¼Œå®ƒé€šå¸¸èƒ½ç”Ÿæˆæ¯”è´ªå©ªæœç´¢ï¼ˆGreedySearchï¼Œå³æ¯æ­¥éƒ½é€‰æ¦‚ç‡æœ€é«˜çš„è¯ï¼‰æ›´æµç•…ã€æ›´å…¨å±€æœ€ä¼˜çš„åºåˆ—ã€‚</li><li><strong>åŠ£åŠ¿</strong>ï¼šå®ƒå€¾å‘äºç”Ÿæˆé«˜é¢‘ã€å®‰å…¨çš„æ–‡æœ¬ï¼Œå¯èƒ½ä¼šç¼ºä¹å¤šæ ·æ€§å’Œåˆ›é€ æ€§ã€‚åŒæ—¶ï¼Œè®¡ç®—å¼€é”€æ¯”ç®€å•çš„é‡‡æ ·æ–¹æ³•è¦å¤§ã€‚</li></ul><p><strong>2. Contrastive Search (å¯¹æ¯”æœç´¢)</strong></p><p>è¿™æ˜¯ä¸€ç§è¾ƒæ–°çš„è§£ç æ–¹æ³•ï¼Œæ—¨åœ¨é€šè¿‡ç»“åˆæ¨¡å‹çš„æ¦‚ç‡å’Œè¯å…ƒé—´çš„ç›¸ä¼¼æ€§æ¥æå‡ç”Ÿæˆæ–‡æœ¬çš„è¿è´¯æ€§å’Œå¤šæ ·æ€§ï¼Œæœ‰æ•ˆå‡å°‘é‡å¤ã€‚</p><ul><li><strong>å·¥ä½œåŸç†</strong>ï¼šåœ¨æ¯ä¸€æ­¥é€‰æ‹©ä¸‹ä¸€ä¸ªè¯å…ƒæ—¶ï¼Œå®ƒä¼šåŒæ—¶è€ƒè™‘ä¸¤ä¸ªå› ç´ ï¼š<ol type="1"><li><strong>æ¨¡å‹ç½®ä¿¡åº¦</strong>ï¼šä¸‹ä¸€ä¸ªè¯å…ƒçš„æ¦‚ç‡è¦é«˜ã€‚</li><li><strong>å¤šæ ·æ€§/æƒ©ç½š</strong>ï¼šä¸‹ä¸€ä¸ªè¯å…ƒä¸åº”è¯¥å’Œå‰æ–‡å·²ç»ç”Ÿæˆçš„è¯å…ƒè¿‡äºç›¸ä¼¼ã€‚å®ƒé€šè¿‡è®¡ç®—å€™é€‰è¯å…ƒä¸ä¸Šæ–‡çš„ç›¸ä¼¼æ€§å¾—åˆ†ï¼Œå¹¶ä»æ¨¡å‹æ¦‚ç‡ä¸­å‡å»è¿™ä¸ªç›¸ä¼¼æ€§å¾—åˆ†ä½œä¸ºæƒ©ç½šé¡¹ã€‚</li></ol></li><li><strong>ä¼˜åŠ¿</strong>ï¼šåœ¨è®¸å¤šè¯„æµ‹ä¸­ï¼Œå¯¹æ¯”æœç´¢è¢«è¯æ˜å¯ä»¥åœ¨ä¸éœ€è¦å¯¹æ¨¡å‹è¿›è¡Œä»»ä½•é¢å¤–è®­ç»ƒçš„æƒ…å†µä¸‹ï¼Œæ˜¾è‘—ä¼˜äºä¼ ç»Ÿçš„è§£ç æ–¹æ³•ï¼Œå°¤å…¶åœ¨å‡å°‘æ–‡æœ¬é‡å¤å’Œæå‡è¿è´¯æ€§æ–¹é¢è¡¨ç°çªå‡ºã€‚</li></ul><p><strong>3. Mirostat é‡‡æ ·</strong></p><p>è¿™æ˜¯ä¸€ç§è‡ªé€‚åº”çš„é‡‡æ ·ç®—æ³•ï¼Œå®ƒçš„ç›®æ ‡æ˜¯è®©ç”Ÿæˆæ–‡æœ¬çš„"æƒŠå¥‡åº¦"ï¼ˆPerplexityï¼Œä¸€ç§è¡¡é‡ä¸ç¡®å®šæ€§çš„æŒ‡æ ‡ï¼‰ç»´æŒåœ¨ä¸€ä¸ªé¢„è®¾çš„ç›®æ ‡å€¼é™„è¿‘ã€‚</p><ul><li><strong>å·¥ä½œåŸç†</strong>ï¼šMirostatä¼šåœ¨ç”Ÿæˆè¿‡ç¨‹ä¸­æŒç»­ç›‘æ§è¾“å‡ºæ–‡æœ¬çš„å›°æƒ‘åº¦ï¼ˆPerplexityï¼‰ã€‚å¦‚æœå½“å‰æ–‡æœ¬çš„å›°æƒ‘åº¦ä½äºç›®æ ‡å€¼ï¼ˆæ„å‘³ç€æ–‡æœ¬è¿‡äºå¹³æ·¡ã€å¯é¢„æµ‹ï¼‰ï¼Œç®—æ³•å°±ä¼šåŠ¨æ€è°ƒæ•´é‡‡æ ·ç­–ç•¥ï¼ˆå¦‚è°ƒæ•´<code>top-k</code> çš„ <code>k</code>å€¼ï¼‰æ¥å¢åŠ éšæœºæ€§ã€‚åä¹‹ï¼Œå¦‚æœå›°æƒ‘åº¦å¤ªé«˜ï¼ˆæ–‡æœ¬å¯èƒ½ä¸è¿è´¯ï¼‰ï¼Œå®ƒå°±ä¼šé™ä½éšæœºæ€§ã€‚</li><li><strong>ä¼˜åŠ¿</strong>ï¼šå®ƒé€šè¿‡ä¸€ä¸ªåé¦ˆå¾ªç¯æ¥ç›´æ¥æ§åˆ¶ç”Ÿæˆæ–‡æœ¬çš„ç»Ÿè®¡ç‰¹æ€§ï¼Œå¯ä»¥æœ‰æ•ˆé¿å…é™·å…¥æ— èŠé™·é˜±ï¼ˆè¿‡åº¦é‡å¤ï¼‰å’Œå›°æƒ‘é™·é˜±ï¼ˆå†…å®¹ä¸è¿è´¯ï¼‰ã€‚</li></ul><p><strong>æ€»ç»“</strong></p><table style="width:100%;"><colgroup><col style="width: 15%" /><col style="width: 31%" /><col style="width: 30%" /><col style="width: 22%" /></colgroup><thead><tr><th>è§£ç ç­–ç•¥</th><th>æ ¸å¿ƒæ€æƒ³</th><th>ä¼˜ç‚¹</th><th>ç¼ºç‚¹</th></tr></thead><tbody><tr><td><strong>Beam Search</strong></td><td>ä¿ç•™ <code>k</code> ä¸ªæœ€å¯èƒ½çš„åºåˆ—ï¼Œè¿½æ±‚å…¨å±€æœ€ä¼˜ã€‚</td><td>è¿è´¯æ€§å¥½ï¼Œé€‚åˆç¿»è¯‘ã€æ‘˜è¦ç­‰ä»»åŠ¡ã€‚</td><td>å¤šæ ·æ€§å·®ï¼Œè®¡ç®—æˆæœ¬è¾ƒé«˜ã€‚</td></tr><tr><td><strong>Contrastive Search</strong></td><td>ç»“åˆæ¨¡å‹æ¦‚ç‡å’Œä¸ä¸Šæ–‡çš„ç›¸å¼‚åº¦æ¥é€‰æ‹©ã€‚</td><td>æ˜¾è‘—å‡å°‘é‡å¤ï¼Œæå‡è¿è´¯æ€§ã€‚</td><td>ç®—æ³•ç›¸å¯¹å¤æ‚ã€‚</td></tr><tr><td><strong>Mirostat</strong></td><td>åŠ¨æ€è°ƒæ•´é‡‡æ ·ï¼Œä½¿æ–‡æœ¬çš„å›°æƒ‘åº¦ç»´æŒåœ¨ç›®æ ‡æ°´å¹³ã€‚</td><td>ç›´æ¥æ§åˆ¶æ–‡æœ¬çš„ç»Ÿè®¡ç‰¹æ€§ï¼Œé¿å…é‡å¤å’Œä¸è¿è´¯ã€‚</td><td>éœ€è¦è®¾å®šä¸€ä¸ªåˆé€‚çš„ç›®æ ‡å›°æƒ‘åº¦å€¼ã€‚</td></tr></tbody></table><h1 id="æ€»ç»“">æ€»ç»“</h1><p>è‡³æ­¤ï¼Œæˆ‘ä»¬ 500è¡Œä»£ç çš„æ—…ç¨‹ä¹Ÿæ¥è¿‘äº†å°¾å£°ã€‚æœ¬æ–‡å®Œæ•´è®°å½•äº†ä»é›¶å¼€å§‹æ„å»ºä¸€ä¸ª GPTé£æ ¼è¯­è¨€æ¨¡å‹çš„å…¨è¿‡ç¨‹ï¼Œæ—¨åœ¨å°†ä¸€ä¸ªå¤æ‚çš„ç³»ç»Ÿæ‹†è§£ä¸ºä¸€ç³»åˆ—æ¸…æ™°ã€å¯æ‰§è¡Œçš„æ­¥éª¤ã€‚</p><p>é¦–å…ˆï¼Œä»æ•°æ®å¤„ç†å…¥æ‰‹ï¼Œé˜è¿°äº†å¦‚ä½•å°†åŸå§‹æ–‡æœ¬è¯­æ–™é€šè¿‡è¯å…ƒåŒ–ã€æ»‘åŠ¨çª—å£é‡‡æ ·ç­‰æ–¹æ³•ï¼Œæ„å»ºæˆæ¨¡å‹è®­ç»ƒæ‰€éœ€çš„ã€åŒ…å«è¾“å…¥-ç›®æ ‡å¯¹çš„æ‰¹é‡åŒ–å¼ é‡ï¼ˆbatchedtensorsï¼‰ã€‚</p><p>æ¥ç€ï¼Œæ·±å…¥å‰–æäº† <strong>Transformeræ¨¡å‹çš„æ ¸å¿ƒæ¶æ„</strong>ã€‚ä»è¾“å…¥å±‚çš„è¯å…ƒä¸ä½ç½®åµŒå…¥ï¼Œåˆ°ä½œä¸ºæ ¸å¿ƒå¤„ç†å•å…ƒçš„TransformerBlockå †å ã€‚åœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œè¯¦ç»†è§£é‡Šäº†å¤šå¤´å› æœè‡ªæ³¨æ„åŠ›æœºåˆ¶ã€å‰é¦ˆç½‘ç»œã€å±‚å½’ä¸€åŒ–å’Œæ®‹å·®è¿æ¥ç­‰å…³é”®ç»„ä»¶çš„åŸç†ä¸ä½œç”¨ï¼Œå±•ç¤ºäº†å®ƒä»¬å¦‚ä½•ååŒå·¥ä½œä»¥èåˆä¸Šä¸‹æ–‡ä¿¡æ¯å¹¶ç¨³å®šæ·±åº¦ç½‘ç»œçš„è®­ç»ƒã€‚</p><p>åœ¨æ¨¡å‹ç»“æ„ä¹‹åï¼Œæ–‡ç« ä»‹ç»äº†å®Œæ•´çš„<strong>è®­ç»ƒå¾ªç¯</strong>ã€‚è¿™åŒ…æ‹¬å‰å‘ä¼ æ’­ã€äº¤å‰ç†µæŸå¤±è®¡ç®—ã€åå‘ä¼ æ’­å’Œä¼˜åŒ–å™¨æ›´æ–°å‚æ•°çš„å®Œæ•´æµç¨‹ï¼Œå¹¶å±•ç¤ºäº†å¦‚ä½•é€šè¿‡éªŒè¯é›†ç›‘æ§è®­ç»ƒçŠ¶æ€ï¼Œä»¥è¯„ä¼°æ¨¡å‹çš„å­¦ä¹ æ•ˆæœå’Œæ³›åŒ–èƒ½åŠ›ã€‚</p><p>æœ€åï¼Œæ–‡ç« æ¢è®¨äº†<strong>æ–‡æœ¬ç”Ÿæˆé˜¶æ®µçš„è§£ç ç­–ç•¥</strong>ï¼Œåˆ†æäº†ä»åŸºç¡€çš„è´ªå©ªè§£ç åˆ°æ›´é«˜çº§çš„æ¸©åº¦é‡‡æ ·ã€Top-kå’Œ Top-pç­‰æ–¹æ³•çš„åŸç†ï¼Œä»¥åŠå®ƒä»¬å¦‚ä½•è¢«ç”¨äºæ§åˆ¶ç”Ÿæˆæ–‡æœ¬çš„å¤šæ ·æ€§ä¸è¿è´¯æ€§ã€‚</p><p>æœ¬æ–‡çš„æ ¸å¿ƒä¸»çº¿æ˜¯å±•ç¤ºä¸€ä¸ªå¤æ‚çš„å¤§è¯­è¨€æ¨¡å‹ç³»ç»Ÿï¼Œå®é™…ä¸Šå¯ä»¥è¢«æ‹†è§£ä¸ºä¸€ç³»åˆ—ç›®æ ‡æ˜ç¡®ã€é€»è¾‘æ¸…æ™°çš„å­é—®é¢˜å’Œå¯¹åº”çš„å·¥ç¨‹å®ç°ã€‚é€šè¿‡é€ä¸€è§£å†³ä»æ•°æ®è¡¨ç¤ºã€ä¸Šä¸‹æ–‡èåˆã€æ·±åº¦ç½‘ç»œè®­ç»ƒç¨³å®šæ€§åˆ°é«˜è´¨é‡æ–‡æœ¬ç”Ÿæˆç­‰ä¸€ç³»åˆ—æŒ‘æˆ˜ï¼Œæˆ‘ä»¬æœ€ç»ˆå°†è¿™äº›ç‹¬ç«‹çš„æ¨¡å—åŒ–è§£å†³æ–¹æ¡ˆç»„åˆæˆä¸€ä¸ªåŠŸèƒ½å®Œå¤‡çš„ç³»ç»Ÿã€‚</p><p>é€šè¿‡è¿™ç§ä»é›¶å¼€å§‹çš„æ„å»ºè¿‡ç¨‹ï¼Œæˆ‘ä»¬ä¸ä»…èƒ½ç†è§£å„ä¸ªæŠ€æœ¯ç‚¹çš„ä½œç”¨ï¼Œæ›´èƒ½æŠŠæ¡å®ƒä»¬ä¹‹é—´å¦‚ä½•ç›¸äº’å…³è”ã€ååŒå·¥ä½œï¼Œä»è€Œå¯¹æ•´ä¸ªå¤§è¯­è¨€æ¨¡å‹çš„å·¥ä½œåŸç†å½¢æˆä¸€ä¸ªç»“æ„åŒ–ã€ç³»ç»Ÿæ€§çš„è®¤çŸ¥ã€‚å¸Œæœ›æœ¬æ–‡çš„æ‹†è§£ä¸å®ç°ï¼Œèƒ½ä¸ºæ¯ä¸€ä½å¯¹å¤§æ¨¡å‹å†…éƒ¨å·¥ä½œåŸç†æ„Ÿåˆ°å¥½å¥‡ã€å¹¶å¸Œæœ›ä»å®è·µä¸­æ„å»ºä½“ç³»åŒ–è®¤çŸ¥çš„å¼€å‘è€…ï¼Œæä¾›ä¸€æ¡æ¸…æ™°å¯å¾ªçš„è·¯å¾„å’Œåˆ‡å®çš„å¸®åŠ©ã€‚</p>]]></content>
    
    
    <summary type="html">é€šè¿‡ 500 è¡Œä»£ç å®ç°ï¼Œæ·±å…¥è§£æä»é›¶æ„å»º GPT é£æ ¼å¤§è¯­è¨€æ¨¡å‹çš„å®Œæ•´æµç¨‹ï¼šä»æ•°æ®å¤„ç†ã€Transformer æ¶æ„æ ¸å¿ƒã€è®­ç»ƒå¾ªç¯åˆ°æ–‡æœ¬ç”Ÿæˆç­–ç•¥ï¼Œå¸¦ä½ ç†è§£å¤§æ¨¡å‹èƒŒåçš„å·¥ç¨‹å®ç°åŸç†ã€‚</summary>
    
    
    
    <category term="è¯»ä¹¦ç¬”è®°" scheme="https://hedon.top/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="è¯»ä¹¦ç¬”è®°" scheme="https://hedon.top/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
    <category term="å¤§æ¨¡å‹" scheme="https://hedon.top/tags/%E5%A4%A7%E6%A8%A1%E5%9E%8B/"/>
    
  </entry>
  
  <entry>
    <title>ä¼˜é›…é‡å¯çš„èŒƒå¼è½¬ç§»ï¼šä» tableflip åˆ° Kubernetes çš„ Go æœåŠ¡å‡çº§ç»ˆææŒ‡å—</title>
    <link href="https://hedon.top/2025/08/30/graceful-restart-from-tableflip-to-k8s/"/>
    <id>https://hedon.top/2025/08/30/graceful-restart-from-tableflip-to-k8s/</id>
    <published>2025-08-30T02:31:45.000Z</published>
    <updated>2025-08-30T03:09:35.124Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å‰è¨€åŒä¸€ä¸ªç›®æ ‡ä¸¤ä¸ªä¸–ç•Œ">å‰è¨€ï¼šåŒä¸€ä¸ªç›®æ ‡ï¼Œä¸¤ä¸ªä¸–ç•Œ</h3><p>åœ¨è½¯ä»¶å¼€å‘çš„ä¸–ç•Œé‡Œï¼Œå®ç°æœåŠ¡çš„"é›¶åœæœºæ›´æ–°"æ˜¯ä¸€ä¸ªæ°¸æ’çš„è¿½æ±‚ã€‚å®ƒæ„å‘³ç€æˆ‘ä»¬çš„æœåŠ¡å¯ä»¥åœ¨å‘å¸ƒæ–°ç‰ˆæœ¬ã€ä¿®å¤Bugç”šè‡³å˜æ›´é…ç½®æ—¶ï¼Œä¾ç„¶å¯¹ç”¨æˆ·ä¿æŒè¿ç»­å¯ç”¨ï¼Œè¿™æ˜¯è¡¡é‡ä¸€ä¸ªç³»ç»Ÿæˆç†Ÿä¸å¦çš„å…³é”®æŒ‡æ ‡ã€‚</p><p>åœ¨ Go çš„ç”Ÿæ€ä¸­ï¼Œ<code>tableflip</code>åº“ä»¥å…¶ç²¾å·§ç»ä¼¦çš„è®¾è®¡ï¼Œä¸ºæˆ‘ä»¬å±•ç¤ºäº†ä¸€ç§åœ¨å•æœºæ—¶ä»£å®ç°ä¼˜é›…é‡å¯çš„"é­”æ³•"ã€‚å®ƒé€šè¿‡<code>fork/exec</code>å’Œæ–‡ä»¶æè¿°ç¬¦ä¼ é€’ï¼Œå®ç°äº†è¿›ç¨‹çº§çš„æ— ç¼äº¤æ¥ï¼Œä»¤äººæ‹æ¡ˆå«ç»ã€‚</p><p>ç„¶è€Œï¼Œå½“æˆ‘ä»¬è¸å…¥ Kubernetesæ‰€å¼•é¢†çš„äº‘åŸç”Ÿæ—¶ä»£ï¼Œä¼šæƒŠå¥‡åœ°å‘ç°ï¼Œè¿™ä¸ªæ›¾ç»çš„å± é¾™ä¹‹æŠ€ä¼¼ä¹å˜å¾—æ°´åœŸä¸æœï¼Œç”šè‡³è¢«è§†ä¸ºä¸€ç§åæ¨¡å¼(anti-pattern)ã€‚ä¸ºä»€ä¹ˆä¸€ä¸ªå¦‚æ­¤ä¼˜é›…çš„æ–¹æ¡ˆï¼Œä¼šåœ¨æ–°çš„ç¯å¢ƒä¸­å¤±æ•ˆï¼Ÿ</p><p>æœ¬æ–‡å°†å¸¦æ‚¨è¸ä¸Šè¿™æ®µä¼˜é›…é‡å¯çš„èŒƒå¼è½¬ç§»ä¹‹æ—…ã€‚æˆ‘ä»¬å°†ä»<code>tableflip</code>çš„ç¬¬ä¸€æ€§åŸç†å‡ºå‘ï¼Œæ·±å…¥å‰–æå…¶å·¥ä½œæœºåˆ¶ï¼›ç„¶åï¼Œæˆ‘ä»¬å°†åˆ‡æ¢è§†è§’ï¼Œå®¡è§†Kubernetes æ˜¯å¦‚ä½•ä»¥ä¸€ç§æˆªç„¶ä¸åŒçš„å“²å­¦æ¥å®šä¹‰å’Œå®ç°ä¼˜é›…ï¼›æœ€åï¼Œæˆ‘ä»¬å°†æ·±å…¥Kuberneteså®è·µçš„æ¯ä¸€ä¸ªç»†èŠ‚ï¼Œä»æ¢é’ˆã€ç«æ€æ¡ä»¶åˆ°æœ‰çŠ¶æ€æœåŠ¡å’Œå¤šæœåŠ¡è¿›ç¨‹ï¼Œä¸ºæ‚¨åœ¨äº‘åŸç”Ÿä¸–ç•Œä¸­æ„å»ºé«˜å¯ç”¨Go åº”ç”¨ï¼Œæä¾›ä¸€ä»½æ¸…æ™°ã€è¯¦å°½çš„ç»ˆææŒ‡å—ã€‚</p><h3 id="æ—§ä¸–ç•Œçš„è‰ºæœ¯å“-tableflip-çš„é­”æ³•">1. æ—§ä¸–ç•Œçš„è‰ºæœ¯å“ â€”â€”<code>tableflip</code> çš„é­”æ³•</h3><p><code>tableflip</code>çš„æ ¸å¿ƒæ€æƒ³ï¼Œæ˜¯åœ¨ä¸€ä¸ªç¨³å®šçš„ã€é•¿ç”Ÿå‘½å‘¨æœŸçš„ç¯å¢ƒï¼ˆå¦‚ä¸€å°è™šæ‹Ÿæœºæˆ–ç‰©ç†æœºï¼‰ä¸­ï¼Œç”¨ä¸€ä¸ªæ–°çš„è¿›ç¨‹å®ä¾‹ï¼Œ<strong>åŸåœ°ã€æ— ç¼åœ°æ›¿æ¢</strong>æ‰ä¸€ä¸ªæ—§çš„è¿›ç¨‹å®ä¾‹ï¼Œè€Œå¯¹å¤–æœåŠ¡çš„ç«¯å£å§‹ç»ˆä¿æŒç›‘å¬ã€‚</p><p>å®ƒçš„é­”æ³•æºäºä¸€ä¸ªç»å…¸çš„ Unix/Linuxç³»ç»Ÿç‰¹æ€§ï¼šçˆ¶è¿›ç¨‹å¯ä»¥å°†å…¶æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆFile Descriptors,FDï¼‰ä¼ é€’ç»™å­è¿›ç¨‹ã€‚å¯¹äºä¸€ä¸ªç½‘ç»œæœåŠ¡è€Œè¨€ï¼Œæœ€é‡è¦çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå°±æ˜¯é‚£ä¸ªç›‘å¬ç½‘ç»œç«¯å£çš„<code>socket FD</code>ã€‚</p><p><code>tableflip</code> çš„å·¥ä½œæµç¨‹ï¼Œå¯ä»¥é€šè¿‡ä¸‹å›¾æ¸…æ™°åœ°å±•ç¤ºï¼š</p><pre class="mermaid">graph TD    %% Define Node Shapes    classDef state fill:#d4f0f0,stroke:#333,stroke-width:2px;    classDef action fill:#fff2cc,stroke:#333,stroke-width:2px;    classDef process fill:#f8cecc,stroke:#b85450,stroke-width:2px;    classDef traffic fill:#dae8fc,stroke:#6c8ebf,stroke-width:2px;    %% Initial State    A["æœåŠ¡è¿è¡Œä¸­ (v1)<br/>çˆ¶è¿›ç¨‹ accept() æ‰€æœ‰è¿æ¥"]:::state;    B{"æ”¶åˆ° SIGUSR2 æ›´æ–°ä¿¡å·"}:::action;    %% Core Actions    C{"fork/exec åˆ›å»ºå­è¿›ç¨‹ (v2)"}:::action;    D{"é€šè¿‡ UDS ä¼ é€’ Socket FD"}:::action;    %% State Split - The core of the graceful restart    E["<b>å­è¿›ç¨‹ (v2) è¡Œä¸º</b><br/>ç»§æ‰¿ Socket FD<br/>å¼€å§‹ accept() <b>æ–°</b>çš„è¿æ¥"]:::process;    F["<b>çˆ¶è¿›ç¨‹ (v1) è¡Œä¸º</b><br/>åœæ­¢ accept() æ–°è¿æ¥<br/>ç»§ç»­å¤„ç†<b>å·²å»ºç«‹</b>çš„è¿æ¥"]:::process;    %% Final Action    G["æ‰€æœ‰æ—§è¿æ¥å¤„ç†å®Œæ¯•<br/>çˆ¶è¿›ç¨‹å¹²å‡€åœ°é€€å‡º"]:::action;    %% Final State    H["æœåŠ¡è¿è¡Œä¸­ (v2)<br/>å­è¿›ç¨‹ accept() æ‰€æœ‰è¿æ¥"]:::state;    %% Traffic Flow    NewReq("æ–°çš„å®¢æˆ·ç«¯è¯·æ±‚"):::traffic;    OldReq("å·²å»ºç«‹çš„è¿æ¥"):::traffic;    %% Chart Flow    A --> B;    B --> C;    C --> D;    D --> E;    D --> F;    F --> G;    E --> H;    G --> H;    NewReq --> E;    OldReq --> F;</pre><p>ä»å¤–éƒ¨å®¢æˆ·ç«¯çœ‹æ¥ï¼ŒæœåŠ¡çš„ç«¯å£ä»æœªå…³é—­ï¼Œè¯·æ±‚å§‹ç»ˆè¢«å¤„ç†ï¼Œä¸€æ¬¡å®Œç¾çš„é›¶åœæœºæ›´æ–°å°±è¿™æ ·åœ¨è¿›ç¨‹å±‚é¢å®Œæˆäº†ã€‚</p><h3 id="æ–°ä¸–ç•Œçš„å“²å­¦-kubernetes-çš„å®å¤§ç¼–æ’">2. æ–°ä¸–ç•Œçš„å“²å­¦ â€”â€”Kubernetes çš„å®å¤§ç¼–æ’</h3><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æŠŠè§†è§’åˆ‡æ¢åˆ° Kubernetesã€‚Kubernetes çš„ä¸–ç•Œè§‚ä¸<code>tableflip</code>çš„å‡è®¾å®Œå…¨ä¸åŒã€‚å®ƒçš„æ ¸å¿ƒå“²å­¦æ˜¯<strong>ä¸å¯å˜åŸºç¡€è®¾æ–½ (ImmutableInfrastructure)</strong>ã€‚</p><p>åœ¨è¿™ä¸ªå“²å­¦ä¸‹ï¼Œè¿è¡Œä¸­çš„å®¹å™¨ (Pod)è¢«è§†ä¸º<strong>çŸ­æš‚çš„ã€å¯ä»»æ„æ›¿ä»£çš„</strong>ï¼ˆephemeral anddisposableï¼‰ï¼Œå°±åƒç‰§ç¾¤ä¸­çš„ç‰›ç¾Š (cattle)ï¼Œè€Œä¸æ˜¯éœ€è¦ç²¾å¿ƒç…§æ–™çš„å® ç‰©(pets)ã€‚æˆ‘ä»¬ä»ä¸"ä¿®å¤"æˆ–"å‡çº§"ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„å®¹å™¨ï¼Œæˆ‘ä»¬åªç”¨ä¸€ä¸ªæ–°çš„ã€é…ç½®å¥½çš„å®¹å™¨å»<strong>æ›¿æ¢</strong>å®ƒã€‚</p><p>Kubernetes å®ç°é›¶åœæœºæ›´æ–°çš„æœºåˆ¶ï¼Œæ˜¯<strong>æ»šåŠ¨æ›¿æ¢ (RollingUpdate)</strong>ï¼Œè¿™æ˜¯ä¸€åœºç”±æ›´é«˜ç»´åº¦ï¼ˆ<code>Deployment</code>æ§åˆ¶å™¨ï¼‰ç¼–æ’çš„ã€è·¨è¶Šæ•´ä¸ªé›†ç¾¤çš„å®å¤§å·¥ç¨‹ã€‚</p><h3 id="èŒƒå¼å†²çª-ä¸ºä»€ä¹ˆ-tableflip-æ°´åœŸä¸æœ">3. èŒƒå¼å†²çª â€”â€” ä¸ºä»€ä¹ˆ<code>tableflip</code> æ°´åœŸä¸æœ</h3><p><code>tableflip</code>çš„ä¼˜é›…ï¼Œå»ºç«‹åœ¨ä¸€ä¸ªç¨³å®šçš„ã€å¯ç›´æ¥æ“æ§è¿›ç¨‹çš„åº•å±‚ç¯å¢ƒä¹‹ä¸Šã€‚è€Œ Kubernetesæ°æ°æŠ½è±¡æ‰äº†è¿™ä¸ªåº•å±‚ï¼Œå¸¦æ¥äº†æ›´é«˜ç»´åº¦çš„ç®¡ç†æ¨¡å‹ã€‚äºŒè€…çš„å†²çªï¼Œæºäºæ ¹æœ¬æ€§çš„â€œä¸–ç•Œè§‚â€ä¸åˆã€‚</p><ol type="1"><li><strong>æŠ½è±¡å±‚çº§ä¸åŒ¹é…</strong>: <code>tableflip</code> åœ¨<strong>Pod å†…éƒ¨</strong> ç©"è¿›ç¨‹æ¥åŠ›"ï¼Œè€Œ Kubernetes åœ¨ <strong>Podå¤–éƒ¨</strong> ç©"Pod æ›¿æ¢"ã€‚ä½ åœ¨æ—§ Pod å†…éƒ¨åšçš„ä»»ä½•è¿›ç¨‹æ›¿æ¢ï¼Œå¯¹äºKubernetes çš„å®å¤§æ›´æ–°æµç¨‹æ¥è¯´ï¼Œæ˜¯æ¯«æ— æ„ä¹‰çš„ã€‚</li><li><strong>èµ„æºç«äº‰ä¸ OOMKilled</strong>: <code>tableflip</code> åœ¨æ‰§è¡Œ<code>Upgrade()</code>çš„çŸ­æš‚ç¬é—´ï¼Œçˆ¶å­ä¸¤ä¸ªè¿›ç¨‹ä¼šåŒæ—¶å­˜åœ¨ï¼Œè¿™æ„å‘³ç€åº”ç”¨çš„å†…å­˜å’Œ CPUæ¶ˆè€—å¯èƒ½ä¼šç¬é—´ç¿»å€ã€‚åœ¨èµ„æºå—ä¸¥æ ¼é™åˆ¶çš„ Kubernetes Pod ä¸­ï¼Œè¿™ææ˜“è§¦å‘OOMKilledï¼ˆOut of Memory Killerï¼‰ï¼Œä¼˜é›…é‡å¯å˜æˆäº†"æš´åŠ›çŒæ­»"ã€‚</li><li><strong>åŠŸèƒ½å†—ä½™ä¸å¤æ‚åŒ–</strong>: Kubernetes çš„<code>Deployment</code> + <code>Service</code> +<code>Readiness Probe</code>å·²ç»æä¾›äº†ä¸€å¥—ç»è¿‡å¤§è§„æ¨¡ç”Ÿäº§éªŒè¯çš„ã€è·¨èŠ‚ç‚¹çš„é›¶åœæœºæ›´æ–°æ–¹æ¡ˆã€‚<code>tableflip</code>æƒ³è¦è§£å†³çš„é—®é¢˜ï¼Œåœ¨ Kubernetesçš„ä¸–ç•Œé‡Œå·²ç»ç”±æ›´é«˜ç»´åº¦çš„æ¶æ„è®¾è®¡è§£å†³äº†ã€‚</li></ol><h3 id="k8s-çš„ä¼˜é›…ä¹‹é“-go-å¼€å‘è€…æ·±åº¦å®è·µæŒ‡å—">4. K8s çš„ä¼˜é›…ä¹‹é“ â€”â€” Goå¼€å‘è€…æ·±åº¦å®è·µæŒ‡å—</h3><p>æ—¢ç„¶æ—§ä¸–ç•Œçš„é­”æ³•å·²ç»å¤±æ•ˆï¼Œæˆ‘ä»¬å°±å¿…é¡»å­¦ä¹ å¹¶æŒæ¡æ–°ä¸–ç•Œçš„è§„åˆ™ã€‚åœ¨Kubernetesä¸­ï¼ŒçœŸæ­£çš„ä¼˜é›…ï¼Œæ˜¯åº”ç”¨ç¨‹åºä¸ç¼–æ’å¹³å°ä¹‹é—´çš„ä¸€åœºç²¾å¦™çš„â€œåŒäººèˆâ€ã€‚</p><h4 id="åºæ›²ä¸€åˆ‡ä»-server.shutdown-å¼€å§‹">4.1 åºæ›²ï¼šä¸€åˆ‡ä»<code>server.Shutdown()</code> å¼€å§‹</h4><p>æ— è®ºå¹³å°å¦‚ä½•æ¼”å˜ï¼Œåº”ç”¨è‡ªèº«å…·å¤‡ä¼˜é›…å…³é—­çš„èƒ½åŠ›æ˜¯æ‰€æœ‰é«˜çº§å®è·µçš„èµ·ç‚¹ã€‚ä¸€ä¸ªåŸºç¡€çš„ã€å…·å¤‡ä¼˜é›…å…³é—­èƒ½åŠ›çš„Go æœåŠ¡åº”è¯¥å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    server := &amp;http.Server&#123;Addr: <span class="string">&quot;:8080&quot;</span>&#125;</span><br><span class="line">    <span class="comment">// ... ä½ çš„ä¸šåŠ¡ handler ...</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> err := server.ListenAndServe(); err != <span class="literal">nil</span> &amp;&amp; err != http.ErrServerClosed &#123;</span><br><span class="line">            log.Fatalf(<span class="string">&quot;ListenAndServe(): %v&quot;</span>, err)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    quit := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">1</span>)</span><br><span class="line">    signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM)</span><br><span class="line">    &lt;-quit <span class="comment">// é˜»å¡ç›´åˆ°æ”¶åˆ°ä¿¡å·</span></span><br><span class="line"></span><br><span class="line">    log.Println(<span class="string">&quot;Shutting down server...&quot;</span>)</span><br><span class="line">    ctx, cancel := context.WithTimeout(context.Background(), <span class="number">30</span>*time.Second)</span><br><span class="line">    <span class="keyword">defer</span> cancel()</span><br><span class="line">    <span class="keyword">if</span> err := server.Shutdown(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(<span class="string">&quot;Server shutdown failed:&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    log.Println(<span class="string">&quot;Server exited properly&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç æ­£ç¡®åœ°å“åº”äº† Kubernetes çš„"è¯·å…³é—­"ä¿¡å·(<code>SIGTERM</code>)ï¼Œæ˜¯ä¼˜é›…ä¹‹è·¯çš„ç¬¬ä¸€æ­¥ã€‚</p><h4 id="k8s-çš„çœ¼ç›æ·±å…¥ç†è§£æ¢é’ˆ-probes">4.2 K8s çš„çœ¼ç›ï¼šæ·±å…¥ç†è§£æ¢é’ˆ(Probes)</h4><p>Kubernetes å¦‚ä½•çŸ¥é“ä½ çš„æ–° Pod â€œå‡†å¤‡å°±ç»ªâ€äº†ï¼Ÿå®ƒå¦‚ä½•åˆ¤æ–­ä¸€ä¸ªè¿è¡Œä¸­çš„Pod æ˜¯å¦â€œå¡æ­»â€äº†ï¼Ÿç­”æ¡ˆæ˜¯<strong>æ¢é’ˆ (Probes)</strong>ã€‚</p><pre class="mermaid">stateDiagram-v2    state "Pending" as P    state "ContainerCreating" as CC    state "Running" as R    [*] --> P    P --> CC    CC --> R    state R {        direction LR        state "Startup Probe" as SP        state "Liveness/Readiness Probes" as LRP        state "Ready" as RDY        state "NotReady" as NRDY        state "Restarting" as RST        [*] --> SP : å®¹å™¨å¯åŠ¨        SP --> LRP : å¯åŠ¨æ¢é’ˆæˆåŠŸ        SP --> RST : å¯åŠ¨æ¢é’ˆå¤±è´¥        LRP --> RDY : å°±ç»ªæ¢é’ˆæˆåŠŸ        LRP --> NRDY : å°±ç»ªæ¢é’ˆå¤±è´¥        RDY --> LRP : å‘¨æœŸæ€§æ£€æŸ¥        NRDY --> LRP : å‘¨æœŸæ€§æ£€æŸ¥        state "Liveness Check" as LC        state "Readiness Check" as RC        LRP: LC & RC        LC --> [*] : å­˜æ´»æ¢é’ˆå¤±è´¥ --> RST    }</pre><ul><li><strong>å­˜æ´»æ¢é’ˆ (Liveness Probe)</strong>:åƒä¸€ä¸ªå¿ƒè·³æ£€æµ‹ä»ªï¼Œå¤±è´¥ä¼šå¯¼è‡´å®¹å™¨<strong>é‡å¯</strong>ã€‚</li><li><strong>å°±ç»ªæ¢é’ˆ (Readiness Probe)</strong>:åƒä¸€å—è¥ä¸šä¸­/ä¼‘æ¯ä¸­çš„ç‰Œå­ï¼Œå¤±è´¥ä¼šå¯¼è‡´æµé‡è¢«<strong>åœæ­¢</strong>ã€‚</li><li><strong>å¯åŠ¨æ¢é’ˆ (Startup Probe)</strong>:ä¸ºå¯åŠ¨ç¼“æ…¢çš„åº”ç”¨æä¾›é¢å¤–çš„å®½é™æœŸã€‚</li></ul><p>å¯¹äºä¸€ä¸ªéœ€è¦é¢„çƒ­ç¼“å­˜çš„ Go åº”ç”¨ï¼Œæˆ‘ä»¬åº”è¯¥åˆ†åˆ«å®ç°<code>/healthz</code> (Liveness) å’Œ <code>/readyz</code> (Readiness)ç«¯ç‚¹ï¼Œå¹¶åœ¨ Kubernetes YAML ä¸­ç²¾ç¡®é…ç½®ã€‚</p><h4 id="é­”é¬¼åœ¨ç»†èŠ‚ä¸­ç ´è§£ä¼˜é›…ç»ˆæ­¢çš„ç«æ€æ¡ä»¶">4.3é­”é¬¼åœ¨ç»†èŠ‚ä¸­ï¼šç ´è§£ä¼˜é›…ç»ˆæ­¢çš„ç«æ€æ¡ä»¶</h4><p>ä¸€ä¸ªè‡´å‘½çš„é­”é¬¼éšè—åœ¨ç»†èŠ‚ä¸­ï¼šå½“ä¸€ä¸ª Pod è¢«ç»ˆæ­¢æ—¶ï¼Œ<code>Service</code>ç«¯ç‚¹åˆ—è¡¨çš„æ›´æ–°åœ¨æ•´ä¸ªé›†ç¾¤ä¸­çš„ä¼ æ’­<strong>ä¸æ˜¯ç¬æ—¶çš„</strong>ã€‚è¿™ä¼šå¯¼è‡´ç«æ€æ¡ä»¶ã€‚</p><p><strong>é”™è¯¯çš„å…³é—­æµç¨‹ - ç«æ€æ¡ä»¶</strong></p><pre class="mermaid">sequenceDiagram    participant Kubelet as Kubelet    participant App as Go åº”ç”¨ (Pod)    participant Endpoints as Endpoints Controller    participant KubeProxy as Kube-Proxy (åœ¨å…¶ä»–èŠ‚ç‚¹)    participant Client as å®¢æˆ·ç«¯    Kubelet->>App: å‘é€ SIGTERM ä¿¡å·    App->>App: ç«‹å³è°ƒç”¨ server.Shutdown()    Note right of App: åº”ç”¨åœæ­¢æ¥å—æ–°è¿æ¥    Endpoints->>Endpoints: å°† Pod ä» Service ç«¯ç‚¹ç§»é™¤ (æœ‰å»¶è¿Ÿ)    Client->>KubeProxy: å‘èµ·æ–°è¯·æ±‚    Note over KubeProxy: æ­¤æ—¶ï¼ŒKube-Proxy çš„æœ¬åœ°è§„åˆ™è¿˜æœªæ›´æ–°    KubeProxy->>App: è½¬å‘è¯·æ±‚åˆ°å³å°†å…³é—­çš„ Pod    App-->>KubeProxy: Connection Refused!    KubeProxy-->>Client: è¿”å›è¿æ¥é”™è¯¯</pre><p><strong>è§£å†³æ–¹æ¡ˆï¼š<code>preStop</code> ç”Ÿå‘½å‘¨æœŸé’©å­</strong>ï¼Œè¿™æ˜¯Kubernetes æä¾›çš„æ ‡å‡†ç­”æ¡ˆã€‚</p><p><strong>æ­£ç¡®çš„å…³é—­æµç¨‹ - <code>preStop</code> Hook</strong></p><pre class="mermaid">sequenceDiagram    participant Kubelet as Kubelet    participant App as Go åº”ç”¨ (Pod)    participant Endpoints as Endpoints Controller    participant KubeProxy as Kube-Proxy    Kubelet->>Endpoints: Pod çŠ¶æ€å˜ä¸º "Terminating", Endpoints Controller ç«‹å³ç§»é™¤ Pod    Note over Endpoints, KubeProxy: Endpoints æ›´æ–°å¼€å§‹ä¼ æ’­åˆ°æ‰€æœ‰ Kube-Proxy    Kubelet->>App: æ‰§è¡Œ preStop Hook (e.g., "sleep 10")    Note over App: åº”ç”¨ä»åœ¨è¿è¡Œï¼Œä½†æ–°æµé‡å·²å¼€å§‹åœæ­¢    par ç­‰å¾…æœŸé—´        KubeProxy->>KubeProxy: æ›´æ–°æœ¬åœ°ç½‘ç»œè§„åˆ™ï¼Œä¸å†è½¬å‘åˆ°æ­¤ Pod    and        App->>App: "sleep 10" æ­£åœ¨æ‰§è¡Œ    end    Kubelet->>App: preStop ç»“æŸåï¼Œå‘é€ SIGTERM ä¿¡å·    App->>App: è°ƒç”¨ server.Shutdown()    Note right of App: æ­¤æ—¶å·²æ— æ–°æµé‡è¿›å…¥ï¼Œä»å®¹å¤„ç†å­˜é‡è¯·æ±‚</pre><p>é…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ... in your container spec</span></span><br><span class="line"><span class="attr">lifecycle:</span></span><br><span class="line">  <span class="attr">preStop:</span></span><br><span class="line">    <span class="attr">exec:</span></span><br><span class="line">      <span class="comment"># åœ¨å‘é€ SIGTERM ä¿¡å·ä¹‹å‰ï¼Œå…ˆæ‰§è¡Œè¿™ä¸ª sleep å‘½ä»¤</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;sleep 10&quot;</span>]</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå°å°çš„ <code>preStop</code>hookï¼Œå°†åº”ç”¨ä»£ç ä¸åŸºç¡€è®¾æ–½çš„ä¼ æ’­å»¶è¿Ÿè§£è€¦ï¼Œæ˜¯å®ç°çœŸæ­£ä¼˜é›…å…³é—­çš„ç‚¹ç›ä¹‹ç¬”ã€‚</p><h4 id="å½“æœåŠ¡æ‹¥æœ‰è®°å¿†æœ‰çŠ¶æ€åº”ç”¨-statefulset">4.4å½“æœåŠ¡æ‹¥æœ‰è®°å¿†ï¼šæœ‰çŠ¶æ€åº”ç”¨ (<code>StatefulSet</code>)</h4><p>å¯¹äºæ•°æ®åº“ã€æ¶ˆæ¯é˜Ÿåˆ—è¿™ç±»æœ‰çŠ¶æ€æœåŠ¡ï¼Œ<code>Deployment</code>çš„éšæœºæ›¿æ¢ç­–ç•¥æ˜¯ç¾éš¾æ€§çš„ã€‚ä¸ºæ­¤ï¼ŒKubernetes æä¾›äº†<code>StatefulSet</code>ï¼Œå®ƒæä¾›äº†ä¸‰å¤§ä¿è¯ï¼š</p><ol type="1"><li><strong>ç¨³å®šçš„ç½‘ç»œèº«ä»½</strong>: Pod åç§°å›ºå®š (<code>-0</code>,<code>-1</code>, ...)ï¼Œå¹¶æ‹¥æœ‰ç‹¬ç«‹çš„ DNS è®°å½•ã€‚</li><li><strong>ç¨³å®šçš„æŒä¹…åŒ–å­˜å‚¨</strong>: æ¯ä¸ª Pod ç»‘å®šä¸€ä¸ªä¸“å±çš„å­˜å‚¨å·(PV)ã€‚</li><li><strong>æœ‰åºçš„éƒ¨ç½²å’Œæ›´æ–°</strong>: ä¸¥æ ¼æŒ‰ç…§åºå·<code>0 -&gt; N</code> éƒ¨ç½²ï¼ŒæŒ‰ç…§ <code>N -&gt; 0</code>æ›´æ–°å’Œåˆ é™¤ã€‚</li></ol><p>å¯¹äºæœ‰çŠ¶æ€æœåŠ¡ï¼Œå¹³æ»‘æ›´æ–°çš„å†…æ¶µå˜æˆäº†<strong>çŠ¶æ€çš„æ— æŸäº¤æ¥</strong>ï¼Œè¿™éœ€è¦åº”ç”¨æœ¬èº«å…·å¤‡é›†ç¾¤å’Œä¸»ä»åˆ‡æ¢èƒ½åŠ›ã€‚</p><h4 id="ç»ˆæä¼˜é›…å°†å¤æ‚æ€§äº¤ç»™æœåŠ¡ç½‘æ ¼-service-mesh">4.5ç»ˆæä¼˜é›…ï¼šå°†å¤æ‚æ€§äº¤ç»™æœåŠ¡ç½‘æ ¼ (Service Mesh)</h4><p>æœ‰æ²¡æœ‰ä¸€ç§æ–¹å¼ï¼Œè®©åº”ç”¨ä»£ç å›å½’çº¯ç²¹ï¼Œå®Œå…¨ä¸å…³å¿ƒè¿™äº›è¿ç»´ç»†èŠ‚å‘¢ï¼Ÿç­”æ¡ˆæ˜¯<strong>æœåŠ¡ç½‘æ ¼ (Service Mesh)</strong>ã€‚å®ƒé€šè¿‡ <strong>Sidecarä»£ç†æ¨¡å¼</strong>ï¼Œå°†æ‰€æœ‰é€šç”¨çš„ç½‘ç»œé€šä¿¡é€»è¾‘ä»åº”ç”¨ä¸­å‰¥ç¦»å‡ºæ¥ã€‚</p><p>åœ¨æœåŠ¡ç½‘æ ¼çš„ä¸–ç•Œé‡Œï¼Œå…³é—­æµç¨‹å˜å¾—å¯¹åº”ç”¨å®Œå…¨é€æ˜ï¼Œç”± Sidecarä»£ç†è‡ªåŠ¨å®Œæˆæ‰€æœ‰ä¼˜é›…çš„æµé‡æ’ç©ºï¼Œè®©ä½ çš„ Go åº”ç”¨å¯ä»¥æåº¦ç®€åŒ–ã€‚</p><h4 id="èä¼šè´¯é€šåº”å¯¹çœŸå®ä¸–ç•Œçš„å¤šæœåŠ¡è¿›ç¨‹">4.6èä¼šè´¯é€šï¼šåº”å¯¹çœŸå®ä¸–ç•Œçš„å¤šæœåŠ¡è¿›ç¨‹</h4><p>ä¸€ä¸ªè¿›ç¨‹å¯èƒ½åŒæ—¶æä¾›å¤šç§æœåŠ¡ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ª HTTP æœåŠ¡ + ä¸€ä¸ª TCPæœåŠ¡ï¼‰ã€‚æ­¤æ—¶ï¼Œç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†ä¹Ÿéœ€è¦"æ•´ä½“æ€ç»´"ã€‚</p><ul><li><strong>å¯åŠ¨æ—¶</strong>: éœ€è¦ä¸€ä¸ª<strong>èšåˆå¥åº·ç«¯ç‚¹</strong>ã€‚åœ¨Go åº”ç”¨ä¸­åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„ <code>/readyz</code>æ¥å£ï¼Œå®ƒçš„é€»è¾‘æ˜¯å½“ä¸”ä»…å½“<strong>å†…éƒ¨æ‰€æœ‰æœåŠ¡éƒ½å°±ç»ª</strong>æ—¶ï¼Œæ‰è¿”å›<code>HTTP 200</code>ã€‚</li><li><strong>å…³é—­æ—¶</strong>:éœ€è¦ä¸€ä¸ª<strong>ç¼–æ’å¼çš„å…³é—­æµç¨‹</strong>ã€‚æ”¶åˆ° <code>SIGTERM</code>åï¼Œç«‹åˆ»ç¿»è½¬å†…éƒ¨çš„èšåˆå°±ç»ªçŠ¶æ€ï¼Œè®© <code>/readyz</code> å¤±è´¥ï¼Œç„¶åä¾èµ–<code>preStop</code> hook ç­‰å¾…ï¼Œæœ€åæŒ‰é¡ºåºä¼˜é›…åœ°å…³é—­æ‰€æœ‰å†…éƒ¨æœåŠ¡ã€‚</li></ul><h3id="ç»“è¯­æ‹¥æŠ±èŒƒå¼è½¬ç§»åœ¨äº‘åŸç”Ÿä¸–ç•Œä¸­ä¼˜é›…å‰è¡Œ">ç»“è¯­ï¼šæ‹¥æŠ±èŒƒå¼è½¬ç§»ï¼Œåœ¨äº‘åŸç”Ÿä¸–ç•Œä¸­ä¼˜é›…å‰è¡Œ</h3><p>ä» <code>tableflip</code> åˆ°Kubernetesï¼Œæˆ‘ä»¬çœ‹åˆ°çš„ä¸æ˜¯ä¸€ä¸ªæŠ€æœ¯çš„"ä¼˜åŠ£"ä¹‹äº‰ï¼Œè€Œæ˜¯ä¸€åœºæ·±åˆ»çš„<strong>èŒƒå¼è½¬ç§»</strong>ã€‚</p><p><code>tableflip</code>æ˜¯å•æœºæ—¶ä»£ï¼Œå·¥ç¨‹å¸ˆä»¬å‡­å€Ÿå¯¹åº•å±‚ç³»ç»Ÿæ·±åˆ»çš„ç†è§£ï¼Œåˆ›é€ å‡ºçš„ç²¾å·§è‰ºæœ¯å“ã€‚å®ƒä»£è¡¨äº†ä¸€ç§<strong>é¢å‘è¿›ç¨‹ã€å‘½ä»¤å¼</strong>çš„ä¼˜é›…ã€‚</p><p>è€Œ Kubernetes çš„æ»šåŠ¨æ›´æ–°ï¼Œåˆ™æ˜¯åœ¨åˆ†å¸ƒå¼æ—¶ä»£ï¼Œé€šè¿‡<strong>é¢å‘APIã€å£°æ˜å¼</strong>çš„å®å¤§ç¼–æ’ï¼Œå®ç°çš„ç³»ç»Ÿçº§çš„ä¼˜é›…ã€‚å®ƒå°†å¤æ‚æ€§ä¸Šç§»åˆ°å¹³å°ï¼Œä»è€Œå°†åº”ç”¨å¼€å‘è€…è§£æ”¾å‡ºæ¥ï¼Œè®©ä»–ä»¬èƒ½æ›´ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘æœ¬èº«ã€‚</p>]]></content>
    
    
    <summary type="html">æœ¬æ–‡å°†å¸¦æ‚¨è¸ä¸Šä¼˜é›…é‡å¯çš„èŒƒå¼è½¬ç§»ä¹‹æ—…ï¼Œä» tableflip çš„ç¬¬ä¸€æ€§åŸç†å‡ºå‘ï¼Œæ·±å…¥å‰–æå…¶å·¥ä½œæœºåˆ¶ï¼›ç„¶åï¼Œæˆ‘ä»¬å°†åˆ‡æ¢è§†è§’ï¼Œå®¡è§† Kubernetes æ˜¯å¦‚ä½•ä»¥ä¸€ç§æˆªç„¶ä¸åŒçš„å“²å­¦æ¥å®šä¹‰å’Œå®ç°ä¼˜é›…ï¼›æœ€åï¼Œæˆ‘ä»¬å°†æ·±å…¥ Kubernetes å®è·µçš„æ¯ä¸€ä¸ªç»†èŠ‚ï¼Œä»æ¢é’ˆã€ç«æ€æ¡ä»¶åˆ°æœ‰çŠ¶æ€æœåŠ¡å’Œå¤šæœåŠ¡è¿›ç¨‹ï¼Œä¸ºæ‚¨åœ¨äº‘åŸç”Ÿä¸–ç•Œä¸­æ„å»ºé«˜å¯ç”¨ Go åº”ç”¨ï¼Œæä¾›ä¸€ä»½æ¸…æ™°ã€è¯¦å°½çš„ç»ˆææŒ‡å—ã€‚</summary>
    
    
    
    <category term="è§£å†³æ–¹æ¡ˆ" scheme="https://hedon.top/categories/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"/>
    
    
    <category term="è§£å†³æ–¹æ¡ˆ" scheme="https://hedon.top/tags/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"/>
    
  </entry>
  
  <entry>
    <title>Redis æ•°æ®ç±»å‹ä¸¨Stringä¸¨ä»ç¬¬ä¸€æ€§åŸç†çœ‹ Redis å­—ç¬¦ä¸²çš„è®¾è®¡å“²å­¦ (åŸºäº Redis 8.2.1 æºç )</title>
    <link href="https://hedon.top/2025/08/25/redis/redis-datatype-string/"/>
    <id>https://hedon.top/2025/08/25/redis/redis-datatype-string/</id>
    <published>2025-08-25T11:41:00.000Z</published>
    <updated>2025-08-25T15:59:00.477Z</updated>
    
    <content type="html"><![CDATA[<p>å½“äººä»¬åˆæ¬¡æ¥è§¦ Redis æ—¶ï¼Œ<code>String</code>ç±»å‹å¾€å¾€æ˜¯ä»–ä»¬è®¤è¯†çš„ç¬¬ä¸€ä¸ªæ•°æ®ç»“æ„ã€‚<code>SET key value</code>ï¼Œ<code>GET key</code>ï¼Œç®€å•ç›´è§‚ï¼Œæ˜“äºä¸Šæ‰‹ã€‚å¾ˆå¤šäººå› æ­¤è®¤ä¸ºï¼ŒRedisStringå°±æ˜¯ä¸€ä¸ªæœ´ç´ çš„å­—ç¬¦ä¸²é”®å€¼å¯¹ã€‚ç„¶è€Œï¼Œè¿™ä¸ªçœ‹ä¼¼ç®€å•çš„è¡¨é¢ä¹‹ä¸‹ï¼Œéšè—ç€ä¸€ä¸ªç”±ç²¾å¦™è®¾è®¡ã€æè‡´ä¼˜åŒ–å’Œæ·±åˆ»æƒè¡¡æ„å»ºèµ·æ¥çš„å¾®è§‚ä¸–ç•Œã€‚</p><p>è¿™ç¯‡æ–‡ç« å°†åŸºäº <ahref="https://github.com/redis/redis/blob/8.2.1/src/sds.h">Redis8.2.1</a>å¸¦é¢†ä½ è¿›è¡Œä¸€æ¬¡æ·±åº¦æ¢ç´¢ã€‚æˆ‘ä»¬ä¸æ»¡è¶³äº"æ˜¯ä»€ä¹ˆ"ï¼Œè€Œæ˜¯è¦ä»è®¡ç®—æœºç§‘å­¦çš„<strong>ç¬¬ä¸€æ€§åŸç†</strong>å‡ºå‘ï¼Œå»æ¢å¯»"ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡"ã€‚è¯»å®Œæœ¬æ–‡ï¼Œä½ å°†ç†è§£Redis String å¹¶ä¸ä»…ä»…æ˜¯ä¸€ç§æ•°æ®ç±»å‹ï¼Œå®ƒæ›´æ˜¯æ•´ä¸ª Redisè®¾è®¡å“²å­¦çš„å®Œç¾ç¼©å½±ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬ä¸‹ä¸€ä¸ªç»“è®ºï¼š<font color="red"><strong>Redis çš„ Stringæ˜¯ä¸€ä¸ªå¯ä»¥å­˜å‚¨å­—ç¬¦ä¸²ã€æ•´æ•°ã€æµ®ç‚¹æ•°ä¹ƒè‡³äºŒè¿›åˆ¶æ•°æ® (å¦‚å›¾ç‰‡æˆ–åºåˆ—åŒ–çš„å¯¹è±¡)çš„æ•°æ®ç±»å‹ï¼Œå…¶æœ€å¤§å®¹é‡ä¸º 512 MBã€‚å®ƒæ˜¯ Redisæ‰€æœ‰æ•°æ®ç»“æ„ä¸­æœ€åŸºç¡€çš„ä¸€ç§ï¼Œåƒ Hashã€Listç­‰ç»“æ„çš„åº•å±‚å®ç°ä¹Ÿå¤§é‡ç”¨åˆ°äº†å®ƒ</strong>ã€‚</font></p><h2 id="åœ°åŸºä¹‹ä¸‹redis-ä¸ºä½•è¦é‡æ–°å‘æ˜å­—ç¬¦ä¸²">1. åœ°åŸºä¹‹ä¸‹ï¼šRedisä¸ºä½•è¦é‡æ–°å‘æ˜å­—ç¬¦ä¸²ï¼Ÿ</h2><p>åœ¨ C è¯­è¨€ä¸­ï¼Œå­—ç¬¦ä¸²æ˜¯ä»¥ç©ºå­—ç¬¦ <code>\0</code>ç»“å°¾çš„å­—ç¬¦æ•°ç»„ã€‚å®ƒç®€å•ï¼Œä½†ä¹Ÿå¸¦æ¥äº†è¯¸å¤šé™åˆ¶å’Œé£é™©ã€‚Redisçš„ç¼”é€ è€…å¹¶æ²¡æœ‰é€‰æ‹©ç›´æ¥ä½¿ç”¨å®ƒï¼Œè€Œæ˜¯ä»é›¶å¼€å§‹æ„å»ºäº†ä¸€ä¸ªåä¸º <strong>SDS(Simple Dynamic String)</strong> çš„ç»“æ„ã€‚</p><p>SDS çš„è®¾è®¡è§£å†³äº† C å­—ç¬¦ä¸²çš„ä»¥ä¸‹ç—›ç‚¹ï¼š</p><ul><li><p><strong>è·å–é•¿åº¦çš„æ—¶é—´å¤æ‚åº¦</strong></p><ul><li><strong>C å­—ç¬¦ä¸²</strong>: å¿…é¡»éå†æ•´ä¸ªå­—ç¬¦ä¸²ç›´åˆ°é‡åˆ°<code>\0</code>ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(N)ã€‚å½“å­—ç¬¦ä¸²å¾ˆé•¿æ—¶ï¼Œè¿™æ˜¯ä¸€ä¸ªæ˜‚è´µçš„æ“ä½œã€‚</li><li><strong>Redis SDS</strong>: ç»“æ„ä¸­ç›´æ¥åŒ…å«ä¸€ä¸ª <code>len</code>å­—æ®µæ¥è®°å½•å½“å‰é•¿åº¦ï¼Œå› æ­¤è·å–é•¿åº¦çš„æ—¶é—´å¤æ‚åº¦æ˜¯O(1)ã€‚è¿™å¯¹äºé¢‘ç¹è·å–é•¿åº¦çš„åœºæ™¯æ˜¯å·¨å¤§çš„æ€§èƒ½æå‡ã€‚</li></ul></li><li><p><strong>æœç»ç¼“å†²åŒºæº¢å‡º (Buffer Overflow)</strong></p><ul><li><strong>C å­—ç¬¦ä¸²</strong>: <code>strcat</code>ç­‰å‡½æ•°ä¸ä¼šæ£€æŸ¥ç›®æ ‡æ•°ç»„çš„å‰©ä½™ç©ºé—´ï¼Œææ˜“é€ æˆç¼“å†²åŒºæº¢å‡ºï¼Œè¿™æ˜¯ä¸€ä¸ªä¸¥é‡çš„å®‰å…¨æ¼æ´ã€‚</li><li><strong>Redis SDS</strong>: å½“å¯¹ SDS è¿›è¡Œä¿®æ”¹æ—¶ (å¦‚<code>APPEND</code>)ï¼ŒAPI ä¼šå…ˆæ£€æŸ¥å…¶å†…éƒ¨è®°å½•çš„å‰©ä½™ç©ºé—´(<code>free</code> å­—æ®µ)æ˜¯å¦è¶³å¤Ÿã€‚å¦‚æœä¸å¤Ÿï¼Œå®ƒä¼šå…ˆæ‰©å±•å†…å­˜ç©ºé—´ï¼Œç„¶åå†æ‰§è¡Œä¿®æ”¹ã€‚è¿™ä»æ ¹æœ¬ä¸Šæœç»äº†æº¢å‡ºçš„å¯èƒ½æ€§ã€‚</li></ul></li><li><p><strong>äºŒè¿›åˆ¶å®‰å…¨ (Binary Safe)</strong></p><ul><li><strong>C å­—ç¬¦ä¸²</strong>: ç”±äºä»¥ <code>\0</code>ä½œä¸ºç»“å°¾æ ‡è¯†ï¼Œå®ƒä¸èƒ½å­˜å‚¨ä»»ä½•åŒ…å« <code>\0</code>çš„æ•°æ®ï¼Œæ¯”å¦‚å›¾ç‰‡ã€éŸ³é¢‘æˆ– Protobuf åºåˆ—åŒ–åçš„æ•°æ®ã€‚</li><li><strong>Redis SDS</strong>: å®ƒé€šè¿‡ <code>len</code>å­—æ®µæ¥åˆ¤æ–­å­—ç¬¦ä¸²çš„å®é™…ç»“å°¾ï¼Œè€Œéç‰¹æ®Šå­—ç¬¦ã€‚å› æ­¤ï¼Œä½ å¯ä»¥å°†ä»»ä½•å­—èŠ‚æµå­˜å…¥SDSï¼ŒçœŸæ­£åšåˆ°äº†äºŒè¿›åˆ¶å®‰å…¨ã€‚</li></ul></li><li><p><strong>ç©ºé—´é¢„åˆ†é…ä¸æƒ°æ€§é‡Šæ”¾</strong></p><p>ä¸ºäº†é¿å…æ¯æ¬¡è¿½åŠ æ“ä½œéƒ½é‡æ–°åˆ†é…å†…å­˜ (è¿™æ˜¯ä¸€ä¸ªè€—æ—¶çš„ç³»ç»Ÿè°ƒç”¨)ï¼ŒSDSé‡‡ç”¨äº†ä¸€ç§æ™ºèƒ½çš„å†…å­˜åˆ†é…ç­–ç•¥ï¼š</p><ul><li><strong>ç©ºé—´é¢„åˆ†é…</strong>: å½“å¯¹ SDSè¿›è¡Œæ‰©å±•æ—¶ï¼Œå®ƒä¼šåˆ†é…æ¯”å®é™…éœ€è¦æ›´å¤šçš„ç©ºé—´ã€‚å¦‚æœä¿®æ”¹å SDS çš„é•¿åº¦<code>len</code> å°äº 1MBï¼Œåˆ™ä¼šé¢å¤–åˆ†é…ä¸ <code>len</code> ç›¸åŒçš„ç©ºé—´(å³ <code>free = len</code>)ã€‚å¦‚æœ <code>len</code> è¶…è¿‡1MBï¼Œåˆ™ä¼šé¢å¤–åˆ†é…å›ºå®šçš„ 1MBç©ºé—´ã€‚è¿™å¤§å¤§å‡å°‘äº†è¿ç»­å¢é•¿å­—ç¬¦ä¸²æ—¶çš„å†…å­˜é‡åˆ†é…æ¬¡æ•°ã€‚</li><li><strong>æƒ°æ€§ç©ºé—´é‡Šæ”¾</strong>: å½“ç¼©çŸ­ SDSå­—ç¬¦ä¸²æ—¶ï¼Œç¨‹åºå¹¶ä¸ä¼šç«‹å³å°†å¤šä½™çš„å†…å­˜äº¤è¿˜ç»™æ“ä½œç³»ç»Ÿï¼Œè€Œæ˜¯é€šè¿‡æ›´æ–°<code>free</code> å­—æ®µæ¥è®°å½•è¿™äº›ç©ºé—²ç©ºé—´ï¼Œä»¥å¤‡æœªæ¥çš„å¢é•¿æ“ä½œä½¿ç”¨ã€‚</li></ul></li></ul><p>ä¸ºäº†å°†å†…å­˜ä¼˜åŒ–åˆ°æè‡´ï¼ŒSDSçš„è®¾è®¡è€…å¹¶æœªé‡‡ç”¨"ä¸€åˆ€åˆ‡"çš„å¤´éƒ¨ç»“æ„ï¼Œè€Œæ˜¯å®ç°äº†ä¸€å¥—"é‡ä½“è£è¡£"çš„æ–¹æ¡ˆã€‚å®ƒæ ¹æ®å­—ç¬¦ä¸²çš„é•¿åº¦ï¼ŒåŠ¨æ€é€‰æ‹©ä¸åŒå¤§å°çš„å¤´éƒ¨ç»“æ„ï¼Œä»¥æ±‚ç”¨æœ€å°‘çš„å…ƒæ•°æ®å¼€é”€æ¥ç®¡ç†å­—ç¬¦ä¸²ã€‚ä¸‹é¢æ˜¯Redis æºç ä¸­ <ahref="https://github.com/redis/redis/blob/8.2.1/src/sds.h">sds.h</a>çš„æ ¸å¿ƒå®šä¹‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Note: sdshdr5 is never used, we just access the flags byte directly.</span></span><br><span class="line"><span class="comment"> * However is here to document the layout of type 5 SDS strings. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">hisdshdr5</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> flags; <span class="comment">/* 3 lsb of type, and 5 msb of string length */</span></span><br><span class="line">    <span class="type">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">hisdshdr8</span> &#123;</span></span><br><span class="line">    <span class="type">uint8_t</span> len; <span class="comment">/* used */</span></span><br><span class="line">    <span class="type">uint8_t</span> alloc; <span class="comment">/* excluding the header and null terminator */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></span><br><span class="line">    <span class="type">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">hisdshdr16</span> &#123;</span></span><br><span class="line">    <span class="type">uint16_t</span> len; <span class="comment">/* used */</span></span><br><span class="line">    <span class="type">uint16_t</span> alloc; <span class="comment">/* excluding the header and null terminator */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></span><br><span class="line">    <span class="type">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">hisdshdr32</span> &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> len; <span class="comment">/* used */</span></span><br><span class="line">    <span class="type">uint32_t</span> alloc; <span class="comment">/* excluding the header and null terminator */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></span><br><span class="line">    <span class="type">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">hisdshdr64</span> &#123;</span></span><br><span class="line">    <span class="type">uint64_t</span> len; <span class="comment">/* used */</span></span><br><span class="line">    <span class="type">uint64_t</span> alloc; <span class="comment">/* excluding the header and null terminator */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></span><br><span class="line">    <span class="type">char</span> buf[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç›¸ä¿¡å½“çœ‹åˆ° <code>sdshdr5</code> åˆ° <code>sdshdr64</code>è¿™ä¸€ç³»åˆ—ç»“æ„çš„æ—¶å€™ï¼Œä¸å°‘è¯»è€…è¦é—®ä¸€ä¸ªé—®é¢˜ï¼š<strong>ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¹ˆå¤šä¸åŒçš„å¤´ç»“æ„(header)ï¼Ÿ</strong></p><p>ç­”æ¡ˆæ ¹æ¤äºä¸€ä¸ªæ ¸å¿ƒçš„æƒè¡¡ï¼š<strong>ç”¨æœ€å°‘çš„å…ƒæ•°æ® (metadata)å¼€é”€æ¥ç®¡ç†ä»»æ„é•¿åº¦çš„å­—ç¬¦ä¸²</strong>ã€‚å¦‚æœåªæœ‰ä¸€ä¸ªèƒ½å®¹çº³ 64ä½é•¿åº¦çš„å·¨å¤§å¤´éƒ¨ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬å­˜å‚¨å¤§é‡åªæœ‰å‡ ä¸ªå­—èŠ‚çš„çŸ­å­—ç¬¦ä¸²æ—¶ï¼Œå¤´éƒ¨æœ¬èº«ï¼ˆ17å­—èŠ‚ï¼‰çš„å¼€é”€å°†è¿œå¤§äºæ•°æ®æœ¬èº«ï¼Œè¿™ä¼šé€ æˆå·¨å¤§çš„å†…å­˜æµªè´¹ã€‚</p><p>å› æ­¤ï¼ŒRedisçš„è®¾è®¡è€…é‡‡å–äº†<strong>åˆ†ç±»å¤„ç†</strong>çš„ç­–ç•¥ï¼šæ ¹æ®å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œä¸ºå…¶é€‰æ‹©ä¸€ä¸ªå¤§å°æ°åˆ°å¥½å¤„çš„å¤´éƒ¨ç»“æ„ã€‚</p><p>åœ¨æ·±å…¥çœ‹å·®å¼‚ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹æ‰€æœ‰ç»“æ„ï¼ˆé™¤ <code>sdshdr5</code>å¤–ï¼‰éƒ½åŒ…å«çš„å››ä¸ªå…³é”®æˆå‘˜ï¼š</p><ul><li><code>len</code>: ä¸€ä¸ªæ— ç¬¦å·æ•´æ•°ï¼Œè®°å½•äº† <code>buf</code>æ•°ç»„ä¸­å½“å‰å·²ä½¿ç”¨çš„å­—èŠ‚æ•°ï¼Œå³å­—ç¬¦ä¸²çš„å®é™…é•¿åº¦ã€‚è¿™æ˜¯å®ç° O(1)å¤æ‚åº¦è·å–å­—ç¬¦ä¸²é•¿åº¦çš„å…³é”®ã€‚</li><li><code>alloc</code>: ä¸€ä¸ªæ— ç¬¦å·æ•´æ•°ï¼Œè®°å½•äº†ä¸º <code>buf</code>æ•°ç»„åˆ†é…çš„æ€»å­—èŠ‚æ•°ï¼Œ<strong>ä¸åŒ…æ‹¬</strong>å¤´éƒ¨è‡ªèº«å’Œæœ«å°¾çš„ç©ºå­—ç¬¦<code>\0</code>ã€‚<code>alloc - len</code> å°±æ˜¯é¢„ç•™çš„ç©ºé—²ç©ºé—´ï¼Œç”¨äºé«˜æ•ˆçš„<code>APPEND</code> æ“ä½œã€‚</li><li><code>flags</code>: ä¸€ä¸ª 8 ä½çš„æ— ç¬¦å·å­—ç¬¦ã€‚å…¶ä¸­ï¼Œä½ 3 ä½ (LSB)ç”¨æ¥å­˜å‚¨ SDS çš„ç±»å‹ç¼–ç  (Type)ã€‚ä¾‹å¦‚ï¼Œ<code>SDS_TYPE_8</code> å¯¹åº”<code>sdshdr8</code>ï¼Œ<code>SDS_TYPE_16</code> å¯¹åº”<code>sdshdr16</code> ç­‰ã€‚SDS çš„å‡½æ•°åº“é€šè¿‡è¯»å–è¿™ä¸ª <code>flags</code>å­—æ®µï¼Œå°±èƒ½çŸ¥é“å½“å‰å¤„ç†çš„æ˜¯å“ªç§ç±»å‹çš„ SDS headerï¼Œä»è€Œæ­£ç¡®åœ°è§£æå‡º<code>len</code> å’Œ <code>alloc</code>ã€‚</li><li><code>buf[]</code>: è¿™æ˜¯ä¸€ä¸ª C99 çš„ç‰¹æ€§ï¼Œç§°ä¸º<strong>æŸ”æ€§æ•°ç»„æˆå‘˜(Flexible ArrayMember)</strong>ã€‚å®ƒå¿…é¡»æ˜¯ç»“æ„çš„æœ€åä¸€ä¸ªæˆå‘˜ï¼Œå¹¶ä¸”åœ¨å®šä¹‰æ—¶å¤§å°ä¸ºç©ºã€‚å®ƒçš„ä½œç”¨æ˜¯ï¼Œå½“æˆ‘ä»¬ä¸ºè¿™ä¸ªç»“æ„åˆ†é…å†…å­˜æ—¶ï¼Œå¯ä»¥ä¸€æ¬¡æ€§åˆ†é…å¤´éƒ¨å’Œæ•°æ®æ‰€éœ€çš„<strong>è¿ç»­å†…å­˜ç©ºé—´</strong>ã€‚è¿™å¯¹äºæé«˜CPU ç¼“å­˜å‘½ä¸­ç‡è‡³å…³é‡è¦ã€‚</li></ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥æ¢ç´¢ä¸€ä¸‹ <code>__attribute__ ((__packed__))</code>çš„åº•å±‚å¥¥ç§˜ï¼Œè¿™ä¸ªå±æ€§æ˜¯ GCC/Clangç¼–è¯‘å™¨çš„æ‰©å±•ï¼Œå®ƒå‘Šè¯‰ç¼–è¯‘å™¨ï¼š<strong>è¯·ä¸è¦ä¸ºäº†å†…å­˜å¯¹é½ (MemoryAlignment) è€Œåœ¨ç»“æ„æˆå‘˜ä¹‹é—´æ·»åŠ ä»»ä½•å¡«å……å­—èŠ‚ (Padding)</strong>ã€‚</p><p>ç°ä»£ CPU è®¿é—®å†…å­˜ä¸æ˜¯é€å­—èŠ‚è¿›è¡Œçš„ï¼Œè€Œæ˜¯ä»¥å­— (Word) ä¸ºå•ä½ï¼ˆæ¯”å¦‚ 4å­—èŠ‚æˆ– 8å­—èŠ‚ï¼‰ã€‚å¦‚æœä¸€ä¸ªæ•°æ®ç»“æ„çš„å¤§å°åˆšå¥½æ˜¯å­—é•¿çš„æ•´æ•°å€ï¼Œå¹¶ä¸”å…¶æˆå‘˜çš„åœ°å€ä¹Ÿéƒ½æ˜¯å­—é•¿çš„å€æ•°ï¼ŒCPUçš„è®¿é—®æ•ˆç‡æœ€é«˜ã€‚ä¸ºæ­¤ï¼Œç¼–è¯‘å™¨é»˜è®¤ä¼šåœ¨ç»“æ„ä½“æˆå‘˜ä¹‹é—´æ’å…¥ä¸€äº›ç©ºç™½çš„å¡«å……å­—èŠ‚ï¼Œä»¥ä¿è¯å¯¹é½ã€‚</p><p>Redis çš„ SDS è®¾è®¡ä¾èµ–ä¸€ä¸ªå·§å¦™çš„æŠ€å·§ï¼š<strong>SDS APIè¿”å›ç»™ç”¨æˆ·çš„æŒ‡é’ˆæ˜¯ <code>buf</code>çš„èµ·å§‹åœ°å€ï¼Œè€Œä¸æ˜¯ç»“æ„ä½“çš„èµ·å§‹åœ°å€</strong>ã€‚å½“éœ€è¦è·å–é•¿åº¦æ—¶ï¼ŒAPIä¼šé€šè¿‡è¿™ä¸ª <code>buf</code> çš„æŒ‡é’ˆå‘å‰åç§»å›ºå®šçš„å­—èŠ‚æ•°æ¥æ‰¾åˆ°<code>len</code> å­—æ®µã€‚ä¾‹å¦‚ï¼Œå¯¹äº <code>sdshdr8</code>ï¼Œ<code>len</code>å­—æ®µå°±åœ¨ <code>buf</code> æŒ‡é’ˆçš„å‰ 3ä¸ªå­—èŠ‚å¤„ã€‚å¦‚æœç¼–è¯‘å™¨è¿›è¡Œäº†å¡«å……ï¼Œè¿™ä¸ªå›ºå®šçš„åç§»é‡å°±ä¼šå¤±æ•ˆã€‚<code>__packed__</code>ç¡®ä¿äº†å†…å­˜å¸ƒå±€çš„ç´§å‡‘å’Œå¯é¢„æµ‹æ€§ï¼Œè®©è¿™ç§æŒ‡é’ˆè¿ç®—æˆä¸ºå¯èƒ½ã€‚</p><p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹æ¯ä¸ªç»“æ„çš„å…·ä½“ç”¨é€”ï¼š</p><ul><li><code>struct sdshdr5</code><ul><li><strong>è¶…çº§ä¼˜åŒ–</strong>:è¿™æ˜¯ä¸€ä¸ªæç«¯çš„ä¼˜åŒ–ï¼Œç”¨äºå­˜å‚¨æçŸ­çš„å­—ç¬¦ä¸²ã€‚å®ƒæ²¡æœ‰ç‹¬ç«‹çš„ <code>len</code>å’Œ <code>alloc</code> å­—æ®µã€‚æ•´ä¸ªå¤´éƒ¨åªæœ‰ä¸€ä¸ª <code>flags</code>å­—èŠ‚ã€‚</li><li><strong>ä½åŸŸæŠ€å·§</strong>: è¿™ä¸ªå­—èŠ‚è¢«æ‹†åˆ†ä½¿ç”¨ï¼šä½ 3 ä½å­˜ç±»å‹ï¼Œé«˜ 5ä½å­˜é•¿åº¦ã€‚å› æ­¤ï¼Œ<code>sdshdr5</code> æœ€å¤šèƒ½è¡¨ç¤ºçš„é•¿åº¦æ˜¯25âˆ’1=31ã€‚ç”±äºæ²¡æœ‰ <code>alloc</code>å­—æ®µï¼Œè¿™ç§ç±»å‹çš„å­—ç¬¦ä¸²æ˜¯åªè¯»çš„ï¼Œä»»ä½•ä¿®æ”¹éƒ½ä¼šå¯¼è‡´å…¶è¢«è½¬æ¢æˆå…¶ä»– SDSç±»å‹ã€‚</li></ul></li><li><code>struct sdshdr8</code><ul><li><strong>å¤´éƒ¨å¤§å°</strong>: <code>len</code>(1 byte) +<code>alloc</code>(1 byte) + <code>flags</code>(1 byte) = <strong>3å­—èŠ‚</strong>ã€‚</li><li><strong>å®¹é‡</strong>: <code>len</code> æ˜¯<code>uint8_t</code>ï¼Œæœ€å¤§å¯ä»¥è¡¨ç¤ºçš„é•¿åº¦æ˜¯ 28âˆ’1=255 å­—èŠ‚ã€‚</li><li><strong>åœºæ™¯</strong>: é€‚ç”¨äºå­˜å‚¨é•¿åº¦åœ¨ 32 åˆ° 255å­—èŠ‚ä¹‹é—´çš„çŸ­å­—ç¬¦ä¸²ã€‚</li></ul></li><li><code>struct sdshdr16</code><ul><li><strong>å¤´éƒ¨å¤§å°</strong>: <code>len</code>(2 bytes) +<code>alloc</code>(2 bytes) + <code>flags</code>(1 byte) = <strong>5å­—èŠ‚</strong>ã€‚</li><li><strong>å®¹é‡</strong>: <code>len</code> æ˜¯<code>uint16_t</code>ï¼Œæœ€å¤§å¯ä»¥è¡¨ç¤ºçš„é•¿åº¦æ˜¯ 216âˆ’1=65,535 å­—èŠ‚ (64KB)ã€‚</li><li><strong>åœºæ™¯</strong>: é€‚ç”¨äºä¸­ç­‰é•¿åº¦çš„å­—ç¬¦ä¸²ã€‚</li></ul></li><li><code>struct sdshdr32</code><ul><li><strong>å¤´éƒ¨å¤§å°</strong>: <code>len</code>(4 bytes) +<code>alloc</code>(4 bytes) + <code>flags</code>(1 byte) = <strong>9å­—èŠ‚</strong>ã€‚</li><li><strong>å®¹é‡</strong>: <code>len</code> æ˜¯<code>uint32_t</code>ï¼Œæœ€å¤§å¯ä»¥è¡¨ç¤ºçš„é•¿åº¦æ˜¯ 232âˆ’1â‰ˆ4 GBã€‚</li><li><strong>åœºæ™¯</strong>: é€‚ç”¨äºéå¸¸é•¿çš„å­—ç¬¦ä¸²ã€‚</li></ul></li><li><code>struct sdshdr64</code><ul><li><strong>å¤´éƒ¨å¤§å°</strong>: <code>len</code>(8 bytes) +<code>alloc</code>(8 bytes) + <code>flags</code>(1 byte) = <strong>17å­—èŠ‚</strong>ã€‚</li><li><strong>å®¹é‡</strong>: <code>len</code> æ˜¯<code>uint64_t</code>ï¼Œç†è®ºä¸Šå¯ä»¥è¡¨ç¤ºå·¨å¤§æ— æ¯”çš„å­—ç¬¦ä¸²ï¼Œä½†å—é™äº RedisString æœ€å¤§ 512 MB çš„è®¾è®¡çº¦æŸã€‚</li><li><strong>åœºæ™¯</strong>: ç”¨äºéœ€è¦è¶…è¿‡ 4GB é•¿åº¦çš„åœºæ™¯ï¼ˆå°½ç®¡åœ¨ Redisçš„å®é™…ä½¿ç”¨ä¸­å¾ˆå°‘è§ï¼‰ã€‚</li></ul></li></ul><p>è¿™æ®µä»£ç çœ‹ä¼¼ç®€å•ï¼Œå´è•´å«äº† Redis è®¾è®¡è€…å¯¹ C è¯­è¨€ã€å†…å­˜å¸ƒå±€å’Œ CPUå·¥ä½œçš„æ·±åˆ»ç†è§£ã€‚å®ƒå‘Šè¯‰æˆ‘ä»¬ï¼š</p><ol type="1"><li><strong>æ²¡æœ‰é“¶å¼¹</strong>:é’ˆå¯¹ä¸åŒè§„æ¨¡çš„é—®é¢˜ï¼Œé‡‡ç”¨ä¸åŒçš„è§£å†³æ–¹æ¡ˆã€‚SDSé€šè¿‡ç±»å‹çš„åˆ’åˆ†ï¼Œå®ç°äº†åœ¨ä¸åŒé•¿åº¦å­—ç¬¦ä¸²ä¸‹çš„æœ€ä¼˜å†…å­˜å¼€é”€ã€‚</li><li><strong>æ·±å…¥ç¡¬ä»¶</strong>: äº†è§£å†…å­˜å¯¹é½ã€CPUç¼“å­˜ç­‰åº•å±‚æœºåˆ¶ï¼Œå¯ä»¥å†™å‡ºæ€§èƒ½æ›´é«˜çš„ä»£ç ã€‚<code>__packed__</code>å’ŒæŸ”æ€§æ•°ç»„æˆå‘˜çš„ä½¿ç”¨å°±æ˜¯æ˜è¯ã€‚</li><li><strong>åŠ¨æ€é€‚åº”</strong>: Redis çš„ SDSåº“æ˜¯æ™ºèƒ½çš„ã€‚å½“ä½ åˆ›å»ºä¸€ä¸ªçŸ­å­—ç¬¦ä¸²æ—¶ï¼Œå®ƒä¼šä½¿ç”¨<code>sdshdr8</code>ã€‚å¦‚æœä½ ä¸æ–­ <code>APPEND</code> å†…å®¹ï¼Œä¸€æ—¦é•¿åº¦è¶…è¿‡255ï¼ŒSDS åº“ä¼šè‡ªåŠ¨è¿›è¡Œå†…å­˜é‡åˆ†é…ï¼Œå¹¶å°†å¤´éƒ¨å‡çº§ä¸º<code>sdshdr16</code>ï¼Œè¿™ä¸ªè¿‡ç¨‹å¯¹ç”¨æˆ·å®Œå…¨é€æ˜ã€‚</li></ol><h2 id="åŠ¨æ€ä¹‹èˆä¸‰ç§ç¼–ç çš„æ™ºèƒ½å¹³è¡¡æœ¯">2.åŠ¨æ€ä¹‹èˆï¼šä¸‰ç§ç¼–ç çš„æ™ºèƒ½å¹³è¡¡æœ¯</h2><p>å¦‚æœè¯´ SDS æ˜¯åšå®çš„åœ°åŸºï¼Œé‚£ä¹ˆæ™ºèƒ½ç¼–ç ä½“ç³»å°±æ˜¯å…¶ä¸ŠçµåŠ¨çš„èˆè€…ã€‚Rediså¯¹å¤–æš´éœ²äº†ç»Ÿä¸€çš„ Stringæ¥å£ï¼Œä½†å¯¹å†…ï¼Œå®ƒä¼šæ ¹æ®æ•°æ®çš„å®é™…ç‰¹å¾ï¼Œæ‚„æ‚„åœ°ä¸ºå…¶é€‰æ‹©æœ€ä¼˜çš„ç¼–ç æ ¼å¼ã€‚</p><p>è¿™ç§è®¾è®¡çš„æ ¸å¿ƒï¼Œæ˜¯ä¸ºäº†è§£å†³<strong>é€šç”¨æ€§ä¸ä¸“ç”¨æ€§</strong>çš„çŸ›ç›¾ã€‚ä¸€ä¸ªé€šç”¨çš„å­—ç¬¦ä¸²ç»“æ„æ— æ³•å¯¹çº¯æ•°å­—è¿™ç±»ç‰¹æ®Šåœºæ™¯è¿›è¡Œä¼˜åŒ–ã€‚ä¸ºæ­¤ï¼ŒRediså‡†å¤‡äº†ä¸‰å¥—â€œæœè£…â€ï¼š<code>int</code>, <code>embstr</code>,<code>raw</code>ã€‚</p><p>è®©æˆ‘ä»¬ä»ç¬¬ä¸€æ€§åŸç†å‡ºå‘ï¼Œæ¢å¯»è¿™èƒŒåçš„è®¾è®¡åŠ¨æœºã€‚</p><h3 id="æ ¸å¿ƒçŸ›ç›¾é€šç”¨æ€§-vs.-ä¸“ç”¨æ€§">æ ¸å¿ƒçŸ›ç›¾ï¼šé€šç”¨æ€§ vs. ä¸“ç”¨æ€§</h3><p>é¦–å…ˆï¼ŒRedis ä½œä¸ºä¸€ä¸ªé”®å€¼æ•°æ®åº“ï¼Œå®ƒçš„ Valueå¿…é¡»å…·å¤‡<strong>é€šç”¨æ€§</strong>ã€‚è¿™æ„å‘³ç€å®ƒåº”è¯¥èƒ½å­˜å‚¨ä»»ä½•ä¸œè¥¿ï¼Œä»æ•°å­—<code>123</code> åˆ°å­—ç¬¦ä¸²<code>"hello world"</code>ï¼Œå†åˆ°ä¸€æ®µå¤æ‚çš„äºŒè¿›åˆ¶æ•°æ®ã€‚ä»è¿™ä¸ªè§’åº¦çœ‹ï¼Œå°†æ‰€æœ‰ä¸œè¥¿éƒ½è§†ä¸ºå­—èŠ‚åºåˆ—ï¼ˆå­—ç¬¦ä¸²ï¼‰æ˜¯æœ€ç®€å•ã€æœ€é€šç”¨çš„åšæ³•ã€‚</p><p>ç„¶è€Œï¼Œå¦‚æœçœŸçš„å°†æ‰€æœ‰ä¸œè¥¿éƒ½å­˜ä¸ºæ™®é€šå­—ç¬¦ä¸²ï¼Œå°±ä¼šé‡åˆ°<strong>æ•ˆç‡ç“¶é¢ˆ</strong>ï¼š</p><ol type="1"><li><strong>å†…å­˜æµªè´¹</strong>: å­˜å‚¨æ•°å­— <code>100</code>ï¼Œå¦‚æœç”¨å­—ç¬¦ä¸²<code>"100"</code> å½¢å¼ï¼Œéœ€è¦ 3 ä¸ªå­—èŠ‚ã€‚å¦‚æœç”¨ä¸€ä¸ª 64 ä½æ•´å‹(<code>long</code>) å­˜å‚¨ï¼Œè™½ç„¶ä¼šå ç”¨ 8 ä¸ªå­—èŠ‚ï¼Œä½† Redisæœ‰æ›´å·§å¦™çš„æ–¹æ³•æ¥ä¼˜åŒ–å®ƒã€‚æ›´é‡è¦çš„æ˜¯ï¼Œé¢‘ç¹åˆ›å»ºå’Œé”€æ¯å¤§é‡å°å­—ç¬¦ä¸²å¯¹è±¡ï¼Œå…¶å…ƒæ•°æ®å¼€é”€å’Œå†…å­˜ç¢ç‰‡ä¸å®¹å¿½è§†ã€‚</li><li><strong>è®¡ç®—ä½æ•ˆ</strong>: å¦‚æœä½ æƒ³å¯¹å­˜å‚¨çš„æ•°å­— <code>"100"</code>æ‰§è¡Œ <code>INCR</code> (åŠ  1) æ“ä½œã€‚å¯¹äºå­—ç¬¦ä¸²ï¼ŒCPU éœ€è¦å…ˆå°†<code>"100"</code> è½¬æ¢ä¸ºæ•´æ•° <code>100</code>ï¼Œç„¶åæ‰§è¡ŒåŠ æ³•å¾—åˆ°<code>101</code>ï¼Œæœ€åå†å°† <code>101</code> è½¬æ¢ä¸ºå­—ç¬¦ä¸²<code>"101"</code>å­˜å›å»ã€‚è¿™ä¸ªè¿‡ç¨‹æ¶‰åŠå¤šæ¬¡ç±»å‹è½¬æ¢ï¼Œè¿œä¸å¦‚ç›´æ¥åœ¨æ•´æ•°ä¸Šæ‰§è¡Œä¸€æ¬¡åŠ æ³•æŒ‡ä»¤æ¥å¾—å¿«ã€‚</li></ol><p>Redisçš„æ™ºèƒ½ç¼–ç ä½“ç³»ï¼Œæ­£æ˜¯ä¸ºäº†è§£å†³<strong>å¯¹å¤–æ¥å£ç»Ÿä¸€</strong>ä¸<strong>å¯¹å†…å®ç°é«˜æ•ˆ</strong>è¿™ä¸€æ ¸å¿ƒçŸ›ç›¾è€Œè®¾è®¡çš„ã€‚å®ƒè®©Redisåœ¨äº«å—é€šç”¨æ€§å¸¦æ¥çš„ä¾¿åˆ©çš„åŒæ—¶ï¼Œåˆèƒ½è·å¾—ä¸“ç”¨æ•°æ®ç±»å‹å¸¦æ¥çš„æ€§èƒ½å’Œå†…å­˜ä¼˜åŠ¿ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬æ¥é€ä¸€åˆ†æ <code>int</code>, <code>embstr</code>,<code>raw</code> è¿™ä¸‰ç§ç¼–ç ï¼Œçœ‹çœ‹å®ƒä»¬åˆ†åˆ«è§£å†³äº†ä»€ä¹ˆé—®é¢˜ã€‚</p><h3id="obj_encoding_intä¸ºæ•°å­—è€Œç”Ÿçš„æè‡´ä¼˜åŒ–">OBJ_ENCODING_INTï¼šä¸ºæ•°å­—è€Œç”Ÿçš„æè‡´ä¼˜åŒ–</h3><blockquote><p>è§£å†³çº¯æ•°å­—çš„å­˜å‚¨å’Œè®¡ç®—æ•ˆç‡é—®é¢˜ã€‚</p></blockquote><p>å½“ä½  SET ä¸€ä¸ªå¯ä»¥è¢« 64 ä½æœ‰ç¬¦å·æ•´æ•° (long) è¡¨ç¤ºçš„å€¼æ—¶ï¼ŒRedisä¸ä¼šä¸ºå…¶åˆ†é…ä¸€ä¸ª sds å­—ç¬¦ä¸²ç»“æ„ã€‚å®ƒä¼šä½¿ç”¨ <code>int</code> ç¼–ç ã€‚</p><p>è¿™é‡Œçš„ç²¾é«“åœ¨äºä¸€ä¸ªæå…¶å·§å¦™çš„æŒ‡é’ˆå¤ç”¨æŠ€å·§ã€‚åœ¨ 64ä½ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªæŒ‡é’ˆå˜é‡æœ¬èº«ä¼šå ç”¨ 8 ä¸ªå­—èŠ‚ã€‚Redis çš„æ ¸å¿ƒæ•°æ®ç»“æ„<code>redisObject</code> åŒ…å«ä¸€ä¸ª <code>void *ptr</code>æŒ‡é’ˆï¼Œé€šå¸¸æŒ‡å‘çœŸæ­£çš„æ•°æ®ï¼ˆæ¯”å¦‚ä¸€ä¸ª <code>sds</code> ç»“æ„ï¼‰ã€‚</p><p>Redis çš„è®¾è®¡è€…å‘ç°ï¼Œä¸€ä¸ª long ç±»å‹ä¹Ÿæ˜¯ 8 ä¸ªå­—èŠ‚ã€‚å› æ­¤ï¼Œå½“å­˜å‚¨ä¸€ä¸ªlong å‹æ•´æ•°æ—¶ï¼ŒRedisä¸å†åˆ†é…é¢å¤–çš„å†…å­˜å»å­˜å‚¨æ•°æ®ï¼Œè€Œæ˜¯<u>ç›´æ¥å°†è¿™ä¸ªæ•´æ•°å€¼å­˜æ”¾åœ¨äº†<code>redisObject</code> çš„ <code>ptr</code> æŒ‡é’ˆæ‰€å ç”¨çš„ 8å­—èŠ‚ç©ºé—´é‡Œ</u>ï¼</p><p>è¿™æ ·æœ‰ 2 ä¸ªå¥½å¤„ï¼š</p><ol type="1"><li><strong>é›¶å†…å­˜å¼€é”€</strong>: é™¤äº† <code>redisObject</code>ç»“æ„æœ¬èº«çš„å¼€é”€å¤–ï¼Œæ•°æ®å­˜å‚¨çš„é¢å¤–å¼€é”€ä¸º 0ã€‚</li><li><strong>æè‡´è®¡ç®—æ€§èƒ½</strong>: æ‰§è¡Œ<code>INCR</code>/<code>DECR</code> ç­‰å‘½ä»¤æ—¶ï¼ŒCPUå¯ä»¥ç›´æ¥åœ¨å†…å­˜ä¸­è¿›è¡ŒåŸç”Ÿæ•´æ•°è¿ç®—ï¼Œæ— éœ€ä»»ä½•ç±»å‹è½¬æ¢ï¼Œé€Ÿåº¦å¿«å¦‚é—ªç”µã€‚</li></ol><h3id="obj_encoding_embsträ¸ºçŸ­å­—ç¬¦ä¸²è®¾è®¡çš„å¿«è½¦é“">OBJ_ENCODING_EMBSTRï¼šä¸ºçŸ­å­—ç¬¦ä¸²è®¾è®¡çš„"å¿«è½¦é“"</h3><blockquote><p>è§£å†³å¤§é‡çŸ­å­—ç¬¦ä¸²å¸¦æ¥çš„å†…å­˜åˆ†é…å¼€é”€å’Œå†…å­˜ç¢ç‰‡é—®é¢˜ã€‚</p></blockquote><p>å½“æˆ‘ä»¬å­˜å‚¨ä¸€ä¸ªè¾ƒé•¿çš„å­—ç¬¦ä¸²æ—¶ï¼Œé€šå¸¸éœ€è¦ä¸¤æ¬¡å†…å­˜åˆ†é…ï¼šä¸€æ¬¡ä¸º<code>redisObject</code> ç»“æ„åˆ†é…ï¼Œå¦ä¸€æ¬¡ä¸º <code>sds</code>ç»“æ„ï¼ˆåŒ…å«å¤´éƒ¨å’Œæ•°æ®æœ¬èº«ï¼‰åˆ†é…ã€‚è¿™ä¸¤å—å†…å­˜é€šå¸¸æ˜¯ä¸è¿ç»­çš„ã€‚</p><p>å¯¹äºçŸ­å­—ç¬¦ä¸²ï¼ˆåœ¨è¾ƒæ–°ç‰ˆæœ¬ä¸­æ˜¯é•¿åº¦ &lt;= 44 å­—èŠ‚ï¼‰ï¼ŒRedisè®¤ä¸ºä¸¤æ¬¡åˆ†é…è¿‡äºæµªè´¹ã€‚äºæ˜¯ <code>embstr</code>ç¼–ç åº”è¿è€Œç”Ÿã€‚<u>å®ƒåªè¿›è¡Œä¸€æ¬¡å†…å­˜åˆ†é…ï¼Œç”³è¯·ä¸€å—è¿ç»­çš„å†…å­˜ç©ºé—´ï¼ŒåŒæ—¶å®¹çº³<code>redisObject</code> çš„å…ƒä¿¡æ¯å’Œ <code>sds</code>çš„å®é™…æ•°æ®</u>ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250825233436780.png"alt="Redis String embstr å’Œ raw ç¼–ç å†…å­˜å¸ƒå±€å¯¹æ¯”" /><figcaption aria-hidden="true">Redis String embstr å’Œ rawç¼–ç å†…å­˜å¸ƒå±€å¯¹æ¯”</figcaption></figure><p>è¿™æ ·æœ‰ 2 ä¸ªå¥½å¤„ï¼š</p><ol type="1"><li><strong>å‡å°‘åˆ†é…æ¬¡æ•°</strong>: åˆ›å»ºå’Œé”€æ¯ <code>embstr</code>åªéœ€è¦ä¸€æ¬¡ <code>malloc</code>/<code>free</code>ï¼Œé™ä½äº†ç®¡ç†å¼€é”€ã€‚</li><li><strong>æå‡ç¼“å­˜æ•ˆç‡ (Cache Locality)</strong>:è¿™æ˜¯æœ€é‡è¦çš„ä¼˜åŠ¿ã€‚CPUä»å†…å­˜è¯»å–æ•°æ®æ—¶ï¼Œä¸æ˜¯ä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚åœ°è¯»ï¼Œè€Œæ˜¯æŒ‰ç¼“å­˜è¡Œ (CacheLine)ï¼ˆé€šå¸¸æ˜¯ 64 å­—èŠ‚ï¼‰è¯»å–ã€‚ç”±äº <code>redisObject</code>å’Œå­—ç¬¦ä¸²æ•°æ®æ˜¯è¿ç»­çš„ï¼Œå½“è®¿é—® <code>redisObject</code>æ—¶ï¼Œå­—ç¬¦ä¸²æ•°æ®å¾ˆå¯èƒ½å·²ç»è¢«ä¸€åŒåŠ è½½åˆ°äº†é«˜é€Ÿçš„ CPUç¼“å­˜ä¸­ã€‚ä¸‹æ¬¡å†è®¿é—®å­—ç¬¦ä¸²æ•°æ®æ—¶ï¼Œå°±èƒ½ç›´æ¥ä»ç¼“å­˜å‘½ä¸­ï¼Œé¿å…äº†è®¿é—®æ…¢é€Ÿä¸»å­˜çš„å»¶è¿Ÿã€‚</li></ol><p>æ³¨æ„ï¼š<code>embstr</code>ç¼–ç çš„å­—ç¬¦ä¸²æ˜¯<strong>åªè¯»</strong>çš„ã€‚ä¸€æ—¦ä½ å°è¯•ä¿®æ”¹å®ƒï¼ˆä¾‹å¦‚<code>APPEND</code>ï¼‰ï¼ŒRedis ä¼šç«‹å³å°†å…¶è½¬æ¢ä¸º <code>raw</code>ç¼–ç ï¼Œå› ä¸ºæ— æ³•åœ¨åŸæœ‰çš„è¿ç»­å†…å­˜å—ä¸Šè¿›è¡ŒåŸåœ°æ‰©å®¹ã€‚</p><h3id="obj_encoding_rawé€šç”¨ä¸”çµæ´»çš„æ ‡å‡†æ¨¡å¼">OBJ_ENCODING_RAWï¼šé€šç”¨ä¸”çµæ´»çš„"æ ‡å‡†æ¨¡å¼"</h3><blockquote><p>ä½œä¸ºæœ€é€šç”¨çš„ç¼–ç ï¼Œå¤„ç†æ‰€æœ‰é•¿å­—ç¬¦ä¸²å’Œè¢«ä¿®æ”¹è¿‡çš„çŸ­å­—ç¬¦ä¸²ã€‚</p></blockquote><p>è¿™æ˜¯æ ‡å‡†çš„ SDS å®ç°ï¼Œ<code>redisObject</code> å’Œ <code>sds</code>ç»“æ„é€šè¿‡æŒ‡é’ˆå…³è”ï¼Œåˆ†åˆ«ä½äºä¸åŒçš„å†…å­˜åŒºåŸŸã€‚</p><p>ç”±äºæ•°æ®åŒº (<code>sds</code>) å’Œå…ƒä¿¡æ¯åŒº (<code>redisObject</code>)æ˜¯åˆ†ç¦»çš„ï¼Œå½“å­—ç¬¦ä¸²éœ€è¦å¢é•¿æ—¶ï¼ˆå¦‚ <code>APPEND</code>ï¼‰ï¼Œå¯ä»¥ç‹¬ç«‹åœ°å¯¹<code>sds</code> è¿›è¡Œå†…å­˜é‡åˆ†é…ï¼ˆreallocï¼‰ï¼Œè€Œæ— éœ€è§¦åŠ¨<code>redisObject</code>ã€‚è¿™ä½¿å¾—å¯¹é•¿å­—ç¬¦ä¸²çš„ä¿®æ”¹å˜å¾—é«˜æ•ˆã€‚</p><h3 id="ç¼–ç è½¬æ¢">ç¼–ç è½¬æ¢</h3><pre class="mermaid">flowchart TD    A[å€¼åˆ›å»º] --> B{å€¼çš„ç±»å‹å’Œå†…å®¹}    B -->|"64ä½æ•´æ•°èŒƒå›´"| C[intç¼–ç ]    B -->|"å­—ç¬¦ä¸²ä¸”é•¿åº¦ â‰¤ 44å­—èŠ‚"| D[embstrç¼–ç ]    B -->|"å­—ç¬¦ä¸²ä¸”é•¿åº¦ > 44å­—èŠ‚"| E[rawç¼–ç ]    C --> F{æ“ä½œç±»å‹}    D --> G{æ“ä½œç±»å‹}    E --> H{æ“ä½œç±»å‹}    F -->|"æ•°å€¼è¿ç®— INCR/DECR"| I[ä¿æŒintç¼–ç ]    F -->|"å­—ç¬¦ä¸²æ“ä½œ APPEND/SETRANGE"| J["int â†’ rawè½¬æ¢"]    G -->|"ä»»ä½•ä¿®æ”¹æ“ä½œ"| K["embstr â†’ rawè½¬æ¢"]    G -->|"åªè¯»æ“ä½œ GET"| L[ä¿æŒembstrç¼–ç ]    H -->|"ä»»ä½•æ“ä½œ"| M[ä¿æŒrawç¼–ç ]    J --> N[åˆ†é…rawå†…å­˜]    N --> O[å°†intè½¬æ¢ä¸ºå­—ç¬¦ä¸²]    O --> P[å­˜å‚¨åˆ°rawç»“æ„]    P --> Q[æ›´æ–°redisObject.ptr]    K --> R[åˆ†é…rawå†…å­˜]    R --> S[å¤åˆ¶å­—ç¬¦ä¸²æ•°æ®]    S --> T[é‡Šæ”¾embstrå†…å­˜]    T --> U[æ›´æ–°redisObject.ptr]    style C fill:#e3f2fd,stroke:#2196f3,stroke-width:2px    style D fill:#e8f5e8,stroke:#28a745,stroke-width:2px    style E fill:#ffebee,stroke:#d73a49,stroke-width:2px    style J fill:#fff3cd,stroke:#ffc107,stroke-width:2px    style K fill:#fff3cd,stroke:#ffc107,stroke-width:2px</pre><h2 id="æ­ç§˜-44-ä¸€ä¸ªæ•°å­—èƒŒåçš„ç¡¬æ ¸åŸç†">3. æ­ç§˜ 44ï¼šä¸€ä¸ªæ•°å­—èƒŒåçš„ç¡¬æ ¸åŸç†</h2><p><code>embstr</code> çš„ 44å­—èŠ‚é™åˆ¶ï¼Œå¹¶ééšæ„è®¾å®šï¼Œè€Œæ˜¯ç²¾ç¡®è®¡ç®—çš„ç»“æœã€‚</p><p><strong>æ ¸å¿ƒç›®æ ‡</strong>ï¼šè®©æ•´ä¸ª <code>embstr</code>å¯¹è±¡æ­£å¥½æ”¾å…¥å†…å­˜åˆ†é…å™¨ï¼ˆå¦‚ jemallocï¼‰çš„ <strong>64å­—èŠ‚</strong>å†…å­˜å—ä¸­ï¼Œä»¥æœ€å¤§åŒ–å†…å­˜æ•ˆç‡å’Œ CPU ç¼“å­˜æ€§èƒ½ã€‚</p><p><strong>æ¨å¯¼è¿‡ç¨‹</strong>ï¼š ä¸€ä¸ª 64 å­—èŠ‚çš„å†…å­˜å—ï¼Œéœ€è¦å®¹çº³ï¼š</p><ol type="1"><li><code>redisObject</code> ç»“æ„ä½“ï¼š<strong>16 å­—èŠ‚</strong></li><li><code>sdshdr8</code> å¤´éƒ¨ï¼ˆçŸ­å­—ç¬¦ä¸²ä½¿ç”¨çš„æœ€å° SDS å¤´ï¼‰ï¼š<strong>3å­—èŠ‚</strong></li><li>SDS ç»“å°¾çš„ç©ºå­—ç¬¦ <code>\0</code>ï¼š<strong>1 å­—èŠ‚</strong></li><li>å­—ç¬¦ä¸²å®é™…å†…å®¹ï¼ˆPayloadï¼‰ï¼š<strong>X å­—èŠ‚</strong></li></ol><p>äºæ˜¯ï¼Œæˆ‘ä»¬å¾—åˆ°æ–¹ç¨‹ï¼š</p><p><span class="math display">\[16+3+X+1=64\]</span></p><p>è§£å¾—ï¼š</p><p><span class="math display">\[X=44\]</span></p><p>è¿™é‡Œçš„ <code>X</code>ï¼Œä¹Ÿå°±æ˜¯44ï¼ŒæŒ‡çš„æ˜¯å­—ç¬¦ä¸²å†…å®¹çš„<strong>å­—èŠ‚æ•°</strong>ã€‚å¯¹äºASCIIï¼Œå®ƒç­‰äºå­—ç¬¦æ•°ï¼›ä½†å¯¹äº UTF-8ç­‰å¤šå­—èŠ‚ç¼–ç ï¼Œåˆ™å¿…é¡»è®¡ç®—å…¶å®é™…å ç”¨çš„å­—èŠ‚ã€‚ä¾‹å¦‚ï¼Œ15 ä¸ªä¸­æ–‡å­—ç¬¦ï¼ˆå æ®<span class="math inline">\(15Ã—3=45\)</span> å­—èŠ‚ï¼‰çš„é•¿åº¦è™½ç„¶è¿œå°äº44ï¼Œä½†å…¶å­—èŠ‚æ•°è¶…è¿‡äº†é™åˆ¶ï¼Œå› æ­¤å¿…é¡»ä½¿ç”¨ <code>raw</code> ç¼–ç ã€‚</p><h2 id="å›å½’å®è·µstring-çš„çœŸå®ä¸–ç•Œ">4. å›å½’å®è·µï¼šString çš„çœŸå®ä¸–ç•Œ</h2><p>ç†è®ºçš„æ·±åˆ»ï¼Œæœ€ç»ˆè¦å›å½’å®è·µçš„ä»·å€¼ã€‚æ­£æ˜¯åŸºäºä¸Šè¿°ç²¾å¦™è®¾è®¡ï¼ŒRedis Stringæ‰èƒ½åœ¨çœŸå®ä¸–ç•Œä¸­æ‰®æ¼”å¦‚æ­¤å¤šæ ·çš„è§’è‰²ï¼š</p><ul><li><strong>ç¼“å­˜å±‚</strong>ï¼šç¼“å­˜æ•°æ®åº“æŸ¥è¯¢ç»“æœã€APIå“åº”ï¼Œæ˜¯å…¶æœ€ç»å…¸çš„ç”¨æ³•ã€‚</li><li><strong>åŸå­è®¡æ•°å™¨</strong>ï¼šåˆ©ç”¨ <code>INCR</code>çš„åŸå­æ€§ï¼Œè½»æ¾å®ç°é«˜å¹¶å‘çš„ç½‘ç«™ PVã€æ–‡ç« ç‚¹èµç­‰åŠŸèƒ½ã€‚</li><li><strong>åˆ†å¸ƒå¼é”</strong>ï¼š<code>SET key value EX seconds NX</code>ä¸€è¡Œå‘½ä»¤ï¼Œæ˜¯å®ç°åˆ†å¸ƒå¼é”çš„æœ€æ ¸å¿ƒé€»è¾‘ã€‚</li><li><strong>ä½å›¾ (Bitmap)</strong>ï¼šé€šè¿‡ <code>SETBIT</code> å’Œ<code>BITCOUNT</code>ï¼Œä»¥æå°çš„ç©ºé—´æˆæœ¬å®ç°ç”¨æˆ·ç­¾åˆ°ã€æ—¥æ´»ç»Ÿè®¡ç­‰åŠŸèƒ½ã€‚</li><li><strong>å…±äº«ä¼šè¯</strong>ï¼šåœ¨åˆ†å¸ƒå¼åº”ç”¨ä¸­å­˜å‚¨ç”¨æˆ·Sessionï¼Œç®€å•é«˜æ•ˆã€‚</li></ul>]]></content>
    
    
    <summary type="html">æœ¬ç¯‡åŸºäº Redis 8.2.1 æºç ï¼Œä»ç¬¬ä¸€æ€§åŸç†çœ‹ Redis å­—ç¬¦ä¸²çš„è®¾è®¡å“²å­¦ï¼Œå¸¦ä½ æ·±å…¥ç†è§£ Redis çš„ String æ•°æ®ç±»å‹ã€‚</summary>
    
    
    
    <category term="Redis" scheme="https://hedon.top/categories/Redis/"/>
    
    
    <category term="Redis" scheme="https://hedon.top/tags/Redis/"/>
    
  </entry>
  
  <entry>
    <title>æ¨¡å‹è®­ç»ƒæ ¸å¿ƒæŠ€å·§ï¼šå­¦ä¹ ç‡é¢„çƒ­ã€ä½™å¼¦è¡°å‡ä¸æ¢¯åº¦è£å‰ª</title>
    <link href="https://hedon.top/2025/08/21/llm/guide-to-lr-warmup-cosine-annealing-gradient-clipping/"/>
    <id>https://hedon.top/2025/08/21/llm/guide-to-lr-warmup-cosine-annealing-gradient-clipping/</id>
    <published>2025-08-21T07:30:20.000Z</published>
    <updated>2025-08-25T15:15:59.965Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬ç¯‡æˆ‘ä»¬æ¥æ·±å…¥æ¢è®¨ä¸€ä¸‹å­¦ä¹ ç‡é¢„çƒ­ï¼ˆLearning RateWarmupï¼‰ã€ä½™å¼¦è¡°å‡ï¼ˆCosine Annealingï¼‰å’Œæ¢¯åº¦è£å‰ªï¼ˆGradientClippingï¼‰è¿™ä¸‰ç§åœ¨æ·±åº¦å­¦ä¹ è®­ç»ƒä¸­éå¸¸å®ç”¨çš„ä¼˜åŒ–æŠ€å·§ã€‚</p><p>é¦–å…ˆï¼Œè¿™ä¸‰ä¸ªæŠ€å·§çš„æ ¸å¿ƒç›®æ ‡æ˜¯ä¸€è‡´çš„ï¼š<strong>è®©æ¨¡å‹åœ¨å¤æ‚çš„é«˜ç»´æŸå¤±å‡½æ•°ç©ºé—´ä¸­ï¼Œæ›´ç¨³å®šã€æ›´é«˜æ•ˆåœ°æ‰¾åˆ°ä¸€ä¸ªå¥½çš„è§£ï¼ˆå±€éƒ¨æœ€ä¼˜è§£æˆ–å…¨å±€æœ€ä¼˜è§£ï¼‰</strong>ã€‚</p><p>å®ƒä»¬åˆ†åˆ«ä»ä¸åŒè§’åº¦è§£å†³äº†è®­ç»ƒè¿‡ç¨‹ä¸­å¯èƒ½é‡åˆ°çš„é—®é¢˜ï¼š</p><ul><li><strong>å­¦ä¹ ç‡é¢„çƒ­ (Warmup)</strong>ï¼šè§£å†³è®­ç»ƒåˆæœŸçš„ä¸ç¨³å®šæ€§ã€‚</li><li><strong>ä½™å¼¦è¡°å‡ (CosineAnnealing)</strong>ï¼šè§£å†³è®­ç»ƒä¸­åæœŸçš„ç²¾ç»†è°ƒæ•´å’Œæ”¶æ•›é—®é¢˜ã€‚</li><li><strong>æ¢¯åº¦è£å‰ª (GradientClipping)</strong>ï¼šè§£å†³è®­ç»ƒè¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°çš„æ¢¯åº¦çˆ†ç‚¸é—®é¢˜ï¼Œå……å½“â€œå®‰å…¨å¸¦â€ã€‚</li></ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬é€ä¸€è§£æã€‚</p><h2 id="å­¦ä¹ ç‡é¢„çƒ­-learning-rate-warmup">å­¦ä¹ ç‡é¢„çƒ­ (Learning RateWarmup)</h2><h3 id="ç»“è®ºå…ˆè¡Œ">ç»“è®ºå…ˆè¡Œ</h3><p>åœ¨è®­ç»ƒå¼€å§‹çš„å‡ ä¸ªå‘¨æœŸï¼ˆepochï¼‰æˆ–è¿­ä»£ï¼ˆstepï¼‰å†…ï¼Œå°†å­¦ä¹ ç‡ï¼ˆLearningRateï¼‰ä»ä¸€ä¸ªéå¸¸å°çš„å€¼ï¼ˆä¾‹å¦‚0ï¼‰çº¿æ€§æˆ–éçº¿æ€§åœ°å¢åŠ åˆ°é¢„è®¾çš„åˆå§‹å­¦ä¹ ç‡ã€‚é¢„çƒ­é˜¶æ®µç»“æŸåï¼Œå†é‡‡ç”¨é¢„è®¾çš„å­¦ä¹ ç‡è¡°å‡ç­–ç•¥ï¼ˆå¦‚ä½™å¼¦è¡°å‡ï¼‰ã€‚</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250821155358300.png" style="zoom: 33%;" /></p><h3 id="æœ¬è´¨æ˜¯ä»€ä¹ˆ">æœ¬è´¨æ˜¯ä»€ä¹ˆ</h3><p>åœ¨è®­ç»ƒä¹‹åˆï¼Œæ¨¡å‹çš„æƒé‡æ˜¯éšæœºåˆå§‹åŒ–çš„ï¼Œå¯ä»¥è¯´å®ƒå¯¹æ•°æ®ä¸€æ— æ‰€çŸ¥ã€‚å¦‚æœæ­¤æ—¶ç›´æ¥ç”¨ä¸€ä¸ªè¾ƒå¤§çš„å­¦ä¹ ç‡ï¼ˆLearningRateï¼‰ï¼Œå°±å¥½æ¯”è®©ä¸€ä¸ªæ–°æ‰‹å¸æœºä¸Šæ¥å°±è¸©æ»¡æ²¹é—¨ï¼Œç»“æœå¾ˆå¯èƒ½æ˜¯è½¦è¾†å¤±æ§ï¼ˆæ¨¡å‹å‚æ•°è¢«å¸¦åˆ°å¾ˆå·®çš„ç©ºé—´ï¼‰ï¼Œå¯¼è‡´è®­ç»ƒåˆæœŸçš„å‰§çƒˆéœ‡è¡ï¼Œç”šè‡³æ— æ³•æ”¶æ•›ã€‚</p><p>å­¦ä¹ ç‡é¢„çƒ­å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å®ƒåœ¨è®­ç»ƒå¼€å§‹çš„å‡ ä¸ªå‘¨æœŸï¼ˆepochï¼‰æˆ–è¿­ä»£ï¼ˆstepï¼‰å†…ï¼Œå°†å­¦ä¹ ç‡ä»ä¸€ä¸ªéå¸¸å°çš„å€¼ï¼ˆç”šè‡³æ˜¯0ï¼‰é€æ­¥æå‡åˆ°ä½ é¢„è®¾çš„åˆå§‹å­¦ä¹ ç‡ã€‚</p><p>å®ƒçš„æœ¬è´¨æ˜¯<strong>åœ¨æ¨¡å‹å°šæœªç¨³å®šæ—¶ï¼Œé€šè¿‡æ§åˆ¶æ›´æ–°æ­¥é•¿æ¥å¢åŠ è®­ç»ƒçš„ç¨³å®šæ€§</strong>ã€‚</p><p>è¿™æ˜¯ä¸€ç§ "å…ˆæ…¢åå¿«"çš„ç­–ç•¥ã€‚å®ƒæ‰¿è®¤äº†æ¨¡å‹åœ¨è®­ç»ƒåˆæœŸå¤„äºä¸€ä¸ªéå¸¸ä¸ç¨³å®šçš„çŠ¶æ€ï¼Œå› æ­¤éœ€è¦ä¸€ä¸ªç¼“å†²æœŸã€‚é€šè¿‡è¿™ä¸ªç¼“å†²æœŸï¼Œæ¨¡å‹å¯ä»¥å®‰å…¨åœ°åº¦è¿‡æœ€ä¸ç¨³å®šçš„é˜¶æ®µï¼Œä¸ºåç»­é«˜æ•ˆçš„è®­ç»ƒæ‰“ä¸‹åšå®çš„åŸºç¡€ã€‚</p><h3 id="å¥½å¤„æœ‰å“ªäº›">å¥½å¤„æœ‰å“ªäº›</h3><ol type="1"><li><strong>é˜²æ­¢æ¨¡å‹åœ¨è®­ç»ƒåˆæœŸ"éœ‡è¡"æˆ–"å‘æ•£"</strong>ï¼šåœ¨è®­ç»ƒåˆšå¼€å§‹æ—¶ï¼Œæ¨¡å‹çš„æƒé‡æ˜¯éšæœºåˆå§‹åŒ–çš„ï¼Œå®ƒä»¬è·ç¦»æœ€ä¼˜è§£éå¸¸é¥è¿œã€‚æ­¤æ—¶å¦‚æœç›´æ¥ä½¿ç”¨ä¸€ä¸ªè¾ƒå¤§çš„å­¦ä¹ ç‡ï¼Œæ¢¯åº¦æ›´æ–°çš„æ­¥å­ä¼šè¿ˆå¾—å¾ˆå¤§ã€‚è¿™å°±åƒåœ¨ä¸€å¼ å´å²–ä¸å¹³çš„åœ°å›¾ä¸Šè’™çœ¼å¯»å®ï¼Œä¸€å¼€å§‹å°±çŒ›å†²ä¸€æ­¥ï¼Œå¾ˆå¯èƒ½ä¼šç›´æ¥å†²è¿›ä¸€ä¸ªå¾ˆå·®çš„åŒºåŸŸï¼ˆæŸå¤±å‡½æ•°çš„â€œæ‚¬å´–â€ï¼‰ï¼Œå¯¼è‡´æŸå¤±å‰§å¢ï¼Œæ¨¡å‹éš¾ä»¥æ”¶æ•›ã€‚</li><li><strong>ç»™æ¨¡å‹æ—¶é—´é€‚åº”æ•°æ®</strong>ï¼šåœ¨è®­ç»ƒåˆæœŸï¼Œæ¨¡å‹å¯¹æ•°æ®è¿˜æ²¡æœ‰ä»»ä½•è®¤çŸ¥ã€‚ä¸€ä¸ªè¾ƒå°çš„å­¦ä¹ ç‡å¯ä»¥è®©æ¨¡å‹"æ¸©æŸ”"åœ°å¼€å§‹å­¦ä¹ ï¼Œé€æ¸é€‚åº”æ•°æ®çš„åˆ†å¸ƒï¼Œç¨³å®šåœ°å­¦ä¹ åˆ°ä¸€äº›æµ…å±‚çš„ã€é²æ£’çš„ç‰¹å¾ã€‚ç­‰æ¨¡å‹å¯¹æ•°æ®æœ‰äº†ä¸€å®šçš„"æ„Ÿè§‰"åï¼Œå†å¢å¤§å­¦ä¹ ç‡è¿›è¡Œå¿«é€Ÿä¼˜åŒ–ï¼Œæ•ˆæœä¼šæ›´å¥½ã€‚</li></ol><h3 id="å¦‚ä½•è¯„ä¼°é¢„çƒ­æ­¥æ•°">å¦‚ä½•è¯„ä¼°é¢„çƒ­æ­¥æ•°</h3><p>è®¾å®šé¢„çƒ­æ­¥æ•°çš„æ ¸å¿ƒåŸåˆ™æ˜¯ï¼š<strong>ç¡®ä¿åœ¨å­¦ä¹ ç‡è¾¾åˆ°å…¶æœ€å¤§å€¼æ—¶ï¼Œæ¨¡å‹çš„è®­ç»ƒå·²ç»è¿›å…¥äº†ä¸€ä¸ªç›¸å¯¹ç¨³å®šçš„çŠ¶æ€</strong>ã€‚</p><ul><li><strong>å¤ªçŸ­çš„é¢„çƒ­</strong>ï¼šå­¦ä¹ ç‡å¾ˆå¿«å°±ä¸Šå‡åˆ°æœ€å¤§å€¼ï¼Œæ­¤æ—¶æ¨¡å‹å¯èƒ½è¿˜æ²¡æ¥å¾—åŠ"é€‚åº”"æ•°æ®ï¼Œä¾ç„¶å¤„äºéå¸¸ä¸ç¨³å®šçš„çŠ¶æ€ã€‚è¿™å¯èƒ½ä¼šå¯¼è‡´è®­ç»ƒåˆæœŸçš„æŸå¤±å‡ºç°å‰§çƒˆéœ‡è¡ç”šè‡³ä¸æ”¶æ•›ï¼Œé¢„çƒ­çš„æ•ˆæœå¤§æ‰“æŠ˜æ‰£ã€‚</li><li><strong>å¤ªé•¿çš„é¢„çƒ­</strong>ï¼šæ¨¡å‹åœ¨å¾ˆé•¿ä¸€æ®µæ—¶é—´å†…éƒ½ä½¿ç”¨éå¸¸å°çš„å­¦ä¹ ç‡è¿›è¡Œè®­ç»ƒï¼Œæ”¶æ•›é€Ÿåº¦è¿‡æ…¢ï¼Œæµªè´¹äº†å¤§é‡çš„è®¡ç®—èµ„æºå’Œæ—¶é—´ã€‚</li></ul><p>æˆ‘ä»¬çš„ç›®æ ‡å°±æ˜¯åœ¨è¿™ä¸¤è€…ä¹‹é—´æ‰¾åˆ°ä¸€ä¸ªå¹³è¡¡ç‚¹ã€‚</p><h4 id="å‰äººç»éªŒ">å‰äººç»éªŒ</h4><p>åœ¨å®è·µä¸­ï¼Œé¢„çƒ­æ­¥æ•°é€šå¸¸æœ‰ä¸¤ç§è®¾å®šæ–¹å¼ï¼š</p><p><strong>1.æŒ‰è®­ç»ƒæ€»æ­¥æ•°çš„æ¯”ä¾‹è®¾å®š</strong>ï¼šè¿™æ˜¯æœ€å¸¸ç”¨ã€ä¹Ÿæœ€æ¨èçš„ä¸€ç§æ–¹æ³•ã€‚å®ƒå°†é¢„çƒ­é˜¶æ®µçš„é•¿åº¦ä¸æ•´ä¸ªè®­ç»ƒè¿‡ç¨‹çš„é•¿åº¦åŠ¨æ€åœ°å…³è”èµ·æ¥ã€‚</p><ul><li><strong>ç»éªŒæ³•åˆ™</strong>ï¼šé€šå¸¸å°† <strong>æ€»è®­ç»ƒæ­¥æ•°çš„ 6% -10%</strong> ä½œä¸ºé¢„çƒ­æ­¥æ•°ã€‚</li><li><strong>ä¸ºä»€ä¹ˆæœ‰æ•ˆ</strong>ï¼šè¿™ä¸ªæ¯”ä¾‹ç¡®ä¿äº†æ— è®ºä½ çš„æ€»è®­ç»ƒæ—¶é—´æ˜¯é•¿æ˜¯çŸ­ï¼Œé¢„çƒ­éƒ½åªå å…¶ä¸­ä¸€å°éƒ¨åˆ†ï¼Œæ—¢èƒ½èµ·åˆ°ç¨³å®šä½œç”¨ï¼Œåˆä¸ä¼šæ‹–æ…¢æ•´ä½“è¿›åº¦ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ è®¡åˆ’æ€»å…±è®­ç»ƒ<code>100,000</code> æ­¥ï¼Œé‚£ä¹ˆè®¾ç½® <code>6,000</code> åˆ°<code>10,000</code>æ­¥çš„é¢„çƒ­æ˜¯ä¸€ä¸ªéå¸¸åˆç†çš„èµ·ç‚¹ã€‚</li><li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šéå¸¸é€‚åˆè®­ç»ƒå¤§å‹æ¨¡å‹ï¼ˆå¦‚ BERT,GPTï¼‰æˆ–åœ¨å¤§å‹æ•°æ®é›†ä¸Šä»å¤´å¼€å§‹è®­ç»ƒã€‚</li></ul><p><strong>2.æŒ‰å›ºå®šçš„å‘¨æœŸæ•°ï¼ˆEpochsï¼‰è®¾å®š</strong>ï¼šå¯¹äºæŸäº›æ•°æ®é›†å’Œè®­ç»ƒæµç¨‹ï¼ŒæŒ‰Epoch è®¾å®šæ›´ä¸ºç›´è§‚ã€‚</p><ul><li><strong>ç»éªŒæ³•åˆ™</strong>ï¼šé€šå¸¸è®¾ç½®ä¸º <strong>1 åˆ° 2 ä¸ªEpoch</strong>ã€‚</li><li><strong>ä¸ºä»€ä¹ˆæœ‰æ•ˆ</strong>ï¼šä¸€ä¸ª Epochæ„å‘³ç€æ¨¡å‹å·²ç»å®Œæ•´åœ°çœ‹è¿‡ä¸€éæ‰€æœ‰è®­ç»ƒæ•°æ®ã€‚ç»è¿‡ä¸€è½®å®Œæ•´çš„â€œé˜…è§ˆâ€ï¼Œæ¨¡å‹é€šå¸¸å·²ç»åˆæ­¥é€‚åº”äº†æ•°æ®åˆ†å¸ƒï¼Œæ­¤æ—¶å†æå‡åˆ°æœ€å¤§å­¦ä¹ ç‡æ˜¯æ¯”è¾ƒå®‰å…¨çš„ã€‚</li><li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šå½“æ•°æ®é›†ä¸æ˜¯ç‰¹åˆ«å·¨å¤§ï¼Œæˆ–è€…åœ¨è¿›è¡Œå¾®è°ƒï¼ˆFine-tuningï¼‰ä»»åŠ¡æ—¶ï¼Œè¿™ç§æ–¹æ³•ç®€å•æœ‰æ•ˆã€‚</li></ul><h4 id="å®è·µæ˜¯æ£€éªŒçœŸç†çš„å”¯ä¸€æ ‡å‡†">å®è·µæ˜¯æ£€éªŒçœŸç†çš„å”¯ä¸€æ ‡å‡†</h4><p>å½“ç„¶ï¼Œä¸Šè¿° 2 ä¸ªæ–¹æ¡ˆéƒ½æ˜¯ç»éªŒå€¼ï¼Œæœ€å¥½çš„æ–¹æ³•è¿˜æ˜¯é€šè¿‡å®éªŒæ¥éªŒè¯ â€”â€”è¯„ä¼°é¢„çƒ­æ­¥æ•°æ˜¯å¦åˆé€‚çš„æœ€ä½³æŒ‡æ ‡å°±æ˜¯ <strong>è®­ç»ƒåˆæœŸçš„æŸå¤±æ›²çº¿ (LossCurve)</strong>ã€‚</p><ol type="1"><li><strong>é€‰æ‹©ä¸€ä¸ªåŸºå‡†å€¼</strong>ï¼šæ ¹æ®ä¸Šé¢çš„ç»éªŒæ³•åˆ™ï¼Œé€‰æ‹©ä¸€ä¸ªèµ·å§‹å€¼ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ åœ¨å¾®è°ƒä¸€ä¸ªBERT æ¨¡å‹ï¼Œå¯ä»¥å…ˆå°è¯• <code>1 epoch</code> çš„é¢„çƒ­ã€‚</li><li><strong>è§‚å¯ŸæŸå¤±æ›²çº¿</strong>ï¼šå¼€å§‹è®­ç»ƒï¼Œå¹¶å¯†åˆ‡å…³æ³¨è®­ç»ƒæ—¥å¿—ä¸­å‰å‡ ä¸ªEpoch çš„æŸå¤±å˜åŒ–ã€‚<ul><li><strong>ç†æƒ³çš„æ›²çº¿</strong>ï¼šåœ¨é¢„çƒ­é˜¶æ®µï¼ŒæŸå¤±å¹³ç¨³ä¸‹é™ã€‚é¢„çƒ­ç»“æŸåï¼Œå­¦ä¹ ç‡è¾¾åˆ°æœ€å¤§å€¼ï¼ŒæŸå¤±å¼€å§‹åŠ é€Ÿä¸‹é™ï¼Œæ•´ä¸ªè¿‡ç¨‹å¹³æ»‘è¿‡æ¸¡ï¼Œæ²¡æœ‰å‡ºç°å‰§çƒˆçš„å°–å³°æˆ–æŠ–åŠ¨ã€‚</li><li><strong>é¢„çƒ­å¯èƒ½è¿‡çŸ­çš„è¿¹è±¡</strong>ï¼šé¢„çƒ­ç»“æŸåï¼ŒæŸå¤±çªç„¶å‡ºç°ä¸€ä¸ªæ˜æ˜¾çš„<strong>å°–å³°(Spike)</strong>ï¼Œæˆ–è€…å¼€å§‹å‰§çƒˆéœ‡è¡ï¼Œç„¶åæ‰æ…¢æ…¢æ¢å¤ä¸‹é™ã€‚è¿™è¯´æ˜å­¦ä¹ ç‡å¢é•¿è¿‡å¿«ï¼Œæ¨¡å‹æ²¡èƒ½å¹³ç¨³è¿‡æ¸¡ã€‚</li><li><strong>é¢„çƒ­å¯èƒ½è¿‡é•¿çš„è¿¹è±¡</strong>ï¼šæŸå¤±æ›²çº¿åœ¨å¼€å§‹çš„ç›¸å½“é•¿ä¸€æ®µæ—¶é—´å†…ä¸‹é™å¾—æä¸ºç¼“æ…¢ï¼Œå‡ ä¹æ˜¯ä¸€æ¡å¹³çº¿ã€‚è¿™è¯´æ˜æ¨¡å‹åœ¨ç”¨ä¸€ä¸ªè¿‡å°çš„å­¦ä¹ ç‡â€œæµªè´¹æ—¶é—´â€ã€‚</li></ul></li><li><strong>è°ƒæ•´å¹¶å¯¹æ¯”</strong>ï¼š<ul><li>å¦‚æœå‘ç°æŸå¤±æœ‰å°–å³°ï¼Œ<strong>å¢åŠ </strong> é¢„çƒ­æ­¥æ•°ï¼ˆä¾‹å¦‚ä» 1 epochå¢åŠ åˆ° 2 epochsï¼‰ã€‚</li><li>å¦‚æœå‘ç°åˆå§‹æ”¶æ•›å¤ªæ…¢ï¼Œå¯ä»¥å°è¯• <strong>å‡å°‘</strong> é¢„çƒ­æ­¥æ•°ã€‚</li></ul></li></ol><p>é€šè¿‡å‡ æ¬¡çŸ­æ—¶é—´çš„å®éªŒï¼ˆä¸éœ€è¦è·‘å®Œæ•´ä¸ªè®­ç»ƒï¼Œè§‚å¯Ÿå‰å‡ ä¸ª epochå³å¯ï¼‰ï¼Œä½ å°±èƒ½å¾ˆå¿«åœ°ä¸ºä½ çš„ç‰¹å®šä»»åŠ¡æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„é¢„çƒ­æ­¥æ•°èŒƒå›´ã€‚</p><h4 id="æ¨èæ–¹æ¡ˆ">æ¨èæ–¹æ¡ˆ</h4><table><colgroup><col style="width: 40%" /><col style="width: 35%" /><col style="width: 24%" /></colgroup><thead><tr><th>åœºæ™¯</th><th>æ¨èçš„èµ·å§‹ç­–ç•¥</th><th>è¯„ä¼°æ–¹æ³•</th></tr></thead><tbody><tr><td><strong>å¤§å‹æ¨¡å‹ä»å¤´è®­ç»ƒ</strong> (e.g., GPT, BERT on largecorpus)</td><td>å°†æ€»è®­ç»ƒæ­¥æ•°çš„ <strong>10%</strong> ä½œä¸ºé¢„çƒ­æ­¥æ•°ã€‚</td><td>è§‚å¯ŸæŸå¤±æ›²çº¿æ˜¯å¦å¹³æ»‘ï¼Œæ²¡æœ‰å°–å³°ã€‚</td></tr><tr><td><strong>ä¸­å°å‹æ¨¡å‹çš„å¾®è°ƒ</strong> (e.g., Fine-tuning ResNet on acustom dataset)</td><td><strong>1 åˆ° 2 ä¸ª Epoch</strong> å¯¹åº”çš„æ­¥æ•°ã€‚</td><td>è§‚å¯ŸæŸå¤±æ›²çº¿ï¼Œç¡®ä¿é¢„çƒ­ç»“æŸåèƒ½å¿«é€Ÿæ”¶æ•›ã€‚</td></tr><tr><td><strong>ä¸ç¡®å®šå¦‚ä½•é€‰æ‹©æ—¶</strong></td><td><strong>ä» 1 ä¸ª Epochå¼€å§‹</strong>ï¼Œè¿™é€šå¸¸æ˜¯ä¸€ä¸ªå®‰å…¨ä¸”ä¸ä¼šå¤ªæ…¢çš„é€‰æ‹©ã€‚</td><td>é€šè¿‡çŸ­æ—¶å®éªŒï¼Œè§‚å¯ŸæŸå¤±æ›²çº¿å¹¶è¿›è¡Œå¾®è°ƒã€‚</td></tr></tbody></table><h2 id="ä½™å¼¦è¡°å‡-cosine-annealing">ä½™å¼¦è¡°å‡ (Cosine Annealing)</h2><h3 id="ç»“è®ºå…ˆè¡Œ-1">ç»“è®ºå…ˆè¡Œ</h3><p>ä¸€ç§å­¦ä¹ ç‡çš„è¡°å‡ç­–ç•¥ã€‚å®ƒä¸åƒä¼ ç»Ÿçš„æ­¥è¿›å¼è¡°å‡ï¼ˆStep Decayï¼Œä¾‹å¦‚æ¯ 30ä¸ª epoch å­¦ä¹ ç‡ä¹˜ä»¥0.1ï¼‰é‚£æ ·æ˜¯è·³å´–å¼ä¸‹é™ï¼Œè€Œæ˜¯è®©å­¦ä¹ ç‡éšç€è®­ç»ƒçš„è¿›è¡Œï¼Œåƒä½™å¼¦å‡½æ•°<code>cos(x)</code> åœ¨ <code>[0, Ï€/2]</code>åŒºé—´ä¸€æ ·ï¼Œå¹³æ»‘åœ°ä»åˆå§‹å€¼ä¸‹é™åˆ°æ¥è¿‘ 0ã€‚</p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250821155626400.png" style="zoom:33%;" /></p><h3 id="æœ¬è´¨æ˜¯ä»€ä¹ˆ-1">æœ¬è´¨æ˜¯ä»€ä¹ˆ</h3><p>å½“æ¨¡å‹è®­ç»ƒè¿›å…¥ä¸­åæœŸï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦é™ä½å­¦ä¹ ç‡ï¼Œå¸®åŠ©æ¨¡å‹åœ¨æœ€ä¼˜ç‚¹é™„è¿‘è¿›è¡Œæ›´ç²¾ç»†çš„æœç´¢ã€‚ä¼ ç»Ÿçš„æ­¥è¿›å¼è¡°å‡è™½ç„¶æœ‰æ•ˆï¼Œä½†å…¶"è·³å´–å¼"çš„ä¸‹é™æ–¹å¼æœ‰æ—¶è¿‡äºç²—æš´ã€‚</p><p>ä½™å¼¦è¡°å‡æä¾›äº†ä¸€ç§æ›´ä¼˜é›…çš„æ–¹æ¡ˆã€‚å®ƒè®©å­¦ä¹ ç‡éšç€è®­ç»ƒçš„è¿›è¡Œï¼Œåƒä½™å¼¦å‡½æ•°ä¸€æ ·å¹³æ»‘åœ°ä»åˆå§‹å€¼ä¸‹é™åˆ°æ¥è¿‘0ã€‚</p><p>å®ƒçš„æœ¬è´¨æ˜¯ï¼š<strong>ä¸€ç§ "å…ˆæ¢ç´¢ï¼Œåç²¾è°ƒ"çš„åŠ¨æ€è°ƒæ•´ç­–ç•¥</strong>ã€‚</p><ul><li><strong>å‰æœŸ/ä¸­æœŸ</strong>ï¼šå­¦ä¹ ç‡ä¸‹é™ç¼“æ…¢ï¼Œä¿æŒç›¸å¯¹è¾ƒé«˜çš„å€¼ï¼Œè®©æ¨¡å‹æœ‰èƒ½åŠ›è·³å‡ºå±€éƒ¨é™·é˜±ï¼Œæ¢ç´¢æ›´å¹¿é˜”çš„ç©ºé—´ã€‚</li><li><strong>åæœŸ</strong>ï¼šå­¦ä¹ ç‡ä¸‹é™åŠ é€Ÿï¼Œè®©æ¨¡å‹èƒ½ä»¥æ›´å°çš„æ­¥é•¿åœ¨æœ€ä¼˜è§£é™„è¿‘ç²¾ç»†å¾®è°ƒã€‚</li></ul><blockquote><p>è¿™å°±åƒé£æœºé™è½ã€‚é£è¡Œå‘˜ä¸ä¼šåœ¨åˆ°è¾¾ç›®çš„åœ°åç›´æ¥å…³é—­å¼•æ“ï¼ˆæ­¥è¿›è¡°å‡ï¼‰ï¼Œè€Œæ˜¯ä¼šæ²¿ç€å¹³æ»‘çš„ä¸‹æ»‘æ›²çº¿ï¼ˆä½™å¼¦æ›²çº¿ï¼‰é€æ¸é™ä½é€Ÿåº¦å’Œé«˜åº¦ï¼Œæœ€ç»ˆå®ç°å¹³ç¨³ç€é™†ã€‚</p></blockquote><h3 id="å¥½å¤„æœ‰å“ªäº›-1">å¥½å¤„æœ‰å“ªäº›</h3><ol type="1"><li><strong>é¿å…åœ¨æ¥è¿‘æœ€ä¼˜ç‚¹æ—¶æ¥å›éœ‡è¡</strong>ï¼šåœ¨è®­ç»ƒåæœŸï¼Œæ¨¡å‹å·²ç»éå¸¸æ¥è¿‘æœ€ä¼˜è§£ã€‚æ­¤æ—¶å¦‚æœå­¦ä¹ ç‡ä¾ç„¶è¾ƒå¤§ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ¨¡å‹åœ¨æœ€ä¼˜è§£é™„è¿‘æ¥å›è·³åŠ¨ï¼Œå§‹ç»ˆæ— æ³•ç²¾ç¡®æ”¶æ•›ã€‚ä½™å¼¦è¡°å‡é€šè¿‡ç¼“æ…¢ã€å¹³æ»‘åœ°é™ä½å­¦ä¹ ç‡ï¼Œä½¿å¾—æ¨¡å‹èƒ½å¤Ÿä»¥æ›´å°çš„æ­¥é•¿ï¼Œæ›´ç²¾ç»†åœ°åœ¨æœ€ä¼˜ç‚¹é™„è¿‘è¿›è¡Œæœç´¢ï¼Œä»è€Œæ›´å®¹æ˜“æ‰¾åˆ°é‚£ä¸ªè°·åº•ã€‚</li><li><strong>åœ¨è¾ƒé•¿æ—¶é—´å†…ç»´æŒç›¸å¯¹è¾ƒå¤§çš„å­¦ä¹ ç‡</strong>ï¼šä¸æ­¥è¿›å¼è¡°å‡ç›¸æ¯”ï¼Œä½™å¼¦è¡°å‡åœ¨å‰æœŸå’Œä¸­æœŸä¸‹é™å¾—æ›´æ…¢ã€‚è¿™æ„å‘³ç€æ¨¡å‹æœ‰æ›´é•¿çš„æ—¶é—´åœ¨æŸå¤±ç©ºé—´ä¸­è¿›è¡Œæ¢ç´¢ï¼Œè¿™æœ‰åŠ©äºå®ƒè·³å‡ºä¸€äº›ä¸å¥½çš„å±€éƒ¨æœ€ä¼˜è§£ï¼ˆsaddlepoints or poor local minimaï¼‰ï¼Œå»å¯»æ‰¾ä¸€ä¸ªæ›´å¥½çš„è§£ã€‚</li></ol><h2 id="æ¢¯åº¦è£å‰ª-gradient-clipping">æ¢¯åº¦è£å‰ª (Gradient Clipping)</h2><h3 id="ç»“è®ºå…ˆè¡Œ-2">ç»“è®ºå…ˆè¡Œ</h3><p>åœ¨è¿›è¡Œæ¢¯åº¦ä¸‹é™æ›´æ–°æƒé‡ä¹‹å‰ï¼Œè®¾å®šä¸€ä¸ªæ¢¯åº¦çš„é˜ˆå€¼ã€‚å¦‚æœå½“å‰è®¡ç®—å‡ºçš„æ¢¯åº¦å‘é‡çš„L2èŒƒæ•°ï¼ˆå¯ä»¥ç†è§£ä¸ºæ¢¯åº¦çš„"é•¿åº¦"æˆ–"å¤§å°"ï¼‰è¶…è¿‡äº†è¿™ä¸ªé˜ˆå€¼ï¼Œå°±æŒ‰æ¯”ä¾‹ç¼©å°è¿™ä¸ªæ¢¯åº¦å‘é‡ï¼Œä½¿å…¶èŒƒæ•°æ°å¥½ç­‰äºè¯¥é˜ˆå€¼ã€‚</p><p>$$ ||g|| &gt; : \ g g</p><p>$$</p><p>å…¶ä¸­ <span class="math inline">\(g\)</span> æ˜¯æ¢¯åº¦å‘é‡ï¼Œ<spanclass="math inline">\(||g||\)</span> æ˜¯å®ƒçš„ L2 èŒƒæ•°ï¼Œä¹Ÿç§°ä¸ºæ¬§å‡ é‡Œå¾—èŒƒæ•°(Euclidean Norm)ï¼Œå…¬å¼å¦‚ä¸‹ï¼š</p><p><span class="math display">\[||\vec{x}||_2 = \sqrt{x_1^2 + x_2^2 + \dots + x_n^2}\]</span></p><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/gradient-clipping-example.jpg" style="zoom:33%;" /></p><h3 id="æœ¬è´¨æ˜¯ä»€ä¹ˆ-2">æœ¬è´¨æ˜¯ä»€ä¹ˆ</h3><p>åœ¨æ·±åº¦ç½‘ç»œï¼ˆå°¤å…¶æ˜¯ RNN,Transformerï¼‰ä¸­ï¼Œæ¢¯åº¦åœ¨åå‘ä¼ æ’­è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå› ä¸ºè¿ä¹˜æ•ˆåº”è€Œå˜å¾—å¼‚å¸¸å·¨å¤§ï¼Œè¿™å°±æ˜¯<strong>æ¢¯åº¦çˆ†ç‚¸ (ExplodingGradients)</strong>ã€‚ä¸€æ¬¡æ¢¯åº¦çˆ†ç‚¸å¸¦æ¥çš„æƒé‡æ›´æ–°å¯èƒ½æ˜¯æ¯ç­æ€§çš„ï¼Œå®ƒä¼šç¬é—´æ‘§æ¯æ¨¡å‹å­¦åˆ°çš„æ‰€æœ‰çŸ¥è¯†ï¼Œå¯¼è‡´æŸå¤±å˜ä¸º<code>NaN</code>ã€‚</p><p>æ¢¯åº¦è£å‰ª (Gradient Clipping)å°±æ˜¯é˜²æ­¢è¿™ç§ç¾éš¾çš„"å®‰å…¨å¸¦"ã€‚å®ƒä¸ºæ¢¯åº¦çš„å¤§å°è®¾å®šä¸€ä¸ªä¸Šé™ï¼Œå¦‚æœæŸæ¬¡è®¡ç®—å‡ºçš„æ¢¯åº¦è¶…è¿‡äº†è¿™ä¸ªä¸Šé™ï¼Œå°±å°†å…¶æŒ‰æ¯”ä¾‹ç¼©å°ï¼Œä½†<strong>ä¿æŒå…¶æ–¹å‘ä¸å˜</strong>ã€‚</p><p>å®ƒçš„æœ¬è´¨æ˜¯ï¼š<strong>ä¸ºè®­ç»ƒè¿‡ç¨‹å¢åŠ ä¸€ä¸ªå®‰å…¨çº¦æŸï¼Œç‰ºç‰²æç«¯æƒ…å†µä¸‹çš„ç†è®ºæœ€ä¼˜æ›´æ–°ï¼Œæ¢å–æ•´ä¸ªè®­ç»ƒè¿‡ç¨‹çš„ç¨³å®šæ€§å’Œé²æ£’æ€§ã€‚</strong></p><h3 id="æœ‰ä»€ä¹ˆå¥½å¤„">æœ‰ä»€ä¹ˆå¥½å¤„</h3><p>è¿™ä¸ªé—®é¢˜çš„æ ¸å¿ƒåœ¨äº <strong>é•¿è·ç¦»ä¾èµ– (Long-termDependencies)</strong> å’Œ <strong>æ·±åº¦ï¼ˆå±‚æ•°ï¼‰</strong>ã€‚</p><p>åœ¨åƒ RNN æˆ– Transformerè¿™æ ·çš„æ¨¡å‹ä¸­ï¼Œä¿¡æ¯éœ€è¦åœ¨å¾ˆé•¿çš„æ—¶é—´æ­¥æˆ–å¾ˆæ·±çš„å±‚çº§ä¹‹é—´ä¼ é€’ã€‚åœ¨åå‘ä¼ æ’­è®¡ç®—æ¢¯åº¦æ—¶ï¼Œæ ¹æ®é“¾å¼æ³•åˆ™ï¼Œæ¢¯åº¦ä¼šæ¶‰åŠåˆ°ä¸€ç³»åˆ—é›…å¯æ¯”çŸ©é˜µï¼ˆJacobianMatrixï¼‰çš„è¿ä¹˜ã€‚</p><p><span class="math display">\[\frac{\partial L}{\partial h_t} = \frac{\partial L}{\partial h_{t+k}}\cdot \frac{\partial h_{t+k}}{\partial h_{t+k-1}} \cdots \frac{\partialh_{t+1}}{\partial h_t}\]</span></p><ul><li>å¦‚æœè¿™äº›çŸ©é˜µçš„èŒƒæ•°æŒç»­å¤§äº1ï¼Œé‚£ä¹ˆè¿ä¹˜çš„ç»“æœå°±ä¼šå‘ˆæŒ‡æ•°çº§å¢é•¿ï¼Œå¯¼è‡´æ¢¯åº¦çˆ†ç‚¸ã€‚</li><li>å¦‚æœæŒç»­å°äº 1ï¼Œåˆ™ä¼šå¯¼è‡´æ¢¯åº¦æ¶ˆå¤±ã€‚</li></ul><p>æ¢¯åº¦è£å‰ªæ­£æ˜¯ä¸ºäº†å¤„ç†å‰ä¸€ç§æƒ…å†µã€‚RNNå› ä¸ºåœ¨æ—¶é—´ç»´åº¦ä¸Šå…±äº«æƒé‡ï¼Œè¿™ç§è¿ä¹˜æ•ˆåº”å°¤å…¶æ˜¾è‘—ã€‚Transformerè™½ç„¶æ²¡æœ‰æ—¶é—´ä¸Šçš„å¾ªç¯ï¼Œä½†å…¶éå¸¸æ·±çš„ç½‘ç»œç»“æ„ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªæ¥ä¸€ä¸ªçš„self-attention å’Œ FFNblockï¼‰åŒæ ·ä¼šå½¢æˆå¾ˆé•¿çš„è®¡ç®—è·¯å¾„ï¼Œä½¿å¾—æ¢¯åº¦åœ¨åå‘ä¼ æ’­æ—¶ä¹Ÿå®¹æ˜“å‡ºç°çˆ†ç‚¸æˆ–æ¶ˆå¤±çš„é—®é¢˜ã€‚</p><p>æ¢¯åº¦è£å‰ªé€šè¿‡è®¾å®šä¸€ä¸ªä¸Šé™ï¼Œç¡®ä¿å•æ¬¡æ›´æ–°çš„æ­¥é•¿ä¸ä¼šè¿‡å¤§ï¼Œä»è€Œé˜²æ­¢äº†è¿™ç§ç¾éš¾æ€§äº‹ä»¶çš„å‘ç”Ÿã€‚</p><h3 id="è£å‰ªæ–¹å¼">è£å‰ªæ–¹å¼</h3><p>å‰é¢æˆ‘ä»¬çš„æè¿°ä¸­é»˜è®¤çš„è£å‰ªæ–¹å¼æ˜¯ï¼š<strong>èŒƒæ•°è£å‰ª (Clipping byNorm)</strong>ï¼Œè¿™ä¹Ÿæ˜¯æœ€å¸¸ç”¨ã€æœ€æ¨èçš„æ–¹å¼ã€‚ä½†å…¶å®è¿˜æœ‰å¦ä¸€ç§æ–¹å¼ï¼Œå«åš<strong>å€¼è£å‰ªï¼ˆClippingby Valueï¼‰</strong>ã€‚ç†è§£å®ƒä»¬çš„åŒºåˆ«éå¸¸é‡è¦ã€‚</p><p><strong>èŒƒæ•°è£å‰ª (Clipping by Norm)</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">torch.nn.utils.clip_grad_norm_(model.parameters(), max_norm=<span class="number">1.0</span>)</span><br></pre></td></tr></table></figure><p>è®¡ç®—æ‰€æœ‰å‚æ•°æ¢¯åº¦çš„ L2èŒƒæ•°ï¼ˆå¯ä»¥ç†è§£ä¸ºæ•´ä¸ªæ¢¯åº¦å‘é‡çš„â€œé•¿åº¦â€ï¼‰ï¼Œå¦‚æœè¿™ä¸ªèŒƒæ•°è¶…è¿‡äº†è®¾å®šçš„é˜ˆå€¼<code>max_norm</code>ï¼Œå°±å°†æ•´ä¸ªæ¢¯åº¦å‘é‡æŒ‰æ¯”ä¾‹ç¼©å°ï¼Œä½¿å…¶èŒƒæ•°æ°å¥½ç­‰äº<code>max_norm</code>ã€‚</p><p>è¿™ç§è£å‰ª<strong>ä¿æŒæ¢¯åº¦çš„æ–¹å‘ä¸å˜</strong>ï¼Œåªç¼©æ”¾å…¶å¤§å°ã€‚è¿™éå¸¸é‡è¦ï¼Œå› ä¸ºæ¢¯åº¦çš„æ–¹å‘æŒ‡æ˜äº†æŸå¤±å‡½æ•°ä¸‹é™æœ€å¿«çš„æ–¹å‘ï¼Œæˆ‘ä»¬å¸Œæœ›ä¿ç•™è¿™ä¸ªæ­£ç¡®çš„ä¿¡æ¯ï¼Œåªæ˜¯ä¸æƒ³è®©æ­¥å­è¿ˆå¾—å¤ªå¤§ã€‚</p><p><strong>å€¼è£å‰ª (Clipping by Value)</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">torch.nn.utils.clip_grad_value_(model.parameters(), clip_value=<span class="number">1.0</span>)</span><br></pre></td></tr></table></figure><p>ä¸ºæ¢¯åº¦çš„æ¯ä¸€ä¸ªå…ƒç´ è®¾å®šä¸€ä¸ªåŒºé—´çš„<code>[min_value, max_value]</code>ã€‚ç„¶åéå†æ¢¯åº¦å‘é‡ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœæŸä¸ªå…ƒç´ çš„å€¼å°äº<code>min_value</code>ï¼Œå°±æŠŠå®ƒè®¾ä¸º <code>min_value</code>ï¼›å¦‚æœå¤§äº<code>max_value</code>ï¼Œå°±æŠŠå®ƒè®¾ä¸º <code>max_value</code>ã€‚</p><p>è¿™ç§æ–¹æ³•ä¼š <strong>æ”¹å˜æ¢¯åº¦çš„æ–¹å‘</strong>ã€‚æƒ³è±¡ä¸€ä¸ªäºŒç»´æ¢¯åº¦å‘é‡<code>g = [10, 0.1]</code>ï¼Œå¦‚æœè®¾ç½®è£å‰ªåŒºé—´ä¸º<code>[-1, 1]</code>ï¼Œè£å‰ªåå®ƒä¼šå˜æˆ<code>g' = [1, 0.1]</code>ã€‚åŸæ¥çš„æ–¹å‘å‡ ä¹æ˜¯æ²¿ç€ xè½´ï¼Œä½†è£å‰ªåçš„æ–¹å‘æ˜æ˜¾å‘ yè½´åç§»äº†ã€‚è¿™ç§æ–¹å‘ä¸Šçš„æ”¹å˜å¯èƒ½ä¼šè¯¯å¯¼æ¨¡å‹çš„æ›´æ–°ã€‚</p><hr /><p>ç”±äºèŒƒæ•°è£å‰ªä¿ç•™äº†æ¢¯åº¦çš„æ­£ç¡®æ–¹å‘ï¼Œåœ¨ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œ<strong>èŒƒæ•°è£å‰ªæ˜¯æ¯”å€¼è£å‰ªæ›´å¥½çš„é€‰æ‹©</strong>ã€‚æˆ‘ä»¬é€šå¸¸æ‰€è¯´çš„æ¢¯åº¦è£å‰ªä¹Ÿé»˜è®¤æ˜¯æŒ‡èŒƒæ•°è£å‰ªã€‚</p><h3 id="å¦‚ä½•é€‰æ‹©è£å‰ªé˜ˆå€¼">å¦‚ä½•é€‰æ‹©è£å‰ªé˜ˆå€¼</h3><p>åœ¨ä¸Šè¿°èŒƒæ•°è£å‰ªï¼ˆåç»­æ¢¯åº¦è£å‰ªå‡é»˜è®¤ä¸ºèŒƒæ•°è£å‰ªï¼‰çš„ç¤ºä¾‹ä»£ç ä¸­ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">torch.nn.utils.clip_grad_norm_(model.parameters(), max_norm=<span class="number">1.0</span>)</span><br></pre></td></tr></table></figure><p><code>max_norm</code>æ˜¯ä¸€ä¸ªè¶…å‚æ•°ï¼Œå³è£å‰ªé˜ˆå€¼ï¼Œå®ƒçš„è®¾å®šæ²¡æœ‰ä¸€ä¸ªæ”¾ä¹‹å››æµ·è€Œçš†å‡†çš„é»„é‡‘æ•°å€¼ï¼Œä½†æœ‰ä¸€ä¸ªéå¸¸æœ‰æ•ˆçš„ç»éªŒæ³•åˆ™æ¥ç¡®å®šå®ƒï¼š</p><ol type="1"><li><strong>åˆå§‹é˜¶æ®µä¸è£å‰ª</strong>ï¼šåœ¨ä½ çš„æ¨¡å‹å’Œæ•°æ®é›†ä¸Šï¼Œå…ˆè·‘å‡ ä¸ªè®­ç»ƒè¿­ä»£ï¼ˆiterationsï¼‰ï¼Œä½†æš‚æ—¶ä¸ä½¿ç”¨æ¢¯åº¦è£å‰ªã€‚</li><li><strong>ç›‘æ§æ¢¯åº¦èŒƒæ•°</strong>ï¼šåœ¨æ¯ä¸ªè®­ç»ƒæ­¥ï¼ˆ<code>loss.backward()</code>ä¹‹åï¼Œ<code>optimizer.step()</code>ä¹‹å‰ï¼‰ï¼Œè®¡ç®—å¹¶è®°å½•ä¸‹æ¨¡å‹å‚æ•°çš„æ¢¯åº¦æ€»èŒƒæ•°ã€‚</li><li><strong>åˆ†æèŒƒæ•°åˆ†å¸ƒ</strong>ï¼šæ”¶é›†ä¸Šç™¾ä¸ªè¿­ä»£çš„æ¢¯åº¦èŒƒæ•°å€¼ï¼Œè§‚å¯Ÿå®ƒä»¬çš„åˆ†å¸ƒã€‚ä½ ä¼šå‘ç°ï¼Œå¤§éƒ¨åˆ†æ—¶å€™æ¢¯åº¦èŒƒæ•°ä¼šå¤„åœ¨ä¸€ä¸ªæ¯”è¾ƒç¨³å®šçš„èŒƒå›´å†…ï¼Œä½†å¶å°”ä¼šå‡ºç°ä¸€äº›éå¸¸å¤§çš„"å°–å³°"ï¼Œè¿™äº›å°±æ˜¯æ¢¯åº¦çˆ†ç‚¸çš„æ—¶åˆ»ã€‚</li><li><strong>è®¾å®šé˜ˆå€¼</strong>ï¼šé€‰æ‹©ä¸€ä¸ªæ¯”å¤§å¤šæ•°"ç¨³å®š"æ¢¯åº¦èŒƒæ•°ç•¥å¤§ï¼Œä½†åˆèƒ½æ˜æ˜¾é™åˆ¶ä½é‚£äº›"å°–å³°"çš„å€¼ã€‚é€šå¸¸å¯ä»¥é€‰æ‹©æ¢¯åº¦èŒƒæ•°åˆ†å¸ƒçš„æŸä¸ªé«˜ç™¾åˆ†ä½ç‚¹ï¼Œæ¯”å¦‚90% æˆ– 95% åˆ†ä½ç‚¹ï¼Œä½œä¸ºä¸€ä¸ªä¸é”™çš„èµ·å§‹å€¼ã€‚</li></ol><p><strong>ä¾‹å¦‚</strong>ï¼šä½ è§‚å¯Ÿåˆ° 95% çš„æ¢¯åº¦èŒƒæ•°éƒ½åœ¨ 0.5 åˆ° 5.0ä¹‹é—´ï¼Œä½†å¶å°”ä¼šé£™å‡åˆ° 50 æˆ– 100ã€‚é‚£ä¹ˆï¼Œå°† <code>max_norm</code> è®¾ç½®ä¸º5.0 æˆ–è€… 10.0å°±æ˜¯ä¸€ä¸ªåˆç†çš„é€‰æ‹©ã€‚è¿™æ ·æ—¢ä¸ä¼šå½±å“æ­£å¸¸çš„è®­ç»ƒï¼Œåˆèƒ½æœ‰æ•ˆé˜²æ­¢æç«¯æƒ…å†µä¸‹çš„è®­ç»ƒå´©æºƒã€‚å¸¸è§çš„<code>max_norm</code> å€¼é€šå¸¸åœ¨ 1.0 åˆ° 10.0 ä¹‹é—´ã€‚</p><p>åœ¨ PyTorch ä¸­ï¼Œæ¢¯åº¦è£å‰ªçš„ä½ç½®éå¸¸å…³é”®ã€‚å®ƒå¿…é¡»åœ¨<code>loss.backward()</code> ä¹‹åï¼ˆæ­¤æ—¶æ¢¯åº¦å·²ç»è¢«è®¡ç®—å‡ºæ¥ï¼‰å’Œ<code>optimizer.step()</code> ä¹‹å‰ï¼ˆåœ¨ç”¨æ¢¯åº¦æ›´æ–°æƒé‡ä¹‹å‰ï¼‰è°ƒç”¨ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸€ä¸ªæ ‡å‡†çš„è®­ç»ƒå¾ªç¯</span></span><br><span class="line">optimizer.zero_grad()        <span class="comment"># 1. æ¸…ç©ºæ—§æ¢¯åº¦</span></span><br><span class="line"></span><br><span class="line">loss = model(inputs, labels) <span class="comment"># 2. å‰å‘ä¼ æ’­è®¡ç®—æŸå¤±</span></span><br><span class="line">loss.backward()              <span class="comment"># 3. åå‘ä¼ æ’­è®¡ç®—æ¢¯åº¦</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- æ¢¯åº¦è£å‰ªå‘ç”Ÿåœ¨è¿™é‡Œ ---</span></span><br><span class="line">torch.nn.utils.clip_grad_norm_(model.parameters(), max_norm=<span class="number">1.0</span>) <span class="comment"># 4. è£å‰ªæ¢¯åº¦</span></span><br><span class="line"></span><br><span class="line">optimizer.step()             <span class="comment"># 5. ä½¿ç”¨è£å‰ªåçš„æ¢¯åº¦æ›´æ–°æƒé‡</span></span><br></pre></td></tr></table></figure><h2 id="ä»£ç æ¡ˆä¾‹">ä»£ç æ¡ˆä¾‹</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä»¥ä¸€ä¸ªå®Œæ•´çš„å¤§è¯­è¨€æ¨¡å‹ï¼ˆLarge LanguageModelï¼‰è®­ç»ƒè¿‡ç¨‹ï¼Œæ¥å°†è¿™ 3 ä¸ªä¼˜åŒ–æ€è·¯ä¸²èµ·æ¥ï¼Œæœ¬ç¯‡æ¡ˆä¾‹å‚è€ƒäº† <ahref="https://github.com/rasbt/LLMs-from-scratch">LLMs-from-scratch</a>ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯å‚é˜…æ­¤ä¹¦ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">train_model</span>(<span class="params">model, train_loader, val_loader, optimizer, device,</span></span><br><span class="line"><span class="params">                num_epochs, eval_freq, eval_iter, start_context, tokenizer,</span></span><br><span class="line"><span class="params">                warmup_steps, initial_lr=<span class="number">3e-05</span>, min_lr=<span class="number">1e-6</span></span>):</span><br><span class="line">    train_losses, val_losses, track_tokens_seen, track_lrs = [], [], [], []</span><br><span class="line">    tokens_seen, global_step = <span class="number">0</span>, -<span class="number">1</span></span><br><span class="line"></span><br><span class="line">    peak_lr = optimizer.param_groups[<span class="number">0</span>][<span class="string">&quot;lr&quot;</span>]</span><br><span class="line">    total_training_steps = <span class="built_in">len</span>(train_loader) * num_epochs <span class="comment"># è®¡ç®—è®­ç»ƒè¿‡ç¨‹ä¸­çš„æ‰€æœ‰è¿­ä»£æ­¥æ•°</span></span><br><span class="line">    lr_increment = (peak_lr - initial_lr) / warmup_steps  <span class="comment"># è®¡ç®—åœ¨é¢„çƒ­é˜¶æ®µå­¦ä¹ ç‡çš„å¢é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(num_epochs):</span><br><span class="line">        model.train()</span><br><span class="line">        <span class="keyword">for</span> input_batch, target_batch <span class="keyword">in</span> train_loader:</span><br><span class="line">            global_step +=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> global_step &lt; warmup_steps:</span><br><span class="line">                lr = initial_lr + global_step * lr_increment    <span class="comment"># &lt;---- å­¦ä¹ ç‡é¢„çƒ­é˜¶æ®µ</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                progress = ((global_step - warmup_steps) /</span><br><span class="line">                                    (total_training_steps - warmup_steps))</span><br><span class="line">                lr = min_lr + (peak_lr - min_lr) * <span class="number">0.5</span> * (      <span class="comment"># &lt;---- ä½™å¼¦è¡°å‡é˜¶æ®µ</span></span><br><span class="line">                    <span class="number">1</span> + math.cos(math.pi * progress))</span><br><span class="line">            <span class="keyword">for</span> param_group <span class="keyword">in</span> optimizer.param_groups:  <span class="comment"># åœ¨ä¼˜åŒ–å™¨ä¸Šåº”ç”¨è®¡ç®—åçš„å­¦ä¹ ç‡</span></span><br><span class="line">                param_group[<span class="string">&quot;lr&quot;</span>] = lr</span><br><span class="line">            track_lrs.append(lr)</span><br><span class="line"></span><br><span class="line">            optimizer.zero_grad()  <span class="comment"># æ¸…ç©ºæ—§æ¢¯åº¦</span></span><br><span class="line">            loss = calc_loss_batch(input_batch, target_batch, model, device) <span class="comment"># å‰å‘ä¼ æ’­è®¡ç®—äº¤å‰ç†µæŸå¤±</span></span><br><span class="line">            loss.backward() <span class="comment"># åå‘ä¼ æ’­è®¡ç®—æ¢¯åº¦</span></span><br><span class="line">            <span class="keyword">if</span> global_step &gt;= warmup_steps: <span class="comment"># &lt;--- åœ¨é¢„çƒ­é˜¶æ®µåä½¿ç”¨æ¢¯åº¦è£å‰ªæ¥é¿å…æ¢¯åº¦çˆ†ç‚¸</span></span><br><span class="line">                torch.nn.utils.clip_grad_norm_(</span><br><span class="line">                    model.parameters(), max_norm=<span class="number">1.0</span></span><br><span class="line">                )</span><br><span class="line">            optimizer.step() <span class="comment"># ä½¿ç”¨è£å‰ªåçš„æ¢¯åº¦æ›´æ–°æƒé‡</span></span><br><span class="line"></span><br><span class="line">            tokens_seen += input_batch.numel()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># è¾“å‡ºè°ƒè¯•ä¿¡æ¯ï¼Œç”¨äºè§‚æµ‹è®­ç»ƒè¿›å±•</span></span><br><span class="line">            <span class="keyword">if</span> global_step % eval_freq == <span class="number">0</span>:</span><br><span class="line">                train_loss, val_loss = evaluate_model(</span><br><span class="line">                    model, train_loader, val_loader, device, eval_iter</span><br><span class="line">                )</span><br><span class="line">                train_losses.append(train_loss)</span><br><span class="line">                val_losses.append(val_loss)</span><br><span class="line">                track_tokens_seen.append(tokens_seen)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Ep <span class="subst">&#123;epoch+<span class="number">1</span>&#125;</span> (Step <span class="subst">&#123;global_step:06d&#125;</span>):&quot;</span></span><br><span class="line">                    <span class="string">f&quot;Train loss <span class="subst">&#123;train_loss:<span class="number">.3</span>f&#125;</span>, &quot;</span></span><br><span class="line">                    <span class="string">f&quot;Val loss <span class="subst">&#123;val_loss:<span class="number">.3</span>f&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è¿ç”¨å½“å‰æ¨¡å‹è¿›è¡Œæ–‡æœ¬ç”Ÿæˆï¼Œè§‚å¯Ÿæ¨¡å‹èƒ½åŠ›</span></span><br><span class="line">        generate_and_print_sample(model, tokenizer, device, start_context)</span><br><span class="line">    <span class="keyword">return</span> train_losses, val_losses, track_tokens_seen, track_lrs</span><br></pre></td></tr></table></figure><p>å®Œæ•´ä»£ç å¯å‚è€ƒï¼š<ahref="https://github.com/hedon-ai-road/llm-from-scratch/blob/main/5-%E8%AE%AD%E7%BB%83%E5%A4%A7%E6%A8%A1%E5%9E%8B.ipynb">llm-from-scratch</a></p><h2 id="æ€»ç»“">æ€»ç»“</h2><p>æ·±åº¦å­¦ä¹ æ¨¡å‹çš„è®­ç»ƒè¿‡ç¨‹å¦‚åŒä¸€åœºå……æ»¡æŒ‘æˆ˜çš„è¿œèˆªï¼Œä¸ç¨³å®šçš„å¼€å±€ã€éš¾ä»¥æ”¶æ•›çš„å›°å¢ƒå’Œçªå¦‚å…¶æ¥çš„è®­ç»ƒå´©æºƒæ˜¯å¸¸è§çš„"é£æµª"ã€‚æœ¬æ–‡æ·±å…¥æ¢è®¨äº†ä¸‰ç§ä¸ºè¿™åœºè¿œèˆªä¿é©¾æŠ¤èˆªçš„æ ¸å¿ƒæŠ€å·§ï¼š</p><ul><li><strong>å­¦ä¹ ç‡é¢„çƒ­ (Learning RateWarmup)</strong>ï¼šå®ƒç¡®ä¿äº†æˆ‘ä»¬èƒ½æœ‰ä¸€ä¸ª"æ¸©æŸ”çš„å¯åŠ¨"ï¼Œé€šè¿‡åœ¨è®­ç»ƒåˆæœŸä½¿ç”¨æå°çš„å­¦ä¹ ç‡å¹¶é€æ­¥æå‡ï¼Œæœ‰æ•ˆé¿å…äº†å› æ¨¡å‹å°šæœªé€‚åº”æ•°æ®è€Œå¯¼è‡´çš„å‰§çƒˆéœ‡è¡ã€‚</li><li><strong>ä½™å¼¦è¡°å‡ (CosineAnnealing)</strong>ï¼šå®ƒä¸ºæˆ‘ä»¬è§„åˆ’äº†"å¹³æ»‘çš„èˆªç¨‹"ï¼Œä»¥ä¸€ç§å…ˆæ…¢åå¿«çš„æ–¹å¼ä¼˜é›…åœ°é™ä½å­¦ä¹ ç‡ï¼Œå…¼é¡¾äº†å‰ä¸­æœŸçš„å¹¿æ³›æ¢ç´¢å’ŒåæœŸçš„ç²¾ç»†æ”¶æ•›ï¼Œå¸®åŠ©æ¨¡å‹æ›´ç²¾å‡†åœ°æŠµè¾¾æœ€ä¼˜è§£ã€‚</li><li><strong>æ¢¯åº¦è£å‰ª (GradientClipping)</strong>ï¼šå®ƒæ˜¯å…¨ç¨‹å¿…å¤‡çš„"å®‰å…¨å¸¦"ï¼Œé€šè¿‡ä¸ºæ¢¯åº¦è®¾ç½®ä¸Šé™ï¼Œæœ‰æ•ˆé˜²æ­¢äº†å› æ¢¯åº¦çˆ†ç‚¸å¼•å‘çš„"æ ¸çˆ†"äº‹æ•…ï¼Œä¿è¯äº†è®­ç»ƒè¿‡ç¨‹çš„ç¨³å®šå’Œé²æ£’ã€‚</li></ul><p>æ–‡ç« æœ€åçš„ä»£ç ç¤ºä¾‹ç”ŸåŠ¨åœ°å±•ç¤ºäº†ï¼Œè¿™ä¸‰ä¸ªæŠ€å·§å¹¶éå­¤ç«‹å­˜åœ¨ï¼Œè€Œæ˜¯ä¸‰ä½ä¸€ä½“çš„ååŒç­–ç•¥ã€‚åœ¨ä¸€ä¸ªå…¸å‹çš„è®­ç»ƒæµç¨‹ä¸­ï¼Œæˆ‘ä»¬ä»¥<strong>é¢„çƒ­</strong>å¼€å¯ï¼Œç”¨<strong>ä½™å¼¦è¡°å‡</strong>è´¯ç©¿å…¨ç¨‹ï¼Œå¹¶ç”±<strong>æ¢¯åº¦è£å‰ª</strong>æ—¶åˆ»å®ˆæŠ¤ã€‚</p><p>æŒæ¡å¹¶å–„ç”¨ä¸‰ä¸ªä¼˜åŒ–æŠ€å·§ï¼Œå°†ä¸å†æ˜¯ç„å­¦è°ƒå‚ï¼Œè€Œæ˜¯æœ‰ç« å¯å¾ªçš„å·¥ç¨‹ç§‘å­¦ï¼Œèƒ½è®©ä½ çš„æ¨¡å‹è®­ç»ƒè¿‡ç¨‹æ›´åŠ ç¨³å®šã€é«˜æ•ˆï¼Œæœ€ç»ˆå¾—åˆ°æ›´ä¼˜çš„æ€§èƒ½ã€‚</p>]]></content>
    
    
    <summary type="html">æœ¬ç¯‡æ·±å…¥æ¢è®¨äº†æ·±åº¦å­¦ä¹ è®­ç»ƒä¸­çš„ä¸‰å¤§æ ¸å¿ƒä¼˜åŒ–æŠ€å·§ï¼Œå­¦ä¹ ç‡é¢„çƒ­è§£å†³è®­ç»ƒåˆæœŸä¸ç¨³å®šæ€§ï¼Œä½™å¼¦è¡°å‡å®ç°ç²¾ç»†è°ƒæ•´å’Œå¹³æ»‘æ”¶æ•›ï¼Œæ¢¯åº¦è£å‰ªé˜²æ­¢æ¢¯åº¦çˆ†ç‚¸ã€‚ä»åŸç†åˆ°å®è·µï¼Œå…¨é¢è§£æå¦‚ä½•è®©æ¨¡å‹åœ¨é«˜ç»´æŸå¤±ç©ºé—´ä¸­æ›´ç¨³å®šã€æ›´é«˜æ•ˆåœ°æ‰¾åˆ°æœ€ä¼˜è§£ã€‚</summary>
    
    
    
    <category term="å¤§æ¨¡å‹" scheme="https://hedon.top/categories/%E5%A4%A7%E6%A8%A1%E5%9E%8B/"/>
    
    
    <category term="æœºå™¨å­¦ä¹ " scheme="https://hedon.top/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="æ·±åº¦å­¦ä¹ " scheme="https://hedon.top/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="å¤§æ¨¡å‹" scheme="https://hedon.top/tags/%E5%A4%A7%E6%A8%A1%E5%9E%8B/"/>
    
    <category term="è®­ç»ƒä¼˜åŒ–" scheme="https://hedon.top/tags/%E8%AE%AD%E7%BB%83%E4%BC%98%E5%8C%96/"/>
    
    <category term="å­¦ä¹ ç‡é¢„çƒ­" scheme="https://hedon.top/tags/%E5%AD%A6%E4%B9%A0%E7%8E%87%E9%A2%84%E7%83%AD/"/>
    
    <category term="ä½™å¼¦è¡°é€€" scheme="https://hedon.top/tags/%E4%BD%99%E5%BC%A6%E8%A1%B0%E9%80%80/"/>
    
    <category term="æ¢¯åº¦è£å‰ª" scheme="https://hedon.top/tags/%E6%A2%AF%E5%BA%A6%E8%A3%81%E5%89%AA/"/>
    
  </entry>
  
  <entry>
    <title>Redis æ•°æ®ç±»å‹ä¸¨Listä¸¨ä»åŒå‘é“¾è¡¨åˆ° Listpack çš„æ¼”è¿›ä¹‹è·¯ (åŸºäº Redis 8.2.1 æºç )</title>
    <link href="https://hedon.top/2025/08/20/redis/redis-datatype-list/"/>
    <id>https://hedon.top/2025/08/20/redis/redis-datatype-list/</id>
    <published>2025-08-20T11:41:00.000Z</published>
    <updated>2025-08-25T15:15:59.965Z</updated>
    
    <content type="html"><![CDATA[<p>å½“ä½ å‘ Redis æ‰§è¡Œä¸€æ¡ <code>LPUSH mylist "hello"</code>å‘½ä»¤æ—¶ï¼Œä½ æœ‰æ²¡æœ‰æƒ³è¿‡ï¼Œè¿™ä¸ª "hello" ç©¶ç«Ÿè¢«å­˜æ”¾åœ¨äº†å“ªé‡Œï¼ŸRedisä¸ºäº†è®©è¿™æ¬¡çœ‹ä¼¼ç®€å•çš„æ“ä½œå°½å¯èƒ½å¿«ã€å°½å¯èƒ½çœå†…å­˜ï¼Œåœ¨åº•å±‚åšäº†å“ªäº›ä»¤äººæƒŠå¹çš„ä¼˜åŒ–ï¼Ÿ</p><p>å¤§å¤šæ•°å¼€å‘è€…æ­¢æ­¥äº APIçš„ä½¿ç”¨ï¼Œä½†çœŸæ­£çš„æŠ€æœ¯ä¸“å®¶ï¼Œå–„äºè¿ç”¨ç¬¬ä¸€æ€§åŸç†ï¼Œæ¢ç©¶å…¶è®¾è®¡èƒŒåçš„æœ¬è´¨ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å°†ä»æœ€åŸºç¡€çš„æ•°æ®ç»“æ„å’Œè®¡ç®—æœºä½“ç³»ç»“æ„å‡ºå‘ï¼Œå±‚å±‚å‰¥èŒ§ï¼Œå½»åº•è§£æ„Redis List çš„è¿›åŒ–å²ï¼Œå¹¶æœ€ç»ˆé€šè¿‡é˜…è¯» <ahref="https://github.com/redis/redis/blob/8.2.1/src/listpack.c#L505">Redis8.2.1 çš„æºç </a>ï¼Œæ¥å°è¯æˆ‘ä»¬æ‰€æœ‰çš„æ¨è®ºã€‚</p><h3 id="è·¯çº¿å›¾">è·¯çº¿å›¾</h3><p>æˆ‘ä»¬çš„æ¢ç´¢å°†éµå¾ª Redis List è‡ªèº«çœŸå®çš„è¿›åŒ–è·¯å¾„ï¼š</p><ol type="1"><li><strong>åˆ›ä¸–çºªï¼š<code>linkedlist</code></strong> -æ•™ç§‘ä¹¦å¼çš„å®Œç¾ä¸ç°å®çš„ä»£ä»·ã€‚</li><li><strong>æ¿€è¿›æ¢ç´¢ï¼š<code>ziplist</code></strong> -å¯¹å†…å­˜çš„æè‡´å‹æ¦¨ä¸æ€§èƒ½çš„éšæ‚£ã€‚</li><li><strong>ä¼Ÿå¤§å¦¥åï¼š<code>quicklist</code></strong> -å¹³è¡¡ç©ºé—´ä¸æ—¶é—´çš„å·¥ç¨‹å¥‡è¿¹ã€‚</li><li><strong>å®Œç¾è¿›åŒ–ï¼š<code>listpack</code></strong> -<code>quicklist</code> çš„æ–°å†…æ ¸ï¼Œç†è®ºä¸ç°å®çš„æœ€ç»ˆç»Ÿä¸€ã€‚</li></ol><hr /><h3 id="åˆ›ä¸–çºªlinkedlist-çš„ä¼˜é›…ä¸ä»£ä»·">1.åˆ›ä¸–çºªï¼š<code>linkedlist</code> çš„ä¼˜é›…ä¸ä»£ä»·</h3><p>ä»è®¡ç®—æœºç§‘å­¦çš„è§’åº¦çœ‹ï¼ŒList (åˆ—è¡¨)çš„æœ€ç›´è§‚å®ç°å°±æ˜¯ä¸€ä¸ª<strong>åŒå‘é“¾è¡¨ (Doubly LinkedList)</strong>ã€‚æ—©æœŸçš„ Redis (2.0æ—¶ä»£) æ­£æ˜¯è¿™æ ·åšçš„ã€‚</p><h4 id="ç¬¬ä¸€æ€§åŸç†æ•°æ®ç»“æ„">ç¬¬ä¸€æ€§åŸç†ï¼šæ•°æ®ç»“æ„</h4><p>ä¸€ä¸ªåŒå‘é“¾è¡¨ç”±ä¸€ç³»åˆ—ç‹¬ç«‹çš„èŠ‚ç‚¹æ„æˆï¼Œæ¯ä¸ªèŠ‚ç‚¹é™¤äº†ä¿å­˜æ•°æ®å¤–ï¼Œè¿˜æ‹¥æœ‰ä¸¤ä¸ªæŒ‡é’ˆï¼Œåˆ†åˆ«æŒ‡å‘å…¶å‰é©±å’Œåç»§èŠ‚ç‚¹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">          +------+     +------+     +------+</span><br><span class="line">... &lt;---- | prev | &lt;-&gt; | prev | &lt;-&gt; | prev | ----&gt; ...</span><br><span class="line">          | data |     | data |     | data |</span><br><span class="line">... &lt;---- | next | &lt;-&gt; | next | &lt;-&gt; | next | ----&gt; ...</span><br><span class="line">          +------+     +------+     +------+</span><br></pre></td></tr></table></figure><p>ä¼˜ç‚¹ï¼šå®Œç¾çš„ O(1) å¤´å°¾æ“ä½œ</p><ul><li>åœ¨é“¾è¡¨çš„å¤´éƒ¨æˆ–å°¾éƒ¨æ’å…¥/åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåªéœ€è¦ä¿®æ”¹ç›¸é‚»çš„ 2-3ä¸ªæŒ‡é’ˆå³å¯ï¼Œè¿™ä¸ªè¿‡ç¨‹æ¶ˆè€—çš„æ—¶é—´æ˜¯å¸¸æ•°ï¼Œä¸é“¾è¡¨é•¿åº¦æ— å…³ã€‚è¿™å¯¹äºLPUSH/RPUSH/LPOP/RPOP è¿™æ ·çš„æ“ä½œæ¥è¯´ï¼Œæ˜¯ç†è®ºä¸Šæœ€å®Œç¾çš„æ•°æ®ç»“æ„ã€‚</li></ul><p>ç¼ºç‚¹ï¼šç°å®ä¸–ç•Œçš„åŒé‡ä»£ä»·</p><ol type="1"><li><strong>é«˜æ˜‚çš„å†…å­˜å¼€é”€</strong>ï¼šè¿™æ˜¯ <code>linkedlist</code>è¢«æ·˜æ±°çš„<strong>é¦–è¦åŸå› </strong>ã€‚åœ¨ä¸€ä¸ª 64 ä½ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªæŒ‡é’ˆå ç”¨ 8å­—èŠ‚ã€‚è¿™æ„å‘³ç€æ¯ä¸ªèŠ‚ç‚¹ï¼Œé™¤äº†å­˜å‚¨ä½ çš„æ•°æ®ï¼Œä»… <code>prev</code> å’Œ<code>next</code> ä¸¤ä¸ªæŒ‡é’ˆå°±è¦é¢å¤–æ¶ˆè€— 16å­—èŠ‚ï¼å½“ä½ å­˜å‚¨å¤§é‡å°æ•°æ®æ—¶ï¼ˆæ¯”å¦‚æ•´æ•°ï¼‰ï¼ŒæŒ‡é’ˆå ç”¨çš„ç©ºé—´ä¼šè¿œè¶…æ•°æ®æœ¬èº«ï¼Œè¿™æ˜¯å¯¹å®è´µå†…å­˜çš„å·¨å¤§æµªè´¹ã€‚</li><li><strong>ç³Ÿç³•çš„ CPUç¼“å­˜å±€éƒ¨æ€§</strong>ï¼šé“¾è¡¨çš„èŠ‚ç‚¹åœ¨å†…å­˜ä¸­æ˜¯<strong>ç¦»æ•£</strong>åˆ†å¸ƒçš„ã€‚å½“CPUéå†é“¾è¡¨æ—¶ï¼Œå®ƒéœ€è¦ä¸æ–­åœ°ä»å†…å­˜çš„ä¸åŒåŒºåŸŸåŠ è½½èŠ‚ç‚¹æ•°æ®ï¼Œè¿™ç§æŒ‡é’ˆè·³è½¬çš„è¡Œä¸ºææ˜“å¯¼è‡´<strong>CPU Cache Miss (ç¼“å­˜æœªå‘½ä¸­)</strong>ã€‚CPUæ— æ³•æœ‰æ•ˆåˆ©ç”¨å…¶é«˜é€Ÿç¼“å­˜æ¥é¢„è¯»æ•°æ®ï¼Œå¯¼è‡´éå†æ€§èƒ½è¿œä¸å¦‚è¿ç»­å†…å­˜çš„æ•°ç»„ã€‚</li></ol><hr /><h3 id="æ¿€è¿›æ¢ç´¢ziplist-å¯¹å†…å­˜çš„æè‡´å‹æ¦¨">2.æ¿€è¿›æ¢ç´¢ï¼š<code>ziplist</code> å¯¹å†…å­˜çš„æè‡´å‹æ¦¨</h3><p>ä¸ºäº†å…‹æœ <code>linkedlist</code> çš„åŒé‡ä»£ä»·ï¼ŒRedisçš„è®¾è®¡è€…ä»¬åˆ›é€ äº†ä¸€ç§æå…¶ç´§å‡‘çš„æ•°æ®ç»“æ„ï¼š<strong>å‹ç¼©åˆ—è¡¨(ziplist)</strong>ã€‚</p><h4 id="ç¬¬ä¸€æ€§åŸç†è¿ç»­å†…å­˜å¸ƒå±€">ç¬¬ä¸€æ€§åŸç†ï¼šè¿ç»­å†…å­˜å¸ƒå±€</h4><p><code>ziplist</code>çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œç”¨ä¸€å—<strong>è¿ç»­çš„ã€å®Œæ•´çš„å†…å­˜å—</strong>æ¥å­˜å‚¨æ‰€æœ‰å…ƒç´ ï¼Œä»è€Œå½»åº•æ¶ˆé™¤æŒ‡é’ˆå¼€é”€ï¼Œå¹¶æœ€å¤§åŒ–åˆ©ç”¨CPU ç¼“å­˜ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;zlbytes&gt; &lt;zltail&gt; &lt;zllen&gt; &lt;entry_1&gt; &lt;entry_2&gt; ... &lt;entry_N&gt; &lt;zlend&gt;</span><br></pre></td></tr></table></figure><ul><li><code>&lt;zlbytes&gt;</code>: æ•´ä¸ª <code>ziplist</code>å ç”¨çš„æ€»å­—èŠ‚æ•°ã€‚</li><li><code>&lt;zltail&gt;</code>: åˆ°æœ€åä¸€ä¸ª entryçš„åç§»é‡ï¼Œç”¨äºå¿«é€Ÿå®šä½åˆ°è¡¨å°¾ã€‚</li><li><code>&lt;zllen&gt;</code>: entry çš„æ•°é‡ã€‚</li><li><code>&lt;entry&gt;</code>: çœŸæ­£çš„åˆ—è¡¨å…ƒç´ ï¼Œæ¯ä¸ª entryä¹Ÿæ˜¯å˜é•¿çš„ã€‚</li><li><code>&lt;zlend&gt;</code>: ç‰¹æ®Šçš„ç»“æŸæ ‡è®° <code>0xFF</code>ã€‚</li></ul><p><code>ziplist</code> çš„ç²¾é«“åœ¨äº <code>entry</code> çš„è®¾è®¡ã€‚æ¯ä¸ª entryçš„å¤´éƒ¨ä¼šè®°å½•<strong>å‰ä¸€ä¸ª entry</strong> çš„é•¿åº¦(<code>prev-len</code>)ï¼Œè¿™ä½¿å¾— <code>ziplist</code>å¯ä»¥ä»åå‘å‰éå†ã€‚</p><p>ä¼˜ç‚¹ï¼šæè‡´çš„å†…å­˜æ•ˆç‡</p><ul><li><code>ziplist</code> æ˜¯ Redisä¸ºäº†èŠ‚çœå†…å­˜è€Œè®¾è®¡çš„å…¸èŒƒã€‚å®ƒæ²¡æœ‰æŒ‡é’ˆï¼Œå¹¶å¯¹å°æ•´æ•°å’ŒçŸ­å­—ç¬¦ä¸²ä½¿ç”¨å˜é•¿ç¼–ç ï¼Œæ˜¯å†…å­˜ä½¿ç”¨æœ€ç»æµçš„åºåˆ—å‹æ•°æ®ç»“æ„ã€‚åŒæ—¶ï¼Œè¿ç»­å†…å­˜å¯¹CPU ç¼“å­˜æä¸ºå‹å¥½ã€‚</li></ul><p>ç¼ºç‚¹ï¼šè¿é”æ›´æ–° (Cascading Updates)</p><ul><li>è¿™æ˜¯ <code>ziplist</code> çš„<ahref="https://zh.wikipedia.org/w/index.php?title=%E9%98%BF%E5%96%80%E7%90%89%E6%96%AF">é˜¿å–€ç‰æ–¯ä¹‹è¸µ</a>ã€‚ç”±äºæ¯ä¸ª<code>entry</code> è®°å½•äº†å‰ä¸€ä¸ª <code>entry</code> çš„é•¿åº¦ï¼Œå½“åœ¨å‰ä¸€ä¸ª<code>entry</code> å‘ç”Ÿå¤§å°å˜åŒ–æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´å½“å‰ <code>entry</code>éœ€è¦ç”¨æ›´å¤šçš„å­—èŠ‚æ¥å­˜å‚¨ <code>prev-len</code>ï¼Œè¿™åˆå¯èƒ½å¯¼è‡´å½“å‰<code>entry</code> è‡ªèº«æ€»é•¿åº¦å˜åŒ–ï¼Œä»è€Œçº§è”å½±å“åˆ°ä¸‹ä¸€ä¸ª<code>entry</code>... åœ¨æœ€åçš„æƒ…å†µä¸‹ï¼Œä¸€æ¬¡æ’å…¥å¯èƒ½å¯¼è‡´åç»­æ‰€æœ‰<code>entry</code> éƒ½éœ€è¦é‡æ–°åˆ†é…ç©ºé—´ï¼Œæ—¶é—´å¤æ‚åº¦ä» O(N) é€€åŒ–åˆ°O(N2)ã€‚</li></ul><hr /><h3 id="ä¼Ÿå¤§å¦¥åquicklist-çš„å¹³è¡¡ä¹‹é“">3.ä¼Ÿå¤§å¦¥åï¼š<code>quicklist</code> çš„å¹³è¡¡ä¹‹é“</h3><p>æ—¢ç„¶ <code>linkedlist</code> å’Œ <code>ziplist</code>å„æœ‰ä¼˜åŠ£ï¼Œèƒ½å¦å°†å®ƒä»¬ç»“åˆèµ·æ¥ï¼Œå–å…¶ç²¾åï¼Œå»å…¶ç³Ÿç²•ï¼Ÿ<strong>å¿«é€Ÿåˆ—è¡¨(quicklist)</strong> åº”è¿è€Œç”Ÿï¼Œå¹¶ä» Redis 3.2 å¼€å§‹æˆä¸º Listçš„é»˜è®¤å®ç°ã€‚</p><h4 id="ç¬¬ä¸€æ€§åŸç†æ··åˆæ•°æ®ç»“æ„">ç¬¬ä¸€æ€§åŸç†ï¼šæ··åˆæ•°æ®ç»“æ„</h4><p><code>quicklist</code> çš„æœ¬è´¨ï¼Œå°±æ˜¯ä¸€ä¸ªç”±<code>ziplist</code>ï¼ˆæˆ–åæ¥çš„<code>listpack</code>ï¼‰èŠ‚ç‚¹ç»„æˆçš„<strong>åŒå‘é“¾è¡¨</strong>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+----------------+     +----------------+     +----------------+</span><br><span class="line">| quicklistNode  | &lt;-&gt; | quicklistNode  | &lt;-&gt; | quicklistNode  |</span><br><span class="line">| (ziplist/pack) |     | (ziplist/pack) |     | (ziplist/pack) |</span><br><span class="line">+----------------+     +----------------+     +----------------+</span><br><span class="line">         ^                    ^                      ^</span><br><span class="line">         |                    |                      |</span><br><span class="line">   [ e1, e2, e3 ]       [ e4, e5 ]           [ e6, e7, e8, e9 ]</span><br></pre></td></tr></table></figure><p>å®ƒåœ¨å®è§‚ä¸Šæ˜¯ä¸€ä¸ª <code>linkedlist</code>ï¼Œä¿æŒäº† O(1)çš„å¤´å°¾æ’å…¥æ€§èƒ½å’Œçµæ´»æ€§ã€‚è€Œåœ¨å¾®è§‚ä¸Šï¼Œæ¯ä¸ªèŠ‚ç‚¹å†…éƒ¨æ˜¯ä¸€ä¸ª<code>ziplist</code> æˆ–<code>listpack</code>ï¼Œå­˜å‚¨äº†å¤šä¸ªå…ƒç´ ï¼Œæå¤§åœ°èŠ‚çœäº†å†…å­˜ï¼Œå¹¶æå‡äº†ç¼“å­˜å±€éƒ¨æ€§ã€‚<code>quicklist</code>é€šè¿‡å°†è¿é”æ›´æ–°çš„é£é™©<strong>é™åˆ¶</strong>åœ¨ä¸€ä¸ªä¸ªç‹¬ç«‹çš„å°èŠ‚ç‚¹å†…éƒ¨ï¼Œå®Œç¾åœ°è§„é¿äº†<code>ziplist</code> æœ€å¤§çš„é£é™©ã€‚</p><hr /><h3 id="å®Œç¾è¿›åŒ–listpack-çš„æœ€ç»ˆå½¢æ€">4. å®Œç¾è¿›åŒ–ï¼š<code>listpack</code>çš„æœ€ç»ˆå½¢æ€</h3><p><code>quicklist</code> å·²ç»éå¸¸ä¼˜ç§€ï¼Œä½†å®ƒçš„å†…æ ¸ <code>ziplist</code>ä¾ç„¶å­˜åœ¨ç†è®ºä¸Šçš„è¿é”æ›´æ–°é£é™©ã€‚ä¸ºäº†è¿½æ±‚æè‡´çš„ç†è®ºå®Œå¤‡æ€§ï¼ŒRediså¼€å‘è€…è®¾è®¡äº† <code>ziplist</code>çš„ç»§ä»»è€…ï¼š<strong>listpack</strong>ã€‚ä» Redis 7.0å¼€å§‹ï¼Œ<code>quicklist</code> çš„å†…éƒ¨èŠ‚ç‚¹é»˜è®¤å·²ç”± <code>ziplist</code>æ›¿æ¢ä¸º <code>listpack</code>ã€‚</p><p><code>listpack</code> çš„ç›®æ ‡ä¸ <code>ziplist</code>ä¸€æ ·ï¼šç”¨ä¸€å—è¿ç»­å†…å­˜æ¥å­˜å‚¨æ•°æ®ã€‚ä½†å®ƒé€šè¿‡ä¸€ä¸ªç»å¦™çš„è®¾è®¡ï¼Œå½»åº•æ ¹é™¤äº†è¿é”æ›´æ–°ã€‚</p><h4id="ç¬¬ä¸€æ€§åŸç†ä¿¡æ¯è‡ªåŒ…å«ä¸å›æº¯æœºåˆ¶">ç¬¬ä¸€æ€§åŸç†ï¼šä¿¡æ¯è‡ªåŒ…å«ä¸å›æº¯æœºåˆ¶</h4><p><code>ziplist</code>è¿é”æ›´æ–°çš„æ ¹æºåœ¨äºï¼š<strong>åä¸€ä¸ªèŠ‚ç‚¹å­˜å‚¨äº†å‰ä¸€ä¸ªèŠ‚ç‚¹çš„ä¿¡æ¯(<code>prev-len</code>)</strong>ã€‚<code>listpack</code>çš„è®¾è®¡å“²å­¦æ˜¯ï¼š<strong>æ¯ä¸ªèŠ‚ç‚¹åªå­˜å‚¨ä¸è‡ªèº«ç›¸å…³çš„ä¿¡æ¯</strong>ã€‚</p><p>ä¸€ä¸ª <code>listpack</code> entry çš„ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+----------------+----------------+----------------+</span><br><span class="line">| encoding-type  | element-data   |    back-len    |</span><br><span class="line">+----------------+----------------+----------------+</span><br></pre></td></tr></table></figure><p>è¦ç†è§£ <code>listpack</code>çš„ç²¾é«“ï¼Œæˆ‘ä»¬å¿…é¡»æ·±åº¦å‰–æå…¶çµé­‚è®¾è®¡â€”â€”<code>back-len</code> å­—æ®µã€‚</p><ul><li><strong>å‘½å</strong>ï¼šæºç ä¸­ç§°ä¹‹ä¸º<code>backlen</code>ï¼Œå®ƒæœ€æ ¸å¿ƒçš„åŠŸèƒ½æ˜¯ç”¨äº<strong>å‘å(Backward)</strong> éå†ã€‚</li><li><strong>å­˜å‚¨å†…å®¹</strong>ï¼š<code>back-len</code>å­—æ®µé‡Œç‰©ç†å­˜å‚¨çš„æ•°å€¼ï¼Œç­‰äºè¯¥æ¡ç›®è‡ªèº«çš„<code>&lt;encoding-type&gt;</code> å’Œ <code>&lt;element-data&gt;</code><strong>ä¸¤éƒ¨åˆ†åŠ èµ·æ¥çš„é•¿åº¦</strong>ï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œéƒ¨åˆ†é•¿åº¦â€ï¼‰ã€‚</li><li><strong>ä½œç”¨</strong>ï¼šå½“éœ€è¦ä»åå‘å‰éå†æ—¶ï¼Œè§£æå™¨ä¼šä»å‰ä¸€ä¸ªæ¡ç›®çš„<strong>å°¾éƒ¨</strong>ï¼Œåå‘è§£æå‡ºè¿™ä¸ªâ€œéƒ¨åˆ†é•¿åº¦â€ï¼Œç„¶åå†åŠ¨æ€è®¡ç®—å‡º<code>&lt;back-len&gt;</code>å­—æ®µè‡ªèº«çš„é•¿åº¦ï¼Œä¸¤è€…ç›¸åŠ å¾—åˆ°å‰ä¸€ä¸ªæ¡ç›®çš„<strong>æ€»é•¿åº¦</strong>ï¼Œä»è€Œå®ç°ç²¾ç¡®çš„å›æº¯è·³è½¬ã€‚</li></ul><h4id="æºç ä½è¯lpprev-å‡½æ•°åŠå…¶ç§˜æœ¯-redis-8.2.1">æºç ä½è¯ï¼š<code>lpPrev</code>å‡½æ•°åŠå…¶"ç§˜æœ¯" (Redis 8.2.1)</h4><p>è®©æˆ‘ä»¬ç›´æ¥é˜…è¯» Redis <code>8.2.1</code> ç‰ˆæœ¬çš„ <ahref="https://github.com/redis/redis/blob/8.2.1/src/listpack.c#L505">listpack.c</a>æºç ï¼Œçœ‹çœ‹ <code>lpPrev</code> å‡½æ•°æ˜¯å¦‚ä½•å®ç°å›æº¯çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* from: https://github.com/redis/redis/blob/8.2.1/src/listpack.c */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> *<span class="title function_">lpPrev</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *lp, <span class="type">unsigned</span> <span class="type">char</span> *p)</span> &#123;</span><br><span class="line">    assert(p);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* è¾¹ç•Œæ£€æŸ¥ï¼šå¦‚æœå·²ç»æ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œæ— æ³•å†å›æº¯ */</span></span><br><span class="line">    <span class="keyword">if</span> (p-lp == LP_HDR_SIZE) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å…³é”®ä¸€æ­¥(1)ï¼šä»å½“å‰æ¡ç›®pçš„å¼€å¤´ï¼Œåé€€ä¸€å­—èŠ‚ï¼Œæ¥åˆ°å‰ä¸€ä¸ªæ¡ç›®çš„æœ«å°¾ */</span></span><br><span class="line">    p--; </span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å…³é”®ä¸€æ­¥(2)ï¼šä»å‰ä¸€ä¸ªæ¡ç›®çš„æœ«å°¾ï¼Œåå‘è§£æå‡ºå…¶â€œéƒ¨åˆ†é•¿åº¦â€ */</span></span><br><span class="line">    <span class="type">uint64_t</span> prevlen = lpDecodeBacklen(p);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å…³é”®ä¸€æ­¥(3)ï¼šè®¡ç®—&lt;back-len&gt;å­—æ®µè‡ªèº«çš„é•¿åº¦ï¼Œå¹¶åŠ åˆ°â€œéƒ¨åˆ†é•¿åº¦â€ä¸Šï¼Œå¾—åˆ°â€œæ€»é•¿åº¦â€ */</span></span><br><span class="line">    prevlen += lpEncodeBacklenBytes(prevlen);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å…³é”®ä¸€æ­¥(4)ï¼šæ‰§è¡Œè·³è½¬ã€‚pæŒ‡é’ˆå½“å‰åœ¨å‰ä¸€ä¸ªæ¡ç›®çš„æœ«å°¾ï¼Œ</span></span><br><span class="line"><span class="comment">     * å›é€€ (æ€»é•¿åº¦ - 1) çš„è·ç¦»ï¼Œå°±æ¥åˆ°äº†å‰ä¸€ä¸ªæ¡ç›®çš„å¼€å¤´ */</span></span><br><span class="line">    p -= prevlen<span class="number">-1</span>; </span><br><span class="line">    </span><br><span class="line">    lpAssertValidEntry(lp, lpBytes(lp), p);</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¦å®Œå…¨çœ‹æ‡‚è¿™æ®µä»£ç ï¼Œæˆ‘ä»¬å¿…é¡»æ½œå…¥å®ƒè°ƒç”¨çš„ä¸¤ä¸ªæ ¸å¿ƒå‡½æ•°ï¼š<code>lpDecodeBacklen</code>å’Œ <code>lpEncodeBacklenBytes</code>ã€‚</p><p><strong><code>lpDecodeBacklen</code> - ä¼˜é›…çš„"ç›²äººæ‘¸è±¡"</strong></p><p><code>lpDecodeBacklen</code> çš„ä»»åŠ¡æ˜¯ï¼Œåœ¨ä¸çŸ¥é“<code>&lt;back-len&gt;</code>å­—æ®µæœ‰å¤šé•¿çš„æƒ…å†µä¸‹ï¼Œä»å®ƒçš„æœ€åä¸€ä¸ªå­—èŠ‚å¼€å§‹ï¼Œåå‘ã€å®Œæ•´åœ°æŠŠå®ƒè¯»å‡ºæ¥ã€‚è¿™æ˜¯å¦‚ä½•åšåˆ°çš„ï¼Ÿç­”æ¡ˆæ˜¯<strong>å¯å˜é•¿åº¦æ•´æ•°ç¼–ç </strong>ã€‚</p><p><code>&lt;back-len&gt;</code> çš„æ¯ä¸ªå­—èŠ‚ä¸­ï¼Œæœ€é«˜ä½ (MSB)æ˜¯ä¸€ä¸ª<strong>"å»¶ç»­ä½"</strong>ï¼š</p><ul><li><code>MSB = 1</code>ï¼šè¡¨ç¤º"æˆ‘ä¸æ˜¯å¼€å¤´ï¼Œå‰é¢è¿˜æœ‰å­—èŠ‚"ã€‚</li><li><code>MSB = 0</code>ï¼šè¡¨ç¤º"æˆ‘å°±æ˜¯å¼€å¤´ï¼Œåˆ°æˆ‘ä¸ºæ­¢"ã€‚</li></ul><p><code>lpDecodeBacklen</code> çš„ç®—æ³•å°±åƒâ€œç›²äººæ‘¸è±¡â€ï¼Œä½†æå…¶é«˜æ•ˆï¼š</p><ol type="1"><li>ä» <code>p</code> æŒ‡é’ˆï¼ˆå‰ä¸€ä¸ªæ¡ç›®çš„æœ«å°¾ï¼‰å¼€å§‹ï¼Œè¯»å– 1 ä¸ªå­—èŠ‚ã€‚</li><li>æ£€æŸ¥å®ƒçš„æœ€é«˜ä½ã€‚å¦‚æœæ˜¯ <code>0</code>ï¼Œè¯´æ˜<code>&lt;back-len&gt;</code> åªæœ‰ 1 å­—èŠ‚é•¿ï¼Œå…¶ä½™ 7ä½å°±æ˜¯é•¿åº¦å€¼ï¼Œä»»åŠ¡å®Œæˆã€‚</li><li>å¦‚æœæ˜¯ <code>1</code>ï¼Œè¯´æ˜è¿™æ˜¯å¤šå­—èŠ‚é•¿åº¦çš„ä¸€éƒ¨åˆ†ï¼Œè®°ä¸‹å…¶ä½™ 7ä½ï¼Œç„¶å<code>p--</code>ï¼Œç»§ç»­å‘å‰è¯»ä¸‹ä¸€ä¸ªå­—èŠ‚ï¼Œé‡å¤æ­¤è¿‡ç¨‹ï¼Œç›´åˆ°æ‰¾åˆ°é‚£ä¸ªæœ€é«˜ä½ä¸º<code>0</code> çš„â€œé¢†å¤´â€å­—èŠ‚ã€‚</li><li>æœ€åï¼Œå°†æ‰€æœ‰æ”¶é›†åˆ°çš„ 7ä½æ•°æ®å—æ‹¼æ¥èµ·æ¥ï¼Œè¿˜åŸå‡ºå®Œæ•´çš„â€œéƒ¨åˆ†é•¿åº¦â€ã€‚</li></ol><p>ä»¥ä¸‹æ˜¯ <code>lpDecodeBacklen</code> çš„æ ¸å¿ƒæºç ç‰‡æ®µï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* from: https://github.com/redis/redis/blob/8.2.1/src/listpack.c */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">uint64_t</span> <span class="title function_">lpDecodeBacklen</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *p)</span> &#123;</span><br><span class="line">    <span class="type">uint64_t</span> val = <span class="number">0</span>;</span><br><span class="line">    <span class="type">uint64_t</span> shift = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">/* ä» p æŒ‡é’ˆå¼€å§‹ï¼Œå‘ä½åœ°å€ï¼ˆå·¦ï¼‰ç§»åŠ¨ */</span></span><br><span class="line">        val |= (<span class="type">uint64_t</span>)(p[<span class="number">0</span>] &amp; <span class="number">127</span>) &lt;&lt; shift;</span><br><span class="line">        <span class="comment">/* å¦‚æœæœ€é«˜ä½æ˜¯ 0ï¼Œè¡¨ç¤ºè¿™æ˜¯æœ€åä¸€ä¸ªå­—èŠ‚ï¼Œå¾ªç¯ç»ˆæ­¢ */</span></span><br><span class="line">        <span class="keyword">if</span> ((p[<span class="number">0</span>] &amp; <span class="number">128</span>) == <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">        shift += <span class="number">7</span>;</span><br><span class="line">        p--;</span><br><span class="line">        <span class="comment">/* å®‰å…¨æ£€æŸ¥ï¼Œé˜²æ­¢æ— é™å¾ªç¯ */</span></span><br><span class="line">        <span class="keyword">if</span> (shift &gt; <span class="number">63</span>) <span class="keyword">return</span> UINT64_MAX;</span><br><span class="line">    &#125; <span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><code>lpEncodeBacklenBytes</code> -æœªåœå…ˆçŸ¥çš„è®¡ç®—</strong></p><p><code>lpPrev</code> åœ¨å¾—åˆ°"éƒ¨åˆ†é•¿åº¦" <code>prevlen</code>åï¼Œè¿˜éœ€è¦çŸ¥é“ <code>&lt;back-len&gt;</code>å­—æ®µæœ¬èº«å äº†å‡ ä¸ªå­—èŠ‚ï¼Œæ‰èƒ½ç®—å‡ºæ€»é•¿åº¦ã€‚<code>lpEncodeBacklenBytes</code>çš„ä½œç”¨å°±æ˜¯å›ç­”è¿™ä¸ªé—®é¢˜ã€‚</p><p>å®ƒçš„é€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯ä¸€ç³»åˆ—çš„èŒƒå›´åˆ¤æ–­ï¼Œè¿™æ­£æ˜¯å¯å˜é•¿åº¦æ•´æ•°ç¼–ç çš„é€†è¿‡ç¨‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* from: https://github.com/redis/redis/blob/8.2.1/src/listpack.c */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">uint64_t</span> <span class="title function_">lpEncodeBacklenBytes</span><span class="params">(<span class="type">uint64_t</span> len)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">128</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (len &lt; <span class="number">16384</span>) <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (len &lt; <span class="number">2097152</span>) <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (len &lt; <span class="number">268435456</span>) <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼Œå¦‚æœ <code>lpDecodeBacklen</code> è¿”å›çš„ <code>prevlen</code>æ˜¯ <code>100</code>ï¼Œ<code>lpEncodeBacklenBytes(100)</code> å°±ä¼šè¿”å›<code>1</code>ã€‚<code>lpPrev</code> éšå³å°†ä¸¤è€…ç›¸åŠ å¾—åˆ°æ€»é•¿åº¦<code>101</code>ï¼Œå®Œæˆæœ€ç»ˆçš„å›æº¯è·³è½¬ã€‚</p><h3 id="ç»“è®ºæ°¸ä¸ä¼‘æ­¢çš„ä¼˜åŒ–ä¹‹è·¯">ç»“è®ºï¼šæ°¸ä¸ä¼‘æ­¢çš„ä¼˜åŒ–ä¹‹è·¯</h3><p>Redis List çš„æ¼”è¿›å²ï¼Œæ˜¯è½¯ä»¶å·¥ç¨‹é¢†åŸŸè¿½æ±‚æè‡´æ€§èƒ½å’Œæ•ˆç‡çš„ç¼©å½±ï¼š</p><ol type="1"><li><strong><code>linkedlist</code></strong>ï¼šä¸€ä¸ªä¼˜é›…çš„ç†è®ºèµ·ç‚¹ï¼Œä½†åœ¨ç°å®çš„å†…å­˜å’ŒCPU é¢å‰æ˜¾å¾—è„†å¼±ã€‚</li><li><strong><code>ziplist</code></strong>ï¼šä¸€æ¬¡æ¿€è¿›çš„ã€å‘å†…å­˜æ•ˆç‡æé™å‘èµ·çš„å†²é”‹ï¼Œä½†ç•™ä¸‹äº†æ€§èƒ½æŠ–åŠ¨çš„éšæ‚£ã€‚</li><li><strong><code>quicklist</code></strong>ï¼šä¸€æ¬¡ä¼Ÿå¤§çš„å·¥ç¨‹å¦¥åï¼Œåœ¨å®è§‚ä¸å¾®è§‚å±‚é¢å–å¾—äº†ç²¾å¦™çš„å¹³è¡¡ï¼Œæˆä¸ºç¨³å®šæœåŠ¡å¤šå¹´çš„åŸºçŸ³ã€‚</li><li><strong><code>listpack</code></strong>ï¼šä¸€æ¬¡å¯¹ç†è®ºå®Œç¾çš„æœ€ç»ˆè¿½æ±‚ï¼Œé€šè¿‡æ”¹å˜èŠ‚ç‚¹å†…éƒ¨çš„ä¿¡æ¯è®°å½•æ–¹å¼ï¼Œå½»åº•æ ¹é™¤äº†å†å²é—ç•™é—®é¢˜ï¼Œè®©List çš„å®ç°è¾¾åˆ°äº†æ–°çš„é«˜åº¦ã€‚</li></ol><p>ä½œä¸º Redis çš„ä½¿ç”¨è€…ï¼Œæˆ‘ä»¬äº«å—ç€ <code>LPUSH</code>/<code>RPOP</code>çš„ç®€æ´ä¸é«˜æ•ˆã€‚ä½†ä½œä¸ºæŠ€æœ¯çš„æ¢ç´¢è€…ï¼Œæˆ‘ä»¬æ›´åº”æ¬£èµè¿™èƒŒåé•¿è¾¾åä½™å¹´çš„ã€å¯¹æ¯ä¸€ä¸ªå­—èŠ‚ã€æ¯ä¸€æ¬¡CPU ç¼“å­˜å‘½ä¸­ã€æ¯ä¸€ç§é£é™©åœºæ™¯çš„æè‡´æ€è€ƒä¸æ‰“ç£¨ã€‚</p>]]></content>
    
    
    <summary type="html">æœ¬ç¯‡åŸºäº Redis 8.2.1 æºç ï¼Œä»åŒå‘é“¾è¡¨åˆ° Listpack çš„æ¼”è¿›ä¹‹è·¯ï¼Œå¸¦ä½ æ·±å…¥ç†è§£ Redis çš„ List æ•°æ®ç±»å‹ã€‚</summary>
    
    
    
    <category term="Redis" scheme="https://hedon.top/categories/Redis/"/>
    
    
    <category term="Redis" scheme="https://hedon.top/tags/Redis/"/>
    
  </entry>
  
  <entry>
    <title>å‘Šåˆ«æ­»è®°ç¡¬èƒŒï¼šä¸€ä»½çœŸæ­£ç†è§£ PyTorch æ ¸å¿ƒè®¾è®¡çš„æŒ‡å—</title>
    <link href="https://hedon.top/2025/08/18/llm/pytorch/"/>
    <id>https://hedon.top/2025/08/18/llm/pytorch/</id>
    <published>2025-08-18T07:31:00.000Z</published>
    <updated>2025-08-25T15:15:59.965Z</updated>
    
    <content type="html"><![CDATA[<p>å¦‚æœä½ æ­£åœ¨å­¦ä¹  PyTorchï¼Œä½ å¾ˆå¯èƒ½å’Œæˆ‘æœ€åˆä¸€æ ·ï¼Œæœ‰è¿™æ ·çš„å›°æƒ‘ï¼šPyTorchçš„ API å¤ªå¤šäº†ï¼Œåƒä¸€ç‰‡æœ›ä¸åˆ°è¾¹çš„æµ·æ´‹ã€‚ä»Šå¤©è®°ä½<code>view</code>ï¼Œæ˜å¤©å¿˜äº† <code>permute</code>ï¼›åˆšå­¦ä¼š<code>Dataset</code>ï¼Œåˆå¯¹ <code>DataLoader</code> çš„<code>num_workers</code>æ„Ÿåˆ°ç¥ç§˜ã€‚é æ­»è®°ç¡¬èƒŒæ¥å­¦ä¹ ï¼Œä¸ä»…æ•ˆç‡ä½ä¸‹ï¼Œè€Œä¸”æ— æ³•çœŸæ­£å»ºç«‹èµ·è§£å†³å¤æ‚é—®é¢˜çš„èƒ½åŠ›ã€‚</p><p>è¿™ç¯‡åšæ–‡çš„ç›®çš„ï¼Œå°±æ˜¯ä¸ºäº†æ‰“ç ´è¿™ç§å›°å¢ƒã€‚æˆ‘ä»¬å°†ä¸å†å­¤ç«‹åœ°çœ‹å¾…APIï¼Œè€Œæ˜¯ä»æ·±åº¦å­¦ä¹ é¡¹ç›®çš„<strong>ç¬¬ä¸€æ€§åŸç†</strong>å‡ºå‘ï¼Œå»ç†è§£ï¼š</p><ul><li><strong>ä¸ºä»€ä¹ˆä¼šæœ‰è¿™äº› APIï¼Ÿ</strong>å®ƒä»¬å„è‡ªè§£å†³äº†ä»€ä¹ˆæ ¸å¿ƒé—®é¢˜ï¼Ÿ</li><li><strong>å®ƒä»¬ä¹‹é—´æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ</strong>å¦‚ä½•ååŒå·¥ä½œï¼Œå…±åŒå®Œæˆä¸€ä¸ªä»»åŠ¡ï¼Ÿ</li></ul><p>æˆ‘ä»¬å°†ä»ä¸¤ä¸ªå±‚é¢æ¥æ„å»ºä½ çš„ PyTorch çŸ¥è¯†ä½“ç³»ï¼š</p><ol type="1"><li><strong>å®è§‚ç¯‡ï¼šæ€ç»´éª¨æ¶</strong> -æ­å»ºä¸€ä¸ªå®Œæ•´çš„æ·±åº¦å­¦ä¹ é¡¹ç›®å·¥ä½œæµï¼Œç†è§£ PyTorch çš„é¡¶å±‚è®¾è®¡ã€‚</li><li><strong>å¾®è§‚ç¯‡ï¼šæ•°æ®è¡€æ¶²</strong> - æ·±å…¥æ¨¡å‹å†…éƒ¨ï¼ŒæŒæ§ä½œä¸ºâ€œè¡€æ¶²â€çš„Tensorï¼ˆå¼ é‡ï¼‰å¦‚ä½•åœ¨å…¶é—´æµåŠ¨å’Œå˜æ¢ã€‚</li></ol><h2 id="å®è§‚ç¯‡æ­å»ºä½ çš„-pytorch-æ€ç»´éª¨æ¶">å®è§‚ç¯‡ï¼šæ­å»ºä½ çš„ PyTorchæ€ç»´éª¨æ¶</h2><h3 id="pytorch-çš„æ ¸å¿ƒè®¾è®¡å“²å­¦çµæ´»ä¸ç›´è§‚">1. PyTorchçš„æ ¸å¿ƒè®¾è®¡å“²å­¦ï¼šçµæ´»ä¸ç›´è§‚</h3><p>è¦ç†è§£ PyTorchï¼Œé¦–å…ˆè¦ç†è§£å®ƒçš„ä¸¤ä¸ªæ ¸å¿ƒç‰¹ç‚¹ï¼š</p><ol type="1"><li>åŠ¨æ€è®¡ç®—å›¾ï¼ˆDynamic Computational Graphï¼‰</li><li>Python ä¼˜å…ˆï¼ˆPython-Firstï¼‰</li></ol><p><strong>åŠ¨æ€è®¡ç®—å›¾</strong>ï¼šè¿™æ˜¯ PyTorch ä¸æ—©æœŸ TensorFlow(TensorFlow 1.x)æœ€å¤§çš„åŒºåˆ«ã€‚ä¼ ç»Ÿçš„é™æ€å›¾æ˜¯"å…ˆå®šä¹‰ï¼Œåæ‰§è¡Œ"ï¼Œä½ å¿…é¡»å…ˆæ„å»ºä¸€ä¸ªå®Œæ•´çš„è®¡ç®—å›¾ï¼Œç„¶åæ‰èƒ½é€å…¥æ•°æ®ã€‚è€ŒPyTorchçš„åŠ¨æ€å›¾æ˜¯"å³æ—¶æ‰§è¡Œ"(Define-by-Run)ï¼Œè®¡ç®—å›¾çš„æ„å»ºå’Œè®¡ç®—æ˜¯åŒæ—¶å‘ç”Ÿçš„ã€‚</p><ul><li><strong>è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ</strong>æå¤§åœ°å¢å¼ºäº†çµæ´»æ€§ã€‚å¯¹äºå¤„ç†åŠ¨æ€è¾“å…¥ï¼ˆå¦‚é•¿åº¦å¯å˜çš„æ–‡æœ¬ï¼‰çš„ NLPä»»åŠ¡ï¼Œæˆ–è€…éœ€è¦å¤æ‚æ§åˆ¶æµï¼ˆå¦‚å¾ªç¯ã€æ¡ä»¶åˆ¤æ–­ï¼‰çš„æ¨¡å‹ï¼ŒåŠ¨æ€å›¾éå¸¸ç›´è§‚å’Œæ–¹ä¾¿ã€‚è°ƒè¯•ä¹Ÿå˜å¾—å¼‚å¸¸ç®€å•ï¼Œä½ å¯ä»¥åƒè°ƒè¯•æ™®é€šPython ä»£ç ä¸€æ ·ï¼Œéšæ—¶åœä¸‹æ¥æŸ¥çœ‹ä¸­é—´å˜é‡çš„å€¼ã€‚</li><li><strong>å¯¹åº”çš„ API ä½“ç°ï¼š</strong> ä½ å†™çš„æ¯ä¸€è¡Œ PyTorchè®¡ç®—ä»£ç ï¼ˆä¾‹å¦‚<code>c = a + b</code>ï¼‰ï¼Œéƒ½åœ¨åŠ¨æ€åœ°æ„å»ºä¸€ä¸ªå¾®å°çš„è®¡ç®—å›¾ã€‚ä½ ä¸éœ€è¦ä»»ä½•ç‰¹æ®Šçš„session æˆ– placeholderã€‚</li></ul><p><strong>Python ä¼˜å…ˆ</strong>ï¼šPyTorch æ·±åº¦æ•´åˆåœ¨ Pythonç”Ÿæ€ä¸­ï¼Œå…¶è®¾è®¡å……æ»¡äº† Pythonicçš„é£æ ¼ã€‚å®ƒæ„Ÿè§‰ä¸åƒæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç¨‹åºï¼Œæ›´åƒæ˜¯ä¸€ä¸ª Python çš„è¶…å¼ºæ•°å­¦å’Œ GPUè®¡ç®—åº“ã€‚</p><ul><li><strong>è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ</strong>é™ä½äº†å­¦ä¹ é—¨æ§›ï¼Œæé«˜äº†å¼€å‘æ•ˆç‡ã€‚ç ”ç©¶äººå‘˜å’Œå¼€å‘è€…å¯ä»¥ç”¨æœ€ç†Ÿæ‚‰çš„æ–¹å¼å¿«é€Ÿè¿­ä»£æƒ³æ³•ã€‚</li><li><strong>å¯¹åº”çš„ API ä½“ç°ï¼š</strong> ä½ ä¼šå‘ç° PyTorch çš„ç±»ï¼ˆå¦‚<code>nn.Module</code>ï¼‰ã€æ•°æ®ç»“æ„ï¼ˆå¦‚ <code>Tensor</code>çš„æ“ä½œï¼‰å’Œæ•´ä½“ç¼–ç¨‹èŒƒå¼éƒ½ä¸ NumPy ç­‰å¸¸è§ Python åº“éå¸¸ç›¸ä¼¼ã€‚</li></ul><h3 id="å…¸å‹çš„æ·±åº¦å­¦ä¹ æµç¨‹ä¸-pytorch-api-çš„æ˜ å°„">2. å…¸å‹çš„æ·±åº¦å­¦ä¹ æµç¨‹ä¸PyTorch API çš„æ˜ å°„</h3><p>æˆ‘ä»¬å¯ä»¥å°†ä¸€ä¸ªå®Œæ•´çš„æ·±åº¦å­¦ä¹ é¡¹ç›®åˆ†ä¸ºå‡ ä¸ªæ ¸å¿ƒé˜¶æ®µã€‚PyTorch çš„ APIè®¾è®¡å°±æ˜¯ä¸ºäº†æœåŠ¡äºè¿™ä¸ªæµç¨‹ä¸­çš„æ¯ä¸€æ­¥ã€‚</p><ol type="1"><li>æ•°æ®å‡†å¤‡ï¼ˆThe Fuelï¼‰</li><li>æ¨¡å‹æ„å»ºï¼ˆThe Engineï¼‰</li><li>è®­ç»ƒå¾ªç¯ï¼ˆThe Driving Processï¼‰</li></ol><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250818155654972.png"alt="å…¸å‹çš„æ·±åº¦å­¦ä¹ æµç¨‹ä¸ PyTorch API çš„æ˜ å°„" /><figcaption aria-hidden="true">å…¸å‹çš„æ·±åº¦å­¦ä¹ æµç¨‹ä¸ PyTorch APIçš„æ˜ å°„</figcaption></figure><h4 id="é˜¶æ®µ-1æ•°æ®å‡†å¤‡-the-fuel">é˜¶æ®µ 1ï¼šæ•°æ®å‡†å¤‡ (The Fuel)</h4><p><strong>é¢ä¸´çš„é—®é¢˜ï¼š</strong></p><ol type="1"><li>åŸå§‹æ•°æ®æ ¼å¼å„å¼‚ï¼Œå¦‚ä½•ç»Ÿä¸€è¯»å–ï¼Ÿ</li><li>æ•°æ®é›†å¯èƒ½éå¸¸å¤§ï¼Œæ— æ³•ä¸€æ¬¡æ€§è½½å…¥å†…å­˜ï¼Œæ€ä¹ˆåŠï¼Ÿ</li><li>è®­ç»ƒæ—¶éœ€è¦å¯¹æ•°æ®è¿›è¡Œæ‰¹é‡ (batching)ã€æ‰“ä¹± (shuffling) å’Œé¢„å¤„ç†(preprocessing)ï¼Œå¦‚ä½•é«˜æ•ˆå®ç°ï¼Ÿ</li><li>å¦‚ä½•åˆ©ç”¨å¤šæ ¸ CPU æ¥åŠ é€Ÿæ•°æ®åŠ è½½ï¼Œé¿å… GPU ç­‰å¾…ï¼Ÿ</li></ol><p><strong>PyTorch çš„è§£å†³æ–¹æ¡ˆ (æ ¸å¿ƒ API):</strong><code>torch.utils.data.Dataset</code> å’Œ<code>torch.utils.data.DataLoader</code></p><p><strong>API å…³ç³»ä¸è§£æï¼š</strong></p><ul><li><code>Dataset</code>ï¼š<strong>å®ƒå®šä¹‰äº†"æ•°æ®é›†"æ˜¯ä»€ä¹ˆ</strong>ã€‚è¿™æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œä½ åªéœ€è¦ç»§æ‰¿å®ƒå¹¶å®ç°ä¸¤ä¸ªæ–¹æ³•ï¼š<code>__len__</code>(è¿”å›æ•°æ®é›†å¤§å°)å’Œ <code>__getitem__</code> (æ ¹æ®ç´¢å¼• <code>idx</code>è¿”å›ä¸€æ¡æ•°æ®)ã€‚å®ƒè§£å†³äº†â€œå¦‚ä½•è·å–å•æ¡æ•°æ®â€çš„é—®é¢˜ï¼Œå°†æ•°æ®è®¿é—®çš„é€»è¾‘å°è£…èµ·æ¥ã€‚</li><li><code>DataLoader</code>ï¼š<strong>å®ƒå®šä¹‰äº†"å¦‚ä½•ä½¿ç”¨æ•°æ®é›†"</strong>ã€‚å®ƒæ¥æ”¶ä¸€ä¸ª<code>Dataset</code> å¯¹è±¡ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šï¼Œä¼˜é›…åœ°è§£å†³äº†æ‰€æœ‰å·¥ç¨‹é—®é¢˜ï¼š<ul><li><code>batch_size</code>ï¼šè‡ªåŠ¨å°†å•æ¡æ•°æ®æ‰“åŒ…æˆä¸€ä¸ª batchã€‚</li><li><code>shuffle=True</code>ï¼šåœ¨æ¯ä¸ª epochå¼€å§‹æ—¶è‡ªåŠ¨æ‰“ä¹±æ•°æ®é¡ºåºã€‚</li><li><code>num_workers</code>ï¼šå¯åŠ¨å¤šä¸ªå­è¿›ç¨‹å¹¶è¡ŒåŠ è½½æ•°æ®ï¼Œæå¤§åœ°æé«˜äº†æ•°æ®ä¾›ç»™æ•ˆç‡ã€‚</li><li><code>collate_fn</code>ï¼šè‡ªå®šä¹‰å¦‚ä½•å°†å¤šæ¡æ ·æœ¬åˆå¹¶æˆä¸€ä¸ªbatchï¼Œå¯¹äºå¤„ç†éæ ‡å‡†æ•°æ®ï¼ˆå¦‚ä¸åŒé•¿åº¦çš„å¥å­ï¼‰éå¸¸æœ‰ç”¨ã€‚</li></ul></li></ul><p><strong>ä¸€å¥è¯æ€»ç»“ï¼š<u><code>Dataset</code>è´Ÿè´£â€œå–â€ï¼Œ<code>DataLoader</code>è´Ÿè´£â€œé€â€ã€‚å®ƒä»¬å…±åŒè§£å†³äº†æ•°æ®ä¾›ç»™çš„æ•ˆç‡å’Œæ ‡å‡†åŒ–é—®é¢˜</u>ã€‚</strong></p><p><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250819154449744.png" /></p><h4 id="é˜¶æ®µ-2æ¨¡å‹æ„å»º-the-engine">é˜¶æ®µ 2ï¼šæ¨¡å‹æ„å»º (The Engine)</h4><p><strong>é¢ä¸´çš„é—®é¢˜ï¼š</strong></p><ol type="1"><li>å¦‚ä½•å®šä¹‰ä¸€ä¸ªç¥ç»ç½‘ç»œç»“æ„ï¼Ÿ</li><li>ç½‘ç»œä¸­åŒ…å«å¤§é‡éœ€è¦å­¦ä¹ çš„å‚æ•°ï¼ˆæƒé‡ <code>weights</code> å’Œåç½®<code>biases</code>ï¼‰ï¼Œå¦‚ä½•æœ‰æ•ˆåœ°ç®¡ç†å®ƒä»¬ï¼Ÿ</li><li>å¦‚ä½•å®ç°å‰å‘ä¼ æ’­ (forward pass) çš„è®¡ç®—é€»è¾‘ï¼Ÿ</li><li>å¦‚ä½•æ–¹ä¾¿åœ°åœ¨ CPU å’Œ GPU ä¹‹é—´åˆ‡æ¢æ¨¡å‹ï¼Ÿ</li></ol><p><strong>PyTorch çš„è§£å†³æ–¹æ¡ˆ (æ ¸å¿ƒ API):</strong><code>torch.nn.Module</code></p><p><strong>API å…³ç³»ä¸è§£æï¼š</strong></p><ul><li><p><code>torch.Tensor</code>ï¼š<strong>è¿™æ˜¯ PyTorchçš„åŸºçŸ³</strong>ã€‚å®ƒä¸ä»…ä»…æ˜¯ä¸€ä¸ªåƒ NumPy <code>ndarray</code>ä¸€æ ·çš„å¤šç»´æ•°ç»„ï¼Œå®ƒè¿˜æ‰¿è½½äº†å¦å¤–ä¸¤ä¸ªè‡³å…³é‡è¦çš„ä¿¡æ¯ï¼š</p><ul><li><code>grad_fn</code>ï¼šæŒ‡å‘åˆ›å»ºè¿™ä¸ªå¼ é‡çš„å‡½æ•°ï¼Œç”¨äºæ„å»ºåå‘ä¼ æ’­çš„è®¡ç®—å›¾ã€‚</li><li><code>grad</code>ï¼šå­˜å‚¨è¯¥å¼ é‡çš„æ¢¯åº¦ã€‚ ä½ å¯ä»¥é€šè¿‡<code>tensor.to('cuda')</code> è½»æ¾åœ°å°†å…¶ç§»åŠ¨åˆ° GPUã€‚</li></ul></li><li><p><code>torch.nn.Module</code>ï¼š<strong>æ‰€æœ‰ç¥ç»ç½‘ç»œå±‚çš„åŸºç±»</strong>ã€‚ä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆä¸€ä¸ªå®¹å™¨æˆ–ä¸€ä¸ªé›¶ä»¶ã€‚</p><ul><li>åœ¨ <code>__init__</code> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰æ¨¡å‹çš„"é›¶ä»¶"ï¼Œä¾‹å¦‚<code>self.conv1 = nn.Conv2d(...)</code>ï¼Œ<code>self.fc1 = nn.Linear(...)</code>ã€‚å½“ä½ å®šä¹‰è¿™äº›å±‚æ—¶ï¼ŒPyTorchä¼šè‡ªåŠ¨å°†å®ƒä»¬çš„å‚æ•°æ³¨å†Œåˆ°è¿™ä¸ª <code>Module</code> ä¸­ã€‚</li><li>åœ¨ <code>forward</code>æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰è¿™äº›"é›¶ä»¶"å¦‚ä½•è¿æ¥èµ·æ¥ï¼Œå®Œæˆä»è¾“å…¥åˆ°è¾“å‡ºçš„è®¡ç®—ã€‚</li></ul></li><li><p><strong>ä¸ºä»€ä¹ˆéœ€è¦ <code>nn.Module</code>è€Œä¸æ˜¯ç›´æ¥ç”¨å‡½æ•°ï¼Ÿ</strong></p><p>å› ä¸º <code>nn.Module</code> å¸®ä½ è‡ªåŠ¨å¤„ç†äº†å‚æ•°ç®¡ç†ã€‚ä½ åªéœ€è¦è°ƒç”¨<code>model.parameters()</code>å°±å¯ä»¥è·å–æ¨¡å‹ä¸­æ‰€æœ‰éœ€è¦è®­ç»ƒçš„å‚æ•°ï¼Œè€Œä¸éœ€è¦æ‰‹åŠ¨å»è¿½è¸ªæ¯ä¸€ä¸ªæƒé‡å’Œåç½®ã€‚å®ƒè¿˜æä¾›äº†<code>model.train()</code> å’Œ <code>model.eval()</code>æ¨¡å¼åˆ‡æ¢ç­‰ä¾¿åˆ©åŠŸèƒ½ï¼Œç”¨äºæ§åˆ¶ <code>Dropout</code> å’Œ<code>BatchNorm</code> ç­‰å±‚çš„è¡Œä¸ºã€‚</p></li></ul><p><strong>ä¸€å¥è¯æ€»ç»“ï¼š<u>æˆ‘ä»¬ç”¨ <code>Tensor</code> ä½œä¸ºæ•°æ®æµï¼Œç”¨<code>nn.Module</code> å°†ç¥ç»ç½‘ç»œçš„â€œéª¨æ¶â€å’Œâ€œå‚æ•°â€ç»„ç»‡èµ·æ¥ï¼Œå¹¶åœ¨<code>forward</code>æ–¹æ³•ä¸­å®šä¹‰æ•°æ®å¦‚ä½•åœ¨è¿™ä¸ªéª¨æ¶ä¸­æµåŠ¨ã€‚</u></strong></p><h4 id="é˜¶æ®µ-3è®­ç»ƒå¾ªç¯-the-driving-process">é˜¶æ®µ 3ï¼šè®­ç»ƒå¾ªç¯ (TheDriving Process)</h4><p>è¿™æ˜¯æ•´ä¸ªæµç¨‹çš„æ ¸å¿ƒï¼Œæ¶‰åŠåˆ°æŸå¤±è®¡ç®—ã€åå‘ä¼ æ’­å’Œå‚æ•°æ›´æ–°ã€‚</p><p><strong>é¢ä¸´çš„é—®é¢˜ï¼š</strong></p><ol type="1"><li>æ¨¡å‹è¾“å‡ºå’ŒçœŸå®æ ‡ç­¾ä¹‹é—´çš„å·®è·ï¼ˆæŸå¤±ï¼‰å¦‚ä½•è®¡ç®—ï¼Ÿ</li><li>å¦‚ä½•æ ¹æ®æŸå¤±è®¡ç®—å‡ºæ¨¡å‹ä¸­æ¯ä¸ªå‚æ•°çš„æ¢¯åº¦ (gradient)ï¼Ÿ</li><li>å¦‚ä½•æ ¹æ®æ¢¯åº¦æ¥æ›´æ–°å‚æ•°ï¼Œä»¥ä½¿æŸå¤±å˜å°ï¼Ÿ</li></ol><p><strong>PyTorch çš„è§£å†³æ–¹æ¡ˆ (æ ¸å¿ƒ API):</strong><code>torch.autograd</code>, <code>loss functions</code>,<code>torch.optim</code></p><p><strong>API å…³ç³»ä¸è§£æï¼š</strong></p><ol type="1"><li><strong>æŸå¤±å‡½æ•° (Loss Function)</strong> - ä¾‹å¦‚<code>nn.CrossEntropyLoss</code>, <code>nn.MSELoss</code><ul><li><strong>ä½œç”¨ï¼š</strong> è¡¡é‡æ¨¡å‹é¢„æµ‹å€¼ <code>output</code> å’ŒçœŸå®å€¼<code>target</code> ä¹‹é—´çš„å·®è·ï¼Œè®¡ç®—å‡ºä¸€ä¸ªæ ‡é‡å€¼ <code>loss</code>ã€‚è¿™ä¸ª<code>loss</code> å°±æ˜¯æˆ‘ä»¬ä¼˜åŒ–çš„ç›®æ ‡ï¼Œæˆ‘ä»¬å¸Œæœ›å®ƒè¶Šå°è¶Šå¥½ã€‚</li></ul></li><li><strong>è‡ªåŠ¨æ±‚å¯¼ç³»ç»Ÿ (Autograd)</strong> -<code>loss.backward()</code><ul><li><strong>ä½œç”¨ï¼š</strong> è¿™æ˜¯ PyTorch çš„é­”æ³•æ ¸å¿ƒã€‚å½“ä½ å¯¹ä¸€ä¸ª<code>requires_grad=True</code> çš„ <code>Tensor</code>ï¼ˆæˆ‘ä»¬çš„<code>loss</code> å°±æ˜¯ï¼‰è°ƒç”¨ <code>.backward()</code> æ–¹æ³•æ—¶ï¼ŒPyTorchä¼šè‡ªåŠ¨æ²¿ç€è®¡ç®—å›¾åå‘ä¼ æ’­ï¼Œè®¡ç®—å‡ºå›¾ä¸­æ‰€æœ‰ <code>requires_grad=True</code>çš„å¶å­èŠ‚ç‚¹ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬æ¨¡å‹çš„å‚æ•° <code>model.parameters()</code>ï¼‰ç›¸å¯¹äº<code>loss</code>çš„æ¢¯åº¦ï¼Œå¹¶æŠŠç»“æœç´¯åŠ åˆ°è¿™äº›å‚æ•°çš„ <code>.grad</code>å±æ€§ä¸Šã€‚</li><li><strong>å®ƒè§£å†³äº†ä»€ä¹ˆï¼Ÿ</strong>è§£å†³äº†æ·±åº¦å­¦ä¹ ä¸­æœ€å¤æ‚ã€æœ€å®¹æ˜“å‡ºé”™çš„æ•°å­¦é—®é¢˜â€”â€”æ¢¯åº¦è®¡ç®—ã€‚ä½ ä¸éœ€è¦æ‰‹åŠ¨å»æ¨å¯¼å’Œå®ç°é“¾å¼æ³•åˆ™ã€‚</li></ul></li><li><strong>ä¼˜åŒ–å™¨ (Optimizer)</strong> - <code>torch.optim</code> (ä¾‹å¦‚<code>optim.SGD</code>, <code>optim.Adam</code>)<ul><li><strong>ä½œç”¨ï¼š</strong> å®ƒæ ¹æ®è®¡ç®—å‡ºçš„æ¢¯åº¦æ¥æ›´æ–°æ¨¡å‹çš„å‚æ•°ã€‚</li><li><strong>å·¥ä½œæµç¨‹ï¼ˆä¸‰æ­¥æ›²ï¼‰ï¼š</strong> a.<code>optimizer.zero_grad()</code>ï¼šæ¸…ç©ºä¸Šä¸€è½®è¿­ä»£ä¸­ç´¯ç§¯çš„æ¢¯åº¦ã€‚å› ä¸ºPyTorch çš„æ¢¯åº¦æ˜¯ç´¯åŠ çš„ (<code>+=</code>)ï¼Œæ‰€ä»¥æ¯è½®æ›´æ–°å‰å¿…é¡»æ‰‹åŠ¨æ¸…é›¶ã€‚b. <code>loss.backward()</code>ï¼šè®¡ç®—å½“å‰ batch çš„æ¢¯åº¦ã€‚ c.<code>optimizer.step()</code>ï¼šæ ¹æ®æ¢¯åº¦æ›´æ–°å‚æ•°ã€‚ä¼˜åŒ–å™¨ä¼šæ ¹æ®è‡ªèº«çš„ç®—æ³•ï¼ˆå¦‚SGD, Adamï¼‰æ¥æ‰§è¡Œ <code>w = w - learning_rate * w.grad</code>è¿™æ ·çš„æ›´æ–°æ“ä½œã€‚</li></ul></li></ol><p><strong>ä¸€å¥è¯æ€»ç»“ï¼š<u><code>æŸå¤±å‡½æ•°</code>å‘Šè¯‰æˆ‘ä»¬"é”™çš„æœ‰å¤šç¦»è°±"ï¼Œ<code>loss.backward()</code>å‘Šè¯‰æˆ‘ä»¬"æ¯ä¸ªå‚æ•°åº”è¯¥æœå“ªä¸ªæ–¹å‘æ”¹"ï¼Œ<code>optimizer.step()</code>è´Ÿè´£"å®é™…å»æ”¹è¿™äº›å‚æ•°"ã€‚è¿™ä¸‰è€…æ„æˆäº†è®­ç»ƒçš„æ ¸å¿ƒé—­ç¯</u>ã€‚</strong></p><h3 id="ä»£ç ç¤ºä¾‹">3. ä»£ç ç¤ºä¾‹</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> TensorDataset, DataLoader</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. æ•°æ®å‡†å¤‡ (Data Preparation)</span></span><br><span class="line"><span class="comment"># å‡è®¾æˆ‘ä»¬æœ‰ 100 ä¸ªæ ·æœ¬ï¼Œæ¯ä¸ªæ ·æœ¬ 10 ä¸ªç‰¹å¾ï¼Œæ ‡ç­¾æ˜¯ 0 æˆ– 1</span></span><br><span class="line">X_train = torch.randn(<span class="number">100</span>, <span class="number">10</span>)</span><br><span class="line">y_train = torch.randint(<span class="number">0</span>, <span class="number">2</span>, (<span class="number">100</span>,)).<span class="built_in">float</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ Dataset å’Œ DataLoader å°è£…æ•°æ®</span></span><br><span class="line"><span class="comment"># TensorDataset æ˜¯ä¸€ä¸ªæ–¹ä¾¿çš„åŒ…è£…å™¨</span></span><br><span class="line">dataset = TensorDataset(X_train, y_train)</span><br><span class="line"><span class="comment"># DataLoader è´Ÿè´£æ‰¹é‡ã€æ‰“ä¹±ç­‰</span></span><br><span class="line">dataloader = DataLoader(dataset, batch_size=<span class="number">16</span>, shuffle=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. æ¨¡å‹æ„å»º (Model Building)</span></span><br><span class="line"><span class="comment"># ç»§æ‰¿ nn.Module æ¥å®šä¹‰æˆ‘ä»¬è‡ªå·±çš„æ¨¡å‹</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleModel</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="comment"># åœ¨ __init__ ä¸­å®šä¹‰æ¨¡å‹çš„å±‚ï¼ˆé›¶ä»¶ï¼‰</span></span><br><span class="line">        <span class="variable language_">self</span>.layer1 = nn.Linear(<span class="number">10</span>, <span class="number">5</span>) <span class="comment"># è¾“å…¥ 10 ç‰¹å¾ï¼Œè¾“å‡º 5 ç‰¹å¾</span></span><br><span class="line">        <span class="variable language_">self</span>.activation = nn.ReLU()</span><br><span class="line">        <span class="variable language_">self</span>.layer2 = nn.Linear(<span class="number">5</span>, <span class="number">1</span>)  <span class="comment"># è¾“å…¥ 5 ç‰¹å¾ï¼Œè¾“å‡º 1 ç‰¹å¾</span></span><br><span class="line">        <span class="variable language_">self</span>.sigmoid = nn.Sigmoid()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="comment"># åœ¨ forward ä¸­å®šä¹‰æ•°æ®å¦‚ä½•æµåŠ¨</span></span><br><span class="line">        x = <span class="variable language_">self</span>.layer1(x)</span><br><span class="line">        x = <span class="variable language_">self</span>.activation(x)</span><br><span class="line">        x = <span class="variable language_">self</span>.layer2(x)</span><br><span class="line">        x = <span class="variable language_">self</span>.sigmoid(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">model = SimpleModel()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. å®šä¹‰æŸå¤±å‡½æ•°å’Œä¼˜åŒ–å™¨ (Loss &amp; Optimizer)</span></span><br><span class="line">criterion = nn.BCELoss() <span class="comment"># äºŒåˆ†ç±»äº¤å‰ç†µæŸå¤±</span></span><br><span class="line">optimizer = torch.optim.SGD(model.parameters(), lr=<span class="number">0.01</span>) <span class="comment"># éšæœºæ¢¯åº¦ä¸‹é™ä¼˜åŒ–å™¨</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. è®­ç»ƒå¾ªç¯ (Training Loop)</span></span><br><span class="line">num_epochs = <span class="number">5</span></span><br><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(num_epochs):</span><br><span class="line">    <span class="keyword">for</span> inputs, labels <span class="keyword">in</span> dataloader: <span class="comment"># DataLoader è‡ªåŠ¨æä¾› batch</span></span><br><span class="line">        <span class="comment"># a. å‰å‘ä¼ æ’­</span></span><br><span class="line">        outputs = model(inputs)</span><br><span class="line">        loss = criterion(outputs.squeeze(), labels)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># b. åå‘ä¼ æ’­ä¸ä¼˜åŒ–ï¼ˆä¸‰æ­¥æ›²ï¼‰</span></span><br><span class="line">        optimizer.zero_grad()  <span class="comment"># 1. æ¢¯åº¦æ¸…é›¶</span></span><br><span class="line">        loss.backward()        <span class="comment"># 2. è®¡ç®—æ¢¯åº¦</span></span><br><span class="line">        optimizer.step()       <span class="comment"># 3. æ›´æ–°å‚æ•°</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;Epoch [<span class="subst">&#123;epoch+<span class="number">1</span>&#125;</span>/<span class="subst">&#123;num_epochs&#125;</span>], Loss: <span class="subst">&#123;loss.item():<span class="number">.4</span>f&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure><blockquote><p>æˆ–è€…å¯ä»¥å‚è€ƒç¬”è€…åœ¨å­¦ä¹  <ahref="https://github.com/rasbt/LLMs-from-scratch">Build a Large LanguageModel (From Scratch)</a> ä¸€ä¹¦æ—¶å®è·µçš„è®­ç»ƒ GPT-2 å¤§æ¨¡å‹çš„<ahref="https://github.com/hedon-ai-road/llm-from-scratch/blob/main/5-%E8%AE%AD%E7%BB%83%E5%A4%A7%E6%A8%A1%E5%9E%8B.ipynb">ä»£ç </a>ï¼Œä¼šæ›´å¤æ‚å…·ä½“äº›ã€‚</p></blockquote><p>ç°åœ¨å†å›è¿‡å¤´çœ‹ PyTorch çš„ä¼—å¤šAPIï¼Œä½ ä¼šå‘ç°å®ƒä»¬éƒ½å¯ä»¥å½’å…¥ä¸Šè¿°çš„æ¡†æ¶ä¸­ï¼š</p><ul><li><strong>æ•°æ®å±‚(<code>torch.utils.data</code>)</strong>ï¼šä¸€åˆ‡ä¸ºäº†é«˜æ•ˆã€æ ‡å‡†åœ°æä¾›æ•°æ®ã€‚</li><li><strong>æ¨¡å‹å±‚(<code>torch.nn</code>)</strong>ï¼šä¸€åˆ‡ä¸ºäº†çµæ´»ã€æ–¹ä¾¿åœ°æ­å»ºå’Œç®¡ç†æ¨¡å‹ã€‚<code>nn.Conv2d</code>,<code>nn.LSTM</code>, <code>nn.Transformer</code> éƒ½æ˜¯é¢„å…ˆå®ç°å¥½çš„<code>nn.Module</code> "é›¶ä»¶"ã€‚<code>nn.functional</code>é‡Œæ˜¯å¯¹åº”çš„æ— çŠ¶æ€å‡½æ•°ç‰ˆæœ¬ï¼ˆä¾‹å¦‚ <code>F.relu</code>ï¼‰ï¼Œé€šå¸¸åœ¨<code>forward</code> ä¸­ä½¿ç”¨ã€‚</li><li><strong>è‡ªåŠ¨æ±‚å¯¼å±‚(<code>torch.autograd</code>)</strong>ï¼šè®­ç»ƒçš„å¹•åè‹±é›„ï¼Œé»˜é»˜åœ°å¤„ç†æœ€å¤æ‚çš„æ•°å­¦ã€‚</li><li><strong>ä¼˜åŒ–å±‚(<code>torch.optim</code>)</strong>ï¼šåº”ç”¨æ¢¯åº¦çš„ä¸åŒç­–ç•¥ï¼Œå†³å®šäº†æ¨¡å‹å‚æ•°å¦‚ä½•è¢«æ›´æ–°ã€‚</li><li><strong>åŸºç¡€ (<code>torch</code>)</strong>ï¼šæ ¸å¿ƒæ•°æ®ç»“æ„<code>Tensor</code> ä»¥åŠå¤§é‡çš„æ•°å­¦è¿ç®—ã€‚</li></ul><h2 id="å¾®è§‚ç¯‡æŒæ§-tensor-çš„ä¸ƒåäºŒå˜">å¾®è§‚ç¯‡ï¼šæŒæ§ Tensorçš„"ä¸ƒåäºŒå˜"</h2><p>å¦‚æœè¯´ç†è§£å·¥ä½œæµæ˜¯æŒæ¡äº†"éª¨æ¶"ï¼Œé‚£ä¹ˆç†è§£ Tensorçš„å½¢çŠ¶å˜åŒ–å°±æ˜¯æŒæ¡äº†"è¡€æ¶²"åœ¨éª¨æ¶ä¸­çš„æµåŠ¨æ–¹å¼ã€‚å‡ ä¹ 80% çš„ PyTorch æ–°æ‰‹bug éƒ½å’Œ Tensor shapeï¼ˆå¼ é‡å½¢çŠ¶ï¼‰ä¸åŒ¹é…æœ‰å…³ã€‚</p><p>å»¶ç»­ä¹‹å‰çš„æ€è·¯ï¼Œæˆ‘ä»¬ä¾ç„¶ä¸å­¤ç«‹åœ°çœ‹ APIï¼Œè€Œæ˜¯å°†å®ƒä»¬æ”¾å…¥<strong>"ä¸ºä»€ä¹ˆéœ€è¦å˜ -&gt; åœ¨å“ªé‡Œå˜ -&gt; å¦‚ä½•å˜"</strong>çš„é€»è¾‘æ¡†æ¶ä¸­ï¼Œç”±æµ…å…¥æ·±åœ°è¿›è¡Œæ‹†è§£ã€‚</p><h3 id="æ ¸å¿ƒå¿ƒæ™ºæ¨¡å‹shape-is-semanticså½¢çŠ¶å³è¯­ä¹‰">1. æ ¸å¿ƒå¿ƒæ™ºæ¨¡å‹ï¼šShapeis Semanticsï¼ˆå½¢çŠ¶å³è¯­ä¹‰ï¼‰</h3><p>åœ¨æ·±å…¥ API ä¹‹å‰ï¼Œè¯·å…ˆå»ºç«‹ä¸€ä¸ªæœ€é‡è¦çš„å¿ƒæ™ºæ¨¡å‹ï¼š<u><strong>Tensorçš„æ¯ä¸€ä¸ªç»´åº¦ (dimension) éƒ½æœ‰å…¶ç‰¹å®šçš„è¯­ä¹‰å«ä¹‰</strong></u>ã€‚</p><p>ä¸€ä¸ªå…¸å‹çš„ 4D Tensor <code>(B, C, H, W)</code> åœ¨è®¡ç®—æœºè§†è§‰ä¸­ï¼Œå…¶å½¢çŠ¶<code>(16, 3, 224, 224)</code> å¹¶ä¸æ˜¯ä¸€ä¸²å­¤ç«‹çš„æ•°å­—ï¼Œå®ƒçš„æ„æ€æ˜¯ï¼š</p><ul><li><strong>B (Batch size) = 16</strong>: è¿™ä¸ª Tensor é‡Œæœ‰ 16å¼ ç‹¬ç«‹çš„å›¾åƒã€‚</li><li><strong>C (Channels) = 3</strong>: æ¯å¼ å›¾åƒæœ‰ 3 ä¸ªé€šé“ï¼ˆR, G,Bï¼‰ã€‚</li><li><strong>H (Height) = 224</strong>: æ¯å¼ å›¾åƒçš„é«˜åº¦æ˜¯ 224 åƒç´ ã€‚</li><li><strong>W (Width) = 224</strong>: æ¯å¼ å›¾åƒçš„å®½åº¦æ˜¯ 224 åƒç´ ã€‚</li></ul><p><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250818160244493.png" alt="Tensor çš„æ¯ä¸€ä¸ªç»´åº¦éƒ½æœ‰å…¶ç‰¹å®šçš„è¯­ä¹‰å«ä¹‰" style="zoom:50%;" /></p><p><strong>æ‰€æœ‰å½¢çŠ¶å˜æ¢çš„æ ¹æœ¬åŸå› ï¼Œéƒ½æ˜¯ä¸ºäº†åŒ¹é…ä¸‹æ¸¸æ“ä½œï¼ˆæ¯”å¦‚ä¸€ä¸ªç½‘ç»œå±‚ï¼‰æ‰€æœŸæœ›çš„"è¯­ä¹‰"ã€‚</strong>å½“ä½ é‡åˆ°å½¢çŠ¶é”™è¯¯æ—¶ï¼Œä¸è¦åªæƒ³ç€"æˆ‘è¦æŠŠè¿™ä¸ª <code>(16, 512)</code> å˜æˆ<code>(16, 1, 512)</code>"ï¼Œè€Œåº”è¯¥å»æƒ³ï¼š"æˆ‘å½“å‰çš„æ•°æ®è¯­ä¹‰æ˜¯<code>(æ‰¹é‡, ç‰¹å¾)</code>ï¼Œä½†ä¸‹ä¸€å±‚éœ€è¦çš„æ˜¯<code>(æ‰¹é‡, é€šé“, é•¿åº¦)</code>ï¼Œæ‰€ä»¥æˆ‘éœ€è¦å¢åŠ ä¸€ä¸ª'é€šé“'ç»´"ã€‚</p><p>å¸¦ç€è¿™ä¸ªå¿ƒæ™ºæ¨¡å‹ï¼Œæˆ‘ä»¬æ¥çœ‹ Tensor çš„å½¢çŠ¶å˜æ¢åœ¨æ•´ä¸ªæµç¨‹ä¸­çš„è§’è‰²ã€‚</p><h3 id="tensor-å½¢çŠ¶å˜æ¢çš„åœºæ™¯ä¸åŠ¨æœº">2. Tensor å½¢çŠ¶å˜æ¢çš„åœºæ™¯ä¸åŠ¨æœº</h3><h4 id="é˜¶æ®µ-1æ•°æ®å‡†å¤‡é˜¶æ®µ-æ ‡å‡†åŒ–">é˜¶æ®µ 1ï¼šæ•°æ®å‡†å¤‡é˜¶æ®µ (æ ‡å‡†åŒ–)</h4><p><strong>é¢ä¸´çš„é—®é¢˜ï¼š</strong> åŸå§‹æ•°æ®ï¼ˆä¾‹å¦‚ä¸€å¼ ç£ç›˜ä¸Šçš„ JPEGå›¾ç‰‡ï¼‰å¹¶ä¸æ˜¯ Tensorã€‚å³ä½¿è½¬æ¢æˆäº†Tensorï¼Œå…¶ç»´åº¦ä¹Ÿå¯èƒ½ä¸ç¬¦åˆæ¨¡å‹è®­ç»ƒçš„éœ€è¦ã€‚</p><p><strong>æ ¸å¿ƒåŠ¨æœºï¼š</strong><strong>æ ‡å‡†åŒ–</strong>ã€‚å°†åƒå·®ä¸‡åˆ«çš„å•ä¸ªæ•°æ®ç‚¹ï¼Œç»Ÿä¸€æˆå¯ä»¥è¢«æ¨¡å‹æ‰¹é‡å¤„ç†çš„æ ‡å‡†æ ¼å¼ã€‚</p><p><strong>å…³é”®å˜æ¢ï¼šå¢åŠ  Batch ç»´åº¦</strong></p><ul><li><p><strong>ä¸ºä»€ä¹ˆï¼Ÿ</strong>æ·±åº¦å­¦ä¹ è®­ç»ƒæ˜¯åŸºäº"å°æ‰¹é‡æ¢¯åº¦ä¸‹é™"(Mini-batch Gradient Descent)çš„ã€‚æˆ‘ä»¬ä¸ä¼šä¸€æ¬¡åªå–‚ç»™æ¨¡å‹ä¸€å¼ å›¾ç‰‡ï¼Œè€Œæ˜¯å–‚ä¸€æ‰¹ã€‚è¿™æœ‰ä¸¤ä¸ªå¥½å¤„ï¼š</p><ol type="1"><li>ç¡¬ä»¶ï¼ˆç‰¹åˆ«æ˜¯ GPUï¼‰å¹¶è¡Œå¤„ç†ä¸€ä¸ª batch çš„æ•°æ®æ•ˆç‡æé«˜ï¼›</li><li>ä¸€ä¸ª batchçš„å¹³å‡æ¢¯åº¦æ¯”å•ä¸ªæ ·æœ¬çš„æ¢¯åº¦æ›´èƒ½ä»£è¡¨æ•´ä½“æ•°æ®ï¼Œä½¿è®­ç»ƒæ›´ç¨³å®šã€‚</li></ol></li><li><p><strong>å¦‚ä½•å®ç°ï¼Ÿ</strong></p><ul><li><p><strong>è‡ªåŠ¨å¤„ç†ï¼š</strong> <code>DataLoader</code> åœ¨ä½ ä»<code>Dataset</code> å–æ•°æ®æ—¶ï¼Œä¼šè‡ªåŠ¨å¸®ä½ æŠŠå¤šä¸ªå•ä¸€æ ·æœ¬å †å  (stack)åœ¨ä¸€èµ·ï¼Œåœ¨æœ€å‰é¢å¢åŠ ä¸€ä¸ª Batch ç»´åº¦ã€‚å¦‚æœä½ ä» <code>Dataset</code>å–å‡ºçš„å•å¼ å›¾ç‰‡ Tensor æ˜¯ <code>(C, H, W)</code>ï¼Œ<code>DataLoader</code>ä¼šè¾“å‡ºä¸€ä¸ª <code>(B, C, H, W)</code> çš„ Tensorã€‚</p></li><li><p><strong>æ‰‹åŠ¨å¤„ç†ï¼š</strong> å¦‚æœä½ åªæœ‰ä¸€ä¸ªæ ·æœ¬ï¼Œä½†æ¨¡å‹éœ€è¦ä¸€ä¸ªbatch è¾“å…¥ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>torch.unsqueeze(0)</code> åœ¨ç¬¬ 0ç»´å¢åŠ ä¸€ä¸ªç»´åº¦ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸€å¼ å›¾ç‰‡ï¼Œå½¢çŠ¶ä¸º (3, 224, 224)</span></span><br><span class="line">single_image = torch.randn(<span class="number">3</span>, <span class="number">224</span>, <span class="number">224</span>)</span><br><span class="line"><span class="comment"># æ¨¡å‹éœ€è¦ batch è¾“å…¥ï¼Œæ‰‹åŠ¨å¢åŠ  batch ç»´</span></span><br><span class="line"><span class="comment"># å½¢çŠ¶å˜ä¸º (1, 3, 224, 224)</span></span><br><span class="line">batched_image = single_image.unsqueeze(<span class="number">0</span>)</span><br></pre></td></tr></table></figure></li></ul></li></ul><h4 id="é˜¶æ®µ-2æ¨¡å‹å†…éƒ¨-forward-ä¼ æ’­-ä»ä¸€ç§å½¢æ€åˆ°å¦ä¸€ç§å½¢æ€">é˜¶æ®µ2ï¼šæ¨¡å‹å†…éƒ¨ (<code>forward</code> ä¼ æ’­) (ä»ä¸€ç§å½¢æ€åˆ°å¦ä¸€ç§å½¢æ€)</h4><p>è¿™æ˜¯å½¢çŠ¶å˜æ¢æœ€é¢‘ç¹ã€æœ€æ ¸å¿ƒçš„åŒºåŸŸã€‚</p><ul><li><strong>é¢ä¸´çš„é—®é¢˜ï¼š</strong>æ•°æ®åœ¨æµç»ä¸åŒç±»å‹çš„ç¥ç»ç½‘ç»œå±‚æ—¶ï¼Œéœ€è¦ç¬¦åˆæ¯ä¸€å±‚å¯¹è¾“å…¥å½¢çŠ¶çš„ç‰¹å®šè¦æ±‚ã€‚</li><li><strong>æ ¸å¿ƒåŠ¨æœºï¼š</strong><strong>åŒ¹é…æ¥å£</strong>ã€‚å°±åƒä¸åŒè§„æ ¼çš„ç®¡é“éœ€è¦è½¬æ¥å¤´ä¸€æ ·ï¼Œä¸åŒç½‘ç»œå±‚ä¹‹é—´éœ€è¦å½¢çŠ¶å˜æ¢æ¥â€œè½¬æ¥â€ã€‚</li></ul><p>ä¸‹é¢æ˜¯å‡ ç§æœ€å¸¸è§çš„å˜æ¢åœºæ™¯ï¼š</p><p><strong>åœºæ™¯ A: "å‹å¹³" - ä»å·ç§¯åˆ°å…¨è¿æ¥</strong></p><ul><li><p><strong>ä¸ºä»€ä¹ˆï¼Ÿ</strong> å·ç§¯å±‚ (<code>nn.Conv2d</code>)éå¸¸æ“…é•¿å¤„ç†å…·æœ‰ç©ºé—´ç»“æ„çš„æ•°æ®ï¼ˆå¦‚å›¾åƒï¼‰ï¼Œå®ƒçš„è¾“å‡ºé€šå¸¸æ˜¯ 4D çš„<code>(B, C_out, H_out, W_out)</code>ï¼Œä¿ç•™äº†ç©ºé—´ä¿¡æ¯ã€‚ä½†æ˜¯ï¼Œå…¨è¿æ¥å±‚(<code>nn.Linear</code>) é€šå¸¸ç”¨äºæœ€åé˜¶æ®µçš„åˆ†ç±»æˆ–å›å½’ï¼Œå®ƒæœŸæœ›çš„è¾“å…¥æ˜¯ 2Dçš„<code>(B, num_features)</code>ï¼Œå³æŠŠæ¯ä¸ªæ ·æœ¬çš„æ‰€æœ‰ç‰¹å¾"æ‹‰å¹³"æˆä¸€ä¸ªé•¿å‘é‡ã€‚</p></li><li><p><strong>å¦‚ä½•å®ç°ï¼Ÿ</strong> <code>view</code>,<code>reshape</code>, <code>flatten</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å‡è®¾ç»è¿‡å·ç§¯å’Œæ± åŒ–åï¼Œè¾“å‡ºå½¢çŠ¶ä¸º (16, 64, 7, 7)</span></span><br><span class="line">conv_output = torch.randn(<span class="number">16</span>, <span class="number">64</span>, <span class="number">7</span>, <span class="number">7</span>)</span><br><span class="line"><span class="comment"># æˆ‘ä»¬éœ€è¦å°†å…¶é€å…¥ä¸€ä¸ª nn.Linear(64 * 7 * 7, 100) çš„å±‚</span></span><br><span class="line"><span class="comment"># batch_size ç»´åº¦éœ€è¦ä¿ç•™</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹æ³•1: ä½¿ç”¨ view (æ•ˆç‡é«˜ï¼Œä½†ä¸ä¿è¯å†…å­˜è¿ç»­)</span></span><br><span class="line"><span class="comment"># -1 ä¼šè‡ªåŠ¨è®¡ç®—è¯¥ç»´åº¦çš„å¤§å°</span></span><br><span class="line">linear_input = conv_output.view(<span class="number">16</span>, -<span class="number">1</span>) <span class="comment"># å½¢çŠ¶å˜ä¸º (16, 3136)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹æ³•2: ä½¿ç”¨ reshape (æ›´å®‰å…¨ï¼Œä¼šè‡ªåŠ¨å¤„ç†å†…å­˜é—®é¢˜)</span></span><br><span class="line">linear_input = conv_output.reshape(<span class="number">16</span>, -<span class="number">1</span>) <span class="comment"># å½¢çŠ¶å˜ä¸º (16, 3136)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹æ³•3: ä½¿ç”¨ flatten (æ›´è¯­ä¹‰åŒ–ï¼Œæ¨è)</span></span><br><span class="line"><span class="comment"># start_dim=1 è¡¨ç¤ºä»ç¬¬1ä¸ªç»´åº¦ï¼ˆChannels ç»´ï¼‰å¼€å§‹å‹å¹³</span></span><br><span class="line">linear_input = torch.flatten(conv_output, start_dim=<span class="number">1</span>) <span class="comment"># å½¢çŠ¶å˜ä¸º (16, 3136)</span></span><br></pre></td></tr></table></figure></li></ul><p><strong>åœºæ™¯ B: "æ¢ä½" - è°ƒæ•´ç»´åº¦é¡ºåº</strong></p><ul><li><p><strong>ä¸ºä»€ä¹ˆï¼Ÿ</strong>ä¸åŒçš„åº“æˆ–ç‰¹å®šçš„å±‚å¯¹ç»´åº¦çš„è¯­ä¹‰é¡ºåºæœ‰ä¸åŒçš„è¦æ±‚ã€‚</p><ul><li><strong>ç»å…¸æ¡ˆä¾‹ 1 (å›¾åƒ)ï¼š</strong> Matplotlib æˆ– OpenCVå¤„ç†å›¾åƒæ—¶ï¼Œé€šé“ç»´é€šå¸¸åœ¨æœ€å <code>(H, W, C)</code>ã€‚è€Œ PyTorchçš„å·ç§¯å±‚è¦æ±‚é€šé“ç»´åœ¨å‰ <code>(C, H, W)</code>ã€‚</li><li><strong>ç»å…¸æ¡ˆä¾‹ 2 (NLP)ï¼š</strong> PyTorch çš„<code>nn.Transformer</code> é»˜è®¤æœŸæœ›çš„è¾“å…¥æ˜¯<code>(åºåˆ—é•¿åº¦, æ‰¹é‡å¤§å°, ç‰¹å¾ç»´åº¦)</code>ï¼Œè€Œå¾ˆå¤šæ—¶å€™æˆ‘ä»¬å¤„ç†æ•°æ®æ—¶æ›´ä¹ æƒ¯<code>(æ‰¹é‡å¤§å°, åºåˆ—é•¿åº¦, ç‰¹å¾ç»´åº¦)</code>ã€‚</li></ul></li><li><p><strong>å¦‚ä½•å®ç°ï¼Ÿ</strong> <code>permute</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ¡ˆä¾‹1: H, W, C -&gt; C, H, W</span></span><br><span class="line">image_hwc = torch.randn(<span class="number">224</span>, <span class="number">224</span>, <span class="number">3</span>)</span><br><span class="line"><span class="comment"># permute æ¥æ”¶æ–°çš„ç»´åº¦é¡ºåº</span></span><br><span class="line">image_chw = image_hwc.permute(<span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>) <span class="comment"># å½¢çŠ¶å˜ä¸º (3, 224, 224)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¡ˆä¾‹2: Batch-first -&gt; Seq-first for Transformer</span></span><br><span class="line">nlp_batch_first = torch.randn(<span class="number">16</span>, <span class="number">100</span>, <span class="number">512</span>) <span class="comment"># (B, Seq, Feat)</span></span><br><span class="line"><span class="comment"># äº¤æ¢ç¬¬ 0 ç»´å’Œç¬¬ 1 ç»´</span></span><br><span class="line">nlp_seq_first = nlp_batch_first.permute(<span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>) <span class="comment"># å½¢çŠ¶å˜ä¸º (100, 16, 512)</span></span><br></pre></td></tr></table></figure><p><code>transpose(dim1, dim2)</code> æ˜¯ <code>permute</code>çš„ä¸€ä¸ªç‰¹ä¾‹ï¼Œå®ƒåªèƒ½äº¤æ¢ä¸¤ä¸ªç»´åº¦ã€‚</p></li></ul><p><strong>åœºæ™¯ C: "å¢åˆ " - å¢åŠ æˆ–ç§»é™¤"å ä½"ç»´åº¦</strong></p><ul><li><p><strong>ä¸ºä»€ä¹ˆï¼Ÿ</strong> æœ‰æ—¶ä¸ºäº†è¿›è¡Œå¹¿æ’­ (broadcasting)è®¡ç®—ï¼Œæˆ–è€…åŒ¹é…ä¸€ä¸ªéœ€è¦ç‰¹å®šç»´åº¦æ•°é‡çš„å‡½æ•°ï¼Œæˆ‘ä»¬éœ€è¦ä¸´æ—¶å¢åŠ æˆ–ç§»é™¤å¤§å°ä¸º 1çš„ç»´åº¦ã€‚</p></li><li><p><strong>å¦‚ä½•å®ç°ï¼Ÿ</strong> <code>unsqueeze</code> (å¢åŠ ) å’Œ<code>squeeze</code> (ç§»é™¤)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœºæ™¯ï¼šç»™ä¸€ä¸ª 2D çš„ batch (B, F) å¢åŠ ä¸€ä¸ªè™šæ‹Ÿçš„â€œé€šé“â€ç»´åº¦</span></span><br><span class="line">x = torch.randn(<span class="number">16</span>, <span class="number">100</span>) <span class="comment"># (Batch, Features)</span></span><br><span class="line"><span class="comment"># ç›®æ ‡ï¼šå˜æˆ (16, 1, 100) ä»¥ä¾¿ä½¿ç”¨ 1D å·ç§¯ nn.Conv1d</span></span><br><span class="line">x_unsqueezed = x.unsqueeze(<span class="number">1</span>) <span class="comment"># åœ¨ç¬¬ 1 ç»´å¢åŠ ä¸€ä¸ªç»´åº¦</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åœºæ™¯ï¼šæ¨¡å‹è¾“å‡º (B, 1)ï¼Œä½† loss å‡½æ•°éœ€è¦ (B)</span></span><br><span class="line">model_output = torch.randn(<span class="number">16</span>, <span class="number">1</span>)</span><br><span class="line"><span class="comment"># ç§»é™¤æ‰€æœ‰å¤§å°ä¸º 1 çš„ç»´åº¦</span></span><br><span class="line">squeezed_output = model_output.squeeze() <span class="comment"># å½¢çŠ¶å˜ä¸º (16)</span></span><br><span class="line"><span class="comment"># åªç§»é™¤ç¬¬ 1 ç»´ (å¦‚æœå®ƒçš„å¤§å°æ˜¯ 1)</span></span><br><span class="line">squeezed_output_dim1 = model_output.squeeze(<span class="number">1</span>) <span class="comment"># å½¢çŠ¶å˜ä¸º (16)</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="é˜¶æ®µ-3æŸå¤±è®¡ç®—é˜¶æ®µ-å¯¹é½é¢„æµ‹ä¸çœŸå€¼">é˜¶æ®µ 3ï¼šæŸå¤±è®¡ç®—é˜¶æ®µ(å¯¹é½"é¢„æµ‹"ä¸"çœŸå€¼")</h4><p><strong>é¢ä¸´çš„é—®é¢˜ï¼š</strong> æ¨¡å‹çš„è¾“å‡º Tensor å’Œæ ‡ç­¾ (label) Tensorçš„å½¢çŠ¶å¯èƒ½ä¸å®Œå…¨ä¸€è‡´ã€‚</p><p><strong>æ ¸å¿ƒåŠ¨æœºï¼š</strong><strong>å¯¹é½</strong>ã€‚ä½¿é¢„æµ‹å’ŒçœŸå€¼çš„å½¢çŠ¶ç¬¦åˆæŸå¤±å‡½æ•°çš„è¦æ±‚ã€‚</p><p><strong>å¸¸è§å˜æ¢ï¼š</strong> <code>squeeze</code> æˆ–<code>argmax</code></p><ul><li><code>nn.BCELoss</code> (äºŒåˆ†ç±»äº¤å‰ç†µ) é€šå¸¸è¦æ±‚æ¨¡å‹è¾“å‡ºå’Œæ ‡ç­¾éƒ½æ˜¯<code>(B)</code> æˆ– <code>(B, 1)</code>ã€‚å¦‚æœä½ çš„æ¨¡å‹è¾“å‡ºäº†<code>(B, 1)</code> è€Œæ ‡ç­¾æ˜¯ <code>(B)</code>ï¼Œä½ å¯èƒ½éœ€è¦<code>model_output.squeeze(1)</code> æ¥å¯¹é½ã€‚</li><li><code>nn.CrossEntropyLoss</code> (å¤šåˆ†ç±»äº¤å‰ç†µ)å¾ˆæ™ºèƒ½ï¼Œå®ƒå…è®¸æ¨¡å‹è¾“å‡ºæ˜¯ <code>(B, num_classes)</code> çš„logitsï¼Œè€Œæ ‡ç­¾æ˜¯ <code>(B)</code>çš„ç±»åˆ«ç´¢å¼•ã€‚å®ƒå†…éƒ¨ä¼šè‡ªåŠ¨å¤„ç†å¯¹é½ã€‚åœ¨è®¡ç®—å‡†ç¡®ç‡æ—¶ï¼Œä½ åˆ™éœ€è¦ç”¨<code>torch.argmax(model_output, dim=1)</code> æ¥å¾—åˆ° <code>(B)</code>çš„é¢„æµ‹ç±»åˆ«ï¼Œå†å’Œæ ‡ç­¾è¿›è¡Œæ¯”è¾ƒã€‚</li></ul><h3 id="æˆ‘åº”è¯¥ç”¨å“ªä¸ª-api">3. æˆ‘åº”è¯¥ç”¨å“ªä¸ª APIï¼Ÿ</h3><p>å½“ä½ éœ€è¦æ”¹å˜ Tensor å½¢çŠ¶æ—¶ï¼Œå¯ä»¥æŒ‰ä»¥ä¸‹æµç¨‹æ€è€ƒï¼š</p><p><strong>æˆ‘çš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p><ul><li>æ˜¯ä¸ºäº†<strong>"å‹å¹³"</strong>å¤šç»´ç‰¹å¾ç»™å…¨è¿æ¥å±‚ï¼Ÿ -&gt;<code>flatten</code> æˆ– <code>reshape/view</code>ã€‚</li><li>æ˜¯ä¸ºäº†<strong>"äº¤æ¢"</strong>ç»´åº¦çš„è¯­ä¹‰é¡ºåºï¼ˆå¦‚ B,S,F -&gt;S,B,Fï¼‰ï¼Ÿ -&gt; <code>permute</code> æˆ– <code>transpose</code>ã€‚</li><li>æ˜¯ä¸ºäº†<strong>"å¢åŠ "</strong>ä¸€ä¸ªä¸å­˜åœ¨çš„ç»´åº¦ï¼ˆå¦‚ batch ç»´ï¼Œchannelç»´ï¼‰ï¼Ÿ -&gt; <code>unsqueeze</code>ã€‚</li><li>æ˜¯ä¸ºäº†<strong>"ç§»é™¤"</strong>ä¸€ä¸ªå¤§å°ä¸º 1 çš„å¤šä½™ç»´åº¦ï¼Ÿ -&gt;<code>squeeze</code>ã€‚</li></ul><blockquote><p><strong>ä¸€ä¸ªé»„é‡‘æ³•åˆ™ï¼š<code>print(tensor.shape)</code></strong> åœ¨<code>forward</code> å‡½æ•°çš„æ¯ä¸€è¡Œå…³é”®æ“ä½œåï¼Œéƒ½åŠ ä¸Š<code>print(x.shape)</code>ã€‚è¿™æ˜¯è°ƒè¯• PyTorchæ¨¡å‹å½¢çŠ¶é—®é¢˜çš„æœ€ç®€å•ã€æœ€æœ‰æ•ˆçš„æ–¹æ³•ã€‚å®ƒå¯ä»¥è®©ä½ æ¸…æ™°åœ°çœ‹åˆ°æ•°æ®æ˜¯å¦‚ä½•ä¸€æ­¥æ­¥å˜æ¢çš„ã€‚</p></blockquote><h3 id="ä»£ç ç¤ºä¾‹-1">4. ä»£ç ç¤ºä¾‹</h3><p>è®©æˆ‘ä»¬è¿½è¸ªä¸€ä¸ª Tensor åœ¨ä¸€ä¸ªç®€å• CNN ä¸­çš„å®Œæ•´æ—…ç¨‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ShapeJourneyCNN</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="variable language_">self</span>.conv1 = nn.Conv2d(in_channels=<span class="number">1</span>, out_channels=<span class="number">16</span>, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>)</span><br><span class="line">        <span class="variable language_">self</span>.relu = nn.ReLU()</span><br><span class="line">        <span class="variable language_">self</span>.pool = nn.MaxPool2d(kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>)</span><br><span class="line">        <span class="variable language_">self</span>.fc1 = nn.Linear(<span class="number">16</span> * <span class="number">14</span> * <span class="number">14</span>, <span class="number">10</span>) <span class="comment"># 28x28 -&gt; 14x14 after pooling</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="comment"># åˆå§‹è¾“å…¥ x: (B, 1, 28, 28) - å‡è®¾æ¥è‡ª MNIST</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Initial shape: \t\t<span class="subst">&#123;x.shape&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç»è¿‡ç¬¬ä¸€ä¸ªå·ç§¯å±‚</span></span><br><span class="line">        x = <span class="variable language_">self</span>.conv1(x)</span><br><span class="line">        <span class="comment"># å½¢çŠ¶å˜ä¸º (B, 16, 28, 28) - é€šé“æ•°ä» 1 å˜ä¸º 16</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;After Conv1: \t\t<span class="subst">&#123;x.shape&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        x = <span class="variable language_">self</span>.relu(x)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç»è¿‡æœ€å¤§æ± åŒ–å±‚</span></span><br><span class="line">        x = <span class="variable language_">self</span>.pool(x)</span><br><span class="line">        <span class="comment"># å½¢çŠ¶å˜ä¸º (B, 16, 14, 14) - H å’Œ W éƒ½å‡åŠ</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;After MaxPool: \t\t<span class="subst">&#123;x.shape&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># **å…³é”®å˜æ¢ï¼šå‹å¹³**</span></span><br><span class="line">        <span class="comment"># ä¸ºäº†é€å…¥ fc1ï¼Œéœ€è¦ä» 4D å˜ä¸º 2D</span></span><br><span class="line">        <span class="comment"># æˆ‘ä»¬ä¿ç•™ batch ç»´åº¦ï¼Œå°†å…¶ä½™ç»´åº¦å‹å¹³</span></span><br><span class="line">        x = torch.flatten(x, start_dim=<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># å½¢çŠ¶å˜ä¸º (B, 16*14*14) -&gt; (B, 3136)</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;After Flatten: \t\t<span class="subst">&#123;x.shape&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç»è¿‡å…¨è¿æ¥å±‚</span></span><br><span class="line">        x = <span class="variable language_">self</span>.fc1(x)</span><br><span class="line">        <span class="comment"># å½¢çŠ¶å˜ä¸º (B, 10) - 10 æ˜¯æœ€ç»ˆçš„ç±»åˆ«æ•°</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Final output shape: \t<span class="subst">&#123;x.shape&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ª dummy input batch</span></span><br><span class="line">dummy_batch = torch.randn(<span class="number">64</span>, <span class="number">1</span>, <span class="number">28</span>, <span class="number">28</span>) <span class="comment"># B=64</span></span><br><span class="line">model = ShapeJourneyCNN()</span><br><span class="line">model(dummy_batch)</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Initial shape: torch.Size([64, 1, 28, 28])</span><br><span class="line">After Conv1: torch.Size([64, 16, 28, 28])</span><br><span class="line">After MaxPool: torch.Size([64, 16, 14, 14])</span><br><span class="line">After Flatten: torch.Size([64, 3136])</span><br><span class="line">Final output shape: torch.Size([64, 10])</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“">æ€»ç»“</h2><p>è®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹æ„å»ºèµ·çš„è¿™å¼ å¿ƒæ™ºåœ°å›¾ï¼š</p><ol type="1"><li><strong>ä»¥å·¥ä½œæµä¸ºçº²</strong>ï¼šå§‹ç»ˆå°† PyTorch çš„ API æ”¾å…¥"æ•°æ®å‡†å¤‡-&gt; æ¨¡å‹æ„å»º -&gt;è®­ç»ƒå¾ªç¯"çš„æ¡†æ¶ä¸­å»ç†è§£å…¶å­˜åœ¨çš„æ„ä¹‰ã€‚è¿™æ„æˆäº†ä½ çš„<strong>å®è§‚éª¨æ¶</strong>ã€‚</li><li><strong>ä»¥è¯­ä¹‰ä¸ºè½´</strong>ï¼šå°† Tensorçš„å½¢çŠ¶å˜åŒ–ç†è§£ä¸ºåŒ¹é…ä¸åŒæ¨¡å—è¯­ä¹‰æ¥å£çš„"ç¿»è¯‘"è¿‡ç¨‹ã€‚è¿™è®©ä½ èƒ½è‡ªå¦‚åœ°æŒæ§<strong>å¾®è§‚è¡€æ¶²</strong>çš„æµåŠ¨ã€‚</li></ol><p>å¸Œæœ›è¿™ç¯‡æŒ‡å—èƒ½å¸®åŠ©ä½ æ‘†è„±æ­»è®°ç¡¬èƒŒçš„æ³¥æ½­ï¼Œä»ç¬¬ä¸€æ€§åŸç†å‡ºå‘ï¼ŒçœŸæ­£å»ºç«‹èµ·å¯¹PyTorch æ·±åˆ»è€Œç³»ç»Ÿçš„ç†è§£ï¼Œåœ¨"ç‚¼ä¸¹"ä¹‹è·¯ä¸Šèµ°å¾—æ›´è¿œã€æ›´ç¨³ã€‚</p>]]></content>
    
    
    <summary type="html">æœ¬æ–‡ä» PyTorch çš„æ ¸å¿ƒè®¾è®¡å‡ºå‘ï¼Œé€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå¸®åŠ©è¯»è€…ç†è§£ PyTorch çš„æ ¸å¿ƒè®¾è®¡ï¼ŒåŒ…æ‹¬å¼ é‡ã€è‡ªåŠ¨æ±‚å¯¼ã€ç¥ç»ç½‘ç»œç­‰ã€‚</summary>
    
    
    
    <category term="å¤§æ¨¡å‹" scheme="https://hedon.top/categories/%E5%A4%A7%E6%A8%A1%E5%9E%8B/"/>
    
    
    <category term="æœºå™¨å­¦ä¹ " scheme="https://hedon.top/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="æ·±åº¦å­¦ä¹ " scheme="https://hedon.top/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="å¤§æ¨¡å‹" scheme="https://hedon.top/tags/%E5%A4%A7%E6%A8%A1%E5%9E%8B/"/>
    
    <category term="PyTorch" scheme="https://hedon.top/tags/PyTorch/"/>
    
  </entry>
  
  <entry>
    <title>ä» ECB åˆ° GCMï¼šç†è§£åŠ å¯†æ¨¡å¼çš„æ¼”è¿›</title>
    <link href="https://hedon.top/2025/08/15/encryption-mode/"/>
    <id>https://hedon.top/2025/08/15/encryption-mode/</id>
    <published>2025-08-15T09:31:00.000Z</published>
    <updated>2025-08-25T15:15:59.964Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ç½‘ç»œä¸–ç•Œä¸­ï¼Œæˆ‘ä»¬çš„æ•°æ®éœ€è¦è¢«å°å¿ƒä¿æŠ¤ã€‚å¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œå¦‚AESï¼Œå°±æ˜¯æˆ‘ä»¬æœ€å¸¸ç”¨çš„"ä¿é™©ç®±"ã€‚ä½†è¿™ä¸ªä¿é™©ç®±æ€ä¹ˆç”¨ï¼Œå´å¤§æœ‰è®²ç©¶ã€‚è¿™å°±å¼•å‡ºäº†æˆ‘ä»¬ä»Šå¤©è®¨è®ºçš„ä¸»é¢˜ï¼š<strong>åŠ å¯†æ¨¡å¼ï¼ˆEncryptionModeï¼‰</strong>ã€‚</p><p>æœ¬æ–‡å°†ç”±æµ…å…¥æ·±åœ°å¸¦ä½ ç†è§£ä¸‰ç§ç»å…¸çš„åˆ†ç»„åŠ å¯†æ¨¡å¼ï¼š<strong>ECBã€CBC</strong>å’Œ <strong>GCM</strong>ï¼Œå¹¶è§£é‡Šå®ƒä»¬å„è‡ªçš„ä¼˜ç¼ºç‚¹å’Œæ¼”è¿›è¿‡ç¨‹ã€‚</p><h3 id="ç®€å•çš„è‡´å‘½å¼±ç‚¹ecbelectronic-codebookæ¨¡å¼">1.ç®€å•çš„è‡´å‘½å¼±ç‚¹ï¼šECBï¼ˆElectronic Codebookï¼‰æ¨¡å¼</h3><p><strong>ECBæ¨¡å¼</strong>æ˜¯æœ€ç®€å•çš„ä¸€ç§åˆ†ç»„åŠ å¯†æ¨¡å¼ã€‚å®ƒçš„å·¥ä½œåŸç†éå¸¸ç›´æ¥ï¼šæŠŠæ˜æ–‡æ•°æ®åˆ‡åˆ†æˆä¸€ä¸ªä¸ªå›ºå®šå¤§å°çš„å—ï¼Œç„¶åç”¨åŒä¸€ä¸ªå¯†é’¥ï¼Œç‹¬ç«‹åœ°åŠ å¯†æ¯ä¸€ä¸ªå—ã€‚</p><p><strong>ä¼˜ç‚¹</strong>ï¼š</p><ul><li><strong>ç®€å•</strong>ï¼šåŸç†æ¸…æ™°ï¼Œæ˜“äºå®ç°ã€‚</li><li><strong>å¯å¹¶è¡Œ</strong>ï¼šæ¯ä¸ªå—çš„åŠ å¯†äº’ä¸å½±å“ï¼Œå¯ä»¥å¹¶è¡Œå¤„ç†ï¼Œæé«˜æ€§èƒ½ã€‚</li><li><strong>å¯æ¢å¤</strong>ï¼šæŸä¸ªå—æŸåï¼Œåªå½±å“è¯¥å—ï¼Œä¸å½±å“å…¶ä»–å—çš„è§£å¯†ã€‚</li></ul><p><strong>ç¼ºç‚¹</strong>ï¼š</p><ul><li><strong>ä¸å®‰å…¨</strong>ï¼šè¿™æ˜¯ ECBæ¨¡å¼çš„è‡´å‘½å¼±ç‚¹ã€‚å› ä¸ºç›¸åŒçš„æ˜æ–‡å—ä¼šäº§ç”Ÿç›¸åŒçš„å¯†æ–‡å—ï¼Œè¿™ä½¿å¾—æ”»å‡»è€…å¯ä»¥é€šè¿‡åˆ†æå¯†æ–‡ä¸­çš„é‡å¤æ¨¡å¼æ¥æ¨æ–­å‡ºåŸå§‹æ•°æ®çš„ç»“æ„å’Œå†…å®¹ã€‚è‘—åçš„â€œECBä¼é¹…â€å›¾ç‰‡å°±æ˜¯æœ€å¥½çš„ä¾‹è¯ã€‚</li></ul><p>æ­£æ˜¯å› ä¸ºè¿™ä¸ªå·¨å¤§çš„å®‰å…¨æ¼æ´ï¼ŒECBæ¨¡å¼åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½ä¸è¢«æ¨èä½¿ç”¨ã€‚</p><hr /><h3 id="é“¾å¼ååº”cbccipher-block-chainingæ¨¡å¼">2. é“¾å¼ååº”ï¼šCBCï¼ˆCipherBlock Chainingï¼‰æ¨¡å¼</h3><p>ä¸ºäº†è§£å†³ ECB æ¨¡å¼çš„é‡å¤æ€§é—®é¢˜ï¼Œå·¥ç¨‹å¸ˆä»¬è®¾è®¡äº† <strong>CBCæ¨¡å¼</strong>ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯<strong>â€œé“¾æ¥â€</strong>ã€‚</p><p>åœ¨ CBCæ¨¡å¼ä¸­ï¼Œæ¯ä¸ªæ˜æ–‡å—åœ¨åŠ å¯†å‰ï¼Œéƒ½ä¼šå…ˆå’Œ<strong>å‰ä¸€ä¸ªå¯†æ–‡å—</strong>è¿›è¡Œå¼‚æˆ–è¿ç®—ã€‚è€Œç¬¬ä¸€ä¸ªæ˜æ–‡å—åˆ™ä¼šå’Œä¸€ä¸ªéšæœºçš„<strong>åˆå§‹åŒ–å‘é‡ï¼ˆIVï¼‰</strong>è¿›è¡Œå¼‚æˆ–è¿ç®—ã€‚</p><p><strong>ä¼˜ç‚¹</strong>ï¼š</p><ul><li><strong>æ›´å®‰å…¨</strong>ï¼šç”±äºå¼•å…¥äº†é“¾å¼ä¾èµ–å’ŒIVï¼Œå³ä½¿æœ‰ç›¸åŒçš„æ˜æ–‡å—ï¼Œå®ƒä»¬åŠ å¯†åä¹Ÿä¼šäº§ç”Ÿä¸åŒçš„å¯†æ–‡ï¼Œæœ‰æ•ˆéšè—äº†æ•°æ®æ¨¡å¼ï¼Œè§£å†³äº†ECB çš„å®‰å…¨é—®é¢˜ã€‚</li></ul><p><strong>ç¼ºç‚¹</strong>ï¼š</p><ul><li><strong>æ— æ³•å¹¶è¡Œ</strong>ï¼šç”±äºåŠ å¯†è¿‡ç¨‹æ˜¯é“¾å¼çš„ï¼Œæ¯ä¸ªå—çš„åŠ å¯†éƒ½ä¾èµ–äºå‰ä¸€ä¸ªå—çš„ç»“æœï¼Œå› æ­¤æ— æ³•å¹¶è¡Œå¤„ç†ã€‚</li><li><strong>é”™è¯¯ä¼ æ’­</strong>ï¼šå¦‚æœæŸä¸ªå¯†æ–‡å—åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æŸåï¼Œå®ƒä¸ä»…ä¼šå¯¼è‡´è‡ªèº«è§£å¯†å¤±è´¥ï¼Œè¿˜ä¼šå½±å“åç»­æ‰€æœ‰å—çš„è§£å¯†ï¼Œäº§ç”Ÿâ€œå¤šç±³è¯ºéª¨ç‰Œæ•ˆåº”â€ã€‚</li></ul><p>CBCæ¨¡å¼å¤§å¤§æé«˜äº†å®‰å…¨æ€§ï¼Œåœ¨å¾ˆé•¿ä¸€æ®µæ—¶é—´é‡Œéƒ½æ˜¯è¡Œä¸šæ ‡å‡†ã€‚ä½†æ˜¯ï¼Œå®ƒæ— æ³•å¹¶è¡ŒåŠ å¯†çš„ç¼ºç‚¹åœ¨é¢å¯¹æµ·é‡æ•°æ®æ—¶ï¼Œæˆä¸ºäº†æ€§èƒ½ç“¶é¢ˆã€‚</p><hr /><h3 id="é«˜æ€§èƒ½ä¸é«˜å®‰å…¨gcmgaloiscounter-modeæ¨¡å¼">3.é«˜æ€§èƒ½ä¸é«˜å®‰å…¨ï¼šGCMï¼ˆGalois/Counter Modeï¼‰æ¨¡å¼</h3><p>ä¸ºäº†å…¼é¡¾å®‰å…¨æ€§å’Œæ€§èƒ½ï¼Œ<strong>GCMæ¨¡å¼</strong>åº”è¿è€Œç”Ÿã€‚å®ƒæ˜¯ä¸€ç§<strong>è®¤è¯åŠ å¯†ï¼ˆAuthenticatedEncryptionï¼‰</strong>æ¨¡å¼ï¼Œå®Œç¾ç»“åˆäº†åŠ å¯†å’Œæ•°æ®å®Œæ•´æ€§æ ¡éªŒã€‚</p><p>GCM æ¨¡å¼çš„æ ¸å¿ƒæ€æƒ³æ˜¯ <strong>CTRï¼ˆCounterModeï¼‰</strong>ã€‚å®ƒä¸ä¾èµ–äºå‰é¢çš„å¯†æ–‡å—ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ª<strong>ä¸æ–­é€’å¢çš„è®¡æ•°å™¨</strong>ï¼Œç”Ÿæˆä¸€ä¸ªåŠ å¯†ç”¨çš„éšæœºæµï¼Œå†å°†è¿™ä¸ªæµå’Œæ˜æ–‡æ•°æ®è¿›è¡Œå¼‚æˆ–è¿ç®—å¾—åˆ°å¯†æ–‡ã€‚</p><p><strong>ä¼˜ç‚¹</strong>ï¼š</p><ul><li><strong>å¯å¹¶è¡Œ</strong>ï¼šæ¯ä¸ªåŠ å¯†å—éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œå¯ä»¥å¹¶è¡Œå¤„ç†ï¼Œæå¤§åœ°æé«˜äº†åŠ è§£å¯†æ€§èƒ½ã€‚</li><li><strong>è®¤è¯åŠ å¯†</strong>ï¼šGCMæ¨¡å¼é™¤äº†åŠ å¯†ï¼Œè¿˜å†…ç½®äº†<strong>è®¤è¯åŠŸèƒ½</strong>ã€‚å®ƒèƒ½ç”Ÿæˆä¸€ä¸ª<strong>è®¤è¯æ ‡ç­¾ï¼ˆAuthenticationTagï¼‰</strong>ï¼Œå¯ä»¥éªŒè¯æ•°æ®çš„å®Œæ•´æ€§ï¼Œç¡®ä¿æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æ²¡æœ‰è¢«ç¯¡æ”¹ã€‚</li></ul><p><strong>ç¼ºç‚¹</strong>ï¼š</p><ul><li><strong>å¤æ‚åº¦é«˜</strong>ï¼šç›¸å¯¹äº ECB å’Œ CBCï¼ŒGCMçš„å®ç°æ›´å¤æ‚ã€‚</li></ul><hr /><h3 id="æ€»ç»“ä¸å±•æœ›">æ€»ç»“ä¸å±•æœ›</h3><p>ä» ECB çš„ç®€å•ä½†å±é™©ï¼Œåˆ° CBC çš„å®‰å…¨ä½†ä¸²è¡Œï¼Œå†åˆ° GCMçš„å®‰å…¨ã€é«˜æ€§èƒ½å’Œè®¤è¯ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°åŠ å¯†æ¨¡å¼çš„æ¼”è¿›ã€‚</p><table><thead><tr><th style="text-align: left;">ç‰¹æ€§</th><th style="text-align: left;">ECB</th><th style="text-align: left;">CBC</th><th style="text-align: left;">GCM</th></tr></thead><tbody><tr><td style="text-align: left;"><strong>å·¥ä½œæ¨¡å¼</strong></td><td style="text-align: left;">ç‹¬ç«‹</td><td style="text-align: left;">é“¾æ¥</td><td style="text-align: left;">è®¡æ•°å™¨</td></tr><tr><td style="text-align: left;"><strong>å®‰å…¨æ€§</strong></td><td style="text-align: left;">æä½</td><td style="text-align: left;">è¾ƒé«˜</td><td style="text-align: left;">æé«˜</td></tr><tr><td style="text-align: left;"><strong>å¹¶è¡Œå¤„ç†</strong></td><td style="text-align: left;">æ”¯æŒ</td><td style="text-align: left;">ä¸æ”¯æŒ</td><td style="text-align: left;">æ”¯æŒ</td></tr><tr><td style="text-align: left;"><strong>æ•°æ®å®Œæ•´æ€§</strong></td><td style="text-align: left;">ä¸æ”¯æŒ</td><td style="text-align: left;">ä¸æ”¯æŒ</td><td style="text-align: left;">æ”¯æŒ</td></tr></tbody></table><p>åœ¨ä»Šå¤©çš„ç½‘ç»œä¸–ç•Œä¸­ï¼Œ<strong>GCMæ¨¡å¼</strong>å› å…¶å“è¶Šçš„æ€§èƒ½å’Œå®‰å…¨æ€§ï¼Œå·²ç»æˆä¸ºæœ€æ¨èä½¿ç”¨çš„åŠ å¯†æ¨¡å¼ï¼Œå¹¿æ³›åº”ç”¨äºTLS/SSL ç­‰ä¸»æµå®‰å…¨åè®®ä¸­ã€‚</p>]]></content>
    
    
    <summary type="html">åŠ å¯†æ¨¡å¼ ECBã€CBCã€GCM</summary>
    
    
    
    <category term="åŠ å¯†æ¨¡å¼" scheme="https://hedon.top/categories/%E5%8A%A0%E5%AF%86%E6%A8%A1%E5%BC%8F/"/>
    
    
    <category term="ECB" scheme="https://hedon.top/tags/ECB/"/>
    
    <category term="CBC" scheme="https://hedon.top/tags/CBC/"/>
    
    <category term="GCM" scheme="https://hedon.top/tags/GCM/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€æ¬¡ç”±å…¬ç½‘æµå‡ºå¸¦å®½é£™å‡å¼•å‘çš„æœåŠ¡å™¨æ€§èƒ½æ’æŸ¥å®å½•</title>
    <link href="https://hedon.top/2025/08/15/record-of-abnormal-investigation-of-public-network-traffic/"/>
    <id>https://hedon.top/2025/08/15/record-of-abnormal-investigation-of-public-network-traffic/</id>
    <published>2025-08-15T07:30:20.000Z</published>
    <updated>2025-08-25T15:15:59.965Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘ï¼Œæˆ‘ä»¬çš„æœåŠ¡å™¨ç›‘æ§ç³»ç»Ÿå‘å‡ºäº†ç´§æ€¥è­¦æŠ¥ï¼šæœåŠ¡å™¨çš„å„é¡¹å…³é”®æ€§èƒ½æŒ‡æ ‡åœ¨<strong>2025 å¹´ 8 æœˆ 15 æ—¥ 11:30å·¦å³</strong>å‡ºç°äº†åŒæ­¥é£™å‡ã€‚é¢å¯¹è¿™ä¸€å¼‚å¸¸ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰æ€¥äºçŒœæµ‹ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ªæ ¸å¿ƒçº¿ç´¢â€”â€”å…¬ç½‘æµå‡ºæµé‡ï¼Œä¸€æ­¥æ­¥æ­å¼€äº†é—®é¢˜çš„çœŸç›¸ã€‚æœ¬æ–‡å°†è¯¦ç»†è®°å½•æˆ‘ä»¬çš„æ’æŸ¥è¿‡ç¨‹ï¼Œå¹¶æ·±å…¥è§£ææ¯ä¸€æ­¥çš„å·¥å…·åº”ç”¨ä¸èƒŒååŸç†ã€‚</p><h4id="ç¬¬ä¸€æ­¥ä»å®è§‚ç›‘æ§å…¥æ‰‹é”å®šå¼‚å¸¸çš„æ ¸å¿ƒ">ç¬¬ä¸€æ­¥ï¼šä»å®è§‚ç›‘æ§å…¥æ‰‹ï¼Œé”å®šå¼‚å¸¸çš„æ ¸å¿ƒ</h4><p>æ•…éšœæ’æŸ¥çš„ç¬¬ä¸€æ­¥ï¼Œæ˜¯ç»†è‡´åˆ†æç›‘æ§å›¾è¡¨ï¼Œä»ä¸­æå–å…³é”®ä¿¡æ¯ï¼Œä»è€Œåœˆå®šé—®é¢˜å‘ç”Ÿçš„ç²¾ç¡®æ—¶é—´ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250815152916476.png"alt="å¼‚å¸¸ç°è±¡" /><figcaption aria-hidden="true">å¼‚å¸¸ç°è±¡</figcaption></figure><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬å‘ç°ï¼Œåœ¨ <strong>2025 å¹´ 8 æœˆ 15 æ—¥ 11:30å·¦å³</strong>ï¼ŒæœåŠ¡å™¨çš„å„é¡¹æŒ‡æ ‡å‡ºç°äº†æ˜¾è‘—å¼‚å¸¸ï¼š</p><ul><li><strong>å…¬ç½‘æµå‡ºå¸¦å®½</strong>ï¼šåœ¨ 11:37:00è¿™ä¸ªæ—¶é—´ç‚¹ï¼Œå…¬ç½‘æµå‡ºå¸¦å®½è¾¾åˆ°äº†æƒŠäººçš„ <strong>110.899 M bit/s</strong>çš„å³°å€¼ï¼Œè¿œè¶…æ­£å¸¸æ°´å¹³ã€‚ä¸æ­¤åŒæ—¶ï¼Œå…¬ç½‘æµå…¥å¸¦å®½ä¹Ÿæœ‰è½»å¾®å¢åŠ ï¼Œä½†é‡çº§è¿œå°äºæµå‡ºå¸¦å®½ã€‚</li><li><strong>CPU ä½¿ç”¨ç‡</strong>ï¼šåœ¨å¸¦å®½é£™å‡çš„åŒæ—¶ï¼ŒCPU ä½¿ç”¨ç‡ä¹Ÿä» 25%å·¦å³çš„æ­£å¸¸æ°´å¹³ï¼Œè¿…é€Ÿå‡é«˜åˆ°æ¥è¿‘ <strong>100%</strong> çš„å³°å€¼ã€‚</li><li><strong>ç£ç›˜I/O</strong>ï¼šç£ç›˜çš„è¯»æ“ä½œååé‡å’Œæ¬¡æ•°ä¹Ÿå‡ºç°äº†åŒæ­¥çš„å³°å€¼ã€‚</li></ul><p>æ­¤å¤–ï¼Œç½‘ç»œè¿æ¥æ•°çš„ç›‘æ§å›¾ä¹Ÿæ­ç¤ºäº†é‡è¦çº¿ç´¢ï¼š</p><ul><li>åœ¨ 11:30 å·¦å³ï¼ŒæœåŠ¡å™¨çš„ç½‘ç»œè¿æ¥æ€»æ•°ä»çº¦ 2.5K æ¿€å¢è‡³ <strong>5.5Kå·¦å³</strong>ã€‚</li><li>å…¶ä¸­ï¼Œ<code>NON_ESTABLISHED</code>ï¼ˆéæ´»è·ƒï¼‰è¿æ¥æ•°æ€¥å‰§å¢åŠ ï¼Œæœ€é«˜è¾¾åˆ°äº†çº¦<strong>2.475K</strong>ï¼Œä¸<code>ESTABLISHED</code>ï¼ˆå·²å»ºç«‹ï¼‰è¿æ¥æ•°å‡ ä¹æŒå¹³ã€‚</li></ul><p><strong>æ’æŸ¥åŸç†</strong>ï¼šå¤šé¡¹å…³é”®æŒ‡æ ‡åœ¨åŒä¸€æ—¶é—´ç‚¹åŒæ­¥å¼‚å¸¸ï¼Œè¿™å¼ºçƒˆæš—ç¤ºç€æŸä¸ªè¿›ç¨‹æˆ–ä»»åŠ¡æ­£åœ¨å¤§é‡æ¶ˆè€—ç³»ç»Ÿèµ„æºã€‚å…¬ç½‘å¸¦å®½çš„å¼‚å¸¸æ˜¯æœ¬æ¬¡æ•…éšœçš„æ ¸å¿ƒçº¿ç´¢ï¼Œå®ƒå°†æˆ‘ä»¬çš„æ’æŸ¥æ–¹å‘èšç„¦äºç½‘ç»œæµé‡ã€‚åŒæ—¶ï¼Œç½‘ç»œè¿æ¥æ•°ä¸­éæ´»è·ƒè¿æ¥çš„æ¿€å¢ï¼Œè¡¨æ˜é—®é¢˜å¯èƒ½ä¸é«˜é¢‘ç‡çš„è¿æ¥å»ºç«‹ä¸å…³é—­æœ‰å…³ï¼Œè€Œéç®€å•çš„æŒç»­é«˜æµé‡ã€‚è¿™äº›å®è§‚çš„ç›‘æ§æ•°æ®ï¼Œä¸ºæˆ‘ä»¬åç»­æ·±å…¥æ’æŸ¥æä¾›äº†æ˜ç¡®çš„èµ·ç‚¹å’Œæ–¹å‘ã€‚</p><h4 id="ç¬¬äºŒæ­¥iftop-å®šä½æµé‡å»å‘ä¸€å‰‘å°å–‰">ç¬¬äºŒæ­¥ï¼š<code>iftop</code>å®šä½æµé‡å»å‘ï¼Œä¸€å‰‘å°å–‰</h4><p>æ—¢ç„¶é—®é¢˜æ˜¯å…¬ç½‘æµå‡ºæµé‡å¼‚å¸¸ï¼Œé‚£ä¹ˆè¿™äº›æµé‡ç©¶ç«Ÿæµå‘å“ªé‡Œï¼Ÿè¿™æ˜¯æˆ‘ä»¬æ’æŸ¥çš„ä¸‹ä¸€ä¸ªå…³é”®é—®é¢˜ã€‚æˆ‘ä»¬è¿è¡Œäº†<code>iftop</code>å·¥å…·ï¼Œå®ƒèƒ½å¤Ÿå®æ—¶ç›‘æ§ç½‘ç»œæµé‡çš„æµå‘ï¼Œç»“æœä»¤äººéœ‡æƒŠï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250815153946932.png"alt="iftop å‘½ä»¤æ˜¾ç¤ºç»“æœ" /><figcaption aria-hidden="true">iftop å‘½ä»¤æ˜¾ç¤ºç»“æœ</figcaption></figure><ul><li><code>iftop</code>å®æ—¶ç›‘æ§æ˜¾ç¤ºï¼ŒæœåŠ¡å™¨çš„å…¬ç½‘æµå‡ºæµé‡ï¼ˆ<code>=&gt;</code>ï¼‰ç»å¤§éƒ¨åˆ†éƒ½æµå‘äº†IP åœ°å€ <code>xxx</code>ã€‚</li><li>æµå‡ºé€Ÿç‡é«˜è¾¾æ¯ç§’ <strong>165Mbits/s</strong>ï¼Œä¸ç›‘æ§å›¾ä¸Šçš„å¸¦å®½å³°å€¼å®Œå…¨å»åˆã€‚</li><li><code>iftop</code> åº•éƒ¨çš„ <code>TX</code>ï¼ˆå‘é€ï¼‰æµé‡å³°å€¼è¾¾åˆ°äº†<strong>181M bits</strong>ï¼Œè¿›ä¸€æ­¥è¯å®äº†å¸¦å®½é£™å‡çš„æ ¹æºã€‚</li></ul><p><strong>æ’æŸ¥åŸç†</strong>ï¼š<code>iftop</code>çš„å¼ºå¤§ä¹‹å¤„åœ¨äºå®ƒçš„<strong>å®æ—¶æ€§å’Œç›´è§‚æ€§</strong>ã€‚å®ƒå°†æœåŠ¡å™¨æŠ½è±¡çš„å¸¦å®½æ•°æ®ï¼Œå…·è±¡åŒ–ä¸º"æœ¬åœ°IP A åˆ°è¿œç«¯ IP B çš„æµé‡"ã€‚é€šè¿‡è§‚å¯Ÿ <code>iftop</code>çš„è¾“å‡ºï¼Œæˆ‘ä»¬ç«‹åˆ»å°†ç›®å…‰ä»"å“ªå°æœåŠ¡å™¨å‡ºäº†é—®é¢˜"è½¬ç§»åˆ°"è¿™å°æœåŠ¡å™¨åœ¨å‘å“ªé‡Œå‘é€æ•°æ®""ï¼Œä»è€Œå¤§å¤§ç¼©çŸ­äº†æ’æŸ¥è·¯å¾„ã€‚</p><h4 id="ç¬¬ä¸‰æ­¥nethogs-é”å®šåº”ç”¨è¿›ç¨‹ç¡®è®¤å…ƒå‡¶">ç¬¬ä¸‰æ­¥ï¼š<code>nethogs</code>é”å®šåº”ç”¨è¿›ç¨‹ï¼Œç¡®è®¤å…ƒå‡¶</h4><p>æˆ‘ä»¬å·²ç»çŸ¥é“æ˜¯æœåŠ¡å™¨åœ¨å‘ <code>xxx</code>å‘é€å¤§é‡æ•°æ®ï¼Œä½†å…·ä½“æ˜¯å“ªä¸ªåº”ç”¨åœ¨åšè¿™ä»¶äº‹ï¼Ÿæˆ‘ä»¬ä½¿ç”¨<code>nethogs</code>å·¥å…·ï¼Œå®ƒèƒ½å¤ŸæŒ‰è¿›ç¨‹å®æ—¶ç›‘æ§æµé‡ï¼Œæœ€ç»ˆé”å®šäº†â€œå…ƒå‡¶â€ï¼š</p><ul><li><code>nethogs</code> çš„è¾“å‡ºæ˜ç¡®æ˜¾ç¤ºï¼Œ<strong><code>snakeweb_</code>åº”ç”¨</strong>æ˜¯äº§ç”Ÿè¿™äº›é«˜æµé‡çš„è¿›ç¨‹ã€‚</li><li>å…¶å‘é€ï¼ˆ<code>SENT</code>ï¼‰å’Œæ¥æ”¶ï¼ˆ<code>RECEIVED</code>ï¼‰æµé‡éƒ½è¿œè¶…å…¶ä»–è¿›ç¨‹ï¼Œè¯å®äº†å®ƒæ˜¯æœ¬æ¬¡æ•…éšœçš„ç›´æ¥â€œå…ƒå‡¶â€ã€‚</li></ul><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250815154151114.png"alt="nethogs" /><figcaption aria-hidden="true">nethogs</figcaption></figure><p><strong>æ’æŸ¥åŸç†</strong>ï¼š<code>nethogs</code> å°†æµé‡ä¸å…·ä½“çš„è¿›ç¨‹IDï¼ˆPIDï¼‰å’Œç¨‹åºè·¯å¾„å…³è”èµ·æ¥ï¼Œä¸ºæˆ‘ä»¬æä¾›äº†æœ€ç»ˆçš„ã€æ— å¯è¾©é©³çš„è¯æ®ã€‚è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å®Œæ•´åœ°é”å®šäº†é—®é¢˜ï¼š<code>snakeweb_</code>åº”ç”¨å‘ IP <code>xxx</code> å‘é€å¤§é‡æ•°æ®ã€‚</p><h4 id="ç¬¬å››æ­¥å‘ç°-time_wait-å †ç§¯ç†è§£è¡Œä¸ºæ¨¡å¼"><strong>ç¬¬å››æ­¥ï¼šå‘ç°<code>TIME_WAIT</code> å †ç§¯ï¼Œç†è§£è¡Œä¸ºæ¨¡å¼</strong></h4><p>åœ¨ç¡®è®¤äº†åº”ç”¨å’Œæµé‡å»å‘åï¼Œæˆ‘ä»¬å›è¿‡å¤´æ¥å®¡è§†æœ€åˆçš„ä¸€äº›å¼‚å¸¸ç°è±¡ã€‚ç½‘ç»œè¿æ¥æ•°çš„ç›‘æ§å›¾æ˜¾ç¤ºï¼Œ<code>NON_ESTABLISHED</code>ï¼ˆéæ´»è·ƒï¼‰è¿æ¥æ•°åœ¨11:30 å·¦å³æ€¥å‰§å¢åŠ ï¼Œæœ€é«˜è¾¾åˆ°äº†çº¦ <strong>2.475K</strong>ï¼Œä¸<code>ESTABLISHED</code>ï¼ˆå·²å»ºç«‹ï¼‰è¿æ¥æ•°å‡ ä¹æŒå¹³ã€‚</p><p><strong>æ’æŸ¥åŸç†</strong>ï¼šå¤§é‡çš„ <code>TIME_WAIT</code> è¿æ¥æ˜¯ TCPè¿æ¥åœ¨<strong>ä¸»åŠ¨å…³é—­å</strong>ä¿æŒçš„ä¸€æ®µç­‰å¾…æ—¶é—´ã€‚è¿™ä¸€ç°è±¡æ­ç¤ºäº†é—®é¢˜çš„å¦ä¸€é¢ï¼š<code>snakeweb_</code>åº”ç”¨åœ¨å‘é€æ•°æ®æ—¶ï¼Œé‡‡ç”¨äº†<strong>é«˜é¢‘ç‡çš„çŸ­è¿æ¥æ–¹å¼</strong>ã€‚æ¯ä¸€æ¬¡è¿æ¥çš„å»ºç«‹å’Œå…³é—­ï¼Œéƒ½åœ¨ç³»ç»Ÿä¸­ç•™ä¸‹äº†å¤§é‡çš„<code>TIME_WAIT</code>çŠ¶æ€è¿æ¥ï¼Œè™½ç„¶ä¸ç›´æ¥æ¶ˆè€—å¸¦å®½ï¼Œä½†å´å ç”¨äº†æ–‡ä»¶æè¿°ç¬¦ç­‰ç³»ç»Ÿèµ„æºï¼Œæˆä¸ºäº†ä¸€ä¸ªéœ€è¦ä¼˜åŒ–çš„æ¬¡è¦é—®é¢˜ã€‚</p><h4id="ç¬¬äº”æ­¥èº«ä»½ç¡®è®¤è§£å†³é—®é¢˜"><strong>ç¬¬äº”æ­¥ï¼šèº«ä»½ç¡®è®¤ï¼Œè§£å†³é—®é¢˜</strong></h4><p>é€šè¿‡ <code>whois</code> æŸ¥è¯¢ï¼Œæˆ‘ä»¬ç¡®è®¤äº†æµé‡æµå‡ºçš„ IPå±äºé˜¿é‡Œäº‘ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬çš„ä¸€ä¸ªæœåŠ¡ä¹‹ä¸€ã€‚è‡³æ­¤ï¼Œæ•´ä¸ªé—®é¢˜é“¾æ¡å·²ç»å®Œæ•´ã€‚æœ€åç»è¿‡æ’æŸ¥ï¼Œå†…éƒ¨çš„å¦å¤–ä¸€ä¸ªæœåŠ¡ï¼Œæ–°åŠ äº†ä¸€ä¸ªå®æ—¶åŒæ­¥æ•°æ®çš„åŠŸèƒ½ï¼Œå¯¼è‡´äº†æµé‡çš„é£™å‡ã€‚</p><h4 id="æ€»ç»“ä¸åæ€">æ€»ç»“ä¸åæ€</h4><p>è¿™æ¬¡æ’æŸ¥å®Œç¾åœ°å±•ç¤ºäº†å·¥å…·åœ¨æ•…éšœæ’æŸ¥ä¸­çš„å·¨å¤§ä½œç”¨ã€‚æˆ‘ä»¬ä»å…¬ç½‘æµé‡é£™å‡è¿™ä¸ª<strong>æ ¸å¿ƒé—®é¢˜</strong>å…¥æ‰‹ï¼Œåˆ©ç”¨<code>iftop</code> å¿«é€Ÿå°†æŠ½è±¡çš„æ€§èƒ½å¼‚å¸¸è½¬åŒ–ä¸ºæ¸…æ™°çš„ç½‘ç»œé€šä¿¡æµï¼›å†é€šè¿‡<code>nethogs</code>ï¼Œæˆ‘ä»¬é”å®šäº†å…·ä½“è¿›ç¨‹ï¼›æœ€åé€šè¿‡å¯¹<code>TIME_WAIT</code>ç­‰æ¬¡è¦ç—‡çŠ¶çš„åˆ†æï¼Œæˆ‘ä»¬è¿˜åŸäº†åº”ç”¨çš„å…·ä½“è¡Œä¸ºæ¨¡å¼ã€‚æ•´ä¸ªè¿‡ç¨‹ç¯ç¯ç›¸æ‰£ï¼Œæœ€ç»ˆæˆåŠŸå®šä½å¹¶è§£å†³äº†é—®é¢˜ã€‚è¿™æé†’æˆ‘ä»¬ï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œåº”æ—¶åˆ»å…³æ³¨æ–°åŠŸèƒ½å¯¹ç½‘ç»œå¸¦å®½ã€è¿æ¥æ¨¡å¼ç­‰åº•å±‚èµ„æºçš„å½±å“ï¼Œé¿å…å› <strong>ä¸šåŠ¡é€»è¾‘çš„æ”¹åŠ¨</strong>è€Œå¼•å‘æ½œåœ¨çš„æ€§èƒ½å±æœºã€‚</p>]]></content>
    
    
    <summary type="html">æœ¬æ–‡è¯¦ç»†è®°å½•äº†ä¸€æ¬¡ç”±å…¬ç½‘æµå‡ºå¸¦å®½é£™å‡å¼•å‘çš„æœåŠ¡å™¨æ€§èƒ½æ•…éšœæ’æŸ¥ã€‚æˆ‘ä»¬ä»ç›‘æ§å›¾è¡¨å…¥æ‰‹ï¼Œåˆ©ç”¨ iftop å®æ—¶è¿½è¸ªæµé‡å»å‘ï¼Œå¹¶æœ€ç»ˆé€šè¿‡ nethogs é”å®šåº”ç”¨ã€‚è¯¥æ¡ˆä¾‹æ­ç¤ºäº†æ–°åŠŸèƒ½é…ç½®å¯¹ç½‘ç»œèµ„æºçš„å·¨å¤§å½±å“ï¼Œä¸ºè§£å†³ç±»ä¼¼é—®é¢˜æä¾›äº†å®è´µç»éªŒã€‚</summary>
    
    
    
    <category term="æ•…éšœæ’æŸ¥" scheme="https://hedon.top/categories/%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5/"/>
    
    
    <category term="ç½‘ç»œ" scheme="https://hedon.top/tags/%E7%BD%91%E7%BB%9C/"/>
    
    <category term="æœåŠ¡å™¨" scheme="https://hedon.top/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    
    <category term="æ•…éšœæ’æŸ¥" scheme="https://hedon.top/tags/%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5/"/>
    
    <category term="iftop" scheme="https://hedon.top/tags/iftop/"/>
    
  </entry>
  
</feed>
