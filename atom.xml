<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>HedonSpace</title>
  
  
  <link href="https://hedon.top/atom.xml" rel="self"/>
  
  <link href="https://hedon.top/"/>
  <updated>2024-06-06T13:40:05.329Z</updated>
  <id>https://hedon.top/</id>
  
  <author>
    <name>Hedon Wang</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Rust å®æˆ˜ä¸¨SSE(Server-Sent Events)</title>
    <link href="https://hedon.top/2024/06/06/rust-action-sse/"/>
    <id>https://hedon.top/2024/06/06/rust-action-sse/</id>
    <published>2024-06-06T13:30:51.000Z</published>
    <updated>2024-06-06T13:40:05.329Z</updated>
    
    <content type="html"><![CDATA[<p>ğŸ“Œ SSEï¼ˆServer-SentEventsï¼‰æ˜¯ä¸€ç§å…è®¸æœåŠ¡å™¨å‘å®¢æˆ·ç«¯æµè§ˆå™¨æ¨é€ä¿¡æ¯çš„æŠ€æœ¯ã€‚å®ƒæ˜¯ HTML5çš„ä¸€éƒ¨åˆ†ï¼Œä¸“é—¨ç”¨äºå»ºç«‹ä¸€ä¸ªå•å‘çš„ä»æœåŠ¡å™¨åˆ°å®¢æˆ·ç«¯çš„é€šä¿¡è¿æ¥ã€‚SSEçš„ä½¿ç”¨åœºæ™¯éå¸¸å¹¿æ³›ï¼ŒåŒ…æ‹¬å®æ—¶æ¶ˆæ¯æ¨é€ã€å®æ—¶é€šçŸ¥æ›´æ–°ç­‰ã€‚</p><h1 id="sse-çš„æœ¬è´¨">SSE çš„æœ¬è´¨</h1><p>ä¸¥æ ¼åœ°è¯´ï¼Œ<ahref="https://en.wikipedia.org/wiki/HTTP">HTTP</a>æ— æ³•åšåˆ°æœåŠ¡å™¨ä¸»åŠ¨æ¨é€ä¿¡æ¯ã€‚ä½†æ˜¯ï¼Œæœ‰ä¸€ç§å˜é€šæ–¹æ³•ï¼Œå°±æ˜¯æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å£°æ˜ï¼Œæ¥ä¸‹æ¥è¦å‘é€çš„æ˜¯æµä¿¡æ¯ï¼ˆstreamingï¼‰ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå‘é€çš„ä¸æ˜¯ä¸€æ¬¡æ€§çš„æ•°æ®åŒ…ï¼Œè€Œæ˜¯ä¸€ä¸ªæ•°æ®æµï¼Œä¼šè¿ç»­ä¸æ–­åœ°å‘é€è¿‡æ¥ã€‚è¿™æ—¶ï¼Œå®¢æˆ·ç«¯ä¸ä¼šå…³é—­è¿æ¥ï¼Œä¼šä¸€ç›´ç­‰ç€æœåŠ¡å™¨å‘è¿‡æ¥çš„æ–°çš„æ•°æ®æµï¼Œè§†é¢‘æ’­æ”¾å°±æ˜¯è¿™æ ·çš„ä¾‹å­ã€‚æœ¬è´¨ä¸Šï¼Œè¿™ç§é€šä¿¡å°±æ˜¯ä»¥æµä¿¡æ¯çš„æ–¹å¼ï¼Œå®Œæˆä¸€æ¬¡ç”¨æ—¶å¾ˆé•¿çš„ä¸‹è½½ã€‚</p><p>SSE å°±æ˜¯åˆ©ç”¨è¿™ç§æœºåˆ¶ï¼Œä½¿ç”¨æµä¿¡æ¯å‘æµè§ˆå™¨æ¨é€ä¿¡æ¯ã€‚å®ƒåŸºäº HTTPåè®®ï¼Œç›®å‰é™¤äº† IE/Edgeï¼Œå…¶ä»–æµè§ˆå™¨éƒ½æ”¯æŒã€‚</p><h1 id="ç‰¹ç‚¹">ç‰¹ç‚¹</h1><ol type="1"><li><strong>æŒç»­è¿æ¥</strong>ï¼šä¸ä¼ ç»Ÿçš„ HTTP è¯·æ±‚ä¸åŒï¼ŒSSEä¿æŒè¿æ¥å¼€æ”¾ï¼ŒæœåŠ¡å™¨å¯ä»¥éšæ—¶å‘é€æ¶ˆæ¯ã€‚</li><li><strong>æ–‡æœ¬æ•°æ®æµ</strong>ï¼šSSEä¸»è¦ä¼ è¾“æ–‡æœ¬æ•°æ®ï¼Œè¿™äº›æ•°æ®ä»¥ç‰¹å®šçš„æ ¼å¼æµå¼ä¼ è¾“ï¼Œä½¿å¾—æ¯æ¡æ¶ˆæ¯éƒ½æ˜¯ç®€å•çš„æ–‡æœ¬æ ¼å¼ã€‚</li><li><strong>å†…ç½®é‡è¿æœºåˆ¶</strong>ï¼šæµè§ˆå™¨ä¼šè‡ªåŠ¨å¤„ç†è¿æ¥ä¸­æ–­å’Œé‡è¿ï¼ŒåŒ…æ‹¬åœ¨é‡è¿è¯·æ±‚ä¸­å‘é€æœ€åæ¥æ”¶çš„äº‹ä»¶IDï¼Œä»¥ä¾¿æœåŠ¡å™¨ä»æ­£ç¡®çš„ä½ç½®æ¢å¤å‘é€äº‹ä»¶ã€‚</li><li><strong>ç®€å•çš„å®¢æˆ·ç«¯å¤„ç†</strong>ï¼šåœ¨æµè§ˆå™¨ä¸­ï¼Œä½¿ç”¨ JavaScript çš„<code>EventSource</code> æ¥å£å¤„ç† SSEéå¸¸ç®€å•ï¼Œåªéœ€å‡ è¡Œä»£ç å³å¯ç›‘å¬æœåŠ¡å™¨å‘æ¥çš„äº‹ä»¶ã€‚</li></ol><h1 id="å·¥ä½œåŸç†">å·¥ä½œåŸç†</h1><ol type="1"><li><strong>å»ºç«‹è¿æ¥</strong>ï¼šå®¢æˆ·ç«¯é€šè¿‡åˆ›å»ºä¸€ä¸ª<code>EventSource</code> å¯¹è±¡è¯·æ±‚ç‰¹å®šçš„ URL æ¥å¯åŠ¨ SSEè¿æ¥ã€‚è¿™ä¸ªè¯·æ±‚æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ HTTPè¯·æ±‚ï¼Œä½†ä¼šè¦æ±‚æœåŠ¡å™¨ä»¥ç‰¹å®šæ–¹å¼å“åº”ã€‚</li><li><strong>æœåŠ¡å™¨å“åº”</strong>ï¼šæœåŠ¡å™¨å“åº”å¿…é¡»è®¾ç½®<code>Content-Type</code> ä¸º<code>text/event-stream</code>ï¼Œç„¶åä¿æŒè¿æ¥æ‰“å¼€ã€‚</li><li><strong>å‘é€æ¶ˆæ¯</strong>ï¼šæœåŠ¡å™¨å¯ä»¥é€šè¿‡æŒç»­å‘é€æ•°æ®æ ¼å¼ä¸ºç‰¹å®šäº‹ä»¶æµçš„æ¶ˆæ¯æ¥æ¨é€æ›´æ–°ã€‚æ¯ä¸ªæ¶ˆæ¯åŒ…æ‹¬ä¸€ä¸ªå¯é€‰çš„äº‹ä»¶ç±»å‹ã€æ•°æ®å’Œä¸€ä¸ªå¯é€‰çš„IDã€‚<ul><li><strong>æ•°æ®</strong>ï¼šå®é™…çš„æ¶ˆæ¯å†…å®¹ï¼Œä»¥ <code>data:</code>å¼€å¤´ï¼Œå¤šè¡Œæ•°æ®ä»¥åŒæ¢è¡Œç¬¦ <code>\n\n</code> ç»“æŸã€‚</li><li><strong>äº‹ä»¶ç±»å‹</strong>ï¼šå…è®¸å®¢æˆ·ç«¯æ ¹æ®äº‹ä»¶ç±»å‹æ¥ç›‘å¬ï¼Œä»¥<code>event:</code> å¼€å¤´ã€‚</li><li><strong>ID</strong>ï¼šå¦‚æœè¿æ¥ä¸­æ–­ï¼Œå®¢æˆ·ç«¯å°†å‘é€åŒ…å«ä¸Šæ¬¡æ¥æ”¶çš„æœ€åä¸€ä¸ªIDçš„<code>Last-Event-ID</code> å¤´ï¼Œä»¥ä¾¿æœåŠ¡å™¨ä»æ–­ç‚¹ç»§ç»­å‘é€æ•°æ®ã€‚</li></ul></li></ol><h1 id="å®æˆ˜">å®æˆ˜</h1><h2 id="å®¢æˆ·ç«¯">å®¢æˆ·ç«¯</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>SSE Test<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Server-Sent Events Test<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;events&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">// ç¡®ä¿è¿™é‡Œçš„URLåŒ¹é…ä½ çš„æœåŠ¡å™¨åœ°å€å’Œç«¯å£</span></span><br><span class="language-javascript">    <span class="hljs-keyword">var</span> eventSource = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventSource</span>(<span class="hljs-string">&#x27;http://localhost:8000/events&#x27;</span>);</span><br><span class="language-javascript">    eventSource.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) &#123;</span><br><span class="language-javascript">        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;New event:&#x27;</span>, event.<span class="hljs-property">data</span>);</span><br><span class="language-javascript">        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;events&#x27;</span>).<span class="hljs-property">innerHTML</span> += event.<span class="hljs-property">data</span> + <span class="hljs-string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="language-javascript">    &#125;;</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="rust-æœåŠ¡ç«¯">Rust æœåŠ¡ç«¯</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/20240606213652.gif"alt="Rust å®ç°æ¼”ç¤º" /><figcaption aria-hidden="true">Rust å®ç°æ¼”ç¤º</figcaption></figure><p>ä¾èµ–ï¼š</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs toml"><span class="hljs-attr">anyhow</span> = <span class="hljs-string">&quot;1.0.86&quot;</span><br><span class="hljs-attr">axum</span> = &#123; version = <span class="hljs-string">&quot;0.7.5&quot;</span> &#125;<br><span class="hljs-attr">chrono</span> = <span class="hljs-string">&quot;0.4.38&quot;</span><br><span class="hljs-attr">futures-core</span> = <span class="hljs-string">&quot;0.3.30&quot;</span><br><span class="hljs-attr">tokio</span> = &#123; version = <span class="hljs-string">&quot;1.38.0&quot;</span>, features = [<span class="hljs-string">&quot;macros&quot;</span>, <span class="hljs-string">&quot;rt-multi-thread&quot;</span>, ] &#125;<br><span class="hljs-attr">tokio-stream</span> = <span class="hljs-string">&quot;0.1.15&quot;</span><br><span class="hljs-attr">tower-http</span> = &#123; version = <span class="hljs-string">&quot;0.5.2&quot;</span>, features = [<span class="hljs-string">&quot;cors&quot;</span>] &#125;<br></code></pre></td></tr></table></figure><p>ä»£ç ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> std::time::Duration;<br><br><span class="hljs-keyword">use</span> axum::&#123;<br>    response::&#123;sse::Event, Sse&#125;,<br>    routing::get,<br>    Router,<br>&#125;;<br><span class="hljs-keyword">use</span> tokio::&#123;net::TcpListener, time::interval&#125;;<br><span class="hljs-keyword">use</span> tokio_stream::&#123;wrappers::IntervalStream, StreamExt&#125;;<br><span class="hljs-keyword">use</span> tower_http::cors::&#123;Any, CorsLayer&#125;;<br><br><span class="hljs-meta">#[tokio::main]</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-&gt;</span> anyhow::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cors</span> = CorsLayer::<span class="hljs-title function_ invoke__">new</span>()<br>        .<span class="hljs-title function_ invoke__">allow_headers</span>(Any)<br>        .<span class="hljs-title function_ invoke__">allow_origin</span>(Any)<br>        .<span class="hljs-title function_ invoke__">allow_headers</span>(Any)<br>        .<span class="hljs-title function_ invoke__">allow_credentials</span>(<span class="hljs-literal">false</span>);<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">listener</span> = TcpListener::<span class="hljs-title function_ invoke__">bind</span>(<span class="hljs-string">&quot;0.0.0.0:8000&quot;</span>).<span class="hljs-keyword">await</span>?;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">app</span> = Router::<span class="hljs-title function_ invoke__">new</span>().<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;/events&quot;</span>, <span class="hljs-title function_ invoke__">get</span>(sse_handler)).<span class="hljs-title function_ invoke__">layer</span>(cors);<br>    axum::<span class="hljs-title function_ invoke__">serve</span>(listener, app).<span class="hljs-keyword">await</span>?;<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">sse_handler</span>() <span class="hljs-punctuation">-&gt;</span> Sse&lt;<span class="hljs-keyword">impl</span> <span class="hljs-title class_">futures_core</span>::Stream&lt;Item = <span class="hljs-type">Result</span>&lt;Event, axum::Error&gt;&gt;&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">interval</span> = <span class="hljs-title function_ invoke__">interval</span>(Duration::<span class="hljs-title function_ invoke__">from_secs</span>(<span class="hljs-number">1</span>));<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">stream</span> = IntervalStream::<span class="hljs-title function_ invoke__">new</span>(interval).<span class="hljs-title function_ invoke__">map</span>(|_| &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">data</span> = <span class="hljs-built_in">format!</span>(<span class="hljs-string">&quot;&#123;&#125;\n\n&quot;</span>, chrono::Local::<span class="hljs-title function_ invoke__">now</span>().<span class="hljs-title function_ invoke__">to_rfc2822</span>());<br>        <span class="hljs-title function_ invoke__">Ok</span>(Event::<span class="hljs-title function_ invoke__">default</span>().<span class="hljs-title function_ invoke__">data</span>(data))<br>    &#125;);<br><br>    Sse::<span class="hljs-title function_ invoke__">new</span>(stream)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="go-æœåŠ¡ç«¯">Go æœåŠ¡ç«¯</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/20240606195749.gif"alt="Go å®ç°æ¼”ç¤º" /><figcaption aria-hidden="true">Go å®ç°æ¼”ç¤º</figcaption></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;log&quot;</span><br><span class="hljs-string">&quot;net/http&quot;</span><br><span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sseHandler</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;<br><span class="hljs-comment">// è®¾ç½®å¤´éƒ¨ä¿¡æ¯ï¼Œç¡®ä¿å…è®¸è·¨åŸŸï¼Œå¹¶ä¸”å‘Šè¯‰æµè§ˆå™¨è¿™æ˜¯ä¸€ä¸ªäº‹ä»¶æµ</span><br>w.Header().Set(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;text/event-stream&quot;</span>)<br>w.Header().Set(<span class="hljs-string">&quot;Cache-Control&quot;</span>, <span class="hljs-string">&quot;no-cache&quot;</span>)<br>w.Header().Set(<span class="hljs-string">&quot;Connection&quot;</span>, <span class="hljs-string">&quot;keep-alive&quot;</span>)<br>w.Header().Set(<span class="hljs-string">&quot;Access-Control-Allow-Origin&quot;</span>, <span class="hljs-string">&quot;*&quot;</span>)<br><br><span class="hljs-comment">// ä¸æ–­å‘é€æ¶ˆæ¯</span><br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-comment">// ç”ŸæˆæœåŠ¡å™¨æ—¶é—´ï¼Œå¹¶å‘é€ç»™å®¢æˆ·ç«¯</span><br>now := time.Now()<br><span class="hljs-comment">// ç”Ÿæˆæ¶ˆæ¯ï¼Œæ ¼å¼ä¸º data: &#123;content&#125; \n\n</span><br>msg := fmt.Sprintf(<span class="hljs-string">&quot;data: %s\n\n&quot;</span>, now.Format(time.DateTime))<br><span class="hljs-comment">// å‘é€æ¶ˆæ¯</span><br><span class="hljs-keyword">if</span> _, err := fmt.Fprintf(w, msg); err != <span class="hljs-literal">nil</span> &#123;<br>log.Println(<span class="hljs-string">&quot;write error:&quot;</span>, err)<br><span class="hljs-keyword">break</span><br>&#125;<br><br><span class="hljs-comment">// åˆ·æ–°å“åº”ç¼“å†²ï¼Œç¡®ä¿å³æ—¶å‘é€</span><br>flusher, ok := w.(http.Flusher)<br><span class="hljs-keyword">if</span> !ok &#123;<br>log.Println(<span class="hljs-string">&quot;Streaming unsupported!&quot;</span>)<br><span class="hljs-keyword">break</span><br>&#125;<br>flusher.Flush()<br><br><span class="hljs-comment">// æ¯ç§’å‘é€ä¸€æ¬¡</span><br>time.Sleep(<span class="hljs-number">1</span> * time.Second)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>http.HandleFunc(<span class="hljs-string">&quot;/events&quot;</span>, sseHandler)<br>log.Println(<span class="hljs-string">&quot;Server started on port 8000...&quot;</span>)<br>log.Fatal(http.ListenAndServe(<span class="hljs-string">&quot;:8000&quot;</span>, <span class="hljs-literal">nil</span>))<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">æœ¬æ–‡è¯¦ç»†ä»‹ç»äº† SSE çš„å·¥ä½œåŸç†ï¼Œå¹¶é€šè¿‡ç¤ºä¾‹ä»£ç å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ Go å’Œ Rust å®ç°ä¸€ä¸ªç®€å•çš„ SSE æœåŠ¡ç«¯ï¼Œå±•ç¤ºäº†åœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨ SSE çš„æ–¹æ³•ã€‚</summary>
    
    
    
    <category term="Rust" scheme="https://hedon.top/categories/Rust/"/>
    
    <category term="Rust å®æˆ˜" scheme="https://hedon.top/categories/Rust/Rust-%E5%AE%9E%E6%88%98/"/>
    
    
    <category term="Go" scheme="https://hedon.top/tags/Go/"/>
    
    <category term="Rust" scheme="https://hedon.top/tags/Rust/"/>
    
    <category term="SSE" scheme="https://hedon.top/tags/SSE/"/>
    
  </entry>
  
  <entry>
    <title>Rust å®æˆ˜ä¸¨é€šè¿‡å®ç° json! æŒæ¡å£°æ˜å®</title>
    <link href="https://hedon.top/2024/05/28/rust-action-macro-json/"/>
    <id>https://hedon.top/2024/05/28/rust-action-macro-json/</id>
    <published>2024-05-28T07:37:23.000Z</published>
    <updated>2024-05-28T15:13:08.694Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ Rustç¼–ç¨‹è¯­è¨€ä¸­ï¼Œå®æ˜¯ä¸€ç§å¼ºå¤§çš„å·¥å…·ï¼Œå¯ä»¥ç”¨äºåœ¨ç¼–è¯‘æ—¶ç”Ÿæˆä»£ç ã€‚<code>json!</code>æ˜¯ä¸€ä¸ªåœ¨ Rust ä¸­å¹¿æ³›ä½¿ç”¨çš„å®ï¼Œå®ƒå…è®¸æˆ‘ä»¬åœ¨ Rust ä»£ç ä¸­æ–¹ä¾¿åœ°åˆ›å»º JSONæ•°æ®ã€‚</p><p>å£°æ˜å®ï¼ˆdeclarative macrosï¼‰æ˜¯ Rust ä¸­çš„ä¸€ç§å®ï¼Œå®ƒä»¬ä½¿ç”¨<code>macro_rules!</code> å…³é”®å­—å®šä¹‰ã€‚</p><p>æœ¬æ–‡å°†å‚è€ƒã€ŠRust ç¨‹åºè®¾è®¡ï¼ˆç¬¬äºŒç‰ˆï¼‰ã€‹ï¼Œé€šè¿‡å®ç° <code>json!</code>å®ï¼Œæ·±å…¥ç†è§£å£°æ˜å®çš„å·¥ä½œåŸç†ã€‚</p><h1 id="ç»“è®ºå…ˆè¡Œ">ç»“è®ºå…ˆè¡Œ</h1><p>æœ¬æ–‡æˆ‘ä»¬å°†æ„å»ºä¸€ä¸ª <code>json!</code> å®ï¼Œå®ƒæ”¯æŒæˆ‘ä»¬ä»¥å­—ç¬¦ä¸² JSONé£æ ¼çš„è¯­æ³•æ¥ç¼–å†™ Json å€¼ã€‚å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">students</span> = json![<br>&#123;<br><span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;Hedon Wang&quot;</span>,<br><span class="hljs-string">&quot;class_of&quot;</span>: <span class="hljs-number">2022</span>,<br><span class="hljs-string">&quot;major&quot;</span>: <span class="hljs-string">&quot;Software engineering&quot;</span><br>&#125;,<br>&#123;<br><span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;Jun Lei&quot;</span>,<br><span class="hljs-string">&quot;class_of&quot;</span>: <span class="hljs-number">1991</span>,<br><span class="hljs-string">&quot;major&quot;</span>: <span class="hljs-string">&quot;Computor science&quot;</span><br>&#125;<br>]<br></code></pre></td></tr></table></figure><blockquote><p><a href="#å®Œæ•´ä»£ç ">å®Œæ•´ä»£ç </a></p></blockquote><h1 id="å®ç°-json">å®ç° <code>json!</code></h1><h2 id="å®šä¹‰-json-enum">å®šä¹‰ Json enum</h2><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦æ€è€ƒä¸€ä¸‹ Json ç»“æ„æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿä¸»è¦æ˜¯ä»¥ä¸‹ 3 ç§æ¨¡å¼ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;hedon&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">18</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;school&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Wuhan University&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;address&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Hubwi Wuhan&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">[</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;hedon&quot;</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;john&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-literal"><span class="hljs-keyword">null</span></span><br></code></pre></td></tr></table></figure><p>ä¸ºæ­¤æˆ‘ä»¬å®šä¹‰ä¸€ä¸ª Json ç»“æ„çš„æšä¸¾ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[derive(Clone, PartialEq, Debug)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Json</span> &#123;<br>    Null,<br>    <span class="hljs-title function_ invoke__">Boolean</span>(<span class="hljs-type">bool</span>),<br>    <span class="hljs-title function_ invoke__">Number</span>(<span class="hljs-type">f64</span>),<br>    <span class="hljs-title function_ invoke__">String</span>(<span class="hljs-type">String</span>),<br>    <span class="hljs-title function_ invoke__">Array</span>(<span class="hljs-type">Vec</span>&lt;Json&gt;),<br>    <span class="hljs-title function_ invoke__">Object</span>(HashMap&lt;<span class="hljs-type">String</span>, Json&gt;),<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½ åº”è¯¥å¯ä»¥æ„Ÿåˆ°éå¸¸å¥‡å¦™ï¼Œä½¿ç”¨ä¸€ä¸ªè¿™ä¹ˆç®€å•çš„æšä¸¾ï¼Œå±…ç„¶å°±å¯ä»¥è¡¨ç¤ºæ‰€æœ‰çš„Json ç»“æ„äº†ã€‚é—æ†¾çš„æ˜¯ï¼Œç°åœ¨è¿™ä¸ªç»“æ„ç¼–å†™ Json å€¼çš„è¯­æ³•ç›¸å½“å†—é•¿ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">people</span> = Json::<span class="hljs-title function_ invoke__">Object</span>(HashMap::<span class="hljs-title function_ invoke__">from</span>([<br>    (<span class="hljs-string">&quot;name&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), Json::<span class="hljs-title function_ invoke__">String</span>(<span class="hljs-string">&quot;hedon&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>())),<br>    (<span class="hljs-string">&quot;age&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), Json::<span class="hljs-title function_ invoke__">Number</span>(<span class="hljs-number">10.0</span>)),<br>    (<span class="hljs-string">&quot;is_student&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), Json::<span class="hljs-title function_ invoke__">Boolean</span>(<span class="hljs-literal">true</span>)),<br>    (<br>        <span class="hljs-string">&quot;detail&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(),<br>        Json::<span class="hljs-title function_ invoke__">Object</span>(HashMap::<span class="hljs-title function_ invoke__">from</span>([<br>            (<span class="hljs-string">&quot;address&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), Json::<span class="hljs-title function_ invoke__">String</span>(<span class="hljs-string">&quot;beijing&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>())),<br>            (<span class="hljs-string">&quot;phone&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), Json::<span class="hljs-title function_ invoke__">String</span>(<span class="hljs-string">&quot;1234567890&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>()))<br>        ]))<br>    )<br>]))<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬æœŸæœ›å¯ä»¥ä»¥ä¸‹é¢è¿™ç§æ–¹å¼æ¥å£°æ˜ Jsonå˜é‡ï¼Œè¿™çœ‹èµ·æ¥å°±æ¸…çˆ½è®¸å¤šäº†ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">students</span> = json!([<br>    &#123;<br>        <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;Jim Blandy&quot;</span>,<br>        <span class="hljs-string">&quot;class_of&quot;</span>: <span class="hljs-number">1926</span>,<br>        <span class="hljs-string">&quot;major&quot;</span>: <span class="hljs-string">&quot;Tibetan throat singing&quot;</span><br>    &#125;,<br>    &#123;<br>        <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;Jason Orendorff&quot;</span>,<br>        <span class="hljs-string">&quot;class_of&quot;</span>: <span class="hljs-number">1702</span>,<br>        <span class="hljs-string">&quot;major&quot;</span>: <span class="hljs-string">&quot;Knots&quot;</span><br>    &#125;<br>]);<br></code></pre></td></tr></table></figure><h2 id="çŒœæƒ³-json">çŒœæƒ³ <code>json!</code></h2><p>æˆ‘ä»¬å¯ä»¥é¢„è§ Json å®å†…éƒ¨å°†ä¼šæœ‰å¤šæ¡è§„åˆ™ï¼Œå› ä¸º JSONæ•°æ®æœ‰å¤šç§ç±»å‹ï¼šå¯¹è±¡ã€æ•°ç»„ã€æ•°å€¼ç­‰ã€‚äº‹å®ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥åˆç†åœ°çŒœæµ‹æ¯ç§ JSONç±»å‹éƒ½å°†æœ‰ä¸€æ¡è§„åˆ™ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-built_in">macro_rules!</span> json &#123;<br>    (null)    =&gt; &#123; Json::Null &#125;;<br>    ([ ... ]) =&gt; &#123; Json::<span class="hljs-title function_ invoke__">Array</span>(...) &#125;;<br>    (&#123; ... &#125;) =&gt; &#123; Json::<span class="hljs-title function_ invoke__">Object</span>(...) &#125;;<br>    (???)     =&gt; &#123; Json::<span class="hljs-title function_ invoke__">Boolean</span>(...) &#125;;<br>    (???)     =&gt; &#123; Json::<span class="hljs-title function_ invoke__">Number</span>(...) &#125;;<br>    (???)     =&gt; &#123; Json::<span class="hljs-title function_ invoke__">String</span>(...) &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶è€Œè¿™ä¸å¤ªæ­£ç¡®ï¼Œå› ä¸ºå®æ¨¡å¼æ— æ³•åŒºåˆ†æœ€å 3ç§æƒ…å†µï¼Œç¨åæˆ‘ä»¬ä¼šè®¨è®ºå¦‚ä½•å¤„ç†ã€‚è‡³äºå‰ 3ç§æƒ…å†µï¼Œæ˜¾ç„¶å®ƒä»¬æ˜¯ä»¥ä¸åŒçš„è¯­æ³•æ ‡è®°å¼€å§‹çš„ï¼Œæ‰€ä»¥è¿™å‡ ç§æƒ…å†µæ¯”è¾ƒå¥½å¤„ç†ã€‚</p><h2 id="å®ç°-null">å®ç° Null</h2><p>æˆ‘ä»¬å…ˆä»æœ€ç®€å•çš„ <code>Null</code> åˆ†æ”¯å¼€å§‹ï¼Œå…ˆç¼–å†™å¦‚ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[cfg(test)]</span><br><span class="hljs-keyword">mod</span> tests &#123;<br>    <span class="hljs-keyword">use</span> super::*;<br><br>    <span class="hljs-meta">#[test]</span><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">test_null_json</span>() &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">json</span> = json!(null);<br>        <span class="hljs-built_in">assert_eq!</span>(json, Json::Null);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æƒ³è¦é€šè¿‡ä¸Šè¿°æµ‹è¯•ç”¨ä¾‹éå¸¸ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ <code>macro_rules!</code>æ”¯æŒä¸­åŒ¹é…è¿™ç§æƒ…å†µå³å¯ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[macro_export]</span><br><span class="hljs-built_in">macro_rules!</span> json &#123;<br>    (null) =&gt; &#123;<br>        Json::Null<br>    &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>#[macro_export]</code> æ³¨è§£æ˜¯ Rustä¸­çš„ä¸€ä¸ªå±æ€§ï¼Œç”¨äºæŒ‡ç¤ºè¿™ä¸ªå®åº”è¯¥è¢«å¯¼å‡ºåˆ°è°ƒç”¨è€…çš„ä½œç”¨åŸŸä¸­ï¼Œè¿™æ ·å…¶ä»–æ¨¡å—ä¹Ÿå¯ä»¥ä½¿ç”¨å®ƒã€‚</li><li><code>macro_rules!</code>å®å®šä¹‰äº†ä¸€ä¸ªè‡ªå®šä¹‰çš„å®ã€‚åœ¨è¿™é‡Œï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªåä¸º <code>json</code>çš„å®ï¼Œç”¨äºç”Ÿæˆ JSON æ•°æ®ã€‚</li><li>å®å®šä¹‰ä¸­ <code>(null)</code> æ˜¯åŒ¹é…æ¨¡å¼ã€‚è¿™æ„å‘³ç€å½“ä½ è°ƒç”¨<code>json!</code> å®å¹¶ä¼ é€’ <code>null</code>ä½œä¸ºå‚æ•°æ—¶ï¼Œå°†ä¼šè§¦å‘è¿™ä¸ªè§„åˆ™ã€‚</li><li><code>=&gt;</code>ç¬¦å·ç”¨äºæŒ‡ç¤ºåŒ¹é…æ¨¡å¼åçš„ä»£ç å—ã€‚åœ¨è¿™é‡Œï¼Œå®ƒæŒ‡å®šäº†å½“åŒ¹é…<code>(null)</code> æ—¶åº”è¯¥ç”Ÿæˆçš„ä»£ç å—ã€‚</li><li><code>Json::Null</code> æ˜¯ä¸€ä¸ª JSON ç±»å‹çš„æšä¸¾å€¼ï¼Œè¡¨ç¤º JSON ä¸­çš„null å€¼ã€‚è¿™ä¸ªå®çš„ç›®çš„æ˜¯å°†ä¼ å…¥çš„ <code>null</code> è½¬æ¢ä¸º<code>Json::Null</code>ã€‚</li></ul><h2 id="å®ç°-booleannumberstring">å®ç° Boolean/Number/String</h2><p>æˆ‘ä»¬å…ˆå‡†å¤‡å¦‚ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[test]</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">test_boolean_number_string_json</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">json</span> = json!(<span class="hljs-literal">true</span>);<br>    <span class="hljs-built_in">assert_eq!</span>(json, Json::<span class="hljs-title function_ invoke__">Boolean</span>(<span class="hljs-literal">true</span>));<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">json</span> = json!(<span class="hljs-number">1.0</span>);<br>    <span class="hljs-built_in">assert_eq!</span>(json, Json::<span class="hljs-title function_ invoke__">Number</span>(<span class="hljs-number">1.0</span>));<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">json</span> = json!(<span class="hljs-string">&quot;hello&quot;</span>);<br>    <span class="hljs-built_in">assert_eq!</span>(json, Json::<span class="hljs-title function_ invoke__">String</span>(<span class="hljs-string">&quot;hello&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>()));<br>&#125;<br></code></pre></td></tr></table></figure><p>é€šè¿‡è§‚å¯Ÿåˆ†æï¼Œå®ƒä»¬å…¶å®éƒ½æ˜¯åŒä¸€ç§æ¨¡å¼ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240528114725679.png"alt="Boolean/Number/String åˆ†æ" /><figcaption aria-hidden="true">Boolean/Number/String åˆ†æ</figcaption></figure><p>ç°åœ¨éœ€è¦è§£å†³çš„é—®é¢˜å°±æ˜¯ï¼Œå¦‚ä½•å°†è¿™ 3 ç§æ¨¡å¼è¿›è¡Œç»Ÿä¸€ï¼Œè¿™æ ·åœ¨<code>macro_rules!</code> ä¸­æ‰å¯ä»¥ç»Ÿä¸€åŒ¹é…æ¨¡å¼å¹¶è¿›è¡Œä»£ç ç”Ÿæˆã€‚</p><p>è¿™é‡Œæˆ‘ä»¬å…¶å®éœ€è¦åšçš„å°±æ˜¯å°† <code>bool</code>ã€<code>f64</code> å’Œ<code>&amp;str</code> è½¬ä¸ºå¯¹åº”çš„ <code>Json</code>ç±»å‹ã€‚é‚£å°±éœ€è¦ç”¨åˆ°æ ‡å‡†åº“ä¸­çš„ <code>From</code> trait äº†ã€‚</p><p>åšæ³•å¾ˆç®€å•ï¼Œæˆ‘ä»¬å®ç°å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;<span class="hljs-type">bool</span>&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">Json</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(value: <span class="hljs-type">bool</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        Json::<span class="hljs-title function_ invoke__">Boolean</span>(value)<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;&amp;<span class="hljs-type">str</span>&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">Json</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(value: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        Json::<span class="hljs-title function_ invoke__">String</span>(value.<span class="hljs-title function_ invoke__">to_string</span>())<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;<span class="hljs-type">f64</span>&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">Json</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(value: <span class="hljs-type">f64</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        Json::<span class="hljs-title function_ invoke__">Number</span>(value)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå®Œå–„æˆ‘ä»¬çš„ <code>json!</code>ï¼Œç›®å‰çš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[macro_export]</span><br><span class="hljs-built_in">macro_rules!</span> json &#123;<br>    (null) =&gt; &#123;<br>        Json::Null<br>    &#125;;<br>    ($value: tt) =&gt; &#123;<br>        Json::<span class="hljs-title function_ invoke__">from</span>($value)<br>    &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ <code>$value</code>ä½œ ä¸ºå˜é‡æ¥æ‰¿æ¥åŒ¹é…åˆ°çš„å…ƒç´ ï¼Œå…¶ç±»å‹ä¸º<code>tt</code> ï¼Œè¡¨ç¤ºä»»æ„çš„è¯­æ³•æ ‡è®°æ ‘ã€‚å…·ä½“å¯ä»¥å‚è€ƒï¼š<ahref="#ç‰‡æ®µç±»å‹">ç‰‡æ®µç±»å‹</a>ã€‚</p><p>è¿™æ—¶è¿è¡Œä¸Šè¿°æµ‹è¯•ç”¨ä¾‹ï¼Œæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">PASS [   0.004s] json-macro tests::test_boolean_number_string_json<br>PASS [   0.004s] json-macro tests::test_null_json<br></code></pre></td></tr></table></figure><p>ç¾ä¸­ä¸è¶³çš„æ˜¯ï¼ŒJSON ç»“æ„ä¸­çš„æ•°å­—ç±»å‹ï¼Œå…¶å®ä¸ä¸€å®šæ˜¯ f64ï¼Œä¹Ÿå¯ä»¥æ˜¯i32ã€u32ã€f32 æˆ–å…¶ä»–çš„æ•°å­—ç±»å‹ï¼Œå¦‚æœæˆ‘ä»¬è¦ä¸ºè¿™å…¨éƒ¨çš„æ•°å­—ç±»å‹éƒ½å®ç°åˆ°Json çš„ <code>From</code> traitï¼Œé‚£å°±å¤šå†—ä½™ã€‚</p><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬åˆå¯ä»¥å®ç°ä¸€ä¸ªå®ï¼Œç”¨äºå¿«é€Ÿç”Ÿæˆ<code>impl From&lt;T&gt; for Json</code>ã€‚è¿™ä¸ªå®ç°æ¯”è¾ƒç®€å•ï¼Œæœ¬æ–‡å°±ä¸èµ˜è¿°äº†ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[macro_export]</span><br><span class="hljs-built_in">macro_rules!</span> impl_from_for_primitives &#123;<br>    (  $( $<span class="hljs-keyword">type</span>: ty ) * ) =&gt; &#123;<br>        $(<br>            <span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;$<span class="hljs-keyword">type</span>&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">Json</span> &#123;<br>                <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(value: $<span class="hljs-keyword">type</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>                    Json::<span class="hljs-title function_ invoke__">Number</span>(value <span class="hljs-keyword">as</span> <span class="hljs-type">f64</span>)<br>                &#125;<br>            &#125;<br>        )*<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬åªéœ€è¦ç”¨ä¸‹é¢è¿™ä¸€è¡Œä»£ç ï¼Œå°±å¯ä»¥ä¸ºæ‰€æœ‰çš„æ•°å­—ç±»å‹å®ç°<code>From</code> trait äº†ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust">impl_from_for_primitives!(<span class="hljs-type">u8</span> <span class="hljs-type">u16</span> <span class="hljs-type">u32</span> <span class="hljs-type">u64</span> <span class="hljs-type">i8</span> <span class="hljs-type">i16</span> <span class="hljs-type">i32</span> <span class="hljs-type">i64</span> <span class="hljs-type">f32</span> <span class="hljs-type">f64</span> <span class="hljs-type">isize</span> <span class="hljs-type">usize</span>);<br></code></pre></td></tr></table></figure><p>è®°å¾—è¿™ä¸ªæ—¶å€™ä½ è¦åˆ é™¤ä¸Šé¢æ‰‹åŠ¨å®ç°çš„<code>impl From&lt;f64&gt; for Json</code>ï¼Œä¸ç„¶ä¼šæœ‰ impl å†²çªé”™è¯¯ã€‚</p><p>å†æ¬¡è¿è¡Œæµ‹è¯•ï¼Œä¹Ÿæ˜¯å¯ä»¥é€šè¿‡çš„ã€‚</p><h2 id="å®ç°-array">å®ç° Array</h2><p>å‡†å¤‡å¦‚ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[test]</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">test_array_json</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">json</span> = json!([<span class="hljs-number">1</span>, null, <span class="hljs-string">&quot;string&quot;</span>, <span class="hljs-literal">true</span>]);<br>    <span class="hljs-built_in">assert_eq!</span>(<br>        json,<br>        Json::<span class="hljs-title function_ invoke__">Array</span>(<span class="hljs-built_in">vec!</span>[<br>            Json::<span class="hljs-title function_ invoke__">Number</span>(<span class="hljs-number">1.0</span>),<br>            Json::Null,<br>            Json::<span class="hljs-title function_ invoke__">String</span>(<span class="hljs-string">&quot;string&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>()),<br>            Json::<span class="hljs-title function_ invoke__">Boolean</span>(<span class="hljs-literal">true</span>)<br>        ])<br>    )<br>&#125;<br></code></pre></td></tr></table></figure><p>è¦åŒ¹é…<code>[1, null, "string", true]</code>è¿™ä¸ªæ¨¡å¼ï¼Œç¬”è€…çš„åˆ†æè¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol type="1"><li>é¦–å…ˆæ˜¯å¤–é¢çš„ä¸¤ä¸ªä¸­æ‹¬å· <code>[</code> å’Œ <code>]</code> ï¼›</li><li>å†å¾€é‡Œï¼Œæ˜¯ä¸€ä¸ªé‡å¤åŒ¹é…çš„æ¨¡å¼ï¼Œä»¥ <code>,</code> åˆ†å‰²ï¼Œå¯ä»¥åŒ¹é… 0åˆ°ä»»æ„å¤šä¸ªå…ƒç´ ï¼Œæ‰€ä»¥æ˜¯ <code>$(  ,*)</code> ï¼Œå…·ä½“å¯ä»¥å‚è€ƒï¼š<ahref="#é‡å¤æ¨¡å¼">é‡å¤æ¨¡å¼</a>ï¼›</li><li>æœ€é‡Œé¢å°±æ˜¯ç¬¬ 2 æ­¥è¦åŒ¹é…çš„å…ƒç´ äº†ï¼Œæˆ‘ä»¬å…ˆç”¨ <code>$element</code>ä½œä¸ºå˜é‡æ¥æ‰¿æ¥æ¯ä¸€ä¸ªå…ƒç´ ï¼Œå…¶ç±»å‹ä¸º <code>tt</code>ï¼Œè¡¨ç¤ºä»»æ„çš„è¯­æ³•æ ‡è®°æ ‘ã€‚</li></ol><p>åˆ†æå®ŒåŒ¹é…çš„è¡¨è¾¾å¼åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust">([ $( $element:tt ), * ]) =&gt; &#123; <span class="hljs-comment">/* TODO */</span> &#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è¦ç”Ÿæˆçš„ä»£ç é•¿è¿™ä¸ªæ ·å­ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust">Json::<span class="hljs-title function_ invoke__">Array</span>(<span class="hljs-built_in">vec!</span>[<br>    Json::<span class="hljs-title function_ invoke__">Number</span>(<span class="hljs-number">1.0</span>),<br>    Json::Null,<br>    Json::<span class="hljs-title function_ invoke__">String</span>(<span class="hljs-string">&quot;string&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>()),<br>    Json::<span class="hljs-title function_ invoke__">Boolean</span>(<span class="hljs-literal">true</span>)<br>])<br></code></pre></td></tr></table></figure><p>å…¶å®å°±æ˜¯ä¸€ä¸ª <code>vec!</code>ï¼Œç„¶åé‡Œé¢æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ª<code>Json</code>ï¼Œå¦‚æ­¤é€’å½’ä¸‹å»ã€‚</p><p>å³å¯ä»¥å¾—åˆ°ä»£ç ç”Ÿæˆéƒ¨åˆ†çš„é€»è¾‘ä¸ºï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust">Json::<span class="hljs-title function_ invoke__">Array</span>(<span class="hljs-built_in">vec!</span>[$(json!($element)),* ])<br></code></pre></td></tr></table></figure><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240528134133088.png"alt="Json::Array å®åˆ†æ" /><figcaption aria-hidden="true">Json::Array å®åˆ†æ</figcaption></figure><p>ç»¼ä¸Šï¼Œæˆ‘ä»¬å®ç°çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[macro_export]</span><br><span class="hljs-built_in">macro_rules!</span> json &#123;<br>    (null) =&gt; &#123;<br>        Json::Null<br>    &#125;;<br>    ([ $( $element: tt),* ]) =&gt; &#123;<br>        Json::<span class="hljs-title function_ invoke__">Array</span>(<span class="hljs-built_in">vec!</span>[ $( json!($element)), * ])<br>    &#125;;<br>    ($value: tt) =&gt; &#123;<br>        Json::<span class="hljs-title function_ invoke__">from</span>($value)<br>    &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œæµ‹è¯•ç”¨ä¾‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">PASS [   0.003s] json-macro tests::test_null_json<br>PASS [   0.003s] json-macro tests::test_boolean_number_string_json<br>PASS [   0.004s] json-macro tests::test_array_json<br></code></pre></td></tr></table></figure><h2 id="å®ç°-object">å®ç° Object</h2><p>å†™å¥½å¦‚ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼Œè¿™æ¬¡æˆ‘ä»¬é¡ºå¸¦æŠŠ Nullã€Booleanã€Number å’Œ Stringå¸¦ä¸Šäº†ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[test]</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">test_object_json</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">json</span> = json!(&#123;<br>        <span class="hljs-string">&quot;null&quot;</span>: null,<br>        <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;hedon&quot;</span>,<br>        <span class="hljs-string">&quot;age&quot;</span>: <span class="hljs-number">10</span>,<br>        <span class="hljs-string">&quot;is_student&quot;</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-string">&quot;detail&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;address&quot;</span>: <span class="hljs-string">&quot;beijing&quot;</span>,<br>            <span class="hljs-string">&quot;phone&quot;</span>: <span class="hljs-string">&quot;1234567890&quot;</span><br>        &#125;<br>    &#125;);<br>    <span class="hljs-built_in">assert_eq!</span>(<br>        json,<br>        Json::<span class="hljs-title function_ invoke__">Object</span>(HashMap::<span class="hljs-title function_ invoke__">from</span>([<br>            (<span class="hljs-string">&quot;name&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), Json::<span class="hljs-title function_ invoke__">String</span>(<span class="hljs-string">&quot;hedon&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>())),<br>            (<span class="hljs-string">&quot;age&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), Json::<span class="hljs-title function_ invoke__">Number</span>(<span class="hljs-number">10.0</span>)),<br>            (<span class="hljs-string">&quot;is_student&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), Json::<span class="hljs-title function_ invoke__">Boolean</span>(<span class="hljs-literal">true</span>)),<br>            (<br>                <span class="hljs-string">&quot;detail&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(),<br>                Json::<span class="hljs-title function_ invoke__">Object</span>(HashMap::<span class="hljs-title function_ invoke__">from</span>([<br>                    (<span class="hljs-string">&quot;address&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), Json::<span class="hljs-title function_ invoke__">String</span>(<span class="hljs-string">&quot;beijing&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>())),<br>                    (<span class="hljs-string">&quot;phone&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), Json::<span class="hljs-title function_ invoke__">String</span>(<span class="hljs-string">&quot;1234567890&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>()))<br>                ]))<br>            )<br>        ]))<br>    )<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹æ¯”é¢„æœŸçš„ <code>json!</code> å®å†…å®¹å’Œå±•å¼€åçš„ä»£ç ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240528133040062.png"alt="Json::Object å®åˆ†æ" /><figcaption aria-hidden="true">Json::Object å®åˆ†æ</figcaption></figure><p>å®Œå–„æˆ‘ä»¬çš„ <code>macro_rules! json</code> ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[macro_export]</span><br><span class="hljs-built_in">macro_rules!</span> json &#123;<br>    (null) =&gt; &#123;<br>        Json::Null<br>    &#125;;<br>    ([ $( $element: tt),* ]) =&gt; &#123;<br>        Json::<span class="hljs-title function_ invoke__">Array</span>(<span class="hljs-built_in">vec!</span>[ $( json!($element)), * ])<br>    &#125;;<br>    (&#123; $( $key:tt : $value:tt ),* &#125;) =&gt; &#123;<br>        Json::<span class="hljs-title function_ invoke__">Object</span>(HashMap::<span class="hljs-title function_ invoke__">from</span>([<br>            $(<br>                ( $key.<span class="hljs-title function_ invoke__">to_string</span>(), json!($value) )<br>            ), *<br>        ]))<br>    &#125;;<br>    ($value: tt) =&gt; &#123;<br>        Json::<span class="hljs-title function_ invoke__">from</span>($value)<br>    &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œæµ‹è¯•ç”¨ä¾‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">PASS [   0.004s] json-macro tests::test_object_json<br>PASS [   0.005s] json-macro tests::test_array_json<br>PASS [   0.004s] json-macro tests::test_null_json<br>PASS [   0.005s] json-macro tests::test_boolean_number_string_json<br></code></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®Œæˆäº† <code>json!</code> å®çš„æ„å»ºäº†ï¼å®Œæ•´æºç å¯è§ï¼š<ahref="https://www.notion.so/e90c161d8e3743b2a4f788e3d7b75181?pvs=21">å®Œæ•´ä»£ç </a></p><p>Peace! Enjoy coding~</p><h1 id="é™„å½•">é™„å½•</h1><h2 id="é‡å¤æ¨¡å¼">é‡å¤æ¨¡å¼</h2><p>åœ¨ <ahref="https://www.notion.so/Array-c914526ab9474ccd9cb92c7eb17225b6?pvs=21">å®ç°Array</a> ä¸­ï¼Œæˆ‘ä»¬åŒ¹é…äº†è¿™æ ·ä¸€ä¸ªæ¨¡å¼ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust">([ $( $element:tt ), * ]) =&gt; &#123; <span class="hljs-comment">/* TODO */</span> &#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>$($element:tt), *)</code>å°±æ˜¯ä¸€ä¸ªé‡å¤æ¨¡å¼ï¼Œå…¶å¯ä»¥è¿›ä¸€æ­¥æŠ½è±¡ä¸º <code>$( ... ),*</code> ï¼Œè¡¨ç¤ºåŒ¹é…0 æ¬¡æˆ–å¤šæ¬¡ï¼Œä»¥ <code>,</code> åˆ†éš”ã€‚</p><p>Rust æ”¯æŒä»¥ä¸‹å…¨éƒ¨é‡å¤æ¨¡å¼ï¼š</p><table><thead><tr class="header"><th>æ¨¡å¼</th><th>å«ä¹‰</th></tr></thead><tbody><tr class="odd"><td>$( â€¦ ) *</td><td>åŒ¹é… 0 æ¬¡æˆ–å¤šæ¬¡ï¼Œæ²¡æœ‰åˆ†éš”ç¬¦</td></tr><tr class="even"><td>$( â€¦ ), *</td><td>åŒ¹é… 0 æ¬¡æˆ–å¤šæ¬¡ï¼Œä»¥é€—å·åˆ†éš”</td></tr><tr class="odd"><td>$( â€¦ ); *</td><td>åŒ¹é… 0 æ¬¡æˆ–å¤šæ¬¡ï¼Œä»¥åˆ†å·åˆ†éš”</td></tr><tr class="even"><td>$( â€¦ ) +</td><td>åŒ¹é… 1 æ¬¡æˆ–å¤šæ¬¡ï¼Œæ²¡æœ‰åˆ†éš”ç¬¦</td></tr><tr class="odd"><td>$( â€¦ ), +</td><td>åŒ¹é… 1 æ¬¡æˆ–å¤šæ¬¡ï¼Œä»¥é€—å·åˆ†éš”</td></tr><tr class="even"><td>$( â€¦ ); +</td><td>åŒ¹é… 1 æ¬¡æˆ–å¤šæ¬¡ï¼Œä»¥åˆ†å·åˆ†éš”</td></tr><tr class="odd"><td>$( â€¦ ) ?</td><td>åŒ¹é… 0 æ¬¡æˆ– 1 æ¬¡ï¼Œæ²¡æœ‰åˆ†éš”ç¬¦</td></tr></tbody></table><p>å³ï¼š</p><ul><li><code>*</code> è¡¨ç¤º 0 æ¬¡æˆ–å¤šæ¬¡</li><li><code>+</code> è¡¨ç¤º 1 æ¬¡æˆ–å¤šæ¬¡</li><li><code>?</code> è¡¨ç¤º 0 æ¬¡æˆ– 1 æ¬¡</li><li>å¯åœ¨ä¸Šè¿° 3 è€…ä¹‹å‰åŠ å…¥åˆ†éš”ç¬¦</li></ul><h2 id="ç‰‡æ®µç±»å‹">ç‰‡æ®µç±»å‹</h2><p>åœ¨ <a href="#å®ç°-array">å®ç° Array</a>ä¸­ï¼Œæˆ‘ä»¬åŒ¹é…äº†è¿™æ ·ä¸€ä¸ªæ¨¡å¼ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust">([ $( $element:tt ), * ]) =&gt; &#123; <span class="hljs-comment">/* TODO */</span> &#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å°† <code>$element</code> æŒ‡å®šä¸º <code>tt</code>ï¼Œè¿™ä¸ª<code>tt</code> å°±æ˜¯å®ä¸­çš„ä¸€ç§ç‰‡æ®µç±»å‹ã€‚</p><p><code>tt</code> èƒ½åŒ¹é…å•ä¸ªè¯­æ³•æ ‡è®°æ ‘ï¼ŒåŒ…å«ï¼š</p><ul><li>ä¸€å¯¹æ‹¬å·ï¼Œå¦‚ <code>(..)</code>ã€<code>[..]</code>ã€æˆ–<code>&#123;..&#125;</code> ï¼Œä»¥åŠä½äºå…¶ä¸­çš„æ‰€æœ‰å†…å®¹ï¼ŒåŒ…æ‹¬åµŒå¥—çš„è¯­æ³•æ ‡è®°æ ‘ã€‚</li><li>å•ç‹¬çš„éæ‹¬å·è¯­æ³•æ ‡è®°ï¼Œæ¯”å¦‚ <code>1926</code> æˆ– <code>Knots</code>ã€‚</li></ul><p>æ‰€ä»¥ä¸ºäº†åŒ¹é…ä»»æ„ç±»å‹çš„ <code>Json</code> ï¼Œæˆ‘ä»¬é€‰æ‹©äº† <code>tt</code>ä½œä¸º <code>$element</code> çš„ç‰‡æ®µç±»å‹ã€‚</p><p><code>macro_rules!</code> æ”¯æŒçš„ç‰‡æ®µç±»å‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><table><thead><tr class="header"><th>ç‰‡æ®µç±»å‹</th><th>åŒ¹é…ï¼ˆå¸¦ä¾‹å­ï¼‰</th><th>åé¢å¯ä»¥è·Ÿ Â·Â·Â·Â·Â·Â·</th></tr></thead><tbody><tr class="odd"><td>expr</td><td>è¡¨è¾¾å¼ï¼š2 + 2, "udon", x.len()</td><td>=&gt;,;</td></tr><tr class="even"><td>stmt</td><td>è¡¨è¾¾å¼æˆ–å£°æ˜ï¼Œä¸åŒ…æ‹¬ä»»ä½•å°¾éšåˆ†å·ï¼ˆå¾ˆéš¾ç”¨ï¼Œè¯·å°è¯•ä½¿ç”¨ expr æˆ–blockï¼‰</td><td>=&gt;,;</td></tr><tr class="odd"><td>ty</td><td>ç±»å‹ï¼šString, Vec<u8>, (&amp;str, bool), dyn Read + Send</td><td>=&gt;,; =</td></tr><tr class="even"><td>path</td><td>è·¯å¾„ï¼šferns, ::std::sync::mpsc</td><td>=&gt;,; =</td></tr><tr class="odd"><td>pat</td><td>æ¨¡å¼ï¼š_, Some(ref x)</td><td>=&gt;,=</td></tr><tr class="even"><td>item</td><td>è¯­æ³•é¡¹ï¼šstruct Point { x: f64, y: f64 }, mod ferns;</td><td>ä»»æ„</td></tr><tr class="odd"><td>block</td><td>å—ï¼š{ s += "ok"; true }</td><td>ä»»æ„</td></tr><tr class="even"><td>meta</td><td>å±æ€§çš„ä¸»ä½“ï¼šinline, derive(Copy, Clone), doc="3D models."</td><td>ä»»æ„</td></tr><tr class="odd"><td>literal</td><td>å­—é¢é‡å€¼ï¼š1024, "Hello, world!", 1_000_000f64</td><td>ä»»æ„</td></tr><tr class="even"><td>lifetime</td><td>ç”Ÿå‘½å‘¨æœŸï¼š'a, 'item, 'static</td><td>ä»»æ„</td></tr><tr class="odd"><td>vis</td><td>å¯è§æ€§è¯´æ˜ç¬¦ï¼špub, pub(crate), pub(in module::submodule)</td><td>ä»»æ„</td></tr><tr class="even"><td>ident</td><td>æ ‡è¯†ç¬¦ï¼šstd, Json, longish_variable_name</td><td>ä»»æ„</td></tr><tr class="odd"><td>tt</td><td>è¯­æ³•æ ‡è®°æ ‘ï¼š;, &gt;=, {}, [0 1 (+ 0 1)]</td><td>ä»»æ„</td></tr></tbody></table><h2 id="å®Œæ•´ä»£ç ">å®Œæ•´ä»£ç </h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> std::collections::HashMap;<br><br><span class="hljs-meta">#[derive(Debug, Clone, PartialEq)]</span><br><span class="hljs-meta">#[allow(unused)]</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Json</span> &#123;<br>    Null,<br>    <span class="hljs-title function_ invoke__">Boolean</span>(<span class="hljs-type">bool</span>),<br>    <span class="hljs-title function_ invoke__">String</span>(<span class="hljs-type">String</span>),<br>    <span class="hljs-title function_ invoke__">Number</span>(<span class="hljs-type">f64</span>),<br>    <span class="hljs-title function_ invoke__">Array</span>(<span class="hljs-type">Vec</span>&lt;Json&gt;),<br>    <span class="hljs-title function_ invoke__">Object</span>(HashMap&lt;<span class="hljs-type">String</span>, Json&gt;),<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;<span class="hljs-type">bool</span>&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">Json</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(value: <span class="hljs-type">bool</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        Json::<span class="hljs-title function_ invoke__">Boolean</span>(value)<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;&amp;<span class="hljs-type">str</span>&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">Json</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(value: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        Json::<span class="hljs-title function_ invoke__">String</span>(value.<span class="hljs-title function_ invoke__">to_string</span>())<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;<span class="hljs-type">String</span>&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">Json</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(value: <span class="hljs-type">String</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        Json::<span class="hljs-title function_ invoke__">String</span>(value)<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">#[macro_export]</span><br><span class="hljs-built_in">macro_rules!</span> impl_from_for_primitives &#123;<br>    (  $( $<span class="hljs-keyword">type</span>: ty ) * ) =&gt; &#123;<br>        $(<br>            <span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;$<span class="hljs-keyword">type</span>&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">Json</span> &#123;<br>                <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(value: $<span class="hljs-keyword">type</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>                    Json::<span class="hljs-title function_ invoke__">Number</span>(value <span class="hljs-keyword">as</span> <span class="hljs-type">f64</span>)<br>                &#125;<br>            &#125;<br>        )*<br>    &#125;<br>&#125;<br><br>impl_from_for_primitives!(<span class="hljs-type">u8</span> <span class="hljs-type">u16</span> <span class="hljs-type">u32</span> <span class="hljs-type">u64</span> <span class="hljs-type">i8</span> <span class="hljs-type">i16</span> <span class="hljs-type">i32</span> <span class="hljs-type">i64</span> <span class="hljs-type">f32</span> <span class="hljs-type">f64</span> <span class="hljs-type">isize</span> <span class="hljs-type">usize</span>);<br><br><span class="hljs-meta">#[macro_export]</span><br><span class="hljs-built_in">macro_rules!</span> json &#123;<br>    (null) =&gt; &#123;<br>        Json::Null<br>    &#125;;<br>    ([ $( $element: tt),* ]) =&gt; &#123;<br>        Json::<span class="hljs-title function_ invoke__">Array</span>(<span class="hljs-built_in">vec!</span>[ $( json!($element)), * ])<br>    &#125;;<br>    (&#123; $( $key:tt : $value:tt ),* &#125;) =&gt; &#123;<br>        Json::<span class="hljs-title function_ invoke__">Object</span>(HashMap::<span class="hljs-title function_ invoke__">from</span>([<br>            $(<br>                ( $key.<span class="hljs-title function_ invoke__">to_string</span>(), json!($value) )<br>            ), *<br>        ]))<br>    &#125;;<br>    ($value: tt) =&gt; &#123;<br>        Json::<span class="hljs-title function_ invoke__">from</span>($value)<br>    &#125;;<br>&#125;<br><br><span class="hljs-meta">#[cfg(test)]</span><br><span class="hljs-keyword">mod</span> tests &#123;<br>    <span class="hljs-keyword">use</span> super::*;<br><br>    <span class="hljs-meta">#[test]</span><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">test_null_json</span>() &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">json</span> = json!(null);<br>        <span class="hljs-built_in">assert_eq!</span>(json, Json::Null);<br>    &#125;<br><br>    <span class="hljs-meta">#[test]</span><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">test_boolean_number_string_json</span>() &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">json</span> = json!(<span class="hljs-literal">true</span>);<br>        <span class="hljs-built_in">assert_eq!</span>(json, Json::<span class="hljs-title function_ invoke__">Boolean</span>(<span class="hljs-literal">true</span>));<br><br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">json</span> = json!(<span class="hljs-number">1.0</span>);<br>        <span class="hljs-built_in">assert_eq!</span>(json, Json::<span class="hljs-title function_ invoke__">Number</span>(<span class="hljs-number">1.0</span>));<br><br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">json</span> = json!(<span class="hljs-string">&quot;hello&quot;</span>);<br>        <span class="hljs-built_in">assert_eq!</span>(json, Json::<span class="hljs-title function_ invoke__">String</span>(<span class="hljs-string">&quot;hello&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>()));<br>    &#125;<br><br>    <span class="hljs-meta">#[test]</span><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">test_object_json</span>() &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">json</span> = json!(&#123;<br>            <span class="hljs-string">&quot;null&quot;</span>: null,<br>            <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;hedon&quot;</span>,<br>            <span class="hljs-string">&quot;age&quot;</span>: <span class="hljs-number">10</span>,<br>            <span class="hljs-string">&quot;is_student&quot;</span>: <span class="hljs-literal">true</span>,<br>            <span class="hljs-string">&quot;detail&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;address&quot;</span>: <span class="hljs-string">&quot;beijing&quot;</span>,<br>                <span class="hljs-string">&quot;phone&quot;</span>: <span class="hljs-string">&quot;1234567890&quot;</span><br>            &#125;<br>        &#125;);<br>        <span class="hljs-built_in">assert_eq!</span>(<br>            json,<br>            Json::<span class="hljs-title function_ invoke__">Object</span>(HashMap::<span class="hljs-title function_ invoke__">from</span>([<br>                (<span class="hljs-string">&quot;null&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), Json::Null),<br>                (<span class="hljs-string">&quot;name&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), Json::<span class="hljs-title function_ invoke__">String</span>(<span class="hljs-string">&quot;hedon&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>())),<br>                (<span class="hljs-string">&quot;age&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), Json::<span class="hljs-title function_ invoke__">Number</span>(<span class="hljs-number">10.0</span>)),<br>                (<span class="hljs-string">&quot;is_student&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), Json::<span class="hljs-title function_ invoke__">Boolean</span>(<span class="hljs-literal">true</span>)),<br>                (<br>                    <span class="hljs-string">&quot;detail&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(),<br>                    Json::<span class="hljs-title function_ invoke__">Object</span>(HashMap::<span class="hljs-title function_ invoke__">from</span>([<br>                        (<span class="hljs-string">&quot;address&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), Json::<span class="hljs-title function_ invoke__">String</span>(<span class="hljs-string">&quot;beijing&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>())),<br>                        (<span class="hljs-string">&quot;phone&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), Json::<span class="hljs-title function_ invoke__">String</span>(<span class="hljs-string">&quot;1234567890&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>()))<br>                    ]))<br>                )<br>            ]))<br>        )<br>    &#125;<br><br>    <span class="hljs-meta">#[test]</span><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">test_array_json</span>() &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">json</span> = json!([<span class="hljs-number">1</span>, null, <span class="hljs-string">&quot;string&quot;</span>, <span class="hljs-literal">true</span>]);<br>        <span class="hljs-built_in">assert_eq!</span>(<br>            json,<br>            Json::<span class="hljs-title function_ invoke__">Array</span>(<span class="hljs-built_in">vec!</span>[<br>                Json::<span class="hljs-title function_ invoke__">Number</span>(<span class="hljs-number">1.0</span>),<br>                Json::Null,<br>                Json::<span class="hljs-title function_ invoke__">String</span>(<span class="hljs-string">&quot;string&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>()),<br>                Json::<span class="hljs-title function_ invoke__">Boolean</span>(<span class="hljs-literal">true</span>)<br>            ])<br>        )<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">æœ¬æ–‡åˆ†æ­¥å±•ç¤ºäº†å®ç° json! å®çš„è¿‡ç¨‹ï¼ŒåŒ…æ‹¬å®šä¹‰ Json æšä¸¾å’Œä¸åŒç±»å‹çš„åŒ¹é…è§„åˆ™ã€‚é€šè¿‡è¿™ä¸ªè¿‡ç¨‹ï¼Œè¯»è€…å¯ä»¥æŒæ¡å£°æ˜å®çš„åŸºæœ¬æ¦‚å¿µå’Œå®ç°æ–¹æ³•ã€‚</summary>
    
    
    
    <category term="Rust" scheme="https://hedon.top/categories/Rust/"/>
    
    <category term="Rust å®æˆ˜" scheme="https://hedon.top/categories/Rust/Rust-%E5%AE%9E%E6%88%98/"/>
    
    
    <category term="Rust" scheme="https://hedon.top/tags/Rust/"/>
    
    <category term="å®" scheme="https://hedon.top/tags/%E5%AE%8F/"/>
    
    <category term="å…ƒç¼–ç¨‹" scheme="https://hedon.top/tags/%E5%85%83%E7%BC%96%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>xgo åŸç†æ¢ç´¢</title>
    <link href="https://hedon.top/2024/05/23/go-xgo-explore/"/>
    <id>https://hedon.top/2024/05/23/go-xgo-explore/</id>
    <published>2024-05-23T13:15:10.000Z</published>
    <updated>2024-05-28T15:13:08.693Z</updated>
    
    <content type="html"><![CDATA[<h1 id="go-å•æµ‹-mock-æ–¹æ¡ˆ">Go å•æµ‹ mock æ–¹æ¡ˆ</h1><table><thead><tr class="header"><th>Mock æ–¹æ³•</th><th>åŸç†</th><th>ä¾èµ–</th><th>ä¼˜ç‚¹</th><th>ç¼ºç‚¹</th></tr></thead><tbody><tr class="odd"><td>æ¥å£ Mock</td><td>ä¸ºä¾èµ–é¡¹å®šä¹‰æ¥å£ï¼Œå¹¶æä¾›æ¥å£çš„ Mock å®ç°ã€‚</td><td>éœ€è¦å®šä¹‰æ¥å£å’Œ Mock å®ç°ã€‚</td><td>çµæ´»ï¼Œéµå¾ª Go çš„ç±»å‹ç³»ç»Ÿï¼›æ˜“äºæ›¿æ¢å®ç°ã€‚</td><td>éœ€è¦æ›´å¤šçš„æ ·æ¿ä»£ç æ¥å®šä¹‰æ¥å£å’Œ Mock å®ç°ã€‚</td></tr><tr class="even"><td>Monkey Patchingï¼ˆbouk/monekyï¼‰</td><td>ç›´æ¥ä¿®æ”¹å‡½æ•°æŒ‡é’ˆçš„å†…å­˜åœ°å€æ¥å®ç°å¯¹å‡½æ•°çš„æ›¿æ¢ã€‚</td><td>å†…å­˜ä¿æŠ¤ï¼›æ±‡ç¼–ä»£ç ã€‚</td><td>å¼ºå¤§ï¼Œå¯ä»¥ Mock ä»»ä½•å‡½æ•°ï¼Œç”šè‡³ç¬¬ä¸‰æ–¹åº“çš„å‡½æ•°ã€‚</td><td>å¤æ‚ï¼Œå®¹æ˜“å‡ºé”™ï¼›çº¿ç¨‹ä¸å®‰å…¨ï¼›ä¾èµ–ç³»ç»ŸæŒ‡ä»¤é›†ã€‚</td></tr></tbody></table><h1 id="boukmonkey-å¼Šç«¯">bouk/monkey å¼Šç«¯</h1><blockquote><p><a href="https://github.com/bouk/monkey">bouk/monkey</a> ğŸ’</p></blockquote><p>monkey çš„æ ¸å¿ƒåŠŸèƒ½æ˜¯èƒ½å¤Ÿåœ¨è¿è¡Œæ—¶æ›¿æ¢æŸä¸ªå‡½æ•°çš„å®ç°ã€‚</p><p><strong>åŸç†ï¼š</strong></p><ol type="1"><li><strong>å‡½æ•°æŒ‡é’ˆæ›¿æ¢</strong>ï¼šåœ¨ Goè¯­è¨€ä¸­ï¼Œå‡½æ•°çš„åœ°å€å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚bouk/monkeyé€šè¿‡ç›´æ¥ä¿®æ”¹å‡½æ•°æŒ‡é’ˆçš„å†…å­˜åœ°å€æ¥å®ç°å¯¹å‡½æ•°çš„æ›¿æ¢ã€‚</li><li><strong>æ±‡ç¼–ä»£ç </strong>ï¼šä½¿ç”¨äº†æ±‡ç¼–ä»£ç æ¥å®ç°å¯¹å‡½æ•°å…¥å£çš„è·³è½¬ã€‚è¿™äº›æ±‡ç¼–ä»£ç ä¼šåœ¨å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œå°†æ‰§è¡Œæµé‡å®šå‘åˆ°æ–°çš„å‡½æ•°å®ç°ã€‚</li><li><strong>å†…å­˜ä¿æŠ¤</strong>ï¼šä¸ºäº†ä¿®æ”¹å†…å­˜ä¸­çš„å‡½æ•°æŒ‡é’ˆï¼Œbouk/monkeyéœ€è¦ä¸´æ—¶ä¿®æ”¹å†…å­˜é¡µé¢çš„ä¿æŠ¤å±æ€§ï¼ˆä¾‹å¦‚ï¼Œå°†é¡µé¢è®¾ä¸ºå¯å†™ï¼‰ã€‚åœ¨ä¿®æ”¹å®Œæ¯•åï¼Œå®ƒä¼šæ¢å¤åŸæ¥çš„ä¿æŠ¤å±æ€§ã€‚</li><li><strong>åå°„ä¸ unsafe åŒ…</strong>ï¼šåˆ©ç”¨ Go çš„åå°„æœºåˆ¶å’Œ unsafeåŒ…ï¼Œbouk/monkey å¯ä»¥è·å–å¹¶æ“ä½œå‡½æ•°çš„åº•å±‚å®ç°ç»†èŠ‚ã€‚</li></ol><p><strong>å®ç°æ­¥éª¤ï¼š</strong></p><ol type="1"><li><strong>ä¿å­˜åŸå‡½æ•°</strong>ï¼šåœ¨æ›¿æ¢å‡½æ•°ä¹‹å‰ï¼Œbouk/monkeyä¼šä¿å­˜åŸå§‹å‡½æ•°çš„æŒ‡é’ˆï¼Œä»¥ä¾¿åœ¨éœ€è¦æ—¶æ¢å¤æˆ–è°ƒç”¨åŸå§‹å‡½æ•°ã€‚</li><li><strong>ç”Ÿæˆè·³è½¬ä»£ç </strong>ï¼šbouk/monkeyç”Ÿæˆä¸€æ®µæ±‡ç¼–è·³è½¬ä»£ç ï¼Œè¿™æ®µä»£ç ä¼šåœ¨å‡½æ•°è°ƒç”¨æ—¶ï¼Œå°†æ‰§è¡Œæµè·³è½¬åˆ°æ–°çš„å‡½æ•°å®ç°ã€‚</li><li><strong>ä¿®æ”¹å‡½æ•°æŒ‡é’ˆ</strong>ï¼šä½¿ç”¨ unsafe åŒ…ï¼Œbouk/monkeyä¿®æ”¹ç›®æ ‡å‡½æ•°çš„å…¥å£åœ°å€ï¼ŒæŒ‡å‘ç”Ÿæˆçš„è·³è½¬ä»£ç ã€‚</li><li><strong>æ¢å¤å†…å­˜ä¿æŠ¤</strong>ï¼šåœ¨å®Œæˆä¸Šè¿°ä¿®æ”¹åï¼Œæ¢å¤å†…å­˜é¡µé¢çš„ä¿æŠ¤å±æ€§ã€‚</li></ol><p><strong>æœ‰ä»¥ä¸‹å‡ ä¸ªå¼Šç«¯ï¼š</strong></p><ol type="1"><li>å¦‚æœå¯ç”¨äº†å†…è”ï¼ŒMonkeyæœ‰æ—¶æ— æ³•ä¿®è¡¥å‡½æ•°ã€‚å°è¯•åœ¨ç¦ç”¨å†…è”çš„æƒ…å†µä¸‹è¿è¡Œæµ‹è¯•ï¼Œä¾‹å¦‚:<code>go test -gcflags=-l</code>ã€‚åŒæ ·çš„å‘½ä»¤è¡Œå‚æ•°ä¹Ÿå¯ä»¥ç”¨äºæ„å»ºã€‚</li><li>Monkeyä¸èƒ½åœ¨ä¸€äº›é¢å‘å®‰å…¨çš„æ“ä½œç³»ç»Ÿä¸Šå·¥ä½œï¼Œè¿™äº›æ“ä½œç³»ç»Ÿä¸å…è®¸åŒæ—¶å†™å…¥å’Œæ‰§è¡Œå†…å­˜é¡µã€‚ç›®å‰çš„æ–¹æ³•å¹¶æ²¡æœ‰çœŸæ­£å¯é çš„è§£å†³æ–¹æ¡ˆã€‚</li><li>çº¿ç¨‹ä¸å®‰å…¨çš„ã€‚</li><li>ä¾èµ–æŒ‡ä»¤é›†ã€‚</li></ol><h1 id="å…ˆçœ‹-xgo-æ€ä¹ˆç”¨">å…ˆçœ‹ xgo æ€ä¹ˆç”¨</h1><blockquote><p><a href="https://github.com/xhd2015/xgo">xgo</a> ğŸ˜ˆ</p></blockquote><p>ä»£ç ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">.<br>â”œâ”€â”€ greet.<span class="hljs-keyword">go</span><br>â””â”€â”€ greet_test.<span class="hljs-keyword">go</span><br></code></pre></td></tr></table></figure><p>ç°åœ¨åœ¨ <code>greet.go</code> ä¸­æœ‰ä¸€ä¸ªå‡½æ•° <code>greet</code>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">greet</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello &quot;</span> + s<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨çœŸå®çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œ<code>greet</code>å¯èƒ½è¦å¤æ‚å¾—å¤šï¼Œå®ƒå¯èƒ½ä¼šä¾èµ–å„ç§ç¬¬ä¸‰æ–¹APIï¼Œä¹Ÿå¯èƒ½ä¼šä¾èµ–æ•°æ®åº“ç­‰å¤šç§å¤–éƒ¨ç»„ä»¶ã€‚æ‰€ä»¥åœ¨æµ‹è¯•çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¸Œæœ›å¯¹å…¶è¿›è¡Œ<strong>mock</strong>ï¼Œä½¿å…¶è¿”å›ä¸€ä¸ªå›ºå®šçš„å€¼ï¼Œä¾¿äºæˆ‘ä»¬æ’°å†™å•å…ƒæµ‹è¯•ã€‚</p><p><code>xgo</code> å‚è€ƒäº† <code>go-monkey</code> çš„æ€æƒ³ï¼Œä½†æ˜¯ä¸ä»<strong>ä¿®æ”¹æŒ‡ä»¤</strong> è¿™ä¸ªé€”å¾„å…¥æ‰‹ï¼Œè€Œæ˜¯å¦è¾Ÿè¹Šå¾„ï¼Œä»<strong>ä»£ç é‡å†™</strong> çš„è§’åº¦å®ç°äº† <strong>mock</strong>çš„èƒ½åŠ›ã€‚</p><p>ä¸ºäº†ä½¿ç”¨ <code>xgo</code>ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå®‰è£… <code>xgo</code>è¿™ä¸ªå‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go install github.com/xhd2015/xgo/cmd/xgo@latest<br></code></pre></td></tr></table></figure><p>åŒæ—¶åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­éœ€è¦å¼•å…¥ <code>xgo</code> ä¾èµ–ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go get <span class="hljs-string">&quot;github.com/xhd2015/xgo/runtime/mock&quot;</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ç¼–å†™çš„ <code>greet_test.go</code> å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> xgo_use<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;testing&quot;</span><br><br><span class="hljs-string">&quot;github.com/xhd2015/xgo/runtime/mock&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestOriginGreet</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>res := greet(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;hello world&quot;</span> &#123;<br>t.Fatalf(<span class="hljs-string">&quot;greet() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;hello world&quot;</span>)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestMockGreet</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>mock.Patch(greet, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock &quot;</span> + s<br>&#125;)<br>res := greet(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;mock world&quot;</span> &#123;<br>t.Fatalf(<span class="hljs-string">&quot;greet() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;mock world&quot;</span>)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨ <code>TestMockGreet</code> è¿™ä¸ªå•å…ƒæµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬å°†<code>greet</code> è¿›è¡Œäº† mockï¼Œè¿”å› <code>"mock " + s</code>ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">mock.Patch(greet, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock &quot;</span> + s<br>&#125;)<br></code></pre></td></tr></table></figure><p>ä¸ºäº†ä½¿ç”¨ <code>xgo</code>çš„èƒ½åŠ›ï¼Œæˆ‘ä»¬åœ¨æ‰§è¡Œå•å…ƒæµ‹è¯•çš„æ—¶å€™ï¼Œéœ€è¦è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">xgo <span class="hljs-built_in">test</span> -v ./<br></code></pre></td></tr></table></figure><p>è¾“å‡ºå¤§è‡´å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  xgo-use git:(master) xgo <span class="hljs-built_in">test</span> -v ./<br>xgo is taking a <span class="hljs-keyword">while</span> to setup, please <span class="hljs-built_in">wait</span>...<br>=== RUN   TestOriginGreet<br>--- PASS: TestOriginGreet (0.00s)<br>=== RUN   TestMockGreet<br>--- PASS: TestMockGreet (0.00s)<br>PASS<br>ok      xgo-explore/xgo-use     (cached)<br></code></pre></td></tr></table></figure><h1 id="xgo-çš„æ ¸å¿ƒåŸç†">xgo çš„æ ¸å¿ƒåŸç†</h1><p><code>xgo</code> çš„æ ¸å¿ƒåŸç†æ˜¯åˆ©ç”¨ <code>go build -toolexec</code>çš„èƒ½åŠ›ã€‚</p><p>è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go <span class="hljs-built_in">help</span> build<br></code></pre></td></tr></table></figure><p>æ‰¾åˆ° <code>toolexec</code> çš„ç›¸å…³è¯´æ˜ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">-toolexec <span class="hljs-string">&#x27;cmd args&#x27;</span><br>        a program to use to invoke toolchain programs like vet and asm.<br>        For example, instead of running asm, the go <span class="hljs-built_in">command</span> will run<br>        <span class="hljs-string">&#x27;cmd args /path/to/asm &lt;arguments for asm&gt;&#x27;</span>.<br>        The TOOLEXEC_IMPORTPATH environment variable will be <span class="hljs-built_in">set</span>,<br>        matching <span class="hljs-string">&#x27;go list -f &#123;&#123;.ImportPath&#125;&#125;&#x27;</span> <span class="hljs-keyword">for</span> the package being built.<br></code></pre></td></tr></table></figure><p>ä¸€è¨€ä»¥è”½ä¹‹ï¼š<code>-toolexec</code> å…è®¸å¯¹ go å·¥å…·é“¾è¿›è¡Œæ‹¦æˆªï¼ŒåŒ…æ‹¬<code>vet</code>ã€<code>asm</code>ã€<code>compile</code> å’Œ<code>link</code>ã€‚</p><p>è¿™ç§æŠ€æœ¯ä¹Ÿè¢«ç§°ä¸ºï¼šæ’æ¡©ï¼ˆstubbingï¼‰ã€å¢å¼ºï¼ˆinstrumentationï¼‰å’Œä»£ç é‡å†™ï¼ˆrewritingï¼‰ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/Km9eLWtYFJMiFYP0uC-B29J__5mGvLlSsrD52hWgS_S2nOGSx9PnMybHuqcQljAtTUr5QVVqaHGyyAEwqVPowhPqJvAZHLALdQpj6gzHzb60NLLe91tX87_sAerIGq2mwYMVdBcptglQpJ0QkfmDC-ZHoQ=s2048.png"alt="-toolexec ç¤ºæ„å›¾ï¼ˆæ¥æºï¼šhttps://blog.xhd2015.xyz/zh/posts/xgo-monkey-patching-in-go-using-toolexec/ï¼‰" /><figcaption aria-hidden="true">-toolexecç¤ºæ„å›¾ï¼ˆæ¥æºï¼šhttps://blog.xhd2015.xyz/zh/posts/xgo-monkey-patching-in-go-using-toolexec/ï¼‰</figcaption></figure><p>åŸºäºä¸Šè¿°åˆ†æï¼Œ<code>xgo</code> æå‡ºäº† <strong>ä»£ç é‡å†™</strong>çš„æ€è·¯ï¼Œå®ç°äº† <strong>åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­æ’å…¥æ‹¦æˆªå™¨ä»£ç </strong> çš„åŠŸèƒ½ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240523164815047.png"alt="xgo åœ¨ go build ä¸­çš„ä½œç”¨ä½ç½®ï¼ˆæ¥æºï¼šhttps://blog.xhd2015.xyz/zh/posts/xgo-monkey-patching-in-go-using-toolexec/ï¼‰" /><figcaption aria-hidden="true">xgo åœ¨ go buildä¸­çš„ä½œç”¨ä½ç½®ï¼ˆæ¥æºï¼šhttps://blog.xhd2015.xyz/zh/posts/xgo-monkey-patching-in-go-using-toolexec/ï¼‰</figcaption></figure><p>æ‰€ä»¥ä¸Šè¿°æˆ‘ä»¬çš„ <code>greet.go</code> æ–‡ä»¶ä¸­çš„æºä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">greet</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello &quot;</span> + s<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»è¿‡ <code>xgo</code> ç¼–è¯‘åæœ€ç»ˆå®é™…ç¼–è¯‘çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;runtime&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">greet</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> (r0 <span class="hljs-type">string</span>) &#123;<br>  stop, post := runtime.__xgo_trap(Greet, &amp;s, &amp;r0)<br>  <span class="hljs-keyword">if</span> stop &#123;<br>    <span class="hljs-keyword">return</span><br>  &#125;<br>  <span class="hljs-keyword">defer</span> post()<br>  <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello&quot;</span> + s<br>&#125;<br></code></pre></td></tr></table></figure><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/5e020865-fd1d-49d3-be72-7ee2233a3c5f.png"alt="greet å‡½æ•°é‡å†™å˜åŒ–ç¤ºæ„å›¾ï¼ˆæ¥æºï¼šhttps://blog.xhd2015.xyz/zh/posts/xgo-monkey-patching-in-go-using-toolexec/ï¼‰" /><figcaption aria-hidden="true">greetå‡½æ•°é‡å†™å˜åŒ–ç¤ºæ„å›¾ï¼ˆæ¥æºï¼šhttps://blog.xhd2015.xyz/zh/posts/xgo-monkey-patching-in-go-using-toolexec/ï¼‰</figcaption></figure><p>å¦‚å›¾æ‰€ç¤ºï¼Œä¸€æ—¦å‡½æ•°è¢«è°ƒç”¨ï¼Œå®ƒçš„æ§åˆ¶æµé¦–å…ˆè½¬ç§»åˆ°<code>Trap</code>ï¼Œç„¶åä¸€ç³»åˆ—æ‹¦æˆªå™¨å°†æ ¹æ®å…¶ç›®çš„æ£€æŸ¥å½“å‰è°ƒç”¨æ˜¯å¦åº”è¯¥è¢«Mockã€ä¿®æ”¹ã€è®°å½•æˆ–åœæ­¢ã€‚</p><p>å¦‚æœ <code>greet</code> æ³¨å†Œäº† mock å‡½æ•°ï¼Œé‚£ä¹ˆå°±ä¼šåœ¨<code>__xgo_trap</code> ä¸­è°ƒç”¨ mock çš„å‡½æ•°ï¼Œå¹¶å°†è¿”å›å€¼è®¾ç½®åˆ°<code>r0</code> ä¸Šè¿›è¡Œè¿”å›ï¼Œè€Œè·³è¿‡åŸå§‹çš„æ‰§è¡Œé€»è¾‘ã€‚</p><h1 id="ç¬¬-1-æ­¥æ­»ä»£ç å®ç°">ç¬¬ 1 æ­¥ï¼šæ­»ä»£ç å®ç°</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  01-deadcode git:(master) tree<br>.<br>â”œâ”€â”€ greet.go<br>â”œâ”€â”€ greet_test.go<br>â””â”€â”€ mock.go<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆä»æœ€ç®€å•çš„å®ç°å¼€å§‹ï¼Œé‡‡ç”¨ä¾µå…¥æ€§ä»£ç å®ç° <code>xgo</code>çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œè¿™é‡Œæˆ‘ä»¬è¿˜ç”¨ä¸åˆ° <code>-toolexec</code>ã€‚</p><p>ä»£ç ç»“æ„å¦‚ä¸Šæ‰€ç¤ºï¼Œåœ¨ <code>mock.go</code> ä¸­ï¼Œæˆ‘ä»¬æœ‰å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> mockFuncs = sync.Map&#123;&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">RegisterMockFunc</span><span class="hljs-params">(funcName <span class="hljs-type">string</span>, fun <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br>mockFuncs.Store(funcName, fun)<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>mockFuncs</code>: ç”¨äºæ‰¿è½½å‡½æ•°ä¸ mock å‡½æ•°çš„å¯¹åº”å…³ç³»ï¼Œå…¶ä¸­ keyä¸ºå‡½æ•°åç§°ï¼Œvalue ä¸º mock å‡½æ•°ã€‚æˆ‘ä»¬ä½¿ç”¨ <code>sync.Map</code>æ¥ä¿è¯å¹¶å‘å®‰å…¨ã€‚</li><li><code>RegisterMockFunc</code> ç”¨äºä¸ºæŒ‡å®šçš„ funcName æ³¨å†Œ mockå‡½æ•°ã€‚</li></ul><p>åœ¨ <code>greet.go</code> ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ª <code>Greet</code> å‡½æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Greet</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello &quot;</span> + s<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬è¦å¯¹å…¶æ”¯æŒ mockï¼Œé‚£ä¹ˆéœ€è¦ä¿®æ”¹å…¶å®ç°ä¸ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Greet</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>fun, ok := mockFuncs.Load(<span class="hljs-string">&quot;Greet&quot;</span>)<br><span class="hljs-keyword">if</span> ok &#123;<br>f, ok := fun.(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span>)<br><span class="hljs-keyword">if</span> ok &#123;<br><span class="hljs-keyword">return</span> f(s)<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello &quot;</span> + s<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ä¿®æ”¹åçš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å…ˆåˆ¤æ–­æ˜¯å¦å­˜åœ¨ mock å‡½æ•°ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™æ‰§è¡Œ mockå‡½æ•°ï¼Œå¦åˆ™æ‰§è¡ŒåŸå§‹é€»è¾‘ã€‚</p><p>ç°åœ¨æˆ‘ä»¬åœ¨ <code>greet_test.go</code> ä¸­ç¼–å†™æµ‹è¯•ä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestMockGreet</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>RegisterMockFunc(<span class="hljs-string">&quot;Greet&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock &quot;</span> + s<br>&#125;)<br>res := Greet(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;mock world&quot;</span> &#123;<br>t.Fatalf(<span class="hljs-string">&quot;Greet() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;mock world&quot;</span>)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestOriginGreet</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>res := Greet(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;hello world&quot;</span> &#123;<br>t.Fatalf(<span class="hljs-string">&quot;Greet() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;hello world&quot;</span>)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œæµ‹è¯•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å•ç‹¬æ‰§è¡Œ TestMockGreet</span><br>âœ  01-deadcode git:(master) âœ— go <span class="hljs-built_in">test</span> -v -run TestMockGreet<br>=== RUN   TestMockGreet<br>--- PASS: TestMockGreet (0.00s)<br>PASS<br>ok      xgo-explore/01-deadcode 0.103s<br><br><span class="hljs-comment"># å•ç‹¬æ‰§è¡Œ TestOriginGreet</span><br>âœ  01-deadcode git:(master) âœ— go <span class="hljs-built_in">test</span> -v -run TestOriginGreet<br>=== RUN   TestOriginGreet<br>--- PASS: TestOriginGreet (0.00s)<br>PASS<br>ok      xgo-explore/01-deadcode 0.102s<br><br><span class="hljs-comment"># ä¸€èµ·æ‰§è¡Œ</span><br>âœ  01-deadcode git:(master) âœ— go <span class="hljs-built_in">test</span> -v -run $Test$<br>=== RUN   TestMockGreet<br>--- PASS: TestMockGreet (0.00s)<br>=== RUN   TestOriginGreet<br>    greet_test.go:20: Greet() = <span class="hljs-string">&quot;mock world&quot;</span>; want <span class="hljs-string">&quot;hello world&quot;</span><br>--- FAIL: TestOriginGreet (0.00s)<br>FAIL<br><span class="hljs-built_in">exit</span> status 1<br>FAIL    xgo-explore/01-deadcode 0.102s<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¼šå‘ç°å•ç‹¬æ‰§è¡Œéƒ½æ˜¯ ok çš„ï¼Œä¸è¿‡ä¸€èµ·æ‰§è¡Œçš„è¯<code>TestOriginGreet</code> å°±å¤±è´¥äº†ï¼Œè¿™æ˜¯å› ä¸ºå…ˆæ‰§è¡Œäº†<code>TestMockGreet</code>ï¼Œè¿™ä¸ªæ—¶å€™å·²ç»å¾€ <code>mockFunc</code>ä¸­æ³¨å†Œäº† mock å‡½æ•°äº†ï¼Œæ‰€ä»¥ <code>TessOriginGreet</code>å°±æ‰§è¡Œå¤±è´¥äº†ã€‚</p><p>è¿™é‡Œéœ€è¦åœ¨åç¨‹å±‚é¢ä¸Šåš mock éš”ç¦»ï¼Œ<code>xgo</code>çš„æ€è·¯æ˜¯åœ¨ç¼–è¯‘æ—¶æ³¨å…¥ <code>getg()</code>å‡½æ•°æ¥è·å–å½“å‰åç¨‹ä¿¡æ¯ä»è€Œå®ç°åœ¨æ³¨å†Œ mockå‡½æ•°æ—¶è¿›è¡Œåç¨‹éš”ç¦»ã€‚æœ¬æ–‡å°†èšç„¦åœ¨ <code>xgo</code> çš„æ ¸å¿ƒåŸç†<strong>ä»£ç é‡å†™</strong> ä¸Šï¼Œæ•…æš‚æ—¶ä¸è€ƒè™‘è¿™ä¸€å—ã€‚</p><p>Okï¼Œé‚£ä¹ˆçŸ­çŸ­å‡ è¡Œä»£ç ï¼Œæˆ‘ä»¬å°±å°† <code>xgo</code>çš„æœ€æ ¸å¿ƒæ€æƒ³ç»™å±•ç¤ºå‡ºæ¥äº†ã€‚å¯ä»¥çœ‹åˆ°ï¼Œ<code>xgo</code>çš„æ ¸å¿ƒæ€æƒ³æ˜¯å¾€æºä»£ç ä¸­åŠ å…¥ <strong>åˆæ³•çš„ Goä»£ç </strong>ï¼Œæ‰€ä»¥ä¸æ¶‰åŠæŒ‡ä»¤é‡å†™ï¼Œæ•…è€Œåªè¦ä½ çš„æœºå™¨èƒ½æ‰§è¡Œ Goç¨‹åºï¼Œå¤©ç„¶å°±æ”¯æŒ mockåŠŸèƒ½ï¼Œè¿™å°±å¤©ç„¶è¾¾åˆ°äº†æ¶æ„æ— å…³çš„å…¼å®¹æ€§äº†ã€‚åŒæ—¶æˆ‘ä»¬ä¹Ÿä½¿ç”¨äº†<code>sync.Map</code> æ¥ä¿è¯äº†å¹¶å‘å®‰å…¨ã€‚</p><h1 id="ç¬¬-2-æ­¥æ­»ä»£ç æ‹¦æˆªå™¨">ç¬¬ 2 æ­¥ï¼šæ­»ä»£ç æ‹¦æˆªå™¨</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  02-deadcode-interceptor git:(master) tree<br>.<br>â”œâ”€â”€ greet.go<br>â”œâ”€â”€ greet_test.go<br>â””â”€â”€ mock.go<br></code></pre></td></tr></table></figure><p>åœ¨ç¬¬ 1 æ­¥ä¸­ï¼Œè¿™æ®µä»£ç æˆ‘è§‰å¾—æœ‰ç‚¹å†—é•¿äº†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">fun, ok := mockFuncs.Load(<span class="hljs-string">&quot;Greet&quot;</span>)<br><span class="hljs-keyword">if</span> ok &#123;<br>  f, ok := fun.(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span>)<br>  <span class="hljs-keyword">if</span> ok &#123;<br>    <span class="hljs-keyword">return</span> f(s)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å‚è€ƒ <code>xgo</code> çš„å‡½æ•°ç­¾åï¼Œæˆ‘ä»¬å¯¹å…¶è¿›è¡Œä¼˜åŒ–ï¼Œåœ¨<code>mock.go</code> ä¸­åŠ å…¥ä¸€ä¸ª <strong>ä¸ç‰ˆæ‹¦æˆªå™¨</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// mock.go</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InterceptMock</span><span class="hljs-params">(funcName <span class="hljs-type">string</span>, arg <span class="hljs-type">string</span>, result *<span class="hljs-type">string</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>fn, ok := mockFuncs.Load(funcName)<br><span class="hljs-keyword">if</span> ok &#123;<br>f, ok := fn.(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span>)<br><span class="hljs-keyword">if</span> ok &#123;<br>*result = f(arg)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹åº” <code>greet.go</code> ä¸­ <code>Greet</code> å‡½æ•°å°±ä¿®æ”¹ä¸ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Greet</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> (res <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">if</span> InterceptMock(<span class="hljs-string">&quot;Greet&quot;</span>, s, &amp;res) &#123;<br><span class="hljs-keyword">return</span> res<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello &quot;</span> + s<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™çœ‹èµ·æ¥å°±æ¸…çˆ½å¤šäº†ã€‚å†æ¬¡æ‰§è¡Œæµ‹è¯•ä»£ç ï¼Œä¸€æ ·æ˜¯å¯ä»¥é€šè¿‡çš„ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  02-deadcode-interceptor git:(master) go <span class="hljs-built_in">test</span> -v -run TestOriginGreet<br>=== RUN   TestOriginGreet<br>--- PASS: TestOriginGreet (0.00s)<br>PASS<br>ok      xgo-explore/02-deadcode-interceptor     0.331s<br><br>âœ  02-deadcode-interceptor git:(master) go <span class="hljs-built_in">test</span> -v -run TestMockGreet<br>=== RUN   TestMockGreet<br>--- PASS: TestMockGreet (0.00s)<br>PASS<br>ok      xgo-explore/02-deadcode-interceptor     0.103s<br></code></pre></td></tr></table></figure><h1 id="ç¬¬-3-æ­¥toolexec-åˆæ¢">ç¬¬ 3 æ­¥ï¼štoolexec åˆæ¢</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  03-toolexec-static git:(master) tree<br>.<br>â”œâ”€â”€ cmd<br>â”‚Â Â  â””â”€â”€ mytool<br>â”‚Â Â      â””â”€â”€ mytool.go<br>â”œâ”€â”€ greet.go<br>â”œâ”€â”€ main.go<br>â”œâ”€â”€ mock.go<br>â””â”€â”€ script.sh<br></code></pre></td></tr></table></figure><p>è¿™é‡Œ <code>mock.go</code> æ²¡æœ‰ä»»ä½•å˜åŒ–ã€‚æˆ‘ä»¬æœŸæœ›ä½¿ç”¨<code>-toolexec</code> æ¥ä¿®æ”¹æºä»£ç ï¼Œä»¥å®ç° mockæ— æºä»£ç ä¾µå…¥çš„ç‰¹æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ <code>greet.to</code> ä¸­å°†<code>Greet</code> å‡½æ•°æ¢å¤ä¸ºåªå…³æ³¨å®é™…åŠŸèƒ½çš„æ ·å­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Greet</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> (res <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello &quot;</span> + s<br>&#125;<br></code></pre></td></tr></table></figure><p>åŒæ—¶ä¸ºäº†æ›´å¥½åœ°æµ‹è¯•ä½¿ç”¨ <code>-toolexec</code>ç¼–è¯‘åçš„è¿è¡Œç»“æœï¼Œè¿™é‡Œå°† <code>greet_test.go</code> åˆ é™¤äº†å¹¶æ–°å¢äº†<code>main.go</code> æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>res := Greet(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;hello world&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Greet() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;hello world&quot;</span>)<br>&#125;<br><br>RegisterMockFunc(<span class="hljs-string">&quot;Greet&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock &quot;</span> + s<br>&#125;)<br>res = Greet(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;mock world&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Greet() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;mock world&quot;</span>)<br>&#125;<br><br>log.Println(<span class="hljs-string">&quot;run successfully&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆ <code>-toolexec</code> è¦æ‰§è¡Œçš„å‘½ä»¤æ€ä¹ˆå®ç°å‘¢ï¼Ÿåœ¨ Google æœç´¢<strong>go toolexec</strong> ä½ ä¼šçœ‹åˆ°å®˜æ–¹ç»™å‡ºçš„ä¸€ä¸ªæ¡ˆä¾‹ï¼š<ahref="https://go.dev/src/cmd/go/testdata/script/toolexec.txt">toolexec.txt</a>ã€‚</p><p>æ ¸å¿ƒéƒ¨åˆ†åœ¨æœ€ä¸‹é¢ï¼Œå‚è€ƒè¿™ä¸ªç¤ºä¾‹ï¼Œæˆ‘ä»¬æ¥å®ç°è‡ªå·±çš„<code>toolexec</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p cmd/mytool<br><span class="hljs-built_in">touch</span> cmd/mytool/mytool.go<br></code></pre></td></tr></table></figure><p>åœ¨<code>mytool.go</code>ä¸­ï¼Œæˆ‘ä»¬å…ˆå†™è¿™ä¹ˆç‚¹ä»£ç ï¼Œçœ‹ä¸€ä¸‹ä¼šè¾“å‡ºä»€ä¹ˆã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>tool, args := os.Args[<span class="hljs-number">1</span>], os.Args[<span class="hljs-number">2</span>:]<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(args) &gt; <span class="hljs-number">0</span> &amp;&amp; args[<span class="hljs-number">0</span>] == <span class="hljs-string">&quot;-V=full&quot;</span> &#123;<br><span class="hljs-comment">// don&#x27;t do anything to infuence the version full output.</span><br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(args) &gt; <span class="hljs-number">0</span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;tool: %s\n&quot;</span>, tool)<br>fmt.Printf(<span class="hljs-string">&quot;args: %v\n&quot;</span>, args)<br>&#125;<br>  <span class="hljs-comment">// ç»§ç»­æ‰§è¡Œä¹‹å‰çš„å‘½ä»¤</span><br>cmd := exec.Command(tool, args...)<br>cmd.Stdout = os.Stdout<br>cmd.Stderr = os.Stderr<br><br><span class="hljs-keyword">if</span> err := cmd.Run(); err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;run command error: %v\n&quot;</span>, err)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬ä¼å›¾è¾“å‡ºæ‰§è¡Œçš„å·¥å…· <code>tool</code> åŠä¼ ç»™å®ƒçš„å‚æ•°<code>args</code>ã€‚ç”±äº <code>-V=full</code>çš„ä½œç”¨æ˜¯åœ¨ç»ˆç«¯è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦è·³è¿‡å®ƒï¼Œé¿å…äº§ç”Ÿå¹²æ‰°ã€‚è¾“å‡ºæ—¥å¿—åï¼Œæˆ‘ä»¬æš‚ä¸”å…ˆç»§ç»­æ‰§è¡ŒåŸå§‹çš„å‘½ä»¤ï¼Œä¸å¯¹ç¼–è¯‘è¿‡ç¨‹åšå…¶ä»–çš„å¹²æ‰°ã€‚</p><p>Okï¼Œç°åœ¨å°±æ¥çœ‹çœ‹è¿™ä¸ª <code>-toolexec</code> åˆ°åº•åšäº†ä»€ä¹ˆï¼Œåœ¨<code>03-toolexec-static</code> ç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æ¸…é™¤ç¼“å­˜ï¼Œä¸€ç›´ä½¿ç”¨æœ€æ–°çš„ç¼–è¯‘ç»“æœ</span><br>go clean -cache -modcache -i -r<br><span class="hljs-comment"># ç¼–è¯‘ mytool</span><br>go build ./cmd/mytool<br><span class="hljs-comment"># ç¼–è¯‘ä¸šåŠ¡ç¨‹åº</span><br>go build -toolexec=./mytool -o main<br></code></pre></td></tr></table></figure><p>å› ä¸ºè¿™å‡ ä¸ªå‘½ä»¤ç»å¸¸ä¼šç”¨åˆ°ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†å…¶å°è£…åˆ°<code>script.sh</code> æ–‡ä»¶ä¸­ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">touch</span> script.sh<br><span class="hljs-built_in">chmod</span> +x script.sh<br></code></pre></td></tr></table></figure><p>å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><br>go clean -cache -modcache -i -r<br>go build ./cmd/mytool<br>go build -toolexec=./mytool -o main<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œä¸Šè¿°å‘½ä»¤åï¼Œå¯ä»¥çœ‹åˆ°ä»¥ä¸‹è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  03-toolexec-static git:(master) ./script.sh<br><span class="hljs-comment"># xgo-explore/03-toolexec-static</span><br>tool: /opt/homebrew/Cellar/go/1.22.3/libexec/pkg/tool/darwin_arm64/compile<br>args: [-o <span class="hljs-variable">$WORK</span>/b001/_pkg_.a -trimpath <span class="hljs-variable">$WORK</span>/b001=&gt; -p main -lang=go1.22 -complete -buildid PcS9clqF_ny_Ds5N0i_s/PcS9clqF_ny_Ds5N0i_s -goversion go1.22.3 -c=4 -shared -nolocalimports -importcfg <span class="hljs-variable">$WORK</span>/b001/importcfg -pack ./greet.go ./main.go ./mock.go]<br><span class="hljs-comment"># xgo-explore/03-toolexec-static</span><br>tool: /opt/homebrew/Cellar/go/1.22.3/libexec/pkg/tool/darwin_arm64/link<br>args: [-o <span class="hljs-variable">$WORK</span>/b001/exe/a.out -importcfg <span class="hljs-variable">$WORK</span>/b001/importcfg.link -buildmode=pie -buildid=KgnnCoU_6enHkOm-T62Z/PcS9clqF_ny_Ds5N0i_s/H80dtgGZw1L8mTtVqJBf/KgnnCoU_6enHkOm-T62Z -extld=cc <span class="hljs-variable">$WORK</span>/b001/_pkg_.a]<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ‰§è¡Œäº† <code>compile</code> å’Œ <code>link</code>ä¸¤ä¸ªå·¥å…·ï¼Œ<code>compile</code> æ˜¯ç¼–è¯‘è¿‡ç¨‹ï¼Œå°†ç”Ÿæˆ <code>&#123;&#125;.out</code>æ–‡ä»¶ï¼Œè€Œ <code>link</code> æ˜¯å°†å¤šä¸ª <code>&#123;&#125;.out</code>æ–‡ä»¶é“¾æ¥æˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ã€‚è¿™æ˜¯å¾ˆç»å…¸çš„ç¼–è¯‘è¿‡ç¨‹ï¼Œå¦‚æœå¯¹ Goè¯­è¨€çš„ç¼–è¯‘è¿‡ç¨‹æ„Ÿå…´è¶£ï¼Œä¹Ÿå¯ä»¥å‚è€ƒå®˜æ–¹çš„ <ahref="https://github.com/golang/go/tree/release-branch.go1.22/src/cmd/compile">GoCompile Readme</a>ï¼Œæˆ–è€…ç¬”è€…æ’°å†™çš„ <ahref="https://hedon.top/2023/11/29/go-compilation/">Go1.21.0ç¨‹åºç¼–è¯‘è¿‡ç¨‹</a>ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬éœ€è¦é‡ç‚¹å…³æ³¨çš„æ˜¯ <code>compile</code>å‘½ä»¤ï¼Œå®ƒæ˜¯è´Ÿè´£ç¼–è¯‘æºä»£ç çš„ï¼Œæ¶‰åŠåˆ°çš„æºä»£ç æ–‡ä»¶ä¼šé€šè¿‡<code>-pack ./greet.go ./main.go ./mock.go</code> ä¼ é€’ç»™<code>compile</code> å‘½ä»¤ã€‚</p><p>ç»“åˆ <code>-toolexec</code> çš„å¸®åŠ©ä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">-toolexec <span class="hljs-string">&#x27;cmd args&#x27;</span><br>        a program to use to invoke toolchain programs like vet and asm.<br>        For example, instead of running asm, the go <span class="hljs-built_in">command</span> will run<br>        <span class="hljs-string">&#x27;cmd args /path/to/asm &lt;arguments for asm&gt;&#x27;</span>.<br>        The TOOLEXEC_IMPORTPATH environment variable will be <span class="hljs-built_in">set</span>,<br>        matching <span class="hljs-string">&#x27;go list -f &#123;&#123;.ImportPath&#125;&#125;&#x27;</span> <span class="hljs-keyword">for</span> the package being built.<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬åªéœ€è¦åœ¨æ‰§è¡Œ <code>compile</code> å‘½ä»¤ä¹‹å‰ï¼Œåœ¨<code>cmd args</code> è¿™ä¸ªç¯èŠ‚ï¼Œè¿›è¡Œ <strong>ä»£ç é‡å†™</strong>å°±å¯ä»¥å®ç°æˆ‘ä»¬æƒ³è¦çš„åŠŸèƒ½äº†ã€‚</p><p>æˆ‘ä»¬ç°åœ¨æ˜¯è¦å¯¹ <code>greet.go</code> é‡Œé¢çš„ <code>Greet</code>å‡½æ•°è¿›è¡Œé‡å†™ï¼Œå…ˆçœ‹çœ‹ä¹‹å‰çš„ä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Greet</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> (res <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello &quot;</span> + s<br>&#125;<br></code></pre></td></tr></table></figure><p>é‡å†™åçš„ä»£ç åº”è¯¥è·Ÿæˆ‘ä»¬ä¹‹å‰ <strong>ç¬¬ 2 æ­¥</strong> æ˜¯ä¸€æ ·çš„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Greet</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> (res <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">if</span> InterceptMock(<span class="hljs-string">&quot;Greet&quot;</span>, s, &amp;res) &#123;<br> <span class="hljs-keyword">return</span> res<br>    &#125;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello &quot;</span> + s<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ nå¤šç§æ–¹å¼å¯ä»¥åšåˆ°ï¼Œç°åœ¨ç¬”è€…å†³å®šä½¿ç”¨æœ€æš´åŠ›çš„æ–¹å¼ï¼Œç›´æ¥ä¸´æ—¶åˆ›å»ºä¸€ä¸ªåŒ…å«è¿™æ®µä»£ç çš„æ–‡ä»¶<code>tmp.go</code>ï¼Œå¹¶æ›¿æ¢æ‰ä¼ ç»™ <code>compile</code> çš„å‚æ•°ï¼Œå³å°†<code>-pack ./greet.go ./main.go ./mock.go</code> æ›¿æ¢ä¸º<code>-pack tmp.go ./main.go ./mock.go</code></p><p>ç»¼ä¸Šï¼Œ<code>cmd/mytool/mytool/go</code> å®ç°çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>tool, args := os.Args[<span class="hljs-number">1</span>], os.Args[<span class="hljs-number">2</span>:]<br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(args) &gt; <span class="hljs-number">0</span> &amp;&amp; args[<span class="hljs-number">0</span>] == <span class="hljs-string">&quot;-V=full&quot;</span> &#123;<br><span class="hljs-comment">// don&#x27;t do anything to infuence the version full output.</span><br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(args) &gt; <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">if</span> filepath.Base(tool) == <span class="hljs-string">&quot;compile&quot;</span> &#123;<br>index := findGreetFile(args)<br><span class="hljs-keyword">if</span> index &gt; <span class="hljs-number">-1</span> &#123;<br>f, err := os.Create(<span class="hljs-string">&quot;tmp.go&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;create tmp.go error: %v\n&quot;</span>, err)<br>&#125;<br><span class="hljs-keyword">defer</span> f.Close()<br><span class="hljs-keyword">defer</span> os.Remove(<span class="hljs-string">&quot;tmp.go&quot;</span>)<br>_, _ = f.WriteString(newCode)<br>args[index] = <span class="hljs-string">&quot;tmp.go&quot;</span><br>&#125;<br>&#125;<br>fmt.Printf(<span class="hljs-string">&quot;tool: %s\n&quot;</span>, tool)<br>fmt.Printf(<span class="hljs-string">&quot;args: %v\n&quot;</span>, args)<br>&#125;<br><span class="hljs-comment">// ç»§ç»­æ‰§è¡Œä¹‹å‰çš„å‘½ä»¤</span><br>cmd := exec.Command(tool, args...)<br>cmd.Stdout = os.Stdout<br>cmd.Stderr = os.Stderr<br><br><span class="hljs-keyword">if</span> err := cmd.Run(); err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;run command error: %v\n&quot;</span>, err)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">findGreetFile</span><span class="hljs-params">(args []<span class="hljs-type">string</span>)</span></span> <span class="hljs-type">int</span> &#123;<br><span class="hljs-keyword">for</span> i, arg := <span class="hljs-keyword">range</span> args &#123;<br><span class="hljs-keyword">if</span> strings.Contains(arg, <span class="hljs-string">&quot;greet.go&quot;</span>) &#123;<br><span class="hljs-keyword">return</span> i<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-number">-1</span><br>&#125;<br><br><span class="hljs-keyword">var</span> newCode = <span class="hljs-string">`</span><br><span class="hljs-string">package main</span><br><span class="hljs-string"></span><br><span class="hljs-string">func Greet(s string) (res string) &#123;</span><br><span class="hljs-string">if InterceptMock(&quot;Greet&quot;, s, &amp;res) &#123;</span><br><span class="hljs-string"> return res</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">return &quot;hello &quot; + s</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">`</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘å…ˆä½¿ç”¨ <code>findGreetFile</code> æ¥æŸ¥æ‰¾ <code>greet.go</code>æ–‡ä»¶æ‰€å¤„çš„å‚æ•°ä½ç½®ï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œåˆ™ç”Ÿæˆæ–°çš„ <code>tmp.go</code>æ–‡ä»¶ï¼Œå¹¶æ›¿æ¢å‚æ•°ï¼Œæœ€ååœ¨ æœ¬æ¬¡ <code>compile</code> å‘½ä»¤æ‰§è¡Œå®Œæ¯•åï¼Œåˆ é™¤<code>tmp.go</code>ï¼Œâ€œæ¯å°¸ç­è¿¹â€ã€‚</p><p>æ‰§è¡Œ <code>./script.sh</code> é‡æ–°ç¼–è¯‘ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  03-toolexec-static git:(master) âœ— ./script.sh<br><span class="hljs-comment"># xgo-explore/03-toolexec-static</span><br>tool: /opt/homebrew/Cellar/go/1.22.3/libexec/pkg/tool/darwin_arm64/compile<br>args: [-o <span class="hljs-variable">$WORK</span>/b001/_pkg_.a -trimpath <span class="hljs-variable">$WORK</span>/b001=&gt; -p main -lang=go1.22 -complete -buildid PcS9clqF_ny_Ds5N0i_s/PcS9clqF_ny_Ds5N0i_s -goversion go1.22.3 -c=4 -shared -nolocalimports -importcfg <span class="hljs-variable">$WORK</span>/b001/importcfg -pack tmp.go ./main.go ./mock.go]<br><span class="hljs-comment"># xgo-explore/03-toolexec-static</span><br>tool: /opt/homebrew/Cellar/go/1.22.3/libexec/pkg/tool/darwin_arm64/link<br>args: [-o <span class="hljs-variable">$WORK</span>/b001/exe/a.out -importcfg <span class="hljs-variable">$WORK</span>/b001/importcfg.link -buildmode=pie -buildid=KgnnCoU_6enHkOm-T62Z/PcS9clqF_ny_Ds5N0i_s/H80dtgGZw1L8mTtVqJBf/KgnnCoU_6enHkOm-T62Z -extld=cc <span class="hljs-variable">$WORK</span>/b001/_pkg_.a]<br></code></pre></td></tr></table></figure><p>è¾“å‡ºçš„ç»“æœä¸­å¯ä»¥çœ‹åˆ°å·²ç»å°† <code>compile</code> çš„å‚æ•°æ›¿æ¢ä¸º<code>-pack tmp.go ./main.go ./mock.go</code> äº†ã€‚</p><p>ç°åœ¨æˆ‘ä»¬æ¥æ‰§è¡Œç”Ÿæˆçš„ç¨‹åºæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯æ‰§è¡ŒæˆåŠŸçš„ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  03-toolexec-static git:(master) âœ— ./main<br>2024/05/23 17:53:52 run successfully<br></code></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬ä¸ä½¿ç”¨ <code>-toolexec</code>ï¼Œæ˜¯æ‰§è¡Œä¸æˆåŠŸçš„ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  03-toolexec-static git:(master) âœ— go clean -cache -modcache -i -r<br>âœ  03-toolexec-static git:(master) âœ— go build -o main<br>âœ  03-toolexec-static git:(master) âœ— ./main<br>2024/05/23 17:54:33 Greet() = <span class="hljs-string">&quot;hello world&quot;</span>; want <span class="hljs-string">&quot;mock world&quot;</span><br></code></pre></td></tr></table></figure><h1 id="ç¬¬-4-æ­¥ä½¿ç”¨-ast-åœ¨å‡½æ•°å‰æ’å…¥ä»£ç ">ç¬¬ 4 æ­¥ï¼šä½¿ç”¨ ASTåœ¨å‡½æ•°å‰æ’å…¥ä»£ç </h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  04-toolexec-ast git:(master) âœ— tree<br>.<br>â”œâ”€â”€ cmd<br>â”‚Â Â  â””â”€â”€ mytool<br>â”‚Â Â      â””â”€â”€ mytool.go<br>â”œâ”€â”€ greet.go<br>â”œâ”€â”€ main.go<br>â”œâ”€â”€ mock.go<br>â””â”€â”€ script.sh<br></code></pre></td></tr></table></figure><p>æš´åŠ›æ›¿æ¢æºä»£ç æ–‡ä»¶çš„æ–¹å¼å¯èƒ½æ˜¯ä¸å¤ªä¼˜é›…å“ˆï¼Œå‡å¦‚æˆ‘ä»¬çš„<code>greet.go</code> å†…å®¹æ”¹æˆä¸‹é¢è¿™æ ·ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Greet</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> (res <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello &quot;</span> + s<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Greet2</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> (res <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello 2 &quot;</span> + s<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬æƒ³å¯¹ <code>Greet2</code> ä¹Ÿè¿›è¡Œ<strong>ä»£ç é‡å†™</strong>ï¼Œé‚£å°±éœ€è¦ä¿®æ”¹å‰é¢ <code>newCode</code>å­—æ®µçš„å†…å®¹ï¼Œè€Œä¸”å®ƒæ˜¯å†™æ­»çš„ï¼Œç¡®å®ä¸å¤ªä¼˜é›…ã€‚ç°åœ¨æˆ‘ä»¬æ­£å¼æ¥é¢å¯¹è¿™ä»¶äº‹ï¼Œå¯¹æ¯”ä¿®æ”¹åçš„å‡½æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Greet</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> (res <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">if</span> InterceptMock(<span class="hljs-string">&quot;Greet&quot;</span>, s, &amp;res) &#123;<br> <span class="hljs-keyword">return</span> res<br>    &#125;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello &quot;</span> + s<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶å®å°±æ˜¯åœ¨æ¯ä¸ªå‡½æ•°å‰åŠ ä¸Šè¿™ä¹ˆä¸€æ®µï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> InterceptMock(<span class="hljs-string">&quot;Greet&quot;</span>, s, &amp;res) &#123;<br><span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><p>äº†è§£è¿‡ç¼–è¯‘åŸç†çš„è¯»è€…åº”è¯¥å¯ä»¥æƒ³åˆ°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ“ä½œæºä»£ç çš„ ASTç»“æ„ï¼Œå¾€å‡½æ•°çš„å¼€å¤´æ’å…¥è¿™æ®µä»£ç å³å¯ã€‚å¦‚æœæˆ‘ä»¬å…ˆä¸è€ƒè™‘å‚æ•°å’Œè¿”å›å€¼çš„è¯ï¼Œé‚£è¿™æ®µä»£ç æˆ‘ä»¬éœ€è¦æ›¿æ¢çš„åœ°æ–¹å°±æ˜¯å‡½æ•°åç§°äº†ï¼Œæ‰€ä»¥å®ƒçš„ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> InterceptMock(<span class="hljs-string">&quot;$&#123;funcName&#125;&quot;</span>, s, &amp;res) &#123;<br><span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°å‡ ä¸ªæ ‡å‡†åº“å·¥å…·ï¼š</p><ul><li><code>go/ast</code>: åŒ…å®šä¹‰äº† Goç¼–ç¨‹è¯­è¨€çš„æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰ï¼Œæ ¸å¿ƒæœ‰ä»¥ä¸‹å‡ ç§ç±»å‹ï¼š<ul><li><code>File</code>: è¡¨ç¤ºä¸€ä¸ª Go æºæ–‡ä»¶ã€‚</li><li><code>Decl</code>:è¡¨ç¤ºä¸€ä¸ªå£°æ˜ï¼ŒåŒ…æ‹¬å‡½æ•°å£°æ˜ã€å˜é‡å£°æ˜ã€ç±»å‹å£°æ˜ç­‰ã€‚</li><li><code>Stmt</code>: è¡¨ç¤ºä¸€ä¸ªè¯­å¥ã€‚</li><li><code>Expr</code>: è¡¨ç¤ºä¸€ä¸ªè¡¨è¾¾å¼ã€‚</li></ul></li><li><code>go/token</code>: å®šä¹‰äº†å¤„ç† Goæºä»£ç çš„è¯æ³•å…ƒç´ çš„åŸºç¡€è®¾æ–½ï¼ŒåŒ…æ‹¬ä½ç½®ã€æ ‡è®°å’Œæ ‡è¯†ç¬¦ç­‰ã€‚è¿™ä¸ªåŒ…æä¾›äº†ç”¨äºç®¡ç†æºä»£ç ä½ç½®çš„ä¿¡æ¯ï¼Œå¯ä»¥å¸®åŠ©å®šä½ä»£ç ä¸­çš„ç‰¹å®šéƒ¨åˆ†ã€‚</li><li><code>go/parser</code>: å°†ä¸€ä¸ª <code>.go</code> æ–‡ä»¶ä»¥è§£ææˆ ASTç»“æ„ã€‚</li><li><code>go/printer</code>: æä¾›äº†å°† AST æ ¼å¼åŒ–å¹¶è¾“å‡ºä¸º Goæºç çš„åŠŸèƒ½</li></ul><p>ä¿®æ”¹åçš„ <code>cmd/mytool/mytool.go</code> ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>tool, args := os.Args[<span class="hljs-number">1</span>], os.Args[<span class="hljs-number">2</span>:]<br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(args) &gt; <span class="hljs-number">0</span> &amp;&amp; args[<span class="hljs-number">0</span>] == <span class="hljs-string">&quot;-V=full&quot;</span> &#123;<br><span class="hljs-comment">// don&#x27;t do anything to infuence the version full output.</span><br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(args) &gt; <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">if</span> filepath.Base(tool) == <span class="hljs-string">&quot;compile&quot;</span> &#123;<br>index := findGreetFile(args)<br><span class="hljs-keyword">if</span> index &gt; <span class="hljs-number">-1</span> &#123;<br>filename := args[index]<br>f, err := os.Create(<span class="hljs-string">&quot;tmp.go&quot;</span>)<br><span class="hljs-keyword">defer</span> f.Close()<br><span class="hljs-keyword">defer</span> os.Remove(<span class="hljs-string">&quot;tmp.go&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;create tmp.go error: %v\n&quot;</span>, err)<br>&#125;<br>_, _ = f.WriteString(insertCode(filename))<br>args[index] = <span class="hljs-string">&quot;tmp.go&quot;</span><br>&#125;<br>&#125;<br>fmt.Printf(<span class="hljs-string">&quot;tool: %s\n&quot;</span>, tool)<br>fmt.Printf(<span class="hljs-string">&quot;args: %v\n&quot;</span>, args)<br>&#125;<br><span class="hljs-comment">// ç»§ç»­æ‰§è¡Œä¹‹å‰çš„å‘½ä»¤</span><br>cmd := exec.Command(tool, args...)<br>cmd.Stdout = os.Stdout<br>cmd.Stderr = os.Stderr<br><br><span class="hljs-keyword">if</span> err := cmd.Run(); err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;run command error: %v\n&quot;</span>, err)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">findGreetFile</span><span class="hljs-params">(args []<span class="hljs-type">string</span>)</span></span> <span class="hljs-type">int</span> &#123;<br><span class="hljs-keyword">for</span> i, arg := <span class="hljs-keyword">range</span> args &#123;<br><span class="hljs-keyword">if</span> strings.Contains(arg, <span class="hljs-string">&quot;greet.go&quot;</span>) &#123;<br><span class="hljs-keyword">return</span> i<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-number">-1</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">insertCode</span><span class="hljs-params">(filename <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>fset := token.NewFileSet()<br>fast, err := parser.ParseFile(fset, filename, <span class="hljs-literal">nil</span>, parser.AllErrors)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;parse file error: %v\n&quot;</span>, err)<br>&#125;<br><br><span class="hljs-keyword">for</span> _, decl := <span class="hljs-keyword">range</span> fast.Decls &#123;<br>fun, ok := decl.(*ast.FuncDecl)<br><span class="hljs-keyword">if</span> !ok &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><br>f, err := os.Create(<span class="hljs-string">&quot;tmp2.go&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;create tmp2.go error: %v\n&quot;</span>, err)<br>&#125;<br>_, _ = f.WriteString(fmt.Sprintf(newCodeFormat, fun.Name.Name))<br>f.Close()<br><br>tmpFset := token.NewFileSet()<br>tmpF, err := parser.ParseFile(tmpFset, <span class="hljs-string">&quot;tmp2.go&quot;</span>, <span class="hljs-literal">nil</span>, parser.AllErrors)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;parse tmp2.go error: %v\n&quot;</span>, err)<br>&#125;<br>fun.Body.List = <span class="hljs-built_in">append</span>(tmpF.Decls[<span class="hljs-number">0</span>].(*ast.FuncDecl).Body.List, fun.Body.List...)<br>os.Remove(<span class="hljs-string">&quot;tmp2.go&quot;</span>)<br>&#125;<br><br><span class="hljs-keyword">var</span> buf bytes.Buffer<br>printer.Fprint(&amp;buf, fset, fast)<br><br>fmt.Println(buf.String())<br><br><span class="hljs-keyword">return</span> buf.String()<br>&#125;<br><br><span class="hljs-keyword">var</span> newCodeFormat = <span class="hljs-string">`</span><br><span class="hljs-string">package main</span><br><span class="hljs-string"></span><br><span class="hljs-string">func TmpFunc() &#123;</span><br><span class="hljs-string">if InterceptMock(&quot;%s&quot;, s, &amp;res) &#123;</span><br><span class="hljs-string"> return res</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">`</span><br></code></pre></td></tr></table></figure><p>æ ¸å¿ƒçš„ä¿®æ”¹åœ¨äº <code>insertCode</code> å‡½æ•°ï¼š</p><ol type="1"><li><p>ä½¿ç”¨ <code>parser.ParseFile</code> å°†æºä»£ç æ–‡ä»¶è§£ææˆ ASTç»“æ„ï¼›</p></li><li><p>éå† AST ç»“æ„ï¼Œæ‰¾åˆ°æ‰€æœ‰çš„å£°æ˜ï¼ˆDeclï¼‰ç»“æ„ï¼Œå¹¶ä½¿ç”¨<code>decl(.ast.FuncDecl)</code> æ‰¾åˆ°æ‰€æœ‰çš„å‡½æ•°ï¼›</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go">FuncDecl <span class="hljs-keyword">struct</span> &#123;<br>  Doc  *CommentGroup <span class="hljs-comment">// associated documentation; or nil</span><br>  Recv *FieldList    <span class="hljs-comment">// receiver (methods); or nil (functions)</span><br>  Name *Ident        <span class="hljs-comment">// function/method name</span><br>  Type *FuncType     <span class="hljs-comment">// function signature: type and value parameters, results, and position of &quot;func&quot; keyword</span><br>  Body *BlockStmt    <span class="hljs-comment">// function body; or nil for external (non-Go) function</span><br>&#125;<br><br>BlockStmt <span class="hljs-keyword">struct</span> &#123;<br>  Lbrace token.Pos <span class="hljs-comment">// position of &quot;&#123;&quot;</span><br>  List   []Stmt<br>  Rbrace token.Pos <span class="hljs-comment">// position of &quot;&#125;&quot;, if any (may be absent due to syntax error)</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹ <code>ast.FuncDecl</code> çš„ç»“æ„åï¼Œå¯ä»¥å¾—å‡ºä¸‹ä¸€æ­¥å°±æ˜¯å¾€<code>FuncDecl.Body.List</code> åˆ—è¡¨å‰é¢æ’å…¥ä¸€äº›<code>Stmt</code>ï¼›</p></li><li><p>ç¬”è€…æ²¡æ‰¾åˆ°ç±»ä¼¼ <code>parseStmt</code>æ–¹æ³•ï¼Œæ‰€ä»¥å–äº†ä¸ªå·§ï¼Œæˆ‘å®šä¹‰äº†ä¸€æ®µä»£ç çš„ <code>format</code>ï¼Œé‡Œé¢çš„<code>%s</code> ä¼šä½¿ç”¨ <code>fun.Name.Name</code>è·å–å‡½æ•°åå¹¶è¿›è¡Œæ›¿æ¢ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> newCodeFormat = <span class="hljs-string">`</span><br><span class="hljs-string">package main</span><br><span class="hljs-string"></span><br><span class="hljs-string">func TmpFunc() &#123;</span><br><span class="hljs-string">if InterceptMock(&quot;%s&quot;, s, &amp;res) &#123;</span><br><span class="hljs-string"> return res</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">`</span><br></code></pre></td></tr></table></figure></li><li><p>åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ <code>tmp2.go</code>å¹¶å†™å…¥æ ¼å¼åŒ–åçš„ä»£ç ï¼Œç„¶åå†æ¬¡è°ƒç”¨ <code>parser.ParseFile</code>å¾—åˆ°è§£æè¿™æ®µä»£ç çš„æŠ½è±¡è¯­æ³•æ ‘ç»“æ„ <code>tmpF</code> äº†ï¼›</p></li><li><p>ç„¶åé€šè¿‡ <code>tmpF.Decls[0].(*ast.FuncDecl).Body.List</code>å°±å¯ä»¥å¾—åˆ° <code>TmpFunc</code> ä¸­çš„è¯­å¥ <code>Stmt</code> äº†ï¼›</p></li><li><p>å°†å…¶åŠ åœ¨æºä»£ç å‡½æ•°çš„å‰é¢å³å¯ï¼š<code>fun.Body.List = append(tmpF.Decls[0].(*ast.FuncDecl).Body.List, fun.Body.List...)</code>ï¼›</p></li><li><p>ç„¶åå†ä½¿ç”¨ <code>go/printer</code> å°†ä¿®æ”¹åçš„ ASTè¾“å‡ºä¸ºæ–°æ–‡ä»¶å†…å®¹ã€‚</p></li></ol><p>é€šè¿‡ä¸Šè¿°æ­¥éª¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¸º <code>greet.go</code>ä¸­çš„æ¯ä¸ªå‡½æ•°å‰é¢éƒ½æ’å…¥æ‰“æ¡©ä»£ç äº†ã€‚</p><p>ä¿®æ”¹ <code>main.go</code> é‡Œé¢çš„å†…å®¹ï¼ŒåŠ å…¥å¯¹ <code>Greet2</code>çš„æµ‹è¯•ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>res := Greet(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;hello world&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Greet() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;hello world&quot;</span>)<br>&#125;<br><br>RegisterMockFunc(<span class="hljs-string">&quot;Greet&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock &quot;</span> + s<br>&#125;)<br>res = Greet(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;mock world&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Greet() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;mock world&quot;</span>)<br>&#125;<br><br>log.Println(<span class="hljs-string">&quot;run greet 1 successfully&quot;</span>)<br><br>RegisterMockFunc(<span class="hljs-string">&quot;Greet2&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock 2 &quot;</span> + s<br>&#125;)<br>res = Greet2(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;mock 2 world&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Greet2() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;mock 2 world&quot;</span>)<br>&#125;<br><br>log.Println(<span class="hljs-string">&quot;run greet 2 successfully&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œè„šæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./script.sh<br></code></pre></td></tr></table></figure><p>è¾“å‡ºåº”è¯¥è¿˜æ˜¯è·Ÿä¹‹å‰æ˜¯ä¸€æ ·çš„ï¼Œæˆ‘ä»¬è¿è¡Œç”Ÿæˆçš„å¯æ‰§è¡Œå‡½æ•°ï¼Œå¾—åˆ°å¦‚ä¸‹ç»“æœé‚£å°±è¯´æ˜æˆ‘ä»¬åˆæˆåŠŸè¿›äº†ä¸€æ­¥äº†~</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  04-toolexec-ast git:(master) âœ— ./main<br>2024/05/23 20:03:22 run greet 1 successfully<br>2024/05/23 20:03:22 run greet 2 successfully<br></code></pre></td></tr></table></figure><h1 id="ç¬¬-5-æ­¥ä½¿ç”¨-reflect-åå°„åŠ¨æ€è·å–å‚æ•°å’Œè¿”å›å€¼åç§°">ç¬¬ 5 æ­¥ï¼šä½¿ç”¨reflect åå°„åŠ¨æ€è·å–å‚æ•°å’Œè¿”å›å€¼åç§°</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  05-toolexec-general git:(master) âœ— tree<br>.<br>â”œâ”€â”€ cmd<br>â”‚Â Â  â””â”€â”€ mytool<br>â”‚Â Â      â””â”€â”€ mytool.go<br>â”œâ”€â”€ greet.go<br>â”œâ”€â”€ main.go<br>â”œâ”€â”€ mock.go<br>â””â”€â”€ script.sh<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å¤„ç†å‡½æ•°ç­¾åä¸­çš„å‚æ•°å’Œè¿”å›å€¼éƒ¨åˆ†ï¼Œæˆ‘ä»¬çš„æ ·æ¿ä»£ç ä¸­ï¼Œå†™æ­»äº†å‚æ•°çš„åç§°å’Œè¿”å›å€¼çš„åç§°ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦æ¥åŠ¨æ€è·å–å‡½æ•°å‚æ•°çš„åç§°å’Œè¿”å›å€¼çš„åç§°ï¼Œå¦‚æœè¿”å›å€¼æ²¡æœ‰åç§°ï¼Œé‚£æˆ‘ä»¬è¿˜éœ€è¦æ‰‹åŠ¨è®¾ç½®åç§°ã€‚</p><p>æˆ‘ä»¬å°† <code>greet.to</code> ä¿®æ”¹ä¸ºä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Greet</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> (res <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello &quot;</span> + s<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Greet2</span><span class="hljs-params">(s2 <span class="hljs-type">string</span>)</span></span> (res2 <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello 2 &quot;</span> + s2<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Greet3</span><span class="hljs-params">(s3 <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello 3 &quot;</span> + s3<br>&#125;<br></code></pre></td></tr></table></figure><p>å‡½æ•°çš„ä¿¡æ¯å½“ç„¶éƒ½åœ¨å‰é¢è·å¾—çš„ <code>ast.FuncDecl</code>ç»“æ„ä¸­ï¼Œå†æ¬¡è§‚å¯Ÿå…¶ç»“æ„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">FuncDecl <span class="hljs-keyword">struct</span> &#123;<br>Doc  *CommentGroup <span class="hljs-comment">// associated documentation; or nil</span><br>Recv *FieldList    <span class="hljs-comment">// receiver (methods); or nil (functions)</span><br>Name *Ident        <span class="hljs-comment">// function/method name</span><br>Type *FuncType     <span class="hljs-comment">// function signature: type and value parameters, results, and position of &quot;func&quot; keyword</span><br>Body *BlockStmt    <span class="hljs-comment">// function body; or nil for external (non-Go) function</span><br>&#125;<br></code></pre></td></tr></table></figure><p>é€šè¿‡æ³¨é‡Šå°±å¯ä»¥çŸ¥é“ <code>Type</code>å­—æ®µå°±åŒ…å«äº†å‚æ•°å’Œè¿”å›å€¼çš„ç›¸å…³ä¿¡æ¯ï¼ŒæŸ¥çœ‹ <code>FuncType</code>ç»“æ„ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">FuncType <span class="hljs-keyword">struct</span> &#123;<br>  Func       token.Pos  <span class="hljs-comment">// position of &quot;func&quot; keyword (token.NoPos if there is no &quot;func&quot;)</span><br>  TypeParams *FieldList <span class="hljs-comment">// type parameters; or nil</span><br>  Params     *FieldList <span class="hljs-comment">// (incoming) parameters; non-nil</span><br>  Results    *FieldList <span class="hljs-comment">// (outgoing) results; or nil</span><br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>Params</code>ï¼šå‡½æ•°å‚æ•°</li><li><code>Results</code>ï¼šå‡½æ•°è¿”å›å€¼</li></ul><p>æŸ¥çœ‹ <code>FieldList</code> ç»“æ„ï¼Œå¯çŸ¥å‚æ•°åˆ—è¡¨å’Œè¿”å›å€¼åˆ—è¡¨éƒ½åœ¨ç›¸åº”çš„<code>List</code> å­—æ®µä¸­ï¼Œè€Œå…¶ä¸­çš„ <code>Names</code>å­—æ®µå°±æ˜¯å‚æ•°çš„åç§°äº†ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> FieldList <span class="hljs-keyword">struct</span> &#123;<br>Opening token.Pos <span class="hljs-comment">// position of opening parenthesis/brace/bracket, if any</span><br>List    []*Field  <span class="hljs-comment">// field list; or nil</span><br>Closing token.Pos <span class="hljs-comment">// position of closing parenthesis/brace/bracket, if any</span><br>&#125;<br><br><span class="hljs-keyword">type</span> Field <span class="hljs-keyword">struct</span> &#123;<br>Doc     *CommentGroup <span class="hljs-comment">// associated documentation; or nil</span><br>Names   []*Ident      <span class="hljs-comment">// field/method/(type) parameter names; or nil</span><br>Type    Expr          <span class="hljs-comment">// field/method/parameter type; or nil</span><br>Tag     *BasicLit     <span class="hljs-comment">// field tag; or nil</span><br>Comment *CommentGroup <span class="hljs-comment">// line comments; or nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¡¥å……ä¸€ä¸‹ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆ <code>Names</code> ç±»å‹æ˜¯ <code>[]*Ident</code>å‘¢ï¼Ÿå› ä¸ºå‡½æ•°æœ‰ä»¥ä¸‹çš„å‘½åæ–¹å¼ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">hello</span><span class="hljs-params">(s1, s2 <span class="hljs-type">string</span>)</span></span> (r1, r1 <span class="hljs-type">string</span>) &#123;&#125;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆåœ¨å½“ä¸‹ï¼Œåªæœ‰ 1 ä¸ªå‚æ•°å’Œåªæœ‰ 1 ä¸ªè¿”å›å€¼çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡<code>fun.Type.Params.List[0].Names[0].Name</code>æ¥è·å–å‚æ•°åç§°ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ <code>fun.Type.Results.List[0].Names</code>æ¥è·å–è¿”å›å€¼åç§°ï¼Œå¦‚æœè¿”å›å€¼æ²¡æœ‰åç§°ï¼Œé‚£æˆ‘ä»¬å°±ä¸ºå…¶è®¾ç½®åç§°<code>__xgo_res_1</code> å¹¶å†™å›æº ASTç»“æ„ã€‚è¿™æ ·å°±éƒ½æœ‰åç§°ï¼Œå°±å¾ˆå¥½å¤„ç†äº†ã€‚</p><p>ç»ä¸Šåˆ†æï¼Œ <code>cmd/mytool/mytool.go</code> ä¸­æˆ‘ä»¬åªéœ€è¦ä¿®æ”¹<code>insertCode</code> éƒ¨åˆ†ï¼Œä¿®æ”¹çš„ç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">insertCode</span><span class="hljs-params">(filename <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>fset := token.NewFileSet()<br>fast, err := parser.ParseFile(fset, filename, <span class="hljs-literal">nil</span>, parser.AllErrors)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;parse file error: %v\n&quot;</span>, err)<br>&#125;<br><br><span class="hljs-keyword">for</span> _, decl := <span class="hljs-keyword">range</span> fast.Decls &#123;<br>fun, ok := decl.(*ast.FuncDecl)<br><span class="hljs-keyword">if</span> !ok &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><br>f, err := os.Create(<span class="hljs-string">&quot;tmp.go&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;create tmp.go error: %v\n&quot;</span>, err)<br>&#125;<br>_, _ = f.WriteString(newCode(fun))<br>f.Close()<br><br>tmpFset := token.NewFileSet()<br>tmpF, err := parser.ParseFile(tmpFset, <span class="hljs-string">&quot;tmp.go&quot;</span>, <span class="hljs-literal">nil</span>, parser.AllErrors)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;parse tmp.go error: %v\n&quot;</span>, err)<br>&#125;<br>fun.Body.List = <span class="hljs-built_in">append</span>(tmpF.Decls[<span class="hljs-number">0</span>].(*ast.FuncDecl).Body.List, fun.Body.List...)<br>os.Remove(<span class="hljs-string">&quot;tmp.go&quot;</span>)<br>&#125;<br><br><span class="hljs-keyword">var</span> buf bytes.Buffer<br>printer.Fprint(&amp;buf, fset, fast)<br><br>fmt.Println(buf.String())<br><br><span class="hljs-keyword">return</span> buf.String()<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newCode</span><span class="hljs-params">(fun *ast.FuncDecl)</span></span> <span class="hljs-type">string</span> &#123;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">&amp;&#123;Doc:&lt;nil&gt; Names:[s] Type:string Tag:&lt;nil&gt; Comment:&lt;nil&gt;&#125;</span><br><span class="hljs-comment">&amp;&#123;Doc:&lt;nil&gt; Names:[res] Type:string Tag:&lt;nil&gt; Comment:&lt;nil&gt;&#125;</span><br><span class="hljs-comment">&amp;&#123;Doc:&lt;nil&gt; Names:[s2] Type:string Tag:&lt;nil&gt; Comment:&lt;nil&gt;&#125;</span><br><span class="hljs-comment">&amp;&#123;Doc:&lt;nil&gt; Names:[res2] Type:string Tag:&lt;nil&gt; Comment:&lt;nil&gt;&#125;</span><br><span class="hljs-comment">&amp;&#123;Doc:&lt;nil&gt; Names:[s3] Type:string Tag:&lt;nil&gt; Comment:&lt;nil&gt;&#125;</span><br><span class="hljs-comment">&amp;&#123;Doc:&lt;nil&gt; Names:[] Type:string Tag:&lt;nil&gt; Comment:&lt;nil&gt;&#125;</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-comment">// å‡½æ•°åç§°</span><br>funcName := fun.Name.Name<br><br><span class="hljs-comment">// å‚æ•°åˆ—è¡¨</span><br>argName := fun.Type.Params.List[<span class="hljs-number">0</span>].Names[<span class="hljs-number">0</span>].Name<br><br><span class="hljs-comment">// è¿”å›å€¼åˆ—è¡¨</span><br>resNames := fun.Type.Results.List[<span class="hljs-number">0</span>].Names<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(resNames) == <span class="hljs-number">0</span> &#123;<br>resNames = <span class="hljs-built_in">append</span>(resNames, &amp;ast.Ident&#123;Name: <span class="hljs-string">&quot;_xgo_res_1&quot;</span>&#125;)<br>fun.Type.Results.List[<span class="hljs-number">0</span>].Names = resNames<br>&#125;<br>resName := resNames[<span class="hljs-number">0</span>].Name<br><span class="hljs-keyword">return</span> fmt.Sprintf(newCodeFormat, funcName, argName, resName, resName)<br>&#125;<br><br><span class="hljs-keyword">var</span> newCodeFormat = <span class="hljs-string">`</span><br><span class="hljs-string">package main</span><br><span class="hljs-string"></span><br><span class="hljs-string">func TmpFunc() &#123;</span><br><span class="hljs-string">if InterceptMock(&quot;%s&quot;, %s, &amp;%s) &#123;</span><br><span class="hljs-string"> return %s</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">`</span><br></code></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥åŠ¨æ€è·å–å‚æ•°åç§°å’Œè¿”å›å€¼åç§°äº†ã€‚</p><p>ä¿®æ”¹æˆ‘ä»¬çš„ <code>main.go</code>ï¼Œä»¥æµ‹è¯•æ‰€æœ‰çš„æƒ…å†µï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>res := Greet(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;hello world&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Greet() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;hello world&quot;</span>)<br>&#125;<br><br>RegisterMockFunc(<span class="hljs-string">&quot;Greet&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock &quot;</span> + s<br>&#125;)<br>res = Greet(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;mock world&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Greet() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;mock world&quot;</span>)<br>&#125;<br><br>log.Println(<span class="hljs-string">&quot;run greet 1 successfully&quot;</span>)<br><br>RegisterMockFunc(<span class="hljs-string">&quot;Greet2&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock 2 &quot;</span> + s<br>&#125;)<br>res = Greet2(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;mock 2 world&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Greet2() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;mock 2 world&quot;</span>)<br>&#125;<br><br>log.Println(<span class="hljs-string">&quot;run greet 2 successfully&quot;</span>)<br><br>RegisterMockFunc(<span class="hljs-string">&quot;Greet3&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock 3 &quot;</span> + s<br>&#125;)<br>res = Greet3(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;mock 3 world&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Greet3() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;mock 3 world&quot;</span>)<br>&#125;<br><br>log.Println(<span class="hljs-string">&quot;run greet 3 successfully&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œç¼–è¯‘è„šæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./script.sh<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œç¼–è¯‘äº§ç”Ÿçš„å¯æ‰§è¡Œç¨‹åºï¼Œè¾“å‡ºå¦‚ä¸‹å°±è¯´æ˜æˆ‘ä»¬åˆæˆåŠŸè¿›äº†ä¸€å¤§æ­¥~</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  05-toolexec-general git:(master) âœ— ./main<br>2024/05/23 20:15:08 run greet 1 successfully<br>2024/05/23 20:15:08 run greet 2 successfully<br>2024/05/23 20:15:08 run greet 3 successfully<br></code></pre></td></tr></table></figure><h1 id="ç¬¬-6-æ­¥æ”¯æŒå¤šå‚æ•°å’Œå¤šè¿”å›å€¼">ç¬¬ 6 æ­¥ï¼šæ”¯æŒå¤šå‚æ•°å’Œå¤šè¿”å›å€¼</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  06-toolexec-multi git:(master) âœ— tree<br>.<br>â”œâ”€â”€ cmd<br>â”‚Â Â  â””â”€â”€ mytool<br>â”‚Â Â      â””â”€â”€ mytool.go<br>â”œâ”€â”€ greet.go<br>â”œâ”€â”€ main.go<br>â”œâ”€â”€ mock.go<br>â””â”€â”€ script.sh<br></code></pre></td></tr></table></figure><p>æœ¬æ–‡çš„æœ€åä¸€æ­¥ï¼Œæˆ‘ä»¬æ¥é¢å¯¹ä¸€ä¸‹å¤šå‚æ•°å’Œå¤šè¿”å›å€¼çš„é—®é¢˜ã€‚å‡è®¾æˆ‘ä»¬åˆå¦‚ä¸‹å‡½æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Pair1</span><span class="hljs-params">(s1, s2 <span class="hljs-type">string</span>)</span></span> (res <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;pair 1 &quot;</span> + s1 + <span class="hljs-string">&quot; &quot;</span> + s2<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬ <strong>ä»£ç é‡å†™</strong>ååº”è¯¥é•¿ä»€ä¹ˆæ ·å­å‘¢ï¼Ÿå¯ä»¥æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Pair1</span><span class="hljs-params">(s1, s2 <span class="hljs-type">string</span>)</span></span> (res <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">if</span> InterceptMock(<span class="hljs-string">&quot;Pair1&quot;</span>, s1, s2, &amp;res) &#123;<br><span class="hljs-keyword">return</span> res<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;pair 1 &quot;</span> + s1 + <span class="hljs-string">&quot; &quot;</span> + s2<br>&#125;<br></code></pre></td></tr></table></figure><p>æŒ‰ç…§è¿™ä¸ªæ€è·¯ï¼Œä¸‹é¢è¿™ä¸ªå‡½æ•°å‘¢ï¼Ÿ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Pair2</span><span class="hljs-params">(s1, s2 <span class="hljs-type">string</span>)</span></span> (res1, res2 <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;pair 1 &quot;</span> + s1, <span class="hljs-string">&quot;pair 2 &quot;</span> + s2<br>&#125;<br></code></pre></td></tr></table></figure><p>é‚£å°±æ˜¯è¿™æ ·çš„ï¼Ÿ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Pair2</span><span class="hljs-params">(s1, s2 <span class="hljs-type">string</span>)</span></span> (res1, res2 <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">if</span> InterceptMock(<span class="hljs-string">&quot;Pair2&quot;</span>, s1, s2, &amp;res1, &amp;res2) &#123;<br><span class="hljs-keyword">return</span> res1, res2<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;pair 1 &quot;</span> + s1, <span class="hljs-string">&quot;pair 2 &quot;</span> + s2<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ç§æ€è·¯å½“ç„¶ä¹Ÿèƒ½å®ç°ï¼Œæ¢ä¸€ç§æ›´ä¼˜é›…çš„æ€è·¯å‘¢ï¼Ÿæ—¢ç„¶æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç”¨åˆ‡ç‰‡æ¥æ‰¿è½½ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Pair2</span><span class="hljs-params">(s1, s2 <span class="hljs-type">string</span>)</span></span> (res1, res2 <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">if</span> InterceptMock(<span class="hljs-string">&quot;Pair2&quot;</span>, []<span class="hljs-keyword">interface</span>&#123;&#125;&#123;s1, s2&#125;, []<span class="hljs-keyword">interface</span>&#123;&#125;&#123;&amp;res1, &amp;res2&#125;) &#123;<br><span class="hljs-keyword">return</span> res1, res2<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;pair 1 &quot;</span> + s1, <span class="hljs-string">&quot;pair 2 &quot;</span> + s2<br>&#125;<br></code></pre></td></tr></table></figure><p>é‚£æˆ‘ä»¬å°±å¯ä»¥æŠ½è±¡å‡ºæ’å…¥ä»£ç çš„æ¨¡æ¿äº†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> InterceptMock(<span class="hljs-string">&quot;$&#123;funcName&#125;&quot;</span>, []<span class="hljs-keyword">interface</span>&#123;&#125;&#123;$&#123;paramList&#125;&#125;, []<span class="hljs-keyword">interface</span>&#123;&#125;&#123;$&#123;returnListWith&amp;&#125;&#125;) &#123;<br>  <span class="hljs-keyword">return</span> $&#123;returnListWithout&amp;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸ºäº†å®ç°è¿™ä¸ªï¼Œæˆ‘ä»¬éœ€è¦å…ˆä¿®æ”¹ä¸€ä¸‹ <code>mock.go</code> ä¸­çš„<code>InterceptMock</code> å‡½æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InterceptMock</span><span class="hljs-params">(funcName <span class="hljs-type">string</span>, args []<span class="hljs-keyword">interface</span>&#123;&#125;, results []<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> <span class="hljs-type">bool</span> &#123;<br>mockFn, ok := mockFuncs.Load(funcName)<br><span class="hljs-keyword">if</span> !ok &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><br><br>in := <span class="hljs-built_in">make</span>([]reflect.Value, <span class="hljs-built_in">len</span>(args))<br><span class="hljs-keyword">for</span> i, arg := <span class="hljs-keyword">range</span> args &#123;<br>in[i] = reflect.ValueOf(arg)<br>&#125;<br><br>  mockFnValue := reflect.ValueOf(mockFn)<br>out := mockFnValue.Call(in)<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(out) != <span class="hljs-built_in">len</span>(results) &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;mock function return value number is not equal to results number&quot;</span>)<br>&#125;<br><br><span class="hljs-keyword">for</span> i, result := <span class="hljs-keyword">range</span> results &#123;<br>reflect.ValueOf(result).Elem().Set(out[i])<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ‹¦æˆªå™¨çš„å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p><ol type="1"><li>åˆ¤æ–­æ˜¯å¦æ³¨å†Œäº† mock å‡½æ•°ï¼Œæ²¡æœ‰åˆ™ç›´æ¥è¿”å›ï¼›</li><li>å°†æ‰€æœ‰å‚æ•°éƒ½æ”¾åˆ° <code>[]refect.Value</code> ä¸­ï¼›</li><li>é€šè¿‡åå°„ <code>refect.ValueOf</code> è·å– mockFn çš„å€¼ï¼›</li><li>è°ƒç”¨ <code>mockFnValue.Call()</code>æ¥æ‰§è¡Œå‡½æ•°ï¼Œå¹¶è¿”å›ç»“æœåˆ—è¡¨ï¼›</li><li>éå†ä¼ è¿›æ¥çš„è¿”å›å€¼å¼•ç”¨åˆ—è¡¨ï¼Œè°ƒç”¨<code>reflect.ValueOf(result).Elem().Set(out[i])</code>å°†è¿”å›å€¼è®¾ç½®å›å»ã€‚</li></ol><p>ç°åœ¨æˆ‘ä»¬æ¥ä¿®æ”¹æˆ‘ä»¬çš„ <code>-toolexec</code> å·¥å…·ï¼Œæ¥æ ¹æ®å‡½æ•°çš„ ASTç»“æ„ï¼Œè·å–å‚æ•°åˆ—è¡¨å’Œè¿”å›å€¼åˆ—è¡¨ï¼Œç”Ÿæˆä»£æ’å…¥çš„æ¨¡æ¿ä»£ç ï¼Œå¹¶å°†å…¶æ’å…¥åˆ°æ¯ä¸ªå‡½æ•°çš„å¼€å¤´ã€‚è¿™æ¬¡åœ¨<code>cmd/mytool/mytool.go</code> ä¸­ï¼Œæˆ‘ä»¬åªéœ€ä¿®æ”¹ <code>newCode</code>å‡½æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">insertCode</span><span class="hljs-params">(filename <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>fset := token.NewFileSet()<br>fast, err := parser.ParseFile(fset, filename, <span class="hljs-literal">nil</span>, parser.AllErrors)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;parse file error: %v\n&quot;</span>, err)<br>&#125;<br><br><span class="hljs-keyword">for</span> _, decl := <span class="hljs-keyword">range</span> fast.Decls &#123;<br>fun, ok := decl.(*ast.FuncDecl)<br><span class="hljs-keyword">if</span> !ok &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><br>f, err := os.Create(<span class="hljs-string">&quot;tmp.go&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;create tmp.go error: %v\n&quot;</span>, err)<br>&#125;<br>_, _ = f.WriteString(newCode(fun))<br>f.Close()<br><br>tmpFset := token.NewFileSet()<br>tmpF, err := parser.ParseFile(tmpFset, <span class="hljs-string">&quot;tmp.go&quot;</span>, <span class="hljs-literal">nil</span>, parser.AllErrors)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;parse tmp.go error: %v\n&quot;</span>, err)<br>&#125;<br>fun.Body.List = <span class="hljs-built_in">append</span>(tmpF.Decls[<span class="hljs-number">0</span>].(*ast.FuncDecl).Body.List, fun.Body.List...)<br>os.Remove(<span class="hljs-string">&quot;tmp.go&quot;</span>)<br>&#125;<br><br><span class="hljs-keyword">var</span> buf bytes.Buffer<br>printer.Fprint(&amp;buf, fset, fast)<br><br>fmt.Println(buf.String())<br><br><span class="hljs-keyword">return</span> buf.String()<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newCode</span><span class="hljs-params">(fun *ast.FuncDecl)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-comment">// å‡½æ•°åç§°</span><br>funcName := fun.Name.Name<br><br><span class="hljs-comment">// å‚æ•°åˆ—è¡¨</span><br>args := <span class="hljs-built_in">make</span>([]<span class="hljs-type">string</span>, <span class="hljs-number">0</span>)<br><span class="hljs-keyword">for</span> _, arg := <span class="hljs-keyword">range</span> fun.Type.Params.List &#123;<br><span class="hljs-keyword">for</span> _, name := <span class="hljs-keyword">range</span> arg.Names &#123;<br>args = <span class="hljs-built_in">append</span>(args, name.Name)<br>&#125;<br>&#125;<br><span class="hljs-comment">// è¿”å›å€¼åˆ—è¡¨</span><br>returns := <span class="hljs-built_in">make</span>([]<span class="hljs-type">string</span>, <span class="hljs-number">0</span>)<br>returnRefs := <span class="hljs-built_in">make</span>([]<span class="hljs-type">string</span>, <span class="hljs-number">0</span>)<br>returnNames := fun.Type.Results.List[<span class="hljs-number">0</span>].Names<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(returnNames) == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; fun.Type.Results.NumFields(); i++ &#123;<br>fun.Type.Results.List[<span class="hljs-number">0</span>].Names = <span class="hljs-built_in">append</span>(fun.Type.Results.List[<span class="hljs-number">0</span>].Names,<br>&amp;ast.Ident&#123;Name: fmt.Sprintf(<span class="hljs-string">&quot;_xgo_res_%d&quot;</span>, i+<span class="hljs-number">1</span>)&#125;)<br>&#125;<br>&#125;<br><span class="hljs-keyword">for</span> _, re := <span class="hljs-keyword">range</span> fun.Type.Results.List[<span class="hljs-number">0</span>].Names &#123;<br>returns = <span class="hljs-built_in">append</span>(returns, re.Name)<br>returnRefs = <span class="hljs-built_in">append</span>(returnRefs, <span class="hljs-string">&quot;&amp;&quot;</span>+re.Name)<br>&#125;<br><span class="hljs-keyword">return</span> fmt.Sprintf(newCodeFormat,<br>funcName,<br>strings.Join(args, <span class="hljs-string">&quot;,&quot;</span>),<br>strings.Join(returnRefs, <span class="hljs-string">&quot;,&quot;</span>),<br>strings.Join(returns, <span class="hljs-string">&quot;,&quot;</span>))<br>&#125;<br><br><span class="hljs-keyword">var</span> newCodeFormat = <span class="hljs-string">`</span><br><span class="hljs-string">package main</span><br><span class="hljs-string"></span><br><span class="hljs-string">func TmpFunc() &#123;</span><br><span class="hljs-string">if InterceptMock(&quot;%s&quot;, []interface&#123;&#125;&#123;%s&#125;, []interface&#123;&#125;&#123;%s&#125;) &#123;</span><br><span class="hljs-string">return %s</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">`</span><br></code></pre></td></tr></table></figure><p>æ€è·¯è·Ÿä¹‹å‰ç¬¬ 5æ­¥å¤§åŒå°å¼‚ï¼Œä¸è¿‡æ˜¯ç”¨éå†çš„æ–¹å¼æ¥æ”¯æŒå¤šä¸ªå‚æ•°å’Œå¤šä¸ªè¿”å›å€¼ç½¢äº†ã€‚</p><p>ç°åœ¨æˆ‘ä»¬ä¸º <code>greet.go</code> æ·»åŠ æ›´å¤šçš„æµ‹è¯•å‡½æ•°ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Greet</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> (res <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello &quot;</span> + s<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Greet2</span><span class="hljs-params">(s2 <span class="hljs-type">string</span>)</span></span> (res2 <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello 2 &quot;</span> + s2<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Greet3</span><span class="hljs-params">(s3 <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello 3 &quot;</span> + s3<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Pair1</span><span class="hljs-params">(s1, s2 <span class="hljs-type">string</span>)</span></span> (res <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;pair 1 &quot;</span> + s1 + <span class="hljs-string">&quot; &quot;</span> + s2<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Pair2</span><span class="hljs-params">(s1, s2 <span class="hljs-type">string</span>)</span></span> (res1, res2 <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;pair 1 &quot;</span> + s1, <span class="hljs-string">&quot;pair 2 &quot;</span> + s2<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Other</span><span class="hljs-params">(i <span class="hljs-type">int</span>, s <span class="hljs-type">string</span>, f <span class="hljs-type">float64</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">&quot;int: %d, string: %s, float: %f&quot;</span>, i, s, f)<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸ºäº†æµ‹è¯•ï¼Œæˆ‘ä»¬å†æ¬¡ä¿®æ”¹ <code>main.go</code>ï¼Œä½¿å…¶è¦†ç›–æ‰€æœ‰çš„æƒ…å†µï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><br>RegisterMockFunc(<span class="hljs-string">&quot;Other&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-type">int</span>, s <span class="hljs-type">string</span>, f <span class="hljs-type">float64</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">&quot;mock %d %s %.2f&quot;</span>, i, s, f)<br>&#125;)<br>res := Other(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;hello&quot;</span>, <span class="hljs-number">3.14</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;mock 1 hello 3.14&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Other() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;mock 1 hello 3.14&quot;</span>)<br>&#125;<br>log.Println(<span class="hljs-string">&quot;run other successfully&quot;</span>)<br><br>RegisterMockFunc(<span class="hljs-string">&quot;Pair1&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s1, s2 <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock 1 &quot;</span> + s1 + <span class="hljs-string">&quot; &quot;</span> + s2<br>&#125;)<br>res = Pair1(<span class="hljs-string">&quot;hello&quot;</span>, <span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;mock 1 hello world&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Pair1() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;mock 1 hello world&quot;</span>)<br>&#125;<br>log.Println(<span class="hljs-string">&quot;run pair1 successfully&quot;</span>)<br><br>RegisterMockFunc(<span class="hljs-string">&quot;Pair2&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s1, s2 <span class="hljs-type">string</span>)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock 2 &quot;</span> + s1, <span class="hljs-string">&quot;mock 2 &quot;</span> + s2<br>&#125;)<br>res1, res2 := Pair2(<span class="hljs-string">&quot;hello&quot;</span>, <span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res1 != <span class="hljs-string">&quot;mock 2 hello&quot;</span> || res2 != <span class="hljs-string">&quot;mock 2 world&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Pair2() = %q, %q; want %q, %q&quot;</span>, res1, res2, <span class="hljs-string">&quot;mock 2 hello&quot;</span>, <span class="hljs-string">&quot;mock 2 world&quot;</span>)<br>&#125;<br>log.Println(<span class="hljs-string">&quot;run pair2 successfully&quot;</span>)<br><br>res = Greet(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;hello world&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Greet() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;hello world&quot;</span>)<br>&#125;<br><br>RegisterMockFunc(<span class="hljs-string">&quot;Greet&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock &quot;</span> + s<br>&#125;)<br>res = Greet(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;mock world&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Greet() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;mock world&quot;</span>)<br>&#125;<br><br>log.Println(<span class="hljs-string">&quot;run greet 1 successfully&quot;</span>)<br><br>RegisterMockFunc(<span class="hljs-string">&quot;Greet2&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock 2 &quot;</span> + s<br>&#125;)<br>res = Greet2(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;mock 2 world&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Greet2() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;mock 2 world&quot;</span>)<br>&#125;<br><br>log.Println(<span class="hljs-string">&quot;run greet 2 successfully&quot;</span>)<br><br>RegisterMockFunc(<span class="hljs-string">&quot;Greet3&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock 3 &quot;</span> + s<br>&#125;)<br>res = Greet3(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;mock 3 world&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Greet3() = %q; want %q&quot;</span>, res, <span class="hljs-string">&quot;mock 3 world&quot;</span>)<br>&#125;<br><br>log.Println(<span class="hljs-string">&quot;run greet 3 successfully&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘ä»£ç ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./script.sh<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œç”Ÿæˆçš„å¯æ‰§è¡Œç¨‹åºï¼Œå¦‚æœæœ‰ä»¥ä¸‹è¾“å‡ºï¼Œé‚£æˆ‘ä»¬å°±åˆæˆåŠŸè¿›äº†ä¸€å¤§å¤§æ­¥äº†~</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  06-toolexec-multi git:(master) âœ— ./main<br>2024/05/23 20:31:10 run other successfully<br>2024/05/23 20:31:10 run pair1 successfully<br>2024/05/23 20:31:10 run pair2 successfully<br>2024/05/23 20:31:10 run greet 1 successfully<br>2024/05/23 20:31:10 run greet 2 successfully<br>2024/05/23 20:31:10 run greet 3 successfully<br></code></pre></td></tr></table></figure><h1 id="æ›´è¿›ä¸€æ­¥">æ›´è¿›ä¸€æ­¥</h1><p>é€šè¿‡ä¸Šé¢ 6 ä¸ªç®€å•çš„å°é˜¶æ®µï¼Œæˆ‘ä»¬å°±å·²ç»æŠŠ <code>xgo</code>æœ€æœ€æ ¸å¿ƒçš„åŠŸèƒ½ç»™å®ç°äº†ï¼Œåœ¨ä¸€äº›å°åœºæ™¯ä¸‹è¿˜å‹‰å¼ºèƒ½ç”¨ï¼ŸğŸ¤¡</p><p>æˆ‘ä»¬æ¥çœ‹çœ‹åŒ…å«æµ‹è¯•ä»£ç å’Œæ ·ä¾‹å‡½æ•°ï¼Œæ€»å…±ç”¨äº†å¤šå°‘ä»£ç ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  06-toolexec-multi git:(master) âœ— tokei .<br>===============================================================================<br> Language            Files        Lines         Code     Comments       Blanks<br>===============================================================================<br> Go                      4          281          224           11           46<br> Shell                   1            5            3            1            1<br>===============================================================================<br> Total                   5          286          227           12           47<br>===============================================================================<br></code></pre></td></tr></table></figure><p>çŸ­çŸ­ <strong>224</strong> è¡Œä»£ç ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸äº†ä¸èµ·çš„æˆå°±ï¼</p><p>å½“ç„¶ï¼Œä¼˜ç§€çš„è¯»è€…è‚¯å®šå¯ä»¥å‘ç°æˆ‘ä»¬è¿™ä¸ª <strong>ä¸ç‰ˆ xgo</strong>æœ‰å¤ªå¤šçš„ä¸è¶³å’Œç¼ºé™·äº†ã€‚è¿™æ˜¯å¿…ç„¶çš„ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ <code>xgo</code> æˆªæ­¢<code>1.0.37</code> ç‰ˆæœ¬ï¼Œæ€»å…±æœ‰å¤šå°‘è¡Œä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go">âœ  xgo git:(master) tokei .<br>===============================================================================<br> Language            Files        Lines         Code     Comments       Blanks<br>===============================================================================<br> BASH                    <span class="hljs-number">1</span>          <span class="hljs-number">104</span>           <span class="hljs-number">81</span>           <span class="hljs-number">11</span>           <span class="hljs-number">12</span><br> CSS                     <span class="hljs-number">1</span>          <span class="hljs-number">153</span>          <span class="hljs-number">118</span>            <span class="hljs-number">5</span>           <span class="hljs-number">30</span><br> Go                    <span class="hljs-number">369</span>        <span class="hljs-number">33232</span>        <span class="hljs-number">26836</span>         <span class="hljs-number">2588</span>         <span class="hljs-number">3808</span><br> JavaScript              <span class="hljs-number">1</span>          <span class="hljs-number">170</span>          <span class="hljs-number">146</span>           <span class="hljs-number">10</span>           <span class="hljs-number">14</span><br> JSON                    <span class="hljs-number">2</span>          <span class="hljs-number">435</span>          <span class="hljs-number">435</span>            <span class="hljs-number">0</span>            <span class="hljs-number">0</span><br> PowerShell              <span class="hljs-number">1</span>           <span class="hljs-number">28</span>           <span class="hljs-number">16</span>            <span class="hljs-number">3</span>            <span class="hljs-number">9</span><br> Shell                   <span class="hljs-number">3</span>          <span class="hljs-number">288</span>          <span class="hljs-number">251</span>            <span class="hljs-number">4</span>           <span class="hljs-number">33</span><br> SVG                     <span class="hljs-number">1</span>           <span class="hljs-number">41</span>           <span class="hljs-number">41</span>            <span class="hljs-number">0</span>            <span class="hljs-number">0</span><br> Plain Text              <span class="hljs-number">7</span>          <span class="hljs-number">192</span>            <span class="hljs-number">0</span>          <span class="hljs-number">174</span>           <span class="hljs-number">18</span><br>-------------------------------------------------------------------------------<br> HTML                    <span class="hljs-number">1</span>           <span class="hljs-number">19</span>           <span class="hljs-number">16</span>            <span class="hljs-number">3</span>            <span class="hljs-number">0</span><br> |- JavaScript           <span class="hljs-number">1</span>            <span class="hljs-number">6</span>            <span class="hljs-number">6</span>            <span class="hljs-number">0</span>            <span class="hljs-number">0</span><br> (Total)                             <span class="hljs-number">25</span>           <span class="hljs-number">22</span>            <span class="hljs-number">3</span>            <span class="hljs-number">0</span><br>-------------------------------------------------------------------------------<br> Markdown               <span class="hljs-number">17</span>         <span class="hljs-number">1455</span>            <span class="hljs-number">0</span>         <span class="hljs-number">1083</span>          <span class="hljs-number">372</span><br> |- Go                   <span class="hljs-number">8</span>          <span class="hljs-number">820</span>          <span class="hljs-number">635</span>           <span class="hljs-number">72</span>          <span class="hljs-number">113</span><br> |- JSON                 <span class="hljs-number">1</span>           <span class="hljs-number">80</span>           <span class="hljs-number">80</span>            <span class="hljs-number">0</span>            <span class="hljs-number">0</span><br> (Total)                           <span class="hljs-number">2355</span>          <span class="hljs-number">715</span>         <span class="hljs-number">1155</span>          <span class="hljs-number">485</span><br>===============================================================================<br> Total                 <span class="hljs-number">404</span>        <span class="hljs-number">36117</span>        <span class="hljs-number">27940</span>         <span class="hljs-number">3881</span>         <span class="hljs-number">4296</span><br>===============================================================================<br></code></pre></td></tr></table></figure><p>å…‰ Go ä»£ç å°±æœ‰ <strong>26836</strong> è¡Œäº†ã€‚æ‰€ä»¥å¯çŸ¥ <code>xgo</code>çš„ä½œè€…æ˜¯åšäº†å¾ˆå¤šçš„ä»˜å‡ºå’ŒåŠªåŠ›çš„ã€‚ä¸è¿‡æˆ‘ä»¬ç”¨äº†ä¸åˆ°ç™¾åˆ†ä¹‹ä¸€çš„ä»£ç é‡ï¼Œå°±å°†<code>xgo</code>æœ€æ ¸å¿ƒçš„åŸç†å±•ç¤ºå¾—æ·‹æ¼“å°½è‡´äº†ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è¿›ä¸€æ­¥é˜…è¯»<code>xgo</code> çš„æºç ï¼Œå¯ä»¥è¿›ä¸€æ­¥æ¢ç´¢å¦‚ä½•æŠ½è±¡å‡ºæ›´é€šç”¨æ›´ç®€æ´æ›´æ˜“æ‰©å±•çš„interceptorï¼Œå¦‚ä½•æ”¯æŒåç¨‹éš”ç¦»ï¼Œå¦‚ä½•ä¼˜åŒ–ä¾èµ–ç®¡ç†ï¼Œä»¥åŠå¦‚ä½•å®ç°å…¶ä»–çš„traceã€coverage åŠŸèƒ½ã€‚å†æ¬¡ä¸º <code>xgo</code> æ‰“ call ğŸ‘ï¼</p><h1 id="å‚è€ƒ">å‚è€ƒ</h1><ul><li><a href="https://github.com/xhd2015/xgo">xgo repo</a></li><li><ahref="https://docs.google.com/presentation/d/1U5yTdrUjnManxztzsMPGBAePrE3HvJcDtRjV6h3HelA/edit#slide=id.g2705943ae25_0_50">xgo:åŸºäºä»£ç é‡å†™å®ç° Monkey Patch å’Œ Trace</a></li><li><ahref="https://github.com/golang/go/tree/release-branch.go1.22/src/cmd/compile">gocompile README</a></li><li><ahref="https://blog.xhd2015.xyz/zh/posts/xgo-monkey-patching-in-go-using-toolexec/">xgo:åœ¨ go ä¸­ä½¿ç”¨-toolexec å®ç°çŒ´å­è¡¥ä¸</a></li></ul>]]></content>
    
    
    <summary type="html">xgo æ˜¯ä¸€ä¸ªé€šè¿‡ä»£ç é‡å†™æ¥å®ç° mockã€trace å’Œ coverage åŠŸèƒ½çš„å•å…ƒæµ‹è¯•æ¡†æ¶ã€‚æœ¬æ–‡å°†æ¢è®¨ xgo æœ€æ ¸å¿ƒçš„åº•å±‚åŸç† -toolexecï¼Œå¹¶é€šè¿‡ 6 ä¸ªç®€å•çš„å°é˜¶æ®µï¼Œä¸€æ­¥æ­¥å®ç°ä¸€ä¸ªä¸ç‰ˆ xgoï¼Œè¿›ä¸€æ­¥å±•ç¤º xgo çš„è®¾è®¡ç†å¿µã€‚</summary>
    
    
    
    <category term="Go" scheme="https://hedon.top/categories/Go/"/>
    
    <category term="å¼€æºé¡¹ç›®" scheme="https://hedon.top/categories/Go/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/"/>
    
    
    <category term="Go" scheme="https://hedon.top/tags/Go/"/>
    
    <category term="å¼€æºé¡¹ç›®" scheme="https://hedon.top/tags/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/"/>
    
    <category term="å•å…ƒæµ‹è¯•" scheme="https://hedon.top/tags/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>xgo ä½¿ç”¨ç»éªŒ</title>
    <link href="https://hedon.top/2024/05/21/go-xgo-use/"/>
    <id>https://hedon.top/2024/05/21/go-xgo-use/</id>
    <published>2024-05-21T08:32:51.000Z</published>
    <updated>2024-05-22T13:26:45.423Z</updated>
    
    <content type="html"><![CDATA[<h1 id="patch">Patch</h1><h2 id="mock-å‡½æ•°">mock å‡½æ•°</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">greet</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello &quot;</span> + s<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestPatchFunc</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>mock.Patch(greet, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock &quot;</span> + s<br>&#125;)<br><br>res := greet(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;mock world&quot;</span> &#123;<br>t.Fatalf(<span class="hljs-string">&quot;expteced mock world got %s&quot;</span>, res)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="mock-å˜é‡">mock å˜é‡</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> value = <span class="hljs-string">&quot;hello&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">greet</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> value + s<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestPatchVar</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>mock.Patch(&amp;value, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock &quot;</span><br>&#125;)<br>res := greet(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;mock world&quot;</span> &#123;<br>t.Fatalf(<span class="hljs-string">&quot;expteced mock world got %s&quot;</span>, res)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestPatchVarByName</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>mock.PatchByName(<span class="hljs-string">&quot;learn-xgo/api&quot;</span>, <span class="hljs-string">&quot;value&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mock &quot;</span><br>&#125;)<br>res := greet2(<span class="hljs-string">&quot;world&quot;</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;mock world&quot;</span> &#123;<br>t.Fatalf(<span class="hljs-string">&quot;expteced mock world got %s&quot;</span>, res)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="mock">Mock</h1><blockquote><p>å› æ­¤ï¼Œå½“å‡½æ•°å«æœ‰æœªå¯¼å‡ºç±»å‹æ—¶ï¼Œ<code>Patch</code>æ— æ³•ä½¿ç”¨ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨ <code>Mock</code>ã€‚</p></blockquote><h2 id="mockbyname">MockByName</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// learn-xgo/funcs/funcs.go</span><br><span class="hljs-keyword">package</span> funcs<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CallUnexportedFunc</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> unexportedFunc(s)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">unexportedFunc</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;origin unexported func, your msg is &quot;</span> + s<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// learn-xgo/api/mock_test.go</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestMockByName</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>mock.MockByName(<span class="hljs-string">&quot;learn-xgo/funcs&quot;</span>, <span class="hljs-string">&quot;unexportedFunc&quot;</span>,<br><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, fn *core.FuncInfo, args core.Object, results core.Object)</span></span> <span class="hljs-type">error</span> &#123;<br>results.GetFieldIndex(<span class="hljs-number">0</span>).Set(<span class="hljs-string">&quot;mock funcs &quot;</span> + args.GetFieldIndex(<span class="hljs-number">0</span>).Value().(<span class="hljs-type">string</span>))<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;)<br><br>msg := funcs.CallUnexportedFunc(<span class="hljs-string">&quot;hedon&quot;</span>)<br><span class="hljs-keyword">if</span> msg != <span class="hljs-string">&quot;mock funcs hedon&quot;</span> &#123;<br>t.Fatalf(<span class="hljs-string">&quot;expteced `mock funcs hedon` got %s&quot;</span>, msg)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">x</summary>
    
    
    
    <category term="Go" scheme="https://hedon.top/categories/Go/"/>
    
    <category term="å¼€æºé¡¹ç›®" scheme="https://hedon.top/categories/Go/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/"/>
    
    
    <category term="Go" scheme="https://hedon.top/tags/Go/"/>
    
    <category term="å¼€æºé¡¹ç›®" scheme="https://hedon.top/tags/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/"/>
    
    <category term="å•å…ƒæµ‹è¯•" scheme="https://hedon.top/tags/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>Kafka è´Ÿè½½å‡è¡¡æŒ‘æˆ˜åŠè§£å†³æ€è·¯</title>
    <link href="https://hedon.top/2024/05/20/kafka-load-balance/"/>
    <id>https://hedon.top/2024/05/20/kafka-load-balance/</id>
    <published>2024-05-20T02:37:10.000Z</published>
    <updated>2024-05-21T14:41:10.216Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡è½¬è½½è‡ª Agoda Engineeringï¼Œä»‹ç»äº†åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¦‚ä½•åº”å¯¹ Kafkaè´Ÿè½½å‡è¡¡æ‰€é‡åˆ°çš„å„ç§æŒ‘æˆ˜ï¼Œå¹¶æå‡ºç›¸åº”çš„è§£å†³æ€è·¯ã€‚æœ¬æ–‡ç®€è¦é˜è¿°äº† Kafkaçš„å¹¶è¡Œæ€§æœºåˆ¶ã€å¸¸ç”¨çš„åˆ†åŒºç­–ç•¥ä»¥åŠåœ¨å®é™…æ“ä½œä¸­é‡åˆ°çš„å¼‚æ„ç¡¬ä»¶ã€ä¸å‡åŒ€å·¥ä½œè´Ÿè½½ç­‰é—®é¢˜ã€‚é€šè¿‡æ·±å…¥åˆ†æè¿™äº›æŒ‘æˆ˜ï¼Œå¹¶æä¾›å…·ä½“çš„è§£å†³æ–¹æ¡ˆï¼Œæœ¬æ–‡æ—¨åœ¨å¸®åŠ©è¯»è€…æ›´å¥½åœ°ç†è§£å’Œåº”ç”¨Kafka çš„è´Ÿè½½å‡è¡¡æŠ€æœ¯ï¼Œä»è€Œæé«˜ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½å’Œç¨³å®šæ€§ã€‚</p><p>ä»¥ä¸‹å¤§éƒ¨åˆ†å†…å®¹ç¿»è¯‘è‡ªåŸæ–‡ <ahref="https://medium.com/agoda-engineering/how-we-solve-load-balancing-challenges-in-apache-kafka-8cd88fdad02b">how-we-solve-load-balancing-challenges-in-apache-kafka</a>ï¼Œå¹¶å·²è·å¾—åŸä½œè€…åŒæ„ã€‚</p><h1 id="æ€ç»´å¯¼å›¾">æ€ç»´å¯¼å›¾</h1><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/Kafka%20%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.png"alt="Kafka è´Ÿè½½å‡è¡¡è§£å†³æ–¹æ¡ˆ" /><figcaption aria-hidden="true">Kafka è´Ÿè½½å‡è¡¡è§£å†³æ–¹æ¡ˆ</figcaption></figure><h1 id="kafka-å¹¶è¡Œæ€§">Kafka å¹¶è¡Œæ€§</h1><p>Kafkaé€šè¿‡åˆ†åŒºæ¥å®ç°å¹¶è¡Œæ€§ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç”Ÿäº§è€…ï¼ˆProducerï¼‰äº§ç”Ÿçš„æ¶ˆæ¯ä¼šæŒ‰ç…§ä¸€å®šçš„åˆ†åŒºç­–ç•¥åˆ†é…åˆ°å¤šä¸ªåˆ†åŒºï¼ˆPartitionï¼‰ä¸­ï¼Œæ¶ˆè´¹ç»„ä¸­çš„æ¯ä¸ªæ¶ˆè´¹è€…ä¼šåˆ†åˆ«è´Ÿè´£æ¶ˆè´¹å…¶ä¸­çš„è‹¥å¹²ä¸ªåˆ†åŒºã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/0*ixosAmhBDsyBBhoS.png"alt="Kafka åˆ†åŒºæ¼”ç¤º" /><figcaption aria-hidden="true">Kafka åˆ†åŒºæ¼”ç¤º</figcaption></figure><p>åˆ†åŒºç­–ç•¥ï¼š</p><ul><li>è½®è¯¢ï¼ˆRound Robinï¼‰ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼ŒKafkaä½¿ç”¨è½®è¯¢ç­–ç•¥å°†æ¶ˆæ¯å‡åŒ€åœ°åˆ†é…åˆ°æ‰€æœ‰åˆ†åŒºã€‚</li><li>å“ˆå¸Œï¼ˆKey Hashingï¼‰ï¼šå¦‚æœæ¶ˆæ¯æœ‰åˆ†åŒºé”®ï¼ŒKafkaä¼šå¯¹é”®è¿›è¡Œå“ˆå¸Œè®¡ç®—ï¼Œå°†æ¶ˆæ¯åˆ†é…åˆ°ç‰¹å®šçš„åˆ†åŒºã€‚</li><li>è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥ï¼šå¼€å‘è€…å¯ä»¥å®ç°è‡ªå®šä¹‰çš„åˆ†åŒºå™¨ï¼ˆPartitionerï¼‰é€»è¾‘ï¼Œä»¥æ»¡è¶³ç‰¹å®šéœ€æ±‚ã€‚</li></ul><p>å¦‚æœè¦ä½¿ç”¨è½®è¯¢æˆ–è€…å“ˆå¸Œç­–ç•¥æ¥è¾¾åˆ°â€œè´Ÿè½½å‡è¡¡â€çš„ç›®çš„ï¼Œé‚£ä¹ˆéœ€è¦æ»¡è¶³ä»¥ä¸‹ 2ä¸ªå‡è®¾ï¼š</p><ol type="1"><li>æ¶ˆè´¹è€…æ‹¥æœ‰ç›¸åŒçš„å¤„ç†èƒ½åŠ›ï¼Œ</li><li>æ¶ˆæ¯çš„å·¥ä½œé‡ç›¸ç­‰ã€‚</li></ol><p>ç„¶è€Œï¼Œåœ¨å®è·µä¸­ï¼Œè¿™äº›å‡è®¾å¾€å¾€ä¸æˆç«‹ã€‚</p><h1 id="ç°å®æŒ‘æˆ˜">ç°å®æŒ‘æˆ˜</h1><h2 id="å¼‚æ„ç¡¬ä»¶">1. å¼‚æ„ç¡¬ä»¶</h2><p>ä¸åŒä»£çš„æœåŠ¡å™¨ç¡¬ä»¶æ€§èƒ½ä¸åŒï¼Œå¯¼è‡´å¤„ç†é€Ÿç‡å­˜åœ¨å·®å¼‚ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ä¸åŒä»£ç¡¬ä»¶è¿›è¡Œå¤„ç†çš„åŸºå‡†æ˜¾ç¤ºæ€§èƒ½å­˜åœ¨æ˜¾ç€å·®å¼‚ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/1*B6svY0ZjYVy-uJ7ZA18Jtg.png"alt="ä¸åŒæœåŠ¡å™¨å¤„ç†é€Ÿç‡å·®å¼‚ä¸¾ä¾‹" /><figcaption aria-hidden="true">ä¸åŒæœåŠ¡å™¨å¤„ç†é€Ÿç‡å·®å¼‚ä¸¾ä¾‹</figcaption></figure><h2 id="æ¯æ¡-kafka-æ¶ˆæ¯çš„å·¥ä½œè´Ÿè½½ä¸å‡åŒ€">2. æ¯æ¡ Kafkaæ¶ˆæ¯çš„å·¥ä½œè´Ÿè½½ä¸å‡åŒ€</h2><p>ä¸‹å›¾æ˜¾ç¤ºäº†åœ¨ä¸€ä¸ªæ—¶é—´çª—å£å†…åˆ°è¾¾çš„ 12æ¡æ¶ˆæ¯ã€‚åœ¨è¿™é‡Œï¼Œç”Ÿäº§è€…å‘è¯¥ä¸»é¢˜ä¸­çš„å…­ä¸ªåˆ†åŒºä¸­çš„æ¯ä¸€ä¸ªå‘å¸ƒä¸¤æ¡æ¶ˆæ¯ã€‚å› æ­¤ï¼Œæ¯ä¸ªworker æ¶ˆè€—æ¥è‡ª 2 ä¸ªåˆ†åŒºçš„æ•°æ®ï¼Œè¿™æ„å‘³ç€æ¯ä¸ª worker éœ€è¦å¤„ç† 4æ¡æ¶ˆæ¯ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/0*VwPda5gNsHRL2tJV.png"alt="ä½¿ç”¨å¾ªç¯åˆ†åŒºå™¨å’Œå¾ªç¯åˆ†é…å™¨æ¥åˆ†å‘æ¶ˆæ¯çš„å…ˆå‰ä¾›åº”ç³»ç»Ÿçš„æ¼”ç¤ºã€‚æ¯ä¸ª worker éƒ½åˆ†é…æœ‰ç›¸åŒæ•°é‡çš„æ¶ˆæ¯ã€‚" /><figcaptionaria-hidden="true">ä½¿ç”¨å¾ªç¯åˆ†åŒºå™¨å’Œå¾ªç¯åˆ†é…å™¨æ¥åˆ†å‘æ¶ˆæ¯çš„å…ˆå‰ä¾›åº”ç³»ç»Ÿçš„æ¼”ç¤ºã€‚æ¯ä¸ªworker éƒ½åˆ†é…æœ‰ç›¸åŒæ•°é‡çš„æ¶ˆæ¯ã€‚</figcaption></figure><p>ä¸åŒçš„æ¶ˆæ¯å¯èƒ½éœ€è¦ä¸åŒçš„å¤„ç†æ­¥éª¤é›†ã€‚ä¾‹å¦‚ï¼Œå¤„ç†æ¶ˆæ¯å¯èƒ½æ¶‰åŠè°ƒç”¨ç¬¬ä¸‰æ–¹HTTPç«¯ç‚¹ï¼Œå¹¶ä¸”ä¸åŒçš„å“åº”å¤§å°æˆ–å»¶è¿Ÿå¯èƒ½ä¼šå½±å“å¤„ç†é€Ÿç‡ã€‚æ­¤å¤–ï¼Œå¯¹äºæ¶‰åŠæ•°æ®åº“æ“ä½œçš„åº”ç”¨ç¨‹åºï¼Œå…¶æ•°æ®åº“æŸ¥è¯¢çš„å»¶è¿Ÿå¯èƒ½ä¼šæ ¹æ®æŸ¥è¯¢å‚æ•°è€Œæ³¢åŠ¨ï¼Œä»è€Œå¯¼è‡´å¤„ç†é€Ÿç‡å‘ç”Ÿå˜åŒ–ã€‚</p><h2 id="è¿‡åº¦é…ç½®é—®é¢˜">3. è¿‡åº¦é…ç½®é—®é¢˜</h2><p>ç”±äºå·¥ä½œè´Ÿè½½å’Œå¤„ç†æ•ˆç‡ä¸åŒï¼Œä¸ºäº†è¾¾åˆ°ç³»ç»Ÿååé‡çš„éœ€æ±‚ï¼Œå¯èƒ½ä¼šå‡ºç°è¿‡åº¦é…ç½®é—®é¢˜ï¼Œä»è€Œå¯¼è‡´èµ„æºæµªè´¹ã€‚</p><p>å‡è®¾æˆ‘ä»¬çš„é«˜ååé‡å’Œä½ååé‡çš„å¤„ç†é€Ÿç‡åˆ†åˆ«ä¸º 20 msg/s å’Œ 10msg/sï¼ˆæ ¹æ®è¡¨ 1ä¸­çš„æ•°æ®è¿›è¡Œç®€åŒ–ï¼‰ã€‚ä½¿ç”¨ä¸¤ä¸ªè¾ƒå¿«çš„å¤„ç†å™¨å’Œä¸€ä¸ªè¾ƒæ…¢çš„å¤„ç†å™¨ï¼Œæˆ‘ä»¬é¢„è®¡æ€»å®¹é‡ä¸º20+20+10 = 50æ¡æ¶ˆæ¯/ç§’ã€‚ä½†æ˜¯ï¼Œå½“ä¿æŒæ¶ˆæ¯çš„å¾ªç¯åˆ†é…æ—¶ï¼Œæˆ‘ä»¬æ— æ³•è¾¾åˆ°æ­¤å®¹é‡ã€‚ä¸‹å›¾æ˜¾ç¤ºäº†å¦‚æœæµé‡æŒç»­è¾¾åˆ°æ¯ç§’50 æ¡æ¶ˆæ¯æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/0*P-Qa3gyPgXtIeZMx.png"alt="å¦‚æœä¼ å…¥æµé‡ä¿æŒåœ¨ 50 æ¡æ¶ˆæ¯/ç§’ï¼Œåˆ™æ…¢é€Ÿå¤„ç†å™¨æ— æ³•å¤„ç†æ€»ä½“æ¶ˆæ¯ 1/3 çš„è´Ÿè½½ï¼Œä»è€Œå¯¼è‡´ç´¯ç§¯å»¶è¿Ÿã€‚ä¸ºäº†é¿å…é«˜å»¶è¿Ÿï¼Œå‘è¯¥ç³»ç»Ÿæ·»åŠ äº†é¢å¤–çš„èµ„æºä»¥ç»´æŒå¤„ç†ã€‚" /><figcaption aria-hidden="true">å¦‚æœä¼ å…¥æµé‡ä¿æŒåœ¨ 50æ¡æ¶ˆæ¯/ç§’ï¼Œåˆ™æ…¢é€Ÿå¤„ç†å™¨æ— æ³•å¤„ç†æ€»ä½“æ¶ˆæ¯ 1/3çš„è´Ÿè½½ï¼Œä»è€Œå¯¼è‡´ç´¯ç§¯å»¶è¿Ÿã€‚ä¸ºäº†é¿å…é«˜å»¶è¿Ÿï¼Œå‘è¯¥ç³»ç»Ÿæ·»åŠ äº†é¢å¤–çš„èµ„æºä»¥ç»´æŒå¤„ç†ã€‚</figcaption></figure><p>ä»è¿™ä¸ªä¾‹å­ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬çš„å¤„ç†å™¨æœåŠ¡ä¸€æ¬¡æœ€å¤šåªèƒ½æ¥å— 30æ¡æ¶ˆæ¯ï¼Œä»¥é˜²æ­¢æ»åå¹¶ç¡®ä¿åŠæ—¶ä¼ é€’æ›´æ–°ã€‚</p><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¦å®é™…æ¯ç§’å¤„ç† 50 æ¡æ¶ˆæ¯ï¼Œæˆ‘ä»¬å¿…é¡»æ€»å…±æ‰©å±•åˆ° 5å°æœºå™¨ï¼Œä»¥ä¿è¯åŠæ—¶å¤„ç†æ‰€æœ‰æ¶ˆæ¯ã€‚ç”±äºè¿™ç§ä¸é€‚å½“çš„åˆ†é…é€»è¾‘ï¼ˆ66.7ï¼…çš„è¿‡åº¦é…ç½®ï¼‰ï¼Œæˆ‘ä»¬ä¼šå‘è¯¥ç³»ç»Ÿè¿‡åº¦é…ç½®é¢å¤–çš„ä¸¤å°æœºå™¨ã€‚</p><p>ä¸ºäº†æ¯ç§’å¤„ç† 50æ¡æ¶ˆæ¯ï¼Œæˆ‘ä»¬éœ€è¦æ‰©å±•åˆ°äº”å°æœºå™¨ä»¥ç¡®ä¿åŠæ—¶å¤„ç†æ‰€æœ‰æ¶ˆæ¯ã€‚ç”±äºè¿™ç§ä¸é€‚å½“çš„åˆ†é…é€»è¾‘ï¼ˆ66.7%çš„è¿‡åº¦é…ç½®ï¼‰ï¼Œè¿™ä¼šå¯¼è‡´å‘è¯¥ç³»ç»Ÿè¿‡åº¦é…ç½®ä¸¤å°é¢å¤–çš„æœºå™¨ã€‚</p><h1 id="é™æ€è§£å†³æ–¹æ¡ˆ">é™æ€è§£å†³æ–¹æ¡ˆ</h1><h2 id="åœ¨ç›¸åŒçš„-podæœºå™¨ä¸Šéƒ¨ç½²">1. åœ¨ç›¸åŒçš„ Podï¼ˆæœºå™¨ï¼‰ä¸Šéƒ¨ç½²</h2><p>è€ƒè™‘æ§åˆ¶æœåŠ¡éƒ¨ç½²ä¸­ä½¿ç”¨çš„ç¡¬ä»¶ç±»å‹ä»¥ç¼“è§£é—®é¢˜ã€‚å¦‚æœæ‚¨åœ¨è™šæ‹Ÿæœºä¸Šéƒ¨ç½²æœåŠ¡å¹¶æ‹¥æœ‰å……è¶³çš„èµ„æºå’Œæ€§èƒ½ç›¸åŒçš„ç¡¬ä»¶ï¼Œåˆ™æ­¤æ–¹æ³•æ˜¯å¯è¡Œçš„ã€‚</p><p>ç„¶è€Œï¼Œç”±äºæˆæœ¬æ•ˆç›Šå’Œçµæ´»æ€§ä¸‹é™ï¼Œåœ¨ç§æœ‰äº‘ç¯å¢ƒä¸­é€šå¸¸ä¸å»ºè®®é‡‡ç”¨è¿™ç§ç­–ç•¥ï¼Œä¸»è¦æ˜¯å› ä¸ºåŒæ—¶å‡çº§æ‰€æœ‰ç°æœ‰ç¡¬ä»¶å¯èƒ½å…·æœ‰æŒ‘æˆ˜æ€§ã€‚å¦‚æœå®ƒéå¸¸é€‚åˆæ‚¨çš„æƒ…å†µï¼Œåˆ™å¯ä»¥ä½¿ç”¨<ahref="https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/">Kuberneteså…³è”æ€§å°† Pod åˆ†é…ç»™æŸäº›ç±»å‹çš„èŠ‚ç‚¹ã€‚</a></p><h2 id="åŠ æƒè´Ÿè½½å‡è¡¡">2. åŠ æƒè´Ÿè½½å‡è¡¡</h2><p>å¦‚æœå®¹é‡æ˜¯å¯é¢„æµ‹çš„å¹¶ä¸”å¤§éƒ¨åˆ†æ—¶é—´ä¿æŒé™æ€ï¼Œåˆ™ä¸ºä¸åŒçš„æ¶ˆè´¹è€…åˆ†é…ä¸åŒçš„æƒé‡å¯ä»¥å¸®åŠ©æœ€å¤§é™åº¦åœ°åˆ©ç”¨å¯ç”¨èµ„æºã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸ºè¡¨ç°è¾ƒå¥½çš„æ¶ˆè´¹è€…èµ‹äºˆæ›´é«˜çš„æƒé‡åï¼Œæˆ‘ä»¬å¯ä»¥å°†æ›´å¤šæµé‡è·¯ç”±ç»™è¿™äº›æ¶ˆè´¹è€…ã€‚</p><h1 id="åŠ¨æ€è§£å†³æ–¹æ¡ˆ">åŠ¨æ€è§£å†³æ–¹æ¡ˆ</h1><p>è™½ç„¶æˆ‘ä»¬å¯ä»¥ä¼°è®¡æ¶ˆæ¯çš„å®¹é‡å’Œå·¥ä½œè´Ÿè½½æ¥è®¾è®¡é™æ€è§„åˆ™æ¥ç¡®å®šåŠ æƒè´Ÿè½½å¹³è¡¡ç­–ç•¥ï¼Œä½†ç”±äºä»¥ä¸‹å‡ ä¸ªå› ç´ ï¼Œè¿™ç§æ–¹æ³•åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­å¯èƒ½å¹¶ä¸æ€»æ˜¯å¯è¡Œï¼š</p><ul><li>æ¶ˆæ¯çš„å·¥ä½œè´Ÿè½½å¹¶ä¸ç»Ÿä¸€ï¼Œè¿™ä½¿å¾—ä¼°è®¡æœºå™¨å®¹é‡å˜å¾—å›°éš¾ã€‚</li><li>ä¾èµ–å…³ç³»ï¼ˆä¾‹å¦‚ç½‘ç»œå’Œç¬¬ä¸‰æ–¹è¿æ¥ï¼‰ä¸ç¨³å®šï¼Œæœ‰æ—¶ä¼šå¯¼è‡´å®é™…å¤„ç†ä¸­çš„å®¹é‡å‘ç”Ÿå˜åŒ–ã€‚</li><li>è¯¥ç³»ç»Ÿç»å¸¸æ·»åŠ æ–°åŠŸèƒ½ï¼Œå¢åŠ é¢å¤–çš„ç»´æŠ¤å·¥ä½œä»¥ä¿æŒæƒé‡æ›´æ–°ã€‚</li></ul><p>ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥åŠ¨æ€ç›‘æ§æ¯ä¸ªåˆ†åŒºä¸­çš„å½“å‰æ»åå¹¶æ ¹æ®å½“å‰æµé‡çŠ¶å†µåšå‡ºç›¸åº”å“åº”ã€‚</p><p>æœ‰ 2 ç§æ€è·¯ï¼š</p><ol type="1"><li><strong>ç”Ÿäº§è€…è§’åº¦</strong>ï¼šä½¿ç”¨è‡ªå®šä¹‰ç®—æ³•æ ¹æ®æ»åçš„æ¶ˆæ¯æ•°é‡æ¥ç¡®å®šæ¯ä¸ªåˆ†åŒºçš„æµé‡ï¼Œè¿™ç§ç”Ÿäº§è€…ç§°ä¸ºæ»åæ„ŸçŸ¥ç”Ÿäº§è€…ï¼ˆLag-awareProducerï¼‰ã€‚</li><li><strong>æ¶ˆè´¹è€…è§’åº¦</strong>ï¼šè¿™äº›æ¶ˆè´¹è€…æ—¨åœ¨ç›‘æ§å½“å‰æ»åçš„æ¶ˆæ¯æ•°é‡ï¼Œå¹¶å¯ä»¥åœ¨å¿…è¦æ—¶å–æ¶ˆè®¢é˜…ä»¥è§¦å‘è´Ÿè½½é‡æ–°å¹³è¡¡ã€‚é€šå¸¸ï¼Œå¯ä»¥é‡‡ç”¨è‡ªå®šä¹‰çš„é‡æ–°å¹³è¡¡ç­–ç•¥æ¥è°ƒæ•´åˆ†åŒºåˆ†é…ã€‚è¿™ç§æ¶ˆè´¹è€…ç§°ä¸ºæ»åæ„ŸçŸ¥æ¶ˆè´¹è€…ï¼ˆLag-awareComsumerï¼‰ã€‚</li></ol><h2 id="ä»ç”Ÿäº§è€…è§’åº¦å‡ºå‘">1. ä»ç”Ÿäº§è€…è§’åº¦å‡ºå‘</h2><p>å¦‚æ­¤å›¾æ‰€ç¤ºï¼Œç”Ÿäº§è€…å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰ç®—æ³•æ ¹æ®æ»åç¡®å®šæ¯ä¸ªåˆ†åŒºçš„æµé‡ã€‚ä¸ºäº†å‡å°‘å¯¹Kafkaä»£ç†çš„è°ƒç”¨æ¬¡æ•°ï¼Œç³»ç»Ÿå¯ä»¥ç»´æŠ¤ä¸€ä¸ªå†…éƒ¨å»¶è¿Ÿç¼“å­˜ï¼Œè€Œä¸æ˜¯åœ¨å‘å¸ƒæ¯æ¡æ¶ˆæ¯ä¹‹å‰è°ƒç”¨Kafka ä»£ç†ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/0*Mg1lxKzMTy7LRAXT.png"alt="åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œåˆ†åŒº 4 å’Œ 6 çš„å»¶è¿Ÿæ¯”å…¶ä»–åˆ†åŒºé«˜å¾—å¤šã€‚åº”å‡å°‘ä»å†…éƒ¨ç”Ÿäº§è€…å‘é€åˆ°è¿™äº›åˆ†åŒºçš„æµé‡ã€‚" /><figcaption aria-hidden="true">åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œåˆ†åŒº 4 å’Œ 6çš„å»¶è¿Ÿæ¯”å…¶ä»–åˆ†åŒºé«˜å¾—å¤šã€‚åº”å‡å°‘ä»å†…éƒ¨ç”Ÿäº§è€…å‘é€åˆ°è¿™äº›åˆ†åŒºçš„æµé‡ã€‚</figcaption></figure><p>ä½¿ç”¨æ»åæ•°æ®ï¼Œå®šåˆ¶çš„ç®—æ³•è¢«è®¾è®¡ä¸ºå‘ç»å†é«˜æ»åçš„åˆ†åŒºå‘å¸ƒæ›´å°‘çš„æµé‡ï¼Œå‘ä½æ»åçš„åˆ†åŒºå‘å¸ƒæ›´å¤šæµé‡ï¼Œä»¥å¹³è¡¡æ¯ä¸ªåˆ†åŒºä¸Šçš„å·¥ä½œè´Ÿè½½ã€‚å½“æ»åå¹³è¡¡ä¸”ç¨³å®šæ—¶ï¼Œæ­¤æ–¹æ³•åº”ç¡®ä¿æ¶ˆæ¯çš„å‡åŒ€åˆ†å¸ƒã€‚</p><p>ä¸é€‚ç”¨æƒ…å†µï¼š</p><ol type="1"><li><strong>çº¯æ¶ˆè´¹è€…åº”ç”¨ç¨‹åº</strong>ï¼šæ‚¨çš„åº”ç”¨ç¨‹åºä¸æ§åˆ¶æ¶ˆæ¯ç”Ÿæˆã€‚</li><li><strong>å¤šä¸ªæ¶ˆè´¹è€…ç»„ï¼š</strong>å½“ç”Ÿæˆçš„æ¶ˆæ¯è¢«å¤šä¸ªæ¶ˆè´¹è€…ç»„æ¶ˆè´¹æ—¶ï¼Œç”Ÿäº§è€…å¯èƒ½ä¼šä¸ºå…¶ä»–æ¶ˆè´¹è€…ç»„äº§ç”Ÿä¸å¿…è¦çš„å€¾æ–œè´Ÿè½½ï¼Œå› ä¸ºæ»ååªæ˜¯ç‰¹å®šäºä¸€ä¸ªæ¶ˆè´¹è€…ç»„çš„ä¿¡æ¯ã€‚</li></ol><h3 id="ç›¸åŒé˜Ÿåˆ—é•¿åº¦ç®—æ³•">ç›¸åŒé˜Ÿåˆ—é•¿åº¦ç®—æ³•</h3><p>è¯¥ç®—æ³•å°†æ¯ä¸ªåˆ†åŒºæ»åè§†ä¸ºå¤„ç†çš„é˜Ÿåˆ—å¤§å°ã€‚è·å–æ»åä¿¡æ¯åï¼Œå®ƒä¼šå‘å¸ƒé€‚å½“æ•°é‡çš„æ¶ˆæ¯ä»¥å¡«å……çŸ­é˜Ÿåˆ—ã€‚æ­¤æ–¹æ³•æ›´é€‚åˆç”±äºå¼‚æ„ç¡¬ä»¶è€Œå¯¼è‡´çš„å€¾æ–œæ»ååˆ†å¸ƒï¼Œå…¶ä¸­é«˜æ€§èƒ½Podï¼ˆæœºå™¨ï¼‰åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹èƒ½å¤Ÿæ›´å¿«åœ°å¤„ç†ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/0*zp-S1Y_GbIzbjCX4.png"alt="ç›¸åŒé˜Ÿåˆ—é•¿åº¦ç®—æ³•çš„æ¼”ç¤ºã€‚æœ€åˆï¼Œä¸åŒé˜Ÿåˆ—çš„é•¿åº¦ä¸åŒã€‚è¯¥ç®—æ³•å°è¯•ç”Ÿæˆä¸åŒæ•°é‡çš„æ¶ˆæ¯ï¼Œä»¥åœ¨æ‰€æœ‰é˜Ÿåˆ—ä¸­å®ç°ç›¸åŒçš„é˜Ÿåˆ—é•¿åº¦ã€‚è¿™é‡Œï¼Œé˜Ÿåˆ—é•¿åº¦å’Œ Kafka lag æ˜¯åŒä¸€ä¸ªæ¦‚å¿µï¼Œä»£è¡¨å°šæœªå¤„ç†çš„æ¶ˆæ¯æ•°é‡" /><figcaptionaria-hidden="true">ç›¸åŒé˜Ÿåˆ—é•¿åº¦ç®—æ³•çš„æ¼”ç¤ºã€‚æœ€åˆï¼Œä¸åŒé˜Ÿåˆ—çš„é•¿åº¦ä¸åŒã€‚è¯¥ç®—æ³•å°è¯•ç”Ÿæˆä¸åŒæ•°é‡çš„æ¶ˆæ¯ï¼Œä»¥åœ¨æ‰€æœ‰é˜Ÿåˆ—ä¸­å®ç°ç›¸åŒçš„é˜Ÿåˆ—é•¿åº¦ã€‚è¿™é‡Œï¼Œé˜Ÿåˆ—é•¿åº¦å’ŒKafka lag æ˜¯åŒä¸€ä¸ªæ¦‚å¿µï¼Œä»£è¡¨å°šæœªå¤„ç†çš„æ¶ˆæ¯æ•°é‡</figcaption></figure><h3 id="å¼‚å¸¸å€¼æ£€æµ‹ç®—æ³•">å¼‚å¸¸å€¼æ£€æµ‹ç®—æ³•</h3><p>è¯¥ç®—æ³•åˆ©ç”¨ç»Ÿè®¡æ–¹æ³•æ¥ç¡®å®šæ‰€æœ‰åˆ†åŒºçš„ä¸Šç¦»ç¾¤å€¼ï¼Œå¹¶æš‚æ—¶åœæ­¢é‚£äº›æ…¢é€Ÿç¦»ç¾¤å€¼çš„å‘å¸ƒè¿‡ç¨‹ã€‚åœ¨åŸæ–‡ç« ä¸­ï¼Œé’ˆå¯¹Agoda çš„ç‰¹å®šéœ€æ±‚ï¼Œä»–ä»¬æå‡ºäº† IQRï¼ˆå››åˆ†ä½è·ï¼‰å’ŒSTDï¼ˆæ ‡å‡†å·®ï¼‰å¼‚å¸¸å€¼æ£€æµ‹ç®—æ³•ã€‚ç®—æ³•æµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤ºã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/0*pjkj5kF6aFcWwBwU.png"alt="å¼‚å¸¸å€¼æ£€æŸ¥ç®—æ³•æµç¨‹" /><figcaption aria-hidden="true">å¼‚å¸¸å€¼æ£€æŸ¥ç®—æ³•æµç¨‹</figcaption></figure><ul><li><strong>æ…¢é€Ÿåˆ†åŒºï¼š</strong>ï¼ˆå·²å…³é—­ï¼‰ç”±äºå­˜åœ¨å»¶è¿Ÿï¼Œè¿™äº›åˆ†åŒºçš„æ¶ˆæ¯ç”Ÿæˆå·²åœæ­¢ã€‚</li><li><strong>å¥½çš„åˆ†åŒº</strong>ï¼šï¼ˆæ‰“å¼€ï¼‰ç…§å¸¸å‘å¸ƒå¹¶å‡åŒ€åˆ†å‘åˆ°æ‰€æœ‰å¥½çš„åˆ†åŒºã€‚</li><li><strong>OKåˆ†åŒºï¼š</strong>ï¼ˆè§‚å¯Ÿ/åŠå¼€æ”¾ï¼‰ä¸ºäº†æé«˜æ€§èƒ½ä¸ä½³çš„æœºå™¨çš„æ€§èƒ½ï¼Œå½“ç³»ç»Ÿå°è¯•å°†æ…¢é€Ÿåˆ†åŒºæå‡ä¸ºè‰¯å¥½åˆ†åŒºæ—¶ï¼Œä¼šæ·»åŠ ä¸€ä¸ªè§‚å¯ŸæœŸã€‚é€šè¿‡ä»…ç”Ÿæˆä¸€å°éƒ¨åˆ†æ¶ˆæ¯å¹¶è¿›è¡Œè§‚å¯Ÿï¼Œå¯ä»¥å°†è¯¥è§‚å¯Ÿé˜¶æ®µä¼˜åŒ–ä¸ºâ€œåŠå¼€æ”¾â€çŠ¶æ€ã€‚å½“æ»åè·å–é—´éš”ç›¸å¯¹è¾ƒé•¿æ—¶ï¼ŒåŠå¼€æ”¾æ˜¯æœ‰ç›Šçš„ï¼Œå› ä¸ºå®ƒå¯ä»¥é˜²æ­¢æ¶ˆè´¹è€…å»¶è¿Ÿç­‰å¾…ä¼ å…¥æ¶ˆæ¯è€Œæ›´æ–°çš„æ»åæ•°æ®å°šæœªæŸ¥è¯¢çš„æƒ…å†µã€‚</li></ul><h2 id="ä»æ¶ˆè´¹è€…è§’åº¦å‡ºå‘">2. ä»æ¶ˆè´¹è€…è§’åº¦å‡ºå‘</h2><p>è¿™é‡Œ Adogaæå‡ºçš„æ€è·¯æ˜¯ï¼š<strong>é‡åˆ°é«˜å»¶è¿Ÿçš„å®ä¾‹å¯ä»¥ä¸»åŠ¨å–æ¶ˆè®¢é˜…ä¸»é¢˜ä»¥è§¦å‘é‡æ–°å¹³è¡¡ã€‚åœ¨é‡æ–°å¹³è¡¡æœŸé—´ï¼Œå¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰çš„åˆ†é…å™¨æ¥å¹³è¡¡æ‰€æœ‰æ¶ˆè´¹è€…å®ä¾‹ä¹‹é—´çš„åˆ†åŒºã€‚</strong></p><p>è§¦å‘é‡æ–°å¹³è¡¡çš„æˆæœ¬éå¸¸æ˜‚è´µï¼Œå› ä¸ºæ€¥åˆ‡çš„é‡æ–°å¹³è¡¡ä¼šåœæ­¢æ¶ˆè´¹è€…ç»„ä¸­çš„æ‰€æœ‰å¤„ç†ã€‚Kafka2.4ä¸­å¼•å…¥çš„<ahref="https://www.confluent.io/blog/incremental-cooperative-rebalancing-in-kafka/">å¢é‡åä½œå†å¹³è¡¡åè®®</a>å·²ç»æœ€å¤§é™åº¦åœ°å‡å°‘äº†æ€§èƒ½å½±å“ï¼Œå…è®¸æ›´é¢‘ç¹çš„å†å¹³è¡¡ä»¥æ›´å¥½åœ°åˆ†é…æ¯ä¸ªåˆ†åŒºä¸Šçš„è´Ÿè½½ã€‚</p><p>ä¸ºäº†å¢å¼ºé‡æ–°åˆ†é…çš„çµæ´»æ€§ï¼Œåˆ†åŒºçš„æ•°é‡åº”è¯¥å¤§äº workerçš„æ•°é‡ã€‚è¿™ä¸€æ¯”ç‡åº”æ ¹æ®åº”ç”¨ç¨‹åºè€Œæœ‰æ‰€ä¸åŒï¼Œå¹¶å‡è®¾ä¸€ä¸ªå·¥ä½œçº¿ç¨‹è‡³å°‘å¯ä»¥å¤„ç†æ¥è‡ªä¸€ä¸ªåˆ†åŒºçš„è´Ÿè½½ä»¥é¿å…é¥¥é¥¿ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/0*68P7QtdFGeIzwZSs.png"alt="åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œå·¥ä½œç¨‹åº 3 åœ¨é€Ÿåº¦è¾ƒæ…¢çš„ç¡¬ä»¶ä¸Šè¿è¡Œï¼Œå¯¼è‡´åˆ†åŒº 5 å’Œ 6 å‡ºç°æ›´é«˜çš„å»¶è¿Ÿã€‚å› æ­¤ï¼Œå·¥ä½œç¨‹åº 3 å¯èƒ½ä¼šä¸»åŠ¨å–æ¶ˆè®¢é˜…ä¸»é¢˜ä»¥è§¦å‘é‡æ–°å¹³è¡¡å¹¶æ›´æœ‰æ•ˆåœ°é‡æ–°åˆ†é…åˆ†åŒºã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œåº”å®ç°è‡ªå®šä¹‰åˆ†é…å™¨ä»¥æ ¹æ®æœºå™¨æŒ‡æ ‡å’Œæ»åä¿¡æ¯é‡æ–°åˆ†é…åˆ†åŒºã€‚" /><figcaption aria-hidden="true">åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œå·¥ä½œç¨‹åº 3åœ¨é€Ÿåº¦è¾ƒæ…¢çš„ç¡¬ä»¶ä¸Šè¿è¡Œï¼Œå¯¼è‡´åˆ†åŒº 5 å’Œ 6 å‡ºç°æ›´é«˜çš„å»¶è¿Ÿã€‚å› æ­¤ï¼Œå·¥ä½œç¨‹åº 3å¯èƒ½ä¼šä¸»åŠ¨å–æ¶ˆè®¢é˜…ä¸»é¢˜ä»¥è§¦å‘é‡æ–°å¹³è¡¡å¹¶æ›´æœ‰æ•ˆåœ°é‡æ–°åˆ†é…åˆ†åŒºã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œåº”å®ç°è‡ªå®šä¹‰åˆ†é…å™¨ä»¥æ ¹æ®æœºå™¨æŒ‡æ ‡å’Œæ»åä¿¡æ¯é‡æ–°åˆ†é…åˆ†åŒºã€‚</figcaption></figure><h1 id="æ€»ç»“">æ€»ç»“</h1><p>æœ¬æ–‡ä» Kafka å¹¶è¡Œæ€§çš„ä¸€èˆ¬å®ç°å‡ºå‘ï¼Œæ¢è®¨äº† Kafkaå®ç°è´Ÿè½½å‡è¡¡åœ¨ç°å®å®è·µä¸­å¯èƒ½é‡åˆ°çš„å„ç§æŒ‘æˆ˜ï¼Œå¹¶ä»é™æ€è°ƒæ•´å’ŒåŠ¨æ€è°ƒæ•´ä¸¤ä¸ªæ–¹é¢ç»™å‡ºäº†è§£å†³æ€è·¯ï¼Œç‰¹åˆ«æ³¨é‡è®¨è®ºäº†åŠ¨æ€è°ƒæ•´ç­–ç•¥ï¼Œå¹¶åˆ†åˆ«ä»ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„è§’åº¦æå‡ºäº†è§£å†³æ–¹æ¡ˆã€‚</p><p>æ€»ä¹‹ï¼Œé€šè¿‡åœ¨ Kafkaä¸­å®ç°è´Ÿè½½å‡è¡¡ï¼Œå¯ä»¥æœ‰æ•ˆåœ°å°†å·¥ä½œè´Ÿè½½åˆ†é…åˆ°å¯ç”¨èµ„æºä¹‹é—´ï¼Œä»è€Œæ˜¾è‘—æé«˜æœåŠ¡æ€§èƒ½ã€‚å…·ä½“çš„ç®—æ³•å’Œç­–ç•¥éœ€è¦æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œé€‰æ‹©å’Œè°ƒæ•´ã€‚</p>]]></content>
    
    
    <summary type="html">æœ¬æ–‡è½¬è½½è‡ª Agoda Enginnering, ä»‹ç»äº† Kafka è´Ÿè½½å‡è¡¡çš„å®é™…åº”ç”¨è¿‡ç¨‹ä¸­çš„è´Ÿè½½å‡è¡¡æŒ‘æˆ˜åŠè§£å†³æ€è·¯ã€‚</summary>
    
    
    
    <category term="Kafka" scheme="https://hedon.top/categories/Kafka/"/>
    
    
    <category term="Kafka" scheme="https://hedon.top/tags/Kafka/"/>
    
    <category term="ä¸­é—´ä»¶" scheme="https://hedon.top/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    <category term="æ¶ˆæ¯é˜Ÿåˆ—" scheme="https://hedon.top/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"/>
    
  </entry>
  
  <entry>
    <title>å­¦ä¹ è®°å½•ï¼šç”¨ Go è‡ªåˆ¶è§£é‡Šå™¨ Monkey</title>
    <link href="https://hedon.top/2024/05/12/monkey-language/"/>
    <id>https://hedon.top/2024/05/12/monkey-language/</id>
    <published>2024-05-11T19:44:15.000Z</published>
    <updated>2024-05-12T11:59:36.393Z</updated>
    
    <content type="html"><![CDATA[<h1 id="è¯æ³•åˆ†æ">è¯æ³•åˆ†æ</h1><p>TDDï¼šæµ‹è¯•é©±åŠ¨å¼€å‘</p><p>å…ˆå†™æµ‹è¯•ç”¨ä¾‹ï¼Œå†è¿›è¡Œè¯æ³•åˆ†æé€»è¾‘çš„å®Œå–„ã€‚</p><h1 id="è¯­æ³•åˆ†æ">è¯­æ³•åˆ†æ</h1><p>é€’å½’ä¸‹é™è¯­æ³•åˆ†æä¼ªä»£ç </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs go">function parseProgram() &#123;<br>    program = newProgramASTNode()<br>    advanceTokens()<br>    <span class="hljs-keyword">for</span> (currentToken() != EOF_TOKEN) &#123;<br>        statement = null<br>        <span class="hljs-keyword">if</span> (currentToken() == LET_TOKEN) &#123;<br>            statement = parseLetStatement()<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (currentToken() == RETURN_TOKEN) &#123;<br>            statement = parseReturnStatement()<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (currentToken() == IF_TOKEN) &#123;<br>            statement = parseIfStatement()<br>        &#125;<br>        <span class="hljs-keyword">if</span> (statement != null) &#123;<br>            program.Statements.push(statement)<br>        &#125;<br>        advanceTokens()<br>    &#125;<br>    <span class="hljs-keyword">return</span> program<br>&#125;<br>function parseLetStatement() &#123;<br>    advanceTokens()<br>    identifier = parseIdentifier()<br>    advanceTokens()<br>    <span class="hljs-keyword">if</span> currentToken() != EQUAL_TOKEN &#123;<br>        parseError(<span class="hljs-string">&quot;no equal sign!&quot;</span>)<br>        <span class="hljs-keyword">return</span> null<br>    &#125;<br>    advanceTokens()<br>    value = parseExpression()<br>    variableStatement = newVariableStatementASTNode()<br>    variableStatement.identifier = identifier<br>    variableStatement.value = value<br>    <span class="hljs-keyword">return</span> variableStatement<br>&#125;<br>function parseIdentifier() &#123;<br>    identifier = newIdentifierASTNode()<br>    identifier.token = currentToken()<br>    <span class="hljs-keyword">return</span> identifier<br>&#125;<br>function parseExpression() &#123;<br>    <span class="hljs-keyword">if</span> (currentToken() == INTEGER_TOKEN) &#123;<br>        <span class="hljs-keyword">if</span> (nextToken() == PLUS_TOKEN) &#123;<br>            <span class="hljs-keyword">return</span> parseOperatorExpression()<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nextToken() == SEMICOLON_TOKEN) &#123;<br>            <span class="hljs-keyword">return</span> parseIntegerLiteral()<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (currentToken() == LEFT_PAREN) &#123;<br>        <span class="hljs-keyword">return</span> parseGroupedExpression()<br>    &#125;<br><span class="hljs-comment">// [...]</span><br>&#125;<br>function parseOperatorExpression() &#123;<br>    operatorExpression = newOperatorExpression()<br>    operatorExpression.left = parseIntegerLiteral()<br>    operatorExpression.operator = currentToken()<br>    operatorExpression.right = parseExpression()<br>    <span class="hljs-keyword">return</span> operatorExpression()<br>&#125;<br></code></pre></td></tr></table></figure><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240512042659060.png"alt="é€’å½’ä¸‹é™åˆ†ææ³•" /><figcaption aria-hidden="true">é€’å½’ä¸‹é™åˆ†ææ³•</figcaption></figure><h2 id="let-x5">let x=5</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240512035446100.png"alt="let stmt AST structure" /><figcaption aria-hidden="true">let stmt AST structure</figcaption></figure><h2 id="return-5">return 5</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240512045650041.png"alt="return stmt AST structue" /><figcaption aria-hidden="true">return stmt AST structue</figcaption></figure><h2 id="æ™®æ‹‰ç‰¹è§£æ">æ™®æ‹‰ç‰¹è§£æ</h2>]]></content>
    
    
    <summary type="html">æœ¬æ–‡ä¸»è¦æ˜¯è®°å½•ç¬”è€…åœ¨å­¦ä¹ ã€Šç”¨ Go è‡ªåˆ¶è§£é‡Šå™¨ Monkeyã€‹è¿‡ç¨‹ä¸­æ¶‰åŠçš„é‡è¦è®¾è®¡ç†å¿µå’Œæ€è€ƒã€‚</summary>
    
    
    
    <category term="Go" scheme="https://hedon.top/categories/Go/"/>
    
    <category term="Go å®æˆ˜" scheme="https://hedon.top/categories/Go/Go-%E5%AE%9E%E6%88%98/"/>
    
    
    <category term="Go" scheme="https://hedon.top/tags/Go/"/>
    
    <category term="ç¼–è¯‘åŸç†" scheme="https://hedon.top/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>æ—¶é—´å¤„ç†åŸºç¡€ï¼šRust çš„ chrono åº“æ•™ç¨‹</title>
    <link href="https://hedon.top/2024/05/11/rust-crate-chrono/"/>
    <id>https://hedon.top/2024/05/11/rust-crate-chrono/</id>
    <published>2024-05-11T15:52:55.000Z</published>
    <updated>2024-05-11T17:02:48.217Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸æœ‰å¯¹æ—¶é—´å’Œæ—¥æœŸå¤„ç†çš„éœ€æ±‚ã€‚ä¸è®ºæ˜¯æ—¥å†åº”ç”¨ã€æ—¥ç¨‹å®‰æ’ã€è¿˜æ˜¯æ—¶é—´æˆ³è®°å½•ï¼Œå‡†ç¡®çš„æ—¶é—´æ•°æ®å¤„ç†éƒ½æ˜¯å¿…ä¸å¯å°‘çš„ã€‚Rustç¤¾åŒºæä¾›çš„ <code>chrono</code> åº“ä»¥å…¶å¼ºå¤§çš„åŠŸèƒ½å’Œçµæ´»çš„æ¥å£ï¼Œåœ¨ Rustå¼€å‘è€…ä¸­å¹¿å—æ¬¢è¿ã€‚æœ¬æ–‡å°†ç®€å•ä»‹ç» <code>chrono</code>åº“ï¼Œå±•ç¤ºå¦‚ä½•åˆ©ç”¨å®ƒæ¥ç²¾ç¡®å¤„ç†å’Œè½¬æ¢æ—¶é—´å’Œæ—¥æœŸï¼Œå¸®åŠ©ä½ åœ¨ä»»ä½• Rusté¡¹ç›®ä¸­éƒ½èƒ½é«˜æ•ˆåœ°ç®¡ç†æ—¶é—´ã€‚</p><h1 id="ç‰ˆæœ¬">ç‰ˆæœ¬</h1><ul><li><code>chrono</code>: 0.4.38</li></ul><h1 id="ç»“è®ºå…ˆè¡Œ">ç»“è®ºå…ˆè¡Œ</h1><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240512010241356.png"alt="chrono å„ç§æ—¶é—´ç±»å‹è½¬æ¢å›¾" /><figcaption aria-hidden="true">chrono å„ç§æ—¶é—´ç±»å‹è½¬æ¢å›¾</figcaption></figure><h1 id="æ—¶é—´ç›¸å…³æ¦‚å¿µ">æ—¶é—´ç›¸å…³æ¦‚å¿µ</h1><table><thead><tr class="header"><th>æ¦‚å¿µ</th><th>ç†è§£</th></tr></thead><tbody><tr class="odd"><td>UNIX æ—¶é—´æˆ³ï¼ˆUNIX Timestampï¼‰</td><td>ä¹Ÿç§°ä¸º POSIX æ—¶é—´æˆ– Epoch æ—¶é—´ï¼Œæ˜¯è‡ª 1970 å¹´ 1 æœˆ 1 æ—¥ï¼ˆUTCæ—¶åŒºï¼‰ä»¥æ¥ç»è¿‡çš„ç§’æ•°ï¼Œä¸è®¡å…¥é—°ç§’ã€‚è¿™æ˜¯ä¸€ç§éå¸¸é€šç”¨çš„æ—¶é—´è¡¨ç¤ºæ–¹æ³•ï¼Œåœ¨ç¼–ç¨‹ä¸­å¹¿æ³›ä½¿ç”¨ï¼Œå› ä¸ºå®ƒå¯ä»¥ç®€åŒ–æ—¶é—´å·®çš„è®¡ç®—ã€‚</td></tr><tr class="even"><td>UTCï¼ˆåè°ƒä¸–ç•Œæ—¶ï¼‰</td><td>å…¨ç§°ä¸ºåè°ƒä¸–ç•Œæ—¶ï¼ˆCoordinated UniversalTimeï¼‰ï¼Œæ˜¯ç›®å‰å›½é™…ä¸Šå¹¿æ³›é‡‡ç”¨çš„æ—¶é—´æ ‡å‡†ã€‚å®ƒåŸºæœ¬ä¸Šä¸æ ¼æ—å¨æ²»å¹³å‡æ—¶ï¼ˆGMTï¼‰ç›¸åŒï¼Œä½†åœ¨æŠ€æœ¯ä¸Šæ›´åŠ ç²¾ç¡®ï¼Œå› ä¸ºå®ƒä½¿ç”¨åŸå­é’Ÿæ¥ä¿æŒæ—¶é—´å‡†ç¡®ã€‚ä¸–ç•Œå„åœ°çš„æ—¶é—´éƒ½æ˜¯ä»¥UTC ä¸ºåŸºç¡€ï¼ŒåŠ ä¸Šæˆ–å‡å»ä¸€å®šçš„å°æ—¶æ•°æ¥å®šä¹‰çš„ã€‚</td></tr><tr class="odd"><td>æ—¶åŒºï¼ˆTime Zoneï¼‰</td><td>æ—¶åŒºæ˜¯åœ°çƒä¸Šåˆ’åˆ†çš„æ ‡å‡†æ—¶é—´åŒºåŸŸã€‚ç”±äºåœ°çƒè‡ªè¥¿å‘ä¸œæ—‹è½¬ï¼Œæ¯å‘ä¸œç§»åŠ¨ä¸€å®šè§’åº¦ï¼Œå½“åœ°çš„å¤ªé˜³æ—¶é—´å°±ä¼šç›¸åº”åœ°æå‰ã€‚ä¸–ç•Œè¢«åˆ†æˆäº†24ä¸ªæ—¶åŒºï¼Œæ¯ä¸ªæ—¶åŒºé€šå¸¸ç›¸å·®ä¸€å°æ—¶ã€‚æ—¶åŒºå…è®¸åœ°åŒºå†…çš„äººä»¬èƒ½åœ¨å¤§è‡´ç›¸åŒçš„æ—¶é—´å†…ï¼Œç»å†ç±»ä¼¼çš„æ—¥å¤œæ›´æ›¿æ¨¡å¼ã€‚</td></tr><tr class="even"><td>UTC+8</td><td>UTC+8 æ˜¯ UTC æ—¶é—´åŠ ä¸Š 8å°æ—¶çš„æ—¶é—´åŒºã€‚ä¸­å›½å¤§é™†å°±æ˜¯ä½äºè¿™ä¸ªæ—¶åŒºã€‚ä¾‹å¦‚ï¼Œå½“ UTC æ—¶é—´ä¸º 00:00æ—¶ï¼ŒUTC+8 çš„æ—¶é—´å°±æ˜¯ 08:00ã€‚</td></tr></tbody></table><h1 id="chrono-å…³é”®ç±»å‹">chrono å…³é”®ç±»å‹</h1><table><thead><tr class="header"><th>ç±»å‹</th><th>å«ä¹‰</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr class="odd"><td>DateTime&lt;Tz&gt;</td><td>ä¸€ä¸ªå¸¦æœ‰æ—¶åŒºçš„æ—¥æœŸå’Œæ—¶é—´ç±»å‹ï¼Œå…¶ä¸­ <code>Tz</code> æ˜¯å®ç°äº†<code>TimeZone</code> ç‰¹è´¨çš„ç±»å‹ï¼Œå¦‚ <code>Utc</code> å’Œ<code>Local</code> ã€‚è¿™æ„å‘³ç€ <code>DateTime</code>è€ƒè™‘äº†æ—¶åŒºçš„å½±å“ï¼Œå¯ä»¥è¡¨ç¤ºå…¨çƒä»»æ„åœ°ç‚¹çš„ç²¾ç¡®æ—¶é—´ã€‚</td><td>å¹¿æ³›ç”¨äºéœ€è¦è€ƒè™‘æ—¶åŒºè½¬æ¢çš„åœºæ™¯ï¼Œå¦‚å­˜å‚¨ç”¨æˆ·çš„æœ¬åœ°æ—¶é—´æˆ–åœ¨ä¸åŒåœ°åŒºä¹‹é—´è½¬æ¢æ—¶é—´ã€‚</td></tr><tr class="even"><td>NaiveDateTime</td><td>ä¸€ä¸ªâ€œå¤©çœŸçš„â€æ—¥æœŸå’Œæ—¶é—´ï¼Œå³ä¸åŒ…å«ä»»ä½•æ—¶åŒºä¿¡æ¯çš„æ—¥æœŸå’Œæ—¶é—´ã€‚è¿™ç§ç±»å‹ä»…ä»…è¡¨ç¤ºä¸€ä¸ªæ—¥å†æ—¥æœŸå’Œä¸€å¤©ä¸­çš„æ—¶é—´ï¼Œè€Œæ²¡æœ‰ä»»ä½•å…³äºåœ°ç†æˆ–æ”¿æ²»æ—¶åŒºçš„æ•°æ®ã€‚</td><td>å¯¹äºä¸€äº›æ—¶åŒºä¸é‡è¦çš„åœºæ™¯éå¸¸æœ‰ç”¨ï¼Œæ¯”å¦‚è®°å½•ç”µå½±çš„å‘è¡Œæ—¥æœŸæˆ–å†å²äº‹ä»¶çš„æ—¥æœŸã€‚</td></tr><tr class="odd"><td>NaiveDate</td><td>ä»…è¡¨ç¤ºä¸€ä¸ªæ—¥å†æ—¥æœŸï¼Œä¸åŒ…æ‹¬æ—¶é—´æˆ–æ—¶åŒºä¿¡æ¯ã€‚</td><td>å®ƒç”¨äºå¤„ç†åªéœ€è¦æ—¥æœŸè€Œä¸å…³å¿ƒå…·ä½“æ—¶é—´çš„åœºæ™¯ï¼Œå¦‚ç”Ÿæ—¥ã€èŠ‚æ—¥ç­‰ã€‚</td></tr><tr class="even"><td>NaiveTime</td><td>æ˜¯ä¸€ä¸ªåªè¡¨ç¤ºä¸€å¤©ä¸­æ—¶é—´çš„ç±»å‹ï¼Œå®ƒä¸åŒ…å«æ—¥æœŸæˆ–æ—¶åŒºä¿¡æ¯ã€‚</td><td>è¿™ä¸ªç±»å‹é€‚ç”¨äºéœ€è¦å¤„ç†å…·ä½“æŸä¸ªæ—¶é—´ç‚¹ï¼ˆå¦‚å¼€ä¼šæ—¶é—´ã€æ—¥å¸¸æ´»åŠ¨çš„å¼€å§‹æ—¶é—´ï¼‰ä½†ä¸éœ€è¦æ—¥æœŸæ•°æ®çš„æƒ…æ™¯ã€‚</td></tr></tbody></table><h1 id="chrono-æ—¶åŒºç±»å‹">chrono æ—¶åŒºç±»å‹</h1><p><code>chrono</code>æ”¯æŒå¤šç§æ—¶åŒºç±»å‹ï¼Œæ–¹ä¾¿è¿›è¡Œå…¨çƒæ—¶é—´çš„è½¬æ¢å’Œè®¡ç®—ï¼š</p><ul><li><strong><code>Utc</code></strong>: ç”¨äºå¤„ç†åè°ƒä¸–ç•Œæ—¶ã€‚</li><li><strong><code>Local</code></strong>:ä»£è¡¨æœåŠ¡å™¨æˆ–ç”¨æˆ·çš„æœ¬åœ°æ—¶åŒºã€‚</li><li><strong><code>FixedOffset</code></strong>:å…è®¸å®šä¹‰ä»»æ„çš„å°æ—¶å’Œåˆ†é’Ÿåç§»é‡ï¼Œé€‚åˆå›ºå®šåç§»çš„æ—¶é—´è®¡ç®—ã€‚</li></ul><h1 id="å¸¸ç”¨åŠŸèƒ½">å¸¸ç”¨åŠŸèƒ½</h1><h2 id="è·å–å½“å‰æ—¶é—´">è·å–å½“å‰æ—¶é—´</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">local_datetime</span>: DateTime&lt;Local&gt; = Local::<span class="hljs-title function_ invoke__">now</span>();<br><span class="hljs-keyword">let</span> <span class="hljs-variable">utc_datetime</span>: DateTime&lt;Utc&gt; = Utc::<span class="hljs-title function_ invoke__">now</span>();<br></code></pre></td></tr></table></figure><h2 id="datetime-è½¬-string">DateTime è½¬ String</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, local_datetime.<span class="hljs-title function_ invoke__">to_rfc2822</span>()); <span class="hljs-comment">// Sun, 12 May 2024 00:15:55 +0800</span><br><span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, local_datetime.<span class="hljs-title function_ invoke__">to_rfc3339</span>()); <span class="hljs-comment">// 2024-05-12T00:15:55.325058+08:00</span><br><span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, local_datetime.<span class="hljs-title function_ invoke__">to_string</span>()); <span class="hljs-comment">// 2024-05-12 00:15:55.325058 +08:00</span><br><span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, local_datetime.format(<span class="hljs-string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)) <span class="hljs-comment">// 2024-05-12 00:15:55</span><br></code></pre></td></tr></table></figure><h2 id="string-è½¬-datetime">String è½¬ DateTime</h2><p>å­—ç¬¦ä¸²å¸¦æ—¶åŒºä¿¡æ¯ï¼Œä½¿ç”¨<code>DateTime::parse_from_str(s, f)</code>ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">format_withzone</span> = <span class="hljs-string">&quot;%Y-%m-%d %H:%M:%S %z&quot;</span>;<br><span class="hljs-keyword">let</span> <span class="hljs-variable">datetime_withzone_str</span> = <span class="hljs-string">&quot;2024-01-01 00:00:00 +08:00&quot;</span>;<br><span class="hljs-keyword">let</span> <span class="hljs-variable">local_datetime</span> =<br>    DateTime::<span class="hljs-title function_ invoke__">parse_from_str</span>(&amp;datetime_withzone_str, &amp;format_withzone).<span class="hljs-title function_ invoke__">unwrap</span>();<br></code></pre></td></tr></table></figure><p>å­—ç¬¦ä¸²æ— æ—¶åŒºä¿¡æ¯ï¼Œä½¿ç”¨<code>NaiveDateTime::parse_from_str(s, f)</code>ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">format</span> = <span class="hljs-string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>;<br><span class="hljs-keyword">let</span> <span class="hljs-variable">datetime_str</span> = <span class="hljs-string">&quot;2024-01-01 00:00:00&quot;</span>;<br><span class="hljs-keyword">let</span> <span class="hljs-variable">local_datetime</span> = NaiveDateTime::<span class="hljs-title function_ invoke__">parse_from_str</span>(&amp;datetime_str, &amp;format)<br>    .<span class="hljs-title function_ invoke__">unwrap</span>()<br>    .<span class="hljs-title function_ invoke__">and_local_timezone</span>(Local) <span class="hljs-comment">// è½¬ä¸ºå¸¦æ—¶åŒºçš„ DateTime</span><br>    .<span class="hljs-title function_ invoke__">unwrap</span>();<br></code></pre></td></tr></table></figure><h2 id="datetime-è½¬-timestamp">DateTime è½¬ timestamp</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">local_datetime</span> = Local::<span class="hljs-title function_ invoke__">now</span>();<br><span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;seconds: &#123;&#125;&quot;</span>, local_datetime.<span class="hljs-title function_ invoke__">timestamp</span>()); <span class="hljs-comment">// 1715444324</span><br><span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;millis: &#123;&#125;&quot;</span>, local_datetime.<span class="hljs-title function_ invoke__">timestamp_millis</span>()); <span class="hljs-comment">// 1715444338610</span><br><span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;micros: &#123;&#125;&quot;</span>, local_datetime.<span class="hljs-title function_ invoke__">timestamp_micros</span>()); <span class="hljs-comment">// 1715444338610873</span><br><span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;nacos: &#123;&#125;&quot;</span>, local_datetime.<span class="hljs-title function_ invoke__">timestamp_nanos_opt</span>().<span class="hljs-title function_ invoke__">unwrap</span>()); <span class="hljs-comment">// 1715444338610873000</span><br></code></pre></td></tr></table></figure><h2 id="timestamp-è½¬-datetime">timestamp è½¬ DateTime</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">utc_datetime</span>: DateTime&lt;Utc&gt; = DateTime::<span class="hljs-title function_ invoke__">from_timestamp</span>(<span class="hljs-number">1704139200</span>, <span class="hljs-number">0</span>).<span class="hljs-title function_ invoke__">unwrap</span>(); <span class="hljs-comment">// é»˜è®¤æ˜¯ Utc</span><br><span class="hljs-keyword">let</span> <span class="hljs-variable">local_datetime</span>: DateTime&lt;Local&gt; = DateTime::<span class="hljs-title function_ invoke__">from_timestamp</span>(<span class="hljs-number">1704139200</span>, <span class="hljs-number">0</span>).<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-title function_ invoke__">into</span>(); <span class="hljs-comment">// ä½¿ç”¨ into() è½¬ä¸º Local</span><br></code></pre></td></tr></table></figure><h2 id="æ—¶åŒºè½¬æ¢">æ—¶åŒºè½¬æ¢</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> chrono::&#123;DateTime, FixedOffset, Utc&#125;;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">utc_date_time</span>: DateTime&lt;Utc&gt; = Utc::<span class="hljs-title function_ invoke__">now</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">fixed_offset</span> = FixedOffset::<span class="hljs-title function_ invoke__">east</span>(<span class="hljs-number">8</span> * <span class="hljs-number">3600</span>); <span class="hljs-comment">// è½¬ä¸º utc+8 ä¸œå…«åŒº</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">local_date_time</span> = utc_date_time.<span class="hljs-title function_ invoke__">with_timezone</span>(&amp;fixed_offset);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Local time in UTC+8: &#123;&#125;&quot;</span>, local_date_time);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æ—¶é—´è®¡ç®—">æ—¶é—´è®¡ç®—</h2><p>æ—¶é—´åŠ å‡ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> chrono::&#123;Duration, Local&#125;;<br><br><span class="hljs-keyword">let</span> <span class="hljs-variable">now</span> = Local::<span class="hljs-title function_ invoke__">now</span>();<br><span class="hljs-keyword">let</span> <span class="hljs-variable">yesterday</span> = now - Duration::<span class="hljs-title function_ invoke__">hours</span>(<span class="hljs-number">24</span>);<br></code></pre></td></tr></table></figure><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240512002330526.png"alt="chrono time duration methods" /><figcaption aria-hidden="true">chrono time duration methods</figcaption></figure><p>æ—¶é—´é—´éš”ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> chrono::&#123;Duration, Local&#125;;<br><br><span class="hljs-keyword">let</span> <span class="hljs-variable">now</span> = Local::<span class="hljs-title function_ invoke__">now</span>();<br><span class="hljs-keyword">let</span> <span class="hljs-variable">yesterday</span> = now - Duration::<span class="hljs-title function_ invoke__">hours</span>(<span class="hljs-number">24</span>);<br><span class="hljs-keyword">let</span> <span class="hljs-variable">hour_interval</span> = (now - yesterday).<span class="hljs-title function_ invoke__">num_hours</span>();<br></code></pre></td></tr></table></figure><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240512002106738.png"alt="chrono time interval methods" /><figcaption aria-hidden="true">chrono time interval methods</figcaption></figure><h1 id="æ€»ç»“">æ€»ç»“</h1><p>é€šè¿‡æœ¬æ–‡çš„è¯¦ç»†ä»‹ç»å’Œå®ç”¨ç¤ºä¾‹ï¼Œæˆ‘ä»¬äº†è§£äº†å¦‚ä½•ä½¿ç”¨ Rust çš„<code>chrono</code> åº“æ¥ç²¾ç¡®å¤„ç†æ—¶é—´å’Œæ—¥æœŸã€‚<code>chrono</code>ä¸ä»…æ”¯æŒå¤æ‚çš„æ—¶åŒºè®¡ç®—å’Œå…¨çƒæ—¶é—´ç®¡ç†ï¼Œè¿˜æä¾›äº†æ–¹ä¾¿çš„æ—¥æœŸæ—¶é—´è§£æå’Œæ ¼å¼åŒ–å·¥å…·ï¼Œä»¥åŠçµæ´»çš„æ—¶é—´è¿ç®—åŠŸèƒ½ã€‚æŒæ¡äº†è¿™äº›æŠ€èƒ½åï¼Œä½ å°†èƒ½å¤Ÿåœ¨ä»»ä½•éœ€è¦ç²¾ç¡®æ—¶é—´æ•°æ®å¤„ç†çš„Rust åº”ç”¨ä¸­ï¼Œæä¾›ç¨³å®šå’Œé«˜æ•ˆçš„è§£å†³æ–¹æ¡ˆã€‚</p><p>æ—¶é—´æ˜¯æ¯ä¸ªç¨‹åºçš„åŸºçŸ³ï¼Œè€Œ <code>chrono</code>å°±æ˜¯é‚£æŠŠèƒ½å¤Ÿæ“çºµæ—¶é—´çš„é­”æ–ã€‚</p><p>å¸Œæœ›æœ¬æ–‡èƒ½å¯¹ä½ æœ‰å¸®åŠ©ï¼Œpeace! enjoy coding~</p><blockquote><p>å‚è€ƒï¼š</p><ul><li><a href="https://docs.rs/chrono/latest/chrono/">chronocrate</a></li><li><ahref="https://blog.stackademic.com/rust-working-with-date-and-time-30e003cd59e8">rust-working-with-date-and-time</a></li></ul><p>ä½œå›¾ï¼š</p><ul><li>https://excalidraw.com/</li></ul></blockquote>]]></content>
    
    
    <summary type="html">æœ¬æ–‡å…¨é¢çš„æŒ‡å—æ·±å…¥ä»‹ç»äº†å¦‚ä½•åœ¨ Rust ä¸­ä½¿ç”¨ chrono åº“æ¥ç²¾ç¡®å¤„ç†å’Œè½¬æ¢æ—¶é—´ä¸æ—¥æœŸã€‚ä»åŸºæœ¬æ¦‚å¿µåˆ°é«˜çº§åŠŸèƒ½ï¼Œæœ¬æ–‡æä¾›äº†å®ç”¨çš„ä»£ç ç¤ºä¾‹å’Œè¯¦å°½çš„è§£é‡Šï¼Œå¸®åŠ©ä½ åœ¨ä»»ä½• Rust é¡¹ç›®ä¸­é«˜æ•ˆç®¡ç†æ—¶é—´ã€‚</summary>
    
    
    
    <category term="Rust" scheme="https://hedon.top/categories/Rust/"/>
    
    <category term="Rust å¸¸ç”¨åº“" scheme="https://hedon.top/categories/Rust/Rust-%E5%B8%B8%E7%94%A8%E5%BA%93/"/>
    
    
    <category term="Rust" scheme="https://hedon.top/tags/Rust/"/>
    
  </entry>
  
  <entry>
    <title>epoll</title>
    <link href="https://hedon.top/2024/04/28/epoll/"/>
    <id>https://hedon.top/2024/04/28/epoll/</id>
    <published>2024-04-28T12:27:29.000Z</published>
    <updated>2024-05-06T09:11:27.155Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€">å‰è¨€</h1><p><code>epoll</code> æ˜¯ä¸€ç§ I/Oå¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œä¸»è¦ç”¨äºé«˜æ€§èƒ½çš„ç½‘ç»œæœåŠ¡å™¨ä¸­ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤§é‡å¹¶å‘è¿æ¥æ—¶ã€‚å®ƒæ˜¯Linux ç‰¹æœ‰çš„ï¼Œè‡ª Linux å†…æ ¸ 2.5.44ç‰ˆæœ¬å¼•å…¥ï¼Œå¹¶åœ¨åç»­ç‰ˆæœ¬ä¸­ä¸æ–­ä¼˜åŒ–ã€‚<code>epoll</code>èƒ½å¤Ÿå¸®åŠ©æœåŠ¡å™¨é«˜æ•ˆåœ°ç®¡ç†æ•°ä»¥åƒè®¡çš„å®¢æˆ·ç«¯è¿æ¥ï¼Œæ˜¯ <code>select</code> å’Œ<code>poll</code> æ–¹æ³•çš„ç°ä»£æ›¿ä»£å“ã€‚</p><p>æœ¬æ–‡ä¸å¯¹ <code>epoll</code>çš„æºç è¿›è¡Œåˆ†æï¼Œä»…åšåŸç†ä¸Šçš„æ€»ç»“ï¼Œæ–¹ä¾¿å¿«é€ŸæŸ¥é˜…å›é¡¾ã€‚å„å¤§è®ºå›å¾ˆå¤šå¤§ä½¬éƒ½å¯¹<code>epoll</code>çš„æºç è¿›è¡Œäº†è¯¦å°½çš„åˆ†æï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥çœ‹ã€Œå‚è€ƒã€ç¯‡ç« ã€‚</p><h1 id="ä¸»è¦ç‰¹ç‚¹">ä¸»è¦ç‰¹ç‚¹</h1><ol type="1"><li><strong>æ•ˆç‡é«˜</strong>: ç›¸è¾ƒäº <code>select</code> å’Œ<code>poll</code>ï¼Œ<code>epoll</code>å¯ä»¥æ›´é«˜æ•ˆåœ°å¤„ç†å¤§é‡çš„å¹¶å‘è¿æ¥ã€‚<code>select</code> å’Œ <code>poll</code>çš„æ•ˆç‡éšç€ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡å¢åŠ è€Œçº¿æ€§ä¸‹é™ï¼Œè€Œ <code>epoll</code>åˆ™ä¸ä¼šå› ä¸ºç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡å¢åŠ è€Œæ˜¾è‘—é™ä½æ•ˆç‡ã€‚</li><li><strong>æ‰©å±•æ€§å¥½</strong>: <code>epoll</code>ä½¿ç”¨ä¸€ç§ç§°ä¸ºäº‹ä»¶é€šçŸ¥çš„æœºåˆ¶ï¼Œåªä¼šå¤„ç†é‚£äº›çœŸæ­£å‘ç”Ÿäº†äº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ã€‚è¿™æ„å‘³ç€ç³»ç»Ÿä¸å¿…é‡æ–°æ£€æŸ¥æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ï¼Œä»è€Œå¤§å¤§å‡å°‘äº†ä¸å¿…è¦çš„CPU å¼€é”€ã€‚</li><li><strong>æ”¯æŒè¾¹ç¼˜è§¦å‘å’Œæ°´å¹³è§¦å‘</strong>: <code>epoll</code> æ”¯æŒ<code>Edge Triggered</code> å’Œæ°´å¹³è§¦å‘ <code>Level Triggered</code>ä¸¤ç§æ¨¡å¼ã€‚è¾¹ç¼˜è§¦å‘æ¨¡å¼åªåœ¨æ–‡ä»¶æè¿°ç¬¦çŠ¶æ€æ”¹å˜æ—¶æ‰é€šçŸ¥åº”ç”¨ç¨‹åºï¼Œé€‚ç”¨äºéé˜»å¡I/Oï¼›è€Œæ°´å¹³è§¦å‘æ¨¡å¼åˆ™åœ¨æœ‰äº‹ä»¶å¯è¯»æˆ–å¯å†™æ—¶éƒ½ä¼šé€šçŸ¥åº”ç”¨ç¨‹åºï¼Œæ›´å®¹æ˜“ä½¿ç”¨ä½†æ•ˆç‡ç•¥ä½ã€‚</li></ol><h1 id="ç»“è®ºå…ˆè¡Œ">ç»“è®ºå…ˆè¡Œ</h1><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240429121302958.png"alt="epoll flow chart" /><figcaption aria-hidden="true">epoll flow chart</figcaption></figure><h1 id="å·¥ä½œåŸç†">å·¥ä½œåŸç†</h1><p><code>epoll</code> çš„å·¥ä½œå¯ä»¥åˆ†ä¸ºä¸‰ä¸ªä¸»è¦æ­¥éª¤ï¼š</p><ol type="1"><li><strong>åˆ›å»º epoll å®ä¾‹</strong>: ä½¿ç”¨ <code>epoll_create</code>å‡½æ•°åˆ›å»ºä¸€ä¸ª <code>epoll</code> å®ä¾‹ã€‚</li><li><strong>æ·»åŠ /ä¿®æ”¹/åˆ é™¤æ–‡ä»¶æè¿°ç¬¦</strong>: ä½¿ç”¨<code>epoll_ctl</code> å‡½æ•°å°†æ–°çš„æ–‡ä»¶æè¿°ç¬¦æ·»åŠ åˆ° <code>epoll</code>å®ä¾‹ä¸­ï¼Œæˆ–è€…ä¿®æ”¹ã€åˆ é™¤å·²å­˜åœ¨çš„æ–‡ä»¶æè¿°ç¬¦ã€‚è¿™äº›æ“ä½œä¸æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡æ— å…³ï¼Œå› æ­¤æ‰§è¡Œé€Ÿåº¦éå¸¸å¿«ã€‚</li><li><strong>ç­‰å¾…äº‹ä»¶å‘ç”Ÿ</strong>: ä½¿ç”¨ <code>epoll_wait</code>å‡½æ•°ç­‰å¾…äº‹ä»¶çš„å‘ç”Ÿã€‚è¿™ä¸ªå‡½æ•°å¯ä»¥åŒæ—¶ç›‘æ§å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå½“æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦ä¸Šå‘ç”Ÿäº†æ³¨å†Œçš„äº‹ä»¶æ—¶ï¼Œå‡½æ•°è¿”å›ï¼Œå¹¶å‘ŠçŸ¥å“ªäº›æ–‡ä»¶æè¿°ç¬¦ä¸Šå‘ç”Ÿäº†äº‹ä»¶ã€‚</li></ol><h1 id="et-lt">ET &amp; LT</h1><p>åœ¨ <code>epoll</code> ä¸­ï¼Œè¾¹ç¼˜è§¦å‘ï¼ˆET, EdgeTriggeredï¼‰å’Œæ°´å¹³è§¦å‘ï¼ˆLT, LevelTriggeredï¼‰æ˜¯ä¸¤ç§ä¸åŒçš„äº‹ä»¶é€šçŸ¥æ–¹å¼ï¼Œå®ƒä»¬å®šä¹‰äº†æ“ä½œç³»ç»Ÿå¦‚ä½•é€šçŸ¥åº”ç”¨ç¨‹åºæ–‡ä»¶æè¿°ç¬¦ä¸Šçš„I/O äº‹ä»¶ã€‚</p><p>è¿™ä¸¤ç§æ¨¡å¼çš„ä¸»è¦åŒºåˆ«åœ¨äºä½•æ—¶ä»¥åŠå¦‚ä½•å¤šæ¬¡é€šçŸ¥åº”ç”¨ç¨‹åºå…³äºæŸä¸ªæ–‡ä»¶æè¿°ç¬¦çš„äº‹ä»¶ã€‚</p><h2 id="æ°´å¹³è§¦å‘level-triggered">æ°´å¹³è§¦å‘ï¼ˆLevel Triggeredï¼‰</h2><ul><li><strong>å®šä¹‰</strong>: åœ¨æ°´å¹³è§¦å‘æ¨¡å¼ä¸‹ï¼Œåªè¦æ–‡ä»¶æè¿°ç¬¦ä¸Šæœ‰æœªå¤„ç†çš„I/O äº‹ä»¶å­˜åœ¨ï¼Œ<code>epoll_wait</code>å°±ä¼šé€šçŸ¥åº”ç”¨ç¨‹åºã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœæ•°æ®å¯è¯»å–ä½†æœªè¢«å®Œå…¨è¯»å–ï¼Œ<code>epoll_wait</code>ä¼šåœ¨ä¸‹æ¬¡è°ƒç”¨æ—¶å†æ¬¡è¿”å›è¯¥æ–‡ä»¶æè¿°ç¬¦ã€‚</li><li><strong>è¡Œä¸º</strong>:è¿™ç§æ¨¡å¼æ›´å®¹æ˜“ç¼–ç¨‹ï¼Œå› ä¸ºåº”ç”¨ç¨‹åºå¯ä»¥ä¸ç”¨æ‹…å¿ƒåœ¨ä¸€ä¸ªæ“ä½œä¸­å¤„ç†æ‰€æœ‰æ•°æ®ã€‚å¦‚æœæ•°æ®è¿˜åœ¨ï¼Œ<code>epoll_wait</code>ä¼šç»§ç»­é€šçŸ¥ä½ ã€‚</li><li><strong>é€‚ç”¨åœºæ™¯</strong>:æ›´é€‚åˆé‚£äº›ç®€å•çš„åº”ç”¨æˆ–è€…å¯¹å®æ—¶æ€§è¦æ±‚ä¸æ˜¯éå¸¸é«˜çš„åº”ç”¨ï¼Œå› ä¸ºå®ƒç®€åŒ–äº†å¤„ç†é€»è¾‘ã€‚</li></ul><h2 id="è¾¹ç¼˜è§¦å‘edge-triggered">è¾¹ç¼˜è§¦å‘ï¼ˆEdge Triggeredï¼‰</h2><ul><li><strong>å®šä¹‰</strong>:åœ¨è¾¹ç¼˜è§¦å‘æ¨¡å¼ä¸‹ï¼Œåªæœ‰çŠ¶æ€å˜åŒ–æ—¶ï¼ˆä¾‹å¦‚ä»æ— æ•°æ®åˆ°æœ‰æ•°æ®ï¼‰ï¼Œ<code>epoll_wait</code>æ‰ä¼šé€šçŸ¥åº”ç”¨ç¨‹åºã€‚ä¸€æ—¦é€šçŸ¥äº†åº”ç”¨ç¨‹åºæŸäº‹ä»¶å‘ç”Ÿï¼Œé™¤éæœ‰æ–°çš„æ•°æ®åˆ°è¾¾æˆ–çŠ¶æ€å†æ¬¡å‘ç”Ÿå˜åŒ–ï¼Œå¦åˆ™ä¸ä¼šå†æ¬¡é€šçŸ¥åº”ç”¨ç¨‹åºè¯¥äº‹ä»¶ã€‚</li><li><strong>è¡Œä¸º</strong>:è¿™è¦æ±‚åº”ç”¨ç¨‹åºå¿…é¡»ç«‹å³å¤„ç†æ‰€æœ‰äº‹ä»¶ï¼Œå› ä¸ºä¹‹åä¸ä¼šå†æ”¶åˆ°å…³äºè¿™äº›äº‹ä»¶çš„é€šçŸ¥ã€‚è¿™æ„å‘³ç€åº”ç”¨ç¨‹åºå¿…é¡»å¾ªç¯è¯»å–æˆ–å†™å…¥ï¼Œç›´åˆ°æ•°æ®è¢«å®Œå…¨å¤„ç†å®Œï¼Œä»¥ç¡®ä¿ä¸é—æ¼ä»»ä½•äº‹ä»¶ã€‚</li><li><strong>é€‚ç”¨åœºæ™¯</strong>:é€‚åˆéœ€è¦é«˜æ€§èƒ½çš„åœºæ™¯ï¼Œå› ä¸ºå®ƒå‡å°‘äº†äº‹ä»¶å¤„ç†çš„æ¬¡æ•°ï¼Œä½†è¦æ±‚ç¨‹åºå¿…é¡»æ›´åŠ å°å¿ƒåœ°ç®¡ç†I/O æ“ä½œã€‚</li></ul><h2 id="æ¯”è¾ƒå’Œé€‰æ‹©">æ¯”è¾ƒå’Œé€‰æ‹©</h2><ul><li><strong>æ€§èƒ½</strong>:è¾¹ç¼˜è§¦å‘é€šå¸¸æä¾›æ›´é«˜çš„æ€§èƒ½ï¼Œå› ä¸ºå®ƒå‡å°‘äº†ç³»ç»Ÿè°ƒç”¨çš„æ¬¡æ•°å’Œä¸å¿…è¦çš„äº‹ä»¶å¤„ç†ã€‚</li><li><strong>ç¼–ç¨‹å¤æ‚æ€§</strong>:è¾¹ç¼˜è§¦å‘æ¨¡å¼ç¼–ç¨‹æ¯”æ°´å¹³è§¦å‘å¤æ‚ï¼Œå› ä¸ºéœ€è¦ç¡®ä¿æ¯æ¬¡äº‹ä»¶è¢«å½»åº•å¤„ç†ï¼Œå¹¶ä¸”æ›´å®¹æ˜“é‡åˆ°å¦‚â€œæƒŠç¾¤æ•ˆåº”â€ï¼ˆå¤šä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹è¢«åŒä¸€ä¸ªäº‹ä»¶å”¤é†’ï¼‰ç­‰é—®é¢˜ã€‚</li><li><strong>å¯é æ€§</strong>:æ°´å¹³è§¦å‘å› ä¸ºå…¶ç®€å•çš„è¡Œä¸ºæ¨¡å¼ï¼Œåœ¨å¯é æ€§å¤„ç†ä¸Šæ›´ä¸ºç›´æ¥å’Œå®¹æ˜“ã€‚</li></ul><p>é€šå¸¸ï¼Œé€‰æ‹©å“ªç§æ¨¡å¼å–å†³äºåº”ç”¨çš„å…·ä½“éœ€æ±‚ã€é¢„æœŸçš„è´Ÿè½½ä»¥åŠå¼€å‘è€…å¯¹äº‹ä»¶å¤„ç†é€»è¾‘çš„æ§åˆ¶ç¨‹åº¦ã€‚é«˜æ€§èƒ½æœåŠ¡å™¨é€šå¸¸é€‰æ‹©è¾¹ç¼˜è§¦å‘æ¨¡å¼ï¼Œä»¥æœ€å¤§åŒ–å…¶æ•ˆç‡ï¼Œè€Œç®€å•çš„æˆ–è€…ä½è´Ÿè½½åº”ç”¨å¯èƒ½ä¼šæ›´å€¾å‘äºä½¿ç”¨æ°´å¹³è§¦å‘ï¼Œä»¥ç®€åŒ–å¼€å‘å’Œè°ƒè¯•è¿‡ç¨‹ã€‚</p><h1 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h1><p><code>epoll</code> ä½¿ç”¨ 2ç§å…³é”®çš„æ•°æ®ç»“æ„æ¥ç»´æŠ¤å’Œè·Ÿè¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆFDï¼‰å’Œäº‹ä»¶ï¼š</p><ol type="1"><li><strong>çº¢é»‘æ ‘ï¼ˆRed-Black Treeï¼‰</strong>:ç”¨äºå­˜å‚¨æ‰€æœ‰æ³¨å†Œçš„æ–‡ä»¶æè¿°ç¬¦åŠå…¶äº‹ä»¶ã€‚çº¢é»‘æ ‘æ˜¯ä¸€ç§è‡ªå¹³è¡¡äºŒå‰æœç´¢æ ‘ï¼Œèƒ½å¤Ÿåœ¨å¯¹æ•°æ—¶é—´å†…å®Œæˆæ’å…¥ã€åˆ é™¤å’ŒæŸ¥æ‰¾æ“ä½œï¼Œè¿™ä½¿å¾—ç®¡ç†å¤§é‡æ–‡ä»¶æè¿°ç¬¦å˜å¾—é«˜æ•ˆã€‚</li><li><strong>å°±ç»ªåˆ—è¡¨ï¼ˆReady Listï¼‰</strong>:å½“äº‹ä»¶å‘ç”Ÿï¼ˆå¦‚å¯è¯»ã€å¯å†™ç­‰ï¼‰å¹¶è¢«å†…æ ¸æ£€æµ‹åˆ°æ—¶ï¼Œç›¸åº”çš„ FDä¼šè¢«æ·»åŠ åˆ°ä¸€ä¸ªå°±ç»ªåˆ—è¡¨ä¸­ã€‚è¿™ä¸ªåˆ—è¡¨ä»…åŒ…å«å®é™…æœ‰äº‹ä»¶å‘ç”Ÿçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä»è€Œå‡å°‘äº†<code>epoll_wait</code> è°ƒç”¨çš„å¤„ç†æ—¶é—´ã€‚</li></ol><h1 id="å·¥ä½œç»†èŠ‚">å·¥ä½œç»†èŠ‚</h1><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/epoll_principle.jpg"alt="epoll data structure" /><figcaption aria-hidden="true">epoll data structure</figcaption></figure><ol type="1"><li>é€šè¿‡è°ƒç”¨ <code>epoll_create()</code> å‡½æ•°åˆ›å»ºå¹¶åˆå§‹åŒ–ä¸€ä¸ª<code>eventpoll</code> å¯¹è±¡ã€‚</li><li>é€šè¿‡è°ƒç”¨ <code>epoll_ctl()</code> å‡½æ•°æŠŠè¢«ç›‘å¬çš„æ–‡ä»¶å¥æŸ„ (å¦‚ socketå¥æŸ„) å°è£…æˆ <code>epitem</code> å¯¹è±¡å¹¶ä¸”æ·»åŠ åˆ° <code>eventpoll</code>å¯¹è±¡çš„çº¢é»‘æ ‘ä¸­è¿›è¡Œç®¡ç†ã€‚</li><li>é€šè¿‡è°ƒç”¨ <code>epoll_wait()</code>å‡½æ•°ç­‰å¾…è¢«ç›‘å¬çš„æ–‡ä»¶çŠ¶æ€å‘ç”Ÿæ”¹å˜ã€‚</li><li>å½“è¢«ç›‘å¬çš„æ–‡ä»¶çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼ˆå¦‚ socketæ¥æ”¶åˆ°æ•°æ®ï¼‰ï¼Œä¼šæŠŠæ–‡ä»¶å¥æŸ„å¯¹åº” <code>epitem</code> å¯¹è±¡æ·»åŠ åˆ°<code>eventpoll</code> å¯¹è±¡çš„å°±ç»ªé˜Ÿåˆ— <code>rdllist</code>ä¸­ã€‚å¹¶ä¸”æŠŠå°±ç»ªé˜Ÿåˆ—çš„æ–‡ä»¶åˆ—è¡¨å¤åˆ¶åˆ° <code>epoll_wait()</code> å‡½æ•°çš„<code>events</code> å‚æ•°ä¸­ã€‚</li><li>å”¤é†’è°ƒç”¨ <code>epoll_wait()</code> å‡½æ•°è¢«é˜»å¡ï¼ˆç¡çœ ï¼‰çš„è¿›ç¨‹ã€‚</li></ol><h1 id="äº‹ä»¶ç›‘å¬">äº‹ä»¶ç›‘å¬</h1><p>å†…æ ¸ä¸­çš„äº‹ä»¶ç›‘å¬å’Œå›è°ƒæœºåˆ¶æ˜¯é€šè¿‡é«˜æ•ˆçš„äº‹ä»¶é©±åŠ¨æ¨¡å‹å®ç°çš„ï¼Œè€Œä¸æ˜¯ç®€å•çš„å¾ªç¯æ£€æŸ¥ï¼ˆå¦‚åœ¨ç”¨æˆ·ç©ºé—´ä¸­çš„è½®è¯¢ï¼‰ã€‚è¿™ç§æœºåˆ¶åˆ©ç”¨äº†ç°ä»£æ“ä½œç³»ç»Ÿçš„ä¸­æ–­å’Œå›è°ƒç³»ç»Ÿï¼Œä»¥åŠé’ˆå¯¹å¼‚æ­¥äº‹ä»¶çš„ä¼˜åŒ–å¤„ç†ç­–ç•¥ã€‚</p><p>ä»¥ä¸‹æ˜¯è¿™ä¸ªè¿‡ç¨‹çš„è¯¦ç»†è§£é‡Šï¼š</p><h2 id="ä¸­æ–­å’Œä¸­æ–­å¤„ç†">1. ä¸­æ–­å’Œä¸­æ–­å¤„ç†</h2><p>åœ¨ç¡¬ä»¶å±‚é¢ï¼Œå¤§å¤šæ•° I/O æ“ä½œï¼ˆå¦‚ç½‘ç»œé€šä¿¡ã€ç£ç›˜I/Oï¼‰éƒ½æ˜¯é€šè¿‡ä¸­æ–­é©±åŠ¨çš„ã€‚å½“ä¸€ä¸ª I/Oè®¾å¤‡å‡†å¤‡å¥½æ•°æ®æˆ–éœ€è¦æœåŠ¡æ—¶ï¼Œå®ƒä¼šäº§ç”Ÿä¸€ä¸ªä¸­æ–­ä¿¡å·ï¼Œè¿™ä¸ªä¿¡å·è¢«å‘é€åˆ°CPUã€‚CPU å“åº”ä¸­æ–­ï¼Œå¹¶æ‰§è¡Œä¸€ä¸ªé¢„å®šçš„ä¸­æ–­å¤„ç†ç¨‹åºï¼ˆInterrupt ServiceRoutine, ISRï¼‰ï¼Œè¯¥ç¨‹åºæ˜¯ç”±è®¾å¤‡çš„é©±åŠ¨ç¨‹åºæä¾›çš„ã€‚</p><h2 id="äº‹ä»¶å’Œå›è°ƒ">2. äº‹ä»¶å’Œå›è°ƒ</h2><p>åœ¨ ISRä¸­ï¼Œä¸è®¾å¤‡ç›¸å…³çš„äº‹ä»¶ï¼ˆä¾‹å¦‚ç½‘ç»œåŒ…çš„æ¥æ”¶ã€ç¡¬ç›˜è¯»å–å®Œæˆï¼‰ä¼šè¢«æ£€æµ‹åˆ°ï¼Œå¹¶ä¸”å¯ä»¥åœ¨æ­¤é˜¶æ®µè°ƒç”¨ç‰¹å®šçš„å›è°ƒå‡½æ•°ã€‚è¿™äº›å›è°ƒå‡½æ•°æ˜¯åœ¨è®¾å¤‡é©±åŠ¨æˆ–ç›¸å…³çš„å†…æ ¸æ¨¡å—ä¸­å®šä¹‰çš„ï¼Œç”¨æ¥é€šçŸ¥å†…æ ¸å…¶ä»–éƒ¨åˆ†æˆ–è€…ç›¸å…³çš„è¿›ç¨‹æœ‰å…³äº‹ä»¶çš„å‘ç”Ÿã€‚</p><h2 id="æ–‡ä»¶æè¿°ç¬¦çš„å›è°ƒæœºåˆ¶">3. æ–‡ä»¶æè¿°ç¬¦çš„å›è°ƒæœºåˆ¶</h2><p>å¯¹äº <code>epoll</code> ç­‰ I/Oå¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œå†…æ ¸ä¸ºæ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦ç»´æŠ¤äº†ä¸€ä¸ªäº‹ä»¶å¤„ç†æœºåˆ¶ã€‚å½“æ–‡ä»¶æè¿°ç¬¦è¢«åˆ›å»ºæ—¶ï¼Œç›¸å…³çš„è®¾å¤‡æˆ–èµ„æºä¼šæ³¨å†Œä¸€ç»„å›è°ƒå‡½æ•°ï¼Œè¿™äº›å‡½æ•°ä¼šåœ¨ç‰¹å®šçš„æ“ä½œï¼ˆå¦‚è¯»ã€å†™ã€é”™è¯¯ï¼‰ä¸Šè¢«è§¦å‘ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªç½‘ç»œå¥—æ¥å­—å¯èƒ½ä¼šåœ¨æ•°æ®åˆ°è¾¾æ—¶è§¦å‘ä¸€ä¸ªâ€œå¯è¯»â€äº‹ä»¶çš„å›è°ƒã€‚</p><h2 id="epoll-çš„äº‹ä»¶ç»‘å®š">4. <code>epoll</code> çš„äº‹ä»¶ç»‘å®š</h2><p>å½“ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦è¢«åŠ å…¥åˆ° <code>epoll</code>ç›‘å¬é˜Ÿåˆ—ä¸­ï¼Œ<code>epoll</code>ä¼šåˆ©ç”¨è¿™äº›å›è°ƒæ¥è·å¾—äº‹ä»¶é€šçŸ¥ã€‚<code>epoll</code>æ“ä½œç›¸å…³çš„ä»£ç ä¼šå°†ä¸€ä¸ªé¢å¤–çš„å›è°ƒå‡½æ•°ç»‘å®šåˆ°è¿™äº›æ–‡ä»¶æè¿°ç¬¦ä¸Šã€‚å½“æ–‡ä»¶æè¿°ç¬¦çš„çŠ¶æ€æ”¹å˜æ—¶ï¼ˆå¦‚æ•°æ®å¯è¯»ï¼‰ï¼Œè¿™ä¸ªå›è°ƒå‡½æ•°å°†è¢«è§¦å‘ï¼Œç„¶åå®ƒä¼šå°†ç›¸åº”çš„æ–‡ä»¶æè¿°ç¬¦æ ‡è®°ä¸ºâ€œå°±ç»ªâ€ï¼Œå¹¶æ”¾å…¥<code>epoll</code> çš„å°±ç»ªé˜Ÿåˆ—ã€‚</p><h2 id="äº‹ä»¶é€šçŸ¥å’Œå”¤é†’">5. äº‹ä»¶é€šçŸ¥å’Œå”¤é†’</h2><p>å½“ <code>epoll_wait</code>è¢«è°ƒç”¨ä¸”æœ‰äº‹ä»¶å°±ç»ªæ—¶ï¼Œå†…æ ¸ä¼šæ£€æŸ¥å°±ç»ªé˜Ÿåˆ—ï¼Œå¹¶å°†è¿™äº›äº‹ä»¶ä¼ é€’ç»™ç­‰å¾…çš„è¿›ç¨‹ã€‚å¦‚æœæ²¡æœ‰äº‹ä»¶å°±ç»ªï¼Œè¿›ç¨‹å°†è¢«æŒ‚èµ·ç›´åˆ°æœ‰äº‹ä»¶å‘ç”Ÿã€‚äº‹ä»¶çš„å‘ç”Ÿä¼šè§¦å‘å†…æ ¸è°ƒåº¦ç¨‹åºå”¤é†’ç›¸åº”çš„è¿›ç¨‹ã€‚</p><h2 id="æ•ˆç‡å’Œæ€§èƒ½">6. æ•ˆç‡å’Œæ€§èƒ½</h2><p>è¿™ç§åŸºäºä¸­æ–­çš„äº‹ä»¶é€šçŸ¥æœºåˆ¶æ„å‘³ç€å†…æ ¸ä¸éœ€è¦ä¸æ–­å¾ªç¯æ£€æŸ¥æ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„çŠ¶æ€ï¼Œä»è€Œæå¤§åœ°æé«˜äº†æ•ˆç‡ã€‚äº‹ä»¶åªæœ‰åœ¨å®é™…å‘ç”Ÿæ—¶æ‰è¢«å¤„ç†ï¼Œä¸”å¤„ç†é€šå¸¸æ˜¯ç”±ç¡¬ä»¶ä¸­æ–­ç›´æ¥è§¦å‘çš„ï¼Œè¿™ä½¿å¾—æ•´ä¸ªç³»ç»Ÿæ›´åŠ å“åº”å¿«é€Ÿï¼Œå‡å°‘äº†æ— æ•ˆçš„CPU ä½¿ç”¨ã€‚</p><p>è¿™ç§è®¾è®¡ä½¿å¾— Linux å†…æ ¸åœ¨å¤„ç†å¤§é‡å¹¶å‘ I/Oæ“ä½œæ—¶èƒ½å¤Ÿä¿æŒé«˜æ•ˆå’Œç¨³å®šï¼Œé€‚åˆæ„å»ºé«˜æ€§èƒ½çš„ç½‘ç»œæœåŠ¡å’Œåº”ç”¨ã€‚</p><h1 id="ä¸­æ–­">ä¸­æ–­</h1><p>ä¸­æ–­æœºåˆ¶æ˜¯è®¡ç®—æœºç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿæ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œå®ƒå…è®¸å¤–è®¾æˆ–ç¡¬ä»¶å¼‚æ­¥åœ°é€šçŸ¥CPU éœ€è¦å¤„ç†æŸäº›äº‹ä»¶ã€‚ä¸­æ–­æœºåˆ¶çš„å®ç°å¹¶ä¸ä¾èµ–äºç±»ä¼¼äº <code>for</code>å¾ªç¯çš„è½®è¯¢æ£€æŸ¥ï¼Œè€Œæ˜¯å»ºç«‹åœ¨æ›´ä¸ºç›´æ¥å’Œé«˜æ•ˆçš„ç¡¬ä»¶å’Œå¤„ç†å™¨æ¶æ„æ”¯æŒä¹‹ä¸Šã€‚</p><p>å½“ CPUæ¥æ”¶åˆ°ä¸­æ–­ä¿¡å·æ—¶ï¼Œå®ƒæ˜¯é€šè¿‡ä¸€å¥—å†…å»ºäºç¡¬ä»¶çš„åè°ƒæœºåˆ¶æ¥è¯†åˆ«å’Œå“åº”ä¸­æ–­çš„ã€‚è¿™ä¸ªè¿‡ç¨‹æ¶‰åŠç¡¬ä»¶ç”µè·¯è®¾è®¡ã€å¤„ç†å™¨æ¶æ„å’Œæ“ä½œç³»ç»Ÿçš„ä¸­æ–­ç®¡ç†åŠŸèƒ½ã€‚</p><p>ä»¥ä¸‹æ˜¯ CPU å¦‚ä½•çŸ¥é“æœ‰ä¸­æ–­å‘ç”Ÿï¼Œå¹¶ä¸”å¦‚ä½•å¤„ç†è¿™ä¸€ä¸­æ–­çš„è¯¦ç»†æ­¥éª¤ï¼š</p><h2 id="ä¸­æ–­ä¿¡å·çš„æ£€æµ‹å’Œå“åº”">ä¸­æ–­ä¿¡å·çš„æ£€æµ‹å’Œå“åº”</h2><ol type="1"><li><p><strong>ä¸­æ–­è¯·æ±‚çº¿ï¼ˆIRQï¼‰</strong>ï¼šå¤–éƒ¨è®¾å¤‡é€šè¿‡è¿æ¥åˆ°å¤„ç†å™¨çš„ä¸€ä¸ªç‰¹å®šçš„ç¡¬ä»¶çº¿è·¯ï¼ˆIRQï¼‰å‘é€ä¸­æ–­ä¿¡å·ã€‚è¿™ä¸ªçº¿è·¯ç›´æ¥ä¸å¤„ç†å™¨å†…çš„ä¸­æ–­æ§åˆ¶å•å…ƒï¼ˆInterruptControllerï¼‰ç›¸è¿ã€‚</p></li><li><p><strong>ä¸­æ–­æ§åˆ¶å™¨</strong>ï¼šå¤§å¤šæ•°ç°ä»£è®¡ç®—æœºç³»ç»Ÿä½¿ç”¨ä¸€ä¸ªæˆ–å¤šä¸ªä¸­æ–­æ§åˆ¶å™¨æ¥ç®¡ç†ä¸­æ–­ä¿¡å·ã€‚ä¸­æ–­æ§åˆ¶å™¨çš„ä»»åŠ¡æ˜¯æ¥æ”¶æ¥è‡ªå„ç§å¤–éƒ¨è®¾å¤‡çš„ä¸­æ–­è¯·æ±‚ï¼Œå¹¶å°†è¿™äº›è¯·æ±‚ä¼˜å…ˆçº§æ’åºåå‘é€ç»™CPUã€‚</p></li><li><p><strong>ä¸­æ–­å‘é‡</strong>ï¼šå½“ä¸­æ–­æ§åˆ¶å™¨æ¥æ”¶åˆ°ä¸€ä¸ªä¸­æ–­ä¿¡å·åï¼Œå®ƒä¼šæ ¹æ®ä¸­æ–­æºç¡®å®šä¸€ä¸ªä¸­æ–­å‘é‡ã€‚è¿™ä¸ªå‘é‡æ˜¯ä¸€ä¸ªæ•°å­—ï¼ŒæŒ‡å‘ä¸­æ–­å‘é‡è¡¨ä¸­å¯¹åº”çš„å…¥å£ï¼Œè¯¥å…¥å£åŒ…å«äº†å¤„ç†è¯¥ä¸­æ–­çš„ä¸­æ–­æœåŠ¡ä¾‹ç¨‹ï¼ˆISRï¼‰çš„åœ°å€ã€‚</p></li></ol><h2 id="cpu-å¦‚ä½•å¤„ç†ä¸­æ–­">CPU å¦‚ä½•å¤„ç†ä¸­æ–­</h2><ol type="1"><li><p><strong>å½“å‰æŒ‡ä»¤çš„å®Œæˆ</strong>ï¼šå½“ CPUæ¥æ”¶åˆ°ä¸­æ–­æ§åˆ¶å™¨å‘å‡ºçš„ä¸­æ–­ä¿¡å·æ—¶ï¼Œå®ƒé¦–å…ˆä¼šå®Œæˆå½“å‰æ‰§è¡Œçš„æŒ‡ä»¤ã€‚è¿™æ˜¯ä¸ºäº†ä¿è¯ç¨‹åºçš„çŠ¶æ€èƒ½å¤Ÿæ­£ç¡®ä¿å­˜ï¼Œä»è€Œåœ¨ä¸­æ–­å¤„ç†å®Œæ¯•åå¯ä»¥æ— ç¼åœ°æ¢å¤æ‰§è¡Œã€‚</p></li><li><p><strong>ä¿å­˜ä¸Šä¸‹æ–‡</strong>ï¼šä¸€æ—¦å½“å‰æŒ‡ä»¤æ‰§è¡Œå®Œæ¯•ï¼ŒCPUä¼šè‡ªåŠ¨ä¿å­˜å½“å‰çš„ç¨‹åºçŠ¶æ€ï¼ŒåŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰ã€å¯„å­˜å™¨å’Œå…¶ä»–å¿…è¦çš„çŠ¶æ€ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯é€šå¸¸è¢«æ¨é€åˆ°å½“å‰çš„æ ˆä¸Šã€‚</p></li><li><p><strong>è·³è½¬åˆ° ISR</strong>ï¼šCPUä½¿ç”¨ä¸­æ–­å‘é‡æ¥è®¿é—®ä¸­æ–­å‘é‡è¡¨ï¼Œæ‰¾åˆ°ä¸ä¸­æ–­å·å¯¹åº”çš„ä¸­æ–­æœåŠ¡ä¾‹ç¨‹ï¼ˆISRï¼‰çš„åœ°å€ï¼Œå¹¶è·³è½¬åˆ°è¯¥åœ°å€å¼€å§‹æ‰§è¡ŒISRã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯è‡ªåŠ¨çš„ï¼Œç”±å¤„ç†å™¨çš„å†…éƒ¨æœºåˆ¶æ§åˆ¶ã€‚</p></li><li><p><strong>æ‰§è¡ŒISR</strong>ï¼šä¸­æ–­æœåŠ¡ä¾‹ç¨‹ä¼šæ‰§è¡Œå¿…è¦çš„æ“ä½œæ¥å¤„ç†ä¸­æ–­ï¼Œæ¯”å¦‚è¯»å–æ•°æ®ç¼“å†²åŒºã€æ¸…é™¤è®¾å¤‡çŠ¶æ€æˆ–å‘é€ä¿¡å·ç­‰ã€‚</p></li><li><p><strong>æ¢å¤ä¸Šä¸‹æ–‡å¹¶è¿”å›</strong>ï¼šä¸€æ—¦ ISRæ‰§è¡Œå®Œæˆï¼Œå¤„ç†å™¨ä¼šä»æ ˆä¸Šæ¢å¤ä¹‹å‰ä¿å­˜çš„ç¨‹åºçŠ¶æ€ï¼Œå¹¶å°†æ§åˆ¶æƒè¿”å›åˆ°è¢«ä¸­æ–­çš„ç¨‹åºï¼Œç»§ç»­æ‰§è¡Œã€‚</p></li></ol><h2 id="ç¡¬ä»¶æ”¯æŒ">ç¡¬ä»¶æ”¯æŒ</h2><p>è¿™ä¸€è¿‡ç¨‹å¤§é‡ä¾èµ–äºå¤„ç†å™¨çš„ç¡¬ä»¶æ”¯æŒï¼Œå¦‚ä¸­æ–­å‘é‡è¡¨é€šå¸¸æ˜¯å›ºå®šåœ¨å¤„ç†å™¨çš„ç‰¹å®šå†…å­˜åœ°å€ä¸Šçš„ã€‚æ­¤å¤–ï¼Œç°ä»£å¤„ç†å™¨å¦‚x86æ¶æ„è¿˜æä¾›äº†æ›´é«˜çº§çš„åŠŸèƒ½ï¼Œæ¯”å¦‚æ”¯æŒå¤šé‡ä¸­æ–­æ§åˆ¶å™¨å’Œé«˜çº§å¯ç¼–ç¨‹ä¸­æ–­æ§åˆ¶å™¨ï¼ˆAPICï¼‰ç­‰ã€‚</p><p>è¿™ç§åŸºäºç¡¬ä»¶çš„ä¸­æ–­å“åº”æœºåˆ¶å…è®¸ CPUå¿«é€Ÿæœ‰æ•ˆåœ°å¤„ç†å„ç§å¤–éƒ¨äº‹ä»¶ï¼Œç¡®ä¿ç³»ç»Ÿçš„å“åº”æ€§å’Œç¨³å®šæ€§ã€‚</p><h1 id="å‚è€ƒ">å‚è€ƒ</h1><ul><li><ahref="https://blog.csdn.net/zhangyanfei01/article/details/114959103">å›¾è§£| æ·±å…¥æ­ç§˜ epoll æ˜¯å¦‚ä½•å®ç° IO å¤šè·¯å¤ç”¨çš„ï¼</a></li><li><ahref="https://blog.csdn.net/zhpCSDN921011/article/details/125580548">ä¸€å›¾æ€»ç»“epoll çš„æ€»ä½“å·¥ä½œæµç¨‹</a></li><li><ahref="https://thetechsolo.wordpress.com/2016/02/29/scalable-io-events-vs-multithreading-based/">scalable-io-events-vs-multithreading-based</a></li><li><ahref="https://github.com/liexusong/linux-source-code-analyze/blob/master/epoll-principle.md">Epollå®ç°åŸç†</a></li><li><a href="https://zhuanlan.zhihu.com/p/667412830">ç½‘ç»œç¼–ç¨‹ä¹‹ epollæºç æ·±åº¦å‰–æ</a></li></ul>]]></content>
    
    
    <summary type="html">æœ¬æ–‡æ€»ç»“äº†é«˜æ€§èƒ½ç½‘ç»œæœåŠ¡å™¨ä¸­å¤§é‡ä½¿ç”¨çš„ I/O å¤šè·¯å¤ç”¨æŠ€æœ¯ epollï¼Œæ¶µç›–å·¥ä½œåŸç†ã€æ•°æ®ç»“æ„ã€äº‹ä»¶ç›‘å¬å’Œä¸­æ–­ç­‰ç›¸å…³å†…å®¹ã€‚</summary>
    
    
    
    <category term="è®¡ç®—æœºåŸºç¡€" scheme="https://hedon.top/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/"/>
    
    
    <category term="epoll" scheme="https://hedon.top/tags/epoll/"/>
    
    <category term="ç½‘ç»œç¼–ç¨‹" scheme="https://hedon.top/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"/>
    
    <category term="éé˜»å¡ I/0" scheme="https://hedon.top/tags/%E9%9D%9E%E9%98%BB%E5%A1%9E-I-0/"/>
    
  </entry>
  
  <entry>
    <title>Rust å®æˆ˜ä¸¨å¹¶å‘æ„å»ºå€’æ’ç´¢å¼•</title>
    <link href="https://hedon.top/2024/04/23/rust-action-inverted-index-concurrency/"/>
    <id>https://hedon.top/2024/04/23/rust-action-inverted-index-concurrency/</id>
    <published>2024-04-23T15:13:27.000Z</published>
    <updated>2024-04-23T15:49:04.234Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€">å¼•è¨€</h1><p>ç»§ä¸Šç¯‡ <ahref="https://hedon.top/2024/04/15/rust-action-inverted-index-demo/">Rustå®æˆ˜ä¸¨å€’æ’ç´¢å¼•</a>ï¼Œæœ¬ç¯‡æˆ‘ä»¬å°†å‚è€ƒã€ŠRustç¨‹åºè®¾è®¡ï¼ˆç¬¬äºŒç‰ˆï¼‰ã€‹ä¸­å¹¶å‘ç¼–ç¨‹ç¯‡ç« æ¥å®ç°é«˜å¹¶å‘æ„å»ºå€’æ’ç´¢å¼•ã€‚</p><p>æœ¬ç¯‡ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p><ol type="1"><li>åŠŸèƒ½å±•ç¤ºï¼šå±•ç¤ºæˆ‘ä»¬æœ€ç»ˆå®ç°çš„ 2ä¸ªå·¥å…·çš„æ•ˆæœï¼ˆæ„å»ºç´¢å¼•ã€æœç´¢åŠŸèƒ½ï¼‰</li><li>é˜…è¯»æºç ï¼šé˜…è¯»ä¹¦ä¸­æºç çš„å®ç°ï¼Œç†æ¸…å¤§ä½“æ€è·¯ã€‚</li><li>æ„å»ºç´¢å¼•ï¼šå®æˆ˜æ„å»ºç´¢å¼•çš„æ¯ä¸ªå…·ä½“ç¯èŠ‚ï¼Œå¹¶å¯¹æ ¸å¿ƒé€»è¾‘è¿›è¡Œè§£é‡Šå’Œé˜è¿°ç¼˜ç”±ã€‚</li><li>æœç´¢åŠŸèƒ½ï¼šè¿™æ˜¯ä¹¦ä¸­æœªæ›¾æä¾›çš„åŠŸèƒ½ï¼Œç¬”è€…æ ¹æ®è‡ªèº«ç†è§£ï¼Œå¯¹é½ä¸Šç¯‡æä¾›çš„åŠŸèƒ½ï¼Œå®ç°äº†ä¸€ä¸ªæœç´¢åŠŸèƒ½ã€‚</li></ol><p>èƒ½å­¦åˆ°ï¼š</p><ul><li>Rust å„ç§è¿­ä»£å™¨çš„ä½¿ç”¨</li><li>Rust æ–‡ä»¶å¸¸ç”¨æ“ä½œ</li><li>Rust å­—ç¬¦ä¸²å¸¸ç”¨æ“ä½œ</li><li>Rust channel å®æˆ˜</li><li>Rust å¹¶å‘ç¼–ç¨‹</li><li>å¤šè·¯åˆå¹¶æ–‡ä»¶å®é™…åº”ç”¨</li><li>ä½¿ç”¨ <code>byteorder</code> è¿›è¡Œä½æ“ä½œ</li><li>ä½¿ç”¨ <code>clap</code> è¿›è¡Œ CLI å¼€å‘</li><li>ç»ˆç«¯é«˜äº®è¾“å‡º</li><li>æ·±å…¥ç†è§£å€’æ’ç´¢å¼•é«˜æ€§èƒ½çš„æ ¸å¿ƒç»†èŠ‚</li></ul><h1 id="é˜…è¯»å»ºè®®">é˜…è¯»å»ºè®®</h1><p>æœ¬ç¯‡å†…å®¹è¾ƒä¸ºå†—é•¿ï¼Œæ¶‰åŠåˆ°çš„ç»†èŠ‚è®²è§£å¯èƒ½æ¯”è¾ƒå•°å—¦ï¼Œæ¨è<strong>ç›´æ¥é˜…è¯»æºç ï¼Œç„¶åå¯¹ä¸ç†è§£çš„åœ°æ–¹å†æ¥æœ¬ç¯‡å¯¹åº”çš„ç« èŠ‚è¿›è¡Œé˜…è¯»</strong>ã€‚</p><p>å®Œæˆæºç ä½äºï¼šhttps://github.com/hedon-rust-road/inverted-index-concurrency</p><h1 id="ç‰ˆæœ¬å£°æ˜">ç‰ˆæœ¬å£°æ˜</h1><ul><li>Rust: 1.76</li><li>byteordrr: 1.5.0</li><li>clap: 4.5.0</li><li>è¿è¡Œç¯å¢ƒï¼šmacbookPro Apple M2 Max</li></ul><h1 id="åŠŸèƒ½å±•ç¤º">åŠŸèƒ½å±•ç¤º</h1><h2 id="create.rs">create.rs</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">Usage: create [OPTIONS] &lt;FILENAMES&gt;...<br><br>Arguments:<br>  &lt;FILENAMES&gt;...<br><br>Options:<br>  -s, --single-threaded  Default <span class="hljs-literal">false</span><br>  -h, --<span class="hljs-built_in">help</span>             Print <span class="hljs-built_in">help</span><br></code></pre></td></tr></table></figure><p>æŒ‡å®šæ–‡ä»¶ç›®å½•ï¼Œæ„å»ºç´¢å¼•ï¼Œå¯ä»¥ä½¿ç”¨ <code>-s</code>ä½¿ç”¨å•çº¿ç¨‹æ„å»ºï¼Œé»˜è®¤ä½¿ç”¨å¹¶å‘æ„å»ºã€‚</p><p>æ‰§è¡Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  inverted-index-concurrency git:(master) âœ— cargo run --bin create ./texts<br>    Finished dev [unoptimized + debuginfo] target(s) <span class="hljs-keyword">in</span> 0.08s<br>     Running `/Users/wangjiahan/rust-target/debug/create ./texts`<br>indexed document 0:<span class="hljs-string">&quot;./texts/text1.txt&quot;</span>, 22 bytes, 5 words<br>indexed document 1:<span class="hljs-string">&quot;./texts/text3.txt&quot;</span>, 27 bytes, 5 words<br>indexed document 2:<span class="hljs-string">&quot;./texts/text2.txt&quot;</span>, 39 bytes, 6 words<br>word count: 16<br>351 bytes main, 736 bytes total<br>wrote file <span class="hljs-string">&quot;./tmp00000001.dat&quot;</span><br></code></pre></td></tr></table></figure><h2 id="search.rs">search.rs</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">Usage: search --index-file &lt;INDEX_FILE&gt; --term &lt;TERM&gt;<br><br>Options:<br>  -i, --index-file &lt;INDEX_FILE&gt;  Specify index file path<br>  -t, --term &lt;TERM&gt;              Specify search term<br>  -h, --<span class="hljs-built_in">help</span>                     Print <span class="hljs-built_in">help</span><br></code></pre></td></tr></table></figure><p>æŒ‡å®šç´¢å¼•æ–‡ä»¶å’Œæœç´¢è¯æ¥è¿›è¡Œæœç´¢ã€‚</p><p>æ‰§è¡Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240423201406903.png"alt="search.rs æ‰§è¡Œç¤ºä¾‹" /><figcaption aria-hidden="true">search.rs æ‰§è¡Œç¤ºä¾‹</figcaption></figure><h1 id="é˜…è¯»æºç ">é˜…è¯»æºç </h1><blockquote><p>ä¹¦ä¸­çš„æºç ä½äºï¼š<ahref="https://github.com/ProgrammingRust/fingertips/tree/master">fingertips</a></p></blockquote><p>ç¬¬ä¸€éƒ¨åˆ†æˆ‘ä»¬å…ˆæ¥é˜…è¯»æºç ï¼Œä¹¦ä¸­å±•ç¤ºäº†è¿™æ ·ä¸€å¼ å›¾ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image00882.jpeg"alt="ç´¢å¼•æ„å»ºå™¨ç®¡é“ï¼Œå…¶ä¸­ç®­å¤´è¡¨ç¤ºé€šè¿‡é€šé“å°†å€¼ä»ä¸€ä¸ªçº¿ç¨‹å‘é€åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼ˆæœªå±•ç¤ºç£ç›˜ I/Oï¼‰" /><figcaptionaria-hidden="true">ç´¢å¼•æ„å»ºå™¨ç®¡é“ï¼Œå…¶ä¸­ç®­å¤´è¡¨ç¤ºé€šè¿‡é€šé“å°†å€¼ä»ä¸€ä¸ªçº¿ç¨‹å‘é€åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼ˆæœªå±•ç¤ºç£ç›˜I/Oï¼‰</figcaption></figure><p>ä»è¿™å¼ å›¾æˆ‘ä»¬å¤§æ¦‚å¯ä»¥çŒœæƒ³æœ¬æ¡ˆä¾‹ä¸­æ„å»ºå¹¶å‘ç´¢å¼•çš„è¿‡ç¨‹å¯èƒ½æ˜¯ï¼š</p><ol type="1"><li>è¯»å–æ–‡ä»¶å†…å®¹ï¼›</li><li>æ ¹æ®æ–‡ä»¶å†…å®¹æ„å»ºç´¢å¼•ï¼›</li><li>å¤šä¸ªç´¢å¼•è¿›è¡Œåˆå¹¶ï¼›</li><li>å°†ç´¢å¼•å†™å…¥æ–‡ä»¶ï¼›</li><li>å¤šä¸ªç´¢å¼•æ–‡ä»¶è¿›è¡Œåˆå¹¶ã€‚</li></ol><p>æŒ‰ç…§è¿™ä¸ªæ€è·¯çš„æŒ‡å¼•ï¼Œæˆ‘ä»¬æ‰“å¼€æºç ï¼Œä» <code>main.rs</code> çš„<code>main()</code> å‡ºå‘ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">single_threaded</span> = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">filenames</span> = <span class="hljs-built_in">vec!</span>[];<br><br>  <span class="hljs-comment">// å‘½ä»¤è¡Œå‚æ•°è§£æ</span><br>    &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">ap</span> = ArgumentParser::<span class="hljs-title function_ invoke__">new</span>();<br>        ap.<span class="hljs-title function_ invoke__">set_description</span>(<span class="hljs-string">&quot;Make an inverted index for searching documents.&quot;</span>);<br>        ap.<span class="hljs-title function_ invoke__">refer</span>(&amp;<span class="hljs-keyword">mut</span> single_threaded).<span class="hljs-title function_ invoke__">add_option</span>(<br>            &amp;[<span class="hljs-string">&quot;-1&quot;</span>, <span class="hljs-string">&quot;--single-threaded&quot;</span>],<br>            StoreTrue,<br>            <span class="hljs-string">&quot;Do all the work on a single thread.&quot;</span>,<br>        );<br>        ap.<span class="hljs-title function_ invoke__">refer</span>(&amp;<span class="hljs-keyword">mut</span> filenames).<span class="hljs-title function_ invoke__">add_argument</span>(<br>            <span class="hljs-string">&quot;filenames&quot;</span>,<br>            Collect,<br>            <span class="hljs-string">&quot;Names of files/directories to index. \</span><br><span class="hljs-string">                           For directories, all .txt files immediately \</span><br><span class="hljs-string">                           under the directory are indexed.&quot;</span>,<br>        );<br>        ap.<span class="hljs-title function_ invoke__">parse_args_or_exit</span>();<br>    &#125;<br><br>  <span class="hljs-comment">// æ„å»ºç´¢å¼•</span><br>    <span class="hljs-keyword">match</span> <span class="hljs-title function_ invoke__">run</span>(filenames, single_threaded) &#123;<br>        <span class="hljs-title function_ invoke__">Ok</span>(()) =&gt; &#123;&#125;<br>        <span class="hljs-title function_ invoke__">Err</span>(err) =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;error: &#123;&#125;&quot;</span>, err),<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol type="1"><li>è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Œè¿™é‡Œä½¿ç”¨ <code>argparse</code> è¿™ä¸ªæ¯”è¾ƒå¤è€çš„ crateæ¥è§£æï¼Œç°åœ¨ä¸€èˆ¬æ˜¯ä½¿ç”¨ <code>clap</code>ã€‚<ul><li><code>single_threaded:</code> æ˜¯å¦ä½¿ç”¨å•çº¿ç¨‹ï¼Œé»˜è®¤æ˜¯å¤šçº¿ç¨‹ã€‚</li><li><code>filenames</code>: æŒ‡å®šçš„æ–‡æœ¬æ–‡ä»¶æˆ–ç›®å½•ã€‚</li></ul></li><li><code>run</code> å‡½æ•°æ‰§è¡Œæ„å»ºç´¢å¼•ã€‚</li></ol><p>çœ‹ä¸€ä¸‹ <code>run</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">/// Generate an index for a bunch of text files.</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">run</span>(filenames: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">String</span>&gt;, single_threaded: <span class="hljs-type">bool</span>) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">output_dir</span> = PathBuf::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;.&quot;</span>);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">documents</span> = <span class="hljs-title function_ invoke__">expand_filename_arguments</span>(filenames)?;<br><br>    <span class="hljs-keyword">if</span> single_threaded &#123;<br>        <span class="hljs-title function_ invoke__">run_single_threaded</span>(documents, output_dir)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-title function_ invoke__">run_pipeline</span>(documents, output_dir)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>å•çº¿ç¨‹ï¼šrun_single_threaded</li><li>å¤šçº¿ç¨‹ï¼šrun_pipeline</li></ul><p>å…ˆä»ç®€å•çœ‹ï¼Œå•çº¿ç¨‹ï¼Œå¿½ç•¥æ‰æºç ä¸­å®šä¹‰çš„ç‰¹æ®Šæ•°æ®ç»“æ„ï¼Œå¯ä»¥å‘ç°è·Ÿæˆ‘ä»¬ä¸Šç¯‡ä»‹ç»çš„ç®€å•ç‰ˆå€’æ’ç´¢å¼•æ€è·¯åŸºæœ¬æ˜¯ä¸€è‡´çš„ï¼Œåªä¸è¿‡æœ¬æ¡ˆä¾‹ä¸­æ•°æ®æ˜¯ä»æ–‡ä»¶ä¸­è¯»ï¼Œæœ€ååˆä¼šå°†ç´¢å¼•å†™å…¥åˆ°æ–‡ä»¶ä¸­ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">run_single_threaded</span>(documents: <span class="hljs-type">Vec</span>&lt;PathBuf&gt;, output_dir: PathBuf) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">accumulated_index</span> = InMemoryIndex::<span class="hljs-title function_ invoke__">new</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">merge</span> = FileMerge::<span class="hljs-title function_ invoke__">new</span>(&amp;output_dir);<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">tmp_dir</span> = TmpDir::<span class="hljs-title function_ invoke__">new</span>(&amp;output_dir);<br><br>    <span class="hljs-comment">// è¿­ä»£æ¯ä¸ªæ–‡æœ¬æ–‡ä»¶</span><br>    <span class="hljs-keyword">for</span> (doc_id, filename) <span class="hljs-keyword">in</span> documents.<span class="hljs-title function_ invoke__">into_iter</span>().<span class="hljs-title function_ invoke__">enumerate</span>() &#123;<br>      <span class="hljs-comment">// æ‰“å¼€æ–‡ä»¶ï¼Œå¹¶å°†å†…å®¹è¯»å–åˆ° `text` ä¸Š</span><br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">f</span> = File::<span class="hljs-title function_ invoke__">open</span>(filename)?;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">text</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">new</span>();<br>        f.<span class="hljs-title function_ invoke__">read_to_string</span>(&amp;<span class="hljs-keyword">mut</span> text)?;<br><br>        <span class="hljs-comment">// æ„å»ºç´¢å¼•</span><br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">index</span> = InMemoryIndex::<span class="hljs-title function_ invoke__">from_single_document</span>(doc_id, text);<br>        accumulated_index.<span class="hljs-title function_ invoke__">merge</span>(index);<br>        <span class="hljs-keyword">if</span> accumulated_index.<span class="hljs-title function_ invoke__">is_large</span>() &#123;<br>            <span class="hljs-comment">// å½“ç´¢å¼•è¶³å¤Ÿå¤§çš„æ—¶å€™ï¼Œå°†å…¶å†™åˆ°æ–‡ä»¶ä¸­</span><br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">file</span> = <span class="hljs-title function_ invoke__">write_index_to_tmp_file</span>(accumulated_index, &amp;<span class="hljs-keyword">mut</span> tmp_dir)?;<br>            merge.<span class="hljs-title function_ invoke__">add_file</span>(file)?;<br>            accumulated_index = InMemoryIndex::<span class="hljs-title function_ invoke__">new</span>();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// å°†æœ€åä¸€ä¸ªç´¢å¼•å†™å…¥åˆ°æ–‡ä»¶ä¸­</span><br>    <span class="hljs-keyword">if</span> !accumulated_index.<span class="hljs-title function_ invoke__">is_empty</span>() &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">file</span> = <span class="hljs-title function_ invoke__">write_index_to_tmp_file</span>(accumulated_index, &amp;<span class="hljs-keyword">mut</span> tmp_dir)?;<br>        merge.<span class="hljs-title function_ invoke__">add_file</span>(file)?;<br>    &#125;<br>    merge.<span class="hljs-title function_ invoke__">finish</span>()<br>&#125;<br></code></pre></td></tr></table></figure><p>å†æ¥çœ‹æœ¬æ–‡çš„é‡å¤´æˆï¼Œå¤šçº¿ç¨‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">run_pipeline</span>(documents: <span class="hljs-type">Vec</span>&lt;PathBuf&gt;, output_dir: PathBuf) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-comment">// å°†æ„å»ºç´¢å¼•åˆ†ä¸º 5 ä¸ªè¿‡ç¨‹</span><br>    <span class="hljs-keyword">let</span> (texts, h1) = <span class="hljs-title function_ invoke__">start_file_reader_thread</span>(documents);<br>    <span class="hljs-keyword">let</span> (pints, h2) = <span class="hljs-title function_ invoke__">start_file_indexing_thread</span>(texts);<br>    <span class="hljs-keyword">let</span> (gallons, h3) = <span class="hljs-title function_ invoke__">start_in_memory_merge_thread</span>(pints);<br>    <span class="hljs-keyword">let</span> (files, h4) = <span class="hljs-title function_ invoke__">start_index_writer_thread</span>(gallons, &amp;output_dir);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">result</span> = <span class="hljs-title function_ invoke__">merge_index_files</span>(files, &amp;output_dir);<br><br>    <span class="hljs-comment">// ç­‰å¾…æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œå®Œæ¯•</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">r1</span> = h1.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br>    h2.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br>    h3.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">r4</span> = h4.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br><br>    r1?;<br>    r4?;<br>    result<br>&#125;<br></code></pre></td></tr></table></figure><p>é¦–å…ˆå°†ç´¢å¼•æ„å»ºåˆ†æˆ 5 ä¸ªé˜¶æ®µï¼š</p><p><strong>1. start_file_reader_thread</strong></p><p>å°±æ˜¯ä»æ–‡ä»¶ä¸­è¯»å–æ–‡æœ¬ä¿¡æ¯ï¼Œå¹¶å°†å…¶æ‰”è¿›<code>Receiver&lt;String&gt;</code> channel ä¸­ï¼Œä¼ åˆ°ä¸‹ä¸€ä¸ªé˜¶æ®µã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">start_file_reader_thread</span>(<br>    documents: <span class="hljs-type">Vec</span>&lt;PathBuf&gt;,<br>) <span class="hljs-punctuation">-&gt;</span> (Receiver&lt;<span class="hljs-type">String</span>&gt;, JoinHandle&lt;io::<span class="hljs-type">Result</span>&lt;()&gt;&gt;) &#123;<br>    <span class="hljs-keyword">let</span> (sender, receiver) = <span class="hljs-title function_ invoke__">channel</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">handle</span> = <span class="hljs-title function_ invoke__">spawn</span>(<span class="hljs-keyword">move</span> || &#123;<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">filename</span> <span class="hljs-keyword">in</span> documents &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">f</span> = File::<span class="hljs-title function_ invoke__">open</span>(filename)?;<br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">text</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">new</span>();<br>          <span class="hljs-comment">// è¯»å–æ–‡ä»¶å†…å®¹</span><br>            f.<span class="hljs-title function_ invoke__">read_to_string</span>(&amp;<span class="hljs-keyword">mut</span> text)?;<br>            <span class="hljs-keyword">if</span> sender.<span class="hljs-title function_ invoke__">send</span>(text).<span class="hljs-title function_ invoke__">is_err</span>() &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-title function_ invoke__">Ok</span>(())<br>    &#125;);<br>    (receiver, handle)<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>2. start_file_indexing_thread</strong></p><p>ä»ç¬¬ 1 æ­¥ä¼ è¿‡æ¥çš„æ–‡æœ¬ä¿¡æ¯ä¸­è°ƒç”¨<code>InMemoryIndex::from_single_document</code> æ„å»ºç´¢å¼•ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">start_file_indexing_thread</span>(<br>    texts: Receiver&lt;<span class="hljs-type">String</span>&gt;,<br>) <span class="hljs-punctuation">-&gt;</span> (Receiver&lt;InMemoryIndex&gt;, JoinHandle&lt;()&gt;) &#123;<br>    <span class="hljs-keyword">let</span> (sender, receiver) = <span class="hljs-title function_ invoke__">channel</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">handle</span> = <span class="hljs-title function_ invoke__">spawn</span>(<span class="hljs-keyword">move</span> || &#123;<br>        <span class="hljs-keyword">for</span> (doc_id, text) <span class="hljs-keyword">in</span> texts.<span class="hljs-title function_ invoke__">into_iter</span>().<span class="hljs-title function_ invoke__">enumerate</span>() &#123;<br>          <span class="hljs-comment">// æ„å»ºç´¢å¼•</span><br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">index</span> = InMemoryIndex::<span class="hljs-title function_ invoke__">from_single_document</span>(doc_id, text);<br>            <span class="hljs-keyword">if</span> sender.<span class="hljs-title function_ invoke__">send</span>(index).<span class="hljs-title function_ invoke__">is_err</span>() &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;);<br>    (receiver, handle)<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>3. start_in_memory_merge_thread</strong></p><p>å°†ç¬¬ 2 æ­¥æ„å»ºçš„å•ä¸€ç´¢å¼•è¿›è¡Œåˆå¹¶ï¼Œå¹¶å°†åˆå¹¶åçš„ç´¢å¼•ä¼ åˆ°ä¸‹ä¸€ä¸ªé˜¶æ®µã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">start_in_memory_merge_thread</span>(<br>    file_indexes: Receiver&lt;InMemoryIndex&gt;,<br>) <span class="hljs-punctuation">-&gt;</span> (Receiver&lt;InMemoryIndex&gt;, JoinHandle&lt;()&gt;) &#123;<br>    <span class="hljs-keyword">let</span> (sender, receiver) = <span class="hljs-title function_ invoke__">channel</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">handle</span> = <span class="hljs-title function_ invoke__">spawn</span>(<span class="hljs-keyword">move</span> || &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">accumulated_index</span> = InMemoryIndex::<span class="hljs-title function_ invoke__">new</span>();<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">fi</span> <span class="hljs-keyword">in</span> file_indexes &#123;<br>          <span class="hljs-comment">// å°†ç´¢å¼•è¿›è¡Œåˆå¹¶</span><br>            accumulated_index.<span class="hljs-title function_ invoke__">merge</span>(fi);<br>            <span class="hljs-keyword">if</span> accumulated_index.<span class="hljs-title function_ invoke__">is_large</span>() &#123;<br>              <span class="hljs-comment">// å¦‚æœç´¢å¼•å¤§å°åˆ°è¾¾é˜ˆå€¼ï¼Œåˆ™ä¼ åˆ°ä¸‹ä¸€é˜¶æ®µ</span><br>                <span class="hljs-keyword">if</span> sender.<span class="hljs-title function_ invoke__">send</span>(accumulated_index).<span class="hljs-title function_ invoke__">is_err</span>() &#123;<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>                accumulated_index = InMemoryIndex::<span class="hljs-title function_ invoke__">new</span>();<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> !accumulated_index.<span class="hljs-title function_ invoke__">is_empty</span>() &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">_</span> = sender.<span class="hljs-title function_ invoke__">send</span>(accumulated_index);<br>        &#125;<br>    &#125;);<br>    (receiver, handle)<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>4. start_index_writer_thread</strong></p><p>å°†ç¬¬ 3 æ­¥ä¼ æ¥çš„å†…å­˜ç´¢å¼•å†™å…¥åˆ°ä¸´æ—¶æ–‡ä»¶ä¸­ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">start_index_writer_thread</span>(<br>    big_indexes: Receiver&lt;InMemoryIndex&gt;,<br>    output_dir: &amp;Path,<br>) <span class="hljs-punctuation">-&gt;</span> (Receiver&lt;PathBuf&gt;, JoinHandle&lt;io::<span class="hljs-type">Result</span>&lt;()&gt;&gt;) &#123;<br>    <span class="hljs-keyword">let</span> (sender, receiver) = <span class="hljs-title function_ invoke__">channel</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">tmp_dir</span> = TmpDir::<span class="hljs-title function_ invoke__">new</span>(output_dir);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">handle</span> = <span class="hljs-title function_ invoke__">spawn</span>(<span class="hljs-keyword">move</span> || &#123;<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">index</span> <span class="hljs-keyword">in</span> big_indexes &#123;<br>          <span class="hljs-comment">// å°†ç´¢å¼•å†™å…¥ä¸´æ—¶æ–‡ä»¶ä¸­</span><br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">file</span> = <span class="hljs-title function_ invoke__">write_index_to_tmp_file</span>(index, &amp;<span class="hljs-keyword">mut</span> tmp_dir)?;<br>            <span class="hljs-keyword">if</span> sender.<span class="hljs-title function_ invoke__">send</span>(file).<span class="hljs-title function_ invoke__">is_err</span>() &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-title function_ invoke__">Ok</span>(())<br>    &#125;);<br>    (receiver, handle)<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>5. merge_index_files</strong></p><p>å°†ä¸´æ—¶æ–‡ä»¶è¿›è¡Œåˆå¹¶ï¼Œç”Ÿæˆæœ€ç»ˆçš„ç´¢å¼•æ–‡ä»¶ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">merge_index_files</span>(files: Receiver&lt;PathBuf&gt;, output_dir: &amp;Path) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">merge</span> = FileMerge::<span class="hljs-title function_ invoke__">new</span>(output_dir);<br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">file</span> <span class="hljs-keyword">in</span> files &#123;<br>        merge.<span class="hljs-title function_ invoke__">add_file</span>(file)?;<br>    &#125;<br>    merge.<span class="hljs-title function_ invoke__">finish</span>()<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ 5 ä¸ªæ­¥éª¤è·Ÿä¹¦ä¸­ç»™å‡ºçš„ç¤ºæ„å›¾åŸºæœ¬ä¸€è‡´ï¼Œæˆ‘ä»¬å†æ¥çœ‹<code>run_pipeline</code> æ˜¯å¦‚ä½•åˆå¹¶å¹¶è¡Œçš„ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// ä½¿ç”¨ join() ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ</span><br><span class="hljs-keyword">let</span> <span class="hljs-variable">r1</span> = h1.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br>h2.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br>h3.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br><span class="hljs-keyword">let</span> <span class="hljs-variable">r4</span> = h4.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br><br><span class="hljs-comment">// é˜¶æ®µ 2 å’Œé˜¶æ®µ 3 éƒ½æ˜¯çº¯å†…å­˜æ“ä½œï¼Œä¸ä¼šæœ‰é”™è¯¯</span><br><span class="hljs-comment">// é˜¶æ®µ 1 æ˜¯è¯»æ–‡ä»¶ï¼Œé˜¶æ®µ 4 æ˜¯å†™æ–‡ä»¶ï¼Œæ‰€ä»¥æœ‰å¯èƒ½ä¼šæŠ¥é”™</span><br>r1?;<br>r4?;<br></code></pre></td></tr></table></figure><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240416001044618.png"alt="run_pipeline ç¤ºæ„å›¾" /><figcaption aria-hidden="true">run_pipeline ç¤ºæ„å›¾</figcaption></figure><p>æºç é˜…è¯»éƒ¨åˆ†å·®ä¸å¤šå°±åˆ°è¿™äº†ï¼Œå¤§çš„æ€æƒ³æ¶æ„ä½ åº”è¯¥éƒ½èƒ½ Getåˆ°äº†ï¼Œå…¶ä¸­æ¯ä¸ªæ•°æ®ç»“æ„çš„å…·ä½“å®ç°ç»†èŠ‚ï¼Œæˆ‘ä»¬åœ¨åé¢çš„å®æˆ˜ä¸­è¿›è¡Œæ‹†è§£ã€‚</p><h1 id="æ„å»ºç´¢å¼•">æ„å»ºç´¢å¼•</h1><h2 id="ä»£ç ç»“æ„">ä»£ç ç»“æ„</h2><p>ä¹¦ä¸­æºç ä»£ç ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs stylus">âœ  fingertips git:(master) âœ— tree<br>.<br>â”œâ”€â”€ Cargo<span class="hljs-selector-class">.lock</span><br>â”œâ”€â”€ Cargo<span class="hljs-selector-class">.toml</span><br>â”œâ”€â”€ LICENSE-MIT<br>â”œâ”€â”€ README<span class="hljs-selector-class">.md</span><br>â”œâ”€â”€ <span class="hljs-attribute">src</span><br>â”‚   â”œâ”€â”€ index<span class="hljs-selector-class">.rs</span><br>â”‚   â”œâ”€â”€ <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.rs</span><br>â”‚   â”œâ”€â”€ merge<span class="hljs-selector-class">.rs</span><br>â”‚   â”œâ”€â”€ read<span class="hljs-selector-class">.rs</span><br>â”‚   â”œâ”€â”€ tmp<span class="hljs-selector-class">.rs</span><br>â”‚   â””â”€â”€ write.rs<br></code></pre></td></tr></table></figure><p>ä¹¦ä¸­ç»™å‡ºçš„æºç å¹¶æ²¡æœ‰å®ç°ä½¿ç”¨æ„å»ºå¥½çš„ç´¢å¼•æ–‡ä»¶è¿›è¡Œæœç´¢çš„åŠŸèƒ½ï¼Œç¬”è€…å°†åœ¨æ­¤åŸºç¡€ä¸Šå®ç°è¯¥åŠŸèƒ½ï¼Œæ‰€ä»¥å¯¹ä»£ç ç»“æ„è¿›è¡Œäº†ç®€å•çš„è°ƒæ•´ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs stylus">âœ  inverted_index git:(master) âœ— tree<br>.<br>â”œâ”€â”€ Cargo<span class="hljs-selector-class">.lock</span><br>â”œâ”€â”€ Cargo<span class="hljs-selector-class">.toml</span><br>â”œâ”€â”€ index<span class="hljs-selector-class">.bat</span><br>â”œâ”€â”€ <span class="hljs-attribute">src</span><br>â”‚   â”œâ”€â”€ bin<br>â”‚   â”‚   â”œâ”€â”€ create<span class="hljs-selector-class">.rs</span><br>â”‚   â”‚   â””â”€â”€ search<span class="hljs-selector-class">.rs</span><br>â”‚   â”œâ”€â”€ index<span class="hljs-selector-class">.rs</span><br>â”‚   â”œâ”€â”€ lib<span class="hljs-selector-class">.rs</span><br>â”‚   â”œâ”€â”€ merge<span class="hljs-selector-class">.rs</span><br>â”‚   â”œâ”€â”€ read<span class="hljs-selector-class">.rs</span><br>â”‚   â”œâ”€â”€ tmp<span class="hljs-selector-class">.rs</span><br>â”‚   â””â”€â”€ write<span class="hljs-selector-class">.rs</span><br>â””â”€â”€ texts<br>    â”œâ”€â”€ text1<span class="hljs-selector-class">.txt</span><br>    â”œâ”€â”€ text2<span class="hljs-selector-class">.txt</span><br>    â””â”€â”€ text3.txt<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æˆ‘å°†æ ¸å¿ƒä»£ç ä» <code>bin</code> æ”¹æˆäº† <code>lib</code>ï¼Œè¿™æ˜¯ä¸ºäº†æ”¯æŒæˆ‘åé¢è¦å®ç°çš„ä¸¤ä¸ª <code>bin</code>:</p><ul><li><code>create</code>: æ„å»ºç´¢å¼•ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯æºä»£ç ä¸­çš„<code>main.rs</code></li><li><code>search</code>: åŸºäºç”Ÿæˆçš„ç´¢å¼•æ–‡ä»¶å®ç°æœç´¢åŠŸèƒ½</li></ul><p><code>texts</code> æ˜¯æˆ‘æä¾›çš„æ–‡æœ¬æ–‡ä»¶æ ·ä¾‹ã€‚</p><p><code>src</code> ç›®å½•ä¸­çš„ä»£ç é˜…è¯»é¡ºåºåŠåŠŸèƒ½åˆ’åˆ†å¦‚ä¸‹ï¼š</p><ul><li><code>index</code>: å®šä¹‰äº†å†…å­˜ç´¢å¼•æ•°æ®ç»“æ„InMemoryIndexï¼Œå®ç°äº†ä»æ–‡ä»¶å†…å®¹ä¸­æ„å»ºå†…å­˜ç´¢å¼•çš„åŸºæœ¬é€»è¾‘ï¼Œä¹Ÿå®ç°äº†ä»ç´¢å¼•æ–‡ä»¶é‡å»ºå†…å­˜ç´¢å¼•çš„åŠŸèƒ½ã€‚</li><li><code>tmp</code>: å®šä¹‰äº†ä¸´æ—¶ç›®å½•æ•°æ®ç»“æ„TmpDirï¼Œç”¨äºå­˜æ”¾ä¸´æ—¶ç´¢å¼•æ–‡ä»¶ã€‚</li><li><code>write</code>: å®šä¹‰äº†ç´¢å¼•æ–‡ä»¶å†™å…¥å™¨ IndexFileWriterï¼Œå®ç°äº†å°†InMemoryIndex å†™å…¥æ–‡ä»¶ä¸­çš„é€»è¾‘ã€‚</li><li><code>merge</code>: å®šä¹‰äº†æ–‡ä»¶åˆå¹¶å™¨ FileMergeï¼Œç”¨äºåˆå¹¶ TmpDirçš„æ‰€æœ‰ç´¢å¼•æ–‡ä»¶ã€‚</li><li><code>read</code>: å®šä¹‰äº†ç´¢å¼•æ–‡ä»¶è¯»å–å™¨IndexFileWriteï¼Œå®ç°äº†è§£æç´¢å¼•æ–‡ä»¶çš„é€»è¾‘ã€‚</li></ul><h2 id="é¡¹ç›®å‡†å¤‡">é¡¹ç›®å‡†å¤‡</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo new --lib inverted_index_concurrency<br></code></pre></td></tr></table></figure><p>Cargo.toml</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs toml"><span class="hljs-section">[package]</span><br><span class="hljs-attr">name</span> = <span class="hljs-string">&quot;inverted-index-concurrency&quot;</span><br><span class="hljs-attr">version</span> = <span class="hljs-string">&quot;0.1.0&quot;</span><br><span class="hljs-attr">edition</span> = <span class="hljs-string">&quot;2021&quot;</span><br><span class="hljs-attr">license</span> = <span class="hljs-string">&quot;mit&quot;</span><br><span class="hljs-attr">authors</span> = [<span class="hljs-string">&quot;hedon&quot;</span>]<br><span class="hljs-attr">description</span> = <span class="hljs-string">&quot;a tool to concurrently build an inverted index.&quot;</span><br><br><span class="hljs-section">[[bin]]</span><br><span class="hljs-attr">name</span>=<span class="hljs-string">&quot;create&quot;</span><br><span class="hljs-attr">path</span>=<span class="hljs-string">&quot;src/bin/create.rs&quot;</span><br><br><span class="hljs-section">[[bin]]</span><br><span class="hljs-attr">name</span>=<span class="hljs-string">&quot;search&quot;</span><br><span class="hljs-attr">path</span>=<span class="hljs-string">&quot;src/bin/search.rs&quot;</span><br><br><span class="hljs-section">[dependencies]</span><br><span class="hljs-attr">byteorder</span> = <span class="hljs-string">&quot;1.5.0&quot;</span><br><span class="hljs-attr">clap</span> = &#123; version = <span class="hljs-string">&quot;4.5.4&quot;</span>, features = [<span class="hljs-string">&quot;derive&quot;</span>] &#125;<br></code></pre></td></tr></table></figure><h2 id="lib.rs">lib.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">mod</span> index;<br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">mod</span> merge;<br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">mod</span> read;<br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">mod</span> tmp;<br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">mod</span> write;<br></code></pre></td></tr></table></figure><p>åœ¨ <code>lib.rs</code> ä¸­æˆ‘ä»¬å°†è¿™ 5 ä¸ª mod å…¬å¼€å‡ºå»ï¼Œè¿™æ ·å°±å¯ä»¥ç»™<code>bin</code> ç›®å½•ä¸­çš„ <code>crate.rs</code> å’Œ<code>search.rs</code> ä½¿ç”¨äº†ã€‚</p><h2 id="index.rs">index.rs</h2><blockquote><p>å®Œæ•´æºç ï¼š<ahref="https://github.com/hedon-rust-road/inverted-index-concurrency/blob/master/src/index.rs">index.rs</a></p></blockquote><p>ç¬¬ä¸€éƒ¨åˆ†æ˜¯å†…å­˜ç´¢å¼•çš„æ„å»ºã€‚</p><h3 id="tokenize">tokenize</h3><p>æˆ‘ä»¬å…ˆå®šä¹‰ä¸€ä¸ªåˆ†è¯å‡½æ•°ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">tokenize</span>(text: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Vec</span>&lt;(&amp;<span class="hljs-type">str</span>, <span class="hljs-type">usize</span>, <span class="hljs-type">usize</span>)&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">res</span> = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">new</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">token_start</span> = <span class="hljs-literal">None</span>;<br>    <span class="hljs-keyword">for</span> (idx, ch) <span class="hljs-keyword">in</span> text.<span class="hljs-title function_ invoke__">char_indices</span>() &#123;<br>        <span class="hljs-keyword">match</span> (ch.<span class="hljs-title function_ invoke__">is_alphanumeric</span>(), token_start) &#123;<br>            (<span class="hljs-literal">true</span>, <span class="hljs-literal">None</span>) =&gt; token_start = <span class="hljs-title function_ invoke__">Some</span>(idx),  <span class="hljs-comment">// æ¯ä¸ªå•è¯çš„å¼€å§‹</span><br>            (<span class="hljs-literal">false</span>, <span class="hljs-title function_ invoke__">Some</span>(start)) =&gt; &#123;  <span class="hljs-comment">// æ¯ä¸ªå•è¯çš„ç»“å°¾</span><br>                res.<span class="hljs-title function_ invoke__">push</span>((&amp;text[start..idx], start, idx - <span class="hljs-number">1</span>));<br>                token_start = <span class="hljs-literal">None</span><br>            &#125;<br>            _ =&gt; &#123;&#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(start) = token_start &#123;<br>        res.<span class="hljs-title function_ invoke__">push</span>((&amp;text[start..], start, text.<span class="hljs-title function_ invoke__">len</span>() - <span class="hljs-number">1</span>))<br>    &#125;<br>    res<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªåˆ†è¯å‡½æ•°è·Ÿä¹¦ä¸­æºç æä¾›çš„ä¸ä¸€æ ·ï¼Œä¸ºäº†å®ç°æ–‡æœ¬é«˜äº®ï¼Œæˆ‘ä»¬éœ€è¦è®°å½•æ¯ä¸ªåˆ†è¯åœ¨åŸæ–‡æœ¬ä¸­çš„èµ·å§‹ä½ç½®å’Œç»“æŸä½ç½®ã€‚å®ƒçš„æ ¸å¿ƒé€»è¾‘å¦‚ä¸‹ï¼š</p><ol type="1"><li><p>é€šè¿‡ <code>char_indices()</code> è·å– <code>text</code>çš„å­—ç¬¦è¿­ä»£å™¨ï¼Œè¿™æ˜¯ä¸€ç§æ‡’åŠ è½½çš„æ–¹æ³•ï¼Œé¿å…ä¸€æ¬¡æ€§å°†æ‰€æœ‰ charåŠ è½½åˆ°å†…å­˜ä¸­ã€‚</p></li><li><p>åŒ¹é… <code>(ch.is_alphanumeric(), token_start)</code>ï¼š</p><ul><li>å¦‚æœæ˜¯ <code>(true, None)</code>åˆ™è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå•è¯çš„å¼€å§‹ï¼Œæˆ‘ä»¬çºªå½•å…¶å¼€å§‹çš„ä½ç½®<code>Some(idx)</code>ï¼›</li><li>å¦‚æœæ˜¯ <code>(false, Some(idx))</code>åˆ™è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå•è¯çš„ç»“æŸï¼Œæˆ‘ä»¬å°†å…¶åŠ å…¥åˆ° <code>res</code>ä¸­ï¼Œå¹¶è®°å½•èµ·å§‹ä½ç½®å’Œç»“æŸä½ç½®ã€‚</li><li>å…¶ä»–æƒ…å†µï¼Œä¸åšå¤„ç†ï¼Œè¦ä¹ˆæ˜¯éæ³•å­—ç¬¦ï¼Œè¦ä¹ˆæ˜¯å¤„äºå•è¯ä¸­é—´ã€‚</li></ul><p>ä»è¿™ä¸ªç®€å•çš„ç†è§£ä¸­ï¼Œä½ åº”è¯¥å¯ä»¥æ„Ÿå—åˆ° Rust ä¸­ match patternçš„å¼ºå¤§å’Œä¾¿æ·äº†ï¼Œ666 ğŸ‘ğŸ»</p></li></ol><h3 id="struct-inmemoryindex">struct: InMemoryIndex</h3><p>åœ¨ <code>index.rs</code> ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸‰ä¸ªæ•°æ®ç»“æ„ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">InMemoryIndex</span> &#123;<br>    <span class="hljs-keyword">pub</span> word_count: <span class="hljs-type">usize</span>,<br>    <span class="hljs-keyword">pub</span> terms: HashMap&lt;<span class="hljs-type">String</span>, <span class="hljs-type">Vec</span>&lt;Hit&gt;&gt;,<br>    <span class="hljs-keyword">pub</span> docs: HashMap&lt;<span class="hljs-type">usize</span>, Document&gt;,<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Document</span> &#123;<br>    <span class="hljs-keyword">pub</span> id: <span class="hljs-type">u32</span>,<br>    <span class="hljs-keyword">pub</span> path: PathBuf,<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">Hit</span> = <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">u8</span>&gt;;<br></code></pre></td></tr></table></figure><ul><li><p><code>Document</code>: æ–‡æ¡£å°è£…ã€‚</p><ul><li><code>id</code>: æ–‡æ¡£ idï¼Œå”¯ä¸€æ ‡è¯†ç¬¦ã€‚</li><li><code>path</code>: æºæ–‡ä»¶è·¯å¾„ã€‚</li></ul></li><li><p><code>Hit</code>:å®ƒæ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„ï¼Œæˆ‘ä»¬æŒ‰ç…§å°ç«¯åºè¿›è¡Œå­˜å‚¨ï¼Œå®ƒçš„å­˜å‚¨ç»“æ„å¦‚ä¸‹ï¼š</p><ul><li>[0..3] å­˜å‚¨ä¸€ä¸ª <code>HITS_SEPERATOR = -1</code>ï¼Œè¡¨ç¤ºä¸€ä¸ª<code>Hit</code> çš„å¼€å§‹ã€‚</li><li>[4..7] å­˜å‚¨ä¸€ä¸ª u32 çš„ <code>document_id</code>ã€‚</li><li>åé¢æ¯ 8 ä¸ª u8 ä¼šå­˜åœ¨ä¸€ä¸ª u32 çš„ <code>start_pos</code> å’Œä¸€ä¸ª u32çš„ <code>end_pos</code>ã€‚</li></ul></li><li><p><code>InMemoryIndex</code>: å†…å­˜ç´¢å¼•ã€‚</p><ul><li><code>word_count</code>:åŒ…å«çš„å•è¯ï¼ˆword/termï¼‰ä¸ªæ•°ï¼Œè®°å½•å®ƒæ˜¯ä¸ºäº†åˆ¤æ–­ç´¢å¼•æ˜¯å¦è¿‡å¤§ï¼Œä»¥ä¾¿å¯¹ç´¢å¼•è¿›è¡Œåˆ†ç‰‡å­˜å‚¨ã€‚</li><li><code>terms</code>: å­˜å‚¨ word åˆ° Hits çš„æ˜ å°„ï¼Œæ¯ä¸ª <code>word</code>æ˜¯ä¸€ä¸ªæœç´¢é¡¹ã€‚</li><li><code>docs</code>: å­˜å‚¨äº† document_idåˆ°æ–‡æ¡£çš„æ˜ å°„ï¼Œç”¨äºæŸ¥è¯¢åŸå§‹æ–‡æ¡£ä¿¡æ¯ã€‚</li></ul></li></ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä¸º <code>InMemoryIndex</code>å®ç°ä¸€ç³»åˆ—æ–¹æ³•ï¼Œå› ä¸ºæˆ‘ä»¬æœŸæœ›ä½¿ç”¨å°ç«¯åºå­˜å‚¨ <code>Hit</code>ä¸­çš„æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¼•å…¥ <code>byteorder</code> è¿™ä¸ª crate:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo add byteorder<br></code></pre></td></tr></table></figure><p>å…·ä½“å®ç°å¯å‚è€ƒæºç ï¼Œæ ¸å¿ƒé€»è¾‘æ˜¯ <code>from_single_document</code> å’Œ<code>merge</code>ã€‚</p><h3 id="from_single_document">from_single_document</h3><p><strong>from_single_document</strong>çš„æ ¸å¿ƒé€»è¾‘åœ¨è¿™ä¸€æ®µï¼Œå®ƒå…¶å®è·Ÿæˆ‘ä»¬ä¹‹å‰å®ç°çš„ç®€æ˜“ç‰ˆå€’æ’ç´¢å¼•å¾ˆç›¸ä¼¼ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">for</span> (token, start_pos, end_pos) <span class="hljs-keyword">in</span> tokens.<span class="hljs-title function_ invoke__">iter</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">hits</span> = index.terms.<span class="hljs-title function_ invoke__">entry</span>(token.<span class="hljs-title function_ invoke__">to_string</span>()).<span class="hljs-title function_ invoke__">or_insert_with</span>(|| &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">hits</span> = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">with_capacity</span>(<span class="hljs-number">4</span> + <span class="hljs-number">4</span> + <span class="hljs-number">4</span> + <span class="hljs-number">4</span>);<br>        hits.write_i32::&lt;LittleEndian&gt;(<span class="hljs-keyword">Self</span>::HITS_SEPERATOR)<br>            .<span class="hljs-title function_ invoke__">unwrap</span>();<br>        hits.write_u32::&lt;LittleEndian&gt;(document_id).<span class="hljs-title function_ invoke__">unwrap</span>();<br>        <span class="hljs-built_in">vec!</span>[hits]<br>    &#125;);<br><br>    hits[<span class="hljs-number">0</span>].write_u32::&lt;LittleEndian&gt;(*start_pos <span class="hljs-keyword">as</span> <span class="hljs-type">u32</span>).<span class="hljs-title function_ invoke__">unwrap</span>();<br>    hits[<span class="hljs-number">0</span>].write_u32::&lt;LittleEndian&gt;(*end_pos <span class="hljs-keyword">as</span> <span class="hljs-type">u32</span>).<span class="hljs-title function_ invoke__">unwrap</span>();<br>    index.word_count += <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>éå†æ¯ä¸ª <code>token</code> å’Œå®ƒåœ¨æ–‡æœ¬ä¸­çš„ä½ç½®ã€‚</li><li>å¯¹äºæ¯ä¸ª <code>token</code>ï¼Œå°è¯•åœ¨ç´¢å¼•çš„ <code>map</code>ä¸­æŸ¥æ‰¾ä¸€ä¸ªç°æœ‰çš„æ¡ç›®ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>Hit</code>è®°å½•ï¼Œå¹¶åˆå§‹åŒ–å®ƒï¼š<ul><li>åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>Hit</code> å‘é‡ï¼Œé¢„ç•™ 24å­—èŠ‚çš„å®¹é‡ï¼Œè¿™æ˜¯å› ä¸ºè‡³å°‘è¦å­˜å‚¨ 1 ä¸ªåˆ†éš”ç¬¦ã€1 ä¸ª document_idã€1 ä¸ªstart_pos å’Œ 1 ä¸ª end_posã€‚</li><li>é¦–å…ˆå†™å…¥ <code>HITS_SEPERATOR</code> å’Œ<code>document_id</code>ï¼ˆä½¿ç”¨å°ç«¯åºï¼‰ã€‚</li></ul></li><li>å‘å¯¹åº”çš„ <code>Hit</code> å‘é‡ä¸­æ·»åŠ å½“å‰å•è¯çš„ä½ç½®ã€‚</li><li>ç´¯åŠ å¤„ç†çš„å•è¯æ€»æ•°åˆ° <code>index.word_count</code>ã€‚</li></ul><p>è¿™é‡Œç»™ä¸ªç¤ºä¾‹ï¼Œå¸Œæœ›å¯ä»¥å¸®åŠ©ä½ ç†è§£ <code>InMemoryIndex</code>çš„å†…å­˜ç»“æ„ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">InMemoryIndex</span><br><span class="hljs-string">â”‚</span><br><span class="hljs-string">â”œâ”€â”€</span> <span class="hljs-attr">word_count:</span> <span class="hljs-string">usize</span><br><span class="hljs-string">â”‚</span><br><span class="hljs-string">â”œâ”€â”€</span> <span class="hljs-attr">terms:</span> <span class="hljs-string">HashMap&lt;String,</span> <span class="hljs-string">Vec&lt;Hit&gt;&gt;</span><br><span class="hljs-string">â”‚</span>   <span class="hljs-string">â”‚</span><br><span class="hljs-string">â”‚</span>   <span class="hljs-string">â”œâ”€â”€</span> <span class="hljs-attr">Key:</span> <span class="hljs-string">&quot;example&quot;</span> <span class="hljs-string">(String)</span><br><span class="hljs-string">â”‚</span>   <span class="hljs-string">â”‚</span>   <span class="hljs-string">â””â”€â”€</span> <span class="hljs-attr">Value:</span> <span class="hljs-string">Vec&lt;Hit&gt;</span><br><span class="hljs-string">â”‚</span>   <span class="hljs-string">â”‚</span>       <span class="hljs-string">â”œâ”€â”€</span> [<span class="hljs-string">HITS_SEPERATOR</span>, <span class="hljs-attr">Document ID:</span> <span class="hljs-number">1</span>, <span class="hljs-attr">Positions:</span> [<span class="hljs-number">10</span>, <span class="hljs-number">19</span>, <span class="hljs-number">30</span>, <span class="hljs-number">39</span>]] <span class="hljs-string">(Hit)</span><br><span class="hljs-string">â”‚</span>   <span class="hljs-string">â”‚</span>       <span class="hljs-string">â””â”€â”€</span> [<span class="hljs-string">HITS_SEPERATOR</span>, <span class="hljs-attr">Document ID:</span> <span class="hljs-number">2</span>, <span class="hljs-attr">Positions:</span> [<span class="hljs-number">15</span>, <span class="hljs-number">25</span>]] <span class="hljs-string">(Hit)</span><br><span class="hljs-string">â”‚</span>   <span class="hljs-string">â”‚</span><br><span class="hljs-string">â”‚</span>   <span class="hljs-string">â””â”€â”€</span> <span class="hljs-attr">Key:</span> <span class="hljs-string">&quot;test&quot;</span><br><span class="hljs-string">â”‚</span>       <span class="hljs-string">â””â”€â”€</span> <span class="hljs-attr">Value:</span> <span class="hljs-string">Vec&lt;Hit&gt;</span><br><span class="hljs-string">â”‚</span>           <span class="hljs-string">â””â”€â”€</span> [<span class="hljs-string">HITS_SEPERATOR</span>, <span class="hljs-attr">Document ID:</span> <span class="hljs-number">1</span>, <span class="hljs-attr">Positions:</span> [<span class="hljs-number">20</span>, <span class="hljs-number">24</span>, <span class="hljs-number">50</span>, <span class="hljs-number">69</span>]] <span class="hljs-string">(Hit)</span><br><span class="hljs-string">â”‚</span><br><span class="hljs-string">â””â”€â”€</span> <span class="hljs-attr">docs:</span> <span class="hljs-string">HashMap&lt;u32,</span> <span class="hljs-string">Document&gt;</span><br>    <span class="hljs-string">â”œâ”€â”€</span> <span class="hljs-attr">Key:</span> <span class="hljs-number">1</span> <span class="hljs-string">(u32)</span><br>    <span class="hljs-string">â”‚</span>   <span class="hljs-string">â””â”€â”€</span> <span class="hljs-attr">Value:</span> <span class="hljs-string">Document</span> &#123; <span class="hljs-attr">id:</span> <span class="hljs-number">1</span>, <span class="hljs-attr">path:</span> <span class="hljs-string">&quot;path/to/file1.txt&quot;</span>&#125;<br>    <span class="hljs-string">â””â”€â”€</span> <span class="hljs-attr">Key:</span> <span class="hljs-number">2</span><br>        <span class="hljs-string">â””â”€â”€</span> <span class="hljs-attr">Value:</span> <span class="hljs-string">Document</span> &#123; <span class="hljs-attr">id:</span> <span class="hljs-number">2</span>, <span class="hljs-attr">path:</span> <span class="hljs-string">&quot;path/to/file2.txt&quot;</span>&#125;<br></code></pre></td></tr></table></figure><h3 id="merge">merge</h3><p><strong>merge</strong> æ˜¯ç”¨äºåˆå¹¶å¤šä¸ª<code>InMemoryIndex</code>ï¼Œèµ·åˆ°æ‰¹å¤„ç†çš„ç›®çš„ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">merge</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, other: InMemoryIndex) &#123;<br>    <span class="hljs-keyword">for</span> (term, hits) <span class="hljs-keyword">in</span> other.terms &#123;<br>        <span class="hljs-keyword">self</span>.terms.<span class="hljs-title function_ invoke__">entry</span>(term).<span class="hljs-title function_ invoke__">or_default</span>().<span class="hljs-title function_ invoke__">extend</span>(hits)<br>    &#125;<br>    <span class="hljs-keyword">self</span>.word_count += other.word_count;<br>    <span class="hljs-keyword">self</span>.docs.<span class="hljs-title function_ invoke__">extend</span>(other.docs);<br>&#125;<br></code></pre></td></tr></table></figure><p>å®ç°å®Œäº† <code>InMemoryIndex</code> åï¼Œæˆ‘ä»¬å°±å¯ä»¥å…ˆæ¥å®Œæˆ<code>create.rs</code> çš„ <code>run_pipeline</code> çš„å‰ 3ä¸ªé˜¶æ®µäº†ã€‚</p><h3 id="step1-start_file_reader_thread">step1:start_file_reader_thread</h3><ol type="1"><li>è¯»å–æ–‡ä»¶ä¿¡æ¯ï¼šæˆ‘ä»¬éœ€è¦åœ¨ç‹¬ç«‹çš„çº¿ç¨‹ä¸­ä¾æ¬¡æ‰“å¼€ç»™å®šçš„æ–‡ä»¶åˆ—è¡¨ï¼Œå¹¶å°†æ–‡ä»¶å†…å®¹è¯»å–åˆ°ä¸€ä¸ªString ä¸­ï¼Œå¹¶åˆ©ç”¨ channel ä¼ é€å‡ºå»ã€‚</li></ol><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">start_file_reader_thread</span>(<br>    documents: <span class="hljs-type">Vec</span>&lt;PathBuf&gt;,<br>) <span class="hljs-punctuation">-&gt;</span> (Receiver&lt;(PathBuf, <span class="hljs-type">String</span>)&gt;, JoinHandle&lt;io::<span class="hljs-type">Result</span>&lt;()&gt;&gt;) &#123;<br>    <span class="hljs-keyword">let</span> (sender, receiver) = <span class="hljs-title function_ invoke__">channel</span>();<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">handler</span> = <span class="hljs-title function_ invoke__">spawn</span>(<span class="hljs-keyword">move</span> || &#123;<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">filename</span> <span class="hljs-keyword">in</span> documents &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">f</span> = File::<span class="hljs-title function_ invoke__">open</span>(filename.<span class="hljs-title function_ invoke__">clone</span>())?;<br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">text</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">new</span>();<br>            f.<span class="hljs-title function_ invoke__">read_to_string</span>(&amp;<span class="hljs-keyword">mut</span> text)?;<br>            <span class="hljs-keyword">if</span> sender.<span class="hljs-title function_ invoke__">send</span>((filename, text)).<span class="hljs-title function_ invoke__">is_err</span>() &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-title function_ invoke__">Ok</span>(())<br>    &#125;);<br><br>    (receiver, handler)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="step2-start_file_indexing_thread">step2:start_file_indexing_thread</h3><ol start="2" type="1"><li>æ„å»ºç´¢å¼•ï¼šé€šè¿‡ channel ä»ç¬¬ 1 é˜¶æ®µä¸­è·å–æ–‡æ¡£æ–‡æœ¬ä¿¡æ¯ï¼Œé€šè¿‡from_single_document æ„å»ºç´¢å¼• InMemoryIndex åï¼Œå°†ç´¢å¼•é€šè¿‡ channelä¼ é€å‡ºå»ã€‚</li></ol><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">start_file_indexing_thread</span>(<br>    docs: Receiver&lt;(PathBuf, <span class="hljs-type">String</span>)&gt;,<br>) <span class="hljs-punctuation">-&gt;</span> (Receiver&lt;InMemoryIndex&gt;, JoinHandle&lt;()&gt;) &#123;<br>    <span class="hljs-keyword">let</span> (sender, receiver) = <span class="hljs-title function_ invoke__">channel</span>();<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">handler</span> = <span class="hljs-title function_ invoke__">spawn</span>(<span class="hljs-keyword">move</span> || &#123;<br>        <span class="hljs-keyword">for</span> (doc_id, (path, text)) <span class="hljs-keyword">in</span> docs.<span class="hljs-title function_ invoke__">into_iter</span>().<span class="hljs-title function_ invoke__">enumerate</span>() &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">index</span> = InMemoryIndex::<span class="hljs-title function_ invoke__">from_single_document</span>(doc_id <span class="hljs-keyword">as</span> <span class="hljs-type">u32</span>, path, text);<br>            <span class="hljs-keyword">if</span> sender.<span class="hljs-title function_ invoke__">send</span>(index).<span class="hljs-title function_ invoke__">is_err</span>() &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;);<br><br>    (receiver, handler)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="step3-start_in_memory_merge_thread">step3:start_in_memory_merge_thread</h3><ol start="3" type="1"><li>åˆå¹¶ç´¢å¼•ï¼šé€šè¿‡ channel ä»ç¬¬ 2 é˜¶æ®µä¸­è·å¾—æ„å»ºçš„ InMemoryIndexå¹¶å°†å…¶åˆå¹¶æˆå¤§ç´¢å¼•ï¼Œç„¶åé€šè¿‡ channel ä¼ é€å‡ºå»ã€‚</li></ol><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">start_in_memory_merge_thread</span>(<br>    indexes: Receiver&lt;InMemoryIndex&gt;,<br>) <span class="hljs-punctuation">-&gt;</span> (Receiver&lt;InMemoryIndex&gt;, JoinHandle&lt;()&gt;) &#123;<br>    <span class="hljs-keyword">let</span> (sender, receiver) = <span class="hljs-title function_ invoke__">channel</span>();<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">handle</span> = <span class="hljs-title function_ invoke__">spawn</span>(<span class="hljs-keyword">move</span> || &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">accumulated_index</span> = InMemoryIndex::<span class="hljs-title function_ invoke__">new</span>();<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> indexes &#123;<br>            accumulated_index.<span class="hljs-title function_ invoke__">merge</span>(i);<br>            <span class="hljs-keyword">if</span> accumulated_index.<span class="hljs-title function_ invoke__">is_large</span>() &#123;<br>                <span class="hljs-keyword">if</span> sender.<span class="hljs-title function_ invoke__">send</span>(accumulated_index).<span class="hljs-title function_ invoke__">is_err</span>() &#123;<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>                accumulated_index = InMemoryIndex::<span class="hljs-title function_ invoke__">new</span>();<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> !accumulated_index.<span class="hljs-title function_ invoke__">is_empty</span>() &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">_</span> = sender.<span class="hljs-title function_ invoke__">send</span>(accumulated_index);<br>        &#125;<br>    &#125;);<br><br>    (receiver, handle)<br>&#125;<br></code></pre></td></tr></table></figure><div class="note note-info">            <p><big><strong>è¡¥å……ï¼šä¸ºä»€ä¹ˆé‡‡ç”¨è¿™ç§â€œå¤æ‚â€çš„æ–¹å¼æ¥å­˜å‚¨æ•°æ®å‘¢ï¼Ÿå¯å¦ä½¿ç”¨JSON æˆ–è€… Protobuf å‘¢ï¼Ÿ</strong></big></p><p>é€‰æ‹©å¦‚ä½•ç»„ç»‡å’Œå­˜å‚¨æ•°æ®ï¼Œç‰¹åˆ«æ˜¯åœ¨å®ç°ä¸€ä¸ªæœç´¢å¼•æ“æˆ–æ•°æ®åº“ç´¢å¼•æ—¶ï¼Œæ˜¯ä¸€ä¸ªå…³é”®å†³ç­–ï¼Œè¿™ä¼šç›´æ¥å½±å“åˆ°ç¨‹åºçš„æ€§èƒ½ã€å¯ç»´æŠ¤æ€§ä»¥åŠæ‰©å±•æ€§ã€‚åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œä½¿ç”¨åƒ<code>byteorder</code> è¿™æ ·çš„ä½çº§æ•°æ®æ ¼å¼å­˜å‚¨ç´¢å¼•ä¿¡æ¯å¯èƒ½æ¯”ä½¿ç”¨ JSON æˆ–Protobuf ç­‰é«˜çº§æ ¼å¼æ›´æœ‰ä¼˜åŠ¿ã€‚</p><p>è¯»å†™é€Ÿåº¦ï¼š</p><ul><li><strong>äºŒè¿›åˆ¶æ ¼å¼</strong>ï¼šç›´æ¥æ“ä½œäºŒè¿›åˆ¶æ ¼å¼é€šå¸¸æ¯”è§£ææ–‡æœ¬æˆ–åŠç»“æ„åŒ–çš„æ•°æ®æ ¼å¼ï¼ˆå¦‚JSONï¼‰è¦å¿«ï¼Œå› ä¸ºå®ƒå‡å°‘äº†è§£ææ—¶é—´å’Œå†…å­˜ä½¿ç”¨ã€‚åœ¨äºŒè¿›åˆ¶æ ¼å¼ä¸­ï¼Œæ•°æ®é€šå¸¸æ˜¯ç´§å¯†æ‰“åŒ…çš„ï¼Œæ²¡æœ‰é¢å¤–çš„æ ¼å¼æ ‡è®°ï¼ˆå¦‚JSON ä¸­çš„èŠ±æ‹¬å·å’Œé€—å·ï¼‰ï¼Œè¿™å‡å°‘äº†ç£ç›˜ I/O éœ€æ±‚ã€‚</li><li><strong>æ–‡æœ¬/åŠç»“æ„åŒ–æ ¼å¼</strong>ï¼šä¾‹å¦‚JSONï¼Œæ¯æ¬¡è¯»å–æ—¶éƒ½éœ€è¦è§£ææ–‡æœ¬ï¼Œè½¬æ¢æ•°æ®ç±»å‹ï¼Œè¿™ä¼šå¢åŠ  CPUçš„è´Ÿæ‹…ï¼Œå°¤å…¶æ˜¯åœ¨å¤§è§„æ¨¡æ•°æ®å¤„ç†æ—¶ã€‚</li></ul><p>ç©ºé—´æ•ˆç‡ï¼š</p><ul><li><strong>äºŒè¿›åˆ¶æ ¼å¼</strong>ï¼šä½¿ç”¨æœ€å°‘çš„å­—èŠ‚è¡¨ç¤ºæ•°æ®ï¼Œä¾‹å¦‚ä½¿ç”¨å®šé•¿çš„æ•´æ•°å­˜å‚¨æ–‡æ¡£ID å’Œä½ç½®ç´¢å¼•ï¼Œä¸ä»…èŠ‚çœç©ºé—´ï¼Œè¿˜èƒ½æé«˜ç¼“å­˜åˆ©ç”¨ç‡ã€‚</li><li><strong>æ–‡æœ¬/åŠç»“æ„åŒ–æ ¼å¼</strong>ï¼šæ–‡æœ¬æ ¼å¼éœ€è¦å­˜å‚¨é¢å¤–çš„å­—ç¬¦æ¥æ ‡è¯†æ•°æ®ï¼ˆä¾‹å¦‚å¼•å·å’Œé”®åï¼‰ï¼Œè¿™å¢åŠ äº†å­˜å‚¨éœ€æ±‚ã€‚</li></ul><p>é€‚ç”¨åœºæ™¯ï¼š</p><ul><li><strong>äºŒè¿›åˆ¶æ ¼å¼</strong>ï¼šéå¸¸é€‚åˆéœ€è¦é«˜æ€§èƒ½å’Œå¤§æ•°æ®å¤„ç†çš„åç«¯ç³»ç»Ÿï¼Œå¦‚æœç´¢å¼•æ“å’Œæ•°æ®åº“ç´¢å¼•ã€‚è¿™ç§æ ¼å¼å¯ä»¥æœ‰æ•ˆåœ°æ”¯æŒå¿«é€Ÿçš„æ•°æ®è¯»å–å’Œå†™å…¥ï¼Œç‰¹åˆ«æ˜¯åœ¨èµ„æºå—é™çš„ç¯å¢ƒä¸­ï¼ˆå¦‚åµŒå…¥å¼ç³»ç»Ÿæˆ–ä½å»¶è¿Ÿåº”ç”¨ï¼‰ã€‚</li><li><strong>JSON/Protobuf</strong>ï¼šæ›´é€‚åˆéœ€è¦è·¨å¹³å°å…¼å®¹æ€§å’Œæ˜“äºè°ƒè¯•çš„åº”ç”¨åœºæ™¯ã€‚ä¾‹å¦‚ï¼Œåœ¨Web åº”ç”¨ä¸­ä½¿ç”¨ JSON ä½œä¸ºæ•°æ®äº¤æ¢æ ¼å¼ï¼Œå¯ä»¥ç®€åŒ–å‰åç«¯çš„é›†æˆå’Œæµ‹è¯•ã€‚</li></ul>          </div><h2 id="tmp.rs">tmp.rs</h2><p>å®Œæˆå†…å­˜ç´¢å¼•çš„æ„å»ºåï¼Œæˆ‘ä»¬éœ€è¦å°†æ„å»ºè¿‡ç¨‹ä¸­äº§ç”Ÿçš„å¤§ç´¢å¼•å…ˆä¸´æ—¶è½ç›˜ï¼Œåé¢å†è¿›è¡Œåˆå¹¶ã€‚ä¸ºäº†ä¸´æ—¶å­˜å‚¨è¿™äº›æ•°æ®æ–‡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦å°†ä»–ä»¬æ”¾åœ¨ä¸€ä¸ªä¸´æ—¶ç›®å½•ä¸­ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬å®šä¹‰äº†<code>TmpDir</code> æ•°æ®ç»“æ„ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[derive(Clone)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">TmpDir</span> &#123;<br>    dir: PathBuf,<br>    n: <span class="hljs-type">usize</span>,<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>dir</code>: ç›®å½•</li><li><code>n</code>: è‡ªå¢å™¨ï¼Œç”¨äºåŒºåˆ†ä¸´æ—¶æ–‡ä»¶å‘½å</li></ul><p>æ¥ä¸‹æ¥ä¸º <code>TmpDir</code> å®ç° 2 ä¸ªæ–¹æ³•ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">TmpDir</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>&lt;P: <span class="hljs-built_in">AsRef</span>&lt;Path&gt;&gt;(dir: P) <span class="hljs-punctuation">-&gt;</span> TmpDir &#123;<br>        TmpDir &#123;<br>            dir: dir.<span class="hljs-title function_ invoke__">as_ref</span>().<span class="hljs-title function_ invoke__">to_owned</span>(),<br>            n: <span class="hljs-number">1</span>,<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">create</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;(PathBuf, BufWriter&lt;File&gt;)&gt; &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">r</span>#<span class="hljs-keyword">try</span> = <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">loop</span> &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">filename</span> = <span class="hljs-keyword">self</span><br>                .dir<br>                .<span class="hljs-title function_ invoke__">join</span>(PathBuf::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-built_in">format!</span>(<span class="hljs-string">&quot;tmp&#123;:08x&#125;.dat&quot;</span>, <span class="hljs-keyword">self</span>.n)));<br>            <span class="hljs-keyword">self</span>.n += <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">match</span> fs::OpenOptions::<span class="hljs-title function_ invoke__">new</span>()<br>                .<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-literal">true</span>)<br>                .<span class="hljs-title function_ invoke__">create_new</span>(<span class="hljs-literal">true</span>)<br>                .<span class="hljs-title function_ invoke__">open</span>(&amp;filename)<br>            &#123;<br>                <span class="hljs-title function_ invoke__">Ok</span>(f) =&gt; <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Ok</span>((filename, BufWriter::<span class="hljs-title function_ invoke__">new</span>(f))),<br>                <span class="hljs-title function_ invoke__">Err</span>(exc) =&gt; &#123;<br>                    <span class="hljs-keyword">if</span> r#<span class="hljs-keyword">try</span> &lt; <span class="hljs-number">999</span> &amp;&amp; exc.<span class="hljs-title function_ invoke__">kind</span>() == io::ErrorKind::AlreadyExists &#123;<br>                        <span class="hljs-comment">// keep going</span><br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Err</span>(exc);<br>                    &#125;<br>                &#125;<br>            &#125;<br>            r#<span class="hljs-keyword">try</span> += <span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>new</strong> æ–¹æ³•æ˜¯ <code>TmpDir</code>çš„æ„é€ å‡½æ•°ï¼Œå…¶ä¸­æˆ‘ä»¬å°† <code>n</code> è®¾ç½®ä¸º 1ï¼Œå³æ–‡ä»¶åä» 1å¼€å§‹ç”Ÿæˆã€‚<code>dir.as_ref().to_owned()</code>æ¥å—ä¸€ä¸ªå¯èƒ½æ˜¯ä»»ä½•ç±»å‹çš„è·¯å¾„ï¼Œå°†å…¶æ ‡å‡†åŒ–ä¸ºä¸€ä¸ª <code>Path</code>ç±»å‹çš„å¼•ç”¨ï¼Œç„¶åå†å¤åˆ¶è¿™ä¸ªå¼•ç”¨ï¼Œåˆ›å»ºä¸€ä¸ªå®Œå…¨ç‹¬ç«‹çš„ã€æ‹¥æœ‰æ‰€æœ‰æƒçš„<code>PathBuf</code> å¯¹è±¡ï¼Œ</p><p><strong>create</strong> æ–¹æ³•æ˜¯åœ¨ <code>TmpDir</code>ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ã€‚</p><h2 id="write.rs">write.rs</h2><blockquote><p>å®Œæ•´æºç ï¼š<ahref="https://github.com/hedon-rust-road/inverted-index-concurrency/blob/master/src/write.rs">write.rs</a></p></blockquote><p>å‡†å¤‡å¥½å†…å­˜ç´¢å¼•å’Œä¸´æ—¶æ–‡ä»¶ï¼Œé‚£æˆ‘ä»¬å°±éœ€è¦å®ç°å°†å†…å­˜ç´¢å¼•å†™å…¥åˆ°æ–‡ä»¶ä¸­çš„åŠŸèƒ½äº†ã€‚</p><h3 id="struct-inmemoryindex-1">struct: InMemoryIndex</h3><p>æˆ‘ä»¬å…ˆæ¥åˆ†æä¸€ä¸‹å¦‚ä½•å°† <code>InMemoryIndex</code> è½ç›˜ã€‚é¦–å…ˆ<code>InMemoryIndex</code> çš„ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">InMemoryIndex</span> &#123;<br>    <span class="hljs-keyword">pub</span> word_count: <span class="hljs-type">usize</span>,<br>    <span class="hljs-keyword">pub</span> terms: HashMap&lt;<span class="hljs-type">String</span>, <span class="hljs-type">Vec</span>&lt;Hit&gt;&gt;,<br>    <span class="hljs-keyword">pub</span> docs: HashMap&lt;<span class="hljs-type">u32</span>, Document&gt;,<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Document</span> &#123;<br>    <span class="hljs-keyword">pub</span> id: <span class="hljs-type">u32</span>,<br>    <span class="hljs-keyword">pub</span> path: PathBuf,<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>word_count</code>ä¸éœ€è¦å­˜å‚¨ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—å‡ºæ¥ã€‚é‚£æˆ‘ä»¬å°±éœ€è¦å­˜å‚¨ç´¢å¼• <code>map</code>å’Œæ–‡æ¡£åŸæ•°æ® <code>docs</code>ã€‚ä¸ºäº†èƒ½ç²¾ç¡®å®šä½åˆ°å„ä¸ªæ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦ï¼š</p><p>terms:</p><ul><li>å†™å…¥ Vec&lt;Hit&gt;</li></ul><p>docs:</p><ul><li>å†™å…¥ docs ä¸­çš„æ¯ä¸ª Document<ul><li>å†™å…¥ id</li><li>å†™å…¥ path å¤§å°</li><li>å†™å…¥ path</li></ul></li></ul><p>è€Œä¸ºäº†å¿«é€Ÿå®šä½åˆ°æ¯ä¸ª term å’Œ docçš„ä½ç½®ï¼Œæˆ‘ä»¬éœ€è¦ä¸‹é¢å‡ ä¸ªå€¼ï¼Œè¿™å‡ ä¸ªå€¼å°†ç»„åˆèµ·æ¥è¾…åŠ©æˆ‘ä»¬å¿«é€Ÿå®šä½ terms æˆ–docsï¼Œæˆ‘ä»¬åé¢ä¼šå°†å…¶ç§°ä¸º <strong>Entry</strong>ï¼Œå®ƒåŒ…å«ä»¥ä¸‹å‡ ä¸ªå€¼ï¼š</p><ul><li><code>term</code>: ç´¢å¼•å•è¯ã€‚ä¸ºäº†ç»Ÿä¸€ï¼Œå¦‚æœ <code>term</code>ä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºå½“å‰è¡¨ç¤ºçš„æ˜¯ docï¼Œå¦åˆ™ä¸º termsã€‚</li><li><code>df</code>: term çš„å‡ºç°æ¬¡æ•°ã€‚ä¸ºäº†ç»Ÿä¸€ï¼Œå¦‚æœ <code>df</code> ä¸º0ï¼Œåˆ™è¡¨ç¤ºå½“å‰è¡¨ç¤ºçš„æ˜¯ docï¼Œå¦åˆ™ä¸º termsã€‚</li><li><code>offset</code>: å¯¹åº”çš„ terms æˆ– docs åœ¨æ–‡ä»¶ä¸­çš„åç§»ã€‚</li><li><code>nbytes</code>: å¯¹åº”çš„ terms æˆ– docs çš„æ€»é•¿åº¦ã€‚</li></ul><p>æ‰€ä»¥æ–‡ä»¶çš„å†…å­˜ç»“æ„å¤§æ¦‚å¦‚ä¸‹ï¼š</p><table><thead><tr class="header"><th>æ–‡ä»¶åŒºåŸŸ</th><th>æè¿°</th><th>æŒ‡å‘å†…å®¹</th></tr></thead><tbody><tr class="odd"><td>å¤´éƒ¨ ï¼ˆ8 å­—èŠ‚ï¼‰</td><td>åŒ…å«ä¸€ä¸ªæŒ‡å‘ç›®å½•è¡¨å¼€å§‹ä½ç½®çš„åç§»é‡ã€‚</td><td>header</td></tr><tr class="even"><td>ä¸»æ¡ç›®</td><td>è¿™äº›æ¡ç›®æŒ‰é¡ºåºç´§å¯†å­˜å‚¨ï¼Œæ²¡æœ‰é¢å¤–çš„å…ƒæ•°æ®ã€‚è¿™éƒ¨åˆ†åŒ…å«å®é™…çš„æ•°æ®æ¡ç›®ã€‚</td><td>terms + docs</td></tr><tr class="odd"><td>ç›®å½•è¡¨</td><td>å­˜å‚¨åœ¨æ–‡ä»¶çš„æœ€åï¼ŒåŒ…æ‹¬æ¯ä¸ªæ¡ç›®çš„æœ¯è¯­ä¿¡æ¯ã€æ–‡æ¡£é¢‘ç‡ã€åç§»å’Œå¤§å°ã€‚</td><td>entries</td></tr></tbody></table><p>ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240423194529529.png"alt="ç´¢å¼•æ–‡ä»¶å†…å­˜ç»“æ„ç¤ºæ„å›¾" /><figcaption aria-hidden="true">ç´¢å¼•æ–‡ä»¶å†…å­˜ç»“æ„ç¤ºæ„å›¾</figcaption></figure><p>ä¸ºæ­¤æˆ‘ä»¬å®šä¹‰äº† <code>IndexFileWriter</code>ï¼Œå®ƒä¸“é—¨ç”¨äºå°†<code>InMemoryIndex</code> å†™å…¥åˆ°ä¸´æ—¶æ–‡ä»¶ä¸­ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">/// A structure to manage writing to an index file efficiently.</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">IndexFileWriter</span> &#123;<br>    offset: <span class="hljs-type">u64</span>,<br>    writer: BufWriter&lt;File&gt;,<br>    contents_buf: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">u8</span>&gt;,<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>offset</code>: ç”¨äºè¿½è¸ªæ–‡ä»¶ä¸­å½“å‰çš„å†™å…¥ä½ç½®ã€‚</li><li><code>writer</code>:ä¸€ä¸ªç¼“å†²å†™å…¥å™¨ï¼Œå®ƒåŒ…è£…äº†ä¸€ä¸ªæ–‡ä»¶ï¼Œç”¨äºè¾“å‡ºæ“ä½œã€‚</li><li><code>contents_buf</code>:ä¸€ä¸ªå‘é‡ï¼Œç”¨æ¥å­˜å‚¨å†…å®¹æ¡ç›®ï¼Œåœ¨å…¨éƒ¨å†™å…¥æ–‡ä»¶ä¹‹å‰æš‚å­˜åœ¨è¿™ä¸ªç¼“å†²åŒºã€‚</li></ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¸º <code>IndexFileWriter</code> å®ç°å‡ ä¸ªæ–¹æ³•ï¼š</p><ul><li><code>new</code>:è¿™æ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œå®ƒåˆå§‹åŒ–æ–‡ä»¶å¹¶è®¾ç½®åˆå§‹åç§»é‡ã€‚åœ¨æ–‡ä»¶çš„å¼€å§‹å¤„å†™å…¥ä¸€ä¸ªå ä½ç¬¦ä½œä¸ºå¤´éƒ¨ï¼Œè¿™ä¸ªå¤´éƒ¨æœ€ç»ˆä¼šå­˜å‚¨ä¸»æ•°æ®åŒºçš„å¤§å°ã€‚</li><li><code>write_document</code>:ç”¨äºå°†ä¸€ä¸ªæ–‡æ¡£ä»¥äºŒè¿›åˆ¶æ ¼å¼å†™å…¥åˆ°æ–‡ä»¶ä¸­ï¼ŒåŒæ—¶æ›´æ–°åç§»é‡ã€‚</li><li><code>write_main</code>:è¿™ä¸ªæ–¹æ³•æ¥å—ä¸€æ®µæ•°æ®ï¼Œå¹¶å°†å®ƒå†™å…¥æ–‡ä»¶ä¸­ï¼ŒåŒæ—¶æ›´æ–°åç§»é‡ã€‚</li><li><code>write_contents_entry</code>: å°†ä¸€ä¸ªå†…å®¹ Entryè¿½åŠ åˆ°å†…éƒ¨çš„ç¼“å†²åŒºä¸­ã€‚EntryåŒ…æ‹¬ä¸€ä¸ªæœ¯è¯­ã€æ–‡æ¡£é¢‘ç‡ã€æœ¯è¯­æ•°æ®çš„èµ·å§‹åç§»å’Œå¤§å°ï¼Œå®ƒç”¨äºå¿«é€Ÿå®šä½ termsæˆ– docsã€‚</li><li><code>finish</code>:å®Œæˆæ–‡ä»¶å†™å…¥è¿‡ç¨‹ï¼Œå°†å†…éƒ¨ç¼“å†²åŒºçš„å†…å®¹å†™å…¥æ–‡ä»¶ï¼Œå¹¶æ›´æ–°æ–‡ä»¶å¤´éƒ¨çš„ä¸»æ•°æ®å¤§å°ã€‚</li></ul><h3 id="new">new</h3><p>æˆ‘ä»¬å…ˆæ¥çœ‹æ„é€ æ–¹æ³•ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(<span class="hljs-keyword">mut</span> f: BufWriter&lt;File&gt;) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;IndexFileWriter&gt; &#123;<br>    <span class="hljs-keyword">const</span> HEADER_SIZE: <span class="hljs-type">u64</span> = <span class="hljs-number">8</span>;<br>    f.write_u64::&lt;LittleEndian&gt;(<span class="hljs-number">0</span>)?; <span class="hljs-comment">// content start</span><br>    <span class="hljs-title function_ invoke__">Ok</span>(IndexFileWriter &#123;<br>        offset: HEADER_SIZE,<br>        writer: f,<br>        contents_buf: <span class="hljs-built_in">vec!</span>[],<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>new</strong> åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š</p><ol type="1"><li><strong>å®šä¹‰å¤´éƒ¨å¤§å°</strong>ï¼š<code>const HEADER_SIZE: u64 = 8;</code>ï¼šå®šä¹‰ä¸€ä¸ªå¸¸é‡<code>HEADER_SIZE</code>ï¼Œå…¶å€¼ä¸º 8å­—èŠ‚ï¼Œè¿™è¡¨ç¤ºæ–‡ä»¶å¤´éƒ¨çš„å¤§å°ã€‚è¿™ä¸ªå¤´éƒ¨å°†ç”¨äºåç»­åœ¨æ–‡ä»¶çš„å¼€å§‹å¤„å†™å…¥ä¸»æ•°æ®åŒºçš„èµ·å§‹ä½ç½®ã€‚</li><li><strong>å†™å…¥å¤´éƒ¨å ä½ç¬¦</strong>ï¼š<code>f.write_u64::&lt;LittleEndian&gt;(0)?;</code>ï¼šåœ¨æ–‡ä»¶çš„å¼€å§‹å¤„å†™å…¥ä¸€ä¸ª8å­—èŠ‚çš„å ä½ç¬¦ï¼Œè¿™ä¸ªå€¼æ˜¯ä»¥å°ç«¯å­—èŠ‚åºï¼ˆ<code>LittleEndian</code>ï¼‰å­˜å‚¨çš„ã€‚åˆå§‹æ—¶è¿™é‡Œå†™å…¥çš„æ˜¯0ï¼Œæ„å‘³ç€â€œä¸»æ•°æ®åŒºçš„èµ·å§‹ä½ç½®æœªçŸ¥â€ï¼Œè¿™ä¸ªå€¼åœ¨åç»­çš„ <code>finish</code>å‡½æ•°ä¸­ä¼šè¢«æ›´æ–°ã€‚</li><li><strong>è¿”å›ä¸€ä¸ªæ–°çš„ IndexFileWriterå®ä¾‹</strong>ï¼š<code>Ok(IndexFileWriter &#123; offset: HEADER_SIZE, writer: f, contents_buf: vec![], &#125;)</code>ï¼šæ„é€ å¹¶è¿”å›ä¸€ä¸ª<code>IndexFileWriter</code> å®ä¾‹ã€‚è¿™ä¸ªå®ä¾‹çš„ <code>offset</code>å­—æ®µè¢«åˆå§‹åŒ–ä¸º <code>HEADER_SIZE</code>ï¼ˆ8å­—èŠ‚ï¼‰ï¼Œè¡¨ç¤ºå®é™…æ•°æ®å°†ä»æ–‡ä»¶çš„ç¬¬ 17 ä¸ªå­—èŠ‚å¼€å§‹å†™å…¥ã€‚<code>writer</code>å­—æ®µå°±æ˜¯ä¼ å…¥çš„æ–‡ä»¶å†™å…¥å™¨ï¼Œ<code>contents_buf</code>æ˜¯ä¸€ä¸ªæ–°çš„ç©ºå‘é‡ï¼Œç”¨äºä¸´æ—¶å­˜å‚¨å†…å®¹æ¡ç›®æ•°æ®ã€‚</li></ol><div class="note note-info">            <p><big><strong>ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ</strong></big></p><p>è¿™ä¸ªå®ç°æ–¹å¼æœ‰å‡ ä¸ªè®¾è®¡ä¸Šçš„è€ƒè™‘ï¼š</p><ol type="1"><li><strong>é¢„ç•™å¤´éƒ¨ç©ºé—´</strong>ï¼šé€šè¿‡åœ¨æ–‡ä»¶å¼€å§‹å¤„é¢„ç•™ 8å­—èŠ‚ç©ºé—´æ¥å­˜å‚¨ä¸»æ•°æ®åŒºçš„å¤§å°ï¼Œè¿™æ ·åšå¯ä»¥åœ¨æ•°æ®å†™å…¥å®Œæˆåï¼Œæ–¹ä¾¿åœ°å›å¡«è¿™ä¸ªä¿¡æ¯ã€‚è¿™æ˜¯æ–‡ä»¶æ ¼å¼è®¾è®¡ä¸­å¸¸è§çš„åšæ³•ï¼Œå…è®¸è¯»å–è€…å¿«é€Ÿå®šä½ä¸»æ•°æ®åŒºå’Œå†…å®¹ç´¢å¼•åŒºã€‚</li><li><strong>ä½¿ç”¨å°ç«¯å­—èŠ‚åº</strong>ï¼šå°ç«¯å­—èŠ‚åºæ˜¯ä¸€ç§åœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­å¸¸ç”¨çš„å­—èŠ‚åºï¼Œå°¤å…¶æ˜¯åœ¨Windowså¹³å°ä¸‹ã€‚ä½¿ç”¨å°ç«¯å­—èŠ‚åºå¯ä»¥æé«˜æ–‡ä»¶çš„å…¼å®¹æ€§ï¼Œå¹¶ä¸”å¯¹äºå¤šæ•°å¤„ç†å™¨æ¶æ„æ¥è¯´ï¼Œå°ç«¯å­—èŠ‚åºçš„è¯»å†™æ“ä½œæ›´ä¸ºé«˜æ•ˆã€‚</li><li><strong>çµæ´»çš„æ•°æ®å†™å…¥</strong>ï¼šé€šè¿‡å°† <code>writer</code> å’Œ<code>contents_buf</code>ç»„åˆä½¿ç”¨ï¼Œè¿™ä¸ªç»“æ„ä½“å¯ä»¥çµæ´»åœ°å¤„ç†ä¸åŒçš„æ•°æ®å†™å…¥éœ€æ±‚ã€‚<code>writer</code>ç›´æ¥å†™å…¥æ–‡ä»¶ï¼Œé€‚åˆè¿ç»­å¤§å—æ•°æ®çš„å†™å…¥ï¼›è€Œ <code>contents_buf</code>ç”¨äºèšé›†å¤šä¸ªå°ç‰‡æ®µçš„æ•°æ®ï¼Œå¯ä»¥åœ¨æœ€åç»Ÿä¸€å†™å…¥ï¼Œå‡å°‘ç£ç›˜æ“ä½œæ¬¡æ•°ã€‚</li></ol><p>æ€»çš„æ¥è¯´ï¼Œè¿™ä¸ªæ„é€ å‡½æ•°çš„å®ç°ä¸ºé«˜æ•ˆå’Œçµæ´»çš„æ–‡ä»¶å†™æ“ä½œæä¾›äº†è‰¯å¥½çš„åŸºç¡€ï¼ŒåŒæ—¶é€šè¿‡åˆç†çš„é”™è¯¯å¤„ç†å’Œæ•°æ®ç»„ç»‡æ–¹å¼ï¼Œç¡®ä¿äº†ç¨‹åºçš„å¥å£®æ€§å’Œé«˜æ€§èƒ½ã€‚</p>          </div><h3 id="write_main">write_main</h3><p>Hit æœ¬èº«å°±æ˜¯ä¸€ä¸ª Vec&lt;u8&gt;ï¼Œ å°†å…¶å†™å…¥æ–‡ä»¶å¾ˆç®€å•ï¼Œè°ƒç”¨<code>write_all</code>ï¼Œå³å¯ï¼Œæˆ‘ä»¬ä¸ºå…¶å°è£… <code>write_main</code>æ–¹æ³•ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">write_main</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, buf: &amp;[<span class="hljs-type">u8</span>]) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-keyword">self</span>.writer.<span class="hljs-title function_ invoke__">write_all</span>(buf)?;<br>    <span class="hljs-keyword">self</span>.offset += buf.<span class="hljs-title function_ invoke__">len</span>() <span class="hljs-keyword">as</span> <span class="hljs-type">u64</span>;<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="write_document">write_document</h3><p>ä¸ºäº†å°† Docuemntæœ¬ä»¥äºŒè¿›åˆ¶ç»“æ„å†™å…¥åˆ°æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ‹†åˆ†æˆå‡ ä¸ªéƒ¨åˆ†ï¼š</p><ol type="1"><li>æ–‡ä»¶ id</li><li>æ–‡ä»¶è·¯å¾„å¤§å°</li><li>æ–‡ä»¶è·¯å¾„</li></ol><p>ä¸ºæ­¤æˆ‘ä»¬ä¸º <code>IndexFileWriter</code> å°è£…äº†<code>write_document</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">write_document</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, doc: &amp;Document) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-keyword">self</span>.writer.write_u32::&lt;LittleEndian&gt;(doc.id)?;<br>    <span class="hljs-keyword">self</span>.writer<br>        .write_u64::&lt;LittleEndian&gt;(doc.path.<span class="hljs-title function_ invoke__">as_os_str</span>().<span class="hljs-title function_ invoke__">len</span>() <span class="hljs-keyword">as</span> <span class="hljs-type">u64</span>)?;<br>    <span class="hljs-keyword">self</span>.writer.<span class="hljs-title function_ invoke__">write_all</span>(doc.path.<span class="hljs-title function_ invoke__">as_os_str</span>().<span class="hljs-title function_ invoke__">as_bytes</span>())?;<br>    <span class="hljs-keyword">self</span>.offset += <span class="hljs-number">4</span> + <span class="hljs-number">8</span> + doc.path.<span class="hljs-title function_ invoke__">as_os_str</span>().<span class="hljs-title function_ invoke__">len</span>() <span class="hljs-keyword">as</span> <span class="hljs-type">u64</span>;<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="write_contents_entry">write_contents_entry</h3><p>Entryçš„æ•°æ®é‡ä¸€èˆ¬è¾ƒå°ï¼Œæˆ‘ä»¬ä¼šå…ˆå†™å…¥ç¼“å†²ä¸­ï¼Œåé¢å†ä¸€æ¬¡æ€§åˆ·ç›˜ï¼Œä¸ºæ­¤æˆ‘ä»¬ä¸º<code>IndexFileWriter</code> å°è£…äº†<code>write_contents_entry</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">/// Appends a content entry to the internal buffer.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// # Arguments</span><br><span class="hljs-comment">/// * `term` - The term associated with the entry</span><br><span class="hljs-comment">/// * `df` - Document frequency for the term</span><br><span class="hljs-comment">/// * `offset` - Offset where the term data starts in the file</span><br><span class="hljs-comment">/// * `nbytes` - Number of bytes of the term data</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">write_contents_entry</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, term: <span class="hljs-type">String</span>, df: <span class="hljs-type">u32</span>, offset: <span class="hljs-type">u64</span>, nbytes: <span class="hljs-type">u64</span>) &#123;<br>    <span class="hljs-keyword">self</span>.contents_buf.write_u64::&lt;LittleEndian&gt;(offset).<span class="hljs-title function_ invoke__">unwrap</span>();<br>    <span class="hljs-keyword">self</span>.contents_buf.write_u64::&lt;LittleEndian&gt;(nbytes).<span class="hljs-title function_ invoke__">unwrap</span>();<br>    <span class="hljs-keyword">self</span>.contents_buf.write_u32::&lt;LittleEndian&gt;(df).<span class="hljs-title function_ invoke__">unwrap</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">bytes</span> = term.<span class="hljs-title function_ invoke__">bytes</span>();<br>    <span class="hljs-keyword">self</span>.contents_buf<br>        .write_u32::&lt;LittleEndian&gt;(bytes.<span class="hljs-title function_ invoke__">len</span>() <span class="hljs-keyword">as</span> <span class="hljs-type">u32</span>)<br>        .<span class="hljs-title function_ invoke__">unwrap</span>();<br>    <span class="hljs-keyword">self</span>.contents_buf.<span class="hljs-title function_ invoke__">extend</span>(bytes);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="finish">finish</h3><p>åˆ·ç›˜çš„è¿‡ç¨‹æˆ‘ä»¬å°è£…åœ¨ <code>finish</code> ä¸­ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">finish</span>(<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">contents_start</span> = <span class="hljs-keyword">self</span>.offset;<br>    <span class="hljs-keyword">self</span>.writer.<span class="hljs-title function_ invoke__">write_all</span>(&amp;<span class="hljs-keyword">self</span>.contents_buf)?;<br>    <span class="hljs-keyword">self</span>.writer.<span class="hljs-title function_ invoke__">seek</span>(SeekFrom::<span class="hljs-title function_ invoke__">Start</span>(<span class="hljs-number">0</span>))?;<br>    <span class="hljs-keyword">self</span>.writer.write_u64::&lt;LittleEndian&gt;(contents_start)?;<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="write_index_to_tmp_file">write_index_to_tmp_file</h3><p>ç»¼åˆä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®ç°æœ€æ ¸å¿ƒçš„å‡½æ•°<code>write_index_to_tmp_file</code> äº†ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">write_index_to_tmp_file</span>(index: InMemoryIndex, tmp_dir: &amp;<span class="hljs-keyword">mut</span> TmpDir) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;PathBuf&gt; &#123;<br>    <span class="hljs-keyword">let</span> (filename, f) = tmp_dir.<span class="hljs-title function_ invoke__">create</span>()?;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">writer</span> = IndexFileWriter::<span class="hljs-title function_ invoke__">new</span>(f)?;<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">index_as_vec</span>: <span class="hljs-type">Vec</span>&lt;_&gt; = index.terms.<span class="hljs-title function_ invoke__">into_iter</span>().<span class="hljs-title function_ invoke__">collect</span>();<br>    index_as_vec.<span class="hljs-title function_ invoke__">sort_by</span>(|(a, _), (b, _)| a.<span class="hljs-title function_ invoke__">cmp</span>(b));<br><br>    <span class="hljs-keyword">for</span> (term, hits) <span class="hljs-keyword">in</span> index_as_vec &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">df</span> = hits.<span class="hljs-title function_ invoke__">len</span>() <span class="hljs-keyword">as</span> <span class="hljs-type">u32</span>;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">start</span> = writer.offset;<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">buffer</span> <span class="hljs-keyword">in</span> hits &#123;<br>            writer.<span class="hljs-title function_ invoke__">write_main</span>(&amp;buffer)?;<br>        &#125;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">stop</span> = writer.offset;<br>        writer.<span class="hljs-title function_ invoke__">write_contents_entry</span>(term, df, start, stop - start);<br>    &#125;<br><br>    <span class="hljs-comment">// if term == &quot;&quot; &amp;&amp; df == 0 &#123; type = document &#125;</span><br>    <span class="hljs-keyword">for</span> (_, doc) <span class="hljs-keyword">in</span> index.docs &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">start</span> = writer.offset;<br>        writer.<span class="hljs-title function_ invoke__">write_document</span>(&amp;doc)?;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">stop</span> = writer.offset;<br>        writer.<span class="hljs-title function_ invoke__">write_contents_entry</span>(<span class="hljs-string">&quot;&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(), <span class="hljs-number">0</span>, start, stop - start)<br>    &#125;<br><br>    writer.<span class="hljs-title function_ invoke__">finish</span>()?;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;wrote file &#123;:?&#125;&quot;</span>, filename);<br>    <span class="hljs-title function_ invoke__">Ok</span>(filename)<br>&#125;<br></code></pre></td></tr></table></figure><ol type="1"><li>æˆ‘ä»¬åœ¨ä¸´æ—¶ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ï¼Œå¹¶åˆå§‹åŒ– IndexFileWriterï¼›</li><li>å°†ç´¢å¼•çš„ <code>terms</code> è½¬æ¢æˆä¸€ä¸ªå‘é‡å¹¶æŒ‰ç…§é”®æ’åºï¼›</li><li>å¯¹äºæ¯ä¸ª<code>term</code>ï¼Œè®¡ç®—æ–‡æ¡£é¢‘ç‡ï¼ˆ<code>df</code>ï¼‰ï¼Œè®°å½•å¼€å§‹å’Œç»“æŸä½ç½®ï¼Œç„¶åè°ƒç”¨<code>write_main</code> æ–¹æ³•å°†æ•°æ®å†™å…¥æ–‡ä»¶ï¼Œç„¶åä½¿ç”¨<code>write_contents_entry</code> æ–¹æ³•å†™å…¥ <code>Entry</code>çš„å…ƒæ•°æ®åˆ°ç›®å½•è¡¨ï¼›</li><li>å¯¹äº <code>index.docs</code>ä¸­çš„æ¯ä¸ªæ–‡æ¡£ï¼Œè®¡ç®—èµ·æ­¢ä½ç½®ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ªç‰¹æ®Šçš„æ¡ç›®ï¼ˆç©ºå­—ç¬¦ä¸²ä½œä¸ºæ¡ç›®åå’Œ 0ä½œä¸ºæ–‡æ¡£é¢‘ç‡ï¼‰æ ‡è®°åœ¨æ–‡ä»¶ä¸­ï¼›</li><li>æœ€åæˆ‘ä»¬ä½¿ç”¨ <code>finish</code> å°†ç¼“å­˜ä¸­æ‰€æœ‰çš„ <code>Entry</code>åˆ·ç›˜ï¼Œå¹¶è®¾ç½® <code>entries</code> çš„èµ·å§‹ä½ç½®ã€‚</li></ol><p>æ–‡ä»¶çš„å†…å­˜ç»“æ„å¦‚ä¸Šé¢ç»™å‡ºçš„å›¾ä¸€æ ·ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥å†çœ‹ä¸€æ¬¡ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240423194529529-20240423195227516.png"alt="ç´¢å¼•æ–‡ä»¶å†…å­˜ç»“æ„ç¤ºæ„å›¾" /><figcaption aria-hidden="true">ç´¢å¼•æ–‡ä»¶å†…å­˜ç»“æ„ç¤ºæ„å›¾</figcaption></figure><h3 id="step4-start_index_writer_thread">step4:start_index_writer_thread</h3><p>å®ç°äº†å°†å†…å­˜ç´¢å¼•å†™å…¥åˆ°æ–‡ä»¶çš„åŠŸèƒ½åï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»§ç»­åœ¨<code>create.rs</code> ä¸­å®ç°ä¸‹ä¸€ä¸ªæµç¨‹äº†ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">start_index_writer_thread</span>(<br>    big_indexes: Receiver&lt;InMemoryIndex&gt;,<br>    output_dir: &amp;Path,<br>) <span class="hljs-punctuation">-&gt;</span> (Receiver&lt;PathBuf&gt;, JoinHandle&lt;io::<span class="hljs-type">Result</span>&lt;()&gt;&gt;) &#123;<br>    <span class="hljs-keyword">let</span> (sender, receiver) = <span class="hljs-title function_ invoke__">channel</span>();<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">tmp_dir</span> = TmpDir::<span class="hljs-title function_ invoke__">new</span>(output_dir);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">handle</span> = <span class="hljs-title function_ invoke__">spawn</span>(<span class="hljs-keyword">move</span> || &#123;<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> big_indexes &#123;<br>            <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;word count: &#123;&#125;&quot;</span>, i.word_count);<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">file</span> = <span class="hljs-title function_ invoke__">write_index_to_tmp_file</span>(i, &amp;<span class="hljs-keyword">mut</span> tmp_dir)?;<br>            <span class="hljs-keyword">if</span> sender.<span class="hljs-title function_ invoke__">send</span>(file).<span class="hljs-title function_ invoke__">is_err</span>() &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-title function_ invoke__">Ok</span>(())<br>    &#125;);<br><br>    (receiver, handle)<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ <code>start_index_writer_thread</code>æµç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†æ„å»ºå¥½çš„å†…å­˜ç´¢å¼•ä¸€ä¸ªä¸ªå†™å…¥åˆ°æ–‡ä»¶ä¸­ï¼Œå¹¶å°†ç”Ÿæˆçš„æ–‡ä»¶å¥æŸ„ä¼ å…¥ä¸‹ä¸€ä¸ªæµç¨‹ã€‚</p><h2 id="merge.rs">merge.rs</h2><blockquote><p>å®Œæ•´æºç ï¼š<ahref="https://github.com/hedon-rust-road/inverted-index-concurrency/blob/master/src/merge.rs">merge.rs</a></p></blockquote><p>å‰é¢ <code>start_index_writer_thread</code> æ˜¯å°†ä¸€ä¸ªä¸ª<code>InMemoryIndex</code> å†™å…¥åˆ° <code>TmpDir</code>ä¸´æ—¶ç›®å½•ä¸­ã€‚ç°åœ¨æˆ‘ä»¬è¦å°†è¿™äº›ä¸´æ—¶æ–‡ä»¶åˆå¹¶æˆä¸€ä¸ªæœ€ç»ˆçš„ç´¢å¼•æ–‡ä»¶ï¼Œä»¥ä¼˜åŒ–æŸ¥è¯¢æ•ˆç‡å’ŒèŠ‚çœå­˜å‚¨ç©ºé—´ã€‚</p><h3 id="srtuct-filemerge">srtuct: FileMerge</h3><p>æˆ‘ä»¬å®šä¹‰ä¸€ä¸‹ç»“æ„ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">FileMerge</span> &#123;<br>    output_dir: PathBuf,<br>    tmp_dir: TmpDir,<br>    stacks: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">Vec</span>&lt;PathBuf&gt;&gt;,<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>output_dir</code>: ç”¨äºå­˜å‚¨æœ€ç»ˆåˆå¹¶æ–‡ä»¶çš„è¾“å‡ºç›®å½•ã€‚</li><li><code>tmp_dir</code>: å‰é¢ <code>tmp.rs</code>å®šä¹‰çš„ç»“æ„ï¼Œç”¨äºç®¡ç†åˆå¹¶è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸´æ—¶æ–‡ä»¶ã€‚</li><li><code>stacks</code>:è¿™æ˜¯ä¸€ä¸ªäºŒç»´å‘é‡ï¼Œæ¯ä¸ªå†…éƒ¨å‘é‡ä»£è¡¨ä¸€ä¸ªåˆå¹¶â€œå±‚â€ï¼Œå­˜å‚¨äº†è¯¥å±‚å¾…åˆå¹¶çš„æ–‡ä»¶è·¯å¾„ã€‚</li></ul><p>å…³äº <code>stacks</code>ï¼Œå†å¤šè¯´ä¸¤ç‚¹ï¼š</p><ul><li><strong>å¤šçº§åˆå¹¶ç­–ç•¥</strong>: <code>FileMerge</code>ä½¿ç”¨ä¸€ä¸ªå¤šå±‚åˆå¹¶ç­–ç•¥ï¼Œè¿™ç§ç­–ç•¥åœ¨å¤„ç†å¤§é‡æ–‡ä»¶æ—¶å°¤ä¸ºæœ‰æ•ˆã€‚åŸºæœ¬æ€æƒ³æ˜¯ï¼Œå½“ä¸€å±‚çš„æ–‡ä»¶æ•°é‡è¾¾åˆ°ä¸€ä¸ªé¢„è®¾çš„é˜ˆå€¼ï¼ˆ<code>NSTREAMS</code>ï¼‰æ—¶ï¼Œè¿™äº›æ–‡ä»¶ä¼šè¢«åˆå¹¶æˆä¸€ä¸ªæ–°çš„æ–‡ä»¶ï¼Œæ–°æ–‡ä»¶åˆ™è¢«æ¨é€åˆ°ä¸Šä¸€å±‚ã€‚è¿™ç§å±‚çº§å¼çš„å¤„ç†æ–¹å¼å¯ä»¥æ˜¾è‘—å‡å°‘æœ€ç»ˆåˆå¹¶æ­¥éª¤éœ€è¦å¤„ç†çš„æ–‡ä»¶æ•°é‡ï¼Œä»è€Œä¼˜åŒ–æ€§èƒ½ã€‚</li><li><strong>åŠ¨æ€æ‰©å±•</strong>ï¼šä½¿ç”¨<code>Vec&lt;Vec&lt;PathBuf&gt;&gt;</code>å…è®¸åŠ¨æ€åœ°æ·»åŠ æ–°çš„åˆå¹¶å±‚ï¼Œè¿™åœ¨å¤„ç†ä¸ç¡®å®šæ•°é‡çš„æ–‡ä»¶æ—¶éå¸¸æœ‰ç”¨ã€‚å‘é‡çš„çµæ´»æ€§æ„å‘³ç€æ— éœ€é¢„å…ˆçŸ¥é“å°†å¤„ç†å¤šå°‘æ–‡ä»¶ï¼Œå®ƒå¯ä»¥æ ¹æ®å®é™…éœ€è¦è¿›è¡Œæ‰©å±•ã€‚</li></ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šä¸º <code>FileMerge</code> å®ç° 2 ä¸ªæ–¹æ³•ï¼š</p><ul><li><code>add_file</code>:æ·»åŠ ä¸€ä¸ªæ–‡ä»¶åˆ°åˆå¹¶æ ˆä¸­ï¼Œå¹¶ä½¿ç”¨å¤šçº§åˆå¹¶ç­–ç•¥è¿›è¡Œåˆå¹¶ã€‚</li><li><code>finish</code>: æ‰§è¡Œæœ€åçš„åˆå¹¶æ“ä½œï¼Œç”Ÿæˆæœ€ç»ˆçš„ç´¢å¼•æ–‡ä»¶ï¼Œè¾“å‡ºåˆ°<code>output_dir</code> ä¸­ã€‚</li></ul><h3 id="add_file">add_file</h3><p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹<code>add_file</code>ï¼Œå®ƒçš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">add_file</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, <span class="hljs-keyword">mut</span> file: PathBuf) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br><span class="hljs-comment">// ä»ç¬¬ä¸€å±‚å¼€å§‹æ£€æŸ¥</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">level</span> = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-comment">// ä½¿ç”¨å¾ªç¯æ¥å¤„ç†æ–‡ä»¶çš„æ·»åŠ å’Œå¯èƒ½çš„åˆå¹¶ã€‚</span><br>    <span class="hljs-keyword">loop</span> &#123;<br><br>      <span class="hljs-comment">// å¦‚æœå½“å‰çš„ level ï¼ˆå±‚çº§ï¼‰ä¸å­˜åœ¨äº stacks ä¸­ï¼Œ</span><br>        <span class="hljs-comment">// å°±åœ¨ stacks ä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„ç©ºå‘é‡ã€‚</span><br>        <span class="hljs-comment">// è¿™æ˜¯ä¸ºäº†å­˜æ”¾è¯¥å±‚çº§çš„æ–‡ä»¶ã€‚</span><br>        <span class="hljs-keyword">if</span> level == <span class="hljs-keyword">self</span>.stacks.<span class="hljs-title function_ invoke__">len</span>() &#123;<br>            <span class="hljs-keyword">self</span>.stacks.<span class="hljs-title function_ invoke__">push</span>(<span class="hljs-built_in">vec!</span>[]);<br>        &#125;<br><br>        <span class="hljs-comment">// å°†å½“å‰çš„æ–‡ä»¶æ·»åŠ åˆ°å¯¹åº”å±‚çº§çš„å‘é‡ä¸­ã€‚</span><br>        <span class="hljs-keyword">self</span>.stacks[level].<span class="hljs-title function_ invoke__">push</span>(file);<br><br>        <span class="hljs-comment">// å¦‚æœè¿™ä¸ªçº§åˆ«çš„å †æ ˆå·²æ»¡ï¼Œå°±åˆå¹¶è¿™ä¸ªçº§åˆ«çš„æ–‡ä»¶ã€‚</span><br>      <span class="hljs-comment">// å¦‚æœæ²¡æ»¡ï¼Œåˆ™ä¸è¿›è¡Œåˆå¹¶ï¼Œç›´æ¥é€€å‡ºã€‚</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.stacks[level].<span class="hljs-title function_ invoke__">len</span>() &lt; NSTREAMS &#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶æ¥å­˜å‚¨åˆå¹¶ç»“æœï¼Œå¹¶æ›´æ–°å †æ ˆã€‚</span><br>        <span class="hljs-keyword">let</span> (filename, out) = <span class="hljs-keyword">self</span>.tmp_dir.<span class="hljs-title function_ invoke__">create</span>()?;<br><br>        <span class="hljs-comment">// åˆå§‹åŒ–ä¸€ä¸ªç©ºçš„ to_merge å‘é‡ï¼Œ</span><br>      <span class="hljs-comment">// ç„¶åä½¿ç”¨ mem::swap äº¤æ¢å½“å‰å±‚çº§çš„æ–‡ä»¶åˆ—è¡¨å’Œè¿™ä¸ªç©ºå‘é‡ï¼Œ</span><br>        <span class="hljs-comment">// è¿™æ · to_merge å‘é‡å°±åŒ…å«äº†éœ€è¦åˆå¹¶çš„æ–‡ä»¶ï¼Œ</span><br>        <span class="hljs-comment">// è€Œå½“å‰å±‚çº§å˜ä¸ºç©ºï¼Œå¯ä»¥ç”¨æ¥å­˜æ”¾æ–°çš„åˆå¹¶æ–‡ä»¶ã€‚</span><br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">to_merge</span> = <span class="hljs-built_in">vec!</span>[];<br>        mem::<span class="hljs-title function_ invoke__">swap</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>.stacks[level], &amp;<span class="hljs-keyword">mut</span> to_merge);<br><br>        <span class="hljs-comment">// è°ƒç”¨ merge_streams å‡½æ•°å°† to_merge ä¸­çš„æ–‡ä»¶åˆå¹¶åˆ°æ–°åˆ›å»ºçš„æ–‡ä»¶ä¸­ã€‚</span><br>        <span class="hljs-title function_ invoke__">merge_streams</span>(to_merge, out)?;<br><br>        <span class="hljs-comment">// å°†åˆå¹¶åå¾—åˆ°çš„æ–°æ–‡ä»¶è·¯å¾„èµ‹å€¼ç»™ file å˜é‡ï¼Œç”¨äºä¸‹ä¸€è½®å¾ªç¯ã€‚</span><br>        file = filename;<br>        <span class="hljs-comment">// level åŠ ä¸€ï¼Œè¡¨ç¤ºç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå±‚çº§ã€‚</span><br>        level += <span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•é€šè¿‡å±‚çº§çš„æ–¹å¼ç®¡ç†æ–‡ä»¶åˆå¹¶ï¼Œæ¯ä¸ªå±‚çº§å¯ä»¥æœ‰å¤šä¸ªæ–‡ä»¶ï¼Œä½†æ•°é‡ä¸Šé™ä¸º<code>NSTREAMS</code>ã€‚å¦‚æœæŸå±‚æ»¡äº†ï¼Œå°±å°†è¯¥å±‚çš„æ–‡ä»¶åˆå¹¶æˆä¸€ä¸ªæ–°æ–‡ä»¶ï¼Œå¹¶å°†è¿™ä¸ªæ–°æ–‡ä»¶ç§»åŠ¨åˆ°ä¸Šä¸€å±‚ç»§ç»­å‚ä¸åˆå¹¶ã€‚è¿™ç§è®¾è®¡æœ‰æ•ˆåœ°å°†å¤šä¸ªæ–‡ä»¶é€æ­¥åˆå¹¶æˆä¸€ä¸ªæ–‡ä»¶ï¼ŒåŒæ—¶æ§åˆ¶å†…å­˜å’ŒI/O èµ„æºçš„ä½¿ç”¨ã€‚</p><p>å…¶ä¸­ <code>merge_streams</code>å°±æ˜¯å…·ä½“çš„åˆå¹¶è¿‡ç¨‹ï¼Œå®ƒçš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">merge_streams</span>(files: <span class="hljs-type">Vec</span>&lt;PathBuf&gt;, out: BufWriter&lt;File&gt;) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>  <span class="hljs-comment">// ä»ç´¢å¼•æ–‡ä»¶ä¸­æ„å»º IndexFileReader åˆ—è¡¨</span><br>  <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">streams</span>: <span class="hljs-type">Vec</span>&lt;IndexFileReader&gt; = files<br>        .<span class="hljs-title function_ invoke__">into_iter</span>()<br>        .<span class="hljs-title function_ invoke__">map</span>(|p| IndexFileReader::<span class="hljs-title function_ invoke__">open_and_delete</span>(p, <span class="hljs-literal">true</span>))<br>        .collect::&lt;io::<span class="hljs-type">Result</span>&lt;_&gt;&gt;()?;<br><br>  <span class="hljs-comment">// é’ˆå¯¹è¾“å‡ºæ–‡ä»¶ç”Ÿæˆä¸€ä¸ª IndexFileWriter ç”¨äºå†™å…¥ç´¢å¼•ä¿¡æ¯</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">output</span> = IndexFileWriter::<span class="hljs-title function_ invoke__">new</span>(out)?;<br>  <span class="hljs-comment">// ç”¨äºè®°å½•å½“å‰å†™å…¥çš„ä½ç½®ï¼ˆæˆ–è€…æ•°æ®åç§»é‡ï¼‰ã€‚</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">point</span>: <span class="hljs-type">u64</span> = <span class="hljs-number">0</span>;<br>  <span class="hljs-comment">// è®°å½•è¿˜æœ‰æ•°æ®æœªå¤„ç†çš„æ–‡ä»¶æµæ•°é‡ï¼Œç”¨ peek() æ–¹æ³•æ£€æŸ¥ã€‚</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">count</span> = streams.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">filter</span>(|s| s.<span class="hljs-title function_ invoke__">peek</span>().<span class="hljs-title function_ invoke__">is_some</span>()).<span class="hljs-title function_ invoke__">count</span>();<br><br>  <span class="hljs-comment">// åªè¦ count å¤§äº0ï¼Œè¡¨ç¤ºè¿˜æœ‰æ–‡ä»¶æœªå®Œå…¨å¤„ç†ï¼Œå°±ç»§ç»­å¾ªç¯ã€‚</span><br>    <span class="hljs-keyword">while</span> count &gt; <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">term</span> = <span class="hljs-literal">None</span>;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">nbytes</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">df</span> = <span class="hljs-number">0</span>;<br><br>        <span class="hljs-comment">// è¿™æ®µä»£ç é€šè¿‡éå†æ¯ä¸ªæ–‡ä»¶æµï¼Œä½¿ç”¨ peek() æ–¹æ³•é¢„è§ˆæ¯ä¸ªæ–‡ä»¶çš„å½“å‰æ•°æ®æ¡ç›®</span><br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">s</span> <span class="hljs-keyword">in</span> &amp;streams &#123;<br>            <span class="hljs-keyword">match</span> s.<span class="hljs-title function_ invoke__">peek</span>() &#123;<br>                <span class="hljs-literal">None</span> =&gt; &#123;&#125;<br>                <span class="hljs-title function_ invoke__">Some</span>(entry) =&gt; &#123;<br>                  <span class="hljs-comment">// term æ˜¯ç©ºçš„ï¼Œåˆ™è¯´æ˜è¿™æ˜¯è¡¨ç¤º doc çš„ entryã€‚</span><br>                  <span class="hljs-comment">// ç›´æ¥é€€å‡º for å¾ªç¯ï¼Œå› ä¸º doc çš„ entry æ²¡æœ‰é¡ºåºä¸”å”¯ä¸€ï¼Œä¸ä¼šè¿›è¡Œç´¯åŠ ã€‚</span><br>                    <span class="hljs-keyword">if</span> entry.term.<span class="hljs-title function_ invoke__">is_empty</span>() &#123;<br>                        term = <span class="hljs-title function_ invoke__">Some</span>(entry.term.<span class="hljs-title function_ invoke__">clone</span>());<br>                        nbytes = entry.nbytes;<br>                        df = entry.df;<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br><br>                  <span class="hljs-comment">// term ä¸æ˜¯ç©ºçš„ï¼Œåˆ™è¯´æ˜è¿™æ˜¯è¡¨ç¤º terms çš„ entryã€‚</span><br>                    <span class="hljs-comment">// é€‰æ‹©è¯æ¡æœ€å°çš„ä¸€ä¸ªï¼ˆå­—å…¸åºï¼‰ï¼Œå¹¶ä¸”ç´¯åŠ å…¶å‡ºç°çš„é¢‘æ¬¡å’Œå­—èŠ‚å¤§å°ã€‚</span><br>                    <span class="hljs-comment">// è¿™æ˜¯å¤šè·¯å½’å¹¶çš„æ ¸å¿ƒï¼Œç¡®ä¿è¾“å‡ºæ–‡ä»¶æ˜¯æœ‰åºçš„ã€‚</span><br>                    <span class="hljs-keyword">if</span> term.<span class="hljs-title function_ invoke__">is_none</span>() || entry.term &lt; *term.<span class="hljs-title function_ invoke__">as_ref</span>().<span class="hljs-title function_ invoke__">unwrap</span>() &#123;<br>                        term = <span class="hljs-title function_ invoke__">Some</span>(entry.term.<span class="hljs-title function_ invoke__">clone</span>());<br>                        nbytes = entry.nbytes;<br>                        df = entry.df<br>                    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> entry.term == *term.<span class="hljs-title function_ invoke__">as_ref</span>().<span class="hljs-title function_ invoke__">unwrap</span>() &#123;<br>                        nbytes += entry.nbytes;<br>                        df += entry.df<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">term</span> = term.<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">&quot;bug in algorithm&quot;</span>);<br><br>      <span class="hljs-comment">// å¯¹äºæ¯ä¸ªæ–‡ä»¶æµï¼Œå¦‚æœå½“å‰æ•°æ®æ¡ç›®ä¸é€‰æ‹©çš„ term ç›¸åŒï¼Œ</span><br>        <span class="hljs-comment">// åˆ™å°†è¯¥æ¡ç›®å†™å…¥è¾“å‡ºæ–‡ä»¶ï¼Œå¹¶æ›´æ–°è¯¥æµçš„è¯»å–ä½ç½®ã€‚</span><br>      <span class="hljs-keyword">for</span> <span class="hljs-variable">s</span> <span class="hljs-keyword">in</span> &amp;<span class="hljs-keyword">mut</span> streams &#123;<br>            <span class="hljs-keyword">if</span> s.<span class="hljs-title function_ invoke__">is_at</span>(&amp;term) &#123;<br>                s.<span class="hljs-title function_ invoke__">move_entry_to</span>(&amp;<span class="hljs-keyword">mut</span> output)?;<br>                <span class="hljs-keyword">if</span> s.<span class="hljs-title function_ invoke__">peek</span>().<span class="hljs-title function_ invoke__">is_none</span>() &#123;<br>                    count -= <span class="hljs-number">1</span>;<br>                &#125;<br>                <span class="hljs-keyword">if</span> term.<span class="hljs-title function_ invoke__">is_empty</span>() &#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        output.<span class="hljs-title function_ invoke__">write_contents_entry</span>(term, df, point, nbytes);<br>        point += nbytes<br>    &#125;<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæ¶‰åŠåˆ°äº†ä¸€ä¸ªæ–°çš„ç»“æ„<code>IndexFileReader</code>ï¼Œå®ƒæ˜¯ç´¢å¼•æ–‡ä»¶çš„è¯»å–å™¨ï¼Œæˆ‘ä»¬å°†åœ¨<code>read.rs</code> ä¸­å®ç°å®ƒã€‚è¿™é‡Œå…ˆä¸å±•å¼€ï¼Œä½ åªéœ€è¦çŸ¥é“ï¼š</p><ul><li><code>IndexFileReader::open_and_delete(p, true)</code>:æ‰“å¼€ä¸€ä¸ªç´¢å¼•æ–‡ä»¶ï¼Œå¹¶æ ¹æ®ä¼ å…¥çš„å‚æ•°åˆ¤æ–­æ˜¯å¦è¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶ï¼Œåœ¨åˆå¹¶è¿‡ç¨‹ä¸­ï¼Œå› ä¸ºéƒ½æ˜¯ä¸´æ—¶æ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šæŒ‡å®šä¸ºåˆ é™¤æ–‡ä»¶ã€‚ä½†æ˜¯åœ¨åé¢ä»ç´¢å¼•æ–‡ä»¶ä¸­é‡å»º<code>InMemoryIndex</code> çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›åˆ é™¤åŸå§‹çš„ç´¢å¼•æ–‡ä»¶ã€‚</li><li><code>s.peek()</code>: æŸ¥çœ‹ä¸‹ä¸€ä¸ª Entryï¼Œå®ƒçš„è¿”å›å€¼æ˜¯Option&lt;Entry&gt;ã€‚</li><li><code>s.move_entry_to(&amp;mut output)</code>: å°†<code>s.peek()</code> æŒ‡å‘çš„ Entry å†™å…¥åˆ° output æ–‡ä»¶ä¸­ï¼Œå¹¶ç§»åŠ¨åˆ°ä¸€ä¸‹Entryã€‚</li></ul><p>æ€»ç»“ä¸‹æ¥ï¼Œè¿™ä¸ªå‡½æ•°å®ç°å¤šè·¯å½’å¹¶çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œå®ƒå°†å¤šä¸ªç´¢å¼•æ–‡ä»¶åˆå¹¶æˆä¸€ä¸ªå•ä¸€çš„æœ‰åºæ–‡ä»¶ã€‚</p><h3 id="finish-1">finish</h3><p>æˆ‘ä»¬å†æ¥çœ‹ <code>FileMerge</code> çš„å¦å¤–ä¸€ä¸ªæ–¹æ³•<code>finish</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">finish</span>(<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br><br>    <span class="hljs-comment">// åˆå§‹åŒ–ä¸€ä¸ªä¸´æ—¶å‘é‡ tmpï¼Œç”¨æ¥æš‚å­˜éœ€è¦åˆå¹¶çš„æ–‡ä»¶è·¯å¾„ã€‚</span><br>    <span class="hljs-comment">// è¿™ä¸ªå‘é‡çš„å®¹é‡è®¾ç½®ä¸º NSTREAMSï¼Œè¿™æ˜¯é¢„å…ˆå®šä¹‰çš„å¸¸é‡ï¼Œè¡¨ç¤ºä¸€æ¬¡å¯ä»¥åˆå¹¶çš„æœ€å¤§æ–‡ä»¶æ•°ã€‚</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">tmp</span> = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">with_capacity</span>(NSTREAMS);<br><br>    <span class="hljs-comment">// æ–¹æ³•éå† self.stacks ä¸­çš„æ¯ä¸ªå †æ ˆã€‚æ¯ä¸ªå †æ ˆä»£è¡¨ä¸€ä¸ªåˆå¹¶å±‚çº§ï¼ŒåŒ…å«è‹¥å¹²å¾…åˆå¹¶çš„æ–‡ä»¶ã€‚</span><br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">stack</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.stacks &#123;<br>        <span class="hljs-comment">// å¯¹äºæ¯ä¸ªå †æ ˆï¼Œæ–¹æ³•ä½¿ç”¨ .into_iter().rev() è¿­ä»£å™¨åå‘éå†æ–‡ä»¶ï¼Œ</span><br>      <span class="hljs-comment">// ä»¥ç¡®ä¿æŒ‰æ­£ç¡®çš„é¡ºåºå¤„ç†ï¼ˆå…ˆè¿›åå‡ºï¼‰ã€‚</span><br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">file</span> <span class="hljs-keyword">in</span> stack.<span class="hljs-title function_ invoke__">into_iter</span>().<span class="hljs-title function_ invoke__">rev</span>() &#123;<br>            <span class="hljs-comment">// å°†æ–‡ä»¶é€ä¸ªæ·»åŠ åˆ° tmp å‘é‡ä¸­ã€‚</span><br>            tmp.<span class="hljs-title function_ invoke__">push</span>(file);<br>            <span class="hljs-comment">// å½“ tmp çš„é•¿åº¦è¾¾åˆ° NSTREAMS æ—¶ï¼Œ</span><br>          <span class="hljs-comment">// è°ƒç”¨ merge_reversed å‡½æ•°è¿›è¡Œåˆå¹¶ã€‚</span><br>            <span class="hljs-keyword">if</span> tmp.<span class="hljs-title function_ invoke__">len</span>() == NSTREAMS &#123;<br>                <span class="hljs-title function_ invoke__">merge_reversed</span>(&amp;<span class="hljs-keyword">mut</span> tmp, &amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>.tmp_dir)?;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>  <span class="hljs-comment">// å¯¹äºå‰©ä½™æ–‡ä»¶è¿›è¡Œæœ€ç»ˆçš„åˆå¹¶ã€‚</span><br>    <span class="hljs-keyword">if</span> tmp.<span class="hljs-title function_ invoke__">len</span>() &gt; <span class="hljs-number">1</span> &#123;<br>        <span class="hljs-title function_ invoke__">merge_reversed</span>(&amp;<span class="hljs-keyword">mut</span> tmp, &amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>.tmp_dir)?;<br>    &#125;<br><br>  <span class="hljs-comment">// æœ€ååº”è¯¥åªæœ‰ä¸€ä¸ªæœ€ç»ˆæ–‡ä»¶</span><br>    <span class="hljs-built_in">assert!</span>(tmp.<span class="hljs-title function_ invoke__">len</span>() == <span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">match</span> tmp.<span class="hljs-title function_ invoke__">pop</span>() &#123;<br>      <span class="hljs-comment">// å¯¹æ–‡ä»¶è¿›è¡Œé‡å‘½å</span><br>        <span class="hljs-title function_ invoke__">Some</span>(last_file) =&gt; fs::<span class="hljs-title function_ invoke__">rename</span>(last_file, <span class="hljs-keyword">self</span>.output_dir.<span class="hljs-title function_ invoke__">join</span>(MERGED_FILENAME)),<br>        <span class="hljs-literal">None</span> =&gt; <span class="hljs-title function_ invoke__">Err</span>(io::Error::<span class="hljs-title function_ invoke__">new</span>(<br>            io::ErrorKind::Other,<br>            <span class="hljs-string">&quot;no ducuments were parsed or none contained any words&quot;</span>,<br>        )),<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæ¶‰åŠåˆ°äº†å¦å¤–ä¸€ä¸ªå‡½æ•° <code>merge_reversed</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">merge_reversed</span>(filenames: &amp;<span class="hljs-keyword">mut</span> <span class="hljs-type">Vec</span>&lt;PathBuf&gt;, tmp_dir: &amp;<span class="hljs-keyword">mut</span> TmpDir) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    filenames.<span class="hljs-title function_ invoke__">reverse</span>();<br>    <span class="hljs-keyword">let</span> (merge_filename, out) = tmp_dir.<span class="hljs-title function_ invoke__">create</span>()?;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">to_merge</span> = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">with_capacity</span>(NSTREAMS);<br>    mem::<span class="hljs-title function_ invoke__">swap</span>(filenames, &amp;<span class="hljs-keyword">mut</span> to_merge);<br>    <span class="hljs-title function_ invoke__">merge_streams</span>(to_merge, out)?;<br>    filenames.<span class="hljs-title function_ invoke__">push</span>(merge_filename);<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></td></tr></table></figure><p>å®ƒå…¶å®å°±æ˜¯å°† <code>filenames</code> ç¿»è½¬ï¼Œæ¸…ç©ºå¹¶å°†å†…å®¹è½¬ç§»åˆ°<code>to_merge</code>ï¼Œç„¶åè°ƒç”¨ <code>merge_streams</code>åˆå¹¶ï¼Œå¹¶å°†åˆå¹¶åçš„æ–‡ä»¶é‡æ–°æ”¾å›è¢«æ¸…ç©ºçš„<code>filenames</code>ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨ <code>finish</code> ä¸­å£°æ˜çš„<code>tmp</code> å˜é‡ã€‚</p><div class="note note-info">            <p><big><strong>ä¸ºä»€ä¹ˆè¿™é‡Œéœ€è¦ç¿»è½¬ filenamesï¼Ÿ</strong></big></p><p>å‡è®¾ NSTREAMS = 3ï¼Œæˆ‘ä»¬æ‰§è¡Œ <code>add_file</code>ï¼Œä»<code>file1</code> åˆ° <code>file8</code>ï¼Œé‚£ä¹ˆè¿‡ç¨‹å¦‚ä¸‹ï¼š</p><table><thead><tr class="header"><th>Action</th><th>Stack 0</th><th>Stack 1</th><th>Notes</th></tr></thead><tbody><tr class="odd"><td>Add file1</td><td>file1</td><td></td><td></td></tr><tr class="even"><td>Add file2</td><td>file1, file2</td><td></td><td></td></tr><tr class="odd"><td>Add file3</td><td>file1, file2, file3</td><td></td><td></td></tr><tr class="even"><td>Merge S1</td><td>(empty)</td><td>merge1</td><td><code>merge1</code> is the result of merging file1-file3</td></tr><tr class="odd"><td>Add file4</td><td>file4</td><td>merge1</td><td></td></tr><tr class="even"><td>Add file5</td><td>file4, file5</td><td>merge1</td><td></td></tr><tr class="odd"><td>Add file6</td><td>file4, file5, file6</td><td>merge1</td><td></td></tr><tr class="even"><td>Merge S2</td><td>(empty)</td><td>merge1, merge2</td><td><code>merge2</code> is the result of merging file4-file6</td></tr><tr class="odd"><td>Add file7</td><td>file7</td><td>merge1, merge2</td><td></td></tr><tr class="even"><td>Add file8</td><td>file7, file8</td><td>merge1, merge2</td><td>Trigger merge because 8 files are reached</td></tr></tbody></table><p>æœ€åæˆ‘ä»¬è·å¾—çš„ç»“æœæ˜¯ï¼š</p><table><thead><tr class="header"><th>stack0</th><th>stack1</th></tr></thead><tbody><tr class="odd"><td>file7, file8</td><td>merge1, merge2</td></tr></tbody></table><p>æŒ‰ç…§æ–‡ä»¶çš„æ·»åŠ é¡ºåºï¼Œæˆ‘ä»¬æœŸæœ›åœ¨ <code>finish</code>ä¸­åˆå¹¶çš„é¡ºåºåº”è¯¥æ˜¯ï¼šmerge1, merge2, file7, file8ã€‚æ‰€ä»¥æˆ‘ä»¬éå†<code>stacks</code> çš„æ—¶å€™ï¼Œä»ç¬¬ 1 å±‚å¼€å§‹éå†çš„è¯ï¼Œæˆ‘ä»¬å°±éœ€è¦åå‘éå†<code>rev()</code>ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬ç»„æˆçš„ <code>tmp</code> å°±æ˜¯ï¼šfile8,file7, merge2, merge1ã€‚æœ€åæˆ‘ä»¬ä¼ å…¥ <code>merge_reversed</code>çš„æ—¶å€™ï¼Œå†è¿›è¡Œ <code>reverse()</code>ï¼Œå°±å¯ä»¥è·å¾—æˆ‘ä»¬æœŸæœ›çš„é¡ºåº merge1,merge2, file7, file8ã€‚</p>          </div><p>å›è¿‡å¤´æ¥ï¼Œæˆ‘ä»¬æ€»ç»“ä¸€ä¸‹<code>finish</code>ï¼šè¿™ä¸ªæ–¹æ³•é€šè¿‡å¤šçº§åˆå¹¶çš„æ–¹å¼ï¼Œé€å±‚å¤„ç†å¹¶æœ€ç»ˆåˆå¹¶æ‰€æœ‰æ–‡ä»¶åˆ°ä¸€ä¸ªæ–‡ä»¶ã€‚è¿™ä¸ªæ–¹æ³•ç¡®ä¿åœ¨å¤šä¸ªæ–‡ä»¶é¢‘ç¹åˆå¹¶çš„ç¯å¢ƒä¸­ï¼Œèƒ½æœ‰æ•ˆåœ°ç®¡ç†å’Œå‡å°‘ä¸´æ—¶å­˜å‚¨ä½¿ç”¨ï¼Œå¹¶ä¿æŒåˆå¹¶æ“ä½œçš„æ•ˆç‡ã€‚é€šè¿‡æœ€åçš„é‡å‘½åæ“ä½œï¼Œå®ƒè¿˜å¤„ç†äº†æ–‡ä»¶çš„æœ€ç»ˆå­˜æ”¾ï¼Œç¡®ä¿åˆå¹¶ç»“æœçš„æ­£ç¡®æ€§å’Œå¯ç”¨æ€§ã€‚</p><p>å®ç°äº† <code>merge.rs</code> çš„ç›¸å…³å†…å®¹ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¥å®ç°<code>create.rs</code> ä¸­çš„æœ€åä¸€æ­¥äº†ã€‚</p><h3 id="step5-merge_index_files">step5: merge_index_files</h3><p>æˆ‘ä»¬å°†ç¬¬ 4 é˜¶æ®µæ„å»ºçš„ä¸´æ—¶æ–‡ä»¶åˆå¹¶æˆä¸€ä¸ªæœ€ç»ˆçš„ç´¢å¼•æ–‡ä»¶å¹¶è¾“å‡ºåˆ°<code>output_dir</code> ç›®å½•ä¸­ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">merge_index_files</span>(files: Receiver&lt;PathBuf&gt;, output_dir: &amp;Path) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">merge</span> = FileMerge::<span class="hljs-title function_ invoke__">new</span>(output_dir);<br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">file</span> <span class="hljs-keyword">in</span> files &#123;<br>        merge.<span class="hljs-title function_ invoke__">add_file</span>(file)?;<br>    &#125;<br>    merge.<span class="hljs-title function_ invoke__">finish</span>()<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="run_pipeline">run_pipeline</h3><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†å¹¶å‘æ„å»ºå€’æ’ç´¢å¼•çš„ 5ä¸ªæ­¥éª¤äº†ï¼Œå¯¹å…¶è¿›è¡Œç»„ç»‡ï¼Œå°±å¯ä»¥å®ç°æˆ‘ä»¬çš„å¹¶å‘æ„å»ºå‡½æ•°<code>run_pipeline</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">run_pipeline</span>(documents: <span class="hljs-type">Vec</span>&lt;PathBuf&gt;, output_dir: PathBuf) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-comment">// Launch all five stages of the pipeline.</span><br>    <span class="hljs-keyword">let</span> (texts, h1) = <span class="hljs-title function_ invoke__">start_file_reader_thread</span>(documents);<br>    <span class="hljs-keyword">let</span> (pints, h2) = <span class="hljs-title function_ invoke__">start_file_indexing_thread</span>(texts);<br>    <span class="hljs-keyword">let</span> (gallons, h3) = <span class="hljs-title function_ invoke__">start_in_memory_merge_thread</span>(pints);<br>    <span class="hljs-keyword">let</span> (files, h4) = <span class="hljs-title function_ invoke__">start_index_writer_thread</span>(gallons, &amp;output_dir);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">result</span> = <span class="hljs-title function_ invoke__">merge_index_files</span>(files, &amp;output_dir);<br><br>    <span class="hljs-comment">// Wait for threads to finish, holding on to any errors that they encounter.</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">r1</span> = h1.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br>    h2.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br>    h3.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">r4</span> = h4.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br><br>    <span class="hljs-comment">// Return the first error encountered, if any.</span><br>    <span class="hljs-comment">// (As it happens, h2 and h3 can&#x27;t fail: those threads</span><br>    <span class="hljs-comment">// are pure in-memory data processing.)</span><br>    r1?;<br>    r4?;<br>    result<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="read.rs">read.rs</h2><blockquote><p>å®Œæ•´æºç ï¼š<ahref="https://github.com/hedon-rust-road/inverted-index-concurrency/blob/master/src/read.rs">read.rs</a></p></blockquote><p>åœ¨ <code>merge.rs</code> ä¸­ï¼Œæˆ‘ä»¬è¿˜å‰©æœ€åä¸€ä¸ªç»“æ„æ²¡æœ‰è§£æï¼Œé‚£å°±æ˜¯<code>IndexFileReader</code>ï¼Œå®ƒæ˜¯ç´¢å¼•æ–‡ä»¶çš„è¯»å–å™¨ã€‚</p><h3 id="struct-indexfilereader">struct: IndexFileReader</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">IndexFileReader</span> &#123;<br>    <span class="hljs-keyword">pub</span> terms_docs: BufReader&lt;File&gt;,<br>    entries: BufReader&lt;File&gt;,<br>    next: <span class="hljs-type">Option</span>&lt;Entry&gt;,<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Entry</span> &#123;<br>    <span class="hljs-keyword">pub</span> term: <span class="hljs-type">String</span>,<br>    <span class="hljs-keyword">pub</span> df: <span class="hljs-type">u32</span>,<br>    <span class="hljs-keyword">pub</span> offset: <span class="hljs-type">u64</span>,<br>    <span class="hljs-keyword">pub</span> nbytes: <span class="hljs-type">u64</span>,<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬åœ¨ <code>IndexFileReader</code> ç»“æ„ä½“ä¸­å®šä¹‰ä¸¤ä¸ª<code>BufReader&lt;File&gt;</code>ï¼Œè¿™æ˜¯ä¸ºäº†æœ‰æ•ˆç®¡ç†å’Œæ“ä½œç´¢å¼•æ–‡ä»¶ä¸­çš„ä¸åŒæ•°æ®æ®µã€‚å…·ä½“æ¥è¯´ï¼Œè¿™ç§è®¾è®¡ä½¿å¾—ä»£ç èƒ½å¤Ÿæ›´åŠ çµæ´»å’Œé«˜æ•ˆåœ°å¤„ç†ç´¢å¼•æ–‡ä»¶ä¸­çš„â€œä¸»æ•°æ®åŒºâ€å’Œâ€œå†…å®¹è¡¨åŒºâ€ã€‚</p><p>å³ç”¨æ¥åˆ†åˆ«å¤„ç†ä¸‹å›¾çš„ <code>terms&amp;doc</code> å’Œ<code>entries</code> ä¸¤ä¸ªåŒºåŸŸï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240423194529529-20240423195227516.png"alt="ç´¢å¼•æ–‡ä»¶å†…å­˜ç»“æ„ç¤ºæ„å›¾" /><figcaption aria-hidden="true">ç´¢å¼•æ–‡ä»¶å†…å­˜ç»“æ„ç¤ºæ„å›¾</figcaption></figure><p>è¿™æœ‰å‡ ä¸ªå¥½å¤„ï¼š</p><ul><li><strong>ç‹¬ç«‹çš„æ–‡ä»¶æŒ‡é’ˆ</strong>ï¼šæ¯ä¸ª<code>BufReader&lt;File&gt;</code>ç»´æŠ¤è‡ªå·±çš„æ–‡ä»¶è¯»å–ä½ç½®ï¼ˆæ–‡ä»¶æŒ‡é’ˆï¼‰ã€‚è¿™æ„å‘³ç€è¯»å–æˆ–æœç´¢å†…å®¹è¡¨æ—¶ï¼Œä¸ä¼šå½±å“ä¸»æ•°æ®åŒºçš„æ–‡ä»¶æŒ‡é’ˆï¼Œåä¹‹äº¦ç„¶ã€‚è¿™æ ·å¯ä»¥é¿å…é¢‘ç¹åœ°é‡æ–°å®šä½æ–‡ä»¶æŒ‡é’ˆï¼Œæé«˜æ–‡ä»¶æ“ä½œçš„æ•ˆç‡ã€‚</li><li><strong>ç¼“å†²è¯»å–</strong>ï¼š<code>BufReader</code>æä¾›äº†ç¼“å†²è¯»å–åŠŸèƒ½ï¼Œå¯ä»¥å‡å°‘ç›´æ¥å¯¹ç¡¬ç›˜çš„è¯»å–æ¬¡æ•°ï¼Œä»è€Œä¼˜åŒ–è¯»å–æ€§èƒ½ã€‚å¯¹äºéœ€è¦é¢‘ç¹è¯»å–å°å—æ•°æ®çš„ç´¢å¼•æ“ä½œï¼Œä½¿ç”¨ç¼“å†²è¯»å–å¯ä»¥æ˜¾è‘—æé«˜æ•ˆç‡ã€‚</li><li><strong>å¹¶è¡Œæ“ä½œ</strong>ï¼šåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œå¯èƒ½éœ€è¦åŒæ—¶è¯»å–ä¸»æ•°æ®åŒºå’Œå†…å®¹è¡¨åŒºã€‚ä½¿ç”¨ä¸¤ä¸ªç‹¬ç«‹çš„<code>BufReader</code>å®ä¾‹å¯ä»¥ç®€åŒ–å¹¶è¡Œè¯»å–çš„ç®¡ç†ï¼Œæ¯ä¸ªè¯»å–æ“ä½œéƒ½å¯ä»¥åœ¨ä¸å¹²æ‰°å¦ä¸€ä¸ªæ“ä½œçš„æƒ…å†µä¸‹ç‹¬ç«‹è¿›è¡Œã€‚</li></ul><p><code>Entry</code> å°±æ˜¯æˆ‘ä»¬åœ¨ <code>write.rs</code> ä¸­<code>write_contents_entry</code> æ—¶ä¼ å…¥çš„å‚æ•°ï¼Œè¿™é‡Œæˆ‘ä»¬å°†å…¶å°è£…æˆä¸€ä¸ªstructï¼Œå†æ¬¡å›é¡¾ä¸‹è¿™å‡ ä¸ªå­—æ®µçš„å«ä¹‰ï¼š</p><ul><li><code>term</code>: ç´¢å¼•å•è¯ã€‚ä¸ºäº†ç»Ÿä¸€ï¼Œå¦‚æœ <code>term</code>ä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºå½“å‰è¡¨ç¤ºçš„æ˜¯ docï¼Œå¦åˆ™ä¸º termsã€‚</li><li><code>df</code>: term çš„å‡ºç°æ¬¡æ•°ã€‚ä¸ºäº†ç»Ÿä¸€ï¼Œå¦‚æœ <code>df</code> ä¸º0ï¼Œåˆ™è¡¨ç¤ºå½“å‰è¡¨ç¤ºçš„æ˜¯ docï¼Œå¦åˆ™ä¸º termsã€‚</li><li><code>offset</code>: å¯¹åº”çš„ terms æˆ– docs åœ¨æ–‡ä»¶ä¸­çš„åç§»ã€‚</li><li><code>nbytes</code>: å¯¹åº”çš„ terms æˆ– docs çš„æ€»é•¿åº¦ã€‚</li></ul><h3 id="read_entry">read_entry</h3><p>è¿™é‡Œæˆ‘ä»¬é‡ç‚¹è§£é‡Šä¸€ä¸‹ <code>read_entry</code>æ–¹æ³•ï¼Œå…¶ä»–çš„éƒ½æ¯”è¾ƒç®€å•ï¼Œè¯·åœ¨æºç ä¸­æŸ¥æ‰¾ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">read_entry</span>(f: &amp;<span class="hljs-keyword">mut</span> BufReader&lt;File&gt;) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;<span class="hljs-type">Option</span>&lt;Entry&gt;&gt; &#123;<br>  <span class="hljs-comment">// è·å–åç§»å€¼</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">offset</span> = <span class="hljs-keyword">match</span> f.read_u64::&lt;LittleEndian&gt;() &#123;<br>        <span class="hljs-title function_ invoke__">Ok</span>(value) =&gt; value,<br>        <span class="hljs-title function_ invoke__">Err</span>(err) =&gt; &#123;<br>            <span class="hljs-keyword">if</span> err.<span class="hljs-title function_ invoke__">kind</span>() == io::ErrorKind::UnexpectedEof &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Ok</span>(<span class="hljs-literal">None</span>);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Err</span>(err);<br>            &#125;<br>        &#125;<br>    &#125;;<br><br>  <span class="hljs-comment">// è¯»å– nbytes</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">nbytes</span> = f.read_u64::&lt;LittleEndian&gt;()?;<br>  <span class="hljs-comment">// è¯»å– df</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">df</span> = f.read_u32::&lt;LittleEndian&gt;()?;<br>  <span class="hljs-comment">// è¯»å– term_lenï¼Œå¹¶åˆå§‹åŒ–ä¸€å—å†…å­˜ bytes ç”¨æ¥è¯»å–å®Œæ•´çš„ term</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">term_len</span> = f.read_u32::&lt;LittleEndian&gt;()? <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">bytes</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">0</span>; term_len];<br>    f.<span class="hljs-title function_ invoke__">read_exact</span>(&amp;<span class="hljs-keyword">mut</span> bytes)?;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">term</span> = <span class="hljs-keyword">match</span> <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from_utf8</span>(bytes) &#123;<br>        <span class="hljs-title function_ invoke__">Ok</span>(s) =&gt; s,<br>        <span class="hljs-title function_ invoke__">Err</span>(_) =&gt; <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Err</span>(io::Error::<span class="hljs-title function_ invoke__">new</span>(io::ErrorKind::Other, <span class="hljs-string">&quot;unicode fail&quot;</span>)),<br>    &#125;;<br><br>  <span class="hljs-comment">// è¿”å›æ„å»ºçš„ Entry</span><br>    <span class="hljs-title function_ invoke__">Ok</span>(<span class="hljs-title function_ invoke__">Some</span>(Entry &#123;<br>        term,<br>        df,<br>        offset,<br>        nbytes,<br>    &#125;))<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»“åˆä¸‹é¢è¿™å¼ å›¾ï¼Œå¾ˆå®¹æ˜“ç†è§£ <code>read_entry</code> å°±æ˜¯å‰é¢<code>write_contents_entry</code> çš„é€†å‘è¿‡ç¨‹ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240423224035544.png"alt="entries åŒºåŸŸå¸ƒå±€ï¼Œæ¯ä¸ª entry ç´§è´´æ’å¸ƒ" /><figcaption aria-hidden="true">entries åŒºåŸŸå¸ƒå±€ï¼Œæ¯ä¸ª entryç´§è´´æ’å¸ƒ</figcaption></figure><h2 id="create.rs-1">create.rs</h2><blockquote><p>å®Œæ•´æºç ï¼š<ahref="https://github.com/hedon-rust-road/inverted-index-concurrency/blob/master/src/bin/create.rs">create.rs</a></p></blockquote><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±åˆ†æå®Œå¹¶å‘æ„å»ºç´¢å¼•çš„æ•´ä¸ªè¿‡ç¨‹äº†ï¼Œåœ¨ <code>create.rs</code>ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>clap</code> å‘½ä»¤è§£ææ¡†æ¶æ¥æ„å»ºä¸€ä¸ª CLIå·¥å…·ç”¨ä»¥æ”¯æŒæ„å»ºç´¢å¼•ï¼Œæˆ‘ä»¬åŒæ—¶æ”¯æŒå•çº¿ç¨‹æ„å»ºå’Œå¹¶å‘æ„å»ºï¼Œå…·ä½“å¯çœ‹å®Œæ•´æºç ã€‚</p><p>å¦‚æœå¯¹ <code>clap</code> ä¸ç†Ÿæ‚‰çš„è¯»è€…ï¼Œå¯å‚è€ƒï¼š<ahref="https://hedon.top/2024/03/02/rust-crate-clap/">æ·±å…¥æ¢ç´¢ Rust çš„clap åº“ï¼šå‘½ä»¤è¡Œè§£æçš„è‰ºæœ¯</a></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Opts</span> &#123;<br>    <span class="hljs-meta">#[arg(short, long, default_value_t = false, help = <span class="hljs-string">&quot;Default false&quot;</span>)]</span><br>    single_threaded: <span class="hljs-type">bool</span>,<br><br>    <span class="hljs-meta">#[arg(required = true)]</span><br>    filenames: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">String</span>&gt;,<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">opts</span> = Opts::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-keyword">match</span> <span class="hljs-title function_ invoke__">run</span>(opts.filenames, opts.single_threaded) &#123;<br>        <span class="hljs-title function_ invoke__">Ok</span>(()) =&gt; &#123;&#125;<br>        <span class="hljs-title function_ invoke__">Err</span>(err) =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;error: &#123;&#125;&quot;</span>, err),<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="æœç´¢åŠŸèƒ½">æœç´¢åŠŸèƒ½</h1><p>åœ¨ã€ŠRustç¨‹åºè®¾è®¡ï¼ˆç¬¬äºŒç‰ˆï¼‰ã€‹ä¸­ï¼Œä½œè€…å¹¶æ²¡æœ‰å®ç°æœç´¢åŠŸèƒ½ï¼Œç¬”è€…å¯¹å…¶è¿›è¡Œæ‰©å±•ï¼Œç›®æ ‡æ˜¯å¯¹æ ‡æˆ‘ä»¬å‰ç¯‡æ‰€æ„å»ºçš„<ahref="https://hedon.top/2024/04/15/rust-action-inverted-index-demo/">Rustå®æˆ˜ä¸¨å€’æ’ç´¢å¼•</a>ã€‚è¿™ä¸ªæœç´¢åŠŸèƒ½ï¼Œä¼šæ ¹æ®ç°æœ‰çš„ç´¢å¼•æ–‡ä»¶é‡å»ºå†…å­˜ç´¢å¼•<code>InMemoryIndex</code>ï¼Œæ”¯æŒæŒ‡å®š <code>term</code>è¿›è¡Œæœç´¢ï¼Œå¹¶å°†åŒ…å«è¿™ä¸ª <code>term</code>çš„æ–‡ä»¶åœ¨å“åº”çš„ä½ç½®ä¸­è¿›è¡Œé«˜äº®æ˜¾ç¤ºå¹¶è¾“å‡ºåˆ°ç»ˆç«¯ã€‚</p><h2 id="search.rs-1">search.rs</h2><blockquote><p>å®Œæ•´æºç ï¼š<ahref="https://github.com/hedon-rust-road/inverted-index-concurrency/blob/master/src/bin/search.rs">search.rs</a></p></blockquote><p>ç¨‹åºå…¥å£å¦‚ä¸‹æ‰€ç¤ºï¼Œæ¯”è¾ƒç®€å•ï¼Œå°±ä¸èµ˜è¿°äº†ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Opts</span> &#123;<br>    <span class="hljs-meta">#[arg(short, long, required = true, help = <span class="hljs-string">&quot;Specify index file path&quot;</span>)]</span><br>    index_file: <span class="hljs-type">String</span>,<br>    <span class="hljs-meta">#[arg(short, long, required = true, help = <span class="hljs-string">&quot;Specify search term&quot;</span>)]</span><br>    term: <span class="hljs-type">String</span>,<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">opts</span> = Opts::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">index</span> = InMemoryIndex::<span class="hljs-title function_ invoke__">from_index_file</span>(opts.index_file)?;<br>    index.<span class="hljs-title function_ invoke__">search</span>(&amp;opts.term)?;<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ 2 ä¸ªæ ¸å¿ƒé€»è¾‘ï¼š</p><ul><li><code>InMemoryIndex::from_index_file</code>:æ ¹æ®ç´¢å¼•æ–‡ä»¶é‡å»ºå†…å­˜ç´¢å¼•ã€‚</li><li><code>index.search(term)</code>: æœç´¢ã€‚</li></ul><h2 id="index.rs-1">index.rs</h2><p>æˆ‘ä»¬åœ¨ <code>index.rs</code> ä¸­ä¸º <code>InMemoryIndex</code> å®ç°ä¸Šè¿°2 ä¸ªæ–¹æ³•ã€‚</p><h3 id="from_index_file">from_index_file</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from_index_file</span>&lt;P: <span class="hljs-built_in">AsRef</span>&lt;Path&gt;&gt;(filename: P) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;InMemoryIndex&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">index</span> = InMemoryIndex::<span class="hljs-title function_ invoke__">new</span>();<br><br>  <span class="hljs-comment">// è·å– IndexFileReader</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">reader</span> = IndexFileReader::<span class="hljs-title function_ invoke__">open_and_delete</span>(filename, <span class="hljs-literal">false</span>)?;<br><br>  <span class="hljs-comment">// ä¾æ¬¡è§£ææ¯ä¸ª Entry</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(entry) = reader.<span class="hljs-title function_ invoke__">iter_next_entry</span>() &#123;<br>        <span class="hljs-keyword">if</span> entry.term.<span class="hljs-title function_ invoke__">is_empty</span>() &amp;&amp; entry.df == <span class="hljs-number">0</span> &#123;<br>            <span class="hljs-comment">// å½“å‰ Entry æŒ‡å‘çš„æ˜¯ä¸€ä¸ª Documentã€‚</span><br>          <span class="hljs-comment">// é€šè¿‡ terms_docs è¯»å– Document æ‰€åœ¨ä½ç½®å¹¶è¿›è¡Œè§£æã€‚</span><br>            reader.terms_docs.<span class="hljs-title function_ invoke__">seek</span>(io::SeekFrom::<span class="hljs-title function_ invoke__">Start</span>(entry.offset))?;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">doc_id</span> = reader.terms_docs.read_u32::&lt;LittleEndian&gt;()?;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">path_len</span> = reader.terms_docs.read_u64::&lt;LittleEndian&gt;()?;<br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">path</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">0u8</span>; path_len <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>];<br>            reader.terms_docs.<span class="hljs-title function_ invoke__">read_exact</span>(&amp;<span class="hljs-keyword">mut</span> path)?;<br>            index.docs.<span class="hljs-title function_ invoke__">insert</span>(<br>                doc_id,<br>                Document &#123;<br>                    id: doc_id,<br>                    path: <span class="hljs-title function_ invoke__">vec_to_pathbuf</span>(path),<br>                &#125;,<br>            );<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// å½“å‰ Entry æŒ‡å‘çš„æ˜¯ä¸€ä¸ª termsã€‚</span><br>          <span class="hljs-comment">// é€šè¿‡ terms_docs è¯»å– terms æ‰€åœ¨ä½ç½®å¹¶è¿›è¡Œè§£æã€‚</span><br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">hits</span> = <span class="hljs-built_in">vec!</span>[];<br>            reader.terms_docs.<span class="hljs-title function_ invoke__">seek</span>(io::SeekFrom::<span class="hljs-title function_ invoke__">Start</span>(entry.offset))?;<br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">data</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">0u8</span>; entry.nbytes <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>];<br>            reader.terms_docs.<span class="hljs-title function_ invoke__">read_exact</span>(&amp;<span class="hljs-keyword">mut</span> data)?;<br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">cursor</span> = Cursor::<span class="hljs-title function_ invoke__">new</span>(data);<br><br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">i</span> = entry.df;<br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">has_hit</span> = <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">quit</span> = <span class="hljs-literal">false</span>;<br><br>            <span class="hljs-keyword">while</span> i &gt; <span class="hljs-number">0</span> &amp;&amp; !quit &#123;<br>                <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">hit</span> = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">with_capacity</span>(<span class="hljs-number">4</span> + <span class="hljs-number">4</span> + <span class="hljs-number">4</span>); <span class="hljs-comment">// cannot use vec![0;12]</span><br>                <span class="hljs-keyword">loop</span> &#123;<br>                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Ok</span>(item) = cursor.read_i32::&lt;LittleEndian&gt;() &#123;<br>                        <span class="hljs-comment">// the start of next hit</span><br>                        <span class="hljs-keyword">if</span> item == <span class="hljs-keyword">Self</span>::HITS_SEPERATOR &amp;&amp; has_hit &#123;<br>                            hits.<span class="hljs-title function_ invoke__">push</span>(hit);<br>                            i -= <span class="hljs-number">1</span>;<br>                            index.word_count -= <span class="hljs-number">2</span>;<br>                            hit = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">with_capacity</span>(<span class="hljs-number">4</span> + <span class="hljs-number">4</span> + <span class="hljs-number">4</span>);<br>                        &#125;<br>                        has_hit = <span class="hljs-literal">true</span>;<br>                        hit.write_u32::&lt;LittleEndian&gt;(item <span class="hljs-keyword">as</span> <span class="hljs-type">u32</span>).<span class="hljs-title function_ invoke__">unwrap</span>();<br>                        index.word_count += <span class="hljs-number">1</span>;<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        quit = <span class="hljs-literal">true</span>;<br>                        <span class="hljs-keyword">if</span> !hit.<span class="hljs-title function_ invoke__">is_empty</span>() &#123;<br>                            hits.<span class="hljs-title function_ invoke__">push</span>(hit);<br>                            index.word_count -= <span class="hljs-number">2</span>;<br>                        &#125;<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br>            index.terms.<span class="hljs-title function_ invoke__">insert</span>(entry.term, hits);<br>        &#125;<br>    &#125;<br>    index.word_count /= <span class="hljs-number">2</span>;<br>    <span class="hljs-title function_ invoke__">Ok</span>(index)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="search">search</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">search</span>(&amp;<span class="hljs-keyword">self</span>, term: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>  <span class="hljs-comment">// è·å– term å‡ºç°çš„ä½ç½®</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">m</span>: <span class="hljs-type">Option</span>&lt;&amp;<span class="hljs-type">Vec</span>&lt;<span class="hljs-type">Vec</span>&lt;<span class="hljs-type">u8</span>&gt;&gt;&gt; = <span class="hljs-keyword">self</span>.terms.<span class="hljs-title function_ invoke__">get</span>(term);<br>    <span class="hljs-keyword">if</span> m.<span class="hljs-title function_ invoke__">is_none</span>() &#123;<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;can not found &#123;&#125; in all documents&quot;</span>, term);<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Ok</span>(());<br>    &#125;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">hits</span> = m.<span class="hljs-title function_ invoke__">unwrap</span>();<br><br>  <span class="hljs-comment">// éå†æ¯ä¸ªå‡ºç°çš„ä½ç½®</span><br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">hit</span> <span class="hljs-keyword">in</span> hits &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">cursor</span> = Cursor::<span class="hljs-title function_ invoke__">new</span>(hit);<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">_</span> = cursor.read_i32::&lt;LittleEndian&gt;().<span class="hljs-title function_ invoke__">unwrap</span>();<br><br>      <span class="hljs-comment">// è·å–æ–‡æ¡£åŸå§‹ä¿¡æ¯</span><br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">document_id</span> = cursor.read_u32::&lt;LittleEndian&gt;().<span class="hljs-title function_ invoke__">unwrap</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">doc</span> = <span class="hljs-keyword">self</span>.docs.<span class="hljs-title function_ invoke__">get</span>(&amp;document_id);<br>        <span class="hljs-keyword">if</span> doc.<span class="hljs-title function_ invoke__">is_none</span>() &#123;<br>            <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;cannot found document &#123;&#125;&quot;</span>, document_id);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">doc</span> = doc.<span class="hljs-title function_ invoke__">unwrap</span>();<br><br>      <span class="hljs-comment">// hits å­˜å‚¨çš„å†…å®¹ï¼š[HITS_SEPERATOR, document_id, start_pos1, end_pos1, ...]</span><br>      <span class="hljs-comment">// è§£æ term å‡ºç°åœ¨ doc ä¸­çš„æ¯ä¸ªä½ç½®</span><br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">poss</span> = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">with_capacity</span>(hits.<span class="hljs-title function_ invoke__">len</span>() / <span class="hljs-number">4</span>);<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">pos</span> = TokenPos::<span class="hljs-title function_ invoke__">default</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">has_pos</span> = <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Ok</span>(p) = cursor.read_u32::&lt;LittleEndian&gt;() &#123;<br>            <span class="hljs-keyword">if</span> !has_pos &#123;<br>                pos.start_pos = p;<br>                has_pos = <span class="hljs-literal">true</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                pos.end_pos = p;<br>                poss.<span class="hljs-title function_ invoke__">push</span>(pos);<br>                pos = TokenPos::<span class="hljs-title function_ invoke__">default</span>();<br>                has_pos = <span class="hljs-literal">false</span>;<br>            &#125;<br>        &#125;<br><br>      <span class="hljs-comment">// å¯¹æ¯ä¸ªå‡ºç°çš„ä½ç½®è¿›è¡Œé«˜äº®å¤„ç†</span><br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">result</span> = <span class="hljs-title function_ invoke__">highlight_file</span>(doc.path.<span class="hljs-title function_ invoke__">clone</span>(), &amp;<span class="hljs-keyword">mut</span> poss)?;<br>      <span class="hljs-comment">// è¾“å‡ºé«˜äº®åçš„ç»“æœ</span><br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;\n&#123;:?&#125;: \n&#123;&#125;&quot;</span>, doc.path, result);<br>    &#125;<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></td></tr></table></figure><hr /><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®ç°äº†é«˜å¹¶å‘æ„å»ºç´¢å¼•å’Œæ ¹æ®ç´¢å¼•è¿›è¡Œæœç´¢çš„åŠŸèƒ½ï¼Œæœ¬ç¯‡æŸäº›éƒ¨åˆ†å¯èƒ½æ¯”è¾ƒå¤æ‚ï¼Œç¯‡å¹…ä¹Ÿæ¯”è¾ƒå†—é•¿ï¼Œç¬”è€…åœ¨é˜…è¯»ä¹¦ä¸­åŸå®ç°çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯è·ç›Šé¢‡ä¸°ï¼Œæƒ³ä¸åˆ°ä¸€ä¸ªç®€å•çš„å€’æ’ç´¢å¼•ç«Ÿæ¶‰åŠè¿™ä¹ˆå¤šçš„å¤„ç†ç»†èŠ‚ã€‚ä¹Ÿå¸Œæœ›æœ¬ç¯‡æ–‡ç« èƒ½å¯¹æ„Ÿå…´è¶£çš„è¯»è€…æœ‰äº›è®¸å¸®åŠ©ã€‚</p><p>peace! enjoy coding~</p><h1 id="ç»˜å›¾å·¥å…·">ç»˜å›¾å·¥å…·</h1><ul><li><ahref="https://link.zhihu.com/?target=https%3A//excalidraw.com/">https://excalidraw.com/</a></li></ul><h1 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h1><ul><li><ahref="https://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Inverted_index">ç»´åŸºç™¾ç§‘Â·å€’æ’ç´¢å¼•</a></li><li><ahref="https://link.zhihu.com/?target=https%3A//book.douban.com/subject/36547630/">Rustç¨‹åºè®¾è®¡ï¼ˆç¬¬äºŒç‰ˆï¼‰</a></li></ul>]]></content>
    
    
    <summary type="html">æœ¬æ–‡è¯¦ç»†é˜è¿°äº†ä½¿ç”¨ Rust channel å¹¶å‘æ„å»ºå€’æ’ç´¢å¼•çš„è¯¦ç»†è¿‡ç¨‹ã€‚</summary>
    
    
    
    <category term="Rust" scheme="https://hedon.top/categories/Rust/"/>
    
    <category term="Rust å®æˆ˜" scheme="https://hedon.top/categories/Rust/Rust-%E5%AE%9E%E6%88%98/"/>
    
    
    <category term="Rust" scheme="https://hedon.top/tags/Rust/"/>
    
    <category term="å€’æ’ç´¢å¼•" scheme="https://hedon.top/tags/%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95/"/>
    
    <category term="å¹¶å‘ç¼–ç¨‹" scheme="https://hedon.top/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"/>
    
    <category term="é€šé“" scheme="https://hedon.top/tags/%E9%80%9A%E9%81%93/"/>
    
  </entry>
  
  <entry>
    <title>Rust å®æˆ˜ä¸¨å€’æ’ç´¢å¼•</title>
    <link href="https://hedon.top/2024/04/15/rust-action-inverted-index-demo/"/>
    <id>https://hedon.top/2024/04/15/rust-action-inverted-index-demo/</id>
    <published>2024-04-15T02:24:17.000Z</published>
    <updated>2024-04-21T15:53:41.028Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€">å¼•è¨€</h1><p>å€’æ’ç´¢å¼•ï¼ˆInvertedIndexï¼‰æ˜¯ä¸€ç§ç´¢å¼•æ•°æ®ç»“æ„ï¼Œç”¨äºå­˜å‚¨æŸä¸ªå•è¯ï¼ˆè¯é¡¹ï¼‰åœ¨ä¸€ç»„æ–‡æ¡£ä¸­çš„æ‰€æœ‰å‡ºç°æƒ…å†µçš„æ˜ å°„ã€‚å®ƒæ˜¯æœç´¢å¼•æ“æ‰§è¡Œå¿«é€Ÿå…¨æ–‡æœç´¢çš„æ ¸å¿ƒæŠ€æœ¯ï¼Œä¹Ÿå¹¿æ³›ç”¨äºæ•°æ®åº“ä¸­è¿›è¡Œæ–‡æœ¬æœç´¢ã€‚æˆ‘ä»¬ç†ŸçŸ¥çš„ElasticSearch æœ€æ ¸å¿ƒåº•å±‚åŸç†ä¾¿å°±æ˜¯å€’æ’ç´¢å¼•ã€‚</p><p>å€’æ’ç´¢å¼•çš„åŸºæœ¬åŸç†æ˜¯<strong>å°†æ–‡æ¡£ä¸­çš„è¯æ±‡è¿›è¡Œåè½¬ï¼Œå½¢æˆå€’æ’åˆ—è¡¨</strong>ã€‚åœ¨å€’æ’åˆ—è¡¨ä¸­ï¼Œæ¯ä¸ªè¯æ±‡éƒ½å¯¹åº”ä¸€ä¸ªæ–‡æ¡£æ ‡è¯†ç¬¦çš„åˆ—è¡¨ï¼Œè¿™äº›æ ‡è¯†ç¬¦æŒ‡æ˜äº†è¯¥è¯æ±‡å‡ºç°åœ¨å“ªäº›æ–‡æ¡£ä¸­ã€‚é€šè¿‡æŸ¥è¯¢å€’æ’åˆ—è¡¨ï¼Œå¯ä»¥å¿«é€Ÿåœ°æ‰¾åˆ°åŒ…å«ç‰¹å®šè¯æ±‡çš„æ–‡æ¡£ã€‚</p><p>æœ¬æ–‡å°†ä½¿ç”¨ Rustè¯­è¨€æ¥å®ç°ä¸€ä¸ªç®€å•çš„å€’æ’ç´¢å¼•ï¼ŒåŒ…æ‹¬å€’æ’ç´¢å¼•çš„æ„å»ºå’Œæœç´¢è¿‡ç¨‹ã€‚åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œç¬”è€…ä¼šåŸºäºã€ŠRustç¨‹åºè®¾è®¡ï¼ˆç¬¬äºŒç‰ˆï¼‰ã€‹å¹¶å‘ç¼–ç¨‹ç¯‡ç« ï¼Œè§£è¯»è¯¥ä¹¦ä½œè€…æ˜¯å¦‚ä½•åŸºäº Rusté€šé“å®ç°æ›´ä¼˜ç§€ã€æ›´é«˜æ€§èƒ½çš„å€’æ’ç´¢å¼•ã€‚</p><h1 id="å¯ä»¥å­¦åˆ°">å¯ä»¥å­¦åˆ°</h1><ol type="1"><li>å€’æ’ç´¢å¼•çš„åŸç†ã€ä¼˜åŠ¿å’Œä½¿ç”¨</li><li>å¸¸ç”¨ crateï¼š<code>colored</code>ã€<code>regex</code></li><li>Rust HashMap</li><li>Rust è¿­ä»£å™¨</li></ol><h1 id="å¼€å‘æ€è·¯">å¼€å‘æ€è·¯</h1><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/imgimage-20240414112337590.png"alt="å€’æ’ç´¢å¼•æ„å»ºè¿‡ç¨‹" /><figcaption aria-hidden="true">å€’æ’ç´¢å¼•æ„å»ºè¿‡ç¨‹</figcaption></figure><p>ä¸€ä¸ªç®€å•çš„å€’æ’ç´¢å¼•å¼€å‘æ€è·¯å¤§æ¦‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼š</p><ol type="1"><li>è¯»å–æ–‡æ¡£</li><li>åˆ†è¯</li><li>æ„å»ºæ¯ä¸ªè¯åˆ°æ¯ä¸ªæ–‡æ¡£çš„æ˜ å°„</li></ol><h1 id="å¼€å‘è¿‡ç¨‹">å¼€å‘è¿‡ç¨‹</h1><blockquote><p>å®Œæ•´æºç ä½äºï¼š<ahref="https://github.com/hedon-rust-road/inverted-index">inverted_index</a>ã€‚</p></blockquote><h2 id="æœ€ç»ˆæ•ˆæœ">æœ€ç»ˆæ•ˆæœ</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">index</span> = InvertedIndex::<span class="hljs-title function_ invoke__">new</span>();<br>    index.<span class="hljs-title function_ invoke__">add</span>(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;Rust is safe and fast.&quot;</span>);<br>    index.<span class="hljs-title function_ invoke__">add</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;Rust is a systems programming language.&quot;</span>);<br>    index.<span class="hljs-title function_ invoke__">add</span>(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;Programming in Rust is fun.&quot;</span>);<br><br>    <span class="hljs-comment">// query &quot;Rust&quot;</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">results</span> = index.<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-string">&quot;Rust&quot;</span>);<br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">result</span> <span class="hljs-keyword">in</span> results &#123;<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, result);<br>    &#125;<br><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&quot;</span>);<br><br>    <span class="hljs-comment">// query &quot;Programming&quot;</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">results</span> = index.<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-string">&quot;Programming&quot;</span>);<br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">result</span> <span class="hljs-keyword">in</span> results &#123;<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, result);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo run<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/imgimage-20240414122848805.png"alt="inverted index è¾“å‡ºç¤ºä¾‹" /><figcaption aria-hidden="true">inverted index è¾“å‡ºç¤ºä¾‹</figcaption></figure><h2 id="ç‰ˆæœ¬å£°æ˜">ç‰ˆæœ¬å£°æ˜</h2><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs toml"><span class="hljs-section">[package]</span><br><span class="hljs-attr">name</span> = <span class="hljs-string">&quot;inverted_index&quot;</span><br><span class="hljs-attr">version</span> = <span class="hljs-string">&quot;0.1.0&quot;</span><br><span class="hljs-attr">edition</span> = <span class="hljs-string">&quot;2021&quot;</span><br><br><span class="hljs-section">[dependencies]</span><br><span class="hljs-attr">colored</span> = <span class="hljs-string">&quot;2.1.0&quot;</span><br><span class="hljs-attr">regex</span> = <span class="hljs-string">&quot;1.10.4&quot;</span><br></code></pre></td></tr></table></figure><h2 id="é¡¹ç›®å‡†å¤‡">é¡¹ç›®å‡†å¤‡</h2><p>é¦–å…ˆæˆ‘ä»¬åˆ›å»ºé¡¹ç›®ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo new inverted_index<br></code></pre></td></tr></table></figure><p>å‡†å¤‡ä¾èµ–ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo add regex<br>cargo add colored<br></code></pre></td></tr></table></figure><ul><li>colored:ç»ˆç«¯é«˜äº®ï¼Œåé¢æˆ‘ä»¬å°†å®ç°æœç´¢è¯çš„é«˜äº®æ˜¾ç¤ºï¼Œä½¿ç»“æœæ›´ç¾è§‚ã€‚</li><li>regex: æ­£åˆ™åº“ï¼Œç”¨äºå®ç°ä¸åŒºåˆ†å¤§å°å†™æ›¿æ¢åŒ¹é…åˆ°çš„æœç´¢è¯ã€‚</li></ul><h2 id="å®ç°è¿‡ç¨‹">å®ç°è¿‡ç¨‹</h2><p>é¦–å…ˆæˆ‘ä»¬å®šä¹‰ä¸¤ä¸ªæ•°æ®ç»“æ„ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Document</span> &#123;<br>    id: <span class="hljs-type">usize</span>,<br>    content: <span class="hljs-type">String</span>,<br>&#125;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">InvertedIndex</span> &#123;<br>    indexes: HashMap&lt;<span class="hljs-type">String</span>, <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">usize</span>&gt;&gt;,<br>    documents: HashMap&lt;<span class="hljs-type">usize</span>, Document&gt;,<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">InvertedIndex</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>() <span class="hljs-punctuation">-&gt;</span> InvertedIndex &#123;<br>        InvertedIndex &#123;<br>            indexes: HashMap::<span class="hljs-title function_ invoke__">new</span>(),<br>            documents: HashMap::<span class="hljs-title function_ invoke__">new</span>(),<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>Document: å°è£…åŸå§‹æ–‡æ¡£</li><li>IndexedIndex: æˆ‘ä»¬å°†æ„å»ºçš„å€’æ’ç´¢å¼•</li></ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬è¦å®ç° 2 ä¸ªè¾…åŠ©å‡½æ•°ï¼Œä¸€ä¸ªæ˜¯<code>tokenize</code>ï¼Œç”¨äºå°†åŸå§‹çš„æ–‡æ¡£ä¿¡æ¯æ‹†åˆ†æˆç‹¬ç«‹çš„è¯ï¼ˆword/termï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯<code>hightlight</code>ï¼Œç”¨äºå°†åŒ¹é…åˆ°çš„æ–‡æœ¬è¿›è¡Œæ›¿æ¢ï¼Œä½¿å…¶åœ¨ä¸­æ–­å¯ä»¥ä»¥<font color="purple">ç´«è‰²</font>è¾“å‡ºã€‚</p><p><code>tokenize</code> å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">tokenize</span>(text: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Vec</span>&lt;&amp;<span class="hljs-type">str</span>&gt; &#123;<br>    text.<span class="hljs-title function_ invoke__">split</span>(|ch: <span class="hljs-type">char</span>| !ch.<span class="hljs-title function_ invoke__">is_alphanumeric</span>())<br>        .<span class="hljs-title function_ invoke__">filter</span>(|c| !c.<span class="hljs-title function_ invoke__">is_empty</span>())<br>        .<span class="hljs-title function_ invoke__">collect</span>()<br>&#125;<br><br><span class="hljs-meta">#[test]</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">tokenize_test</span>() &#123;<br>    <span class="hljs-built_in">assert_eq!</span>(<br>        <span class="hljs-title function_ invoke__">tokenize</span>(<span class="hljs-string">&quot;This is\nhedon&#x27;s tokenize function.&quot;</span>),<br>        <span class="hljs-built_in">vec!</span>[<span class="hljs-string">&quot;This&quot;</span>, <span class="hljs-string">&quot;is&quot;</span>, <span class="hljs-string">&quot;hedon&quot;</span>, <span class="hljs-string">&quot;s&quot;</span>, <span class="hljs-string">&quot;tokenize&quot;</span>, <span class="hljs-string">&quot;function&quot;</span>]<br>    )<br>&#125;<br></code></pre></td></tr></table></figure><p><code>highlight</code> å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">highlight</span>(term: &amp;<span class="hljs-type">str</span>, content: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">regex</span> = Regex::<span class="hljs-title function_ invoke__">new</span>(&amp;<span class="hljs-built_in">format!</span>(<span class="hljs-string">r&quot;(?i)&#123;&#125;&quot;</span>, term)).<span class="hljs-title function_ invoke__">unwrap</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">highlighted_content</span> = regex<br>        .<span class="hljs-title function_ invoke__">replace_all</span>(content, |caps: &amp;regex::Captures| &#123;<br>            caps[<span class="hljs-number">0</span>].<span class="hljs-title function_ invoke__">to_string</span>().<span class="hljs-title function_ invoke__">purple</span>().<span class="hljs-title function_ invoke__">to_string</span>()<br>        &#125;)<br>        .<span class="hljs-title function_ invoke__">to_string</span>();<br>    highlighted_content<br>&#125;<br><br><span class="hljs-meta">#[test]</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">highlight_test</span>() &#123;<br>    <span class="hljs-built_in">assert_eq!</span>(<br>        <span class="hljs-title function_ invoke__">highlight</span>(<span class="hljs-string">&quot;programming&quot;</span>, <span class="hljs-string">&quot;I like programming with Rust Programming&quot;</span>),<br>        <span class="hljs-string">&quot;I like \u&#123;1b&#125;[35mprogramming\u&#123;1b&#125;[0m with Rust \u&#123;1b&#125;[35mProgramming\u&#123;1b&#125;[0m&quot;</span><br>    );<br>&#125;<br></code></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥ä¸º <code>InvertedIndex</code> å®ç°æ„å»ºç´¢å¼•çš„æ–¹æ³•<code>add</code>äº†ï¼Œå®ƒä¼šæ¥æ”¶åŸå§‹æ–‡æ¡£ï¼Œå¯¹å…¶è¿›è¡Œåˆ†è¯ï¼Œå¹¶å°†è®°å½•æ¯ä¸ªåˆ†è¯å’Œæ–‡æ¡£ idçš„æ˜ å°„ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">InvertedIndex</span> &#123;<br>  <span class="hljs-keyword">fn</span> <span class="hljs-title function_">add</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, doc_id: <span class="hljs-type">usize</span>, content: &amp;<span class="hljs-type">str</span>) &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">content_lowercase</span> = content.<span class="hljs-title function_ invoke__">to_lowercase</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">words</span> = <span class="hljs-title function_ invoke__">tokenize</span>(&amp;content_lowercase);<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">word</span> <span class="hljs-keyword">in</span> words &#123;<br>            <span class="hljs-keyword">self</span>.indexes<br>                .<span class="hljs-title function_ invoke__">entry</span>(word.<span class="hljs-title function_ invoke__">to_string</span>())<br>                .<span class="hljs-title function_ invoke__">or_insert</span>(<span class="hljs-built_in">vec!</span>[])<br>                .<span class="hljs-title function_ invoke__">push</span>(doc_id)<br>        &#125;<br><br>        <span class="hljs-keyword">self</span>.documents.<span class="hljs-title function_ invoke__">insert</span>(<br>            doc_id,<br>            Document &#123;<br>                id: doc_id,<br>                content: content.<span class="hljs-title function_ invoke__">to_string</span>(),<br>            &#125;,<br>        );<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬å†å®ç°å¯¹åº”çš„æ ¹æ®åˆ†è¯ <code>term</code>æœç´¢åŸå§‹æ–‡æ¡£çš„æ–¹æ³•ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">InvertedIndex</span> &#123;<br>  <span class="hljs-keyword">fn</span> <span class="hljs-title function_">query</span>(&amp;<span class="hljs-keyword">self</span>, term: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">String</span>&gt; &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">term_lowercase</span> = term.<span class="hljs-title function_ invoke__">to_lowercase</span>();<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(doc_ids) = <span class="hljs-keyword">self</span>.indexes.<span class="hljs-title function_ invoke__">get</span>(&amp;term_lowercase) &#123;<br>            doc_ids<br>                .<span class="hljs-title function_ invoke__">iter</span>()<br>                .<span class="hljs-title function_ invoke__">filter_map</span>(|doc_id| &#123;<br>                    <span class="hljs-keyword">self</span>.documents<br>                        .<span class="hljs-title function_ invoke__">get</span>(doc_id)<br>                        .<span class="hljs-title function_ invoke__">map</span>(|doc| <span class="hljs-title function_ invoke__">highlight</span>(&amp;term_lowercase, &amp;doc.content))<br>                &#125;)<br>                .<span class="hljs-title function_ invoke__">collect</span>()<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">new</span>()<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ ·ä¸€ä¸ªç®€å•çš„å€’æ’ç´¢å¼•æ„å»ºå’Œæœç´¢åŠŸèƒ½å°±å®Œæˆäº†ï¼Œå…·ä½“çš„æ‰§è¡Œæ•ˆæœä½ å¯ä»¥å›åˆ°å‰é¢çš„ã€Œæœ€ç»ˆæ•ˆæœã€è¿›è¡ŒæŸ¥é˜…ã€‚</p><h1 id="æ€»ç»“é¢„å‘Š">æ€»ç»“é¢„å‘Š</h1><p>æœ¬æ–‡å®ç°çš„å€’æ’ç´¢å¼•è™½ç„¶éå¸¸ç®€å•ï¼Œä½†æ˜¯ä¹ŸåŸºæœ¬ä½“ç°äº†å€’æ’ç´¢å¼•çš„æœ€æ ¸å¿ƒæ€æƒ³å’Œåº”ç”¨æ–¹å¼äº†ã€‚åœ¨ã€ŠRustç¨‹åºè®¾è®¡ï¼ˆç¬¬äºŒç‰ˆï¼‰ã€‹çš„å¹¶å‘ç¼–ç¨‹ç¯‡ç« ä¸­ï¼Œè¯¥ä¹¦æå‡ºäº†ä½¿ç”¨é€šé“ channelæ¥å¹¶å‘æ„å»ºå€’æ’ç´¢å¼•ï¼ŒåŒæ—¶ç»™å‡ºäº†æ›´åŠ ä¸°å¯Œå’Œä¼˜é›…çš„å®ç°ã€‚åœ¨ä¸‹ç¯‡æ–‡ç« ä¸­ï¼Œç¬”è€…å°†é˜…è¯»è¿™éƒ¨åˆ†çš„æºç ï¼Œè§£æå¹¶é‡ç°å½“ä¸­çš„å®æˆ˜è¿‡ç¨‹ï¼Œå¹¶è¿›è¡Œé€‚å½“æ‰©å±•ã€‚</p><p>peace! enjoy coding~</p><h1 id="ç»˜å›¾å·¥å…·">ç»˜å›¾å·¥å…·</h1><ul><li>https://excalidraw.com/</li></ul><h1 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h1><ul><li><ahref="https://en.wikipedia.org/wiki/Inverted_index">ç»´åŸºç™¾ç§‘Â·å€’æ’ç´¢å¼•</a></li><li><a href="https://book.douban.com/subject/36547630/">Rustç¨‹åºè®¾è®¡ï¼ˆç¬¬äºŒç‰ˆï¼‰</a></li></ul>]]></content>
    
    
    <summary type="html">æœ¬æ–‡å°†ä½¿ç”¨ Rust å®ç°ä¸€ä¸ªç®€å•çš„å€’æ’ç´¢å¼•ã€‚</summary>
    
    
    
    <category term="Rust" scheme="https://hedon.top/categories/Rust/"/>
    
    <category term="Rust å®æˆ˜" scheme="https://hedon.top/categories/Rust/Rust-%E5%AE%9E%E6%88%98/"/>
    
    
    <category term="Rust" scheme="https://hedon.top/tags/Rust/"/>
    
    <category term="å€’æ’ç´¢å¼•" scheme="https://hedon.top/tags/%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥æµ…å‡º Go è¯­è¨€çš„ defer æœºåˆ¶</title>
    <link href="https://hedon.top/2024/03/28/go-defer/"/>
    <id>https://hedon.top/2024/03/28/go-defer/</id>
    <published>2024-03-28T12:34:50.000Z</published>
    <updated>2024-04-14T15:12:49.119Z</updated>
    
    <content type="html"><![CDATA[<p>Goè¯­è¨€ä»¥å…¶ç®€æ´çš„è¯­æ³•å’Œå¼ºå¤§çš„å¹¶å‘æ”¯æŒè€Œé—»åã€‚åœ¨è¿™äº›ç‰¹æ€§ä¸­ï¼Œ<code>defer</code>è¯­å¥æ˜¯ Goè¯­è¨€æä¾›çš„ä¸€é¡¹ç‹¬ç‰¹åŠŸèƒ½ï¼Œå®ƒå…è®¸æˆ‘ä»¬æ¨è¿Ÿå‡½æ•°çš„æ‰§è¡Œç›´åˆ°åŒ…å«å®ƒçš„å‡½æ•°å³å°†è¿”å›ã€‚è¿™ä¸ªç®€å•è€Œå¼ºå¤§çš„æœºåˆ¶ä¸ä»…å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¤„ç†èµ„æºé‡Šæ”¾å’Œé”™è¯¯å¤„ç†ï¼Œè¿˜èƒ½è®©ä»£ç æ›´åŠ ç®€æ´å’Œå®‰å…¨ã€‚æœ¬æ–‡å°†æ·±å…¥æµ…å‡ºåœ°ä»‹ç»<code>defer</code>çš„å·¥ä½œåŸç†ï¼Œæ¢ç©¶å…¶èƒŒåçš„æœºåˆ¶ï¼Œå¹¶é€šè¿‡ä¸°å¯Œçš„æ¡ˆä¾‹æ¥å±•ç¤ºå®ƒçš„å®é™…åº”ç”¨ã€‚</p><p>ç¬”è€…æœ¬æ¥ä»¥ä¸º Go è¯­è¨€çš„ <code>defer</code>å…¶å®ä¸œè¥¿ä¸å¤šï¼Œå°±æ˜¯ç±»ä¼¼äºâ€œæ ˆâ€çš„æ“ä½œç½¢äº†ï¼Œæ— éå°±æ˜¯ç”¨äºé‡Šæ”¾èµ„æºã€åè¿›å…ˆå‡ºè€Œå·²ã€‚ä½†æ˜¯æœ€è¿‘åœ¨é˜…è¯»å®Œã€Šæ·±å…¥ç†è§£Go è¯­è¨€ã€‹ã€ã€ŠGo åº•å±‚åŸç†å‰–æã€‹å’Œã€ŠGo è¯­è¨€è®¾è®¡ä¸å®ç°ã€‹ä¸­å…³äº<code>defer</code>çš„ç¯‡ç« ã€‚å‘ç°å…¶ä¸­éšå«çš„é“é“å’Œå‘è¿˜æ˜¯æ¯”è¾ƒæœ‰æ„æ€çš„ï¼Œç‰¹æ­¤æ•´ç†è¿™ç¯‡æ–‡ç« ï¼Œå¸Œæœ›èƒ½å¯¹Go <code>defer</code> åŸç†æ„Ÿå…´è¶£çš„è¯»è€…å¸¦æ¥ä¸€äº›å¸®åŠ©ã€‚</p><p>æœ¬æ–‡å…·ä½“ä¼šåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š</p><ul><li><strong><code>defer</code> æœºåˆ¶ç®€ä»‹</strong>ï¼šä»‹ç»<code>defer</code> å…³é”®å­—çš„åŸºæœ¬æ¦‚å¿µå’Œå®ƒåœ¨ Go è¯­è¨€ä¸­çš„ä½œç”¨ã€‚</li><li><strong><code>defer</code> çš„å·¥ä½œåŸç†</strong>ï¼šæ·±å…¥æ¢è®¨<code>defer</code> åœ¨å‡½æ•°æ‰§è¡Œç»“æŸæ—¶å¦‚ä½•å·¥ä½œçš„ç»†èŠ‚ã€‚</li><li><strong><code>defer</code> çš„æ‰§è¡Œé¡ºåº</strong>ï¼šè§£é‡Š<code>defer</code> è¯­å¥æ˜¯å¦‚ä½•æŒ‰ç…§åè¿›å…ˆå‡ºï¼ˆLIFOï¼‰çš„é¡ºåºæ‰§è¡Œçš„ã€‚</li><li><strong>å‚æ•°é¢„è®¡ç®—å’Œå€¼ä¼ é€’</strong>ï¼šè®¨è®º <code>defer</code>è¯­å¥ä¸­å‚æ•°æ˜¯å¦‚ä½•è¢«é¢„å…ˆè®¡ç®—å’Œä¼ é€’çš„ã€‚</li><li><strong>ç¯å¢ƒå˜é‡å’Œé—­åŒ…</strong>ï¼šæ¢è®¨ <code>defer</code>å¦‚ä½•ä¸é—­åŒ…ä¸€èµ·å·¥ä½œï¼Œä»¥åŠå¦‚ä½•æ•è·å’Œå½±å“ç¯å¢ƒå˜é‡ã€‚</li><li><strong><code>defer</code> ä¸é”™è¯¯å¤„ç†</strong>ï¼šè¯´æ˜å¦‚ä½•åˆ©ç”¨<code>defer</code> å’Œ <code>recover</code> è¿›è¡Œé”™è¯¯å¤„ç†å’Œå¼‚å¸¸æ•è·ã€‚</li><li><strong><code>defer</code> çš„å®ç°ç»†èŠ‚</strong>ï¼šæ·±å…¥åˆ†æ<code>defer</code>çš„ä¸åŒå®ç°ç­–ç•¥ï¼ŒåŒ…æ‹¬å †ä¸Šåˆ†é…ã€æ ˆä¸Šåˆ†é…å’Œå¼€æ”¾ç¼–ç ã€‚</li></ul><h1 id="ç‰ˆæœ¬å£°æ˜">ç‰ˆæœ¬å£°æ˜</h1><ul><li>Go1.22</li></ul><h1 id="æ€ç»´å¯¼å›¾">æ€ç»´å¯¼å›¾</h1><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/Go%20defer.png"alt="Go defer" /><figcaption aria-hidden="true">Go defer</figcaption></figure><h1 id="æ ¸å¿ƒè¦ç‚¹">æ ¸å¿ƒè¦ç‚¹</h1><p>å¯¹äºåé¢å°†è¦åˆ†æçš„å„ç§å„æ ·çš„æƒ…å†µï¼Œåœ¨åˆ†æçš„æ—¶å€™åªè¦éµå¾ªä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒç‚¹ï¼ŒåŸºæœ¬ä¸Šå°±ä¸ä¼šè·‘åï¼š</p><ol type="1"><li>å»¶è¿Ÿæ‰§è¡Œï¼šåœ¨å‡½æ•°ç»“æŸæ—¶æ‰§è¡Œï¼ŒåŒ…æ‹¬æ­£å¸¸è¿”å›æˆ–é­é‡ panicã€‚</li><li>æ ˆå¼æ‰§è¡Œé¡ºåºï¼šåå®šä¹‰çš„ <code>defer</code> å…ˆæ‰§è¡Œï¼ˆLIFOï¼‰ã€‚</li><li>å‚æ•°é¢„è®¡ç®—ï¼š<code>defer</code> è¯­å¥å®šä¹‰æ—¶å³è®¡ç®—å¹¶å›ºå®šå‚æ•°å€¼ã€‚</li><li>å€¼ä¼ é€’åŸåˆ™ï¼š<code>defer</code> æ‹·è´å‚æ•°ï¼Œä½¿ç”¨å®šä¹‰æ—¶çš„å€¼ã€‚</li><li>ç¯å¢ƒå˜é‡æ•è·ï¼šåœ¨ <code>defer</code>ä¸­å¯ä»¥è·Ÿä¸€ä¸ªé—­åŒ…ï¼Œé—­åŒ…å¯ä»¥æ•è·ç¯å¢ƒå˜é‡ï¼Œå½“ç„¶è¿™åŒ…æ‹¬å…·åè¿”å›å€¼ã€‚</li></ol><p>ç‰¹åˆ«è¯´æ˜çš„æ˜¯ï¼Œè™½ç„¶æˆ‘ä»¬é€šå¸¸å°† <code>defer</code>æƒ³è±¡ä¸ºä½¿ç”¨æ ˆè¿›è¡Œç®¡ç†ï¼Œä½†æ˜¯å®é™…å®ç°ä¸Šï¼Œ<code>defer</code>å¹¶ä¸éƒ½æ˜¯å­˜æ”¾åœ¨æ ˆä¸Šçš„ï¼Œæˆ‘ä»¬åé¢ä¼šå…·ä½“åˆ†æåˆ°ã€‚è¿™ç§å®ç°ç»†èŠ‚é€šå¸¸å¯¹äºç¼–å†™æ­£ç¡®çš„Goä»£ç å¹¶ä¸é‡è¦ï¼Œä½†äº†è§£è¿™ä¸€ç‚¹å¯¹äºæ·±å…¥ç†è§£è¯­è¨€å†…éƒ¨æœºåˆ¶å¯èƒ½æ˜¯æœ‰å¸®åŠ©çš„ã€‚</p><h1 id="åŸºæœ¬ç”¨æ³•">åŸºæœ¬ç”¨æ³•</h1><p>åœ¨ Go è¯­è¨€ä¸­ï¼Œ<code>defer</code>è¯­å¥é€šå¸¸ç”¨äºç¡®ä¿ä¸€ä¸ªå‡½æ•°è°ƒç”¨åœ¨ç¨‹åºæ‰§è¡Œç»“æŸæ—¶å‘ç”Ÿï¼Œå¸¸è§çš„ç”¨ä¾‹åŒ…æ‹¬æ–‡ä»¶å…³é—­ã€é”é‡Šæ”¾ã€èµ„æºå›æ”¶ç­‰ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">readFile</span><span class="hljs-params">(filename <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">error</span> &#123;<br>    f, err := os.Open(filename)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> err<br>    &#125;<br>    <span class="hljs-comment">// ç¡®ä¿æ–‡ä»¶åœ¨å‡½æ•°è¿”å›æ—¶å…³é—­</span><br>    <span class="hljs-keyword">defer</span> f.Close()<br><br>    <span class="hljs-comment">// ... å¤„ç†æ–‡ä»¶ ...</span><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ<code>defer f.Close()</code> ä¿è¯äº†æ— è®º<code>readFile</code>å‡½æ•°å¦‚ä½•è¿”å›ï¼ˆæ­£å¸¸è¿”å›æˆ–å‘ç”Ÿé”™è¯¯ï¼‰ï¼Œ<code>f.Close()</code>éƒ½ä¼šè¢«è°ƒç”¨ï¼Œä»è€Œé¿å…äº†èµ„æºæ³„éœ²ã€‚</p><h1 id="æ‰§è¡Œé¡ºåº">æ‰§è¡Œé¡ºåº</h1><p><code>defer</code>çš„æ‰§è¡Œé¡ºåºæ˜¯å…ˆè¿›åå‡ºï¼Œå³â€œæ ˆâ€æ“ä½œã€‚è¿™é‡Œå€Ÿç”¨åˆ˜ä¸¹å†°è€å¸ˆçš„ä¸€å¼ å›¾æ¥æ¼”ç¤ºè¿™ä¸ªè¿‡ç¨‹ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/1651037338287-fd17c81d-a1ad-4bc7-ae7e-eec8a264af5f.jpeg"alt="Go defer æ‰§è¡Œé¡ºåº" /><figcaption aria-hidden="true">Go defer æ‰§è¡Œé¡ºåº</figcaption></figure><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹ä»£ç è¿›è¡ŒéªŒè¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">func1</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;func1...&quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">func2</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;func2...&quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">func3</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;func3...&quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> func1()<br><span class="hljs-keyword">defer</span> func2()<br><span class="hljs-keyword">defer</span> func3()<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-function"><span class="hljs-title">func3</span></span>...<br><span class="hljs-function"><span class="hljs-title">func2</span></span>...<br><span class="hljs-function"><span class="hljs-title">func1</span></span>...<br></code></pre></td></tr></table></figure><h1 id="å‚æ•°æ±‚å€¼ä¸é™·é˜±">å‚æ•°æ±‚å€¼ä¸é™·é˜±</h1><p>å…³äº <code>defer</code>å‚æ•°è¿™ä¸€å—ï¼Œæ˜¯ä¸€ä¸ªæ¯”è¾ƒå®¹æ˜“å‡ºé”™çš„åœ°æ–¹ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼Œä½ å¯ä»¥åˆ†æä¸‹å®ƒçš„è¾“å‡ºä¼šæ˜¯ä»€ä¹ˆï¼Ÿ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">printI</span><span class="hljs-params">(i <span class="hljs-type">int</span>)</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;printI i:&quot;</span>, i)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>i := <span class="hljs-number">10</span><br><span class="hljs-keyword">defer</span> printI(i * <span class="hljs-number">10</span>)<br>i = i + <span class="hljs-number">1</span><br>fmt.Println(<span class="hljs-string">&quot;main i:&quot;</span>, i)<br>&#125;<br></code></pre></td></tr></table></figure><p>æŒ‰ç…§æˆ‘ä»¬ä¹‹å‰æ€»ç»“çš„æ ¸å¿ƒç‚¹ï¼š<strong>å‚æ•°é¢„è®¡ç®—ï¼š<code>defer</code>è¯­å¥å®šä¹‰æ—¶å³è®¡ç®—å¹¶å›ºå®šå‚æ•°å€¼</strong>ã€‚å…·ä½“æ¥è¯´ï¼Œåœ¨æŠŠ <code>defer</code>å‹å…¥â€œæ ˆâ€æ—¶ï¼Œä¼šåŒæ—¶å‹å…¥<strong>å‡½æ•°åœ°å€</strong>å’Œ<strong>å‡½æ•°å½¢å‚</strong>ï¼Œä¹Ÿå°±æ˜¯ä¼šåœ¨è¿™ä¸ªæ—¶å€™å°±æŠŠå‚æ•°å…ˆç®—å¥½ã€‚æ‰€ä»¥åœ¨æ‰§è¡Œåˆ°ç¬¬7 è¡Œä»£ç çš„æ—¶å€™ï¼Œå°±ä¼šæŠŠ <code>i*10</code> ç®—å¥½ï¼Œç„¶ååŒ<code>printI</code> ä¸€åŒå‹å…¥åˆ°å»¶è¿Ÿæ‰§è¡Œæ ˆä¸­ã€‚</p><p>æ‰€ä»¥æœ€åçš„ç»“æœå°±æ˜¯ï¼š</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-selector-tag">main</span> <span class="hljs-selector-tag">i</span>: <span class="hljs-number">11</span><br><span class="hljs-selector-tag">printI</span> <span class="hljs-selector-tag">i</span>: <span class="hljs-number">100</span><br></code></pre></td></tr></table></figure><p>å…³äº<strong>å‚æ•°å€¼ä¼ é€’</strong>ï¼Œç¬”è€…è¿™é‡Œå†ä¸¾ä¸¤ä¸ªä¾‹å­è¿›è¡Œæ¯”è¾ƒï¼Œä½“ä¼šåä½ åº”è¯¥å°±ç†è§£äº†ã€‚</p><p>ç¬¬ä¸€ä¸ªä¾‹å­ä¸­ï¼Œ<code>defer</code>åé¢å‚æ•°æ˜¯æŒ‡é’ˆï¼Œæœ¬è´¨ä¸Š<strong>å€¼ä¼ é€’</strong>ï¼Œä½†æ˜¯æ‹·è´çš„æ˜¯æŒ‡é’ˆï¼Œæ‰€ä»¥åœ¨<code>defer</code> ä¸­ä¿®æ”¹çš„ä¸œè¥¿ï¼Œæœ€åä¼šåé¦ˆåˆ°æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡ï¼Œæ‰€ä»¥å¯¹<code>testUser</code> çš„è¿”å›å€¼æ˜¯æœ‰å½±å“çš„ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span>&#123;<br>name <span class="hljs-type">string</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">testUser</span><span class="hljs-params">()</span></span> *User &#123;<br>user := &amp;User&#123;&#125;<br>user.name = <span class="hljs-string">&quot;name-1&quot;</span><br><br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(u *User)</span></span> &#123;<br>u.name = <span class="hljs-string">&quot;name-defer&quot;</span><br>&#125;(user)<br><br>user.name = <span class="hljs-string">&quot;name-2&quot;</span><br><span class="hljs-keyword">return</span> user<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>user := testUser()<br>fmt.Println(user)<br>&#125;<br><span class="hljs-comment">// &amp;&#123;name-defer&#125;</span><br></code></pre></td></tr></table></figure><p>ç¬¬äºŒä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä¼ å…¥çš„å°±æ˜¯ç»“æ„ä½“ç¤ºä¾‹æœ¬èº«äº†ï¼Œå› ä¸ºå€¼ä¼ é€’ï¼Œå³æ‹·è´äº†ä¸€ä»½æ–°çš„<code>user</code>ï¼Œæ‰€ä»¥é—­åŒ…å†…çš„ä¿®æ”¹å¯¹å¤–é¢æ˜¯ä¸äº§ç”Ÿå½±å“çš„ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> &#123;<br>name <span class="hljs-type">string</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">testUser</span><span class="hljs-params">()</span></span> User &#123;<br>user := User&#123;&#125;<br>user.name = <span class="hljs-string">&quot;name-1&quot;</span><br><br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(u User)</span></span> &#123;<br>u.name = <span class="hljs-string">&quot;name-defer&quot;</span><br>&#125;(user)<br><br>user.name = <span class="hljs-string">&quot;name-2&quot;</span><br><span class="hljs-keyword">return</span> user<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>user := testUser()<br>fmt.Println(user)<br>&#125;<br><span class="hljs-comment">// &#123;name-2&#125;</span><br></code></pre></td></tr></table></figure><h1 id="ç¯å¢ƒå˜é‡æ•è·">ç¯å¢ƒå˜é‡æ•è·</h1><p>å°†ä¸Šé¢çš„ä¸€ä¸ªä¾‹å­è¿›è¡Œç®€å•ä¿®æ”¹ï¼Œä¼šè¾“å‡ºä»€ä¹ˆå‘¢ï¼Ÿ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">printI</span><span class="hljs-params">(i <span class="hljs-type">int</span>)</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;printI i:&quot;</span>, i)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>i := <span class="hljs-number">10</span><br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>printI(i * <span class="hljs-number">10</span>)<br>&#125;()<br>i = i + <span class="hljs-number">1</span><br>fmt.Println(<span class="hljs-string">&quot;main i:&quot;</span>, i)<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™å…¶å®æ²¡æœ‰å‚æ•°ï¼Œæ‰€ä»¥ä¼šç›´æ¥å°†ä¸‹é¢é—­åŒ…å‹å…¥å»¶è¿Ÿæ ˆä¸­ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>  printI(i * <span class="hljs-number">10</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>è€Œé—­åŒ…æ˜¯å¯ä»¥æ•è·ç¯å¢ƒå˜é‡çš„ï¼Œæ‰€ä»¥åœ¨ <code>main</code> returnåï¼Œ<code>defer</code> å¯ä»¥æ•è·åˆ° <code>i</code> çš„å€¼ï¼Œä¸ºæ›´æ–°åçš„<code>i+1</code>ï¼Œæœ€åå†è¿›è¡Œ <code>printI(i * 10)</code>ã€‚</p><p>æ‰€ä»¥è¾“å‡ºç»“æœæ˜¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">main i: <span class="hljs-number">11</span><br>printI i: <span class="hljs-number">110</span><br></code></pre></td></tr></table></figure><p>æ‰€ä»¥è¯´ï¼Œ<code>defer</code>åé¢çš„é—­åŒ…ï¼Œæ˜¯å¯ä»¥æ•è·ç¯å¢ƒå˜é‡çš„ï¼Œå¦‚æœè¿™ä¸ªå˜é‡æ˜¯è¿”å›å€¼çš„è¯ï¼Œé‚£ä¹ˆç†æ‰€åº”å½“ä¹Ÿæ˜¯å¯ä»¥å¯¹å…¶äº§ç”Ÿä½œç”¨çš„ï¼Œå¦‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getI</span><span class="hljs-params">()</span></span> (i <span class="hljs-type">int</span>) &#123;<br>i = <span class="hljs-number">1</span><br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>i *= <span class="hljs-number">10</span><br>&#125;()<br><span class="hljs-keyword">return</span> <span class="hljs-number">20</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(getI())<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ä¸­ï¼Œ<code>getI</code> çš„è¿”å›å€¼æ˜¯æœ‰åå­—çš„<code>i</code>ï¼Œ<code>getI</code> æ‰§è¡Œäº†<code>return 20</code>ï¼Œå…¶å®å°±æ˜¯å°† <code>i</code> è®¾ç½®ä¸º<code>20</code>ï¼Œæ‰€ä»¥åœ¨æ‰§è¡Œåˆ° <code>defer</code> é—­åŒ…çš„æ—¶å€™ï¼Œæ•è·åˆ°äº†<code>i=20</code>ï¼Œå¹¶å°†å…¶è¿›è¡Œäº†ä¿®æ”¹ã€‚æ‰€ä»¥æœ€ç»ˆè¾“å‡ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-number">200</span><br></code></pre></td></tr></table></figure><h1 id="é”™è¯¯å¤„ç†ä¸-defer">é”™è¯¯å¤„ç†ä¸ defer</h1><p>æˆ‘ä»¬éƒ½çŸ¥é“ Go ç¨‹åºä¸­é‡åˆ° <code>panic</code>å°±ä¼šä¸­æ–­åé¢çš„æ‰§è¡Œæµç¨‹ç›´æ¥è¿”å›ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥åœ¨ <code>defer</code>ä¸­ç»“åˆ <code>recover</code> æ¥æ•è·è¿™ä¸ª<code>panic</code>ï¼Œä»è€Œä¿æŠ¤ç¨‹åºä¸å´©æºƒã€‚</p><p>å¦‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">panicAndRecover</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> err := <span class="hljs-built_in">recover</span>(); err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(err)<br>&#125;<br>&#125;()<br>fmt.Println(<span class="hljs-string">&quot;å‡½æ•°ä¸­æ­£å¸¸æµç¨‹&quot;</span>)<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;å‡ºç°å¼‚å¸¸&quot;</span>)<br>fmt.Println(<span class="hljs-string">&quot;panic åçš„è¯­å¥æ°¸è¿œæ‰§è¡Œä¸åˆ°&quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>panicAndRecover()<br>fmt.Println(<span class="hljs-string">&quot;æ­£å¸¸å›åˆ° main&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// å‡½æ•°ä¸­æ­£å¸¸æµç¨‹</span><br><span class="hljs-comment">// å‡ºç°å¼‚å¸¸</span><br><span class="hljs-comment">// æ­£å¸¸å›åˆ° main</span><br></code></pre></td></tr></table></figure><p>æ›´è¿›ä¸€æ­¥ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ <code>defer</code> ä¸­ä¹Ÿæœ‰ <code>panic</code>å‘¢ï¼Ÿè¯·æ€è€ƒä¸‹åˆ—ä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">panicAndRecover</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;ç¬¬ 1 ä¸ªå…¥æ ˆçš„ defer&quot;</span>)<br><span class="hljs-keyword">if</span> err := <span class="hljs-built_in">recover</span>(); err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;æœ€ç»ˆæ•è·çš„ panic:&quot;</span>, err)<br>&#125;<br>&#125;()<br><br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;ç¬¬ 2 ä¸ªå…¥æ ˆçš„ defer&quot;</span>)<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;ç¬¬ 2 ä¸ªå…¥æ ˆçš„ defer å‘ç”Ÿ panic&quot;</span>)<br>&#125;()<br><br>fmt.Println(<span class="hljs-string">&quot;panicAndRecover å‡½æ•°ä¸­æ­£å¸¸æµç¨‹&quot;</span>)<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;panicAndRecover å‡ºç°å¼‚å¸¸&quot;</span>)<br>fmt.Println(<span class="hljs-string">&quot;panic åçš„è¯­å¥æ°¸è¿œæ‰§è¡Œä¸åˆ°&quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>panicAndRecover()<br>fmt.Println(<span class="hljs-string">&quot;æ­£å¸¸å›åˆ° main&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬åœ¨ <code>panicAndRecover</code> å¼ºè¡ŒæŠ›å‡º<code>panic</code>ï¼Œç”±äº <code>defer</code> å…ˆè¿›åå‡ºï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šå…ˆæ‰§è¡Œç¬¬2 ä¸ª <code>defer</code>ï¼Œå…¶ä¸­ä¹Ÿå‘ç”Ÿäº† <code>panic</code>ï¼Œæˆ‘ä»¬åœ¨ç¬¬ 1 ä¸ª<code>defer</code> ä¸­å¯¹ <code>panic</code> è¿›è¡Œ<code>recover</code>ï¼Œæœ€ç»ˆçš„ç°è±¡æ˜¯åªæ•è·åˆ°äº†åé¢æŠ›å‡ºçš„<code>panic</code>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go">panicAndRecover å‡½æ•°ä¸­æ­£å¸¸æµç¨‹<br>ç¬¬ <span class="hljs-number">2</span> ä¸ªå…¥æ ˆçš„ <span class="hljs-keyword">defer</span><br>ç¬¬ <span class="hljs-number">1</span> ä¸ªå…¥æ ˆçš„ <span class="hljs-keyword">defer</span><br>æœ€ç»ˆæ•è·çš„ <span class="hljs-built_in">panic</span>: ç¬¬ <span class="hljs-number">2</span> ä¸ªå…¥æ ˆçš„ <span class="hljs-keyword">defer</span> å‘ç”Ÿ <span class="hljs-built_in">panic</span><br>æ­£å¸¸å›åˆ° main<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p>åœ¨ Go è¯­è¨€ä¸­ï¼Œ<code>panic</code> å‡½æ•°å®é™…ä¸Šæ˜¯åˆ›å»ºäº†ä¸€ä¸ª<code>panic</code> å¯¹è±¡ï¼Œå¹¶æŠ›å‡ºè¿™ä¸ªå¯¹è±¡ã€‚</p><p>å½“ä¸€ä¸ª <code>panic</code> å‘ç”Ÿå¹¶å¼€å§‹å‘ä¸Šä¼ æ’­æ—¶ï¼ŒGo è¿è¡Œæ—¶ä¼šæ£€æŸ¥æ¯ä¸ª<code>defer</code>ã€‚å¦‚æœ <code>defer</code> ä¸­åŒ…å« <code>recover</code>è°ƒç”¨ï¼Œå¹¶ä¸”å®ƒè¢«æ‰§è¡Œï¼Œé‚£ä¹ˆ <code>recover</code> ä¼šæ•è·å½“å‰çš„<code>panic</code>ï¼Œå¹¶ä¸”é˜²æ­¢å®ƒç»§ç»­å‘ä¸Šä¼ æ’­ã€‚å¦‚æœ <code>defer</code>ä¸­å†æ¬¡å‘ç”Ÿ <code>panic</code>ï¼Œé‚£ä¹ˆåŸæ¥çš„ <code>panic</code> å°±ä¸ä¼šè¢«<code>recover</code> æ•è·ï¼Œå› ä¸º <code>defer</code>å‡½æ•°å·²ç»é€€å‡ºäº†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ–°çš„ <code>panic</code>ä¼šå¯¼è‡´ç¨‹åºå´©æºƒï¼Œå› ä¸ºæ²¡æœ‰æ›´å¤šçš„ <code>defer</code> å‡½æ•°å»<code>recover</code> è¿™ä¸ªæ–°çš„ <code>panic</code>ã€‚</p><p>è¿™è¯´æ˜äº† Go ç¨‹åºä¸­ä¸å…è®¸åŒæ—¶æœ‰å¤šä¸ªæ´»è·ƒçš„ <code>panic</code>å­˜åœ¨ï¼Œè¿™ä¸ªè®¾è®¡ç¡®ä¿äº†åœ¨ä»»ä½•ç»™å®šçš„æ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ª <code>panic</code>èƒ½å¤Ÿè¢«å¤„ç†ã€‚è¿™æ ·åšæœ‰å‡ ä¸ªåŸå› ï¼š</p><ol type="1"><li><strong>ç®€åŒ–é”™è¯¯å¤„ç†ï¼š</strong> å¦‚æœåŒæ—¶å­˜åœ¨å¤šä¸ª<code>panic</code>ï¼Œå°±ä¼šå˜å¾—éå¸¸å¤æ‚å»ç¡®å®šå¦‚ä½•å¤„ç†å®ƒä»¬ï¼Œå°¤å…¶æ˜¯åœ¨å®ƒä»¬ä¹‹é—´å­˜åœ¨ä¾èµ–å…³ç³»çš„æ—¶å€™ã€‚ä¸€ä¸ª<code>panic</code>åº”è¯¥è¡¨ç¤ºä¸€ä¸ªä¸å¯æ¢å¤çš„é”™è¯¯ï¼Œå¦‚æœæœ‰å¤šä¸ªè¿™æ ·çš„é”™è¯¯åŒæ—¶å­˜åœ¨ï¼Œç¨‹åºçš„çŠ¶æ€å¯èƒ½ä¼šå˜å¾—éå¸¸ä¸ç¡®å®šã€‚</li><li><strong>ä¿æŒä¸€è‡´æ€§ï¼š</strong> <code>panic</code>é€šå¸¸è¡¨ç¤ºç¨‹åºä¸­å‡ºç°äº†ä¸¥é‡é”™è¯¯ï¼Œå¯èƒ½ä¼šç ´åç¨‹åºçš„ä¸€è‡´æ€§æˆ–å®‰å…¨æ€§ã€‚å¦‚æœå…è®¸å¤šä¸ª<code>panic</code> åŒæ—¶å­˜åœ¨ï¼Œå°±å¾ˆéš¾ä¿è¯ç¨‹åºçŠ¶æ€çš„ä¸€è‡´æ€§ï¼Œå› ä¸ºä¸åŒçš„<code>panic</code> å¯èƒ½éœ€è¦å›é€€ä¸åŒçš„æ“ä½œã€‚</li><li><strong>é¿å…èµ„æºæ³„æ¼ï¼š</strong> <code>defer</code>è¯­å¥ç”¨äºç¡®ä¿èµ„æºè¢«é‡Šæ”¾ï¼Œä¾‹å¦‚æ–‡ä»¶å’Œé”ã€‚å¦‚æœåœ¨å¤„ç†ä¸€ä¸ª <code>panic</code>çš„è¿‡ç¨‹ä¸­ï¼Œåˆå‘ç”Ÿäº†å¦ä¸€ä¸ª <code>panic</code>ï¼Œå¯èƒ½ä¼šå¯¼è‡´<code>defer</code> è¯­å¥ä¸­å‰©ä½™çš„æ¸…ç†ä»£ç æ— æ³•æ‰§è¡Œï¼Œä»è€Œå¼•èµ·èµ„æºæ³„æ¼ã€‚</li><li><strong>æ§åˆ¶æµç¨‹æ¸…æ™°ï¼š</strong> <code>panic</code> å’Œ<code>recover</code> çš„è®¾è®¡ä½¿å¾—é”™è¯¯çš„æ§åˆ¶æµç¨‹æ¸…æ™°ä¸”å¯é¢„æµ‹ã€‚ä¸€æ—¦ä¸€ä¸ª<code>panic</code> è¢« <code>recover</code>æ•è·ï¼Œç¨‹åºå¯ä»¥é€‰æ‹©æ˜¯å¦ç»§ç»­æ‰§è¡Œï¼Œæˆ–è€…æ˜¯é€šè¿‡é‡æ–° <code>panic</code>æ¥ç»ˆæ­¢ç¨‹åºã€‚è¿™ç§å†³ç­–è¿‡ç¨‹åœ¨å¤šä¸ª <code>panic</code>æƒ…å†µä¸‹ä¼šå˜å¾—å¤æ‚ä¸”éš¾ä»¥ç®¡ç†ã€‚</li></ol><p>å› æ­¤ï¼Œåœ¨ Go çš„è®¾è®¡ä¸­ï¼Œä¸å…è®¸åŒæ—¶å­˜åœ¨å¤šä¸ªæ´»è·ƒçš„<code>panic</code>ã€‚ä¸€æ—¦å‘ç”Ÿ <code>panic</code>ï¼Œå®ƒå¿…é¡»è¢«<code>recover</code>å¤„ç†ï¼Œå¦åˆ™ç¨‹åºå°†ä¼šç»ˆæ­¢ã€‚è¿™ç¡®ä¿äº†é”™è¯¯å¤„ç†çš„æ¸…æ™°æ€§å’Œç¨‹åºçš„ç¨³å®šæ€§ã€‚</p><h1 id="defer-æ”¾åœ¨å“ª">defer æ”¾åœ¨å“ª</h1><p><code>defer</code> å®é™…ä¸Šä¸ä¸€å®šæ˜¯æ”¾åœ¨æ ˆä¸Šçš„ï¼Œæˆªæ­¢Go1.22ï¼Œ<code>defer</code> å…¶å®ç”¨ 3 ç§åˆ†é…ç­–ç•¥ï¼š</p><ul><li>å †ä¸Šåˆ†é…</li><li>æ ˆä¸Šåˆ†é…</li><li>å¼€æ”¾ç¼–ç </li></ul><h2 id="æ‰§è¡Œæœºåˆ¶">æ‰§è¡Œæœºåˆ¶</h2><p>åœ¨ <ahref="https://github.com/golang/go/blob/release-branch.go1.22/src/cmd/compile/internal/ssagen/ssa.go">ssa.go</a>æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ° <code>state.stmt()</code>ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯è´Ÿè´£åœ¨ Goç¨‹åºç¼–è¯‘è¿‡ç¨‹ä¸­ä¸­é—´ä»£ç ç”Ÿæˆé˜¶æ®µæ—¶å¯¹ä¸åŒè¯­å¥çš„å¤„ç†è¿‡ç¨‹ï¼Œå…¶ä¸­å¯¹äº<code>ODEFER</code> å³ <code>defer</code> è¯­å¥çš„å¤„ç†é€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// stmt converts the statement n to SSA and adds it to s.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *state)</span></span> stmt(n ir.Node) &#123;<br>s.stmtList(n.Init())<br><span class="hljs-keyword">switch</span> n.Op() &#123;<br><span class="hljs-keyword">case</span> ir.ODEFER:<br>      n := n.(*ir.GoDeferStmt)<br>      <span class="hljs-keyword">if</span> base.Debug.Defer &gt; <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">var</span> defertype <span class="hljs-type">string</span><br>        <span class="hljs-keyword">if</span> s.hasOpenDefers &#123;<br>          defertype = <span class="hljs-string">&quot;open-coded&quot;</span><br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> n.Esc() == ir.EscNever &#123;<br>          defertype = <span class="hljs-string">&quot;stack-allocated&quot;</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          defertype = <span class="hljs-string">&quot;heap-allocated&quot;</span><br>        &#125;<br>        base.WarnfAt(n.Pos(), <span class="hljs-string">&quot;%s defer&quot;</span>, defertype)<br>      &#125;<br>...<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œæ€»å…±æœ‰ 3 ç§åˆ†é…ç­–ç•¥ï¼š</p><ul><li><strong>open-coded</strong>: s.hasOpenDefers == true</li><li><strong>stack-allocated</strong>: n.Esc() == ir.EscNever</li><li><strong>heap-allocated</strong>: é»˜è®¤</li></ul><p>é»˜è®¤æ˜¯å †åˆ†é…ï¼Œåœ¨ Go1.13ä»¥å‰ï¼Œä¹Ÿåªæœ‰å †åˆ†é…è¿™ä¸€ç§ç­–ç•¥ï¼Œä¸è¿‡è¯¥å®ç°çš„æ€§èƒ½è¾ƒå·®ã€‚Go è¯­è¨€åœ¨ 1.13ä¸­å¼•å…¥æ ˆä¸Šåˆ†é…çš„ç»“æ„ä½“ï¼Œ<ahref="https://go-review.googlesource.com/c/go/+/171758">å‡å°‘äº† 30%çš„é¢å¤–å¼€é”€</a>ï¼Œå¹¶åœ¨ 1.14 ä¸­å¼•å…¥äº†åŸºäºå¼€æ”¾ç¼–ç çš„<code>defer</code>ï¼Œä½¿å¾—è¯¥å…³é”®å­—çš„é¢å¤–å¼€é”€<ahref="https://go-review.googlesource.com/c/go/+/190098/6">å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡</a>ã€‚</p><p>æœ¬æ–‡ä¸­ä¸å¯¹å…·ä½“çš„åˆ†é…æœºåˆ¶è¿›è¡Œåˆ†æï¼Œè¿™ä¸€å—ä¼šæ¯”è¾ƒå¤æ‚ï¼Œç¬”è€…æœ¬èº«ä¹Ÿä¸æ˜¯å¾ˆæ„Ÿå…´è¶£ï¼Œä¾¿å†³å®šå¯¹æ­¤ä¸è¿‡åˆ†æ·±ç©¶ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…æ¨èè¯¦ç»†é˜…è¯»ã€ŠGoè¯­è¨€è®¾è®¡ä¸å®ç°ã€‹ä¸­å…³äº <code>defer</code>å…³é”®å­—çš„åˆ†æï¼šhttps://draveness.me/golang/docs/part2-foundation/ch05-keyword/golang-defer/ã€‚</p><p>æœ¬æ–‡åªè®¨è®ºä»€ä¹ˆæƒ…å†µä¸‹ä¼šä½¿ç”¨ä»€ä¹ˆåˆ†é…ç­–ç•¥ã€‚ç”±äºå †åˆ†é…æ˜¯é»˜è®¤çš„ï¼Œæˆ‘ä»¬å°±ä¸ä½œåˆ†æäº†ï¼Œå…·ä½“æ¥çœ‹çœ‹<code>s.hasOpenDefers == true</code> å’Œ<code>n.Esc() == ir.EscNever</code> ä»€ä¹ˆæ—¶å€™ä¼šæˆç«‹ã€‚</p><h2 id="æ ˆä¸Šåˆ†é…">æ ˆä¸Šåˆ†é…</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹æ ˆä¸Šåˆ†é…ï¼Œè¦æ»¡è¶³æ ˆä¸Šåˆ†é…ï¼Œåˆ™éœ€è¦æ»¡è¶³<code>n.Esc() == ir.EscNever</code>ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">const</span> (<br>EscUnknown = <span class="hljs-literal">iota</span><br>EscNone    <span class="hljs-comment">// Does not escape to heap, result, or parameters.</span><br>EscHeap    <span class="hljs-comment">// Reachable from the heap</span><br>EscNever   <span class="hljs-comment">// By construction will not escape.</span><br>)<br></code></pre></td></tr></table></figure><p>å½“ <code>n</code> çš„é€ƒé€¸åˆ†æç»“æœæ˜¯ <code>ir.EscNever</code>ï¼Œåˆ™è¡¨æ˜è¯¥<code>defer</code>è¯­å¥ä»ä¸é€ƒé€¸ï¼ˆä¸ä¼šåœ¨å‡½æ•°è°ƒç”¨ç»“æŸåä»ç„¶è¢«å¼•ç”¨ï¼‰ï¼Œè¿™ç§æƒ…å†µä¸‹<code>defer</code> å°†è¢«åˆ†é…åˆ°æ ˆä¸Šï¼ˆstack-allocatedï¼‰ã€‚å¦åˆ™ï¼Œå¦‚æœ<code>defer</code> é€ƒé€¸äº†ï¼Œå°±ä¼šè¢«åˆ†é…åˆ°å †ä¸Šï¼ˆheap-allocatedï¼‰ã€‚</p><p>é‚£ <code>defer</code> è¯­å¥ä»€ä¹ˆæ—¶å€™ä¼šé€ƒé€¸å‘¢ï¼Ÿ</p><blockquote><p>åœ¨ Goä¸­ï¼Œä¸€ä¸ªå˜é‡çš„é€ƒé€¸æ„å‘³ç€å®ƒçš„ç”Ÿå‘½å‘¨æœŸè¶…å‡ºäº†å½“å‰å‡½æ•°çš„èŒƒå›´ã€‚åœ¨å‡½æ•°å†…å®šä¹‰çš„å˜é‡é€šå¸¸åˆ†é…åœ¨æ ˆä¸Šï¼Œè€Œåœ¨å †ä¸Šåˆ†é…å†…å­˜éœ€è¦æ›´å¤æ‚çš„ç®¡ç†ã€‚åœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨å¯èƒ½ä¼šé€‰æ‹©å°†å˜é‡åˆ†é…åœ¨å †ä¸Šï¼Œè¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬ç§°ä¹‹ä¸ºé€ƒé€¸ã€‚</p></blockquote><p>å¯¹äº <code>defer</code> è¯­å¥ï¼Œå¦‚æœå®ƒå¼•ç”¨äº†å‡½æ•°å¤–çš„å˜é‡ï¼Œè¿™ä¸ª<code>defer</code> å°±ä¼šé€ƒé€¸ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> x = <span class="hljs-number">10</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">someFunction</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        fmt.Println(x) <span class="hljs-comment">// è¿™é‡Œå¼•ç”¨äº†å¤–éƒ¨å˜é‡ x</span><br>    &#125;()<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>defer</code> å‡½æ•°å†…éƒ¨å¼•ç”¨äº† <code>x</code>è¿™ä¸ªå¤–éƒ¨å˜é‡ï¼Œå› æ­¤ <code>defer</code> è¯­å¥éœ€è¦ç¡®ä¿ <code>x</code> åœ¨<code>defer</code> å‡½æ•°æ‰§è¡Œæ—¶ä»ç„¶æœ‰æ•ˆã€‚ä¸ºäº†æ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼Œç¼–è¯‘å™¨å¯èƒ½ä¼šå°†<code>x</code> åˆ†é…åœ¨å †ä¸Šï¼Œè€Œä¸æ˜¯æ ˆä¸Šã€‚</p><h2 id="å¼€æ”¾ç¼–ç ">å¼€æ”¾ç¼–ç </h2><p>å…ˆç»™ç»“è®ºï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œè¦ä½¿ç”¨å¼€æ”¾ç¼–ç ç­–ç•¥ï¼Œä½ åªéœ€è¦å…³æ³¨ä»¥ä¸‹ 4ç‚¹å³å¯ï¼š</p><ol type="1"><li>å‡½æ•°çš„ <code>defer</code> æ•°é‡ä¸èƒ½è¶…è¿‡ 8 ä¸ªï¼›</li><li>å‡½æ•°çš„ <code>defer</code> å…³é”®å­—ä¸èƒ½åœ¨å¾ªç¯ä¸­æ‰§è¡Œï¼›</li><li>å‡½æ•°çš„ <code>defer</code> ä¸­ä¸èƒ½å‘ç”Ÿé€ƒé€¸ï¼›</li><li>å‡½æ•°çš„ <code>return</code> è¯­å¥ä¸ <code>defer</code>è¯­å¥çš„ä¹˜ç§¯å°äºæˆ–è€…ç­‰äº 15 ä¸ªï¼›</li></ol><hr /><p>Okï¼Œä¸‹é¢æ˜¯å…·ä½“çš„åˆ†æè¿‡ç¨‹ã€‚</p><p>å€ŸåŠ© Goland çš„èƒ½åŠ›ï¼Œå°†é¼ æ ‡å…‰æ ‡æ”¾åœ¨ <code>s.hasOpenDefers</code>ä¸Šï¼ŒæŒ‰ä½ <strong>Command</strong>åŠ ç‚¹å‡»é¼ æ ‡ï¼Œå¯ä»¥çœ‹åˆ°è¯¥å±æ€§çš„ä½¿ç”¨æƒ…å†µï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/imgimage-20240328133312845-20240328202233278.png"alt="s.hasOpenDefers" /><figcaption aria-hidden="true">s.hasOpenDefers</figcaption></figure><p>å¯ä»¥çœ‹åˆ°è¯¥å±æ€§çš„åˆ¤æ–­é€»è¾‘éƒ½åœ¨ <ahref="https://github.com/golang/go/blob/release-branch.go1.22/src/cmd/compile/internal/ssagen/ssa.go">ssa.go</a>æ–‡ä»¶ä¸­çš„ <code>buildssa()</code>å‡½æ•°ä¸­ã€‚å»æ‰ä¸€äº›æ— å…³çš„ä»£ç ï¼Œæ ¸å¿ƒé€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// buildssa builds an SSA function for fn.</span><br><span class="hljs-comment">// worker indicates which of the backend workers is doing the processing.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">buildssa</span><span class="hljs-params">(fn *ir.Func, worker <span class="hljs-type">int</span>)</span></span> *ssa.Func &#123;<br>...<br>  <span class="hljs-comment">// â‘ </span><br>s.hasOpenDefers = base.Flag.N == <span class="hljs-number">0</span> &amp;&amp; s.hasdefer &amp;&amp; !s.curfn.OpenCodedDeferDisallowed()<br><span class="hljs-keyword">switch</span> &#123;<br>  <span class="hljs-comment">// â‘¡</span><br><span class="hljs-keyword">case</span> base.Debug.NoOpenDefer != <span class="hljs-number">0</span>:<br>s.hasOpenDefers = <span class="hljs-literal">false</span><br><span class="hljs-keyword">case</span> s.hasOpenDefers &amp;&amp; (base.Ctxt.Flag_shared || base.Ctxt.Flag_dynlink) &amp;&amp; base.Ctxt.Arch.Name == <span class="hljs-string">&quot;386&quot;</span>:<br>    <span class="hljs-comment">// â‘¢</span><br><span class="hljs-comment">// Don&#x27;t support open-coded defers for 386 ONLY when using shared</span><br><span class="hljs-comment">// libraries, because there is extra code (added by rewriteToUseGot())</span><br><span class="hljs-comment">// preceding the deferreturn/ret code that we don&#x27;t track correctly.</span><br>s.hasOpenDefers = <span class="hljs-literal">false</span><br>&#125;<br>  <span class="hljs-comment">// â‘£</span><br><span class="hljs-keyword">if</span> s.hasOpenDefers &amp;&amp; <span class="hljs-built_in">len</span>(s.curfn.Exit) &gt; <span class="hljs-number">0</span> &#123;<br><span class="hljs-comment">// Skip doing open defers if there is any extra exit code (likely</span><br><span class="hljs-comment">// race detection), since we will not generate that code in the</span><br><span class="hljs-comment">// case of the extra deferreturn/ret segment.</span><br>s.hasOpenDefers = <span class="hljs-literal">false</span><br>&#125;<br>  <span class="hljs-comment">// â‘¤</span><br><span class="hljs-keyword">if</span> s.hasOpenDefers &#123;<br><span class="hljs-comment">// Similarly, skip if there are any heap-allocated result</span><br><span class="hljs-comment">// parameters that need to be copied back to their stack slots.</span><br><span class="hljs-keyword">for</span> _, f := <span class="hljs-keyword">range</span> s.curfn.Type().Results().FieldSlice() &#123;<br><span class="hljs-keyword">if</span> !f.Nname.(*ir.Name).OnStack() &#123;<br>s.hasOpenDefers = <span class="hljs-literal">false</span><br><span class="hljs-keyword">break</span><br>&#125;<br>&#125;<br>&#125;<br>  <span class="hljs-comment">// â‘¥</span><br><span class="hljs-keyword">if</span> s.hasOpenDefers &amp;&amp;<br>s.curfn.NumReturns*s.curfn.NumDefers &gt; <span class="hljs-number">15</span> &#123;<br><span class="hljs-comment">// Since we are generating defer calls at every exit for</span><br><span class="hljs-comment">// open-coded defers, skip doing open-coded defers if there are</span><br><span class="hljs-comment">// too many returns (especially if there are multiple defers).</span><br><span class="hljs-comment">// Open-coded defers are most important for improving performance</span><br><span class="hljs-comment">// for smaller functions (which don&#x27;t have many returns).</span><br>s.hasOpenDefers = <span class="hljs-literal">false</span><br>&#125;<br>  ...<br><span class="hljs-keyword">return</span> s.f<br>&#125;<br><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ€»å…±æœ‰ 6ä¸ªæ¡ä»¶ï¼Œæˆ‘å·²åœ¨æ³¨é‡Šä¸­è¿›è¡Œæ ‡æ³¨ï¼Œæˆ‘ä»¬æ¥è¿›è¡Œé€ä¸€åˆ†æï¼š</p><h3 id="base.flag.n-0-s.hasdefer-s.curfn.opencodeddeferdisallowed">â‘ base.Flag.N == 0 &amp;&amp; s.hasdefer &amp;&amp;!s.curfn.OpenCodedDeferDisallowed()</h3><blockquote><p>å¦‚æœ<code>base.Flag.N</code> ç­‰äº 0ä¸”å½“å‰å‡½æ•°æœ‰å»¶è¿Ÿè°ƒç”¨ä¸”æ²¡æœ‰ç¦æ­¢å¼€æ”¾å¼å»¶è¿Ÿï¼Œé‚£ä¹ˆè®¾ç½®<code>s.hasOpenDefers</code>ä¸º<code>true</code>ã€‚</p></blockquote><p>åœ¨ Goç¼–è¯‘å™¨ä¸­ï¼Œ<code>-N</code>æ ‡å¿—é€šå¸¸ç”¨äºç¦ç”¨ä¼˜åŒ–ã€‚åœ¨è¿™æ®µä»£ç ä¸­ï¼Œå¦‚æœ<code>base.Flag.N</code>ç­‰äº0ï¼Œæ„å‘³ç€æ²¡æœ‰ç¦ç”¨ä¼˜åŒ–ï¼Œå› æ­¤ç¼–è¯‘å™¨å¯èƒ½ä¼šå°è¯•ä½¿ç”¨æ›´é«˜çº§çš„ä¼˜åŒ–æŠ€æœ¯ï¼Œæ¯”å¦‚å¼€æ”¾å¼å»¶è¿Ÿï¼ˆopen-codeddefersï¼‰ã€‚</p><p><code>OpenCodedDeferDisallowed()</code>å³ç¦ç”¨å¼€æ”¾ç¼–ç ï¼Œå®ƒçš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">const</span> funcOpenCodedDeferDisallowed <span class="hljs-comment">// can&#x27;t do open-coded defers</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f *Func)</span></span> OpenCodedDeferDisallowed() <span class="hljs-type">bool</span> &#123; <span class="hljs-keyword">return</span> f.flags&amp;funcOpenCodedDeferDisallowed != <span class="hljs-number">0</span> &#125;<br></code></pre></td></tr></table></figure><p>æŒ‰ä½ Command åç‚¹å‡» <code>funcOpenCodedDeferDisallowed</code>å¯ä»¥çœ‹åˆ°åªæœ‰ <code>funcOpenCodedDeferDisallowed(b)</code>å¯ä»¥ä¿®æ”¹å®ƒçš„å€¼ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/imgimage-20240328140733594.png"alt="funcOpenCodedDeferDisallowed" /><figcaption aria-hidden="true">funcOpenCodedDeferDisallowed</figcaption></figure><p>æˆ‘ä»¬æ¥çœ‹çœ‹å“ªä¸ªåœ°æ–¹ä¼šè°ƒç”¨<code>funcOpenCodedDeferDisallowed()</code>ï¼Œå¹¶å°†<code>funcOpenCodedDeferDisallowed</code> è®¾ç½®ä¸º <code>true</code>ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/imgimage-20240328140859879.png"alt="å°† funcOpenCodedDeferDisallowed è®¾ç½®ä¸º true çš„åœ°æ–¹" /><figcaption aria-hidden="true">å°† funcOpenCodedDeferDisallowed è®¾ç½®ä¸ºtrue çš„åœ°æ–¹</figcaption></figure><p>è°ƒç”¨å®ƒçš„åœ°æ–¹åœ¨ <ahref="https://github.com/golang/go/blob/release-branch.go1.22/src/cmd/compile/internal/walk/stmt.go">stmt.go</a>æ–‡ä»¶ä¸­çš„ <code>walkStmt()</code> å‡½æ•°ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// The max number of defers in a function using open-coded defers. We enforce this</span><br><span class="hljs-comment">// limit because the deferBits bitmask is currently a single byte (to minimize code size)</span><br><span class="hljs-keyword">const</span> maxOpenDefers = <span class="hljs-number">8</span><br><br><span class="hljs-comment">// The result of walkStmt MUST be assigned back to n, e.g.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//n.Left = walkStmt(n.Left)</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">walkStmt</span><span class="hljs-params">(n ir.Node)</span></span> ir.Node &#123;<br>  ...<br><span class="hljs-keyword">switch</span> n.Op() &#123;<br>    ...<br>    <span class="hljs-keyword">case</span> ir.ODEFER:<br>      n := n.(*ir.GoDeferStmt)<br>      ir.CurFunc.SetHasDefer(<span class="hljs-literal">true</span>)<br>      ir.CurFunc.NumDefers++<br>      <span class="hljs-keyword">if</span> ir.CurFunc.NumDefers &gt; maxOpenDefers &#123;<br>        <span class="hljs-comment">// Don&#x27;t allow open-coded defers if there are more than</span><br>        <span class="hljs-comment">// 8 defers in the function, since we use a single</span><br>        <span class="hljs-comment">// byte to record active defers.</span><br>        ir.CurFunc.SetOpenCodedDeferDisallowed(<span class="hljs-literal">true</span>)<br>      &#125;<br>      <span class="hljs-keyword">if</span> n.Esc() != ir.EscNever &#123;<br>        <span class="hljs-comment">// If n.Esc is not EscNever, then this defer occurs in a loop,</span><br>        <span class="hljs-comment">// so open-coded defers cannot be used in this function.</span><br>        ir.CurFunc.SetOpenCodedDeferDisallowed(<span class="hljs-literal">true</span>)<br>      &#125;<br>      <span class="hljs-keyword">fallthrough</span><br>    ...<br>  &#125;<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€ç‚¹æ˜¯ï¼šå½“å‰å‡½æ•°ä¸­ <code>defer</code> ä¸ªæ•°è¶…è¿‡ 8çš„è¯ï¼Œåˆ™ç¦ç”¨å¼€æ”¾ç¼–ç ã€‚</p><p>ç¬¬äºŒç‚¹æ˜¯å½“ <code>n.Esc() != ir.EscNever</code>ä½¿ï¼Œå°±ç¦ç”¨å¼€æ”¾ç¼–ç ã€‚è¿™ä¸ªè¦æ±‚è·Ÿå‰é¢åˆ†æçš„â€œæ ˆä¸Šåˆ†é…â€è¦æ±‚æ˜¯ä¸€æ ·çš„ã€‚</p><p>è¿™é‡Œå†è¡¥å……ä¸€ç‚¹ï¼šä»€ä¹ˆæ—¶å€™ <code>n.Esc()</code> ä¼šè¢«è®¾ç½®ä¸º<code>ir.EscNever</code> å‘¢ï¼Ÿ</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/imgimage-20240328192005520.png"alt="n.SetEsc(ir.EscNever)" /><figcaption aria-hidden="true">n.SetEsc(ir.EscNever)</figcaption></figure><p>è¿™é‡Œé¢æ ¸å¿ƒç‚¹æ˜¯ç¬¬ä¸€ä¸ªï¼Œå®ƒå¯¹åº”çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *escape)</span></span> goDeferStmt(n *ir.GoDeferStmt) &#123;<br>k := e.heapHole()<br><span class="hljs-keyword">if</span> n.Op() == ir.ODEFER &amp;&amp; e.loopDepth == <span class="hljs-number">1</span> &#123;<br>...<br>n.SetEsc(ir.EscNever)<br>&#125;<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><p><code>e.loopDepth == 1</code> æ—¶å°±è®¾ç½®ï¼Œæ¢è¨€ä¹‹ï¼Œ<code>defer</code>ä¸åœ¨å¾ªç¯ä¸­çš„æ—¶å€™ï¼Œæ‰å…è®¸å¼€æ”¾ç¼–ç ã€‚</p><p>æ€»è€Œè¨€ä¹‹ï¼Œç¬¬ â‘  ä¸ªæ¡ä»¶çº¦æŸäº†è¦é‡‡ç”¨<code>open-coded å¼€æ”¾ç¼–ç </code>ç­–ç•¥çš„ 3 ä¸ªæ¡ä»¶ï¼š</p><ol type="1"><li>å‡½æ•°ä¸­ <code>defer</code> ä¸ªæ•°ä¸èƒ½è¶…è¿‡ <strong>8</strong>ï¼›</li><li><code>defer</code> ä¸èƒ½åœ¨å¾ªç¯ä¸­ï¼›</li><li><code>defer</code> ä¸èƒ½å‘ç”Ÿé€ƒé€¸ã€‚</li></ol><h3 id="base.debug.noopendefer-0">â‘¡ base.Debug.NoOpenDefer != 0</h3><blockquote><p>å¦‚æœ<code>base.Debug.NoOpenDefer</code>ä¸ä¸º0ï¼Œé‚£ä¹ˆç¦ç”¨å¼€æ”¾å¼å»¶è¿Ÿã€‚</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">NoOpenDefer           <span class="hljs-type">int</span>    <span class="hljs-string">`help:&quot;disable open-coded defers&quot; concurrent:&quot;ok&quot;`</span><br></code></pre></td></tr></table></figure><h3id="base.ctxt.flag_shared-base.ctxt.flag_dynlink-base.ctxt.arch.name-386">â‘¢(base.Ctxt.Flag_shared || base.Ctxt.Flag_dynlink) &amp;&amp;base.Ctxt.Arch.Name == "386"</h3><blockquote><p>å¦‚æœå½“å‰æ¶æ„æ˜¯<code>386</code>ï¼Œå¹¶ä¸”ä½¿ç”¨å…±äº«åº“æˆ–åŠ¨æ€é“¾æ¥ï¼Œé‚£ä¹ˆä¸æ”¯æŒå¼€æ”¾å¼å»¶è¿Ÿï¼Œå› ä¸ºå­˜åœ¨ä¸€äº›é¢å¤–çš„ä»£ç ï¼ˆç”±<code>rewriteToUseGot()</code>æ·»åŠ ï¼‰å¯èƒ½æ— æ³•æ­£ç¡®è¿½è¸ªã€‚</p></blockquote><h3 id="lens.curfn.exit">â‘£ len(s.curfn.Exit)</h3><blockquote><p>å¦‚æœå­˜åœ¨ä»»ä½•é¢å¤–çš„é€€å‡ºä»£ç ï¼ˆæ¯”å¦‚å¯èƒ½æ˜¯ç«æ€æ£€æµ‹ç›¸å…³çš„ä»£ç ï¼‰ï¼Œåˆ™è·³è¿‡å¼€æ”¾å¼å»¶è¿Ÿã€‚</p></blockquote><h3 id="f.nname.ir.name.onstack">â‘¤ !f.Nname.(*ir.Name).OnStack()</h3><blockquote><p>å¦‚æœæœ‰ä»»ä½•å †åˆ†é…çš„ç»“æœå‚æ•°éœ€è¦å¤åˆ¶å›å®ƒä»¬çš„æ ˆæ§½ï¼Œä¹Ÿè·³è¿‡å¼€æ”¾å¼å»¶è¿Ÿã€‚</p></blockquote><h3 id="s.curfn.numreturnss.curfn.numdefers-15">â‘¥s.curfn.NumReturns*s.curfn.NumDefers &gt; 15</h3><blockquote><p>å¦‚æœå‡½æ•°çš„è¿”å›æ•°ä¹˜ä»¥å»¶è¿Ÿè°ƒç”¨æ•°å¤§äº<strong>15</strong>ï¼Œè€ƒè™‘åˆ°æ¯ä¸ªé€€å‡ºç‚¹éƒ½è¦ç”Ÿæˆå»¶è¿Ÿè°ƒç”¨ï¼Œå¹¶ä¸”å¼€æ”¾å¼å»¶è¿Ÿå¯¹äºå°å‡½æ•°ï¼ˆæ²¡æœ‰å¤šä¸ªè¿”å›ï¼‰çš„æ€§èƒ½æå‡æœ€ä¸ºé‡è¦ï¼Œæ‰€ä»¥åœ¨è¿™ç§æƒ…å†µä¸‹ä¹Ÿä¸ä½¿ç”¨å¼€æ”¾å¼å»¶è¿Ÿã€‚</p></blockquote><h2 id="å †ä¸Šåˆ†é…">å †ä¸Šåˆ†é…</h2><p>å½“ä¸æ»¡è¶³å¼€æ”¾ç¼–ç å’Œæ ˆä¸Šåˆ†é…çš„æ—¶å€™ï¼Œé»˜è®¤å°±æ˜¯å †ä¸Šåˆ†é…ï¼ˆheap-allocatedï¼‰ï¼Œæ€§èƒ½æœ€å·®ï¼Œè¿™é‡Œä¸åšåˆ†æã€‚</p><hr /><p>ä»¥ä¸Šå°±æ˜¯æœ¬æ–‡å…³äº Go è¯­è¨€ä¸­ <code>defer</code> å…³é”®å­—çš„å…·ä½“åˆ†æï¼ŒHappyCoding! Peace~</p><h1 id="å‚è€ƒ">å‚è€ƒ</h1><ul><li><a href="https://book.douban.com/subject/36403287/">æ·±å…¥ç†è§£ Goè¯­è¨€</a></li><li><a href="https://book.douban.com/subject/35556889/">Goè¯­è¨€åº•å±‚åŸç†å‰–æ</a></li><li><ahref="https://draveness.me/golang/docs/part2-foundation/ch05-keyword/golang-defer/">Goè¯­è¨€è®¾è®¡ä¸å®ç°</a></li><li>ChatGPT4</li></ul>]]></content>
    
    
    <summary type="html">æœ¬æ–‡å°†æ·±å…¥æµ…å‡ºåœ°ä»‹ç» defer çš„å·¥ä½œåŸç†ï¼Œæ¢ç©¶å…¶èƒŒåçš„æœºåˆ¶ï¼Œå¹¶é€šè¿‡ä¸°å¯Œçš„æ¡ˆä¾‹æ¥å±•ç¤ºå®ƒçš„å®é™…åº”ç”¨ã€‚</summary>
    
    
    
    <category term="Go" scheme="https://hedon.top/categories/Go/"/>
    
    
    <category term="Go" scheme="https://hedon.top/tags/Go/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥ Go è¯­è¨€æ ¸å¿ƒï¼šç»“æ„ä½“çš„å…¨æ–¹ä½è§£æ</title>
    <link href="https://hedon.top/2024/03/09/go-struct/"/>
    <id>https://hedon.top/2024/03/09/go-struct/</id>
    <published>2024-03-09T08:59:34.000Z</published>
    <updated>2024-03-10T09:20:22.895Z</updated>
    
    <content type="html"><![CDATA[<p>Goè¯­è¨€ï¼Œä½œä¸ºä¸€ç§é«˜æ•ˆã€é™æ€ç±»å‹çš„ç¼–ç¨‹è¯­è¨€ï¼Œè‡ªå…¶é—®ä¸–ä»¥æ¥ä¾¿ä»¥å…¶å¹¶å‘å¤„ç†èƒ½åŠ›å’Œç®€æ´çš„è¯­æ³•ç»“æ„å¹¿å—å¼€å‘è€…æ¬¢è¿ã€‚è™½ç„¶Goä¸æ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„é¢å‘å¯¹è±¡è¯­è¨€ï¼Œå®ƒå´ä»¥ç‹¬ç‰¹çš„æ–¹å¼æ”¯æŒé¢å‘å¯¹è±¡ç¼–ç¨‹çš„æ ¸å¿ƒæ¦‚å¿µï¼Œå…¶ä¸­ç»“æ„ä½“æ‰®æ¼”äº†éå¸¸å…³é”®çš„è§’è‰²ã€‚</p><p>ç»“æ„ä½“åœ¨ Goè¯­è¨€ä¸­æ˜¯ä¸€ç§å¤åˆæ•°æ®ç±»å‹ï¼Œå…è®¸æˆ‘ä»¬å°†ä¸åŒç±»å‹çš„æ•°æ®èšåˆåˆ°ä¸€èµ·ã€‚å®ƒä¸ä»…æé«˜äº†æ•°æ®ç®¡ç†çš„æ•ˆç‡å’Œé€»è¾‘æ¸…æ™°åº¦ï¼Œè¿˜æ˜¯Goè¯­è¨€ä¸­å®ç°é¢å‘å¯¹è±¡ç¼–ç¨‹æ€æƒ³å¦‚å°è£…ã€ç»„åˆç­‰æ¦‚å¿µçš„åŸºçŸ³ã€‚äº†è§£å’ŒæŒæ¡ç»“æ„ä½“çš„ä½¿ç”¨ï¼Œå¯¹äºæ·±å…¥ç†è§£Go è¯­è¨€çš„ç‰¹æ€§å’Œç¼–å†™é«˜æ•ˆã€å¯ç»´æŠ¤çš„ Go ä»£ç è‡³å…³é‡è¦ã€‚</p><p>æœ¬æ–‡å°†å¸¦æ‚¨å…¨é¢æ·±å…¥åœ°æ¢ç´¢ Goè¯­è¨€ä¸­ç»“æ„ä½“çš„å„ä¸ªæ–¹é¢ï¼Œä»åŸºæœ¬å®šä¹‰ã€åˆå§‹åŒ–å’Œä½¿ç”¨ï¼Œåˆ°é«˜çº§ç‰¹æ€§å¦‚ç»“æ„ä½“çš„ç»„åˆã€æ–¹æ³•å®šä¹‰ã€å†…å­˜å¯¹é½ç­‰ï¼Œæ¯ä¸€ä¸ªç»†èŠ‚éƒ½å°†ä¸€ä¸€å±•å¼€ã€‚æ— è®ºæ‚¨æ˜¯Goè¯­è¨€çš„æ–°æ‰‹ï¼Œè¿˜æ˜¯æœ‰ä¸€å®šç»éªŒçš„å¼€å‘è€…ï¼Œç›¸ä¿¡æœ¬æ–‡éƒ½èƒ½ä¸ºæ‚¨æä¾›æœ‰ä»·å€¼çš„è§è§£å’Œå¸®åŠ©ã€‚è®©æˆ‘ä»¬ä¸€èµ·æ¢ç´¢Goç»“æ„ä½“çš„å¥¥ç§˜ï¼Œæ­å¼€å…¶èƒŒåçš„åŸç†ï¼Œä¼˜åŒ–æˆ‘ä»¬çš„ä»£ç ç»“æ„ï¼Œæå‡ç¼–ç¨‹æ•ˆç‡ã€‚</p><h1 id="ç‰ˆæœ¬å£°æ˜">ç‰ˆæœ¬å£°æ˜</h1><ul><li>Go 1.22.1</li><li>gopkg.in/yaml.v3 v3.0.1</li><li>os: m2max</li></ul><h1 id="å…¨æ–‡æ¦‚è§ˆ">å…¨æ–‡æ¦‚è§ˆ</h1><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%20Go%20%E8%AF%AD%E8%A8%80%E7%BB%93%E6%9E%84%E4%BD%93%20(1).png"alt="Go è¯­è¨€ç»“æ„ä½“" /><figcaption aria-hidden="true">Go è¯­è¨€ç»“æ„ä½“</figcaption></figure><h1 id="ç»“æ„ä½“çš„åŸºæœ¬ä½¿ç”¨">1. ç»“æ„ä½“çš„åŸºæœ¬ä½¿ç”¨</h1><h2 id="å®šä¹‰ç»“æ„ä½“">1.1 å®šä¹‰ç»“æ„ä½“</h2><p>ç»“æ„ä½“ç±»å‹çš„å®šä¹‰å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> T <span class="hljs-keyword">struct</span> &#123;<br>  Field T1,<br>  Field T2,<br>  ....<br>  FieldN Tn,<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¯”å¦‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;<br>  Name <span class="hljs-type">string</span><br>  Age <span class="hljs-type">int</span><br>  ExtraInfo <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»“æ„ä½“å†…éƒ¨ï¼Œä¹Ÿå¯ä»¥å†…åµŒ<strong>åŒ¿åç»“æ„ä½“</strong>ï¼Œå¦‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;<br>Name <span class="hljs-type">string</span><br>  Age <span class="hljs-type">int</span><br>  School <span class="hljs-keyword">struct</span> &#123;<br>    Name <span class="hljs-type">string</span><br>    Address <span class="hljs-type">string</span><br>    Phone <span class="hljs-type">string</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ä½†æ˜¯ï¼æ³¨æ„ï¼Œå¦‚æœ Person ä¸­åŒ…å«äº† Person å‘¢ï¼Ÿ</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;<br>person  Person<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä¼šæŠ¥é”™ï¼šä¸å…è®¸å¼•ç”¨è‡ªèº«ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./main.go:5:6: invalid recursive <span class="hljs-built_in">type</span>: Person refers to itself<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯å› ä¸º Goè¯­è¨€åœ¨ç¼–è¯‘æ—¶éœ€è¦çŸ¥é“æ¯ä¸ªç±»å‹çš„ç¡®åˆ‡å¤§å°ï¼Œä»¥ä¾¿æ­£ç¡®åœ°åˆ†é…å†…å­˜ã€‚ä½†åœ¨è¿™ä¸ªå®šä¹‰ä¸­ï¼Œå› ä¸º<code>Person</code> åŒ…å«è‡ªèº«ï¼Œç¼–è¯‘å™¨æ— æ³•ç¡®å®š <code>Person</code>çš„å¤§å°ï¼Œå› æ­¤ä¼šæŠ¥é”™ã€‚</p><p>å¦‚æœä½ éœ€è¦åœ¨ä¸€ä¸ªç»“æ„ä½“ä¸­å¼•ç”¨ç›¸åŒç±»å‹çš„æ•°æ®ï¼Œä½ åº”è¯¥ä½¿ç”¨æŒ‡é’ˆã€‚æŒ‡é’ˆçš„å¤§å°æ˜¯å›ºå®šçš„ï¼Œå› æ­¤ç¼–è¯‘å™¨å¯ä»¥ç¡®å®šç»“æ„ä½“çš„å¤§å°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;<br>  person *Person<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="åˆå§‹åŒ–ç»“æ„ä½“">1.2 åˆå§‹åŒ–ç»“æ„ä½“</h2><p>å‡è®¾æˆ‘ä»¬æœ‰ä»¥ä¸‹ç»“æ„ä½“ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;<br>Name      <span class="hljs-type">string</span><br>Age       <span class="hljs-type">int</span><br>ExtraInfo <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥æœ‰ä»¥ä¸‹å‡ ç§åˆå§‹åŒ–ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// é€ä¸ªå­—æ®µèµ‹å€¼ï¼Œé¡ºåºä¸é‡è¦ï¼Œä¹Ÿå¯ä»¥åªèµ‹å€¼éƒ¨åˆ†å­—æ®µ</span><br>person1 := Person&#123;<br>  Age:       <span class="hljs-number">18</span>,<br>  Name:      <span class="hljs-string">&quot;hedon&quot;</span>,<br>  ExtraInfo: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;),<br>&#125;<br>fmt.Println(person1) <span class="hljs-comment">// &#123;hedon 18 map[]&#125;</span><br><br><span class="hljs-comment">// å¯ä»¥ä¸æŒ‡å®šå­—æ®µï¼Œä¸¥æ ¼æŒ‰ç…§é¡ºåº</span><br>person2 := Person&#123;<span class="hljs-string">&quot;hedon2&quot;</span>, <span class="hljs-number">19</span>, <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;)&#125;<br>fmt.Println(person2) <span class="hljs-comment">// &#123;hedon2 19 map[]&#125;</span><br><br><span class="hljs-comment">// é»˜è®¤åˆå§‹åŒ–ï¼Œåˆ™ç»“æ„ä½“ä¸­çš„æ¯ä¸ªå­—æ®µéƒ½ä¼šè¢«é»˜è®¤èµ‹äºˆå…¶å¯¹åº”ç±»å‹çš„â€œé›¶å€¼â€</span><br><span class="hljs-keyword">var</span> person3 Person<br>fmt.Println(person3)                  <span class="hljs-comment">// &#123; 0 map[]&#125;</span><br>fmt.Println(person3.ExtraInfo == <span class="hljs-literal">nil</span>) <span class="hljs-comment">// true</span><br><br><span class="hljs-comment">// ä¹Ÿå¯ä»¥ä½¿ç”¨ new() æˆ– &amp; æ¥åˆå§‹åŒ–å¹¶è¿”å›æŒ‡é’ˆ</span><br>person3 := <span class="hljs-built_in">new</span>(Person)<br>fmt.Println(person3)  <span class="hljs-comment">// &amp;&#123; 0 map[]&#125;</span><br></code></pre></td></tr></table></figure><h2 id="ç©ºç»“æ„ä½“">1.3 ç©ºç»“æ„ä½“</h2><p>æœ‰ä¸€ç§ç‰¹æ®Šçš„ç»“æ„ä½“ï¼Œå®ƒä¸€ä¸ªå­—æ®µéƒ½æ²¡æœ‰ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œç©ºç»“æ„ä½“â€ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Empty <span class="hljs-keyword">struct</span>&#123;&#125;<br></code></pre></td></tr></table></figure><p>ç©ºç»“æ„ä½“éå¸¸ç‰¹æ®Šï¼Œå®ƒä¸å æ®ä»»ä½•ç©ºé—´ï¼ä½ å¯ä»¥è‡ªå·±éªŒè¯ä¸€ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Empty <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  fmt.Println(<span class="hljs-string">&quot;the size of empty:&quot;</span>, unsafe.Sizeof(Empty&#123;&#125;)) <span class="hljs-comment">// the size of empty: 0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è€Œä¸”ï¼Œæ‰€æœ‰ç©ºç»“æ„ä½“çš„åœ°å€éƒ½ä¸€æ ·ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Empty <span class="hljs-keyword">struct</span>&#123;&#125;<br><span class="hljs-keyword">type</span> Empty1 <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>e := Empty&#123;&#125;<br>e1 := Empty1&#123;&#125;<br>fmt.Printf(<span class="hljs-string">&quot;the address of empty: %p\n&quot;</span>, &amp;e) <span class="hljs-comment">// the address of empty: 0x10460f520</span><br>fmt.Printf(<span class="hljs-string">&quot;the address of empty1: %p\n&quot;</span>, &amp;e1)  <span class="hljs-comment">// the address of empty1: 0x10460f520</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯å› ä¸º Go è¯­è¨€ä¸ºæ‰€æœ‰å¤§å°ä¸º 0 çš„å˜é‡éƒ½æŒ‡å‘äº†åŒä¸€ä¸ªå€¼ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// base address for all 0-byte allocations</span><br><span class="hljs-keyword">var</span> zerobase <span class="hljs-type">uintptr</span><br></code></pre></td></tr></table></figure><p>å¥½å¤„å°±æ˜¯å‡å°‘äº†å†…å­˜çš„æµªè´¹ã€‚å…¸å‹çš„ç”¨æ³•å°±æ˜¯æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ map æ¥å®ç°Setï¼Œè¿™æ ·å°±åªèŠ±è´¹äº†å­˜å‚¨é”®çš„ç©ºé—´ï¼Œè€Œå€¼ä¸å ç”¨ä»»ä½•ç©ºé—´ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Set = <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">struct</span>&#123;&#125;<br></code></pre></td></tr></table></figure><h2 id="è®¿é—®å’Œä¿®æ”¹ç»“æ„ä½“">1.4 è®¿é—®å’Œä¿®æ”¹ç»“æ„ä½“</h2><ul><li>ç»“æ„ä½“å±æ€§çš„å¯è§æ€§è·Ÿ GoåŒ…çš„å¯è§æ€§è§„åˆ™ä¸€æ ·ï¼šå¤§å†™å¯¹åŒ…å¤–å¯è§ï¼Œå°å†™ä»…åŒ…å†…å¯è§ã€‚</li><li>ä½¿ç”¨ <code>.</code> è®¿é—®å’Œä¿®æ”¹ç»“æ„ä½“ä¸­çš„å±æ€§ã€‚</li><li>Goè¯­è¨€ä¸­åªæœ‰â€œ<strong>å€¼ä¼ é€’</strong>â€ï¼Œæ‰€ä»¥å¦‚æœä½ è¦å°†ç»“æ„ä½“ç¤ºä¾‹ä¼ å…¥ä¸€ä¸ªfunc è¿›è¡Œä¿®æ”¹ï¼Œåˆ™éœ€è¦ä¼ å…¥å…¶å¼•ç”¨ã€‚</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;<br>Name <span class="hljs-type">string</span><br>Age  <span class="hljs-type">int</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>p := Person&#123;Name: <span class="hljs-string">&quot;hedon&quot;</span>, Age: <span class="hljs-number">18</span>&#125;<br>UpdatePersonName(p)<br>fmt.Println(<span class="hljs-string">&quot;1:&quot;</span>, p)<br>UpdatePersonNameWithRef(&amp;p)<br>fmt.Println(<span class="hljs-string">&quot;2:&quot;</span>, p)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">UpdatePersonName</span><span class="hljs-params">(p Person)</span></span> &#123;<br>p.Name = <span class="hljs-string">&quot;hedon-1&quot;</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">UpdatePersonNameWithRef</span><span class="hljs-params">(p *Person)</span></span> &#123;<br>p.Name = <span class="hljs-string">&quot;hedon-2&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">1: &#123;hedon 18&#125;<br>2: &#123;hedon-2 18&#125;<br></code></pre></td></tr></table></figure><h1 id="ç»“æ„ä½“çš„é«˜çº§ç‰¹æ€§">2. ç»“æ„ä½“çš„é«˜çº§ç‰¹æ€§</h1><h2 id="ç»“æ„ä½“ç»„åˆ">2.1 ç»“æ„ä½“ç»„åˆ</h2><p>åœ¨ Goè¯­è¨€ä¸­ï¼Œå€¡å¯¼çš„æ˜¯â€œç»„åˆä¼˜äºç»§æ‰¿â€çš„å“²å­¦ï¼Œå³å€¡å¯¼ä½¿ç”¨ç»„åˆè€Œä¸æ˜¯ç»§æ‰¿æ¥å®ç°ä»£ç çš„å¤ç”¨ã€‚è¯¥ç†å¿µé¼“åŠ±å¼€å‘è€…é€šè¿‡ç»„åˆå’Œæ¥å£æ¥æ„å»ºçµæ´»ã€å¯ç»´æŠ¤çš„ä»£ç ï¼Œè€Œä¸æ˜¯ä¾èµ–äºæ›´ä¸¥æ ¼ã€æ›´æ˜“å‡ºé”™çš„ç»§æ‰¿å…³ç³»ã€‚è¿™ç§æ–¹å¼ä¿ƒè¿›äº†ä»£ç çš„è§£è€¦ï¼Œå¢å¼ºäº†ä»£ç çš„çµæ´»æ€§å’Œå¯é‡ç”¨æ€§ï¼ŒåŒæ—¶ä¹Ÿä½¿å¾—ä»£ç æ›´åŠ æ¸…æ™°å’Œæ˜“äºç†è§£ã€‚</p><p>åœ¨ Goä¸­ï¼Œç»„åˆæ˜¯é€šè¿‡å°†ä¸€ä¸ªæˆ–å¤šä¸ªç±»å‹ï¼ˆé€šå¸¸æ˜¯ç»“æ„ä½“ï¼‰åµŒå…¥åˆ°å¦ä¸€ä¸ªç»“æ„ä½“ä¸­æ¥å®ç°çš„ã€‚è¿™ä½¿å¾—åµŒå…¥çš„ç±»å‹çš„æ–¹æ³•è¢«â€œæå‡â€åˆ°åŒ…å«å®ƒçš„ç»“æ„ä½“ä¸­ï¼Œå…è®¸ä½ è°ƒç”¨è¿™äº›æ–¹æ³•å°±åƒå®ƒä»¬æ˜¯å¤–éƒ¨ç»“æ„ä½“çš„ä¸€éƒ¨åˆ†ä¸€æ ·ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Engine <span class="hljs-keyword">struct</span> &#123;<br>    Power <span class="hljs-type">int</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *Engine)</span></span> Start() &#123;<br>    <span class="hljs-comment">// å¯åŠ¨å¼•æ“çš„é€»è¾‘</span><br>&#125;<br><br><span class="hljs-keyword">type</span> Car <span class="hljs-keyword">struct</span> &#123;<br>    Engine <span class="hljs-comment">// é€šè¿‡ç»„åˆçš„æ–¹å¼åµŒå…¥ Engine</span><br>&#125;<br><br><span class="hljs-comment">// ç°åœ¨ Car å¯ä»¥ç›´æ¥è°ƒç”¨ Start æ–¹æ³•</span><br>car := Car&#123;Engine&#123;Power: <span class="hljs-number">100</span>&#125;&#125;<br>car.Start() <span class="hljs-comment">// è°ƒç”¨çš„æ˜¯ Engine çš„ Start æ–¹æ³•</span><br></code></pre></td></tr></table></figure><h2 id="ç»“æ„ä½“çš„æ–¹æ³•">2.2 ç»“æ„ä½“çš„æ–¹æ³•</h2><p>å‡è®¾æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªç»“æ„ä½“ Personï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;<br>Name <span class="hljs-type">string</span><br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ Go ä¸­ï¼Œä½ å¯ä»¥ä¸ºç»“æ„ä½“çš„å€¼æˆ–æŒ‡é’ˆå®ç°ç‰¹å®šçš„æ–¹æ³•ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(p Person)</span></span> SetName(name <span class="hljs-type">string</span>) <span class="hljs-type">string</span> &#123;<br>  p.Name = name<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(p *Person)</span></span> SetName(name <span class="hljs-type">string</span>) <span class="hljs-type">string</span> &#123;<br>  p.Name = name<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸¤è€…æœ€æ ¸å¿ƒçš„åŒºåˆ«æ˜¯ï¼š<strong>å½“ä½ ä¸ºç»“æ„ä½“çš„æŒ‡é’ˆç±»å‹å®šä¹‰æ–¹æ³•æ—¶ï¼Œè¯¥æ–¹æ³•ä¼šåœ¨åŸå§‹ç»“æ„ä½“å®ä¾‹ä¸Šæ“ä½œã€‚è¿™æ„å‘³ç€æ–¹æ³•å†…éƒ¨å¯¹ç»“æ„ä½“çš„ä»»ä½•ä¿®æ”¹éƒ½ä¼šå½±å“åˆ°åŸå§‹ç»“æ„ä½“ã€‚</strong></p><p>æ‰€ä»¥è¿™ä¸¤æ®µä»£ç çš„è¾“å‡ºæ˜¯ä¸ä¸€æ ·çš„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>p := Person&#123;Name: <span class="hljs-string">&quot;hedon&quot;</span>&#125;<br>p.SetName(<span class="hljs-string">&quot;new_name&quot;</span>)<br>fmt.Println(p.Name)   <span class="hljs-comment">// name_name</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Person)</span></span> SetName(name <span class="hljs-type">string</span>) &#123;<br>p.Name = name<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>p := Person&#123;Name: <span class="hljs-string">&quot;hedon&quot;</span>&#125;<br>p.SetName(<span class="hljs-string">&quot;new_name&quot;</span>)<br>fmt.Println(p.Name)  <span class="hljs-comment">// hedon</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p Person)</span></span> SetName(name <span class="hljs-type">string</span>) &#123;<br>p.Name = name<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™é‡Œæˆ‘æƒ³å†è¡¥å……ä¸¤ä¸ªå°ç‚¹ã€‚è¯·å…ˆæ€è€ƒä¸€ä¸‹ä¸‹é¢è¿™ä¸¤æ®µä»£ç æ˜¯å¦å¯ä»¥ç¼–è¯‘é€šè¿‡ï¼Ÿå¦‚æœå¯ä»¥è¾“å‡ºæ˜¯ä»€ä¹ˆï¼Ÿ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>p := Person&#123;Name: <span class="hljs-string">&quot;hedon&quot;</span>&#125;<br>p.SetName(<span class="hljs-string">&quot;new_name&quot;</span>)<br>fmt.Println(<span class="hljs-string">&quot;person name after set:&quot;</span>, p.Name)<br><br>pt := reflect.TypeOf(p)<br>fmt.Println(<span class="hljs-string">&quot;the number of person&#x27;s method: &quot;</span>, pt.NumMethod())<br><br>p2 := &amp;Person&#123;&#125;<br>pt = reflect.TypeOf(p2)<br>fmt.Println(<span class="hljs-string">&quot;the number of &amp;person&#x27;s method: &quot;</span>, pt.NumMethod())<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Person)</span></span> SetName(name <span class="hljs-type">string</span>) &#123;<br>p.Name = name<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>p := Person&#123;Name: <span class="hljs-string">&quot;hedon&quot;</span>&#125;<br>p.SetName(<span class="hljs-string">&quot;new_name&quot;</span>)<br>fmt.Println(<span class="hljs-string">&quot;person name after set:&quot;</span>, p.Name)<br><br>pt := reflect.TypeOf(p)<br>fmt.Println(<span class="hljs-string">&quot;the number of person&#x27;s method: &quot;</span>, pt.NumMethod())<br><br>p2 := &amp;Person&#123;&#125;<br>pt = reflect.TypeOf(p2)<br>fmt.Println(<span class="hljs-string">&quot;the number of &amp;person&#x27;s method: &quot;</span>, pt.NumMethod())<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p Person)</span></span> SetName(name <span class="hljs-type">string</span>) &#123;<br>p.Name = name<br>&#125;<br></code></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾è¿™ä¸¤æ®µä»£ç çš„å”¯ä¸€åŒºåˆ«å°±æ˜¯ï¼Œç¬¬ä¸€æ®µä»£ç æˆ‘ä»¬æ˜¯ä¸º<code>*Person</code> å®ç°äº† <code>SetName</code>æ–¹æ³•ï¼Œè€Œç¬¬äºŒæ®µä»£ç æˆ‘ä»¬æ˜¯ä¸º <code>Person</code> å®ç°äº†<code>SetName</code> æ–¹æ³•ã€‚ä¸¤æ®µä»£ç æˆ‘ä»¬éƒ½æ‰“å°äº†è°ƒç”¨ <code>SetName</code>å <code>p.name</code> çš„å€¼ï¼Œä»¥åŠåˆ©ç”¨æ–¹å¼åˆ†åˆ«è·å– <code>Person</code> å’Œ<code>*Person</code> å®ç°çš„æ–¹æ³•ä¸ªæ•°ã€‚</p><p>ç¬¬ä¸€æ®µä»£ç çš„è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs tex">person name after set: new<span class="hljs-built_in">_</span>name<br>the number of person&#x27;s method:  0<br>the number of <span class="hljs-built_in">&amp;</span>person&#x27;s method:  1<br></code></pre></td></tr></table></figure><p>ç¬¬äºŒæ®µä»£ç çš„è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs tex">person name after set: hedon<br>the number of person&#x27;s method:  1<br>the number of <span class="hljs-built_in">&amp;</span>person&#x27;s method:  1<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥å¾—å‡º 2 ä¸ªç»“è®ºï¼š</p><p><strong>â‘  ç»“æ„ä½“çš„ä¿®æ”¹ä¾èµ–äºæ–¹æ³•æ¥æ”¶å™¨çš„ç±»å‹</strong>ï¼š</p><ul><li>å½“æ–¹æ³•çš„æ¥æ”¶å™¨ä¸ºå€¼ç±»å‹ï¼ˆ<code>Person</code>ï¼‰æ—¶ï¼Œå¯¹ç»“æ„ä½“çš„ä¿®æ”¹ä¸ä¼šå½±å“åŸå§‹ç»“æ„ä½“å®ä¾‹ï¼Œå› ä¸ºæ–¹æ³•ä½œç”¨äºç»“æ„ä½“çš„å‰¯æœ¬ä¸Šã€‚</li><li>å½“æ–¹æ³•çš„æ¥æ”¶å™¨ä¸ºæŒ‡é’ˆç±»å‹ï¼ˆ<code>*Person</code>ï¼‰æ—¶ï¼Œå¯¹ç»“æ„ä½“çš„ä¿®æ”¹ä¼šå½±å“åŸå§‹ç»“æ„ä½“å®ä¾‹ï¼Œå› ä¸ºæ–¹æ³•ä½œç”¨äºç»“æ„ä½“çš„å¼•ç”¨ä¸Šã€‚</li></ul><p><strong>â‘¡ æ–¹æ³•é›†ä¾èµ–äºæ¥æ”¶å™¨çš„ç±»å‹</strong>ï¼š</p><ul><li>ä¸ºå€¼ç±»å‹ï¼ˆ<code>Person</code>ï¼‰å®ç°çš„æ–¹æ³•ï¼Œæ—¢å±äºå€¼ç±»å‹ä¹Ÿå±äºæŒ‡é’ˆç±»å‹ï¼ˆ<code>*Person</code>ï¼‰çš„æ–¹æ³•é›†ã€‚</li><li>ä¸ºæŒ‡é’ˆç±»å‹ï¼ˆ<code>*Person</code>ï¼‰å®ç°çš„æ–¹æ³•ï¼Œåªå±äºæŒ‡é’ˆç±»å‹çš„æ–¹æ³•é›†ã€‚</li></ul><p>å¯¹äº â‘¡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ Plan9 æ±‡ç¼–ä»£ç ä¸€æ¢ç©¶ç«Ÿã€‚</p><p>æˆ‘ä»¬ä¸ºç¬¬ä¸€æ®µä»£ç æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go build -gcflags -S main.go<br></code></pre></td></tr></table></figure><p>åœ¨è¾“å‡ºçš„æœ€ä¸Šé¢ï¼Œå¯ä»¥çœ‹åˆ°åªæœ‰<code>main.(*Person).GetName</code>ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"># command-line-arguments<br>main.main STEXT size=<span class="hljs-number">128</span> args=<span class="hljs-number">0x0</span> locals=<span class="hljs-number">0x48</span> funcid=<span class="hljs-number">0x0</span> align=<span class="hljs-number">0x0</span><br>        ...<br>main.(*Person).GetName STEXT size=<span class="hljs-number">16</span> args=<span class="hljs-number">0x8</span> locals=<span class="hljs-number">0x0</span> funcid=<span class="hljs-number">0x0</span> align=<span class="hljs-number">0x0</span> leaf<br>       ...<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å†æ¥ä¸ºç¬¬äºŒæ®µä»£ç æ‰§è¡Œç›¸åŒçš„å‘½ä»¤ã€‚å¯ä»¥åœ¨è¾“å‡ºçš„æœ€ä¸Šé¢ï¼Œçœ‹åˆ°ä¸ä»…æœ‰<code>main.Person.GetName</code>ï¼Œè¿˜å¯ä»¥å‘ç°ç¼–è¯‘å™¨è‡ªåŠ¨å¸®æˆ‘ä»¬ç”Ÿæˆäº†<code>main.(*Person).GetName</code>ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># command-line-arguments</span><br>main.main STEXT size=480 args=0x0 locals=0xe8 funcid=0x0 align=0x0<br>...<br>main.Person.SetName STEXT size=16 args=0x28 locals=0x0 funcid=0x0 align=0x0 leaf<br>   ...<br>main.(*Person).SetName STEXT dupok size=128 args=0x18 locals=0x8 funcid=0x16 align=0x0<br>...<br></code></pre></td></tr></table></figure><p>å¯¹äº â‘¡ï¼Œç¬”è€…å…¶å®æœ‰ä¸€ä¸ªä¸å¤ªç†è§£çš„åœ°æ–¹ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>p := &amp;Person&#123;Name: <span class="hljs-string">&quot;hedon&quot;</span>&#125;<br>p.SetName(<span class="hljs-string">&quot;new_name&quot;</span>)<br>fmt.Println(<span class="hljs-string">&quot;person name after set:&quot;</span>, p.Name) <span class="hljs-comment">// hedon</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p Person)</span></span> SetName(name <span class="hljs-type">string</span>) &#123;<br>p.Name = name<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œ <code>p</code> æ˜¯å¼•ç”¨ç±»å‹ï¼Œä¸‹é¢å®ç°çš„æ˜¯<code>Person.SetName</code>ï¼ŒæŒ‰ç…§æˆ‘ä»¬ä¸Šé¢çš„ç»“è®ºï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬å®ç°<code>(*Person).SetName</code>ã€‚æŒ‰ç…§è¿™ç§æ€è·¯ï¼Œè¾“å‡º <code>new_name</code>ä¹Ÿæ˜¯è§£é‡Šå¾—é€šçš„ã€‚å› ä¸ºæ—¢ç„¶æˆ‘ä»¬å£°æ˜çš„æ˜¯ä¸€ä¸ªå¼•ç”¨ç±»å‹ï¼Œé‚£ä¹ˆ <code>p</code>å®Œå…¨å¯ä»¥å»è°ƒç”¨è‡ªåŠ¨ç”Ÿæˆçš„<code>(*Person).SetName</code>ã€‚ä½†æ˜¯æœ€ç»ˆçš„ç»“æœè¿˜æ˜¯è¾“å‡º<code>hedon</code>ï¼Œæ‰€ä»¥è¿™é‡Œç¼–è¯‘å™¨è‡ªåŠ¨å¸®æˆ‘ä»¬å°† <code>p</code>è¿›è¡Œè§£å¼•ç”¨ï¼Œç„¶åè°ƒç”¨äº† <code>Person.SetName</code>ã€‚</p><p>è¿™æ˜¯æ¯”è¾ƒå›°æ‰°ç¬”è€…çš„ä¸€ä¸ªåœ°æ–¹ï¼Œæ¬¢è¿è¯„è®ºåŒºè®¨è®º~</p><p>å¯èƒ½ç¼–è¯‘å™¨è¿˜æ˜¯æ›´å¸Œæœ›å¯¹äºå¼€å‘è€…æ¥è¯´â€œæ‰€è§å³æ‰€å¾—â€ï¼Œæ—¢ç„¶å¼€å‘è€…å®ç°çš„æ˜¯<code>Person.SetName</code>ï¼Œé‚£ä¹ˆå¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œåº”è¯¥å°±æ˜¯å¸Œæœ›ä¸å½±å“åŸå§‹ç»“æ„ä½“çš„å€¼ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨è¿˜æ˜¯é€‰æ‹©éµå¾ªè¿™ç§â€œæ„æ„¿â€ï¼Œä¸ä¹±æ“ä½œã€‚</p><h2 id="ç»“æ„ä½“æ¯”è¾ƒ">2.3 ç»“æ„ä½“æ¯”è¾ƒ</h2><p>Go å…è®¸ç›´æ¥æ¯”è¾ƒä¸¤ä¸ªç»“æ„ä½“å®ä¾‹ï¼Œä½†æœ‰ä¸€å®šçš„é™åˆ¶ï¼š</p><ol type="1"><li><strong>å¯æ¯”è¾ƒæ€§</strong>ï¼šåªæœ‰å½“ç»“æ„ä½“ä¸­çš„æ‰€æœ‰å­—æ®µéƒ½æ˜¯å¯æ¯”è¾ƒçš„æ—¶ï¼Œç»“æ„ä½“æ‰æ˜¯å¯æ¯”è¾ƒçš„ã€‚åŸºæœ¬æ•°æ®ç±»å‹ï¼ˆå¦‚intã€string ç­‰ï¼‰æ˜¯å¯æ¯”è¾ƒçš„ï¼Œä½†åˆ‡ç‰‡ã€æ˜ å°„ã€å‡½æ•°ç­‰ç±»å‹ä¸å¯æ¯”è¾ƒã€‚</li><li><strong>ç›¸ç­‰æ€§æ£€æµ‹</strong>ï¼šå½“ä¸¤ä¸ªç»“æ„ä½“çš„å¯¹åº”å­—æ®µéƒ½ç›¸ç­‰æ—¶ï¼Œè¿™ä¸¤ä¸ªç»“æ„ä½“è¢«è®¤ä¸ºæ˜¯ç›¸ç­‰çš„ã€‚å¯ä»¥ä½¿ç”¨<code>==</code> å’Œ <code>!=</code> æ“ä½œç¬¦æ¥è¿›è¡Œæ¯”è¾ƒã€‚</li></ol><p>ä¸‹é¢è¿™æ®µç¤ºä¾‹ï¼Œ<code>p3==p4</code> è¿”å›äº†<code>true</code>ï¼Œè¿™ç¬¦åˆæˆ‘ä»¬ä¸Šé¢æ€»ç»“çš„ç»“è®ºã€‚<code>p1==p2</code> è¿”å›äº†<code>false</code>ï¼Œå› ä¸ºè¿™å…¶å®ä¸æ˜¯ç»“æ„ä½“ä¹‹é—´çš„æ¯”è¾ƒäº†ï¼Œè¿™æ˜¯æŒ‡é’ˆçš„æ¯”è¾ƒäº†ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">p1 := &amp;Person&#123;Name: <span class="hljs-string">&quot;hedon&quot;</span>, Age: <span class="hljs-number">18</span>&#125;<br>p2 := &amp;Person&#123;Name: <span class="hljs-string">&quot;hedon&quot;</span>, Age: <span class="hljs-number">18</span>&#125;<br>fmt.Println(p1 == p2) <span class="hljs-comment">// false</span><br>p3 := Person&#123;Name: <span class="hljs-string">&quot;hedon&quot;</span>, Age: <span class="hljs-number">18</span>&#125;<br>p4 := Person&#123;Name: <span class="hljs-string">&quot;hedon&quot;</span>, Age: <span class="hljs-number">18</span>&#125;<br>fmt.Println(p3 == p4) <span class="hljs-comment">// true</span><br></code></pre></td></tr></table></figure><p>ç»“æ„ä½“çš„æ¯”è¾ƒåªæ”¯æŒ <code>==</code> å’Œ <code>!=</code>ï¼Œä¸æ”¯æŒ<code>&lt;</code> å’Œ <code>&gt;</code> ç­‰å…¶ä»–è¿ç®—ç¬¦çš„æ¯”è¾ƒã€‚è€Œ Goè¯­è¨€åˆä¸æ”¯æŒæ¯”è¾ƒç¬¦é‡è½½ã€‚æ‰€ä»¥å¦‚æœä½ è¦æ¯”è¾ƒä¸¤ä¸ªç»“æ„ä½“çš„å¤§å°ï¼Œé‚£ä¹ˆåªèƒ½è‡ªè¡Œå°è£…ç±»å‹<code>compare</code>çš„å‡½æ•°ã€‚åœ¨è¿™æˆ‘ä»¬æ’åºç»“æ„ä½“æ•°ç»„æˆ–åˆ‡ç‰‡çš„æ—¶å€™ï¼Œç»å¸¸ä½¿ç”¨åˆ°ï¼Œæ¯”å¦‚æˆ‘ä»¬å¸Œæœ›æŒ‰<code>Age</code> å­—æ®µä»å°åˆ°å¤§æ’åºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">sort.Slice(persons, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i, j <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>  <span class="hljs-keyword">return</span> persons[i].Age &lt; persons[j].Age<br>&#125;)<br></code></pre></td></tr></table></figure><h2 id="ç»“æ„ä½“å¤åˆ¶">2.4 ç»“æ„ä½“å¤åˆ¶</h2><p>åœ¨ Goä¸­ï¼Œç»“æ„ä½“ä¹Ÿæ˜¯å€¼ç±»å‹ï¼Œè¿™æ„å‘³ç€å½“å®ƒä»¬è¢«èµ‹å€¼ç»™æ–°çš„å˜é‡æˆ–ä½œä¸ºå‡½æ•°å‚æ•°ä¼ é€’æ—¶ï¼Œå®é™…ä¸Šæ˜¯è¿›è¡Œäº†ä¸€æ¬¡æ·±æ‹·è´ï¼š</p><ol type="1"><li><strong>å€¼å¤åˆ¶</strong>ï¼šå½“å°†ä¸€ä¸ªç»“æ„ä½“èµ‹å€¼ç»™ä¸€ä¸ªæ–°å˜é‡æ—¶ï¼Œæ–°å˜é‡ä¼šè·å¾—åŸå§‹ç»“æ„ä½“çš„ä¸€ä¸ªå‰¯æœ¬ï¼Œå®ƒä»¬åœ¨å†…å­˜ä¸­å æœ‰ä¸åŒçš„ä½ç½®ã€‚</li><li><strong>ç‹¬ç«‹æ€§</strong>ï¼šå› ä¸ºæ˜¯æ·±æ‹·è´ï¼Œæ‰€ä»¥åŸå§‹ç»“æ„ä½“å’Œå‰¯æœ¬ç»“æ„ä½“æ˜¯å®Œå…¨ç‹¬ç«‹çš„ï¼›ä¿®æ”¹å…¶ä¸­ä¸€ä¸ªä¸ä¼šå½±å“å¦ä¸€ä¸ªã€‚</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Point <span class="hljs-keyword">struct</span> &#123;<br>    X, Y <span class="hljs-type">int</span><br>&#125;<br><br>original := Point&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>&#125;<br><span class="hljs-built_in">copy</span> := original<br><span class="hljs-built_in">copy</span>.X = <span class="hljs-number">3</span><br><br>fmt.Println(original) <span class="hljs-comment">// &#123;1, 2&#125;</span><br>fmt.Println(<span class="hljs-built_in">copy</span>)     <span class="hljs-comment">// &#123;3, 2&#125;</span><br></code></pre></td></tr></table></figure><h1 id="ç»“æ„ä½“ä¸æ¥å£">3. ç»“æ„ä½“ä¸æ¥å£</h1><p>åœ¨ Goè¯­è¨€ä¸­ï¼Œå¦‚æœä¸€ä¸ªç±»å‹å®ç°äº†æ¥å£ä¸­æ‰€æœ‰çš„æ–¹æ³•ï¼Œåˆ™è¿™ä¸ªç±»å‹å°±å®ç°äº†è¯¥æ¥å£ã€‚å…³äºæ¥å£éƒ¨åˆ†çš„çŸ¥è¯†ç‚¹ï¼Œæ¯”å¦‚æ¥å£å®šä¹‰ã€å¤šæ€å’Œæ–­è¨€ç­‰ï¼Œæœ¬æ–‡å°±ä¸èµ˜è¿°äº†ã€‚</p><p>åœ¨è¿™é‡Œæˆ‘ä¸»è¦æƒ³ä»å¦å¤–ä¸€ä¸ªè§’åº¦ç»§ç»­æ¥éªŒè¯å‰é¢æˆ‘ä»¬æ€»ç»“çš„ï¼š<strong>ä¸ºå€¼ç±»å‹ï¼ˆ<code>Person</code>ï¼‰å®ç°çš„æ–¹æ³•ï¼Œæ—¢å±äºå€¼ç±»å‹ä¹Ÿå±äºæŒ‡é’ˆç±»å‹ï¼ˆ<code>*Person</code>ï¼‰çš„æ–¹æ³•é›†</strong>ã€‚</p><p>è¯·çœ‹è¿™æ®µä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">interface</span> &#123;<br>GetName() <span class="hljs-type">string</span><br>&#125;<br><br><span class="hljs-keyword">type</span> Man <span class="hljs-keyword">struct</span> &#123;<br>Name <span class="hljs-type">string</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m Man)</span></span> GetName() <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> m.Name<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">PrintPersonName</span><span class="hljs-params">(p Person)</span></span> &#123;<br>fmt.Println(p.GetName())<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>m1 := Man&#123;Name: <span class="hljs-string">&quot;hedon1&quot;</span>&#125;<br>PrintPersonName(m1)<br>m2 := &amp;Man&#123;Name: <span class="hljs-string">&quot;hedon2&quot;</span>&#125;<br>PrintPersonName(m2)<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ®µä»£ç æˆ‘ä»¬å®šä¹‰äº† <code>Person</code> æ¥å£ï¼Œå®ƒåªæœ‰ä¸€ä¸ªæ–¹æ³•<code>GetName</code>ã€‚ç„¶åæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªç»“æ„ä½“<code>Man</code>ï¼Œå¹¶ä¸ºå®ƒçš„å€¼ç±»å‹å®ç°äº† <code>Person</code>æ¥å£ã€‚é€šè¿‡æˆ‘ä»¬ä¸Šé¢çš„ç»“è®ºï¼Œè¿™é‡Œ <code>Man</code> å’Œ <code>*Man</code>å…¶å®éƒ½å®ç°äº† <code>Person</code>æ¥å£ï¼Œæ‰€ä»¥ä¸Šé¢çš„ä»£ç æ˜¯å¯ä»¥ç¼–è¯‘é€šè¿‡çš„ã€‚</p><p>å¦‚æœæ”¹æˆä¸ºæŒ‡é’ˆç±»å‹å®ç°æ¥å£å‘¢ï¼Ÿä½ å¯ä»¥è¯•ä¸€ä¸‹~</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Man)</span></span> GetName() <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> m.Name<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="æ³›å‹ç»“æ„ä½“">4. æ³›å‹ç»“æ„ä½“</h1><p>Go è¯­è¨€åœ¨å…¶ 1.18ç‰ˆæœ¬ä¸­å¼•å…¥äº†æ³›å‹æ”¯æŒï¼Œè¿™åŒ…æ‹¬äº†å¯¹æ³›å‹ç»“æ„ä½“çš„æ”¯æŒã€‚é€šè¿‡ä½¿ç”¨æ³›å‹ï¼Œä½ å¯ä»¥åˆ›å»ºæ›´çµæ´»å’Œå¯é‡ç”¨çš„æ•°æ®ç»“æ„å’Œå‡½æ•°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Container[T any] <span class="hljs-keyword">struct</span> &#123;<br>items []T<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° Go è¯­è¨€ç”¨ <code>[]</code> æ¥å®ç°æ³›å‹ï¼Œè€Œä¸åƒå…¶ä»–è¯­è¨€ä¸€æ ·ç”¨<code>&lt;&gt;</code>ï¼ŒçœŸæ˜¯å–œæ¬¢æç‰¹æ®Šå•Š ğŸ¤¡ï¼Œåˆä¸‘åˆå®¹æ˜“è·Ÿ map å’Œ sliceæ··æ·†ã€‚</p><h1 id="ç»“æ„ä½“çš„æ ‡ç­¾tag">5. ç»“æ„ä½“çš„æ ‡ç­¾ï¼ˆTagï¼‰</h1><p>åœ¨ç»“æ„ä½“å­—æ®µåé¢ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ <strong>``</strong>æ¥æŒ‡å®šæ ‡ç­¾ï¼Œè¿™å…è®¸æˆ‘ä»¬å¯¹ç»“æ„ä½“å®šåˆ¶åŒ–ä¸€äº›å¸¸ç”¨æ“ä½œï¼Œæœ€ç»å…¸çš„å°±æ˜¯åºåˆ—åŒ–ä¸ååºåˆ—åŒ–ã€‚</p><h2 id="åºåˆ—åŒ–ä¸ååºåˆ—åŒ–">5.1 åºåˆ—åŒ–ä¸ååºåˆ—åŒ–</h2><p>å¯¹äºå¸¸è§çš„æ•°æ®ç»“æ„ï¼Œå¦‚<code>json</code>ã€<code>yaml</code>ã€<code>xml</code> æˆ–<code>toml</code>ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥é€šè¿‡åœ¨ç»“æ„ä½“ä¸­æŒ‡å®šæ ‡ç­¾ï¼Œç„¶åä½¿ç”¨å¯¹åº”è§£æåº“è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚æ¯”å¦‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;encoding/json&quot;</span><br><span class="hljs-string">&quot;fmt&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;<br>Name <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;name&quot;`</span><br>Age  <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;age&quot;`</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>p := Person&#123;Name: <span class="hljs-string">&quot;hedon&quot;</span>, Age: <span class="hljs-number">18</span>&#125;<br>bs, _ := json.Marshal(p) <span class="hljs-comment">// åºåˆ—åŒ–</span><br>fmt.Println(<span class="hljs-type">string</span>(bs))  <span class="hljs-comment">// &#123;&quot;name&quot;:&quot;hedon&quot;,&quot;age&quot;:18&#125;</span><br>newP := Person&#123;&#125;<br>_ = json.Unmarshal(bs, &amp;newP) <span class="hljs-comment">// ååºåˆ—åŒ–</span><br>fmt.Println(newP)             <span class="hljs-comment">// &#123;hedon 18&#125;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ç¬”è€…çš„å®è·µè¿‡ç¨‹ä¸­ï¼Œåœ¨ç»“æ„ä½“ç»„åˆçš„åœºæ™¯ä¸‹ï¼Œä¸åŒæ•°æ®æ ¼å¼çš„è§£æä¼šæœ‰ä¸€äº›å°å·®åˆ«ï¼Œè¿™åœ¨å®æˆ˜è¿‡ç¨‹ä¸­ä½ éœ€è¦é‡ç‚¹å…³æ³¨å’ŒéªŒè¯ã€‚æ¯”å¦‚<code>json</code> å’Œ <code>yaml</code> å°±ä¼šæœ‰ä¸€äº›ä¸åŒã€‚</p><p>æ¯”å¦‚è¯´æˆ‘è¿™é‡Œå®šä¹‰äº†ä¸‹é¢ 2 ä¸ªç»“æ„ä½“ï¼Œå…¶ä¸­ <code>Person</code> ç»„åˆäº†<code>School</code>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;<br>Name <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;name&quot; yaml:&quot;name&quot;`</span><br>Age  <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;age&quot; yaml:&quot;age&quot;`</span><br>School<br>&#125;<br><br><span class="hljs-keyword">type</span> School <span class="hljs-keyword">struct</span> &#123;<br>SchoolName    <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;school_name&quot; yaml:&quot;school_name&quot;`</span><br>SchoolAddress <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;school_address&quot; json:&quot;school_address&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å®ƒä»¬éƒ½åŠ ä¸Šäº† <code>json</code> å’Œ <code>yaml</code> æ ‡ç­¾ï¼Œå¯¹äº<code>json</code> ç±»å‹ï¼Œä½ å¯ä»¥ç”¨æ ‡å‡†åº“çš„ <code>encoding/json</code>æ¥è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œè€Œ <code>yaml</code> ä½ å¯ä»¥ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ï¼š<ahref="https://github.com/go-yaml/yaml">go-yaml</a>ã€‚</p><p>å…ˆæ¥çœ‹ç³»åˆ—åŒ–ç»“æœï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>p := Person&#123;Name: <span class="hljs-string">&quot;hedon&quot;</span>, Age: <span class="hljs-number">18</span>, School: School&#123;SchoolName: <span class="hljs-string">&quot;nb_school&quot;</span>, SchoolAddress: <span class="hljs-string">&quot;a_good_school_place&quot;</span>&#125;&#125;<br>bs, _ := json.Marshal(p)<br>fmt.Println(<span class="hljs-string">&quot;json:\n&quot;</span>, <span class="hljs-type">string</span>(bs))<br>bs, _ = yaml.Marshal(p)<br>fmt.Println(<span class="hljs-string">&quot;yaml:\n&quot;</span>, <span class="hljs-type">string</span>(bs))<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs tex">json:<br> &#123;&quot;name&quot;:&quot;hedon&quot;,&quot;age&quot;:18,&quot;school<span class="hljs-built_in">_</span>name&quot;:&quot;nb<span class="hljs-built_in">_</span>school&quot;,&quot;school<span class="hljs-built_in">_</span>address&quot;:&quot;a<span class="hljs-built_in">_</span>good<span class="hljs-built_in">_</span>school<span class="hljs-built_in">_</span>place&quot;&#125;<br>yaml:<br> name: hedon<br> age: 18<br> school:<br>    school<span class="hljs-built_in">_</span>name: nb<span class="hljs-built_in">_</span>school<br>    school<span class="hljs-built_in">_</span>address: a<span class="hljs-built_in">_</span>good<span class="hljs-built_in">_</span>school<span class="hljs-built_in">_</span>place<br></code></pre></td></tr></table></figure><p>é€šè¿‡è§‚å¯Ÿä½ å¯ä»¥å‘ç°å“ˆï¼Œåœ¨ <code>json</code> ä¸­ï¼Œç»„åˆçš„æ—¶å€™ï¼ˆæ²¡æœ‰ç»™School åŠ æ ‡ç­¾ï¼‰ç›´æ¥å°† <code>School</code> å¹³é“ºåœ¨ <code>Person</code>ä¸­ï¼Œæ‰€ä»¥åœ¨åºåˆ—åŒ–çš„ç»“æœä¸­ï¼Œæ‰¾ä¸åˆ° <code>"school": &#123;&#125;</code>ã€‚è€Œåœ¨<code>yaml</code> ä¸­ï¼Œå¹¶ä¸æ˜¯ç›´æ¥å¹³é“ºçš„ã€‚</p><p>è¿™ä¸ªåŒºåˆ«åœ¨ä½ è§£æé…ç½®æ–‡ä»¶çš„æ—¶å€™å°¤å…¶é‡è¦ï¼Œå¦‚æœä¸æ³¨æ„ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šå¯¼è‡´é…ç½®è§£æå¤±è´¥ã€‚</p><p>æˆ‘å‡†å¤‡äº† 4 ä¸ªé…ç½®æ–‡ä»¶ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// person1.json</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;hedon_json&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">18</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;school&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;school_name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;nb_json_school&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;school_address&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;a_good_place_in_json&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># person1.yaml</span><br><span class="hljs-attr">name:</span> <span class="hljs-string">&quot;hedon_yaml&quot;</span><br><span class="hljs-attr">age:</span> <span class="hljs-number">18</span><br><span class="hljs-attr">school:</span><br>  <span class="hljs-attr">school_name:</span> <span class="hljs-string">&quot;nb_yaml_school&quot;</span><br>  <span class="hljs-attr">school_address:</span> <span class="hljs-string">&quot;a_good_price_in_yaml&quot;</span><br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// person2.json</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;hedon_json&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">18</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;school_name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;nb_json_school&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;school_address&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;a_good_place_in_json&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># person2.yaml</span><br><span class="hljs-attr">name:</span> <span class="hljs-string">&quot;hedon_yaml&quot;</span><br><span class="hljs-attr">age:</span> <span class="hljs-number">18</span><br><span class="hljs-attr">school_name:</span> <span class="hljs-string">&quot;nb_yaml_school&quot;</span><br><span class="hljs-attr">school_address:</span> <span class="hljs-string">&quot;a_good_price_in_yaml&quot;</span><br></code></pre></td></tr></table></figure><p>è§£æä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>filenames := []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;person1.json&quot;</span>, <span class="hljs-string">&quot;person1.yaml&quot;</span>, <span class="hljs-string">&quot;person2.json&quot;</span>, <span class="hljs-string">&quot;person2.yaml&quot;</span>&#125;<br><span class="hljs-keyword">for</span> i, fn := <span class="hljs-keyword">range</span> filenames &#123;<br>bs := readFileIntoBytes(fn)<br>p := Person&#123;&#125;<br><span class="hljs-keyword">if</span> i%<span class="hljs-number">2</span> == <span class="hljs-number">0</span> &#123;<br>_ = json.Unmarshal(bs, &amp;p)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>_ = yaml.Unmarshal(bs, &amp;p)<br>&#125;<br>fmt.Printf(<span class="hljs-string">&quot;%s -&gt; %v\n&quot;</span>, fn, p)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">readFileIntoBytes</span><span class="hljs-params">(filename <span class="hljs-type">string</span>)</span></span> []<span class="hljs-type">byte</span> &#123;<br>f, err := os.Open(filename)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(err)<br>&#125;<br>bs, _ := io.ReadAll(f)<br><span class="hljs-keyword">return</span> bs<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs tex">person1.json -&gt; &#123;hedon<span class="hljs-built_in">_</span>json 18 &#123; &#125;&#125;<br>person1.yaml -&gt; &#123;hedon<span class="hljs-built_in">_</span>yaml 18 &#123;nb<span class="hljs-built_in">_</span>yaml<span class="hljs-built_in">_</span>school a<span class="hljs-built_in">_</span>good<span class="hljs-built_in">_</span>price<span class="hljs-built_in">_</span>in<span class="hljs-built_in">_</span>yaml&#125;&#125;<br>person2.json -&gt; &#123;hedon<span class="hljs-built_in">_</span>json 18 &#123;nb<span class="hljs-built_in">_</span>json<span class="hljs-built_in">_</span>school a<span class="hljs-built_in">_</span>good<span class="hljs-built_in">_</span>place<span class="hljs-built_in">_</span>in<span class="hljs-built_in">_</span>json&#125;&#125;<br>person2.yaml -&gt; &#123;hedon<span class="hljs-built_in">_</span>yaml 18 &#123; &#125;&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœç»™ <code>School</code> å­—æ®µåŠ ä¸Š <code>json tag</code>çš„è¯ï¼Œç»“æœåˆæ˜¯ä¸åŒï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;<br>Name   <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;name&quot; yaml:&quot;name&quot;`</span><br>Age    <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;age&quot; yaml:&quot;age&quot;`</span><br>School <span class="hljs-string">`json:&quot;school&quot; yaml:&quot;school&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs tex">person1.json -&gt; &#123;hedon<span class="hljs-built_in">_</span>json 18 &#123;nb<span class="hljs-built_in">_</span>json<span class="hljs-built_in">_</span>school a<span class="hljs-built_in">_</span>good<span class="hljs-built_in">_</span>place<span class="hljs-built_in">_</span>in<span class="hljs-built_in">_</span>json&#125;&#125;<br>person1.yaml -&gt; &#123;hedon<span class="hljs-built_in">_</span>yaml 18 &#123;nb<span class="hljs-built_in">_</span>yaml<span class="hljs-built_in">_</span>school a<span class="hljs-built_in">_</span>good<span class="hljs-built_in">_</span>price<span class="hljs-built_in">_</span>in<span class="hljs-built_in">_</span>yaml&#125;&#125;<br>person2.json -&gt; &#123;hedon<span class="hljs-built_in">_</span>json 18 &#123; &#125;&#125;<br>person2.yaml -&gt; &#123;hedon<span class="hljs-built_in">_</span>yaml 18 &#123; &#125;&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å—å½±å“çš„åªæœ‰ <code>json</code>ã€‚</p><p>åˆ°è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ€»ç»“ï¼š<strong>åœ¨ç»„åˆåœºæ™¯ä¸‹ï¼Œå¦‚æœä¸æ˜ç¡®æŒ‡å®š<code>tag</code>ï¼Œ<code>yaml</code> è§£ææœŸæœ›å­—æ®µæ˜¯åµŒå¥—çš„ï¼Œè€Œ<code>json</code> è§£ææœŸæœ›å­—æ®µæ˜¯å¹³é“ºçš„</strong>ã€‚</p><h2 id="è‡ªå®šä¹‰-tag">5.2 è‡ªå®šä¹‰ Tag</h2><p>åœ¨ Goä¸­ï¼Œä½ å¯ä»¥ä¸ºç»“æ„ä½“å­—æ®µå®šä¹‰ä»»æ„çš„æ ‡ç­¾ã€‚è¿™äº›æ ‡ç­¾åœ¨ç¼–è¯‘æ—¶ä¼šè¢«å­˜å‚¨ï¼Œå¹¶ä¸”å¯ä»¥åœ¨è¿è¡Œæ—¶é€šè¿‡åå°„ï¼ˆreflectionï¼‰æ¥è®¿é—®ã€‚</p><p>å‡è®¾æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªåä¸º <code>check</code>çš„æ ‡ç­¾ï¼Œå®ƒç”¨äºæˆ‘ä»¬å¯¹ç»“æ„ä½“å­—æ®µçš„æ£€æŸ¥ï¼Œå‡è®¾æˆ‘ä»¬è¿™ä¸ªæ ‡ç­¾æ”¯æŒä»¥ä¸‹åŠŸèƒ½ï¼š</p><ul><li><code>check:"strnoempty"</code>: å­—ç¬¦ä¸²ä¸å¯ä»¥ä¸ºç©ºã€‚</li></ul><p>å‡å¦‚åŠ å…¥ <code>check</code> æ ‡ç­¾çš„ <code>Person</code>ç»“æ„ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;<br>Name <span class="hljs-type">string</span> <span class="hljs-string">`check:&quot;strnoempty&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥ä¸º <code>check</code> å®ç°è§£æå‡½æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CheckPerson</span><span class="hljs-params">(p Person)</span></span> <span class="hljs-type">error</span> &#123;<br>pt := reflect.TypeOf(p)<br>pv := reflect.ValueOf(p)<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; pt.NumField(); i++ &#123;<br>field := pt.Field(i)<br>tagValue := field.Tag.Get(<span class="hljs-string">&quot;check&quot;</span>)<br><span class="hljs-keyword">if</span> tagValue == <span class="hljs-string">&quot;&quot;</span> &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><span class="hljs-keyword">if</span> field.Type.Kind() == reflect.String &amp;&amp; tagValue == <span class="hljs-string">&quot;strnoempty&quot;</span> &#123;<br><span class="hljs-keyword">if</span> err := checkStrNoEmpty(field.Name, pv.Field(i).Interface()); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> err<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">checkStrNoEmpty</span><span class="hljs-params">(fieldName <span class="hljs-type">string</span>, v any)</span></span> <span class="hljs-type">error</span> &#123;<br>s, ok := v.(<span class="hljs-type">string</span>)<br><span class="hljs-keyword">if</span> !ok &#123;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;%v is not string&quot;</span>, v)<br>&#125;<br><span class="hljs-keyword">if</span> s == <span class="hljs-string">&quot;&quot;</span> &#123;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;[check] %s should not be empty&quot;</span>, fieldName)<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æµ‹è¯•å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>p1 := Person&#123;&#125;<br>p2 := Person&#123;Name: <span class="hljs-string">&quot;hedon&quot;</span>&#125;<br>fmt.Println(CheckPerson(p1)) <span class="hljs-comment">// [check] Name should not be empty</span><br>fmt.Println(CheckPerson(p2)) <span class="hljs-comment">// &lt;nil&gt;</span><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="ç»“æ„ä½“å†…å­˜å¯¹é½">6. ç»“æ„ä½“å†…å­˜å¯¹é½</h1><p>åœ¨æœ¬å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†æ¢è®¨ Go è¯­è¨€ç»“æ„ä½“çš„å†…å­˜ç»“æ„å’Œå¯¹é½ç­–ç•¥ã€‚</p><h2 id="é—®é¢˜å¼•å‡º">6.1 é—®é¢˜å¼•å‡º</h2><p>æ€è€ƒä¸‹é¢è¿™æ®µä»£ç çš„è¾“å‡ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> S1 <span class="hljs-keyword">struct</span> &#123;<br>num2 <span class="hljs-type">int8</span><br>num1 <span class="hljs-type">int16</span><br>flag <span class="hljs-type">bool</span><br>&#125;<br><br><span class="hljs-keyword">type</span> S2 <span class="hljs-keyword">struct</span> &#123;<br>num1 <span class="hljs-type">int8</span><br>flag <span class="hljs-type">bool</span><br>num2 <span class="hljs-type">int16</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(unsafe.Sizeof(S1&#123;&#125;))<br>fmt.Println(unsafe.Sizeof(S2&#123;&#125;))<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆä»…æ˜¯å­—æ®µé¡ºåºä¸åŒï¼Œ<code>S1&#123;&#125;</code> å’Œ <code>S2&#123;&#125;</code>çš„å¤§å°å°±ä¸ä¸€æ ·äº†ï¼Ÿ</p><p>æˆ‘ä»¬å¯ä»¥å†™ä¸ªç®€å•çš„ç¨‹åºæ¥è¾“å‡º <code>S1</code> å’Œ <code>S2</code>çš„å†…å­˜ç»“æ„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>s1 := S1&#123;&#125;<br>s2 := S2&#123;&#125;<br>fmt.Print(<span class="hljs-string">&quot;s1: &quot;</span>)<br>printMemory(s1)<br>fmt.Print(<span class="hljs-string">&quot;s2: &quot;</span>)<br>printMemory(s2)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">printMemory</span><span class="hljs-params">(a any)</span></span> &#123;<br>t := reflect.TypeOf(a)<br>mem := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-type">int</span>(t.Size()))<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; t.NumField(); i++ &#123;<br>field := t.Field(i)<br>offset := <span class="hljs-type">int</span>(field.Offset)<br>size := <span class="hljs-type">int</span>(field.Type.Size())<br><span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; size; j++ &#123;<br>mem[j+offset] = i + <span class="hljs-number">1</span><br>&#125;<br>&#125;<br>fmt.Println(mem)<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">s1: [<span class="hljs-number">1</span> <span class="hljs-number">0</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">0</span>]<br>s2: [<span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span>]<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>1</code>ã€<code>2</code>ã€<code>3</code>åˆ†åˆ«æ›¿ä»£ç»“æ„ä½“ä¸­çš„ç¬¬ 1/2/3 ä¸ªå­—æ®µæ‰€å ç”¨çš„å†…å­˜ã€‚è¿™é‡Œå¯ä»¥çœ‹åˆ°<code>s1</code> çš„é•¿åº¦æ˜¯ 6 å­—èŠ‚ï¼Œè€Œ <code>s2</code> æ˜¯ 4 å­—èŠ‚ã€‚è¿™é‡Œ<code>s1</code> æ¯” <code>s2</code> å¤šå‡ºçš„ 2 ä¸ªå­—èŠ‚å°±æ˜¯è¿™ä¸¤ä¸ªå¡«å……çš„<code>0</code>ã€‚è¿™è€Œ 2ä¸ªå­—èŠ‚çš„å¡«å……ï¼Œå°±æ˜¯ä¸ºäº†<strong>å†…å­˜å¯¹é½</strong>ã€‚</p><h2 id="å†…å­˜å¯¹é½">6.2 å†…å­˜å¯¹é½</h2><p>å¦‚ä¸Šåˆ†æï¼Œ<code>s1</code> çš„å†…å­˜ç»“æ„å¦‚ä¸‹ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240310154903219.png"alt="s1 å†…å­˜ç»“æ„" /><figcaption aria-hidden="true">s1 å†…å­˜ç»“æ„</figcaption></figure><p>å¦‚æœæ²¡æœ‰å†…å­˜å¯¹é½å‘¢ï¼Ÿ<code>s1</code> çš„ç»“æ„å¯èƒ½å¦‚ä¸‹ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240310155353882.png"alt="æ²¡æœ‰å†…å­˜å¯¹é½çš„ s1 å†…å­˜ç»“æ„" /><figcaption aria-hidden="true">æ²¡æœ‰å†…å­˜å¯¹é½çš„ s1 å†…å­˜ç»“æ„</figcaption></figure><p>å¦‚æœæ˜¯ 16 ä½ç³»ç»Ÿçš„è¯ï¼Œé‚£ä¹ˆæ²¡æœ‰å†…å­˜å¯¹é½çš„æƒ…å†µä¸‹ï¼Œè¦è®¿é—®<code>s1.num2</code> å­—æ®µï¼Œå°±éœ€è¦è·¨è¿‡ 2ä¸ªç³»ç»Ÿå­—é•¿çš„å†…å­˜ï¼Œæ•ˆç‡å°±ä½äº†ã€‚å…·ä½“æ¥è¯´ï¼Œå†…å­˜å¯¹é½æ˜¯è®¡ç®—æœºå†…å­˜åˆ†é…çš„ä¸€ç§ä¼˜åŒ–æ–¹å¼ï¼Œç”¨äºç¡®ä¿æ•°æ®ç»“æ„çš„å­˜å‚¨æŒ‰ç…§ç‰¹å®šçš„å­—èŠ‚è¾¹ç•Œå¯¹é½ã€‚è¿™ç§å¯¹é½æ˜¯ä¸ºäº†æé«˜è®¡ç®—æœºå¤„ç†æ•°æ®çš„æ•ˆç‡ã€‚</p><h2 id="å¯¹é½ç³»æ•°">6.3 å¯¹é½ç³»æ•°</h2><ul><li>å¯¹é½ç³»æ•°ï¼šå˜é‡çš„å†…å­˜åœ°å€å¿…é¡»è¢«å¯¹é½ç³»æ•°æ•´é™¤ã€‚</li><li><code>unsafe.Alignof()</code>: å¯ä»¥æŸ¥çœ‹å€¼åœ¨å†…å­˜ä¸­çš„å¯¹é½ç³»æ•°ã€‚</li></ul><h2 id="åŸºæœ¬ç±»å‹å¯¹é½">6.4 åŸºæœ¬ç±»å‹å¯¹é½</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">fmt.Printf(<span class="hljs-string">&quot;bool size: %d, align: %d\n&quot;</span>, unsafe.Sizeof(<span class="hljs-type">bool</span>(<span class="hljs-literal">true</span>)), unsafe.Alignof(<span class="hljs-type">bool</span>(<span class="hljs-literal">true</span>)))<br>fmt.Printf(<span class="hljs-string">&quot;byte size: %d, align: %d\n&quot;</span>, unsafe.Sizeof(<span class="hljs-type">byte</span>(<span class="hljs-number">0</span>)), unsafe.Alignof(<span class="hljs-type">byte</span>(<span class="hljs-number">0</span>)))<br>fmt.Printf(<span class="hljs-string">&quot;int8 size: %d, align: %d\n&quot;</span>, unsafe.Sizeof(<span class="hljs-type">int8</span>(<span class="hljs-number">0</span>)), unsafe.Alignof(<span class="hljs-type">int8</span>(<span class="hljs-number">0</span>)))<br>fmt.Printf(<span class="hljs-string">&quot;int16 size: %d, align: %d\n&quot;</span>, unsafe.Sizeof(<span class="hljs-type">int16</span>(<span class="hljs-number">0</span>)), unsafe.Alignof(<span class="hljs-type">int16</span>(<span class="hljs-number">0</span>)))<br>fmt.Printf(<span class="hljs-string">&quot;int32 size: %d, align: %d\n&quot;</span>, unsafe.Sizeof(<span class="hljs-type">int32</span>(<span class="hljs-number">0</span>)), unsafe.Alignof(<span class="hljs-type">int32</span>(<span class="hljs-number">0</span>)))<br>fmt.Printf(<span class="hljs-string">&quot;int64 size: %d, align: %d\n&quot;</span>, unsafe.Sizeof(<span class="hljs-type">int64</span>(<span class="hljs-number">0</span>)), unsafe.Alignof(<span class="hljs-type">int64</span>(<span class="hljs-number">0</span>)))<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-type">bool</span> size: <span class="hljs-number">1</span>, align: <span class="hljs-number">1</span><br><span class="hljs-type">byte</span> size: <span class="hljs-number">1</span>, align: <span class="hljs-number">1</span><br><span class="hljs-type">int8</span> size: <span class="hljs-number">1</span>, align: <span class="hljs-number">1</span><br><span class="hljs-type">int16</span> size: <span class="hljs-number">2</span>, align: <span class="hljs-number">2</span><br><span class="hljs-type">int32</span> size: <span class="hljs-number">4</span>, align: <span class="hljs-number">4</span><br><span class="hljs-type">int64</span> size: <span class="hljs-number">8</span>, align: <span class="hljs-number">8</span><br></code></pre></td></tr></table></figure><p>ç»“è®ºï¼šåŸºæœ¬ç±»å‹çš„å¯¹é½ç³»æ•°è·Ÿå®ƒçš„é•¿åº¦ä¸€è‡´ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240310160412598.png"alt="åŸºæœ¬ç±»å‹å†…å­˜å¯¹é½" /><figcaption aria-hidden="true">åŸºæœ¬ç±»å‹å†…å­˜å¯¹é½</figcaption></figure><h2 id="ç»“æ„ä½“å†…éƒ¨å¯¹é½">6.5 ç»“æ„ä½“å†…éƒ¨å¯¹é½</h2><p>ç»“æ„ä½“å†…å­˜å¯¹é½åˆ†ä¸ºå†…éƒ¨å¯¹é½å’Œç»“æ„ä½“ä¹‹é—´å¯¹é½ã€‚</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹ç»“æ„ä½“å†…éƒ¨å¯¹é½ï¼š</p><ul><li>æŒ‡çš„æ˜¯ç»“æ„ä½“å†…éƒ¨æˆå‘˜çš„ç›¸å¯¹ä½ç½®ï¼ˆåç§»é‡ï¼‰ï¼›</li><li>æ¯ä¸ªæˆå‘˜çš„åç§»é‡æ˜¯ <strong>è‡ªèº«å¤§å°</strong> å’Œ<strong>å¯¹é½ç³»æ•°</strong> çš„è¾ƒå°å€¼çš„å€æ•°</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Demo <span class="hljs-keyword">struct</span> &#123;<br>  a <span class="hljs-type">bool</span><br>  b <span class="hljs-type">string</span><br>  c <span class="hljs-type">int16</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å‡å¦‚æˆ‘ä»¬å®šä¹‰äº†ä¸Šé¢çš„ç»“æ„ä½“ <code>Demo</code>ï¼Œå¦‚æœåœ¨ 64ä½ç³»ç»Ÿä¸Šï¼ˆå­—é•¿ä¸º 8 å­—èŠ‚ï¼‰é€šè¿‡ä¸Šé¢çš„è§„åˆ™ï¼Œå¯ä»¥åˆ¤æ–­å‡ºï¼šï¼ˆå•ä½ä¸ºå­—èŠ‚ï¼‰</p><ul><li>a: size=1, align=1</li><li>b: size=16, align=8</li><li>c: size=2, align=2</li></ul><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240310163126556.png"alt="Demo å†…å­˜ç»“æ„" /><figcaption aria-hidden="true">Demo å†…å­˜ç»“æ„</figcaption></figure><p>å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ç¨‹åºè¾“å‡ºæ¥éªŒè¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Demo <span class="hljs-keyword">struct</span> &#123;<br>a <span class="hljs-type">bool</span>   <span class="hljs-comment">// size=1, align=1</span><br>b <span class="hljs-type">string</span> <span class="hljs-comment">// size=16, align=8</span><br>c <span class="hljs-type">int16</span>  <span class="hljs-comment">// size=2, align=2</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>d := Demo&#123;&#125;<br>fmt.Printf(<span class="hljs-string">&quot;a: size=%d, align=%d\n&quot;</span>, unsafe.Sizeof(d.a), unsafe.Alignof(d.a))<br>fmt.Printf(<span class="hljs-string">&quot;b: size=%d, align=%d\n&quot;</span>, unsafe.Sizeof(d.b), unsafe.Alignof(d.b))<br>fmt.Printf(<span class="hljs-string">&quot;c: size=%d, align=%d\n&quot;</span>, unsafe.Sizeof(d.c), unsafe.Alignof(d.c))<br>printMemory(d)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">printMemory</span><span class="hljs-params">(a any)</span></span> &#123;<br>t := reflect.TypeOf(a)<br>mem := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-type">int</span>(t.Size()))<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; t.NumField(); i++ &#123;<br>field := t.Field(i)<br>offset := <span class="hljs-type">int</span>(field.Offset)<br>size := <span class="hljs-type">int</span>(field.Type.Size())<br><span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; size; j++ &#123;<br>mem[j+offset] = i + <span class="hljs-number">1</span><br>&#125;<br>&#125;<br>fmt.Println(mem)<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go">a: size=<span class="hljs-number">1</span>, align=<span class="hljs-number">1</span><br>b: size=<span class="hljs-number">16</span>, align=<span class="hljs-number">8</span><br>c: size=<span class="hljs-number">2</span>, align=<span class="hljs-number">2</span><br>[<span class="hljs-number">1</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span>]<br></code></pre></td></tr></table></figure><h2 id="ç»“æ„ä½“é•¿åº¦å¡«å……">6.6 ç»“æ„ä½“é•¿åº¦å¡«å……</h2><p>ä¸Šé¢ Demo ç»“æ„ä½“æœ€åè¿˜å¡«äº† 6 ä¸ªå­—èŠ‚çš„ 0ï¼Œè¿™å°±æ˜¯ç»“æ„ä½“é•¿åº¦å¡«å……ï¼š</p><ul><li>ç»“æ„ä½“é€šè¿‡å¡«å……é•¿åº¦ï¼Œæ¥å¯¹é½ç³»ç»Ÿå­—é•¿ã€‚</li><li>ç»“æ„ä½“é•¿åº¦æ˜¯ <strong>æœ€å¤§æˆå‘˜é•¿åº¦</strong> å’Œ<strong>ç³»ç»Ÿå­—é•¿</strong> è¾ƒå°å€¼çš„æ•´æ•°å€ã€‚</li></ul><p>æˆ‘çš„ç³»ç»Ÿç¯å¢ƒæ˜¯ m2maxï¼Œç³»ç»Ÿå­—é•¿æ˜¯ 8 å­—èŠ‚ï¼ŒDemo æœ€å¤§æˆå‘˜é•¿åº¦æ˜¯<code>b string</code>ï¼Œå³ 16 ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥ <code>Demo</code> çš„é•¿åº¦åº”è¯¥æ˜¯<code>8</code> çš„å€æ•°ï¼Œæ‰€ä»¥æœ€åå¡«å……äº† 6 ä¸ªå­—èŠ‚çš„ 0ã€‚</p><h2 id="ç»“æ„ä½“ä¹‹é—´å¯¹é½">6.7 ç»“æ„ä½“ä¹‹é—´å¯¹é½</h2><ul><li>ç»“æ„ä½“ä¹‹é—´å¯¹é½ï¼Œæ˜¯ä¸ºäº†ç¡®å®šç»“æ„ä½“çš„ç¬¬ä¸€ä¸ªæˆå‘˜å˜é‡çš„å†…å­˜åœ°å€ï¼Œä»¥è®©åé¢çš„æˆå‘˜åœ°å€éƒ½åˆæ³•ã€‚</li><li>ç»“æ„ä½“çš„å¯¹é½ç³»æ•°æ˜¯ <strong>å…¶æˆå‘˜çš„æœ€å¤§å¯¹é½ç³»æ•°</strong>ï¼›</li></ul><h2 id="ç©ºç»“æ„ä½“å¯¹é½">6.8 ç©ºç»“æ„ä½“å¯¹é½</h2><p>å‰é¢æˆ‘ä»¬ä¸“é—¨è®¨è®ºäº†ç©ºç»“æ„ä½“<code>struct&#123;&#125;</code>ï¼Œå®ƒä»¬çš„å†…å­˜åœ°å€ç»Ÿä¸€æŒ‡å‘<code>zerobase</code>ï¼Œè€Œä¸”å†…å­˜é•¿åº¦ä¸º0ã€‚è¿™ä¹Ÿå¯¼è‡´äº†å®ƒçš„å†…å­˜å¯¹é½è§„åˆ™ï¼Œæœ‰ä¸€äº›ä¸åŒã€‚å…·ä½“å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ 4ä¸ªæƒ…å†µã€‚</p><h3 id="ç©ºç»“æ„ä½“å•ç‹¬å­˜åœ¨">6.8.1 ç©ºç»“æ„ä½“å•ç‹¬å­˜åœ¨</h3><p>ç©ºç»“æ„ä½“å•ç‹¬å­˜åœ¨æ—¶ï¼Œå…¶å†…å­˜åœ°å€ä¸º<code>zerobase</code>ï¼Œä¸é¢å¤–åˆ†é…å†…å­˜ã€‚</p><h3 id="ç©ºç»“æ„ä½“åœ¨ç»“æ„ä½“æœ€å‰">6.8.2 ç©ºç»“æ„ä½“åœ¨ç»“æ„ä½“æœ€å‰</h3><p>ç©ºç»“æ„ä½“æ˜¯ç»“æ„ä½“ç¬¬ä¸€ä¸ªå­—æ®µæ—¶ï¼Œå®ƒçš„åœ°å€è·Ÿç»“æ„ä½“æœ¬èº«åŠç»“æ„ä½“ç¬¬ 2ä¸ªå­—æ®µä¸€æ ·ï¼Œä¸å æ®å†…å­˜ç©ºé—´ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> TestEmpty <span class="hljs-keyword">struct</span> &#123;<br>empty <span class="hljs-keyword">struct</span>&#123;&#125;<br>a     <span class="hljs-type">bool</span><br>b     <span class="hljs-type">string</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>te := TestEmpty&#123;&#125;<br>fmt.Printf(<span class="hljs-string">&quot;address of te: %p\n&quot;</span>, &amp;te)<br>fmt.Printf(<span class="hljs-string">&quot;address of te.empty: %p\n&quot;</span>, &amp;(te.empty))<br>fmt.Printf(<span class="hljs-string">&quot;address of te.a: %p\n&quot;</span>, &amp;(te.a))<br>fmt.Printf(<span class="hljs-string">&quot;empty: size=%d, align=%d\n&quot;</span>, unsafe.Sizeof(te.empty), unsafe.Alignof(te.empty))<br>fmt.Printf(<span class="hljs-string">&quot;a: size=%d, align=%d\n&quot;</span>, unsafe.Sizeof(te.a), unsafe.Alignof(te.a))<br>fmt.Printf(<span class="hljs-string">&quot;b: size=%d, align=%d\n&quot;</span>, unsafe.Sizeof(te.b), unsafe.Alignof(te.b))<br>printMemory(te)<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">address of te: <span class="hljs-number">0x140000ba000</span><br>address of te.empty: <span class="hljs-number">0x140000ba000</span><br>address of te.a: <span class="hljs-number">0x140000ba000</span><br>empty: size=<span class="hljs-number">0</span>, align=<span class="hljs-number">1</span><br>a: size=<span class="hljs-number">1</span>, align=<span class="hljs-number">1</span><br>b: size=<span class="hljs-number">16</span>, align=<span class="hljs-number">8</span><br>[<span class="hljs-number">2</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span>]<br></code></pre></td></tr></table></figure><h3 id="ç©ºç»“æ„ä½“åœ¨ç»“æ„ä½“ä¸­é—´">6.8.3 ç©ºç»“æ„ä½“åœ¨ç»“æ„ä½“ä¸­é—´</h3><p>ç©ºç»“æ„ä½“å‡ºç°åœ¨ç»“æ„ä½“ä¸­æ—¶ï¼Œåœ°å€è·Ÿéšå‰ä¸€ä¸ªå˜é‡ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240310165025700.png"alt="ç©ºç»“æ„ä½“åœ¨ç»“æ„ä½“ä¸­é—´å†…å­˜å¯¹é½" /><figcaption aria-hidden="true">ç©ºç»“æ„ä½“åœ¨ç»“æ„ä½“ä¸­é—´å†…å­˜å¯¹é½</figcaption></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> TestEmpty <span class="hljs-keyword">struct</span> &#123;<br>a     <span class="hljs-type">bool</span><br>empty <span class="hljs-keyword">struct</span>&#123;&#125;<br>b     <span class="hljs-type">string</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>te := TestEmpty&#123;&#125;<br>fmt.Printf(<span class="hljs-string">&quot;address of te: %p\n&quot;</span>, &amp;te)<br>fmt.Printf(<span class="hljs-string">&quot;address of te.a: %p\n&quot;</span>, &amp;(te.a))<br>fmt.Printf(<span class="hljs-string">&quot;address of te.empty: %p\n&quot;</span>, &amp;(te.empty))<br>fmt.Printf(<span class="hljs-string">&quot;a: size=%d, align=%d\n&quot;</span>, unsafe.Sizeof(te.a), unsafe.Alignof(te.a))<br>fmt.Printf(<span class="hljs-string">&quot;empty: size=%d, align=%d\n&quot;</span>, unsafe.Sizeof(te.empty), unsafe.Alignof(te.empty))<br>fmt.Printf(<span class="hljs-string">&quot;b: size=%d, align=%d\n&quot;</span>, unsafe.Sizeof(te.b), unsafe.Alignof(te.b))<br>printMemory(te)<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">address of te: <span class="hljs-number">0x14000128000</span><br>address of te.a: <span class="hljs-number">0x14000128000</span><br>address of te.empty: <span class="hljs-number">0x14000128001</span><br>a: size=<span class="hljs-number">1</span>, align=<span class="hljs-number">1</span><br>empty: size=<span class="hljs-number">0</span>, align=<span class="hljs-number">1</span><br>b: size=<span class="hljs-number">16</span>, align=<span class="hljs-number">8</span><br>[<span class="hljs-number">1</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span>]<br></code></pre></td></tr></table></figure><h3 id="ç©ºç»“æ„ä½“åœ¨ç»“æ„ä½“æœ€å">6.8.4 ç©ºç»“æ„ä½“åœ¨ç»“æ„ä½“æœ€å</h3><p>ç©ºç»“æ„ä½“å‡ºç°åœ¨ç»“æ„ä½“æœ€åï¼Œå¦‚æœå¼€å¯äº†ä¸€ä¸ªæ–°çš„ç³»ç»Ÿå­—é•¿ï¼Œåˆ™éœ€è¦è¡¥é›¶ï¼Œé˜²æ­¢ä¸å…¶ä»–ç»“æ„ä½“æ··ç”¨åœ°å€ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240310164933867.png"alt="ç©ºç»“æ„ä½“åœ¨ç»“æ„ä½“æœ€åå†…å­˜å¯¹é½" /><figcaption aria-hidden="true">ç©ºç»“æ„ä½“åœ¨ç»“æ„ä½“æœ€åå†…å­˜å¯¹é½</figcaption></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> TestEmpty <span class="hljs-keyword">struct</span> &#123;<br>a     <span class="hljs-type">bool</span><br>b     <span class="hljs-type">string</span><br>empty <span class="hljs-keyword">struct</span>&#123;&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>te := TestEmpty&#123;&#125;<br>fmt.Printf(<span class="hljs-string">&quot;address of te: %p\n&quot;</span>, &amp;te)<br>fmt.Printf(<span class="hljs-string">&quot;address of te.a: %p\n&quot;</span>, &amp;(te.a))<br>fmt.Printf(<span class="hljs-string">&quot;address of te.empty: %p\n&quot;</span>, &amp;(te.empty))<br>fmt.Printf(<span class="hljs-string">&quot;a: size=%d, align=%d\n&quot;</span>, unsafe.Sizeof(te.a), unsafe.Alignof(te.a))<br>fmt.Printf(<span class="hljs-string">&quot;b: size=%d, align=%d\n&quot;</span>, unsafe.Sizeof(te.b), unsafe.Alignof(te.b))<br>fmt.Printf(<span class="hljs-string">&quot;empty: size=%d, align=%d\n&quot;</span>, unsafe.Sizeof(te.empty), unsafe.Alignof(te.empty))<br>printMemory(te)<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">address of te: <span class="hljs-number">0x1400006a020</span><br>address of te.a: <span class="hljs-number">0x1400006a020</span><br>address of te.empty: <span class="hljs-number">0x1400006a038</span><br>a: size=<span class="hljs-number">1</span>, align=<span class="hljs-number">1</span><br>b: size=<span class="hljs-number">16</span>, align=<span class="hljs-number">8</span><br>empty: size=<span class="hljs-number">0</span>, align=<span class="hljs-number">1</span><br>[<span class="hljs-number">1</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span>]<br></code></pre></td></tr></table></figure><h2 id="ä½¿ç”¨-fieldalignment--fix-å·¥å…·ä¼˜åŒ–ç»“æ„ä½“å†…å­˜å¯¹é½">6.9 ä½¿ç”¨fieldalignment -fix å·¥å…·ä¼˜åŒ–ç»“æ„ä½“å†…å­˜å¯¹é½</h2><p>è¿˜è®°å¾—æˆ‘ä»¬æœ€å¼€å§‹æå‡ºçš„é—®é¢˜å—ï¼Ÿ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> S1 <span class="hljs-keyword">struct</span> &#123;<br>num2 <span class="hljs-type">int8</span><br>num1 <span class="hljs-type">int16</span><br>flag <span class="hljs-type">bool</span><br>&#125;<br><br><span class="hljs-keyword">type</span> S2 <span class="hljs-keyword">struct</span> &#123;<br>num1 <span class="hljs-type">int8</span><br>flag <span class="hljs-type">bool</span><br>num2 <span class="hljs-type">int16</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(unsafe.Sizeof(S1&#123;&#125;))<br>fmt.Println(unsafe.Sizeof(S2&#123;&#125;))<br>&#125;<br></code></pre></td></tr></table></figure><p><code>S1</code> å’Œ <code>S2</code> æä¾›çš„ç¨‹åºåŠŸèƒ½æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯<code>S1</code> å´æ¯” <code>S2</code>èŠ±è´¹äº†æ›´å¤šçš„å†…å­˜ç©ºé—´ã€‚æ‰€ä»¥æœ‰æ—¶å€™æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»…ä»…è°ƒæ•´ç»“æ„ä½“å†…éƒ¨å­—æ®µçš„é¡ºåºå°±å‡å°‘ä¸å°‘çš„å†…å­˜ç©ºé—´æ¶ˆè€—ã€‚åœ¨è¿™ä¸ªæ—¶å€™<code>fieldalignment</code> å¯ä»¥å¸®åŠ©æˆ‘ä»¬è‡ªåŠ¨æ£€æµ‹å¹¶ä¼˜åŒ–ã€‚</p><p>ä½ å¯ä»¥è¿è¡Œä¸‹é¢å‘½ä»¤å®‰è£… <code>fieldalignment</code> å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go install golang.org/x/tools/go/analysis/passes/fieldalignment/cmd/fieldalignment@latest<br></code></pre></td></tr></table></figure><p>ç„¶ååœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹è¿è¡Œä¸‹é¢å‘½ä»¤ï¼Œå¯¹æˆ‘ä»¬çš„ä»£ç è¿›è¡Œæ£€æŸ¥ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go vet -vettool=$(<span class="hljs-built_in">which</span> fieldalignment) ./...<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä¼šè¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./main.go:9:9: struct of size 6 could be 4<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™å¯ä»¥æ‰§è¡Œ <code>fieldalignment -fix ç›®å½•|æ–‡ä»¶</code>ï¼Œå®ƒä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬çš„ä»£ç è¿›è¡Œä¿®å¤ï¼Œä½†æ˜¯<strong>å¼ºçƒˆå»ºè®®ä½ åœ¨è¿è¡Œä¹‹å‰ï¼Œå¤‡ä»½ä½ çš„ä»£ç ï¼Œå› ä¸ºæ³¨é‡Šä¼šè¢«åˆ é™¤ï¼</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">fieldalignment -fix ./...<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">/Users/hedon/GolandProjects/learn-<span class="hljs-keyword">go</span>-<span class="hljs-keyword">struct</span>/main.<span class="hljs-keyword">go</span>:<span class="hljs-number">9</span>:<span class="hljs-number">9</span>: <span class="hljs-keyword">struct</span> of size <span class="hljs-number">6</span> could be <span class="hljs-number">4</span><br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™ <code>S1</code> å·²ç»è¢«ä¼˜åŒ–å¥½äº†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> S1 <span class="hljs-keyword">struct</span> &#123;<br>num1 <span class="hljs-type">int16</span><br>num2 <span class="hljs-type">int8</span><br>flag <span class="hljs-type">bool</span><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">æœ¬æ–‡å°†å¸¦æ‚¨å…¨é¢æ·±å…¥åœ°æ¢ç´¢ Go è¯­è¨€ä¸­ç»“æ„ä½“çš„å„ä¸ªæ–¹é¢ï¼Œä»åŸºæœ¬å®šä¹‰ã€åˆå§‹åŒ–å’Œä½¿ç”¨ï¼Œåˆ°é«˜çº§ç‰¹æ€§å¦‚ç»“æ„ä½“çš„ç»„åˆã€æ–¹æ³•å®šä¹‰ã€å†…å­˜å¯¹é½ç­‰ã€‚</summary>
    
    
    
    <category term="Go" scheme="https://hedon.top/categories/Go/"/>
    
    
    <category term="Go" scheme="https://hedon.top/tags/Go/"/>
    
  </entry>
  
  <entry>
    <title>Rust å®æˆ˜ä¸¨HTTPie</title>
    <link href="https://hedon.top/2024/03/06/rust-action-httpie/"/>
    <id>https://hedon.top/2024/03/06/rust-action-httpie/</id>
    <published>2024-03-06T14:22:02.000Z</published>
    <updated>2024-03-06T15:05:03.735Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ¦‚è¿°">æ¦‚è¿°</h1><p>ä¹‹å‰å­¦ä¹ è¿‡ã€Šé™ˆå¤©Â·Rust ç¼–ç¨‹ç¬¬ä¸€è¯¾ - 04ï½œget hands dirtyï¼šæ¥å†™ä¸ªå®ç”¨çš„CLI å°å·¥å…·ã€‹ï¼Œå­¦çš„æ—¶å€™è¿·è¿·ç³Šç³Šã€‚åæ¥åœ¨ç³»ç»Ÿå­¦ä¹ å®Œ Ruståï¼Œé‡æ–°å›è¿‡å¤´æ¥çœ‹è¿™ä¸ªå®æˆ˜å°æ¡ˆä¾‹ï¼ŒåŸºæœ¬ä¸Šéƒ½èƒ½æŒæ¡ï¼Œå¹¶ä¸”æœ‰äº†ä¸€äº›æ–°çš„ç†è§£ã€‚æ‰€ä»¥æˆ‘å†³å®šä»¥ä¸€ä¸ªRust åˆå­¦è€…çš„è§’åº¦ï¼Œå¹¶ä»¥æœ€æ–°ç‰ˆæœ¬çš„ Rustï¼ˆ1.7.6ï¼‰å’Œclapï¼ˆ4.5.1ï¼‰æ¥é‡æ–°å®ç°è¿™ä¸ªæ¡ˆä¾‹ï¼ŒæœŸæœ›èƒ½å¯¹ Rustæ„Ÿå…´è¶£çš„åˆå­¦è€…æä¾›ä¸€äº›å¸®åŠ©ã€‚</p><p>æœ¬æ–‡å°†å®ç°çš„åº”ç”¨å« HTTPieï¼ŒHTTPie æ˜¯ä¸€ä¸ªç”¨ Python ç¼–å†™çš„å‘½ä»¤è¡Œ HTTPå®¢æˆ·ç«¯ï¼Œå…¶ç›®æ ‡æ˜¯ä½¿ CLI ä¸ web æœåŠ¡çš„äº¤äº’å°½å¯èƒ½æ„‰å¿«ã€‚å®ƒè¢«è®¾è®¡ä¸ºä¸€ä¸ª<code>curl</code> å’Œ <code>wget</code>çš„æ›¿ä»£å“ï¼Œæä¾›æ˜“äºä½¿ç”¨çš„ç•Œé¢å’Œä¸€äº›ç”¨æˆ·å‹å¥½çš„åŠŸèƒ½ï¼Œå¦‚ JSONæ”¯æŒã€è¯­æ³•é«˜äº®å’Œæ’ä»¶ã€‚å®ƒå¯¹äºæµ‹è¯•ã€è°ƒè¯•å’Œé€šå¸¸ä¸ HTTP æœåŠ¡å™¨æˆ– RESTful APIè¿›è¡Œäº¤äº‘çš„å¼€å‘äººå‘˜æ¥è¯´éå¸¸æœ‰ç”¨ã€‚</p><p>HTTPie çš„ä¸€äº›å…³é”®ç‰¹æ€§åŒ…æ‹¬ï¼š</p><ol type="1"><li><strong>JSON æ”¯æŒ</strong>ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼ŒHTTPie ä¼šè‡ªåŠ¨å‘é€JSONï¼Œå¹¶ä¸”å¯ä»¥è½»æ¾åœ°é€šè¿‡å‘½ä»¤è¡Œå‘é€ JSON è¯·æ±‚ä½“ã€‚</li><li><strong>è¯­æ³•é«˜äº®</strong>ï¼šå®ƒä¼šä¸º HTTPå“åº”è¾“å‡ºæä¾›è¯­æ³•é«˜äº®æ˜¾ç¤ºï¼Œä½¿å¾—ç»“æœæ›´åŠ æ˜“äºé˜…è¯»ã€‚</li><li><strong>æ’ä»¶</strong>ï¼šHTTPie æ”¯æŒæ’ä»¶ï¼Œå…è®¸æ‰©å±•å…¶æ ¸å¿ƒåŠŸèƒ½ã€‚</li><li><strong>è¡¨å•å’Œæ–‡ä»¶ä¸Šä¼ </strong>ï¼šå¯ä»¥å¾ˆå®¹æ˜“åœ°é€šè¿‡è¡¨å•ä¸Šä¼ æ–‡ä»¶ã€‚</li><li><strong>è‡ªå®šä¹‰ HTTP æ–¹æ³•å’Œå¤´éƒ¨</strong>ï¼šå¯ä»¥å‘é€ä»»ä½• HTTPæ–¹æ³•çš„è¯·æ±‚ï¼Œè‡ªå®šä¹‰è¯·æ±‚å¤´éƒ¨ã€‚</li><li><strong>HTTPSã€ä»£ç†å’Œèº«ä»½éªŒè¯æ”¯æŒ</strong>ï¼šæ”¯æŒ HTTPSè¯·æ±‚ã€ä½¿ç”¨ä»£ç†ä»¥åŠå¤šç§ HTTP èº«ä»½éªŒè¯æœºåˆ¶ã€‚</li><li><strong>æµå¼ä¸Šä¼ å’Œä¸‹è½½</strong>ï¼šæ”¯æŒå¤§æ–‡ä»¶çš„æµå¼ä¸Šä¼ å’Œä¸‹è½½ã€‚</li><li><strong>ä¼šè¯æ”¯æŒ</strong>ï¼šå¯ä»¥ä¿å­˜å’Œé‡ç”¨å¸¸ç”¨çš„è¯·æ±‚å’Œé›†åˆã€‚</li></ol><p>æœ¬æ–‡æˆ‘ä»¬å°†å®ç°å…¶ä¸­çš„ <code>1</code>ã€<code>2</code> å’Œ<code>5</code>ã€‚æˆ‘ä»¬ä¼šæ”¯æŒå‘é€ GET å’Œ POST è¯·æ±‚ï¼Œå…¶ä¸­ POSTæ”¯æŒè®¾ç½®è¯·æ±‚å¤´å’Œ JSON æ•°æ®ã€‚</p><p>åœ¨æœ¬æ–‡ä¸­ï¼Œä½ å¯ä»¥å­¦ä¹ åˆ°ï¼š</p><ul><li>å¦‚ä½•ç”¨ <code>clap</code> è§£æå‘½ä»¤è¡Œå‚æ•°ã€‚</li><li>å¦‚ä½•ç”¨ <code>tokio</code> è¿›è¡Œå¼‚æ­¥ç¼–ç¨‹ã€‚</li><li>å¦‚ä½•ç”¨ <code>reqwest</code> å‘é€ HTTP è¯·æ±‚ã€‚</li><li>å¦‚ä½•ç”¨ <code>colored</code> åœ¨ç»ˆç«¯è¾“å‡ºå¸¦é¢œè‰²çš„å†…å®¹ã€‚</li><li>å¦‚ä½•ç”¨ <code>jsonxf</code> ç¾åŒ– json å­—ç¬¦ä¸²ã€‚</li><li>å¦‚ä½•ç”¨ <code>anyhow</code> é…åˆ <code>?</code> è¿›è¡Œé”™è¯¯ä¼ æ’­ã€‚</li><li>å¦‚ä½•ä½¿ç”¨ <code>HTTPie</code> æ¥è¿›è¡Œ HTTP æ¥å£æµ‹è¯•ã€‚</li></ul><p>åœ¨è¿›è¡Œå®é™…å¼€å‘ä¹‹å‰ï¼Œæ¨èä½ å…ˆäº†è§£ä¸€ä¸‹ï¼š</p><ul><li><a href="https://hedon.top/2024/03/02/rust-crate-reqwest/">Rustreqwest ç®€æ˜æ•™ç¨‹</a></li><li><a href="https://hedon.top/2024/03/05/rust-crate-anyhow/">Rustanyhow ç®€æ˜æ•™ç¨‹</a></li><li><a href="https://hedon.top/2024/03/02/rust-crate-clap/">æ·±å…¥æ¢ç´¢Rust çš„ clap åº“ï¼šå‘½ä»¤è¡Œè§£æçš„è‰ºæœ¯</a></li></ul><p>æœ¬æ–‡å®Œæ•´ä»£ç ï¼š<ahref="https://github.com/hedon954/httpie">hedon954/httpie</a></p><h1 id="å¼€å‘æ€è·¯">å¼€å‘æ€è·¯</h1><h2 id="http-åè®®">HTTP åè®®</h2><p>å›é¡¾ä¸€ä¸‹ HTTP åè®®çš„è¯·æ±‚ä½“å’Œå“åº”ä½“ç»“æ„ã€‚</p><p>è¯·æ±‚ç»“æ„ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240303131157545.png"alt="http request structure" /><figcaption aria-hidden="true">http request structure</figcaption></figure><p>å“åº”ç»“æ„ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240303131123618.png"alt="http response structure" /><figcaption aria-hidden="true">http response structure</figcaption></figure><h2 id="å‘½ä»¤åˆ†æ">å‘½ä»¤åˆ†æ</h2><p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°±å®ç° HTTPie cli å®˜æ–¹çš„è¿™ä¸ª<ahref="https://github.com/httpie/cli?tab=readme-ov-file#examples">ç¤ºä¾‹</a>ï¼šå³å…è®¸æŒ‡å®šè¯·æ±‚æ–¹æ³•ã€æºå¸¦headers å’Œ json æ•°æ®å‘é€è¯·æ±‚ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240303131445159.png"alt="HTTPie å®˜æ–¹ç¤ºä¾‹" /><figcaption aria-hidden="true">HTTPie å®˜æ–¹ç¤ºä¾‹</figcaption></figure><p>æˆ‘ä»¬æ¥æ‹†è§£ä¸€ä¸‹ï¼Œè¿™ä¸ªå‘½ä»¤å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tex">httpie &lt;METHOD&gt; &lt;URL&gt; [headers | params]...<br></code></pre></td></tr></table></figure><ul><li><code>&lt;METHOD&gt;</code>: è¯·æ±‚æ–¹æ³•ï¼Œæœ¬æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬ä»…æ”¯æŒ GET å’ŒPOSTã€‚</li><li><code>&lt;URL&gt;</code>: è¯·æ±‚åœ°å€ã€‚</li><li><code>&lt;HEADERS&gt;</code>: è¯·æ±‚å¤´ï¼Œæ ¼å¼ä¸º<code>h1:v1</code>ã€‚</li><li><code>&lt;PARAMS&gt;</code>: è¯·æ±‚å‚æ•°ï¼Œæ ¼å¼ä¸º<code>k1=v1</code>ï¼Œæœ€ç»ˆä»¥ json ç»“æ„å‘é€ã€‚</li></ul><h2 id="æ•ˆæœå±•ç¤º">æ•ˆæœå±•ç¤º</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  httpie git:(master) âœ— ./Httpie --<span class="hljs-built_in">help</span>                                              <br>Usage: Httpie &lt;COMMAND&gt;<br><br>Commands:<br>  get   <br>  post  <br>  <span class="hljs-built_in">help</span>  Print this message or the <span class="hljs-built_in">help</span> of the given subcommand(s)<br><br>Options:<br>  -h, --<span class="hljs-built_in">help</span>     Print <span class="hljs-built_in">help</span><br>  -V, --version  Print version<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ post å­å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">Usage: Httpie post &lt;URL&gt; &lt;BODY&gt;...<br><br>Arguments:<br>  &lt;URL&gt;      Specify the url you wanna request to<br>  &lt;BODY&gt;...  Set the request body. Examples: headers: header1:value1 params: key1=value1<br><br>Options:<br>  -h, --<span class="hljs-built_in">help</span>  Print <span class="hljs-built_in">help</span><br></code></pre></td></tr></table></figure><p>è¯·æ±‚ç¤ºä¾‹ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240305225846224.png"alt="httpie response demo" /><figcaption aria-hidden="true">httpie response demo</figcaption></figure><h2 id="æ€è·¯æ¢³ç†">æ€è·¯æ¢³ç†</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240306223319742.png"alt="httpie å¼€å‘æ€è·¯æ¢³ç†" /><figcaption aria-hidden="true">httpie å¼€å‘æ€è·¯æ¢³ç†</figcaption></figure><p><strong>ç¬¬ 1 æ­¥ï¼šè§£æå‘½ä»¤è¡Œå‚æ•°</strong></p><p>æœ¬æ¡ˆä¾‹ä¸­ httpie æ”¯æŒ 2 ä¸ªå­å‘½ä»¤ï¼š</p><ul><li>get æ”¯æŒ url å‚æ•°</li><li>post æ”¯æŒ urlã€body å‚æ•°ï¼Œå› ä¸ºå…¶ä¸­ headers å’Œ paramsæ˜¯å˜é•¿çš„ï¼Œæˆ‘ä»¬ç»Ÿä¸€ç”¨ <code>Vec&lt;String&gt;</code> ç±»å‹çš„ bodyæ¥æ¥æ”¶ï¼Œç„¶åç”¨ <code>:</code> å’Œ <code>=</code> æ¥åŒºåˆ†å®ƒä»¬ã€‚</li></ul><p><strong>ç¬¬ 2 æ­¥ï¼šå‘é€è¯·æ±‚</strong></p><ol type="1"><li>ä½¿ç”¨ reqwest åˆ›å»º http clientï¼›</li><li>è®¾ç½® urlï¼›</li><li>è®¾ç½® methodï¼›</li><li>è®¾ç½® headersï¼›</li><li>è®¾ç½® paramsï¼›</li><li>å‘é€è¯·æ±‚ï¼›</li><li>è·å–å“åº”ä½“ã€‚</li></ol><p><strong>ç¬¬ 3 æ­¥ï¼šæ‰“å°å“åº”</strong></p><ol type="1"><li>æ‰“å° http version å’Œ statusï¼Œå¹¶ä½¿ç”¨ colored èµ‹äºˆè“è‰²ï¼›</li><li>æ‰“å° response headersï¼Œå¹¶ä½¿ç”¨ colored èµ‹äºˆç»¿è‰²ï¼›</li><li>ç¡®å®š content-typeï¼Œå¦‚æœæ˜¯ jsonï¼Œæˆ‘ä»¬å°±ç”¨ jsonxf ç¾åŒ– json ä¸²å¹¶ä½¿ç”¨colored èµ‹äºˆè“ç»¿è‰²è¾“å‡ºï¼Œå¦‚æœæ˜¯å…¶ä»–ç±»å‹ï¼Œè¿™é‡Œæˆ‘ä»¬å°±è¾“å‡ºåŸæ–‡å³å¯ã€‚</li></ol><h1 id="å®æˆ˜è¿‡ç¨‹">å®æˆ˜è¿‡ç¨‹</h1><h2 id="åˆ›å»ºé¡¹ç›®">1. åˆ›å»ºé¡¹ç›®</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo new httpie<br></code></pre></td></tr></table></figure><h2 id="æ·»åŠ ä¾èµ–">2. æ·»åŠ ä¾èµ–</h2><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs toml"><span class="hljs-section">[package]</span><br><span class="hljs-attr">name</span> = <span class="hljs-string">&quot;httpie&quot;</span><br><span class="hljs-attr">version</span> = <span class="hljs-string">&quot;0.1.0&quot;</span><br><span class="hljs-attr">edition</span> = <span class="hljs-string">&quot;2021&quot;</span><br><br><span class="hljs-section">[dependencies]</span><br><span class="hljs-attr">anyhow</span> = <span class="hljs-string">&quot;1.0.80&quot;</span><br><span class="hljs-attr">clap</span> = &#123; version = <span class="hljs-string">&quot;4.5.1&quot;</span>, features = [<span class="hljs-string">&quot;derive&quot;</span>] &#125;<br><span class="hljs-attr">colored</span> = <span class="hljs-string">&quot;2.1.0&quot;</span><br><span class="hljs-attr">jsonxf</span> = <span class="hljs-string">&quot;1.1.1&quot;</span><br><span class="hljs-attr">mime</span> = <span class="hljs-string">&quot;0.3.17&quot;</span><br><span class="hljs-attr">reqwest</span> = &#123; version = <span class="hljs-string">&quot;0.11.24&quot;</span>, features = [<span class="hljs-string">&quot;json&quot;</span>] &#125;<br><span class="hljs-attr">tokio</span> = &#123; version = <span class="hljs-string">&quot;1.36.0&quot;</span>, features = [<span class="hljs-string">&quot;rt&quot;</span>, <span class="hljs-string">&quot;rt-multi-thread&quot;</span>, <span class="hljs-string">&quot;macros&quot;</span>] &#125;<br></code></pre></td></tr></table></figure><ul><li><code>anyhow</code>: ç”¨äºç®€åŒ–å¼‚å¸¸å¤„ç†ã€‚</li><li><code>clap</code>: è§£æå‘½ä»¤è¡Œå‚æ•°ã€‚</li><li><code>colored</code>: ä¸ºç»ˆç«¯è¾“å‡ºå†…å®¹èµ‹äºˆé¢œè‰²ã€‚</li><li><code>jsonxf</code>: ç¾åŒ– json ä¸²ã€‚</li><li><code>mime</code>: æä¾›äº†å„ç§ Media Type çš„ç±»å‹å°è£…ã€‚</li><li><code>reqwest</code>: http å®¢æˆ·ç«¯ã€‚</li><li><code>tokio</code>: å¼‚æ­¥åº“ï¼Œæœ¬æ¡ˆä¾‹ç§æˆ‘ä»¬ä½¿ç”¨ reqwestçš„å¼‚æ­¥åŠŸèƒ½ã€‚</li></ul><h2 id="å®Œæ•´æºç ">3. å®Œæ•´æºç </h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// src/main.rs  ä¸ºå‡å°ç¯‡å¹…ï¼Œçœç•¥äº†å•å…ƒæµ‹è¯•ï¼Œè¯»è€…å¯è‡ªè¡Œè¡¥å……ã€‚</span><br><span class="hljs-keyword">use</span> std::collections::HashMap;<br><span class="hljs-keyword">use</span> reqwest::&#123;Client, header, Response&#125;;<br><span class="hljs-keyword">use</span> std::<span class="hljs-type">str</span>::FromStr;<br><span class="hljs-keyword">use</span> anyhow::anyhow;<br><span class="hljs-keyword">use</span> clap::&#123;Args, Parser, Subcommand&#125;;<br><span class="hljs-keyword">use</span> colored::Colorize;<br><span class="hljs-keyword">use</span> mime::Mime;<br><span class="hljs-keyword">use</span> reqwest::header::&#123;HeaderMap, HeaderName, HeaderValue&#125;;<br><span class="hljs-keyword">use</span> reqwest::Url;<br><br><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(version, author, about, long_about = None)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Httpie</span> &#123;<br>    <span class="hljs-meta">#[command(subcommand)]</span><br>    methods: Method,<br>&#125;<br><br><span class="hljs-meta">#[derive(Subcommand)]</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Method</span> &#123;<br>    <span class="hljs-title function_ invoke__">Get</span>(Get),<br>    <span class="hljs-title function_ invoke__">Post</span>(Post)<br>&#125;<br><br><span class="hljs-meta">#[derive(Args)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Get</span> &#123;<br>    <span class="hljs-meta">#[arg(value_parser = parse_url)]</span><br>    url: <span class="hljs-type">String</span>,<br>&#125;<br><br><span class="hljs-meta">#[derive(Args)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Post</span> &#123;<br>    <span class="hljs-comment">/// Specify the url you wanna request to.</span><br>    <span class="hljs-meta">#[arg(value_parser = parse_url)]</span><br>    url: <span class="hljs-type">String</span>,<br><br>    <span class="hljs-comment">/// Set the request body.</span><br>    <span class="hljs-comment">/// Examples:</span><br>    <span class="hljs-comment">///     headers:</span><br>    <span class="hljs-comment">///         header1:value1</span><br>    <span class="hljs-comment">///     params:</span><br>    <span class="hljs-comment">///         key1=value1</span><br>    <span class="hljs-meta">#[arg(required = true, value_parser = parse_kv_pairs)]</span><br>    body: <span class="hljs-type">Vec</span>&lt;KvPair&gt;<br>&#125;<br><br><span class="hljs-meta">#[derive(Debug, Clone)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">KvPair</span> &#123;<br>    k: <span class="hljs-type">String</span>,<br>    v: <span class="hljs-type">String</span>,<br>    t: KvPairType,<br>&#125;<br><br><span class="hljs-meta">#[derive(Debug,Clone)]</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">KvPairType</span> &#123;<br>    Header,<br>    Param,<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">FromStr</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">KvPair</span> &#123;<br>    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Err</span> = anyhow::Error;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from_str</span>(s: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-keyword">Self</span>, <span class="hljs-keyword">Self</span>::<span class="hljs-literal">Err</span>&gt; &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">pair_type</span>: KvPairType;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">split_char</span> = <span class="hljs-keyword">if</span> s.<span class="hljs-title function_ invoke__">contains</span>(<span class="hljs-string">&#x27;:&#x27;</span>) &#123;<br>            pair_type = KvPairType::Header;<br>            <span class="hljs-string">&#x27;:&#x27;</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            pair_type = KvPairType::Param;<br>            <span class="hljs-string">&#x27;=&#x27;</span><br>        &#125;;<br><br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">split</span> = s.<span class="hljs-title function_ invoke__">split</span>(split_char);<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">err</span> = || anyhow!(<span class="hljs-built_in">format!</span>(<span class="hljs-string">&quot;failed to parse pairs &#123;&#125;&quot;</span>,s));<br>        <span class="hljs-title function_ invoke__">Ok</span>(<span class="hljs-keyword">Self</span> &#123;<br>            k: (split.<span class="hljs-title function_ invoke__">next</span>().<span class="hljs-title function_ invoke__">ok_or_else</span>(err)?).<span class="hljs-title function_ invoke__">to_string</span>(),<br>            v: (split.<span class="hljs-title function_ invoke__">next</span>().<span class="hljs-title function_ invoke__">ok_or_else</span>(err)?).<span class="hljs-title function_ invoke__">to_string</span>(),<br>            t: pair_type,<br>        &#125;)<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">parse_url</span>(s: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> anyhow::<span class="hljs-type">Result</span>&lt;<span class="hljs-type">String</span>&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">_url</span>: Url = s.<span class="hljs-title function_ invoke__">parse</span>()?;<br>    <span class="hljs-title function_ invoke__">Ok</span>(s.<span class="hljs-title function_ invoke__">into</span>())<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">parse_kv_pairs</span>(s: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> anyhow::<span class="hljs-type">Result</span>&lt;KvPair&gt; &#123;<br>    <span class="hljs-title function_ invoke__">Ok</span>(s.<span class="hljs-title function_ invoke__">parse</span>()?)<br>&#125;<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get</span>(client: Client, args: &amp;Get) <span class="hljs-punctuation">-&gt;</span> anyhow::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>   <span class="hljs-keyword">let</span> <span class="hljs-variable">resp</span> = client.<span class="hljs-title function_ invoke__">get</span>(&amp;args.url).<span class="hljs-title function_ invoke__">send</span>().<span class="hljs-keyword">await</span>?;<br>    <span class="hljs-title function_ invoke__">Ok</span>(<span class="hljs-title function_ invoke__">print_resp</span>(resp).<span class="hljs-keyword">await</span>?)<br>&#125;<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">post</span>(client: Client, args: &amp;Post) <span class="hljs-punctuation">-&gt;</span> anyhow::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">body</span> = HashMap::<span class="hljs-title function_ invoke__">new</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">header_map</span> = HeaderMap::<span class="hljs-title function_ invoke__">new</span>();<br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">pair</span> <span class="hljs-keyword">in</span> args.body.<span class="hljs-title function_ invoke__">iter</span>() &#123;<br>        <span class="hljs-keyword">match</span> pair.t &#123;<br>            KvPairType::Param =&gt;  &#123;body.<span class="hljs-title function_ invoke__">insert</span>(&amp;pair.k, &amp;pair.v);&#125;<br>            KvPairType::Header =&gt; &#123;<br>                <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Ok</span>(name) = HeaderName::<span class="hljs-title function_ invoke__">from_str</span>(pair.k.<span class="hljs-title function_ invoke__">as_str</span>()) &#123;<br>                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Ok</span>(value) = HeaderValue::<span class="hljs-title function_ invoke__">from_str</span>(pair.v.<span class="hljs-title function_ invoke__">as_str</span>()) &#123;<br>                        header_map.<span class="hljs-title function_ invoke__">insert</span>(name,value);<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Invalid header value for key: &#123;&#125;&quot;</span>, pair.v);<br>                    &#125;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Invalid header key: &#123;&#125;&quot;</span>, pair.k);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">resp</span> = client.<span class="hljs-title function_ invoke__">post</span>(&amp;args.url)<br>        .<span class="hljs-title function_ invoke__">headers</span>(header_map)<br>        .<span class="hljs-title function_ invoke__">json</span>(&amp;body).<span class="hljs-title function_ invoke__">send</span>().<span class="hljs-keyword">await</span>?;<br>    <span class="hljs-title function_ invoke__">Ok</span>(<span class="hljs-title function_ invoke__">print_resp</span>(resp).<span class="hljs-keyword">await</span>?)<br>&#125;<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">print_resp</span>(resp: Response) <span class="hljs-punctuation">-&gt;</span> anyhow::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-title function_ invoke__">print_status</span>(&amp;resp);<br>    <span class="hljs-title function_ invoke__">print_headers</span>(&amp;resp);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">mime</span> = <span class="hljs-title function_ invoke__">get_content_type</span>(&amp;resp);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">body</span> = resp.<span class="hljs-title function_ invoke__">text</span>().<span class="hljs-keyword">await</span>?;<br>    <span class="hljs-title function_ invoke__">print_body</span>(mime, &amp;body);<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">print_status</span>(resp: &amp;Response) &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">status</span> = <span class="hljs-built_in">format!</span>(<span class="hljs-string">&quot;&#123;:?&#125; &#123;&#125;&quot;</span>, resp.<span class="hljs-title function_ invoke__">version</span>(), resp.<span class="hljs-title function_ invoke__">status</span>()).<span class="hljs-title function_ invoke__">blue</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;\n&quot;</span>, status);<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">print_headers</span>(resp: &amp;Response) &#123;<br>    <span class="hljs-keyword">for</span> (k,v) <span class="hljs-keyword">in</span> resp.<span class="hljs-title function_ invoke__">headers</span>() &#123;<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;: &#123;:?&#125;&quot;</span>, k.<span class="hljs-title function_ invoke__">to_string</span>().<span class="hljs-title function_ invoke__">green</span>(), v);<br>    &#125;<br>    <span class="hljs-built_in">print!</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">print_body</span>(mime: <span class="hljs-type">Option</span>&lt;Mime&gt;, resp: &amp;<span class="hljs-type">String</span>) &#123;<br>    <span class="hljs-keyword">match</span> mime &#123;<br>        <span class="hljs-title function_ invoke__">Some</span>(v) =&gt; &#123;<br>            <span class="hljs-keyword">if</span> v == mime::APPLICATION_JSON &#123;<br>                <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, jsonxf::<span class="hljs-title function_ invoke__">pretty_print</span>(resp).<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-title function_ invoke__">cyan</span>())<br>            &#125;<br>        &#125;<br>        _ =&gt; <span class="hljs-built_in">print!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, resp),<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_content_type</span>(resp: &amp;Response) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;Mime&gt; &#123;<br>    resp.<span class="hljs-title function_ invoke__">headers</span>()<br>        .<span class="hljs-title function_ invoke__">get</span>(header::CONTENT_TYPE)<br>        .<span class="hljs-title function_ invoke__">map</span>(|v|v.<span class="hljs-title function_ invoke__">to_str</span>().<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-title function_ invoke__">parse</span>().<span class="hljs-title function_ invoke__">unwrap</span>())<br>&#125;<br><br><span class="hljs-meta">#[tokio::main]</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-&gt;</span> anyhow::<span class="hljs-type">Result</span>&lt;()&gt;&#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">httpie</span> = Httpie::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">client</span> = Client::<span class="hljs-title function_ invoke__">new</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">result</span> = <span class="hljs-keyword">match</span> httpie.methods &#123;<br>        Method::<span class="hljs-title function_ invoke__">Get</span>(<span class="hljs-keyword">ref</span> args) =&gt; <span class="hljs-title function_ invoke__">get</span>(client, args).<span class="hljs-keyword">await</span>?,<br>        Method::<span class="hljs-title function_ invoke__">Post</span>(<span class="hljs-keyword">ref</span> args) =&gt; <span class="hljs-title function_ invoke__">post</span>(client, args).<span class="hljs-keyword">await</span>?,<br>    &#125;;<br>    <span class="hljs-title function_ invoke__">Ok</span>(result)<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå³ä½¿ç®—ä¸Š <code>use</code> éƒ¨åˆ†ï¼Œæ€»ä»£ç ä¹Ÿä¸è¿‡160è¡Œå·¦å³ï¼ŒRust çš„ <code>clap</code> åº“åœ¨ CLI å¼€å‘ä¸Šç¡®å® yydsï¼</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä¸€ä¸€æ‹†è§£è¿™éƒ¨åˆ†çš„ä»£ç ï¼Œå…¶ä¸­å…³äº <code>clap</code>çš„éƒ¨åˆ†æˆ‘ä¸ä¼šè¿‡å¤šå±•å¼€ï¼Œåˆšå…´è¶£çš„è¯»è€…å¯ä»¥å‚é˜…ï¼š<ahref="https://hedon.top/2024/03/02/rust-crate-clap/">æ·±å…¥æ¢ç´¢ Rust çš„clap åº“ï¼šå‘½ä»¤è¡Œè§£æçš„è‰ºæœ¯</a>ã€‚</p><h3 id="å‘½ä»¤è¡Œè§£æ">3.1 å‘½ä»¤è¡Œè§£æ</h3><p>æˆ‘ä»¬å…ˆä» <code>main()</code> å¼€å§‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[tokio::main]</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-&gt;</span> anyhow::<span class="hljs-type">Result</span>&lt;()&gt;&#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">httpie</span> = Httpie::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">client</span> = Client::<span class="hljs-title function_ invoke__">new</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">result</span> = <span class="hljs-keyword">match</span> httpie.methods &#123;<br>        Method::<span class="hljs-title function_ invoke__">Get</span>(<span class="hljs-keyword">ref</span> args) =&gt; <span class="hljs-title function_ invoke__">get</span>(client, args).<span class="hljs-keyword">await</span>?,<br>        Method::<span class="hljs-title function_ invoke__">Post</span>(<span class="hljs-keyword">ref</span> args) =&gt; <span class="hljs-title function_ invoke__">post</span>(client, args).<span class="hljs-keyword">await</span>?,<br>    &#125;;<br>    <span class="hljs-title function_ invoke__">Ok</span>(result)<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¸Œæœ›ä½¿ç”¨ <code>clap</code> çš„å¼‚æ­¥åŠŸèƒ½ï¼Œæ‰€ä»¥ä½¿ç”¨äº†<code>async</code> å…³é”®å­—ï¼ŒåŒæ—¶åŠ ä¸Šäº† <code>tokio</code> æä¾›çš„å±æ€§å®<code>#[tokio::main]</code>ï¼Œç”¨äºè®¾ç½®å¼‚æ­¥ç¯å¢ƒã€‚ä¸ºäº†èƒ½å¤Ÿä½¿ç”¨<code>?</code> å¿«é€Ÿä¼ æ’­é”™è¯¯ï¼Œæˆ‘ä»¬è®¾ç½®è¿”å›å€¼ä¸º<code>anyhow::Result&lt;()&gt;</code>ï¼Œæœ¬é¡¹ç›®ä¸­æˆ‘ä»¬ä¸å¯¹é”™è¯¯è¿›è¡Œè¿‡å¤šå¤„ç†ï¼Œæ‰€ä»¥è¿™ç§æ–¹å¼å¯ä»¥å¤§å¤§ç®€åŒ–æˆ‘ä»¬çš„é”™è¯¯å¤„ç†è¿‡ç¨‹ã€‚</p><p><code>main()</code> ä¸­æˆ‘ä»¬ä½¿ç”¨ <code>Httpie::parse()</code>è§£æå‘½ä»¤è¡Œä¸­çš„å‚æ•°ï¼Œä½¿ç”¨ <code>Client::new()</code> åˆ›å»ºä¸€ä¸ª httpclientï¼Œæ ¹æ®è§£æåˆ°çš„å‘½ä»¤è¡Œå‚æ•°ï¼Œæˆ‘ä»¬åŒ¹é…å­å‘½ä»¤<code>methods</code>ï¼Œåˆ†åˆ«è°ƒç”¨ <code>get()</code> å’Œ <code>post()</code>æ¥å‘é€ GET å’Œ POST è¯·æ±‚ã€‚</p><p><code>Httpie</code> çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(version, author, about, long_about = None)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Httpie</span> &#123;<br>    <span class="hljs-meta">#[command(subcommand)]</span><br>    methods: Method,<br>&#125;<br></code></pre></td></tr></table></figure><p><code>#[derive(Parser)]</code> æ˜¯ä¸€ä¸ªè¿‡ç¨‹å®ï¼ˆproceduralmacroï¼‰ï¼Œç”¨äºè‡ªåŠ¨ä¸ºç»“æ„ä½“å®ç° <code>clap::Parser</code>traitã€‚è¿™ä½¿å¾—è¯¥ç»“æ„ä½“å¯ä»¥ç”¨æ¥è§£æå‘½ä»¤è¡Œå‚æ•°ã€‚</p><p>åœ¨ <code>Httpie</code> ä¸­æˆ‘ä»¬å®šä¹‰äº†å­å‘½ä»¤ <code>Method</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[derive(Subcommand)]</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Method</span> &#123;<br>    <span class="hljs-title function_ invoke__">Get</span>(Get),<br>    <span class="hljs-title function_ invoke__">Post</span>(Post)<br>&#125;<br></code></pre></td></tr></table></figure><p><code>#[derive(Subcommand)]</code>å±æ€§å®ä¼šè‡ªåŠ¨ä¸ºæšä¸¾æ´¾ç”Ÿä¸€äº›ä»£ç ï¼Œä»¥ä¾¿å®ƒå¯ä»¥ä½œä¸ºå­å‘½ä»¤æ¥è§£æå‘½ä»¤è¡Œå‚æ•°ã€‚ç›®å‰æ”¯æŒ<code>Get</code> å’Œ <code>Post</code> ä¸¤ä¸ªå­å‘½ä»¤ï¼Œå®ƒä»¬åˆ†åˆ«æ¥æ”¶<code>Get</code> å’Œ <code>Post</code> å‚æ•°ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[derive(Args)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Get</span> &#123;<br>    <span class="hljs-meta">#[arg(value_parser = parse_url)]</span><br>    url: <span class="hljs-type">String</span>,<br>&#125;<br><br><span class="hljs-meta">#[derive(Args)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Post</span> &#123;<br>    <span class="hljs-meta">#[arg(value_parser = parse_url)]</span><br>    url: <span class="hljs-type">String</span>,<br>  <br>    <span class="hljs-meta">#[arg(value_parser = parse_kv_pairs)]</span><br>    body: <span class="hljs-type">Vec</span>&lt;KvPair&gt;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>#[derive(Args)]</code> å±æ€§å®è¡¨æ˜å½“å‰ struct æ˜¯å‘½ä»¤çš„å‚æ•°ï¼Œå…¶ä¸­<code>Get</code> ä»…æ”¯æŒ <code>url</code> å‚æ•°ï¼Œ<code>Post</code> æ”¯æŒ<code>url</code> å’Œ <code>body</code> å‚æ•°ã€‚</p><p><code>url</code> å‚æ•°æˆ‘ä»¬ä½¿ç”¨ <code>parse_url</code>å‡½æ•°æ¥è¿›è¡Œè§£æï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> reqwest::Url;<br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">parse_url</span>(s: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> anyhow::<span class="hljs-type">Result</span>&lt;<span class="hljs-type">String</span>&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">_url</span>: Url = s.<span class="hljs-title function_ invoke__">parse</span>()?;<br>    <span class="hljs-title function_ invoke__">Ok</span>(s.<span class="hljs-title function_ invoke__">into</span>())<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œ <code>reqwest::Url</code> å·²ç»å®ç°äº† <code>FromStr</code>traitï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è°ƒç”¨ <code>s.parse()</code> æ¥è§£æ<code>url</code>ã€‚</p><p>è€Œ <code>body</code>ï¼Œå› ä¸ºæˆ‘ä»¬æœŸæœ› CLI ä½¿ç”¨èµ·æ¥åƒï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">httpie url header1:value1 param1=v1<br></code></pre></td></tr></table></figure><p><code>body</code> å°±æ˜¯ <code>header1:value1 param1=v1</code>ï¼Œä¸€å¯¹ kvå°±ä»£è¡¨ç€ä¸€ä¸ª header æˆ–è€… paramï¼Œç”¨ <code>:</code> å’Œ <code>=</code>æ¥åŒºåˆ†ã€‚å› ä¸º kv å¯¹çš„ä¸ªæ•°çš„å˜é•¿çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨<code>Vec&lt;KvPair&gt;</code> æ¥æ¥æ”¶ <code>body</code> è¿™ä¸ªå‚æ•°ï¼Œå¹¶ä½¿ç”¨<code>parse_kv_pairs</code> æ¥è§£æ kv å¯¹ã€‚</p><p><code>KvPair</code> æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„ç±»å‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[derive(Debug, Clone)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">KvPair</span> &#123;<br>    k: <span class="hljs-type">String</span>,<br>    v: <span class="hljs-type">String</span>,<br>    t: KvPairType,<br>&#125;<br><br><span class="hljs-meta">#[derive(Debug,Clone)]</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">KvPairType</span> &#123;<br>    Header,<br>    Param,<br>&#125;<br></code></pre></td></tr></table></figure><p><code>parse_kv_pairs</code> çš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">parse_kv_pairs</span>(s: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> anyhow::<span class="hljs-type">Result</span>&lt;KvPair&gt; &#123;<br>    <span class="hljs-title function_ invoke__">Ok</span>(s.<span class="hljs-title function_ invoke__">parse</span>()?)<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œï¼Œä½ å¯ä»¥åœ¨ <code>parse_kv_pairs()</code> å‡½æ•°ä¸­ï¼Œå¯¹<code>s</code> è¿›è¡Œè§£æå¹¶è¿”å›<code>anyhow::Result&lt;KvPair&gt;</code>ã€‚ä¸è¿‡ï¼Œæ›´ä¼˜é›…ï¼Œæ›´ç»Ÿä¸€çš„æ–¹å¼æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå°±æ˜¯åƒ<code>reqwest::Url</code> ä¸€æ ·ï¼Œä¸º <code>KvPair</code> å®ç°<code>FromStr</code> traitï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥è°ƒç”¨ <code>s.parse()</code>æ¥è¿›è¡Œè§£æäº†ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">FromStr</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">KvPair</span> &#123;<br>    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Err</span> = anyhow::Error;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from_str</span>(s: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-keyword">Self</span>, <span class="hljs-keyword">Self</span>::<span class="hljs-literal">Err</span>&gt; &#123;<br>        ...<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å‘é€è¯·æ±‚">3.2 å‘é€è¯·æ±‚</h3><p>å‚æ•°è§£æå®Œï¼Œå°±åˆ°äº†å‘é€è¯·æ±‚çš„åœ°æ–¹äº†ï¼Œè¿™é‡Œä½¿ç”¨ <code>reqwest</code>crate å°±éå¸¸æ–¹ä¾¿äº†ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ï¼Œå…·ä½“å¯ä»¥å‚è€ƒï¼š<ahref="https://hedon.top/2024/03/02/rust-crate-reqwest/">Rust reqwestç®€æ˜æ•™ç¨‹</a>ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get</span>(client: Client, args: &amp;Get) <span class="hljs-punctuation">-&gt;</span> anyhow::<span class="hljs-type">Result</span>&lt;()&gt; &#123; ... &#125;<br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">post</span>(client: Client, args: &amp;Post) <span class="hljs-punctuation">-&gt;</span> anyhow::<span class="hljs-type">Result</span>&lt;()&gt; &#123; ... &#125;<br></code></pre></td></tr></table></figure><h3 id="æ‰“å°å“åº”">3.3 æ‰“å°å“åº”</h3><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240305225846224.png"alt="httpie response demo" /><figcaption aria-hidden="true">httpie response demo</figcaption></figure><p>å“åº”åˆ†ä¸º 3 ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>print_status()</li><li>print_headers()</li><li>print_body()</li></ul><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">print_resp</span>(resp: Response) <span class="hljs-punctuation">-&gt;</span> anyhow::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-title function_ invoke__">print_status</span>(&amp;resp);<br>    <span class="hljs-title function_ invoke__">print_headers</span>(&amp;resp);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">mime</span> = <span class="hljs-title function_ invoke__">get_content_type</span>(&amp;resp);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">body</span> = resp.<span class="hljs-title function_ invoke__">text</span>().<span class="hljs-keyword">await</span>?;<br>    <span class="hljs-title function_ invoke__">print_body</span>(mime, &amp;body);<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></td></tr></table></figure><p><code>print_status()</code> æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯æ‰“å° HTTPç‰ˆæœ¬å’Œå“åº”çŠ¶æ€ç ï¼Œç„¶åæˆ‘ä»¬ä½¿ç”¨ <code>colored</code> crate çš„<code>blue()</code> ä½¿å…¶åœ¨ç»ˆç«¯ä»¥<font color="blue">è“è‰²</font>è¾“å‡ºã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">print_status</span>(resp: &amp;Response) &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">status</span> = <span class="hljs-built_in">format!</span>(<span class="hljs-string">&quot;&#123;:?&#125; &#123;&#125;&quot;</span>, resp.<span class="hljs-title function_ invoke__">version</span>(), resp.<span class="hljs-title function_ invoke__">status</span>()).<span class="hljs-title function_ invoke__">blue</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;\n&quot;</span>, status);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>print_headers()</code> ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>green()</code> ä½¿header_name åœ¨ç»ˆç«¯ä»¥<font color="green">ç»¿è‰²</font>è¾“å‡ºã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">print_headers</span>(resp: &amp;Response) &#123;<br>    <span class="hljs-keyword">for</span> (k,v) <span class="hljs-keyword">in</span> resp.<span class="hljs-title function_ invoke__">headers</span>() &#123;<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;: &#123;:?&#125;&quot;</span>, k.<span class="hljs-title function_ invoke__">to_string</span>().<span class="hljs-title function_ invoke__">green</span>(), v);<br>    &#125;<br>    <span class="hljs-built_in">print!</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>å“åº”ä½“çš„æ ¼å¼ï¼ˆMedia Typeï¼‰æœ‰å¾ˆå¤šï¼Œæœ¬æ¡ˆä¾‹ä¸­æˆ‘ä»¬ä»…æ”¯æŒ<code>application/json</code>ï¼Œæ‰€ä»¥åœ¨ <code>print_body()</code>ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆè¯»å– response header ä¸­çš„ content-typeï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_content_type</span>(resp: &amp;Response) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;Mime&gt; &#123;<br>    resp.<span class="hljs-title function_ invoke__">headers</span>()<br>        .<span class="hljs-title function_ invoke__">get</span>(header::CONTENT_TYPE)<br>        .<span class="hljs-title function_ invoke__">map</span>(|v|v.<span class="hljs-title function_ invoke__">to_str</span>().<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-title function_ invoke__">parse</span>().<span class="hljs-title function_ invoke__">unwrap</span>())<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ <code>print_resp()</code> ä¸­ï¼Œå¯¹äº<code>application/json</code>ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>jsonxf</code> crateå¯¹è¿›è¡Œç¾åŒ–ï¼Œå¹¶ä½¿ç”¨ <code>cyan()</code>ä½¿å…¶åœ¨ç»ˆç«¯ä»¥<font color="cyan">è“ç»¿è‰²</font>è¾“å‡ºã€‚å¯¹äºå…¶ä»–ç±»å‹ï¼Œæˆ‘ä»¬å§‘ä¸”ç…§åŸæ–‡è¾“å‡ºã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">print_body</span>(mime: <span class="hljs-type">Option</span>&lt;Mime&gt;, resp: &amp;<span class="hljs-type">String</span>) &#123;<br>    <span class="hljs-keyword">match</span> mime &#123;<br>        <span class="hljs-title function_ invoke__">Some</span>(v) =&gt; &#123;<br>            <span class="hljs-keyword">if</span> v == mime::APPLICATION_JSON &#123;<br>                <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, jsonxf::<span class="hljs-title function_ invoke__">pretty_print</span>(resp).<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-title function_ invoke__">cyan</span>())<br>            &#125;<br>        &#125;<br>        _ =&gt; <span class="hljs-built_in">print!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, resp),<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="æ€»ç»“">æ€»ç»“</h1><p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬æ·±å…¥æ¢è®¨äº†å¦‚ä½•ä½¿ç”¨ Rust è¯­è¨€æ¥å®ç°ä¸€ä¸ªç±»ä¼¼äº HTTPieçš„å‘½ä»¤è¡Œå·¥å…·ã€‚è¿™ä¸ªè¿‡ç¨‹åŒ…æ‹¬äº†å¯¹ HTTP åè®®çš„ç†è§£ã€å‘½ä»¤è¡Œå‚æ•°çš„è§£æã€HTTPå®¢æˆ·ç«¯çš„åˆ›å»ºå’Œè¯·æ±‚å‘é€ï¼Œä»¥åŠå¯¹å“åº”çš„å¤„ç†å’Œå±•ç¤ºã€‚é€šè¿‡æœ¬æ–‡ï¼Œè¯»è€…ä¸ä»…èƒ½å¤Ÿè·å¾—ä¸€ä¸ªå®ç”¨çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œè¿˜èƒ½å¤Ÿå­¦ä¹ åˆ°å¦‚ä½•ä½¿ç”¨Rust çš„åº“æ¥æ„å»ºå®é™…çš„åº”ç”¨ç¨‹åºï¼ŒåŒ…æ‹¬<code>clap</code>ã€<code>reqwest</code>ã€<code>tokio</code> å’Œ<code>colored</code> ç­‰ã€‚æ­¤å¤–ï¼Œæ–‡ç« ä¹Ÿè¯´æ˜äº†åœ¨ Rustä¸­è¿›è¡Œå¼‚æ­¥ç¼–ç¨‹å’Œé”™è¯¯å¤„ç†çš„ä¸€äº›å¸¸è§æ¨¡å¼ã€‚å°½ç®¡ç¤ºä¾‹ä»£ç çš„é”™è¯¯å¤„ç†è¾ƒä¸ºç®€å•ï¼Œä½†å®ƒæä¾›äº†ä¸€ä¸ªè‰¯å¥½çš„èµ·ç‚¹ï¼Œå¼€å‘è€…å¯ä»¥åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œæ‰©å±•å’Œæ”¹è¿›ï¼Œä»¥é€‚åº”æ›´å¤æ‚çš„åº”ç”¨åœºæ™¯ã€‚</p>]]></content>
    
    
    <summary type="html">æˆ‘ä»¬æ·±å…¥æ¢è®¨äº†å¦‚ä½•ä½¿ç”¨ Rust è¯­è¨€æ¥å®ç°ä¸€ä¸ªç±»ä¼¼äº HTTPie çš„å‘½ä»¤è¡Œå·¥å…·ã€‚</summary>
    
    
    
    <category term="Rust" scheme="https://hedon.top/categories/Rust/"/>
    
    <category term="Rust å®æˆ˜" scheme="https://hedon.top/categories/Rust/Rust-%E5%AE%9E%E6%88%98/"/>
    
    
    <category term="Rust" scheme="https://hedon.top/tags/Rust/"/>
    
  </entry>
  
  <entry>
    <title>Rust anyhow ç®€æ˜æ•™ç¨‹</title>
    <link href="https://hedon.top/2024/03/05/rust-crate-anyhow/"/>
    <id>https://hedon.top/2024/03/05/rust-crate-anyhow/</id>
    <published>2024-03-05T15:44:00.000Z</published>
    <updated>2024-05-11T15:53:19.389Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://docs.rs/anyhow/latest/anyhow/index.html">anyhow</a>æ˜¯ Rust ä¸­çš„ä¸€ä¸ªåº“ï¼Œæ—¨åœ¨æä¾›çµæ´»çš„ã€å…·ä½“çš„é”™è¯¯å¤„ç†èƒ½åŠ›ï¼Œå»ºç«‹åœ¨<code>std::error::Error</code>åŸºç¡€ä¸Šã€‚å®ƒä¸»è¦ç”¨äºé‚£äº›éœ€è¦ç®€å•é”™è¯¯å¤„ç†çš„åº”ç”¨ç¨‹åºå’ŒåŸå‹å¼€å‘ä¸­ï¼Œå°¤å…¶æ˜¯åœ¨é”™è¯¯ç±»å‹ä¸éœ€è¦è¢«ä¸¥æ ¼åŒºåˆ†çš„åœºæ™¯ä¸‹ã€‚</p><p>ä»¥ä¸‹æ˜¯ <code>anyhow</code> çš„å‡ ä¸ªå…³é”®ç‰¹æ€§ï¼š</p><ul><li><strong>æ˜“ç”¨æ€§</strong>: <code>anyhow</code> æä¾›äº†ä¸€ä¸ª<code>Error</code> ç±»å‹ï¼Œè¿™ä¸ªç±»å‹å¯ä»¥åŒ…å«ä»»ä½•å®ç°äº†<code>std::error::Error</code> çš„é”™è¯¯ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥ä½¿ç”¨<code>anyhow::Error</code>æ¥åŒ…è£…å‡ ä¹æ‰€æœ‰ç±»å‹çš„é”™è¯¯ï¼Œæ— éœ€æ‹…å¿ƒå…·ä½“çš„é”™è¯¯ç±»å‹ã€‚</li><li><strong>ç®€æ´çš„é”™è¯¯é“¾</strong>: <code>anyhow</code> æ”¯æŒé€šè¿‡<code>?</code>æ“ä½œç¬¦æ¥ä¼ æ’­é”™è¯¯ï¼ŒåŒæ—¶ä¿ç•™é”™è¯¯å‘ç”Ÿçš„ä¸Šä¸‹æ–‡ã€‚è¿™è®©é”™è¯¯å¤„ç†æ›´åŠ ç›´è§‚ï¼ŒåŒæ—¶è¿˜èƒ½ä¿ç•™é”™è¯¯é“¾ï¼Œä¾¿äºè°ƒè¯•ã€‚</li><li><strong>ä¾¿äºè°ƒè¯•</strong>: <code>anyhow</code> æ”¯æŒé€šè¿‡<code>&#123;:#&#125;</code>æ ¼å¼åŒ–æŒ‡ç¤ºç¬¦æ¥æ‰“å°é”™è¯¯åŠå…¶æ‰€æœ‰ç›¸å…³çš„ä¸Šä¸‹æ–‡å’ŒåŸå› ï¼Œè¿™ä½¿å¾—è°ƒè¯•å¤æ‚çš„é”™è¯¯é“¾å˜å¾—æ›´åŠ ç®€å•ã€‚</li><li><strong>æ— éœ€å…³å¿ƒé”™è¯¯ç±»å‹</strong>:åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œç‰¹åˆ«æ˜¯åœ¨åº”ç”¨ç¨‹åºçš„é¡¶å±‚ï¼Œä½ å¯èƒ½ä¸éœ€è¦å…³å¿ƒé”™è¯¯çš„å…·ä½“ç±»å‹ï¼Œåªéœ€è¦çŸ¥é“å‡ºé”™äº†å¹¶ä¸”èƒ½å¤Ÿå°†é”™è¯¯ä¿¡æ¯ä¼ é€’ç»™ç”¨æˆ·æˆ–æ—¥å¿—ã€‚<code>anyhow</code>è®©è¿™ä¸€è¿‡ç¨‹å˜å¾—ç®€å•ï¼Œå› ä¸ºå®ƒå¯ä»¥åŒ…è£…ä»»ä½•é”™è¯¯ï¼Œè€Œä¸éœ€è¦æ˜¾å¼åœ°æŒ‡å®šé”™è¯¯ç±»å‹ã€‚</li></ul><p>ä½¿ç”¨ <code>anyhow</code>çš„å…¸å‹åœºæ™¯åŒ…æ‹¬å¿«é€ŸåŸå‹å¼€å‘ã€åº”ç”¨ç¨‹åºé¡¶å±‚çš„é”™è¯¯å¤„ç†ï¼Œæˆ–è€…åœ¨åº“ä¸­ä½œä¸ºè¿”å›é”™è¯¯ç±»å‹çš„ä¸€ä¸ªç®€ä¾¿é€‰æ‹©ï¼Œå°¤å…¶æ˜¯åœ¨åº“çš„ä½¿ç”¨è€…ä¸éœ€è¦å…³å¿ƒå…·ä½“é”™è¯¯ç±»å‹çš„æ—¶å€™ã€‚</p><h2 id="anyhowerror">anyhow::Error</h2><p><code>anyhow::Error</code> æ˜¯ <code>anyhow</code>åº“å®šä¹‰çš„ä¸€ä¸ªé”™è¯¯ç±»å‹ã€‚å®ƒæ˜¯ä¸€ä¸ªåŒ…è£…å™¨ï¼ˆwrapperï¼‰ç±»å‹ï¼Œå¯ä»¥åŒ…å«ä»»ä½•å®ç°äº†<code>std::error::Error</code> traitçš„é”™è¯¯ç±»å‹ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥å°†å‡ ä¹æ‰€æœ‰çš„é”™è¯¯è½¬æ¢ä¸º<code>anyhow::Error</code>ç±»å‹ï¼Œä»è€Œåœ¨å‡½æ•°ä¹‹é—´ä¼ é€’ï¼Œè€Œä¸éœ€è¦åœ¨æ„å…·ä½“çš„é”™è¯¯ç±»å‹ã€‚è¿™åœ¨å¿«é€ŸåŸå‹å¼€å‘æˆ–åº”ç”¨ç¨‹åºé¡¶å±‚é”™è¯¯å¤„ç†ä¸­ç‰¹åˆ«æœ‰ç”¨ï¼Œå› ä¸ºå®ƒç®€åŒ–äº†é”™è¯¯å¤„ç†çš„é€»è¾‘ã€‚</p><p>å®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[cfg_attr(not(doc), repr(transparent))]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Error</span> &#123;<br>    inner: Own&lt;ErrorImpl&gt;,<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­æ ¸å¿ƒæ˜¯ <code>ErrorImpl</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[repr(C)]</span><br><span class="hljs-title function_ invoke__">pub</span>(<span class="hljs-keyword">crate</span>) <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ErrorImpl</span>&lt;E = ()&gt; &#123;<br>    vtable: &amp;<span class="hljs-symbol">&#x27;static</span> ErrorVTable,<br>    backtrace: <span class="hljs-type">Option</span>&lt;Backtrace&gt;,<br>    <span class="hljs-comment">// <span class="hljs-doctag">NOTE:</span> Don&#x27;t use directly. Use only through vtable. Erased type may have</span><br>    <span class="hljs-comment">// different alignment.</span><br>    _object: E,<br>&#125;<br></code></pre></td></tr></table></figure><p><code>ErrorImpl</code> æ˜¯ä¸€ä¸ªå†…éƒ¨ç»“æ„ä½“ï¼Œç”¨äºå®ç°<code>anyhow::Error</code> ç±»å‹çš„å…·ä½“åŠŸèƒ½ã€‚å®ƒåŒ…å«äº†ä¸‰ä¸ªä¸»è¦å­—æ®µï¼š</p><ul><li><code>vtable</code>æ˜¯ä¸€ä¸ªæŒ‡å‘é™æ€è™šæ‹Ÿè¡¨çš„æŒ‡é’ˆï¼Œç”¨äºåŠ¨æ€æ´¾å‘é”™è¯¯ç›¸å…³çš„æ–¹æ³•ã€‚</li><li><code>backtrace</code>æ˜¯ä¸€ä¸ªå¯é€‰çš„å›æº¯ï¼ˆBacktraceï¼‰ç±»å‹ï¼Œç”¨äºå­˜å‚¨é”™è¯¯å‘ç”Ÿæ—¶çš„è°ƒç”¨æ ˆä¿¡æ¯ã€‚</li><li><code>_object</code>å­—æ®µç”¨äºå­˜å‚¨å…·ä½“çš„é”™è¯¯å¯¹è±¡ï¼Œå…¶ç±»å‹åœ¨ç¼–è¯‘æ—¶è¢«æ“¦é™¤ä»¥æä¾›ç±»å‹å®‰å…¨çš„åŠ¨æ€é”™è¯¯å¤„ç†ã€‚</li></ul><p>è¿™ç§è®¾è®¡å…è®¸ <code>anyhow</code>é”™è¯¯å°è£…å¹¶è¡¨ç¤ºå„ç§ä¸åŒçš„é”™è¯¯ç±»å‹ï¼ŒåŒæ—¶æä¾›äº†æ–¹æ³•åŠ¨æ€æ´¾å‘å’Œå›æº¯åŠŸèƒ½ï¼Œä»¥ä¾¿äºé”™è¯¯è°ƒè¯•ã€‚</p><p><code>anyhow::Error</code> å¯ä»¥åŒ…å«ä»»ä½•å®ç°äº†<code>std::error::Error</code> trait çš„é”™è¯¯ç±»å‹ï¼Œè¿™é‡Œå› ä¸ºä¸‹é¢çš„<code>impl</code>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go">impl&lt;E&gt; StdError <span class="hljs-keyword">for</span> ErrorImpl&lt;E&gt;<br>where<br>    E: StdError,<br>&#123;<br>    fn source(&amp;self) -&gt; Option&lt;&amp;(dyn StdError + <span class="hljs-string">&#x27;static)&gt; &#123;</span><br><span class="hljs-string">        unsafe &#123; ErrorImpl::error(self.erase()).source() &#125;</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    #[cfg(error_generic_member_access)]</span><br><span class="hljs-string">    fn provide&lt;&#x27;</span>a&gt;(&amp;<span class="hljs-string">&#x27;a self, request: &amp;mut Request&lt;&#x27;</span>a&gt;) &#123;<br>        unsafe &#123; ErrorImpl::provide(self.erase(), request) &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="anyhowresult">anyhow::Result</h2><p><code>anyhow::Result</code> æ˜¯ä¸€ä¸ªåˆ«åï¼ˆtype aliasï¼‰ï¼Œå®ƒæ˜¯<code>std::result::Result&lt;T, anyhow::Error&gt;</code> çš„ç®€å†™ã€‚åœ¨ä½¿ç”¨<code>anyhow</code>åº“è¿›è¡Œé”™è¯¯å¤„ç†æ—¶ï¼Œä½ ä¼šé¢‘ç¹åœ°çœ‹åˆ°è¿™ä¸ªç±»å‹ã€‚å®ƒåŸºæœ¬ä¸Šæ˜¯æ ‡å‡†çš„<code>Result</code> ç±»å‹ï¼Œä½†é”™è¯¯ç±»å‹è¢«å›ºå®šä¸º<code>anyhow::Error</code>ã€‚è¿™ä½¿å¾—ä½ å¯ä»¥å¾ˆå®¹æ˜“åœ°åœ¨å‡½æ•°ä¹‹é—´ä¼ é€’é”™è¯¯ï¼Œè€Œä¸éœ€è¦å£°æ˜å…·ä½“çš„é”™è¯¯ç±»å‹ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">Result</span>&lt;T, E = Error&gt; = core::result::<span class="hljs-type">Result</span>&lt;T, E&gt;;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>anyhow::Result</code>çš„å¥½å¤„åœ¨äºå®ƒæä¾›äº†ä¸€ç§ç»Ÿä¸€çš„æ–¹å¼æ¥å¤„ç†é”™è¯¯ã€‚ä½ å¯ä»¥ä½¿ç”¨ <code>?</code>æ“ä½œç¬¦æ¥ä¼ æ’­é”™è¯¯ï¼ŒåŒæ—¶ä¿ç•™é”™è¯¯çš„ä¸Šä¸‹æ–‡ä¿¡æ¯å’Œå›æº¯ã€‚è¿™æå¤§åœ°ç®€åŒ–äº†é”™è¯¯å¤„ç†ä»£ç ï¼Œå°¤å…¶æ˜¯åœ¨å¤šä¸ªå¯èƒ½äº§ç”Ÿä¸åŒé”™è¯¯ç±»å‹çš„æ“ä½œé“¾ä¸­ã€‚</p><h2 id="ä¸ªæ ¸å¿ƒä½¿ç”¨æŠ€å·§">3 ä¸ªæ ¸å¿ƒä½¿ç”¨æŠ€å·§</h2><ul><li>ä½¿ç”¨ <code>Result&lt;T, anyhow::Error&gt;</code> æˆ–è€…<code>anyhow::Result&lt;T&gt;</code> ä½œä¸ºè¿”å›å€¼ï¼Œç„¶ååˆ©ç”¨ <code>?</code>è¯­æ³•ç³–æ— è„‘ä¼ æ’­æŠ¥é”™ã€‚</li><li>ä½¿ç”¨ with_context(f) æ¥é™„åŠ é”™è¯¯ä¿¡æ¯ã€‚</li><li>ä½¿ç”¨ downcast åè§£å…·ä½“çš„é”™è¯¯ç±»å‹ã€‚</li></ul><h2 id="å®æˆ˜æ¡ˆä¾‹">å®æˆ˜æ¡ˆä¾‹</h2><p>ä¸‹é¢æˆ‘ä»¬ç”¨ä¸€ä¸ªæ¡ˆä¾‹æ¥ä½“ä¼š <code>anyhow</code> çš„ä½¿ç”¨æ–¹å¼ï¼š</p><p>æˆ‘ä»¬çš„éœ€æ±‚æ˜¯ï¼šæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œè§£ææ–‡ä»¶ä¸­çš„æ•°æ®å¹¶è¿›è¡Œå¤§å†™åŒ–ï¼Œç„¶åè¾“å‡ºå¤„ç†åçš„æ•°æ®ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> anyhow::&#123;<span class="hljs-type">Result</span>, Context&#125;;<br><span class="hljs-keyword">use</span> std::&#123;fs, io&#125;;<br><br><span class="hljs-comment">// 1. è¯»å–æ–‡ä»¶ã€è§£ææ•°æ®å’Œæ‰§è¡Œæ•°æ®æ“ä½œéƒ½å¯èƒ½å‡ºç°é”™è¯¯ï¼Œ</span><br><span class="hljs-comment">// æ‰€ä»¥æˆ‘ä»¬éœ€è¦è¿”å› Result æ¥å…¼å®¹å¼‚å¸¸æƒ…å†µã€‚</span><br><span class="hljs-comment">// è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ anyhow::Result æ¥ç®€åŒ–å’Œä¼ æ’­é”™è¯¯ã€‚</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">read_and_process_file</span>(file_path: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-comment">// å°è¯•è¯»å–æ–‡ä»¶</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">data</span> = fs::<span class="hljs-title function_ invoke__">read_to_string</span>(file_path)<br>        <span class="hljs-comment">// 2. ä½¿ç”¨ with_context æ¥é™„åŠ é”™è¯¯ä¿¡æ¯ï¼Œç„¶ååˆ©ç”¨ ? è¯­æ³•ç³–ä¼ æ’­é”™è¯¯ã€‚</span><br>        .<span class="hljs-title function_ invoke__">with_context</span>(||<span class="hljs-built_in">format!</span>(<span class="hljs-string">&quot;failed to read file `&#123;&#125;`&quot;</span>, file_path))?;<br><br>    <span class="hljs-comment">// è§£ææ•°æ®</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">processed_data</span> = <span class="hljs-title function_ invoke__">parse_data</span>(&amp;data)<br>        .<span class="hljs-title function_ invoke__">with_context</span>(||<span class="hljs-built_in">format!</span>(<span class="hljs-string">&quot;failed to parse data from file `&#123;&#125;`&quot;</span>, file_path))?;<br><br>    <span class="hljs-comment">// æ‰§è¡Œæ•°æ®æ“ä½œ</span><br>    <span class="hljs-title function_ invoke__">perform_some_operation</span>(processed_data)<br>        .<span class="hljs-title function_ invoke__">with_context</span>(|| <span class="hljs-string">&quot;failed to perform operation based on file data&quot;</span>)?;<br><br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">parse_data</span>(data: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-type">String</span>&gt; &#123;<br>    <span class="hljs-title function_ invoke__">Ok</span>(data.<span class="hljs-title function_ invoke__">to_uppercase</span>())<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">perform_some_operation</span>(data: <span class="hljs-type">String</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;processed data: &#123;&#125;&quot;</span>, data);<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">file_path</span> = <span class="hljs-string">&quot;./anyhow.txt&quot;</span>;<br>  <span class="hljs-comment">// æ‰§è¡Œå¤„ç†é€»è¾‘</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">res</span> =  <span class="hljs-title function_ invoke__">read_and_process_file</span>(file_path);<br>  <span class="hljs-comment">// å¤„ç†ç»“æœ</span><br>    <span class="hljs-keyword">match</span> res &#123;<br>        <span class="hljs-title function_ invoke__">Ok</span>(_) =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;successfully!&quot;</span>),<br>        <span class="hljs-title function_ invoke__">Err</span>(e) =&gt; &#123;<br>            <span class="hljs-comment">// 3. ä½¿ç”¨ downcast æ¥åè§£å‡ºå®é™…çš„é”™è¯¯å®ä¾‹ï¼Œæœ¬æ¡ˆä¾‹ä¸­å¯èƒ½å‡ºç°çš„å¼‚å¸¸æ˜¯ io::Errorã€‚</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(my_error) = e.downcast_ref::&lt;io::Error&gt;() &#123;<br>                <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;has io error: &#123;:#&#125;&quot;</span>, my_error);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;unknown error: &#123;:?&#125;&quot;</span>, e);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">æ¢ç´¢ Rust çš„ anyhow åº“ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªç®€å•è€Œå¼ºå¤§çš„æ–¹å¼æ¥å¤„ç†é”™è¯¯ã€‚æœ¬æ•™ç¨‹å°†å¼•å¯¼ä½ äº†è§£ anyhow çš„æ ¸å¿ƒç‰¹æ€§ï¼ŒåŒ…æ‹¬æ˜“ç”¨æ€§ã€é”™è¯¯é“¾ã€è°ƒè¯•ä¾¿åˆ©æ€§ï¼Œä»¥åŠå¦‚ä½•åœ¨ä¸åŒåœºæ™¯ä¸‹åˆ©ç”¨ anyhow æ¥ç®€åŒ–é”™è¯¯å¤„ç†ã€‚æ— è®ºæ˜¯å¿«é€ŸåŸå‹å¼€å‘è¿˜æ˜¯åº”ç”¨ç¨‹åºé¡¶å±‚é”™è¯¯å¤„ç†ï¼Œanyhow éƒ½æ˜¯ Rust å¼€å‘è€…çš„å¾—åŠ›åŠ©æ‰‹ã€‚</summary>
    
    
    
    <category term="Rust" scheme="https://hedon.top/categories/Rust/"/>
    
    <category term="Rust å¸¸ç”¨åº“" scheme="https://hedon.top/categories/Rust/Rust-%E5%B8%B8%E7%94%A8%E5%BA%93/"/>
    
    
    <category term="Rust" scheme="https://hedon.top/tags/Rust/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥æ¢ç´¢ Rust çš„ clap åº“ï¼šå‘½ä»¤è¡Œè§£æçš„è‰ºæœ¯</title>
    <link href="https://hedon.top/2024/03/02/rust-crate-clap/"/>
    <id>https://hedon.top/2024/03/02/rust-crate-clap/</id>
    <published>2024-03-02T12:08:59.000Z</published>
    <updated>2024-03-06T14:47:39.143Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç‰ˆæœ¬å£°æ˜">ç‰ˆæœ¬å£°æ˜</h1><ul><li>Rust: 1.76</li><li><a href="https://docs.rs/clap/4.5.1/clap/index.html">clap:4.5.1</a></li><li><ahref="https://docs.rs/clap_complete/4.5.1/clap_complete/index.html">clap_complete4.5.1</a></li><li><ahref="https://docs.rs/rpassword/7.3.1/rpassword/index.html">rpassword:7.3.1</a></li></ul><h1 id="ç»“è®ºå…ˆè¡Œ">ç»“è®ºå…ˆè¡Œ</h1><p>æœ¬æ–‡å°†ä» CLIï¼ˆCommand LineInterfaceï¼‰å‘½ä»¤è¡Œå·¥å…·çš„æ¦‚è¿°è®²èµ·ï¼Œä»‹ç»ä¸€ä¸ªä¼˜ç§€çš„å‘½ä»¤è¡Œå·¥å…·åº”è¯¥å…·å¤‡çš„åŠŸèƒ½å’Œç‰¹æ€§ã€‚ç„¶åä»‹ç»Rust ä¸­ä¸€ä¸ªéå¸¸ä¼˜ç§€çš„å‘½ä»¤è¡Œè§£æå·¥å…· <code>clap</code>ç»å…¸ä½¿ç”¨æ–¹æ³•ï¼Œå¹¶åˆ©ç”¨ <code>clap</code> å®ç°ä¸€ä¸ªç±»ä¼¼äº <code>curl</code>çš„å·¥å…· <code>httpie</code>ã€‚æ–‡ç« æœ€åè¿˜å°† <code>clap</code> äº Goè¯­è¨€ä¸­åŒæ ·ä¼˜ç§€çš„å‘½ä»¤è¡Œè§£æå·¥å…· <code>cobra</code>è¿›è¡Œä¸€ä¸ªç®€å•å¯¹æ¯”ï¼Œä¾¿äºè¯»è€…è¿›ä¸€æ­¥ä½“ä¼š <code>clap</code>çš„ç®€æ´å’Œä¼˜ç§€ã€‚</p><p>æœ¬æ–‡å°†åŒ…å«ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p><ol type="1"><li><strong>CLI æ¦‚è¿°</strong>ï¼šä» CLIçš„åŸºæœ¬æ¦‚å¿µå‡ºå‘ï¼Œä»‹ç»ä¼˜ç§€å‘½ä»¤è¡Œå·¥å…·åº”è¯¥å…·å¤‡çš„åŠŸèƒ½ç‰¹æ€§ï¼Œå¹¶ä»¥ curlä½œä¸ºç»å…¸èŒƒä¾‹è¿›è¡Œè¯´æ˜ã€‚</li><li><strong>è¯¦ç»†ä»‹ç» clap</strong>ï¼šåŸºäº clap å®˜æ–¹æ–‡æ¡£ï¼Œåˆ†åˆ«è¯¦ç»†ä»‹ç»clap ä»¥ derive å’Œ builder ä¸¤ä¸ªæ–¹å¼æ„å»º cli çš„å¸¸ç”¨æ–¹æ³•ã€‚</li><li><strong>å®æˆ˜ httpie</strong>ï¼šå‚è€ƒé™ˆå¤©è€å¸ˆçš„ã€ŠRustç¼–ç¨‹ç¬¬ä¸€è¯¾ã€‹ï¼Œç”¨æœ€æ–°çš„ clap ç‰ˆæœ¬ï¼ˆ1.7.6ï¼‰å®ç° httpie å·¥å…·ã€‚</li><li><strong>å¯¹æ¯”cobra</strong>ï¼šä»è®¾è®¡ç†å¿µå’Œç›®æ ‡ã€åŠŸèƒ½ç‰¹ç‚¹ã€ä½¿ç”¨åœºæ™¯ç­‰æ–¹é¢ç®€è¦å¯¹æ¯” clapå’Œ Go æµè¡Œçš„å‘½ä»¤è¡Œè§£æåº“ cobraã€‚</li></ol><p>ç‰¹æ­¤å£°æ˜ï¼Œæœ¬æ–‡åŒ…å« AI è¾…åŠ©ç”Ÿæˆå†…å®¹ï¼Œå¦‚æœ‰é”™è¯¯é—æ¼ä¹‹å¤„ï¼Œæ•¬è¯·æŒ‡å‡ºã€‚</p><h1 id="cli-æ¦‚è¿°">CLI æ¦‚è¿°</h1><p>CLIï¼ˆCommand LineInterfaceï¼Œå‘½ä»¤è¡Œç•Œé¢ï¼‰æ˜¯ä¸€ç§å…è®¸ç”¨æˆ·é€šè¿‡æ–‡æœ¬å‘½ä»¤ä¸è®¡ç®—æœºç¨‹åºæˆ–æ“ä½œç³»ç»Ÿè¿›è¡Œäº¤äº’çš„æ¥å£ã€‚ä¸å›¾å½¢ç”¨æˆ·ç•Œé¢ï¼ˆGUIï¼ŒGraphicalUser Interfaceï¼‰ç›¸æ¯”ï¼ŒCLIä¸æä¾›å›¾å½¢å…ƒç´ ï¼Œå¦‚æŒ‰é’®æˆ–å›¾æ ‡ï¼Œè€Œæ˜¯ä¾èµ–äºæ–‡æœ¬è¾“å…¥ã€‚ç”¨æˆ·é€šè¿‡é”®ç›˜è¾“å…¥ç‰¹å®šçš„å‘½ä»¤è¡ŒæŒ‡ä»¤ï¼Œå‘½ä»¤è¡Œç•Œé¢è§£é‡Šè¿™äº›æŒ‡ä»¤å¹¶æ‰§è¡Œç›¸åº”çš„æ“ä½œã€‚</p><p>ä¸€æ¬¾ä¼˜ç§€çš„ CLIå·¥å…·åº”è¯¥å…·å¤‡ä»¥ä¸‹çš„åŠŸèƒ½å’Œç‰¹æ€§ï¼Œä»¥æå‡ç”¨æˆ·ä½“éªŒå’Œæ•ˆç‡ï¼š</p><p>ä¸€ä¸ªä¼˜ç§€çš„å‘½ä»¤è¡Œå·¥å…·ï¼ˆCLI, Command LineInterfaceï¼‰åº”è¯¥å…·å¤‡ä»¥ä¸‹åŠŸèƒ½å’Œç‰¹æ€§ï¼Œä»¥æå‡ç”¨æˆ·ä½“éªŒå’Œæ•ˆç‡ï¼š</p><ol type="1"><li><strong>ç›´è§‚æ˜“ç”¨</strong>ï¼š<ul><li><strong>ç®€æ´çš„å‘½ä»¤è¯­æ³•</strong>ï¼šå‘½ä»¤å’Œå‚æ•°çš„è®¾è®¡åº”ç›´è§‚æ˜“æ‡‚ï¼Œæ–¹ä¾¿ç”¨æˆ·è®°å¿†å’Œä½¿ç”¨ã€‚</li><li><strong>è‡ªåŠ¨è¡¥å…¨</strong>ï¼šæ”¯æŒå‘½ä»¤å’Œå‚æ•°çš„è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ï¼Œæé«˜ç”¨æˆ·è¾“å…¥æ•ˆç‡ã€‚</li><li><strong>å‘½ä»¤åˆ«å</strong>ï¼šæä¾›å¸¸ç”¨å‘½ä»¤çš„ç®€çŸ­åˆ«åï¼Œå‡å°‘è¾“å…¥çš„å·¥ä½œé‡ã€‚</li></ul></li><li><strong>å¼ºå¤§çš„å¸®åŠ©ç³»ç»Ÿ</strong>ï¼š<ul><li><strong>è¯¦ç»†çš„å¸®åŠ©æ–‡æ¡£</strong>ï¼šæ¯ä¸ªå‘½ä»¤å’Œå‚æ•°éƒ½åº”æœ‰æ¸…æ™°çš„è¯´æ˜æ–‡æ¡£ã€‚</li><li><strong>ç¤ºä¾‹ä½¿ç”¨æ–¹å¼</strong>ï¼šæä¾›å¸¸è§çš„ä½¿ç”¨ç¤ºä¾‹ï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿç†è§£å’Œåº”ç”¨ã€‚</li><li><strong>å†…ç½®å¸®åŠ©å‘½ä»¤</strong>ï¼šé€šè¿‡å¦‚<code>--help</code>æˆ–<code>-h</code>å‚æ•°è½»æ¾è®¿é—®å¸®åŠ©ä¿¡æ¯ã€‚</li></ul></li><li><strong>é”™è¯¯å¤„ç†ä¸åé¦ˆ</strong>ï¼š<ul><li><strong>æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯</strong>ï¼šå‡ºç°é”™è¯¯æ—¶ï¼Œæä¾›æ˜ç¡®ã€å…·ä½“çš„é”™è¯¯ä¿¡æ¯ï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿå®šä½é—®é¢˜ã€‚</li><li><strong>å»ºè®®å’Œè§£å†³æ–¹æ¡ˆ</strong>ï¼šåœ¨å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œç»™å‡ºé”™è¯¯è§£å†³çš„å»ºè®®æˆ–è‡ªåŠ¨ä¿®å¤é€‰é¡¹ã€‚</li></ul></li><li><strong>é«˜æ•ˆçš„æ‰§è¡Œå’Œè¾“å‡º</strong>ï¼š<ul><li><strong>å¿«é€Ÿå“åº”</strong>ï¼šå‘½ä»¤æ‰§è¡Œåº”è¿…é€Ÿï¼Œå‡å°‘ç”¨æˆ·ç­‰å¾…æ—¶é—´ã€‚</li><li><strong>æ ¼å¼åŒ–çš„è¾“å‡º</strong>ï¼šæä¾›æ˜“äºé˜…è¯»å’Œè§£æçš„è¾“å‡ºæ ¼å¼ï¼Œå¦‚è¡¨æ ¼ã€JSONæˆ– XML ç­‰ã€‚</li><li><strong>è¾“å‡ºè¿‡æ»¤å’Œæ’åº</strong>ï¼šå…è®¸ç”¨æˆ·æ ¹æ®éœ€è¦è¿‡æ»¤å’Œæ’åºè¾“å‡ºç»“æœï¼Œæé«˜ä¿¡æ¯çš„æŸ¥æ‰¾æ•ˆç‡ã€‚</li></ul></li><li><strong>è·¨å¹³å°å…¼å®¹</strong>ï¼š<ul><li><strong>å¤šå¹³å°æ”¯æŒ</strong>ï¼šèƒ½å¤Ÿåœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸Šè¿è¡Œï¼Œå¦‚Windowsã€macOSã€Linux ç­‰ã€‚</li><li><strong>ç¯å¢ƒé€‚åº”æ€§</strong>ï¼šè‡ªåŠ¨é€‚åº”ä¸åŒçš„ç»ˆç«¯ç¯å¢ƒå’Œå­—ç¬¦ç¼–ç ï¼Œç¡®ä¿è¾“å‡ºæ˜¾ç¤ºæ­£ç¡®ã€‚</li></ul></li><li><strong>å®‰å…¨æ€§</strong>ï¼š<ul><li><strong>å®‰å…¨çš„é»˜è®¤è®¾ç½®</strong>ï¼šé»˜è®¤é…ç½®åº”å¼ºè°ƒå®‰å…¨ï¼Œé¿å…æš´éœ²æ•æ„Ÿä¿¡æ¯ã€‚</li><li><strong>æ•°æ®åŠ å¯†</strong>ï¼šåœ¨å¤„ç†æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚å¯†ç ï¼‰æ—¶ï¼Œåº”ä½¿ç”¨åŠ å¯†æ‰‹æ®µä¿æŠ¤æ•°æ®å®‰å…¨ã€‚</li></ul></li><li><strong>ç‰ˆæœ¬ç®¡ç†</strong>ï¼š<ul><li><strong>ç‰ˆæœ¬æ§åˆ¶</strong>ï¼šæä¾›å‘½ä»¤æŸ¥çœ‹å·¥å…·ç‰ˆæœ¬ï¼Œæ”¯æŒå¤šç‰ˆæœ¬å…±å­˜æˆ–å‡çº§ã€‚</li><li><strong>å‘åå…¼å®¹</strong>ï¼šæ–°ç‰ˆæœ¬åº”å°½é‡ä¿æŒä¸æ—§ç‰ˆæœ¬çš„å…¼å®¹æ€§ï¼Œé¿å…ç ´åç”¨æˆ·ç°æœ‰çš„å·¥ä½œæµç¨‹ã€‚</li></ul></li></ol><p>è¿™äº›ç‰¹æ€§ä¸ä»…èƒ½å¤Ÿæé«˜ç”¨æˆ·çš„å·¥ä½œæ•ˆç‡ï¼Œè¿˜èƒ½å¢å¼ºç”¨æˆ·ä½“éªŒï¼Œä½¿å‘½ä»¤è¡Œå·¥å…·æ›´åŠ å¼ºå¤§å’Œæ˜“ç”¨ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬ä»¥ <code>curl</code> ä¸ºä¾‹ï¼Œçœ‹çœ‹ä¼˜ç§€çš„ CLIå·¥å…·å¤§æ¦‚é•¿ä»€ä¹ˆæ ·å­ã€‚</p><p><code>curl</code>æ˜¯ä¸€ç§å‘½ä»¤è¡Œå·¥å…·å’Œåº“ï¼Œç”¨äºä¼ è¾“æ•°æ®ã€‚å®ƒæ”¯æŒå¤šç§åè®®ï¼ŒåŒ…æ‹¬HTTPã€HTTPSã€FTPã€FTPSã€SCPã€SFTPã€TFTPã€TELNETã€DICTã€LDAPã€LDAPSã€IMAPã€POP3ã€SMTPå’Œ RTSP ç­‰ã€‚<code>curl</code>æ˜¯ä¸€ä¸ªéå¸¸å¼ºå¤§å’Œçµæ´»çš„å·¥å…·ï¼Œå¹¿æ³›åº”ç”¨äºè‡ªåŠ¨åŒ–è„šæœ¬ã€ç³»ç»Ÿæµ‹è¯•ã€æ•°æ®æ”¶é›†å’Œè®¸å¤šå…¶ä»–ç”¨é€”ã€‚</p><p>è¿›å…¥ç»ˆç«¯ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸‹é¢å‘½ä»¤æŸ¥çœ‹ <code>curl</code> çš„è¯´æ˜æ–‡æ¡£ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  ~ curl --<span class="hljs-built_in">help</span><br>Usage: curl [options...] &lt;url&gt;<br> -d, --data &lt;data&gt;          HTTP POST data<br> -f, --fail                 Fail fast with no output on HTTP errors<br> -h, --<span class="hljs-built_in">help</span> &lt;category&gt;      Get <span class="hljs-built_in">help</span> <span class="hljs-keyword">for</span> commands<br> -i, --include              Include protocol response headers <span class="hljs-keyword">in</span> the output<br> -o, --output &lt;file&gt;        Write to file instead of stdout<br> -O, --remote-name          Write output to a file named as the remote file<br> -s, --silent               Silent mode<br> -T, --upload-file &lt;file&gt;   Transfer <span class="hljs-built_in">local</span> FILE to destination<br> -u, --user &lt;user:password&gt; Server user and password<br> -A, --user-agent &lt;name&gt;    Send User-Agent &lt;name&gt; to server<br> -v, --verbose              Make the operation more talkative<br> -V, --version              Show version number and quit<br><br>This is not the full <span class="hljs-built_in">help</span>, this menu is stripped into categories.<br>Use <span class="hljs-string">&quot;--help category&quot;</span> to get an overview of all categories.<br>For all options use the manual or <span class="hljs-string">&quot;--help all&quot;</span>.<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p><ul><li>ä¸‹è½½æ–‡ä»¶ï¼š <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -O http://example.com/file.txt<br></code></pre></td></tr></table></figure></li><li>å‘é€ POST è¯·æ±‚ï¼š <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -d <span class="hljs-string">&quot;param1=value1&amp;param2=value2&quot;</span> http://example.com/resource<br></code></pre></td></tr></table></figure></li><li>ä½¿ç”¨ HTTPS å¹¶å¿½ç•¥è¯ä¹¦éªŒè¯ï¼š <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -k https://example.com<br></code></pre></td></tr></table></figure></li><li>ä½¿ç”¨åŸºæœ¬è®¤è¯ï¼š <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -u username:password http://example.com<br></code></pre></td></tr></table></figure></li></ul><p><code>curl</code>çš„è¿™äº›ç‰¹æ€§ä½¿å…¶æˆä¸ºå¼€å‘è€…ã€ç³»ç»Ÿç®¡ç†å‘˜å’Œè‡ªåŠ¨åŒ–è„šæœ¬ä¸­å¹¿æ³›ä½¿ç”¨çš„å·¥å…·ä¹‹ä¸€ã€‚</p><h1 id="clap">clap</h1><h2 id="æ¦‚è¿°">æ¦‚è¿°</h2><p><code>clap</code>ï¼Œä»£è¡¨ <em>Command Line ArgumentParser</em>ï¼Œæ˜¯ä¸€ä¸ªæ—¨åœ¨åˆ›å»ºç›´è§‚ã€æ˜“ç”¨ä¸”åŠŸèƒ½å¼ºå¤§çš„å‘½ä»¤è¡Œç•Œé¢çš„ Ruståº“ã€‚æˆªè‡³ç›®å‰ï¼ˆ2024.2ï¼‰ï¼Œ<code>clap</code> å·²ç»å‘å±•åˆ°äº† 4.5.1ç‰ˆæœ¬ï¼Œå®ƒé€šè¿‡ç®€åŒ–å‘½ä»¤è¡Œå‚æ•°çš„å¤„ç†ï¼Œè®©å¼€å‘è€…èƒ½æ›´ä¸“æ³¨äºåº”ç”¨é€»è¾‘çš„æ„å»ºã€‚</p><p><code>clap</code> ä¹‹æ‰€ä»¥åœ¨ Rustç¤¾åŒºå¦‚æ­¤æµè¡Œï¼Œå¾—ç›Šäºä»¥ä¸‹å‡ ä¸ªä¼˜ç‚¹ï¼š</p><p><strong>1. æ˜“äºä½¿ç”¨</strong></p><p><code>clap</code>çš„è®¾è®¡ç†å¿µæ˜¯è®©å‘½ä»¤è¡Œå‚æ•°çš„è§£æå˜å¾—ç®€å•è€Œç›´è§‚ã€‚å³ä½¿æ˜¯æ²¡æœ‰ç»éªŒçš„å¼€å‘è€…ä¹Ÿèƒ½å¿«é€Ÿä¸Šæ‰‹ï¼Œé€šè¿‡å‡ è¡Œä»£ç å°±èƒ½å®ç°å¤æ‚çš„å‘½ä»¤è¡Œå‚æ•°è§£æã€‚</p><p><strong>2. åŠŸèƒ½ä¸°å¯Œ</strong></p><p><code>clap</code>æä¾›äº†å¹¿æ³›çš„åŠŸèƒ½æ¥æ»¡è¶³å„ç§å‘½ä»¤è¡Œè§£æéœ€æ±‚ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š</p><ul><li><strong>è‡ªåŠ¨ç”Ÿæˆçš„å¸®åŠ©ä¿¡æ¯</strong>ï¼š<code>clap</code>èƒ½æ ¹æ®å®šä¹‰çš„å‚æ•°è‡ªåŠ¨ç”Ÿæˆå¸®åŠ©ä¿¡æ¯ï¼ŒåŒ…æ‹¬å‚æ•°çš„è¯´æ˜ã€ç±»å‹ã€é»˜è®¤å€¼ç­‰ã€‚</li><li><strong>å¼ºå¤§çš„é”™è¯¯æç¤º</strong>ï¼šå½“ç”¨æˆ·è¾“å…¥æ— æ•ˆçš„å‘½ä»¤è¡Œå‚æ•°æ—¶ï¼Œ<code>clap</code>ä¼šæä¾›æ¸…æ™°ä¸”æœ‰ç”¨çš„é”™è¯¯æç¤ºï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿå®šä½é—®é¢˜ã€‚</li><li><strong>å‚æ•°éªŒè¯</strong>ï¼šå¼€å‘è€…å¯ä»¥ä¸ºå‚æ•°è®¾å®šéªŒè¯è§„åˆ™ï¼Œç¡®ä¿è¾“å…¥çš„å‚æ•°ç¬¦åˆé¢„æœŸã€‚</li><li><strong>å¤æ‚çš„å‘½ä»¤ç»“æ„</strong>ï¼šæ”¯æŒå­å‘½ä»¤çš„åµŒå¥—ï¼Œå…è®¸æ„å»ºå¤æ‚çš„å‘½ä»¤è¡Œåº”ç”¨ç»“æ„ã€‚</li><li><strong>è‡ªå®šä¹‰æ´¾ç”Ÿ</strong>ï¼šé€šè¿‡ <code>clap</code>çš„æ´¾ç”Ÿå®ï¼Œå¯ä»¥ç®€åŒ–å‘½ä»¤è¡Œè§£æå™¨çš„å®šä¹‰ï¼Œä½¿ä»£ç æ›´åŠ æ¸…æ™°ã€‚</li></ul><p><strong>3. é«˜åº¦å¯å®šåˆ¶</strong></p><p><code>clap</code>å…è®¸å¼€å‘è€…é«˜åº¦å®šåˆ¶å‘½ä»¤è¡Œè§£æçš„è¡Œä¸ºå’Œå¤–è§‚ï¼ŒåŒ…æ‹¬è‡ªå®šä¹‰å¸®åŠ©ä¿¡æ¯çš„æ ¼å¼ã€æ§åˆ¶é”™è¯¯æ¶ˆæ¯çš„æ˜¾ç¤ºæ–¹å¼ç­‰ã€‚è¿™ç§çµæ´»æ€§æ„å‘³ç€ä½ å¯ä»¥æ ¹æ®åº”ç”¨ç¨‹åºçš„éœ€æ±‚è°ƒæ•´<code>clap</code> çš„è¡Œä¸ºã€‚</p><p><strong>4. æ€§èƒ½ä¼˜å¼‚</strong></p><p>å°½ç®¡ <code>clap</code>åŠŸèƒ½å¼ºå¤§ï¼Œä½†å®ƒä»ç„¶éå¸¸æ³¨é‡æ€§èƒ½ã€‚<code>clap</code>ç»è¿‡ä¼˜åŒ–ï¼Œä»¥å°½å¯èƒ½å°‘çš„æ€§èƒ½å¼€é”€å¤„ç†å‘½ä»¤è¡Œå‚æ•°ã€‚</p><p><strong>5. æ´»è·ƒçš„ç¤¾åŒºæ”¯æŒ</strong></p><p><code>clap</code> æœ‰ä¸€ä¸ªéå¸¸æ´»è·ƒçš„ç¤¾åŒºï¼Œåœ¨ GitHubä¸Šä¸æ–­æœ‰æ–°çš„è´¡çŒ®è€…åŠ å…¥ã€‚è¿™æ„å‘³ç€ <code>clap</code>ä¸æ–­åœ°å¾—åˆ°æ”¹è¿›å’Œæ›´æ–°ï¼ŒåŒæ—¶ä¹Ÿæœ‰å¤§é‡çš„ç¤¾åŒºèµ„æºå¯ä¾›å‚è€ƒã€‚</p><h2 id="derive-vs-builder-1-åˆæ¢">Derive vs Builder (1) åˆæ¢</h2><p><code>clap</code> æä¾›äº† 2 ç§æ„å»ºå‘½ä»¤è¡Œçš„æ–¹å¼ï¼Œåˆ†åˆ«ä¸º<code>Derive</code> å’Œ<code>Builder</code>ã€‚é¡¾åæ€ä¹‰ï¼Œ<code>Derive</code>å°±æ˜¯åˆ©ç”¨å®å¼ºå¤§çš„åŠŸèƒ½æ¥æ„å»ºå‘½ä»¤è¡Œï¼Œè€Œ <code>Builder</code>åˆ™é‡‡ç”¨æ„å»ºè€…æ¨¡å¼é“¾å¼æ„å»ºå‘½ä»¤è¡Œå·¥å…·ã€‚</p><p>åœ¨è¿™é‡Œæˆ‘ä»¬å…ˆç»™å‡ºç¤ºä¾‹æ¥ç›´è§‚æ„Ÿå—è¿™ 2 ç§æ„å»ºæ–¹å¼çš„ä¸åŒï¼š</p><p>Derive:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(version, author, about, long_about = None)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cli</span> &#123;<br>    <span class="hljs-comment">/// Specify your name</span><br>    name: <span class="hljs-type">String</span>,<br><br>    <span class="hljs-comment">/// Specify your age optionally</span><br>    <span class="hljs-meta">#[arg(short, long)]</span><br>    age: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">i8</span>&gt;,<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cli</span> = Cli::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;name: &#123;&#125;&quot;</span>, cli.name);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;age: &#123;:?&#125;&quot;</span>, cli.age);<br>&#125;<br></code></pre></td></tr></table></figure><p>Builder:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">matches</span> = Command::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;myapp&quot;</span>)<br>  .<span class="hljs-title function_ invoke__">version</span>(<span class="hljs-string">&quot;1.0.0&quot;</span>)<br>  .<span class="hljs-title function_ invoke__">author</span>(<span class="hljs-string">&quot;hedon&quot;</span>)<br>  .<span class="hljs-title function_ invoke__">about</span>(<span class="hljs-string">&quot;this is the short about&quot;</span>)<br>  .<span class="hljs-title function_ invoke__">long_about</span>(<span class="hljs-string">&quot;this is the long about&quot;</span>)<br>        .<span class="hljs-title function_ invoke__">arg</span>(arg!([NAME]).<span class="hljs-title function_ invoke__">required</span>(<span class="hljs-literal">true</span>).<span class="hljs-title function_ invoke__">help</span>(<span class="hljs-string">&quot;Specify your name&quot;</span>))<br>        .<span class="hljs-title function_ invoke__">arg</span>(arg!(-a --age &lt;AGE&gt;)<br>            .<span class="hljs-title function_ invoke__">value_parser</span>(clap::value_parser!(<span class="hljs-type">u8</span>))<br>            .<span class="hljs-title function_ invoke__">help</span>(<span class="hljs-string">&quot;Specify your age optionally&quot;</span>))<br>        .<span class="hljs-title function_ invoke__">get_matches</span>();<br><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;name: &#123;:?&#125;&quot;</span>, matches.get_one::&lt;<span class="hljs-type">String</span>&gt;(<span class="hljs-string">&quot;NAME&quot;</span>));<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;age: &#123;:?&#125;&quot;</span>, matches.get_one::&lt;<span class="hljs-type">u8</span>&gt;(<span class="hljs-string">&quot;age&quot;</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ 2 ä¸ªç¨‹åºéƒ½å®ç°äº†ç›¸åŒçš„åŠŸèƒ½ï¼Œä½¿ç”¨ <code>--help</code>ï¼Œè¾“å‡ºçš„å†…å®¹å¤§è‡´éƒ½å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">Usage: derive [OPTIONS] &lt;NAME&gt;<br><br>Arguments:<br>  &lt;NAME&gt;  Specify your name<br><br>Options:<br>  -a, --age &lt;AGE&gt;  Specify your age optionally<br>  -h, --<span class="hljs-built_in">help</span>       Print <span class="hljs-built_in">help</span><br></code></pre></td></tr></table></figure><p>é€šè¿‡è§‚å¯Ÿï¼Œå¯ä»¥å‘ç° Derive æ¨¡å¼ä¸‹ï¼Œå®ä¸­çš„æ¯ä¸€ä¸ªå±æ€§ï¼Œå¦‚<code>version</code>ã€<code>author</code> ç­‰ï¼Œéƒ½å¯¹åº”åˆ° Builderæ¨¡å¼ä¸‹ä¸€ä¸ªåŒåçš„å‡½æ•°ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å°†ä»<strong>ã€Œåº”ç”¨é…ç½®ã€</strong>ã€<strong>ã€Œå‚æ•°ç±»å‹ã€</strong>å’Œ<strong>ã€Œå‚æ•°æ ¡éªŒã€</strong>ä¸‰ä¸ªæ–¹é¢ï¼Œåˆ†åˆ«ä»‹ç»<code>clap</code> ä¸­ Derive å’Œ Builder ä¸¤ç§æ¨¡å¼æ„å»º CLI çš„å¸¸ç”¨æ–¹æ³•ã€‚</p><p>ç‰¹åˆ«è¯´æ˜ï¼šåç»­çš„ä¾‹å­å‡åœ¨ <code>examples</code>ç›®å½•ä¸‹å®ç°ï¼Œæ•…ç¼–è¯‘å’Œæ‰§è¡Œå‘½ä»¤éƒ½åŒ…å« exampleã€‚</p><p>ç›®å½•ç»“æ„å¤§æ¦‚å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  learn-clap git:(master) âœ— tree         <br>.<br>â”œâ”€â”€ Cargo.lock<br>â”œâ”€â”€ Cargo.toml<br>â”œâ”€â”€ examples<br>â”‚Â Â  â”œâ”€â”€ optional.rs<br>â”œâ”€â”€ src<br>â”‚   â””â”€â”€ main.rs<br>â””â”€â”€ target<br>    â””â”€â”€ release<br>        â””â”€â”€ examples<br>        â””â”€â”€ optional<br></code></pre></td></tr></table></figure><h2 id="derive">Derive</h2><p>è¦ä½¿ç”¨ <code>clap</code> çš„ Derive æ¨¡å¼ï¼Œéœ€è¦ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo add clap --features derive<br></code></pre></td></tr></table></figure><h3 id="åº”ç”¨é…ç½®">1. åº”ç”¨é…ç½®</h3><p>æˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ª <code>strut</code> æ¥è¡¨ç¤ºæˆ‘ä»¬çš„<code>application</code>ï¼Œåˆ©ç”¨å®ƒæ¥æ‰¿è½½åº”ç”¨çš„å‚æ•°ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">/// The example of clap derive</span><br><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(version, author, about, long_about = None)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cli</span> &#123;<br>    <span class="hljs-comment">/// Specify your name</span><br>    name: <span class="hljs-type">String</span>,<br><br>    <span class="hljs-comment">/// Specify your age optionally</span><br>    <span class="hljs-meta">#[arg(short, long)]</span><br>    age: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">i8</span>&gt;,<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cli</span> = Cli::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;name: &#123;&#125;&quot;</span>, cli.name);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;age: &#123;:?&#125;&quot;</span>, cli.age);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>#[derive(Parser)]</code> æ˜¯ä¸€ä¸ªè¿‡ç¨‹å®ï¼ˆproceduralmacroï¼‰ï¼Œç”¨äºè‡ªåŠ¨ä¸ºç»“æ„ä½“å®ç° <code>clap::Parser</code>traitã€‚è¿™ä½¿å¾—è¯¥ç»“æ„ä½“å¯ä»¥ç”¨æ¥è§£æå‘½ä»¤è¡Œå‚æ•°ã€‚</p><ul><li>ä½¿ç”¨<code>#[derive(Parser)]</code>ï¼Œä½ å¯ä»¥ç®€åŒ–å‘½ä»¤è¡Œè§£æçš„ä»£ç ï¼Œå› ä¸º<code>clap</code> ä¼šæ ¹æ®ç»“æ„ä½“çš„å­—æ®µè‡ªåŠ¨ç”Ÿæˆå‘½ä»¤è¡Œè§£æçš„é€»è¾‘ã€‚</li><li>æ¯ä¸ªå­—æ®µéƒ½å¯¹åº”ä¸€ä¸ªå‘½ä»¤è¡Œå‚æ•°ï¼Œå­—æ®µçš„ç±»å‹å’Œå±æ€§ç”¨æ¥å†³å®šå‚æ•°çš„è§£ææ–¹å¼å’ŒéªŒè¯è§„åˆ™ã€‚</li></ul><p><code>#[command(version, about, long_about = None)]</code>å±æ€§ç”¨äºä¸ºæ•´ä¸ªå‘½ä»¤è¡Œç¨‹åºæä¾›å…ƒä¿¡æ¯ï¼Œå®ƒæ”¯æŒä»¥ä¸‹å‡ ä¸ªå…ƒç´ ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240301202114143.png"alt="#[command] æ”¯æŒçš„å…ƒç´ " /><figcaption aria-hidden="true">#[command] æ”¯æŒçš„å…ƒç´ </figcaption></figure><p><code>#[arg(short, long)]</code>å±æ€§ç”¨äºé…ç½®å‘½ä»¤å‚æ•°çš„å…ƒä¿¡æ¯ï¼Œå®ƒæ”¯æŒä»¥ä¸‹å‡ ä¸ªå±æ€§ï¼š</p><table><thead><tr class="header"><th>å±æ€§</th><th>æ–¹æ³•</th><th>é»˜è®¤å€¼/è¡Œä¸º</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr class="odd"><td>id</td><td>Arg::id</td><td>fieldâ€™s name</td><td>å½“å±æ€§ä¸å­˜åœ¨æ—¶ï¼Œä½¿ç”¨å­—æ®µå</td></tr><tr class="even"><td>value_parser</td><td>Arg::value_parser</td><td>auto-select based on field type</td><td>å½“å±æ€§ä¸å­˜åœ¨æ—¶ï¼Œä¼šåŸºäºå­—æ®µç±»å‹è‡ªåŠ¨é€‰æ‹©å®ç°</td></tr><tr class="odd"><td>action</td><td>Arg::action</td><td>auto-select based on field type</td><td>å½“å±æ€§ä¸å­˜åœ¨æ—¶ï¼Œä¼šåŸºäºå­—æ®µç±»å‹è‡ªåŠ¨é€‰æ‹©åŠ¨ä½œ</td></tr><tr class="even"><td>help</td><td>Arg::help</td><td>Doc comment summary</td><td>å½“å±æ€§ä¸å­˜åœ¨æ—¶ï¼Œä½¿ç”¨æ–‡æ¡£æ³¨é‡Šæ‘˜è¦</td></tr><tr class="odd"><td>long_help</td><td>Arg::long_help</td><td>Doc comment with blank line, else nothing</td><td>å½“å±æ€§ä¸å­˜åœ¨æ—¶ï¼Œä½¿ç”¨æ–‡æ¡£æ³¨é‡Šï¼Œå¦‚æœæœ‰ç©ºè¡Œ</td></tr><tr class="even"><td>verbatim_doc_comment</td><td>Minimizes preprocessing</td><td>-</td><td>å°†æ–‡æ¡£æ³¨é‡Šè½¬æ¢ä¸º help/long_help æ—¶æœ€å°åŒ–é¢„å¤„ç†</td></tr><tr class="odd"><td>short</td><td>Arg::short</td><td>no short set</td><td>å½“å±æ€§ä¸å­˜åœ¨æ—¶ï¼Œæ²¡æœ‰çŸ­åç§°è®¾ç½®</td></tr><tr class="even"><td>long</td><td>Arg::long</td><td>no long set</td><td>å½“å±æ€§ä¸å­˜åœ¨æ—¶ï¼Œæ²¡æœ‰é•¿åç§°è®¾ç½®</td></tr><tr class="odd"><td>env</td><td>Arg::env</td><td>no env set</td><td>å½“å±æ€§ä¸å­˜åœ¨æ—¶ï¼Œæ²¡æœ‰ç¯å¢ƒå˜é‡è®¾ç½®</td></tr><tr class="even"><td>from_global</td><td>Read Arg::global</td><td>-</td><td>æ— è®ºåœ¨å“ªä¸ªå­å‘½ä»¤ä¸­ï¼Œéƒ½è¯»å– Arg::global å‚æ•°</td></tr><tr class="odd"><td>value_enum</td><td>Parse with ValueEnum</td><td>-</td><td>ä½¿ç”¨ ValueEnum è§£æå€¼</td></tr><tr class="even"><td>skip</td><td>Ignore this field</td><td>fills the field with Default::default()</td><td>å¿½ç•¥æ­¤å­—æ®µï¼Œç”¨ &lt;expr&gt; æˆ– Default::default() å¡«å……</td></tr><tr class="odd"><td>default_value</td><td>Arg::default_value</td><td>Arg::required(false)</td><td>è®¾ç½®é»˜è®¤å€¼ï¼Œå¹¶å°† Arg è®¾ç½®ä¸ºéå¿…é¡»</td></tr><tr class="even"><td>default_value_t</td><td>Arg::default_value</td><td>Arg::required(false)</td><td>è¦æ±‚ std::fmt::Display ä¸ Arg::value_parser ç›¸åŒ¹é…</td></tr><tr class="odd"><td>default_values_t</td><td>Arg::default_values</td><td>Arg::required(false)</td><td>è¦æ±‚å­—æ®µç±»å‹ä¸º Vec&lt;T&gt;ï¼ŒT å®ç° std::fmt::Display</td></tr><tr class="even"><td>default_value_os_t</td><td>Arg::default_value_os</td><td>Arg::required(false)</td><td>è¦æ±‚ std::convert::Into&lt;OsString&gt;</td></tr><tr class="odd"><td>default_values_os_t</td><td>Arg::default_values_os</td><td>Arg::required(false)</td><td>è¦æ±‚å­—æ®µç±»å‹ä¸º Vec&lt;T&gt;ï¼ŒTå®ç°std::convert::Into&lt;OsString&gt;</td></tr></tbody></table><h3 id="å‚æ•°ç±»å‹">2. å‚æ•°ç±»å‹</h3><h4 id="arguments-options">2.1 Arguments &amp; Options</h4><p>ä»ä¸Šé¢è¿™ä¸ªè¾“å‡ºæ ·ä¾‹ä¸­ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">the example of clap derive<br><br>Usage: derive [OPTIONS] &lt;NAME&gt;<br><br>Arguments:<br>  &lt;NAME&gt;  Specify your name<br><br>Options:<br>  -a, --age &lt;AGE&gt;  Specify your age optionally<br>  -h, --<span class="hljs-built_in">help</span>       Print <span class="hljs-built_in">help</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è·Ÿåœ¨å‘½ä»¤åé¢æœ‰ 2 ä¸­å‚æ•°ç±»å‹ï¼š</p><ul><li><strong>Arguments</strong>: ç›´æ¥åœ¨å‘½ä»¤åé¢æŒ‡å®šå€¼ï¼Œå¦‚<code>cmd hedon</code>ï¼Œæœ‰ä¸¥æ ¼çš„é¡ºåºè¦æ±‚ã€‚</li><li><strong>Options</strong>: éœ€è¦ç”¨ <code>-&#123;short&#125;</code> æˆ–<code>--&#123;long&#125;</code> æ¥æŒ‡å®šæ˜¯å“ªä¸ªå‚æ•°ï¼Œæ— ä¸¥æ ¼çš„é¡ºåºè¦æ±‚ã€‚</li></ul><p>å®ƒä»¬çš„å®šä¹‰åŒºåˆ«å°±æ˜¯æ˜¯å¦ä½¿ç”¨äº† <code>#[arg]</code>ï¼š</p><ul><li><strong>Options</strong>: æŒ‡å®šäº† short æˆ– longã€‚</li><li><strong>Arguments</strong>: æ²¡æœ‰ short å’Œ longã€‚</li></ul><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cli</span> &#123;<br>  <span class="hljs-comment">/// ä¼šè¢«è§£ææˆ [NAME]</span><br>  name: <span class="hljs-type">String</span>,<br>  <br>  <span class="hljs-comment">/// ä¼šè¢«è§£ææˆ -a &lt;AGE&gt;</span><br>  <span class="hljs-meta">#[arg(short, long)]</span><br>  age: <span class="hljs-type">u8</span>,<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å¯é€‰å‚æ•°">2.2 å¯é€‰å‚æ•°</h4><p>å¯ä»¥ä½¿ç”¨ <code>Option</code> æ¥å®ç°å¯é€‰å‚æ•°ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::Parser;<br><br><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(version, author, about, long_about = None)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cli</span> &#123;<br>    name: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">String</span>&gt;,<br><br>    <span class="hljs-meta">#[arg(short, long)]</span><br>    age: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">u8</span>&gt;,<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cli</span> = Cli::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;name: &#123;:?&#125;&quot;</span>, cli.name);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;age: &#123;:?&#125;&quot;</span>, cli.age);<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo build --example optional --release<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">/target/release/examples/optional --<span class="hljs-built_in">help</span> <br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">this is the about from Cargo.toml<br><br>Usage: optional [OPTIONS] [NAME]<br><br>Arguments:<br>  [NAME]  <br><br>Options:<br>  -a, --age &lt;AGE&gt;  <br>  -h, --<span class="hljs-built_in">help</span>       Print <span class="hljs-built_in">help</span><br>  -V, --version    Print version<br></code></pre></td></tr></table></figure><p>æµ‹è¯•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  learn-clap git:(master) âœ— ./target/release/examples/optional       <br>name: None<br>age: None<br>âœ  learn-clap git:(master) âœ— ./target/release/examples/optional -a 1  <br>name: None<br>age: Some(1)<br>âœ  learn-clap git:(master) âœ— ./target/release/examples/optional hedon  <br>name: Some(<span class="hljs-string">&quot;hedon&quot;</span>)<br>age: None<br>âœ  learn-clap git:(master) âœ— ./target/release/examples/optional hedon -a 18<br>name: Some(<span class="hljs-string">&quot;hedon&quot;</span>)<br>age: Some(18)<br></code></pre></td></tr></table></figure><h4 id="æšä¸¾å‚æ•°">2.3 æšä¸¾å‚æ•°</h4><p>å¯ä»¥ä½¿ç”¨ <code>enum</code> æ­é… <code>value_enum</code>æ¥å®ç°å¤šé€‰ä¸€å‚æ•°ï¼Œå¹¶é™åˆ¶å¯é€‰å‚æ•°çš„å–å€¼ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::&#123;Parser, ValueEnum&#125;;<br><br><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(version, author, about, long_about = None)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cli</span> &#123;<br>    <span class="hljs-comment">/// Choose the program mode run in</span><br>    <span class="hljs-meta">#[arg(value_enum)]</span><br>    mode: Mode,<br>&#125;<br><br><span class="hljs-meta">#[derive(Copy, Clone, PartialEq, Eq, PartialOrd, Ord, ValueEnum)]</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Mode</span> &#123;<br>    <span class="hljs-comment">/// run in fast mode</span><br>    Fast,<br>    <span class="hljs-comment">/// run in slow mode</span><br>    Slow,<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cli</span> = Cli::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-keyword">match</span> cli.mode &#123;<br>        Mode::Fast =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;fast!!!!!&quot;</span>),<br>        Mode::Slow =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;slow......&quot;</span>),<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">Usage: enum &lt;MODE&gt;<br><br>Arguments:<br>  &lt;MODE&gt;<br>          Choose the program mode run <span class="hljs-keyword">in</span><br><br>          Possible values:<br>          - fast: run <span class="hljs-keyword">in</span> fast mode<br>          - slow: run <span class="hljs-keyword">in</span> slow mode<br><br>Options:<br>  -h, --<span class="hljs-built_in">help</span><br>          Print <span class="hljs-built_in">help</span> (see a summary with <span class="hljs-string">&#x27;-h&#x27;</span>)<br><br>  -V, --version<br>          Print version<br></code></pre></td></tr></table></figure><h4 id="ç´¯è®¡å‚æ•°">2.4 ç´¯è®¡å‚æ•°</h4><p>ç´¯ç§¯å‚æ•°å…è®¸ç”¨æˆ·é€šè¿‡é‡å¤æŒ‡å®šåŒä¸€ä¸ªæ ‡å¿—ï¼ˆä¾‹å¦‚<code>-d</code>ï¼‰æ¥ç´¯åŠ å€¼æˆ–æ•ˆæœï¼Œé€šå¸¸ç”¨äºæ§åˆ¶å‘½ä»¤è¡Œåº”ç”¨çš„è¯¦ç»†çº§åˆ«ï¼ˆverbositylevelï¼‰æˆ–å…¶ä»–éœ€è¦æ ¹æ®æ¬¡æ•°å˜åŒ–çš„è¡Œä¸ºã€‚</p><p>åœ¨å¾ˆå¤šå‘½ä»¤è¡Œå·¥å…·ä¸­ï¼Œç´¯ç§¯å‚æ•°å¸¸è§äºæ§åˆ¶æ—¥å¿—è¾“å‡ºçš„è¯¦ç»†ç¨‹åº¦ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ª<code>-v</code>ï¼ˆverboseï¼‰æ ‡å¿—å¯èƒ½æ¯è¢«æŒ‡å®šä¸€æ¬¡ï¼Œå°±å¢åŠ ä¸€å±‚è¯¦ç»†çº§åˆ«ã€‚æ‰€ä»¥ï¼Œ<code>-vvv</code>ï¼ˆç­‰ä»·äº<code>-v -v -v</code>ï¼‰ ä¼šæ¯”å•ä¸ª <code>-v</code>æä¾›æ›´å¤šçš„è¯¦ç»†ä¿¡æ¯ã€‚</p><p>åœ¨ <code>clap</code> ä¸­å¯ä»¥é€šè¿‡ <code>clap::ArgAction::Count</code>æ¥å®ç°è¿™ç§ç´¯ç§¯å‚æ•°ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::Parser;<br><br><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(version, author, about, long_about = None)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cli</span> &#123;<br>    <span class="hljs-meta">#[arg(short, long, action = clap::ArgAction::Count)]</span><br>    verbose: <span class="hljs-type">u8</span>,<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cli</span> = Cli::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;verbose: &#123;&#125;&quot;</span>, cli.verbose);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  learn-clap git:(master) âœ— ./target/release/examples/accurate --<span class="hljs-built_in">help</span><br>this is the about from Cargo.toml<br><br>Usage: accurate [OPTIONS]<br><br>Options:<br>  -v, --verbose...  <br>  -h, --<span class="hljs-built_in">help</span>        Print <span class="hljs-built_in">help</span><br>  -V, --version     Print version<br>âœ  learn-clap git:(master) âœ— ./target/release/examples/accurate -v    <br>verbose: 1<br>âœ  learn-clap git:(master) âœ— ./target/release/examples/accurate -vvvv<br>verbose: 4<br></code></pre></td></tr></table></figure><h4 id="å˜é•¿å‚æ•°">2.5 å˜é•¿å‚æ•°</h4><p>æœ‰æ—¶å€™æˆ‘ä»¬å¸Œæœ›æ¥æ”¶å˜é•¿å‚æ•°ï¼Œæ¯”å¦‚è¯´ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">del file1 file2 file3<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™å¯ä»¥ä½¿ç”¨ <code>Vec&lt;&gt;</code> æ¥å®ç°ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::Parser;<br><br><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(version, author, about, long_about = None)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cli</span> &#123;<br>    files: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">String</span>&gt;,<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cli</span> = Cli::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;files: &#123;:?&#125;&quot;</span>, cli.files);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  learn-clap git:(master) âœ— ./target/release/examples/var_length --<span class="hljs-built_in">help</span><br>this is the about from Cargo.toml<br><br>Usage: var_length [FILES]...<br><br>Arguments:<br>  [FILES]...  <br><br>Options:<br>  -h, --<span class="hljs-built_in">help</span>     Print <span class="hljs-built_in">help</span><br>  -V, --version  Print version<br>âœ  learn-clap git:(master) âœ— ./target/release/examples/var_length       <br>files: []<br>âœ  learn-clap git:(master) âœ— ./target/release/examples/var_length file1 <br>files: [<span class="hljs-string">&quot;file1&quot;</span>]<br>âœ  learn-clap git:(master) âœ— ./target/release/examples/var_length file1 file2<br>files: [<span class="hljs-string">&quot;file1&quot;</span>, <span class="hljs-string">&quot;file2&quot;</span>]<br>âœ  learn-clap git:(master) âœ— ./target/release/examples/var_length file1 file2 file3<br>files: [<span class="hljs-string">&quot;file1&quot;</span>, <span class="hljs-string">&quot;file2&quot;</span>, <span class="hljs-string">&quot;file3&quot;</span>]<br></code></pre></td></tr></table></figure><h4 id="æ ‡å¿—å‚æ•°">2.6 æ ‡å¿—å‚æ•°</h4><p>å¯¹äºæ ‡å¿—å‚æ•°ï¼Œåªè¦æŒ‡å®šç±»å‹ä¸º<code>bool</code>ï¼Œå°±å¯ä»¥è‡ªåŠ¨å®ç°äº†ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::Parser;<br><br><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(version, author, about, long_about = None)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cli</span> &#123;<br>    <span class="hljs-meta">#[arg(short, long)]</span><br>    verbose: <span class="hljs-type">bool</span>,<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cli</span> = Cli::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;verbose: &#123;&#125;&quot;</span>, cli.verbose);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  learn-clap git:(master) âœ— ./target/release/examples/flag --<span class="hljs-built_in">help</span><br>Usage: flag [OPTIONS]<br><br>Options:<br>  -v, --verbose  <br>  -h, --<span class="hljs-built_in">help</span>     Print <span class="hljs-built_in">help</span><br>  -V, --version  Print version<br>âœ  learn-clap git:(master) âœ— ./target/release/examples/flag       <br>verbose: <span class="hljs-literal">false</span><br>âœ  learn-clap git:(master) âœ— ./target/release/examples/flag -v    <br>verbose: <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><h4 id="å­å‘½ä»¤">2.7 å­å‘½ä»¤</h4><p>åœ¨æ›´å¤æ‚çš„å‘½ä»¤è¡Œå·¥å…·ä¸­ï¼Œé™¤äº†ä¸»å‘½ä»¤ï¼Œè¿˜æœ‰å­å‘½ä»¤ï¼Œç”šè‡³å­å‘½ä»¤ä¸‹é¢è¿˜æœ‰å­å‘½ä»¤ï¼Œå…¶å®å°±æ˜¯ä¸€é¢—å‘½ä»¤æ ‘ã€‚</p><figure><imgsrc="https://cdn.jsdelivr.net/gh/hedon954/mapStorage/img/image-20240228183301763.png"alt="command tree" /><figcaption aria-hidden="true">command tree</figcaption></figure><p>åœ¨ <code>clap</code> ä¸­å¯ä»¥ä½¿ç”¨ <code>#[command(subcommand)]</code>æ­é… <code>#[derive(Subcommand)]</code> å®ç°å­å‘½ä»¤åŠŸèƒ½ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::&#123;Parser, Subcommand&#125;;<br><br><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(version, author, about, long_about = None)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cli</span> &#123;<br>    <span class="hljs-meta">#[command(subcommand)]</span><br>    test: <span class="hljs-type">Option</span>&lt;Test&gt;,<br>&#125;<br><br><span class="hljs-meta">#[derive(Subcommand)]</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-comment">/// Add a number</span><br>    Add &#123;<br>        <span class="hljs-meta">#[arg(short, long)]</span><br>        num: <span class="hljs-type">u16</span>,<br>    &#125;,<br>    <span class="hljs-comment">/// Sub a number</span><br>    Sub &#123;<br>        <span class="hljs-meta">#[arg(short, long)]</span><br>        num: <span class="hljs-type">u16</span>,<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cli</span> = Cli::<span class="hljs-title function_ invoke__">parse</span>();<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(test) = cli.test &#123;<br>        <span class="hljs-keyword">match</span> test &#123;<br>            Test::Add &#123;num&#125; =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;test add num: &#123;:?&#125;&quot;</span>, num),<br>            Test::Sub &#123;num&#125; =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;test sub num: &#123;:?&#125;&quot;</span>, num),<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  learn-clap git:(master) âœ— ./target/release/examples/subcommand --<span class="hljs-built_in">help</span>      <br>this is the about from Cargo.toml<br><br>Usage: subcommand [COMMAND]<br><br>Commands:<br>  add   Add a number<br>  sub   Sub a number<br>  <span class="hljs-built_in">help</span>  Print this message or the <span class="hljs-built_in">help</span> of the given subcommand(s)<br><br>Options:<br>  -h, --<span class="hljs-built_in">help</span>     Print <span class="hljs-built_in">help</span><br>  -V, --version  Print version<br>âœ  learn-clap git:(master) âœ— ./target/release/examples/subcommand add --<span class="hljs-built_in">help</span><br>Add a number<br><br>Usage: subcommand add --num &lt;NUM&gt;<br><br>Options:<br>  -n, --num &lt;NUM&gt;  <br>  -h, --<span class="hljs-built_in">help</span>       Print <span class="hljs-built_in">help</span><br>âœ  learn-clap git:(master) âœ— ./target/release/examples/subcommand add -n 1  <br><span class="hljs-built_in">test</span> add num: 1<br>âœ  learn-clap git:(master) âœ— ./target/release/examples/subcommand sub -n 2<br><span class="hljs-built_in">test</span> sub num: 2<br></code></pre></td></tr></table></figure><h3 id="å‚æ•°æ ¡éªŒ">3. å‚æ•°æ ¡éªŒ</h3><h4 id="ç±»å‹æ ¡éªŒ">3.1 ç±»å‹æ ¡éªŒ</h4><p>å¯ä»¥å‘ç°ï¼Œä½¿ç”¨ Deriveæ¨¡å¼çš„æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨å‚æ•°åé¢æŒ‡å®šå‚æ•°ç±»å‹çš„æ—¶å€™ï¼Œ<code>clap</code>å°±ä¼šå¯¹æˆ‘ä»¬è¾“å…¥å‚æ•°è¿›è¡Œç±»å‹æ£€æŸ¥ï¼Œä¸åŒ¹é…çš„æ—¶å€™ä¼šè¾“å‡ºä¸°å¯Œçš„æŠ¥é”™ä¿¡æ¯å’ŒæŒ‡å¯¼å»ºè®®ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">error: invalid value <span class="hljs-string">&#x27;xxxx&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;--num &lt;NUM&gt;&#x27;</span>: invalid digit found <span class="hljs-keyword">in</span> string<br><br>For more information, try <span class="hljs-string">&#x27;--help&#x27;</span>.<br></code></pre></td></tr></table></figure><p>é»˜è®¤æ”¯æŒï¼š</p><ul><li>åŸç”Ÿç±»å‹ï¼š<code>bool</code>, <code>String</code>,<code>OsString</code>,<code>PathBuf</code>ã€<code>usize</code>ã€<code>isize</code></li><li>èŒƒå›´æ•°æ®ï¼š<code>u8</code>, <code>i8</code>, <code>u16</code>,<code>i16</code>, <code>u32</code>, <code>i32</code>, <code>u64</code>,<code>i64</code></li><li>å®ç°äº† <code>ValueEnum</code> çš„ enum ç±»å‹</li><li>å®ç°äº†<code>From&lt;OsString&gt;</code>ã€<code>From&lt;&amp;OsStr&gt;</code>ã€<code>FromStr</code> çš„ç±»å‹</li></ul><p>è¿™æ˜¯å› ä¸ºä»–ä»¬éƒ½å®ç°äº† <code>TypedValueParser</code>traitï¼Œä½ è‡ªå®šä¹‰çš„ç±»å‹ä¹Ÿå¯ä»¥å®ç°è¿™ä¸ªtriatï¼Œè¿™æ ·å°±å¯ä»¥è‡ªåŠ¨è¿›è¡Œç±»å‹æ ¡éªŒäº†ã€‚</p><p><code>clap</code> è¿˜æä¾›äº†ä¸€äº›æ›´åŠ ä¸¥æ ¼çš„å‚æ•°æ ¡éªŒåŠŸèƒ½ã€‚ğŸ‘‡ğŸ»</p><h4 id="æšä¸¾æ ¡éªŒ">3.2 æšä¸¾æ ¡éªŒ</h4><p>å¯¹äºå®ç° <code>ValueEnum</code>çš„æšä¸¾ç±»å‹ï¼Œå¦‚æœè¾“å…¥çš„å€¼ä¸æ˜¯æšä¸¾ä¸­å®šä¹‰çš„ï¼Œåˆ™ <code>clap</code>ä¼šæŠ¥é”™å¹¶æç¤ºå¯é€‰å€¼ã€‚</p><p>æˆ‘ä»¬å¤ç”¨ä¸Šé¢ä»‹ç»ã€Œå¤šé€‰ä¸€å‚æ•°ã€çš„ä»£ç ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::&#123;Parser, ValueEnum&#125;;<br><br><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(version, author, about, long_about = None)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cli</span> &#123;<br>    <span class="hljs-comment">/// Choose the program mode run in</span><br>    <span class="hljs-meta">#[arg(value_enum)]</span><br>    mode: Mode,<br>&#125;<br><br><span class="hljs-meta">#[derive(Copy, Clone, PartialEq, Eq, PartialOrd, Ord, ValueEnum)]</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Mode</span> &#123;<br>    <span class="hljs-comment">/// run in fast mode</span><br>    Fast,<br>    <span class="hljs-comment">/// run in slow mode</span><br>    Slow,<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cli</span> = Cli::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-keyword">match</span> cli.mode &#123;<br>        Mode::Fast =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;fast!!!!!&quot;</span>),<br>        Mode::Slow =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;slow......&quot;</span>),<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨é”™è¯¯çš„å€¼è¿›è¡Œå°è¯•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  learn-clap git:(master) âœ— ./target/release/examples/enum xxxx               <br>error: invalid value <span class="hljs-string">&#x27;xxxx&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;&lt;MODE&gt;&#x27;</span><br>  [possible values: fast, slow]<br><br>For more information, try <span class="hljs-string">&#x27;--help&#x27;</span>.<br></code></pre></td></tr></table></figure><h4 id="èŒƒå›´æ ¡éªŒ">3.3 èŒƒå›´æ ¡éªŒ</h4><p>å¦‚æœä½ æƒ³è¦å®ç°æ•°å­—ç±»å‹èŒƒå›´é™åˆ¶çš„è¯ï¼Œæ¯”å¦‚ç«¯å£å·å‚æ•°çš„èŒƒå›´åº”è¯¥æ˜¯ [1,65535]ï¼Œé‚£å¯ä»¥ä½¿ç”¨<code>value_parser! = clap::value_parser!(u16).range(1..)</code>æ¥å®ç°è¿™ä¸ªåŠŸèƒ½ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::Parser;<br><br><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(version, author, about, long_about = None)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cli</span> &#123;<br>    <span class="hljs-meta">#[arg(short, long, value_parser = clap::value_parser!(u16).range(1..))]</span><br>    port: <span class="hljs-type">u16</span>,<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cli</span> = Cli::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;port: &#123;:?&#125;&quot;</span>, cli.port);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  learn-clap git:(master) âœ— ./target/release/examples/range --<span class="hljs-built_in">help</span>             <br>this is the about from Cargo.toml<br><br>Usage: range --port &lt;PORT&gt;<br><br>Options:<br>  -p, --port &lt;PORT&gt;  <br>  -h, --<span class="hljs-built_in">help</span>         Print <span class="hljs-built_in">help</span><br>  -V, --version      Print version<br>  <br>âœ  learn-clap git:(master) âœ— ./target/release/examples/range -p 0  <br>error: invalid value <span class="hljs-string">&#x27;0&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;--port &lt;PORT&gt;&#x27;</span>: 0 is not <span class="hljs-keyword">in</span> 1..=65535<br><br>For more information, try <span class="hljs-string">&#x27;--help&#x27;</span>.<br><br>âœ  learn-clap git:(master) âœ— ./target/release/examples/range -p 11111111<br>error: invalid value <span class="hljs-string">&#x27;11111111&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;--port &lt;PORT&gt;&#x27;</span>: 11111111 is not <span class="hljs-keyword">in</span> 1..=65535<br><br>For more information, try <span class="hljs-string">&#x27;--help&#x27;</span>.<br><br>âœ  learn-clap git:(master) âœ— ./target/release/examples/range -p 1111    <br>port: 1111<br></code></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>value_parser = clap::value_parser!(u16).range(1..)</code>çš„å«ä¹‰å¯ä»¥åˆ†ä¸ºä¸¤éƒ¨åˆ†è§£é‡Šï¼š</p><p><strong>1. clap::value_parser!(u16)</strong></p><p>è¿™éƒ¨åˆ†ä½¿ç”¨ <code>value_parser!</code> å®ä¸ºå‘½ä»¤è¡Œå‚æ•°æŒ‡å®šäº†<code>u16</code> ç±»å‹çš„è§£æå™¨ã€‚è¿™æ„å‘³ç€è¾“å…¥çš„å‚æ•°å€¼ä¼šè¢«å°è¯•è§£æä¸ºæ— ç¬¦å·16 ä½æ•´æ•°ï¼ˆ<code>u16</code>ï¼‰ã€‚å¦‚æœè¾“å…¥ä¸èƒ½è¢«æˆåŠŸè§£æä¸º <code>u16</code>ç±»å‹ï¼ˆä¾‹å¦‚ï¼Œè¾“å…¥æ˜¯éæ•°å­—å­—ç¬¦ä¸²æˆ–è€…æ•°å­—è¿‡å¤§/è¿‡å°è€Œä¸ç¬¦åˆ <code>u16</code>çš„èŒƒå›´ï¼‰ï¼Œ<code>clap</code> ä¼šæŠ¥é”™å¹¶æç¤ºç”¨æˆ·è¾“å…¥æœ‰æ•ˆçš„å‚æ•°å€¼ã€‚</p><p><strong>2. .range(1..)</strong></p><p>è¿™éƒ¨åˆ†è¿›ä¸€æ­¥é™åˆ¶äº†å‚æ•°å€¼çš„æœ‰æ•ˆèŒƒå›´ã€‚<code>.range(1..)</code>æŒ‡å®šäº†å‚æ•°å€¼å¿…é¡»å¤§äºæˆ–ç­‰äº 1ï¼ˆåŒ…å« 1ï¼‰ï¼Œä½†æ²¡æœ‰ä¸Šé™ã€‚æ¢å¥è¯è¯´ï¼Œä»»ä½•å°äº 1çš„å€¼éƒ½å°†è¢«è®¤ä¸ºæ˜¯æ— æ•ˆçš„ï¼Œ<code>clap</code>ä¼šå› æ­¤æŠ¥é”™å¹¶è¦æ±‚ç”¨æˆ·è¾“å…¥ä¸€ä¸ªç¬¦åˆèŒƒå›´è¦æ±‚çš„å€¼ã€‚è¿™åœ¨éœ€è¦é™å®šå‚æ•°å€¼ä¸ºæ­£æ•°æ—¶éå¸¸æœ‰ç”¨ã€‚</p><p>ç»“åˆèµ·æ¥ï¼Œ<code>value_parser = clap::value_parser!(u16).range(1..)</code>åˆ›å»ºäº†ä¸€ä¸ªè§„åˆ™ï¼Œè¦æ±‚å‘½ä»¤è¡Œå‚æ•°å¿…é¡»æ˜¯ä¸€ä¸ªå¤§äºæˆ–ç­‰äº 1 çš„ <code>u16</code>ç±»å‹çš„æ•°å€¼ã€‚è¿™åœ¨å¾ˆå¤šåœºæ™¯ä¸‹éƒ½éå¸¸æœ‰ç”¨ï¼Œæ¯”å¦‚å½“ä½ éœ€è¦ç”¨æˆ·æŒ‡å®šä¸€ä¸ªæ­£æ•°ç«¯å£å·æ—¶ã€‚</p><p>åœ¨ RustRover ä¸­ï¼Œä½ å¯ä»¥åœ¨ Builder æ¨¡å¼ï¼Œé€šè¿‡åœ¨<code>clap::value_parser!()</code> ä¸­æŒ‡å®šå…¶ä»–çš„ç±»å‹ï¼Œç„¶åè¾“å…¥<code>.</code> è·å¾—å…¶ä»–ç±»å‹çš„å†…ç½®æ ¡éªŒè§„åˆ™ã€‚</p><h4 id="è‡ªå®šä¹‰æ ¡éªŒ">3.4 è‡ªå®šä¹‰æ ¡éªŒ</h4><p>å¯¹äºæ›´å¤æ‚çš„è§„åˆ™ï¼Œ<code>clap</code> è¿˜æ”¯æŒè‡ªå®šä¹‰æ ¡éªŒè§„åˆ™ã€‚æ¯”å¦‚ä¸Šé¢å¯¹port çš„æ ¡éªŒï¼Œä¹Ÿå¯ä»¥è‡ªå·±å®ç°ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> std::ops::RangeInclusive;<br><span class="hljs-keyword">use</span> clap::Parser;<br><br><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(version, author, about, long_about = None)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cli</span> &#123;<br>    <span class="hljs-meta">#[arg(short, long, value_parser = parse_port)]</span><br>    port: <span class="hljs-type">u16</span>,<br>&#125;<br><br><span class="hljs-keyword">const</span> PORT_RANGE: RangeInclusive&lt;<span class="hljs-type">usize</span>&gt; = <span class="hljs-number">1</span>..=<span class="hljs-number">65535</span>;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">parse_port</span>(s: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-type">u16</span>, <span class="hljs-type">String</span>&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">port</span>: <span class="hljs-type">usize</span> = s<br>        .<span class="hljs-title function_ invoke__">parse</span>()<br>        .<span class="hljs-title function_ invoke__">map_err</span>(|_| <span class="hljs-built_in">format!</span>(<span class="hljs-string">&quot;`&#123;s&#125;` isn&#x27;t a port number`&quot;</span>))?;<br><br>    <span class="hljs-keyword">if</span> PORT_RANGE.<span class="hljs-title function_ invoke__">contains</span>(&amp;port) &#123;<br>        <span class="hljs-title function_ invoke__">Ok</span>(port <span class="hljs-keyword">as</span> <span class="hljs-type">u16</span>)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-title function_ invoke__">Err</span>(<span class="hljs-built_in">format!</span>(<br>            <span class="hljs-string">&quot;port not in range &#123;&#125;-&#123;&#125;&quot;</span>,<br>            PORT_RANGE.<span class="hljs-title function_ invoke__">start</span>(),<br>            PORT_RANGE.<span class="hljs-title function_ invoke__">end</span>(),<br>        ))<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cli</span> = Cli::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;port: &#123;:?&#125;&quot;</span>, cli.port);<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ä»£ç ä¸­ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ <code>value_parser = parse_port</code>æ¥æŒ‡å®šè‡ªå®šä¹‰çš„æ ¡éªŒè§„åˆ™ã€‚</p><p>æˆ‘ä»¬è‡ªå®šä¹‰çš„æ ¡éªŒè§„åˆ™ä¸ºï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">parse_port</span>(s: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-type">u16</span>, <span class="hljs-type">String</span>&gt; &#123;&#125;<br></code></pre></td></tr></table></figure><p>å®ƒéœ€è¦æ»¡è¶³ï¼š</p><ul><li>å…¥å‚æ˜¯ &amp;str</li><li>å‡ºå‚æ˜¯ Result&lt;å‚æ•°ç±»å‹, String&gt;</li></ul><p>å¯ä»¥æµ‹è¯•è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  learn-clap git:(master) âœ— ./target/release/examples/custom --<span class="hljs-built_in">help</span><br>this is the about from Cargo.toml<br><br>Usage: custom --port &lt;PORT&gt;<br><br>Options:<br>  -p, --port &lt;PORT&gt;  <br>  -h, --<span class="hljs-built_in">help</span>         Print <span class="hljs-built_in">help</span><br>  -V, --version      Print version<br>  <br>âœ  learn-clap git:(master) âœ— ./target/release/examples/custom -p xxx<br>error: invalid value <span class="hljs-string">&#x27;xxx&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;--port &lt;PORT&gt;&#x27;</span>: `xxx` isn<span class="hljs-string">&#x27;t a port number`</span><br><span class="hljs-string"></span><br><span class="hljs-string">For more information, try &#x27;</span>--<span class="hljs-built_in">help</span><span class="hljs-string">&#x27;.</span><br><span class="hljs-string"></span><br><span class="hljs-string">âœ  learn-clap git:(master) âœ— ./target/release/examples/custom -p 0  </span><br><span class="hljs-string">error: invalid value &#x27;</span>0<span class="hljs-string">&#x27; for &#x27;</span>--port &lt;PORT&gt;<span class="hljs-string">&#x27;: port not in range 1-65535</span><br><span class="hljs-string"></span><br><span class="hljs-string">For more information, try &#x27;</span>--<span class="hljs-built_in">help</span><span class="hljs-string">&#x27;.</span><br><span class="hljs-string"></span><br><span class="hljs-string">âœ  learn-clap git:(master) âœ— ./target/release/examples/custom -p 9527</span><br><span class="hljs-string">port: 9527</span><br></code></pre></td></tr></table></figure><h4 id="å…³è”å‚æ•°">3.5 å…³è”å‚æ•°</h4><p>æœ‰æ—¶å€™å‚æ•°ç›´æ¥è¿˜æœ‰å…³è”å…³ç³»ï¼Œæ¯”å¦‚è¯´ï¼š</p><ul><li>ä¾èµ–ï¼šå¿…é¡»å­˜åœ¨ <code>-a</code> å‚æ•°ï¼Œ<code>-b</code>å‚æ•°æ‰æœ‰æ„ä¹‰ï¼Œå³è¦ä½¿ç”¨ <code>-b</code> å‚æ•°æ—¶ï¼Œå¿…é¡»æŒ‡å®š <code>-a</code>å‚æ•°ã€‚</li><li>äº’æ–¥ï¼š<code>-a</code> å’Œ <code>-b</code> åªèƒ½åŒæ—¶å­˜åœ¨ä¸€ä¸ªã€‚</li></ul><p><strong>å¯ä»¥ä½¿ç”¨ requires å®ç°ä¾èµ–å…³ç³»ï¼š</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::Parser;<br><br><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(version, author, about, long_about = None)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cli</span> &#123;<br>    <span class="hljs-meta">#[arg(short, long)]</span><br>    a: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">String</span>&gt;,<br><br>    <span class="hljs-meta">#[arg(short, long,requires = <span class="hljs-string">&quot;a&quot;</span>)]</span><br>    b: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">String</span>&gt;,<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cli</span> = Cli::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;a: &#123;:?&#125;&quot;</span>, cli.a);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;b: &#123;:?&#125;&quot;</span>, cli.b);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬åœ¨å‚æ•° <code>b</code> ä¸­åŠ å…¥äº†<code>requires = "a"</code>ï¼Œè¡¨ç¤ºè¦ä½¿ç”¨ <code>b</code> å‚æ•°å¿…é¡»è¦æœ‰<code>a</code> å‚æ•°ã€‚</p><p>è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  learn-clap git:(master) âœ— ./target/release/examples/relation      <br>a: None<br>b: None<br>âœ  learn-clap git:(master) âœ— ./target/release/examples/relation -b 1 <br>error: the following required arguments were not provided:<br>  --a &lt;A&gt;<br><br>Usage: relation --a &lt;A&gt; --b &lt;B&gt;<br><br>For more information, try <span class="hljs-string">&#x27;--help&#x27;</span>.<br><br>âœ  learn-clap git:(master) âœ— ./target/release/examples/relation -a 1<br>a: Some(<span class="hljs-string">&quot;1&quot;</span>)<br>b: None<br><br>âœ  learn-clap git:(master) âœ— ./target/release/examples/relation -a 1 -b 2<br>a: Some(<span class="hljs-string">&quot;1&quot;</span>)<br>b: Some(<span class="hljs-string">&quot;2&quot;</span>)<br></code></pre></td></tr></table></figure><p><strong>å¯ä»¥ä½¿ç”¨ #[group(required = true, mutiple = false)]æ¥å®ç°äº’æ–¥å…³ç³»ï¼š</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::&#123;Args, Parser&#125;;<br><br><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(version, author, about, long_about = None)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cli</span> &#123;<br>    <span class="hljs-meta">#[command(flatten)]</span><br>    args: Only,<br>&#125;<br><br><span class="hljs-meta">#[derive(Args, Debug)]</span><br><span class="hljs-meta">#[group(required = true, multiple = false)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Only</span> &#123;<br>    <span class="hljs-meta">#[arg(long)]</span><br>    a: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">String</span>&gt;,<br>    <span class="hljs-meta">#[arg(long)]</span><br>    b: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">String</span>&gt;,<br>    <span class="hljs-meta">#[arg(long)]</span><br>    c: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">String</span>&gt;,<br>    <span class="hljs-meta">#[arg(long)]</span><br>    d: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">String</span>&gt;,<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cli</span> = Cli::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;only: &#123;:?&#125;&quot;</span>, cli.args)<br>&#125;<br></code></pre></td></tr></table></figure><p><code>#[command(flattern)]</code> ç›´æ¥å°†ç»“æ„ä½“é‡Œé¢çš„å‚æ•°å¹³é“ºã€‚</p><p><code>#[group]</code>ç”¨äºå°†ä¸€ç»„å‚æ•°å½’ä¸ºä¸€ä¸ªç»„ï¼Œ<code>required = true</code> è¡¨ç¤ºå¿…é¡»æä¾›è¯¥group ä¸­çš„å‚æ•°ï¼Œ<code>multiple = false</code>è¡¨ç¤ºåªèƒ½æœ‰ä¸€ä¸ªå‚æ•°è¢«æä¾›ã€‚</p><p>æµ‹è¯•è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  learn-clap git:(master) âœ— ./target/release/examples/only_one --<span class="hljs-built_in">help</span><br>this is the about from Cargo.toml<br><br>Usage: only_one &lt;--a &lt;A&gt;|--b &lt;B&gt;|--c &lt;C&gt;|--d &lt;D&gt;&gt;<br><br>Options:<br>      --a &lt;A&gt;    <br>      --b &lt;B&gt;    <br>      --c &lt;C&gt;    <br>      --d &lt;D&gt;    <br>  -h, --<span class="hljs-built_in">help</span>     Print <span class="hljs-built_in">help</span><br>  -V, --version  Print version<br>  <br>âœ  learn-clap git:(master) âœ— ./target/release/examples/only_one       <br>error: the following required arguments were not provided:<br>  &lt;--a &lt;A&gt;|--b &lt;B&gt;|--c &lt;C&gt;|--d &lt;D&gt;&gt;<br><br>Usage: only_one &lt;--a &lt;A&gt;|--b &lt;B&gt;|--c &lt;C&gt;|--d &lt;D&gt;&gt;<br><br>For more information, try <span class="hljs-string">&#x27;--help&#x27;</span>.<br><br>âœ  learn-clap git:(master) âœ— ./target/release/examples/only_one --a 1      <br>only: Only &#123; a: Some(<span class="hljs-string">&quot;1&quot;</span>), b: None, c: None, d: None &#125;<br><br>âœ  learn-clap git:(master) âœ— ./target/release/examples/only_one --a 1 --b 2<br>error: the argument <span class="hljs-string">&#x27;--a &lt;A&gt;&#x27;</span> cannot be used with <span class="hljs-string">&#x27;--b &lt;B&gt;&#x27;</span><br><br>Usage: only_one &lt;--a &lt;A&gt;|--b &lt;B&gt;|--c &lt;C&gt;|--d &lt;D&gt;&gt;<br><br>For more information, try <span class="hljs-string">&#x27;--help&#x27;</span>.<br><br>âœ  learn-clap git:(master) âœ— ./target/release/examples/only_one --b 2      <br>only: Only &#123; a: None, b: Some(<span class="hljs-string">&quot;2&quot;</span>), c: None, d: None &#125;<br></code></pre></td></tr></table></figure><h2 id="builder">Builder</h2><p>ä½¿ç”¨ <code>clap</code> çš„ Builderæ¨¡å¼ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸éœ€è¦é¢å¤–å¼•å…¥å…¶ä»–çš„ featuresï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo add clap<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯å¦‚æœè¦ä½¿ç”¨ <code>command!</code> æ¥æ„å»ºåº”ç”¨çš„è¯ï¼Œéœ€è¦å¼•å…¥<code>cargo</code> è¿™ä¸ª featuresï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo add clap --features cargo<br></code></pre></td></tr></table></figure><h3 id="åº”ç”¨é…ç½®-1">1. åº”ç”¨é…ç½®</h3><p>åœ¨ Builder æ¨¡å¼ä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>command!()</code> æˆ–<code>Command::new("appname")</code> æ¥æ„å»ºä¸€ä¸ªå‘½ä»¤è¡Œåº”ç”¨ï¼Œå…¶ä¸­<code>command!()</code> é»˜è®¤å°† appname è®¾ç½®åº”ç”¨åç§°ï¼Œè€Œ<code>Command::new()</code> å¿…é¡»æ˜¾ç¤ºæŒ‡å®š appnameã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::&#123;arg, Arg, Command, command, value_parser&#125;;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-comment">// let matches = command!()</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">matches</span> = Command::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;MyApp&quot;</span>)<br>        <span class="hljs-comment">// Application configuration</span><br>        .<span class="hljs-title function_ invoke__">version</span>(<span class="hljs-string">&quot;1.0.0&quot;</span>)<br>        .<span class="hljs-title function_ invoke__">author</span>(<span class="hljs-string">&quot;hedon&quot;</span>)<br>        .<span class="hljs-title function_ invoke__">about</span>(<span class="hljs-string">&quot;This the intro of the cli application&quot;</span>)<br>        <span class="hljs-comment">// Application args</span><br>        .<span class="hljs-title function_ invoke__">arg</span>(arg!([NAME]).<span class="hljs-title function_ invoke__">help</span>(<span class="hljs-string">&quot;Specify your name&quot;</span>))<br>        .<span class="hljs-title function_ invoke__">arg</span>(<br>            Arg::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;age&quot;</span>).<span class="hljs-title function_ invoke__">short</span>(<span class="hljs-string">&#x27;a&#x27;</span>).<span class="hljs-title function_ invoke__">long</span>(<span class="hljs-string">&quot;age&quot;</span>).<span class="hljs-title function_ invoke__">value_parser</span>(value_parser!(<span class="hljs-type">u8</span>))<br>        )<br>    .<span class="hljs-title function_ invoke__">get_matches</span>();<br><br>    <span class="hljs-comment">// Read and parse command args</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(name) = matches.get_one::&lt;<span class="hljs-type">String</span>&gt;(<span class="hljs-string">&quot;NAME&quot;</span>) &#123;<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Value for name: &#123;name&#125;&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(age) = matches.get_one::&lt;<span class="hljs-type">u8</span>&gt;(<span class="hljs-string">&quot;age&quot;</span>) &#123;<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Value for age: &#123;age&#125;&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ®µä»£ç åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p><p><strong>1. åˆ›å»ºå‘½ä»¤è¡Œåº”ç”¨å®ä¾‹</strong>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">matches</span> = Command::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;MyApp&quot;</span>)<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨ <code>Command::new</code>æ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å‘½ä»¤è¡Œåº”ç”¨å®ä¾‹ï¼Œå‘½åä¸º <code>"MyApp"</code>ã€‚</p><p><strong>2. é…ç½®åº”ç”¨</strong>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs rust">.<span class="hljs-title function_ invoke__">version</span>(<span class="hljs-string">&quot;1.0.0&quot;</span>)<br>.<span class="hljs-title function_ invoke__">author</span>(<span class="hljs-string">&quot;hedon&quot;</span>)<br>.<span class="hljs-title function_ invoke__">about</span>(<span class="hljs-string">&quot;This the intro of the cli application&quot;</span>)<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œä½¿ç”¨é“¾å¼è°ƒç”¨æ–¹æ³•é…ç½®åº”ç”¨çš„ç‰ˆæœ¬å·ä¸º<code>"1.0.0"</code>ï¼Œä½œè€…ä¸º<code>"hedon"</code>ï¼Œå¹¶æ·»åŠ äº†ä¸€ä¸ªç®€çŸ­çš„æè¿°ã€‚</p><p>è¿™é‡Œç­‰ä»·äº Builder æ¨¡å¼ä¸‹çš„ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[command(version, author, about)]</span><br></code></pre></td></tr></table></figure><p><strong>3. æ·»åŠ å‘½ä»¤è¡Œå‚æ•°</strong>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs rust">.<span class="hljs-title function_ invoke__">arg</span>(arg!([NAME]).<span class="hljs-title function_ invoke__">help</span>(<span class="hljs-string">&quot;Specify your name&quot;</span>))<br>.<span class="hljs-title function_ invoke__">arg</span>(<br>    Arg::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;age&quot;</span>).<span class="hljs-title function_ invoke__">short</span>(<span class="hljs-string">&#x27;a&#x27;</span>).<span class="hljs-title function_ invoke__">long</span>(<span class="hljs-string">&quot;age&quot;</span>).<span class="hljs-title function_ invoke__">value_parser</span>(value_parser!(<span class="hljs-type">u8</span>))<br>)<br></code></pre></td></tr></table></figure><p>è¿™éƒ¨åˆ†ä»£ç æ·»åŠ äº†ä¸¤ä¸ªå‘½ä»¤è¡Œå‚æ•°ï¼š -<code>.arg(arg!([NAME]).required(true).help("Specify your name"))</code>ä½¿ç”¨ <code>arg!</code> å®æ·»åŠ äº†ä¸€ä¸ªåä¸º <code>NAME</code>çš„å¿…éœ€å‚æ•°ï¼Œå¹¶æä¾›äº†ä¸€äº›å¸®åŠ©ä¿¡æ¯ã€‚ -<code>.arg(Arg::new("age").short('a').long("age").value_parser(value_parser!(u8)))</code>åˆ›å»ºäº†å¦ä¸€ä¸ªå‚æ•° <code>age</code>ï¼Œå¯ä»¥é€šè¿‡ <code>-a</code> æˆ–<code>--age</code> æ¥æŒ‡å®šã€‚è¿™ä¸ªå‚æ•°ä½¿ç”¨äº† <code>value_parser</code>å®æ¥æŒ‡æ˜å®ƒçš„å€¼åº”è¢«è§£æä¸º <code>u8</code> ç±»å‹çš„æ•°å­—ã€‚</p><p><strong>4. è§£æå‘½ä»¤è¡Œå‚æ•°</strong>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust">.<span class="hljs-title function_ invoke__">get_matches</span>();<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>.get_matches()</code> æ–¹æ³•æ¥è§£æå‘½ä»¤è¡Œå‚æ•°å¹¶å°†ç»“æœå­˜å‚¨åœ¨<code>matches</code> å˜é‡ä¸­ã€‚</p><p><strong>5. è¯»å–å¹¶æ‰“å°å‚æ•°å€¼</strong>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(name) = matches.get_one::&lt;<span class="hljs-type">String</span>&gt;(<span class="hljs-string">&quot;NAME&quot;</span>) &#123;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Value for name: &#123;name&#125;&quot;</span>);<br>&#125;<br><span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(age) = matches.get_one::&lt;<span class="hljs-type">u8</span>&gt;(<span class="hljs-string">&quot;age&quot;</span>) &#123;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Value for age: &#123;age&#125;&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€åï¼Œä½¿ç”¨ <code>matches.get_one::&lt;T&gt;("arg_name")</code>æ–¹æ³•å°è¯•è·å–æŒ‡å®šåç§°çš„å‚æ•°å€¼ã€‚å¦‚æœæˆåŠŸæ‰¾åˆ°ï¼Œåˆ™å°†å…¶æ‰“å°å‡ºæ¥ã€‚è¿™é‡Œåˆ†åˆ«å°è¯•è·å–<code>"NAME"</code> å’Œ <code>"age"</code> å‚æ•°çš„å€¼ï¼Œå¹¶ä½¿ç”¨<code>println!</code> å®å°†å®ƒä»¬æ‰“å°åˆ°æ§åˆ¶å°ã€‚</p><p>ä½¿ç”¨ <code>-- help</code> æµ‹è¯•è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">This the intro of the cli application<br><br>Usage: app2 [OPTIONS] [NAME]<br><br>Arguments:<br>  [NAME]  Specify your name<br><br>Options:<br>  -a, --age &lt;AGE&gt;  <br>  -h, --<span class="hljs-built_in">help</span>       Print <span class="hljs-built_in">help</span><br>  -V, --version    Print version<br></code></pre></td></tr></table></figure><p>ä½ å¯ä»¥å°†å…¶ä¸ã€ŒDerive -åº”ç”¨é…ç½®ã€è¿›è¡Œæ¯”è¾ƒï¼Œåº”è¯¥å¾ˆå®¹æ˜“æ‰¾åˆ°å®ƒä»¬ä¹‹é—´çš„å¯¹åº”å…³ç³»ã€‚</p><p>åœ¨ Derive ä¸­ <code>#[command]</code> å’Œ <code>#[arg]</code>æ”¯æŒçš„å±æ€§ï¼Œéƒ½å¯ä»¥åœ¨ Builderä¸­æ‰¾åˆ°å¯¹åº”çš„åŒåçš„å‡½æ•°ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚</p><h3 id="å‚æ•°ç±»å‹-1">2. å‚æ•°ç±»å‹</h3><p>åœ¨ Builder æ¨¡å¼ä¸­ï¼Œé…ç½®å‚æ•°æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><ul><li>arg!([-short] [--long] id)</li><li>Args::new("id").short('s').long("long")</li></ul><h4 id="arguments-options-1">2.1 Arguments &amp; Options</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">Arguments:<br>  [NAME]  Specify your name<br><br>Options:<br>  -a, --age &lt;AGE&gt;  <br></code></pre></td></tr></table></figure><ul><li><strong>Argument:</strong> ä¸åŒ…å« <code>-&#123;short&#125;</code> å’Œ<code>--&#123;long&#125;</code>ã€‚</li><li><strong>Options:</strong> åŒ…å« <code>-&#123;short&#125;</code> æˆ–<code>--&#123;long&#125;</code>ã€‚</li></ul><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs rust">.<span class="hljs-title function_ invoke__">arg</span>(arg!([NAME]).<span class="hljs-title function_ invoke__">help</span>(<span class="hljs-string">&quot;Specify your name&quot;</span>))<br>.<span class="hljs-title function_ invoke__">arg</span>(arg!(-a --age &lt;AGE&gt;).<span class="hljs-title function_ invoke__">value_parser</span>(value_parser!(<span class="hljs-type">u16</span>)))<br></code></pre></td></tr></table></figure><h4 id="å¯é€‰å‚æ•°-1">2.2 å¯é€‰å‚æ•°</h4><p>æ ¹æ®çº¦å®šï¼Œ<code>&lt;&gt;</code> è¡¨ç¤ºå¿…é¡»ï¼Œè€Œ <code>[]</code>è¡¨ç¤ºå¯é€‰ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs rust">.<span class="hljs-title function_ invoke__">arg</span>(arg!(&lt;NAME&gt;)   <span class="hljs-comment">// å¿…é¡»</span><br>.<span class="hljs-title function_ invoke__">arg</span>(arg!([ADDRESS]))  <span class="hljs-comment">// å¯é€‰</span><br></code></pre></td></tr></table></figure><p>ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>.required(bool)</code> å‡½æ•°æ˜ç¡®æŒ‡å‡ºæ˜¯å¦å¿…é¡»ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust">.<span class="hljs-title function_ invoke__">arg</span>(arg!(&lt;NAME&gt;).<span class="hljs-title function_ invoke__">required</span>(<span class="hljs-literal">true</span>))<br></code></pre></td></tr></table></figure><p><code>.required()</code> çš„ä¼˜å…ˆçº§é«˜äº <code>&lt;&gt;</code> å’Œ<code>[]</code>ï¼Œä½†æ˜¯å»ºè®®ä½ åœ¨æ„å»ºçš„æ—¶å€™è¿˜æ˜¯éµå¾ªçº¦å®šã€‚</p><h4 id="æšä¸¾å‚æ•°-1">2.3 æšä¸¾å‚æ•°</h4><p><strong>ç¬¬ 1 ç§ï¼šåœ¨ value_parser()ä¸­ç›´æ¥æŒ‡å®šå¯é€‰çš„æšä¸¾å‚æ•°</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust">.<span class="hljs-title function_ invoke__">arg</span>(arg!(&lt;MODE&gt;).<span class="hljs-title function_ invoke__">value_parser</span>([<span class="hljs-string">&quot;fast, slow&quot;</span>]))<br></code></pre></td></tr></table></figure><p><strong>ç¬¬ 2 ç§ï¼šä½¿ç”¨æšä¸¾ï¼Œä½†æ˜¯æšä¸¾éœ€è¦å®ç° ValueEnumtrait</strong></p><p>è¿™é‡Œåˆæœ‰ 2 ç§æ–¹å¼ï¼Œä½ å¯ä»¥å‘ Derive ä¸€æ ·å¼•å…¥ <code>derive</code>featuresï¼Œç„¶åç›´æ¥ <code>#[derive(ValueElem)]</code>ä½¿ç”¨é»˜è®¤å®ç°ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨å®ç°ã€‚æˆ‘æ›´å€¾å‘äºå‰è€…ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::&#123;arg, command, value_parser, ValueEnum&#125;;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">matches</span> = command!()<br>        <span class="hljs-comment">// .arg(arg!(&lt;MODE&gt;).value_parser([&quot;fast, slow&quot;]))</span><br>        .<span class="hljs-title function_ invoke__">arg</span>(<br>            arg!(&lt;MODE&gt;).<span class="hljs-title function_ invoke__">value_parser</span>(value_parser!(Mode)).<span class="hljs-title function_ invoke__">required</span>(<span class="hljs-literal">true</span>)<br>        )<br>        .<span class="hljs-title function_ invoke__">get_matches</span>();<br><br>    <span class="hljs-keyword">match</span> matches.get_one::&lt;Mode&gt;(<span class="hljs-string">&quot;MODE&quot;</span>)<br>        .<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">&quot;&#x27;Mode&#x27; is required and parsing will fail if its missing&quot;</span>)&#123;<br>        Mode::Fast =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;fast&quot;</span>),<br>        Mode::Slow =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;slow&quot;</span>),<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">#[derive(Copy, Clone, Ord, PartialOrd, Eq, PartialEq, ValueEnum)]</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Mode</span> &#123;<br>    <span class="hljs-comment">/// Run in fast mode</span><br>    Fast,<br>    <span class="hljs-comment">/// Run in slow mode</span><br>    Slow,<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ç´¯è®¡å‚æ•°-1">2.4 ç´¯è®¡å‚æ•°</h4><p>ä½¿ç”¨ <code>clap::ArgAction::Count</code> è®¾ç½®å‚æ•°ä¸ºç´¯è®¡å‚æ•°ï¼Œç„¶åä½¿ç”¨<code>get_count(id)</code> è·å–å‚æ•°çš„å€¼ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::&#123;arg, command&#125;;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">matches</span> = command!()<br>        .<span class="hljs-title function_ invoke__">arg</span>(arg!(-v --verbose...).<span class="hljs-title function_ invoke__">action</span>(clap::ArgAction::Count))<br>        .<span class="hljs-title function_ invoke__">get_matches</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;v count: &#123;:?&#125;&quot;</span>, matches.<span class="hljs-title function_ invoke__">get_count</span>(<span class="hljs-string">&quot;verbose&quot;</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œè¦æ³¨æ„ï¼Œ<code>arg!()</code> ä¸­å‚æ•°çš„å®šä¹‰ï¼Œä¹Ÿè¦ç¬¦åˆç´¯è®¡å‚æ•°çš„æ ¼å¼<code>-&#123;short&#125; --&#123;long&#125;...</code>ã€‚</p><h4 id="å˜é•¿å‚æ•°-1">2.5 å˜é•¿å‚æ•°</h4><p>ä½¿ç”¨ <code>clap::ArgAction::Append</code>è®¾ç½®å‚æ•°ä¸ºå˜é•¿å‚æ•°ï¼Œç„¶åä½¿ç”¨ <code>get_many::&lt;ç±»å‹&gt;("id")</code>è·å–å‚æ•°çš„å€¼ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::&#123;arg, Command&#125;;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">matches</span> = Command::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;append-application&quot;</span>)<br>        .<span class="hljs-title function_ invoke__">arg</span>(arg!([FILES]...).<span class="hljs-title function_ invoke__">action</span>(clap::ArgAction::Append))<br>        .<span class="hljs-title function_ invoke__">get_matches</span>();<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">files</span> = matches<br>        .get_many::&lt;<span class="hljs-type">String</span>&gt;(<span class="hljs-string">&quot;FILES&quot;</span>)<br>        .<span class="hljs-title function_ invoke__">unwrap_or_default</span>()<br>        .<span class="hljs-title function_ invoke__">map</span>(|v|v.<span class="hljs-title function_ invoke__">as_str</span>())<br>        .collect::&lt;<span class="hljs-type">Vec</span>&lt;_&gt;&gt;();<br><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;files: &#123;:?&#125;&quot;</span>, files);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œè¦æ³¨æ„ï¼Œ<code>arg!()</code> ä¸­å‚æ•°çš„å®šä¹‰ï¼Œä¹Ÿè¦ç¬¦åˆå˜é•¿å‚æ•°çš„æ ¼å¼<code>[arg]|&lt;arg&gt;...</code>ã€‚</p><h4 id="æ ‡å¿—å‚æ•°-1">2.6 æ ‡å¿—å‚æ•°</h4><p>ä½¿ç”¨ <code>clap::ArgAction::SetTrue</code> æˆ–<code>clap::ArgAction::SetFalse</code> è®¾ç½®å‚æ•°ä¸ºæ ‡å¿—å‚æ•°ï¼Œç„¶åä½¿ç”¨<code>get_flag()</code> è·å–å‚æ•°çš„å€¼ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::&#123;arg, command&#125;;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">matches</span> = command!()<br>        .<span class="hljs-title function_ invoke__">arg</span>(arg!(-d --debug).<span class="hljs-title function_ invoke__">action</span>(clap::ArgAction::SetTrue))<br>        .<span class="hljs-title function_ invoke__">arg</span>(arg!(-v --verbose).<span class="hljs-title function_ invoke__">action</span>(clap::ArgAction::SetFalse))<br>        .<span class="hljs-title function_ invoke__">get_matches</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;debug: &#123;:?&#125;&quot;</span>, matches.<span class="hljs-title function_ invoke__">get_flag</span>(<span class="hljs-string">&quot;debug&quot;</span>));<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;verbose: &#123;:?&#125;&quot;</span>, matches.<span class="hljs-title function_ invoke__">get_flag</span>(<span class="hljs-string">&quot;verbose&quot;</span>))<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ï¼š</p><ul><li><code>clap::ArgAction::SetTrue</code> : è®¾ç½®å‚æ•°çš„è¯ï¼Œåˆ™ä¸ºtrueï¼Œå¦åˆ™ falseï¼ˆé»˜è®¤ï¼‰ã€‚</li><li><code>clap::ArgAction::SetFalse</code> : è®¾ç½®å‚æ•°çš„è¯ï¼Œåˆ™ä¸ºfalseï¼Œå¦åˆ™ trueï¼ˆé»˜è®¤ï¼‰ã€‚</li></ul><p>æµ‹è¯•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  learn-clap-builder git:(master) âœ— ./target/release/examples/flag      <br>debug: <span class="hljs-literal">false</span><br>verbose: <span class="hljs-literal">true</span><br>âœ  learn-clap-builder git:(master) âœ— ./target/release/examples/flag -d   <br>debug: <span class="hljs-literal">true</span><br>verbose: <span class="hljs-literal">true</span><br>âœ  learn-clap-builder git:(master) âœ— ./target/release/examples/flag -v   <br>debug: <span class="hljs-literal">false</span><br>verbose: <span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure><h4 id="å­å‘½ä»¤-1">2.7 å­å‘½ä»¤</h4><p>å¯ä»¥ä½¿ç”¨ <code>subcommand(sub_cmd)</code> å’Œ<code>subcommand([sub_cmd1, sub_cmd2])</code>æ¥æ·»åŠ å­å‘½ä»¤ï¼Œè§£æçš„æ—¶å€™ä½¿ç”¨ <code>matches.subcommand()</code>åŒ¹é…å­å‘½ä»¤ï¼Œå†æŒ‰ç…§ä¹‹å‰çš„è§„åˆ™è§£æå­å‘½ä»¤ä¸­å¯¹åº”çš„å‚æ•°å³å¯ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::&#123;arg, Command, value_parser&#125;;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">matches</span> = Command::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;myapp&quot;</span>)<br>        .<span class="hljs-title function_ invoke__">subcommands</span>([<br>            Command::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;add&quot;</span>)<br>                .<span class="hljs-title function_ invoke__">arg</span>(arg!(&lt;NUM&gt;).<span class="hljs-title function_ invoke__">value_parser</span>(value_parser!(<span class="hljs-type">i16</span>))),<br>            Command::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;sub&quot;</span>)<br>                .<span class="hljs-title function_ invoke__">arg</span>(arg!(&lt;NUM&gt;).<span class="hljs-title function_ invoke__">value_parser</span>(value_parser!(<span class="hljs-type">i16</span>))),<br>        ])<br>        .<span class="hljs-title function_ invoke__">get_matches</span>();<br><br>    <span class="hljs-keyword">match</span> matches.<span class="hljs-title function_ invoke__">subcommand</span>() &#123;<br>        <span class="hljs-title function_ invoke__">Some</span>((<span class="hljs-string">&quot;add&quot;</span>, add_cmd)) =&gt; <span class="hljs-built_in">println!</span>(<br>            <span class="hljs-string">&quot;&#x27;myapp add&#x27; was used, num is: &#123;:?&#125;&quot;</span>,<br>            add_cmd.get_one::&lt;<span class="hljs-type">i16</span>&gt;(<span class="hljs-string">&quot;NUM&quot;</span>),<br>        ),<br>        <span class="hljs-title function_ invoke__">Some</span>((<span class="hljs-string">&quot;sub&quot;</span>, sub_cmd)) =&gt; <span class="hljs-built_in">println!</span>(<br>            <span class="hljs-string">&quot;&#x27;myapp sub&#x27; was used, num is: &#123;:?&#125;&quot;</span>,<br>            sub_cmd.get_one::&lt;<span class="hljs-type">i16</span>&gt;(<span class="hljs-string">&quot;NUM&quot;</span>),<br>        ),<br>        _ =&gt; <span class="hljs-built_in">unreachable!</span>()<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å‚æ•°æ ¡éªŒ-1">3. å‚æ•°æ ¡éªŒ</h3><h4 id="ç±»å‹æ ¡éªŒ-1">3.1 ç±»å‹æ ¡éªŒ</h4><p>ä½¿ç”¨ <code>value_parser!()</code> åœ¨æ‹¬å·ä¸­æŒ‡å®šç±»å‹ï¼Œ<code>clap</code>å°±ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬å¯¹å‚æ•°è¿›è¡Œç±»å‹æ ¡éªŒï¼Œå½“ç„¶ä½ åœ¨è·å–å‚æ•°å€¼<code>get_one::&lt;ç±»å‹&gt;()</code> çš„æ—¶å€™ï¼Œç±»å‹è¦å¯¹ä¸Šï¼Œå¦åˆ™ä¼španicã€‚</p><p>é»˜è®¤æ”¯æŒï¼š</p><ul><li>åŸç”Ÿç±»å‹ï¼š<code>bool</code>, <code>String</code>,<code>OsString</code>,<code>PathBuf</code>ã€<code>usize</code>ã€<code>isize</code></li><li>èŒƒå›´æ•°æ®ï¼š<code>u8</code>, <code>i8</code>, <code>u16</code>,<code>i16</code>, <code>u32</code>, <code>i32</code>, <code>u64</code>,<code>i64</code></li><li>å®ç°äº† <code>ValueEnum</code> çš„ enum ç±»å‹</li><li>å®ç°äº†<code>From&lt;OsString&gt;</code>ã€<code>From&lt;&amp;OsStr&gt;</code>ã€<code>FromStr</code> çš„ç±»å‹</li></ul><h4 id="æšä¸¾æ ¡éªŒ-1">3.2 æšä¸¾æ ¡éªŒ</h4><p>2.3 ä¸­æšä¸¾å‚æ•°çš„è¯´æ˜ä¸­ï¼Œå·²ç»ä½“ç°äº†æšä¸¾æ ¡éªŒçš„åŠŸèƒ½äº†ï¼Œè¿™é‡Œä¸èµ˜è¿°ã€‚</p><h4 id="èŒƒå›´æ ¡éªŒ-1">3.3 èŒƒå›´æ ¡éªŒ</h4><p>å¯¹äºä¸Šè¿°æåˆ°çš„ã€ŒèŒƒå›´æ•°æ®ã€ï¼Œå¯ä»¥ä½¿ç”¨<code>value_parser!(ç±»å‹).range()</code> è¿›è¡ŒèŒƒå›´æ ¡éªŒã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs rust">arg!(&lt;PORT&gt;)<br>  .<span class="hljs-title function_ invoke__">value_parser</span>(value_parser!(<span class="hljs-type">u16</span>).<span class="hljs-title function_ invoke__">range</span>(<span class="hljs-number">1</span>..))<br></code></pre></td></tr></table></figure><h4 id="è‡ªå®šä¹‰æ ¡éªŒ-1">3.4 è‡ªå®šä¹‰æ ¡éªŒ</h4><p><code>value_parser()</code>ä¸­ä¹Ÿå¯ä»¥ä¼ è‡ªå®šä¹‰çš„æ ¡éªŒå‡½æ•°ï¼Œè¯¥å‡½æ•°çš„ç­¾åéœ€è¦æ»¡è¶³çš„æ¡ä»¶è·Ÿæˆ‘ä»¬åœ¨ä»‹ç»Derive æ—¶ä¸€æ ·ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> std::ops::RangeInclusive;<br><span class="hljs-keyword">use</span> clap::&#123;arg, command&#125;;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">matches</span> = command!()<br>        .<span class="hljs-title function_ invoke__">arg</span>(arg!(&lt;PORT&gt;).<span class="hljs-title function_ invoke__">value_parser</span>(port_in_range))<br>        .<span class="hljs-title function_ invoke__">get_matches</span>();<br><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;port: &#123;:?&#125;&quot;</span>, matches.get_one::&lt;<span class="hljs-type">u16</span>&gt;(<span class="hljs-string">&quot;PORT&quot;</span>))<br>&#125;<br><br><span class="hljs-keyword">const</span> PORT_RANGE: RangeInclusive&lt;<span class="hljs-type">usize</span>&gt; = RangeInclusive::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">1</span>, <span class="hljs-number">65535</span>);<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">port_in_range</span>(s: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-type">u16</span>, <span class="hljs-type">String</span>&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">port</span>: <span class="hljs-type">usize</span> = s<br>        .<span class="hljs-title function_ invoke__">parse</span>()<br>        .<span class="hljs-title function_ invoke__">map_err</span>(|_|<span class="hljs-built_in">format!</span>(<span class="hljs-string">&quot;`&#123;s&#125;` is not a port number&quot;</span>))?;<br>    <span class="hljs-keyword">if</span> PORT_RANGE.<span class="hljs-title function_ invoke__">contains</span>(&amp;port) &#123;<br>        <span class="hljs-title function_ invoke__">Ok</span>(port <span class="hljs-keyword">as</span> <span class="hljs-type">u16</span>)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-title function_ invoke__">Err</span>(<span class="hljs-built_in">format!</span>(<br>            <span class="hljs-string">&quot;port not in range &#123;&#125;-&#123;&#125;&quot;</span>,<br>            PORT_RANGE.<span class="hljs-title function_ invoke__">start</span>(),<br>            PORT_RANGE.<span class="hljs-title function_ invoke__">end</span>(),<br>        ))<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å…³è”å‚æ•°-1">3.5 å…³è”å‚æ•°</h4><ul><li><strong>ä¾èµ–å…³ç³»ï¼š</strong>ä½¿ç”¨<code>requires(id | group)</code></li><li><strong>æ’æ–¥å…³ç³»</strong>ï¼šä½¿ç”¨<code>group().multiple(false).required(true)</code></li></ul><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs rust">.<span class="hljs-title function_ invoke__">group</span>(<br>    ArgGroup::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;vers&quot;</span>)<br>  <span class="hljs-comment">// è¡¨ç¤º &quot;set-ver&quot;, &quot;major&quot;, &quot;minor&quot;, &quot;patch&quot; å¿…é¡»æœ‰ä¸€ä¸ªä¸”åªèƒ½æœ‰ä¸€ä¸ªå­˜åœ¨</span><br>        .<span class="hljs-title function_ invoke__">multiple</span>(<span class="hljs-literal">false</span>)<br>        .<span class="hljs-title function_ invoke__">required</span>(<span class="hljs-literal">true</span>)<br>        .<span class="hljs-title function_ invoke__">args</span>([<span class="hljs-string">&quot;set-ver&quot;</span>, <span class="hljs-string">&quot;major&quot;</span>, <span class="hljs-string">&quot;minor&quot;</span>, <span class="hljs-string">&quot;patch&quot;</span>]),<br>)<br>.<span class="hljs-title function_ invoke__">arg</span>(<br>    arg!([INPUT_FILE] <span class="hljs-string">&quot;some regular input&quot;</span>)<br>        .<span class="hljs-title function_ invoke__">value_parser</span>(value_parser!(PathBuf))<br>        .<span class="hljs-title function_ invoke__">group</span>(<span class="hljs-string">&quot;input&quot;</span>),<br>)<br>.<span class="hljs-title function_ invoke__">arg</span>(<br>    arg!(config: -c &lt;CONFIG&gt;)<br>        .<span class="hljs-title function_ invoke__">value_parser</span>(value_parser!(PathBuf))<br>   <span class="hljs-comment">// è¡¨ç¤º -c éœ€è¦æœ‰ group ä¸º input çš„å‘½ä»¤å­˜åœ¨æ‰å¯ä»¥ä½¿ç”¨</span><br>        .<span class="hljs-title function_ invoke__">requires</span>(<span class="hljs-string">&quot;input&quot;</span>),<br>)<br></code></pre></td></tr></table></figure><h2 id="derive-vs-builder-2-å¯¹æ¯”">Derive vs Builder (2) å¯¹æ¯”</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/screencapture-wepie-feishu-cn-wiki-Bdb3wl4cViE6hqkUuykctkrqn8i-2024-03-01-20_52_38.png"alt="Derive vs Builder" /><figcaption aria-hidden="true">Derive vs Builder</figcaption></figure><h2 id="clap-rpassword-å®ç°åŠ å¯†è¾“å…¥">clap + rpassword å®ç°åŠ å¯†è¾“å…¥</h2><p>å¯¹äºå¯†ç ã€å¯†é’¥ç­‰å…³é”®ä¿¡æ¯çš„è¾“å…¥ï¼Œä¸ºäº†ä¿¡æ¯å®‰å…¨ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šä½¿ç”¨åŠ å¯†è¾“å‡ºï¼Œ<code>clap</code>æœ¬èº«ä¸æ”¯æŒåŠ å¯†è¾“å…¥åŠŸèƒ½ã€‚è‹¥ä½ æœ‰è¿™æ–¹é¢çš„éœ€æ±‚ï¼Œå¯ä»¥ä½¿ç”¨<code>rpassword</code> crate è¾…åŠ©å®Œæˆã€‚</p><p>ç¤ºä¾‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::Parser;<br><span class="hljs-keyword">use</span> rpassword::read_password;<br><br><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(version, author, about, long_about = None)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cli</span> &#123;<br>    <span class="hljs-meta">#[arg(short, long)]</span><br>    username: <span class="hljs-type">String</span>,<br><br>    <span class="hljs-meta">#[arg(short, long, required = true)]</span><br>    password: <span class="hljs-type">bool</span>,<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cli</span> = Cli::<span class="hljs-title function_ invoke__">parse</span>();<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">password</span> = <span class="hljs-keyword">if</span> cli.password &#123;<br>        <span class="hljs-comment">// Prompt user to enter password</span><br>        <span class="hljs-title function_ invoke__">read_password</span>().<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">&quot;Failed to read password&quot;</span>)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-string">&quot;&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>()<br>    &#125;;<br><br>    <span class="hljs-comment">// Use username and password to do something</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;username: &#123;&#125;, password: &#123;&#125;&quot;</span>, cli.username, password);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="clap_complete-å®ç°è‡ªåŠ¨è¡¥å…¨">clap_complete å®ç°è‡ªåŠ¨è¡¥å…¨</h2><p>è¦å®ç°è‡ªåŠ¨è¡¥å…¨ï¼Œéœ€è¦åœ¨ <code>.zshrc</code> æˆ– <code>.bashrc</code> ç­‰<code>SHELL</code> æ–‡ä»¶ä¸­åŠ å…¥å‘½ä»¤è‡ªåŠ¨è¡¥å…¨è„šæœ¬ã€‚è¿™æ—¶å€™å¯ä»¥ä½¿ç”¨<code>clap_complete</code> æ¥å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚</p><p>ä¸‹é¢çš„ç¤ºä¾‹ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">â”œâ”€â”€ Cargo.lock<br>â”œâ”€â”€ Cargo.toml<br>â”œâ”€â”€ build.rs<br>â””â”€â”€ src<br>    â”œâ”€â”€ cli.rs<br>    â””â”€â”€ main.rs<br></code></pre></td></tr></table></figure><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦å¼•å…¥ <code>clap</code> å’Œ <code>clap_complete</code>crateï¼Œå…¶ä¸­ <code>clap_complete</code> åªéœ€åœ¨ buildç¯å¢ƒä¸‹å³å¯ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ <code>Cargo.tmol</code> å¦‚ä¸‹ï¼š</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs toml"><span class="hljs-section">[package]</span><br><span class="hljs-attr">name</span> = <span class="hljs-string">&quot;myapp&quot;</span><br><span class="hljs-attr">version</span> = <span class="hljs-string">&quot;0.1.0&quot;</span><br><span class="hljs-attr">edition</span> = <span class="hljs-string">&quot;2021&quot;</span><br><br><span class="hljs-attr">build</span> = <span class="hljs-string">&quot;build.rs&quot;</span><br><br><span class="hljs-section">[dependencies]</span><br><span class="hljs-attr">clap</span> = &#123; version = <span class="hljs-string">&quot;4.5.1&quot;</span> &#125;<br><span class="hljs-attr">dirs</span> = <span class="hljs-string">&quot;5.0.1&quot;</span><br><br><span class="hljs-section">[build-dependencies]</span><br><span class="hljs-attr">clap</span> = &#123; version = <span class="hljs-string">&quot;4.5.1&quot;</span>&#125;<br><span class="hljs-attr">clap_complete</span> = <span class="hljs-string">&quot;4.5.1&quot;</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆåœ¨ <code>src/cli.rs</code> ä¸­å®ç°ä¸€ä¸ªç®€å•çš„å‘½ä»¤è¡Œç¨‹åº<strong>myapp</strong>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::&#123;Arg, ArgAction, Command&#125;;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">build_cli</span>() <span class="hljs-punctuation">-&gt;</span> Command &#123;<br>    Command::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;myapp&quot;</span>)<br>        .<span class="hljs-title function_ invoke__">about</span>(<span class="hljs-string">&quot;Tests completions&quot;</span>)<br>        .<span class="hljs-title function_ invoke__">arg</span>(Arg::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;file&quot;</span>)<br>            .<span class="hljs-title function_ invoke__">help</span>(<span class="hljs-string">&quot;some input file&quot;</span>))<br>        .<span class="hljs-title function_ invoke__">subcommand</span>(Command::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;test&quot;</span>)<br>            .<span class="hljs-title function_ invoke__">about</span>(<span class="hljs-string">&quot;tests things&quot;</span>)<br>            .<span class="hljs-title function_ invoke__">arg</span>(Arg::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;case&quot;</span>)<br>                .<span class="hljs-title function_ invoke__">long</span>(<span class="hljs-string">&quot;case&quot;</span>)<br>                .<span class="hljs-title function_ invoke__">action</span>(ArgAction::Set)<br>                .<span class="hljs-title function_ invoke__">help</span>(<span class="hljs-string">&quot;the case to test&quot;</span>)))<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸»è¦æ˜¯æ¼”ç¤ºè¿™ä¸ªè‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ï¼Œä¸ºäº†çœäº‹ï¼Œ<code>src/main.rs</code>ä¸­å°±ä¸å®ç°å…·ä½“é€»è¾‘äº†ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">mod</span> cli;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">_m</span> = cli::<span class="hljs-title function_ invoke__">build_cli</span>().<span class="hljs-title function_ invoke__">get_matches</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ç€ï¼Œæˆ‘ä»¬åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹å®ç°<code>build.rs</code>ï¼Œå®ƒå°†ä¸ºæˆ‘ä»¬æŒ‡å®šçš„å‘½ä»¤ç”Ÿæˆè‡ªåŠ¨è¡¥å…¨è„šæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">touch</span> build.rs<br></code></pre></td></tr></table></figure><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap_complete::&#123;generate_to, shells::Bash&#125;;<br><span class="hljs-keyword">use</span> std::env;<br><span class="hljs-keyword">use</span> std::io::Error;<br><br>include!(<span class="hljs-string">&quot;src/cli.rs&quot;</span>);<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;(), Error&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">outdir</span> = <span class="hljs-keyword">match</span> env::<span class="hljs-title function_ invoke__">var_os</span>(<span class="hljs-string">&quot;OUT_DIR&quot;</span>) &#123;<br>        <span class="hljs-literal">None</span> =&gt; <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Ok</span>(()),<br>        <span class="hljs-title function_ invoke__">Some</span>(outdir) =&gt; outdir,<br>    &#125;;<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">cmd</span> = <span class="hljs-title function_ invoke__">build_cli</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">path</span> = <span class="hljs-title function_ invoke__">generate_to</span>(<br>        Bash,<br>        &amp;<span class="hljs-keyword">mut</span> cmd, <span class="hljs-comment">// We need to specify what generator to use</span><br>        <span class="hljs-string">&quot;myapp&quot;</span>,  <span class="hljs-comment">// We need to specify the bin name manually</span><br>        outdir,   <span class="hljs-comment">// We need to specify where to write to</span><br>    )?;<br><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;cargo:warning=completion file is generated: &#123;path:?&#125;&quot;</span>);<br><br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½ éœ€è¦æŠŠå…¶ä¸­çš„ <strong>myapp</strong> æ›¿æ¢ä¸ºä½ çš„å‘½ä»¤ã€‚</p><p>æ‰§è¡Œæ„å»ºå‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo build<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">warning: myapp@0.1.0: completion file is generated: <span class="hljs-string">&quot;/Users/hedon/RustroverProjects/learn-clap-complete/target/debug/build/myapp-42e401d08c044ca3/out/myapp.bash&quot;</span><br>    Finished dev [unoptimized + debuginfo] target(s) <span class="hljs-keyword">in</span> 1.90s<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä¼šè¾“å‡ºç”Ÿæˆè„šæœ¬æ‰€åœ¨çš„ä½ç½®ï¼Œæˆ‘è¿™é‡Œæ˜¯<code>/Users/hedon/RustroverProjects/learn-clap-complete/target/debug/build/myapp-42e401d08c044ca3/out/myapp.bash</code>ã€‚</p><p>æˆ‘çš„ç»ˆç«¯ä½¿ç”¨çš„æ˜¯ zshï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  <span class="hljs-built_in">echo</span> <span class="hljs-variable">$SHELL</span>      <br>/bin/zsh<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘éœ€è¦å°†è¿™ä¸ªæ–‡ä»¶çš„å†…å®¹åŠ åˆ° <code>~/.zshrc</code> æ–‡ä»¶çš„æœ«å°¾ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /Users/hedon/RustroverProjects/learn-clap-complete/target/debug/build/myapp-42e401d08c044ca3/out/myapp.bash &gt;&gt; ~/.zshrc<br></code></pre></td></tr></table></figure><p>é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">source</span> ~/.zshrc<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™ä½ ä½¿ç”¨ <strong>myapp</strong> å‘½ä»¤çš„æ—¶å€™ï¼ŒæŒ‰ <code>tap</code>é”®ï¼Œå°±æœ‰è‡ªåŠ¨è¡¥å…¨äº†ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  ./target/debug/myapp <br>--<span class="hljs-built_in">help</span>    -h        \[file\]  <span class="hljs-built_in">help</span>      <span class="hljs-built_in">test</span> <br></code></pre></td></tr></table></figure><h1 id="httpie">HTTPie</h1><p>ç”±äºç¯‡å¹…åŸå› ï¼Œå®æˆ˜ HTTPie éƒ¨åˆ†è¯·çœ‹ï¼š<ahref="https://hedon.top/2024/03/06/rust-action-httpie/">Rustå®æˆ˜ä¸¨HTTPie</a></p><h1 id="ä¸-go-è¯­è¨€-cobra-æ¯”è¾ƒ">ä¸ Go è¯­è¨€ cobra æ¯”è¾ƒ</h1><p>Go çš„ <code>cobra</code> ä¹Ÿæ˜¯ç”¨äºæ„å»ºå‘½ä»¤è¡Œåº”ç”¨ç¨‹åºçš„åº“ï¼Œå®ƒåœ¨ Goè¯­è¨€ç”Ÿæ€ä¸­éå¸¸å—æ¬¢è¿ã€‚</p><p>ä¸ºäº†ç›´è§‚å±•ç¤ºè¿™ 2ä¸ªåº“æ„å»ºå‘½ä»¤è¡Œåº”ç”¨ç¨‹åºçš„åŒºåˆ«ï¼Œæˆ‘ä»¬æ¥è®¾è®¡ä¸€ä¸ªç®€å•çš„å‘½ä»¤è¡Œç¨‹åºï¼Œç”¨<code>clap</code> å’Œ <code>cobra</code>åˆ†åˆ«å®ç°ï¼Œä»¥å±•ç¤ºå¦‚ä½•ç”¨è¿™ä¸¤ä¸ªåº“å®ç°ç›¸åŒçš„åŠŸèƒ½ã€‚</p><p>è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª CLI ç¨‹åºï¼Œå®ƒæœ‰ä¸€ä¸ª <code>greet</code> å­å‘½ä»¤ï¼Œæ¥å—ä¸€ä¸ª<code>-n</code> æˆ– <code>--name</code> å‚æ•°ï¼Œå¹¶æ‰“å°å‡ºä¸€æ¡æ¬¢è¿ä¿¡æ¯ã€‚</p><h2 id="rust-clap-å®ç°">Rust clap å®ç°</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::&#123; Parser, Subcommand&#125;;<br><br><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(bin_name = <span class="hljs-string">&quot;greet_app&quot;</span>)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cli</span> &#123;<br>    <span class="hljs-meta">#[command(subcommand)]</span><br>    sub: <span class="hljs-type">Option</span>&lt;Sub&gt;,<br>&#125;<br><br><span class="hljs-meta">#[derive(Subcommand)]</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Sub</span> &#123;<br>    Greet &#123;<br>        <span class="hljs-meta">#[arg(short, long)]</span><br>        name: <span class="hljs-type">String</span>,<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cli</span> = Cli::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(sub) = cli.sub &#123;<br>        <span class="hljs-keyword">match</span> sub &#123;<br>            Sub::Greet&#123;name&#125; =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;greeting: &#123;:?&#125;&quot;</span>, name),<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="go-cobra-å®ç°">Go cobra å®ç°</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;os&quot;</span><br><br><span class="hljs-string">&quot;github.com/spf13/cobra&quot;</span><br>)<br><br><span class="hljs-keyword">var</span> rootCmd = &amp;cobra.Command&#123;<br>Use:   <span class="hljs-string">&quot;greet_app&quot;</span>,<br>Short: <span class="hljs-string">&quot;A simple greeting application&quot;</span>,<br>Long:  <span class="hljs-string">`This is a simple greeting application with a greet command.`</span>,<br>&#125;<br><br><span class="hljs-keyword">var</span> greetCmd = &amp;cobra.Command&#123;<br>Use:   <span class="hljs-string">&quot;greet&quot;</span>,<br>Short: <span class="hljs-string">&quot;Greets a user&quot;</span>,<br>Long:  <span class="hljs-string">`Prints a greeting message for the specified user.`</span>,<br>Run: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(cmd *cobra.Command, args []<span class="hljs-type">string</span>)</span></span> &#123;<br>name, _ := cmd.Flags().GetString(<span class="hljs-string">&quot;name&quot;</span>)<br>fmt.Printf(<span class="hljs-string">&quot;Hello, %s!\n&quot;</span>, name)<br>&#125;,<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;<br>rootCmd.AddCommand(greetCmd)<br>greetCmd.Flags().StringP(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;n&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;Sets the name to greet&quot;</span>)<br>greetCmd.MarkFlagRequired(<span class="hljs-string">&quot;name&quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> err := rootCmd.Execute(); err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(err)<br>os.Exit(<span class="hljs-number">1</span>)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">This is a simple greeting application with a greet <span class="hljs-built_in">command</span>.<br><br>Usage:<br>  greet_app [<span class="hljs-built_in">command</span>]<br><br>Available Commands:<br>  completion  Generate the autocompletion script <span class="hljs-keyword">for</span> the specified shell<br>  greet       Greets a user<br>  <span class="hljs-built_in">help</span>        Help about any <span class="hljs-built_in">command</span><br><br>Flags:<br>  -h, --<span class="hljs-built_in">help</span>   <span class="hljs-built_in">help</span> <span class="hljs-keyword">for</span> greet_app<br><br>Use <span class="hljs-string">&quot;greet_app [command] --help&quot;</span> <span class="hljs-keyword">for</span> more information about a <span class="hljs-built_in">command</span>.<br></code></pre></td></tr></table></figure><h2 id="å¯¹æ¯”">å¯¹æ¯”</h2><h3 id="è®¾è®¡å“²å­¦å’Œæ˜“ç”¨æ€§">è®¾è®¡å“²å­¦å’Œæ˜“ç”¨æ€§</h3><p><strong>clap</strong>:</p><ul><li>ä½¿ç”¨ Rust çš„å®æ¥æä¾›å¼ºå¤§çš„ç¼–è¯‘æ—¶åŠŸèƒ½ï¼Œå¦‚å‚æ•°è§£æã€éªŒè¯ç­‰ã€‚</li><li>åˆ©ç”¨ Rust çš„ç±»å‹å®‰å…¨ç‰¹æ€§ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯ã€‚</li><li>æ”¯æŒé€šè¿‡æ´¾ç”Ÿå®è‡ªåŠ¨ä»ç»“æ„ä½“ç”Ÿæˆå‘½ä»¤è¡Œè§£æä»£ç ï¼Œç®€åŒ–å¼€å‘æµç¨‹ã€‚</li></ul><p><strong>cobra</strong>:</p><ul><li>é‡‡ç”¨æ›´ä¼ ç»Ÿçš„å‘½ä»¤å¼ç¼–ç¨‹æ¨¡å‹ï¼Œç›´è§‚ä¸”æ˜“äºä¸Šæ‰‹ã€‚</li><li>é€šè¿‡ç»„åˆå‘½ä»¤å¯¹è±¡æ¥æ„å»ºå¤æ‚çš„å‘½ä»¤è¡Œåº”ç”¨ã€‚</li><li>æä¾›äº†ä¸€å¥—å®Œæ•´çš„ç”Ÿæˆå·¥å…·æ¥åˆ›å»ºå‘½ä»¤å’Œé…ç½®ï¼Œä¿ƒè¿›äº†å¼€å‘é€Ÿåº¦ã€‚</li></ul><h3 id="åŠŸèƒ½å’Œç‰¹æ€§">åŠŸèƒ½å’Œç‰¹æ€§</h3><p><strong>clap</strong>:</p><ul><li>è‡ªåŠ¨ç”Ÿæˆå¸®åŠ©ä¿¡æ¯ã€ç‰ˆæœ¬ä¿¡æ¯ç­‰ã€‚</li><li>æ”¯æŒå¤šçº§å­å‘½ä»¤ã€‚</li><li>æ”¯æŒè‡ªå®šä¹‰éªŒè¯å™¨å’Œå¤æ‚çš„å‚æ•°å…³ç³»ï¼ˆå¦‚äº’æ–¥ã€ä¾èµ–ç­‰ï¼‰ã€‚</li></ul><p><strong>cobra</strong>:</p><ul><li>æ”¯æŒè‡ªåŠ¨ç”Ÿæˆå¸®åŠ©æ–‡æ¡£ã€‚</li><li><strong>å†…ç½®å‘½ä»¤è‡ªåŠ¨è¡¥å…¨è„šæœ¬ç”ŸæˆåŠŸèƒ½</strong>ã€‚</li><li><strong>æ”¯æŒæŒä¹…åŒ–å‘½ä»¤è¡Œæ ‡å¿—åˆ°é…ç½®æ–‡ä»¶</strong>ã€‚</li><li>é€šè¿‡æ’ä»¶æ”¯æŒå¢åŠ é¢å¤–çš„å­å‘½ä»¤ã€‚</li><li>èƒ½å¤Ÿè½»æ¾åœ°ä¸å…¶ä»– Go åº“é›†æˆï¼Œå¦‚ Viper ç”¨äºé…ç½®ç®¡ç†ã€‚</li></ul><h3 id="æ€§èƒ½">æ€§èƒ½</h3><p><strong>clap</strong>:</p><ul><li>ç”±äº Rust çš„ç¼–è¯‘æ—¶ä¼˜åŒ–ï¼Œ<code>clap</code>åœ¨è§£æå‘½ä»¤è¡Œå‚æ•°æ—¶é€šå¸¸ä¼šæœ‰æ›´å¥½çš„æ€§èƒ½ã€‚</li><li>æ›´å°‘çš„è¿è¡Œæ—¶å¼€é”€ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†å¤§é‡å¤æ‚å‘½ä»¤è¡Œå‚æ•°æ—¶ã€‚</li></ul><p><strong>cobra</strong>:</p><ul><li>æ€§èƒ½å¯¹äºå¤§å¤šæ•°å‘½ä»¤è¡Œåº”ç”¨æ¥è¯´å·²ç»è¶³å¤Ÿï¼Œä½†å¯èƒ½ä¸å¦‚ <code>clap</code>ä¼˜åŒ–ã€‚</li><li>Go çš„è¿è¡Œæ—¶å¯èƒ½ä¼šå¼•å…¥é¢å¤–çš„å¼€é”€ï¼Œå°¤å…¶æ˜¯åœ¨å¹¶å‘å¤„ç†æ—¶ã€‚</li></ul>]]></content>
    
    
    <summary type="html">æœ¬æ–‡å°†æ·±å…¥æ¢ç´¢ Rust ä¸­ä¸€ä¸ªéå¸¸æµè¡Œçš„å‘½ä»¤è¡Œè§£æå·¥å…· clapï¼Œæœ¬æ–‡ä¼šå…ˆè¯¦ç»†ä»‹ç» clap Derive å’Œ Builder ä¸¤ç§æ„å»ºå‘½ä»¤è¡Œå·¥å…·çš„æ–¹å¼ï¼Œå¹¶å®æˆ˜ httpie å·¥å…·ï¼Œæœ€åè¿˜å°† clap ä¸ Go è¯­è¨€ä¸­åœ¨å‘½ä»¤è¡Œè§£æåŒæ ·æµè¡Œçš„ cargo è¿›è¡Œæ¯”è¾ƒã€‚</summary>
    
    
    
    <category term="Rust" scheme="https://hedon.top/categories/Rust/"/>
    
    <category term="Rust å¸¸ç”¨åº“" scheme="https://hedon.top/categories/Rust/Rust-%E5%B8%B8%E7%94%A8%E5%BA%93/"/>
    
    
    <category term="Rust" scheme="https://hedon.top/tags/Rust/"/>
    
    <category term="clap" scheme="https://hedon.top/tags/clap/"/>
    
  </entry>
  
  <entry>
    <title>Rust reqwest ç®€æ˜æ•™ç¨‹</title>
    <link href="https://hedon.top/2024/03/02/rust-crate-reqwest/"/>
    <id>https://hedon.top/2024/03/02/rust-crate-reqwest/</id>
    <published>2024-03-02T10:46:56.000Z</published>
    <updated>2024-05-16T13:04:10.160Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2><p><code>reqwest</code> æ˜¯ Rust ä¸­ä¸€ä¸ªéå¸¸æµè¡Œå’Œå¼ºå¤§çš„ HTTPå®¢æˆ·ç«¯åº“ï¼Œå®ƒæä¾›äº†ä¸€ç§ç®€å•çš„æ–¹å¼æ¥å‘é€ HTTPè¯·æ±‚å¹¶å¤„ç†å“åº”ã€‚<code>reqwest</code>æ”¯æŒé˜»å¡å’Œéé˜»å¡ï¼ˆå¼‚æ­¥ï¼‰è¯·æ±‚ï¼Œä½¿å…¶é€‚åˆäºå„ç§ä¸åŒçš„åº”ç”¨åœºæ™¯ã€‚åœ¨è¿™ç¯‡åšæ–‡ä¸­ï¼Œæˆ‘ä»¬å°†è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨<code>reqwest</code> å‘é€å„ç§ HTTP è¯·æ±‚ï¼Œå¹¶å¤„ç†è¿”å›çš„å“åº”ã€‚</p><h2 id="å¼€å§‹ä¹‹å‰">å¼€å§‹ä¹‹å‰</h2><p>åœ¨å¼€å§‹ç¼–å†™ä»£ç ä¹‹å‰ï¼Œä½ éœ€è¦åœ¨ä½ çš„ Rust é¡¹ç›®ä¸­æ·»åŠ  <code>reqwest</code>ä¾èµ–ã€‚æ‰“å¼€ä½ çš„ <code>Cargo.toml</code> æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs toml"><span class="hljs-section">[dependencies]</span><br><span class="hljs-attr">reqwest</span> = &#123; version = <span class="hljs-string">&quot;0.12.4&quot;</span>, features = [<span class="hljs-string">&quot;json&quot;</span>] &#125;<br><span class="hljs-attr">tokio</span> = &#123; version = <span class="hljs-string">&quot;1&quot;</span>, features = [<span class="hljs-string">&quot;full&quot;</span>] &#125;<br><span class="hljs-attr">serde</span> = &#123; version = <span class="hljs-string">&quot;1.0.197&quot;</span>, features = [<span class="hljs-string">&quot;derive&quot;</span>] &#125;<br><span class="hljs-attr">serde_json</span> = <span class="hljs-string">&quot;1.0.114&quot;</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬è¿˜æ·»åŠ äº†å…¶ä»–å‡ ä¸ªä¾èµ–ï¼š</p><ul><li><code>tokio</code>: åœ¨åé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ <code>reqwest</code>çš„å¼‚æ­¥åŠŸèƒ½ã€‚</li><li><code>serde</code>: ç”¨äºæ•°æ®è§£æï¼Œåœ¨ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä¼šæ¼”ç¤º jsonæ•°æ®çš„è§£æã€‚</li><li><code>serde_json</code>: ä¾¿äºä½¿ç”¨ <code>json!</code> å®å¿«é€Ÿæ„å»º jsonæ•°æ®ã€‚</li></ul><h2 id="å‘é€-get-è¯·æ±‚">å‘é€ GET è¯·æ±‚</h2><p>å‘é€ä¸€ä¸ª GET è¯·æ±‚æ˜¯æœ€åŸºæœ¬çš„ HTTP æ“ä½œã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨<code>reqwest</code> å‘é€ GET è¯·æ±‚å¹¶è®¾ç½®è¯·æ±‚å¤´çš„ç¤ºä¾‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> reqwest::header;<br><br><span class="hljs-meta">#[tokio::main]</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;(), reqwest::Error&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">params</span> = [(<span class="hljs-string">&quot;key1&quot;</span>, <span class="hljs-string">&quot;value1&quot;</span>), (<span class="hljs-string">&quot;key2&quot;</span>, <span class="hljs-string">&quot;values&quot;</span>)];<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">client</span> = reqwest::Client::<span class="hljs-title function_ invoke__">new</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">body</span> = client<br>        .<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">&quot;http://httpbin.org/get&quot;</span>)<br>        <span class="hljs-comment">// set query params</span><br>        .form(&amp;params)<br>        <span class="hljs-comment">// set request headers</span><br>        .<span class="hljs-title function_ invoke__">header</span>(header::USER_AGENT, <span class="hljs-string">&quot;My Rust Program&quot;</span>)<br>        .<span class="hljs-title function_ invoke__">header</span>(header::CONTENT_TYPE, <span class="hljs-string">&quot;application/json&quot;</span>)<br>        .<span class="hljs-title function_ invoke__">send</span>()<br>        .<span class="hljs-keyword">await</span>?<br>        .<span class="hljs-title function_ invoke__">text</span>()<br>        .<span class="hljs-keyword">await</span>?;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;body = &#123;:?&#125;&quot;</span>, body);<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>reqwest::get</code> å‡½æ•°å‘é€ä¸€ä¸ª GETè¯·æ±‚åˆ° "https://httpbin.org/get"ï¼Œå¹¶é€šè¿‡ <code>text</code>æ–¹æ³•è·å–å“åº”çš„æ–‡æœ¬å†…å®¹ã€‚</p><h2 id="å‘é€-post---text-è¯·æ±‚">å‘é€ POST - text è¯·æ±‚</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> reqwest::Client;<br><br><span class="hljs-meta">#[tokio::main]</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;(), reqwest::Error&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">client</span> = Client::<span class="hljs-title function_ invoke__">new</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">res</span> = client.<span class="hljs-title function_ invoke__">post</span>(<span class="hljs-string">&quot;http://httpbin.org/post&quot;</span>)<br>        .<span class="hljs-title function_ invoke__">body</span>(<span class="hljs-string">&quot;the exact body that is sent&quot;</span>)<br>        .<span class="hljs-title function_ invoke__">send</span>()<br>        .<span class="hljs-keyword">await</span>?<br>        .<span class="hljs-title function_ invoke__">text</span>()<br>        .<span class="hljs-keyword">await</span>?;<br><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;body: &#123;:?&#125;&quot;</span>, res);<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å‘é€-post---form-è¯·æ±‚">å‘é€ POST - form è¯·æ±‚</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[tokio::main]</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;(), reqwest::Error&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">params</span> = [(<span class="hljs-string">&quot;key1&quot;</span>, <span class="hljs-string">&quot;value1&quot;</span>), (<span class="hljs-string">&quot;key2&quot;</span>, <span class="hljs-string">&quot;values&quot;</span>)];<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">client</span> = reqwest::Client::<span class="hljs-title function_ invoke__">new</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">res</span> = client.<span class="hljs-title function_ invoke__">post</span>(<span class="hljs-string">&quot;http://httpbin.org/post&quot;</span>)<br>        .form(&amp;params)<br>        .<span class="hljs-title function_ invoke__">send</span>()<br>        .<span class="hljs-keyword">await</span>?<br>        .<span class="hljs-title function_ invoke__">text</span>()<br>        .<span class="hljs-keyword">await</span>?;<br><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;body: &#123;:?&#125;&quot;</span>, res);<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å‘é€-post---json-è¯·æ±‚">å‘é€ POST - json è¯·æ±‚</h2><p>å‘é€ POST è¯·æ±‚é€šå¸¸ç”¨äºå‘æœåŠ¡å™¨æäº¤æ•°æ®ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨<code>reqwest</code> å‘é€åŒ…å« JSON æ•°æ®çš„ POST è¯·æ±‚çš„ç¤ºä¾‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> reqwest;<br><span class="hljs-keyword">use</span> serde_json::json;<br><br><span class="hljs-meta">#[tokio::main]</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;(), reqwest::Error&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">client</span> = reqwest::Client::<span class="hljs-title function_ invoke__">new</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">res</span> = client.<span class="hljs-title function_ invoke__">post</span>(<span class="hljs-string">&quot;https://httpbin.org/post&quot;</span>)<br>        .<span class="hljs-title function_ invoke__">json</span>(&amp;json!(&#123;<span class="hljs-string">&quot;key&quot;</span>: <span class="hljs-string">&quot;value&quot;</span>&#125;))<br>        .<span class="hljs-title function_ invoke__">send</span>()<br>        .<span class="hljs-keyword">await</span>?;<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">body</span> = res.<span class="hljs-title function_ invoke__">text</span>().<span class="hljs-keyword">await</span>?;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Body:\n&#123;&#125;&quot;</span>, body);<br><br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ <code>Client::post</code> æ–¹æ³•åˆ›å»ºä¸€ä¸ª POST è¯·æ±‚ï¼Œå¹¶é€šè¿‡<code>json</code> æ–¹æ³•è®¾ç½® JSON è´Ÿè½½ã€‚ç„¶åï¼Œæˆ‘ä»¬è°ƒç”¨ <code>send</code>æ–¹æ³•å‘é€è¯·æ±‚ã€‚</p><h2 id="å¤„ç†-json-å“åº”">å¤„ç† JSON å“åº”</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> reqwest;<br><span class="hljs-keyword">use</span> serde::Deserialize;<br><br><span class="hljs-meta">#[derive(Deserialize)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Ip</span> &#123;<br>    origin: <span class="hljs-type">String</span>,<br>&#125;<br><br><span class="hljs-meta">#[tokio::main]</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;(), reqwest::Error&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">ip</span>: Ip = reqwest::<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">&quot;https://httpbin.org/ip&quot;</span>)<br>        .<span class="hljs-keyword">await</span>?<br>        .<span class="hljs-title function_ invoke__">json</span>()<br>        .<span class="hljs-keyword">await</span>?;<br><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;IP: &#123;&#125;&quot;</span>, ip.origin);<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª <code>Ip</code> ç»“æ„ä½“æ¥è¡¨ç¤º JSONå“åº”ï¼Œç„¶åä½¿ç”¨ <code>json</code> æ–¹æ³•å°†å“åº”ååºåˆ—åŒ–ä¸º <code>Ip</code>ç±»å‹ã€‚</p><h2 id="æ€»ç»“">æ€»ç»“</h2><p><code>reqwest</code> åº“ä¸º Rust æä¾›äº†ä¸€ä¸ªåŠŸèƒ½ä¸°å¯Œè€Œçµæ´»çš„ HTTPå®¢æˆ·ç«¯ï¼Œé€‚ç”¨äºå„ç§ç½‘ç»œç¼–ç¨‹ä»»åŠ¡ã€‚æ— è®ºæ˜¯ç®€å•çš„æ•°æ®è·å–è¿˜æ˜¯å¤æ‚çš„ APIäº¤äº’ï¼Œ<code>reqwest</code> éƒ½èƒ½å¸®åŠ©ä½ ä»¥ç®€æ´çš„ Rustä»£ç å®Œæˆä»»åŠ¡ã€‚å¸Œæœ›è¿™ç¯‡åšæ–‡èƒ½å¸®åŠ©ä½ å¼€å§‹ä½¿ç”¨ <code>reqwest</code>æ¥å¼€å‘ç½‘ç»œç›¸å…³çš„ Rust åº”ç”¨ï¼</p>]]></content>
    
    
    <summary type="html">æœ¬æ–‡ä»‹ç»äº† Rust ä¸€ä¸ªéå¸¸æµç¨‹å’Œå¼ºå¤§çš„ HTTP å®¢æˆ·ç«¯åº“ reqwest çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•ã€‚</summary>
    
    
    
    <category term="Rust" scheme="https://hedon.top/categories/Rust/"/>
    
    <category term="Rust å¸¸ç”¨åº“" scheme="https://hedon.top/categories/Rust/Rust-%E5%B8%B8%E7%94%A8%E5%BA%93/"/>
    
    
    <category term="Rust" scheme="https://hedon.top/tags/Rust/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥æµ…å‡º Go è¯­è¨€çš„ GPM æ¨¡å‹ï¼ˆGo1.21ï¼‰</title>
    <link href="https://hedon.top/2024/01/20/go-gpm/"/>
    <id>https://hedon.top/2024/01/20/go-gpm/</id>
    <published>2024-01-20T05:10:41.000Z</published>
    <updated>2024-01-29T13:44:58.357Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€">å¼•è¨€</h1><p>åœ¨ç°ä»£è½¯ä»¶å¼€å‘ä¸­ï¼Œæœ‰æ•ˆåœ°åˆ©ç”¨å¹¶å‘æ˜¯æé«˜åº”ç”¨æ€§èƒ½å’Œå“åº”é€Ÿåº¦çš„å…³é”®ã€‚éšç€å¤šæ ¸å¤„ç†å™¨çš„æ™®åŠï¼Œç¼–ç¨‹è¯­è¨€å’Œæ¡†æ¶å¦‚ä½•é«˜æ•ˆã€ç®€ä¾¿åœ°æ”¯æŒå¹¶å‘ç¼–ç¨‹ï¼Œæˆä¸ºäº†è½¯ä»¶å·¥ç¨‹å¸ˆä»¬è¯„ä¼°å’Œé€‰æ‹©å·¥å…·æ—¶çš„ä¸€ä¸ªé‡è¦è€ƒé‡ã€‚åœ¨è¿™æ–¹é¢ï¼ŒGoè¯­è¨€å‡­å€Ÿå…¶åˆ›æ–°çš„å¹¶å‘æ¨¡å‹â€”GPMï¼ˆGoroutine, P,Mï¼‰â€”åœ¨ä¼—å¤šç¼–ç¨‹è¯­è¨€ä¸­è„±é¢–è€Œå‡ºï¼Œä¸ºå¼€å‘è€…æä¾›äº†å¼ºå¤§çš„å·¥å…·ï¼Œä»¥ç®€å•ã€é«˜æ•ˆçš„æ–¹å¼å®ç°å¹¶å‘ã€‚</p><p>è‡ªä» 2009 å¹´é¦–æ¬¡å‘å¸ƒä»¥æ¥ï¼ŒGoè¯­è¨€å°±ä»¥å…¶å‡ºè‰²çš„æ€§èƒ½ã€ç®€æ´çš„è¯­æ³•å’Œå¯¹å¹¶å‘çš„åŸç”Ÿæ”¯æŒèµ¢å¾—äº†å¹¿æ³›çš„å…³æ³¨ã€‚å°¤å…¶æ˜¯å…¶å¹¶å‘æ¨¡å‹ï¼Œè¢«è®¾è®¡ä¸ºèƒ½å¤Ÿå……åˆ†åˆ©ç”¨ç°ä»£å¤šæ ¸å¤„ç†å™¨çš„èƒ½åŠ›ï¼ŒåŒæ—¶éšè—åº•å±‚çš„çº¿ç¨‹ç®¡ç†å’ŒåŒæ­¥å¤æ‚æ€§ï¼Œè®©å¼€å‘è€…èƒ½å¤Ÿä»¥æ›´ç›´è§‚ã€æ›´é«˜çº§çš„æŠ½è±¡æ¥æ„å»ºå¹¶å‘ç¨‹åºã€‚GPMæ¨¡å‹ï¼Œä½œä¸º Go è¯­è¨€å¹¶å‘ç¼–ç¨‹çš„æ ¸å¿ƒï¼Œé€šè¿‡Goroutineã€Pï¼ˆprocessorï¼‰ã€Mï¼ˆmachineï¼‰ä¸‰è€…çš„ååŒå·¥ä½œï¼Œå®ç°äº†ä¸€ç§é«˜æ•ˆä¸”æ˜“äºç®¡ç†çš„å¹¶å‘æœºåˆ¶ã€‚</p><p>æœ¬æ–‡å°†åŸºäº <strong>Go1.21</strong> æ·±å…¥æµ…å‡ºåœ°æ¢è®¨ Go è¯­è¨€çš„ GPMæ¨¡å‹ï¼Œä¸»è¦åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>é¦–å…ˆä»å…¶è®¾è®¡ç†å¿µå‡ºå‘ï¼Œè¯¦ç»†è§£æ Goroutineã€P å’Œ Mä¸‰è€…çš„è§’è‰²ã€å·¥ä½œåŸç†åŠå…¶ç›¸äº’ä¹‹é—´çš„äº¤äº’æ–¹å¼ã€‚</li><li>ç„¶åå¼•å…¥å‡ ä¸ªå…³é”®é—®é¢˜ï¼Œæˆ‘ä»¬ä¼šä»ç»“è®ºä¸Šå…ˆæ€»ç»“ GPMçš„æ ¸å¿ƒè¦ç‚¹ï¼Œå†…å®¹åŒ…æ‹¬åç¨‹è°ƒåº¦å¾ªç¯ã€è°ƒåº¦ç­–ç•¥å’Œè°ƒåº¦æ—¶æœºã€‚</li><li>æ¥ç€æˆ‘ä»¬ä¼šæ·±å…¥æºç ï¼Œå»ä¸€æ­¥æ­¥æ´å¯Ÿ Go è¯­è¨€è®¾è®¡è€…æ˜¯å¦‚ä½•å®ç° GPMæ¨¡å‹ä¸­çš„å„ä¸ªè¦ç‚¹çš„ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šæ¯”è¾ƒç¹çï¼Œä½†å…¶å®ä¹Ÿæ¯”è¾ƒæœ‰è¶£ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥é˜…è¯»è¿™ä¸€å—ï¼Œè‹¥åªæ˜¯æƒ³å¯¹GPM æ¨¡å‹æœ‰ä¸ªå¤§æ¦‚äº†è§£ï¼Œé‚£ä¹ˆåœç•™åœ¨ä¸Šä¸€æ­¥ä¹Ÿè¶³çŸ£äº†ã€‚</li><li>æœ€åæˆ‘ä»¬åŸºäºå‰é¢çš„åˆ†æï¼Œæ€»ç»“ Gã€Pã€M ä¸‰å¤§ç»„ä»¶åœ¨ Goç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­çš„çŠ¶æ€æµè½¬å›¾ã€‚</li></ul><p>é€šè¿‡å¯¹ GPM æ¨¡å‹çš„æ¢è®¨ï¼Œæˆ‘ä»¬ä¸ä»…èƒ½å¤Ÿç†è§£ Goè¯­è¨€å¦‚ä½•åœ¨ä¼—å¤šç°ä»£ç¼–ç¨‹è¯­è¨€ä¸­ä»¥å…¶å¹¶å‘ç¼–ç¨‹èƒ½åŠ›è„±é¢–è€Œå‡ºï¼Œè¿˜èƒ½å¤Ÿæ´å¯Ÿå…¶è®¾è®¡èƒŒåçš„æ™ºæ…§ï¼Œä»¥åŠè¿™ä¸€æ¨¡å‹å¦‚ä½•éšç€Go è¯­è¨€ç‰ˆæœ¬çš„è¿­ä»£è€Œä¸æ–­è¿›åŒ–å’Œä¼˜åŒ–ã€‚æ— è®ºä½ æ˜¯å¯¹ Goè¯­è¨€å……æ»¡å¥½å¥‡çš„æ–°æ‰‹ï¼Œè¿˜æ˜¯å¸Œæœ›æ·±åŒ–ç†è§£å…¶å¹¶å‘æ¨¡å‹çš„ç»éªŒå¼€å‘è€…ï¼Œæœ¬æ–‡éƒ½å°†ä¸ºä½ æä¾›å®è´µçš„è§†è§’å’Œæ·±åˆ»çš„æ´è§ã€‚</p><h1 id="ç»“è®ºå…ˆè¡Œ">ç»“è®ºå…ˆè¡Œ</h1><h2 id="gpm-è°ƒåº¦åŸç†å›¾">GPM è°ƒåº¦åŸç†å›¾</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240126214830929.png"alt="Goroutine è°ƒåº¦åŸç†å›¾" /><figcaption aria-hidden="true">Goroutine è°ƒåº¦åŸç†å›¾</figcaption></figure><h2 id="goroutine-åº•å±‚ç»“æ„">Goroutine åº•å±‚ç»“æ„</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/e6c9d24egy1h569pjiiosj21cu0u040p.jpg"alt="Goroutine åº•å±‚ç»“æ„ç¤ºä¾‹" /><figcaption aria-hidden="true">Goroutine åº•å±‚ç»“æ„ç¤ºä¾‹</figcaption></figure><h2 id="è°ƒåº¦å™¨-p-åº•å±‚ç»“æ„">è°ƒåº¦å™¨ P åº•å±‚ç»“æ„</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/e6c9d24egy1h57sl36b40j20o40u8js7.jpg"alt="P åº•å±‚ç»“æ„" /><figcaption aria-hidden="true">P åº•å±‚ç»“æ„</figcaption></figure><h2 id="gpm-è°ƒåº¦å¾ªç¯">GPM è°ƒåº¦å¾ªç¯</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/e6c9d24egy1h57qxoptk4j21hm0simyy.jpg"alt="GPM è°ƒåº¦å¾ªç¯å›¾" /><figcaption aria-hidden="true">GPM è°ƒåº¦å¾ªç¯å›¾</figcaption></figure><h2 id="gpm-åç¨‹è°ƒåº¦ä¼˜å…ˆçº§ä¸é¡ºåº">GPM åç¨‹è°ƒåº¦ä¼˜å…ˆçº§ä¸é¡ºåº</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240127161341751.png"alt="Go åç¨‹è°ƒåº¦ä¼˜å…ˆçº§ä¸é¡ºåº" /><figcaption aria-hidden="true">Go åç¨‹è°ƒåº¦ä¼˜å…ˆçº§ä¸é¡ºåº</figcaption></figure><h2 id="å¯»æ‰¾å¯æ‰§è¡Œ-g-è¿‡ç¨‹">å¯»æ‰¾å¯æ‰§è¡Œ G è¿‡ç¨‹</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240128212451142.png"alt="findRunnable()" /><figcaption aria-hidden="true">findRunnable()</figcaption></figure><h2 id="åç¨‹åˆ‡æ¢æ—¶æœº">åç¨‹åˆ‡æ¢æ—¶æœº</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240129000028727.png"alt="Go åç¨‹åˆ‡æ¢æ—¶æœº" /><figcaption aria-hidden="true">Go åç¨‹åˆ‡æ¢æ—¶æœº</figcaption></figure><h1 id="gpm-æ¨¡å‹">GPM æ¨¡å‹</h1><h2 id="æ¦‚è§ˆ">1. æ¦‚è§ˆ</h2><p>è¿™é‡Œæœ‰ä¸€å¼ å¾ˆæµè¡Œçš„ Goroutine è°ƒåº¦åŸç†å›¾ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240126214830929.png"alt="Goroutine è°ƒåº¦åŸç†å›¾" /><figcaption aria-hidden="true">Goroutine è°ƒåº¦åŸç†å›¾</figcaption></figure><table><thead><tr class="header"><th>ä»£å·</th><th>åç§°</th><th>å®šä¹‰ä½ç½®</th><th>ä½œç”¨</th></tr></thead><tbody><tr class="odd"><td>Sched</td><td>è°ƒåº¦å™¨</td><td>proc.c</td><td>ç»´æŠ¤æœ‰å­˜å‚¨ M å’Œ G çš„é˜Ÿåˆ—ä»¥åŠè°ƒåº¦å™¨çš„ä¸€äº›çŠ¶æ€ä¿¡æ¯ç­‰ã€‚</td></tr><tr class="even"><td>M</td><td>Machine ç³»ç»Ÿçº¿ç¨‹</td><td>runtime.h</td><td>å®ƒç”±æ“ä½œç³»ç»Ÿç®¡ç†çš„ï¼ŒGoroutine å°±æ˜¯è·‘åœ¨ M ä¹‹ä¸Šçš„ï¼›Mæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„ç»“æ„ï¼Œé‡Œé¢ç»´æŠ¤å°å¯¹è±¡å†…å­˜ cacheï¼ˆmcacheï¼‰ã€å½“å‰æ‰§è¡Œçš„Goroutineã€éšæœºæ•°å‘ç”Ÿå™¨ç­‰ç­‰éå¸¸å¤šçš„ä¿¡æ¯ã€‚</td></tr><tr class="odd"><td>P</td><td>Processor å¤„ç†å™¨</td><td>runtime.h</td><td>å®ƒçš„ä¸»è¦ç”¨é€”å°±æ˜¯ç”¨æ¥æ‰§è¡Œ Goroutine çš„ï¼Œå®ƒç»´æŠ¤äº†ä¸€ä¸ª Goroutineé˜Ÿåˆ—ï¼Œå³ runqueueã€‚Processor æ˜¯è®©æˆ‘ä»¬ä» N:1 è°ƒåº¦åˆ° M:Nè°ƒåº¦çš„é‡è¦éƒ¨åˆ†ã€‚æ‰€æœ‰çš„ P éƒ½åœ¨ç¨‹åºå¯åŠ¨æ—¶åˆ›å»ºï¼Œå¹¶ä¿å­˜åœ¨æ•°ç»„ä¸­ï¼Œæœ€å¤šæœ‰GOMAXPROCSï¼ˆå¯é…ç½®ï¼‰ä¸ªã€‚</td></tr><tr class="even"><td>G</td><td>Goroutine å®ç°çš„æ ¸å¿ƒç»“æ„</td><td>runtime.h</td><td>å®ƒåŒ…å«äº†æ ˆï¼ŒæŒ‡ä»¤æŒ‡é’ˆï¼Œä»¥åŠå…¶ä»–å¯¹è°ƒåº¦ Goroutineå¾ˆé‡è¦çš„ä¿¡æ¯ï¼Œä¾‹å¦‚å…¶é˜»å¡çš„ channelã€‚</td></tr><tr class="odd"><td>Global Queue</td><td>å…¨å±€é˜Ÿåˆ—</td><td>proc.h</td><td>å­˜æ”¾ç­‰å¾…è¿è¡Œçš„ Gã€‚å…¨å±€é˜Ÿåˆ—å¯èƒ½è¢«ä»»æ„çš„ P åŠ é”å»è·å–é‡Œé¢çš„ Gã€‚</td></tr><tr class="even"><td>P Local Queue</td><td>P çš„æœ¬åœ°é˜Ÿåˆ—</td><td>proc.h</td><td>åŒå…¨å±€é˜Ÿåˆ—ç±»ä¼¼ï¼Œå­˜æ”¾çš„ä¹Ÿæ˜¯ç­‰å¾…è¿è¡Œçš„ Gï¼Œä½†å­˜æ”¾çš„æ•°æ®æœ‰é™ï¼Œä¸ä¼šè¶…è¿‡256 ä¸ªã€‚æ–°å»º G æ—¶ï¼ŒGä¼šä¼˜å…ˆåŠ å…¥æœ¬åœ°é˜Ÿåˆ—ã€‚å¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™ä¼šæŠŠæœ¬åœ°é˜Ÿåˆ—ä¸­ä¸€åŠçš„ G ä»¥åŠæ–° Gä¸€èµ·ç§»åŠ¨åˆ°å…¨å±€é˜Ÿåˆ—ã€‚</td></tr></tbody></table><p>é€šè¿‡è¿™ä¸ªåŸç†å›¾æˆ‘ä»¬çŸ¥é“ Go è¯­è¨€çš„ GPMæ¨¡å‹çš„ä½œç”¨éå¸¸ç®€å•ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªâ€œç²¾æ‰“ç»†ç®—â€çš„å·¥å…·ã€‚ä»¥å‰å•è¿›ç¨‹æ— æ³•å……åˆ†åˆ©ç”¨CPUèµ„æºï¼Œæ‰€ä»¥å¼•å…¥äº†å¤šè¿›ç¨‹ã€‚åˆå› ä¸ºè¿›ç¨‹æ‹¥æœ‰çš„èµ„æºå¤ªå¤šï¼Œå…¶åˆ›å»ºã€åˆ‡æ¢å’Œé”€æ¯éƒ½ä¼šå ç”¨å¾ˆé•¿æ—¶é—´ï¼Œæ‰€ä»¥å¼•å…¥äº†æ›´å°ç²’åº¦çš„çº¿ç¨‹ã€‚éšç€è®¡ç®—æœºç§‘å­¦çš„è¿›æ­¥ï¼Œç°åœ¨çœ‹æ¥ï¼Œçº¿ç¨‹æ‹¥æœ‰çš„èµ„æºä¹Ÿæ˜¯â€œæ¯”è¾ƒå¤šâ€çš„ï¼Œæ‰€ä»¥çº¿ç¨‹çš„åˆ›å»ºã€åˆ‡æ¢å’Œé”€æ¯ä»£ä»·ä¹Ÿæ˜¯â€œç›¸å¯¹å¤§â€çš„ã€‚æ‰€ä»¥å¾ˆå¤šç¼–ç¨‹è¯­è¨€å°±å¼•å…¥äº†åç¨‹è¿™ä¸ªæ¦‚å¿µï¼Œå…¶æ ¸å¿ƒç›®çš„å°±æ˜¯åº”ç”¨å±‚è‡ªå·±æŠ½è±¡ä¸€ä¸ªæ¯”çº¿ç¨‹æ›´å°ç²’åº¦çš„è°ƒåº¦å•å…ƒï¼Œåº”ç”¨å±‚ç»“åˆæ“ä½œç³»ç»Ÿçš„å¤šçº¿ç¨‹èƒ½åŠ›ï¼Œè‡ªå·±æ¥ç®¡ç†â€œè°ƒåº¦å•å…ƒâ€çš„åˆ›å»ºã€åˆ‡æ¢å’Œé”€æ¯ï¼Œä»è€Œå°½å¯èƒ½å‡å°‘ç”±çº¿ç¨‹åˆ‡æ¢å¸¦æ¥çš„å¼€é”€ï¼Œä»¥åšåˆ°æ›´è½»é‡çº§çš„å¹¶å‘ã€‚</p><p>ä¸åŒçš„ç¼–ç¨‹è¯­è¨€å¯èƒ½æœ‰ä¸åŒçš„å®ç°ï¼Œè€Œå…³é”®å°±åœ¨äºå¦‚ä½•è®©è°ƒåº¦æ›´å¿«ã€å¼€é”€æ›´å°ã€‚è¿™ä¾¿æ˜¯æˆ‘ä»¬æœ¬æ–‡è¦æ¢è®¨çš„ä¸»è¦å†…å®¹ã€‚</p><div class="note note-info">            <p><strong>Go è¯­è¨€çš„å®ç°ï¼š</strong></p><p>çº¿ç¨‹æƒ³è¿è¡Œä»»åŠ¡å°±å¾—è·å– Pï¼Œä» P çš„æœ¬åœ°é˜Ÿåˆ—è·å– Gï¼Œå½“ Pçš„æœ¬åœ°é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼ŒM ä¼šå°è¯•ä»å…¨å±€é˜Ÿåˆ—è·å¾—ä¸€æ‰¹ G æ”¾åˆ° Pçš„æœ¬åœ°é˜Ÿåˆ—ï¼Œæˆ–è€…ä»å…¶ä»– P çš„æœ¬åœ°é˜Ÿåˆ—ä¸­â€œå·â€ä¸€åŠ G æ”¾åˆ°è‡ªå·±çš„æœ¬åœ°é˜Ÿåˆ—ã€‚ç„¶åM è¿è¡Œ Gï¼ŒG æ‰§è¡Œä¹‹åï¼Œå†ä» P è·å–ä¸‹ä¸€ä¸ª Gï¼Œå¦‚æ­¤ä¸æ–­é‡å¤ä¸‹å»ã€‚</p>          </div><p>åœ¨è¿›å…¥æ›´åŠ å…·ä½“æ·±å…¥çš„è®¨è®ºä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦é‡ç‚¹æ€è€ƒä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š</p><ol type="1"><li>G æˆ‘ä»¬å¯ä»¥éšä¾¿åˆ›å»ºï¼Œå¯èƒ½æœ‰æˆåƒä¸Šä¸‡ä¸ªï¼Œé‚£ P å’Œ M æœ‰å¤šå°‘ä¸ªå‘¢ï¼Ÿ</li><li>P å’Œ M ä»€ä¹ˆæ—¶å€™è¢«åˆ›å»ºå‘¢ï¼Ÿ</li><li>æ“ä½œç³»ç»ŸåªçŸ¥é“çº¿ç¨‹ï¼Œæ‰€ä»¥å®é™…ä¸Šè¿˜æ˜¯çº¿ç¨‹åœ¨æ‰§è¡Œä»»åŠ¡ï¼Œé‚£ä¹ˆ Gæ˜¯å¦‚ä½•è°ƒåº¦åˆ°çº¿ç¨‹ä¸Šå¹¶æ‰§è¡Œçš„å‘¢ï¼Ÿ</li><li>å¦‚ä½•é˜²æ­¢åç¨‹é¥¥é¥¿ï¼Ÿ</li><li>å¦‚ä½•å‡å°‘é¢‘ç¹åœ°åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ï¼Ÿ</li><li>å¤šä¸ªçº¿ç¨‹ä»å…¨å±€é˜Ÿåˆ—æ‹¿ Gå¦‚ä½•è§£å†³å¹¶å‘é—®é¢˜ï¼Ÿåˆå¦‚ä½•å‡å°‘è¿™ç§æ•°æ®ç«äº‰å‘¢ï¼Ÿ</li><li>åœ¨æ•´ä¸ª Go è°ƒåº¦åç¨‹çš„è¿‡ç¨‹ä¸­ï¼ŒGã€Pã€Mæœ‰å“ªäº›çŠ¶æ€ï¼Ÿå®ƒä»¬åˆæ˜¯å¦‚ä½•è½®è½¬çš„å‘¢ï¼Ÿ</li></ol><p>å¦‚æœä½ å¯¹è¿™å‡ ä¸ªé—®é¢˜æœ‰å…´è¶£ï¼Œè¯·ç»§ç»­é˜…è¯»ä¸‹æ–‡ã€‚</p><h2 id="p-å’Œ-m-çš„ä¸ªæ•°é—®é¢˜">2. P å’Œ M çš„ä¸ªæ•°é—®é¢˜</h2><ol type="1"><li>P çš„æ•°é‡ç”±å¯åŠ¨æ—¶ç¯å¢ƒå˜é‡ <code>$GOMAXPROCS</code> æˆ–è€…ç¨‹åºä¸­<code>runtime.GOMAXPROCS()</code>å†³å®šã€‚è¿™æ„å‘³ç€åœ¨ç¨‹åºæ‰§è¡Œçš„ä»»æ„æ—¶åˆ»éƒ½åªæœ‰ <code>GOMAXPROCS</code> ä¸ªGoroutine åœ¨åŒæ—¶è¿è¡Œã€‚</li><li>M çš„æ•°é‡ç”± Go è¯­è¨€æœ¬èº«çš„é™åˆ¶å†³å®šï¼ŒGo ç¨‹åºå¯åŠ¨æ—¶ä¼šè®¾ç½® M çš„æœ€å¤§æ•°é‡ä¸º<strong>10000</strong>ä¸ªï¼Œä½†æ˜¯å†…æ ¸å¾ˆéš¾æ”¯æŒè¿™ä¹ˆå¤šçš„çº¿ç¨‹æ•°ï¼Œæ‰€ä»¥è¿™ä¸ªé™åˆ¶å¯ä»¥å¿½ç•¥ã€‚å¯ä»¥ä½¿ç”¨<code>runtime.SetMaxThreads()</code> è®¾ç½® M çš„æœ€å¤§æ•°é‡ã€‚</li></ol><h2 id="p-å’Œ-m-ä½•æ—¶è¢«åˆ›å»º">3. P å’Œ M ä½•æ—¶è¢«åˆ›å»º</h2><ol type="1"><li>P çš„åˆ›å»ºæ—¶æœºåœ¨ç¡®å®šäº† P çš„æœ€å¤§æ•°é‡ n åï¼Œruntime ä¼šæ ¹æ®è¿™ä¸ªæ•°é‡åˆ›å»º nä¸ª Pã€‚</li><li>M åˆ›å»ºçš„æ—¶æœºæ˜¯åœ¨å½“æ²¡æœ‰è¶³å¤Ÿçš„ M æ¥å…³è” P å¹¶è¿è¡Œå…¶ä¸­å¯è¿è¡Œçš„ Gçš„æ—¶å€™ï¼Œå¦‚æ‰€æœ‰çš„ M æ­¤æ—¶éƒ½é˜»å¡ä½äº†ï¼Œè€Œ Pä¸­è¿˜æœ‰å¾ˆå¤šå°±ç»ªä»»åŠ¡ï¼Œå°±ä¼šå»å¯»æ‰¾ç©ºé—²çš„ Mï¼Œå¦‚æœæ²¡æœ‰ç©ºé—²çš„ Mï¼Œå°±ä¼šå»åˆ›å»ºæ–°çš„Mã€‚</li></ol><h2 id="è°ƒåº¦å¾ªç¯">4. è°ƒåº¦å¾ªç¯</h2><p>åœ¨è®¨è®º G æ˜¯å¦‚ä½•è¢«è°ƒåº¦åˆ° M å»æ‰§è¡Œçš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å…ˆä»‹ç» GPMæ¨¡å‹ä¸­ä¸¤ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„è§’è‰²ï¼š<code>m0</code> å’Œ <code>g0</code>ã€‚</p><h3 id="m0">4.1 m0</h3><ul><li><strong>å®šä¹‰</strong>ï¼šm0 æ˜¯ Go ç¨‹åºå¯åŠ¨æ—¶åˆ›å»ºçš„ç¬¬ä¸€ä¸ª Mã€‚å®ƒæ˜¯ç”± Goè¿è¡Œæ—¶ç³»ç»Ÿç›´æ¥ä»æ“ä½œç³»ç»Ÿçº¿ç¨‹åˆ›å»ºçš„ï¼Œä¸æ˜¯ä»çº¿ç¨‹æ± ä¸­è·å–çš„ã€‚</li><li><strong>ä½œç”¨</strong>ï¼šm0 è´Ÿè´£åˆå§‹åŒ–å’Œå¯åŠ¨ Goè¿è¡Œæ—¶ç¯å¢ƒï¼ŒåŒ…æ‹¬åˆ›å»ºè°ƒåº¦å™¨ã€åˆ†é…ç¬¬ä¸€ä¸ªPï¼ˆp0ï¼‰ï¼Œå¹¶åˆ›å»ºå…¶ä»–ç³»ç»Ÿçº§åˆ«çš„èµ„æºã€‚åœ¨ç¨‹åºçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­ï¼Œm0ä¼šç»§ç»­å­˜åœ¨ï¼Œå³ä½¿å®ƒå¯èƒ½ä¸æ‰§è¡Œä»»ä½• Go ä»£ç ã€‚</li><li><strong>ç‰¹ç‚¹</strong>ï¼šm0 ä¸åŒäºå…¶ä»–Mï¼Œå› ä¸ºå®ƒä¸æ˜¯ä»çº¿ç¨‹æ± ä¸­è·å–çš„ã€‚å®ƒå¯èƒ½æ²¡æœ‰ç»‘å®šä»»ä½• Pï¼Œé™¤éç¨‹åºä¸­åªæœ‰ä¸€ä¸ªPï¼ˆå³ GOMAXPROCS è®¾ç½®ä¸º 1ï¼‰ã€‚</li></ul><h3 id="g0">4.2 g0</h3><ul><li><strong>å®šä¹‰</strong>ï¼šg0 æ˜¯æ¯ä¸ª M çš„ç‰¹æ®ŠGoroutineï¼Œå®ƒä¸æ‰§è¡Œä»»ä½•å®é™…çš„ Go ä»£ç ã€‚æ¯ä¸ª M åœ¨åˆ›å»ºæ—¶éƒ½ä¼šåˆ†é…ä¸€ä¸ªg0ã€‚</li><li><strong>ä½œç”¨</strong>ï¼šg0 ä¸»è¦ç”¨äºæ‰§è¡Œè°ƒåº¦å™¨ä»£ç å’Œè¿›è¡Œç³»ç»Ÿè°ƒç”¨ã€‚å½“ Méœ€è¦æ‰§è¡Œè¿™äº›éç”¨æˆ·ä»£ç æ—¶ï¼Œä¼šåˆ‡æ¢åˆ° g0 çš„æ ˆä¸Šè¿è¡Œã€‚</li><li><strong>ç‰¹ç‚¹</strong>ï¼šg0æ‹¥æœ‰è‡ªå·±çš„æ ˆï¼Œè¿™ä¸ªæ ˆç”¨äºå­˜æ”¾è°ƒåº¦å™¨å‡½æ•°å’Œç³»ç»Ÿè°ƒç”¨çš„æ•°æ®ã€‚è¿™æ„å‘³ç€å½“æ‰§è¡Œè¿™äº›æ“ä½œæ—¶ï¼Œä¸ä¼šå½±å“å½“å‰è¿è¡Œçš„ç”¨æˆ·Goroutine çš„æ ˆã€‚</li></ul><h3 id="åç¨‹æ ˆåˆ‡æ¢">4.3 åç¨‹æ ˆåˆ‡æ¢</h3><p>g0 æ˜¯ M ä¸­è´Ÿè´£è°ƒåº¦å…¶ä»– g çš„åç¨‹ï¼Œæ‰€ä»¥ä¸€ä¸ª M ä¸­çš„åç¨‹è°ƒåº¦å…¶å®å°±æ˜¯åœ¨ gå’Œ g0 ä¹‹é—´ä¸æ–­åˆ‡æ¢ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240127155030695.png"alt="åç¨‹ g ä¸ åç¨‹ g0 çš„å¯¹åº”å…³ç³»" /><figcaption aria-hidden="true">åç¨‹ g ä¸ åç¨‹ g0 çš„å¯¹åº”å…³ç³»</figcaption></figure><p>å¤§è‡´è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol type="1"><li>å½“ M æ‰§è¡Œä¸€ä¸ª Gï¼ˆç”¨æˆ· Goroutineï¼‰æ—¶ï¼Œå®ƒä½¿ç”¨ Gçš„æ ˆæ¥è¿è¡Œç”¨æˆ·ä»£ç ã€‚</li><li>å½“éœ€è¦æ‰§è¡Œç³»ç»Ÿè°ƒç”¨æˆ–è°ƒåº¦å™¨ç›¸å…³çš„ä»£ç æ—¶ï¼ŒM ä¼šåˆ‡æ¢åˆ° g0ã€‚g0æ‹¥æœ‰è‡ªå·±çš„æ ˆï¼Œä¸“é—¨ç”¨äºæ‰§è¡Œç³»ç»Ÿè°ƒç”¨å’Œè°ƒåº¦å™¨ä»£ç ï¼Œè¿™æ ·å¯ä»¥é¿å…æ±¡æŸ“ç”¨æˆ·Goroutine çš„æ ˆç©ºé—´ã€‚åœ¨ g0 ä¸Šï¼ŒM å¯ä»¥æ‰§è¡Œå¦‚å†…å­˜åˆ†é…ã€è°ƒåº¦å†³ç­–ã€å¤„ç†Goroutine çš„åˆ›å»ºå’Œé”€æ¯ç­‰æ“ä½œã€‚</li><li>å®Œæˆç³»ç»Ÿè°ƒç”¨æˆ–è°ƒåº¦å™¨ä»»åŠ¡åï¼ŒM ä¼šåˆ‡æ¢å›ä¹‹å‰çš„Gï¼Œç»§ç»­æ‰§è¡Œç”¨æˆ·ä»£ç ã€‚è¿™ä¸ªè¿‡ç¨‹ä¼šä» g0 çš„æ ˆåˆ‡æ¢å› G çš„æ ˆã€‚</li></ol><p>è¯¦ç»†ç»†èŠ‚æˆ‘ä»¬ç•™åˆ°åé¢çš„æºç åˆ†ææ­æ™“ã€‚</p><h2 id="è°ƒåº¦ç­–ç•¥">5. è°ƒåº¦ç­–ç•¥</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240127161341751.png"alt="Go åç¨‹è°ƒåº¦ä¼˜å…ˆçº§ä¸é¡ºåº" /><figcaption aria-hidden="true">Go åç¨‹è°ƒåº¦ä¼˜å…ˆçº§ä¸é¡ºåº</figcaption></figure><h3 id="è·å–æœ¬åœ°è¿è¡Œé˜Ÿåˆ—">5.1 è·å–æœ¬åœ°è¿è¡Œé˜Ÿåˆ—</h3><p>P ä¼šä¼˜å…ˆå°è¯•ä»è‡ªå·±çš„æœ¬åœ°é˜Ÿåˆ—ä¸­å¯»æ‰¾å°±ç»ªçš„Gï¼Œå®ƒ<strong>ä¸€èˆ¬</strong>ä¼šä¼˜å…ˆè°ƒåº¦æœ€è¿‘åŠ å…¥çš„ã€‚</p><p>å› ä¸ºè¿™ä¸ªæ—¶å€™å¯èƒ½ç”±å…¶ä»– P æ¥çªƒå– Gï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯éœ€è¦åŒæ­¥æœºåˆ¶çš„ï¼ŒGoé‡‡ç”¨åŸå­æ“ä½œæ¥é™ä½åŒæ­¥å¼€é”€ã€‚</p><p>æœ¬åœ°é˜Ÿåˆ— G çš„ä¸ªæ•°ä¸è¶…è¿‡ <strong>256</strong> ä¸ªï¼Œ<strong>å¦‚æœåœ¨åˆ›å»º Gçš„æ—¶å€™æœ¬åœ°é˜Ÿåˆ—æ»¡äº†ï¼Œä¼šå°†æœ¬åœ°é˜Ÿåˆ—ä¸­ 1/2 çš„ G è¿åŒæ–°åˆ›å»ºçš„ Gä¸€èµ·æ”¾å…¥å…¨å±€é˜Ÿåˆ—ä¸­ã€‚</strong></p><h3 id="è·å–å…¨å±€è¿è¡Œé˜Ÿåˆ—">5.2 è·å–å…¨å±€è¿è¡Œé˜Ÿåˆ—</h3><p>P ä¼šä¼˜å…ˆæœ¬åœ°é˜Ÿåˆ—ï¼Œç„¶åæ‰å…¨å±€é˜Ÿåˆ—ï¼Œè¿™æœ‰ä¸ªå¥½å¤„ï¼š</p><ul><li>å¦‚æœåªæœ‰å…¨å±€é˜Ÿåˆ—ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„ P éƒ½éœ€è¦å»ç«äº‰å…¨å±€é˜Ÿåˆ—ä¸­çš„Gï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦ä¸Šé”ï¼Œä¸”æ•°æ®ç«äº‰ä¼šæ¯”è¾ƒæ¿€çƒˆï¼Œæ€§èƒ½è¾ƒå·®ã€‚</li><li>é€šè¿‡æ¯ä¸ª Pç»´æŠ¤ä¸€ä¸ªè‡ªå·±çš„æœ¬åœ°é˜Ÿåˆ—å¯ä»¥å‡å°‘å¹¶å‘å†²çªï¼Œå¦‚æœå®åœ¨éœ€è¦å»å…¨å±€é˜Ÿåˆ—æ‹¿Gï¼Œä¹Ÿå¯ä»¥ä¸€æ¬¡æ€§æ‹¿å¤šä¸ªï¼Œå¤§å¤§å‡å°‘äº†å¹¶å‘å†²çªçš„æƒ…å†µå‘ç”Ÿã€‚</li></ul><p>ä½†è¿™åˆå¸¦æ¥äº†ä¸€ä¸ªé—®é¢˜ï¼Œå…¨å±€é˜Ÿåˆ—ä¸­åç¨‹çš„é¥¥é¥¿é—®é¢˜ï¼Œå› ä¸º Pä¼šä¼˜å…ˆè°ƒåº¦æœ€è¿‘åŠ å…¥åˆ°è‡ªå·±æœ¬åœ°é˜Ÿåˆ—ä¸­çš„ Gï¼Œé‚£å¯èƒ½ä¼šä¸€ç›´æœ‰æ–°çš„ Gè¢«åˆ›å»ºï¼Œå¯¼è‡´å…¨å±€é˜Ÿåˆ—ä¸­çš„ G æ²¡æœ‰æœºä¼šè¢«è°ƒåº¦åˆ°ã€‚Go çš„è§£å†³æ€è·¯æ˜¯ï¼š</p><ul><li>P æ¯è°ƒåº¦ <strong>61</strong> æ¬¡åï¼Œå°±ä¼šä»å…¨å±€é˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ª Gæ¥è¿è¡Œã€‚</li></ul><h3 id="è·å–å‡†å¤‡å°±ç»ªçš„ç½‘ç»œåç¨‹">5.3 è·å–å‡†å¤‡å°±ç»ªçš„ç½‘ç»œåç¨‹</h3><p>å¦‚æœæœ¬åœ°é˜Ÿåˆ—å’Œå…¨å±€é˜Ÿåˆ—éƒ½æ‰¾ä¸åˆ°å°±ç»ªçš„ G å¯ä»¥æ‰§è¡Œçš„è¯ã€‚è°ƒåº¦ä¼šé€šè¿‡<code>runtime.netpoll</code> è·å–å¯ä»¥è¿è¡Œçš„ç½‘ç»œåç¨‹ã€‚</p><p>Go è¯­è¨€çš„ç½‘ç»œæ¨¡å‹æ˜¯å¯¹ä¸åŒæ“ä½œç³»ç»Ÿå¹³å°ä¸Š I/O å¤šè·¯å¤ç”¨æŠ€æœ¯çš„å°è£…ã€‚</p><p>å½“ Goroutine åœ¨è¿›è¡Œç½‘ç»œ I/O æ—¶ï¼Œå®ƒä¼šè¢«æŒ‚èµ·ï¼Œçº¿ç¨‹ä¼šå»æ‰§è¡Œå…¶ä»–Goroutineã€‚ä¸€æ—¦ I/O æ“ä½œå®Œæˆï¼Œè¯¥ Goroutineä¼šè¢«å”¤é†’å¹¶é‡æ–°æ’é˜Ÿç­‰å¾…æ‰§è¡Œã€‚</p><h3 id="ç³»ç»Ÿè°ƒç”¨">5.4 ç³»ç»Ÿè°ƒç”¨</h3><p>å½“ä¸€ä¸ª Goroutineæ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå®ƒå¯èƒ½ä¼šè¢«é˜»å¡ï¼Œè¿™æ—¶å®ƒçš„æ‰§è¡Œçº¿ç¨‹ï¼ˆMï¼‰å¯èƒ½ä¼šé‡Šæ”¾å½“å‰ç»‘å®šçš„å¤„ç†å™¨ï¼ˆPï¼‰ï¼Œä»¥ä¾¿å…¶ä»–Goroutine å¯ä»¥åœ¨è¯¥ P ä¸Šè¿è¡Œã€‚</p><h3 id="åç¨‹çªƒå–">5.5 åç¨‹çªƒå–</h3><p>ç©ºé—²çš„ M å¦‚æœç»‘å®šäº† Pï¼Œé‚£ä¹ˆå®ƒçš„ P ä¼šä¸€ç›´å°è¯•ä»å…¶ä»– P çš„é˜Ÿåˆ—ä¸­çªƒå–Goroutineï¼Œä»¥å¹³è¡¡è´Ÿè½½å’Œé¿å…ç©ºé—²ã€‚è¿™ä¸ªæ—¶å€™ä¸ºäº†è®©æ¯ä¸ª P éƒ½æœ‰å¯èƒ½è¢«çªƒå–ï¼ŒGoæ²¡æœ‰ç›´æ¥é¡ºåºéå† P åˆ—è¡¨ï¼Œè€Œæ˜¯é‡‡ç”¨äº†ä¸€ç§ç›¸å¯¹éšæœºçš„æ–¹å¼å»éå† Påˆ—è¡¨ï¼Œç›´åˆ°æ‰¾åˆ°å¯ä»¥è¿è¡Œçš„åç¨‹å°±è¿”å›ã€‚M ä¸æ–­å¯»æ‰¾å¯æ‰§è¡Œ Gçš„è¿™æ®µæœŸé—´ï¼Œå®ƒè¢«ç§°ä¸º<strong>è‡ªæ—‹çº¿ç¨‹</strong>ã€‚</p><p>æ‰€ä»¥ä¸ºå‡å°‘åˆ›å»ºã€åˆ‡æ¢å’Œé”€æ¯çº¿ç¨‹çš„å¼€é”€ï¼ŒGo åšäº†è‡³å°‘ä¸¤ç‚¹åŠªåŠ›ï¼š</p><ol type="1"><li><p>å·å–ï¼ˆWork Stealingï¼‰æœºåˆ¶</p><p>å½“æœ¬çº¿ç¨‹æ— å¯è¿è¡Œçš„ G æ—¶ï¼Œå®ƒæ‰€ç»‘å®šçš„ P ä¼šå°è¯•ä»å…¶ä»–çº¿ç¨‹ç»‘å®šçš„ P çªƒå–Gï¼Œè€Œä¸æ˜¯é”€æ¯çº¿ç¨‹ã€‚</p></li><li><p>ç§»äº¤ï¼ˆHand Offï¼‰æœºåˆ¶</p><p>å½“æœ¬çº¿ç¨‹å› ä¸º G è¿›è¡Œç³»ç»Ÿè°ƒç”¨è€Œé˜»å¡æ—¶ï¼Œçº¿ç¨‹ä¼šé‡Šæ”¾ç»‘å®šçš„ Pï¼ŒæŠŠ Pç§»äº¤ç»™å…¶ä»–ç©ºé—²çš„çº¿ç¨‹æ‰§è¡Œã€‚</p></li></ol><h2 id="è°ƒåº¦æ—¶æœº">6. è°ƒåº¦æ—¶æœº</h2><p>Go è¯­è¨€çš„è°ƒåº¦å™¨ç»“åˆäº†æŠ¢å å¼è°ƒåº¦å’Œåä½œå¼è°ƒåº¦ï¼Œä»¥ä¸‹æ˜¯ Goä¸­è¿™ä¸¤ç§è°ƒåº¦æ–¹å¼çš„å…·ä½“å®ç°å’Œç‰¹æ€§ï¼š</p><h3 id="åä½œå¼è°ƒåº¦cooperative-scheduling">6.1 åä½œå¼è°ƒåº¦ï¼ˆCooperativeSchedulingï¼‰</h3><p><strong>é˜»å¡æ“ä½œ</strong>ï¼š</p><ul><li>å½“ Goroutineæ‰§è¡Œé˜»å¡æ“ä½œï¼ˆå¦‚é€šé“æ“ä½œã€ç­‰å¾…é”ã€ç³»ç»Ÿè°ƒç”¨ç­‰ï¼‰æ—¶ï¼Œå®ƒä¼šä¸»åŠ¨æ”¾å¼ƒ CPUæ§åˆ¶æƒï¼Œå…è®¸è°ƒåº¦å™¨åˆ‡æ¢åˆ°å…¶ä»– Goroutineã€‚</li></ul><p><strong>æ˜¾å¼è°ƒåº¦</strong>ï¼š</p><ul><li>Goroutine æ˜¾å¼è¯·æ±‚ <code>runtime.Gosched()</code>è°ƒç”¨ï¼Œè°ƒåº¦å™¨è¿›è¡Œè°ƒåº¦ã€‚</li><li>è¿™ä¸ªæ—¶å€™å›ä»å½“å‰åç¨‹åˆ‡æ¢åˆ° g0 åç¨‹ï¼Œå–æ¶ˆ G ä¸ M ä¹‹é—´çš„ç»‘å®šå…³ç³»ï¼ŒæŠŠ Gæ”¾å…¥å…¨å±€é˜Ÿåˆ—ä¸­ã€‚</li></ul><h3 id="æŠ¢å å¼è°ƒåº¦preemptive-scheduling">6.2 æŠ¢å å¼è°ƒåº¦ï¼ˆPreemptiveSchedulingï¼‰</h3><p><strong>åŸºäºæ—¶é—´çš„æŠ¢å </strong>ï¼š</p><ul><li>ä» Go 1.14 å¼€å§‹ï¼Œè°ƒåº¦å™¨å¼•å…¥äº†åŸºäºæ—¶é—´çš„æŠ¢å æœºåˆ¶ã€‚å¦‚æœä¸€ä¸ª Goroutineè¿è¡Œæ—¶é—´è¶…è¿‡ 10 æ¯«ç§’ï¼Œæˆ–è€…åœ¨ç³»ç»Ÿè°ƒç”¨ä¸­è¶…è¿‡äº† 20å¾®å¦™ï¼Œè°ƒåº¦å™¨ä¼šåœ¨å®‰å…¨ç‚¹ï¼ˆå¦‚å‡½æ•°è°ƒç”¨ã€å¾ªç¯è¿­ä»£ã€é˜»å¡æ“ä½œç­‰ï¼‰å°è¯•æš‚åœè¯¥Goroutineã€‚</li><li>è¿™ç§æŠ¢å ä¸ä¾èµ–äº Goroutineçš„æ˜¾å¼æ”¾å¼ƒæ§åˆ¶ï¼Œè€Œæ˜¯ç”±è°ƒåº¦å™¨ä¸»åŠ¨è§¦å‘ã€‚</li><li>å®‰å…¨ç‚¹çš„é€‰æ‹©æ—¨åœ¨å‡å°‘å¯¹ Goroutineæ‰§è¡Œçš„å¹²æ‰°ï¼ŒåŒæ—¶ç¡®ä¿è°ƒåº¦çš„å…¬å¹³æ€§å’Œå“åº”æ€§ã€‚</li></ul><p><strong>åŸºäºä¿¡å·çš„æŠ¢å ï¼š</strong></p><ul><li>å½“ç¨‹åºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ—¢æ— æ³•ä¸»åŠ¨æŒ‚èµ·ï¼Œä¹Ÿä¸èƒ½è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œä¸”æ— æ³•è¿›è¡Œå‡½æ•°è°ƒç”¨æ—¶ï¼Œå°±å¯ä»¥ä½¿ç”¨ä¿¡å·æ¥è°ƒåº¦ã€‚</li><li>ä¿¡å·å…¶å®å°±æ˜¯çº¿ç¨‹ä¿¡å·ï¼Œåœ¨æ“ä½œç³»ç»Ÿä¸­æœ‰å¾ˆå¤šåŸºäºä¿¡å·çš„åº•å±‚é€šä¿¡æ–¹å¼ï¼ˆSIGPIPE/ SIGURG / SIGHUPï¼‰ï¼Œè€Œæˆ‘ä»¬çš„çº¿ç¨‹å¯ä»¥æ³¨å†Œå¯¹åº”ä¿¡å·çš„å¤„ç†å‡½æ•°ã€‚</li><li>å½“çº¿ç¨‹æ¥æ”¶åˆ°æŠ¢å ä¿¡å·æ—¶ï¼Œä¼šè¿›å…¥ä¸€ä¸ªä¸“é—¨çš„ä¿¡å·å¤„ç†å™¨ã€‚è¿™ä¸ªå¤„ç†å™¨ä¼šæ£€æŸ¥æ˜¯å¦å¤„äºå®‰å…¨ç‚¹ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æš‚åœå½“å‰Goroutine å¹¶è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</li></ul><h1 id="æºç åˆ†æ">æºç åˆ†æ</h1><p>å‰é¢æˆ‘ä»¬å¯¹ Go è¯­è¨€çš„ GPMæ¨¡å‹åœ¨åŸºæœ¬æ¦‚å¿µã€è°ƒåº¦å¾ªç¯ã€è°ƒåº¦ç­–ç•¥å’Œè°ƒåº¦æ—¶æœºå„ä¸ªæ–¹é¢éƒ½è¿›è¡Œäº†è¯¦ç»†çš„é˜è¿°ã€‚å¦‚æœè¯»è€…åªæ˜¯æƒ³ç®€å•äº†è§£ä¸€ä¸‹GPMæ¨¡å‹çš„ä¸€äº›æ¦‚å¿µå’Œè®¾è®¡æ€æƒ³ï¼Œé‚£ä¹ˆé˜…è¯»åˆ°è¿™é‡Œå°±åŸºæœ¬è¶³å¤Ÿäº†ã€‚å¦‚æœå¯¹å…¶æºç å®ç°æœ‰å…´è¶£çš„è¯ï¼Œé‚£ä¹ˆè¯·ç»§ç»­å¾€ä¸‹é˜…è¯»~</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ¥å¯¹ Go è¯­è¨€çš„ GPM æ¨¡å‹è¿›è¡Œæºç åˆ†æï¼š</p><ol type="1"><li>Gã€Pã€M åœ¨ Go è¯­è¨€ä¸­çš„è¡¨ç¤ºã€‚</li><li>G çš„åˆ›å»ºè¿‡ç¨‹ã€‚</li><li>g å’Œ g0 çš„åˆ‡æ¢è¿‡ç¨‹ã€‚</li><li>GPM çš„è°ƒåº¦æœºåˆ¶ã€‚</li></ol><h2 id="g-çš„åº•å±‚ç»“æ„">1. G çš„åº•å±‚ç»“æ„</h2><p>G åœ¨ Go é‡Œé¢å°±æ˜¯ <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/runtime2.go">runtime2.go</a>é‡Œé¢å®šä¹‰çš„ <code>g</code> ç»“æ„ä½“ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> g <span class="hljs-keyword">struct</span> &#123;<br><span class="hljs-comment">// æ ˆå‚æ•°ã€‚</span><br><span class="hljs-comment">// stack æè¿°å®é™…çš„æ ˆå†…å­˜ï¼š[stack.lo, stack.hi)ã€‚</span><br><span class="hljs-comment">// stackguard0 æ˜¯åœ¨ Go æ ˆå¢é•¿åºè¨€ä¸­æ¯”è¾ƒçš„æ ˆæŒ‡é’ˆã€‚</span><br><span class="hljs-comment">// é€šå¸¸æ˜¯ stack.lo+StackGuardï¼Œä½†å¯ä»¥æ˜¯ StackPreempt æ¥è§¦å‘æŠ¢å ã€‚</span><br><span class="hljs-comment">// stackguard1 æ˜¯åœ¨ C æ ˆå¢é•¿åºè¨€ä¸­æ¯”è¾ƒçš„æ ˆæŒ‡é’ˆã€‚</span><br><span class="hljs-comment">// åœ¨ g0 å’Œ gsignal æ ˆä¸Šæ˜¯ stack.lo+StackGuardã€‚</span><br><span class="hljs-comment">// åœ¨å…¶ä»– goroutine æ ˆä¸Šæ˜¯ ~0ï¼Œä»¥è§¦å‘å¯¹ morestackc çš„è°ƒç”¨ï¼ˆå¹¶å´©æºƒï¼‰ã€‚</span><br>stack       stack   <span class="hljs-comment">// è¿è¡Œæ—¶/CGO å·²çŸ¥çš„åç§»</span><br>stackguard0 <span class="hljs-type">uintptr</span> <span class="hljs-comment">// liblink å·²çŸ¥çš„åç§»</span><br>stackguard1 <span class="hljs-type">uintptr</span> <span class="hljs-comment">// liblink å·²çŸ¥çš„åç§»</span><br><br>_panic    *_panic <span class="hljs-comment">// æœ€å†…å±‚çš„ panic - liblink å·²çŸ¥çš„åç§»</span><br>_defer    *_defer <span class="hljs-comment">// æœ€å†…å±‚çš„ defer</span><br>m         *m      <span class="hljs-comment">// å½“å‰ mï¼›arm liblink å·²çŸ¥çš„åç§»</span><br>sched     gobuf   <span class="hljs-comment">// å½“å‰åç¨‹çš„è¿è¡Œç°åœº</span><br>syscallsp <span class="hljs-type">uintptr</span> <span class="hljs-comment">// å¦‚æœ status==Gsyscall, syscallsp = sched.sp åœ¨ gc æœŸé—´ä½¿ç”¨</span><br>syscallpc <span class="hljs-type">uintptr</span> <span class="hljs-comment">// å¦‚æœ status==Gsyscall, syscallpc = sched.pc åœ¨ gc æœŸé—´ä½¿ç”¨</span><br>stktopsp  <span class="hljs-type">uintptr</span> <span class="hljs-comment">// æ ˆé¡¶çš„é¢„æœŸ spï¼Œç”¨äºå›æº¯æ£€æŸ¥</span><br><span class="hljs-comment">// param æ˜¯ä¸€ä¸ªé€šç”¨çš„æŒ‡é’ˆå‚æ•°å­—æ®µï¼Œç”¨äºåœ¨ç‰¹å®šä¸Šä¸‹æ–‡ä¸­ä¼ é€’å€¼ï¼Œ</span><br><span class="hljs-comment">// å…¶ä»–å­˜å‚¨å‚æ•°çš„æ–¹å¼éš¾ä»¥æ‰¾åˆ°ã€‚ç›®å‰æœ‰ä¸‰ç§ç”¨é€”ï¼š</span><br><span class="hljs-comment">// 1. å½“é€šé“æ“ä½œå”¤é†’ä¸€ä¸ªé˜»å¡çš„ goroutine æ—¶ï¼Œå®ƒå°† param è®¾ç½®ä¸º</span><br><span class="hljs-comment">//    æŒ‡å‘å·²å®Œæˆé˜»å¡æ“ä½œçš„ sudogã€‚</span><br><span class="hljs-comment">// 2. ç”± gcAssistAlloc1 ä½¿ç”¨ï¼Œä»¥å‘å…¶è°ƒç”¨è€…ä¿¡å·ï¼Œè¡¨æ˜ goroutine å®Œæˆäº† GC å‘¨æœŸã€‚</span><br><span class="hljs-comment">//    ä»¥ä»»ä½•å…¶ä»–æ–¹å¼è¿™æ ·åšæ˜¯ä¸å®‰å…¨çš„ï¼Œå› ä¸ºæ­¤æ—¶ goroutine çš„æ ˆå¯èƒ½å·²ç»ç§»åŠ¨ã€‚</span><br><span class="hljs-comment">// 3. ç”± debugCallWrap ä½¿ç”¨ï¼Œä»¥å°†å‚æ•°ä¼ é€’ç»™æ–°çš„ goroutineï¼Œå› ä¸ºåœ¨è¿è¡Œæ—¶åˆ†é…é—­åŒ…æ˜¯è¢«ç¦æ­¢çš„ã€‚</span><br>param        unsafe.Pointer<br>atomicstatus atomic.Uint32<br>stackLock    <span class="hljs-type">uint32</span> <span class="hljs-comment">// sigprof/scang é”ï¼›<span class="hljs-doctag">TODO:</span> åˆå¹¶åˆ° atomicstatus</span><br>goid         <span class="hljs-type">uint64</span><br>schedlink    guintptr<br>waitsince    <span class="hljs-type">int64</span>      <span class="hljs-comment">// g å˜ä¸ºé˜»å¡çš„å¤§è‡´æ—¶é—´</span><br>waitreason   waitReason <span class="hljs-comment">// å¦‚æœ status==Gwaiting</span><br><br>preempt       <span class="hljs-type">bool</span> <span class="hljs-comment">// æŠ¢å ä¿¡å·ï¼Œå¤åˆ¶ stackguard0 = stackpreempt</span><br>preemptStop   <span class="hljs-type">bool</span> <span class="hljs-comment">// åœ¨æŠ¢å æ—¶è½¬æ¢ä¸º _Gpreemptedï¼›å¦åˆ™ï¼Œåªæ˜¯å–æ¶ˆè°ƒåº¦</span><br>preemptShrink <span class="hljs-type">bool</span> <span class="hljs-comment">// åœ¨åŒæ­¥å®‰å…¨ç‚¹ç¼©å°æ ˆ</span><br><br><span class="hljs-comment">// asyncSafePoint è®¾ç½®ä¸º true è¡¨ç¤º g åœ¨å¼‚æ­¥å®‰å…¨ç‚¹åœæ­¢ã€‚</span><br><span class="hljs-comment">// è¿™æ„å‘³ç€æ ˆä¸Šæœ‰æ²¡æœ‰ç²¾ç¡®æŒ‡é’ˆä¿¡æ¯çš„å¸§ã€‚</span><br>asyncSafePoint <span class="hljs-type">bool</span><br><br>paniconfault <span class="hljs-type">bool</span> <span class="hljs-comment">// åœ¨æ„å¤–çš„æ•…éšœåœ°å€ä¸Šè§¦å‘ panicï¼ˆè€Œä¸æ˜¯å´©æºƒï¼‰</span><br>gcscandone   <span class="hljs-type">bool</span> <span class="hljs-comment">// g å·²æ‰«ææ ˆï¼›ç”± _Gscan ä½åœ¨çŠ¶æ€ä¸­ä¿æŠ¤</span><br>throwsplit   <span class="hljs-type">bool</span> <span class="hljs-comment">// å¿…é¡»ä¸åˆ†å‰²æ ˆ</span><br><span class="hljs-comment">// activeStackChans è¡¨ç¤ºæœ‰æœªé”å®šçš„é€šé“æŒ‡å‘è¿™ä¸ª goroutine çš„æ ˆã€‚</span><br><span class="hljs-comment">// å¦‚æœä¸º trueï¼Œæ ˆå¤åˆ¶éœ€è¦è·å–é€šé“é”æ¥ä¿æŠ¤è¿™äº›æ ˆåŒºåŸŸã€‚</span><br>activeStackChans <span class="hljs-type">bool</span><br><span class="hljs-comment">// parkingOnChan è¡¨ç¤º goroutine å³å°†åœ¨ chansend æˆ– chanrecv ä¸Šåœè½¦ã€‚</span><br><span class="hljs-comment">// ç”¨äºæ ‡è®°æ ˆç¼©å°çš„ä¸å®‰å…¨ç‚¹ã€‚</span><br>parkingOnChan atomic.Bool<br><br>raceignore    <span class="hljs-type">int8</span>  <span class="hljs-comment">// å¿½ç•¥ç«æ€æ£€æµ‹äº‹ä»¶</span><br>tracking      <span class="hljs-type">bool</span>  <span class="hljs-comment">// æ˜¯å¦è·Ÿè¸ªæ­¤ G ä»¥è·å–è°ƒåº¦å»¶è¿Ÿç»Ÿè®¡</span><br>trackingSeq   <span class="hljs-type">uint8</span> <span class="hljs-comment">// ç”¨äºå†³å®šæ˜¯å¦è·Ÿè¸ªæ­¤ G</span><br>trackingStamp <span class="hljs-type">int64</span> <span class="hljs-comment">// G æœ€åå¼€å§‹è¢«è·Ÿè¸ªçš„æ—¶é—´æˆ³</span><br>runnableTime  <span class="hljs-type">int64</span> <span class="hljs-comment">// å¯è¿è¡Œæ—¶é—´ï¼Œè¿è¡Œæ—¶æ¸…é™¤ï¼Œä»…åœ¨è·Ÿè¸ªæ—¶ä½¿ç”¨</span><br>lockedm       muintptr<br>sig           <span class="hljs-type">uint32</span><br>writebuf      []<span class="hljs-type">byte</span><br>sigcode0      <span class="hljs-type">uintptr</span><br>sigcode1      <span class="hljs-type">uintptr</span><br>sigpc         <span class="hljs-type">uintptr</span><br>parentGoid    <span class="hljs-type">uint64</span>          <span class="hljs-comment">// åˆ›å»ºæ­¤ goroutine çš„ goroutine çš„ goid</span><br>gopc          <span class="hljs-type">uintptr</span>         <span class="hljs-comment">// åˆ›å»ºæ­¤ goroutine çš„ go è¯­å¥çš„ pc</span><br>ancestors     *[]ancestorInfo <span class="hljs-comment">// åˆ›å»ºæ­¤ goroutine çš„ç¥–å…ˆ goroutine çš„ä¿¡æ¯ï¼ˆä»…åœ¨ debug.tracebackancestors ä½¿ç”¨ï¼‰</span><br>startpc       <span class="hljs-type">uintptr</span>         <span class="hljs-comment">// goroutine å‡½æ•°çš„ pc</span><br>racectx       <span class="hljs-type">uintptr</span><br>waiting       *sudog         <span class="hljs-comment">// æ­¤ g æ­£åœ¨ç­‰å¾…çš„ sudog ç»“æ„ï¼ˆå…·æœ‰æœ‰æ•ˆçš„ elem æŒ‡é’ˆï¼‰ï¼›æŒ‰é”é¡ºåº</span><br>cgoCtxt       []<span class="hljs-type">uintptr</span>      <span class="hljs-comment">// cgo å›æº¯ä¸Šä¸‹æ–‡</span><br>labels        unsafe.Pointer <span class="hljs-comment">// åˆ†æå™¨æ ‡ç­¾</span><br>timer         *timer         <span class="hljs-comment">// ç¼“å­˜çš„è®¡æ—¶å™¨ï¼Œç”¨äº time.Sleep</span><br>selectDone    atomic.Uint32  <span class="hljs-comment">// æˆ‘ä»¬æ˜¯å¦å‚ä¸ select å¹¶ä¸”æœ‰äººèµ¢å¾—äº†ç«èµ›ï¼Ÿ</span><br><br><span class="hljs-comment">// goroutineProfiled æŒ‡ç¤ºå½“å‰ goroutine çš„æ ˆçŠ¶æ€</span><br>  <span class="hljs-comment">// æ˜¯å¦å·²ç»è¢«è®°å½•åœ¨è¿›è¡Œä¸­çš„ goroutine æ€§èƒ½åˆ†æä¸­ã€‚</span><br>goroutineProfiled goroutineProfileStateHolder<br><br><span class="hljs-comment">// æ¯ä¸ª G çš„è¿½è¸ªçŠ¶æ€ã€‚</span><br>trace gTraceState<br><br><span class="hljs-comment">// æ¯ä¸ª G çš„ GC çŠ¶æ€</span><br><br><span class="hljs-comment">// gcAssistBytes æ˜¯æ­¤ G çš„ GC ååŠ©ä¿¡ç”¨ï¼Œä»¥åˆ†é…çš„å­—èŠ‚ä¸ºå•ä½ã€‚</span><br><span class="hljs-comment">// å¦‚æœä¸ºæ­£ï¼Œåˆ™ G æœ‰ä¿¡ç”¨åˆ†é… gcAssistBytes å­—èŠ‚è€Œä¸ååŠ©ã€‚</span><br><span class="hljs-comment">// å¦‚æœä¸ºè´Ÿï¼Œåˆ™ G å¿…é¡»é€šè¿‡æ‰§è¡Œæ‰«æå·¥ä½œæ¥çº æ­£è¿™ä¸€ç‚¹ã€‚</span><br><span class="hljs-comment">// æˆ‘ä»¬ä»¥å­—èŠ‚ä¸ºå•ä½è·Ÿè¸ªè¿™ä¸€ç‚¹ï¼Œä»¥ä¾¿åœ¨ malloc çƒ­è·¯å¾„ä¸­å¿«é€Ÿæ›´æ–°å’Œæ£€æŸ¥å€ºåŠ¡ã€‚</span><br><span class="hljs-comment">// ååŠ©æ¯”ç‡å†³å®šäº†è¿™å¦‚ä½•å¯¹åº”äºæ‰«æå·¥ä½œå€ºåŠ¡ã€‚</span><br>gcAssistBytes <span class="hljs-type">int64</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° <code>g</code> ç»“æ„å­—æ®µéå¸¸å¤šï¼Œè¿™ä¸ªç»“æ„ä½“çš„è®¾è®¡åæ˜ äº† Goè¯­è¨€å¯¹å¹¶å‘å’Œåç¨‹ç®¡ç†çš„åº•å±‚æœºåˆ¶ï¼ŒåŒ…æ‹¬æ ˆç®¡ç†ã€è°ƒåº¦ã€åƒåœ¾å›æ”¶ã€å¼‚å¸¸å¤„ç†ç­‰å¤šä¸ªæ–¹é¢ã€‚é€šè¿‡è¿™ç§æŠ½è±¡ï¼ŒGoè¯­è¨€èƒ½å¤Ÿæœ‰æ•ˆåœ°ç®¡ç†æˆåƒä¸Šä¸‡çš„<code>goroutine</code>ï¼Œä½¿å¾—å¹¶å‘ç¼–ç¨‹å˜å¾—æ›´åŠ ç®€å•å’Œé«˜æ•ˆã€‚</p><p>è¿™é‡Œæˆ‘ä»¬åªå…³æ³¨ GPM æ¨¡å‹ç›¸å…³çš„å†…å®¹ï¼Œéœ€è¦é‡ç‚¹å…³å¿ƒä»¥ä¸‹å‡ ä¸ªå­—æ®µï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> g <span class="hljs-keyword">struct</span> &#123;<br>stack     stack   <span class="hljs-comment">// å½“å‰åç¨‹çš„åç¨‹æ ˆ</span><br>m         *m      <span class="hljs-comment">// å½“å‰çº¿ç¨‹</span><br>sched     gobuf  <span class="hljs-comment">// ä¿å­˜åç¨‹çš„è¿è¡Œç°åœº</span><br>atomicstatus atomic.Uint32<span class="hljs-comment">// åç¨‹çŠ¶æ€</span><br>goid         <span class="hljs-type">uint64</span><span class="hljs-comment">// åç¨‹ID</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åç¨‹æ ˆ-stack">1.1 åç¨‹æ ˆ stack</h3><p>å…¶ä¸­ <code>stack</code>ç»“æ„å¦‚ä¸‹ï¼Œå®ƒå­˜å‚¨äº†åç¨‹æ ˆçš„ä½åœ°å€å’Œé«˜åœ°å€ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> stack <span class="hljs-keyword">struct</span> &#123;<br>lo <span class="hljs-type">uintptr</span> <span class="hljs-comment">// æ ˆçš„ä½åœ°å€</span><br>hi <span class="hljs-type">uintptr</span> <span class="hljs-comment">// æ ˆçš„é«˜åœ°å€</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="çº¿ç¨‹æŠ½è±¡-m">1.2 çº¿ç¨‹æŠ½è±¡ m</h3><p>è€Œ <code>m</code> å°±æ˜¯ Goè¯­è¨€å¯¹æ“ä½œç³»ç»Ÿçº¿ç¨‹çš„æŠ½è±¡ï¼Œè¿™ä¸æ˜¯å®é™…çš„çº¿ç¨‹ï¼Œè¿™åªæ˜¯ Goè¯­è¨€å¯¹çº¿ç¨‹ç›¸å…³ä¿¡æ¯çš„æŠ½è±¡ï¼Œä»¥æ–¹ä¾¿æ›´å¥½åœ°è°ƒåº¦åç¨‹ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> m <span class="hljs-keyword">struct</span> &#123;<br>g0      *g     <span class="hljs-comment">// g0 åç¨‹ï¼ŒGo ä¸­çš„ä¸»åç¨‹</span><br>curg    *g       <span class="hljs-comment">// ç°åœ¨æ­£åœ¨è¿è¡Œçš„åç¨‹</span><br>id      <span class="hljs-type">int64</span> <span class="hljs-comment">// çº¿ç¨‹ID</span><br>mOS<span class="hljs-comment">// å½“å‰æ“ä½œç³»ç»Ÿå¯¹çº¿ç¨‹çš„é¢å¤–æè¿°ä¿¡æ¯</span><br>...<br>&#125;<br></code></pre></td></tr></table></figure><p><code>m</code>ç»“æ„ä½“åŒ…å«äº†è®¸å¤šå­—æ®µï¼Œè¿™äº›å­—æ®µæ¶‰åŠåˆ°çº¿ç¨‹ç®¡ç†ã€è°ƒåº¦ã€ä¿¡å·å¤„ç†ã€ç³»ç»Ÿè°ƒç”¨ã€é”ç®¡ç†ç­‰å¤šä¸ªæ–¹é¢ã€‚è¿™ä¸ªç»“æ„ä½“æ˜¯Go å¹¶å‘æ¨¡å‹çš„æ ¸å¿ƒéƒ¨åˆ†ä¹‹ä¸€ï¼Œå®ƒä¸ <code>g</code>ï¼ˆgoroutineï¼‰å’Œ<code>p</code>ï¼ˆprocessorï¼‰ç»“æ„ä½“ä¸€èµ·ï¼Œæ„æˆäº† Goçš„è°ƒåº¦ç³»ç»Ÿçš„åŸºç¡€ã€‚é€šè¿‡è¿™ç§è®¾è®¡ï¼ŒGoèƒ½å¤Ÿæœ‰æ•ˆåœ°åœ¨å¤šä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ä¹‹é—´è°ƒåº¦æˆåƒä¸Šä¸‡çš„goroutineï¼Œå®ç°é«˜æ•ˆçš„å¹¶å‘æ‰§è¡Œã€‚</p><h3 id="åç¨‹ä¸Šä¸‹æ–‡-gobuf">1.3 åç¨‹ä¸Šä¸‹æ–‡ gobuf</h3><p><code>gobuf</code> ç»“æ„ä½“åœ¨ Go è¯­è¨€çš„è¿è¡Œæ—¶ç³»ç»Ÿä¸­ç”¨äºä¿å­˜<code>Goroutine</code>çš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œç‰¹åˆ«æ˜¯åœ¨è°ƒåº¦å’Œç³»ç»Ÿè°ƒç”¨ä¸­ã€‚è¿™ä¸ªç»“æ„ä½“ä¿å­˜äº†è¶³å¤Ÿçš„ä¿¡æ¯ä»¥ä¾¿åœ¨<code>Goroutine</code> è¢«æš‚åœåèƒ½å¤Ÿæ¢å¤æ‰§è¡Œã€‚</p><p>ä¸‹é¢æ˜¯å¯¹ <code>gobuf</code> ç»“æ„ä½“ä¸­å„ä¸ªå­—æ®µçš„è§£é‡Šï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> gobuf <span class="hljs-keyword">struct</span> &#123;<br><span class="hljs-comment">// sp, pc å’Œ g çš„åç§»é‡æ˜¯å·²çŸ¥çš„ï¼ˆåœ¨ libmach ä¸­ç¡¬ç¼–ç ï¼‰ã€‚</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// ctxt åœ¨ GC æ–¹é¢æ¯”è¾ƒç‰¹æ®Šï¼šå®ƒå¯èƒ½æ˜¯ä¸€ä¸ªå †åˆ†é…çš„ funcvalï¼Œ</span><br><span class="hljs-comment">// å› æ­¤ GC éœ€è¦è·Ÿè¸ªå®ƒï¼Œä½†å®ƒéœ€è¦åœ¨æ±‡ç¼–ä¸­è®¾ç½®å’Œæ¸…é™¤ï¼Œ</span><br><span class="hljs-comment">// åœ¨é‚£é‡Œå®ç°å†™å±éšœæ¯”è¾ƒå›°éš¾ã€‚ç„¶è€Œï¼Œctxt å®é™…ä¸Šæ˜¯ä¸€ä¸ªä¿å­˜çš„ã€æ´»è·ƒçš„å¯„å­˜å™¨ï¼Œ</span><br><span class="hljs-comment">// æˆ‘ä»¬åªåœ¨çœŸå®å¯„å­˜å™¨å’Œ gobuf ä¹‹é—´äº¤æ¢å®ƒã€‚å› æ­¤ï¼Œæˆ‘ä»¬åœ¨æ ˆæ‰«ææœŸé—´å°†å…¶è§†ä¸ºæ ¹ï¼Œ</span><br><span class="hljs-comment">// è¿™æ„å‘³ç€ä¿å­˜å’Œæ¢å¤å®ƒçš„æ±‡ç¼–ä¸éœ€è¦å†™å±éšœã€‚å®ƒä»ç„¶è¢«ç±»å‹åŒ–ä¸ºæŒ‡é’ˆï¼Œ</span><br><span class="hljs-comment">// ä»¥ä¾¿ä»»ä½•å…¶ä»–ä» Go è¿›è¡Œçš„å†™æ“ä½œéƒ½ä¼šè·å¾—å†™å±éšœã€‚</span><br>sp   <span class="hljs-type">uintptr</span>        <span class="hljs-comment">// æ ˆæŒ‡é’ˆ</span><br>pc   <span class="hljs-type">uintptr</span>        <span class="hljs-comment">// ç¨‹åºè®¡æ•°å™¨</span><br>g    guintptr       <span class="hljs-comment">// æŒ‡å‘å½“å‰ goroutine çš„æŒ‡é’ˆ</span><br>ctxt unsafe.Pointer <span class="hljs-comment">// ä¸Šä¸‹æ–‡ï¼Œç”¨äºä¿å­˜é¢å¤–çš„çŠ¶æ€æˆ–ä¿¡æ¯</span><br>ret  <span class="hljs-type">uintptr</span>        <span class="hljs-comment">// ç”¨äºä¿å­˜å‡½æ•°è¿”å›å€¼</span><br>lr   <span class="hljs-type">uintptr</span>        <span class="hljs-comment">// é“¾æ¥å¯„å­˜å™¨ï¼ˆåœ¨æŸäº›æ¶æ„ä¸­ç”¨äºå‡½æ•°è°ƒç”¨ï¼‰</span><br>bp   <span class="hljs-type">uintptr</span>        <span class="hljs-comment">// åŸºæŒ‡é’ˆï¼ˆåœ¨å¯ç”¨å¸§æŒ‡é’ˆçš„æ¶æ„ä¸­ä½¿ç”¨ï¼‰</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬é‡ç‚¹éœ€è¦å…³æ³¨ 2 ä¸ªå­—æ®µï¼š</p><ul><li><code>sp</code>ï¼šæ ˆæŒ‡é’ˆï¼Œè¡¨ç¤ºå½“å‰åç¨‹è¿è¡Œåˆ°æ ˆä¸­çš„å“ªä¸ªä½ç½®äº†ã€‚</li><li><code>pc</code>ï¼šç¨‹åºè®¡æ•°å™¨ï¼Œè¡¨ç¤ºå½“å‰åç¨‹è¿è¡Œåˆ°å“ªä¸€è¡Œä»£ç äº†ã€‚</li></ul><h3 id="åç¨‹çŠ¶æ€-atomicstatus">1.4 åç¨‹çŠ¶æ€ atomicstatus</h3><p>æˆ‘è®°å¾—åœ¨ Go1.16 ç‰ˆæœ¬ä¸­ï¼Œè¿™ä¸ªå­—æ®µçš„ç±»å‹è¿˜æ˜¯ <code>uint32</code>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">atomicstatus <span class="hljs-type">uint32</span><br></code></pre></td></tr></table></figure><p>ç°åœ¨ Go1.21 ç‰ˆæœ¬ä¸­ï¼Œå·²ç»ç”¨äº†åŸå­æ“ä½œæ¥å‡å°‘å¹¶å‘å†²çªäº†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">atomicstatus atomic.Uint32<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° Go çš„åº•å±‚ä¹Ÿæ˜¯éšç€ç‰ˆæœ¬æ›´æ–°ä¸æ–­ä¼˜åŒ–ä¸­çš„ã€‚</p><p><ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/runtime2.go">runtime2.go</a>å®šä¹‰äº† G çš„å„ç§çŠ¶æ€ï¼Œå¦‚ï¼š</p><ul><li><code>_Gidle (0)</code>: è¡¨ç¤º G åˆšåˆšè¢«åˆ†é…ï¼Œå°šæœªåˆå§‹åŒ–ã€‚</li><li><code>_Grunnable (1)</code>: è¡¨ç¤º Gåœ¨è¿è¡Œé˜Ÿåˆ—ä¸Šã€‚å®ƒå½“å‰æ²¡æœ‰æ‰§è¡Œç”¨æˆ·ä»£ç ã€‚æ ˆä¸è¢«è¯¥ <code>goroutine</code>æ‹¥æœ‰ã€‚</li><li>...</li></ul><p>åé¢æˆ‘ä»¬ä¼šç»™å‡º G çŠ¶æ€çš„æµè½¬å›¾ã€‚</p><h3 id="ä¸¾ä¸ªä¾‹å­">1.5 ä¸¾ä¸ªä¾‹å­</h3><p>å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰ä»¥ä¸‹ Go ä»£ç ï¼šmain() è°ƒç”¨ do1()ï¼Œdo1() è°ƒç”¨do2()ï¼Œdo2() è°ƒç”¨ do3()ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">do3</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;here is do3&quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">do2</span><span class="hljs-params">()</span></span> &#123;<br>do3()<span class="hljs-comment">//&lt;---------------</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">do1</span><span class="hljs-params">()</span></span> &#123;<br>do2()<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>do1()<br>&#125;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆå½“è¿™æ®µç¨‹åºè¿è¡Œåˆ°ç¬¬ 6 è¡Œçš„æ—¶å€™ï¼Œå®ƒçš„åº•å±‚ç»“æ„å¤§æ¦‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/e6c9d24egy1h569pjiiosj21cu0u040p.jpg"alt="Goroutine åº•å±‚ç»“æ„ç¤ºä¾‹" /><figcaption aria-hidden="true">Goroutine åº•å±‚ç»“æ„ç¤ºä¾‹</figcaption></figure><p>è‡³äºä¸ºä»€ä¹ˆè¿™é‡Œæœ‰ä¸ª <code>goexit()</code>ï¼Œå…¶å®å°±æ˜¯ä¸ºäº†å¯ä»¥è·³å›åˆ°<code>g0</code> åç¨‹ï¼Œåé¢æˆ‘ä»¬ä¼šå…·ä½“åˆ†æåˆ°ã€‚</p><h2 id="p-çš„åº•å±‚ç»“æ„">2. P çš„åº•å±‚ç»“æ„</h2><p>P çš„æœ¬è´¨æ˜¯ <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/runtime2.go">runtime2.go</a>é‡Œé¢å®šä¹‰çš„ <code>p</code> ç»“æ„ä½“ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> p <span class="hljs-keyword">struct</span> &#123;<br>    id          <span class="hljs-type">int32</span>          <span class="hljs-comment">// P çš„å”¯ä¸€æ ‡è¯†ç¬¦</span><br>    status      <span class="hljs-type">uint32</span>         <span class="hljs-comment">// P çš„çŠ¶æ€ï¼Œå¦‚ pidle/prunning/...</span><br>    link        puintptr       <span class="hljs-comment">// P é“¾æ¥</span><br>    schedtick   <span class="hljs-type">uint32</span>         <span class="hljs-comment">// æ¯æ¬¡è°ƒåº¦å™¨è°ƒç”¨æ—¶é€’å¢</span><br>    syscalltick <span class="hljs-type">uint32</span>         <span class="hljs-comment">// æ¯æ¬¡ç³»ç»Ÿè°ƒç”¨æ—¶é€’å¢</span><br>    sysmontick  sysmontick     <span class="hljs-comment">// sysmon è§‚å¯Ÿåˆ°çš„æœ€åä¸€ä¸ª tick</span><br>    m           muintptr       <span class="hljs-comment">// å…³è”çš„ M çš„åå‘é“¾æ¥ï¼ˆå¦‚æœç©ºé—²åˆ™ä¸º nilï¼‰</span><br>    mcache      *mcache        <span class="hljs-comment">// M ç¼“å­˜</span><br>    pcache      pageCache      <span class="hljs-comment">// é¡µé¢ç¼“å­˜</span><br>    raceprocctx <span class="hljs-type">uintptr</span>        <span class="hljs-comment">// ç”¨äºç«æ€æ£€æµ‹çš„ä¸Šä¸‹æ–‡</span><br><br>    <span class="hljs-comment">// å»¶è¿Ÿç»“æ„ä½“æ± </span><br>    deferpool    []*_defer<br>    deferpoolbuf [<span class="hljs-number">32</span>]*_defer<br><br>    <span class="hljs-comment">// Goroutine ID ç¼“å­˜ï¼Œå‡å°‘å¯¹ runtimeÂ·sched.goidgen çš„è®¿é—®</span><br>    goidcache    <span class="hljs-type">uint64</span><br>    goidcacheend <span class="hljs-type">uint64</span><br><br>    <span class="hljs-comment">// å¯è¿è¡Œ goroutine é˜Ÿåˆ—ï¼Œæ— é”è®¿é—®</span><br>    runqhead <span class="hljs-type">uint32</span><br>    runqtail <span class="hljs-type">uint32</span><br>    runq     [<span class="hljs-number">256</span>]guintptr<br>    runnext  guintptr <span class="hljs-comment">// ä¸‹ä¸€ä¸ªè¦è¿è¡Œçš„ G</span><br><br>    <span class="hljs-comment">// ç©ºé—² G çš„åˆ—è¡¨ï¼ˆçŠ¶æ€ == Gdeadï¼‰</span><br>    gFree <span class="hljs-keyword">struct</span> &#123;<br>        gList<br>        n <span class="hljs-type">int32</span><br>    &#125;<br><br>    <span class="hljs-comment">// sudog ç¼“å­˜</span><br>    sudogcache []*sudog<br>    sudogbuf   [<span class="hljs-number">128</span>]*sudog<br><br>    <span class="hljs-comment">// å †ä¸Š mspan å¯¹è±¡çš„ç¼“å­˜</span><br>    mspancache <span class="hljs-keyword">struct</span> &#123;<br>        <span class="hljs-built_in">len</span> <span class="hljs-type">int</span><br>        buf [<span class="hljs-number">128</span>]*mspan<br>    &#125;<br><br>    <span class="hljs-comment">// pinner å¯¹è±¡çš„ç¼“å­˜</span><br>    pinnerCache *pinner<br><br>  <span class="hljs-comment">// P çŠ¶æ€è·Ÿè¸ª</span><br>    trace pTraceState<br><br>    <span class="hljs-comment">// æ¯ä¸ª P çš„æŒä¹…åˆ†é…ï¼Œé¿å…äº’æ–¥</span><br>    palloc persistentAlloc <br><br>    <span class="hljs-comment">// å®šæ—¶å™¨ç›¸å…³å­—æ®µ</span><br>    timer0When             atomic.Int64<br>    timerModifiedEarliest  atomic.Int64<br>    timersLock             mutex<br>    timers                 []*timer<br>    numTimers              atomic.Uint32<br>    deletedTimers          atomic.Uint32<br>    timerRaceCtx           <span class="hljs-type">uintptr</span><br><br>    <span class="hljs-comment">// GC ç›¸å…³å­—æ®µ</span><br>    gcAssistTime         <span class="hljs-type">int64</span><br>    gcFractionalMarkTime <span class="hljs-type">int64</span><br>    gcw                  gcWork<br>    wbBuf                wbBuf<br><br>    <span class="hljs-comment">// æŒ‡ç¤ºæ˜¯å¦åœ¨ä¸‹ä¸€ä¸ªå®‰å…¨ç‚¹è¿è¡Œç‰¹å®šçš„å‡½æ•°</span><br>    runSafePointFn <span class="hljs-type">uint32</span><br>  <br>    <span class="hljs-comment">// æŒ‡ç¤ºå½“å‰ P æ˜¯å¦æ­£åœ¨å†™å…¥ä»»ä½•ç»Ÿè®¡æ•°æ®ã€‚</span><br>  <span class="hljs-comment">// å¶æ•°æ—¶è¡¨ç¤ºæ²¡æœ‰å†™å…¥ï¼Œå¥‡æ•°æ—¶è¡¨ç¤ºæ­£åœ¨å†™å…¥ã€‚</span><br>    statsSeq       atomic.Uint32<br>  <br>    <span class="hljs-comment">// æŒ‡ç¤ºå½“å‰çš„ P åº”è¯¥å°½å¿«è¿›å…¥è°ƒåº¦å™¨ï¼Œæ— è®ºå…¶ä¸Šè¿è¡Œçš„æ˜¯å“ªä¸ª Gã€‚</span><br><span class="hljs-comment">// è¿™æ˜¯å®ç°æŠ¢å å¼è°ƒåº¦çš„ä¸€éƒ¨åˆ†ï¼Œå…è®¸è°ƒåº¦å™¨åœ¨å¿…è¦æ—¶ä¸­æ–­é•¿æ—¶é—´è¿è¡Œçš„ goroutineï¼Œ</span><br>    <span class="hljs-comment">// ä»¥ä¾¿å…¶ä»– goroutine æœ‰æœºä¼šè¿è¡Œã€‚</span><br>    preempt        <span class="hljs-type">bool</span><br>  <br>    <span class="hljs-comment">// è®°å½•é¡µé¢åˆ†é…ã€é‡Šæ”¾å’Œæ¸…ç†è·Ÿè¸ªä¿¡æ¯çš„ç¼“å†²åŒºã€‚</span><br>    pageTraceBuf   pageTraceBuf<br>&#125;<br></code></pre></td></tr></table></figure><p><code>p</code> ç»“æ„ä½“åœ¨ Goè¯­è¨€çš„è¿è¡Œæ—¶ç³»ç»Ÿä¸­ä»£è¡¨äº†ä¸€ä¸ªå¤„ç†å™¨ï¼ˆprocessorï¼‰ï¼Œå®ƒæ˜¯è°ƒåº¦å™¨çš„æ ¸å¿ƒç»„æˆéƒ¨åˆ†ã€‚æ¯ä¸ª<code>p</code> è´Ÿè´£ç®¡ç†ä¸€ç»„ <code>goroutine</code>çš„è¿è¡Œã€‚è¿™ä¸ªç»“æ„ä½“åŒ…å«äº†è®¸å¤šå­—æ®µï¼Œæ¶‰åŠåˆ° <code>goroutine</code>çš„è°ƒåº¦ã€å†…å­˜åˆ†é…ã€åƒåœ¾å›æ”¶å’Œå…¶ä»–ç³»ç»Ÿçº§åˆ«çš„æ“ä½œã€‚</p><p>æˆ‘ä»¬é‡ç‚¹å…³æ³¨ä»¥ä¸‹å‡ ä¸ªå­—æ®µï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> p <span class="hljs-keyword">struct</span> &#123;<br>m           muintptr   <span class="hljs-comment">// å½“å‰è´Ÿè´£çš„çº¿ç¨‹</span><br>  <br><span class="hljs-comment">// æœ¬åœ°å¯è¿è¡Œçš„åç¨‹çš„é˜Ÿåˆ—ï¼Œå¯æ— é”è®¿é—®</span><br>runqhead <span class="hljs-type">uint32</span> <span class="hljs-comment">// é˜Ÿå¤´</span><br>runqtail <span class="hljs-type">uint32</span> <span class="hljs-comment">// é˜Ÿå°¾</span><br>runq     [<span class="hljs-number">256</span>]guintptr   <span class="hljs-comment">// é•¿åº¦ä¸º 256</span><br>runnext guintptr <span class="hljs-comment">// ä¸‹ä¸€ä¸ªå¯ç”¨çš„åç¨‹çš„æŒ‡é’ˆ</span><br>  <br>  <span class="hljs-comment">// æŠ¢å æ ‡è¯†ï¼ŒæŒ‡ç¤ºå½“å‰çš„ P åº”è¯¥å°½å¿«è¿›å…¥è°ƒåº¦å™¨ï¼Œæ— è®ºå…¶ä¸Šè¿è¡Œçš„æ˜¯å“ªä¸ª Gã€‚</span><br>  preempt <span class="hljs-type">bool</span><br>&#125;<br></code></pre></td></tr></table></figure><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/e6c9d24egy1h57sl36b40j20o40u8js7.jpg"alt="P åº•å±‚ç»“æ„" /><figcaption aria-hidden="true">P åº•å±‚ç»“æ„</figcaption></figure><h2 id="goroutine-çš„åˆ›å»º">3. Goroutine çš„åˆ›å»º</h2><p>Go å¹¶å‘èƒ½åŠ›çš„ä¼˜ç§€ä¹‹å¤„ï¼Œå°±åœ¨äºå®ƒå¯åŠ¨ä¸€ä¸ªæ–°çš„åç¨‹å®åœ¨æ˜¯å¤ªæ–¹ä¾¿äº†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; ... &#125;()<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆåº•å±‚ç©¶ç«Ÿåšäº†ä»€ä¹ˆå‘¢ï¼Ÿ</p><h3 id="newproc">3.1 newproc()</h3><p>Goroutine é€šè¿‡ <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/proc.go">proc.go</a>ä¸­çš„ <code>newproc()</code> åˆ›å»ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newproc</span><span class="hljs-params">(fn *funcval)</span></span> &#123;<br>    gp := getg()<br>    pc := getcallerpc()<br>    systemstack(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        newg := newproc1(fn, gp, pc)<br><br>        pp := getg().m.p.ptr()<br>        runqput(pp, newg, <span class="hljs-literal">true</span>)<br><br>        <span class="hljs-keyword">if</span> mainStarted &#123;<br>            wakep()<br>        &#125;<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure><ol type="1"><li><strong>è·å–å½“å‰ goroutine å’Œè°ƒç”¨è€… PC</strong>: <code>getg()</code>è·å–å½“å‰æ­£åœ¨æ‰§è¡Œçš„ <code>goroutine</code>ï¼Œ<code>getcallerpc()</code>è·å–è°ƒç”¨è€…çš„ç¨‹åºè®¡æ•°å™¨åœ°å€ã€‚</li><li><strong>åœ¨ç³»ç»Ÿæ ˆä¸Šæ‰§è¡Œ <code>newproc1</code></strong>:<code>systemstack</code> ç¡®ä¿ <code>newproc1</code>åœ¨ç³»ç»Ÿæ ˆä¸Šæ‰§è¡Œï¼Œè€Œä¸æ˜¯å½“å‰ <code>goroutine</code> çš„æ ˆã€‚è¿™æ˜¯å› ä¸ºæ–°çš„<code>goroutine</code> å¯èƒ½éœ€è¦æ›´å¤šçš„æ ˆç©ºé—´ã€‚</li><li><strong>åˆ›å»ºæ–°çš„ goroutine</strong>: <code>newproc1</code>è¢«è°ƒç”¨æ¥å®é™…åˆ›å»ºæ–°çš„ <code>goroutine</code>ã€‚</li><li><strong>å°†æ–°çš„ goroutine æ”¾å…¥è¿è¡Œé˜Ÿåˆ—</strong>: <code>runqput</code>å°†æ–°åˆ›å»ºçš„ <code>goroutine</code> æ”¾å…¥è¿è¡Œé˜Ÿåˆ—ã€‚</li><li><strong>å”¤é†’å¤„ç†å™¨</strong>:å¦‚æœä¸»å‡½æ•°å·²ç»å¼€å§‹æ‰§è¡Œï¼Œ<code>wakep</code> ç”¨äºå”¤é†’ä¸€ä¸ªç©ºé—²çš„ Pæ¥è¿è¡Œæ–°çš„ <code>goroutine</code>ã€‚</li></ol><h3 id="newproc1">3.2 newproc1()</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newproc1</span><span class="hljs-params">(fn *funcval, callergp *g, callerpc <span class="hljs-type">uintptr</span>)</span></span> *g &#123;<br>    <span class="hljs-comment">// ... (çœç•¥äº†é”™è¯¯æ£€æŸ¥å’Œè·å– M çš„ä»£ç )</span><br><br>  <span class="hljs-comment">// å°è¯•ä» P çš„ç©ºé—²åˆ—è¡¨è·å–ä¸€ä¸ª Gï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„</span><br>    newg := gfget(pp)<br>    <span class="hljs-keyword">if</span> newg == <span class="hljs-literal">nil</span> &#123;<br>        newg = malg(stackMin)<br>        casgstatus(newg, _Gidle, _Gdead)<br>        allgadd(newg)<br>    &#125;<br><br>    <span class="hljs-comment">// è®¾ç½®æ–° G çš„æ ˆ</span><br>    totalSize := <span class="hljs-type">uintptr</span>(<span class="hljs-number">4</span>*goarch.PtrSize + sys.MinFrameSize)<br>    totalSize = alignUp(totalSize, sys.StackAlign)<br>    sp := newg.stack.hi - totalSize<br>  spArg := sp<br>  <br>    <span class="hljs-comment">// æ¸…ç©ºå¹¶è®¾ç½®æ–° G çš„è°ƒåº¦å™¨ç›¸å…³å­—æ®µ</span><br>    memclrNoHeapPointers(unsafe.Pointer(&amp;newg.sched), unsafe.Sizeof(newg.sched))<br>    newg.sched.sp = sp<br>    newg.stktopsp = sp<br>    newg.sched.pc = abi.FuncPCABI0(goexit) + sys.PCQuantum<br>    newg.sched.g = guintptr(unsafe.Pointer(newg))<br>  <br>    <span class="hljs-comment">// è®¾ç½®æ–° G çš„å…¶ä»–å­—æ®µ</span><br>    gostartcallfn(&amp;newg.sched, fn)<br>    newg.parentGoid = callergp.goid<br>    newg.gopc = callerpc<br>    newg.startpc = fn.fn<br>    <br>  <span class="hljs-comment">// ... (çœç•¥äº†è·Ÿè¸ªå’Œè°ƒè¯•ç›¸å…³çš„ä»£ç )</span><br><br>    casgstatus(newg, _Gdead, _Grunnable)<br><br>    <span class="hljs-keyword">return</span> newg<br>&#125;<br></code></pre></td></tr></table></figure><ol type="1"><li><strong>åˆ›å»ºæˆ–è·å–ä¸€ä¸ªæ–°çš„ goroutine</strong>: <code>gfget</code>å°è¯•ä» P çš„ç©ºé—²åˆ—è¡¨ä¸­è·å–ä¸€ä¸ª<code>goroutine</code>ï¼Œå¦‚æœæ²¡æœ‰å¯ç”¨çš„ï¼Œåˆ™é€šè¿‡ <code>malg</code>åˆ†é…ä¸€ä¸ªæ–°çš„ã€‚</li><li><strong>åˆå§‹åŒ– goroutine çš„æ ˆå’Œè°ƒåº¦å™¨</strong>: è®¾ç½®æ–°<code>goroutine</code>çš„æ ˆã€ç¨‹åºè®¡æ•°å™¨ã€è°ƒç”¨å‡½æ•°ç­‰ã€‚è¿™é‡Œæœ‰ä¸ªéå¸¸æ ¸å¿ƒçš„ç‚¹<code>newg.sched.pc = abi.FuncPCABI0(goexit) + sys.PCQuantum</code>ï¼Œæˆ‘ä»¬å‰é¢ç•™äº†ä¸ªç–‘é—®ï¼Œåç¨‹æ ˆé¡¶çš„<code>goexit</code> æ˜¯å“ªé‡Œæ¥çš„ï¼Œå°±æ˜¯è¿™é‡Œæ¥çš„ã€‚è¿™é‡Œè®¾ç½®æ–°<code>goroutine</code> çš„ç¨‹åºè®¡æ•°å™¨ï¼ˆ<code>pc</code>ï¼‰æŒ‡å‘<code>goexit</code> å‡½æ•°ã€‚<code>goexit</code> æ˜¯æ¯ä¸ª<code>goroutine</code> åœ¨é€€å‡ºæ—¶å¿…é¡»è°ƒç”¨çš„å‡½æ•°ï¼Œç”¨äºæ‰§è¡Œæ¸…ç†å·¥ä½œå¹¶åˆ‡æ¢åˆ°g0 æ ˆã€‚</li><li><strong>è®¾ç½®çˆ¶ goroutine ID å’Œåˆ›å»ºç‚¹</strong>: è®°å½•åˆ›å»ºè¿™ä¸ªæ–°<code>goroutine</code> çš„çˆ¶ <code>goroutine</code> çš„ ID å’Œ<code>go</code> è¯­å¥çš„ä½ç½®ã€‚</li><li><strong>æ›´æ”¹ goroutine çŠ¶æ€</strong>: å°†æ–° <code>goroutine</code>çš„çŠ¶æ€ä» <code>_Gdead</code> æ”¹ä¸º<code>_Grunnable</code>ï¼Œä½¿å…¶å‡†å¤‡å¥½è¢«è°ƒåº¦ã€‚</li><li><strong>è¿”å›æ–°çš„ goroutine</strong>: å‡½æ•°è¿”å›æ–°åˆ›å»ºçš„<code>goroutine</code>ã€‚</li></ol><h3 id="runqput">3.3 runqput()</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// runqput tries to put g on the local runnable queue.</span><br><span class="hljs-comment">// If next is false, runqput adds g to the tail of the runnable queue.</span><br><span class="hljs-comment">// If next is true, runqput puts g in the pp.runnext slot.</span><br><span class="hljs-comment">// If the run queue is full, runnext puts g on the global queue.</span><br><span class="hljs-comment">// Executed only by the owner P.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">runqput</span><span class="hljs-params">(pp *p, gp *g, next <span class="hljs-type">bool</span>)</span></span> &#123;<br><span class="hljs-keyword">if</span> randomizeScheduler &amp;&amp; next &amp;&amp; fastrandn(<span class="hljs-number">2</span>) == <span class="hljs-number">0</span> &#123;<br>next = <span class="hljs-literal">false</span><br>&#125;<br><br><span class="hljs-keyword">if</span> next &#123;<br>retryNext:<br>oldnext := pp.runnext<br><span class="hljs-keyword">if</span> !pp.runnext.cas(oldnext, guintptr(unsafe.Pointer(gp))) &#123;<br><span class="hljs-keyword">goto</span> retryNext<br>&#125;<br><span class="hljs-keyword">if</span> oldnext == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br>gp = oldnext.ptr()<br>&#125;<br><br>retry:<br>h := atomic.LoadAcq(&amp;pp.runqhead) <br>t := pp.runqtail<br><span class="hljs-keyword">if</span> t-h &lt; <span class="hljs-type">uint32</span>(<span class="hljs-built_in">len</span>(pp.runq)) &#123;<br>pp.runq[t%<span class="hljs-type">uint32</span>(<span class="hljs-built_in">len</span>(pp.runq))].set(gp)<br>atomic.StoreRel(&amp;pp.runqtail, t+<span class="hljs-number">1</span>) <br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">if</span> runqputslow(pp, gp, h, t) &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">goto</span> retry<br>&#125;<br></code></pre></td></tr></table></figure><ol type="1"><li><strong>éšæœºè°ƒåº¦å™¨</strong>ï¼šå¦‚æœå¯ç”¨äº†è°ƒåº¦å™¨çš„éšæœºåŒ–ï¼ˆ<code>randomizeScheduler</code>ï¼‰ï¼Œå¹¶ä¸”<code>next</code> ä¸º <code>true</code>ï¼ˆnewproc è°ƒç”¨çš„æ—¶å€™æ°¸è¿œéƒ½æ˜¯ä¼ çš„trueï¼‰ï¼Œåˆ™æœ‰ä¸€åŠçš„æ¦‚ç‡å°† <code>next</code> è®¾ç½®ä¸º<code>false</code>ã€‚è¿™æœ‰åŠ©äºé˜²æ­¢è°ƒåº¦å™¨çš„è¡Œä¸ºè¿‡äºå¯é¢„æµ‹ã€‚</li><li><strong>å¤„ç† <code>runnext</code> æ§½</strong>ï¼šå¦‚æœ<code>next</code> ä¸º <code>true</code>ï¼Œå‡½æ•°å°è¯•å°† <code>gp</code> æ”¾å…¥<code>pp.runnext</code> æ§½ã€‚å¦‚æœè¯¥æ§½å·²è¢«å ç”¨ï¼Œåˆ™å°†åŸæœ‰çš„<code>goroutine</code> ç§»åŠ¨åˆ°å¸¸è§„è¿è¡Œé˜Ÿåˆ—ï¼Œå¹¶é‡è¯•å°†æ–°çš„ <code>gp</code>æ”¾å…¥ <code>runnext</code>ã€‚</li><li><strong>æ”¾å…¥æœ¬åœ°è¿è¡Œé˜Ÿåˆ—</strong>ï¼šå¦‚æœ <code>next</code> ä¸º<code>false</code> æˆ– <code>runnext</code> æ§½å·²æ»¡ï¼Œå‡½æ•°å°è¯•å°†<code>gp</code> æ”¾å…¥æœ¬åœ°è¿è¡Œé˜Ÿåˆ—çš„å°¾éƒ¨ã€‚å¦‚æœé˜Ÿåˆ—æœªæ»¡ï¼Œ<code>gp</code>å°†è¢«æˆåŠŸæ·»åŠ ã€‚</li><li><strong>å¤„ç†é˜Ÿåˆ—æ»¡çš„æƒ…å†µ</strong>ï¼šå¦‚æœæœ¬åœ°è¿è¡Œé˜Ÿåˆ—å·²æ»¡ï¼Œ<code>runqputslow</code>è¢«è°ƒç”¨ï¼Œå°è¯•å°† <code>gp</code> è¿åŒè‡ªå·±é˜Ÿåˆ—ä¸­ä¸€åŠçš„ gæ”¾å…¥å…¨å±€è¿è¡Œé˜Ÿåˆ—ã€‚å¦‚æœè¿™ä¹Ÿå¤±è´¥äº†ï¼Œå‡½æ•°ä¼šé‡è¯•å°† <code>gp</code>æ”¾å…¥æœ¬åœ°é˜Ÿåˆ—ã€‚</li><li><strong>åŸå­æ“ä½œ</strong>ï¼šå‡½æ•°ä½¿ç”¨åŸå­æ“ä½œæ¥åŠ è½½å’Œå­˜å‚¨é˜Ÿåˆ—å¤´ï¼ˆ<code>runqhead</code>ï¼‰å’Œå°¾ï¼ˆ<code>runqtail</code>ï¼‰æŒ‡é’ˆï¼Œä»¥ç¡®ä¿å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„æ•°æ®ä¸€è‡´æ€§å’Œçº¿ç¨‹å®‰å…¨ã€‚</li></ol><h3 id="runqputslow">3.4 runqputslow()</h3><p><code>runqputslow</code> å‡½æ•°å¤„ç†æœ¬åœ°è¿è¡Œé˜Ÿåˆ—æ»¡çš„æƒ…å†µï¼Œå°†<code>goroutine</code>æ‰¹é‡è½¬ç§»åˆ°å…¨å±€é˜Ÿåˆ—ã€‚è¿™ä¸ªå‡½æ•°é€šè¿‡åŸå­æ“ä½œå’Œé”æ¥ç¡®ä¿æ“ä½œçš„åŸå­æ€§å’Œçº¿ç¨‹å®‰å…¨ã€‚éšæœºåŒ–è°ƒåº¦å™¨çš„ä½¿ç”¨å¢åŠ äº†è°ƒåº¦çš„éšæœºæ€§å’Œå…¬å¹³æ€§ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Put g and a batch of work from local runnable queue on global queue.</span><br><span class="hljs-comment">// Executed only by the owner P.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">runqputslow</span><span class="hljs-params">(pp *p, gp *g, h, t <span class="hljs-type">uint32</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br><br>  <span class="hljs-comment">// ä» pp çš„æœ¬åœ°é˜Ÿåˆ—ä¸­è·å–ä¸€åŠçš„ goroutine</span><br>  <span class="hljs-keyword">var</span> batch [<span class="hljs-built_in">len</span>(pp.runq)/<span class="hljs-number">2</span> + <span class="hljs-number">1</span>]*g<br>n := t - h<br>n = n / <span class="hljs-number">2</span><br><span class="hljs-keyword">if</span> n != <span class="hljs-type">uint32</span>(<span class="hljs-built_in">len</span>(pp.runq)/<span class="hljs-number">2</span>) &#123;<br>throw(<span class="hljs-string">&quot;runqputslow: queue is not full&quot;</span>)<br>&#125;<br><span class="hljs-keyword">for</span> i := <span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>); i &lt; n; i++ &#123;<br>batch[i] = pp.runq[(h+i)%<span class="hljs-type">uint32</span>(<span class="hljs-built_in">len</span>(pp.runq))].ptr()<br>&#125;<br><span class="hljs-keyword">if</span> !atomic.CasRel(&amp;pp.runqhead, h, h+n) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br>batch[n] = gp<br><br>  <span class="hljs-comment">// éšæœºæ‰“ä¹± goroutine çš„é¡ºåºï¼Œä»¥å¢åŠ è°ƒåº¦çš„éšæœºæ€§</span><br><span class="hljs-keyword">if</span> randomizeScheduler &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-type">uint32</span>(<span class="hljs-number">1</span>); i &lt;= n; i++ &#123;<br>j := fastrandn(i + <span class="hljs-number">1</span>)<br>batch[i], batch[j] = batch[j], batch[i]<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// ä¸²æˆé˜Ÿåˆ—</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>); i &lt; n; i++ &#123;<br>batch[i].schedlink.set(batch[i+<span class="hljs-number">1</span>])<br>&#125;<br><span class="hljs-keyword">var</span> q gQueue<br>q.head.set(batch[<span class="hljs-number">0</span>])<br>q.tail.set(batch[n])<br><br><span class="hljs-comment">// æ”¾å…¥å…¨å±€é˜Ÿåˆ—ä¸­</span><br>lock(&amp;sched.lock)<br>globrunqputbatch(&amp;q, <span class="hljs-type">int32</span>(n+<span class="hljs-number">1</span>))<br>unlock(&amp;sched.lock)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure><ol type="1"><li><strong>åˆ›å»ºæ‰¹å¤„ç†æ•°ç»„</strong>ï¼šå‡½æ•°é¦–å…ˆåˆ›å»ºä¸€ä¸ª <code>batch</code>æ•°ç»„ï¼Œç”¨äºå­˜å‚¨ä»æœ¬åœ°é˜Ÿåˆ—ä¸­å–å‡ºçš„ <code>goroutine</code>ã€‚</li><li><strong>ä»æœ¬åœ°é˜Ÿåˆ—ä¸­è·å–ä¸€æ‰¹<code>goroutine</code></strong>ï¼šå‡½æ•°è®¡ç®—å‡ºè¦ä»æœ¬åœ°é˜Ÿåˆ—ä¸­å–å‡ºå¤šå°‘ä¸ª<code>goroutine</code>ï¼ˆé€šå¸¸æ˜¯é˜Ÿåˆ—é•¿åº¦çš„ä¸€åŠï¼‰ï¼Œå¹¶å°†å®ƒä»¬æ·»åŠ åˆ°<code>batch</code> æ•°ç»„ä¸­ã€‚</li><li><strong>åŸå­æ“ä½œæ›´æ–°é˜Ÿåˆ—å¤´éƒ¨</strong>ï¼šä½¿ç”¨åŸå­æ“ä½œ<code>atomic.CasRel</code>æ›´æ–°æœ¬åœ°è¿è¡Œé˜Ÿåˆ—çš„å¤´éƒ¨ç´¢å¼•ï¼Œè¿™æ˜¯ä¸€ä¸ªé‡Šæ”¾ï¼ˆreleaseï¼‰æ“ä½œï¼Œç¡®ä¿ä¹‹å‰çš„è¯»å–æ“ä½œå®Œæˆã€‚</li><li><strong>å°†å½“å‰ <code>goroutine</code>æ·»åŠ åˆ°æ‰¹å¤„ç†ä¸­</strong>ï¼šå°†ä¼ å…¥çš„ <code>gp</code> æ·»åŠ åˆ°<code>batch</code> æ•°ç»„çš„æœ«å°¾ã€‚</li><li><strong>éšæœºåŒ–è°ƒåº¦å™¨</strong>ï¼šå¦‚æœå¯ç”¨äº†éšæœºè°ƒåº¦å™¨ï¼Œå‡½æ•°ä¼šéšæœºæ‰“ä¹±<code>batch</code> æ•°ç»„ä¸­çš„ <code>goroutine</code>é¡ºåºï¼Œä»¥å¢åŠ è°ƒåº¦çš„éšæœºæ€§ã€‚</li><li><strong>é“¾æ¥ <code>goroutine</code></strong>ï¼šå°† <code>batch</code>æ•°ç»„ä¸­çš„ <code>goroutine</code> é“¾æ¥èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªé˜Ÿåˆ—ã€‚</li><li><strong>å‡†å¤‡å…¨å±€é˜Ÿåˆ—</strong>ï¼šåˆ›å»ºä¸€ä¸ª <code>gQueue</code>ç»“æ„ï¼Œå¹¶è®¾ç½®å…¶å¤´éƒ¨å’Œå°¾éƒ¨æŒ‡å‘ <code>batch</code> æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ª<code>goroutine</code>ã€‚</li><li><strong>å°†æ‰¹å¤„ç†æ”¾å…¥å…¨å±€é˜Ÿåˆ—</strong>ï¼šåŠ é”è®¿é—®å…¨å±€è°ƒåº¦å™¨çš„é”ï¼Œç„¶åå°†æ•´ä¸ª<code>batch</code> é˜Ÿåˆ—æ”¾å…¥å…¨å±€è¿è¡Œé˜Ÿåˆ—ã€‚</li></ol><h2 id="è°ƒåº¦è¿‡ç¨‹-schedule">4. è°ƒåº¦è¿‡ç¨‹ schedule()</h2><p>Go çš„è°ƒåº¦å™¨æ ¸å¿ƒæ‰§è¡Œé€»è¾‘éƒ½åœ¨ <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/proc.go">proc.go</a>çš„ <code>schedule()</code>å‡½æ•°ä¸­ã€‚æˆ‘ä»¬å…ˆä¸æ¢è®¨è¿‡å¤šçš„ç»†èŠ‚ï¼Œæˆ‘ä»¬å…ˆæŠŠæ•´ä¸ªå¤§ä½“è„‰ç»œç†æ¸…æ¥šå†è¯´ã€‚</p><p>ç®€åŒ–åçš„ <code>schedule()</code> å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">schedule</span><span class="hljs-params">()</span></span> &#123;<br>  <span class="hljs-comment">// è·å–å½“å‰æ­£åœ¨æ‰§è¡Œçš„ M</span><br>mp := getg().m<br>  ...<br>  <span class="hljs-comment">// æŸ¥æ‰¾ä¸€ä¸ªå¯è¿è¡Œçš„ Gï¼Œä¼šé˜»å¡ä½ç›´åˆ°è¿”å›ã€‚</span><br>gp, inheritTime, tryWakeP := findRunnable() <br>  ...<br><span class="hljs-comment">// æ‰§è¡Œ g</span><br>execute(gp, inheritTime)<br>&#125;<br></code></pre></td></tr></table></figure><p><code>execute()</code> æ‰§è¡Œ gï¼Œå®ƒç®€åŒ–åå¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">execute</span><span class="hljs-params">(gp *g, inheritTime <span class="hljs-type">bool</span>)</span></span> &#123;<br>mp := getg().m<br>..<br>gogo(&amp;gp.sched)<br>&#125;<br></code></pre></td></tr></table></figure><p>å®ƒè°ƒç”¨äº† <code>gogo()</code>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">gogo</span><span class="hljs-params">(buf *gobuf)</span></span><br></code></pre></td></tr></table></figure><p>ä¸€èˆ¬è¿™ç§æ ¼å¼è¯´æ˜å‡½æ•°æ˜¯ç”¨æ±‡ç¼–å®ç°çš„ï¼Œæˆ‘ä»¬åœ¨ Goland ä¸Šå¯ä»¥åŒå‡» shiftç„¶åæœç´¢ <code>runtimeÂ·gogo</code>ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240128130637007.png"alt="runtimeÂ·gogo" /><figcaption aria-hidden="true">runtimeÂ·gogo</figcaption></figure><p>ä¸åŒçš„å¹³å°æœ‰ä¸åŒçš„å®ç°ï¼Œä½†æ˜¯æ ¸å¿ƒé€»è¾‘éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå®ƒç›´æ¥æ“ä½œå¤„ç†å™¨çš„å¯„å­˜å™¨å’Œæ ˆï¼Œä»¥å®ç°ä»ä¸€ä¸ª <code>goroutine</code>åˆ‡æ¢åˆ°å¦ä¸€ä¸ª <code>goroutine</code> çš„åŠŸèƒ½ã€‚</p><p>æˆ‘ä»¬åé¢çš„å‘å†…å¿ƒä¼šå‘ç° <code>goexit()</code> æœ€ç»ˆä¼šè°ƒç”¨<code>schedule()</code>ã€‚</p><p>è¿™å°±ä¸²èµ·æ¥äº†ï¼ŒGo ç¨‹åºå¯åŠ¨åä¼šåˆ›å»º m0 å’Œg0ï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ª<code>schedule()</code> æ˜¯ g0 è°ƒç”¨çš„ï¼Œæœ€åé€šè¿‡<code>gogo</code> åˆ‡æ¢åˆ°ç”¨æˆ·åç¨‹ g ä¸Šé¢æ‰§è¡Œä¸šåŠ¡æ–¹æ³•ï¼Œå®Œäº‹å g é€šè¿‡<code>goexit</code> å›åˆ° <code>schedule()</code>ï¼Œä»¥æ­¤å¾ªç¯åå¤ä¸‹å»ã€‚</p><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥æ¥æ€»ç»“ä¸€ä¸‹ GPM è°ƒåº¦å¾ªç¯çš„è¿‡ç¨‹ï¼Œå¤§æ¦‚å¦‚ä¸‹å›¾è¡¨ç¤ºï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/e6c9d24egy1h57qxoptk4j21hm0simyy.jpg"alt="GPM è°ƒåº¦å¾ªç¯å›¾" /><figcaption aria-hidden="true">GPM è°ƒåº¦å¾ªç¯å›¾</figcaption></figure><p>ä¸‹é¢æˆ‘ä»¬å†å¯¹è¿™ä¸ªè¿‡ç¨‹ä¸­çš„å…³é”®å‡½æ•°è¿›è¡Œç»†è‡´åˆ†æï¼š</p><ul><li><code>schedule()</code>ï¼šè°ƒåº¦å…¥å£ã€‚</li><li><code>findRunnable()</code>ï¼šå¯»æ‰¾å¯æ‰§è¡Œçš„ Gã€‚</li><li><code>execute()</code>ï¼šæ‰§è¡Œ Gã€‚</li><li><code>gogo()</code>ï¼šåˆ‡æ¢åç¨‹æ ˆ g0 åˆ° gã€‚</li><li><code>goexit()</code>ï¼šé€€å‡º g åç¨‹ï¼Œåˆ‡æ¢å› g0 æ ˆã€‚</li></ul><h3 id="schedule">4.1 schedule()</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">schedule</span><span class="hljs-params">()</span></span> &#123;<br>  <span class="hljs-comment">// è·å–å½“å‰æ­£åœ¨æ‰§è¡Œçš„ M</span><br>mp := getg().m<br><br>  <span class="hljs-comment">// æœ‰é”çš„è¯æŠ›å‡ºå¼‚å¸¸ï¼Œé¿å…è¯¥æƒ…å†µä¸‹è°ƒåº¦å‡ºç°æ­»é”æˆ–å…¶ä»–é—®é¢˜</span><br><span class="hljs-keyword">if</span> mp.locks != <span class="hljs-number">0</span> &#123;<br>throw(<span class="hljs-string">&quot;schedule: holding locks&quot;</span>)<br>&#125;<br><br>  <span class="hljs-comment">// M è¢«é”å®šäº†ç‰¹å®šçš„ Gï¼Œè¿™ä¸ªæ—¶å€™ç›´æ¥æ‰§è¡Œè¿™ä¸ªé”å®šçš„ Gã€‚</span><br><span class="hljs-keyword">if</span> mp.lockedg != <span class="hljs-number">0</span> &#123;<br>stoplockedm()<br>execute(mp.lockedg.ptr(), <span class="hljs-literal">false</span>) <span class="hljs-comment">// Never returns.</span><br>&#125;<br><br><span class="hljs-comment">// CGO è°ƒç”¨éœ€è¦ g0 æ ˆï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™ä¸ç»§ç»­è°ƒåº¦äº†ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚</span><br><span class="hljs-keyword">if</span> mp.incgo &#123;<br>throw(<span class="hljs-string">&quot;schedule: in cgo&quot;</span>)<br>&#125;<br><br>top:<br>pp := mp.p.ptr()<br>pp.preempt = <span class="hljs-literal">false</span><br><br><span class="hljs-comment">// å®‰å…¨ç‚¹æ£€æŸ¥ï¼šå¦‚æœå½“å‰ M åœ¨è‡ªæ—‹çš„è¯ï¼Œåº”è¯¥æ˜¯æ²¡æœ‰å¯æ‰§è¡Œ G çš„ã€‚</span><br><span class="hljs-keyword">if</span> mp.spinning &amp;&amp; (pp.runnext != <span class="hljs-number">0</span> || pp.runqhead != pp.runqtail) &#123;<br>throw(<span class="hljs-string">&quot;schedule: spinning with local work&quot;</span>)<br>&#125;<br><br>  <span class="hljs-comment">// æŸ¥æ‰¾ä¸€ä¸ªå¯è¿è¡Œçš„ Gï¼Œä¼šé˜»å¡ä½ç›´åˆ°è¿”å›ã€‚</span><br>gp, inheritTime, tryWakeP := findRunnable() <br><br>  <span class="hljs-comment">// è°ƒè¯•çš„æ—¶å€™ç³»ç»Ÿä¼šå¤„äºâ€œå†»ç»“â€çŠ¶æ€ï¼Œ</span><br>  <span class="hljs-comment">// è¿™é‡Œæ•…æ„é€šè¿‡ä¸¤æ¬¡ lock å¼•å…¥æ­»é”ä½¿å½“å‰ M é™·å…¥æ— é™ç­‰å¾…ï¼Œ</span><br>  <span class="hljs-comment">// ä»¥åœ¨è°ƒè¯•æ—¶ä¿æŒå½“å‰çš„è°ƒåº¦å™¨å’Œè¿è¡Œæ—¶çŠ¶æ€ä¸å˜ã€‚</span><br><span class="hljs-keyword">if</span> debug.dontfreezetheworld &gt; <span class="hljs-number">0</span> &amp;&amp; freezing.Load() &#123;<br>lock(&amp;deadlock)<br>lock(&amp;deadlock)<br>&#125;<br><br>  <span class="hljs-comment">// å¦‚æœå½“å‰ M ä¹‹å‰æ˜¯è‡ªæ—‹çš„ï¼Œä½†æ˜¯ç°åœ¨è¦å‡†å¤‡æ‰§è¡Œ G äº†ï¼Œé‚£å°±ä¸æ˜¯è‡ªæ—‹äº†ã€‚</span><br><span class="hljs-keyword">if</span> mp.spinning &#123;<br>resetspinning()<br>&#125;<br><br>  <span class="hljs-comment">// å½“ç”¨æˆ·çº§è°ƒåº¦è¢«ç¦ç”¨æ—¶ï¼Œé‡‡ç”¨åŒé‡æ£€æŸ¥åå¦‚æœç¡®å®è¢«ç¦ç”¨äº†ï¼Œ</span><br>  <span class="hljs-comment">// é‚£ä¹ˆå°±æŠŠå½“å‰ g æ”¾åœ¨ sched.disable.runnable åˆ—è¡¨ä¸­ï¼Œ</span><br>  <span class="hljs-comment">// ç­‰å¾…è°ƒåº¦é‡å¯å¯ç”¨æ—¶å†å¤„ç†ã€‚</span><br>  <span class="hljs-comment">// åœ¨ gc çš„æ—¶å€™ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼š</span><br>  <span class="hljs-comment">// gcStart()    -&gt;  schedEnableUser(false)</span><br>  <span class="hljs-comment">// gcMarkDone() -&gt;  schedEnableUser(true)</span><br><span class="hljs-keyword">if</span> sched.disable.user &amp;&amp; !schedEnabled(gp) &#123;<br>lock(&amp;sched.lock)<br><span class="hljs-keyword">if</span> schedEnabled(gp) &#123;<br>unlock(&amp;sched.lock)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>sched.disable.runnable.pushBack(gp)<br>sched.disable.n++<br>unlock(&amp;sched.lock)<br><span class="hljs-keyword">goto</span> top<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦éœ€è¦å”¤é†’ä¸€ä¸ª Pã€‚</span><br>  <span class="hljs-comment">// å¦‚æœè¿”å›çš„ g æ¯”è¾ƒç‰¹æ®Šï¼Œæ¯”å¦‚è¦è´Ÿè´£ gcï¼Œé‚£ä¹ˆè¿™ä¸ªå€¼ä¼šæ˜¯ trueã€‚</span><br><span class="hljs-keyword">if</span> tryWakeP &#123;<br>wakep()<br>&#125;<br>  <br>  <span class="hljs-comment">// å¦‚æœ g å·²ç»ç»‘å®šäº† Mï¼Œåˆ™ç›´æ¥å¯åŠ¨è¯¥ M å»æ‰§è¡Œ gã€‚</span><br><span class="hljs-keyword">if</span> gp.lockedm != <span class="hljs-number">0</span> &#123;<br>startlockedm(gp)<br><span class="hljs-keyword">goto</span> top<br>&#125;<br><br>  <span class="hljs-comment">// æ‰§è¡Œ g</span><br>execute(gp, inheritTime)<br>&#125;<br></code></pre></td></tr></table></figure><p><code>schedule()</code> å‡½æ•°æ˜¯ Go è°ƒåº¦å™¨çš„æ ¸å¿ƒï¼Œè´Ÿè´£ç®¡ç†<code>goroutine</code> çš„æ‰§è¡Œã€‚å®ƒåŒ…æ‹¬å¤šä¸ªæ­¥éª¤ï¼Œå¦‚æ£€æŸ¥å½“å‰ Mçš„çŠ¶æ€ï¼Œå¤„ç†ç‰¹æ®Šæƒ…å†µï¼ˆå¦‚ <code>goroutine</code> è¢«é”å®šåˆ°ç‰¹å®šçš„ Mï¼Œæˆ–è€… Mæ­£åœ¨æ‰§è¡Œ CGO è°ƒç”¨ï¼‰ï¼Œä»¥åŠé€‰æ‹©å’Œæ‰§è¡Œå¯è¿è¡Œçš„ <code>goroutine</code>ã€‚</p><h3 id="findrunnable">4.2 findRunnable()</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Finds a runnable goroutine to execute.</span><br><span class="hljs-comment">// Tries to steal from other P&#x27;s, get g from local or global queue, poll network.</span><br><span class="hljs-comment">// tryWakeP indicates that the returned goroutine is not normal (GC worker, trace reader) so the caller should try to wake a P.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">findRunnable</span><span class="hljs-params">()</span></span> (gp *g, inheritTime, tryWakeP <span class="hljs-type">bool</span>) &#123;<br></code></pre></td></tr></table></figure><p>é€šè¿‡æ³¨é‡Šå°±å¯ä»¥çŸ¥é“è¿™ä¸ªå‡½æ•°çš„ä½œç”¨ï¼šå¯»æ‰¾ä¸€ä¸ªå¯æ‰§è¡Œçš„ goroutineï¼š</p><ol type="1"><li>å°è¯•ä»å…¶ä»– P çªƒå– gã€ä»æœ¬åœ°è·å– gã€ä»å…¨å±€é˜Ÿåˆ—è·å–gã€ä»ç½‘ç»œè½®è¯¢å™¨è·å– gï¼›</li><li>å¦‚æœæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ gï¼Œå¦‚è¦è´Ÿè´£ gc æˆ– traceï¼Œé‚£ä¹ˆä¼šå°†<code>tryWakeP</code> ç½®ä¸º<code>true</code>ï¼Œè¡¨ç¤ºè°ƒåº¦å™¨éœ€è¦å°è¯•å”¤é†’æˆ–å¯åŠ¨ä¸€ä¸ªæ–°çš„ P æ¥è¿è¡Œè¿™ä¸ªgï¼Œä»¥ç¡®ä¿äº†å³ä½¿åœ¨ç³»ç»Ÿè´Ÿè½½è¾ƒä½æ—¶ï¼Œè¿™äº›ç‰¹æ®Šçš„g ä¹Ÿèƒ½å¾—åˆ°åŠæ—¶å¤„ç†ã€‚</li></ol><p>æˆ‘ä»¬åªå…³å¿ƒå®ƒçš„æ ¸å¿ƒéƒ¨åˆ†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">findRunnable</span><span class="hljs-params">()</span></span> (gp *g, inheritTime, tryWakeP <span class="hljs-type">bool</span>) &#123;<br>  <span class="hljs-comment">// è·å–å½“å‰ M</span><br>mp := getg().m<br>top:<br>  <br>  <span class="hljs-comment">// è·å– M ç»‘å®šçš„ P</span><br>pp := mp.p.ptr()<br><br><span class="hljs-comment">// 1. æ¯ 61 æ¬¡å¾ªç¯è°ƒåº¦ï¼Œå°±ä¼šå»å…¨å±€é˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ª g æ¥æ‰§è¡Œ</span><br><span class="hljs-keyword">if</span> pp.schedtick%<span class="hljs-number">61</span> == <span class="hljs-number">0</span> &amp;&amp; sched.runqsize &gt; <span class="hljs-number">0</span> &#123;<br>lock(&amp;sched.lock)<br>gp := globrunqget(pp, <span class="hljs-number">1</span>)<br>unlock(&amp;sched.lock)<br><span class="hljs-keyword">if</span> gp != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> gp, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span><br>&#125;<br>&#125;<br><br><br><span class="hljs-comment">// 2. ä»æœ¬åœ°é˜Ÿåˆ—ä¸­è·å– g</span><br><span class="hljs-keyword">if</span> gp, inheritTime := runqget(pp); gp != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> gp, inheritTime, <span class="hljs-literal">false</span><br>&#125;<br><br><span class="hljs-comment">// 3. ä»å…¨å±€é˜Ÿåˆ—ä¸­è·å– g</span><br><span class="hljs-keyword">if</span> sched.runqsize != <span class="hljs-number">0</span> &#123;<br>lock(&amp;sched.lock)<br>gp := globrunqget(pp, <span class="hljs-number">0</span>)<br>unlock(&amp;sched.lock)<br><span class="hljs-keyword">if</span> gp != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> gp, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span><br>&#125;<br>&#125;<br><br><span class="hljs-comment">// 4. ä»ç½‘ç»œè½®è¯¢å™¨ä¸­è·å– g</span><br><span class="hljs-keyword">if</span> netpollinited() &amp;&amp; netpollWaiters.Load() &gt; <span class="hljs-number">0</span> &amp;&amp; sched.lastpoll.Load() != <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">if</span> list := netpoll(<span class="hljs-number">0</span>); !list.empty() &#123; <span class="hljs-comment">// non-blocking</span><br>gp := list.pop()<br>injectglist(&amp;list)<br>casgstatus(gp, _Gwaiting, _Grunnable)<br><span class="hljs-keyword">if</span> traceEnabled() &#123;<br>traceGoUnpark(gp, <span class="hljs-number">0</span>)<br>&#125;<br><span class="hljs-keyword">return</span> gp, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span><br>&#125;<br>&#125;<br><br><span class="hljs-comment">// 5. è‡ªæ—‹ï¼Œä»å…¶ä»– P çªƒå– g</span><br>  <span class="hljs-comment">// mp.spinning è¿™ä¸ªæ¡ä»¶æ£€æŸ¥å½“å‰ Mï¼ˆæ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼‰æ˜¯å¦åº”è¯¥è¿›å…¥è‡ªæ—‹çŠ¶æ€ã€‚</span><br>  <span class="hljs-comment">// è‡ªæ—‹çŠ¶æ€æ„å‘³ç€ M ä¼šç§¯æåœ°å¯»æ‰¾å·¥ä½œï¼Œè€Œä¸æ˜¯ä¼‘çœ ã€‚</span><br>  <span class="hljs-comment">// 2*sched.nmspinning.Load() &lt; gomaxprocs-sched.npidle.Load()</span><br>  <span class="hljs-comment">// è¿™ä¸ªæ¡ä»¶ç¡®ä¿ç³»ç»Ÿä¸­è‡ªæ—‹çš„ M çš„æ•°é‡ä¸ä¼šè¶…è¿‡ä¸€å®šæ¯”ä¾‹ã€‚</span><br>  <span class="hljs-comment">// è¿™æ˜¯ä¸ºäº†é˜²æ­¢åœ¨ä½å¹¶å‘æƒ…å†µä¸‹è¿‡å¤šçš„ CPU ä½¿ç”¨ã€‚</span><br><span class="hljs-keyword">if</span> mp.spinning || <span class="hljs-number">2</span>*sched.nmspinning.Load() &lt; gomaxprocs-sched.npidle.Load() &#123;<br><span class="hljs-keyword">if</span> !mp.spinning &#123;<br>mp.becomeSpinning()<br>&#125;<br> <br>gp, inheritTime, tnow, w, newWork := stealWork(now)<br><span class="hljs-keyword">if</span> gp != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> gp, inheritTime, <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-keyword">if</span> newWork &#123;<br><span class="hljs-keyword">goto</span> top<br>&#125;<br><br>now = tnow<br><span class="hljs-keyword">if</span> w != <span class="hljs-number">0</span> &amp;&amp; (pollUntil == <span class="hljs-number">0</span> || w &lt; pollUntil) &#123;<br>pollUntil = w<br>&#125;<br>&#125;<br>  ...<br><span class="hljs-keyword">goto</span> top<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è¿™ä¸ªè¿‡ç¨‹æ¶‰åŠåˆ°å‡ ä¸ªé‡è¦çš„å‡½æ•°ï¼š</p><ul><li><code>globrunqget()</code>ï¼šä»å…¨å±€é˜Ÿåˆ—ä¸­å¯»æ‰¾å¯è¿è¡Œçš„ Gã€‚</li><li><code>runqget()</code>ï¼šä»æœ¬åœ°é˜Ÿåˆ—ä¸­å¯»æ‰¾å¯è¿è¡Œçš„ Gã€‚</li><li><code>netpoll()</code>ï¼šå¯»æ‰¾å¯ä»¥è¿è¡Œçš„ç½‘ç»œåç¨‹ã€‚</li><li><code>stealWork()</code>ï¼šä»å…¶ä»– P çªƒå–å¯è¿è¡Œçš„ Gã€‚</li></ul><h3 id="globrunqget">4.3 globrunqget()</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">globrunqget</span><span class="hljs-params">(pp *p, max <span class="hljs-type">int32</span>)</span></span> *g &#123;<br>  <span class="hljs-comment">// æŠ¢å…¨å±€åˆ—è¡¨çš„é”</span><br>    assertLockHeld(&amp;sched.lock)<br><br>  <span class="hljs-comment">// å¦‚æœä¸ºç©ºåˆ™ç›´æ¥è¿”å›</span><br>    <span class="hljs-keyword">if</span> sched.runqsize == <span class="hljs-number">0</span> &#123;<br>       <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    &#125;<br><br>  <span class="hljs-comment">// ç¡®å®š n çš„å¤§å°ï¼Œå³è¦ä»å…¨å±€é˜Ÿåˆ—ä¸­è·å–çš„ g çš„ä¸ªæ•°ã€‚</span><br>  <span class="hljs-comment">// è¿™é‡Œä¼šç»“åˆå…¥å‚ max å¯¹è¾¹ç•Œå€¼è¿›è¡Œåˆ¤æ–­ï¼Œä»¥è·å¾—ä¸€ä¸ªåˆç†çš„ nã€‚</span><br>  <span class="hljs-comment">// ä¸€æ¬¡æ€§æœ€å¤šæ‹¿ len(pp.runq)/2 ä¸ª gã€‚</span><br>    n := sched.runqsize/gomaxprocs + <span class="hljs-number">1</span><br>    <span class="hljs-keyword">if</span> n &gt; sched.runqsize &#123;<br>       n = sched.runqsize<br>    &#125;<br>    <span class="hljs-keyword">if</span> max &gt; <span class="hljs-number">0</span> &amp;&amp; n &gt; max &#123;<br>       n = max<br>    &#125;<br>    <span class="hljs-keyword">if</span> n &gt; <span class="hljs-type">int32</span>(<span class="hljs-built_in">len</span>(pp.runq))/<span class="hljs-number">2</span> &#123;<br>       n = <span class="hljs-type">int32</span>(<span class="hljs-built_in">len</span>(pp.runq)) / <span class="hljs-number">2</span><br>    &#125;<br><br>    sched.runqsize -= n<br><br>  <span class="hljs-comment">// é€šè¿‡ pop() ä»å…¨å±€é˜Ÿåˆ—ä¸­å¼¹å‡º g</span><br>    gp := sched.runq.pop()<br>    n--<br>    <span class="hljs-keyword">for</span> ; n &gt; <span class="hljs-number">0</span>; n-- &#123;<br>       gp1 := sched.runq.pop()<br>       <span class="hljs-comment">// å°† g æ”¾å…¥ pp çš„æœ¬åœ°é˜Ÿåˆ—ä¸­</span><br>       <span class="hljs-comment">// runqput åœ¨å‰é¢åˆ›å»ºåç¨‹çš„åœ°æ–¹å·²ç»ä»‹ç»è¿‡äº†ï¼Œè¿™é‡Œä¸èµ˜è¿°ã€‚</span><br>       runqput(pp, gp1, <span class="hljs-literal">false</span>)<br>    &#125;<br>    <span class="hljs-keyword">return</span> gp<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="runqget">4.4 runqget()</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">runqget</span><span class="hljs-params">(pp *p)</span></span> (gp *g, inheritTime <span class="hljs-type">bool</span>) &#123;<br><span class="hljs-comment">// runnext çš„ g ä¼šä¼˜å…ˆæ‰§è¡Œ</span><br>next := pp.runnext<br><span class="hljs-keyword">if</span> next != <span class="hljs-number">0</span> &amp;&amp; pp.runnext.cas(next, <span class="hljs-number">0</span>) &#123;<br><span class="hljs-keyword">return</span> next.ptr(), <span class="hljs-literal">true</span><br>&#125;<br><br><span class="hljs-keyword">for</span> &#123;<br>    <span class="hljs-comment">// åŸå­æ“ä½œè·å–é˜Ÿå¤´æŒ‡é’ˆ</span><br>h := atomic.LoadAcq(&amp;pp.runqhead) <br>t := pp.runqtail<br><span class="hljs-keyword">if</span> t == h &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">false</span><br>&#125;<br>    <span class="hljs-comment">// ä»é˜Ÿå¤´è·å– gï¼Œå¹¶é€šè¿‡åŸå­æ“ä½œæ›´æ–°é˜Ÿå¤´ï¼ˆå³æŠ¢è¿™ä¸ª gï¼‰</span><br>gp := pp.runq[h%<span class="hljs-type">uint32</span>(<span class="hljs-built_in">len</span>(pp.runq))].ptr()<br><span class="hljs-keyword">if</span> atomic.CasRel(&amp;pp.runqhead, h, h+<span class="hljs-number">1</span>) &#123; <br><span class="hljs-keyword">return</span> gp, <span class="hljs-literal">false</span><br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>runqget()</code> å‡½æ•°ç”¨äºä»æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ªå¯è¿è¡Œçš„<code>goroutine</code>ã€‚è¿™ä¸ªå‡½æ•°åªèƒ½ç”±æ‹¥æœ‰è¯¥é˜Ÿåˆ—çš„å¤„ç†å™¨ï¼ˆPï¼‰æ‰§è¡Œã€‚ä¸‹é¢æ˜¯å¯¹è¿™ä¸ªå‡½æ•°çš„è¯¦ç»†è§£é‡Šï¼š</p><p><strong>1. æ£€æŸ¥ <code>runnext</code></strong>ï¼š</p><ul><li><code>runnext</code> æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å­—æ®µï¼Œç”¨äºå­˜å‚¨ä¸‹ä¸€ä¸ªè¦è¿è¡Œçš„<code>goroutine</code>ã€‚å¦‚æœ <code>runnext</code>éé›¶ï¼Œå¹¶ä¸”èƒ½æˆåŠŸé€šè¿‡åŸå­æ“ä½œï¼ˆCASï¼‰å°†å…¶è®¾ç½®ä¸ºé›¶ï¼Œåˆ™ç›´æ¥è¿”å›è¿™ä¸ª<code>goroutine</code>ã€‚</li><li>å¦‚æœæˆåŠŸè·å– <code>runnext</code> æŒ‡å‘çš„<code>goroutine</code>ï¼Œ<code>inheritTime</code> è¢«è®¾ç½®ä¸º<code>true</code>ï¼Œè¡¨ç¤ºè¿™ä¸ª <code>goroutine</code>åº”è¯¥ç»§æ‰¿å½“å‰æ—¶é—´ç‰‡çš„å‰©ä½™æ—¶é—´ã€‚</li><li>å¦‚æœæ²¡æˆåŠŸï¼Œæ„å‘³ç€ runnext çš„è¿™ä¸ª g å·²ç»è¢«å…¶ä»– Pç»™æŠ¢äº†ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥å‘ç°æœ¬ P åªå¯èƒ½å°†å…¶è®¾ç½®ä¸º 0ï¼Œåªæœ‰å…¶ä»– Pæ‰ä¼šå°†å…¶è®¾ç½®ä»¥ä¸ºé 0ã€‚</li></ul><p><strong>2. ä»æœ¬åœ°é˜Ÿåˆ—ä¸­è·å– <code>goroutine</code></strong>ï¼š</p><ul><li>ä½¿ç”¨åŸå­æ“ä½œåŠ è½½<code>runqhead</code>ï¼ˆé˜Ÿåˆ—å¤´æŒ‡é’ˆï¼‰ï¼Œ<code>runqtail</code>ï¼ˆé˜Ÿåˆ—å°¾æŒ‡é’ˆï¼‰ã€‚</li><li>å¦‚æœ <code>runqhead</code> ç­‰äº<code>runqtail</code>ï¼Œè¡¨ç¤ºé˜Ÿåˆ—ä¸ºç©ºï¼Œè¿”å› <code>nil</code>ã€‚</li><li>å¦åˆ™ï¼Œä»é˜Ÿåˆ—ä¸­è·å– <code>runqhead</code> æŒ‡å‘çš„<code>goroutine</code>ï¼Œå¹¶å°è¯•é€šè¿‡åŸå­æ“ä½œï¼ˆCASï¼‰æ›´æ–°<code>runqhead</code>ã€‚</li><li>å¦‚æœæ›´æ–°æˆåŠŸï¼Œè¿”å›è·å–åˆ°çš„<code>goroutine</code>ï¼Œ<code>inheritTime</code> è¢«è®¾ç½®ä¸º<code>false</code>ï¼Œè¡¨ç¤ºè¿™ä¸ª <code>goroutine</code>åº”è¯¥å¼€å§‹ä¸€ä¸ªæ–°çš„æ—¶é—´ç‰‡ã€‚</li></ul><p>ä¸¤ä¸ªé—®é¢˜ï¼š</p><p><strong>1. ä¸ºä»€ä¹ˆè·å– runqhead éœ€è¦ä¸Šé”ï¼Œè·å– runqtailå°±ä¸éœ€è¦ï¼Ÿ</strong></p><p><strong>å•ä¸€ç”Ÿäº§è€…</strong>ï¼šæ¯ä¸ªæœ¬åœ°è¿è¡Œé˜Ÿåˆ—åªæœ‰ä¸€ä¸ªç”Ÿäº§è€…ï¼Œå³ä¸ä¹‹å…³è”çš„å½“å‰Pã€‚åªæœ‰è¿™ä¸ª P å¯ä»¥å‘é˜Ÿåˆ—å°¾éƒ¨æ·»åŠ æ–°çš„<code>goroutine</code>ã€‚ç”±äºä¸å­˜åœ¨å¤šä¸ªç”Ÿäº§è€…çš„å¹¶å‘å†™å…¥é—®é¢˜ï¼Œå› æ­¤ä¸éœ€è¦é”æ¥ä¿æŠ¤é˜Ÿå°¾ã€‚</p><p><strong>2. inheritTime æœ‰ä»€ä¹ˆç”¨ï¼Ÿ</strong></p><p><code>inheritTime</code> çš„ä¸»è¦ä½œç”¨æ˜¯å†³å®šæ–°è°ƒåº¦çš„<code>goroutine</code>æ˜¯å¦åº”è¯¥ç«‹å³å¼€å§‹ä¸€ä¸ªæ–°çš„æ—¶é—´ç‰‡ï¼Œæˆ–è€…ç»§ç»­ä½¿ç”¨å½“å‰æ—¶é—´ç‰‡çš„å‰©ä½™éƒ¨åˆ†ã€‚è¿™åœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¸‹å°¤ä¸ºé‡è¦ï¼š</p><ul><li><strong>ç»§æ‰¿æ—¶é—´ç‰‡</strong> (<code>inheritTime == true</code>)ï¼šå½“<code>runqget</code> ä» <code>runnext</code> å­—æ®µè·å–<code>goroutine</code> æ—¶ï¼Œè¿™ä¸ª <code>goroutine</code>è¢«è®¤ä¸ºæ˜¯ç‰¹åˆ«ä¼˜å…ˆçš„ï¼Œå› æ­¤å®ƒç»§æ‰¿äº†å½“å‰æ—¶é—´ç‰‡çš„å‰©ä½™æ—¶é—´ã€‚è¿™é€šå¸¸å‘ç”Ÿåœ¨<code>goroutine</code>é€šè¿‡ç‰¹å®šçš„åŒæ­¥æœºåˆ¶ï¼ˆå¦‚é€šé“æ“ä½œï¼‰è¢«æ˜ç¡®å”¤é†’æ—¶ã€‚</li><li><strong>å¼€å§‹æ–°çš„æ—¶é—´ç‰‡</strong>(<code>inheritTime == false</code>)ï¼šå½“ <code>runqget</code>ä»æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ä¸­æ­£å¸¸è·å– <code>goroutine</code> æ—¶ï¼Œè¿™ä¸ª<code>goroutine</code>å°†å¼€å§‹ä¸€ä¸ªå…¨æ–°çš„æ—¶é—´ç‰‡ã€‚è¿™ç¡®ä¿äº†è°ƒåº¦çš„å…¬å¹³æ€§ï¼Œä½¿å¾—æ¯ä¸ª<code>goroutine</code> éƒ½æœ‰æœºä¼šåœ¨ç»™å®šçš„æ—¶é—´ç‰‡å†…è¿è¡Œã€‚</li></ul><h3 id="netpoll">4.5 netpoll()</h3><p><code>netpoll()</code> å‡½æ•°æ˜¯ Goè¯­è¨€è¿è¡Œæ—¶ç½‘ç»œè½®è¯¢æœºåˆ¶çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºæ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦å‡†å¤‡å¥½è¿›è¡Œéé˜»å¡ I/Oæ“ä½œã€‚è¿™ä¸ªå‡½æ•°è¿”å›ä¸€ç»„å·²ç»å˜ä¸ºå¯è¿è¡ŒçŠ¶æ€çš„ <code>goroutine</code>ï¼Œè¿™äº›<code>goroutine</code> ä¹‹å‰å¯èƒ½å› ç­‰å¾…ç½‘ç»œ I/O è€Œè¢«æŒ‚èµ·ã€‚</p><p>è¿™é‡Œæ¶‰åŠåˆ° Go è¯­è¨€ç½‘ç»œç¼–ç¨‹åŸç†ï¼Œåœ¨æœ¬æ–‡ä¸­ä¸ç»†ç©¶ï¼Œå°±ç®€å•å¸¦è¿‡äº†ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">netpoll</span><span class="hljs-params">(delay <span class="hljs-type">int64</span>)</span></span> gList &#123;<br>  <span class="hljs-comment">// æ£€æŸ¥è½®è¯¢å™¨æ˜¯å¦åˆå§‹åŒ–ã€‚</span><br><span class="hljs-keyword">if</span> kq == <span class="hljs-number">-1</span> &#123;<br><span class="hljs-keyword">return</span> gList&#123;&#125;<br>&#125;<br>  <span class="hljs-comment">// è®¾ç½®è½®è¯¢è¶…æ—¶ã€‚</span><br><span class="hljs-keyword">var</span> tp *timespec<br><span class="hljs-keyword">var</span> ts timespec<br><span class="hljs-keyword">if</span> delay &lt; <span class="hljs-number">0</span> &#123;<br>tp = <span class="hljs-literal">nil</span><br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> delay == <span class="hljs-number">0</span> &#123;<br>tp = &amp;ts<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>ts.setNsec(delay)<br><span class="hljs-keyword">if</span> ts.tv_sec &gt; <span class="hljs-number">1e6</span> &#123;<br>ts.tv_sec = <span class="hljs-number">1e6</span><br>&#125;<br>tp = &amp;ts<br>&#125;<br>  <span class="hljs-comment">// ä½¿ç”¨ kevent è¿›è¡Œè½®è¯¢æ“ä½œï¼Œç»“æœæ”¾åœ¨ events ä¸­ã€‚</span><br><span class="hljs-keyword">var</span> events [<span class="hljs-number">64</span>]keventt<br>retry:<br>n := kevent(kq, <span class="hljs-literal">nil</span>, <span class="hljs-number">0</span>, &amp;events[<span class="hljs-number">0</span>], <span class="hljs-type">int32</span>(<span class="hljs-built_in">len</span>(events)), tp)<br><span class="hljs-keyword">if</span> n &lt; <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">if</span> n != -_EINTR &#123;<br><span class="hljs-built_in">println</span>(<span class="hljs-string">&quot;runtime: kevent on fd&quot;</span>, kq, <span class="hljs-string">&quot;failed with&quot;</span>, -n)<br>throw(<span class="hljs-string">&quot;runtime: netpoll failed&quot;</span>)<br>&#125;<br><span class="hljs-keyword">if</span> delay &gt; <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> gList&#123;&#125;<br>&#125;<br><span class="hljs-keyword">goto</span> retry<br>&#125;<br>  <span class="hljs-comment">// éå† events å¤„ç†è½®è¯¢äº‹ä»¶ã€‚</span><br><span class="hljs-keyword">var</span> toRun gList<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-type">int</span>(n); i++ &#123;<br>ev := &amp;events[i]<br><br>    <span class="hljs-comment">// netpollBreakRd ç”¨äºå”¤é†’è½®è¯¢ï¼Œå³å”¤é†’ç­‰å¾…ä¸­çš„ goroutineã€‚</span><br><span class="hljs-keyword">if</span> <span class="hljs-type">uintptr</span>(ev.ident) == netpollBreakRd &#123;<br><span class="hljs-keyword">if</span> ev.filter != _EVFILT_READ &#123;<br><span class="hljs-built_in">println</span>(<span class="hljs-string">&quot;runtime: netpoll: break fd ready for&quot;</span>, ev.filter)<br>throw(<span class="hljs-string">&quot;runtime: netpoll: break fd ready for something unexpected&quot;</span>)<br>&#125;<br><span class="hljs-keyword">if</span> delay != <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">var</span> tmp [<span class="hljs-number">16</span>]<span class="hljs-type">byte</span><br>read(<span class="hljs-type">int32</span>(netpollBreakRd), noescape(unsafe.Pointer(&amp;tmp[<span class="hljs-number">0</span>])), <span class="hljs-type">int32</span>(<span class="hljs-built_in">len</span>(tmp)))<br>netpollWakeSig.Store(<span class="hljs-number">0</span>)<br>&#125;<br><span class="hljs-keyword">continue</span><br>&#125;<br><br>    <span class="hljs-comment">// æ ¹æ®è½®è¯¢äº‹ä»¶çš„ç±»å‹ï¼ˆè¯»æˆ–å†™ï¼‰ï¼Œå”¤é†’ç›¸åº”ç­‰å¾…ç½‘ç»œ I/O çš„ groutineã€‚</span><br><span class="hljs-keyword">var</span> mode <span class="hljs-type">int32</span><br><span class="hljs-keyword">switch</span> ev.filter &#123;<br><span class="hljs-keyword">case</span> _EVFILT_READ:<br>mode += <span class="hljs-string">&#x27;r&#x27;</span><br><span class="hljs-keyword">if</span> ev.flags&amp;_EV_EOF != <span class="hljs-number">0</span> &#123;<br>mode += <span class="hljs-string">&#x27;w&#x27;</span><br>&#125;<br><span class="hljs-keyword">case</span> _EVFILT_WRITE:<br>mode += <span class="hljs-string">&#x27;w&#x27;</span><br>&#125;<br><span class="hljs-keyword">if</span> mode != <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">var</span> pd *pollDesc<br><span class="hljs-keyword">var</span> tag <span class="hljs-type">uintptr</span><br><span class="hljs-keyword">if</span> goarch.PtrSize == <span class="hljs-number">4</span> &#123;<br>pd = (*pollDesc)(unsafe.Pointer(ev.udata))<br>tag = <span class="hljs-number">0</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br>tp := taggedPointer(<span class="hljs-type">uintptr</span>(unsafe.Pointer(ev.udata)))<br>pd = (*pollDesc)(tp.pointer())<br>tag = tp.tag()<br><span class="hljs-keyword">if</span> pd.fdseq.Load() != tag &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br>&#125;<br>pd.setEventErr(ev.flags == _EV_ERROR, tag)<br>      <span class="hljs-comment">// æ ‡è®° goroutine å¯æ‰§è¡Œã€‚</span><br>netpollready(&amp;toRun, pd, mode)<br>&#125;<br>&#125;<br>  <br>  <span class="hljs-comment">// è¿”å›å¯è¿è¡Œçš„ goroutine åˆ—è¡¨ã€‚</span><br><span class="hljs-keyword">return</span> toRun<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="stealwork">4.6 stealWork()</h3><p><code>stealWork()</code> å‡½æ•°ç”¨äºå°è¯•ä»å…¶ä»–å¤„ç†å™¨ï¼ˆPï¼‰çªƒå–å¯è¿è¡Œçš„<code>goroutine</code> æˆ–å®šæ—¶å™¨ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">stealWork</span><span class="hljs-params">(now <span class="hljs-type">int64</span>)</span></span> (gp *g, inheritTime <span class="hljs-type">bool</span>, rnow, pollUntil <span class="hljs-type">int64</span>, newWork <span class="hljs-type">bool</span>) &#123;<br>  <br>  <span class="hljs-comment">// è·å–å½“å‰ M ç»‘å®šçš„ Pã€‚</span><br>pp := getg().m.p.ptr()<br><br>ranTimer := <span class="hljs-literal">false</span><br><br>  <span class="hljs-comment">// å°è¯• 4 æ¬¡ã€‚</span><br><span class="hljs-keyword">const</span> stealTries = <span class="hljs-number">4</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; stealTries; i++ &#123;<br>    <span class="hljs-comment">// å‰ 3 æ¬¡å°è¯•çªƒå– gã€‚</span><br>    <span class="hljs-comment">// ç¬¬ 4 æ¬¡å°è¯•çªƒå– timerï¼Œå¹¶ä¸”å°è¯•è·å–å…¶ä»– P çš„ runnext ä¸­çš„ gã€‚</span><br>stealTimersOrRunNextG := i == stealTries<span class="hljs-number">-1</span><br><br>    <span class="hljs-comment">// éšæœºé€‰ä¸€ä¸ª Pã€‚</span><br><span class="hljs-keyword">for</span> enum := stealOrder.start(fastrand()); !enum.done(); enum.next() &#123;<br><span class="hljs-comment">// å¦‚æœç³»ç»Ÿæ­£åœ¨ GCï¼Œåˆ™å¯ä»¥ç›´æ¥è¿”å› trueï¼Œå› ä¸ºå¯èƒ½è¦è´Ÿè´£ gc äº†ï¼Œæœ‰äº‹å¹²äº†ã€‚</span><br>      <span class="hljs-keyword">if</span> sched.gcwaiting.Load() &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">false</span>, now, pollUntil, <span class="hljs-literal">true</span><br>&#125;<br>      <br>      <span class="hljs-comment">// è·å–é€‰ä¸­çš„ Pï¼Œå¦‚æœæ˜¯å½“å‰ P åˆ™ç›´æ¥ continueï¼Œé‡è¯•ã€‚</span><br>p2 := allp[enum.position()]<br><span class="hljs-keyword">if</span> pp == p2 &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><br>      <span class="hljs-comment">// ç¬¬ 4 æ¬¡å°è¯•å»çªƒå– p2 çš„ timerã€‚</span><br><span class="hljs-keyword">if</span> stealTimersOrRunNextG &amp;&amp; timerpMask.read(enum.position()) &#123;<br>        <span class="hljs-comment">// æ£€æŸ¥å¹¶å¯èƒ½æ‰§è¡Œ timerã€‚</span><br>tnow, w, ran := checkTimers(p2, now)<br>now = tnow<br><span class="hljs-keyword">if</span> w != <span class="hljs-number">0</span> &amp;&amp; (pollUntil == <span class="hljs-number">0</span> || w &lt; pollUntil) &#123;<br>pollUntil = w<br>&#125;<br>        <span class="hljs-comment">// å¦‚æœæ‰§è¡Œäº† timerï¼Œåˆ™æ£€æŸ¥æœ¬åœ°é˜Ÿåˆ—æ˜¯å¦æœ‰ g å¯ä»¥è¿è¡Œï¼Œ</span><br>        <span class="hljs-comment">// å› ä¸º timer ä¼šå”¤é†’è¢«æŒ‚èµ·çš„ gã€‚</span><br><span class="hljs-keyword">if</span> ran &#123;<br><span class="hljs-keyword">if</span> gp, inheritTime := runqget(pp); gp != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> gp, inheritTime, now, pollUntil, ranTimer<br>&#125;<br>ranTimer = <span class="hljs-literal">true</span><br>&#125;<br>&#125;<br><br>      <span class="hljs-comment">// å‰ 3 æ¬¡å°è¯•æˆ–è€…ç¬¬ 4 æ¬¡å°è¯•æ²¡æœ‰çªƒå–åˆ° timer çš„æ—¶å€™ï¼Œ</span><br>      <span class="hljs-comment">// å°±ä»å…¶ä»–éç©ºé—² P çš„æœ¬åœ°é˜Ÿåˆ—ä¸­å°è¯•çªƒå– gã€‚</span><br><span class="hljs-keyword">if</span> !idlepMask.read(enum.position()) &#123;<br>        <span class="hljs-comment">// å¦‚æœ stealTimersOrRunNextG ä¸º trueï¼Œ</span><br>        <span class="hljs-comment">// é‚£ä¹ˆä¼šåœ¨çªƒå–çš„æ—¶å€™ï¼Œå°è¯•çªƒå– p2 çš„ runnextã€‚</span><br><span class="hljs-keyword">if</span> gp := runqsteal(pp, p2, stealTimersOrRunNextG); gp != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> gp, <span class="hljs-literal">false</span>, now, pollUntil, ranTimer<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">false</span>, now, pollUntil, ranTimer<br>&#125;<br></code></pre></td></tr></table></figure><p>é˜…è¯»æºç çš„å¥½å¤„è¿™å°±ä½“ç°äº†ï¼Œæ‰€æœ‰äººéƒ½å‘Šè¯‰æˆ‘ä»¬ P æ‰¾ä¸åˆ°å¯è¿è¡Œ Gçš„æ—¶å€™å°±ä¼šå»çªƒå–å…¶ä»– P çš„Gï¼Œä½†æ²¡äººå‘Šè¯‰æˆ‘ä»¬ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹<strong>è¿˜å¯èƒ½ä¼šå»çªƒå–å…¶ä»– P çš„ timer å’Œrunnext</strong>ã€‚</p><p>æ‰€è°“<code>timer</code>ï¼Œå³å®šæ—¶å™¨ï¼Œç”¨äºåœ¨æŒ‡å®šçš„æ—¶é—´åæ‰§è¡ŒæŸäº›æ“ä½œã€‚è¿™äº›æ“ä½œé€šå¸¸åŒ…æ‹¬å”¤é†’ç­‰å¾…ç‰¹å®šæ—¶é—´çš„<code>goroutine</code>ï¼Œæˆ–æ‰§è¡Œä¸æ—¶é—´ç›¸å…³çš„ä»»åŠ¡ã€‚å®šæ—¶å™¨åœ¨ Goçš„å¹¶å‘æ¨¡å‹ä¸­æ‰®æ¼”ç€é‡è¦çš„è§’è‰²ï¼Œç‰¹åˆ«æ˜¯åœ¨æ¶‰åŠåˆ°æ—¶é—´å»¶è¿Ÿæˆ–å‘¨æœŸæ€§ä»»åŠ¡çš„åœºæ™¯ä¸­ã€‚åœ¨è°ƒåº¦å™¨å±‚é¢ï¼Œå®šæ—¶å™¨çš„ç®¡ç†å¯¹äºç¡®ä¿åŠæ—¶å“åº”æ—¶é—´ç›¸å…³çš„äº‹ä»¶å’Œç»´æŒé«˜æ•ˆçš„è°ƒåº¦è‡³å…³é‡è¦ã€‚é€šè¿‡åˆç†åœ°å¤„ç†å®šæ—¶å™¨äº‹ä»¶ï¼ŒGoèƒ½å¤Ÿåœ¨ä¿æŒé«˜å¹¶å‘æ€§çš„åŒæ—¶ï¼Œæœ‰æ•ˆåœ°ç®¡ç†æ—¶é—´å»¶è¿Ÿå’Œå‘¨æœŸæ€§ä»»åŠ¡ã€‚</p><p>åœ¨ Go è¯­è¨€çš„è°ƒåº¦å™¨ä¸­ï¼Œè·¨ P çš„å®šæ—¶å™¨çªƒå–æ˜¯ä¸€ç§ä¼˜åŒ–æœºåˆ¶ï¼Œå®ƒæœ‰ 2ä¸ªå¥½å¤„ï¼š</p><ul><li><strong>ä¿æŒå¤„ç†å™¨æ´»è·ƒ</strong>ï¼šå½“ä¸€ä¸ª Pæ²¡æœ‰è¶³å¤Ÿçš„æœ¬åœ°å·¥ä½œæ—¶ï¼Œå®ƒå¯ä»¥å°è¯•ä»å…¶ä»– Pçªƒå–å®šæ—¶å™¨ä»»åŠ¡ã€‚è¿™æ ·åšå¯ä»¥ä¿æŒè¯¥ Pæ´»è·ƒï¼Œé¿å…å®ƒè¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œä»è€Œæé«˜æ•´ä½“ç³»ç»Ÿçš„æ•ˆç‡ã€‚</li><li><strong>å¹³è¡¡ç³»ç»Ÿè´Ÿè½½</strong>ï¼šåœ¨å¤šæ ¸ç³»ç»Ÿä¸­ï¼Œä¸åŒçš„ På¯èƒ½ä¼šæœ‰ä¸åŒçš„è´Ÿè½½ã€‚è·¨ P çš„å®šæ—¶å™¨çªƒå–æœ‰åŠ©äºåœ¨ Pä¹‹é—´å¹³è¡¡è´Ÿè½½ï¼Œç‰¹åˆ«æ˜¯åœ¨ä¸€äº› P éå¸¸å¿™ç¢Œè€Œå…¶ä»– P ç›¸å¯¹ç©ºé—²çš„æƒ…å†µä¸‹ã€‚</li></ul><p>å¥½çš„ï¼Œå›è¿‡å¤´æ¥ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬ä¼šè¯´çªƒå–çš„æ—¶å€™ä¼šä»é˜Ÿå¤´çªƒå–å‘¢ï¼Ÿä¸ºä»€ä¹ˆæ˜¯çªƒå–p2 ä¸€åŠçš„ g å‘¢ï¼Ÿè¿™ä¸ªè¿‡ç¨‹å°±åœ¨ <code>runqsteal()</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">runqsteal</span><span class="hljs-params">(pp, p2 *p, stealRunNextG <span class="hljs-type">bool</span>)</span></span> *g &#123;<br>t := pp.runqtail<br>  <br>  <span class="hljs-comment">// ä» p2 ä¸­è·å– n ä¸ª gã€‚</span><br>n := runqgrab(p2, &amp;pp.runq, t, stealRunNextG)<br><span class="hljs-keyword">if</span> n == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br>  <br>  <span class="hljs-comment">// è¿”å›ç¬¬ 1 ä¸ª gï¼Œå› ä¸ºå®ƒå¯ä»¥ç›´æ¥æ‰§è¡Œäº†ã€‚</span><br>n--<br>gp := pp.runq[(t+n)%<span class="hljs-type">uint32</span>(<span class="hljs-built_in">len</span>(pp.runq))].ptr()<br><span class="hljs-keyword">if</span> n == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> gp<br>&#125;<br>  <span class="hljs-comment">// å¦‚æœè¿˜æœ‰å‰©ä¸‹çš„ gï¼Œé‚£ä¹ˆå°±åŠ å…¥åˆ°æœ¬åœ°é˜Ÿåˆ—ä¸­ã€‚</span><br>  <span class="hljs-comment">// è¿™é‡Œå¯ä»¥çœ‹åˆ°æ˜¯ä»é˜Ÿå¤´åŠ å…¥çš„ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨åŸå­æ“ä½œè·å–é˜Ÿå¤´ã€‚</span><br>h := atomic.LoadAcq(&amp;pp.runqhead)<br><span class="hljs-keyword">if</span> t-h+n &gt;= <span class="hljs-type">uint32</span>(<span class="hljs-built_in">len</span>(pp.runq)) &#123;<br>throw(<span class="hljs-string">&quot;runqsteal: runq overflow&quot;</span>)<br>&#125;<br>atomic.StoreRel(&amp;pp.runqtail, t+n)<br><span class="hljs-keyword">return</span> gp<br>&#125;<br></code></pre></td></tr></table></figure><p><code>runqgrab()</code> æ˜¯çªƒå– n ä¸ª g çš„è¿‡ç¨‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">runqgrab</span><span class="hljs-params">(pp *p, batch *[256]guintptr, batchHead <span class="hljs-type">uint32</span>, stealRunNextG <span class="hljs-type">bool</span>)</span></span> <span class="hljs-type">uint32</span> &#123;<br>  <span class="hljs-comment">// ä½¿ç”¨æ— é™å¾ªç¯æ¥å°è¯•çªƒå–å·¥ä½œï¼Œç›´åˆ°æˆåŠŸæˆ–ç¡®å®šæ²¡æœ‰å¯çªƒå–çš„å·¥ä½œã€‚</span><br><span class="hljs-keyword">for</span> &#123;<br>h := atomic.LoadAcq(&amp;pp.runqhead) <br>t := atomic.LoadAcq(&amp;pp.runqtail) <br>n := t - h<br>    <br>    <span class="hljs-comment">// è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œè¦çªƒå–çš„ä¸ªæ•°ï¼Œå°±æ˜¯ pp æœ¬åœ°é˜Ÿåˆ—ä¸­ g ä¸ªæ•°çš„ä¸€åŠ</span><br>n = n - n/<span class="hljs-number">2</span><br>    <br>    <span class="hljs-comment">// å¦‚æœ n ä¸º 0ï¼Œä¸” stealRunNextG == trueï¼Œ</span><br>    <span class="hljs-comment">// é‚£ä¹ˆå°±å°è¯•çªƒå– pp çš„ runnext ä¸­çš„ gã€‚</span><br><span class="hljs-keyword">if</span> n == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">if</span> stealRunNextG &#123;<br><span class="hljs-keyword">if</span> next := pp.runnext; next != <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">if</span> !pp.runnext.cas(next, <span class="hljs-number">0</span>) &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br>batch[batchHead%<span class="hljs-type">uint32</span>(<span class="hljs-built_in">len</span>(batch))] = next<br><span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>&#125;<br>    <br>    <span class="hljs-comment">// å¦‚æœ n ä¸ä¸ºé˜Ÿåˆ—é•¿åº¦çš„ä¸€åŠï¼Œåˆ™è¯´æ˜é˜Ÿåˆ—å‘ç”Ÿäº†å˜åŒ–ï¼Œ</span><br>    <span class="hljs-comment">// è¿™ä¸ªæ—¶å€™é‡æ–°å°è¯•çªƒå–ã€‚</span><br><span class="hljs-keyword">if</span> n &gt; <span class="hljs-type">uint32</span>(<span class="hljs-built_in">len</span>(pp.runq)/<span class="hljs-number">2</span>) &#123; <br><span class="hljs-keyword">continue</span><br>&#125;<br>    <span class="hljs-comment">// å°†è¦çªƒå–çš„ g ä» pp.runq ä¸­è½¬ç§»åˆ° batch ä¸­ã€‚</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>); i &lt; n; i++ &#123;<br>g := pp.runq[(h+i)%<span class="hljs-type">uint32</span>(<span class="hljs-built_in">len</span>(pp.runq))]<br>batch[(batchHead+i)%<span class="hljs-type">uint32</span>(<span class="hljs-built_in">len</span>(batch))] = g<br>&#125;<br>    <span class="hljs-comment">// ä½¿ç”¨åŸå­æ“ä½œå°è¯•æ›´æ–° pp çš„é˜Ÿåˆ—å¤´éƒ¨ï¼Œå³å°† g ä» pp.runq ä¸­ç§»é™¤ã€‚</span><br><span class="hljs-keyword">if</span> atomic.CasRel(&amp;pp.runqhead, h, h+n) &#123; <br><span class="hljs-keyword">return</span> n<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>findRunnable()</code>çš„å…¨éƒ¨è¿‡ç¨‹æˆ‘ä»¬æ€»ç®—æ˜¯æ¢³ç†å®Œäº†ï¼Œè¿™ä¸ªè¿‡ç¨‹ç¡®å®éå¸¸ç²¾å½©ï¼ŒGoè°ƒåº¦å™¨åœ¨æé«˜è°ƒåº¦æ€§èƒ½ã€ç¡®ä¿è°ƒåº¦çš„å…¬å¹³æ€§ã€å¹³è¡¡ç³»ç»Ÿè´Ÿè½½ã€é™ä½åŒæ­¥å¼€é”€ã€å‡å°‘èµ„æºå†åˆ†é…ç­‰æ–¹é¢éƒ½åšäº†å¾ˆå¤šçš„åŠªåŠ›ï¼Œè¿™æ‰è®©Go è¯­è¨€çš„å¹¶å‘åˆå¼ºå¤§åˆæ˜“ç”¨ã€‚</p><p>ä¸‹é¢æ˜¯å¯¹ <code>findRunnable()</code> ä¸€ä¸ªç®€å•çš„æ€»ç»“ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240128212451142.png"alt="findRunnable()" /><figcaption aria-hidden="true">findRunnable()</figcaption></figure><h3 id="execute">4.7 execute()</h3><p><code>findRunnable()</code> ä¹‹åå°±æ˜¯<code>execute()</code>ï¼Œå®ƒçš„æ ¸å¿ƒè¿‡ç¨‹å¦‚ä¸‹ï¼ˆæœ‰åˆ å‡ï¼‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">execute</span><span class="hljs-params">(gp *g, inheritTime <span class="hljs-type">bool</span>)</span></span> &#123;<br>mp := getg().m<br><span class="hljs-comment">// å°† g0 d çº¿ç¨‹ä¿¡æ¯å¤åˆ¶åˆ°å³å°†è¦è°ƒç”¨çš„åç¨‹ gp ä¸­ã€‚</span><br>mp.curg = gp<br>gp.m = mp<br>  <span class="hljs-comment">// ä¿®æ”¹ gp çš„çŠ¶æ€ä¸º _Grunningï¼Œå³è¿è¡Œä¸­ã€‚</span><br>casgstatus(gp, _Grunnable, _Grunning)<br>gp.waitsince = <span class="hljs-number">0</span><br>  <span class="hljs-comment">// æ ‡è®°ä¸ºéæŠ¢å </span><br>gp.preempt = <span class="hljs-literal">false</span><br>  <span class="hljs-comment">// ç”¨äºæ ˆä¿æŠ¤ï¼Œæ£€æµ‹æ ˆæº¢å‡º</span><br>gp.stackguard0 = gp.stack.lo + stackGuard<br>  <span class="hljs-comment">// gogo ä¼šå®Œæˆ g0 åˆ° g çš„åç¨‹æ ˆçš„åˆ‡æ¢ï¼Œå¹¶ä» gp.sched å¼€å§‹æ‰§è¡Œã€‚</span><br>  <span class="hljs-comment">// sched å­—æ®µæˆ‘ä»¬å‰é¢ä»‹ç»è¿‡ï¼Œå®ƒæ˜¯ gobuf ç»“æ„ä½“ï¼Œå­˜å‚¨äº† sp å’Œ pcã€‚</span><br>gogo(&amp;gp.sched)<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥ <code>execute()</code> çš„å·¥ä½œéå¸¸ç®€å•ï¼Œå…¶å®å°±æ˜¯å°† g0çš„çº¿ç¨‹ä¿¡æ¯å¤åˆ¶åˆ° gp ä¸Šï¼Œå¹¶ä¿®æ”¹çŠ¶æ€å’Œä¸€äº›å…ƒæ•°æ®ï¼Œæ ¸å¿ƒéƒ¨åˆ†å…¶å®åœ¨<code>gogo()</code> ä¸­ã€‚</p><h3 id="gogo">4.8 gogo()</h3><p>å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼Œ<code>gogo()</code> ä¼šå®Œæˆ g0 æ ˆåˆ° gæ ˆçš„åˆ‡æ¢ï¼Œä¸”åœ¨ä¸åŒå¹³å°ä¸‹æœ‰ä¸åŒçš„è§†çº¿ï¼Œè¿™é‡Œæˆ‘ä»¬ä»¥ <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/asm_arm64.s">asm_arm64.s</a>ä¸ºä»£è¡¨æ¥çœ‹ä¸€ä¸‹ <code>gogo()</code> çš„æ±‡ç¼–å®ç°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs assembly">TEXT runtimeÂ·gogo(SB), NOSPLIT|NOFRAME, $0-8<br>MOVDbuf+0(FP), R5<br>MOVDgobuf_g(R5), R6<br>MOVD0(R6), R4// make sure g != nil<br>Bgogo&lt;&gt;(SB)<br><br>TEXT gogo&lt;&gt;(SB), NOSPLIT|NOFRAME, $0<br>MOVDR6, g<br>BLruntimeÂ·save_g(SB)<br><br>MOVDgobuf_sp(R5), R0<br>MOVDR0, RSP<br>MOVDgobuf_bp(R5), R29<br>MOVDgobuf_lr(R5), LR<br>MOVDgobuf_ret(R5), R0<br>MOVDgobuf_ctxt(R5), R26<br>MOVD$0, gobuf_sp(R5)<br>MOVD$0, gobuf_bp(R5)<br>MOVD$0, gobuf_ret(R5)<br>MOVD$0, gobuf_lr(R5)<br>MOVD$0, gobuf_ctxt(R5)<br>CMPZR, ZR // set condition codes for == test, needed by stack split<br>MOVDgobuf_pc(R5), R6<br>B(R6)<br></code></pre></td></tr></table></figure><p>å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol type="1"><li><strong><code>runtimeÂ·gogo</code>å‡½æ•°</strong>ï¼šè¿™ä¸ªå‡½æ•°ç”¨äºè®¾ç½®æ–°çš„ <code>goroutine</code>ä¸Šä¸‹æ–‡ã€‚å®ƒæ¥æ”¶ä¸€ä¸ªæŒ‡å‘ <code>gobuf</code>ç»“æ„çš„æŒ‡é’ˆï¼ˆ<code>buf+0(FP)</code>ï¼‰ï¼Œè¯¥ç»“æ„åŒ…å«äº†<code>goroutine</code> çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</li><li><strong>åŠ è½½ <code>gobuf</code> å¹¶æ£€æŸ¥ <code>g</code></strong>ï¼šåŠ è½½<code>gobuf</code> ç»“æ„ï¼Œå¹¶æ£€æŸ¥ <code>g</code> æ˜¯å¦ä¸º<code>nil</code>ã€‚</li><li><strong>è·³è½¬åˆ° <code>gogo&lt;&gt;</code></strong>ï¼šæ‰§è¡Œæ— æ¡ä»¶è·³è½¬åˆ°<code>gogo&lt;&gt;</code> å‡½æ•°ã€‚</li><li><strong><code>gogo&lt;&gt;</code>å‡½æ•°</strong>ï¼šè¿™ä¸ªå‡½æ•°å®é™…ä¸Šå®Œæˆäº†ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚<ul><li>è®¾ç½®å½“å‰ <code>goroutine</code>ï¼šå°† <code>R6</code>å¯„å­˜å™¨ä¸­çš„å€¼ï¼ˆæ–°çš„ <code>goroutine</code>ï¼‰è®¾ç½®ä¸ºå½“å‰<code>goroutine</code>ã€‚</li><li>ä¿å­˜å½“å‰ <code>goroutine</code>ï¼šè°ƒç”¨ <code>runtimeÂ·save_g</code>ä¿å­˜å½“å‰ <code>goroutine</code> çš„çŠ¶æ€ã€‚</li><li>æ¢å¤æ ˆæŒ‡é’ˆå’Œå…¶ä»–å¯„å­˜å™¨ï¼šä» <code>gobuf</code>ç»“æ„ä¸­æ¢å¤æ ˆæŒ‡é’ˆï¼ˆ<code>RSP</code>ï¼‰ã€åŸºæŒ‡é’ˆï¼ˆ<code>R29</code>ï¼‰ã€é“¾æ¥å¯„å­˜å™¨ï¼ˆ<code>LR</code>ï¼‰ã€è¿”å›å€¼ï¼ˆ<code>R0</code>ï¼‰å’Œä¸Šä¸‹æ–‡ï¼ˆ<code>R26</code>ï¼‰ã€‚</li><li>æ¸…ç©º <code>gobuf</code> ç»“æ„ï¼šå°† <code>gobuf</code>ç»“æ„ä¸­çš„å­—æ®µæ¸…é›¶ã€‚</li><li>å‡†å¤‡è·³è½¬åˆ°æ–°çš„ç¨‹åºè®¡æ•°å™¨ä½ç½®ï¼šä» <code>gobuf</code>ä¸­åŠ è½½æ–°çš„ç¨‹åºè®¡æ•°å™¨åœ°å€ï¼ˆ<code>gobuf_pc(R5)</code>ï¼‰åˆ°<code>R6</code>ã€‚</li><li>è·³è½¬æ‰§è¡Œï¼šé€šè¿‡ <code>B (R6)</code>è·³è½¬åˆ°æ–°çš„ç¨‹åºè®¡æ•°å™¨åœ°å€ï¼Œç»§ç»­æ‰§è¡Œæ–° <code>goroutine</code>çš„ä»£ç ã€‚</li></ul></li></ol><p>è¿™æ®µæ±‡ç¼–ä»£ç æ˜¯ Go è¿è¡Œæ—¶ä¸­å¤„ç† <code>goroutine</code>ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å…³é”®éƒ¨åˆ†ã€‚å®ƒç›´æ¥æ“ä½œå¤„ç†å™¨çš„å¯„å­˜å™¨å’Œæ ˆï¼Œä»¥å®ç°ä»ä¸€ä¸ª<code>goroutine</code> åˆ‡æ¢åˆ°å¦ä¸€ä¸ª <code>goroutine</code> çš„åŠŸèƒ½ã€‚</p><p>åœ¨ <code>execute()</code> ä¸­æ˜¯è¿™ä¹ˆè°ƒç”¨ <code>gogo()</code> çš„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">gogo(&amp;gp.sched)<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥å®Œæˆæ ˆçš„åˆ‡æ¢åä¼šä» <code>gp.sched</code>å¼€å§‹ï¼Œæ‰§è¡Œä»£ç ï¼Œå‰é¢æˆ‘ä»¬ä»‹ç»è¿‡ <code>sched</code> æ˜¯ä¸€ä¸ª<code>gobuf</code> ç»“æ„ä½“ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> gobuf <span class="hljs-keyword">struct</span> &#123;<br>sp   <span class="hljs-type">uintptr</span><br>pc   <span class="hljs-type">uintptr</span><br>g    guintptr<br>ctxt unsafe.Pointer<br>ret  <span class="hljs-type">uintptr</span><br>lr   <span class="hljs-type">uintptr</span><br>bp   <span class="hljs-type">uintptr</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥ä¼šä» pc å¤„å¼€å§‹æ‰§è¡Œä¸šåŠ¡ä»£ç ï¼Œå‰é¢åœ¨ <code>newproc()</code>çš„æ—¶å€™ï¼Œæˆ‘ä»¬æè¿‡ä¸€è¡Œä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">newg.sched.pc = abi.FuncPCABI0(goexit) + sys.PCQuantum<br></code></pre></td></tr></table></figure><p>è¿™è¡Œä»£ç çš„ä½œç”¨ï¼Œæ˜¯åœ¨åç¨‹åˆ›å»ºçš„æ—¶å€™æ’å…¥ä¸€ä¸ª <code>goexit</code>å‡½æ•°çš„åœ°å€ï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™ <code>g</code>åˆšåˆ›å»ºï¼Œæ‰€ä»¥å…¶å®å°±æ˜¯å¾€åç¨‹æ ˆé¡¶æ’å…¥äº† <code>goexit</code> çš„åœ°å€ã€‚æ‰€ä»¥å½“<code>g</code> æ‰§è¡Œå®Œä¸šåŠ¡ä»£ç åï¼Œå½“æ ˆä¸­å…ƒç´ ä¸æ–­å¼¹å‡ºåï¼Œæœ€ç»ˆå°±ä¼šå¼¹å‡º<code>goexit</code> çš„åœ°å€ï¼Œç„¶åæ‰§è¡Œ <code>goexit()</code>å‡½æ•°ï¼Œé€€å‡ºå½“å‰ <code>g</code>ï¼Œåˆ‡æ¢å› <code>g0</code>ã€‚</p><h3 id="goexit">4.9 goexit()</h3><p><code>goexit</code> å®šä¹‰åœ¨ <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/stubs.go">runtime/stubs.go</a>ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// goexit is the return stub at the top of every goroutine call stack.</span><br><span class="hljs-comment">// Each goroutine stack is constructed as if goexit called the</span><br><span class="hljs-comment">// goroutine&#x27;s entry point function, so that when the entry point</span><br><span class="hljs-comment">// function returns, it will return to goexit, which will call goexit1</span><br><span class="hljs-comment">// to perform the actual exit.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// This function must never be called directly. Call goexit1 instead.</span><br><span class="hljs-comment">// gentraceback assumes that goexit terminates the stack. A direct</span><br><span class="hljs-comment">// call on the stack will cause gentraceback to stop walking the stack</span><br><span class="hljs-comment">// prematurely and if there is leftover state it may panic.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">goexit</span><span class="hljs-params">(neverCallThisFunction)</span></span><br></code></pre></td></tr></table></figure><p>é€šè¿‡æ³¨é‡Šæˆ‘ä»¬å¯ä»¥å¾—åˆ° 2 ä¸ªä¿¡æ¯ï¼š</p><ul><li><code>goexit</code> çš„ä½äºæ¯ä¸ª goroutine è°ƒç”¨æ ˆçš„é¡¶éƒ¨ã€‚æ¯ä¸ªgoroutine çš„æ ˆè¢«æ„é€ å¾—å¥½åƒ <code>goexit</code> è°ƒç”¨äº† goroutineçš„å…¥å£å‡½æ•°ã€‚è¿™æ„å‘³ç€å½“å…¥å£å‡½æ•°è¿”å›æ—¶ï¼Œå®ƒå®é™…ä¸Šè¿”å›åˆ°<code>goexit</code>ã€‚</li><li>ä¸è¦ç›´æ¥è°ƒç”¨ <code>goexit</code>ï¼Œåº”è¯¥è°ƒç”¨<code>goexit1</code>ã€‚</li></ul><p><code>goexit1</code> ä½äº <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/proc.go">runtime/proc.go</a>ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Finishes execution of the current goroutine.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">goexit1</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> raceenabled &#123;<br>racegoend()<br>&#125;<br><span class="hljs-keyword">if</span> traceEnabled() &#123;<br>traceGoEnd()<br>&#125;<br>mcall(goexit0)<br>&#125;<br></code></pre></td></tr></table></figure><p>å¥½å§ï¼Œå®ƒè°ƒç”¨äº†<code>goexit0</code>ï¼ŒåŸæ¥è¿™æ‰æ˜¯çœŸæ­£çš„é€€å‡ºå…¥å£ï¼Œå®ƒä¹Ÿä½äº <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/proc.go">runtime/proc.go</a>ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">goexit0</span><span class="hljs-params">(gp *g)</span></span> &#123;<br>  <span class="hljs-comment">// è·å–å½“å‰çš„ M å’Œ P</span><br>mp := getg().m<br>pp := mp.p.ptr()<br><br>  <span class="hljs-comment">// ä¿®æ”¹ gp çš„çŠ¶æ€ä¸º _Gdeadï¼Œæ ‡å¿—å®ƒçš„ç»ˆæ­¢</span><br>casgstatus(gp, _Grunning, _Gdead)<br>  <span class="hljs-comment">// æ ‡è®° gc çš„æ ˆå†…å­˜æ˜¯å¯ä»¥è¿›è¡Œ gc æ‰«æçš„</span><br>gcController.addScannableStack(pp, -<span class="hljs-type">int64</span>(gp.stack.hi-gp.stack.lo))<br><span class="hljs-comment">// å¦‚æœ gp æ˜¯ç³»ç»Ÿ goroutineï¼Œåˆ™å°†ç³»ç»Ÿ goroutine çš„è®¡æ•°å‡å°‘</span><br>  <span class="hljs-keyword">if</span> isSystemGoroutine(gp, <span class="hljs-literal">false</span>) &#123;<br>sched.ngsys.Add(<span class="hljs-number">-1</span>)<br>&#125;<br>  <span class="hljs-comment">// æ¸…ç† gp çš„çŠ¶æ€</span><br>gp.m = <span class="hljs-literal">nil</span><br>locked := gp.lockedm != <span class="hljs-number">0</span><br>gp.lockedm = <span class="hljs-number">0</span><br>mp.lockedg = <span class="hljs-number">0</span><br>gp.preemptStop = <span class="hljs-literal">false</span><br>gp.paniconfault = <span class="hljs-literal">false</span><br>gp._defer = <span class="hljs-literal">nil</span> <br>gp._panic = <span class="hljs-literal">nil</span><br>gp.writebuf = <span class="hljs-literal">nil</span><br>gp.waitreason = waitReasonZero<br>gp.param = <span class="hljs-literal">nil</span><br>gp.labels = <span class="hljs-literal">nil</span><br>gp.timer = <span class="hljs-literal">nil</span><br><br>  <span class="hljs-comment">// å¦‚æœå¯ç”¨äº†åƒåœ¾å›æ”¶ï¼ˆGCï¼‰å¹¶ä¸” gp.gcAssistBytes å¤§äº 0ï¼Œ</span><br>  <span class="hljs-comment">// åˆ™å°†è¾…åŠ©ä¿¡ç”¨å½’è¿˜ç»™å…¨å±€æ± ã€‚è¿™æœ‰åŠ©äºæ›´å¥½åœ°æ§åˆ¶åƒåœ¾å›æ”¶è¿›ç¨‹ã€‚</span><br><span class="hljs-keyword">if</span> gcBlackenEnabled != <span class="hljs-number">0</span> &amp;&amp; gp.gcAssistBytes &gt; <span class="hljs-number">0</span> &#123;<br>assistWorkPerByte := gcController.assistWorkPerByte.Load()<br>scanCredit := <span class="hljs-type">int64</span>(assistWorkPerByte * <span class="hljs-type">float64</span>(gp.gcAssistBytes))<br>gcController.bgScanCredit.Add(scanCredit)<br>gp.gcAssistBytes = <span class="hljs-number">0</span><br>&#125;<br><br>  <span class="hljs-comment">// å°†å½“å‰ g ä» P çš„è¿è¡Œé˜Ÿåˆ—ä¸­ç§»é™¤</span><br>dropg()<br><br>  <span class="hljs-comment">// WebAssembly å¹³å°ç‰¹æ®Šå¤„ç†</span><br><span class="hljs-keyword">if</span> GOARCH == <span class="hljs-string">&quot;wasm&quot;</span> &#123; <br>gfput(pp, gp)<br>schedule() <br>&#125;<br><br>  <span class="hljs-comment">// å°† gp æ”¾å›å¤„ç†å™¨çš„å¯ç”¨é˜Ÿåˆ—ä¸­ï¼Œè¿™æ ·å¯ä»¥å¤ç”¨ g</span><br>gfput(pp, gp)<br><br>  <span class="hljs-comment">// å¦‚æœ goroutine è¢«ç»‘å®šåˆ°å½“å‰çº¿ç¨‹ä¸Šï¼Œ</span><br>  <span class="hljs-comment">// é‚£å¯èƒ½æ˜¯åœ¨åšç³»ç»Ÿè°ƒç”¨ï¼Œcgo è°ƒç”¨æˆ–å…¶ä»–ç‰¹æ®Šä»»åŠ¡ï¼Œ</span><br>  <span class="hljs-comment">// é‚£ä¹ˆå°±éœ€è¦åˆ‡åˆ° g0ï¼Œè®© g0 æ¥å®Œæˆåé¢çš„è°ƒåº¦ã€‚</span><br>  <span class="hljs-keyword">if</span> locked &#123;<br><span class="hljs-comment">// å¦‚æœ goroutine åœ¨ç»ˆæ­¢å‰æ›¾é”å®šå½“å‰çº¿ç¨‹ï¼Œ</span><br>    <span class="hljs-comment">// åˆ™æ ¹æ®ä¸åŒçš„æ“ä½œç³»ç»Ÿæ‰§è¡Œä¸åŒçš„å¤„ç†ã€‚</span><br>    <span class="hljs-comment">// åœ¨å¤§å¤šæ•°æ“ä½œç³»ç»Ÿä¸Šï¼Œä¼šè·³è½¬åˆ° mstart å‡½æ•°ï¼Œé‡Šæ”¾ P å¹¶é€€å‡ºçº¿ç¨‹ã€‚</span><br>    <span class="hljs-comment">// ä½†åœ¨ Plan 9 æ“ä½œç³»ç»Ÿä¸Šï¼Œä¼šæ¸…é™¤ lockedExtã€‚</span><br><span class="hljs-keyword">if</span> GOOS != <span class="hljs-string">&quot;plan9&quot;</span> &#123; <span class="hljs-comment">// See golang.org/issue/22227.</span><br>gogo(&amp;mp.g0.sched)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>mp.lockedExt = <span class="hljs-number">0</span><br>&#125;<br>&#125;<br>  <br>  <span class="hljs-comment">// ç»§ç»­è°ƒåº¦</span><br>  <span class="hljs-comment">// å¦‚æœæ‰§è¡Œäº† gogoï¼Œé‚£å°±æ˜¯ g0 åœ¨è°ƒåº¦ã€‚</span><br>  <span class="hljs-comment">// å¦‚æœæ²¡æœ‰æ‰§è¡Œ gogoï¼Œé‚£å°±æ˜¯ gp åœ¨è°ƒåº¦ã€‚</span><br>schedule()<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œæˆ‘ä»¬å°±å®Œæˆäº†å¯¹ GPM è°ƒåº¦å¾ªç¯çš„å…¨è¿‡ç¨‹æºç åˆ†æäº†ï¼Œä½ å¯ä»¥å›åˆ° <ahref="##4.%20è°ƒåº¦è¿‡ç¨‹%20schedule()">4. è°ƒåº¦è¿‡ç¨‹ schedule()</a>çœ‹ä¸€ä¸‹æˆ‘æ€»ç»“çš„é‚£å¼ å›¾ï¼Œè¿™å›ä½ åº”è¯¥ä¼šæœ‰æ›´åŠ æ·±å…¥çš„ç†è§£äº†ã€‚</p><h2 id="åç¨‹åˆ‡æ¢">5. åç¨‹åˆ‡æ¢</h2><p>å¦‚æœè¦ä¸€ä¸ªåç¨‹è¦ä¸€ç›´åˆ°æ‰§è¡Œå®Œæ¯•æ‰é€€å‡ºçš„è¯ï¼Œé‚£å¾ˆå¯èƒ½ä¼šé€ æˆå…¶ä»–åç¨‹é¥¥é¥¿çš„é—®é¢˜ã€‚æ‰€ä»¥Goå…¶å®ä¼šåœ¨ä¸€äº›ç‰¹æ®Šçš„æ—¶æœºå¯¹åç¨‹è¿›è¡Œåˆ‡æ¢ï¼Œè¿™ä¸ªè¿‡ç¨‹æœ‰æŠ¢å å¼è°ƒåº¦ï¼Œä¹Ÿæœ‰åä½œå¼çš„è°ƒåº¦ã€‚</p><p>åç¨‹åˆ‡æ¢çš„æ—¶å€™ï¼Œæœ€æ ¸å¿ƒçš„å°±æ˜¯è¦ä¿å­˜å½“å‰åç¨‹çš„ç°åœºï¼Œä»¥æ–¹ä¾¿å›åˆ°è¯¥åç¨‹çš„æ—¶å€™ç»§ç»­æ‰§è¡Œå‰©ä¸‹çš„å†…å®¹ã€‚å¤§è‡´è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/e6c9d24egy1h57vi6wrdqj21ho0sqjtn.jpg"alt="Go åç¨‹åˆ‡æ¢" /><figcaption aria-hidden="true">Go åç¨‹åˆ‡æ¢</figcaption></figure><p>æœ‰å“ªäº›æ—¶æœºä¼šè§¦å‘åˆ‡æ¢å‘¢ï¼Œè¿™é‡Œæˆ‘ç›´æ¥ç»™å‡ºç»“è®ºï¼š</p><p>åŸºäºåä½œçš„æŠ¢å å¼è°ƒåº¦</p><ul><li>ä¸»åŠ¨æŒ‚èµ·ï¼š<code>runtime.gopark()</code></li><li>ç³»ç»Ÿè°ƒç”¨ç»“æŸæ—¶ï¼š<code>exitsyscall()</code></li><li>å‡½æ•°è·³è½¬æ—¶ï¼š<code>morestack()</code></li></ul><p>åŸºäºä¿¡å·çš„æŠ¢å å¼è°ƒåº¦</p><ul><li>ä¿¡å·è°ƒåº¦ï¼š<code>doSigPreempt()</code></li></ul><h3 id="ä¸»åŠ¨æŒ‚èµ·-runtime.gopack">5.1 ä¸»åŠ¨æŒ‚èµ· runtime.gopack()</h3><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/e6c9d24egy1h57vq4flf5j21j20s4jto.jpg"alt="gopack åç¨‹åˆ‡æ¢" /><figcaption aria-hidden="true">gopack åç¨‹åˆ‡æ¢</figcaption></figure><p>è¿™ä¸ªå‡½æ•°ä½äº <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/proc.go">runtime/proc.go</a>ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">gopark</span><span class="hljs-params">(unlockf <span class="hljs-keyword">func</span>(*g, unsafe.Pointer)</span></span> <span class="hljs-type">bool</span>, lock unsafe.Pointer, reason waitReason, traceReason traceBlockReason, traceskip <span class="hljs-type">int</span>) &#123;<br><span class="hljs-keyword">if</span> reason != waitReasonSleep &#123;<br>checkTimeouts() <br>&#125;<br>mp := acquirem()<br>gp := mp.curg<br>status := readgstatus(gp)<br><span class="hljs-keyword">if</span> status != _Grunning &amp;&amp; status != _Gscanrunning &#123;<br>throw(<span class="hljs-string">&quot;gopark: bad g status&quot;</span>)<br>&#125;<br>mp.waitlock = lock<br>mp.waitunlockf = unlockf<br>gp.waitreason = reason<br>mp.waitTraceBlockReason = traceReason<br>mp.waitTraceSkip = traceskip<br>releasem(mp)<br>mcall(park_m)<br>&#125;<br></code></pre></td></tr></table></figure><p><code>gopark</code> å‡½æ•°çš„ä¸»è¦ç›®çš„æ˜¯ä½¿ Gè¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œç­‰å¾…è¢«å”¤é†’ã€‚</p><p>æœ€åå®ƒè°ƒç”¨äº† <code>mcall()</code>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// mcall switches from the g to the g0 stack and invokes fn(g)</span><br><span class="hljs-comment">// mcall åˆ‡æ¢åˆ° g0ï¼Œå¹¶æ‰§è¡Œ fnã€‚</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">mcall</span><span class="hljs-params">(fn <span class="hljs-keyword">func</span>(*g)</span></span>)<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥è¿™é‡Œåˆ‡æ¢å› <code>g0</code>ï¼Œå¹¶æ‰§è¡Œäº† <code>pack_m</code>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">park_m</span><span class="hljs-params">(gp *g)</span></span> &#123;<br>...<br>schedule()<br>&#125;<br></code></pre></td></tr></table></figure><p><code>pack_m()</code> å…¶å®å°±æ˜¯è°ƒç”¨äº† <code>schedule()</code>å»è¿›è¡Œä¸‹ä¸€è½®è°ƒåº¦ï¼Œè¿™å°±å®Œæˆäº†åç¨‹çš„åˆ‡æ¢ã€‚</p><p>å½“åç¨‹è¢«é˜»å¡çš„æ—¶å€™ï¼Œå°±ä¼šå»è°ƒç”¨ <code>runtime.gopark()</code> ä¸»åŠ¨è®©å‡ºCPUï¼Œåˆ‡å› <code>g0</code>ï¼Œç­‰å¾…è¢«å”¤é†’ï¼Œä»¥æ­¤ä¿è¯æœ€å¤§åŒ–åˆ©ç”¨ CPUèµ„æºã€‚æ¯”å¦‚ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š</p><ul><li>ä¼‘çœ </li><li>channel é€šé“é˜»å¡</li><li>ç½‘ç»œ I/O é˜»å¡</li><li>å› ä¸ºæ‰§è¡Œåƒåœ¾å›æ”¶è€Œæš‚åœ</li></ul><h3 id="ç³»ç»Ÿè°ƒç”¨ç»“æŸæ—¶-exitsyscall">5.2 ç³»ç»Ÿè°ƒç”¨ç»“æŸæ—¶exitsyscall()</h3><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/e6c9d24egy1h57vx0tfayj21g60r4tb4.jpg"alt="exitsyscall åç¨‹åˆ‡æ¢" /><figcaption aria-hidden="true">exitsyscall åç¨‹åˆ‡æ¢</figcaption></figure><p>Go é€šè¿‡ <code>entersyscall()</code> è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œå®Œäº‹åä¼šæ‰§è¡Œ<code>exitsyscall()</code>ï¼Œå®ƒä¹Ÿä½äº <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/proc.go">runtime/proc.go</a>ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">exitsyscall</span><span class="hljs-params">()</span></span> &#123;<br>...<br>mcall(exitsyscall0)<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶å®å®ƒæœ€ç»ˆä¹Ÿæ˜¯è°ƒç”¨ <code>mcall()</code> åˆ‡æ¢åˆ° <code>g0</code>ï¼Œæˆ‘ä»¬ä¸éš¾çŒœå‡ºï¼Œå®ƒè¿™é‡Œè®© <code>g0</code> å»æ‰§è¡Œ <code>exitsyscall0</code>å‡½æ•°ï¼Œåšå®Œç³»ç»Ÿè°ƒç”¨çš„å–„ååï¼Œè‚¯å®šè¿˜æ˜¯ä¼šæ‰§è¡Œ <code>schedule()</code>å‡½æ•°è¿›è¡Œåç¨‹è°ƒåº¦ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">exitsyscall0</span><span class="hljs-params">(gp *g)</span></span> &#123;<br>...<br>schedule()<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å‡½æ•°è·³è½¬æ—¶-morestack">5.3 å‡½æ•°è·³è½¬æ—¶ morestack()</h3><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/e6c9d24egy1h57w74gg19j21iq0smwgs.jpg"alt="morestack åç¨‹åˆ‡æ¢" /><figcaption aria-hidden="true">morestack åç¨‹åˆ‡æ¢</figcaption></figure><p>å› ä¸ºå‡½æ•°è·³è½¬æ„å‘³ç€â€œå‹æ ˆâ€ï¼Œå‡½æ•°è·³è½¬æ—¶éƒ½ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œå®ƒçš„æœ¬æ„åœ¨äºæ£€æŸ¥å½“å‰åç¨‹æ ˆç©ºé—´æ˜¯å¦æœ‰è¶³å¤Ÿå†…å­˜ï¼Œå¦‚æœä¸å¤Ÿå°±è¦æ‰©å¤§è¯¥æ ˆç©ºé—´ã€‚</p><p>ä¸ºäº†è®©æ¯ä¸ªåç¨‹éƒ½æœ‰æ‰§è¡Œçš„æœºä¼šï¼Œå¹¶ä¸”æœ€å¤§åŒ–åˆ©ç”¨ CPU èµ„æºï¼ŒGoè¯­è¨€åœ¨åˆå§‹åŒ–æ—¶ä¼šå¯åŠ¨ä¸€ä¸ªç‰¹æ®Šçš„çº¿ç¨‹æ¥æ‰§è¡Œç³»ç»Ÿç›‘æ§ä»»åŠ¡ï¼Œç³»ç»Ÿç›‘æ§åœ¨ä¸€ä¸ªç‹¬ç«‹çš„M ä¸Šè¿è¡Œï¼Œä¸ç”¨ç»‘å®šé€»è¾‘å¤„ç†å™¨ Pã€‚å½“ç³»ç»Ÿç›‘æ§åˆ°åç¨‹è¿è¡Œè¶…è¿‡<code>10ms</code>ï¼Œå°±å°† <code>g.stackguard0</code> ç½®ä¸º<code>stackPreempt</code>ï¼ˆè¯¥å€¼æ˜¯ä¸€ä¸ªæŠ¢å æ ‡å¿—ï¼‰ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">const</span> forcePreemptNS = <span class="hljs-number">10</span> * <span class="hljs-number">1000</span> * <span class="hljs-number">1000</span> <span class="hljs-comment">// 10ms</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">retake</span><span class="hljs-params">(now <span class="hljs-type">int64</span>)</span></span> <span class="hljs-type">uint32</span> &#123;<br><span class="hljs-comment">// éå†æ‰€æœ‰çš„ P</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(allp); i++ &#123;<br>pp := allp[i]<br>pd := &amp;pp.sysmontick<br>s := pp.status<br>sysretake := <span class="hljs-literal">false</span><br><span class="hljs-keyword">if</span> s == _Prunning || s == _Psyscall &#123;<br>t := <span class="hljs-type">int64</span>(pp.schedtick)<br><span class="hljs-keyword">if</span> <span class="hljs-type">int64</span>(pd.schedtick) != t &#123;<br>pd.schedtick = <span class="hljs-type">uint32</span>(t)<br>pd.schedwhen = now<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> pd.schedwhen+forcePreemptNS &lt;= now &#123;<br>        <span class="hljs-comment">// å¦‚æœ G è¿è¡Œæ—¶é—´è¿‡é•¿ï¼Œè¶…è¿‡äº† forcePreemptNS(10ms)ï¼Œ</span><br>        <span class="hljs-comment">// åˆ™æ ‡è®°æŠ¢å </span><br>preemptone(pp)<br>sysretake = <span class="hljs-literal">true</span><br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> s == _Psyscall &#123;<br>      <span class="hljs-comment">// å¦‚æœæ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œä¸”å·²ç»è¶…è¿‡äº†ä¸€ä¸ªç³»ç»Ÿç›‘æ§çš„ tick(20us)ï¼Œ</span><br>      <span class="hljs-comment">// åˆ™ä»ç³»ç»Ÿè°ƒç”¨ä¸­æŠ¢å  pã€‚</span><br>      t := <span class="hljs-type">int64</span>(pp.syscalltick)<br><span class="hljs-keyword">if</span> !sysretake &amp;&amp; <span class="hljs-type">int64</span>(pd.syscalltick) != t &#123;<br>pd.syscalltick = <span class="hljs-type">uint32</span>(t)<br>pd.syscallwhen = now<br><span class="hljs-keyword">continue</span><br>&#125;<br>...<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// æ ‡è®°æŠ¢å </span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">preemptone</span><span class="hljs-params">(pp *p)</span></span> <span class="hljs-type">bool</span> &#123;<br>mp := pp.m.ptr()<br>gp := mp.curg<br>gp.preempt = <span class="hljs-literal">true</span><br>gp.stackguard0 = stackPreempt<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å·§çš„å°±æ˜¯ï¼ŒGo è®¾è®¡è€…ï¼Œè®©ç¨‹åºåœ¨æ‰§è¡Œ <code>morestack()</code>å‡½æ•°æ—¶é¡ºä¾¿åˆ¤æ–­ä¸€ä¸‹ <code>g</code> ä¸­çš„ <code>stackguard</code>æ˜¯å¦å·²ç»è¢«ç½®ä¸ºæŠ¢å  <code>stackPreempt</code>ï¼Œå¦‚æœçš„ç¡®è¢«æ ‡è®°æŠ¢å ï¼Œå°±å›åˆ°<code>schedule()</code> æ–¹æ³•ï¼Œå¹¶å°†å½“å‰åç¨‹æ”¾å›é˜Ÿåˆ—ä¸­ã€‚</p><p><code>morestack</code> æ˜¯æ±‡ç¼–å®ç°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs assembly">TEXT runtimeÂ·morestack(SB),NOSPLIT|NOFRAME,$0-0<br>...<br>BLruntimeÂ·newstack(SB)<br></code></pre></td></tr></table></figure><p>å®ƒæœ€ç»ˆä¼šè°ƒç”¨ <code>newstack()</code>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newstack</span><span class="hljs-params">()</span></span> &#123;<br>  thisg := getg()<br>  gp := thisg.m.curg<br>  <span class="hljs-comment">// 1. åˆ¤æ–­ gp.stackguard0 æ˜¯å¦è¢«æ ‡è®°ä¸ºæŠ¢å </span><br>  stackguard0 := atomic.Loaduintptr(&amp;gp.stackguard0)<br>preempt := stackguard0 == stackPreempt<br>  <span class="hljs-comment">// 2. å¦‚æœè¢«æ ‡è®°ä½æŠ¢å ï¼Œè°ƒç”¨ gopreempt_m()</span><br>  <span class="hljs-keyword">if</span> preempt &#123;<br><span class="hljs-comment">// 3. æœ€ç»ˆä¼šå»è°ƒç”¨  schedule() å»è°ƒæ–°çš„åç¨‹æ‰§è¡Œ</span><br>gopreempt_m(gp) <span class="hljs-comment">// never return</span><br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">gopreempt_m</span><span class="hljs-params">(gp *g)</span></span> &#123;<br><span class="hljs-keyword">if</span> traceEnabled() &#123;<br>traceGoPreempt()<br>&#125;<br>goschedImpl(gp)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">goschedImpl</span><span class="hljs-params">(gp *g)</span></span> &#123;<br>...<br>schedule()<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ä¿¡å·è°ƒåº¦-dosigpreempt">5.4 ä¿¡å·è°ƒåº¦ doSigPreempt()</h3><p>å½“ç¨‹åºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ—¢æ— æ³•ä¸»åŠ¨æŒ‚èµ·ï¼Œä¹Ÿä¸èƒ½è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œä¸”æ— æ³•è¿›è¡Œå‡½æ•°è°ƒç”¨æ—¶ï¼Œå°±å¯ä»¥ä½¿ç”¨ä¿¡å·æ¥è°ƒåº¦ã€‚</p><p>ä¿¡å·å…¶å®å°±æ˜¯çº¿ç¨‹ä¿¡å·ï¼Œåœ¨æ“ä½œç³»ç»Ÿä¸­æœ‰å¾ˆå¤šåŸºäºä¿¡å·çš„åº•å±‚é€šä¿¡æ–¹å¼ï¼ˆSIGPIPE/ SIGURG / SIGHUPï¼‰ï¼Œè€Œæˆ‘ä»¬çš„çº¿ç¨‹å¯ä»¥æ³¨å†Œå¯¹åº”ä¿¡å·çš„å¤„ç†å‡½æ•°ã€‚</p><p>Go ä¸­æ˜¯æ³¨å†Œäº† <code>SIGURG</code> ä¿¡å·çš„å¤„ç†å‡½æ•°<code>doSigPreempt()</code>ï¼Œåœ¨ GCå·¥ä½œæ—¶ï¼Œå‘ç›®æ ‡çº¿ç¨‹å‘é€ä¿¡å·ã€‚çº¿ç¨‹æ”¶åˆ°ä¿¡å·åï¼Œä¼šè§¦å‘è°ƒåº¦ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/e6c9d24egy1h57wecvgwdj21hk0ssgny.jpg"alt="doSigPreempt åç¨‹åˆ‡æ¢" /><figcaption aria-hidden="true">doSigPreempt åç¨‹åˆ‡æ¢</figcaption></figure><p><code>doSigPreempt</code> ä½äº <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/signal_unix.go">runtime.signal_unix.go</a>ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">doSigPreempt</span><span class="hljs-params">(gp *g, ctxt *sigctxt)</span></span> &#123;<br><span class="hljs-comment">// æ£€æŸ¥æ­¤ g æ˜¯å¦è¦è¢«æŠ¢å å¹¶ä¸”å®‰å…¨æŠ¢å </span><br><span class="hljs-keyword">if</span> wantAsyncPreempt(gp) &#123;<br><span class="hljs-keyword">if</span> ok, newpc := isAsyncSafePoint(gp, ctxt.sigpc(), ctxt.sigsp(), ctxt.siglr()); ok &#123;<br><span class="hljs-comment">// 2. è°ƒæ•´ç¨‹åºè®¡æ•°å™¨ PC å¹¶å¼‚æ­¥è°ƒç”¨ asyncPreempt</span><br>ctxt.pushCall(abi.FuncPCABI0(asyncPreempt), newpc)<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>asyncPreempt</code> çš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">asyncPreempt</span><span class="hljs-params">()</span></span><br><br><span class="hljs-comment">// </span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">asyncPreempt2</span><span class="hljs-params">()</span></span> &#123;<br>gp := getg()<br>gp.asyncSafePoint = <span class="hljs-literal">true</span><br>  <span class="hljs-comment">// </span><br><span class="hljs-keyword">if</span> gp.preemptStop &#123;<br>mcall(preemptPark)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>mcall(gopreempt_m)<br>&#125;<br>gp.asyncSafePoint = <span class="hljs-literal">false</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>asyncPreempt</code> æ˜¯æ±‡ç¼–å®ç°ï¼Œæœ€ç»ˆæ˜¯è°ƒçš„<code>asyncPreempt2</code>ï¼Œå®ƒä¼šè°ƒç”¨ <code>mcall</code> åˆ‡å›<code>g0</code>ï¼Œå¹¶æ‰§è¡Œ <code>preemptPark</code> æˆ–<code>gopreempt_m</code>ï¼Œ <code>gopreempt_m</code> å°±æ˜¯å‰é¢<code>morestack</code> æœ€åè°ƒçš„ï¼ä¸å‡ºæ„å¤–ï¼Œ<code>preemptPack</code>æœ€åè‚¯å®šè¿˜æ˜¯è°ƒçš„ <code>schedule()</code>ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">preemptPark</span><span class="hljs-params">(gp *g)</span></span> &#123;<br>...<br>schedule()<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="runtime.gosched">5.5 runtime.Gosched()</h3><p>åœ¨æˆ‘ä»¬å®é™…ç¼–ç¨‹ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡æ˜¾å¼è°ƒç”¨ <code>runtime.Gosched()</code>æ¥ä¸»åŠ¨è®©å‡º CPUï¼Œä¿ƒè¿› Go çš„ä¸‹ä¸€è½®è°ƒåº¦ï¼Œæˆ‘ä»¬æ¥çœ‹å®ƒçš„å…·ä½“å®ç°ï¼Œè‚¯å®šè¿˜æ˜¯è°ƒçš„<code>schedule()</code>ï¼Œæ²¡æœ‰æ„å¤–ï¼</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Gosched</span><span class="hljs-params">()</span></span> &#123;<br>checkTimeouts()<br>mcall(gosched_m)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">gosched_m</span><span class="hljs-params">(gp *g)</span></span> &#123;<br><span class="hljs-keyword">if</span> traceEnabled() &#123;<br>traceGoSched()<br>&#125;<br>goschedImpl(gp)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">goschedImpl</span><span class="hljs-params">(gp *g)</span></span> &#123;<br>status := readgstatus(gp)<br><span class="hljs-keyword">if</span> status&amp;^_Gscan != _Grunning &#123;<br>dumpgstatus(gp)<br>throw(<span class="hljs-string">&quot;bad g status&quot;</span>)<br>&#125;<br>casgstatus(gp, _Grunning, _Grunnable)<br>dropg()<br>lock(&amp;sched.lock)<br>globrunqput(gp)<br>unlock(&amp;sched.lock)<br><br>schedule()<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ€»ç»“">5.6 æ€»ç»“</h3><p>Go è¯­è¨€ä¸ºäº†ç¡®ä¿ P ä¸ä¼šå› ä¸º Gè¿è¡Œæ—¶é—´è¿‡é•¿æˆ–ç³»ç»Ÿè°ƒç”¨é˜»å¡æ—¶é—´è¿‡é•¿è€Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚å®ƒä¼šå°è¯•è¿›è¡Œåç¨‹åˆ‡æ¢ï¼Œä»¥ç¡®ä¿ä»»åŠ¡å¯ä»¥é€‚æ—¶åœ°è¢«åˆ†é…å’Œæ‰§è¡Œã€‚è¿™æœ‰åŠ©äºä¿æŒGoç¨‹åºçš„å¹¶å‘æ€§èƒ½å’Œå“åº”æ€§ã€‚è€Œåç¨‹åˆ‡æ¢çš„æ–¹å¼æœ‰åŸºäºåä½œçš„æŠ¢å å¼è°ƒåº¦ï¼ˆä¸»åŠ¨æŒ‚èµ·<code>runtime.gopark()</code>ï¼Œç³»ç»Ÿè°ƒç”¨ç»“æŸæ—¶<code>exitsyscall()</code>ï¼Œå‡½æ•°è·³è½¬æ—¶<code>morestack()</code>ï¼‰ï¼Œä¹Ÿæœ‰åŸºäºä¿¡å·çš„æŠ¢å å¼è°ƒåº¦<code>doSigPreempt()</code>ï¼Œä»–ä»¬éƒ½æ— ä¸€ä¾‹å¤–çš„æœ€ç»ˆè°ƒç”¨äº†<code>schedule()</code>ã€‚</p><p>æ‰€ä»¥æ€»ç»“ä¸‹æ¥å…¶å®è¿˜æ˜¯è¿™å¼ å›¾ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/e6c9d24egy1h57vi6wrdqj21ho0sqjtn.jpg"alt="Go åç¨‹åˆ‡æ¢" /><figcaption aria-hidden="true">Go åç¨‹åˆ‡æ¢</figcaption></figure><h1 id="gpm-çŠ¶æ€æµè½¬">Gã€Pã€M çŠ¶æ€æµè½¬</h1><p>ç»è¿‡æˆ‘ä»¬å‰é¢çš„åˆ†æï¼Œä½ å¯ä»¥è‡ªè¡Œæ•´ç† Gã€Pã€MçŠ¶æ€çš„æµè½¬ï¼Œè¿™é‡Œæˆ‘ç»™å‡ºå‡ å¼ å›¾ä¾›ä½ å‚è€ƒï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240126224853429.png"alt="Go åç¨‹ï¼ˆGï¼‰çŠ¶æ€è½¬æ¢å›¾" /><figcaption aria-hidden="true">Go åç¨‹ï¼ˆGï¼‰çŠ¶æ€è½¬æ¢å›¾</figcaption></figure><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240126225021035.png"alt="Go å¤„ç†å™¨ï¼ˆPï¼‰çŠ¶æ€è½¬æ¢å›¾" /><figcaption aria-hidden="true">Go å¤„ç†å™¨ï¼ˆPï¼‰çŠ¶æ€è½¬æ¢å›¾</figcaption></figure><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240126225849169.png"alt="Go Mï¼ˆæ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼‰çŠ¶æ€è½¬æ¢" /><figcaption aria-hidden="true">Go Mï¼ˆæ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼‰çŠ¶æ€è½¬æ¢</figcaption></figure><h1 id="æ€»ç»“-1">æ€»ç»“</h1><p>ä»¥ä¸Šä¾¿æ˜¯å¯¹ Go è¯­è¨€ GPM æ¨¡å‹çš„å…¨éƒ¨åˆ†äº«å•¦ï¼GPM æ¨¡å‹ä½¿å¾— Goè¯­è¨€èƒ½å¤Ÿå¹¶å‘æ‰§è¡Œæˆåƒä¸Šä¸‡ä¸ªåç¨‹ã€‚</p><p>ä¸ºäº†å‡å°‘çº¿ç¨‹â€œç›¸å¯¹æ˜‚è´µâ€çš„åˆ‡æ¢ä»£ä»·ï¼ŒGo å¼•å…¥äº† GPMï¼Œå°†å¤§é‡çš„ Goroutineåˆ†é…åˆ°å°‘é‡çš„ç³»ç»Ÿçº¿ç¨‹ä¸Šå»æ‰§è¡Œï¼Œå¹¶åˆ©ç”¨å¤šæ ¸å¹¶è¡Œï¼Œå®ç°æ›´å¼ºå¤§çš„å¹¶å‘ã€‚</p><p>ä¸ºäº†å‡å°å¹¶å‘å†²çªï¼ŒGo åœ¨å…¨å±€é˜Ÿåˆ—çš„åŸºç¡€ä¸Šå¼•å…¥äº†æœ¬åœ°é˜Ÿåˆ—ã€‚</p><p>ä¸ºäº†é¿å…åç¨‹é¥¥é¥¿ï¼ŒGo åˆå¼•å…¥äº†å¤šç§åç¨‹è°ƒåº¦çš„ç­–ç•¥ã€‚</p><p>ä¸ºäº†é¿å…åç¨‹é˜»å¡æµªè´¹ CPUï¼ŒGo å¼•å…¥äº†å¤šç§åç¨‹åˆ‡æ¢çš„æ–¹å¼ã€‚</p><p>Go è¯­è¨€è®¾è®¡è€…è¿›è¡Œäº†å¦‚æ­¤å¤æ‚çš„è°ƒåº¦å™¨å®ç°ï¼Œæœ€ç»ˆäº¤ä»˜ç»™ Gopherçš„ï¼Œä»…ä»…æ˜¯ä¸€ä¸ª <code>go</code>å…³é”®å­—è¿™ä¹ˆç®€å•ï¼ŒçœŸçš„æ˜¯å¤§é“è‡³ç®€ï¼Œè¿™ä¹Ÿæ˜¯å……åˆ†å°è¯äº†é‚£å¥è¯ï¼šâ€œGoä¸ºå¹¶å‘è€Œç”Ÿâ€ã€‚</p><p>å¸Œæœ›æœ¬æ–‡èƒ½å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œenjoy~ happy coding~</p><h1 id="å‚è€ƒ">å‚è€ƒ</h1><ul><li><a href="https://book.douban.com/subject/36403287/">æ·±å…¥ç†è§£ Goè¯­è¨€</a></li><li><a href="https://book.douban.com/subject/35556889/">Goè¯­è¨€åº•å±‚åŸç†å‰–æ</a></li><li><a href="https://coding.imooc.com/class/576.html">æ·±å…¥ Goåº•å±‚åŸç†</a></li><li>ChatGPT4</li></ul><h1 id="ä½œå›¾å·¥å…·">ä½œå›¾å·¥å…·</h1><ul><li><a href="https://excalidraw.com/">excalidraw</a></li><li><a href="https://whimsical.com/">whimsical</a></li></ul>]]></content>
    
    
    <summary type="html">æœ¬æ–‡åŸºäº Go1.21.0 ç‰ˆæœ¬è¯¦ç»†ä»‹ç»äº† Go è¯­è¨€çš„ GPM æ¨¡å‹ã€‚</summary>
    
    
    
    <category term="Go" scheme="https://hedon.top/categories/Go/"/>
    
    
    <category term="Go" scheme="https://hedon.top/tags/Go/"/>
    
  </entry>
  
  <entry>
    <title>Rust å®æˆ˜ä¸¨ç»˜åˆ¶æ›¼å¾·åšé›†</title>
    <link href="https://hedon.top/2024/01/17/rust-action-mandelbrot/"/>
    <id>https://hedon.top/2024/01/17/rust-action-mandelbrot/</id>
    <published>2024-01-17T14:39:05.000Z</published>
    <updated>2024-04-02T14:19:13.737Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ›¼å¾·åšé›†">æ›¼å¾·åšé›†</h1><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/2560px-Mandelset_hires-20240118170914026.png"alt="æ›¼å¾·åšé›†" /><figcaption aria-hidden="true">æ›¼å¾·åšé›†</figcaption></figure><p>æ›¼å¾·åšé›†å…¶å®æ˜¯ä¸€ä¸ªâ€œæ²¡ä»€ä¹ˆç”¨â€çš„å‘ç°ã€‚</p><p>æ›¼å¾·åšé›†ï¼ˆMandelbrotSetï¼‰æ˜¯ä¸€ç§åœ¨å¤å¹³é¢ä¸Šå½¢æˆç‹¬ç‰¹ä¸”å¤æ‚å›¾æ¡ˆçš„ç‚¹çš„é›†åˆã€‚è¿™ä¸ªé›†åˆæ˜¯ä»¥æ•°å­¦å®¶æœ¬åÂ·æ›¼å¾·åšï¼ˆBenoitMandelbrotï¼‰çš„åå­—å‘½åçš„ï¼Œä»–åœ¨ç ”ç©¶å¤æ‚ç»“æ„å’Œæ··æ²Œç†è®ºæ—¶å‘ç°äº†è¿™ä¸ªé›†åˆã€‚æ›¼å¾·åšé›†æ˜¯åˆ†å½¢å‡ ä½•çš„ä¸€ä¸ªç»å…¸ä¾‹å­ï¼Œæ˜¾ç¤ºäº†ä¸€ä¸ªç®€å•çš„æ•°å­¦å…¬å¼å¦‚ä½•èƒ½äº§ç”Ÿæ— é™å¤æ‚å’Œç¾ä¸½çš„å›¾æ¡ˆã€‚</p><p>æ›¼å¾·åšé›†çš„å®šä¹‰ç›¸å¯¹ç®€å•ã€‚å¯¹äºæ¯ä¸€ä¸ªå¤æ•° <spanclass="math inline">\(c\)</span>ï¼Œæˆ‘ä»¬è€ƒè™‘ä»¥ä¸‹è¿­ä»£åºåˆ—ï¼š <spanclass="math display">\[Z_{n+1} = z_n^2 + c \;\;\\ å…¶ä¸­ \;\; (z_0 = 0)\]</span> <strong>æ›¼å¾·åšé›†åˆç”±é‚£äº›ä½¿å¾—ä¸Šè¿°åºåˆ—ä¸è¶‹äºæ— é™å¤§çš„å¤æ•° <spanclass="math inline">\(c\)</span>ç»„æˆ</strong>ã€‚åœ¨å¤å¹³é¢ä¸Šï¼Œè¿™äº›ç‚¹å½¢æˆäº†ä¸€ç§ç‹¬ç‰¹çš„å›¾æ¡ˆï¼Œé€šå¸¸ä»¥ä¸€ç§ç¾ä¸½ä¸”è‰ºæœ¯çš„æ–¹å¼å‘ˆç°ã€‚è¿™ä¸ªå›¾æ¡ˆçš„è¾¹ç•Œéå¸¸å¤æ‚ï¼ŒåŒ…å«äº†æ— é™çš„ç»†èŠ‚å’Œè‡ªç›¸ä¼¼çš„ç»“æ„ã€‚è¿™æ„å‘³ç€æ— è®ºä½ æ”¾å¤§å›¾æ¡ˆçš„å“ªä¸€éƒ¨åˆ†ï¼Œä½ éƒ½ä¼šå‘ç°è¶Šæ¥è¶Šç²¾ç»†çš„ç»“æ„ï¼Œè¿™äº›ç»“æ„åœ¨å½¢å¼ä¸Šä¸æ•´ä½“å›¾æ¡ˆç›¸ä¼¼ã€‚</p><p>æ›¼å¾·åšé›†åˆä¸ä»…åœ¨æ•°å­¦ä¸Šæœ‰æ„ä¹‰ï¼Œä¹Ÿåœ¨è‰ºæœ¯å’Œç§‘å­¦ä¸­æœ‰å¹¿æ³›çš„åº”ç”¨ï¼Œå°¤å…¶æ˜¯åœ¨ç ”ç©¶æ··æ²Œç†è®ºå’Œå¤æ‚ç³»ç»Ÿæ—¶ã€‚</p><p>å…·ä½“å¯ä»¥çœ‹</p><ul><li><ahref="https://zh.wikipedia.org/wiki/%E6%9B%BC%E5%BE%B7%E5%8D%9A%E9%9B%86%E5%90%88">ç»´åŸºç™¾ç§‘-æ›¼å¾·åšé›†</a></li><li><a href="https://www.bilibili.com/video/BV1kA411T7at">bilibili -2000äº¿å€æ”¾å¤§æ›¼å¾·åšé›†</a></li></ul><h1 id="ç›®æ ‡åŠŸèƒ½">ç›®æ ‡åŠŸèƒ½</h1><p>æœ€ç»ˆæˆ‘ä»¬å°†å®ç°ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œå®ƒä¼šæ ¹æ®æˆ‘ä»¬è¾“å…¥çš„å‚æ•°ç”Ÿæˆæ›¼å¾·åšé›†å›¾ï¼Œä½¿ç”¨å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./mandelbrot &lt;FILE&gt; &lt;PIXELS&gt; &lt;UPPERLEFT&gt; &lt;LOWERRIGHT&gt;<br></code></pre></td></tr></table></figure><ul><li><code>FILE</code>: æ›¼å¾·åšé›†å›¾ç”Ÿæˆçš„å›¾ç‰‡è·¯ç»ã€‚</li><li><code>PIXELS</code>: å›¾ç‰‡åˆ†è¾¨ç‡ï¼Œå¦‚ <code>4x3</code>ã€‚</li><li><code>UPPERLEFT</code>: æŒ‡å®šåœ¨å¤å¹³é¢ä¸­å›¾ç‰‡è¦†ç›–çš„å·¦ä¸Šè§’ï¼Œå¦‚<code>4.0,3.0</code>ã€‚</li><li><code>LOWERRIGHT</code>: åˆ¶å®šåœ¨å¤å¹³é¢ä¸­å›¾ç‰‡è¦†ç›–çš„å³ä¸‹è§’ã€‚</li></ul><p>æ‰€ä»¥æˆ‘ä»¬æœ€ç»ˆä¼šæ ¹æ®æŒ‡å®šçš„å›¾ç‰‡èŒƒå›´ï¼Œæˆªå– <code>PIXELS</code>åˆ†è¾¨ç‡å¤§å°çš„æ›¼å¾·åšé›†å›¾ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240118171322832.png"alt="æˆªå–æ›¼å¾·åšé›†ç¤ºæ„å›¾" /><figcaption aria-hidden="true">æˆªå–æ›¼å¾·åšé›†ç¤ºæ„å›¾</figcaption></figure><p>åŸºäºä»¥ä¸Šç›®æ ‡ï¼Œæˆ‘ä»¬æ‹†åˆ†æˆå‡ ä¸ªé—®é¢˜ï¼š</p><ol type="1"><li>å¦‚ä½•è¡¨ç¤ºå¤æ•°ï¼Ÿ</li><li>å¦‚ä½•è§£æåˆ†è¾¨ç‡å’Œåæ ‡ï¼Ÿ</li><li>å¦‚ä½•å°†å›¾ä¸Šåƒç´ æ˜ å°„åˆ°å¤æ•°ï¼Ÿ</li><li>å¦‚ä½•ç”Ÿæˆæ›¼å¾·åšé›†å›¾ï¼Ÿå³å¦‚ä½•æ‰¾åˆ°é‚£äº›ç¬¦åˆæ›¼å¾·åšé›†çš„ç‚¹ï¼Œå¹¶å°†å…¶è¿›è¡Œç€è‰²æ ‡æ³¨ï¼Ÿ</li><li>å¦‚ä½•å†™å…¥å›¾ç‰‡æ–‡ä»¶ï¼Ÿ</li><li>å¦‚ä½•æ¸²æŸ“æ›¼å¾·åšé›†ï¼Ÿ</li><li>å¦‚ä½•è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Ÿ</li><li>å¦‚ä½•å¹¶å‘å†™å…¥å›¾ç‰‡æ–‡ä»¶ï¼Ÿ</li></ol><h1 id="èƒ½å­¦åˆ°ä»€ä¹ˆ">èƒ½å­¦åˆ°ä»€ä¹ˆ</h1><ol type="1"><li>æ›¼å¾·åšé›†æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>Rust ä¸­çš„å¤æ•°çš„åŸç†ä¸åº”ç”¨ã€‚</li><li>Rust æ³›å‹åˆæ¢ã€‚</li><li>Rust ä¸­çš„ Option å’Œ Result åˆæ¢ã€‚</li><li>Rust å¹¶å‘åˆæ¢ã€‚</li><li>Rust ä¸­å¦‚ä½•è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Ÿ</li><li>Rust å¦‚ä½•å†™å…¥å›¾åƒæ–‡ä»¶ï¼Ÿ</li><li>Rust å¦‚ä½•å†™æµ‹è¯•ç”¨ä¾‹ï¼Ÿ</li><li>Rust å®ç”¨ crate<code>num</code>ã€<code>image</code>ã€<code>crossbeam</code>ã€‚</li></ol><h1 id="ç‰ˆæœ¬">ç‰ˆæœ¬</h1><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs toml"><span class="hljs-section">[package]</span><br><span class="hljs-attr">name</span> = <span class="hljs-string">&quot;mandelbrot&quot;</span><br><span class="hljs-attr">version</span> = <span class="hljs-string">&quot;0.1.0&quot;</span><br><span class="hljs-attr">edition</span> = <span class="hljs-string">&quot;2021&quot;</span><br><br><span class="hljs-section">[dependencies]</span><br><span class="hljs-attr">image</span> = &#123;version = <span class="hljs-string">&quot;0.13.0&quot;</span>, features = [<span class="hljs-string">&quot;default&quot;</span>, <span class="hljs-string">&quot;png&quot;</span>]&#125;<br><span class="hljs-attr">num</span> = <span class="hljs-string">&quot;0.4.1&quot;</span><br><span class="hljs-attr">crossbeam</span> = <span class="hljs-string">&quot;0.8&quot;</span><br><span class="hljs-attr">rayon</span> = <span class="hljs-string">&quot;1.10.0&quot;</span><br></code></pre></td></tr></table></figure><p>å®Œæ•´ä»£ç ï¼šhttps://github.com/hedon954/mandelbrot/blob/master/src/main.rs</p><h1 id="ç¼–ç å®ç°">ç¼–ç å®ç°</h1><h2 id="åˆ›å»ºé¡¹ç›®">0. åˆ›å»ºé¡¹ç›®</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo new mandelbrot<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> mandelbrot<br></code></pre></td></tr></table></figure><h2 id="å¤æ•°è¡¨ç¤º">1. å¤æ•°è¡¨ç¤º</h2><p>ä½¿ç”¨å¤æ•°ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥ä¸€ä¸ª creteï¼š<code>num</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo add num<br></code></pre></td></tr></table></figure><p>å…¶ä¸­å®šä¹‰äº†ä¸€ä¸ªå¤æ•°ç±»å‹ <code>Complex</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Complex</span>&lt;T&gt; &#123;<br>    <span class="hljs-comment">/// å¤æ•°çš„å®éƒ¨</span><br>    <span class="hljs-keyword">pub</span> re: T,<br>    <span class="hljs-comment">/// å¤æ•°çš„è™šéƒ¨</span><br>    <span class="hljs-keyword">pub</span> im: T,<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œ <code>T</code> æ˜¯ Rust ä¸­çš„æ³›å‹åŠŸèƒ½ï¼Œè¡¨ç¤ºä»»æ„ç±»å‹<code>T</code>ï¼Œç¡®å®šå¥½è¿™ä¸ªç»“æ„ä½“çš„ <code>T</code> çš„ç±»å‹åï¼Œå…¶ä¸­çš„å±æ€§<code>re</code> å’Œ <code>im</code> çš„ç±»å‹ä¹Ÿå°±éšä¹‹ç¡®å®šäº†ã€‚</p><h2 id="è§£æåˆ†è¾¨ç‡å’Œåæ ‡">2. è§£æåˆ†è¾¨ç‡å’Œåæ ‡</h2><ul><li>åˆ†è¾¨ç‡æ ¼å¼ä¸ºï¼š4000x3000</li><li>åæ ‡æ ¼å¼ä¸ºï¼š-1.0,2.0</li></ul><h3 id="è§£ææ•°å¯¹">2.1 è§£ææ•°å¯¹</h3><p>æˆ‘ä»¬è¦åšçš„å°±æ˜¯ï¼Œå°†åˆ†è¾¨ç‡æ‹†æˆ (4000,3000)ï¼Œå°†åæ ‡æ‹†ä¸º (-1.0,2.0)ã€‚è¿™é‡Œï¼š</p><ul><li>å¸¦è§£æçš„å…ƒç´  <code>s</code> æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²<code>&amp;str</code>ã€‚</li><li>åˆ†éš”ç¬¦ <code>separator</code> æ˜¯ä¸€ä¸ªå­—ç¬¦ <code>char</code>ã€‚</li><li>è¿”å›å€¼æ˜¯ä¸€ä¸ªå…ƒç»„ <code>(T, T)</code>ï¼Œå…¶ä¸­ <code>T</code> è¿™é‡Œå¯ä»¥æ˜¯u64/f32 ç­‰æ•°å­—ï¼Œå®ƒä»¬éƒ½éœ€è¦èƒ½ä»å­—ç¬¦ä¸²è½¬åŒ–è€Œæ¥ï¼Œå³<code>&lt;T:FromStr&gt;</code>ã€‚</li><li>å› ä¸ºè§£æå¯èƒ½å‡ºé”™ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ <code>Option</code> æ¥æ‰¿è½½ã€‚</li></ul><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">/// æŠŠå­—ç¬¦ä¸² `s`ï¼ˆå½¢å¦‚ `&quot;400Ã—600&quot;` æˆ– ``&quot;1.0,0.5&quot;ï¼‰è§£ææˆä¸€ä¸ªåæ ‡å¯¹</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// å…·ä½“æ¥è¯´ï¼Œ`s` åº”è¯¥å…·æœ‰&lt;left&gt;&lt;sep&gt;&lt;right&gt;çš„æ ¼å¼ï¼Œå…¶ä¸­&lt;sep&gt;æ˜¯ç”±`separator`</span><br><span class="hljs-comment">/// å‚æ•°ç»™å‡ºçš„å­—ç¬¦ï¼Œè€Œ&lt;left&gt;å’Œ&lt;right&gt;æ˜¯å¯ä»¥è¢« `T:from_str` è§£æçš„å­—ç¬¦ä¸²ã€‚</span><br><span class="hljs-comment">/// `separator` å¿…é¡»æ˜¯ ASCII å­—ç¬¦</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// å¦‚æœ `s` å…·æœ‰æ­£ç¡®çš„æ ¼å¼ï¼Œå°±è¿”å› `Some(x,y)`ï¼Œå¦åˆ™è¿”å› `None`</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">parse_pair</span>&lt;T: FromStr&gt;(s: &amp;<span class="hljs-type">str</span>, separator: <span class="hljs-type">char</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;(T, T)&gt; &#123;<br>    <span class="hljs-keyword">match</span> s.<span class="hljs-title function_ invoke__">find</span>(separator) &#123;<br>        <span class="hljs-literal">None</span> =&gt; <span class="hljs-literal">None</span>,<br>        <span class="hljs-title function_ invoke__">Some</span>(index) =&gt; <span class="hljs-keyword">match</span> (T::<span class="hljs-title function_ invoke__">from_str</span>(&amp;s[..index]), T::<span class="hljs-title function_ invoke__">from_str</span>(&amp;s[index + <span class="hljs-number">1</span>..])) &#123;<br>            (<span class="hljs-title function_ invoke__">Ok</span>(l), <span class="hljs-title function_ invoke__">Ok</span>(r)) =&gt; <span class="hljs-title function_ invoke__">Some</span>((l, r)),<br>            _ =&gt; <span class="hljs-literal">None</span>,<br>        &#125;,<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥å†™å‡ ä¸ªæµ‹è¯•ç”¨ä¾‹æ¥éªŒè¯ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„æ­£ç¡®æ€§ï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨åˆ°<code>#[test]</code> å’Œ <code>assert_eq!</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[test]</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">test_parse_pair</span>() &#123;<br>    <span class="hljs-built_in">assert_eq!</span>(parse_pair::&lt;<span class="hljs-type">i32</span>&gt;(<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&#x27;,&#x27;</span>), <span class="hljs-literal">None</span>);<br>    <span class="hljs-built_in">assert_eq!</span>(parse_pair::&lt;<span class="hljs-type">i32</span>&gt;(<span class="hljs-string">&quot;10,&quot;</span>, <span class="hljs-string">&#x27;,&#x27;</span>), <span class="hljs-literal">None</span>);<br>    <span class="hljs-built_in">assert_eq!</span>(parse_pair::&lt;<span class="hljs-type">i32</span>&gt;(<span class="hljs-string">&quot;,10&quot;</span>, <span class="hljs-string">&#x27;,&#x27;</span>), <span class="hljs-literal">None</span>);<br>    <span class="hljs-built_in">assert_eq!</span>(parse_pair::&lt;<span class="hljs-type">i32</span>&gt;(<span class="hljs-string">&quot;10,20&quot;</span>, <span class="hljs-string">&#x27;,&#x27;</span>), <span class="hljs-title function_ invoke__">Some</span>((<span class="hljs-number">10</span>, <span class="hljs-number">20</span>)));<br>    <span class="hljs-built_in">assert_eq!</span>(parse_pair::&lt;<span class="hljs-type">i32</span>&gt;(<span class="hljs-string">&quot;10,20xy&quot;</span>, <span class="hljs-string">&#x27;,&#x27;</span>), <span class="hljs-literal">None</span>);<br>    <span class="hljs-built_in">assert_eq!</span>(parse_pair::&lt;<span class="hljs-type">f64</span>&gt;(<span class="hljs-string">&quot;0.5x&quot;</span>, <span class="hljs-string">&#x27;x&#x27;</span>), <span class="hljs-literal">None</span>);<br>    <span class="hljs-built_in">assert_eq!</span>(parse_pair::&lt;<span class="hljs-type">f64</span>&gt;(<span class="hljs-string">&quot;0.5x1.5&quot;</span>, <span class="hljs-string">&#x27;x&#x27;</span>), <span class="hljs-title function_ invoke__">Some</span>((<span class="hljs-number">0.5</span>, <span class="hljs-number">1.5</span>)));<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="è½¬ä¸ºå¤æ•°">2.2 è½¬ä¸ºå¤æ•°</h3><p>æˆ‘ä»¬éœ€è¦çš„å‚æ•° <code>upper_left</code> å’Œ <code>lower_right</code>éƒ½æ˜¯å¤å¹³é¢ä¸­çš„ä¸€ä¸ªç‚¹ï¼Œæ‰€ä»¥ä»å­—ç¬¦ä¸²ä¸­å°†æ•°å¯¹è§£æå®Œæ¯•åï¼Œæˆ‘ä»¬å°†å…¶èµ‹å€¼åˆ°å¤æ•°çš„å®éƒ¨å’Œè™šéƒ¨ï¼Œè½¬ä¸ºå¤æ•°å®ä¾‹ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// æŠŠä¸€å¯¹ç”¨é€—å·éš”å¼€çš„æµ®ç‚¹æ•°è§£æä¸ºå¤æ•°</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">parse_complex</span>(s: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;Complex&lt;<span class="hljs-type">f64</span>&gt;&gt; &#123;<br>    <span class="hljs-keyword">match</span> <span class="hljs-title function_ invoke__">parse_pair</span>(s, <span class="hljs-string">&#x27;,&#x27;</span>) &#123;<br>        <span class="hljs-title function_ invoke__">Some</span>((re, im)) =&gt; <span class="hljs-title function_ invoke__">Some</span>(Complex &#123; re, im &#125;),<br>        <span class="hljs-literal">None</span> =&gt; <span class="hljs-literal">None</span>,<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å°†åƒç´ ç‚¹æ˜ å°„æˆå¤æ•°">3. å°†åƒç´ ç‚¹æ˜ å°„æˆå¤æ•°</h2><p>ç¬¬ 2 æ­¥æˆ‘ä»¬å…¶å®ç¡®å®šäº†ä¸¤ä»¶äº‹ï¼š</p><ol type="1"><li>ç¡®å®šæˆªå–æ›¼å¾·åšé›†çš„å“ªä¸€éƒ¨åˆ†ã€‚</li><li>è¦åœ¨è¿™ä¸ªéƒ¨åˆ†ä¸­ç”»å¤šå°‘ä¸ªç‚¹ã€‚</li></ol><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240118174407537.png"alt="ç›®æ ‡åŒºåŸŸä¸­çš„åƒç´ ç‚¹" /><figcaption aria-hidden="true">ç›®æ ‡åŒºåŸŸä¸­çš„åƒç´ ç‚¹</figcaption></figure><p>è¿™ä¸€æ­¥æˆ‘ä»¬éœ€è¦æŠŠ <code>x</code>ç‚¹è½¬ä¸ºå¤æ•°ï¼Œå³ç¡®å®šå®ƒçš„æ¨ªåæ ‡å’Œçºµåæ ‡ã€‚è¿™éƒ¨åˆ†å¯èƒ½éœ€è¦å‘æŒ¥ä¸€ä¸‹ä½ çš„å‡ ä½•æ•°å­¦èƒ½åŠ›äº†ï¼ˆğŸ¤¡ğŸ¤¡ğŸ¤¡ï¼‰ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">/// ç»™å®šè¾“å‡ºå›¾åƒé‡åƒç´ çš„è¡Œå’Œåˆ—ï¼Œè¿”å›å¤å¹³é¢ä¸­å¯¹åº”çš„åæ ‡</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// `pixed` æ˜¯è¡¨ç¤ºç»™å›¾ç‰‡ä¸­ç‰¹å®šåƒç´ çš„ (column, row) äºŒå…ƒç»„ã€‚</span><br><span class="hljs-comment">/// `upper_left` å‚æ•°å’Œ `lower_right` å‚æ•°æ˜¯åœ¨å¤å¹³é¢ä¸­è¡¨ç¤ºæŒ‡å®šå›¾åƒè¦†ç›–èŒƒå›´çš„ç‚¹ã€‚</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">pixed_to_point</span>(<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    Â·--------------------&gt; bounds.0  re</span><br><span class="hljs-comment">    ä¸¨</span><br><span class="hljs-comment">    ä¸¨</span><br><span class="hljs-comment">    ä¸¨</span><br><span class="hljs-comment">    bounds.1  im</span><br><span class="hljs-comment">     */</span><br>    bounds: (<span class="hljs-type">usize</span>, <span class="hljs-type">usize</span>),<br>    pixed: (<span class="hljs-type">usize</span>, <span class="hljs-type">usize</span>),<br>    upper_left: Complex&lt;<span class="hljs-type">f64</span>&gt;,<br>    lower_right: Complex&lt;<span class="hljs-type">f64</span>&gt;,<br>) <span class="hljs-punctuation">-&gt;</span> Complex&lt;<span class="hljs-type">f64</span>&gt; &#123;<br>    <span class="hljs-keyword">let</span> (width, height) = (<br>        lower_right.re - upper_left.re, <span class="hljs-comment">// å³-å·¦</span><br>        upper_left.im - lower_right.im, <span class="hljs-comment">// ä¸Š-ä¸‹</span><br>    );<br><br>    Complex &#123;<br>        re: upper_left.re + pixed.<span class="hljs-number">0</span> <span class="hljs-keyword">as</span> <span class="hljs-type">f64</span> * width / bounds.<span class="hljs-number">0</span> <span class="hljs-keyword">as</span> <span class="hljs-type">f64</span>,<br>        im: upper_left.im - pixed.<span class="hljs-number">1</span> <span class="hljs-keyword">as</span> <span class="hljs-type">f64</span> * height / bounds.<span class="hljs-number">1</span> <span class="hljs-keyword">as</span> <span class="hljs-type">f64</span>,<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">#[test]</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">test_pixed_to_point</span>() &#123;<br>    <span class="hljs-built_in">assert_eq!</span>(<br>        <span class="hljs-title function_ invoke__">pixed_to_point</span>(<br>            (<span class="hljs-number">100</span>, <span class="hljs-number">200</span>),<br>            (<span class="hljs-number">25</span>, <span class="hljs-number">175</span>),<br>            Complex &#123; re: -<span class="hljs-number">1.0</span>, im: <span class="hljs-number">1.0</span> &#125;,<br>            Complex &#123; re: <span class="hljs-number">1.0</span>, im: -<span class="hljs-number">1.0</span> &#125;<br>        ),<br>        Complex &#123;<br>            re: -<span class="hljs-number">0.5</span>,<br>            im: -<span class="hljs-number">0.75</span>,<br>        &#125;<br>    );<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å¯»æ‰¾æ›¼å¾·åšé›†ç‚¹">4. å¯»æ‰¾æ›¼å¾·åšé›†ç‚¹</h2><p>ä»€ä¹ˆæ˜¯æ›¼å¾·åšé›†ç‚¹ï¼Ÿçœ‹çœ‹ä¸Šé¢çš„å®šä¹‰ï¼š<strong>æ›¼å¾·åšé›†åˆç”±é‚£äº›ä½¿å¾—ä¸Šè¿°åºåˆ—ä¸è¶‹äºæ— é™å¤§çš„å¤æ•°<span class="math inline">\(c\)</span> ç»„æˆ</strong>ã€‚</p><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥æ¥è¡¨ç¤ºä¸Šè¿°çš„å…¬å¼ <span class="math inline">\(Z_{n+1} =z_n^2 + c\)</span> äº†ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">complex_square_add_loop</span>(c: Complex&lt;<span class="hljs-type">f64</span>&gt;) &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">z</span> = Complex &#123; re: <span class="hljs-number">0.0</span>, im: <span class="hljs-number">0.0</span> &#125;;<br>    <span class="hljs-keyword">loop</span> &#123;<br>        z = z * z + c<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­æˆ‘ä»¬å°†æ³›å‹ç»“æ„ä½“ <code>Complex</code> çš„ <code>T</code> ç¡®å®šä¸º<code>f64</code>ï¼Œå¹¶ä½¿ç”¨ <code>loop</code> å…³é”®å­—è¿›è¡Œæ— é™å¾ªç¯ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ<strong>æ‰¾åˆ°ä»¤ <code>z</code>ä¸ä¼šâ€œé£åˆ°â€æ— ç©·è¿œçš„ <code>c</code></strong>ã€‚</p><p>ç”±äºå¤æ•° <span class="math inline">\(c\)</span> å…·æœ‰å®éƒ¨ re å’Œè™šéƒ¨imï¼Œå› æ­¤å¯ä»¥æŠŠå®ƒä»¬è§†ä¸ºç¬›å¡å°”å¹³é¢ä¸ŠæŸä¸ªç‚¹çš„ x åæ ‡å’Œ y åæ ‡ï¼Œå¦‚æœ <spanclass="math inline">\(c\)</span>åœ¨æ›¼å¾·åšé›†ä¸­ï¼Œå°±åœ¨å…¶ä¸­ç”¨é»‘è‰²ç€è‰²ï¼Œå¦åˆ™å°±ç”¨æµ…è‰²ã€‚å› æ­¤ï¼Œå¯¹äºå›¾åƒä¸­çš„æ¯ä¸ªåƒç´ ï¼Œå¿…é¡»åœ¨å¤å¹³é¢ä¸Šç›¸åº”ç‚¹ä½è¿è¡Œå‰é¢çš„å¾ªç¯ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦é€ƒé€¸åˆ°æ— ç©·è¿œè¿˜æ˜¯æ°¸è¿œç»•ç€åŸç‚¹è¿è¡Œï¼Œå¹¶ç›¸åº”å°†å…¶ç€è‰²ã€‚</p><p>æ— é™å¾ªç¯è‚¯å®šæ˜¯ä¸ç°å®çš„ï¼Œæˆ‘ä»¬æ€»è¦æ‰¾åˆ°é€€å‡ºå¾ªç¯çš„æœºä¼šï¼Œæœ‰ 2 ä¸ªæ€è·¯ï¼š</p><ol type="1"><li>è¿›è¡Œæœ‰é™æ¬¡æ•°çš„è¿­ä»£ï¼Œè¿™æ ·å¯ä»¥è·å¾—è¯¥é›†åˆçš„ä¸€ä¸ªä¸é”™çš„è¿‘ä¼¼å€¼ï¼Œè¿­ä»£çš„æ¬¡æ•°å–å†³äº†ç²¾åº¦çš„éœ€è¦ï¼›</li><li>ä¸šç•Œå·²è¯æ˜ï¼Œ<strong>ä¸€æ—¦ <code>z</code> ç¦»å¼€äº†ä»¥åŸç‚¹ä¸ºä¸­å¿ƒçš„åŠå¾„ 2çš„åœ†ï¼Œå®ƒæœ€ç»ˆä¸€å®šä¼šâ€œé£åˆ°â€æ— ç©·è¿œ</strong>ã€‚</li></ol><p>æ‰€ä»¥æˆ‘ä»¬æœ€ç»ˆç¡®å®šçš„å‡½æ•°å¦‚ä¸‹ï¼Œå…¶ä¸­ <code>norm_sqr()</code> ä¼šè¿”å›<code>z</code> è·Ÿå¤å¹³é¢åŸç‚¹çš„è·ç¦»çš„å¹³æ–¹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">/// å°è¯•æµ‹è¯• `c` æ˜¯å¦ä½äºæ›¼å¾·åšé›†ä¸­ï¼Œä½¿ç”¨æœ€å¤š `limit` æ¬¡è¿­ä»£æ¥åˆ¤å®š</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// å¦‚æœ `c` ä¸æ˜¯é›†åˆæˆå‘˜ä¹‹ä¸€ï¼Œåˆ™è¿”å› `Some(i)`ï¼Œå…¶ä¸­ `i` æ˜¯ `c` ç¦»å¼€ä»¥åŸç‚¹</span><br><span class="hljs-comment">/// ä¸ºä¸­å¿ƒçš„åŠå¾„ä¸º 2 çš„åœ†æ—¶æ‰€éœ€çš„è¿­ä»£æ¬¡æ•°ã€‚å¦‚æœ `c` ä¼¼ä¹æ˜¯é›†ç¾¤æˆå‘˜ä¹‹ä¸€ï¼ˆç¡®</span><br><span class="hljs-comment">/// åˆ‡è€Œè¨€æ˜¯è¾¾åˆ°äº†è¿­ä»£æ¬¡æ•°é™åˆ¶ä½†ä»ç„¶æ— æ³•è¯æ˜ `c` ä¸æ˜¯æˆå‘˜ï¼‰ï¼Œåˆ™è¿”å› `None`</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">escape_time</span>(c: Complex&lt;<span class="hljs-type">f64</span>&gt;, limit: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-type">usize</span>&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">z</span> = Complex &#123; re: <span class="hljs-number">0.0</span>, im: <span class="hljs-number">0.0</span> &#125;;<br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..limit &#123;<br>        <span class="hljs-keyword">if</span> z.<span class="hljs-title function_ invoke__">norm_sqr</span>() &gt; <span class="hljs-number">4.0</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Some</span>(i);<br>        &#125;<br>        z = z * z + c<br>    &#125;<br>    <span class="hljs-literal">None</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å†™å…¥å›¾ç‰‡æ–‡ä»¶">5. å†™å…¥å›¾ç‰‡æ–‡ä»¶</h2><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>image</code> è¿™ä¸ª crateæ¥å†™å…¥å›¾ç‰‡æ–‡ä»¶ï¼Œå®ƒæ”¯æŒå¤šç§æ ¼å¼å›¾ç‰‡çš„è¯»å†™ï¼Œå¹¶å†…ç½®äº†å¤šç§é¢œè‰²è‰²å€¼ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬å‡†å¤‡ç”Ÿæˆ pngå›¾ç‰‡ï¼Œä¸”éœ€è¦å¯¹å›¾ç‰‡è¿›è¡Œä¸åŒé¢œè‰²çš„ç€è‰²ï¼Œæ‰€ä»¥æˆ‘ä»¬å¼•å…¥ <code>default</code>å’Œ <code>png</code> è¿™ä¸¤ä¸ª featureã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo add image --features default,png<br></code></pre></td></tr></table></figure><h3 id="åˆ›å»ºæ–‡ä»¶-filecreate">5.1 åˆ›å»ºæ–‡ä»¶ File::create()</h3><p>æˆ‘ä»¬å¯ä»¥ç”¨æ ‡å‡†åº“ä¸­çš„ <code>File::create(filename)</code>æ¥åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼ŒæˆåŠŸçš„è¯ä¼šè¿”å›ä¸€ä¸ªæ–‡ä»¶å¥æŸ„ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">output</span> = File::<span class="hljs-title function_ invoke__">create</span>(filename)?;<br></code></pre></td></tr></table></figure><h3 id="å†™å…¥å›¾ç‰‡-pngencoder">5.2 å†™å…¥å›¾ç‰‡ PNGEncoder</h3><p><code>image</code> ä¸­æä¾›äº† <code>PNGEncoder</code> ç”¨äºå†™å…¥ pngå›¾ç‰‡ï¼Œå®ƒæœ‰ä¸¤ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">impl</span>&lt;W: Write&gt; PNGEncoder&lt;W&gt; &#123;<br>    <span class="hljs-comment">/// Create a new encoder that writes its output to ```w```</span><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(w: W) <span class="hljs-punctuation">-&gt;</span> PNGEncoder&lt;W&gt; &#123;<br>        PNGEncoder &#123;<br>            w: w<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/// Encodes the image ```image```</span><br>    <span class="hljs-comment">/// that has dimensions ```width``` and ```height```</span><br>    <span class="hljs-comment">/// and ```ColorType``` ```c```</span><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">encode</span>(<span class="hljs-keyword">self</span>, data: &amp;[<span class="hljs-type">u8</span>], width: <span class="hljs-type">u32</span>, height: <span class="hljs-type">u32</span>, color: ColorType) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>        <span class="hljs-keyword">let</span> (ct, bits) = color.<span class="hljs-title function_ invoke__">into</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">encoder</span> = png::Encoder::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-keyword">self</span>.w, width, height);<br>        encoder.<span class="hljs-title function_ invoke__">set</span>(ct).<span class="hljs-title function_ invoke__">set</span>(bits);<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">writer</span> = <span class="hljs-built_in">try!</span>(encoder.<span class="hljs-title function_ invoke__">write_header</span>());<br>        writer.<span class="hljs-title function_ invoke__">write_image_data</span>(data).<span class="hljs-title function_ invoke__">map_err</span>(|e| e.<span class="hljs-title function_ invoke__">into</span>())<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>new(w)</code>: ä¼ è¿›ç›®æ ‡ writerï¼Œå³æˆ‘ä»¬ä¸Šé¢åˆ›å»ºçš„<code>output</code>ã€‚</li><li><code>encode()</code>: å†™å…¥å›¾ç‰‡ä¿¡æ¯ï¼Œè¿™é‡Œæœ‰å‡ ä¸ªå‚æ•°ï¼š<ul><li><code>width: u32</code>: å›¾ç‰‡å®½åº¦ã€‚</li><li><code>height: u32</code>: å›¾ç‰‡é«˜åº¦ã€‚</li><li><code>color: ColorType</code>: é¢œè‰²ç±»å‹ï¼Œå¯ä»¥æ˜¯ RGB, Gray(8)ç­‰ã€‚</li><li><code>data: &amp;[u8]</code>: åƒç´ è‰²å€¼åˆ—è¡¨ï¼Œå®ƒçš„é•¿åº¦åº”è¯¥ç”±ä¸Šé¢ 3ä¸ªå­—æ®µå…±åŒå†³å®šï¼Œå¦‚æœé€‰å–çš„é¢œè‰²æ˜¯ RGBï¼Œæ„å‘³ç€éœ€è¦ 3 ä¸ª u8æ‰èƒ½è¡¨ç¤ºä¸€ä¸ªåƒç´ ç‚¹çš„é¢œè‰²ï¼Œæ‰€ä»¥é•¿åº¦ä¸º width * height *3ï¼Œå¦‚æœé€‰å–çš„é¢œè‰²æ˜¯ Gray(8)ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç”¨ 1 ä¸ª u8å°±å¯ä»¥è¡¨ç¤ºä¸€ä¸ªåƒç´ ç‚¹çš„ç°åº¦å€¼ï¼Œæ‰€ä»¥é•¿åº¦ä¸º width * height *1ã€‚æœ¬æ–‡ä¸­æˆ‘ä»¬ä¼šé‡‡ç”¨ Gray(8) æ¥æ±‡æ€»æ›¼å¾·åšé›†çš„é»‘ç™½å›¾ã€‚</li></ul></li></ul><h2 id="æ¸²æŸ“æ›¼å¾·åšé›†">6. æ¸²æŸ“æ›¼å¾·åšé›†</h2><p>è¿™ä¸€æ­¥æˆ‘ä»¬éœ€è¦æ¥ç¡®å®šä¸Šè¿° <code>PNGEncoder::encode()</code> çš„ 4ä¸ªå‚æ•°ï¼š</p><ul><li><p><code>width: u32</code>:å›¾ç‰‡å®½åº¦ç”±å‘½ä»¤è¡Œå‚æ•°ä¸­æŒ‡å®šå³å¯ã€‚</p></li><li><p><code>height: u32</code>:å›¾ç‰‡é«˜åº¦ç”±å‘½ä»¤è¡Œå‚æ•°ä¸­æŒ‡å®šå³å¯ã€‚</p></li><li><p><code>color: ColorType</code>: æœ¬æ–‡æˆ‘ä»¬åªç»˜åˆ¶é»‘ç™½å›¾ï¼Œè¿™é‡Œä½¿ç”¨<code>ColorType::Gray(8)</code>ï¼Œå®ƒè¡¨ç¤ºå›¾åƒæ˜¯ä¸€ä¸ªç°åº¦ï¼ˆå•è‰²ï¼‰å›¾åƒï¼Œæ¯ä¸ªåƒç´ ç”¨8ä½ï¼ˆå³1ä¸ªå­—èŠ‚ï¼‰æ¥è¡¨ç¤ºã€‚åœ¨è¿™ç§æ ¼å¼ä¸­ï¼Œæ¯ä¸ªåƒç´ çš„ç°åº¦å€¼èŒƒå›´æ˜¯0 åˆ° 255ï¼Œå…¶ä¸­ 0 é€šå¸¸è¡¨ç¤ºé»‘è‰²ï¼Œ255è¡¨ç¤ºç™½è‰²ï¼Œä¸­é—´å€¼è¡¨ç¤ºä¸åŒçš„ç°åº¦ã€‚</p></li><li><p><code>data: &amp;[u8]</code>: åƒç´ è‰²å€¼åˆ—è¡¨ï¼Œæˆ‘ä»¬éœ€è¦ç¡®å®š width *height ä¸ªåƒç´ çš„ç°åº¦å€¼ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬æ ¹æ®ç¬¬ 3 æ­¥å°†åƒç´ ç‚¹æ˜ å°„æˆå¤æ•° <spanclass="math inline">\(c\)</span>ï¼Œç„¶åä½¿ç”¨ç¬¬ 4 æ­¥ä¸­çš„<code>escape_time()</code> å‡½æ•°æ¥åˆ¤æ–­å¤æ•° <spanclass="math inline">\(c\)</span>æ˜¯å¦ä½äºæ›¼å¾·åšé›†ä¸­ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ç€é»‘è‰²ï¼Œå³èµ‹å€¼<code>0</code>ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™çœ‹å®ƒè¿­ä»£äº†å¤šå°‘æ¬¡æ‰å¤±è´¥ï¼Œæ¬¡æ•°è¶Šå¤šï¼Œåˆ™è¶Šæ¥è¿‘æ›¼å¾·åšé›†ï¼Œé¢œè‰²è¶Šæ·±ï¼Œå³è¶Šé è¿‘0ï¼Œæ‰€ä»¥èµ‹å€¼ <code>255-time</code>ã€‚</p></li></ul><p>æœ€ç»ˆæˆ‘ä»¬å®ç°çš„å‡½æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">/// å°†æ›¼å¾·åšé›†å¯¹åº”çš„çŸ©å½¢æ¸²æŸ“åˆ°åƒç´ ç¼“å†²åŒºä¸­</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// `bounds` å‚æ•°ä¼šç»™ç¼“å†²åŒº `pixels` çš„å®½åº¦å’Œé«˜åº¦ï¼Œæ­¤ç¼“å†²åŒºçš„æ¯ä¸ªå­—èŠ‚éƒ½</span><br><span class="hljs-comment">/// åŒ…å«ä¸€ä¸ªç°åº¦åƒç´ ã€‚`upper_left` å’Œ `lower_right` å‚æ•°åˆ†åˆ«æŒ‡å®šäº†</span><br><span class="hljs-comment">/// å¤å¹³é¢ä¸­å¯¹åº”äºåƒç´ ç¼“å†²åŒºå·¦ä¸Šè§’å’Œå³ä¸Šè§’çš„ç‚¹ã€‚</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">render</span>(<br>    pixels: &amp;<span class="hljs-keyword">mut</span> [<span class="hljs-type">u8</span>],<br>    bounds: (<span class="hljs-type">usize</span>, <span class="hljs-type">usize</span>),<br>    upper_left: Complex&lt;<span class="hljs-type">f64</span>&gt;,<br>    lower_right: Complex&lt;<span class="hljs-type">f64</span>&gt;,<br>) &#123;<br>    <span class="hljs-built_in">assert_eq!</span>(pixels.<span class="hljs-title function_ invoke__">len</span>(), bounds.<span class="hljs-number">0</span> * bounds.<span class="hljs-number">1</span>);<br><br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">raw</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..bounds.<span class="hljs-number">1</span> &#123;<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">column</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..bounds.<span class="hljs-number">0</span> &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">point</span> = <span class="hljs-title function_ invoke__">pixed_to_point</span>(bounds, (column, raw), upper_left, lower_right);<br>            pixels[raw * bounds.<span class="hljs-number">0</span> + column] = <span class="hljs-keyword">match</span> <span class="hljs-title function_ invoke__">escape_time</span>(point, <span class="hljs-number">255</span>) &#123;<br>                <span class="hljs-literal">None</span> =&gt; <span class="hljs-number">0</span>,<br>                <span class="hljs-title function_ invoke__">Some</span>(count) =&gt; <span class="hljs-number">255</span> - count <span class="hljs-keyword">as</span> <span class="hljs-type">u8</span>,<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="è§£æå‘½ä»¤è¡Œå‚æ•°">7. è§£æå‘½ä»¤è¡Œå‚æ•°</h2><p>æ ¸å¿ƒé€»è¾‘éƒ¨åˆ†åˆ°è¿™é‡Œå…¶å®å°±å®Œæˆäº†ï¼Œç°åœ¨æˆ‘ä»¬è¦åšæœ€åä¸€æ­¥ï¼Œå°±æ˜¯è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Œè®©ç¨‹åºå¯ä»¥æ ¹æ®æˆ‘ä»¬çš„è¦æ±‚ç»˜åˆ¶æ›¼å¾·åšé›†å›¾ã€‚</p><h3 id="è§£æ-stdenvargs">7.1 è§£æ std::env::args()</h3><p>åœ¨ Rustä¸­è§£æå‘½ä»¤è¡Œå‚æ•°çš„ä¸€ä¸ªå¸¸ç”¨æ–¹æ³•æ˜¯ä½¿ç”¨<code>std::env::args</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ªè¿­ä»£å™¨ï¼Œå®ƒåŒ…å«äº†å‘½ä»¤è¡Œä¸Šä¼ é€’ç»™ç¨‹åºçš„æ‰€æœ‰å‚æ•°ã€‚å¯¹äºæ›´å¤æ‚çš„å‘½ä»¤è¡Œå‚æ•°è§£æï¼Œå¯ä»¥ä½¿ç”¨åƒ<code>clap</code>æˆ–<code>structopt</code>è¿™æ ·çš„ç¬¬ä¸‰æ–¹åº“ï¼Œè¿™äº›åº“æä¾›äº†æ›´é«˜çº§çš„åŠŸèƒ½å’Œæ›´å¥½çš„é”™è¯¯å¤„ç†ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨<code>std::env::args</code>çš„åŸºæœ¬ä¾‹å­ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> std::env;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">args</span>: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">String</span>&gt; = env::<span class="hljs-title function_ invoke__">args</span>().<span class="hljs-title function_ invoke__">collect</span>();<br><br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">arg</span> <span class="hljs-keyword">in</span> args.<span class="hljs-title function_ invoke__">iter</span>() &#123;<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, arg);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åŸºç¡€ç‰ˆç¨‹åº">7.2 åŸºç¡€ç‰ˆç¨‹åº</h3><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±å¯ä»¥å®ç°å®Œæ•´çš„åŸºç¡€ç‰ˆç¨‹åºäº†ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>  <span class="hljs-comment">// è¯»å–å‚æ•°</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">args</span>: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">String</span>&gt; = env::<span class="hljs-title function_ invoke__">args</span>().<span class="hljs-title function_ invoke__">collect</span>();<br>  <span class="hljs-comment">// å‚æ•°ä¸ªæ•° = 1 + 4ï¼Œå…¶ä¸­ç¬¬ 1 ä¸ªæ˜¯åº”ç”¨ç¨‹åºå</span><br>    <span class="hljs-keyword">if</span> args.<span class="hljs-title function_ invoke__">len</span>() != <span class="hljs-number">5</span> &#123;<br>        <span class="hljs-built_in">eprintln!</span>(<span class="hljs-string">&quot;Usage: &#123;&#125; FILE PIXELS UPPERLEFT LOWERRIGHT&quot;</span>, args[<span class="hljs-number">0</span>]);<br>        <span class="hljs-built_in">eprintln!</span>(<br>            <span class="hljs-string">&quot;Example: &#123;&#125; mandel.png 1000x700 -1.20,0.35 -1,0.20&quot;</span>,<br>            args[<span class="hljs-number">0</span>]<br>        );<br>        std::process::<span class="hljs-title function_ invoke__">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br><span class="hljs-comment">// è§£æå‚æ•°</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">bounds</span> = <span class="hljs-title function_ invoke__">parse_pair</span>(&amp;args[<span class="hljs-number">2</span>], <span class="hljs-string">&#x27;x&#x27;</span>).<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">&quot;error parsing image dimensions&quot;</span>);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">upper_left</span> = <span class="hljs-title function_ invoke__">parse_complex</span>(&amp;args[<span class="hljs-number">3</span>]).<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">&quot;error parsing upper left corner point&quot;</span>);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">lower_right</span> = <span class="hljs-title function_ invoke__">parse_complex</span>(&amp;args[<span class="hljs-number">4</span>]).<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">&quot;error parsing lower right corner point&quot;</span>);<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">pixels</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">0</span>; bounds.<span class="hljs-number">0</span> * bounds.<span class="hljs-number">1</span>];<br>    <span class="hljs-comment">// æ¸²æŸ“æ›¼å¾·åšé›†</span><br>    <span class="hljs-title function_ invoke__">render</span>(&amp;<span class="hljs-keyword">mut</span> pixels, bounds, upper_left, lower_right);<br>  <span class="hljs-comment">// è¾“å‡ºå›¾ç‰‡</span><br>    <span class="hljs-title function_ invoke__">write_image</span>(&amp;args[<span class="hljs-number">1</span>], &amp;pixels, bounds).<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">&quot;error writing PNG file&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹ç¼–è¯‘ä¸€ä¸‹ç¨‹åºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo build --release<br></code></pre></td></tr></table></figure><p>ä¼šåœ¨ target/release ä¸‹ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ‰§è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./target/release/mandelbrot mandel.png 4000x3000 -1.20,0.35 -1,0.20<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œåä½ åº”è¯¥å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ç”Ÿæˆçš„æ›¼å¾·åšé›†å›¾å¦‚ä¸‹ï¼š</p><figure><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/mandel.png"alt="ç¨‹åºç”Ÿæˆçš„æ›¼å¾·åšé›†" /><figcaption aria-hidden="true">ç¨‹åºç”Ÿæˆçš„æ›¼å¾·åšé›†</figcaption></figure><p>å¤§æ¦‚æ˜¯å¤„äºè¿™ä¸ªä½ç½®ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240118191624303.png"alt="ç¨‹åºæˆªå–çš„å±€éƒ¨æ›¼å¾·åšé›†å¤„äºæ•´ä¸ªæ›¼å¾·åšé›†ä¸­çš„ä½ç½®" /><figcaptionaria-hidden="true">ç¨‹åºæˆªå–çš„å±€éƒ¨æ›¼å¾·åšé›†å¤„äºæ•´ä¸ªæ›¼å¾·åšé›†ä¸­çš„ä½ç½®</figcaption></figure><h2 id="å¹¶å‘æ¸²æŸ“">8. å¹¶å‘æ¸²æŸ“</h2><p>åœ¨ macOS æˆ– linux ç³»ç»Ÿä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>time</code>æ¥è¾“å‡ºç¨‹åºçš„æ‰§è¡Œæ—¶é—´ï¼š</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs txt">time ./target/release/mandelbrot mandel.png 4000x3000 -1.20,0.35 -1,0.20<br>./target/release/mandelbrot mandel.png 4000x3000 -1.20,0.35 -1,0.20  3.30s user 0.01s system 98% cpu 3.341 total<br></code></pre></td></tr></table></figure><p>ç¬”è€…ä½¿ç”¨çš„ç”µè„‘ä¸º macbook Pro m2 max èŠ¯ç‰‡ 32 G å†…å­˜ 12æ ¸ï¼Œå¯ä»¥çœ‹åˆ°åœ¨å•æ ¸æ¨¡å¼ä¸‹ï¼Œå·®ä¸å¤šéœ€è¦ 3~4s çš„æ—¶é—´ã€‚</p><p>å‡ ä¹æ‰€æœ‰çš„ç°ä»£æœºå™¨éƒ½æœ‰å¤šä¸ªå¤„ç†å™¨æ ¸å¿ƒï¼Œè€Œå½“å‰è¿™ä¸ªç¨‹åºåªä½¿ç”¨äº†ä¸€ä¸ªã€‚å¦‚æœå¯ä»¥æŠŠæ­¤å·¥ä½œåˆ†æ´¾ä¸ªæœºå™¨æä¾›çš„å¤šä¸ªå¤„ç†å™¨æ ¸å¿ƒï¼Œåˆ™åº”è¯¥å¯ä»¥æ›´å¿«åœ°ç”»å®Œå›¾åƒã€‚</p><p>ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å°†å›¾åƒåˆ’åˆ†æˆå¤šä¸ªéƒ¨åˆ†ï¼Œæ¯ä¸ªå¤„ç†å™¨è´Ÿè´£å…¶ä¸­çš„ä¸€ä¸ªéƒ¨åˆ†ï¼Œå¹¶è®©æ¯ä¸ªå¤„ç†å™¨ä¸ºåˆ†æ´¾ç»™å®ƒçš„åƒç´ ç€è‰²ã€‚ä¸ºç®€å•èµ·è§ï¼Œå¯ä»¥å°†å…¶åˆ†æˆä¸€äº›æ°´å¹³æ¡å¸¦ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/CleanShot%202024-01-18%20at%2021.28.20.jpg"alt="å°†åƒç´ ç¼“å†²åŒºåˆ’åˆ†ä¸ºä¸€äº›æ¡å¸¦ä»¥è¿›è¡Œå¹¶å‘æ¸²æŸ“" /><figcaptionaria-hidden="true">å°†åƒç´ ç¼“å†²åŒºåˆ’åˆ†ä¸ºä¸€äº›æ¡å¸¦ä»¥è¿›è¡Œå¹¶å‘æ¸²æŸ“</figcaption></figure><p>crossbeam æ˜¯ Rustä¸­çš„ä¸€ä¸ªå¹¶å‘ç¼–ç¨‹å·¥å…·ç®±ï¼Œå®ƒå¹¿æ³›ç”¨äºæä¾›å„ç§å¹¶å‘å’Œå¤šçº¿ç¨‹ç¼–ç¨‹çš„ç»„ä»¶ã€‚</p><p><code>crossbeam::scope</code> æ˜¯ crossbeamæä¾›çš„ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„åŠŸèƒ½ï¼Œå®ƒå…è®¸ä½ å®‰å…¨åœ°åˆ›å»ºä¸´æ—¶çš„çº¿ç¨‹ï¼Œå¹¶ç¡®ä¿è¿™äº›çº¿ç¨‹åœ¨ç¦»å¼€ä½œç”¨åŸŸä¹‹å‰ç»“æŸã€‚</p><p>è¿™é‡Œæˆ‘ä»¬å¼•å…¥ crossbeamï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo add crossbeam<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å°† <code>fn main()</code> ä¸­çš„ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-title function_ invoke__">render</span>(&amp;<span class="hljs-keyword">mut</span> pixels, bounds, upper_left, lower_right);<br></code></pre></td></tr></table></figure><p>æ›¿æ¢æˆï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// ä½¿ç”¨ 8 ä¸ªçº¿ç¨‹æ¥å¹¶å‘æ‰§è¡Œ</span><br><span class="hljs-keyword">let</span> <span class="hljs-variable">threads</span> = <span class="hljs-number">8</span>;<br><span class="hljs-comment">// è®¡ç®—æ¯ä¸ªçº¿ç¨‹è´Ÿè´£æ¸²æŸ“çš„é«˜åº¦ï¼Œå‘ä¸Šå–æ•´</span><br><span class="hljs-keyword">let</span> <span class="hljs-variable">rows_per_band</span> = bounds.<span class="hljs-number">1</span> / threads + <span class="hljs-number">1</span>;<br>&#123;<br>  <span class="hljs-comment">// chunks_mut() ä¼šè¿”å›ä¸€ä¸ªè¿­ä»£å™¨ï¼Œè¯¥è¿­ä»£å™¨ä¼šç”Ÿæˆæ­¤ç¼“å†²åŒºçš„å¯å˜ä¸”ä¸å¯è¿­ä»£çš„åˆ‡ç‰‡</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">bands</span>: <span class="hljs-type">Vec</span>&lt;&amp;<span class="hljs-keyword">mut</span> [<span class="hljs-type">u8</span>]&gt; = pixels.<span class="hljs-title function_ invoke__">chunks_mut</span>(rows_per_band * bounds.<span class="hljs-number">0</span>).<span class="hljs-title function_ invoke__">collect</span>();<br>  <span class="hljs-comment">// crossbeam::scope ç¡®ä¿æ‰€æœ‰å­çº¿ç¨‹åœ¨ä½œç”¨åŸŸç»“æŸä¹‹å‰å®Œæˆï¼Œ</span><br>  <span class="hljs-comment">// è¿™é˜²æ­¢äº†æ‚¬å‚æŒ‡é’ˆå’Œå…¶ä»–æ•°æ®ç«äº‰é—®é¢˜ã€‚</span><br>    crossbeam::<span class="hljs-title function_ invoke__">scope</span>(|spawner| &#123;<br>      <span class="hljs-comment">// éå†åƒç´ ç¼“å†²åŒºçš„å„ä¸ªæ¡å¸¦ï¼Œ</span><br>      <span class="hljs-comment">// è¿™é‡Œ into_iter() è¿­ä»£å™¨ä¼šä¸ºå¾ªç¯ä½“çš„æ¯æ¬¡è¿­ä»£èµ‹äºˆç‹¬å ä¸€ä¸ªæ¡å¸¦çš„æ‰€æœ‰æƒï¼Œ</span><br>      <span class="hljs-comment">// ç¡®ä¿ä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥å†™å…¥å®ƒã€‚</span><br>        <span class="hljs-keyword">for</span> (i, band) <span class="hljs-keyword">in</span> bands.<span class="hljs-title function_ invoke__">into_iter</span>().<span class="hljs-title function_ invoke__">enumerate</span>() &#123;<br>          <span class="hljs-comment">// ç¡®å®šæ¯ä¸ªæ¡å¸¦çš„å‚æ•°</span><br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">top</span> = rows_per_band * i;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">height</span> = band.<span class="hljs-title function_ invoke__">len</span>() / bounds.<span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">band_bounds</span> = (bounds.<span class="hljs-number">0</span>, height);<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">band_upper_left</span> = <span class="hljs-title function_ invoke__">pixed_to_point</span>(bounds, (<span class="hljs-number">0</span>, top), upper_left, lower_right);<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">band_lower_right</span> =<br>                <span class="hljs-title function_ invoke__">pixed_to_point</span>(bounds, (bounds.<span class="hljs-number">0</span>, top + height), upper_left, lower_right);<br>          <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œæ¸²æŸ“å›¾åƒ</span><br>          <span class="hljs-comment">// move è¡¨ç¤ºè¿™ä¸ªé—­åŒ…ä¼šæ¥æ‰‹å®ƒæ‰€ç”¨éå†çš„æ‰€æœ‰æƒï¼Œ</span><br>          <span class="hljs-comment">// æ‰€ä»¥åªæœ‰æ­¤é—­å…³ï¼Œå³åªæœ‰æ­¤çº¿ç¨‹å¯ä»¥ä½¿ç”¨å¯å˜åˆ‡ç‰‡ bandã€‚</span><br>            spawner.<span class="hljs-title function_ invoke__">spawn</span>(<span class="hljs-keyword">move</span> |_| &#123;<br>                <span class="hljs-title function_ invoke__">render</span>(band, band_bounds, band_upper_left, band_lower_right);<br>            &#125;);<br>        &#125;<br>    &#125;)<br>    .<span class="hljs-title function_ invoke__">unwrap</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>å†æ¬¡æ‰§è¡Œï¼š</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs llvm">time ./<span class="hljs-keyword">target</span>/<span class="hljs-keyword">release</span>/mandelbrot mandel.png <span class="hljs-number">4000</span><span class="hljs-keyword">x</span><span class="hljs-number">3000</span> <span class="hljs-number">-1.20</span><span class="hljs-punctuation">,</span><span class="hljs-number">0.35</span> <span class="hljs-number">-1</span><span class="hljs-punctuation">,</span><span class="hljs-number">0.20</span><br>./<span class="hljs-keyword">target</span>/<span class="hljs-keyword">release</span>/mandelbrot mandel.png <span class="hljs-number">4000</span><span class="hljs-keyword">x</span><span class="hljs-number">3000</span> <span class="hljs-number">-1.20</span><span class="hljs-punctuation">,</span><span class="hljs-number">0.35</span> <span class="hljs-number">-1</span><span class="hljs-punctuation">,</span><span class="hljs-number">0.20</span>  <span class="hljs-number">3.57</span>s user <span class="hljs-number">0.01</span>s system <span class="hljs-number">335</span>% cpu <span class="hljs-number">1.067</span> total<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è™½ç„¶æ€»å…±ä½¿ç”¨çš„ CPU æ—¶é—´è¿˜æ˜¯3~4sï¼Œä½†æ˜¯æ•´ä¸ªç¨‹åºçš„æ‰§è¡Œæ—¶é—´åªç¼©çŸ­åˆ° 1s å·¦å³äº†ã€‚</p><h2 id="rayon-å·¥ä½œçªƒå–">9. rayon å·¥ä½œçªƒå–</h2><p>å‰é¢æˆ‘ä»¬ä½¿ç”¨ 8 ä¸ªå·¥ä½œçº¿ç¨‹ä¼˜åŒ–äº†æ›¼å¾·åšé›†çš„ç»˜åˆ¶é€Ÿåº¦ï¼Œå¤§æ¦‚æ˜¯ 4å€çš„é€Ÿåº¦æå‡ã€‚å…¶å®è¿™è¿˜ä¸å¤Ÿå¿«ã€‚</p><p>é—®é¢˜çš„æ ¹æºåœ¨äºæˆ‘ä»¬æ²¡æœ‰å¹³å‡åˆ†é…å·¥ä½œé‡ã€‚è®¡ç®—å›¾åƒçš„ä¸€ä¸ªåƒç´ ç›¸å½“äºè¿è¡Œä¸€ä¸ªå¾ªç¯ã€‚äº‹å®ä¸Šï¼Œå›¾åƒçš„æµ…ç°è‰²éƒ¨åˆ†ï¼ˆå¾ªç¯ä¼šå¿«é€Ÿé€€å‡ºçš„åœ°æ–¹ï¼‰æ¯”é»‘è‰²éƒ¨åˆ†ï¼ˆå¾ªç¯ä¼šè¿è¡Œæ•´æ•´255æ¬¡è¿­ä»£çš„åœ°æ–¹ï¼‰æ¸²æŸ“é€Ÿåº¦è¦å¿«å¾—å¤šã€‚å› æ­¤ï¼Œè™½ç„¶æˆ‘ä»¬å°†æ•´ä¸ªåŒºåŸŸåˆ’åˆ†æˆäº†å¤§å°ç›¸ç­‰çš„æ°´å¹³æ¡å¸¦ï¼Œä½†åˆ›å»ºäº†ä¸å‡ç­‰çš„å·¥ä½œè´Ÿè½½ï¼Œ</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image00879.jpeg"alt="æ›¼å¾·åšé›†ç¨‹åºä¸­çš„å·¥ä½œåˆ†é…ä¸å‡ç­‰" /><figcaptionaria-hidden="true">æ›¼å¾·åšé›†ç¨‹åºä¸­çš„å·¥ä½œåˆ†é…ä¸å‡ç­‰</figcaption></figure><p>ä½¿ç”¨ rayonå¾ˆå®¹æ˜“è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æˆ‘ä»¬å¯ä»¥ä¸ºè¾“å‡ºä¸­çš„æ¯ä¸€è¡Œåƒç´ å¯åŠ¨ä¸€ä¸ªå¹¶è¡Œä»»åŠ¡ã€‚è¿™ä¼šåˆ›å»ºæ•°ç™¾ä¸ªä»»åŠ¡ï¼Œè€Œrayonå¯ä»¥åœ¨å…¶çº¿ç¨‹ä¸­åˆ†é…è¿™äº›ä»»åŠ¡ã€‚æœ‰äº†å·¥ä½œçªƒå–æœºåˆ¶ï¼Œä»»åŠ¡çš„è§„æ¨¡æ˜¯æ— å…³ç´§è¦çš„ã€‚rayonä¼šå¯¹è¿™äº›å·¥ä½œè¿›è¡Œå¹³è¡¡ã€‚</p><p>æˆ‘ä»¬å…ˆå¼•å…¥ <code>rayon</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo add rayon<br></code></pre></td></tr></table></figure><p>åœ¨ <code>main.rs</code> ä¸­å¼•å…¥ <code>rayon</code>:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> rayon::prelude::*;<br></code></pre></td></tr></table></figure><p>ç„¶å <code>main</code> ä¸­å¹¶å‘ç»˜åˆ¶çš„éƒ¨åˆ†æ›¿æ¢ä¸ºä¸‹é¢çš„ä»£ç ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">bands</span>: <span class="hljs-type">Vec</span>&lt;(<span class="hljs-type">usize</span>, &amp;<span class="hljs-keyword">mut</span> [<span class="hljs-type">u8</span>])&gt; = pixels.<span class="hljs-title function_ invoke__">chunks_mut</span>(bounds.<span class="hljs-number">0</span>).<span class="hljs-title function_ invoke__">enumerate</span>().<span class="hljs-title function_ invoke__">collect</span>();<br><br>bands.<span class="hljs-title function_ invoke__">into_par_iter</span>().for_each(|(i, band)| &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">top</span> = i;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">band_bounds</span> = (bounds.<span class="hljs-number">0</span>, <span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">band_upper_left</span> = <span class="hljs-title function_ invoke__">pixed_to_point</span>(bounds, (<span class="hljs-number">0</span>, top), upper_left, lower_right);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">band_lower_right</span> = <span class="hljs-title function_ invoke__">pixed_to_point</span>(bounds, (bounds.<span class="hljs-number">0</span>, top + <span class="hljs-number">1</span>), upper_left, lower_right);<br>    <span class="hljs-title function_ invoke__">render</span>(band, band_bounds, band_upper_left, band_lower_right);<br>&#125;);<br></code></pre></td></tr></table></figure><p>é¦–å…ˆï¼Œåˆ›å»º bandsï¼Œä¹Ÿå°±æ˜¯è¦ä¼ ç»™ rayonçš„ä»»åŠ¡é›†åˆã€‚æ¯ä¸ªä»»åŠ¡åªæ˜¯ä¸€ä¸ªå…ƒç»„ç±»å‹ (usize, &amp;mut[u8])ï¼šç¬¬ä¸€ä¸ªæ˜¯è®¡ç®—æ‰€éœ€çš„è¡Œå·ï¼Œç¬¬äºŒä¸ªæ˜¯è¦å¡«å……çš„ pixels åˆ‡ç‰‡ã€‚æˆ‘ä»¬ä½¿ç”¨chunks_mut æ–¹æ³•å°†å›¾åƒç¼“å†²åŒºåˆ†æˆä¸€äº›è¡Œï¼Œenumerateåˆ™ä¼šç»™æ¯ä¸€è¡Œæ·»åŠ è¡Œå·ï¼Œç„¶å collectä¼šå°†æ‰€æœ‰æ•°å€¼åˆ‡ç‰‡å¯¹æ”¾å…¥ä¸€ä¸ªå‘é‡ä¸­ã€‚ï¼ˆè¿™é‡Œéœ€è¦ä¸€ä¸ªå‘é‡ï¼Œå› ä¸º rayonåªèƒ½ä»æ•°ç»„å’Œå‘é‡ä¸­åˆ›å»ºå¹¶è¡Œè¿­ä»£å™¨ã€‚ï¼‰</p><p>ç¼–è¯‘ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo build --release<br></code></pre></td></tr></table></figure><p>å†æ¬¡æ‰§è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">time ./target/release/mandelbrot mandel.png 4000x3000 -1.20,0.35 -1,0.20<br>./target/release/mandelbrot mandel.png 4000x3000 -1.20,0.35 -1,0.20  3.96s user 0.01s system 973% cpu 0.408 total<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ¬¡é€Ÿåº¦æå‡æ›´åŠ æ˜æ˜¾ï¼Œæ€»å…±åªç”¨äº† 0.4s å·¦å³çš„æ—¶é—´ã€‚</p><p>ä»¥ä¸Šå°±æ˜¯å®ç”¨ Rust ç»˜åˆ¶æ›¼å¾·åšé›†å®æˆ˜çš„å…¨éƒ¨å†…å®¹ï¼Œenjoyï¼Œhappycoding~</p>]]></content>
    
    
    <summary type="html">æœ¬æ–‡å‚è€ƒã€ŠRust ç¨‹åºè®¾è®¡ï¼ˆç¬¬äºŒç‰ˆï¼‰ã€‹ä¸­ç¬¬äºŒç« çš„ç¤ºä¾‹ï¼Œä¸è¯»è€…åˆ†äº«**æ›¼å¾·åšé›†**çš„ç»˜åˆ¶è¿‡ç¨‹ã€‚</summary>
    
    
    
    <category term="Rust" scheme="https://hedon.top/categories/Rust/"/>
    
    <category term="Rust å®æˆ˜" scheme="https://hedon.top/categories/Rust/Rust-%E5%AE%9E%E6%88%98/"/>
    
    
    <category term="Rust" scheme="https://hedon.top/tags/Rust/"/>
    
  </entry>
  
  <entry>
    <title>Rust Web æ¡†æ¶ Axum æŒ‡å—</title>
    <link href="https://hedon.top/2024/01/14/rust-axum/"/>
    <id>https://hedon.top/2024/01/14/rust-axum/</id>
    <published>2024-01-13T16:28:03.000Z</published>
    <updated>2024-01-22T15:47:54.686Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç»“è®ºå…ˆè¡Œ">ç»“è®ºå…ˆè¡Œ</h1><h1 id="hello-world">Hello World</h1><p>å…ˆæ¥çœ‹çœ‹ Axum çš„ Hello Worldï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> axum::Router;<br><span class="hljs-keyword">use</span> axum::routing::get;<br><br><span class="hljs-meta">#[tokio::main]</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªåº”ç”¨ï¼Œå¸¦ä¸€ä¸ª / è·¯ç”±ï¼Œè¾“å‡º Hello World</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">app</span> = Router::<span class="hljs-title function_ invoke__">new</span>()<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-title function_ invoke__">get</span>(|| <span class="hljs-keyword">async</span> &#123; <span class="hljs-string">&quot;Hello World!&quot;</span> &#125;));<br><br>    <span class="hljs-comment">// ç›‘å¬ 3000 ç«¯å£</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">listener</span> = tokio::net::TcpListener::<span class="hljs-title function_ invoke__">bind</span>(<span class="hljs-string">&quot;0.0.0.0:3000&quot;</span>).<span class="hljs-keyword">await</span>.<span class="hljs-title function_ invoke__">unwrap</span>();<br><br>    <span class="hljs-comment">// å¯åŠ¨æœåŠ¡</span><br>    axum::<span class="hljs-title function_ invoke__">serve</span>(listener, app).<span class="hljs-keyword">await</span>.<span class="hljs-title function_ invoke__">unwrap</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢è¿™ä¸ªä¾‹å­ï¼Œå¯ä»¥å¾—åˆ°çš„ç¬¬ä¸€ä¸ªä¿¡æ¯å°±æ˜¯ï¼š<code>Axum</code> æ˜¯<code>tokic</code> ç”Ÿæ€ä¸‹çš„ä¸€å‘˜ã€‚</p><blockquote><p>æœ¬æ–‡é»˜è®¤è¯»è€…å¯¹ <code>tokio</code> å…·æœ‰åŸºæœ¬çš„äº†è§£ã€‚</p></blockquote><p>æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦å¼•å…¥ä¸¤ä¸ªç»„ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo add tokio --features macros,rt-multi-thread<br>cargo add axum<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªä¾‹å­æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªè·¯ç”±ï¼Œä¸‹é¢æˆ‘ä»¬å°±å…ˆä» Axum çš„è·¯ç”±å¼€å§‹ä»‹ç»ã€‚</p><h1 id="routing-è·¯ç”±">Routing è·¯ç”±</h1><h2 id="å•ä¸ªè·¯ç”±">å•ä¸ªè·¯ç”±</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust">Router::<span class="hljs-title function_ invoke__">new</span>().<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-title function_ invoke__">get</span>(|| <span class="hljs-keyword">async</span> &#123; <span class="hljs-string">&quot;Hello World!&quot;</span> &#125;));<br></code></pre></td></tr></table></figure><p>å®é™…ä¸Šå®ƒç­‰ä»·äºï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[tokio::main]</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">app</span> = Router::<span class="hljs-title function_ invoke__">new</span>()<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-title function_ invoke__">get</span>(handler_hello_world));<br> ...<br>&#125;<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">handler_hello_world</span> () <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">impl</span> <span class="hljs-title class_">IntoResponse</span> &#123;<br>    <span class="hljs-string">&quot;Hello World&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è·¯ç”±æ³¨å†Œéƒ¨åˆ†ä¸ºä¸º <code>path</code>ã€<code>method</code> å’Œ<code>handler</code> ä¸‰ä¸ªéƒ¨åˆ†ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240114141604009.png"alt="è·¯ç”±æ³¨å†Œéƒ¨åˆ†" /><figcaption aria-hidden="true">è·¯ç”±æ³¨å†Œéƒ¨åˆ†</figcaption></figure><p>å…¶ä¸­ <code>get</code> å¯ä»¥æ›¿æ¢ä¸º<code>post</code>ã€<code>patch</code>ã€<code>delete</code>ã€<code>head</code>å’Œ <code>options</code> ç­‰ http methodã€‚</p><p>å…¶ä¸­ <code>handler</code>çš„è¿”å›å€¼éœ€è¦æ»¡è¶³ï¼š<code>impl IntoResponse</code>ï¼Œå¸¸ç”¨çš„<code>å­—ç¬¦ä¸²</code>ã€<code>json</code> å’Œ <code>html</code> éƒ½å·²ç»å®ç°äº†<code>IntoResponse</code>ï¼Œæ‰€ä»¥éƒ½æ˜¯å¯ä»¥ç›´æ¥è¿”å›çš„ã€‚</p><h2 id="è·¯ç”±åˆ†ç»„">è·¯ç”±åˆ†ç»„</h2><p>ä½ å¯ä»¥ä½¿ç”¨ <code>merge()</code> å’Œ <code>nest()</code>æ¥è¿›è¡Œè·¯ç”±åˆ†ç»„ï¼Œå…¶ä¸­ <code>nest()</code> å¯ä»¥æŒ‡å®šç»Ÿä¸€è·¯ç”±å‰ç¼€ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[tokio::main]</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">app</span> = Router::<span class="hljs-title function_ invoke__">new</span>()<br>        .<span class="hljs-title function_ invoke__">merge</span>(<span class="hljs-title function_ invoke__">todo_routers</span>())<br>        .<span class="hljs-title function_ invoke__">nest</span>(<span class="hljs-string">&quot;/v2/todo&quot;</span>, <span class="hljs-title function_ invoke__">todo_routers_v2</span>());<br>...<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">todo_routers</span>() <span class="hljs-punctuation">-&gt;</span> Router &#123;<br>    Router::<span class="hljs-title function_ invoke__">new</span>()<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;/todo/delete/:id&quot;</span>, <span class="hljs-title function_ invoke__">delete</span>(handler_todo_delete))<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;/todo/list&quot;</span>, <span class="hljs-title function_ invoke__">get</span>(handler_todo_list))<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;/todo/create&quot;</span>, <span class="hljs-title function_ invoke__">post</span>(handler_todo_create))<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;/todo/update&quot;</span>, <span class="hljs-title function_ invoke__">put</span>(handler_todo_update))<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">todo_routers_v2</span>() <span class="hljs-punctuation">-&gt;</span> Router &#123;<br>    Router::<span class="hljs-title function_ invoke__">new</span>()<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;/delete/:id&quot;</span>, <span class="hljs-title function_ invoke__">delete</span>(handler_todo_delete))<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;/list&quot;</span>, <span class="hljs-title function_ invoke__">get</span>(handler_todo_list))<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;/create&quot;</span>, <span class="hljs-title function_ invoke__">post</span>(handler_todo_create))<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;/update&quot;</span>, <span class="hljs-title function_ invoke__">put</span>(handler_todo_update))<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="é™æ€è·¯ç”±">é™æ€è·¯ç”±</h2><p>å¯ä»¥ä½¿ç”¨åŒ <code>tokio</code> ç”Ÿæ€ä¸‹çš„ <code>tower-http</code>æ¥å®ç°é™æ€è·¯ç”±ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">static_routers</span>() <span class="hljs-punctuation">-&gt;</span> Router &#123;<br>    Router::<span class="hljs-title function_ invoke__">new</span>().<span class="hljs-title function_ invoke__">nest_service</span>(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-title function_ invoke__">get_service</span>(ServeDir::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;./&quot;</span>)))<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä½ éœ€è¦æ·»åŠ  <code>tower-http</code> ç»„ä»¶ï¼Œè‡³å°‘éœ€è¦è½½å…¥<code>fs</code> ç‰¹æ€§ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo add tower-http --features fs<br></code></pre></td></tr></table></figure><h1 id="å‚è€ƒ">å‚è€ƒ</h1><ul><li><a href="https://docs.rs/axum/latest/axum/">Rust-Axum</a></li></ul>]]></content>
    
    
    <summary type="html">æœ¬æ–‡è¯¦ç»†ä»‹ç»äº† Rust ä¸­çš„ Web æ¡†æ¶ Axumï¼ŒåŒ…å«äº† Axum çš„åŸºç¡€å’Œé«˜é˜¶åŠŸèƒ½ï¼Œæ–‡ä¸­åŒ…å«äº†å¤§é‡ç¤ºä¾‹ï¼Œå¸Œæœ›èƒ½å¯¹è¯»è€…äº†è§£ Axum å¸¦æ¥ä¸€ç‚¹å¸®åŠ©ã€‚</summary>
    
    
    
    <category term="Rust" scheme="https://hedon.top/categories/Rust/"/>
    
    <category term="web æ¡†æ¶" scheme="https://hedon.top/categories/Rust/web-%E6%A1%86%E6%9E%B6/"/>
    
    
    <category term="Rust" scheme="https://hedon.top/tags/Rust/"/>
    
    <category term="Axum" scheme="https://hedon.top/tags/Axum/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€æ–‡å½»åº•æŒæ¡æµ®ç‚¹æ•°</title>
    <link href="https://hedon.top/2023/12/23/floating-point-number/"/>
    <id>https://hedon.top/2023/12/23/floating-point-number/</id>
    <published>2023-12-23T13:51:52.000Z</published>
    <updated>2024-03-16T10:51:12.651Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç»å…¸é—®é¢˜">ç»å…¸é—®é¢˜</h2><p>0.1 + 0.2 = ï¼Ÿ</p><p>æˆ‘ä»¬å†™ä¸ª Go ç¨‹åºæ¥æµ‹è¯•ä¸€ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> f1 <span class="hljs-type">float64</span> = <span class="hljs-number">0.1</span><br><span class="hljs-keyword">var</span> f2 <span class="hljs-type">float64</span> = <span class="hljs-number">0.2</span><br>fmt.Println(f1+f2 == <span class="hljs-number">0.3</span>)<br>fmt.Println(f1 + f2)<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-literal">false</span><br>0.30000000000000004<br></code></pre></td></tr></table></figure><p>å¦‚æ­¤è¿èƒŒ â€œå¸¸è¯†â€çš„ç»“æœï¼Œå…¶å®æ˜¯å› ä¸ºå½“ä¸‹è®¡ç®—æœºä½“ç³»ä¸­å°æ•°çš„è¡¨ç¤ºæ–¹å¼æ˜¯æµ®ç‚¹æ•°ï¼Œè€Œè®¡ç®—æœºä¸­å¯¹æµ®ç‚¹æ•°çš„è¡¨ç¤ºå¹¶éç™¾åˆ†ç™¾ç²¾ç¡®çš„ï¼Œåœ¨è¡¨ç¤ºå’Œè®¡ç®—è¿‡ç¨‹ä¸­éƒ½æœ‰å¯èƒ½ä¼šä¸¢å¤±ç²¾åº¦ã€‚</p><p>è¿™è¿«ä½¿å¿…é¡»æ·±å…¥ç†è§£æµ®ç‚¹æ•°åœ¨è®¡ç®—æœºä¸­çš„å­˜å‚¨æ–¹å¼åŠæ€§è´¨ï¼Œæ‰èƒ½æ­£ç¡®å¤„ç†å…³äºæ•°å­—çš„è®¡ç®—é—®é¢˜ã€‚</p><h2 id="ç»“è®ºå…ˆè¡Œ">ç»“è®ºå…ˆè¡Œ</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/IEEE-754%20%E6%B5%AE%E7%82%B9%E6%95%B0.jpg"alt="IEEE-754 æµ®ç‚¹æ•°" /><figcaption aria-hidden="true">IEEE-754 æµ®ç‚¹æ•°</figcaption></figure><h2 id="å®šç‚¹æ•°">å®šç‚¹æ•°</h2><p>è¦ç†è§£æµ®ç‚¹æ•°çš„ç¬¬ä¸€æ­¥æ˜¯è€ƒè™‘å«æœ‰å°æ•°å€¼çš„äºŒè¿›åˆ¶æ•°å­—ã€‚åœ¨è¿™ä¹‹å‰ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æ›´åŠ ç†Ÿæ‚‰çš„åè¿›åˆ¶è¡¨ç¤ºæ³•ï¼š</p><p><span class="math display">\[d_md_{m-1} Â·Â·Â· d_1d_0 . d_{-1}d_{-2}Â·Â·Â· d_{-n}\]</span></p><p>å°æ•°ç‚¹ <code>.</code>å·¦è¾¹æ˜¯æ•´æ•°éƒ¨åˆ†ï¼Œå³è¾¹æ˜¯å°æ•°éƒ¨åˆ†ã€‚å…¶ä¸­æ¯ä¸ªåè¿›åˆ¶æ•° <code>di</code>çš„å–å€¼èŒƒå›´æ˜¯ 0~9ã€‚</p><p>å¦‚åè¿›åˆ¶çš„ <code>12.34</code> å³å¯ä»¥è¡¨ç¤ºä¸ºï¼š</p><p><span class="math display">\[1Ã—10^1+2Ã—10^0+3Ã—10^{-1}+4Ã—10^{-2}\]</span></p><p>é‚£å…¶å®äºŒè¿›åˆ¶ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ï¼Œåªä¸è¿‡æŠŠå…¶ä¸­çš„ <code>10</code> æ¢æˆ<code>2</code>ï¼Œè€Œ <code>di</code> çš„å–å€¼èŒƒå›´ä¸º 0~1ã€‚</p><p>å¦‚äºŒè¿›åˆ¶çš„ <code>101.11</code> å¯ä»¥è¡¨ç¤ºä¸ºï¼š</p><p><span class="math display">\[1Ã—2^2+0Ã—2^1+1Ã—2^0+1Ã—2^{-1}+1Ã—2^{-2}\]</span></p><p>å¦‚æœæˆ‘ä»¬ä»…è€ƒè™‘æœ‰é™é•¿åº¦çš„ç¼–ç ï¼Œé‚£ä¹ˆåè¿›åˆ¶è¡¨ç¤ºæ³•ä¸èƒ½å‡†ç¡®è¡¨è¾¾åƒ 1/3 å’Œ5/7è¿™æ ·çš„æ•°ã€‚ç±»ä¼¼çš„ï¼Œå°æ•°çš„äºŒè¿›åˆ¶è¡¨ç¤ºæ³•åªèƒ½è¡¨ç¤ºé‚£äº›èƒ½å¤Ÿè¢«å†™æˆä»¥ä¸‹å½¢å¼çš„æ•°ï¼š</p><p><span class="math display">\[x Ã— 2^y\]</span></p><p>å…¶ä»–çš„å€¼å°±åªèƒ½è¿‘ä¼¼åœ°è¡¨ç¤ºã€‚</p><p>å®šç‚¹æ•°çš„æ•´æ•°éƒ¨åˆ†æ˜¯å°æ•°éƒ¨åˆ†çš„ä½æ•°æ˜¯å›ºå®šä¸å˜çš„ï¼Œåœ¨ä½æ•°æœ‰é™çš„æƒ…å†µä¸‹ï¼Œå®šç‚¹æ•°çš„å–å€¼èŒƒå›´å’Œç²¾åº¦éƒ½æ¯”è¾ƒå·®ã€‚äºæ˜¯å°±æœ‰äº†IEEE-754 æå‡ºçš„æµ®ç‚¹æ•°è¡¨ç¤ºæ³•ã€‚</p><h2 id="æµ®ç‚¹æ•°">æµ®ç‚¹æ•°</h2><p>æ‰€è°“â€œæµ®ç‚¹æ•°â€ï¼ˆFloating-pointnumbersï¼‰ï¼Œå³å°æ•°ç‚¹å¯ä»¥â€œ<strong>æµ®åŠ¨</strong>â€ï¼Œå³å°æ•°ç‚¹çš„ä½ç½®ä¸æ˜¯å›ºå®šçš„ï¼Œè€Œæ˜¯å¯ä»¥æ ¹æ®æ•°å€¼çš„å¤§å°å’Œç²¾åº¦éœ€æ±‚ç§»åŠ¨çš„ã€‚è¿™ç§è¡¨ç¤ºæ³•å…è®¸åœ¨å¹¿æ³›çš„èŒƒå›´å†…è¡¨ç¤ºæ•°å€¼ï¼ŒåŒæ—¶ä¿æŒç›¸å¯¹æ’å®šçš„ç²¾åº¦ã€‚</p><p>åœ¨è®¡ç®—æœºä¸­ï¼Œæµ®ç‚¹æ•°é€šå¸¸éµå¾ª IEEE-754æ ‡å‡†ã€‚è¿™ä¸ªæ ‡å‡†å®šä¹‰äº†æµ®ç‚¹æ•°çš„å­˜å‚¨å’Œè¿ç®—æ–¹å¼ï¼Œç¡®ä¿äº†ä¸åŒè®¡ç®—æœºç³»ç»Ÿä¹‹é—´çš„ä¸€è‡´æ€§ã€‚IEEE-754ç”¨ä»¥ä¸‹å½¢å¼æ¥è¡¨ç¤ºä¸€ä¸ªæ•°ï¼š</p><p><span class="math display">\[V = (-1)^sÃ—MÃ—2^E\]</span></p><p>å…¶ä¸­ï¼š</p><ul><li><strong>s ç¬¦å·ä½ï¼ˆSign bitï¼‰</strong>ï¼šè¡¨ç¤ºæ•°å€¼çš„æ­£è´Ÿã€‚</li><li><strong>M å°¾æ•°ï¼ˆMantissaï¼‰</strong>ï¼šè¡¨ç¤ºæ•°å€¼çš„æœ‰æ•ˆæ•°å­—ã€‚</li><li><strong>E æŒ‡æ•°ï¼ˆExponentï¼‰</strong>ï¼šå†³å®šå°æ•°ç‚¹çš„ä½ç½®ã€‚</li></ul><p>IEEE-754å°†æµ®ç‚¹æ•°çš„ä½è¡¨ç¤ºåˆ’åˆ†æˆä¸‰ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«å¯¹å„ä¸ªéƒ¨åˆ†è¿›è¡Œç¼–ç ï¼Œå¯¹åº”ä¸Šé¢å…¬å¼å³è¾¹çš„3 ä¸ªå­—æ¯ï¼š</p><ul><li>ä¸€ä¸ªå•ç‹¬çš„ç¬¦å·ä½ <code>s</code> ç›´æ¥ç¼–ç ç¬¦å· <code>s</code>ã€‚</li><li><span class="math inline">\(k\)</span> ä½çš„é˜¶ç å­—æ®µ <spanclass="math inline">\(exp=e_{k-1}\cdots e_1e_0\)</span> ç¼–ç é˜¶ç <code>E</code>ã€‚</li><li><span class="math inline">\(n\)</span> ä½å°æ•°å­—æ®µ <spanclass="math inline">\(frac=f_{n-1}\cdots f_1f_0\)</span> ç¼–ç å°¾æ•°<code>M</code>ï¼Œä½†æ˜¯ç¼–ç å‡ºæ¥çš„å€¼ä¹Ÿä¾èµ–äºé˜¶ç å­—æ®µçš„å€¼æ˜¯å¦ç­‰äº 0ã€‚</li></ul><p>åœ¨ IEEE-754 æ ‡å‡†ä¸­ï¼Œå®šä¹‰äº†ä¸¤ç§ç²¾åº¦çš„æµ®ç‚¹æ•°ï¼Œåˆ†åˆ«æ˜¯å•ç²¾åº¦æµ®ç‚¹æ•°ï¼ˆ32ä½ï¼‰å’ŒåŒç²¾åº¦æµ®ç‚¹æ•°ï¼ˆ64 ä½ï¼‰ã€‚</p><p>å•ç²¾åº¦ï¼š</p><ul><li>1 ä½ç¬¦å·ä½ s</li><li>8 ä½æŒ‡æ•° exp</li><li>23 ä½å°¾æ•° frac</li></ul><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20231224102703581.png"alt="å•ç²¾åº¦æµ®ç‚¹æ•°" /><figcaption aria-hidden="true">å•ç²¾åº¦æµ®ç‚¹æ•°</figcaption></figure><p>åŒç²¾åº¦ï¼š</p><ul><li>1 ä½ç¬¦å·ä½ s</li><li>11 ä½æŒ‡æ•° exp</li><li>52 ä½å°¾æ•° frac</li></ul><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20231224102756244.png"alt="åŒç²¾åº¦æµ®ç‚¹æ•°" /><figcaption aria-hidden="true">åŒç²¾åº¦æµ®ç‚¹æ•°</figcaption></figure><p>æ ¹æ® <code>exp</code> çš„å€¼ï¼Œæµ®ç‚¹æ•°åˆå¯ä»¥åˆ†æˆä¸‰ç±»ï¼š</p><ol type="1"><li>è§„æ ¼åŒ–çš„</li><li>éè§„æ ¼åŒ–çš„</li><li>ç‰¹æ®Šçš„</li></ol><p>å…¶ä¸­ç¬¬ä¸‰ç±»â€œç‰¹æ®Šçš„â€åˆå¯ä»¥æ ¹æ® <code>frac</code> åˆ†æˆä¸¤ç±»ï¼š</p><ol type="1"><li>æ— ç©·å¤§</li><li>ä¸æ˜¯ä¸€ä¸ªæ•° NaNï¼ˆNot a Numberï¼‰</li></ol><p>å…·ä½“å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p><table><thead><tr class="header"><th></th><th style="text-align: center;">exp</th><th style="text-align: center;">frac</th></tr></thead><tbody><tr class="odd"><td>è§„æ ¼åŒ–çš„</td><td style="text-align: center;">â‰ 0 &amp; â‰  255</td><td style="text-align: center;">f</td></tr><tr class="even"><td>éè§„æ ¼åŒ–çš„</td><td style="text-align: center;">0</td><td style="text-align: center;">f</td></tr><tr class="odd"><td>ç‰¹æ®Šçš„</td><td style="text-align: center;">1</td><td style="text-align: center;">f</td></tr><tr class="even"><td>- æ— ç©·å¤§</td><td style="text-align: center;">1</td><td style="text-align: center;">0</td></tr><tr class="odd"><td>- NaN</td><td style="text-align: center;">1</td><td style="text-align: center;">â‰ 0</td></tr></tbody></table><p>å¯¹äºä¸åŒç±»å‹çš„æµ®ç‚¹æ•°ï¼Œåœ¨è®¡ç®—å…¬å¼ <spanclass="math inline">\(V=(-1)^sÃ—MÃ—2^E\)</span>ä¸­ï¼Œ<code>exp -&gt; E</code> å’Œ <code>frac -&gt; M</code>çš„æ–¹å¼æœ‰æ‰€ä¸åŒã€‚</p><p>ä¸‹é¢æˆ‘ä»¬æ¥å¯¹è¿™å‡ ç§ä¸åŒç±»å‹è¿›è¡Œè¯¦ç»†è®¨è®ºï¼Œå…¶ä¸­ä¸ä¹æœ‰ä¸€äº›å¾ˆæœ‰è¶£ä¸”å……æ»¡æ™ºæ…§çš„è®¾è®¡ç†å¿µã€‚</p><h3 id="ç‰¹æ®Šå€¼-special-values">ç‰¹æ®Šå€¼ Special Values</h3><ul><li><strong>æŒ‡æ•°éƒ¨åˆ†</strong>ï¼šå…¨ä¸º 0ã€‚</li><li><strong>å°¾æ•°éƒ¨åˆ†</strong>ï¼šå…¨ä¸º 0 åˆ™è¡¨ç¤ºæ— ç©·å¤§ï¼Œä¸å…¨ä¸º 0 åˆ™è¡¨ç¤ºNaNã€‚</li><li><strong>ä½œç”¨</strong>ï¼šç‰¹æ®Šå€¼ç”¨äºè¡¨ç¤ºé‚£äº›æ— æ³•ç”¨å¸¸è§„æ•°å€¼è¡¨ç¤ºçš„æƒ…å†µï¼Œå¦‚æ— ç©·å¤§ã€éæ•°ï¼ˆNaNï¼‰ç­‰ã€‚è¿™äº›å€¼é€šå¸¸ç”¨äºæ“ä½œçš„é”™è¯¯æˆ–ç‰¹æ®Šæƒ…å†µçš„ç»“æœï¼Œå¦‚é™¤ä»¥0ã€æ— æ•ˆæ“ä½œç­‰ã€‚</li></ul><h3 id="è§„æ ¼åŒ–çš„å€¼-normalize-values">è§„æ ¼åŒ–çš„å€¼ Normalize Values</h3><ul><li><strong>æŒ‡æ•°éƒ¨åˆ†</strong>ï¼šä¸å…¨ä¸º 0 ä¸”ä¸å…¨ä¸º 1ã€‚</li><li><strong>å°¾æ•°éƒ¨åˆ†</strong>ï¼šå¯ä»¥æ˜¯ä»»æ„å€¼ã€‚</li><li><strong>ä½œç”¨</strong>ï¼šç”¨äºè¡¨ç¤ºå¤§å¤šæ•°éé›¶æ•°å€¼</li></ul><p>åœ¨è§„æ ¼åŒ–å€¼ä¸­ï¼š</p><ul><li><span class="math inline">\(E=e-bias\)</span></li><li><span class="math inline">\(M=1+f\)</span></li></ul><p>å…¶ä¸­ <code>e</code> å³ä¸º <code>exp</code>ï¼Œï¼Œ<code>bias</code>æ˜¯åç½®é‡ï¼Œå®ƒçš„å€¼ä¸º <span class="math inline">\(2^{k-1} -1\)</span>ï¼Œå…¶ä¸­<code>k</code> ä¸º <code>exp</code> çš„ä½æ•°ï¼Œæ•…ï¼š</p><ul><li>åœ¨å•ç²¾åº¦ä¸­ï¼Œ<spanclass="math inline">\(bias=2^{8-1}-1=2^7-1=128-1=127\)</span></li><li>åœ¨åŒç²¾åº¦ä¸­ï¼Œ<spanclass="math inline">\(bias=2^{11-1}-1=2^{10}-1=1024-1=1023\)</span></li></ul><p>å…¶ä¸­ <code>f</code> ä¸º <code>frac</code> è¡¨ç¤ºçš„æ•°ï¼ŒèŒƒå›´ <spanclass="math inline">\(0â‰¤f&lt;1\)</span>ã€‚</p><p>æ‰€ä»¥ä¸€ä¸ªè§„æ ¼åŒ–æ•°ï¼Œå…·ä½“å¯ä»¥è¡¨ç¤ºä¸ºï¼š</p><p><span class="math display">\[V=(-1)^{sign}Ã—1.fracÃ—2^{(exp-bias)}\]</span></p><p>è¿™é‡Œæœ‰ 4 ä¸ªé—®é¢˜ï¼š</p><ol type="1"><li>è¿™ä¸ª <code>bias</code> æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>ä¸ºä»€ä¹ˆ <code>E</code> è¦ <code>e</code> å»å‡æ‰ä¸€ä¸ª<code>bias</code>ï¼Ÿ</li><li><code>bias</code> çš„å€¼æ˜¯æ€ä¹ˆå®šä¸‹çš„ï¼Œå¦‚å•ç²¾åº¦ä¸ºä»€ä¹ˆæ˜¯ 127ï¼Œä¸æ˜¯ 126æˆ– 128ï¼Ÿ</li><li><code>M</code> ä¸ºä»€ä¹ˆéœ€è¦ <code>f</code> å»åŠ ä¸Šä¸€ä¸ª<code>1</code>ï¼Ÿ</li></ol><p>ä¸‹é¢æˆ‘ä»¬æ¥å¯¹è¿™ 4 ä¸ªé—®é¢˜è¿›è¡Œä¸€ä¸€è§£ç­”ã€‚</p><p><strong>ç¬¬ 1 ä¸ªé—®é¢˜ï¼Œè¿™ä¸ª bias æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p><blockquote><p><code>bias</code>æ˜¯ä¸€ä¸ªé¢„è®¾çš„åç§»é‡ï¼Œç”¨äºå°†æŒ‡æ•°éƒ¨åˆ†çš„å€¼åç§»åˆ°å…¨æ­£æ•°ï¼Œä»è€Œç®€åŒ–å¤„ç†ã€‚</p></blockquote><p><strong>ç¬¬ 2 ä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆ E è¦ e å»å‡å»ä¸€ä¸ª biasï¼Ÿ</strong></p><blockquote><p>å…ˆè¯´ç»“è®ºï¼šä½¿ç”¨ biasï¼ˆåç½®æŒ‡æ•°ï¼Œbiasedexponentï¼‰å¯ä»¥å…è®¸æµ®ç‚¹æ•°ä»¥ç»Ÿä¸€çš„æ–¹å¼è¡¨ç¤ºï¼ŒåŒæ—¶ä¹Ÿä½¿å¾—æµ®ç‚¹æ•°çš„æ’åºå’Œæ¯”è¾ƒå˜å¾—ç®€å•ã€‚</p></blockquote><p>é¦–å…ˆæŒ‡æ•°è‚¯å®šå¾—æ”¯æŒæ­£è´Ÿå½¢å¼çš„å‡ºç°ï¼Œé‚£ä¹ˆç›´æ¥ä½¿ç”¨æ— ç¬¦å·æ•´å‹æ¥è¡¨ç¤ºæŒ‡æ•°è‚¯å®šæ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºå®ƒæ— æ³•è¡¨ç¤ºè´ŸæŒ‡æ•°ã€‚æš‚æ—¶å…ˆæŠ›å¼€IEEE-754 å®šä¸‹çš„æ ‡å‡†ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•ç”¨è¡¥ç æ¥è¡¨ç¤ºæŒ‡æ•°ã€‚</p><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ª 32 ä½çš„æµ®ç‚¹æ•° <code>A</code> å’Œ<code>B</code>ï¼Œå¹¶ä¸”æˆ‘ä»¬å‡è®¾å®ƒä»¬çš„æŒ‡æ•°éƒ¨åˆ†ä½¿ç”¨ 8 ä½äºŒè¿›åˆ¶è¡¥ç è¡¨ç¤ºï¼ˆè¿™ä¸IEEE-754 æ ‡å‡†ä¸åŒï¼‰ã€‚</p><ul><li><code>A</code>çš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼š<code>0 0000010 00000000000000000000000</code></li><li><code>B</code>çš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼š<code>0 1111110 00000000000000000000000</code></li></ul><p>åœ¨è¿™é‡Œï¼Œç¬¬ä¸€ä½æ˜¯ç¬¦å·ä½ï¼ˆ0 è¡¨ç¤ºæ­£æ•°ï¼‰ï¼Œæ¥ä¸‹æ¥çš„ 8ä½æ˜¯ä»¥è¡¥ç å½¢å¼è¡¨ç¤ºçš„æŒ‡æ•°ï¼Œå‰©ä¸‹çš„ 23 ä½æ˜¯å°¾æ•°ã€‚</p><p>æˆ‘ä»¬æƒ³è¦æ¯”è¾ƒè¿™ä¸¤ä¸ªæ•°çš„å¤§å°ï¼Œéœ€è¦æ€ä¹ˆåšå‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å…ˆè§£æè¿™ 2 ä¸ªæ•°ï¼š</p><ul><li>ç¬¦å·ä½ï¼šå¯¹äº <code>A</code> å’Œ <code>B</code>ï¼Œç¬¦å·ä½éƒ½æ˜¯0ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸¤ä¸ªæ­£æ•°ã€‚</li><li>æŒ‡æ•°éƒ¨åˆ†ï¼ˆä½¿ç”¨è¡¥ç è¡¨ç¤ºï¼‰<ul><li><code>A</code> çš„æŒ‡æ•°ä¸º <code>0000010</code>ï¼Œè§£è¯»ä¸ºæ­£æ•° +2ã€‚</li><li><code>B</code> çš„æŒ‡æ•°ä¸º<code>1111110</code>ï¼Œåœ¨è¡¥ç è¡¨ç¤ºä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ªè´Ÿæ•°ã€‚å…ˆåŠ å–åååŠ  1è½¬æ¢ä¸ºæ­£æ•° <code>00000010</code>ï¼Œå®ƒè¡¨ç¤º -2ã€‚</li></ul></li></ul><p>è¦æ¯”è¾ƒè¿™ 2 ä¸ªæ•°ï¼š</p><ul><li>å½“æˆ‘ä»¬æ¯”è¾ƒ <code>A</code> å’Œ <code>B</code>æ—¶ï¼Œé¦–å…ˆéœ€è¦è€ƒè™‘å®ƒä»¬çš„æŒ‡æ•°ã€‚</li><li>æŒ‡æ•° <code>A</code> ä¸º +2ï¼Œè€Œ <code>B</code> ä¸º-2ã€‚å³ä½¿å®ƒä»¬çš„å°¾æ•°éƒ¨åˆ†ç›¸åŒï¼ˆåœ¨è¿™ä¸ªä¾‹å­ä¸­éƒ½æ˜¯ 0ï¼‰ï¼Œ<code>A</code>çš„å®é™…å€¼è¦å¤§äº<code>B</code>ï¼Œå› ä¸ºæ­£æŒ‡æ•°è¡¨ç¤ºçš„æ•°å€¼èŒƒå›´è¿œå¤§äºè´ŸæŒ‡æ•°ã€‚</li></ul><p>å¯ä»¥çœ‹å‡ºï¼šä½¿ç”¨è¡¥ç è¡¨ç¤ºæŒ‡æ•°å¢åŠ äº†æ¯”è¾ƒè¿‡ç¨‹çš„å¤æ‚æ€§ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦è§£è¯»è¡¥ç å¹¶è€ƒè™‘å…¶æ­£è´Ÿã€‚ç‰¹åˆ«æ˜¯åœ¨æ¶‰åŠåˆ°è´ŸæŒ‡æ•°çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸èƒ½ä»…ä»…æ¯”è¾ƒäºŒè¿›åˆ¶è¡¨ç¤ºçš„å¤§å°ï¼Œè€Œå¿…é¡»å°†è¡¥ç è½¬æ¢ä¸ºå®é™…çš„æ•°å€¼ï¼Œç„¶åå†è¿›è¡Œæ¯”è¾ƒã€‚</p><p>ç°åœ¨å›è¿‡å¤´æ¥çœ‹çœ‹ IEEE-754 çš„è®¾è®¡ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªå•ç²¾åº¦ï¼ˆ32 ä½ï¼‰æµ®ç‚¹æ•°<code>A</code> å’Œ <code>B</code>ï¼š</p><ul><li><code>A</code>çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸ºï¼š<code>0 10000010 00000000000000000000000</code></li><li><code>B</code>çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸ºï¼š<code>0 01111110 00000000000000000000000</code></li></ul><p>è§£æè¿™ä¸¤ä¸ªæ•°ï¼š</p><ul><li><code>A</code>ï¼šç¬¦å·ä½ä¸º 0ï¼ˆæ­£æ•°ï¼‰ï¼ŒæŒ‡æ•°éƒ¨åˆ†ä¸º<code>10000010</code>ï¼ˆäºŒè¿›åˆ¶ï¼Œå¯¹åº”åè¿›åˆ¶çš„ 130ï¼‰ï¼Œå°¾æ•°éƒ¨åˆ†ä¸ºå…¨ 0ã€‚</li><li><code>B</code>ï¼šç¬¦å·ä½ä¸º 0ï¼ˆæ­£æ•°ï¼‰ï¼ŒæŒ‡æ•°éƒ¨åˆ†ä¸º<code>01111110</code>ï¼ˆäºŒè¿›åˆ¶ï¼Œå¯¹åº”åè¿›åˆ¶çš„ 126ï¼‰ï¼Œå°¾æ•°éƒ¨åˆ†ä¸ºå…¨ 0ã€‚</li></ul><p>è®¡ç®—å®é™…æŒ‡æ•°å€¼ï¼šå•ç²¾åº¦æµ®ç‚¹æ•°çš„åç½®å€¼ <code>bias</code> ä¸º127ï¼Œæ•…ï¼š</p><ul><li><code>A</code> çš„å®é™…æŒ‡æ•° <code>E = 130 - 127 = 3</code>ã€‚</li><li><code>B</code> çš„å®é™…æŒ‡æ•° <code>E = 126 - 127 = -1</code>ã€‚</li></ul><p>æ¯”è¾ƒè¿™ä¸¤ä¸ªæ•°ï¼š</p><ul><li>åœ¨å‡å» <code>bias</code>åï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ¯”è¾ƒæŒ‡æ•°éƒ¨åˆ†çš„äºŒè¿›åˆ¶è¡¨ç¤ºæ¥ç¡®å®šæ•°å€¼çš„å¤§å°ã€‚</li><li>ç”±äº <code>10000010</code>ï¼ˆ130ï¼‰å¤§äº<code>01111110</code>ï¼ˆ126ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç›´æ¥å¾—å‡º <code>A</code> å¤§äº<code>B</code>ï¼Œè€Œæ— éœ€è€ƒè™‘è´ŸæŒ‡æ•°çš„å¤æ‚è¡¨ç¤ºé—®é¢˜ã€‚</li></ul><p>è¿™ä¸ªä¾‹å­è¯´æ˜äº†é€šè¿‡å‡å»åç½®å€¼ï¼ŒIEEE-754æ ‡å‡†èƒ½å¤Ÿç®€åŒ–æµ®ç‚¹æ•°çš„æ¯”è¾ƒå’Œæ’åºæ“ä½œã€‚åç½®åçš„æŒ‡æ•°è¡¨ç¤ºæ–¹æ³•å…è®¸è®¡ç®—æœºä»¥ç»Ÿä¸€å’Œé«˜æ•ˆçš„æ–¹å¼å¤„ç†æµ®ç‚¹æ•°ï¼Œæ— è®ºå®ƒä»¬çš„å®é™…æ•°å€¼å¤§å°å¦‚ä½•ã€‚</p><p><strong>ç¬¬ 3 ä¸ªé—®é¢˜ï¼šbias çš„å€¼æ˜¯æ€ä¹ˆå®šä¸‹çš„ï¼Œå¦‚å•ç²¾åº¦ä¸ºä»€ä¹ˆæ˜¯127ï¼Œè€Œä¸æ˜¯ 126 æˆ– 128ï¼Ÿ</strong></p><blockquote><p><code>bias</code>å€¼çš„é€‰æ‹©ï¼Œæ˜¯ä¸ºäº†å¹³è¡¡æ­£è´ŸæŒ‡æ•°çš„è¡¨ç¤ºèŒƒå›´ï¼Œå¹¶ä¸”å……åˆ†åˆ©ç”¨æŒ‡æ•°éƒ¨åˆ†çš„å­˜å‚¨ç©ºé—´ã€‚</p></blockquote><p>ä»¥å•ç²¾åº¦ä¸ºä¾‹ï¼Œ<code>exp</code> å äº† 8 ä½ï¼Œ8ä½äºŒè¿›åˆ¶å¯ä»¥è¡¨ç¤ºçš„å€¼çš„èŒƒå›´æ˜¯ <spanclass="math inline">\([0,255]\)</span>ã€‚å¦‚æœæˆ‘ä»¬é€‰æ‹© 127 ä½œä¸º<code>bias</code>ï¼Œåˆ™å­˜å‚¨çš„æŒ‡æ•°èŒƒå›´å°±æ˜¯ <spanclass="math inline">\([-127,128]\)</span>ã€‚è¿™æ ·å¯ä»¥ä½¿å¾—æŒ‡æ•°éƒ¨åˆ†å¯ä»¥å‡åŒ€åœ°è¡¨ç¤ºä»è´Ÿå¤§æ•°åˆ°æ­£å¤§æ•°çš„èŒƒå›´ï¼ˆå¯¹ç§°ï¼‰ã€‚</p><p>åœ¨ IEEE-754 æ ‡å‡†ä¸­ï¼Œå…¨ 0 çš„æŒ‡æ•°è¡¨ç¤ºä¸ºéè§„æ ¼åŒ–æ•°æˆ– 0ï¼Œè€Œå…¨ 1çš„æŒ‡æ•°ç”¨äºè¡¨ç¤ºæ— ç©·å¤§æˆ– NaNï¼‰ã€‚é€‰æ‹© 127 ä½œä¸º <code>bias</code>å¯ä»¥åœ¨ä¿ç•™è¿™äº›ç‰¹æ®Šå€¼çš„åŒæ—¶ï¼Œæä¾›æœ€å¤§çš„æœ‰æ•ˆæŒ‡æ•°èŒƒå›´ã€‚</p><p><strong>ç¬¬ 4 ä¸ªé—®é¢˜ï¼šM ä¸ºä»€ä¹ˆéœ€è¦ f å»åŠ ä¸Šä¸€ä¸ª 1ï¼Ÿ</strong></p><blockquote><p>åœ¨è§„æ ¼åŒ–æ•°ä¸­éšå«æœ€é«˜ä½ 1æ˜¯ä¸ºäº†æé«˜å°¾æ•°éƒ¨åˆ†çš„è¡¨ç¤ºæ•ˆç‡ï¼Œä»è€Œå¢åŠ ç²¾åº¦ã€‚</p></blockquote><p>å…¶å®è¿™è·Ÿç§‘å­¦è®¡æ•°æ³•çš„å¾ˆåƒçš„ï¼Œä¸ºäº†ç¡®ä¿æµ®ç‚¹æ•°è¡¨ç¤ºçš„<strong>å”¯ä¸€æ€§</strong>ï¼ŒIEEE-754è§„å®šè§„æ ¼åŒ–æµ®ç‚¹æ•°æœ€é«˜ä½ä¸€å®šæ˜¯éé›¶çš„ã€‚å¦‚æœä¸è§„å®šæœ€é«˜ä½éé›¶ï¼ŒåŒä¸€ä¸ªæ•°å¯ä»¥æœ‰å¤šç§ä¸åŒçš„æµ®ç‚¹è¡¨ç¤ºï¼Œä¾‹å¦‚ï¼Œåœ¨äºŒè¿›åˆ¶ä¸­<code>0.5</code> å¯ä»¥è¡¨ç¤ºä¸º <spanclass="math inline">\(1.0Ã—2^{-1}\)</span>ï¼Œä¹Ÿå¯ä»¥è¡¨ç¤ºä½ <spanclass="math inline">\(0.1Ã—2^0\)</span> æˆ– <spanclass="math inline">\(0.01Ã—2^1\)</span>ç­‰ç­‰ã€‚è¿™ç§å¤šé‡è¡¨ç¤ºä¼šä½¿æµ®ç‚¹è¿ç®—å˜å¾—å¤æ‚ä¸”ä½æ•ˆã€‚</p><p>é‚£æ—¢ç„¶æœ€é«˜ä½æ€»æ˜¯ 1ï¼Œé‚£å°±æ²¡å¿…è¦æ˜¾ç¤ºå­˜å‚¨äº†ï¼Œè¿˜å¯ä»¥ä½¿å°¾æ•°éƒ¨åˆ†ä¸­å¤š 1ä½çš„å­˜å‚¨ç©ºé—´ï¼Œä»è€Œå…è®¸å­˜å‚¨æ›´å¤šçš„æœ‰æ•ˆæ•°å­—ï¼Œä»¥<strong>æé«˜ç²¾åº¦</strong>ã€‚</p><h3 id="éè§„æ ¼åŒ–çš„å€¼-denormalized-values">éè§„æ ¼åŒ–çš„å€¼ DenormalizedValues</h3><ul><li><strong>æŒ‡æ•°éƒ¨åˆ†</strong>ï¼šå…¨ä¸º 0ã€‚</li><li><strong>å°¾æ•°éƒ¨åˆ†</strong>ï¼šå¯ä»¥æ˜¯ä»»æ„å€¼ã€‚</li><li><strong>ä½œç”¨</strong>ï¼š<ul><li>æä¾›è¡¨ç¤ºæ•°å€¼ 0 çš„æ–¹æ³•ã€‚å› ä¸ºè§„æ ¼åŒ–ä¸­ <spanclass="math inline">\(Mâ‰¥1\)</span>ï¼Œæ‰€ä»¥æ— æ³•è¡¨ç¤º 0ã€‚</li><li>ç”¨äºè¡¨ç¤ºéå¸¸æ¥è¿‘äº 0çš„æ•°å€¼ï¼Œè¿™äº›æ•°å€¼å¤ªå°ï¼Œæ— æ³•ç”¨è§„æ ¼åŒ–æ ¼å¼è¡¨ç¤ºã€‚å®ƒä»¬å¡«è¡¥äº† 0å’Œæœ€å°è§„æ ¼åŒ–æ­£æ•°ä¹‹é—´çš„é—´éš™ï¼Œæä¾›äº†æ¸è¿‘äº 0çš„è¿ç»­è¡¨ç¤ºï¼Œé˜²æ­¢äº†æ‰€è°“çš„â€œä¸‹æº¢â€ã€‚</li></ul></li></ul><p>åœ¨éè§„æ ¼åŒ–å€¼ä¸­ï¼š</p><ul><li><span class="math inline">\(E=1-bias\)</span></li><li><span class="math inline">\(M=f\)</span></li></ul><p>æ‰€ä»¥ä¸€ä¸ªè§„æ ¼åŒ–æ•°ï¼Œå…·ä½“å¯ä»¥è¡¨ç¤ºä¸ºï¼š</p><p><span class="math display">\[V=(-1)^{sign}Ã—0.fracÃ—2^{(1-bias)}\]</span></p><p>é‚£è¿™é‡Œåˆæœ‰ 2 ä¸ªé—®é¢˜äº†ï¼š</p><ol type="1"><li>ä¸ºä»€ä¹ˆæŒ‡æ•°éƒ¨åˆ†ä¸æ˜¯ <span class="math inline">\(0-bias\)</span> è€Œæ˜¯<span class="math inline">\(1-bias\)</span>ï¼Ÿ</li><li>ä¸ºä»€ä¹ˆ M ä¸éœ€è¦éšå«çš„ 1 äº†ï¼Ÿ</li></ol><p><strong>ç¬¬ 1 ä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆæŒ‡æ•°éƒ¨åˆ†ä¸æ˜¯ 0-bias è€Œæ˜¯1-biasï¼Ÿ</strong></p><blockquote><p>è¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„è®¾è®¡ï¼Œæ—¨åœ¨ä½¿éè§„æ ¼åŒ–æ•°èƒ½å¤Ÿå¹³æ»‘åœ°è¿æ¥åˆ°è§„æ ¼åŒ–æ•°çš„æœ€å°æ­£å€¼ã€‚</p></blockquote><p>æœ€å°çš„è§„æ ¼åŒ–æ•°çš„æŒ‡æ•°ä¸º<code>1 - bias</code>ã€‚ä¸ºäº†åœ¨æ•°å€¼ä¸Šå¹³æ»‘åœ°è¿‡æ¸¡åˆ°éè§„æ ¼åŒ–æ•°ï¼Œéè§„æ ¼åŒ–æ•°çš„å®é™…æŒ‡æ•°ä¹Ÿè¢«è®¾å®šä¸º<code>1 - bias</code>ã€‚è¿™æ ·ï¼Œéè§„æ ¼åŒ–æ•°å°±å¯ä»¥ä»£è¡¨é‚£äº›å°äºæœ€å°è§„æ ¼åŒ–æ­£æ•°çš„æ•°å€¼ï¼Œè€Œä¸ä¼šå‡ºç°ä¸€ä¸ªæ•°å€¼çš„â€œé—´éš™â€ã€‚</p><p><strong>ç¬¬ 2 ä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆ M ä¸éœ€è¦éšå«çš„ 1 äº†ï¼Ÿ</strong></p><blockquote><p>ä¸åŒ…å«éšå«çš„ 1 ä½¿å¾—éè§„æ ¼åŒ–æ•°èƒ½å¤Ÿåœ¨æµ®ç‚¹æ•°è¡¨ç¤ºä¸­å¡«è¡¥ 0å’Œæœ€å°è§„æ ¼åŒ–æ•°ä¹‹é—´çš„ç©ºéš™ï¼Œæä¾›å¯¹æå°æ•°å€¼çš„è¿ç»­è¡¨ç¤ºã€‚</p></blockquote><ul><li><strong>é¿å…ä¸‹æº¢</strong>ï¼šéè§„æ ¼åŒ–æ•°é€šè¿‡å…è®¸å°¾æ•°éƒ¨åˆ†ä¸ä»¥éšå«çš„ 1å¼€å§‹ï¼ˆè€Œæ˜¯ä»¥æ˜¾å¼çš„ 0å¼€å§‹ï¼‰ï¼Œä½¿å¾—å®ƒä»¬å¯ä»¥è¡¨ç¤ºæ¯”æœ€å°è§„æ ¼åŒ–æ•°è¿˜è¦å°çš„æ•°å€¼ã€‚è¿™å¯¹äºé¿å…æ•°å€¼ä¸‹æº¢è‡³0 éå¸¸é‡è¦ï¼Œå°¤å…¶æ˜¯åœ¨ç´¯ç§¯äº†å¤šæ¬¡è¿ç®—åçš„åœºåˆã€‚</li><li><strong>ç²¾åº¦ç‰ºç‰²</strong>ï¼šä½¿ç”¨éè§„æ ¼åŒ–æ•°çš„ä»£ä»·æ˜¯ç‰ºç‰²äº†ä¸€äº›ç²¾åº¦ã€‚ç”±äºæ²¡æœ‰éšå«çš„æœ€é«˜ä½1ï¼Œéè§„æ ¼åŒ–æ•°çš„ç²¾åº¦è¾ƒä½ã€‚ä½†è¿™æ˜¯ä¸ºäº†åœ¨éå¸¸å°çš„æ•°å€¼èŒƒå›´å†…æä¾›æ•°å€¼çš„è¿ç»­æ€§æ‰€åšçš„å¿…è¦å¦¥åã€‚</li></ul><h3 id="æ€»ç»“">æ€»ç»“</h3><p>è§„æ ¼åŒ–å€¼ã€éè§„æ ¼åŒ–å€¼å’Œç‰¹æ®Šå€¼ä¸‰ç§ç±»å‹å…±åŒæ„æˆäº† IEEE-754æµ®ç‚¹æ•°æ ‡å‡†çš„å®Œæ•´è¡¨ç¤ºä½“ç³»ï¼Œä½¿å¾—æµ®ç‚¹æ•°èƒ½å¤Ÿåœ¨è®¡ç®—æœºä¸­æœ‰æ•ˆä½å¤„ç†ä»éå¸¸å°åˆ°éå¸¸å¤§çš„æ•°å€¼èŒƒå›´ï¼ŒåŒæ—¶è¿˜èƒ½åº”å¯¹ç‰¹æ®Šçš„è®¡ç®—æƒ…å†µã€‚</p><h3 id="ä¸¾ä¾‹">ä¸¾ä¾‹</h3><p>å‚è€ƒã€Šæ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿã€‹ï¼Œæˆ‘ä»¬ä»¥ 8 ä½æµ®ç‚¹æ•°ä¸ºä¾‹ï¼Œå…¶ä¸­ï¼š</p><ul><li>1 ä½ç¬¦å· s</li><li>4 ä½æŒ‡æ•° exp</li><li>3 ä½å°¾æ•° frac</li></ul><p>å¯ä»¥ç®—å‡º <spanclass="math inline">\(bias=2^{4-1}-1=2^3-1=8-1=7\)</span>ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/544558-20211104211145834-189368139.png"alt="8 ä½æµ®ç‚¹æ•°ï¼ˆâ‰¥0éƒ¨åˆ†ï¼‰" /><figcaption aria-hidden="true">8 ä½æµ®ç‚¹æ•°ï¼ˆâ‰¥0éƒ¨åˆ†ï¼‰</figcaption></figure><p>å…¶ä¸­é è¿‘ 0 çš„æ˜¯éè§„æ ¼åŒ–å€¼ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20231224130157112.png"alt="8 ä½æµ®ç‚¹æ•° - éè§„æ ¼åŒ–å€¼" /><figcaption aria-hidden="true">8 ä½æµ®ç‚¹æ•° - éè§„æ ¼åŒ–å€¼</figcaption></figure><p>ä»¥ <code>0 0000 001</code> ä¸ºä¾‹ï¼š</p><p><span class="math display">\[V = (-1)^sÃ—MÃ—2^E \\= (-1)^sÃ—0.fracÃ—2^{1-bias} \\= (-1)^0Ã—(0+(1/8))Ã—2^{1-7} \\= 1Ã—1/8Ã—2^{-6} \\=2^{(-9)} \\= 1/512\]</span></p><p>å†å¾€ä¸‹ï¼Œå°±æ˜¯è§„æ ¼åŒ–å€¼ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20231224130849986.png"alt="8 ä½æµ®ç‚¹æ•° - è§„æ ¼åŒ–å€¼" /><figcaption aria-hidden="true">8 ä½æµ®ç‚¹æ•° - è§„æ ¼åŒ–å€¼</figcaption></figure><p>ä»¥ <code>0 0110 110</code> ä¸ºä¾‹ï¼š</p><p><span class="math display">\[V = (-1)^sÃ—MÃ—2^E \\= (-1)^sÃ—1.fracÃ—2^{e-bias} \\= (-1)^0Ã—(1+6/8)Ã—2^{6-7} \\=1Ã—14/8Ã—2^{-1} \\= 14/16 \\=7/8\]</span></p><h2 id="æ•´å‹è½¬ä¸ºæµ®ç‚¹å‹">æ•´å‹è½¬ä¸ºæµ®ç‚¹å‹</h2><p>ä¸‹é¢ä»¥ä¸€ä¸ªä¾‹å­æ¥ç›´è§‚æ„Ÿå—ä¸€ä¸‹ä¸€ä¸ªæ•´å‹æ˜¯å¦‚ä½•è½¬ä¸ºæµ®ç‚¹å‹çš„ã€‚</p><p>ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ª int32 çš„æ•´å‹<code>123</code>ï¼Œæˆ‘ä»¬å¸Œæœ›å°†å…¶è½¬ä¸ºå•ç²¾åº¦æµ®ç‚¹å‹ <code>123.0</code>ã€‚</p><p><strong>1. å°†æ•´å‹ç”¨äºŒè¿›åˆ¶è¡¨ç¤ºå‡ºæ¥</strong></p><p><span class="math display">\[12345_{(10)} = 1111011_{(2)}\]</span></p><p><strong>2. è§„èŒƒåŒ–è¡¨ç¤º</strong></p><p><span class="math display">\[1111011= 1.111011Ã—2^6\]</span></p><p><strong>3. è®¡ç®—æŒ‡æ•°</strong></p><p><span class="math display">\[exp = 6 + 127 = 133_{(10)} = 10000101_{(2)}\]</span></p><p><strong>4. ç¡®å®šå°¾æ•°**</strong></p><p>è¿™æ˜¯ä¸ªè§„èŒƒåŒ–å€¼ï¼Œæ‰€ä»¥ <code>1.frac</code> çš„ <code>1</code>çœç•¥ï¼Œåˆå› ä¸ºå•ç²¾åº¦æµ®ç‚¹æ•° <code>frac</code> å  23 ä½ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨<code>111011</code> åé¢å†å¡« 17 ä¸ª 0ï¼Œå³ï¼š</p><p><span class="math display">\[frac = 111011 0000 0000 0000 0000 0\]</span></p><p><strong>5. ç¡®å®šç¬¦å·ä½</strong></p><p><span class="math display">\[s = 0_{(2)}\]</span></p><p><strong>6. ç»„åˆèµ·æ¥</strong></p><p><code>12345.0</code> =<code>0  10000101 11101100000000000000000</code></p><h2 id="æµ®ç‚¹æ•°èˆå…¥">æµ®ç‚¹æ•°èˆå…¥</h2><p>ç”±äºæµ®ç‚¹æ•°çš„è¡¨ç¤ºå…·æœ‰å›ºå®šçš„ç²¾åº¦ï¼Œåœ¨è¿›è¡Œè¿ç®—æˆ–è¡¨ç¤ºæ—¶ï¼Œç»å¸¸ä¼šé‡åˆ°æ— æ³•ç²¾ç¡®è¡¨ç¤ºçš„æ•°å€¼ï¼Œè¿™å°±éœ€è¦é‡‡ç”¨èˆå…¥æ–¹æ³•æ¥è¿‘ä¼¼è¡¨ç¤ºè¿™äº›æ•°å€¼ã€‚IEEE-754æ ‡å‡†å®šä¹‰äº†å‡ ç§ä¸åŒçš„èˆå…¥æ¨¡å¼ï¼Œä»¥é€‚åº”ä¸åŒçš„è®¡ç®—éœ€æ±‚ã€‚</p><h3 id="èˆå…¥æ¨¡å¼">èˆå…¥æ¨¡å¼</h3><p><strong>æœ€è¿‘èˆå…¥ï¼ˆRound to Nearestï¼‰</strong>:</p><ul><li>è¿™æ˜¯æœ€å¸¸ç”¨çš„èˆå…¥æ¨¡å¼ï¼Œä¹Ÿæ˜¯é»˜è®¤çš„æ¨¡å¼ã€‚</li><li>è§„åˆ™æ˜¯å‘æœ€æ¥è¿‘çš„å¯è¡¨ç¤ºå€¼èˆå…¥ã€‚å¦‚æœç²¾ç¡®ç»“æœä½äºä¸¤ä¸ªå¯è¡¨ç¤ºå€¼çš„ä¸­ç‚¹ï¼Œé€šå¸¸èˆå…¥åˆ°æœ€è¿‘çš„å¶æ•°ï¼ˆå³å°¾æ•°çš„æœ€åä¸€ä½ä¸º0ï¼‰ã€‚</li><li>è¿™ç§æ–¹æ³•å‡å°‘äº†ç´¯ç§¯è¯¯å·®ï¼Œç¡®ä¿äº†åœ¨å¤šæ¬¡è¿ç®—åçš„æ€»ä½“ç²¾åº¦ã€‚</li></ul><p><strong>å‘é›¶èˆå…¥ï¼ˆRound Toward Zeroï¼‰</strong>:</p><ul><li>è¿™ç§æ¨¡å¼æ€»æ˜¯èˆå…¥åˆ°é›¶çš„æ–¹å‘ï¼Œå³èˆå»å°æ•°éƒ¨åˆ†ã€‚</li><li>å¯¹äºæ­£æ•°ï¼Œè¿™ç›¸å½“äºå–ä¸‹é™ï¼Œå¯¹äºè´Ÿæ•°ï¼Œç›¸å½“äºå–ä¸Šé™ã€‚</li></ul><p><strong>å‘ä¸Šèˆå…¥ï¼ˆRound Upï¼‰</strong>:</p><ul><li>æ— è®ºæ­£è´Ÿï¼Œéƒ½å‘è¿œç¦»é›¶çš„æ–¹å‘èˆå…¥ã€‚</li><li>å¯¹äºæ­£æ•°ï¼Œèˆå…¥åçš„å€¼ä¸å°äºåŸå€¼ï¼›å¯¹äºè´Ÿæ•°ï¼Œèˆå…¥åçš„å€¼ä¸å¤§äºåŸå€¼ã€‚</li></ul><p><strong>å‘ä¸‹èˆå…¥ï¼ˆRound Downï¼‰</strong>:</p><ul><li>æ— è®ºæ­£è´Ÿï¼Œéƒ½å‘æ¥è¿‘é›¶çš„æ–¹å‘èˆå…¥ã€‚</li><li>å¯¹äºæ­£æ•°ï¼Œèˆå…¥åçš„å€¼ä¸å¤§äºåŸå€¼ï¼›å¯¹äºè´Ÿæ•°ï¼Œèˆå…¥åçš„å€¼ä¸å°äºåŸå€¼ã€‚</li></ul><h3 id="èˆå…¥çš„å½±å“">èˆå…¥çš„å½±å“</h3><ul><li><strong>ç²¾åº¦æŸå¤±</strong>ï¼šç”±äºå›ºå®šçš„å°¾æ•°ä½æ•°ï¼Œèˆå…¥å¯èƒ½å¯¼è‡´ç²¾åº¦çš„æŸå¤±ã€‚</li><li><strong>èˆå…¥è¯¯å·®</strong>ï¼šèˆå…¥æ“ä½œæœ¬èº«å¯èƒ½å¼•å…¥è¯¯å·®ï¼Œè¿™äº›è¯¯å·®åœ¨è¿ç»­è¿ç®—ä¸­å¯èƒ½ä¼šç´¯ç§¯ã€‚</li><li><strong>é€‰æ‹©åˆé€‚çš„èˆå…¥æ¨¡å¼</strong>ï¼šä¸åŒçš„èˆå…¥æ¨¡å¼é€‚åˆä¸åŒçš„åº”ç”¨åœºæ™¯ã€‚ä¾‹å¦‚ï¼Œé‡‘èè®¡ç®—å¯èƒ½æ›´å€¾å‘äºä½¿ç”¨å‘é›¶èˆå…¥ï¼Œè€Œç§‘å­¦è®¡ç®—é€šå¸¸ä½¿ç”¨æœ€è¿‘èˆå…¥ä»¥å‡å°‘ç´¯ç§¯è¯¯å·®ã€‚</li></ul><h3 id="å®ä¾‹">å®ä¾‹</h3><table><thead><tr class="header"><th>Mode</th><th style="text-align: center;">1.40</th><th style="text-align: center;">1.60</th><th style="text-align: center;">1.50</th><th style="text-align: center;">2.50</th><th style="text-align: center;">-1.50</th></tr></thead><tbody><tr class="odd"><td>æœ€è¿‘èˆå…¥</td><td style="text-align: center;">1</td><td style="text-align: center;">2</td><td style="text-align: center;">2</td><td style="text-align: center;">2</td><td style="text-align: center;">-2</td></tr><tr class="even"><td>å‘é›¶èˆå…¥</td><td style="text-align: center;">1</td><td style="text-align: center;">1</td><td style="text-align: center;">1</td><td style="text-align: center;">2</td><td style="text-align: center;">-1</td></tr><tr class="odd"><td>å‘ä¸Šèˆå…¥</td><td style="text-align: center;">2</td><td style="text-align: center;">2</td><td style="text-align: center;">2</td><td style="text-align: center;">3</td><td style="text-align: center;">-1</td></tr><tr class="even"><td>å‘ä¸‹èˆå…¥</td><td style="text-align: center;">1</td><td style="text-align: center;">1</td><td style="text-align: center;">1</td><td style="text-align: center;">2</td><td style="text-align: center;">-2</td></tr></tbody></table><h2 id="æµ®ç‚¹æ•°è¿ç®—">æµ®ç‚¹æ•°è¿ç®—</h2><p>å› ä¸ºæµ®ç‚¹æ•°æœ¬èº«å°±å­˜åœ¨ç²¾åº¦é—®é¢˜ï¼Œæ‰€ä»¥æµ®ç‚¹æ•°è¿ç®—åœ¨è®¡ç®—æœºä¸­æ˜¯ä¸€ä¸ªè¿‘ä¼¼è¿‡ç¨‹ï¼Œæ¶‰åŠåˆ°ç²¾ç¡®åº¦çš„æƒè¡¡ã€ç‰¹æ®Šå€¼çš„å¤„ç†ã€é”™è¯¯çš„ä¼ æ’­ï¼Œä»¥åŠèˆå…¥è§„åˆ™çš„åº”ç”¨ã€‚</p><h3 id="æµ®ç‚¹æ•°åŠ å‡">æµ®ç‚¹æ•°åŠ å‡</h3><ol type="1"><li>æµ®ç‚¹æ•°åŠ æ³•å’Œå‡æ³•é¦–å…ˆéœ€è¦å¯¹æ“ä½œæ•°è¿›è¡Œå¯¹é½ï¼Œä½¿å¾—å®ƒä»¬çš„æŒ‡æ•°ç›¸åŒã€‚è¿™å¯èƒ½æ¶‰åŠå°†å°¾æ•°çš„äºŒè¿›åˆ¶è¡¨ç¤ºå‘å³ç§»ä½ï¼Œå¯èƒ½å¯¼è‡´ç²¾åº¦æŸå¤±ã€‚</li><li>ç„¶åæ‰§è¡ŒåŠ æ³•æˆ–å‡æ³•æ“ä½œã€‚</li><li>å¯¹ç»“æœè¿›è¡Œè§„èŒƒåŒ–å’Œèˆå…¥ã€‚</li></ol><p>æ³¨æ„ï¼Œæµ®ç‚¹æ•°çš„åŠ å‡æ³•<strong>ä¸æ»¡è¶³</strong>ç»“åˆå¾‹ã€äº¤æ¢å¾‹å’Œåˆ†é…å¾‹ï¼Œè¿™ä½ ç®€å•åˆ†æä¸‹åº”è¯¥å°±å¯ä»¥ç†è§£äº†ï¼Œè¿™é‡Œä¸èµ˜è¿°äº†ã€‚</p><p>å‡è®¾æˆ‘ä»¬è¦åœ¨å•ç²¾åº¦æµ®ç‚¹æ•°æ ¼å¼ä¸‹è®¡ç®—ï¼š</p><p><span class="math display">\[12.375 + 0.1 = ?\]</span></p><p><strong>ç¬¬ 1 æ­¥ï¼šè½¬ä¸ºäºŒè¿›åˆ¶è¡¨ç¤º</strong></p><p>å…¶ä¸­ 12.375 æˆ‘ä»¬å¯ä»¥ç”¨äºŒè¿›åˆ¶ç²¾ç¡®è¡¨ç¤ºï¼š</p><p><span class="math display">\[12.375_{(10)} = 1100.011_{(2)}\]</span></p><p>è€Œ 0.1 å°±æ¯”è¾ƒç‰¹æ®Šäº†ï¼Œç”¨äºŒè¿›åˆ¶è¡¨ç¤ºçš„è¯å®ƒä¼šæ— é™å¾ªç¯ã€‚</p><blockquote><p>å°†åè¿›åˆ¶å°æ•°è½¬æ¢ä¸ºäºŒè¿›åˆ¶è¡¨ç¤ºæ¶‰åŠåˆ°é‡å¤ä¹˜ä»¥ 2çš„è¿‡ç¨‹ï¼Œå¹¶æå–æ¯æ¬¡ä¹˜æ³•åæ•´æ•°éƒ¨åˆ†ä½œä¸ºäºŒè¿›åˆ¶ä½ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯ä¸€ä¸ªä¸æ–­é‡å¤çš„è¿‡ç¨‹ï¼Œç›´åˆ°å°æ•°éƒ¨åˆ†å˜ä¸º0 æˆ–å¼€å§‹å¾ªç¯ã€‚</p></blockquote><ol type="1"><li><p>å– <code>0.1</code> çš„å°æ•°éƒ¨åˆ†ä¹˜ä»¥ 2ï¼ˆå³<code>0.1 Ã— 2 = 0.2</code>ï¼‰ï¼Œæ•´æ•°éƒ¨åˆ†æ˜¯ <code>0</code>ï¼Œå°æ•°éƒ¨åˆ†æ˜¯<code>0.2</code>ã€‚</p></li><li><p>å†æ¬¡å–å°æ•°éƒ¨åˆ†ä¹˜ä»¥ 2ï¼ˆå³ <code>0.2 Ã— 2 = 0.4</code>ï¼‰ï¼Œæ•´æ•°éƒ¨åˆ†æ˜¯<code>0</code>ï¼Œå°æ•°éƒ¨åˆ†æ˜¯ <code>0.4</code>ã€‚</p></li><li><p>ç»§ç»­è¿™ä¸ªè¿‡ç¨‹ï¼Œæˆ‘ä»¬å¾—åˆ°ä»¥ä¸‹åºåˆ—ï¼š</p><p><code>0.4 Ã— 2 = 0.8</code> â†’ æ•´æ•°éƒ¨åˆ† <code>0</code></p><p><code>0.8 Ã— 2 = 1.6</code> â†’ æ•´æ•°éƒ¨åˆ† <code>1</code></p><p><code>0.6 Ã— 2 = 1.2</code> â†’ æ•´æ•°éƒ¨åˆ† <code>1</code></p><p><code>0.2 Ã— 2 = 0.4</code> â†’ æ•´æ•°éƒ¨åˆ† <code>0</code></p><p>â€¦ï¼ˆå¾ªç¯å¼€å§‹ï¼‰</p></li></ol><p>æ‰€ä»¥ï¼Œ<code>0.1</code> çš„äºŒè¿›åˆ¶è¡¨ç¤ºå¼€å§‹ä¸º<code>0.0001100110011â€¦</code>ï¼Œå¹¶ä¸”è¿™ä¸ªæ¨¡å¼ä¼šæ— é™å¾ªç¯ä¸‹å»ã€‚</p><p><strong>ç¬¬ 2 æ­¥ï¼šè§„æ ¼åŒ–</strong></p><p>å›é¡¾ä¸€ä¸‹è¿™å¼ å›¾ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20231224102703581.png"alt="å•ç²¾åº¦æµ®ç‚¹æ•°" /><figcaption aria-hidden="true">å•ç²¾åº¦æµ®ç‚¹æ•°</figcaption></figure><p>æ‰€ä»¥ 12.375 è§„æ ¼åŒ–è¡¨ç¤ºä¸ºï¼š</p><ul><li>å…ˆè§„èŒƒåŒ–ä¸º 1.xxxx å½¢å¼ï¼š <span class="math inline">\(1100.011_{(2)}= 1.100011 Ã— 2^3\)</span></li><li>æŒ‡æ•°ä¸ºï¼š<span class="math inline">\(3 + 127 = 130 =10000010_{(2)}\)</span></li><li>å°¾æ•°ä¸ºï¼š<spanclass="math inline">\(10001100000000000000000ï¼ˆ23\;ä½ï¼Œå³è¾¹è¡¥\;0ï¼‰\)</span></li><li>æ±‡æ€»ï¼š<spanclass="math inline">\(0\;10000010\;10001100000000000000000\)</span></li></ul><p>è€Œ 0.1 ç”±äºæ— é™å¾ªç¯ï¼Œæˆ‘ä»¬åœ¨å•ç²¾åº¦ä¸‹åªèƒ½ä¿ç•™ 23ä½ï¼Œå¹¶é‡‡ç”¨<strong>æœ€è¿‘èˆå…¥</strong>ï¼Œæ‰€ä»¥ 0.1 è§„æ ¼åŒ–è¡¨ç¤ºä¸ºï¼š</p><ul><li>å…ˆè§„èŒƒä¸º 1.xxxx å½¢å¼ï¼š<spanclass="math inline">\(0.00011001100110011001100(å¾ªç¯) =1.10011001100110011001100 Ã— 2^-4\)</span></li><li>æŒ‡æ•°ä¸ºï¼š<span class="math inline">\(-4 + 127 = 123 =01111011_{(2)}\)</span></li><li>å°¾æ•°ä¸ºï¼š<spanclass="math inline">\(10011001100110011001100\)</span></li><li>æ±‡æ€»ï¼š<spanclass="math inline">\(0\;01111011\;10011001100110011001100\)</span></li></ul><p><strong>ç¬¬ 3 æ­¥ï¼šå¯¹é½æŒ‡æ•°</strong></p><p>å…ˆæŠŠ 2 ä¸ªæµ®ç‚¹è¡¨ç¤ºæ”¾åœ¨ä¸€èµ·ï¼Œå¥½å¯¹æ¯”ï¼š</p><ul><li><spanclass="math inline">\(0\;10000010\;10001100000000000000000\)</span></li><li><spanclass="math inline">\(0\;01111011\;10011001100110011001100\)</span></li></ul><p>å°†ä¸¤ä¸ªæ•°çš„æŒ‡æ•°å¯¹é½ï¼Œè¾ƒå°çš„æŒ‡æ•°å¢åŠ ï¼ŒåŒæ—¶ç›¸åº”åœ°è°ƒæ•´å°¾æ•°ã€‚</p><p>è¿™é‡Œéœ€è¦è°ƒæ•´å°† <code>0.1</code> çš„æŒ‡æ•°ä» <code>01111011</code> è°ƒæ•´åˆ°<code>10000010</code>ï¼Œè¿™é‡ŒåŠ äº† <code>7</code>ï¼Œæ‰€ä»¥ <code>0.1</code>çš„å°¾æ•° <code>1.10011001100110011001100</code>éœ€è¦å³ç§» <code>7</code>ä½ï¼Œå³ï¼š<code>0.00000011001100110011001</code>ã€‚</p><p><strong>ç¬¬ 4 æ­¥ï¼šç›¸åŠ </strong></p><p>ç°åœ¨ä¸¤ä¸ªæ•°çš„æŒ‡æ•°ç›¸åŒäº†ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æŠŠå®ƒä»¬çš„å°¾æ•°ç›¸åŠ ï¼š</p><p><span class="math display">\[\;\;\;1.10001100000000000000000 \\+\;0.00000011001100110011001 \\=\;1.10001111001100110011001\]</span></p><p><strong>ç¬¬ 5 æ­¥ï¼šè§„èŒƒåŒ–ç»“æœ</strong></p><p>è¿™é‡Œæ— éœ€è§„èŒƒåŒ–ã€‚</p><p><strong>ç¬¬ 6 æ­¥ï¼šèˆå…¥</strong></p><p>è¿™é‡Œæ²¡æœ‰è¿›ä½ï¼Œä¸éœ€è¦èˆå…¥ã€‚</p><p><strong>ç¬¬ 7 æ­¥ï¼šæµ®ç‚¹åŒ–è¡¨ç¤º</strong></p><p><span class="math display">\[0\;10000010\;10001111001100110011001\]</span></p><p><strong>ç¬¬ 8 æ­¥ï¼šè½¬ä¸ºåè¿›åˆ¶</strong></p><p><span class="math display">\[V =(-1)^sÃ—MÃ—2^E \\= (-1)^sÃ—1.fracÃ—2^{e-bias} \\= 1.10001111001100110011001 Ã— 2^3 \\= 1100.01111001100110011001_{(2)} \\= 12.47499942779541015625_{(10)} \\â‰ˆ 12.475_{(10)}\]</span></p><h3 id="æµ®ç‚¹æ•°ä¹˜æ³•">æµ®ç‚¹æ•°ä¹˜æ³•</h3><ol type="1"><li><strong>ç¬¦å·ä½è®¡ç®—</strong>ï¼šç»“æœçš„ç¬¦å·ç”±ä¸¤ä¸ªæ“ä½œæ•°çš„ç¬¦å·ä½å†³å®šã€‚å¦‚æœç¬¦å·ä½ç›¸åŒï¼ˆéƒ½æ˜¯æ­£æ•°æˆ–éƒ½æ˜¯è´Ÿæ•°ï¼‰ï¼Œç»“æœä¸ºæ­£ï¼›å¦‚æœç¬¦å·ä½ä¸åŒï¼Œç»“æœä¸ºè´Ÿã€‚</li><li><strong>æŒ‡æ•°ç›¸åŠ </strong>ï¼šä¸¤ä¸ªæ•°çš„æŒ‡æ•°ç›¸åŠ ï¼Œå¹¶å‡å»åç½®å€¼ï¼ˆå•ç²¾åº¦æµ®ç‚¹æ•°ä¸­ä¸º127ï¼ŒåŒç²¾åº¦ä¸º 1023ï¼‰ã€‚</li><li><strong>å°¾æ•°ç›¸ä¹˜</strong>ï¼šä¸¤ä¸ªæ•°çš„å°¾æ•°ç›¸ä¹˜ã€‚è¿™é‡Œçš„å°¾æ•°åŒ…æ‹¬éšå«çš„æœ€é«˜ä½1ã€‚</li><li><strong>ç»“æœè§„èŒƒåŒ–</strong>ï¼šå¦‚æœä¹˜æ³•çš„ç»“æœéœ€è¦è§„èŒƒåŒ–ï¼ˆå³è°ƒæ•´ä¸º<code>1.xxxx</code> çš„å½¢å¼ï¼‰ï¼Œåˆ™ç›¸åº”è°ƒæ•´æŒ‡æ•°ã€‚</li><li><strong>èˆå…¥å¤„ç†</strong>ï¼šå¦‚æœéœ€è¦ï¼Œå¯¹ç»“æœè¿›è¡Œèˆå…¥ä»¥é€‚åº”ç›®æ ‡æ ¼å¼ã€‚</li><li><strong>æ£€æŸ¥æº¢å‡ºæˆ–ä¸‹æº¢</strong>ï¼šå¦‚æœæŒ‡æ•°è¶…å‡ºäº†è¡¨ç¤ºèŒƒå›´ï¼Œåˆ™å‘ç”Ÿæº¢å‡ºï¼ˆç»“æœå¯èƒ½ä¸ºæ— ç©·å¤§æˆ–ç‰¹æ®Šå€¼ï¼‰ï¼›å¦‚æœæŒ‡æ•°å¤ªå°ï¼Œå‘ç”Ÿä¸‹æº¢ï¼ˆç»“æœå¯èƒ½ä¸º0 æˆ–éè§„æ ¼åŒ–æ•°ï¼‰ã€‚</li></ol><p>å‡è®¾æˆ‘ä»¬è¦åœ¨å•ç²¾åº¦æµ®ç‚¹æ•°æ ¼å¼ä¸‹è®¡ç®—ï¼š</p><p><span class="math display">\[2.0 Ã— 3.0 = ?\]</span></p><p><strong>ç¬¬ 1 æ­¥ï¼šè½¬ä¸ºäºŒè¿›åˆ¶è¡¨ç¤º</strong></p><p><span class="math display">\[2.0_{(10)} = 1_{(2)} \\3.0_{(10)} = 11_{(2)}\]</span></p><p><strong>ç¬¬ 2 æ­¥ï¼šè§„èŒƒåŒ–</strong></p><p><span class="math display">\[1 = 1.0 Ã— 2^0 \\11 = 1.1 Ã— 2^1\]</span></p><p><strong>ç¬¬ 3 æ­¥ï¼šæµ®ç‚¹åŒ–</strong></p><p><span class="math display">\[2.0 = 0\;00000001\;00000000000000000000000 \\3.0 = 0\;00000001\;10000000000000000000000\]</span></p><p><strong>ç¬¬ 4 æ­¥ï¼šä¹˜æ³•æ“ä½œ</strong></p><ul><li>ç¬¦å·ä½ï¼šæ­£æ­£å¾—æ­£ï¼š<span class="math inline">\(0_{(2)} Ã— 0_{(2)} =0_{(2)}\)</span></li><li>æŒ‡æ•°ç›¸åŠ å¹¶å‡å»åç½®å€¼ï¼š<spanclass="math inline">\((127+1)+(127+1)-127=129\)</span></li><li>å°¾æ•°ç›¸ä¹˜ï¼š<span class="math inline">\(1.0_{(2)}Ã—1.1_{(2)} =1.1_{(2)}\)</span></li></ul><p><strong>ç¬¬ 5 æ­¥ï¼šè§„èŒƒåŒ–</strong></p><p>è¿™é‡Œæ— éœ€è§„èŒƒåŒ–ã€‚</p><p><strong>ç¬¬ 6 æ­¥ï¼šèˆå…¥</strong></p><p>è¿™é‡Œæ— éœ€èˆå…¥ã€‚</p><p><strong>ç¬¬ 7 æ­¥ï¼šæµ®ç‚¹åŒ–ç»“æœ</strong></p><p><span class="math display">\[0\;00000010\;10000000000000000000000\]</span></p><p><strong>ç¬¬ 8 æ­¥ï¼šè½¬ä¸ºåè¿›åˆ¶</strong></p><p><span class="math display">\[V = (-1)^sÃ—1.fracÃ—2^{(e-127)} \\= 0 Ã— 1.1 Ã— 2^2 \\= 110_{(2)} \\= 6.0_{(10)}\]</span></p><h3 id="æµ®ç‚¹æ•°é™¤æ³•">æµ®ç‚¹æ•°é™¤æ³•</h3><p>æµ®ç‚¹æ•°é™¤æ³•ç±»ä¼¼äºä¹˜æ³•ï¼Œä½†æœ‰ä¸€äº›ä¸åŒï¼š</p><ol type="1"><li><strong>ç¬¦å·ä½è®¡ç®—</strong>ï¼šä¸ä¹˜æ³•ç±»ä¼¼ï¼Œç»“æœçš„ç¬¦å·ç”±ä¸¤ä¸ªæ“ä½œæ•°çš„ç¬¦å·ä½å†³å®šã€‚</li><li><strong>æŒ‡æ•°ç›¸å‡</strong>ï¼šè¢«é™¤æ•°çš„æŒ‡æ•°å‡å»é™¤æ•°çš„æŒ‡æ•°ï¼Œå†åŠ ä¸Šåç½®å€¼ã€‚</li><li><strong>å°¾æ•°ç›¸é™¤</strong>ï¼šè¢«é™¤æ•°çš„å°¾æ•°é™¤ä»¥é™¤æ•°çš„å°¾æ•°ã€‚</li><li><strong>ç»“æœè§„èŒƒåŒ–</strong>ï¼šå¦‚æœå¿…è¦ï¼Œè°ƒæ•´ç»“æœä½¿å…¶è§„èŒƒåŒ–ã€‚</li><li><strong>èˆå…¥å¤„ç†</strong>ï¼šå¦‚æœéœ€è¦ï¼Œå¯¹ç»“æœè¿›è¡Œèˆå…¥ã€‚</li><li><strong>æ£€æŸ¥æº¢å‡ºæˆ–ä¸‹æº¢</strong>ï¼šä¸ä¹˜æ³•ç±»ä¼¼çš„æ£€æŸ¥ã€‚</li></ol><p>å‡è®¾æˆ‘ä»¬è¦åœ¨å•ç²¾åº¦æµ®ç‚¹æ•°æ ¼å¼ä¸‹è®¡ç®—ï¼š</p><p><span class="math display">\[6.0 Ã· 3.0 =?\]</span></p><p><strong>ç¬¬ 1 æ­¥ï¼šè½¬ä¸ºäºŒè¿›åˆ¶è¡¨ç¤º</strong></p><p><span class="math display">\[6.0_{(10)} = 110_{(2)} \\3.0_{(10)} = 11_{(2)}\]</span></p><p><strong>ç¬¬ 2 æ­¥ï¼šè§„èŒƒåŒ–</strong></p><p><span class="math display">\[6.0 = 110 = 1.10 Ã— 2^2 \\3.0 = 11 = 1.1 Ã— 2^1\]</span></p><p><strong>ç¬¬ 3 æ­¥ï¼šæµ®ç‚¹åŒ–</strong></p><p><span class="math display">\[6.0 = 0\;00000020\;10000000000000000000000 \\3.0 = 0\;00000001\;10000000000000000000000\]</span></p><p><strong>ç¬¬ 4 æ­¥ï¼šé™¤æ³•æ“ä½œ</strong></p><ul><li>ç¬¦å·ä½ï¼šæ­£æ­£å¾—æ­£ï¼š<span class="math inline">\(0_{(2)} Ã— 0_{(2)} =0_{(2)}\)</span></li><li>æŒ‡æ•°å‡å¹¶åŠ ä¸Šåç½®å€¼ï¼š<spanclass="math inline">\((127+2)-(127+1)+127=128\)</span></li><li>å°¾æ•°ç›¸é™¤ï¼š<span class="math inline">\(1.1_{(2)}Ã—1.1_{(2)} =1.0_{(2)}\)</span></li></ul><p><strong>ç¬¬ 5 æ­¥ï¼šè§„èŒƒåŒ–</strong></p><p>è¿™é‡Œæ— éœ€è§„èŒƒåŒ–ã€‚</p><p><strong>ç¬¬ 6 æ­¥ï¼šèˆå…¥</strong></p><p>è¿™é‡Œæ— éœ€èˆå…¥ã€‚</p><p><strong>ç¬¬ 7 æ­¥ï¼šæµ®ç‚¹åŒ–ç»“æœ</strong></p><p><span class="math display">\[0\;00000001\;00000000000000000000000\]</span></p><p><strong>ç¬¬ 8 æ­¥ï¼šè½¬ä¸ºåè¿›åˆ¶</strong></p><p><span class="math display">\[V = (-1)^sÃ—1.fracÃ—2^{(e-127)} \\= 0 Ã— 1.0 Ã— 2^1 \\= 10_{(2)} \\= 2.0_{(10)}\]</span></p><h2 id="go-è¯­è¨€è¾“å‡ºæµ®ç‚¹æ•°">Go è¯­è¨€è¾“å‡ºæµ®ç‚¹æ•°</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> number <span class="hljs-type">float32</span> = <span class="hljs-number">12.375</span><br>fmt.Printf(<span class="hljs-string">&quot;æµ®ç‚¹æ•°ï¼š%f\n&quot;</span>, number)<br>fmt.Printf(<span class="hljs-string">&quot;ç§‘å­¦è®¡æ•°æ³•ï¼š%e\n&quot;</span>, number)<br>fmt.Printf(<span class="hljs-string">&quot;ä¿ç•™ 2 ä½å°æ•°ï¼š%.2f\n&quot;</span>, number)<br><br>bits := math.Float32bits(number)<br>bitsStr := fmt.Sprintf(<span class="hljs-string">&quot;%.32b&quot;</span>, bits)<br>fmt.Printf(<span class="hljs-string">&quot;è¾“å‡º32ä½æµ®ç‚¹è¡¨ç¤ºï¼š%s %s %s\n&quot;</span>, bitsStr[:<span class="hljs-number">1</span>], bitsStr[<span class="hljs-number">1</span>:<span class="hljs-number">9</span>], bitsStr[<span class="hljs-number">9</span>:])<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="mathbig">math/big</h2><p>Go è¯­è¨€çš„ <code>math/big</code>åŒ…æä¾›äº†å¯¹å¤§æ•°çš„ç²¾ç¡®è®¡ç®—æ”¯æŒï¼Œè¿™äº›å¤§æ•°çš„å¤§å°è¶…å‡ºäº†æ ‡å‡†æ•´æ•°ç±»å‹ï¼ˆå¦‚<code>int64</code>ï¼‰æˆ–æµ®ç‚¹ç±»å‹ï¼ˆå¦‚<code>float64</code>ï¼‰çš„èŒƒå›´ã€‚è¿™ä¸ªåŒ…ä¸»è¦ç”¨äºéœ€è¦é«˜ç²¾åº¦è®¡ç®—çš„é¢†åŸŸï¼Œå¦‚åŠ å¯†ã€ç§‘å­¦è®¡ç®—ç­‰ã€‚</p><p>ä¸»è¦åŠŸèƒ½ï¼š</p><ul><li><strong>ç®—æœ¯è¿ç®—</strong>ï¼šæ”¯æŒåŸºæœ¬çš„åŠ ã€å‡ã€ä¹˜ã€é™¤ç­‰ç®—æœ¯è¿ç®—ã€‚</li><li><strong>æ¯”è¾ƒæ“ä½œ</strong>ï¼šå¯ä»¥æ¯”è¾ƒä¸¤ä¸ªå¤§æ•°çš„å¤§å°ã€‚</li><li><strong>ä½æ“ä½œ</strong>ï¼šå¯¹å¤§æ•´æ•°è¿›è¡Œä½æ“ä½œï¼Œå¦‚ä½ç§»ã€ä¸ã€æˆ–ã€å¼‚æˆ–ç­‰ã€‚</li><li><strong>è§£æå’Œæ ¼å¼åŒ–</strong>ï¼šå¯ä»¥ä»å­—ç¬¦ä¸²è§£æå¤§æ•°ï¼Œä¹Ÿå¯ä»¥å°†å¤§æ•°æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²ã€‚</li></ul><p>ç¤ºä¾‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>a := big.NewFloat(math.MaxFloat64)<br>b := big.NewFloat(math.MaxFloat64)<br>sum := big.NewFloat(<span class="hljs-number">0</span>)<br>sum.Add(a, b)<br>fmt.Println(<span class="hljs-string">&quot;a:&quot;</span>, a)<br>fmt.Println(<span class="hljs-string">&quot;sum:&quot;</span>, sum)<br>sum2 := big.NewFloat(<span class="hljs-number">0</span>).<br>SetPrec(<span class="hljs-number">15</span>).        <span class="hljs-comment">// è®¾ç½®ç²¾åº¦ï¼Œprec è¶Šå¤§ï¼Œç²¾åº¦è¶Šé«˜ï¼Œè®¡ç®—è¶Šå¤æ‚</span><br>SetMode(big.ToZero) <span class="hljs-comment">// è®¾ç½®èˆå…¥ç­–ç•¥</span><br>sum2.Add(a, b)<br>fmt.Println(<span class="hljs-string">&quot;sum2:&quot;</span>, sum2)<br>&#125;<br><br><span class="hljs-comment">// a: 1.7976931348623157e+308</span><br><span class="hljs-comment">// sum: 3.5953862697246314e+308</span><br><span class="hljs-comment">// sum2: 3.5953e+308</span><br></code></pre></td></tr></table></figure><p>æ³¨æ„äº‹é¡¹ï¼š</p><ul><li><strong>æ€§èƒ½è€ƒè™‘</strong>ï¼šç”±äº <code>math/big</code>æä¾›çš„æ˜¯ä»»æ„ç²¾åº¦è®¡ç®—ï¼Œå…¶æ€§èƒ½é€šå¸¸ä½äºåŸç”Ÿçš„å›ºå®šå¤§å°æ•°å€¼ç±»å‹ã€‚</li><li><strong>å†…å­˜ä½¿ç”¨</strong>ï¼šå¤§æ•°è¿ç®—å¯èƒ½ä¼šæ¶ˆè€—æ›´å¤šçš„å†…å­˜ã€‚</li><li><strong>æ–¹æ³•é“¾å¼è°ƒç”¨</strong>ï¼š<code>math/big</code>çš„è®¸å¤šæ–¹æ³•è¿”å›æ¥æ”¶è€…æœ¬èº«ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨ã€‚</li></ul><h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2><ul><li><ahref="https://people.eecs.berkeley.edu/~wkahan/ieee754status/IEEE754.PDF">IEEE-754</a></li><li>æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ</li><li>Go è¯­è¨€åº•å±‚åŸç†å‰–æ</li><li>https://www.bilibili.com/video/BV1zK4y1j7Cn</li><li>ChatGPT-4</li></ul>]]></content>
    
    
    <summary type="html">æœ¬æ–‡ä»ä¸€ä¸ªç»å…¸é—®é¢˜ 0.1+0.2 != 0.3 å‡ºå‘ï¼Œè¯¦ç»†ä»‹ç»äº† IEEE-754 æ ‡å‡†ä¸‹çš„æµ®ç‚¹æ•°è¡¨ç¤ºæ–¹æ³•ï¼Œç»†è‡´é˜è¿°äº† 3 ç§æµ®ç‚¹æ•°ç±»å‹çš„è¡¨ç¤ºé€»è¾‘ï¼ŒåŒ…æ‹¬è§„æ ¼åŒ–å€¼ã€éè§„æ ¼åŒ–å€¼å’Œç‰¹æ®Šå€¼ã€‚è¿˜ä»‹ç»äº†æµ®ç‚¹æ•°èˆå…¥çš„ 4 ç§æ¨¡å¼ï¼Œä»¥åŠæµ®ç‚¹æ•°çš„åŸºæœ¬è¿ç®—ã€‚æœ€åï¼Œæœ¬æ–‡ç»“åˆ Go è¯­è¨€ç»™å‡ºäº†æµ®ç‚¹æ•°ä¸åŒçš„è¾“å‡ºæ–¹å¼çš„ä¾‹å­ï¼Œä»¥åŠç®€å•ä»‹ç»äº† Go è¯­è¨€ä¸­çš„ math/big åº“åœ¨å¤§æ•°è¿ç®—å’Œç²¾åº¦æ›´é«˜çš„è¿ç®—åœºæ™¯ä¸­çš„åº”ç”¨ã€‚æœ¬æ–‡åŒ…å«å¤§é‡å®ä¾‹å’Œæ¨æ¼”è¿‡ç¨‹ï¼Œå¸Œæœ›èƒ½å¸®åŠ©è¯»è€…å½»åº•æŒæ¡æµ®ç‚¹æ•°ã€‚</summary>
    
    
    
    <category term="è®¡ç®—æœºåŸºç¡€" scheme="https://hedon.top/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/"/>
    
    
    <category term="è®¡ç®—æœºåŸç†" scheme="https://hedon.top/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%8E%9F%E7%90%86/"/>
    
    <category term="æµ®ç‚¹æ•°" scheme="https://hedon.top/tags/%E6%B5%AE%E7%82%B9%E6%95%B0/"/>
    
  </entry>
  
</feed>
