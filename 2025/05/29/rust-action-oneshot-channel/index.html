
<!DOCTYPE html><html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.29.1" theme-name="Stellar" theme-version="1.29.1">
  
  <meta name="generator" content="Hexo 6.3.0">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  <link rel="preconnect" href="https://gcore.jsdelivr.net" crossorigin><link rel="preconnect" href="https://unpkg.com" crossorigin><link rel="preconnect" href="https://cdn.bootcdn.net" crossorigin>
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  <meta name="theme-color" content="#f9fafb">
  
  <title>Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª oneshot channel - HedonWang</title>

  
    <meta name="description" content="æœ¬æ–‡ä»é›¶å¼€å§‹ï¼Œé€šè¿‡å¤šç‰ˆæœ¬è¿­ä»£ï¼Œå®ç°ä¸€ä¸ªå®‰å…¨çš„ Rust oneshot channelã€‚æˆ‘ä»¬å°†æ·±å…¥ &#96;AtomicBool&#96;ã€&#96;UnsafeCell&#96;ã€&#96;MaybeUninit&#96; çš„ä½¿ç”¨ï¼Œé€šè¿‡ &#96;Drop&#96; ç®¡ç†å†…å­˜ï¼Œå¹¶æœ€ç»ˆä»¥ &#96;Sender&#96;&#x2F;&#96;Receiver&#96; æ¨¡å¼å’Œæ‰€æœ‰æƒæœºåˆ¶å°è£… &#96;unsafe&#96;ï¼Œæ„å»ºå¥å£®çš„å¹¶å‘åŸè¯­ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª oneshot channel">
<meta property="og:url" content="https://hedon.top/2025/05/29/rust-action-oneshot-channel/index.html">
<meta property="og:site_name" content="HedonWang">
<meta property="og:description" content="æœ¬æ–‡ä»é›¶å¼€å§‹ï¼Œé€šè¿‡å¤šç‰ˆæœ¬è¿­ä»£ï¼Œå®ç°ä¸€ä¸ªå®‰å…¨çš„ Rust oneshot channelã€‚æˆ‘ä»¬å°†æ·±å…¥ &#96;AtomicBool&#96;ã€&#96;UnsafeCell&#96;ã€&#96;MaybeUninit&#96; çš„ä½¿ç”¨ï¼Œé€šè¿‡ &#96;Drop&#96; ç®¡ç†å†…å­˜ï¼Œå¹¶æœ€ç»ˆä»¥ &#96;Sender&#96;&#x2F;&#96;Receiver&#96; æ¨¡å¼å’Œæ‰€æœ‰æƒæœºåˆ¶å°è£… &#96;unsafe&#96;ï¼Œæ„å»ºå¥å£®çš„å¹¶å‘åŸè¯­ã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-05-29T14:11:03.000Z">
<meta property="article:modified_time" content="2025-07-27T04:29:14.336Z">
<meta property="article:author" content="Hedon Wang">
<meta property="article:tag" content="rust">
<meta property="article:tag" content="å¹¶å‘ç¼–ç¨‹">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <meta name="keywords" content="rust,å¹¶å‘ç¼–ç¨‹">

  <!-- feed -->
  
    <link rel="alternate" href="/atom.xml" title="HedonWang" type="application/atom+xml">
  

  <link rel="stylesheet" href="/css/main.css?v=1.29.1">


  
    <link rel="shortcut icon" href="/assets/favicon.png">
  

  

  <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon.png"><link rel="shortcut icon" href="/assets/favicon.png"><meta name="theme-color" content="#f8f8f8"><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC&display=swap" rel="stylesheet"><link rel="stylesheet" href="/css/markmap.css"><script src="https://cdn.jsdelivr.net/npm/markmap-autoloader@0.18"></script>
</head>
<body>

<div class="l_body s:aa content tech" id="start" layout="post" ><aside class="l_left"><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><div class="icon"><img no-lazy class="icon" src="/assets/favicon.png" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></div><a class="title" href="/"><div class="main" ff="title">HedonWang</div><div class="sub cap">å›å­æ±‚è¯¸å·±ï¼Œå¾‹å·±åˆ™å®‰ã€‚</div></a></div></header>

<div class="nav-area">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" placeholder="ç«™å†…æœç´¢"></form><div id="search-result"></div><div class="search-no-result">æ²¡æœ‰æ‰¾åˆ°å†…å®¹ï¼</div></div>


<nav class="menu dis-select"><a class="nav-item" title="åšå®¢" href="/" style="color:#1BCDFC"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M5.879 2.879C5 3.757 5 5.172 5 8v8c0 2.828 0 4.243.879 5.121C6.757 22 8.172 22 11 22h2c2.828 0 4.243 0 5.121-.879C19 20.243 19 18.828 19 16V8c0-2.828 0-4.243-.879-5.121C17.243 2 15.828 2 13 2h-2c-2.828 0-4.243 0-5.121.879M8.25 17a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75M9 12.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5zM8.25 9A.75.75 0 0 1 9 8.25h6a.75.75 0 0 1 0 1.5H9A.75.75 0 0 1 8.25 9" clip-rule="evenodd"/><path fill="currentColor" d="M5.235 4.058C5 4.941 5 6.177 5 8v8c0 1.823 0 3.058.235 3.942L5 19.924c-.975-.096-1.631-.313-2.121-.803C2 18.243 2 16.828 2 14v-4c0-2.829 0-4.243.879-5.121c.49-.49 1.146-.707 2.121-.803zm13.53 15.884C19 19.058 19 17.822 19 16V8c0-1.823 0-3.059-.235-3.942l.235.018c.975.096 1.631.313 2.121.803C22 5.757 22 7.17 22 9.999v4c0 2.83 0 4.243-.879 5.122c-.49.49-1.146.707-2.121.803z" opacity=".5"/></svg></a><a class="nav-item" title="ä¸“æ " href="/topic/" style="color:#3DC550"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M14.25 4.48v3.057c0 .111 0 .27.02.406a.936.936 0 0 0 .445.683a.96.96 0 0 0 .783.072c.13-.04.272-.108.378-.159L17 8.005l1.124.534c.106.05.248.119.378.16a.958.958 0 0 0 .783-.073a.936.936 0 0 0 .444-.683c.021-.136.021-.295.021-.406V3.031c.113-.005.224-.01.332-.013C21.154 2.98 22 3.86 22 4.933v11.21c0 1.112-.906 2.01-2.015 2.08c-.97.06-2.108.179-2.985.41c-1.082.286-1.99 1.068-3.373 1.436c-.626.167-1.324.257-1.627.323V5.174c.32-.079 1.382-.203 1.674-.371c.184-.107.377-.216.576-.323m5.478 8.338a.75.75 0 0 1-.546.91l-4 1a.75.75 0 0 1-.364-1.456l4-1a.75.75 0 0 1 .91.546" clip-rule="evenodd"/><path fill="currentColor" d="M18.25 3.151c-.62.073-1.23.18-1.75.336a8.2 8.2 0 0 0-.75.27v3.182l.75-.356l.008-.005a1.13 1.13 0 0 1 .492-.13c.047 0 .094.004.138.01c.175.029.315.1.354.12l.009.005l.749.356V3.647z"/><path fill="currentColor" d="M12 5.214c-.334-.064-1.057-.161-1.718-.339C8.938 4.515 8.05 3.765 7 3.487c-.887-.234-2.041-.352-3.018-.412C2.886 3.007 2 3.9 2 4.998v11.146c0 1.11.906 2.01 2.015 2.079c.97.06 2.108.179 2.985.41c.486.129 1.216.431 1.873.726c1.005.451 2.052.797 3.127 1.034z" opacity=".5"/><path fill="currentColor" d="M4.273 12.818a.75.75 0 0 1 .91-.545l4 1a.75.75 0 1 1-.365 1.455l-4-1a.75.75 0 0 1-.545-.91m.909-4.545a.75.75 0 1 0-.364 1.455l4 1a.75.75 0 0 0 .364-1.455z"/></svg></a><a class="nav-item" title="å…³äºæˆ‘" href="/about/" style="color:#F44336"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="m13.629 20.472l-.542.916c-.483.816-1.69.816-2.174 0l-.542-.916c-.42-.71-.63-1.066-.968-1.262c-.338-.197-.763-.204-1.613-.219c-1.256-.021-2.043-.098-2.703-.372a5 5 0 0 1-2.706-2.706C2 14.995 2 13.83 2 11.5v-1c0-3.273 0-4.91.737-6.112a5 5 0 0 1 1.65-1.651C5.59 2 7.228 2 10.5 2h3c3.273 0 4.91 0 6.113.737a5 5 0 0 1 1.65 1.65C22 5.59 22 7.228 22 10.5v1c0 2.33 0 3.495-.38 4.413a5 5 0 0 1-2.707 2.706c-.66.274-1.447.35-2.703.372c-.85.015-1.275.022-1.613.219c-.338.196-.548.551-.968 1.262" opacity=".5"/><path fill="currentColor" d="M10.99 14.308c-1.327-.978-3.49-2.84-3.49-4.593c0-2.677 2.475-3.677 4.5-1.609c2.025-2.068 4.5-1.068 4.5 1.609c0 1.752-2.163 3.615-3.49 4.593c-.454.335-.681.502-1.01.502c-.329 0-.556-.167-1.01-.502"/></svg></a><a class="nav-item" title="æ€ç»´å¯¼å›¾" href="/html/mindmap.html" style="color:#F44336"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="m13.629 20.472l-.542.916c-.483.816-1.69.816-2.174 0l-.542-.916c-.42-.71-.63-1.066-.968-1.262c-.338-.197-.763-.204-1.613-.219c-1.256-.021-2.043-.098-2.703-.372a5 5 0 0 1-2.706-2.706C2 14.995 2 13.83 2 11.5v-1c0-3.273 0-4.91.737-6.112a5 5 0 0 1 1.65-1.651C5.59 2 7.228 2 10.5 2h3c3.273 0 4.91 0 6.113.737a5 5 0 0 1 1.65 1.65C22 5.59 22 7.228 22 10.5v1c0 2.33 0 3.495-.38 4.413a5 5 0 0 1-2.707 2.706c-.66.274-1.447.35-2.703.372c-.85.015-1.275.022-1.613.219c-.338.196-.548.551-.968 1.262" opacity=".5"/><path fill="currentColor" d="M10.99 14.308c-1.327-.978-3.49-2.84-3.49-4.593c0-2.677 2.475-3.677 4.5-1.609c2.025-2.068 4.5-1.068 4.5 1.609c0 1.752-2.163 3.615-3.49 4.593c-.454.335-.681.502-1.01.502c-.329 0-.556-.167-1.01-.502"/></svg></a></nav>
</div>
<div class="widgets">
<widget class="widget-wrapper post-list"><div class="widget-header dis-select"><span class="name">ä¸“æ ï¼šRust å®æˆ˜é›†åˆ</span></div><div class="widget-body"><a class="item" href="/2025/06/11/rust-action-rwlock/"><span class="title">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª RwLock</span></a><a class="item" href="/2025/06/09/rust-action-mutex/"><span class="title">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª Mutex</span></a><a class="item" href="/2025/06/09/rust-action-condvar/"><span class="title">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª Condvar</span></a><a class="item" href="/2025/06/03/rust-action-arc/"><span class="title">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª Arc</span></a><a class="item active" href="/2025/05/29/rust-action-oneshot-channel/"><span class="title">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª oneshot channel</span><svg class="active-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M21 11.098v4.993c0 3.096 0 4.645-.734 5.321c-.35.323-.792.526-1.263.58c-.987.113-2.14-.907-4.445-2.946c-1.02-.901-1.529-1.352-2.118-1.47a2.225 2.225 0 0 0-.88 0c-.59.118-1.099.569-2.118 1.47c-2.305 2.039-3.458 3.059-4.445 2.945a2.238 2.238 0 0 1-1.263-.579C3 20.736 3 19.188 3 16.091v-4.994C3 6.81 3 4.666 4.318 3.333C5.636 2 7.758 2 12 2c4.243 0 6.364 0 7.682 1.332C21 4.665 21 6.81 21 11.098" opacity=".5"/><path fill="currentColor" d="M9 5.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5z"/></svg></a><a class="item" href="/2025/05/13/rust-action-spinlock/"><span class="title">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª SpinLock</span></a><a class="item" href="/2024/06/06/rust-action-sse/"><span class="title">Rust å®æˆ˜ä¸¨SSE(Server-Sent Events)</span></a><a class="item" href="/2024/05/28/rust-action-macro-json/"><span class="title">Rust å®æˆ˜ä¸¨é€šè¿‡å®ç° json! æŒæ¡å£°æ˜å®</span></a><a class="item" href="/2024/04/23/rust-action-inverted-index-concurrency/"><span class="title">Rust å®æˆ˜ä¸¨å¹¶å‘æ„å»ºå€’æ’ç´¢å¼•</span></a><a class="item" href="/2024/04/15/rust-action-inverted-index-demo/"><span class="title">Rust å®æˆ˜ä¸¨å€’æ’ç´¢å¼•</span></a><a class="item" href="/2024/03/06/rust-action-httpie/"><span class="title">Rust å®æˆ˜ä¸¨HTTPie</span></a><a class="item" href="/2024/01/17/rust-action-mandelbrot/"><span class="title">Rust å®æˆ˜ä¸¨ç»˜åˆ¶æ›¼å¾·åšé›†</span></a></div></widget>

<widget class="widget-wrapper post-list"><div class="widget-header dis-select"><span class="name">æœ€è¿‘æ›´æ–°</span></div><div class="widget-body fs14"><a class="item title" href="/2025/12/18/mysql/mysql-transaction/"><span class="title">MySQL åº•å±‚åŸç†ä¸¨äº‹åŠ¡çš„å®ç°ï¼ˆåŠä¸‰ç§æ—¥å¿—ï¼‰</span></a><a class="item title" href="/2025/11/23/go/go-net/"><span class="title">Go åº•å±‚åŸç†ä¸¨ç½‘ç»œç¼–ç¨‹</span></a><a class="item title" href="/2025/12/17/mysql/mysql-online-ddl/"><span class="title">MySQL åº•å±‚åŸç†ä¸¨Online DDL</span></a><a class="item title" href="/2025/08/30/note/note-llm-from-scratch/"><span class="title">è¯»ä¹¦ç¬”è®°ä¸¨ã€Šä»é›¶æ„å»ºå¤§è¯­è¨€æ¨¡å‹ã€‹</span></a><a class="item title" href="/2025/12/17/mysql/mysql-master-slave-new-questions/"><span class="title">MySQL åº•å±‚åŸç†ä¸¨ä¸»ä»å¤åˆ¶å¸¦æ¥çš„æ–°é—®é¢˜</span></a><a class="item title" href="/2025/12/17/mysql/mysql-lock/"><span class="title">MySQL åº•å±‚åŸç†ä¸¨é”</span></a><a class="item title" href="/2025/04/08/mysql/mysql-ibd/"><span class="title">ä¸€æ­¥æ­¥æ¨å¯¼å‡º MySQL æ•°æ®çš„åº•å±‚å­˜å‚¨ç»“æ„</span></a><a class="item title" href="/2025/12/08/mysql/mysql-binlog-practice/"><span class="title">MySQL Binlog å®è·µ CDC</span></a><a class="item title" href="/2025/11/22/go/go-channel/"><span class="title">Go åº•å±‚åŸç†ä¸¨channel</span></a><a class="item title" href="/2025/11/21/go/go-lock/"><span class="title">Go åº•å±‚åŸç†ä¸¨é”</span></a></div></widget>
</div>

</div></aside><div class="l_main" id="main">





<div class="article banner top"><img class="bg lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/banner/rust-action-oneshot-channel.jpg">
  <div class="content">
    <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">ä¸»é¡µ</a>
<span class="sep"></span><a class="cap breadcrumb" id="menu" href="/topic">ä¸“æ </a><span class="sep"></span><a class="cap breadcrumb" id="proj" href="/2025/06/11/rust-action-rwlock/">Rust å®æˆ˜é›†åˆ</a></div>
<div class="flex-row" id="post-meta"><span class="text created">å‘å¸ƒäºï¼š<time datetime="2025-05-29T14:11:03.000Z">2025-05-29</time></span><span class="sep updated"></span><span class="text updated">æ›´æ–°äºï¼š<time datetime="2025-07-27T04:29:14.336Z">2025-07-27</time></span></div></div></div>
    
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª oneshot channel</span></h1>
        
      </div>
    </div>
    
  </div>
  </div><article class="md-text content"><p>ç³»åˆ—æ–‡ç« ï¼š</p>
<ul>
<li><a href="https://hedon.top/2024/11/11/rust-memory-order/">Rust
åŸç†ä¸¨èŠä¸€èŠ Rust çš„ Atomic å’Œå†…å­˜é¡ºåº</a></li>
<li><a
href="https://hedon.top/2025/06/05/rust-atomic-in-processor/">Rust
åŸç†ä¸¨ä»æ±‡ç¼–è§’åº¦çœ‹åŸå­æ“ä½œ</a></li>
<li><a href="https://hedon.top/2025/05/13/rust-action-spinlock/">Rust
å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª SpinLock</a></li>
<li><a
href="https://hedon.top/2025/05/29/rust-action-oneshot-channel/">Rust
å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª oneshot channel</a> ğŸ‘ˆ æœ¬ç¯‡</li>
<li><a href="https://hedon.top/2025/06/03/rust-action-arc/">Rust
å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª Arc</a></li>
<li><a href="https://hedon.top/2025/06/08/rust-os-primitives/">Rust
åŸç†ä¸¨æ“ä½œç³»ç»Ÿå¹¶å‘åŸè¯­</a></li>
<li><a href="https://hedon.top/2025/06/09/rust-action-mutex/">Rust
å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª Mutex</a></li>
<li><a href="https://hedon.top/2025/06/09/rust-action-condvar/">Rust
å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª Condvar</a></li>
<li><a href="https://hedon.top/2025/06/11/rust-action-rwlock/">Rust
å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª RwLock</a></li>
</ul>
<hr />
<p>ç»§ä¸Šç¯‡ <a
href="https://hedon.top/2025/05/13/rust-action-spinlock/">Rust
å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª SpinLock</a>ï¼Œæœ¬ç¯‡æˆ‘ä»¬ç»§ç»­å‚è€ƒ <a
target="_blank" rel="noopener" href="https://marabos.nl/atomics/">Rust Atomics and Locks</a>
ä¸€ä¹¦ï¼Œæ¥å®ç°ä¸€ä¸ª <code>oneshot channel</code>ã€‚</p>
<p>åœ¨ Go è¯­è¨€ä¸­ï¼Œæœ‰ä¸€å¥åè¨€ï¼š</p>
<blockquote>
<p>Don't communicate by sharing memory, share memory by communicating.
ä¸è¦é€šè¿‡å…±äº«å†…å­˜æ¥é€šä¿¡ï¼Œè€Œè¦é€šè¿‡é€šä¿¡æ¥å…±äº«å†…å­˜ã€‚</p>
</blockquote>
<p>è®²çš„å°±æ˜¯é€šé“ <code>channel</code>ã€‚ä½¿ç”¨ <code>channel</code>
æ¥é€šä¿¡ï¼Œä¸€æ–¹é¢å¯ä»¥é¿å…å…±äº«çŠ¶æ€çš„å¹¶å‘ç«äº‰é—®é¢˜ï¼Œå¦ä¸€æ–¹é¢å¯ä»¥è§£è€¦ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ã€‚</p>
<p><code>channel</code> æ ¹æ®ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„æ•°é‡ï¼Œå¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç§ï¼š</p>
<ol type="1">
<li><strong>å•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…</strong> (SPSC)</li>
<li><strong>å•ç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…</strong> (SPMC)</li>
<li><strong>å¤šç”Ÿäº§è€…å•æ¶ˆè´¹è€…</strong> (MPSC)</li>
<li><strong>å¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…</strong> (MPMC)</li>
</ol>
<p>åœ¨<strong>å•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…</strong>è¿™ä¸ªåˆ†ç±»ä¸­ï¼Œæœ‰ä¸€ç§ç‰¹æ®Šä¸”å¸¸ç”¨çš„åœºæ™¯ï¼Œå«<strong>ä¸€æ¬¡æ€§é€šé“</strong>ï¼ˆoneshot
channelï¼‰ã€‚å®ƒåœ¨ SPSC
çš„åŸºç¡€ä¸Šå¢åŠ äº†é¢å¤–çº¦æŸï¼šæ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…åªä¼ é€’ä¸€æ¬¡æ•°æ®ï¼Œä¼ é€’å®Œæˆåé€šé“å°±å¤±æ•ˆäº†ã€‚</p>
<p>ç†Ÿæ‚‰ Go è¯­è¨€çš„è¯»è€…åº”è¯¥å¯¹ä»¥ä¸‹ä½¿ç”¨åœºæ™¯å¾ˆç†Ÿæ‚‰ï¼Œè¿™äº›éƒ½æ˜¯å…¸å‹çš„ oneshot
channel åº”ç”¨ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">demo1</span><span class="params">()</span></span> &#123;</span><br><span class="line">	done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="comment">// ... do something</span></span><br><span class="line">		<span class="built_in">close</span>(done)</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	&lt;-done</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">demo2</span><span class="params">()</span></span> &#123;</span><br><span class="line">	oneShot := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>, <span class="number">1</span>)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		oneShot &lt;- generateText()</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	text := &lt;-oneShot</span><br><span class="line">	doSthWithText(text)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">generateText</span><span class="params">()</span></span> <span class="type">string</span> &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doSthWithText</span><span class="params">(text <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ Rust ç¤¾åŒºé‡Œé¢ï¼Œå°±æœ‰ä¸€ä¸ªéå¸¸ä¼˜ç§€çš„ <a
target="_blank" rel="noopener" href="https://docs.rs/oneshot/latest/oneshot/">oneshot</a>
å®ç°ï¼Œåœ¨è¯¦ç»†æ·±å…¥å®ƒçš„å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå‚è€ƒ <a
target="_blank" rel="noopener" href="https://marabos.nl/atomics/building-channels.html">Rust Atomics
and Locks</a> ä¸€ä¹¦ï¼Œæ¥å°è¯•å®ç°ä¸€ä¸ª <code>oneshot channel</code>!</p>
<h2 id="è¯»å®Œæœ¬ç¯‡ä½ èƒ½å­¦åˆ°ä»€ä¹ˆ">è¯»å®Œæœ¬ç¯‡ä½ èƒ½å­¦åˆ°ä»€ä¹ˆ</h2>
<ol type="1">
<li><p><strong>ä¸€æ¬¡æ€§ (oneshot) é€šé“çš„åœºæ™¯ä¸ä¼˜åŠ¿</strong></p>
<ul>
<li>äº†è§£å®ƒä¸å¤šç”Ÿäº§è€…/å¤šæ¶ˆè´¹è€…é€šé“çš„åŒºåˆ«</li>
<li>æŒæ¡å¸¸è§ä½¿ç”¨æ¨¡å¼ï¼ˆå¦‚çº¿ç¨‹åŒæ­¥ã€å•æ¬¡ç»“æœè¿”å›ï¼‰</li>
</ul></li>
<li><p><strong>Rust å¹¶å‘æ ¸å¿ƒåŸè¯­çš„æ¸è¿›å¼å®è·µ</strong></p>
<ul>
<li><code>UnsafeCell</code>ï¼šå†…éƒ¨å¯å˜æ€§åŸºçŸ³</li>
<li><code>AtomicBool</code> +
<code>Ordering::&#123;Release,Acquire&#125;</code>ï¼šæœ€å°åŒ–åŒæ­¥åŸè¯­</li>
<li><code>MaybeUninit&lt;T&gt;</code>ï¼šé›¶æˆæœ¬å»¶è¿Ÿåˆå§‹åŒ–</li>
</ul></li>
<li><p><strong>ç”¨æ‰€æœ‰æƒä¸ç”Ÿå‘½å‘¨æœŸè®¾è®¡é›¶è¯¯ç”¨ API</strong></p>
<ul>
<li>å°† <code>Sender</code> / <code>Receiver</code> æ‹†åˆ†å¹¶ä¸€æ¬¡æ€§æ¶ˆè´¹</li>
<li>ç”Ÿå‘½å‘¨æœŸå¼•ç”¨ vs <code>Arc</code> çš„æƒè¡¡ä¸æ›¿æ¢æŠ€å·§</li>
</ul></li>
<li><p><strong>çº¿ç¨‹æŒ‚èµ·/å”¤é†’æœºåˆ¶</strong></p>
<ul>
<li><code>std::thread::park / unpark</code> çš„é˜»å¡å¼ç­‰å¾…æ¨¡å‹</li>
</ul></li>
<li><p><strong>ç±»å‹ç³»ç»Ÿå±‚é¢çš„â€œé˜²å‘†â€æ‰‹æ®µ</strong></p>
<ul>
<li>åˆ©ç”¨ <code>PhantomData</code> ç¦æ­¢è·¨çº¿ç¨‹è¯¯ç”¨</li>
<li><code>Drop</code> æ‰‹åŠ¨å›æ”¶ï¼Œé¿å…å†…å­˜æ³„æ¼</li>
</ul></li>
<li><p><strong>ä¸€æ­¥æ­¥ä¼˜åŒ–çš„æ€è€ƒè·¯å¾„</strong></p>
<ul>
<li>å¦‚ä½•å‘ç°é—®é¢˜ â†’ æå‡ºå‡è®¾ â†’ å®ç° â†’ éªŒè¯ â†’ å†è¿­ä»£</li>
</ul></li>
</ol>
<p>å¸¦ç€è¿™äº›ç›®æ ‡ï¼Œè·Ÿéšæœ¬æ–‡ä¸€è·¯è¿­ä»£åˆ°
<strong>v8</strong>ï¼Œä½ å°†æ‹¥æœ‰ä¸€ä¸ªé«˜æ€§èƒ½ã€é›¶è¯¯ç”¨çš„ oneshot
channelï¼Œä»¥åŠä¸€æ•´å¥—å¯è¿ç§»åˆ°å…¶å®ƒå¹¶å‘åœºæ™¯çš„è®¾è®¡æ€ç»´ã€‚</p>
<h2 id="çƒ­èº«ç‰ˆ-v0åŸºäºé”çš„é€šé“">çƒ­èº«ç‰ˆ v0ï¼šåŸºäºé”çš„é€šé“</h2>
<p>æˆ‘ä»¬å…ˆæ¥å®ç°ä¸€ä¸ª<strong>ä¸‡èƒ½ç‰ˆ</strong> <code>channel</code>
çƒ­çƒ­èº«ã€‚é¡¾åæ€ä¹‰ï¼Œ<code>channel</code> åˆ†ä¸º 2 ä¸ªåŠŸèƒ½ï¼Œ<code>send</code>
å’Œ <code>receive</code>ï¼Œå…¶ä¸­ï¼š</p>
<ul>
<li><code>send</code> å¾€ <code>channel</code> ä¸€å¤´æ”¾æ•°æ®ã€‚</li>
<li><code>receive</code> ä» <code>channel</code>
å¦å¤–ä¸€å¤´å–æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®ï¼Œåˆ™é˜»å¡ä½ï¼Œç›´åˆ°æœ‰æ•°æ®æ—¶è¿”å›å–å‡ºæ•°æ®å¹¶è¿”å›ã€‚</li>
</ul>
<p>åœ¨ Rust ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨é˜Ÿåˆ— <code>VecQueue</code>
æ¥ä½œä¸ºæ•°æ®çš„æ‰¿è½½ï¼ŒåŒæ—¶ä¸ºäº†å¯¹é˜Ÿåˆ—è®¿é—®çš„å¹¶å‘å®‰å…¨ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨é”
<code>Mutex</code>
æ¥ä¿æŠ¤å®ƒï¼Œå¦å¤–ï¼Œåœ¨æ¶ˆè´¹è€…å–æ•°æ®æ—¶ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®ï¼Œåˆ™éœ€è¦é˜»å¡å¹¶ç­‰å¾…å”¤é†’ï¼ˆä½¿ç”¨å¾ªç¯ç­‰å¾…å°±å¤ªè€—
CPU äº†ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ¡ä»¶å˜é‡ <code>Condvar</code>
æ¥å®ç°æŒ‚èµ·å’Œå”¤é†’ã€‚</p>
<p>ç»è¿‡ä»¥ä¸Šåˆ†æï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰å¦‚ä¸‹çš„ç»“æ„ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::&#123;</span><br><span class="line">    collections::VecDeque,</span><br><span class="line">    sync::&#123;Condvar, Mutex&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Channel</span>&lt;T&gt; &#123;</span><br><span class="line">    queue: Mutex&lt;VecDeque&lt;T&gt;&gt;,</span><br><span class="line">    item_ready: Condvar,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>send</code> å’Œ <code>receive</code>
æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; Channel&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            queue: Mutex::<span class="title function_ invoke__">new</span>(VecDeque::<span class="title function_ invoke__">new</span>()),</span><br><span class="line">            item_ready: Condvar::<span class="title function_ invoke__">new</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">send</span>(&amp;<span class="keyword">self</span>, message: T) &#123;</span><br><span class="line">      	<span class="comment">// ä¸Šé”å¹¶ä»é˜Ÿåˆ—åé¢æ’å…¥æ•°æ®</span></span><br><span class="line">        <span class="keyword">self</span>.queue.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>().<span class="title function_ invoke__">push_back</span>(message);</span><br><span class="line">        <span class="comment">// å”¤é†’ä¸€ä¸ªç­‰å¾…æ•°æ®çš„çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">self</span>.item_ready.<span class="title function_ invoke__">notify_one</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">receive</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> T &#123;</span><br><span class="line">      	<span class="comment">// æŠ¢å é˜Ÿåˆ—</span></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">b</span> = <span class="keyword">self</span>.queue.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">          	<span class="comment">// å°è¯•ä»é˜Ÿåˆ—ä¸­è·å–æ•°æ®ï¼Œå¦‚æœè·å–åˆ°ï¼Œåˆ™ç›´æ¥è¿”å›ï¼ˆå¹¶é‡Šæ”¾é”ï¼‰</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(message) = b.<span class="title function_ invoke__">pop_front</span>() &#123;</span><br><span class="line">                <span class="keyword">return</span> message;</span><br><span class="line">            &#125;</span><br><span class="line">          	<span class="comment">// æ²¡æœ‰æ•°æ®ï¼Œåˆ™æŒ‚èµ·å½“å‰çº¿ç¨‹ï¼ˆåŒæ—¶é‡Šæ”¾é”ï¼‰</span></span><br><span class="line">            b = <span class="keyword">self</span>.item_ready.<span class="title function_ invoke__">wait</span>(b).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>self.queue.lock().unwrap()</code> è¿”å›çš„
<code>b</code> æ˜¯ä¸€ä¸ª <code>MutextGuard</code>ï¼Œæ‰€ä»¥å½“æ‰§è¡Œ
<code>self.item_ready.wait(b)</code>
çš„æ—¶å€™ï¼Œåœ¨æŒ‚èµ·å½“å‰çº¿ç¨‹çš„æ—¶å€™ï¼Œä¼šé‡Šæ”¾
<code>b</code>ï¼Œæ‰€ä»¥è¿™é‡Œä¸ä¼šä¸€ç›´å ç”¨é”ï¼Œè€Œå¯¼è‡´å…¶ä»–çº¿ç¨‹æŠ¢ä¸åˆ°é”ã€‚</p>
<p>è¿™ä¸ªç‰ˆæœ¬çš„å®ç°åœ¨åŠŸèƒ½ä¸Šå½“ç„¶æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯åœ¨æ€§èƒ½ä¸Šè¿˜æœ‰éå¸¸å¤šå¯ä»¥ä¼˜åŒ–çš„åœ°æ–¹ï¼Œå°¤å…¶æ˜¯åœ¨é”çš„ä½¿ç”¨ä¸Šï¼Œåœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œé”çš„ç«äº‰ä¼šéå¸¸æ¿€çƒˆã€‚</p>
<p>OKï¼Œçƒ­å®Œèº«åï¼Œæˆ‘ä»¬å¼€å§‹åŸºäºè¿™ä¸ªå®ç°ï¼Œæ¥ä¸€æ­¥æ­¥å®ç°ä¸€ä¸ªé«˜æ€§èƒ½çš„
<code>oneshot channel</code>ï¼</p>
<h2 id="åŸºç¡€ç‰ˆ-v1unsafe-æé†’ä½¿ç”¨è€…">åŸºç¡€ç‰ˆ v1ï¼šunsafe æé†’ä½¿ç”¨è€…</h2>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Channel</span>&lt;T&gt; &#123;</span><br><span class="line">    queue: Mutex&lt;VecDeque&lt;T&gt;&gt;,</span><br><span class="line">    item_ready: Condvar,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å…ˆæ¥åˆ†æä¸€ä¸‹ï¼Œä¸€ä¸ª <code>oneshot channel</code>
çš„ç»“æ„ï¼Œéœ€è¦åŒ…å«å“ªäº›å­—æ®µã€‚</p>
<ol type="1">
<li>é¦–å…ˆå®ƒå¯èƒ½ä¼šæœ‰ 0 æ¡æ•°æ®æˆ– 1 æ¡æ•°æ®ï¼Œæ‰€ä»¥å¾ˆå½“ç„¶ï¼Œæ•°æ®å¯ä»¥ç”¨ä¸€ä¸ª
<code>Option</code> æ¥æ‰¿è½½ã€‚</li>
<li>å¦å¤–ï¼Œ<code>send</code> å’Œ <code>receive</code>
å¯ä»¥åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­è¢«è°ƒç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½ç”¨å…±äº«åªè¯»å¼•ç”¨ï¼Œè€Œä¸æ˜¯ç”¨
<code>mut</code> ç‹¬äº«å¯å˜å¼•ç”¨ï¼Œä½†æ˜¯ <code>send</code> å’Œ
<code>receive</code>
éƒ½éœ€è¦å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œå°±éœ€è¦ä¸€ä¸ªæ”¯æŒå†…éƒ¨å¯å˜æ€§çš„æ•°æ®ç»“æ„ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œå°±ç”¨åˆ°äº†ä¸Šç¯‡
<a
href="https://hedon.top/2025/05/13/rust-action-spinlock/#%E5%8D%87%E7%BA%A7%E7%89%88-v1">Rust
å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª SpinLock</a> ä»‹ç»çš„
<code>UnsafeCell&lt;T&gt;</code>ï¼Œå®ƒå…è®¸åœ¨å…±äº«å¼•ç”¨ä¸‹è¿›è¡Œå†…éƒ¨å¯å˜æ€§ä¿®æ”¹ï¼Œæ˜¯
Rust å¹¶å‘åŸè¯­çš„åŸºçŸ³ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</li>
<li>æœ€åï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå˜é‡æ¥è¡¨æ˜æ˜¯å¦æœ‰æ•°æ®ï¼Œä¸ºäº†å¹¶å‘å®‰å…¨ï¼Œè¿™é‡Œå¯ä»¥ç”¨
<code>AtomicBool</code>ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬ä¹Ÿå¢åŠ äº†ä¸€ä¸ª <code>is_ready</code>
çš„æ–¹æ³•ï¼Œç”¨äºåˆ¤æ–­æ•°æ®æ˜¯å¦å·²å‡†å¤‡å¥½ã€‚å¯¹äºåŸå­å˜é‡ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€å¯¹
<code>Release</code> å’Œ <code>Acquire</code>ï¼ˆ<code>Release</code>
ç¡®ä¿ä¹‹å‰çš„å†™å…¥å¯¹å…¶ä»–çº¿ç¨‹å¯è§ï¼Œ<code>Acquire</code> ç¡®ä¿èƒ½çœ‹åˆ°ä¹‹å‰çš„
<code>Release</code> å†™å…¥ï¼‰æ¥ç¡®ä¿åŸå­å˜é‡çš„è·¨çº¿ç¨‹å¯è§æ€§ã€‚</li>
</ol>
<p>åŸºäºä»¥ä¸Šåˆ†æï¼Œæˆ‘ä»¬å®šå‡ºäº†æ–°çš„ <code>Channel</code> ç»“æ„ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Channel</span>&lt;T&gt; &#123;</span><br><span class="line">    message: UnsafeCell&lt;<span class="type">Option</span>&lt;T&gt;&gt;,</span><br><span class="line">    ready: AtomicBool,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹åº”çš„ <code>send</code>ã€<code>receive</code> å’Œ
<code>is_ready</code> å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; Channel&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            message: UnsafeCell::<span class="title function_ invoke__">new</span>(<span class="literal">None</span>),</span><br><span class="line">            ready: AtomicBool::<span class="title function_ invoke__">new</span>(<span class="literal">false</span>),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Safety: Only call this once!</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">send</span>(&amp;<span class="keyword">self</span>, message: T) &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.message.<span class="title function_ invoke__">get</span>().<span class="title function_ invoke__">write</span>(<span class="title function_ invoke__">Some</span>(message));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.ready.<span class="title function_ invoke__">store</span>(<span class="literal">true</span>, Ordering::Release);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">is_ready</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.ready.<span class="title function_ invoke__">load</span>(Ordering::Acquire)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Safety: Only call this once,</span></span><br><span class="line">    <span class="comment">/// and only after is_ready() returns true!</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">receive</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> T &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; <span class="keyword">self</span>.message.<span class="title function_ invoke__">get</span>().<span class="title function_ invoke__">read</span>().<span class="title function_ invoke__">unwrap</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼š</p>
<ol type="1">
<li>æˆ‘ä»¬æš‚ä¸”ä½¿ç”¨ <code>unsafe</code> åŠ æ³¨é‡Šçš„æ–¹å¼ï¼Œæ¥
<strong>æé†’</strong> ä½¿ç”¨è€…ï¼Œ<code>send</code> å’Œ <code>receive</code>
åªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡ï¼ŒåŒæ—¶ï¼Œåœ¨è°ƒç”¨ <code>receive</code> ä¹‹å‰ï¼Œå¿…é¡»å…ˆä½¿ç”¨
<code>is_ready</code> è¿›è¡Œæ•°æ®æ£€æŸ¥ã€‚</li>
<li>å¯¹äºåŸå­å˜é‡ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€å¯¹ Release å’Œ Acquire
æ¥ç¡®ä¿åŸå­å˜é‡çš„è·¨çº¿ç¨‹å¯è§æ€§ï¼Œå…·ä½“å¯å‚è€ƒ <a
href="https://hedon.top/2024/11/11/rust-memory-order/">Rust åŸç†ä¸¨èŠä¸€èŠ
Rust çš„ Atomic å’Œå†…å­˜é¡ºåº</a>ã€‚</li>
</ol>
<p>å¦å¤–åˆ«å¿˜äº†ï¼Œ<code>UnsafeCell&lt;T&gt;</code> æ˜¯ä¸æ”¯æŒ
<code>Sync</code> çš„ï¼Œæ‰€ä»¥ä¸ºäº†æˆ‘ä»¬çš„ <code>Channel</code>
å¯ä»¥è·¨çº¿ç¨‹ä½¿ç”¨ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºå…¶å®ç° <code>Sync</code> traitï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. Channel&lt;T&gt; å¯ä»¥åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­è¢«åˆ†åˆ«æ‰§è¡Œ send å’Œ receiveï¼Œæ‰€ä»¥å®ƒçš„å¼•ç”¨å¯ä»¥åœ¨çº¿ç¨‹ä¸­å…±äº«ï¼Œæ‰€ä»¥éœ€è¦å®ç° Syncï¼›</span></span><br><span class="line"><span class="comment">// 2. T ç”±çº¿ç¨‹ 1 ç”Ÿæˆå¹¶æ”¾å…¥ Channelï¼Œç„¶åç”±çº¿ç¨‹ 2 ä» Channel ä¸­è·å–ï¼Œæ‰€ä»¥å®ƒéœ€è¦ä»ä¸€ä¸ªçº¿ç¨‹è½¬ç§»åˆ°å¦å¤–ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥éœ€è¦å®ç° Sendã€‚</span></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Sync</span> <span class="keyword">for</span> <span class="title class_">Channel</span>&lt;T&gt; <span class="keyword">where</span> T: <span class="built_in">Send</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">one_thread_should_work</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">channel</span> = Channel::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        channel.<span class="title function_ invoke__">send</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> channel.<span class="title function_ invoke__">is_ready</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">msg</span> = <span class="keyword">unsafe</span> &#123; channel.<span class="title function_ invoke__">receive</span>() &#125;;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(msg, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">cross_thread_should_work</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">channel</span> = Channel::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    thread::<span class="title function_ invoke__">scope</span>(|s| &#123;</span><br><span class="line">        s.<span class="title function_ invoke__">spawn</span>(|| &#123;</span><br><span class="line">            <span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">10</span>));</span><br><span class="line">            <span class="keyword">unsafe</span> &#123;</span><br><span class="line">                channel.<span class="title function_ invoke__">send</span>(<span class="number">1</span>);</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> channel.<span class="title function_ invoke__">is_ready</span>() &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">res</span> = <span class="keyword">unsafe</span> &#123; channel.<span class="title function_ invoke__">receive</span>() &#125;;</span><br><span class="line">                <span class="built_in">assert_eq!</span>(res, <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="åŸºç¡€ç‰ˆ-v2ä½¿ç”¨-maybeuninit-æ›¿ä»£-option-å‡å°‘å†…å­˜å¼€é”€">åŸºç¡€ç‰ˆ
v2ï¼šä½¿ç”¨ MaybeUninit æ›¿ä»£ Option å‡å°‘å†…å­˜å¼€é”€</h2>
<p>æˆ‘ä»¬å…ˆæ¥æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼š<strong>Option&lt;T&gt;
çš„å†…å­˜å ç”¨æ˜¯å¤šå°‘ï¼Ÿ</strong></p>
<blockquote>
<p>ç»“è®ºæ˜¯ï¼šï¼š<strong><code>Option&lt;T&gt;</code> ç›¸æ¯”äº
Tï¼Œå¯èƒ½éœ€è¦é¢å¤–æ¶ˆè€—æ ‡è®°ä½å’Œå¡«å……ä½çš„ç©ºé—´</strong>ã€‚å…·ä½“å¯å‚è€ƒ<u>é™„å½•ï¼š1.
Option&lt;T&gt; çš„å†…å­˜å ç”¨æ˜¯å¤šå°‘</u>ã€‚</p>
</blockquote>
<p>å¦å¤–ä¸€ç‚¹æ˜¯ï¼Œ<code>Option&lt;T&gt;</code>
å…¶å®å·²ç»åŒ…å«äº†æ˜¯å¦å­˜åœ¨å€¼çš„ä¿¡æ¯äº†ï¼Œå®ƒè·Ÿ <code>ready</code>
è¿™ä¸ªæ ‡å¿—çš„ä½œç”¨å…¶å®é‡å¤äº†ï¼Œæœ‰ä¸€äº›æµªè´¹ã€‚</p>
<p>åœ¨å½“ä¸‹åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦å¤–ä¸€ä¸ªæ•°æ®ç»“æ„æ¥æ›¿ä»£
<code>Option&lt;T&gt;</code> â€”â€”
<code>MaybeUninit&lt;T&gt;</code>ï¼Œç›¸æ¯”äº
<code>Option&lt;T&gt;</code>ï¼Œå®ƒæœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š</p>
<ol type="1">
<li><strong>å†…å­˜å ç”¨ä¼˜åŒ–</strong>ï¼šåœ¨ <code>Option&lt;T&gt;</code>
ä¸­ï¼Œå¯¹äºéç©ºæŒ‡é’ˆä¼˜åŒ–ï¼ˆNiche Optimizationï¼‰çš„ç±»å‹ï¼Œ<code>None</code>
ä¼šå ç”¨é¢å¤–çš„ç©ºé—´ï¼ˆä¸€ä¸ªå­—èŠ‚çš„æ ‡ç­¾+å¯èƒ½çš„å¯¹é½å¡«å……ï¼‰ã€‚è€Œ
<code>MaybeUninit&lt;T&gt;</code> æœ¬èº«å°±æ˜¯ä¸€ä¸ªå¤§å°ä¸ <code>T</code>
ç›¸åŒçš„æœªåˆå§‹åŒ–å†…å­˜ï¼Œå®ƒæ²¡æœ‰æ ‡ç­¾ï¼Œå› æ­¤ä¸ä¼šå¼•å…¥é¢å¤–çš„å†…å­˜å¼€é”€ã€‚</li>
<li><strong>é¿å…åˆå§‹åŒ–å¼€é”€</strong>ï¼šä½¿ç”¨ <code>Option&lt;T&gt;</code>
æ—¶ï¼Œåœ¨åˆå§‹åŒ–æ—¶è®¾ç½®ä¸º <code>None</code>ï¼Œå®é™…ä¸Šä¼šå†™å…¥ä¸€ä¸ªè¡¨ç¤º
<code>None</code> çš„å€¼ï¼ˆå³è¿›è¡Œåˆå§‹åŒ–ï¼‰ã€‚è€Œ
<code>MaybeUninit&lt;T&gt;</code> çš„ <code>uninit()</code>
ä¸ä¼šå¯¹å†…å­˜è¿›è¡Œä»»ä½•åˆå§‹åŒ–ï¼Œè¿™åœ¨æ€§èƒ½æ•æ„Ÿçš„åœºæ™¯ä¸‹å¯ä»¥é¿å…ä¸å¿…è¦çš„åˆå§‹åŒ–å¼€é”€ï¼ˆç‰¹åˆ«æ˜¯å½“
<code>T</code> å¾ˆå¤§æ—¶ï¼‰ã€‚</li>
<li><strong>æ›´çµæ´»åœ°æ§åˆ¶åˆå§‹åŒ–</strong>ï¼šåœ¨é€šé“çš„å®ç°ä¸­ï¼Œæ¶ˆæ¯å¯èƒ½ç”±ç”Ÿäº§è€…å†™å…¥ï¼Œç„¶åé€šè¿‡è®¾ç½®
<code>ready</code> æ ‡å¿—æ¥é€šçŸ¥æ¶ˆè´¹è€…ã€‚ä½¿ç”¨ <code>MaybeUninit</code>
å…è®¸æˆ‘ä»¬å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç›´åˆ°å®é™…éœ€è¦å†™å…¥æ¶ˆæ¯çš„æ—¶å€™ã€‚è¿™æ ·ï¼Œåœ¨é€šé“åˆ›å»ºæ—¶ï¼Œæˆ‘ä»¬ä¸éœ€è¦ä¸º
<code>T</code> ç±»å‹çš„å€¼è¿›è¡Œä»»ä½•åˆå§‹åŒ–ï¼ˆå³ä½¿æ˜¯
<code>None</code>ï¼‰ï¼Œè€Œæ˜¯ç•™å‡ºä¸€å—æœªåˆå§‹åŒ–çš„å†…å­˜ï¼Œåœ¨åç»­ç”±ç”Ÿäº§è€…å†™å…¥å®é™…çš„å€¼ã€‚</li>
<li><strong>ä¸åŸå­æ ‡å¿—é…åˆæ›´é«˜æ•ˆ</strong>ï¼šåœ¨ä¸Šä¸ªç‰ˆæœ¬çš„è§†çº¿ä¸­ï¼Œ<code>ready</code>
æ˜¯ä¸€ä¸ª <code>AtomicBool</code>ï¼Œç”¨äºæŒ‡ç¤ºæ¶ˆæ¯æ˜¯å¦å°±ç»ªã€‚åœ¨
<code>Option&lt;T&gt;</code> ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ£€æŸ¥ <code>Option</code>
æ˜¯å¦ä¸º <code>Some</code>ï¼ŒåŒæ—¶è¿˜è¦æ£€æŸ¥ <code>ready</code> æ ‡å¿—ã€‚è€Œä½¿ç”¨
<code>MaybeUninit</code> åï¼Œæˆ‘ä»¬å®Œå…¨ä¾èµ– <code>ready</code>
æ ‡å¿—æ¥åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦å¯ç”¨ï¼Œé¿å…äº†åŒé‡æ£€æŸ¥ï¼ˆå› ä¸º <code>MaybeUninit</code>
æœ¬èº«ä¸æºå¸¦çŠ¶æ€ï¼Œæ‰€ä»¥çŠ¶æ€å®Œå…¨ç”± <code>ready</code>
æ§åˆ¶ï¼‰ã€‚è¿™æ ·ï¼Œç»“æ„ä½“çš„å†…å­˜å¸ƒå±€æ›´ç´§å‡‘ï¼Œä¸”è®¿é—®æ¨¡å¼æ›´ç›´æ¥ã€‚</li>
<li><strong>æ½œåœ¨çš„æ€§èƒ½æå‡</strong>ï¼šç”±äºé¿å…äº†é¢å¤–çš„æ ‡ç­¾å’Œåˆå§‹åŒ–ï¼Œä»¥åŠæ›´ç´§å‡‘çš„å†…å­˜å¸ƒå±€ï¼Œå¯èƒ½ä¼šæé«˜ç¼“å­˜åˆ©ç”¨ç‡ï¼Œä»è€Œæå‡æ€§èƒ½ã€‚</li>
</ol>
<p><code>MaybeUninit&lt;T&gt;</code> æœ‰ä»¥ä¸‹å¸¸ç”¨æ–¹æ³•ï¼š</p>
<table>
<colgroup>
<col style="width: 28%" />
<col style="width: 46%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>å¸¸ç”¨æ–¹æ³•</th>
<th>ä½œç”¨</th>
<th>å®‰å…¨çº§åˆ«</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>MaybeUninit::uninit()</code></td>
<td>åˆ›å»ºä¸€å—<strong>å®Œå…¨æœªåˆå§‹åŒ–</strong>çš„å†…å­˜</td>
<td><code>const fn</code>ã€<code>safe</code></td>
</tr>
<tr>
<td><code>as_mut_ptr()</code> / <code>as_ptr()</code></td>
<td>å–å‡ºè£¸æŒ‡é’ˆï¼Œä¾›å¤–éƒ¨å†™å…¥æˆ–è¯»å–</td>
<td><code>safe</code></td>
</tr>
<tr>
<td><code>assume_init()</code> / <code>assume_init_read()</code></td>
<td>å‘Šè¯‰ç¼–è¯‘å™¨â€œè¿™é‡Œå·²ç»æ˜¯ä¸€ä¸ªåˆæ³•çš„ <code>T</code> äº†â€ï¼Œå¹¶è¿”å›å®ƒ</td>
<td><code>unsafe</code>ï¼ˆå› ä¸ºä½ å¾—ä¿è¯çœŸåˆå§‹åŒ–è¿‡ï¼‰</td>
</tr>
<tr>
<td><code>write(val)</code></td>
<td><strong>æŒ‰ä½æŠŠ <code>val</code> å¤åˆ¶/ç§»åŠ¨</strong>
åˆ°è¿™å—æœªåˆå§‹åŒ–å†…å­˜ï¼›æ­¤åè§†ä¸ºå·²åˆå§‹åŒ–</td>
<td><code>unsafe</code></td>
</tr>
</tbody>
</table>
<p>ç»è¿‡ä¸Šé¢ä¸€é¡¿åˆ†æï¼Œæˆ‘ä»¬æ¥ä½¿ç”¨ <code>MaybeUninit&lt;T&gt;</code> æ¥æ›¿ä»£
<code>Option&lt;T&gt;</code>ï¼Œè¿›ä¸€æ­¥å‡å°‘å†…å­˜å ç”¨å’Œæå‡æ€§èƒ½ï¼Œæ–°çš„
<code>Channel</code> ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Channel</span>&lt;T&gt; &#123;</span><br><span class="line">    message: UnsafeCell&lt;MaybeUninit&lt;T&gt;&gt;,</span><br><span class="line">    ready: AtomicBool,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Channel&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">          	<span class="comment">// åˆ›å»ºä¸€å—å®Œå…¨æœªåˆå§‹åŒ–çš„å†…å­˜ï¼Œå…ˆå ä½</span></span><br><span class="line">            message: UnsafeCell::<span class="title function_ invoke__">new</span>(MaybeUninit::<span class="title function_ invoke__">uninit</span>()),</span><br><span class="line">            ready: AtomicBool::<span class="title function_ invoke__">new</span>(<span class="literal">false</span>),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹åº”çš„ <code>send</code> å’Œ <code>receive</code> å®ç°æ›´æ–°å¦‚ä¸‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; Channel&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">/// Safety: Only call this once!</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">send</span>(&amp;<span class="keyword">self</span>, message: T) &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            <span class="comment">// ä» UnsafeCell&lt;MaybeUninit&lt;T&gt;&gt; ä¸­å–å‡º MaybeUninit&lt;T&gt; å¹¶å†™å…¥æ•°æ®ã€‚</span></span><br><span class="line">            (*<span class="keyword">self</span>.message.<span class="title function_ invoke__">get</span>()).<span class="title function_ invoke__">write</span>(message);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.ready.<span class="title function_ invoke__">store</span>(<span class="literal">true</span>, Ordering::Release);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Safety: Only call this once,</span></span><br><span class="line">    <span class="comment">/// and only after is_ready() returns true!</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">receive</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> T &#123;</span><br><span class="line">      	<span class="comment">// ä» UnsafeCell&lt;MaybeUninit&lt;T&gt;&gt; ä¸­å–å‡º MaybeUninit&lt;T&gt; å¹¶è¯»å‡ºæ•°æ®ã€‚</span></span><br><span class="line">        <span class="keyword">unsafe</span> &#123; (*<span class="keyword">self</span>.message.<span class="title function_ invoke__">get</span>()).<span class="title function_ invoke__">assume_init_read</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ <code>send</code> ä¸­ï¼Œ<code>(*self.message.get())</code> ä»
<code>UnsafeCell&lt;MaybeUninit&lt;T&gt;&gt;</code> ä¸­å–å‡º
<code>MaybeUninit&lt;T&gt;</code>ï¼Œç„¶åè°ƒç”¨ <code>write</code> æ–¹æ³•æŠŠ
<code>message</code>
å†™å…¥è¿™å—æœªåˆå§‹åŒ–çš„å†…å­˜ä¸­ï¼Œæ­¤åè§†ä¸ºå·²åˆå§‹åŒ–ï¼Œå¹¶å¯ä»¥ä½¿ç”¨ä½¿ç”¨
<code>assume_init_read</code> è¿›è¡Œè¯»å–ã€‚</p>
<p>ä¿®æ”¹åï¼Œæµ‹è¯•ä»£ç æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œæˆ‘ä»¬æ‰§è¡Œä¹‹å‰çš„æµ‹è¯•ä»£ç ï¼Œå‘ç°è¿˜æ˜¯å¯ä»¥é€šè¿‡çš„ï¼</p>
<h2 id="åŸºç¡€ç‰ˆ-v3å¢åŠ åŠ¨æ€æ£€æŸ¥æé«˜å®‰å…¨æ€§">åŸºç¡€ç‰ˆ
v3ï¼šå¢åŠ åŠ¨æ€æ£€æŸ¥æé«˜å®‰å…¨æ€§</h2>
<p>ä¸Šè¿°ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ <code>unsafe</code>
å’Œæ³¨é‡Šå»â€œè¦æ±‚â€è°ƒç”¨è€…ä¸¥æ ¼éµå¾ªä»¥ä¸‹çº¦æŸï¼š</p>
<ol type="1">
<li><code>send</code> å’Œ <code>receive</code> æœ€å¤šåªè°ƒç”¨ä¸€æ¬¡ã€‚</li>
<li><code>receive</code> è°ƒç”¨ä¹‹å‰ï¼Œå¿…é¡»å…ˆç»è¿‡ <code>is_ready</code>
çš„æ£€æŸ¥ã€‚</li>
</ol>
<p>åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬åŠ ä¸€ä¸‹åŠ¨æ€æ£€æŸ¥ï¼Œå¦‚æœè°ƒç”¨è€…ä¸æŒ‰è¦æ±‚åšäº‹ï¼Œé‚£å°±ç›´æ¥
<code>panic</code> ç»™å‡ºå‘Šè­¦ã€‚</p>
<p>åœ¨ <code>receive</code> ä¸­ï¼Œæˆ‘ä»¬éœ€è¦åš 2 ç‚¹ä¿è¯ï¼šâ‘  å·²ç»æœ‰æ•°æ®äº†ï¼Œâ‘¡
æ•°æ®åªè¢«æ¶ˆè€—äº†ä¸€æ¬¡ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">receive</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> T &#123;</span><br><span class="line">    <span class="keyword">if</span> !<span class="keyword">self</span>.ready.<span class="title function_ invoke__">swap</span>(<span class="literal">false</span>, Ordering::Acquire) &#123;</span><br><span class="line">        <span class="built_in">panic!</span>(<span class="string">&quot;no message available!&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; (*<span class="keyword">self</span>.message.<span class="title function_ invoke__">get</span>()).<span class="title function_ invoke__">assume_init_read</span>() &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ <code>swap</code>ï¼Œå°† <code>ready</code> ä»
<code>false</code> è½¬ä¸º <code>true</code>ï¼Œè¾¾åˆ°äº† 2 ä¸ªç›®çš„ï¼š</p>
<ol type="1">
<li>å¦‚æœè¿”å›äº† <code>false</code>ï¼Œåˆ™è¯´æ˜ä¹‹å‰çš„ <code>ready</code> ä¸º
<code>false</code>ï¼Œå³æ•°æ®æ²¡å‡†å¤‡å¥½ã€‚</li>
<li>å¦‚æœè¿”å›äº†
<code>true</code>ï¼Œåˆ™è¯´æ˜æ•°æ®å·²ç»å‡†å¤‡å¥½äº†ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œä¹Ÿå·²ç»å°†
<code>ready</code> ç½®ä¸º <code>false</code>ï¼Œè¿™æ ·åé¢è°ƒç”¨çš„
<code>receive</code> ä¹Ÿå°†å¤±è´¥ã€‚</li>
</ol>
<p>å¯¹äº
<code>send</code>ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯åªå†™å…¥ä¸€æ¬¡ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦å¼•å…¥ä¸€ä¸ªæ–°çš„å˜é‡
<code>in_user</code>ï¼Œè¡¨ç¤º <code>send</code> æ˜¯å¦å·²ç»ä½¿ç”¨äº†ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Channel</span>&lt;T&gt; &#123;</span><br><span class="line">    message: UnsafeCell&lt;MaybeUninit&lt;T&gt;&gt;,</span><br><span class="line">    in_use: AtomicBool, <span class="comment">// æ–°å˜é‡ï¼Œè¡¨ç¤º send æ˜¯å¦å·²ç»ä½¿ç”¨äº†ã€‚</span></span><br><span class="line">    ready: AtomicBool,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Channel&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            message: UnsafeCell::<span class="title function_ invoke__">new</span>(MaybeUninit::<span class="title function_ invoke__">uninit</span>()),</span><br><span class="line">            in_use: AtomicBool::<span class="title function_ invoke__">new</span>(<span class="literal">false</span>),</span><br><span class="line">            ready: AtomicBool::<span class="title function_ invoke__">new</span>(<span class="literal">false</span>),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>send</code> ä¸­ï¼Œæˆ‘ä»¬ä¾æ—§ä½¿ç”¨ <code>swap</code>ï¼Œæ¥å°†
<code>in_use</code> ä»è½¬ä¸º <code>true</code>ï¼Œå¦‚æœè¿”å›
<code>true</code>ï¼Œåˆ™è¯´æ˜ä¹‹å‰å·²ç»æ‰§è¡Œè¿‡ <code>send</code>
äº†ï¼Œè¿™ä¸ªæ—¶å€™å°†æ‰§è¡Œ panic è¿›è¡Œå‘Šè­¦ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Panics when trying to send more than one message.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">send</span>(&amp;<span class="keyword">self</span>, message: T) &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">self</span>.in_use.<span class="title function_ invoke__">swap</span>(<span class="literal">true</span>, Ordering::Relaxed) &#123;</span><br><span class="line">        <span class="built_in">panic!</span>(<span class="string">&quot;can&#x27;t send more than one message&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        (*<span class="keyword">self</span>.message.<span class="title function_ invoke__">get</span>()).<span class="title function_ invoke__">write</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">self</span>.ready.<span class="title function_ invoke__">store</span>(<span class="literal">true</span>, Ordering::Release);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ä¸Šè¿°çš„ 2 ä¸ªä¼˜åŒ–ï¼Œæˆ‘ä»¬çš„ <code>Channel</code>
åˆâ€œå®‰å…¨â€äº†ä¸€ä¸¢ä¸¢ï¼</p>
<h2 id="åŸºç¡€ç‰ˆ-v4å®ç°-drop-è‡ªåŠ¨æ¸…ç†æ— ç”¨å†…å­˜">åŸºç¡€ç‰ˆ v4ï¼šå®ç° Drop
è‡ªåŠ¨æ¸…ç†æ— ç”¨å†…å­˜</h2>
<p>å› ä¸ºæˆ‘ä»¬ä½¿ç”¨äº†
<code>MaybeUninit&lt;T&gt;</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è‡ªå·±ç®¡ç† <code>T</code>
çš„å†…å­˜ç®¡ç†ï¼Œä½†åœ¨ä¸Šè¿°çš„å®ç°ä¸­ï¼Œå¯èƒ½å­˜åœ¨ä¸€ç§æƒ…å†µï¼Œå¯¼è‡´å†…å­˜å¾—ä¸åˆ°é‡Šæ”¾ï¼š<strong>æˆ‘ä»¬åªæ‰§è¡Œäº†
<code>send</code>ï¼Œä½†ç›´åˆ° <code>Channel</code>
è¶…è¿‡ä½œç”¨åŸŸçš„æ—¶å€™ï¼Œéƒ½æ²¡æœ‰è¢« <code>receive</code></strong>ã€‚</p>
<p>ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä¸º <code>Channel</code> å®ç° <code>Drop</code>
traitï¼Œå½“æœ‰æ•°æ®çš„æ—¶å€™ï¼Œå¯¹<code>MaybeUninit&lt;T&gt;</code>
è¿›è¡Œå†…å­˜é‡Šæ”¾ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Drop</span> <span class="keyword">for</span> <span class="title class_">Channel</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> *<span class="keyword">self</span>.ready.<span class="title function_ invoke__">get_mut</span>() &#123;</span><br><span class="line">            <span class="keyword">unsafe</span> &#123;</span><br><span class="line">                <span class="keyword">self</span>.message.<span class="title function_ invoke__">get_mut</span>().<span class="title function_ invoke__">assume_init_drop</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å®‰å…¨éé˜»å¡ç‰ˆ-v5æä¾›å®‰å…¨æ–¹æ³•å‡å°‘ä½¿ç”¨è€…è¯¯ç”¨">å®‰å…¨éé˜»å¡ç‰ˆ
v5ï¼šæä¾›å®‰å…¨æ–¹æ³•ï¼Œå‡å°‘ä½¿ç”¨è€…è¯¯ç”¨</h2>
<p>åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬æ¥è§£å†³å‰é¢å®ç°çš„æœ€å¤§é—®é¢˜ï¼š<strong>æ–¹æ³•æ˜¯ä¸å®‰å…¨çš„ï¼Œä¸¥é‡ä¾èµ–è°ƒç”¨è€…çš„è‡ªè§‰æ€§ï¼Œæ²¡æœ‰å……åˆ†å‘æŒ¥
Rust å¼ºå¤§ç¼–è¯‘å™¨çš„æ£€æŸ¥èƒ½åŠ›</strong>ã€‚</p>
<p>å›é¡¾æˆ‘ä»¬çš„éœ€æ±‚ï¼š<strong>æˆ‘ä»¬è¦å®ç°çš„æ˜¯ä¸€ä¸ª
<code>oneshot channel</code>ï¼Œå³åªèƒ½è°ƒç”¨ä¸€æ¬¡ <code>send</code> å’Œ
<code>receive</code></strong>ã€‚</p>
<p>ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯ï¼šå¦‚ä½•åˆ©ç”¨ Rust
å¤©ç„¶çš„ç¼–è¯‘å™¨æ£€æŸ¥èƒ½åŠ›æ¥çº¦æŸè¿™ä¸€ç‚¹å‘¢ï¼Ÿå¾ˆæ˜æ˜¾ï¼Œå°±æ˜¯<strong>æ‰€æœ‰æƒæœºåˆ¶</strong>ï¼ä»€ä¹ˆä¸œè¥¿åªèƒ½æ‰§è¡Œä¸€æ¬¡å‘¢ï¼Ÿæ¶ˆè€—æ‰€æœ‰æƒçš„ä¸œè¥¿ï¼</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯¹äºç¬¬ä¸€ä¸ªå‚æ•°ä¸º self çš„æ–¹æ³•ï¼Œæ‰§è¡Œæ—¶ï¼Œä¼šè½¬ç§»æ‰€æœ‰æƒï¼Œæ‰§è¡Œåï¼ŒåŸå˜é‡å°±ä¸èƒ½å†ç”¨äº†ï¼Œå› ä¸ºæ‰€æœ‰æƒå·²ç»è½¬ç§»äº†ã€‚</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">do</span>(<span class="keyword">self</span>) &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>å¥½ï¼Œé‚£ç¬¬äºŒä¸ªé—®é¢˜å°±æ¥äº†ï¼š<code>self</code>
æ–¹æ³•åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œä½†å¾ˆæ˜æ˜¾æˆ‘ä»¬æ€»å…±éœ€è¦ 2 æ¬¡çš„è°ƒç”¨ï¼ˆ<code>send</code> å’Œ
<code>receive</code>ï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¯ä»¥å°† <code>Channel</code>
è¿›è¡Œæ‹†å¼€ï¼Œåˆ†æˆ <code>Sender</code> å’Œ <code>Receiver</code>ã€‚</p>
<p>é‚£ç¬¬ä¸‰ä¸ªé—®é¢˜ä¹Ÿå°±éšä¹‹è€Œæ¥äº†ï¼Œ<code>Sender</code> å’Œ
<code>Receiver</code> éƒ½éœ€è¦æŒæœ‰
<code>Channel</code>ï¼Œå¹¶ä¸”å¯èƒ½å¤„äºä¸åŒçš„çº¿ç¨‹ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥å…ˆç”¨
<code>Arc</code> æ¥å¯¹ <code>Channel</code> è¿›è¡Œå¼•ç”¨ã€‚</p>
<p>è§£å†³äº†ä¸Šè¿° 3 ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥æ¢³ç†æ–°çš„æ•°æ®ç»“æ„ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Sender</span>&lt;T&gt; &#123;</span><br><span class="line">    channel: Arc&lt;Channel&lt;T&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Receiver</span>&lt;T&gt; &#123;</span><br><span class="line">    channel: Arc&lt;Channel&lt;T&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Channel</span>&lt;T&gt; &#123;</span><br><span class="line">    message: UnsafeCell&lt;MaybeUninit&lt;T&gt;&gt;,</span><br><span class="line">    ready: AtomicBool,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">channel</span>&lt;T&gt;() <span class="punctuation">-&gt;</span> (Sender&lt;T&gt;, Receiver&lt;T&gt;) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span> = Arc::<span class="title function_ invoke__">new</span>(Channel &#123;</span><br><span class="line">        message: UnsafeCell::<span class="title function_ invoke__">new</span>(MaybeUninit::<span class="title function_ invoke__">uninit</span>()),</span><br><span class="line">        ready: AtomicBool::<span class="title function_ invoke__">new</span>(<span class="literal">false</span>),</span><br><span class="line">    &#125;);</span><br><span class="line">    (Sender &#123; channel: a.<span class="title function_ invoke__">clone</span>() &#125;, Receiver &#123; channel: a &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol type="1">
<li><code>Channel</code> ä¸­ç§»é™¤äº† <code>in_use</code>
å±æ€§ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»æœ‰ <code>self</code> åšæ‰€æœ‰æƒæ£€æŸ¥äº†ï¼Œä¸å†éœ€è¦
<code>in_use</code> æ¥é¿å…é‡å¤è°ƒç”¨ <code>send</code> äº†ã€‚</li>
<li>æ–°å¢äº† <code>Sender&lt;T&gt;</code> å’Œ
<code>Receiver&lt;T&gt;</code> ä¸¤ä¸ªç»“æ„ï¼Œå®ƒä»¬éƒ½å„è‡ªæŒæœ‰äº†ä¸€ä¸ª
<code>Arc&lt;Channel&gt;</code>ã€‚</li>
</ol>
<p>å¯¹åº”çš„ <code>send</code> å’Œ <code>receive</code> æ–¹æ³•å½“ç„¶ä¹Ÿå°±è½¬ç§»åˆ°
<code>Sender&lt;T&gt;</code> å’Œ <code>Receiver&lt;T&gt;</code>
èº«ä¸Šäº†ï¼Œå®ç°ä¹Ÿå’Œä¹‹å‰åŸºæœ¬ä¸€è‡´ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; Sender&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">send</span>(<span class="keyword">self</span>, messgae: T) &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; (*<span class="keyword">self</span>.channel.message.<span class="title function_ invoke__">get</span>()).<span class="title function_ invoke__">write</span>(messgae) &#125;;</span><br><span class="line">        <span class="keyword">self</span>.channel.ready.<span class="title function_ invoke__">store</span>(<span class="literal">true</span>, Ordering::Release);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Receiver&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">is_ready</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.channel.ready.<span class="title function_ invoke__">load</span>(Ordering::Relaxed)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Safety: only after is_ready() returns true!</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">receive</span>(<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> T &#123;</span><br><span class="line">        <span class="keyword">if</span> !<span class="keyword">self</span>.channel.ready.<span class="title function_ invoke__">swap</span>(<span class="literal">false</span>, Ordering::Acquire) &#123;</span><br><span class="line">            <span class="built_in">panic!</span>(<span class="string">&quot;no message available!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; (*<span class="keyword">self</span>.channel.message.<span class="title function_ invoke__">get</span>()).<span class="title function_ invoke__">assume_init_read</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Drop æ²¡å˜</span></span><br></pre></td></tr></table></figure>
<p>ä¿®æ”¹äº†ç»“æ„äº†ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹å¯¹åº”çš„æµ‹è¯•ä»£ç ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">one_thread_should_work</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> (sender, receiver) = <span class="title function_ invoke__">channel</span>();</span><br><span class="line">    sender.<span class="title function_ invoke__">send</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> receiver.<span class="title function_ invoke__">is_ready</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">msg</span> = receiver.<span class="title function_ invoke__">receive</span>();</span><br><span class="line">        <span class="built_in">assert_eq!</span>(msg, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">cross_thread_should_work</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> (sender, receiver) = <span class="title function_ invoke__">channel</span>();</span><br><span class="line">    thread::<span class="title function_ invoke__">scope</span>(|s| &#123;</span><br><span class="line">        s.<span class="title function_ invoke__">spawn</span>(|| &#123;</span><br><span class="line">            <span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">10</span>));</span><br><span class="line">            sender.<span class="title function_ invoke__">send</span>(<span class="number">1</span>); <span class="comment">// æ²¡æœ‰ unsafe äº†ï¼</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> receiver.<span class="title function_ invoke__">is_ready</span>() &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">res</span> = receiver.<span class="title function_ invoke__">receive</span>(); <span class="comment">// æ²¡æœ‰ unsafe äº†ï¼</span></span><br><span class="line">                <span class="built_in">assert_eq!</span>(res, <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨æœ€æ–°çš„æµ‹è¯•ä»£ç ä¸­ï¼Œæˆ‘ä»¬å·²ç»ä¸å†éœ€è¦ <code>unsafe</code>
ä»£ç äº†ï¼è¿™å¯¹äºä½¿ç”¨è€…æ¥è¯´ï¼Œå°±éå¸¸å‹å¥½äº†ï¼</p>
<p>è€Œä¸”è¿™ä¸ªæ—¶å€™ï¼Œä½ å¦‚æœå°è¯•æ‰§è¡Œå¤šæ¬¡ <code>send</code> å’Œ
<code>receive</code> çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨å°±ä¼šæŠ¥é”™äº†ï¼</p>
<p>ä¸è¿‡å®ƒè¿˜æ˜¯æœ‰ 2 ä¸ªç¼ºç‚¹ï¼š</p>
<ol type="1">
<li><code>Arc</code> çš„å¤åˆ¶è¿˜æ˜¯æœ‰ä¸€äº›å¼€é”€çš„ã€‚</li>
<li>æˆ‘ä»¬ä¾æ—§ä¾èµ–ä½¿ç”¨è€…æå‰ç”¨ <code>is_ready</code> æ¥æ£€æŸ¥ï¼Œå¦åˆ™ç›´æ¥è°ƒç”¨
<code>receive</code> å°±æœ‰å¯èƒ½ä¼š <code>panic</code>ã€‚</li>
</ol>
<p>æˆ‘ä»¬å…ˆæ¥è§£å†³ç¬¬ 1 ä¸ªé—®é¢˜ã€‚</p>
<h2
id="å®‰å…¨éé˜»å¡ç‰ˆ-v6ä½¿ç”¨ç”Ÿå‘½å‘¨æœŸåŠ å¼•ç”¨é¿å…-arc-çš„å¤åˆ¶å¼€é”€">å®‰å…¨éé˜»å¡ç‰ˆ
v6ï¼šä½¿ç”¨ç”Ÿå‘½å‘¨æœŸåŠ å¼•ç”¨ï¼Œé¿å… Arc çš„å¤åˆ¶å¼€é”€</h2>
<p>ä¸ºäº†é¿å… Arc çš„å¼€é”€ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ <code>Sender&lt;T&gt;</code> å’Œ
<code>Receiver&lt;T&gt;</code> ä¸­æŒæœ‰ <code>Channel&lt;T&gt;</code>
çš„å¼•ç”¨ï¼Œè€Œå¼•ç”¨çš„å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸ç¡®å®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åŠ å…¥ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨ï¼Œæ¥å‘Šè¯‰ç¼–è¯‘å™¨æˆ‘ä»¬çš„å¼•ç”¨æ˜¯é€»è¾‘è‡ªæ´½çš„ã€‚</p>
<p>æ–°çš„ç»“æ„å’Œæ„é€ å‡½æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Sender</span>&lt;<span class="symbol">&#x27;a</span>, T&gt; &#123;</span><br><span class="line">    channel: &amp;<span class="symbol">&#x27;a</span> Channel&lt;T&gt;, <span class="comment">// ä½¿ç”¨å¼•ç”¨æ›¿ä»£ Arcï¼Œå¹¶åŠ å…¥ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Receiver</span>&lt;<span class="symbol">&#x27;a</span>, T&gt; &#123;</span><br><span class="line">    channel: &amp;<span class="symbol">&#x27;a</span> Channel&lt;T&gt;, <span class="comment">// ä½¿ç”¨å¼•ç”¨æ›¿ä»£ Arcï¼Œå¹¶åŠ å…¥ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Channel</span>&lt;T&gt; &#123;</span><br><span class="line">    message: UnsafeCell&lt;MaybeUninit&lt;T&gt;&gt;,</span><br><span class="line">    ready: AtomicBool,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Channel&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            message: UnsafeCell::<span class="title function_ invoke__">new</span>(MaybeUninit::<span class="title function_ invoke__">uninit</span>()),</span><br><span class="line">            ready: AtomicBool::<span class="title function_ invoke__">new</span>(<span class="literal">false</span>),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">split</span>&lt;<span class="symbol">&#x27;a</span>&gt;(&amp;<span class="symbol">&#x27;a</span> <span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> (Sender&lt;<span class="symbol">&#x27;a</span>, T&gt;, Receiver&lt;<span class="symbol">&#x27;a</span>, T&gt;) &#123;</span><br><span class="line">        *<span class="keyword">self</span> = <span class="keyword">Self</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">        (Sender &#123; channel: <span class="keyword">self</span> &#125;, Receiver &#123; channel: <span class="keyword">self</span> &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Drop æ²¡å˜</span></span><br></pre></td></tr></table></figure>
<p>åœ¨è¿™ä¸ªç‰ˆæœ¬çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬æ–°å¢äº† <code>split</code> æ–¹æ³•ï¼š</p>
<ol type="1">
<li>å…¶ä¸­å‚æ•° <code>&amp;'a mut self</code> è¡¨æ˜å®ƒæ˜¯ä¸€ä¸ªç‹¬å å¼•ç”¨ï¼Œå³
<code>channel.split()</code> ä¸ä¼šæœ‰å¹¶å‘é—®é¢˜ã€‚</li>
<li>ç¬¬ä¸€è¡Œä»£ç  <code>*self = Self::new()</code> æˆ‘ä»¬å¯¹åŸæœ‰çš„
<code>Channel</code>
è¿›è¡Œé‡ç½®ï¼Œä¿è¯<strong>æ‹†åˆ†ä¹‹å‰é€šé“é‡Œç»å¯¹æ²¡æœ‰æ®‹ç•™æ•°æ®</strong>ï¼Œé¿å…æ—§æ¶ˆæ¯è¢«ä¸‹ä¸€å¯¹
<code>Sender/Receiver</code> è¯¯ä½¿ç”¨ã€‚</li>
<li><code>'a</code> ç›´æ¥æ¥è‡ªäº
<code>&amp;'a mut self</code>ï¼Œä¿è¯ä¸¤ç«¯æŠŠæ‰‹<strong>ç»ä¸ä¼šæ¯”åŸå§‹
<code>Channel</code> æ´»å¾—æ›´ä¹…</strong>ã€‚</li>
</ol>
<p>æ–°çš„æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">one_thread_should_work</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">channel</span> = Channel::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="keyword">let</span> (sender, receiver) = channel.<span class="title function_ invoke__">split</span>();</span><br><span class="line">    sender.<span class="title function_ invoke__">send</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> receiver.<span class="title function_ invoke__">is_ready</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">msg</span> = receiver.<span class="title function_ invoke__">receive</span>();</span><br><span class="line">        <span class="built_in">assert_eq!</span>(msg, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">cross_thread_should_work</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">channel</span> = Channel::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="keyword">let</span> (sender, receiver) = channel.<span class="title function_ invoke__">split</span>();</span><br><span class="line">    thread::<span class="title function_ invoke__">scope</span>(|s| &#123;</span><br><span class="line">        s.<span class="title function_ invoke__">spawn</span>(|| &#123;</span><br><span class="line">            <span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">100</span>));</span><br><span class="line">            sender.<span class="title function_ invoke__">send</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> !receiver.<span class="title function_ invoke__">is_ready</span>() &#123;&#125;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(receiver.<span class="title function_ invoke__">receive</span>(), <span class="number">1</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å®‰å…¨é˜»å¡ç‰ˆ-v7å»æ‰-is_ready-å®Œå…¨é¿å…ä½¿ç”¨è€…è¯¯è°ƒç”¨">å®‰å…¨é˜»å¡ç‰ˆ
v7ï¼šå»æ‰ is_ready å®Œå…¨é¿å…ä½¿ç”¨è€…è¯¯è°ƒç”¨</h2>
<p>æˆªæ­¢ç›®å‰çš„å®ç°ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä¾èµ–ä½¿ç”¨è€…åœ¨æ‰§è¡Œ <code>receive</code>
ä¹‹å‰å…ˆæ‰§è¡Œ <code>is_ready</code>
è¿›è¡Œæ•°æ®æ£€æŸ¥ï¼Œè¿˜æ˜¯å­˜åœ¨ä¸€å®šçš„è¯¯æ“ä½œæ€§ã€‚ç°åœ¨æˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªå®Œå…¨é˜»å¡çš„ç‰ˆæœ¬ï¼Œæ¥å®Œå…¨é¿å…è¿™ä¸ªæƒ…å†µã€‚</p>
<p>æˆ‘ä»¬éœ€è¦åšå‡ ä»¶äº‹æƒ…ï¼š</p>
<ol type="1">
<li>å»æ‰ <code>is_ready</code> æ–¹æ³•ï¼›</li>
<li>åœ¨ <code>receive</code> ä¸­ï¼Œæ ¹æ® <code>ready</code>
åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ•°æ®ï¼š
<ol type="1">
<li>å¦‚æœå­˜åœ¨ï¼Œåˆ™ç›´æ¥å–å‡ºæ•°æ®å¹¶è¿”å›ï¼›</li>
<li>å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™éœ€è¦å…ˆæŒ‚èµ·å½“å‰çº¿ç¨‹ï¼Œç­‰å¾…å”¤é†’ï¼ˆç›´æ¥ CPU
å¾ªç¯æ£€æŸ¥è‚¯å®šå¯ä»¥ï¼Œä½†ä¸å¤Ÿä¼˜é›…ï¼å’±ä¸å¹²ï¼ï¼‰ï¼›</li>
</ol></li>
<li>åœ¨ <code>send</code>
ä¸­ï¼Œæ”¾å…¥æ•°æ®åï¼Œå°è¯•å”¤é†’å¯èƒ½å¤„äºæŒ‚èµ·ä¸­çš„çº¿ç¨‹ã€‚</li>
</ol>
<p>é‚£ç°åœ¨æœ€é‡è¦çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼š<strong>å¦‚ä½•å”¤é†’å¤„äºæŒ‚èµ·ä¸­çš„çº¿ç¨‹ï¼Ÿ</strong>æ›´è¿›ä¸€æ­¥ï¼Œ<strong>å”¤é†’å“ªä¸ªçº¿ç¨‹ï¼Ÿ</strong></p>
<p>è¿™é‡Œå…¶å®æ˜¯è¯´ä¸å®šçš„ï¼Œå› ä¸º <code>Sender</code> å’Œ <code>Receiver</code>
éƒ½å¯èƒ½è¢«æ”¾å…¥ä»»ä½•ä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œä¸è¿‡åœ¨ <a
target="_blank" rel="noopener" href="https://marabos.nl/atomics/building-channels.html">Rust Atomics
and Locks</a> ä¹¦ä¸­ï¼Œä½œè€…å‡å®šäº† <code>Receiver</code> ä¼šå›ºå®šåœ¨è°ƒç”¨
<code>split</code> çš„é‚£ä¸ªçº¿ç¨‹ã€‚</p>
<p>ç¬”è€…è®¤ä¸ºè¿™ä¸ªå‡è®¾æ˜¯ç®€å•ä¸”æœ‰æ•ˆçš„ï¼Œå›é¡¾ä¸€ä¸‹æˆ‘ä»¬å‰é¢ä¸¾çš„ Go è¯­è¨€çš„ 2
ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">demo1</span><span class="params">()</span></span> &#123;</span><br><span class="line">	done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;) <span class="comment">// ç±»ä¼¼äº split</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="comment">// ... do something</span></span><br><span class="line">		<span class="built_in">close</span>(done)</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	&lt;-done  <span class="comment">// receiver</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">demo2</span><span class="params">()</span></span> &#123;</span><br><span class="line">	oneShot := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>, <span class="number">1</span>)  <span class="comment">// ç±»ä¼¼äº split</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		oneShot &lt;- generateText()</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	text := &lt;-oneShot  <span class="comment">// receiver</span></span><br><span class="line">	doSthWithText(text)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨è¿™ä¸¤ä¸ªæœ€å¸¸è§çš„ <code>oneshot channel</code>
çš„ä¾‹å­ä¸­ï¼Œ<code>Receiver</code> å°±æ˜¯å¤„äºè°ƒç”¨ <code>split</code>
çš„çº¿ç¨‹ä¸­ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åŸºäºè¿™ä¸ªå‡è®¾æ¥å®ç°è¿™ä¸ªç‰ˆæœ¬ã€‚</p>
<p>å…ˆå›é¡¾ä¸‹ <code>Thread</code> 2 ä¸ªæœ€æ ¸å¿ƒçš„æ–¹æ³•ï¼š</p>
<ul>
<li><code>Thread.park(thread)</code>: æŒ‚èµ·çº¿ç¨‹ï¼Œç­‰å¾…å”¤é†’ã€‚</li>
<li><code>thread.unpark()</code>: å”¤é†’çº¿ç¨‹ã€‚</li>
</ul>
<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦åœ¨ <code>Sender</code> ä¸­ä¿å­˜å¾…å”¤é†’çš„çº¿ç¨‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Sender</span>&lt;<span class="symbol">&#x27;a</span>, T&gt; &#123;</span><br><span class="line">    channel: &amp;<span class="symbol">&#x27;a</span> Channel&lt;T&gt;,</span><br><span class="line">    receiving_thread: Thread,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>split()</code> çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦è·å–å½“å‰çº¿ç¨‹å¹¶ä¿å­˜åœ¨
<code>Sender</code> ä¸­ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">split</span>&lt;<span class="symbol">&#x27;a</span>&gt;(&amp;<span class="symbol">&#x27;a</span> <span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> (Sender&lt;<span class="symbol">&#x27;a</span>, T&gt;, Receiver&lt;<span class="symbol">&#x27;a</span>, T&gt;) &#123;</span><br><span class="line">    *<span class="keyword">self</span> = <span class="keyword">Self</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    (</span><br><span class="line">        Sender &#123;</span><br><span class="line">            channel: <span class="keyword">self</span>,</span><br><span class="line">          	<span class="comment">// è·å–å½“å‰çº¿ç¨‹ã€‚è®°ä½ï¼è¿™é‡Œæˆ‘ä»¬å‡è®¾äº† receiver ä¼šå›ºå®šåœ¨ split çš„çº¿ç¨‹ä¸­ï¼</span></span><br><span class="line">            receiving_thread: thread::<span class="title function_ invoke__">current</span>(),</span><br><span class="line">        &#125;,</span><br><span class="line">        Receiver &#123; channel: <span class="keyword">self</span> &#125;,</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>recevie</code>
çš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŒ‚èµ·å½“å‰çº¿ç¨‹ï¼Œç­‰å¾…å”¤é†’ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; Receiver&lt;<span class="symbol">&#x27;_</span>, T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">receive</span>(<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> T &#123;</span><br><span class="line">        <span class="keyword">while</span> !<span class="keyword">self</span>.channel.ready.<span class="title function_ invoke__">swap</span>(<span class="literal">false</span>, Ordering::Acquire) &#123;</span><br><span class="line">            thread::<span class="title function_ invoke__">park</span>(); <span class="comment">// æŒ‚èµ·å½“å‰çº¿ç¨‹ï¼Œå³ thread::current() çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; (*<span class="keyword">self</span>.channel.message.<span class="title function_ invoke__">get</span>()).<span class="title function_ invoke__">assume_init_read</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>send</code> å®Œæ•°æ®åï¼Œå”¤é†’å¯èƒ½æŒ‚èµ·çš„çº¿ç¨‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; Sender&lt;<span class="symbol">&#x27;_</span>, T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">send</span>(<span class="keyword">self</span>, messgae: T) &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; (*<span class="keyword">self</span>.channel.message.<span class="title function_ invoke__">get</span>()).<span class="title function_ invoke__">write</span>(messgae) &#125;;</span><br><span class="line">        <span class="keyword">self</span>.channel.ready.<span class="title function_ invoke__">store</span>(<span class="literal">true</span>, Ordering::Release);</span><br><span class="line">        Thread::<span class="title function_ invoke__">unpark</span>(&amp;<span class="keyword">self</span>.receiving_thread); <span class="comment">// å”¤é†’ receiver çº¿ç¨‹</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€ååˆ é™¤ä¹‹å‰çš„ <code>is_ready</code>
æ–¹æ³•ï¼Œç„¶åæ›´æ–°æˆ‘ä»¬çš„æµ‹è¯•ä»£ç ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">one_thread_should_work</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">channel</span> = Channel::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="keyword">let</span> (sender, receiver) = channel.<span class="title function_ invoke__">split</span>();</span><br><span class="line">    sender.<span class="title function_ invoke__">send</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">msg</span> = receiver.<span class="title function_ invoke__">receive</span>();</span><br><span class="line">    <span class="built_in">assert_eq!</span>(msg, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">cross_thread_should_work</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">channel</span> = Channel::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="keyword">let</span> (sender, receiver) = channel.<span class="title function_ invoke__">split</span>();</span><br><span class="line">    thread::<span class="title function_ invoke__">scope</span>(|s| &#123;</span><br><span class="line">        s.<span class="title function_ invoke__">spawn</span>(|| &#123;</span><br><span class="line">            <span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">100</span>));</span><br><span class="line">            sender.<span class="title function_ invoke__">send</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(receiver.<span class="title function_ invoke__">receive</span>(), <span class="number">1</span>); <span class="comment">// ä¸å†éœ€è¦æ£€æŸ¥ is_readyï¼Œè¿™é‡Œä¼šé˜»å¡ä¸€ç›´ç›´åˆ°æœ‰æ•°æ®åˆ°æ¥</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2
id="æœ€ç»ˆç‰ˆ-v8ä½¿ç”¨-phantomdata-æ¥ä¿è¯-receiver-å¤„äº-split-çº¿ç¨‹">æœ€ç»ˆç‰ˆ
v8ï¼šä½¿ç”¨ PhantomData æ¥ä¿è¯ Receiver å¤„äº split() çº¿ç¨‹</h2>
<p>æ˜¯ä¸æ˜¯è§‰å¾—ï¼Œä¸Šè¿°å®ç°å·²ç»å®Œç¾æ— ç‘•äº†ï¼å…¶å®ä¸ç„¶ï¼Œæˆ‘ä»¬è™½ç„¶å‡è®¾äº†
<code>Receiver</code> å¤„äºè°ƒç”¨ <code>split()</code>
çš„çº¿ç¨‹ä¸­ï¼Œä½†æ˜¯è¿˜æ˜¯æ— æ³•é˜»æ­¢ä½¿ç”¨è€…å°† <code>Receiver</code>
è½¬ç§»åˆ°å…¶ä»–çº¿ç¨‹ã€‚</p>
<p>å†æ¬¡å›é¡¾ä¸‹æˆ‘ä»¬ç°åœ¨çš„ <code>Channel</code> å’Œ
<code>Receiver</code>ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Receiver</span>&lt;<span class="symbol">&#x27;a</span>, T&gt; &#123;</span><br><span class="line">    channel: &amp;<span class="symbol">&#x27;a</span> Channel&lt;T&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Channel</span>&lt;T&gt; &#123;</span><br><span class="line">    message: UnsafeCell&lt;MaybeUninit&lt;T&gt;&gt;,</span><br><span class="line">    ready: AtomicBool,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Sync</span> <span class="keyword">for</span> <span class="title class_">Channel</span>&lt;T&gt; <span class="keyword">where</span> T: <span class="built_in">Send</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä¸º <code>Channel&lt;T&gt;</code> å®ç°äº† <code>Sync</code>
traitï¼Œè€Œæ ‡å‡†åº“ä¸­æœ‰è¿™ 2 è¡Œä»£ç ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T: ?<span class="built_in">Sized</span> + <span class="built_in">Sync</span>&gt; <span class="built_in">Sync</span> <span class="keyword">for</span> &amp;T &#123;&#125;</span><br><span class="line"><span class="keyword">impl</span>&lt;T: ?<span class="built_in">Sized</span> + <span class="built_in">Sync</span>&gt; <span class="built_in">Send</span> <span class="keyword">for</span> &amp;T &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥ <code>&amp;Channel&lt;T&gt;</code> å®ç°äº† <code>Sync/Send</code>
traitï¼Œè€Œ <code>Receiver</code> åªæŒæœ‰äº†ä¸€ä¸ª
<code>&amp;'a Channel&lt;T&gt;</code>ï¼Œæ‰€ä»¥å®ƒä¹Ÿæ˜¯ <code>Send</code>
çš„ï¼</p>
<p>æ‰€ä»¥ <code>Receiver</code>
æ˜¯å¯ä»¥è¢«è½¬ç§»åˆ°å…¶ä»–çº¿ç¨‹çš„ï¼Œå³ä¸‹è¿°çš„æµ‹è¯•ä»£ç åœ¨ç¼–è¯‘ä¸Šä¹Ÿæ˜¯é€šè¿‡çš„ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">cross_thread_should_work</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">channel</span> = Channel::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="keyword">let</span> (sender, receiver) = channel.<span class="title function_ invoke__">split</span>(); <span class="comment">// æ‰§è¡Œ split() çš„çº¿ç¨‹</span></span><br><span class="line">    thread::<span class="title function_ invoke__">scope</span>(|s| &#123;</span><br><span class="line">        s.<span class="title function_ invoke__">spawn</span>(|| &#123;</span><br><span class="line">            <span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">100</span>));</span><br><span class="line">            sender.<span class="title function_ invoke__">send</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">      	<span class="comment">// è¿™é‡Œåœ¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œæ‰§è¡Œäº† `receiver.receive()`</span></span><br><span class="line">        s.<span class="title function_ invoke__">spawn</span>(|| &#123;</span><br><span class="line">            <span class="built_in">assert_eq!</span>(receiver.<span class="title function_ invoke__">receive</span>(), <span class="number">1</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯æˆ‘ä»¬æ‰§è¡Œåä¼šå‘ç°ï¼Œ<code>receiver.receive()</code>
ä¼šè¢«æ°¸ä¹…é˜»å¡ä½ï¼Œè¿™æ˜¯å› ä¸º <code>sender.send(1)</code> åªä¼šå”¤é†’æ‰§è¡Œ
<code>split()</code> çš„çº¿ç¨‹ã€‚</p>
<p>ä¸ºäº†é¿å…è¿™ç§æƒ…å†µçš„å‘ç”Ÿï¼Œæˆ‘ä»¬éœ€è¦å¼ºè¡Œé˜²æ­¢ <code>Receiver</code> å®ç°
<code>Send</code> traitï¼</p>
<p>æ€ä¹ˆåŠå‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦åšåˆ° 2 ä»¶äº‹æƒ…ï¼š</p>
<ol type="1">
<li>è®© <code>Receiver</code> æŒæœ‰ä¸€ä¸ªé <code>Sync</code> çš„å±æ€§ï¼›</li>
<li>è¿™ä¸ªå±æ€§é™¤äº†æ ‡è®°æ²¡æœ‰å…¶ä»–ä½œç”¨ï¼Œæœ€å¥½ä¸è¦å ç”¨ä»»ä½•çš„èµ„æºã€‚</li>
</ol>
<p>è¿™é‡Œæˆ‘ä»¬ä»‹ç»ä¸€ä½æ–°æœ‹å‹ï¼š<code>PhantomData</code>ï¼š</p>
<blockquote>
<p><code>PhantomData</code> æ˜¯ä¸€ä¸ªé›¶å¤§å°ç±»å‹ï¼ˆZero-Sized Type,
ZSTï¼‰ï¼Œç”¨äºåœ¨ç¼–è¯‘æœŸå‘ç±»å‹ç³»ç»Ÿä¼ é€’é¢å¤–ä¿¡æ¯ï¼Œè€Œä¸å ç”¨è¿è¡Œæ—¶å†…å­˜ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ç”¨å®ƒåœ¨åŒ…ä¸€ä¸ª <code>!Send</code> çš„ç±»å‹ï¼Œè¿™æ ·
<code>Receiver</code> å°±æ˜¯ <code>!Send</code> çš„äº†ã€‚å…³äº
<code>PhantomData</code> çš„æ›´å¤šä»‹ç»ï¼Œå¯ä»¥å‚è€ƒ<u>é™„å½•
2ï¼šPhantomData</u>ã€‚</p>
</blockquote>
<p>åœ¨ä»‹ç»å®Œ <code>PhantomData</code> åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨å®ƒæ¥é˜²æ­¢
<code>Receiver</code> å®ç° <code>Send</code> trait äº†ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Receiver</span>&lt;<span class="symbol">&#x27;a</span>, T&gt; &#123;</span><br><span class="line">    channel: &amp;<span class="symbol">&#x27;a</span> Channel&lt;T&gt;,</span><br><span class="line">    _no_send: PhantomData&lt;*<span class="title function_ invoke__">const</span> ()&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ <code>*const()</code> æ˜¯ <code>!Send</code> çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„
<code>Receiver</code> å†ä¹Ÿä¸ä¼šè¢«è½¬ç§»åˆ°å…¶ä»–çº¿ç¨‹äº†ï¼Œè€Œ <code>send</code>
æ˜¯è¦æ±‚ <code>self</code>ï¼Œæ‰€ä»¥å³ä¾¿æ˜¯ <code>Sync</code>
çš„ä¹Ÿæ— æ‰€è°“äº†ï¼Œå› ä¸ºæ— æ³•é€šè¿‡å¼•ç”¨æ¥æ‰§è¡Œ <code>receive()</code> æ–¹æ³•ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å†æ¬¡æ‰§è¡Œä¸Šé¢çš„æµ‹è¯•ä»£ç ï¼ˆå¼ºè¡Œå°† Receiver
ç§»åŠ¨åˆ°å…¶ä»–çº¿ç¨‹ä¸­ï¼‰ï¼Œå°†ä¼šå¾—åˆ°ä»¥ä¸‹çš„æŠ¥é”™ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">error[E0277]: `*const ()` cannot be sent between threads safely</span><br><span class="line"><span class="meta prompt_">   --&gt; </span><span class="language-bash">src/oneshotchannel.rs:103:21</span></span><br><span class="line">    |</span><br><span class="line">103 |               s.spawn(|| &#123;</span><br><span class="line">    |                 ----- ^-</span><br><span class="line">    |                 |     |</span><br><span class="line">    |  _______________|_____within this `&#123;closure@oneshotchannel.rs:103:21&#125;`</span><br><span class="line">    | |               |</span><br><span class="line">    | |               required by a bound introduced by this call</span><br><span class="line">104 | |                 assert_eq!(receiver.receive(), 1);</span><br><span class="line">105 | |             &#125;);</span><br><span class="line">    | |_____________^ `*const ()` cannot be sent between threads safely</span><br></pre></td></tr></table></figure>
<p>åˆ°è¿™é‡Œï¼Œé€šè¿‡ 8
ä¸ªç‰ˆæœ¬ï¼Œæˆ‘ä»¬ä¸€æ­¥æ­¥å®ç°äº†ä¸€ä¸ªé«˜æ€§èƒ½ã€ä½å†…å­˜å ç”¨ä¸”å®‰å…¨å¯ç”¨çš„
<code>oneshot channel</code> äº†ï¼</p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>è‡³æ­¤ï¼Œé€šè¿‡ 8 ä¸ªå°ç‰ˆæœ¬ï¼Œæˆ‘ä»¬ä¸ä»…æ‰‹å†™äº†ä¸€ä¸ª <strong>é«˜æ€§èƒ½ã€å®‰å…¨å‹å¥½çš„
oneshot channel</strong>ï¼Œè¿˜æ›´è¿›ä¸€æ­¥ä½“éªŒäº† Rust åœ¨å¹¶å‘é¢†åŸŸ
<strong>â€œä»¥ç±»å‹ç³»ç»Ÿé©±åŠ¨æ­£ç¡®æ€§â€</strong>
çš„å¨åŠ›ã€‚æˆ‘ä»¬æ¥åšä¸€ä¸ªç®€å•çš„å°ç»“ã€‚</p>
<p>å…³é”®æ”¶è·ï¼š</p>
<table>
<colgroup>
<col style="width: 8%" />
<col style="width: 52%" />
<col style="width: 39%" />
</colgroup>
<thead>
<tr>
<th>ç‰ˆæœ¬</th>
<th>æ–°å¢èƒ½åŠ›</th>
<th>è§£å†³äº†ä»€ä¹ˆé—®é¢˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>v0</strong></td>
<td><code>Mutex</code> + <code>Condvar</code> é€šç”¨é€šé“</td>
<td>æ‰“å¼€è¯é¢˜ã€å¯¹æ¯”åç»­æ— é”æ–¹æ¡ˆ</td>
</tr>
<tr>
<td><strong>v1</strong></td>
<td><code>UnsafeCell&lt;Option&lt;T&gt;&gt;</code> +
<code>AtomicBool</code></td>
<td>å»é”åŒ–ã€æœ€å°å¯è¡Œä¸€æ¬¡æ€§é€šé“</td>
</tr>
<tr>
<td><strong>v2</strong></td>
<td>æ›¿æ¢ä¸º <code>MaybeUninit&lt;T&gt;</code></td>
<td>èŠ‚çœå†…å­˜&amp;é¿å…åŒçŠ¶æ€æ£€æŸ¥</td>
</tr>
<tr>
<td><strong>v3</strong></td>
<td>è¿è¡Œæ—¶æ£€æŸ¥ (<code>swap</code>)</td>
<td>é˜»æ­¢æœªå‡†å¤‡/äºŒæ¬¡è°ƒç”¨å¯¼è‡´ UB</td>
</tr>
<tr>
<td><strong>v4</strong></td>
<td><code>Drop</code> æ¸…ç†</td>
<td>é˜²æ­¢â€œåª send ä¸ recvâ€æ³„æ¼</td>
</tr>
<tr>
<td><strong>v5</strong></td>
<td><code>Sender</code> / <code>Receiver</code> æ‰€æœ‰æƒ API</td>
<td>ç¼–è¯‘æœŸä¿è¯â€œä»…è°ƒç”¨ä¸€æ¬¡â€</td>
</tr>
<tr>
<td><strong>v6</strong></td>
<td>ç”Ÿå‘½å‘¨æœŸå¼•ç”¨æ›¿æ¢ <code>Arc</code></td>
<td>æ¶ˆé™¤å¼•ç”¨è®¡æ•°å¼€é”€</td>
</tr>
<tr>
<td><strong>v7</strong></td>
<td><code>park / unpark</code> é˜»å¡æ¨¡å‹</td>
<td>ä½¿ç”¨è€…ä¸å†éœ€è¦è½®è¯¢ <code>is_ready</code></td>
</tr>
<tr>
<td><strong>v8</strong></td>
<td><code>PhantomData</code> é˜²è·¨çº¿ç¨‹è¯¯ç”¨</td>
<td>ç±»å‹ç³»ç»Ÿå½»åº•å°æ­»é”™è¯¯ç”¨æ³•</td>
</tr>
</tbody>
</table>
<p>æ ¸å¿ƒè®°å¿†ç‚¹ï¼š</p>
<ul>
<li><strong>å†…éƒ¨å¯å˜æ€§</strong>ï¼š<code>UnsafeCell</code>
æ˜¯æ‰€æœ‰å¹¶å‘åŸè¯­çš„åŸºçŸ³ã€‚</li>
<li><strong>å»¶è¿Ÿåˆå§‹åŒ–</strong>ï¼š<code>MaybeUninit&lt;T&gt;</code> +
â€œå°±ç»ªæ ‡å¿—â€ æ˜¯é›¶æˆæœ¬ç»„åˆã€‚</li>
<li><strong>Release / Acquire</strong>ï¼šæœ€è½»é‡çš„è·¨çº¿ç¨‹å¯è§æ€§ä¿éšœã€‚</li>
<li><strong>æ‰€æœ‰æƒè®¾è®¡ API</strong>ï¼šè®©ç¼–è¯‘å™¨æ›¿ä½ å…œåº•é€»è¾‘çº¦æŸã€‚</li>
<li><strong>PhantomData</strong>ï¼šé›¶å¤§å°ä½†èƒ½å½±å“ <code>Send/Sync</code>
çš„ç±»å‹çº§æ ‡è®°ã€‚</li>
<li><strong>è¿­ä»£æ€è·¯</strong>ï¼šå…ˆè·‘é€šï¼Œå†æ”¶å£å®‰å…¨æ€§ä¸æ€§èƒ½ï¼Œæœ€åç”¨ç±»å‹ç³»ç»Ÿâ€œé˜²å‘†â€ã€‚</li>
</ul>
<p>å®Œæ•´çš„ä»£ç å¯ä»¥å‚è€ƒï¼š<a
target="_blank" rel="noopener" href="https://github.com/hedon-rust-road/conutils/blob/main/src/oneshot.rs">conutils-oneshot</a>ã€‚</p>
<h2 id="oneshot-crate-æµ…æ¢">oneshot crate æµ…æ¢</h2>
<h2 id="é™„å½•">é™„å½•</h2>
<h3 id="optiont-çš„å†…å­˜å ç”¨æ˜¯å¤šå°‘">1. Option&lt;T&gt;
çš„å†…å­˜å ç”¨æ˜¯å¤šå°‘ï¼Ÿ</h3>
<p>åœ¨ Rust ä¸­ï¼Œ<code>Option&lt;T&gt;</code>
ç±»å‹å ç”¨çš„å†…å­˜ï¼Œå–å†³äºæ³›å‹å‚æ•° <code>T</code>
çš„ç±»å‹ç‰¹æ€§ã€‚å…·ä½“å¯åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š</p>
<ul>
<li>å½“ T
æ˜¯<strong>éæŒ‡é’ˆç±»å‹</strong>ï¼ˆå¦‚åŸºæœ¬ç±»å‹ã€ç»“æ„ä½“ç­‰ï¼‰æ—¶ï¼Œ<code>Option&lt;T&gt;</code>
éœ€è¦é¢å¤–çš„ç©ºé—´å­˜å‚¨ Some æˆ– None çš„æ ‡ç­¾ï¼Œæ­¤æ—¶ï¼š
<ul>
<li>å†…å­˜å¸ƒå±€ï¼šåŒ…å«ä¸€ä¸ª 1 å­—èŠ‚çš„æ ‡ç­¾ï¼ˆæ ‡è¯† Some æˆ– Noneï¼‰å’Œ
<code>T</code> ç±»å‹çš„æ•°æ®ç©ºé—´ï¼ˆå¯èƒ½åŒ…å«å¯¹é½å¡«å……ï¼‰ã€‚</li>
<li>å³ä½¿ä¸º <code>None</code>ï¼Œä»éœ€ä¿ç•™ <code>T</code>
æ‰€éœ€çš„å†…å­˜ç©ºé—´ï¼ˆå«å¡«å……ï¼‰ï¼Œä»¥ä¿éšœæšä¸¾å€¼å¤§å°ç»Ÿä¸€ã€‚å¦‚
<code>Option&lt;i32&gt;</code> å ç”¨ 8 å­—èŠ‚ï¼ˆ1 å­—èŠ‚æ ‡ç­¾ + 4 å­—èŠ‚ i32 + 3
å­—èŠ‚å¡«å……ï¼‰ã€‚</li>
</ul></li>
<li>å½“ T æ˜¯<strong>ä¸å¯ä¸ºç©ºçš„æŒ‡é’ˆç±»å‹</strong>ï¼ˆå¦‚
Box&lt;T&gt;ã€&amp;Tã€&amp;mut Tï¼‰æ—¶ï¼ŒRust
ç¼–è¯‘å™¨ä¼šå¯ç”¨<strong>ç©ºæŒ‡é’ˆä¼˜åŒ–</strong>ï¼ˆNiche
Optimizationï¼‰ã€‚å³åˆ©ç”¨<strong>æŒ‡é’ˆä¸èƒ½ä¸º 0</strong> çš„ç‰¹æ€§ï¼Œå°†
<code>None</code> æ ‡è¯†ä¸ºå…¨é›¶ä½æ¨¡å¼ï¼ˆ0x00ï¼‰ï¼Œè€Œ <code>Some(ptr)</code>
å­˜å‚¨å®é™…æŒ‡é’ˆåœ°å€ï¼Œæ­¤æ—¶æ— éœ€é¢å¤–æ ‡ç­¾ã€‚è¿™ä¸ªæ—¶å€™ï¼Œ<code>None</code> å’Œ
<code>Some(T)</code> ä¸å ç”¨ä»»ä½•çš„é¢å¤–ç©ºé—´ï¼Œå¤§å°ä¸ T ç›¸åŒã€‚</li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥å†™ä¸ªç¨‹åºæ¥ç®€å•éªŒè¯ä¸€ä¸‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">test_option</span>() &#123;</span><br><span class="line">    <span class="comment">// 1. åŸºæœ¬æ•°æ®ç±»å‹</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">i</span>: <span class="type">i32</span> = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">i_none</span>: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; = <span class="literal">None</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">i_some</span>: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; = <span class="title function_ invoke__">Some</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;åŸºæœ¬ç±»å‹ï¼š&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;i32: &#123;&#125; bytes, ptr: &#123;:p&#125;&quot;</span>, mem::<span class="title function_ invoke__">size_of_val</span>(&amp;i), &amp;i); <span class="comment">// 4 bytes</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;None&lt;i32&gt;: &#123;&#125; bytes, ptr: &#123;:p&#125;&quot;</span>, mem::<span class="title function_ invoke__">size_of_val</span>(&amp;i_none), &amp;i_none); <span class="comment">// 8 bytes</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Some&lt;i32&gt;: &#123;&#125; bytes, ptr: &#123;:p&#125;&quot;</span>, mem::<span class="title function_ invoke__">size_of_val</span>(&amp;i_some), &amp;i_some); <span class="comment">// 8 bytes</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. è‡ªå®šä¹‰ç±»å‹</span></span><br><span class="line">    <span class="meta">#[repr(C)]</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Data</span> &#123;</span><br><span class="line">        a: <span class="type">u64</span>,</span><br><span class="line">        b: <span class="type">u32</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">data</span> = Data &#123; a: <span class="number">1</span>, b: <span class="number">1</span> &#125;;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">data_none</span>: <span class="type">Option</span>&lt;Data&gt; = <span class="literal">None</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">data_some</span>: <span class="type">Option</span>&lt;Data&gt; = <span class="title function_ invoke__">Some</span>(Data &#123; a: <span class="number">1</span>, b: <span class="number">1</span> &#125;);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;\nè‡ªå®šä¹‰ç»“æ„ä½“ï¼š&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Data: &#123;&#125; bytes, ptr: &#123;:p&#125;&quot;</span>, mem::<span class="title function_ invoke__">size_of_val</span>(&amp;data), &amp;data); <span class="comment">// 16 bytes</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;None&lt;Data&gt;: &#123;&#125; bytes, ptr: &#123;:p&#125;&quot;</span>, mem::<span class="title function_ invoke__">size_of_val</span>(&amp;data_none), &amp;data_none); <span class="comment">// 24 bytes</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Some&lt;Data&gt;: &#123;&#125; bytes, ptr: &#123;:p&#125;&quot;</span>, mem::<span class="title function_ invoke__">size_of_val</span>(&amp;data_some), &amp;data_some); <span class="comment">// 24 bytes</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. æŒ‡é’ˆç±»å‹</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b</span> = <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b_none</span>: <span class="type">Option</span>&lt;<span class="type">Box</span>&lt;<span class="type">i32</span>&gt;&gt; = <span class="literal">None</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b_some</span>: <span class="type">Option</span>&lt;<span class="type">Box</span>&lt;<span class="type">i32</span>&gt;&gt; = <span class="title function_ invoke__">Some</span>(<span class="type">Box</span>::<span class="title function_ invoke__">new</span>(<span class="number">1</span>));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;\næŒ‡é’ˆç±»å‹ï¼š&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Box&lt;i32&gt;: &#123;&#125; bytes, ptr: &#123;:p&#125;&quot;</span>, mem::<span class="title function_ invoke__">size_of_val</span>(&amp;b), &amp;b); <span class="comment">// 8 bytes</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;None&lt;Box&lt;i32&gt;&gt;: &#123;&#125; bytes, ptr: &#123;:p&#125;&quot;</span>, mem::<span class="title function_ invoke__">size_of_val</span>(&amp;b_none), &amp;b_none); <span class="comment">// 8 bytes</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Some&lt;Box&lt;i32&gt;&gt;: &#123;&#125; bytes, ptr: &#123;:p&#125;&quot;</span>, mem::<span class="title function_ invoke__">size_of_val</span>(&amp;b_some), &amp;b_some); <span class="comment">// 8 bytes</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">none_value</span> = <span class="keyword">unsafe</span> &#123; *(&amp;b_none <span class="keyword">as</span> *<span class="keyword">const</span> _ <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">i64</span>) &#125;;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;None&lt;Box&lt;i32&gt;&gt; bit pattern: &#123;:#x&#125;&quot;</span>, none_value); <span class="comment">// 0x0</span></span><br><span class="line">  	<span class="keyword">let</span> <span class="variable">some_value</span> = <span class="keyword">unsafe</span> &#123; *(&amp;b_some <span class="keyword">as</span> *<span class="keyword">const</span> _ <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">i64</span>) &#125;;</span><br><span class="line">		<span class="built_in">println!</span>(<span class="string">&quot;None&lt;Box&lt;i32&gt;&gt; bit pattern: &#123;:#x&#125;&quot;</span>, some_value); <span class="comment">// 0x15d0043c0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ç¬”è€…çš„ç”µè„‘ä¸‹ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">åŸºæœ¬ç±»å‹ï¼š</span><br><span class="line">i32: 4 bytes, ptr: 0x16bef203c</span><br><span class="line">None&lt;i32&gt;: 8 bytes, ptr: 0x16bef2040</span><br><span class="line">Some&lt;i32&gt;: 8 bytes, ptr: 0x16bef2048</span><br><span class="line"></span><br><span class="line">è‡ªå®šä¹‰ç»“æ„ä½“ï¼š</span><br><span class="line">Data: 16 bytes, ptr: 0x16bef2200</span><br><span class="line">None&lt;Data&gt;: 24 bytes, ptr: 0x16bef2210</span><br><span class="line">Some&lt;Data&gt;: 24 bytes, ptr: 0x16bef2228</span><br><span class="line"></span><br><span class="line">æŒ‡é’ˆç±»å‹ï¼š</span><br><span class="line">Box&lt;i32&gt;: 8 bytes, ptr: 0x16bef23f8</span><br><span class="line">None&lt;Box&lt;i32&gt;&gt;: 8 bytes, ptr: 0x16bef2400</span><br><span class="line">Some&lt;Box&lt;i32&gt;&gt;: 8 bytes, ptr: 0x16bef2408</span><br><span class="line">None&lt;Box&lt;i32&gt;&gt; bit pattern: 0x0</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡è¾“å‡ºæˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ°ç»è¿‡<strong>ç©ºæŒ‡é’ˆä¼˜åŒ–</strong>ï¼Œ<code>Option&lt;Box&lt;i32&gt;&gt;</code>
çš„ <code>None</code> å’Œ <code>Some</code> éƒ½åªå  <strong>8
å­—èŠ‚</strong>ï¼ˆä¸ <code>Box&lt;i32&gt;</code> ç›¸åŒï¼‰ï¼ŒåŒæ—¶é€šè¿‡ä¸º
<code>None</code> å¤ç”¨ç±»å‹çš„æ— æ•ˆä½æ¨¡å¼ï¼ˆå¦‚
<code>0x0</code>ï¼‰æ¶ˆé™¤æšä¸¾æ ‡ç­¾ï¼Œå®ç°é›¶æˆæœ¬æŠ½è±¡ã€‚</p>
<h3 id="phantomdata">2. PhantomData</h3>
<p>Rust ä¸­çš„ <code>PhantomData</code> æ˜¯ä¸€ä¸ªé›¶å¤§å°ç±»å‹ï¼ˆZero-Sized Type,
ZSTï¼‰ï¼Œç”¨äºåœ¨ç¼–è¯‘æœŸå‘ç±»å‹ç³»ç»Ÿä¼ é€’é¢å¤–ä¿¡æ¯ï¼Œè€Œä¸å ç”¨è¿è¡Œæ—¶å†…å­˜ã€‚å®ƒåœ¨æ³›å‹ç¼–ç¨‹ã€ç”Ÿå‘½å‘¨æœŸç®¡ç†å’Œæ‰€æœ‰æƒæ ‡è®°ä¸­æ‰®æ¼”å…³é”®è§’è‰²ã€‚</p>
<p>å®ƒæœ‰ä»¥ä¸‹çš„æ ¸å¿ƒç‰¹æ€§å’Œä½œç”¨ï¼š</p>
<ol type="1">
<li><p><strong>é›¶å†…å­˜å¼€é”€</strong>ï¼š<code>PhantomData&lt;T&gt;</code>
æœ¬èº«ä¸å­˜å‚¨ä»»ä½•æ•°æ®ï¼Œç¼–è¯‘åä¼šè¢«ä¼˜åŒ–æ‰ï¼Œå› æ­¤<strong>ä¸ä¼šå¢åŠ ç»“æ„ä½“çš„å®é™…å†…å­˜å ç”¨</strong>ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::marker::PhantomData;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Wrapper</span>&lt;T&gt; &#123;</span><br><span class="line">    data: <span class="type">u32</span>,</span><br><span class="line">    _marker: PhantomData&lt;T&gt;, <span class="comment">// ä¸å ç©ºé—´</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>æ ‡è®°æœªä½¿ç”¨çš„æ³›å‹å‚æ•°</strong>ï¼šRust
è¦æ±‚æ³›å‹å‚æ•°å¿…é¡»åœ¨ç»“æ„ä½“ä¸­è¢«æ˜¾å¼ä½¿ç”¨ã€‚è‹¥æ³›å‹å‚æ•°æœªç›´æ¥å‡ºç°åœ¨å­—æ®µä¸­ï¼Œå¯é€šè¿‡
<code>PhantomData</code> æ ‡è®°å…¶å­˜åœ¨æ€§ï¼Œé¿å…ç¼–è¯‘é”™è¯¯ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Resource</span>&lt;T&gt; &#123;</span><br><span class="line">    handle: *<span class="title function_ invoke__">mut</span> (),</span><br><span class="line">    _phantom: PhantomData&lt;T&gt;, <span class="comment">// æ ‡è®°ç±»å‹ T</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>å£°æ˜ç”Ÿå‘½å‘¨æœŸä¾èµ–</strong>ï¼šå½“ç»“æ„ä½“åŒ…å«åŸå§‹æŒ‡é’ˆï¼ˆå¦‚
<code>*const T</code>ï¼‰æ—¶ï¼Œ<code>PhantomData</code>
å¯ç»‘å®šç”Ÿå‘½å‘¨æœŸï¼Œç¡®ä¿å¼•ç”¨çš„æ•°æ®æœ‰æ•ˆæ€§ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Slice</span>&lt;<span class="symbol">&#x27;a</span>, T&gt; &#123;</span><br><span class="line">    start: *<span class="keyword">const</span> T,</span><br><span class="line">    end: *<span class="keyword">const</span> T,</span><br><span class="line">    _phantom: PhantomData&lt;&amp;<span class="symbol">&#x27;a</span> T&gt;, <span class="comment">// ç»‘å®šç”Ÿå‘½å‘¨æœŸ &#x27;a</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>åå˜ä¸é€†å˜æ§åˆ¶</strong>ï¼šé€šè¿‡
<code>PhantomData&lt;&amp;'a T&gt;</code> æˆ–
<code>PhantomData&lt;*mut T&gt;</code>
ç­‰ä¸åŒå½¢å¼ï¼Œè°ƒæ•´ç±»å‹çš„åå˜/é€†å˜è¡Œä¸ºã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::marker::PhantomData;</span><br><span class="line"><span class="keyword">use</span> std::rc::Rc;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ‡è®°ç±»å‹ä¸º !Send ä¸” !Sync</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">NotThreadSafe</span> &#123;</span><br><span class="line">    _marker: PhantomData&lt;Rc&lt;()&gt;&gt;, <span class="comment">// Rc&lt;()&gt; æœ¬èº«æ˜¯ !Send + !Sync</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>

<div class="article-footer fs14">
    <section id="references">
      <div class="header"><span>å‚è€ƒèµ„æ–™</span></div>
      <div class="body">
        <ul>
        <li class="post-title">
          <p><a target="_blank" rel="noopener" href="https://marabos.nl/atomics/">Rust Atomics and Locks</a></p>

        </li>
        
        <li class="post-title">
          <p><a target="_blank" rel="noopener" href="https://doc.rust-lang.org/book/">Rust Programming
Language</a></p>

        </li>
        
        <li class="post-title">
          <p><a href="https://hedon.top/2024/11/11/rust-memory-order/">Rust
åŸç†ä¸¨èŠä¸€èŠ Rust çš„ Atomic å’Œå†…å­˜é¡ºåº</a></p>

        </li>
        
        <li class="post-title">
          <p><a href="https://hedon.top/2025/05/13/rust-action-spinlock/">Rust
å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª SpinLock</a></p>

        </li>
        </ul>
      </div>
    </section>
    
    <section id="license">
      <div class="header"><span>è®¸å¯åè®®</span></div>
      <div class="body"><p>æœ¬æ–‡é‡‡ç”¨ <a
target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº«
4.0 å›½é™…</a> è®¸å¯åè®®ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>
</div>
    </section>
    
    <section id="share">
      <div class="header"><span>åˆ†äº«æ–‡ç« </span></div>
      <div class="body">
        <div class="link"><input class="copy-area" readonly="true" id="copy-link" value="https://hedon.top/2025/05/29/rust-action-oneshot-channel/" /></div>
        <div class="social-wrap dis-select"><a class="social share-item wechat" onclick="util.toggle(&quot;qrcode-wechat&quot;)"><img class="lazy"  src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/b32ef3da1162a.svg" /></a><a class="social share-item weibo" target="_blank" rel="external nofollow noopener noreferrer" href="https://service.weibo.com/share/share.php?url=https://hedon.top/2025/05/29/rust-action-oneshot-channel/&title=Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª oneshot channel - HedonWang&pics=/banner/rust-action-oneshot-channel.jpg&summary=æœ¬æ–‡ä»é›¶å¼€å§‹ï¼Œé€šè¿‡å¤šç‰ˆæœ¬è¿­ä»£ï¼Œå®ç°ä¸€ä¸ªå®‰å…¨çš„ Rust oneshot channelã€‚æˆ‘ä»¬å°†æ·±å…¥ `AtomicBool`ã€`UnsafeCell`ã€`MaybeUninit` çš„ä½¿ç”¨ï¼Œé€šè¿‡ `Drop` ç®¡ç†å†…å­˜ï¼Œå¹¶æœ€ç»ˆä»¥ `Se..."><img class="lazy"  src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/80c07e4dbb303.svg" /></a><a class="social share-item email" href="mailto:?subject=Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª oneshot channel - HedonWang&amp;body=https://hedon.top/2025/05/29/rust-action-oneshot-channel/"><img class="lazy"  src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/a1b00e20f425d.svg" /></a><a class="social share-item link" onclick="util.copy(&quot;copy-link&quot;, &quot;å¤åˆ¶æˆåŠŸ&quot;)"><img class="lazy"  src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/8411ed322ced6.svg" /></a></div>
        
        <div class="qrcode" id="qrcode-wechat" style="opacity:0;height:0">
          <img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=https://hedon.top/2025/05/29/rust-action-oneshot-channel/"/>
        </div>
        
      </div>
    </section>
    </div>
</article>
<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">è¾ƒæ–°æ–‡ç« </div><a href="/2025/06/03/rust-action-arc/">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª Arc</a></div><div class="item" id="next"><div class="note">è¾ƒæ—©æ–‡ç« </div><a href="/2025/05/13/rust-action-spinlock/">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª SpinLock</a></div></section></div>




  <div class="related-wrap md-text" id="comments">
    <section class='header cmt-title cap theme'>
      <p>å¿«æ¥å‚ä¸è®¨è®ºå§~</p>

    </section>
    <section class='body cmt-body giscus'>
      

<svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg>

<div id="giscus" src="https://giscus.app/client.js" data-repo="hedon954/hedonspace" data-repo-id="R_kgDOKt17sQ" data-category="Q&A" data-category-id="DIC_kwDOKt17sc4CbAt-" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous"></div>

    </section>
  </div>



<footer class="page-footer footnote"><hr><div class="text"><p>æœ¬ç«™ç”± <a href="/">Hedon Wang</a> ä½¿ç”¨ <a
target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.29.1">Stellar
1.29.1</a> ä¸»é¢˜åˆ›å»ºã€‚ æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a
target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA
4.0</a> è®¸å¯åè®®ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper toc" id="data-toc" collapse="false"><div class="widget-header dis-select"><span class="name">æœ¬æ–‡ç›®å½•</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BB%E5%AE%8C%E6%9C%AC%E7%AF%87%E4%BD%A0%E8%83%BD%E5%AD%A6%E5%88%B0%E4%BB%80%E4%B9%88"><span class="toc-text">è¯»å®Œæœ¬ç¯‡ä½ èƒ½å­¦åˆ°ä»€ä¹ˆ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%83%AD%E8%BA%AB%E7%89%88-v0%E5%9F%BA%E4%BA%8E%E9%94%81%E7%9A%84%E9%80%9A%E9%81%93"><span class="toc-text">çƒ­èº«ç‰ˆ v0ï¼šåŸºäºé”çš„é€šé“</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%89%88-v1unsafe-%E6%8F%90%E9%86%92%E4%BD%BF%E7%94%A8%E8%80%85"><span class="toc-text">åŸºç¡€ç‰ˆ v1ï¼šunsafe æé†’ä½¿ç”¨è€…</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%89%88-v2%E4%BD%BF%E7%94%A8-maybeuninit-%E6%9B%BF%E4%BB%A3-option-%E5%87%8F%E5%B0%91%E5%86%85%E5%AD%98%E5%BC%80%E9%94%80"><span class="toc-text">åŸºç¡€ç‰ˆ
v2ï¼šä½¿ç”¨ MaybeUninit æ›¿ä»£ Option å‡å°‘å†…å­˜å¼€é”€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%89%88-v3%E5%A2%9E%E5%8A%A0%E5%8A%A8%E6%80%81%E6%A3%80%E6%9F%A5%E6%8F%90%E9%AB%98%E5%AE%89%E5%85%A8%E6%80%A7"><span class="toc-text">åŸºç¡€ç‰ˆ
v3ï¼šå¢åŠ åŠ¨æ€æ£€æŸ¥æé«˜å®‰å…¨æ€§</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%89%88-v4%E5%AE%9E%E7%8E%B0-drop-%E8%87%AA%E5%8A%A8%E6%B8%85%E7%90%86%E6%97%A0%E7%94%A8%E5%86%85%E5%AD%98"><span class="toc-text">åŸºç¡€ç‰ˆ v4ï¼šå®ç° Drop
è‡ªåŠ¨æ¸…ç†æ— ç”¨å†…å­˜</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E9%9D%9E%E9%98%BB%E5%A1%9E%E7%89%88-v5%E6%8F%90%E4%BE%9B%E5%AE%89%E5%85%A8%E6%96%B9%E6%B3%95%E5%87%8F%E5%B0%91%E4%BD%BF%E7%94%A8%E8%80%85%E8%AF%AF%E7%94%A8"><span class="toc-text">å®‰å…¨éé˜»å¡ç‰ˆ
v5ï¼šæä¾›å®‰å…¨æ–¹æ³•ï¼Œå‡å°‘ä½¿ç”¨è€…è¯¯ç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E9%9D%9E%E9%98%BB%E5%A1%9E%E7%89%88-v6%E4%BD%BF%E7%94%A8%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%8A%A0%E5%BC%95%E7%94%A8%E9%81%BF%E5%85%8D-arc-%E7%9A%84%E5%A4%8D%E5%88%B6%E5%BC%80%E9%94%80"><span class="toc-text">å®‰å…¨éé˜»å¡ç‰ˆ
v6ï¼šä½¿ç”¨ç”Ÿå‘½å‘¨æœŸåŠ å¼•ç”¨ï¼Œé¿å… Arc çš„å¤åˆ¶å¼€é”€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E9%98%BB%E5%A1%9E%E7%89%88-v7%E5%8E%BB%E6%8E%89-is_ready-%E5%AE%8C%E5%85%A8%E9%81%BF%E5%85%8D%E4%BD%BF%E7%94%A8%E8%80%85%E8%AF%AF%E8%B0%83%E7%94%A8"><span class="toc-text">å®‰å…¨é˜»å¡ç‰ˆ
v7ï¼šå»æ‰ is_ready å®Œå…¨é¿å…ä½¿ç”¨è€…è¯¯è°ƒç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E7%89%88-v8%E4%BD%BF%E7%94%A8-phantomdata-%E6%9D%A5%E4%BF%9D%E8%AF%81-receiver-%E5%A4%84%E4%BA%8E-split-%E7%BA%BF%E7%A8%8B"><span class="toc-text">æœ€ç»ˆç‰ˆ
v8ï¼šä½¿ç”¨ PhantomData æ¥ä¿è¯ Receiver å¤„äº split() çº¿ç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">æ€»ç»“</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#oneshot-crate-%E6%B5%85%E6%8E%A2"><span class="toc-text">oneshot crate æµ…æ¢</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%E5%BD%95"><span class="toc-text">é™„å½•</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#optiont-%E7%9A%84%E5%86%85%E5%AD%98%E5%8D%A0%E7%94%A8%E6%98%AF%E5%A4%9A%E5%B0%91"><span class="toc-text">1. Option&lt;T&gt;
çš„å†…å­˜å ç”¨æ˜¯å¤šå°‘ï¼Ÿ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#phantomdata"><span class="toc-text">2. PhantomData</span></a></li></ol></li></ol></div><div class="widget-footer">

<a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 12c0-4.714 0-7.071 1.464-8.536C4.93 2 7.286 2 12 2c4.714 0 7.071 0 8.535 1.464C22 4.93 22 7.286 22 12c0 4.714 0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12Z"/><path stroke-linecap="round" stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/></g></svg><span>å›åˆ°é¡¶éƒ¨</span></a><a class="buttom" onclick="util.scrollComment()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M10.46 1.25h3.08c1.603 0 2.86 0 3.864.095c1.023.098 1.861.3 2.6.752a5.75 5.75 0 0 1 1.899 1.899c.452.738.654 1.577.752 2.6c.095 1.004.095 2.261.095 3.865v1.067c0 1.141 0 2.036-.05 2.759c-.05.735-.153 1.347-.388 1.913a5.75 5.75 0 0 1-3.112 3.112c-.805.334-1.721.408-2.977.43a10.81 10.81 0 0 0-.929.036c-.198.022-.275.054-.32.08c-.047.028-.112.078-.224.232c-.121.166-.258.396-.476.764l-.542.916c-.773 1.307-2.69 1.307-3.464 0l-.542-.916a10.605 10.605 0 0 0-.476-.764c-.112-.154-.177-.204-.224-.232c-.045-.026-.122-.058-.32-.08c-.212-.023-.49-.03-.93-.037c-1.255-.021-2.171-.095-2.976-.429A5.75 5.75 0 0 1 1.688 16.2c-.235-.566-.338-1.178-.389-1.913c-.049-.723-.049-1.618-.049-2.76v-1.066c0-1.604 0-2.86.095-3.865c.098-1.023.3-1.862.752-2.6a5.75 5.75 0 0 1 1.899-1.899c.738-.452 1.577-.654 2.6-.752C7.6 1.25 8.857 1.25 10.461 1.25M6.739 2.839c-.914.087-1.495.253-1.959.537A4.25 4.25 0 0 0 3.376 4.78c-.284.464-.45 1.045-.537 1.96c-.088.924-.089 2.11-.089 3.761v1c0 1.175 0 2.019.046 2.685c.045.659.131 1.089.278 1.441a4.25 4.25 0 0 0 2.3 2.3c.515.214 1.173.294 2.429.316h.031c.398.007.747.013 1.037.045c.311.035.616.104.909.274c.29.17.5.395.682.645c.169.232.342.525.538.856l.559.944a.52.52 0 0 0 .882 0l.559-.944c.196-.331.37-.624.538-.856c.182-.25.392-.476.682-.645c.293-.17.598-.24.909-.274c.29-.032.639-.038 1.037-.045h.032c1.255-.022 1.913-.102 2.428-.316a4.25 4.25 0 0 0 2.3-2.3c.147-.352.233-.782.278-1.441c.046-.666.046-1.51.046-2.685v-1c0-1.651 0-2.837-.089-3.762c-.087-.914-.253-1.495-.537-1.959a4.25 4.25 0 0 0-1.403-1.403c-.464-.284-1.045-.45-1.96-.537c-.924-.088-2.11-.089-3.761-.089h-3c-1.651 0-2.837 0-3.762.089" clip-rule="evenodd"/><path fill="currentColor" d="M9 11a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0"/></svg><span>å‚ä¸è®¨è®º</span></a></div></widget>
</div></aside><div class='float-panel blur'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">
<script type="text/javascript">
  const ctx = {
    date_suffix: {
      just: `åˆšåˆš`,
      min: `åˆ†é’Ÿå‰`,
      hour: `å°æ—¶å‰`,
      day: `å¤©å‰`,
    },
    root : `/`,
    tag_plugins: {
      chat: Object.assign({"api":"https://siteinfo.listentothewind.cn/api/v1"}),
    }
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"all","path":"/search.json","content":true,"skip_search":null,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
  };
  const deps = {
    jquery: `https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js`,
    marked: `https://cdn.jsdelivr.net/npm/marked@13.0.1/lib/marked.umd.min.js`
  }
  

</script>

<script type="text/javascript">
  function RunItem() {
    this.list = []; // å­˜æ”¾å›è°ƒå‡½æ•°
    this.start = () => {
      for (var i = 0; i < this.list.length; i++) {
        this.list[i].run();
      }
    };
    this.push = (fn, name, setRequestAnimationFrame = true) => {
      let myfn = fn
      if (setRequestAnimationFrame) {
        myfn = () => {
          utils.requestAnimationFrame(fn)
        }
      }
      var f = new Item(myfn, name);
      this.list.push(f);
    };
    this.remove = (name) => {
      for (let index = 0; index < this.list.length; index++) {
        const e = this.list[index];
        if (e.name == name) {
          this.list.splice(index, 1);
        }
      }
    }
    // æ„é€ ä¸€ä¸ªå¯ä»¥runçš„å¯¹è±¡
    function Item(fn, name) {
      // å‡½æ•°åç§°
      this.name = name || fn.name;
      // runæ–¹æ³•
      this.run = () => {
        try {
          fn()
        } catch (error) {
          console.log(error);
        }
      };
    }
  }

  const utils = {
    // æ‡’åŠ è½½ css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')) {
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // é»˜è®¤å¼‚æ­¥ï¼Œå¦‚æœéœ€è¦åŒæ­¥ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥ {} å³å¯
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function () {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },

    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      let retryTimes = 3;
      utils.onLoading(el);
      function req() {
        return new Promise((resolve, reject) => {
          let status = 0; // 0 ç­‰å¾… 1 å®Œæˆ 2 è¶…æ—¶
          let timer = setTimeout(() => {
            if (status === 0) {
              status = 2;
              timer = null;
              reject('è¯·æ±‚è¶…æ—¶');
              if (retryTimes == 0) {
                onFailure();
              }
            }
          }, 5000);
          fetch(url).then(function (response) {
            if (status !== 2) {
              clearTimeout(timer);
              resolve(response);
              timer = null;
              status = 1;
            }
            if (response.ok) {
              return response.json();
            }
            throw new Error('Network response was not ok.');
          }).then(function (data) {
            retryTimes = 0;
            utils.onLoadSuccess(el);
            callback(data);
          }).catch(function (error) {
            if (retryTimes > 0) {
              retryTimes -= 1;
              setTimeout(() => {
                req();
              }, 5000);
            } else {
              utils.onLoadFailure(el);
              onFailure();
            }
          });
        });
      }
      req();
    },
    /********************** requestAnimationFrame ********************************/
    // 1ã€requestAnimationFrame ä¼šæŠŠæ¯ä¸€å¸§ä¸­çš„æ‰€æœ‰ DOM æ“ä½œé›†ä¸­èµ·æ¥ï¼Œåœ¨ä¸€æ¬¡é‡ç»˜æˆ–å›æµä¸­å°±å®Œæˆï¼Œå¹¶ä¸”é‡ç»˜æˆ–å›æµçš„æ—¶é—´é—´éš”ç´§ç´§è·Ÿéšæµè§ˆå™¨çš„åˆ·æ–°é¢‘ç‡ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œè¿™ä¸ªé¢‘ç‡ä¸ºæ¯ç§’60å¸§ã€‚
    // 2ã€åœ¨éšè—æˆ–ä¸å¯è§çš„å…ƒç´ ä¸­ï¼ŒrequestAnimationFrame å°†ä¸ä¼šè¿›è¡Œé‡ç»˜æˆ–å›æµï¼Œè¿™å½“ç„¶å°±æ„å‘³ç€æ›´å°‘çš„çš„ cpuï¼Œgpu å’Œå†…å­˜ä½¿ç”¨é‡ã€‚
    requestAnimationFrame: (fn) => {
      if (!window.requestAnimationFrame) {
        window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame;
      }
      window.requestAnimationFrame(fn)
    },
    dark: {},
  };

  // utils.dark.mode å½“å‰æ¨¡å¼ dark or light
  // utils.dark.toggle() æš—é»‘æ¨¡å¼è§¦å‘å™¨
  // utils.dark.push(callBack[,"callBackName"]) ä¼ å…¥è§¦å‘å™¨å›è°ƒå‡½æ•°
  utils.dark.method = {
    toggle: new RunItem(),
  };
  utils.dark = Object.assign(utils.dark, {
    push: utils.dark.method.toggle.push,
  });
</script>
<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>
<script type="text/javascript">
  (() => {
    const tagSwitchers = document.querySelectorAll('.tag-subtree.parent-tag > a > .tag-switcher-wrapper')
    for (const tagSwitcher of tagSwitchers) {
      tagSwitcher.addEventListener('click', (e) => {
        const parent = e.target.closest('.tag-subtree.parent-tag')
        parent.classList.toggle('expanded')
        e.preventDefault()
      })
    }

    // Get active tag from query string, then activate it.
    const urlParams = new URLSearchParams(window.location.search)
    const activeTag = urlParams.get('tag')
    if (activeTag) {
      let tag = document.querySelector(`.tag-subtree[data-tag="${activeTag}"]`)
      if (tag) {
        tag.querySelector('a').classList.add('active')
        
        while (tag) {
          tag.classList.add('expanded')
          tag = tag.parentElement.closest('.tag-subtree.parent-tag')
        }
      }
    }
  })()
</script>


<!-- required -->
<script src="/js/main.js?v=1.29.1" defer></script>

<script type="text/javascript">
  const applyTheme = (theme) => {
    if (theme === 'auto') {
      document.documentElement.removeAttribute('data-theme')
    } else {
      document.documentElement.setAttribute('data-theme', theme)
    }

    applyThemeToGiscus(theme)
  }

  const applyThemeToGiscus = (theme) => {
    theme = theme === 'auto' ? 'preferred_color_scheme' : theme

    const cmt = document.getElementById('giscus')
    if (cmt) {
      // This works before giscus load.
      cmt.setAttribute('data-theme', theme)
    }

    const iframe = document.querySelector('#comments > section.giscus > iframe')
    if (iframe) {
      // This works after giscus loaded.
      const src = iframe.src
      const newSrc = src.replace(/theme=[\w]+/, `theme=${theme}`)
      iframe.src = newSrc
    }
  }

  const switchTheme = () => {
    // light -> dark -> auto -> light -> ...
    const currentTheme = document.documentElement.getAttribute('data-theme')
    let newTheme;
    switch (currentTheme) {
      case 'light':
        newTheme = 'dark'
        break
      case 'dark':
        newTheme = 'auto'
        break
      default:
        newTheme = 'light'
    }
    applyTheme(newTheme)
    window.localStorage.setItem('Stellar.theme', newTheme)
    utils.dark.mode = newTheme === 'auto' ? (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light") : newTheme;
    utils.dark.method.toggle.start();

    const messages = {
      light: `åˆ‡æ¢åˆ°æµ…è‰²æ¨¡å¼`,
      dark: `åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼`,
      auto: `åˆ‡æ¢åˆ°è·Ÿéšç³»ç»Ÿé…è‰²`,
    }
    hud?.toast?.(messages[newTheme])
  }

  (() => {
    // Apply user's preferred theme, if any.
    const theme = window.localStorage.getItem('Stellar.theme')
    if (theme !== null) {
      applyTheme(theme)
    } else {
      utils.dark.mode = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
    }
    utils.dark.method.toggle.start();
  })()
</script>


<!-- optional -->

  <script type="module">
  const el = document.querySelector('#comments #giscus');
  util.viewportLazyload(el, load_discus, false);

  function load_discus() {
    if (!el) return;
    try {
        el.innerHTML = '';
      } catch (error) {
        console.error(error);
      }
      const script = document.createElement('script');
      script.async = true;
      for (const key of Object.keys(el.attributes)) {
        const attr = el.attributes[key];
        if (['class', 'id'].includes(attr.name) === false) {
          script.setAttribute(attr.name, attr.value);
        }
      }
      el.appendChild(script);
  }
</script>




<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":"https://site-info-api-hedon.vercel.app/api/v1?url={href}"},"ghinfo":{"js":"/js/services/ghinfo.js"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"},"voice":{"js":"/js/plugins/voice.js"},"video":{"js":"/js/plugins/video.js"},"download-file":{"js":"/js/plugins/download-file.js"},"twikoo":{"js":"/js/services/twikoo_latest_comment.js"},"waline":{"js":"/js/services/waline_latest_comment.js"},"artalk":{"js":"/js/services/artalk_latest_comment.js"},"giscus":{"js":"/js/services/giscus_latest_comment.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else if (id == 'voice') {
        ctx.voiceAudios = document.querySelectorAll('.voice>audio');
        if (ctx.voiceAudios?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            createVoiceDom(ctx.voiceAudios);
          });
        }
      } else if (id == 'video') {
        ctx.videos = document.querySelectorAll('.video>video');
        if (ctx.videos?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            videoEvents(ctx.videos);
          });
        }
      } else if (id == 'download-file') {
        ctx.files = document.querySelectorAll('.file');
        if (ctx.files?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            downloadFileEvent(ctx.files);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }

    // chat iphone time
    let phoneTimes = document.querySelectorAll('.chat .status-bar .time');

    if (phoneTimes.length > 0) {
      NowTime();
      var date = new Date();
      var sec = date.getSeconds();
      var firstAdjustInterval = setInterval(firstAdjustTime, 1000 * (60 - sec));
    }

    function firstAdjustTime() {
      NowTime();
      clearInterval(firstAdjustInterval);
      setInterval(NowTime, 1000 * 60);
    }

    function NowTime() {
      for (let i = 0; i < phoneTimes.length; ++i) {
        var timeSpan = phoneTimes[i];
        var date = new Date();
        var hour = date.getHours();
        var min = date.getMinutes();
        timeSpan.innerHTML = check(hour) + ":" + check(min);
      }
    };

    function check(val) {
      if (val < 10) {
        return ("0" + val);
      }
      return (val);
    }

    // chat quote
    const chat_quote_obverser = new IntersectionObserver((entries, observer) => {
      entries.filter((entry) => { return entry.isIntersecting }).sort((a, b) => a.intersectionRect.y !== b.intersectionRect.y ? a.intersectionRect.y - b.intersectionRect.y : a.intersectionRect.x - b.intersectionRect.x).forEach((entry, index) => {
          observer.unobserve(entry.target);
          setTimeout(() => {
            entry.target.classList.add('quote-blink');
            setTimeout(() => {
              entry.target.classList.remove('quote-blink');
            }, 1000);
          }, Math.max(100, 16) * (index + 1));
        });
    });

    var chatQuotes = document.querySelectorAll(".chat .talk .quote");
    chatQuotes.forEach((quote) => {
      quote.addEventListener('click', function () {
        var chatCellDom = document.getElementById("quote-" + quote.getAttribute("quotedCellTag"));
        if (chatCellDom) {
          var chatDiv = chatCellDom.parentElement;
          var mid = chatDiv.clientHeight / 2;
          var offsetTop = chatCellDom.offsetTop;
          if (offsetTop > mid - chatCellDom.clientHeight / 2) {
            chatDiv.scrollTo({
              top: chatCellDom.offsetTop - mid + chatCellDom.clientHeight / 2,
              behavior: "smooth"
            });
          } else {
            chatDiv.scrollTo({
              top: 0,
              behavior: "smooth"
            });
          }
          chat_quote_obverser.observe(chatCellDom);
        }
      });
    });
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://cdn.jsdelivr.net/npm/flying-pages@2/flying-pages.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@19.1.3/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });
</script><script>
  ctx.fancybox = {
    selector: `.timenode p>img, .md-text img:not([class]), .md-text .image img`,
    css: `https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css`,
    js: `https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js`
  };
  var selector = '[data-fancybox]:not(.error)';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const els = document.getElementsByClassName('ds-memos');
    if (els != undefined && els.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>
<script defer type="text/javascript" src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    var mermaid_config = {
      startOnLoad: true,
      theme:
        "" == "auto" &&
          window.matchMedia("(prefers-color-scheme: dark)").matches
          ? "dark"
          : "neutral",
      logLevel: 3,
      themeVariables: {
        darkMode: true
      },
      flowchart: {
        useMaxWidth: false,
        htmlLabels: true,
        curve: "linear"
      },
      gantt: {
        axisFormat: "%Y/%m/%d"
      },
      sequence: {
        actorMargin: 50
      }
    }
    mermaid.initialize(mermaid_config);
  });
</script><script>
  document.addEventListener('DOMContentLoaded', function () {
    window.codeElements = document.querySelectorAll('.code');
    if (window.codeElements.length > 0) {
      ctx.copycode = {
        default_text: `Copy`,
        success_text: `Copied`,
        toast: `å¤åˆ¶æˆåŠŸ`,
      };
      utils.js('/js/plugins/copycode.js');
    }
  });
</script>


<!-- inject -->

</div></body></html>
