
<!DOCTYPE html><html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.29.1" theme-name="Stellar" theme-version="1.29.1">
  
  <meta name="generator" content="Hexo 6.3.0">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  <link rel="preconnect" href="https://gcore.jsdelivr.net" crossorigin><link rel="preconnect" href="https://unpkg.com" crossorigin><link rel="preconnect" href="https://cdn.bootcdn.net" crossorigin>
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  <meta name="theme-color" content="#f9fafb">
  
  <title>Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª Arc - HedonWang</title>

  
    <meta name="description" content="æœ¬æ–‡æ‰‹æŠŠæ‰‹å¸¦ä½ æ‹†è§£å¹¶é‡æ„ Arcï¼šä»å•çº¿ç¨‹å¼•ç”¨è®¡æ•°ï¼Œåˆ°è·¨çº¿ç¨‹ Weak é˜²ç¯ï¼Œå†åˆ°å‰¥ç¦»å¼º&#x2F;å¼±å¼•ç”¨ä¸å†…å­˜åºä¼˜åŒ–ï¼Œå±‚å±‚æ·±å…¥ Rust å¹¶å‘ä¸å†…å­˜æ¨¡å‹æ ¸å¿ƒã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª Arc">
<meta property="og:url" content="https://hedon.top/2025/06/03/rust-action-arc/index.html">
<meta property="og:site_name" content="HedonWang">
<meta property="og:description" content="æœ¬æ–‡æ‰‹æŠŠæ‰‹å¸¦ä½ æ‹†è§£å¹¶é‡æ„ Arcï¼šä»å•çº¿ç¨‹å¼•ç”¨è®¡æ•°ï¼Œåˆ°è·¨çº¿ç¨‹ Weak é˜²ç¯ï¼Œå†åˆ°å‰¥ç¦»å¼º&#x2F;å¼±å¼•ç”¨ä¸å†…å­˜åºä¼˜åŒ–ï¼Œå±‚å±‚æ·±å…¥ Rust å¹¶å‘ä¸å†…å­˜æ¨¡å‹æ ¸å¿ƒã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-06-03T05:00:00.000Z">
<meta property="article:modified_time" content="2025-07-27T04:29:14.334Z">
<meta property="article:author" content="Hedon Wang">
<meta property="article:tag" content="rust">
<meta property="article:tag" content="å¹¶å‘ç¼–ç¨‹">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <meta name="keywords" content="rust,å¹¶å‘ç¼–ç¨‹">

  <!-- feed -->
  
    <link rel="alternate" href="/atom.xml" title="HedonWang" type="application/atom+xml">
  

  <link rel="stylesheet" href="/css/main.css?v=1.29.1">


  
    <link rel="shortcut icon" href="/assets/favicon.png">
  

  

  <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon.png"><link rel="shortcut icon" href="/assets/favicon.png"><meta name="theme-color" content="#f8f8f8"><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC&display=swap" rel="stylesheet"><link rel="stylesheet" href="/css/markmap.css"><script src="https://cdn.jsdelivr.net/npm/markmap-autoloader@0.18"></script>
</head>
<body>

<div class="l_body s:aa content tech" id="start" layout="post" ><aside class="l_left"><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><div class="icon"><img no-lazy class="icon" src="/assets/favicon.png" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></div><a class="title" href="/"><div class="main" ff="title">HedonWang</div><div class="sub cap">å›å­æ±‚è¯¸å·±ï¼Œå¾‹å·±åˆ™å®‰ã€‚</div></a></div></header>

<div class="nav-area">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" placeholder="ç«™å†…æœç´¢"></form><div id="search-result"></div><div class="search-no-result">æ²¡æœ‰æ‰¾åˆ°å†…å®¹ï¼</div></div>


<nav class="menu dis-select"><a class="nav-item" title="åšå®¢" href="/" style="color:#1BCDFC"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M5.879 2.879C5 3.757 5 5.172 5 8v8c0 2.828 0 4.243.879 5.121C6.757 22 8.172 22 11 22h2c2.828 0 4.243 0 5.121-.879C19 20.243 19 18.828 19 16V8c0-2.828 0-4.243-.879-5.121C17.243 2 15.828 2 13 2h-2c-2.828 0-4.243 0-5.121.879M8.25 17a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75M9 12.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5zM8.25 9A.75.75 0 0 1 9 8.25h6a.75.75 0 0 1 0 1.5H9A.75.75 0 0 1 8.25 9" clip-rule="evenodd"/><path fill="currentColor" d="M5.235 4.058C5 4.941 5 6.177 5 8v8c0 1.823 0 3.058.235 3.942L5 19.924c-.975-.096-1.631-.313-2.121-.803C2 18.243 2 16.828 2 14v-4c0-2.829 0-4.243.879-5.121c.49-.49 1.146-.707 2.121-.803zm13.53 15.884C19 19.058 19 17.822 19 16V8c0-1.823 0-3.059-.235-3.942l.235.018c.975.096 1.631.313 2.121.803C22 5.757 22 7.17 22 9.999v4c0 2.83 0 4.243-.879 5.122c-.49.49-1.146.707-2.121.803z" opacity=".5"/></svg></a><a class="nav-item" title="ä¸“æ " href="/topic/" style="color:#3DC550"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M14.25 4.48v3.057c0 .111 0 .27.02.406a.936.936 0 0 0 .445.683a.96.96 0 0 0 .783.072c.13-.04.272-.108.378-.159L17 8.005l1.124.534c.106.05.248.119.378.16a.958.958 0 0 0 .783-.073a.936.936 0 0 0 .444-.683c.021-.136.021-.295.021-.406V3.031c.113-.005.224-.01.332-.013C21.154 2.98 22 3.86 22 4.933v11.21c0 1.112-.906 2.01-2.015 2.08c-.97.06-2.108.179-2.985.41c-1.082.286-1.99 1.068-3.373 1.436c-.626.167-1.324.257-1.627.323V5.174c.32-.079 1.382-.203 1.674-.371c.184-.107.377-.216.576-.323m5.478 8.338a.75.75 0 0 1-.546.91l-4 1a.75.75 0 0 1-.364-1.456l4-1a.75.75 0 0 1 .91.546" clip-rule="evenodd"/><path fill="currentColor" d="M18.25 3.151c-.62.073-1.23.18-1.75.336a8.2 8.2 0 0 0-.75.27v3.182l.75-.356l.008-.005a1.13 1.13 0 0 1 .492-.13c.047 0 .094.004.138.01c.175.029.315.1.354.12l.009.005l.749.356V3.647z"/><path fill="currentColor" d="M12 5.214c-.334-.064-1.057-.161-1.718-.339C8.938 4.515 8.05 3.765 7 3.487c-.887-.234-2.041-.352-3.018-.412C2.886 3.007 2 3.9 2 4.998v11.146c0 1.11.906 2.01 2.015 2.079c.97.06 2.108.179 2.985.41c.486.129 1.216.431 1.873.726c1.005.451 2.052.797 3.127 1.034z" opacity=".5"/><path fill="currentColor" d="M4.273 12.818a.75.75 0 0 1 .91-.545l4 1a.75.75 0 1 1-.365 1.455l-4-1a.75.75 0 0 1-.545-.91m.909-4.545a.75.75 0 1 0-.364 1.455l4 1a.75.75 0 0 0 .364-1.455z"/></svg></a><a class="nav-item" title="å…³äºæˆ‘" href="/about/" style="color:#F44336"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="m13.629 20.472l-.542.916c-.483.816-1.69.816-2.174 0l-.542-.916c-.42-.71-.63-1.066-.968-1.262c-.338-.197-.763-.204-1.613-.219c-1.256-.021-2.043-.098-2.703-.372a5 5 0 0 1-2.706-2.706C2 14.995 2 13.83 2 11.5v-1c0-3.273 0-4.91.737-6.112a5 5 0 0 1 1.65-1.651C5.59 2 7.228 2 10.5 2h3c3.273 0 4.91 0 6.113.737a5 5 0 0 1 1.65 1.65C22 5.59 22 7.228 22 10.5v1c0 2.33 0 3.495-.38 4.413a5 5 0 0 1-2.707 2.706c-.66.274-1.447.35-2.703.372c-.85.015-1.275.022-1.613.219c-.338.196-.548.551-.968 1.262" opacity=".5"/><path fill="currentColor" d="M10.99 14.308c-1.327-.978-3.49-2.84-3.49-4.593c0-2.677 2.475-3.677 4.5-1.609c2.025-2.068 4.5-1.068 4.5 1.609c0 1.752-2.163 3.615-3.49 4.593c-.454.335-.681.502-1.01.502c-.329 0-.556-.167-1.01-.502"/></svg></a><a class="nav-item" title="æ€ç»´å¯¼å›¾" href="/html/mindmap.html" style="color:#F44336"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="m13.629 20.472l-.542.916c-.483.816-1.69.816-2.174 0l-.542-.916c-.42-.71-.63-1.066-.968-1.262c-.338-.197-.763-.204-1.613-.219c-1.256-.021-2.043-.098-2.703-.372a5 5 0 0 1-2.706-2.706C2 14.995 2 13.83 2 11.5v-1c0-3.273 0-4.91.737-6.112a5 5 0 0 1 1.65-1.651C5.59 2 7.228 2 10.5 2h3c3.273 0 4.91 0 6.113.737a5 5 0 0 1 1.65 1.65C22 5.59 22 7.228 22 10.5v1c0 2.33 0 3.495-.38 4.413a5 5 0 0 1-2.707 2.706c-.66.274-1.447.35-2.703.372c-.85.015-1.275.022-1.613.219c-.338.196-.548.551-.968 1.262" opacity=".5"/><path fill="currentColor" d="M10.99 14.308c-1.327-.978-3.49-2.84-3.49-4.593c0-2.677 2.475-3.677 4.5-1.609c2.025-2.068 4.5-1.068 4.5 1.609c0 1.752-2.163 3.615-3.49 4.593c-.454.335-.681.502-1.01.502c-.329 0-.556-.167-1.01-.502"/></svg></a></nav>
</div>
<div class="widgets">
<widget class="widget-wrapper post-list"><div class="widget-header dis-select"><span class="name">ä¸“æ ï¼šRust å®æˆ˜é›†åˆ</span></div><div class="widget-body"><a class="item" href="/2025/06/11/rust-action-rwlock/"><span class="title">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª RwLock</span></a><a class="item" href="/2025/06/09/rust-action-mutex/"><span class="title">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª Mutex</span></a><a class="item" href="/2025/06/09/rust-action-condvar/"><span class="title">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª Condvar</span></a><a class="item active" href="/2025/06/03/rust-action-arc/"><span class="title">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª Arc</span><svg class="active-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M21 11.098v4.993c0 3.096 0 4.645-.734 5.321c-.35.323-.792.526-1.263.58c-.987.113-2.14-.907-4.445-2.946c-1.02-.901-1.529-1.352-2.118-1.47a2.225 2.225 0 0 0-.88 0c-.59.118-1.099.569-2.118 1.47c-2.305 2.039-3.458 3.059-4.445 2.945a2.238 2.238 0 0 1-1.263-.579C3 20.736 3 19.188 3 16.091v-4.994C3 6.81 3 4.666 4.318 3.333C5.636 2 7.758 2 12 2c4.243 0 6.364 0 7.682 1.332C21 4.665 21 6.81 21 11.098" opacity=".5"/><path fill="currentColor" d="M9 5.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5z"/></svg></a><a class="item" href="/2025/05/29/rust-action-oneshot-channel/"><span class="title">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª oneshot channel</span></a><a class="item" href="/2025/05/13/rust-action-spinlock/"><span class="title">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª SpinLock</span></a><a class="item" href="/2024/06/06/rust-action-sse/"><span class="title">Rust å®æˆ˜ä¸¨SSE(Server-Sent Events)</span></a><a class="item" href="/2024/05/28/rust-action-macro-json/"><span class="title">Rust å®æˆ˜ä¸¨é€šè¿‡å®ç° json! æŒæ¡å£°æ˜å®</span></a><a class="item" href="/2024/04/23/rust-action-inverted-index-concurrency/"><span class="title">Rust å®æˆ˜ä¸¨å¹¶å‘æ„å»ºå€’æ’ç´¢å¼•</span></a><a class="item" href="/2024/04/15/rust-action-inverted-index-demo/"><span class="title">Rust å®æˆ˜ä¸¨å€’æ’ç´¢å¼•</span></a><a class="item" href="/2024/03/06/rust-action-httpie/"><span class="title">Rust å®æˆ˜ä¸¨HTTPie</span></a><a class="item" href="/2024/01/17/rust-action-mandelbrot/"><span class="title">Rust å®æˆ˜ä¸¨ç»˜åˆ¶æ›¼å¾·åšé›†</span></a></div></widget>

<widget class="widget-wrapper post-list"><div class="widget-header dis-select"><span class="name">æœ€è¿‘æ›´æ–°</span></div><div class="widget-body fs14"><a class="item title" href="/2025/11/19/go/go-gc-green-tea-gc/"><span class="title">Go åº•å±‚åŸç†ä¸¨åƒåœ¾å›æ”¶ï¼ˆgreen tea gcï¼‰</span></a><a class="item title" href="/2025/11/17/go/go-gc-tri-color-marking/"><span class="title">Go åº•å±‚åŸç†ä¸¨åƒåœ¾å›æ”¶ï¼ˆä¸‰è‰²æ ‡è®°æ³•ï¼‰</span></a><a class="item title" href="/2025/11/17/go/go-memory-model/"><span class="title">Go åº•å±‚åŸç†ä¸¨å†…å­˜æ¨¡å‹</span></a><a class="item title" href="/2025/11/17/go/go-interface/"><span class="title">Go åº•å±‚åŸç†ä¸¨interface</span></a><a class="item title" href="/2025/11/16/go/go-map-swiss/"><span class="title">Go åº•å±‚åŸç†ä¸¨mapï¼ˆSwiss Table ç‰ˆæœ¬ï¼‰</span></a><a class="item title" href="/2025/11/16/go/go-slice/"><span class="title">Go åº•å±‚åŸç†ä¸¨slice ä»ç¬¬ä¸€æ€§åŸç†åˆ°å®ç°ç»†èŠ‚</span></a><a class="item title" href="/2025/11/16/go/go-map-no-swiss/"><span class="title">Go åº•å±‚åŸç†ä¸¨mapï¼ˆé swiss ç‰ˆæœ¬ï¼‰</span></a><a class="item title" href="/2025/11/14/first-job-review-01-tech-01-manager-complexity/"><span class="title">ä¸‰å¹´å·¥ä½œå¤ç›˜ä¸¨æŠ€æœ¯ç¯‡ï¼šè½¯ä»¶å·¥ç¨‹æ˜¯ä»€ä¹ˆä¸¨ï¼ˆä¸€ï¼‰ç®¡ç†å¤æ‚åº¦</span></a><a class="item title" href="/2025/04/09/note/note-unit-testing/"><span class="title">è¯»ä¹¦ç¬”è®°ä¸¨ã€ŠUnit Testing Principles, Practices, and Patternsã€‹</span></a><a class="item title" href="/2025/07/24/note/note-fosa/"><span class="title">è¯»ä¹¦ç¬”è®°ä¸¨ã€ŠFundamentals of Software Architectureã€‹</span></a></div></widget>
</div>

</div></aside><div class="l_main" id="main">





<div class="article banner top"><img class="bg lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/banner/rust-action-arc.jpg">
  <div class="content">
    <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">ä¸»é¡µ</a>
<span class="sep"></span><a class="cap breadcrumb" id="menu" href="/topic">ä¸“æ </a><span class="sep"></span><a class="cap breadcrumb" id="proj" href="/2025/06/11/rust-action-rwlock/">Rust å®æˆ˜é›†åˆ</a></div>
<div class="flex-row" id="post-meta"><span class="text created">å‘å¸ƒäºï¼š<time datetime="2025-06-03T05:00:00.000Z">2025-06-03</time></span><span class="sep updated"></span><span class="text updated">æ›´æ–°äºï¼š<time datetime="2025-07-27T04:29:14.334Z">2025-07-27</time></span></div></div></div>
    
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª Arc</span></h1>
        
      </div>
    </div>
    
  </div>
  </div><article class="md-text content"><p>ç³»åˆ—æ–‡ç« ï¼š</p>
<ul>
<li><a href="https://hedon.top/2024/11/11/rust-memory-order/">Rust
åŸç†ä¸¨èŠä¸€èŠ Rust çš„ Atomic å’Œå†…å­˜é¡ºåº</a></li>
<li><a
href="https://hedon.top/2025/06/05/rust-atomic-in-processor/">Rust
åŸç†ä¸¨ä»æ±‡ç¼–è§’åº¦çœ‹åŸå­æ“ä½œ</a></li>
<li><a href="https://hedon.top/2025/05/13/rust-action-spinlock/">Rust
å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª SpinLock</a></li>
<li><a
href="https://hedon.top/2025/05/29/rust-action-oneshot-channel/">Rust
å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª oneshot channel</a></li>
<li><a href="https://hedon.top/2025/06/03/rust-action-arc/">Rust
å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª Arc</a> ğŸ‘ˆ æœ¬ç¯‡</li>
<li><a href="https://hedon.top/2025/06/08/rust-os-primitives/">Rust
åŸç†ä¸¨æ“ä½œç³»ç»Ÿå¹¶å‘åŸè¯­</a></li>
<li><a href="https://hedon.top/2025/06/09/rust-action-mutex/">Rust
å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª Mutex</a></li>
<li><a href="https://hedon.top/2025/06/09/rust-action-condvar/">Rust
å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª Condvar</a></li>
<li><a href="https://hedon.top/2025/06/11/rust-action-rwlock/">Rust
å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª RwLock</a></li>
</ul>
<hr />
<p>ç»§ä¸Šç¯‡ <a
href="https://hedon.top/2025/05/29/rust-action-oneshot-channel/">Rust
å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª oneshot channel</a>ï¼Œæœ¬ç¯‡æˆ‘ä»¬ç»§ç»­å‚è€ƒ <a
target="_blank" rel="noopener" href="https://marabos.nl/atomics/">Rust Atomics and Locks</a>
ä¸€ä¹¦ï¼Œæ¥å®ç°ä¸€ä¸ª <code>Arc</code>ã€‚</p>
<p>åœ¨æœ¬ç« å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å‡è®¾ä½ å·²ç»ï¼š</p>
<ol type="1">
<li>ç†Ÿæ‚‰å¹¶ç†è§£ Rust çš„å„ç§åŸå­æ“ä½œã€‚</li>
<li>é˜…è¯»è¿‡ <a
href="https://hedon.top/2024/11/11/rust-memory-order/">Rust åŸç†ä¸¨èŠä¸€èŠ
Rust çš„ Atomic
å’Œå†…å­˜é¡ºåº</a>ï¼Œå¹¶ç†è§£å†…å­˜é¡ºåºå’Œå†…å­˜å±éšœçš„åŸç†å’Œä½¿ç”¨æ–¹æ³•ã€‚</li>
<li>ç†è§£ Rust <code>UnsafeCell&lt;T&gt;</code>
æä¾›çš„å†…éƒ¨å¯å˜æ€§å…è®¸æˆ‘ä»¬åœ¨æŒæœ‰å…±äº«å¼•ç”¨ <code>&amp;</code>
çš„æ—¶å€™å¯ä»¥å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹ã€‚</li>
</ol>
<h2 id="arc-ç®€ä»‹">Arc ç®€ä»‹</h2>
<p><code>Arc</code>ï¼ˆ<em>Atomic Reference Counted</em>ï¼‰æ˜¯ Rust
æ ‡å‡†åº“é‡Œä½äº <code>std::sync</code> æ¨¡å—ä¸­çš„æ™ºèƒ½æŒ‡é’ˆï¼Œç”¨äº
<strong>åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´å®‰å…¨åœ°å…±äº«åªè¯»æ•°æ®</strong>ã€‚å’Œåªé€‚ç”¨äºå•çº¿ç¨‹åœºæ™¯çš„
<code>Rc&lt;T&gt;</code> ä¸åŒï¼Œ<code>Arc&lt;T&gt;</code>
çš„å¼•ç”¨è®¡æ•°å¢å‡æ“ä½œä½¿ç”¨åŸå­æŒ‡ä»¤ï¼Œä»è€Œä¿è¯è·¨çº¿ç¨‹çš„å†…å­˜å®‰å…¨ã€‚</p>
<p><strong>ä¸ºä»€ä¹ˆéœ€è¦ Arcï¼Ÿ</strong></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">p</span> = Person &#123; age: <span class="number">18</span>, name: <span class="string">&quot;hedon&quot;</span>.<span class="title function_ invoke__">to_string</span>(), address: <span class="string">&quot;China&quot;</span>.<span class="title function_ invoke__">to_string</span>() &#125;;</span><br><span class="line"></span><br><span class="line">thread::<span class="title function_ invoke__">scope</span>(|s| &#123;</span><br><span class="line">    s.<span class="title function_ invoke__">spawn</span>(|| <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, &amp;p)); <span class="comment">// âœ… scope å†…çš„çº¿ç¨‹å¯ä»¥å€Ÿç”¨</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, &amp;p)); <span class="comment">// âŒ éœ€è¦ &#x27;static ç”Ÿå‘½å‘¨æœŸ</span></span><br></pre></td></tr></table></figure>
<p><strong>é—®é¢˜</strong>ï¼š<code>thread::spawn</code> è¦æ±‚
<code>'static</code> ç”Ÿå‘½å‘¨æœŸï¼Œä½† <code>&amp;p</code>
åªæ˜¯æ ˆä¸Šå˜é‡çš„å€Ÿç”¨ã€‚<br />
<strong>è§£å†³</strong>ï¼šä½¿ç”¨ <code>Arc::new(p)</code>
æŠŠæ•°æ®ç§»åˆ°å †ä¸Šï¼Œé€šè¿‡åŸå­å¼•ç”¨è®¡æ•°å®ç°å¤šæ‰€æœ‰æƒï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">p</span> = Arc::<span class="title function_ invoke__">new</span>(Person &#123; <span class="comment">/* ... */</span> &#125;);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">p_clone</span> = p.<span class="title function_ invoke__">clone</span>(); <span class="comment">// åŸå­è®¡æ•° +1</span></span><br><span class="line">thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, p_clone)); <span class="comment">// âœ… ç¼–è¯‘é€šè¿‡</span></span><br></pre></td></tr></table></figure>
<h2 id="è¯»å®Œæœ¬ç¯‡ä½ èƒ½å­¦åˆ°ä»€ä¹ˆ">è¯»å®Œæœ¬ç¯‡ä½ èƒ½å­¦åˆ°ä»€ä¹ˆ</h2>
<ul>
<li><strong>åŸå­æ“ä½œçš„å†…å­˜é¡ºåºé€‰æ‹©</strong>ï¼šé€šè¿‡å¼•ç”¨è®¡æ•°è¿™ä¸ªå…·ä½“ä¾‹å­ï¼Œç†è§£
<code>Relaxed / Acquire / Release / fence</code> çš„ä½¿ç”¨åœºæ™¯ã€‚</li>
<li><strong>å¼±å¼•ç”¨è§£å†³å¾ªç¯å¼•ç”¨</strong>ï¼š<code>Weak&lt;T&gt;</code>
çš„è®¾è®¡åŸç†å’Œåœ¨å›¾ç»“æ„ä¸­çš„åº”ç”¨ã€‚</li>
<li><strong>Arc::get_mut
çš„å®‰å…¨æ€§ä¿è¯</strong>ï¼šç†è§£ã€ŒéåŸå­ä¸¤æ­¥æ ¡éªŒã€çš„å·§å¦™è®¾è®¡ã€‚</li>
<li><strong>é›¶æˆæœ¬æŠ½è±¡çš„å®ç°ç»†èŠ‚</strong>ï¼š<code>UnsafeCell</code> +
<code>ManuallyDrop</code> ç›¸æ¯” <code>Option&lt;T&gt;</code>
çš„ä¼˜åŠ¿ã€‚</li>
</ul>
<h2 id="v0-åŸºç¡€å¼•ç”¨è®¡æ•°">v0: åŸºç¡€å¼•ç”¨è®¡æ•°</h2>
<h3 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h3>
<p>æˆ‘ä»¬å…ˆæ¥åˆ†æä¸€ä¸‹åŸºæœ¬çš„æ•°æ®ç»“æ„è¯¥å¦‚ä½•å®šä¹‰ï¼Œåœ¨ä¹‹å‰çš„ <a
href="https://hedon.top/2025/05/13/rust-action-spinlock/">Rust
å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª SpinLock</a>ï¼Œæˆ‘ä»¬è®²åˆ°äº† C++/Rust å¸¸ç”¨çš„å¹¶å‘ç¼–ç¨‹æ–¹å¼
RAIIï¼ˆResource Acquisition Is
Initializationï¼Œèµ„æºè·å–å³åˆå§‹åŒ–ï¼‰ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š<strong>åœ¨å¯¹è±¡æ„é€ å‡½æ•°ä¸­è·å–èµ„æºï¼Œåœ¨ææ„å‡½æ•°ä¸­é‡Šæ”¾èµ„æº</strong>ã€‚ä¸Šé¢çš„æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬åœ¨åˆå§‹åŒ–
<code>Person</code> çš„æ—¶å€™å…¶å®ä¹Ÿæ˜¯åº”ç”¨äº†è¿™ç§æ€è·¯ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">p</span> = Arc::<span class="title function_ invoke__">new</span>(Person &#123;</span><br><span class="line">    age: <span class="number">18</span>,</span><br><span class="line">    name: <span class="string">&quot;hedon&quot;</span>.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">    address: <span class="string">&quot;China&quot;</span>.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥æˆ‘ä»¬çš„è‡ªå®šä¹‰ <code>Arc</code> éœ€è¦æ³›å‹
<code>T</code>ï¼Œä½¿å…¶å¯ä»¥æ‰¿è½½ä¸åŒçš„æ•°æ®ç±»å‹çš„æ•°æ®
<code>data</code>ï¼ŒåŒæ—¶ä¸ºäº†åšå¼•ç”¨è®¡æ•°ï¼Œå®ƒéœ€è¦ä¸€ä¸ªæ•°å€¼ç±»å‹
<code>ref_count</code> æ¥è®¡æ•°ï¼Œä¸ºäº†å¹¶å‘å®‰å…¨ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©åŸå­ç±»å‹
<code>AtomicUsize</code>ã€‚</p>
<p>åœ¨ <code>Arc</code> ä¸­ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±ç®¡ç† <code>data</code>
çš„ç”Ÿå‘½å‘¨æœŸï¼Œé™¤äº†ä½¿ç”¨è£¸æŒ‡é’ˆ <code>*mut T</code> æˆ– <code>*const T</code>
ä¹‹å¤–ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>std::ptr::NonNull&lt;T&gt;</code>
ï¼Œå®ƒæ˜¯ä¸€ä¸ªé›¶æˆæœ¬ã€ä¿è¯éç©ºã€æ”¯æŒåå˜ï¼ˆå¯å®‰å…¨å‘å­ç±»å‹è½¬æ¢ï¼‰çš„è£¸æŒ‡é’ˆåŒ…è£…å™¨ï¼Œå…·ä½“å¯å‚è€ƒ<strong>é™„å½•
1. NonNull&lt;T&gt;</strong>ã€‚</p>
<p>ç»¼ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä»¥ä¸‹æ•°æ®ç»“æ„ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ArcData</span>&lt;T&gt; &#123;</span><br><span class="line">    ref_count: AtomicUsize,</span><br><span class="line">    data: T,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    ptr: NonNull&lt;ArcData&lt;T&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Arc&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(data: T) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        Arc &#123;</span><br><span class="line">            ptr: NonNull::<span class="title function_ invoke__">from</span>(<span class="type">Box</span>::<span class="title function_ invoke__">leak</span>(<span class="type">Box</span>::<span class="title function_ invoke__">new</span>(ArcData &#123;</span><br><span class="line">                ref_count: AtomicUsize::<span class="title function_ invoke__">new</span>(<span class="number">1</span>),</span><br><span class="line">                data,</span><br><span class="line">            &#125;))),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol type="1">
<li>æˆ‘ä»¬å®šä¹‰äº† <code>ArcData</code> å’Œ <code>Arc</code> ä¸¤ä¸ªç»“æ„ï¼Œå…¶ä¸­
<code>ArcData</code> åŒ…å«å¼•ç”¨è®¡æ•° <code>ref_count</code> å’Œå®é™…æ•°æ®
<code>data</code>ã€‚</li>
<li>åœ¨ <code>Arc</code> ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>NonNull</code> æ¥ç®¡ç†
<code>ArcData</code> çš„ç”Ÿå‘½å‘¨æœŸã€‚åˆå§‹åŒ–æ—¶ï¼Œå…ˆç”¨ <code>Box::new()</code>
åœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼Œå†é€šè¿‡ <code>Box::leak()</code> æ”¾å¼ƒ
<code>Box&lt;T&gt;</code> çš„æ‰€æœ‰æƒï¼Œäº¤ç”± <code>Arc</code>
è‡ªè¡Œç®¡ç†ã€‚</li>
</ol>
<pre class="mermaid">graph TB
    subgraph Stack ["æ ˆå†…å­˜ Stack"]
        ArcStruct["Arc&lt;T&gt;<br/>ptr: NonNull&lt;ArcData&lt;T&gt;&gt;"]
    end

    subgraph Heap ["å †å†…å­˜ Heap"]
        ArcDataStruct["ArcData&lt;T&gt;<br/>ref_count: AtomicUsize(1)<br/>data: T"]
    end

    ArcStruct -->|æŒ‡å‘| ArcDataStruct

    subgraph Process ["å†…å­˜åˆ†é…è¿‡ç¨‹"]
        Step1["Box::new(ArcData)"]
        Step2["Box::leak()"]
        Step3["NonNull::from()"]

        Step1 --> Step2
        Step2 --> Step3
    end

    classDef stackStyle fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef heapStyle fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef processStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px

    class ArcStruct stackStyle
    class ArcDataStruct heapStyle
    class Step1,Step2,Step3 processStyle</pre>
<p>å¦å¤–ï¼Œè·¨çº¿ç¨‹å‘é€ <code>Arc&lt;T&gt;</code> ä¼šå¯¼è‡´ <code>T</code>
å¯¹è±¡è¢«å…±äº«ï¼Œå³ <code>T</code> éœ€è¦æ»¡è¶³ <code>Sync</code>
traitï¼Œè€Œè·¨çº¿ç¨‹å‘é€ <code>Arc&lt;T&gt;</code>
ä¹Ÿä¼šå¯¼è‡´éœ€è¦ç”±å¦å¤–ä¸€ä¸ªçº¿ç¨‹æ¥é‡Šæ”¾ <code>T</code>ï¼Œæ‰€ä»¥éœ€è¦ <code>T</code>
æ»¡è¶³ <code>Send</code> traitã€‚æ‰€ä»¥åªæœ‰å½“ <code>T</code> æ»¡è¶³
<code>Send+Sync</code> çš„æ—¶å€™ï¼Œ<code>Arc&lt;T&gt;</code> æ‰æ˜¯
<code>Send</code> çš„ï¼Œå¯¹äº <code>Sync</code> ä¹Ÿæ˜¯åŒç†ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥ä¸º
<code>Arc&lt;T&gt;</code> åˆ†åˆ«å®ç° <code>Sync</code> å’Œ
<code>Send</code> traitï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T: <span class="built_in">Send</span> + <span class="built_in">Sync</span>&gt; <span class="built_in">Send</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;&#125;</span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T: <span class="built_in">Send</span> + <span class="built_in">Sync</span>&gt; <span class="built_in">Sync</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸ºäº†èƒ½å¤Ÿä¾¿æ·çš„è·å– <code>data</code>ï¼Œæˆ‘ä»¬å…ˆä¸º
<code>Arc&lt;T&gt;</code> å®ç°ä¸€ä¸ª <code>data()</code> ç”¨äºè·å–
<code>ArcData&lt;T&gt;</code>ï¼ŒåŒæ—¶ä¸ºå…¶å®ç° <code>Deref</code>
traitï¼Œç”¨äºåƒæŒ‡é’ˆä¸€æ ·æ— æ„Ÿæ“ä½œ <code>data: T</code>ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; Arc&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">data</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;ArcData&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; <span class="keyword">self</span>.ptr.<span class="title function_ invoke__">as_ref</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Deref <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Target</span> = T;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">deref</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="keyword">Self</span>::Target &#123;</span><br><span class="line">        &amp;<span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().data</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç»´æŠ¤å¼•ç”¨è®¡æ•°">ç»´æŠ¤å¼•ç”¨è®¡æ•°</h3>
<p>åŸºç¡€éƒ¨åˆ†æˆ‘ä»¬å·²ç»é“ºå«å®Œäº†ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦æ¥å®ç° 2 ä¸ªæœ€é‡è¦çš„ trait
äº†ï¼š</p>
<ul>
<li><strong>Clone</strong>: <code>Arc</code> å¼•ç”¨è®¡æ•°çš„å…³é”®ï¼Œåœ¨æ¯æ¬¡
<code>clone()</code> çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸æ‹·è´ <code>data</code>ï¼Œè€Œæ˜¯è®©
<code>ref_count</code> è‡ªå¢ï¼Œè¿›è¡Œå¼•ç”¨è®¡æ•°ã€‚</li>
<li><strong>Drop</strong>: åœ¨ <code>Arc&lt;T&gt;</code>
å®ä¾‹ç¦»å¼€ä½œç”¨åŸŸçš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦è®© <code>ref_count</code>
è‡ªå‡ï¼ŒåŒæ—¶åœ¨æœ€åä¸€ä¸ª <code>Arc&lt;T&gt;</code>
è¢«é”€æ¯æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä¸»åŠ¨é‡Šæ”¾ <code>ArcData&lt;T&gt;</code>
çš„å†…å­˜èµ„æºã€‚</li>
</ul>
<p>æˆ‘ä»¬å…ˆæ¥å®ç° <code>Clone</code>ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Clone</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">clone</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">      	<span class="comment">// <span class="doctag">TODO:</span> å¤„ç†æ•´å‹æº¢å‡ºçš„æƒ…å†µ</span></span><br><span class="line">        <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().ref_count.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Ordering::Relaxed)</span><br><span class="line">        Arc &#123; ptr: <span class="keyword">self</span>.ptr &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºè¿™é‡Œæ²¡æœ‰å…¶ä»–åŸå­æ“ä½œéœ€è¦è·Ÿå½“å‰æ“ä½œå»ºç«‹ä¸¥æ ¼çš„
<code>happens-before</code> å…³ç³»ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æœ€æ¾çš„
<code>Relaxed</code> å†…å­˜é¡ºåºã€‚</p>
<p>æ¥ä¸‹æ¥çœ‹ä¸‹ <code>Drop</code>ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> &lt;T&gt; <span class="built_in">Drop</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().ref_count.<span class="title function_ invoke__">fetch_sub</span>(<span class="number">1</span>, ???) == <span class="number">1</span> &#123; <span class="comment">// &lt;----- è¿™é‡Œéœ€è¦ä»€ä¹ˆä½¿ç”¨å†…å­˜é¡ºåºçº¦æŸï¼Ÿ</span></span><br><span class="line">            <span class="keyword">unsafe</span> &#123;</span><br><span class="line">                <span class="title function_ invoke__">drop</span>(<span class="type">Box</span>::<span class="title function_ invoke__">from_raw</span>(<span class="keyword">self</span>.ptr.<span class="title function_ invoke__">as_ptr</span>()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹äº
<code>Drop</code>ï¼Œæˆ‘ä»¬å°±éœ€è¦å¥½å¥½æƒ³ä¸€æƒ³éœ€è¦ä»€ä¹ˆå†…å­˜é¡ºåºçº¦æŸäº†ã€‚åœ¨æœ€åä¸€ä¸ª
<code>drop</code> çš„æ—¶å€™ï¼Œæˆ‘ä»¬æœ‰ 2 ä¸ªç›®æ ‡ï¼š</p>
<ol type="1">
<li><strong>ä¸èƒ½è¿‡æ—©é‡Šæ”¾</strong>ï¼šç¡®ä¿åœ¨å¼•ç”¨è®¡æ•°å‡åˆ° 0
å¹¶é”€æ¯å¯¹è±¡ä¹‹å‰ï¼Œæ²¡æœ‰åˆ«çš„çº¿ç¨‹ä»åœ¨ä½¿ç”¨è¿™ä»½æ•°æ®ï¼›</li>
<li><strong>è¦çœ‹å¾—è§åˆ«äººå†™çš„ä¸œè¥¿</strong>ï¼šå¦‚æœåˆ«çš„çº¿ç¨‹åœ¨å®ƒä»¬å„è‡ªçš„
<code>drop</code>
é‡Œé¢å¯¹å…±äº«å¯¹è±¡åšäº†å†™å…¥ï¼Œæœ€åä¸€ä¸ªçº¿ç¨‹åšææ„æ—¶å¿…é¡»"çœ‹åˆ°"è¿™äº›å†™å…¥ï¼Œå¦åˆ™å°±å¯èƒ½å‡ºç°æ•°æ®ç«äº‰æˆ–æ¬¡åºé”™è¯¯ã€‚</li>
</ol>
<p>æ¢è¨€ä¹‹ï¼Œæˆ‘ä»¬éœ€è¦æœ€åä¸€ä¸ª <code>fetch_sub</code> è·Ÿå‰é¢å…¶ä»–æ¯ä¸€ä¸ª
<code>fetch_sub</code> éƒ½å»ºç«‹èµ· happens before å…³ç³»ï¼Œä¹Ÿå³æˆ‘ä»¬éœ€è¦ä¸€å¯¹
Release å’Œ Acquire æ¥ä¿è¯ happens-beforeã€‚</p>
<p>è¿™é‡Œç®€å•å›é¡¾ä¸€ä¸‹ <code>Release</code> å’Œ
<code>Acquire</code>ï¼Œä¸ç†Ÿæ‚‰çš„è¯»è€…å¯ä»¥å‚é˜…ï¼š<a
href="https://hedon.top/2024/11/11/rust-memory-order/">Rust åŸç†ä¸¨èŠä¸€èŠ
Rust çš„ Atomic å’Œå†…å­˜é¡ºåº</a>ã€‚</p>
<ul>
<li><code>Release</code>:
ä½œç”¨äºå†™æ“ä½œï¼ˆstoreï¼‰ï¼Œç¡®ä¿è¯¥æ“ä½œä¹‹å‰çš„æ‰€æœ‰å†…å­˜è®¿é—®ä¸ä¼šè¢«é‡æ’åˆ°è¿™ä¸ª
Release æ“ä½œä¹‹åã€‚</li>
<li><code>Acquire</code>:
ä½œç”¨äºè¯»æ“ä½œï¼ˆloadï¼‰ï¼Œç¡®ä¿è¯¥æ“ä½œä¹‹åçš„æ‰€æœ‰å†…å­˜è®¿é—®ä¸ä¼šè¢«é‡æ’åˆ°è¿™ä¸ª
Acquire æ“ä½œä¹‹å‰ã€‚</li>
<li>å½“ä¸€ä¸ªçº¿ç¨‹é€šè¿‡ <code>Acquire</code> è¯»å–åˆ°å¦ä¸€ä¸ªçº¿ç¨‹é€šè¿‡
<code>Release</code> å†™å…¥çš„å€¼æ—¶ï¼Œä¼šå»ºç«‹ä¸€ä¸ª happens-before
å…³ç³»ï¼š<strong>çº¿ç¨‹ A ä¸­ Release å†™å…¥ä¹‹å‰çš„æ‰€æœ‰å†…å­˜å†™æ“ä½œï¼Œå¯¹äºçº¿ç¨‹ B ä¸­
Acquire è¯»å–ä¹‹åçš„æ‰€æœ‰å†…å­˜è¯»æ“ä½œéƒ½æ˜¯å¯è§çš„</strong>ã€‚</li>
</ul>
<blockquote>
<p><strong>Release-Sequence
æ¦‚å¿µè¡¥å……</strong>ï¼šå½“å¤šä¸ªçº¿ç¨‹å¯¹åŒä¸€ä¸ªåŸå­å˜é‡æ‰§è¡Œ Release
æ“ä½œæ—¶ï¼Œè¿™äº›æ“ä½œä¼šå½¢æˆä¸€ä¸ª "release-sequence"ã€‚åç»­ä»»ä½•ä¸€ä¸ª Acquire
æ“ä½œè¯»å–åˆ°è¿™ä¸ªåºåˆ—ä¸­çš„ä»»æ„å€¼ï¼Œéƒ½èƒ½ä¸æ•´ä¸ªåºåˆ—å»ºç«‹ happens-before
å…³ç³»ã€‚è¿™æ­£æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬çš„ <code>fence(Acquire)</code>
èƒ½å¤Ÿä¸ä¹‹å‰<strong>æ‰€æœ‰çº¿ç¨‹</strong>çš„ <code>fetch_sub(Release)</code>
å½¢æˆåŒæ­¥çš„å…³é”®ã€‚</p>
</blockquote>
<p>æˆ‘ä»¬å½“ç„¶å¯ä»¥ä½¿ç”¨ <code>Release</code> å’Œ <code>Acquire</code>
çš„ç»“åˆä½“ <code>AcqRel</code>
æ¥ä¸€æ­¥åˆ°ä½è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ä¸è¿‡è€ƒè™‘åˆ°åªæœ‰æœ€åä¸€ä¸ª <code>drop</code>
éœ€è¦æ»¡è¶³è¿™ä¸ªå…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•åšå¾—æ›´ä¼˜é›…ä¸€äº›ã€‚</p>
<p><strong>åœ¨è¿™ç§ä»…éœ€åœ¨ä¸´ç•Œå€¼ä¿è¯ happens-before
çš„åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥å•ç‹¬åœ¨ä¸´ç•Œæƒ…å†µä¸‹ä½¿ç”¨ä¸€ä¸ª <code>fence</code> æ¥å»ºç«‹èµ·
happens-beforeã€‚</strong></p>
<p>å…·ä½“æ¥è¯´ï¼š</p>
<ul>
<li><strong>å¯¹äºéæœ€ç»ˆ <code>drop</code></strong>ï¼šæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨
<code>Release</code>ï¼Œå³
<code>fetch_sub(1, Ordering::Release)</code>ï¼Œå®ƒä¿è¯äº†åˆ«çš„çº¿ç¨‹å¦‚æœæœ€ç»ˆåš"æœ€åä¸€æ¬¡
drop"ï¼Œåªè¦å®ƒå¯¹ç›¸åŒåŸå­æ‰§è¡Œä¸€æ¡ <em>Acquire</em>
æ“ä½œï¼Œå®ƒå°±èƒ½åŒæ­¥åˆ°å‰é¢æ‰€æœ‰çº¿ç¨‹å¯¹æ•°æ®åšè¿‡çš„æ”¹åŠ¨ã€‚</li>
<li><strong>å¯¹äºæœ€ç»ˆ <code>drop</code></strong>ï¼šåœ¨è°ƒç”¨
<code>fetch_sub</code> çš„æ—¶å€™æˆ‘ä»¬ä»éœ€è¦ <code>Release</code>
è¯­ä¹‰ï¼Œä½†æ˜¯è°ƒç”¨æ—¶ï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“è‡ªå·±æ˜¯ä¸æ˜¯"æœ€åé‚£ä¸ªçº¿ç¨‹"ã€‚å½“
<code>fetch_sub</code> è¿”å› <code>1</code>
çš„æ—¶å€™ï¼Œè¯´æ˜æˆ‘ä»¬æ˜¯"æœ€åé‚£ä¸ªçº¿ç¨‹"ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å»ºç«‹ä¸€ä¸ª
<code>fetch(Acquire)</code>ï¼Œä¸ä¹‹å‰çš„æ‰€æœ‰ <code>Release</code>
å½¢æˆé…å¯¹ï¼Œç¡®ä¿çœ‹åˆ°<strong>ä¹‹å‰æ‰€æœ‰çš„å†å²å†™å…¥</strong>ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬æ‰èƒ½ç¡®å®šå·²ç»æ²¡æœ‰åˆ«çš„çº¿ç¨‹åœ¨ä½¿ç”¨æ•°æ®äº†ï¼Œæˆ‘ä»¬æ‰å¯ä»¥å®‰å…¨åœ°é”€æ¯å¯¹è±¡ã€‚</li>
</ul>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼›</p>
<pre class="mermaid">sequenceDiagram
    participant A as Thread A
    participant B as Thread B
    participant C as Thread C<br/>(æœ€å drop)

    %% æ™®é€šå†™å…¥
    A->>A: write shared data â€¦
    B->>B: write shared data â€¦

    %% éæœ€ç»ˆ dropï¼šRelease å†™
    A->>A: fetch_sub (Release)  â¬… è®¡æ•° nâ†’n-1
    B->>B: fetch_sub (Release)  â¬… è®¡æ•° n-1â†’n-2

    %% å½¢æˆ release-sequence
    Note over A,B: è¿™ä¸¤æ¬¡ Release å†™ç»„æˆ<br/>åŒä¸€æ¡ release-sequence

    %% æœ€ç»ˆ dropï¼šRelease å†™ & è¿”å› 1
    C->>C: fetch_sub (Release)  â¬… è¿”å› 1 â†’ è®¡æ•° 0

    %% Acquire fence åŒæ­¥
    C-->>C: fence (Acquire)<br/>ã€æ¥æ”¶ release-sequenceã€‘

    %% å®‰å…¨ææ„
    C->>C: drop(Box::from_raw)

    %% ç»“æœè¯´æ˜
    Note over C: fence (Acquire) ä½¿ A/B<br/>å¯¹å…±äº«æ•°æ®çš„å†™å¿…å®š<br/>åœ¨ææ„å‰å¯è§</pre>
<p>ç»è¿‡è¿™ä¹ˆä¸€é¡¿åˆ†æåï¼Œæˆ‘ä»¬æœ€ç»ˆçš„ <code>Drop</code> å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Drop</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="comment">// â¶ æ‰€æœ‰ `drop` éƒ½æ‰§è¡Œï¼šRelease</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().ref_count.<span class="title function_ invoke__">fetch_sub</span>(<span class="number">1</span>, Ordering::Release) == <span class="number">1</span> &#123;</span><br><span class="line">            <span class="comment">// â· åªæœ‰æœ€åä¸€ä¸ªå¼•ç”¨æ‰ä¼šè¿›æ¥</span></span><br><span class="line">            std::sync::atomic::<span class="title function_ invoke__">fence</span>(Ordering::Acquire); <span class="comment">// â¸ è¡¥ä¸Š Acquire</span></span><br><span class="line">            <span class="keyword">unsafe</span> &#123;</span><br><span class="line">                <span class="comment">// â¹ ç°åœ¨å¯ä»¥å®‰å…¨åœ°å›æ”¶å¹¶ææ„</span></span><br><span class="line">                <span class="title function_ invoke__">drop</span>(<span class="type">Box</span>::<span class="title function_ invoke__">from_raw</span>(<span class="keyword">self</span>.ptr.<span class="title function_ invoke__">as_ptr</span>()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ç°é€»è¾‘ï¼š</p>
<ol type="1">
<li><strong>æ‰€æœ‰ drop</strong> éƒ½ç”¨ <code>Release</code>
è¯­ä¹‰å‡å¼•ç”¨è®¡æ•°ï¼Œä¸ºå¯èƒ½çš„"æœ€åä¸€æ¬¡ drop"åšå‡†å¤‡</li>
<li><strong>åªæœ‰æœ€åä¸€æ¬¡ drop</strong>ï¼ˆè¿”å›å€¼ä¸º 1ï¼‰æ‰éœ€è¦é¢å¤–çš„
<code>fence(Acquire)</code> ä¸ä¹‹å‰æ‰€æœ‰çš„ Release å»ºç«‹
happens-before</li>
<li><strong>å®‰å…¨ææ„</strong>ï¼šç°åœ¨å¯ä»¥ç¡®ä¿çœ‹åˆ°æ‰€æœ‰å†å²å†™å…¥ï¼Œæ²¡äººå†æŒæœ‰å¼•ç”¨</li>
</ol>
<h3 id="å®Œæ•´ä»£ç ">å®Œæ•´ä»£ç </h3>
<p>è‡ªæ­¤ï¼Œæˆ‘ä»¬ç¬¬ä¸€ä¸ªç‰ˆæœ¬çš„ <code>Arc</code>
å°±å®ç°å®Œæ¯•äº†ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æœ€ç»ˆå®Œæˆçš„ä»£ç ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::atomic::&#123;AtomicUsize, Ordering, fence&#125;;</span><br><span class="line"><span class="keyword">use</span> std::ptr::NonNull;</span><br><span class="line"><span class="keyword">use</span> std::ops::Deref;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ArcData</span>&lt;T&gt; &#123;</span><br><span class="line">    ref_count: AtomicUsize,</span><br><span class="line">    data: T,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    ptr: NonNull&lt;ArcData&lt;T&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Arc&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(data: T) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        Arc &#123;</span><br><span class="line">            ptr: NonNull::<span class="title function_ invoke__">from</span>(<span class="type">Box</span>::<span class="title function_ invoke__">leak</span>(<span class="type">Box</span>::<span class="title function_ invoke__">new</span>(ArcData &#123;</span><br><span class="line">                ref_count: AtomicUsize::<span class="title function_ invoke__">new</span>(<span class="number">1</span>),</span><br><span class="line">                data,</span><br><span class="line">            &#125;))),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">data</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;ArcData&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; <span class="keyword">self</span>.ptr.<span class="title function_ invoke__">as_ref</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T: <span class="built_in">Send</span> + <span class="built_in">Sync</span>&gt; <span class="built_in">Send</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;&#125;</span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T: <span class="built_in">Send</span> + <span class="built_in">Sync</span>&gt; <span class="built_in">Sync</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Deref <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Target</span> = T;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">deref</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="keyword">Self</span>::Target &#123;</span><br><span class="line">        &amp;<span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().data</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Clone</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">clone</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().ref_count.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Ordering::Relaxed);</span><br><span class="line">        Arc &#123; ptr: <span class="keyword">self</span>.ptr &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Drop</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().ref_count.<span class="title function_ invoke__">fetch_sub</span>(<span class="number">1</span>, Ordering::Release) == <span class="number">1</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">fence</span>(Ordering::Acquire);</span><br><span class="line">            <span class="keyword">unsafe</span> &#123;</span><br><span class="line">                <span class="title function_ invoke__">drop</span>(<span class="type">Box</span>::<span class="title function_ invoke__">from_raw</span>(<span class="keyword">self</span>.ptr.<span class="title function_ invoke__">as_ptr</span>()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å•å…ƒæµ‹è¯•">å•å…ƒæµ‹è¯•</h3>
<p>å†™ä¸ªå•å…ƒæµ‹è¯•éªŒè¯ä¸€ä¸‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">arc_should_work</span>() &#123;</span><br><span class="line">    <span class="keyword">static</span> NUM_DROPS: AtomicUsize = AtomicUsize::<span class="title function_ invoke__">new</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">DetectDrop</span>;</span><br><span class="line">    <span class="keyword">impl</span> <span class="title class_">Drop</span> <span class="keyword">for</span> <span class="title class_">DetectDrop</span> &#123;</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">            NUM_DROPS.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Ordering::Relaxed);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»º 2 ä¸ª Arc å…±äº«ä¸€ä¸ªå…ƒç»„ï¼ŒåŒ…å«ä¸€ä¸ªå­—ç¬¦ä¸²å’Œ DetectDrop å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = Arc::<span class="title function_ invoke__">new</span>((<span class="string">&quot;hedon&quot;</span>, DetectDrop));</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">y</span> = x.<span class="title function_ invoke__">clone</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°† x è½¬ç§»åˆ°å¦å¤–ä¸€ä¸ªçº¿ç¨‹å¹¶ä½¿ç”¨å®ƒ</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">t</span> = thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(x.<span class="number">0</span>, <span class="string">&quot;hedon&quot;</span>); <span class="comment">// å¯ä»¥æ­£å¸¸ä½¿ç”¨</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™é‡Œï¼Œy åº”è¯¥ä¹Ÿæ˜¯å¯ä»¥æ­£å¸¸ä½¿ç”¨çš„</span></span><br><span class="line">    <span class="built_in">assert_eq!</span>(y.<span class="number">0</span>, <span class="string">&quot;hedon&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾… t çº¿ç¨‹æ‰§è¡Œå®Œæ¯•</span></span><br><span class="line">    t.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™ä¸ªæ—¶å€™ `x` å·²ç»è¢«é‡Šæ”¾äº†ï¼Œä½†æ˜¯`y` è¿˜æ²¡æœ‰è¢«é‡Šæ”¾ï¼Œ</span></span><br><span class="line">    <span class="comment">// æ‰€ä»¥ `DetectDrop` åº”è¯¥è¿˜æ²¡è¢«é‡Šæ”¾ã€‚</span></span><br><span class="line">    <span class="built_in">assert_eq!</span>(NUM_DROPS.<span class="title function_ invoke__">load</span>(Ordering::Relaxed), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰‹åŠ¨é‡Šæ”¾æ‰ `y`ï¼Œè¿™æ˜¯æœ€åä¸€ä¸ª `Arc`ï¼Œæ‰€ä»¥ `DetectDrop` åº”è¯¥ä¼šè¢«é‡Šæ”¾</span></span><br><span class="line">    <span class="title function_ invoke__">drop</span>(y);</span><br><span class="line">    <span class="built_in">assert_eq!</span>(NUM_DROPS.<span class="title function_ invoke__">load</span>(Ordering::Relaxed), <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœæ˜¯ ok çš„ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">running 1 test</span><br><span class="line">test arc::tests::arc_should_work ... ok</span><br><span class="line"></span><br><span class="line">successes:</span><br><span class="line"></span><br><span class="line">successes:</span><br><span class="line">    arc::tests::arc_should_work</span><br><span class="line"></span><br><span class="line">test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s</span><br></pre></td></tr></table></figure>
<h2 id="v1-å®ç°-get_mut-è·å–å¯å˜å¼•ç”¨">v1: å®ç° get_mut è·å–å¯å˜å¼•ç”¨</h2>
<p>æŒ‰ç…§å‰é¢ç‰ˆæœ¬çš„å®ç°ï¼Œæˆ‘ä»¬æ˜¯ä¸èƒ½ä¸º <code>Arc&lt;T&gt;</code> å®ç°
<code>DerefMut</code> trait çš„ï¼Œå› ä¸ºæˆ‘ä»¬ä¸èƒ½æ— æ¡ä»¶åœ°æä¾›
<code>&amp;mut T</code> å¯å˜å¼•ç”¨ï¼Œå› ä¸ºå®ƒå¯èƒ½åŒæ—¶è¢«å…¶ä»–çš„
<code>Arc&lt;T&gt;</code> æ‰€è®¿é—®ä¸­ã€‚</p>
<p>ä¸è¿‡ï¼Œå½“æ»¡è¶³ä¸€å®šæ¡ä»¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¯ä»¥æä¾› <code>&amp;mut T</code>
å¯å˜å¼•ç”¨çš„ã€‚å…·ä½“æ¥è¯´ï¼Œéœ€è¦æ»¡è¶³ 2 ä¸ªæ¡ä»¶ï¼š</p>
<ol type="1">
<li>ä½¿ç”¨ <code>&amp;mut Arc&lt;T&gt;</code> ä¿è¯å½“å‰
<code>Arc&lt;T&gt;</code> åªæœ‰ä¸€ä¸ªåœ°æ–¹åœ¨ä½¿ç”¨ï¼›</li>
<li>éœ€è¦ç¡®ä¿å…¨å±€åªæœ‰ä¸€ä¸ª <code>Arc&lt;T&gt;</code>ã€‚</li>
</ol>
<p>ä¸ºäº†é¿å…è·Ÿ <code>DerefMut</code>
æ··æ·†ï¼Œæˆ‘ä»¬å°†å…¶å£°æ˜ä¸ºä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œå¹¶å°† <code>Arc&lt;T&gt;</code>
ä½œä¸ºå‚æ•°ï¼ŒåŒæ—¶å› ä¸ºåªæœ‰æ»¡è¶³ç‰¹å®šæ¡ä»¶çš„æƒ…å†µä¸‹ï¼Œæ‰èƒ½è¿”å›
<code>&amp;mut T</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ <code>Option</code>
ä½œä¸ºè¿”å›å€¼ã€‚å¦‚ä¸‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">get_mut</span>(arc: &amp;<span class="keyword">mut</span> Arc&lt;T&gt;) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;&amp;<span class="keyword">mut</span> T&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> arc.<span class="title function_ invoke__">data</span>().ref_count.<span class="title function_ invoke__">load</span>(Ordering::Relaxed) == <span class="number">1</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">fence</span>(Ordering::Acquire);</span><br><span class="line">        <span class="comment">// Safety: æ²¡æœ‰å…¶ä»–åœ°æ–¹å¯ä»¥è®¿é—®æ•°æ®ï¼Œ</span></span><br><span class="line">        <span class="comment">// å› ä¸ºæˆ‘ä»¬ä½¿ç”¨äº† &amp;mut ç‹¬å å¼•ç”¨ï¼Œè€Œä¸”æ­¤æ—¶åªæœ‰ä¸€ä¸ª `Arc`ã€‚</span></span><br><span class="line">        <span class="keyword">unsafe</span> &#123; <span class="title function_ invoke__">Some</span>(&amp;<span class="keyword">mut</span> arc.ptr.<span class="title function_ invoke__">as_mut</span>().data) &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="literal">None</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol type="1">
<li><p>è¿™é‡Œæˆ‘ä»¬åœ¨ç¡®å®šåªæœ‰ä¸€ä¸ª <code>Arc</code> å®ä¾‹çš„æ—¶å€™ï¼Œä½¿ç”¨
<code>fetch(Acquire)</code> æ¥è·Ÿæ‰€æœ‰å…¶ä»– <code>Arc</code> æ‰§è¡Œ
<code>drop()</code> çš„ <code>fetch_sub(Release)</code> å»ºç«‹
happens-before å…³ç³»ã€‚</p></li>
<li><p>å› ä¸ºæ­¤æ—¶ <code>ref_count=1</code>ï¼Œè¯´æ˜ä»…æœ‰å½“å‰ <code>Arc</code>
è¿™ä¸€ä¸ªå®ä¾‹ï¼Œè€Œ <code>get_mut</code> éœ€è¦çš„åˆæ˜¯ç‹¬å å¼•ç”¨ï¼Œæ‰€ä»¥å½“å‰
<code>Arc</code> ä¸å¯èƒ½å†è¢«æ‹¿å»åš <code>clone()</code>
æ“ä½œï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªæƒ…å†µä¸‹ï¼Œæ˜¯å¯ä»¥ä¿è¯æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª <code>Arc</code>
å®ä¾‹ï¼Œæ‰€ä»¥æˆ‘ä»¬æ˜¯å¯ä»¥å®‰å…¨è¿”å› <code>&amp;mut T</code> çš„ã€‚</p></li>
<li><p>è¿”å›çš„ <code>&amp;mut T</code> ä¼šéšå¼åœ°å€Ÿç”¨å‚æ•°
<code>&amp;mut Arc&lt;T&gt;</code> çš„ç”Ÿå‘½å‘¨æœŸï¼Œè€Œ Rust
ä¸å…è®¸å¯å˜å¼•ç”¨å’Œåªè¯»å¼•ç”¨äº¤å‰å­˜åœ¨ï¼Œæ‰€ä»¥å½“å‰ä»…å‰©çš„è¿™ä¸ª
<code>Arc</code>ï¼Œç›´åˆ° <code>&amp;mut T</code>
ä½œç”¨åŸŸç»“æŸä¹‹å‰ï¼Œéƒ½æ˜¯ä¸å¯ç”¨çš„ï¼Œæ‰€ä»¥åœ¨é‚£ä¹‹å‰ï¼Œä¸ä¼šå†è¢«æ‹¿å»æ‰§è¡Œ
<code>clone()</code> å’Œ <code>Deref</code> ç­‰æ“ä½œï¼Œæ‰€ä»¥æ˜¯å®‰å…¨çš„ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">get_mut_should_be_safe</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">x</span> = Arc::<span class="title function_ invoke__">new</span>(<span class="built_in">vec!</span>[]);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">v</span> = Arc::<span class="title function_ invoke__">get_mut</span>(&amp;<span class="keyword">mut</span> x).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    v.<span class="title function_ invoke__">push</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">y</span> = x.<span class="title function_ invoke__">clone</span>(); <span class="comment">// &lt;---- cannot borrow `x` as immutable</span></span><br><span class="line">    v.<span class="title function_ invoke__">push</span>(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šé¢è¿™ä¸ªä¾‹å­ï¼Œå°±ä¼šæŠ¥é”™ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">error[E0502]: cannot borrow `x` as immutable because it is also borrowed as mutable</span><br><span class="line"><span class="meta prompt_">   --&gt; </span><span class="language-bash">src/arc.rs:117:17</span></span><br><span class="line">    |</span><br><span class="line">114 |         let v = Arc::get_mut(&amp;mut x).unwrap();</span><br><span class="line">    |                              ------ mutable borrow occurs here</span><br><span class="line">...</span><br><span class="line">117 |         let y = x.clone();</span><br><span class="line">    |                 ^ immutable borrow occurs here</span><br><span class="line">118 |         v.push(2);</span><br><span class="line">    |         - mutable borrow later used here</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="v2-å¼±æŒ‡é’ˆ-weakt-è§£å†³å¾ªç¯å¼•ç”¨">v2: å¼±æŒ‡é’ˆ Weak&lt;T&gt;
è§£å†³å¾ªç¯å¼•ç”¨</h2>
<h3 id="å¾ªç¯å¼•ç”¨é—®é¢˜åˆ†æ">å¾ªç¯å¼•ç”¨é—®é¢˜åˆ†æ</h3>
<pre class="mermaid">graph TD
    A --> B;
    A --> C;</pre>
<p>å¼•ç”¨è®¡æ•°åœ¨å„ç§æ•°æ®ç»“æ„çš„è¡¨ç¤ºä¸­éå¸¸æœ‰ç”¨ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºçš„æ ‘å½¢ç»“æ„ï¼Œå½“é‡Šæ”¾
A çš„æ—¶å€™ï¼Œå› ä¸º B å’Œ C ä¸å†è¢«å¼•ç”¨ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥é¡ºå¸¦é‡Šæ”¾äº†ã€‚</p>
<p>ä½†æ˜¯ï¼Œå¦‚æœ B å’Œ C ä¹ŸæŒæœ‰å¯¹ A
çš„å¼•ç”¨ï¼Œå³å½¢æˆäº†å¾ªç¯å¼•ç”¨ï¼Œé‚£æŒ‰ç…§æˆ‘ä»¬ä¹‹å‰çš„å®ç°ï¼ŒAã€Bã€C
éƒ½å°†æ°¸è¿œä¸ä¼šè¢«é‡Šæ”¾äº†ï¼Œå› ä¸ºå®ƒä»¬çš„å¼•ç”¨è®¡æ•°æ°¸ä¸ä¸º
0ï¼Œå“ªæ€•å®ƒä»¬ä¸‰è€…å‡ä¸å†è¢«ä½¿ç”¨ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<pre class="mermaid">graph TD
    A <--> B;
    A <--> C;
    B -.-> A;
    C -.-> A;</pre>
<p>ä¸ºäº†åº”å¯¹è¿™ç§åœºæ™¯ï¼ŒRust
çš„æ ‡å‡†åº“ä¸­æå‡ºçš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼š<strong><code>Weak&lt;T&gt;</code>ï¼Œä¹Ÿç§°å¼±æŒ‡é’ˆ</strong>ã€‚<strong><code>T</code>
å¯ä»¥åœ¨ <code>Arc&lt;T&gt;</code> å’Œ <code>Weak&lt;T&gt;</code>
ä¹‹é—´å…±äº«ï¼Œå½“æ‰€æœ‰çš„ <code>Arc&lt;T&gt;</code>
éƒ½å¤±æ•ˆçš„æ—¶å€™ï¼Œ<code>T</code> è¢«é‡Šæ”¾ï¼Œæ— è®ºæ­¤æ—¶æ˜¯å¦æœ‰
<code>Weak&lt;T&gt;</code> çš„å­˜åœ¨ã€‚</strong></p>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œçˆ¶èŠ‚ç‚¹å¯¹å­èŠ‚ç‚¹ä½¿ç”¨çš„æ˜¯å¼ºå¼•ç”¨ï¼Œç¡®ä¿äº†çˆ¶èŠ‚ç‚¹å­˜æ´»çš„æ—¶å€™ï¼Œå­èŠ‚ç‚¹éƒ½å­˜åœ¨ã€‚è€Œå­èŠ‚ç‚¹å¯¹çˆ¶èŠ‚ç‚¹ä½¿ç”¨çš„æ˜¯å¼±å¼•ç”¨ï¼Œåªå³ä¿ç•™äº†å­èŠ‚ç‚¹å›æº¯çˆ¶èŠ‚ç‚¹çš„èƒ½åŠ›ï¼Œä¹Ÿä¸ä¼šé˜»æ­¢çˆ¶èŠ‚ç‚¹çš„é‡Šæ”¾ã€‚</p>
<p>å½“çˆ¶èŠ‚ç‚¹è¢«é‡Šæ”¾æ—¶ï¼Œæ‰€æœ‰å¼ºå¼•ç”¨è®¡æ•°å½’é›¶ï¼ŒèŠ‚ç‚¹å¯ä»¥ä¾æ¬¡è¢«é‡Šæ”¾ã€‚</p>
<pre class="mermaid">graph TD
    A -- Arc --> B;
    A -- Arc --> C;
    B -.->|Weak| A;
    C -.->|Weak| A;</pre>
<h3 id="æ•°æ®ç»“æ„-1">æ•°æ®ç»“æ„</h3>
<p>OKï¼Œåšäº†è¿™ä¹ˆå¤šé“ºå«åï¼Œæˆ‘ä»¬æ¥æ€è€ƒä¸€ä¸‹ç°åœ¨çš„ <code>ArcData</code>
è¯¥å¦‚ä½•è°ƒæ•´ã€‚</p>
<ol type="1">
<li>ä¹‹å‰æˆ‘ä»¬ç”¨ <code>ref_count</code>
åšå¼•ç”¨è®¡æ•°ï¼Œå®ƒä»£è¡¨çš„éƒ½æ˜¯å¼ºå¼•ç”¨ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦è®°å½•å¼±å¼•ç”¨æ•°é‡çš„ç›¸å…³å­—æ®µã€‚</li>
<li>å½“åªæœ‰å¼±å¼•ç”¨çš„æ—¶å€™ï¼Œ<code>data</code> å°±å·²ç»è¢«é‡Šæ”¾äº†ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨
<code>None</code> æ¥è¡¨ç¤ºè¿™ç§æƒ…å†µï¼Œæ‰€ä»¥ <code>data</code> åº”è¯¥æ˜¯ä¸€ä¸ª
<code>Option&lt;T&gt;</code> ç±»å‹ã€‚</li>
<li>å½“ <code>ArcData&lt;T&gt;</code> è¢«ä¸€ä¸ª <code>Arc</code> å’Œå¤šä¸ª
<code>Weak</code> å…±äº«æ—¶ï¼Œé‡Šæ”¾æœ€åä¸€ä¸ª <code>Arc</code> æ—¶ï¼Œæˆ‘ä»¬ä»…æ‹¥æœ‰
<code>&amp;ArcData&lt;T&gt;</code> ä¸å¯å˜å¼•ç”¨ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦å°†å…¶ä»
<code>Some(T)</code> ç½®ä¸º
<code>None</code>ï¼Œå³è¦åœ¨ä¸å¯å˜å¼•ç”¨ä¸Šå®ç°ä¿®æ”¹ï¼Œè¿™å°±æ¶‰åŠåˆ°äº†å‰å‡ ç¯‡æåˆ°çš„ï¼š<strong>å†…éƒ¨å¯å˜æ€§</strong>ã€‚<strong>UnsafeCell</strong>
æ˜¯ Rust
æä¾›çš„ä¸€ä¸ªå†…éƒ¨å¯å˜æ€§å·¥å…·ç±»å‹ï¼Œå®ƒåŒ…è£…ä¸€ä¸ªæ•°æ®ï¼Œä½¿å¾—å³ä½¿åœ¨åªæœ‰ä¸å¯å˜å¼•ç”¨çš„æƒ…å†µä¸‹ä¹Ÿå¯ä»¥è¿›è¡Œä¿®æ”¹ï¼ˆå½“ç„¶éœ€è¦åœ¨
<code>unsafe</code> å—ä¸­æ“ä½œï¼‰ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°† <code>data</code> å†ç”¨
<code>UnsafeCell</code> åŒ…ä¸€å±‚ï¼Œä»¥æ»¡è¶³æ­¤åœºæ™¯çš„éœ€æ±‚ã€‚</li>
</ol>
<p>ç»¼ä¸Šï¼Œæœ€æ–°çš„ <code>ArcData</code> å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ArcData</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">// `Arc` çš„æ•°é‡ï¼Œä¹Ÿå³æ•°æ® T çš„å¼ºå¼•ç”¨è®¡æ•°ã€‚</span></span><br><span class="line">    data_ref_count: AtomicUsize,</span><br><span class="line">    <span class="comment">// `Arc` + `Weak` çš„æ•°é‡ã€‚</span></span><br><span class="line">    alloc_ref_count: AtomicUsize,</span><br><span class="line">    <span class="comment">// æ•°æ®ï¼Œå½“åªæœ‰ `Weak` çš„æ—¶å€™ï¼Œä¸º Noneã€‚</span></span><br><span class="line">    data: UnsafeCell&lt;<span class="type">Option</span>&lt;T&gt;&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªæ–°ç»“æ„ <code>Weak&lt;T&gt;</code>
ï¼Œç”¨æ¥è¡¨ç¤ºå¼±å¼•ç”¨ï¼Œå‡å®šè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°†ç»´æŠ¤ <code>ArcData</code>
å­˜æ´»çš„èŒè´£äº¤ç»™ <code>Weak&lt;T&gt;</code>ï¼Œé‚£å°±å¯ä»¥å°†
<code>ArcData</code> è½¬ç»™ <code>Weak&lt;T&gt;</code> æŒæœ‰ï¼Œç„¶ååœ¨
<code>Arc&lt;T&gt;</code> ä¸­æŒæœ‰ä¸€ä¸ª <code>Weak&lt;T&gt;</code>ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ArcData</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">// `Arc` çš„æ•°é‡ï¼Œä¹Ÿå³æ•°æ® T çš„å¼ºå¼•ç”¨è®¡æ•°ã€‚</span></span><br><span class="line">    data_ref_count: AtomicUsize,</span><br><span class="line">    <span class="comment">// `Arc` + `Weak` çš„æ•°é‡ã€‚</span></span><br><span class="line">    alloc_ref_count: AtomicUsize,</span><br><span class="line">    <span class="comment">// æ•°æ®ï¼Œå½“åªæœ‰ `Weak` çš„æ—¶å€™ï¼Œä¸º Noneã€‚</span></span><br><span class="line">    data: UnsafeCell&lt;<span class="type">Option</span>&lt;T&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    weak: Weak&lt;T&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Weak</span>&lt;T&gt; &#123;</span><br><span class="line">    ptr: NonNull&lt;ArcData&lt;T&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T: <span class="built_in">Send</span> + <span class="built_in">Sync</span>&gt; <span class="built_in">Send</span> <span class="keyword">for</span> <span class="title class_">Weak</span>&lt;T&gt; &#123;&#125;</span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T: <span class="built_in">Send</span> + <span class="built_in">Sync</span>&gt; <span class="built_in">Sync</span> <span class="keyword">for</span> <span class="title class_">Weak</span>&lt;T&gt; &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Arc&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(data: T) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        Arc &#123;</span><br><span class="line">            weak: Weak &#123;</span><br><span class="line">                ptr: NonNull::<span class="title function_ invoke__">from</span>(<span class="type">Box</span>::<span class="title function_ invoke__">leak</span>(<span class="type">Box</span>::<span class="title function_ invoke__">new</span>(ArcData &#123;</span><br><span class="line">                    alloc_ref_count: AtomicUsize::<span class="title function_ invoke__">new</span>(<span class="number">1</span>),</span><br><span class="line">                    data_ref_count: AtomicUsize::<span class="title function_ invoke__">new</span>(<span class="number">1</span>),</span><br><span class="line">                    data: UnsafeCell::<span class="title function_ invoke__">new</span>(<span class="title function_ invoke__">Some</span>(data)),</span><br><span class="line">                &#125;))),</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Weak&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">data</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;ArcData&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; <span class="keyword">self</span>.ptr.<span class="title function_ invoke__">as_ref</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Deref <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Target</span> = T;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">deref</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="keyword">Self</span>::Target &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">ptr</span> = <span class="keyword">self</span>.weak.<span class="title function_ invoke__">data</span>().data.<span class="title function_ invoke__">get</span>();</span><br><span class="line">        <span class="comment">// Safety: è¿™ä¸ªæ—¶å€™è¿˜æœ‰ Arc å­˜åœ¨ï¼Œæ‰€ä»¥ data è‚¯å®šæ˜¯ç”Ÿæ•ˆçš„ã€‚</span></span><br><span class="line">        <span class="keyword">unsafe</span> &#123; (*ptr).<span class="title function_ invoke__">as_ref</span>().<span class="title function_ invoke__">unwrap</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œé™¤äº†æ•°æ®ç»“æ„ä¹‹å¤–ï¼Œæˆ‘ä»¬åšäº† 3 ç‚¹è°ƒæ•´ï¼š</p>
<ol type="1">
<li>åªéœ€è¦ä¸º <code>Weak&lt;T&gt;</code> å®ç° <code>Sync</code> å’Œ
<code>Send</code> traitï¼Œè¿™ä¸ªæ—¶å€™ <code>Arc&lt;T&gt;</code>
å°±ä¼šè¢«è‡ªåŠ¨å®ç°è¿™ 2 ä¸ª triatã€‚</li>
<li><code>data(&amp;self)</code> è¾…åŠ©å‡½æ•°ï¼Œç§»åˆ°äº†
<code>Weak&lt;T&gt;</code> èº«ä¸Šã€‚</li>
<li><code>Arc&lt;T&gt;</code> è¦ä» <code>Deref</code> è·å–
<code>&amp;T</code>ï¼Œéœ€è¦å…ˆç»è¿‡ä¸€é“ <code>Weak&lt;T&gt;</code>ã€‚</li>
</ol>
<pre class="mermaid">graph LR
    subgraph Stack ["æ ˆå†…å­˜ Stack"]
        ArcStruct["Arc&lt;T&gt;<br/>weak: Weak&lt;T&gt;"]
        WeakStruct["Weak&lt;T&gt;<br/>ptr: NonNull&lt;ArcData&lt;T&gt;&gt;"]
    end

    subgraph Heap ["å †å†…å­˜ Heap"]
        ArcDataStruct["ArcData&lt;T&gt;<br/>data_ref_count: AtomicUsize(1)<br/>alloc_ref_count: AtomicUsize(1)<br/>data: UnsafeCell&lt;Option&lt;T&gt;&gt;"]
    end

    ArcStruct -->|åŒ…å«| WeakStruct
    WeakStruct -->|æŒ‡å‘| ArcDataStruct


    classDef stackStyle fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef heapStyle fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef processStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef refStyle fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px

    class ArcStruct,WeakStruct stackStyle
    class ArcDataStruct heapStyle
    class Step1,Step2,Step3,Step4,Step5 processStyle
    class DataRef,AllocRef,DataContent refStyle</pre>
<h3 id="ç»´æŠ¤å¼•ç”¨è®¡æ•°-1">ç»´æŠ¤å¼•ç”¨è®¡æ•°</h3>
<p>ç°åœ¨é‡ç‚¹æ¥äº†ï¼Œæˆ‘ä»¬éœ€è¦æ¥æ€è€ƒ <code>Weak&lt;T&gt;</code> å’Œ
<code>Arc&lt;T&gt;</code> çš„ <code>Clone</code> å’Œ <code>Drop</code>
è¯¥å¦‚ä½•å®ç°ã€‚å…¶å®é‡ç‚¹å°±æ˜¯è¯¥<strong>å¦‚ä½•ç®¡ç† <code>alloc_ref_count</code>
å’Œ <code>data_ref_count</code> çš„è®¡æ•°</strong>ã€‚</p>
<p>å†æ¬¡æ˜ç¡®ä¸‹æˆ‘ä»¬çš„å®šä¹‰ï¼š</p>
<ul>
<li><code>data_ref_count</code>: ä»£è¡¨çš„æ˜¯å¼ºå¼•ç”¨
<code>Arc&lt;T&gt;</code> çš„æ•°é‡ã€‚</li>
<li><code>alloc_ref_count</code>: ä»£è¡¨çš„æ˜¯ <code>Arc&lt;T&gt;</code> +
<code>Weak&lt;T&gt;</code> çš„æ•°é‡ã€‚</li>
</ul>
<p>å› æ­¤ï¼š</p>
<ul>
<li>Clone:
<ul>
<li>å½“ <code>Weak&lt;T&gt;</code>
æ‹·è´æ—¶ï¼Œä»…å¢åŠ äº†å¼±å¼•ç”¨çš„æ•°é‡ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€å¯¹
<code>alloc_ref_count</code> è¿›è¡Œè‡ªå¢ã€‚</li>
<li>å½“ <code>Arc&lt;T&gt;</code> æ‹·è´æ—¶ï¼Œä¸ä»…éœ€è¦æ‹·è´å†…éƒ¨çš„
<code>Weak&lt;T&gt;</code>ï¼Œè¿˜å¢åŠ äº†å¼ºå¼•ç”¨çš„æ•°é‡ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦å¯¹
<code>data_ref_count</code> è¿›è¡Œè‡ªå¢ã€‚</li>
</ul></li>
<li>Drop:
<ul>
<li>å½“ <code>Arc&lt;T&gt;</code> è¢«é‡Šæ”¾æ—¶ï¼Œä¸ä»…é‡Šæ”¾äº†å…¶å†…éƒ¨çš„
<code>Weak&lt;T&gt;</code>ï¼Œè¿˜å‡å°‘äº†ä¸€ä¸ªå¼ºå¼•ç”¨ï¼Œæ‰€ä»¥éœ€è¦å¯¹
<code>data_ref_count</code> è¿›è¡Œè‡ªå‡ã€‚å¦å¤–ï¼Œå¦‚æœæ˜¯æœ€åä¸€ä¸ª
<code>Arc&lt;T&gt;</code> è¢«é‡Šæ”¾ï¼Œæˆ‘ä»¬éœ€è¦å°†
<code>ArcData&lt;T&gt;.data</code> ç½®ä¸º <code>None</code>ã€‚</li>
<li>å½“ <code>Weak&lt;T&gt;</code>
è¢«é‡Šæ”¾æ—¶ï¼Œæˆ‘ä»¬ä»…éœ€å‡å°‘å¼±å¼•ç”¨çš„æ•°é‡ï¼Œå³å¯¹ <code>alloc_ref_count</code>
è¿›è¡Œè‡ªå‡ã€‚å¦å¤–ï¼Œå½“æœ€åä¸€ä¸ª <code>Weak&lt;T&gt;</code>
è¢«é‡Šæ”¾æ—¶ï¼ˆæ­¤æ—¶è‚¯å®šä¹Ÿæ²¡æœ‰ <code>Arc&lt;T&gt;</code>
äº†ï¼‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è´Ÿè´£é‡Šæ”¾ <code>ArcData&lt;T&gt;</code> ã€‚</li>
</ul></li>
</ul>
<p>ç»¼ä¸Šï¼Œæˆ‘ä»¬çš„å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Clone</span> <span class="keyword">for</span> <span class="title class_">Weak</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">clone</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().alloc_ref_count.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Ordering::Relaxed) &gt; <span class="type">usize</span>::MAX / <span class="number">2</span> &#123;</span><br><span class="line">            std::process::<span class="title function_ invoke__">abort</span>();</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">Self</span> &#123; ptr: <span class="keyword">self</span>.ptr &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Clone</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">clone</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">weak</span> = <span class="keyword">self</span>.weak.<span class="title function_ invoke__">clone</span>();</span><br><span class="line">        <span class="keyword">if</span> weak.<span class="title function_ invoke__">data</span>().data_ref_count.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Ordering::Relaxed) &gt; <span class="type">usize</span>::MAX / <span class="number">2</span> &#123;</span><br><span class="line">            std::process::<span class="title function_ invoke__">abort</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        Arc &#123; weak &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Drop</span> <span class="keyword">for</span> <span class="title class_">Weak</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().alloc_ref_count.<span class="title function_ invoke__">fetch_sub</span>(<span class="number">1</span>, Ordering::Release) == <span class="number">1</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">fence</span>(Ordering::Acquire);</span><br><span class="line">            <span class="comment">// Safety: æœ€åä¸€ä¸ª Weak&lt;T&gt; å·²ç»è¢«é‡Šæ”¾äº†ã€‚</span></span><br><span class="line">            <span class="keyword">unsafe</span> &#123;</span><br><span class="line">                <span class="title function_ invoke__">drop</span>(<span class="type">Box</span>::<span class="title function_ invoke__">from_raw</span>(<span class="keyword">self</span>.ptr.<span class="title function_ invoke__">as_ptr</span>()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Drop</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span></span><br><span class="line">            .weak</span><br><span class="line">            .<span class="title function_ invoke__">data</span>()</span><br><span class="line">            .data_ref_count</span><br><span class="line">            .<span class="title function_ invoke__">fetch_sub</span>(<span class="number">1</span>, Ordering::Release)</span><br><span class="line">            == <span class="number">1</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="title function_ invoke__">fence</span>(Ordering::Acquire);</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">ptr</span> = <span class="keyword">self</span>.weak.<span class="title function_ invoke__">data</span>().data.<span class="title function_ invoke__">get</span>();</span><br><span class="line">            <span class="comment">// Safety: data_ref_count å·²ç»ä¸º 0 äº†ï¼Œæ²¡æœ‰åœ°æ–¹åœ¨ä½¿ç”¨ data äº†ã€‚</span></span><br><span class="line">            <span class="keyword">unsafe</span> &#123; (*ptr) = <span class="literal">None</span> &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¿™é‡Œè€ƒè™‘åˆ°å®é™…åœºæ™¯ä¸­çš„å†…å­˜é™åˆ¶ï¼Œæˆ‘ä»¬å¯¹å¼•ç”¨è®¡æ•°è¿›è¡Œäº†ç®€å•çš„é™åˆ¶ï¼Œå½“å…¶è¶…è¿‡
<code>usize::Max/2</code> çš„æ—¶å€™ï¼Œå°±æ‰§è¡Œ
<code>std::process:abort()</code> è®©æ•´ä¸ªè¿›ç¨‹å´©æºƒã€‚</p>
</blockquote>
<h3 id="get_mut">get_mut()</h3>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥è€ƒè™‘ä¸‹ <code>get_mut(arc: &amp;mut Arc&lt;T&gt;)</code>
è¯¥å¦‚ä½•ä¿®æ”¹ã€‚ä»€ä¹ˆæ—¶å€™å¯ä»¥è¿”å›
<code>&amp;mut T</code>ï¼Œå¾ˆæ˜æ˜¾ï¼Œ<strong>å½“ä¸”ä»…å½“åªæœ‰ä¸€ä¸ª
<code>Arc&lt;T&gt;</code> çš„æ—¶å€™æ‰å¯ä»¥</strong>ã€‚</p>
<p>æ•… <code>get_mut</code> çš„å®ç°ä¿®æ”¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">get_mut</span>(arc: &amp;<span class="keyword">mut</span> Arc&lt;T&gt;) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;&amp;<span class="keyword">mut</span> T&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> arc.weak.<span class="title function_ invoke__">data</span>().alloc_ref_count.<span class="title function_ invoke__">load</span>(Ordering::Relaxed) == <span class="number">1</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">fence</span>(Ordering::Acquire);</span><br><span class="line">        <span class="comment">// Safety: è¿™ä¸ªæ—¶å€™æ²¡æœ‰å…¶ä»–åœ°æ–¹èƒ½ä½¿ç”¨æ•°æ®ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ª `Arc`ï¼Œ</span></span><br><span class="line">        <span class="comment">// åŒæ—¶æˆ‘ä»¬æ‹¥æœ‰ä»…å­˜çš„è¿™ä¸ª `Arc` çš„ä¸å¯å˜å¼•ç”¨ã€‚</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">arcdata</span> = <span class="keyword">unsafe</span> &#123; arc.weak.ptr.<span class="title function_ invoke__">as_mut</span>() &#125;;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">option</span> = arcdata.data.<span class="title function_ invoke__">get_mut</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">data</span> = option.<span class="title function_ invoke__">as_mut</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(data)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="literal">None</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬æ‰§è¡Œä¹‹å‰çš„ <code>arc_should_work</code>
æµ‹è¯•ç”¨ä¾‹ï¼Œå¯ä»¥å‘ç°æ˜¯é¡ºåˆ©é€šè¿‡çš„ã€‚</p>
<h3 id="dowgrade">dowgrade()</h3>
<p>å›é¡¾ä¸‹é¢è¿™å¼ å›¾ï¼Œä¸ºäº†æä¾› A çš„ <code>Weak&lt;T&gt;</code>
æŒ‡é’ˆï¼Œæˆ‘ä»¬éœ€è¦ç»™ <code>Arc&lt;T&gt;</code> æä¾›ä¸€ä¸ª
<code>downgrade()</code>
æ–¹æ³•ï¼Œç”¨äºå°†å¼ºå¼•ç”¨é™ä¸ºå¼±å¼•ç”¨ï¼Œè¿™æ˜¯å¿…ç„¶å¯ä»¥æˆåŠŸçš„ã€‚åŒæ—¶ï¼Œå½“æˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸º
<code>Weak&lt;T&gt;</code> æä¾›ä¸€ä¸ª <code>upgrade()</code>
æ–¹æ³•ï¼Œç”¨äºæŒæœ‰å¼±å¼•ç”¨çš„æƒ…å†µä¸‹å¯ä»¥å°è¯•è®¿é—®æ•°æ®ï¼Œå½“ç„¶è¿™æœªå¿…èƒ½æˆåŠŸã€‚</p>
<pre class="mermaid">graph TD
    A -- Arc --> B;
    A -- Arc --> C;
    B -.->|Weak| A;
    C -.->|Weak| A;</pre>
<p><code>downgrade()</code> æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬ç›´æ¥ <code>clone()</code> ä¸€ä¸ª
<code>Weak&lt;T&gt;</code> å°±å¯ä»¥äº†ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; Arc&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">downgrade</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> Weak&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.weak.<span class="title function_ invoke__">clone</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="upgrade">upgrade()</h3>
<p><code>upgrade()</code> å°±æ¯”è¾ƒå¤æ‚äº†ï¼Œåªæœ‰å½“å­˜åœ¨ <code>Arc</code>
çš„æ—¶å€™ï¼Œ<code>data</code> æ‰æ²¡è¢«é‡Šæ”¾ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæ‰èƒ½è¿”å›å‡çº§åçš„
<code>Arc&lt;T&gt;</code>ï¼Œå³è¦æ±‚ <code>data_ref_count&gt;0</code>ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; Weak&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">upgrade</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;Arc&lt;T&gt;&gt; &#123;</span><br><span class="line">      	<span class="comment">// è·å– data_ref_count çš„å€¼</span></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">n</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().data_ref_count.<span class="title function_ invoke__">load</span>(Ordering::Relaxed);</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">          	<span class="comment">// å¦‚æœç­‰äº 0ï¼Œåˆ™è¯´æ˜ data å·²ç»è¢«é‡Šæ”¾äº†ï¼Œç›´æ¥è¿”å› None</span></span><br><span class="line">            <span class="keyword">if</span> n == <span class="number">0</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">assert!</span>(n &lt; <span class="type">usize</span>::MAX);</span><br><span class="line">          	<span class="comment">// ä¸ä¸º 0 çš„è¯ï¼Œdata_ref_count å°è¯•è¿›è¡Œ +1ï¼Œå¤±è´¥äº†å°±é‡è¯•</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Err</span>(e) = <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().data_ref_count.<span class="title function_ invoke__">compare_exchange_weak</span>(</span><br><span class="line">                n,</span><br><span class="line">                n + <span class="number">1</span>,</span><br><span class="line">                Ordering::Relaxed,</span><br><span class="line">                Ordering::Relaxed,</span><br><span class="line">            ) &#123;</span><br><span class="line">                n = e;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          	<span class="comment">// æˆåŠŸäº†ï¼Œåˆ™ clone weak å³å¯ï¼ˆæ‰§è¡Œ alloc_ref_count++ï¼‰</span></span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">Some</span>(Arc &#123; weak: <span class="keyword">self</span>.<span class="title function_ invoke__">clone</span>() &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æ¥å†™ä¸€ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼ŒéªŒè¯ä½¿ç”¨äº† <code>Weak&lt;T&gt;</code>
åï¼Œæˆ‘ä»¬çš„èµ„æºèƒ½å¦æ­£ç¡®é‡Šæ”¾ã€‚åœ¨è¿™ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå†™ä¸€ä¸ªé
<code>Weak&lt;T&gt;</code> ç‰ˆæœ¬çš„ï¼Œçœ‹çœ‹èµ„æºæ˜¯å¦çœŸçš„æ²¡æœ‰è¢«é‡Šæ”¾ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">no_weak_should_not_free_resource</span>() &#123;</span><br><span class="line">    <span class="keyword">static</span> NUM_DROPS: AtomicUsize = AtomicUsize::<span class="title function_ invoke__">new</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">      	<span class="comment">// ä½¿ç”¨ RefCellï¼Œåˆ©ç”¨å…¶å†…éƒ¨å¯å˜æ€§ï¼Œæ–¹ä¾¿æˆ‘ä»¬å»ºç«‹çˆ¶å­å…³ç³»</span></span><br><span class="line">        child: RefCell&lt;<span class="type">Vec</span>&lt;Arc&lt;Node&gt;&gt;&gt;,</span><br><span class="line">        parent: RefCell&lt;<span class="type">Option</span>&lt;Arc&lt;Node&gt;&gt;&gt;, <span class="comment">// &lt;---- è¿™é‡ŒæŒæœ‰çš„æ˜¯å¼ºå¼•ç”¨</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">impl</span> <span class="title class_">Drop</span> <span class="keyword">for</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">            NUM_DROPS.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Ordering::Relaxed);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">impl</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">        <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">            <span class="keyword">Self</span> &#123;</span><br><span class="line">                child: RefCell::<span class="title function_ invoke__">new</span>(<span class="built_in">vec!</span>[]),</span><br><span class="line">                parent: RefCell::<span class="title function_ invoke__">new</span>(<span class="literal">None</span>),</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      	<span class="comment">// å»ºç«‹çˆ¶å­å…³ç³»</span></span><br><span class="line">        <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">add_child</span>(parent: &amp;Arc&lt;Node&gt;, child: Arc&lt;Node&gt;) &#123;</span><br><span class="line">            *child.parent.<span class="title function_ invoke__">borrow_mut</span>() = <span class="title function_ invoke__">Some</span>(parent.<span class="title function_ invoke__">clone</span>());</span><br><span class="line">            parent.child.<span class="title function_ invoke__">borrow_mut</span>().<span class="title function_ invoke__">push</span>(child);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">// é™å®šä½œç”¨åŸŸï¼Œç¦»å¼€ä½œç”¨åŸŸåï¼Œroot/child1/child2 æ­£å¸¸æƒ…å†µåº”è¯¥è¢«é‡Šæ”¾ã€‚</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">root</span> = Arc::<span class="title function_ invoke__">new</span>(Node::<span class="title function_ invoke__">new</span>());</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">child1</span> = Arc::<span class="title function_ invoke__">new</span>(Node::<span class="title function_ invoke__">new</span>());</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">child2</span> = Arc::<span class="title function_ invoke__">new</span>(Node::<span class="title function_ invoke__">new</span>());</span><br><span class="line"></span><br><span class="line">        Node::<span class="title function_ invoke__">add_child</span>(&amp;root, child1);</span><br><span class="line">        Node::<span class="title function_ invoke__">add_child</span>(&amp;root, child2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">assert_ne!</span>(NUM_DROPS.<span class="title function_ invoke__">load</span>(Ordering::Relaxed), <span class="number">3</span>); <span class="comment">// ä¸ä¸º 3</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œä¸Šè¿°ç”¨ä¾‹åï¼Œæˆ‘ä»¬å¯ä»¥å‘ç° <code>NUM_DROPS</code> è¿˜æ˜¯ 0ï¼Œå³
<code>root/child1/child2</code> å‡æ²¡æœ‰è¢«é‡Šæ”¾èµ„æºã€‚</p>
<p>ä½ å¯ä»¥å°† <code>parent</code>
çš„å¼•ç”¨ä¿®æ”¹ä¸ºå¼±å¼•ç”¨ï¼Œç„¶åå†é‡æ–°æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ï¼Œå°±ä¼šå‘ç°
<code>root/child1/child2</code> çš„èµ„æºéƒ½è¢«æ­£ç¡®é‡Šæ”¾äº†ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">    child: RefCell&lt;<span class="type">Vec</span>&lt;Arc&lt;Node&gt;&gt;&gt;,</span><br><span class="line">    parent: RefCell&lt;<span class="type">Option</span>&lt;Weak&lt;Node&gt;&gt;&gt;, <span class="comment">// &lt;---- è¿™é‡ŒæŒæœ‰çš„æ˜¯å¼±å¼•ç”¨</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            child: RefCell::<span class="title function_ invoke__">new</span>(<span class="built_in">vec!</span>[]),</span><br><span class="line">            parent: RefCell::<span class="title function_ invoke__">new</span>(<span class="literal">None</span>),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å»ºç«‹çˆ¶å­å…³ç³»</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">add_child</span>(parent: &amp;Arc&lt;Node&gt;, child: Arc&lt;Node&gt;) &#123;</span><br><span class="line">        *child.parent.<span class="title function_ invoke__">borrow_mut</span>() = <span class="title function_ invoke__">Some</span>(parent.<span class="title function_ invoke__">downgrade</span>()); <span class="comment">// &lt;---- ä½¿ç”¨ downgrade è½¬ä¸ºå¼±å¼•ç”¨</span></span><br><span class="line">        parent.child.<span class="title function_ invoke__">borrow_mut</span>().<span class="title function_ invoke__">push</span>(child);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="v3-åˆ†ç¦»å¼ºå¼±å¼•ç”¨é¿å…æ— ç”¨æ¶ˆè€—">v3: åˆ†ç¦»å¼ºå¼±å¼•ç”¨ï¼Œé¿å…æ— ç”¨æ¶ˆè€—</h2>
<p>ä¸Šä¸ªç‰ˆæœ¬æˆ‘ä»¬é€šè¿‡å¼•å…¥äº†å¼±å¼•ç”¨
<code>Weak&lt;T&gt;</code>ï¼ŒæˆåŠŸè§£å†³äº†å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼Œè¿™æ˜¯ä¸ªéå¸¸å¤§çš„è¿›æ­¥ï¼</p>
<p>ä¸è¿‡æˆ‘ä»¬ä»ç„¶æœ‰è¿›ä¸€æ­¥ä¼˜åŒ–çš„ç©ºé—´ï¼Œå¯ä»¥è§‚å¯Ÿåˆ°ï¼Œ<code>Arc&lt;T&gt;</code>
çš„æ¯æ¬¡æ‹·è´ï¼Œéƒ½ä¼šä¼´éšä¸€æ¬¡æ‹·è´
<code>Weak&lt;T&gt;</code>ï¼Œä½†æ˜¯ï¼Œå¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬å…¶å®æ²¡æœ‰å¾ªç¯å¼•ç”¨å…³ç³»çš„ï¼Œä¹Ÿå³æˆ‘ä»¬å¹¶ä¸æ˜¯æ¯ä¸€æ¬¡éƒ½éœ€è¦
<code>Weak&lt;T&gt;</code>ï¼Œæ‰€ä»¥ä¸Šä¸ªç‰ˆæœ¬çš„å®ç°ï¼Œå…¶å®æ˜¯æœ‰å¾ˆå¤šçš„æµªè´¹çš„ã€‚</p>
<h3 id="æ•°æ®ç»“æ„-2">æ•°æ®ç»“æ„</h3>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è€ƒè™‘å°† <code>Weak&lt;T&gt;</code> ä»
<code>Arc&lt;T&gt;</code> ä¸­åˆ†ç¦»å‡ºæ¥ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    ptr: NonNull&lt;ArcData&lt;T&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T: <span class="built_in">Send</span> + <span class="built_in">Sync</span>&gt; <span class="built_in">Send</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;&#125;</span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T: <span class="built_in">Send</span> + <span class="built_in">Sync</span>&gt; <span class="built_in">Sync</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Weak</span>&lt;T&gt; &#123;</span><br><span class="line">    ptr: NonNull&lt;ArcData&lt;T&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T: <span class="built_in">Send</span> + <span class="built_in">Sync</span>&gt; <span class="built_in">Send</span> <span class="keyword">for</span> <span class="title class_">Weak</span>&lt;T&gt; &#123;&#125;</span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T: <span class="built_in">Send</span> + <span class="built_in">Sync</span>&gt; <span class="built_in">Sync</span> <span class="keyword">for</span> <span class="title class_">Weak</span>&lt;T&gt; &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Arc&lt;T&gt; &#123;</span><br><span class="line">  	<span class="comment">// è°ƒæ•´ Arc çš„æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(data: T) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        Arc &#123;</span><br><span class="line">            ptr: NonNull::<span class="title function_ invoke__">from</span>(<span class="type">Box</span>::<span class="title function_ invoke__">leak</span>(<span class="type">Box</span>::<span class="title function_ invoke__">new</span>(ArcData &#123;</span><br><span class="line">                data_ref_count: AtomicUsize::<span class="title function_ invoke__">new</span>(<span class="number">1</span>),</span><br><span class="line">                alloc_ref_count: AtomicUsize::<span class="title function_ invoke__">new</span>(<span class="number">1</span>),</span><br><span class="line">                data: UnsafeCell::<span class="title function_ invoke__">new</span>(ManuallyDrop::<span class="title function_ invoke__">new</span>(data)),</span><br><span class="line">            &#125;))),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">// Arc å·²ç»æ²¡æœ‰ Weak äº†ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæ—¶å€™ç»™å®ƒè¡¥ä¸€ä¸ª data() è¾…åŠ©å‡½æ•°</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">data</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;ArcData&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; <span class="keyword">self</span>.ptr.<span class="title function_ invoke__">as_ref</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›¸åº”åœ°è°ƒæ•´ Deref</span></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Deref <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Target</span> = T;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">deref</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="keyword">Self</span>::Target &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; &amp;*<span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().data.<span class="title function_ invoke__">get</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŒæ—¶æˆ‘ä»¬éœ€è¦å¯¹ <code>ArcData&lt;T&gt;</code>
ç»“æ„ä¸­çš„å¼•ç”¨æŠ€æœ¯è¿›è¡Œé‡æ–°å®šä¹‰ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ArcData</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">// `Arc` çš„æ•°é‡</span></span><br><span class="line">    data_ref_count: AtomicUsize,</span><br><span class="line">    <span class="comment">// `Weak` çš„æ•°é‡ï¼Œå½“å­˜åœ¨ `Arc` æ—¶ï¼Œé¢å¤–åŠ  1</span></span><br><span class="line">    alloc_ref_count: AtomicUsize,</span><br><span class="line">    <span class="comment">// æ•°æ®ï¼Œå½“åªæœ‰ `Weak` çš„æ—¶å€™ï¼Œé‡Šæ”¾å®ƒã€‚</span></span><br><span class="line">    data: UnsafeCell&lt;ManuallyDrop&lt;T&gt;&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æ€»å…±åšäº† 3 ä¸ªé‡è¦çš„è°ƒæ•´ï¼š</p>
<ol type="1">
<li><p><code>Arc&lt;T&gt;</code> ä¸å†åŒ…å«
<code>Weak&lt;T&gt;</code>ï¼Œè€Œæ˜¯å„è‡ªç‹¬ç«‹ï¼Œä¸è¿‡å®ƒä»¬ä¹‹å‰ä¼šå…±äº«åº•å±‚çš„
<code>ArcData&lt;T&gt;</code>ã€‚</p></li>
<li><p><code>alloc_ref_count</code> çš„è¯­ä¹‰ï¼Œä»<strong>"Arc + Weak
çš„æ•°é‡</strong>"ï¼Œå˜æˆ"<strong>Weak çš„æ•°é‡ï¼Œå½“å­˜åœ¨ Arc æ—¶ï¼Œé¢å¤–åŠ 
1</strong>"ã€‚</p>
<blockquote>
<p>æ¢è¨€ä¹‹ï¼Œå¯¹äºæ‰€æœ‰çš„ <code>Arc&lt;T&gt;</code>ï¼Œéƒ½å…±æœ‰ä¸€ä¸ªéšå¼çš„
<code>Weak&lt;T&gt;</code> ï¼Œå½“é‡Šæ”¾æœ€åä¸€ä¸ª <code>Arc&lt;T&gt;</code>
çš„æ—¶å€™ï¼Œè¿™ä¸ªéšå¼çš„ <code>Weak&lt;T&gt;</code> ä¹Ÿéœ€è¦è¢«é‡Šæ”¾ï¼ˆæœ¬è´¨æ˜¯æ‰§è¡Œ
alloc_ref_count å‡ä¸€ï¼ŒåŒæ—¶å¦‚æœæ²¡æœ‰å…¶ä»–çš„
<code>Weak&lt;T&gt;</code>ï¼Œéœ€è¦é¡ºå¸¦é‡Šæ”¾
<code>ArcData&lt;T&gt;</code>ã€‚</p>
</blockquote></li>
<li><p><code>data</code> å­—æ®µï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>ManuallyDrop</code> æ¥æ›¿ä»£
<code>Option</code>ï¼Œæˆ‘ä»¬ä¹‹å‰ä½¿ç”¨ <code>None</code>
æ¥è¡¨ç¤ºæ•°æ®å·²ç»è¢«é‡Šæ”¾ï¼Œä½†å…¶å® <code>data_ref_count</code>
å·²ç»èƒ½è¡¨è¾¾è¿™å±‚æ„æ€äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œä½¿ç”¨ <code>ManuallyDrop</code>
æ¥è¿›ä¸€æ­¥èŠ‚çœå†…å­˜èµ„æºã€‚</p></li>
</ol>
<blockquote>
<p><code>std::mem::ManuallyDrop&lt;T&gt;</code>
æ˜¯ä¸€ä¸ªé›¶æˆæœ¬ï¼ˆzero-costï¼‰åŒ…è£…å™¨ã€‚å®ƒä¸æ”¹å˜ <code>T</code>
çš„å¸ƒå±€ï¼Œä¹Ÿä¸ä¼šäº§ç”Ÿé¢å¤–çš„å­—èŠ‚ï¼Œåœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œå¯ä»¥æ¯”
<code>Option&lt;T&gt;</code>
å°‘ä¸€äº›æ ‡è®°ä½å’Œå­—èŠ‚å¯¹é½æ‰€å æ®çš„é¢å¤–ç©ºé—´ã€‚å…·ä½“å¯å‚è€ƒï¼š<strong>é™„å½• 2.
ManuallyDrop&lt;T&gt;</strong>ã€‚</p>
</blockquote>
<pre class="mermaid">graph TB
    subgraph Stack ["æ ˆå†…å­˜ Stack"]
        ArcStruct["Arc&lt;T&gt;<br/>ptr: NonNull&lt;ArcData&lt;T&gt;&gt;"]
        WeakStruct["Weak&lt;T&gt;<br/>ptr: NonNull&lt;ArcData&lt;T&gt;&gt;"]
    end

    subgraph Heap ["å †å†…å­˜ Heap"]
        ArcDataStruct["ArcData&lt;T&gt;<br/>data_ref_count<br/>alloc_ref_count<br/>data"]
    end

    ArcStruct -->|ç›´æ¥æŒ‡å‘| ArcDataStruct
    WeakStruct -->|ç›´æ¥æŒ‡å‘| ArcDataStruct

    classDef stackStyle fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef heapStyle fill:#f3e5f5,stroke:#4a148c,stroke-width:2px

    class ArcStruct,WeakStruct stackStyle
    class ArcDataStruct heapStyle</pre>
<h3 id="ç»´æŠ¤å¼•ç”¨è®¡æ•°-2">ç»´æŠ¤å¼•ç”¨è®¡æ•°</h3>
<p>ä¿®æ”¹äº†å¼•ç”¨è®¡æ•°çš„è¯­ä¹‰åï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°æ€è€ƒå¦‚ä½•ç®¡ç†å¼•ç”¨è®¡æ•°ã€‚</p>
<ul>
<li>Clone:
<ul>
<li>å½“ <code>Weak&lt;T&gt;</code>
æ‹·è´æ—¶ï¼Œä»…å¢åŠ äº†å¼±å¼•ç”¨çš„æ•°é‡ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¾æ—§åªéœ€å¯¹
<code>alloc_ref_count</code> è¿›è¡Œè‡ªå¢ã€‚</li>
<li>å½“ <code>Arc&lt;T&gt;</code> æ‹·è´æ—¶ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±åªéœ€è¦å¯¹
<code>data_ref_count</code> è¿›è¡Œè‡ªå¢å³å¯ã€‚</li>
</ul></li>
<li>Drop:
<ul>
<li>å½“ <code>Arc&lt;T&gt;</code> è¢«é‡Šæ”¾æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å¯¹
<code>data_ref_count</code> è¿›è¡Œè‡ªå‡ã€‚å¦å¤–ï¼Œå¦‚æœæ˜¯æœ€åä¸€ä¸ª
<code>Arc&lt;T&gt;</code> è¢«é‡Šæ”¾ï¼Œæˆ‘ä»¬éœ€è¦é‡Šæ”¾ <code>data</code>
ï¼ŒåŒæ—¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦é‡Šæ”¾é‚£ä¸ªä»£è¡¨æ‰€æœ‰ <code>Arc</code> çš„éšå¼
<code>Weak</code>ã€‚</li>
<li>å½“ <code>Weak&lt;T&gt;</code>
è¢«é‡Šæ”¾æ—¶ï¼Œæˆ‘ä»¬ä»…éœ€å‡å°‘å¼±å¼•ç”¨çš„æ•°é‡ï¼Œå³å¯¹ <code>alloc_ref_count</code>
è¿›è¡Œè‡ªå‡ã€‚å¦å¤–ï¼Œå½“æœ€åä¸€ä¸ª <code>Weak&lt;T&gt;</code>
è¢«é‡Šæ”¾æ—¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è´Ÿè´£é‡Šæ”¾ <code>ArcData&lt;T&gt;</code> ã€‚</li>
</ul></li>
</ul>
<p>å…·ä½“çš„å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Clone</span> <span class="keyword">for</span> <span class="title class_">Weak</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">clone</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().alloc_ref_count.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Ordering::Relaxed) &gt; <span class="type">usize</span>::MAX / <span class="number">2</span> &#123;</span><br><span class="line">            std::process::<span class="title function_ invoke__">abort</span>();</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">Self</span> &#123; ptr: <span class="keyword">self</span>.ptr &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Clone</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">clone</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().data_ref_count.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Ordering::Relaxed) &gt; <span class="type">usize</span>::MAX / <span class="number">2</span> &#123;</span><br><span class="line">            std::process::<span class="title function_ invoke__">abort</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">Self</span> &#123; ptr: <span class="keyword">self</span>.ptr &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Drop</span> <span class="keyword">for</span> <span class="title class_">Weak</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">      	<span class="comment">// æ€è€ƒä¸‹è¿™é‡Œä¸ºä»€ä¹ˆè¦ç”¨ Releaseï¼Ÿåé¢æˆ‘ä»¬ä¼šæ­æ™“ï¼</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().alloc_ref_count.<span class="title function_ invoke__">fetch_sub</span>(<span class="number">1</span>, Ordering::Release) == <span class="number">1</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">fence</span>(Ordering::Acquire);</span><br><span class="line">            <span class="comment">// Safety: æœ€åä¸€ä¸ª Weak&lt;T&gt; å·²ç»è¢«é‡Šæ”¾äº†ã€‚</span></span><br><span class="line">            <span class="keyword">unsafe</span> &#123;</span><br><span class="line">                <span class="comment">// é‡Šæ”¾ ArcData&lt;T&gt;</span></span><br><span class="line">                <span class="title function_ invoke__">drop</span>(<span class="type">Box</span>::<span class="title function_ invoke__">from_raw</span>(<span class="keyword">self</span>.ptr.<span class="title function_ invoke__">as_ptr</span>()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Drop</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().data_ref_count.<span class="title function_ invoke__">fetch_sub</span>(<span class="number">1</span>, Ordering::Release) == <span class="number">1</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">fence</span>(Ordering::Acquire);</span><br><span class="line">            <span class="comment">// æœ€åä¸€ä¸ª `Arc` è¢«é‡Šæ”¾ï¼Œéœ€è¦åš 2 ä»¶äº‹æƒ…ï¼š</span></span><br><span class="line">            <span class="comment">// 1. é‡Šæ”¾ ArcData.data</span></span><br><span class="line">            <span class="comment">// 2. é‡Šæ”¾é‚£ä¸ªä»£è¡¨æ‰€æœ‰ `Arc` çš„éšå¼ `Weak`</span></span><br><span class="line">            <span class="keyword">unsafe</span> &#123;</span><br><span class="line">                ManuallyDrop::<span class="title function_ invoke__">drop</span>(&amp;<span class="keyword">mut</span> *<span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().data.<span class="title function_ invoke__">get</span>());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// åœ¨ `Weak` é‚£è¾¹ `drop()` çš„æ—¶å€™ï¼š</span></span><br><span class="line">            <span class="comment">// 1. ä¼šæ‰§è¡Œ alloc_ref_count--;</span></span><br><span class="line">            <span class="comment">// 2. å¦‚æœåˆšå¥½æ˜¯æœ€åä¸€ä¸ª `Weak`ï¼Œé‚£ä¼šé¡ºå¸¦é”€æ¯ `AraData`ã€‚</span></span><br><span class="line">            <span class="title function_ invoke__">drop</span>(Weak &#123; ptr: <span class="keyword">self</span>.ptr &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹äºè¿™ä¸ªéšå¼ <code>Weak&lt;T&gt;</code>ï¼Œå¦‚æœä½ ä¸€æ—¶æ— æ³•å¾ˆå¥½åœ° Get
åˆ°é‚£ä¸ªç‚¹ï¼Œå¯ä»¥å°è¯•æ‰‹åŠ¨å†™å†™æ•´ä¸ªå®ç°çš„è¿‡ç¨‹ï¼Œç›¸ä¿¡å¤šèµ°å‡ éæµç¨‹ï¼Œä½ ä¼šæœ‰é‚£ç§èŒ…å¡é¡¿å¼€çš„æ„Ÿè§‰ï¼</p>
<pre class="mermaid">flowchart TD
    subgraph Clone["Clone æ“ä½œ"]
        WeakClone["Weak&lt;T&gt;::clone()"]
        ArcClone["Arc&lt;T&gt;::clone()"]

        WeakClone --> WeakInc["alloc_ref_count.fetch_add(1)"]
        ArcClone --> ArcInc["data_ref_count.fetch_add(1)"]

        WeakInc --> WeakCheck{"è®¡æ•° > usize::MAX/2?"}
        ArcInc --> ArcCheck{"è®¡æ•° > usize::MAX/2?"}

        WeakCheck -->|æ˜¯| Abort1["std::process::abort()"]
        ArcCheck -->|æ˜¯| Abort2["std::process::abort()"]
        WeakCheck -->|å¦| WeakNew["è¿”å›æ–°çš„ Weak&lt;T&gt;"]
        ArcCheck -->|å¦| ArcNew["è¿”å›æ–°çš„ Arc&lt;T&gt;"]
    end

    subgraph Drop["Drop æ“ä½œ"]
        WeakDrop["Weak&lt;T&gt;::drop()"]
        ArcDrop["Arc&lt;T&gt;::drop()"]

        WeakDrop --> WeakDec["alloc_ref_count.fetch_sub(1, Release)"]
        ArcDrop --> ArcDec["data_ref_count.fetch_sub(1, Release)"]

        WeakDec --> WeakDropCheck{"è¿”å›å€¼ == 1?<br/>æœ€åä¸€ä¸ª Weak?"}
        ArcDec --> ArcDropCheck{"è¿”å›å€¼ == 1?<br/>æœ€åä¸€ä¸ª Arc?"}

        WeakDropCheck -->|æ˜¯| WeakFence["fence(Acquire)"]
        WeakDropCheck -->|å¦| WeakEnd["ç»“æŸ"]

        ArcDropCheck -->|æ˜¯| ArcFence["fence(Acquire)"]
        ArcDropCheck -->|å¦| ArcEnd["ç»“æŸ"]

        WeakFence --> WeakFree["é‡Šæ”¾ ArcData&lt;T&gt;<br/>Box::from_raw(ptr)"]

        ArcFence --> ArcDataFree["é‡Šæ”¾ data<br/>ManuallyDrop::drop()"]
        ArcDataFree --> ImplicitWeak["é‡Šæ”¾éšå¼ Weak<br/>drop(Weak { ptr })"]

        ImplicitWeak --> WeakDrop
    end

    subgraph Memory["å†…å­˜é‡Šæ”¾é¡ºåº"]
        Step1["â‘  Arc é‡Šæ”¾ data å†…å®¹"]
        Step2["â‘¡ Arc é‡Šæ”¾éšå¼ Weak"]
        Step3["â‘¢ Weak é‡Šæ”¾ ArcData ç»“æ„"]

        Step1 --> Step2
        Step2 --> Step3
    end

    classDef cloneStyle fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    classDef dropStyle fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef memStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef criticalStyle fill:#fce4ec,stroke:#880e4f,stroke-width:3px

    class WeakClone,ArcClone,WeakInc,ArcInc,WeakNew,ArcNew cloneStyle
    class WeakDrop,ArcDrop,WeakDec,ArcDec,WeakEnd,ArcEnd dropStyle
    class WeakFree,ArcDataFree,ImplicitWeak criticalStyle
    class Step1,Step2,Step3 memStyle</pre>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬é‡æ–°è¿è¡Œä¹‹å‰çš„æµ‹è¯•ç”¨ä¾‹
<code>arc_should_work()</code>ï¼Œå¯ä»¥å‘ç°çš„æˆåŠŸé€šè¿‡çš„ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬ç»§ç»­æ¥è°ƒæ•´ <code>get_mut</code>ã€<code>downgrade()</code> å’Œ
<code>upgrade()</code>ã€‚</p>
<h3 id="upgrade-1">upgrade()</h3>
<p><code>upgrade()</code> æ¯”è¾ƒç®€å•ï¼Œå®ƒçš„è§„åˆ™è¿˜æ˜¯ä¸å˜ï¼Œåªæœ‰å½“å­˜åœ¨
<code>Arc&lt;T&gt;</code> æ—¶ï¼Œå³ <code>data_ref_count&gt;0</code>
æ—¶ï¼Œæ‰èƒ½å‡çº§æˆåŠŸï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; Weak&lt;T&gt; &#123;</span><br><span class="line">  	<span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">upgrade</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;Arc&lt;T&gt;&gt; &#123;</span><br><span class="line">      	<span class="comment">// è·å– data_ref_count çš„å€¼ã€‚</span></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">n</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().data_ref_count.<span class="title function_ invoke__">load</span>(Ordering::Relaxed);</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">          	<span class="comment">// å¦‚æœä¸º 0ï¼Œè¡¨ç¤ºå·²ç»æ²¡æœ‰ Arc äº†ï¼Œå‡çº§å¤±è´¥ã€‚</span></span><br><span class="line">            <span class="keyword">if</span> n == <span class="number">0</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">assert!</span>(n &lt; <span class="type">usize</span>::MAX);</span><br><span class="line"></span><br><span class="line">          	<span class="comment">// å­˜åœ¨ Arcï¼Œåˆ™å¯¹ data_ref_count å°è¯•è¿›è¡Œ CAS åŠ  1ã€‚</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Err</span>(e) = <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().data_ref_count.<span class="title function_ invoke__">compare_exchange_weak</span>(</span><br><span class="line">                n,</span><br><span class="line">                n + <span class="number">1</span>,</span><br><span class="line">                Ordering::Relaxed,</span><br><span class="line">                Ordering::Relaxed,</span><br><span class="line">            ) &#123;</span><br><span class="line">              	<span class="comment">// CAS å¤±è´¥ï¼Œåˆ™é‡è¯•ã€‚</span></span><br><span class="line">                n = e;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          	<span class="comment">// CAS æˆåŠŸï¼Œåˆ™è¿”å›å‡çº§åçš„ Arcã€‚</span></span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">Some</span>(Arc &#123; ptr: <span class="keyword">self</span>.ptr &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="get_mut-1">get_mut()</h3>
<p>æ¥ä¸€ä¸‹æˆ‘ä»¬çœ‹
<code>get_mut</code>ï¼Œè§„åˆ™ä¹Ÿæ˜¯ä¸å˜ï¼š<strong>å½“å‰ä»…å½“åªæœ‰ä¸€ä¸ª
<code>Arc&lt;T&gt;</code>ï¼Œä¸”ä¸å­˜åœ¨ <code>Weak&lt;T&gt;</code>
æ—¶ï¼Œæ‰å¯ä»¥è¿”å›å¯å˜å¼•ç”¨ã€‚</strong></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸¤ä¸ªæ¡ä»¶</span></span><br><span class="line"><span class="comment">// 1. æ²¡æœ‰ Weak&lt;T&gt;</span></span><br><span class="line"><span class="comment">// 2. æ²¡æœ‰å…¶ä»–çš„ Arc&lt;T&gt;</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">get_mut</span>(arc: &amp;<span class="keyword">mut</span> Arc&lt;T&gt;) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;&amp;<span class="keyword">mut</span> T&gt; &#123;</span><br><span class="line">    <span class="comment">// å°† alloc_ref_count ä» 1 ç½®ä¸º usize::Maxã€‚</span></span><br><span class="line">    <span class="comment">//  å¦‚æœå¤±è´¥ï¼šè¯´æ˜ä¹‹å‰ä¸æ˜¯ 1ï¼Œå³å­˜åœ¨å…¶ä»–çš„ Weak&lt;T&gt;ï¼Œæ— æ³•è·å– &amp;mut Tï¼Œ None</span></span><br><span class="line">    <span class="comment">//  å¦‚æœæˆåŠŸï¼šè¯´æ˜å½“å‰æ²¡æœ‰ Weak&lt;T&gt;ï¼Œç¬¬ä¸€æ­¥æ ¡éªŒé€šè¿‡ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> arc</span><br><span class="line">        .<span class="title function_ invoke__">data</span>()</span><br><span class="line">        .alloc_ref_count</span><br><span class="line">        .<span class="title function_ invoke__">compare_exchange</span>(<span class="number">1</span>, <span class="type">usize</span>::MAX, Ordering::Acquire, Ordering::Relaxed)</span><br><span class="line">        .<span class="title function_ invoke__">is_err</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">is_unique</span> = arc.<span class="title function_ invoke__">data</span>().data_ref_count.<span class="title function_ invoke__">load</span>(Ordering::Relaxed) == <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡Šæ”¾ alloc_ref_count</span></span><br><span class="line">    arc.<span class="title function_ invoke__">data</span>().alloc_ref_count.<span class="title function_ invoke__">store</span>(<span class="number">1</span>, Ordering::Release);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœå­˜åœ¨å…¶ä»–çš„ Arcï¼Œåˆ™æ— æ³•è·å– &amp;mut Tï¼Œè¿”å› None</span></span><br><span class="line">    <span class="keyword">if</span> !is_unique &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸å­˜åœ¨å…¶ä»–çš„ Arcï¼Œè¿”å› &amp;mut T</span></span><br><span class="line">    <span class="title function_ invoke__">fence</span>(Ordering::Acquire);</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; <span class="title function_ invoke__">Some</span>(&amp;<span class="keyword">mut</span> *arc.<span class="title function_ invoke__">data</span>().data.<span class="title function_ invoke__">get</span>()) &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç çš„é€»è¾‘å°±ä¸èµ˜è¿°äº†ï¼Œä½†æ˜¯è¿™é‡Œæœ‰ <strong>3
ä¸ª</strong>åŸå­æ“ä½œçš„å†…å­˜é¡ºåºæˆ‘ä»¬éœ€è¦è®¨è®ºä¸€ä¸‹ï¼</p>
<p>åˆ†åˆ«æ˜¯ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å– Weak&lt;T&gt; çš„æ•°é‡å¹¶æš‚æ—¶é”å®š</span></span><br><span class="line">arc</span><br><span class="line">  .<span class="title function_ invoke__">data</span>()</span><br><span class="line">  .alloc_ref_count</span><br><span class="line">  .<span class="title function_ invoke__">compare_exchange</span>(<span class="number">1</span>, <span class="type">usize</span>::MAX, Ordering::Acquire, Ordering::Relaxed)</span><br></pre></td></tr></table></figure>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å– Arc&lt;T&gt; çš„æ•°é‡</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">is_unique</span> = arc.<span class="title function_ invoke__">data</span>().data_ref_count.<span class="title function_ invoke__">load</span>(Ordering::Relaxed) == <span class="number">1</span>;</span><br><span class="line">...</span><br><span class="line"><span class="title function_ invoke__">fence</span>(Ordering::Acquire);</span><br></pre></td></tr></table></figure>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é‡Šæ”¾ alloc_ref_count</span></span><br><span class="line">arc.<span class="title function_ invoke__">data</span>().alloc_ref_count.<span class="title function_ invoke__">store</span>(<span class="number">1</span>, Ordering::Release);</span><br></pre></td></tr></table></figure>
<hr />
<p>é¦–å…ˆçœ‹ç¬¬ 1 ä¸ªï¼Œæˆ‘ä»¬è¦åˆ¤æ–­å½“å‰æ˜¯å¦å·²ç»æ²¡æœ‰ <code>Weak&lt;T&gt;</code>
äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿è¯çœ‹åˆ°ä¹‹å‰æ‰€æœ‰ <code>drop(Weak&lt;T&gt;)</code>
çš„å†™å…¥æ“ä½œï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦å»ºç«‹èµ·ä¸€ä¸ª happens-beforeï¼Œå› æ­¤æˆ‘ä»¬ä¹‹å‰ä¸º
<code>Weak&lt;T&gt;</code> å®ç° <code>Drop</code> trait çš„æ—¶å€™ï¼Œä½¿ç”¨çš„æ˜¯
<code>Release</code>ï¼Œè€Œè¿™é‡Œï¼Œéœ€è¦ä½¿ç”¨ <code>Acquire</code>
æ¥è¿›è¡Œé…å¯¹ï¼Œå»ºç«‹ happens-beforeã€‚</p>
<hr />
<p>ç„¶åçœ‹ç¬¬ 2 ä¸ªï¼Œè¿™é‡Œæˆ‘ä»¬è¦åˆ¤æ–­æ˜¯å¦ä»…æœ‰ä¸€ä¸ª
<code>Arc&lt;T&gt;</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿è¯çœ‹åˆ°ä¹‹å‰æ‰€æœ‰
<code>drop&lt;Arc&lt;T&gt;</code> çš„å†™å…¥æ“ä½œï¼Œå› æ­¤æˆ‘ä»¬ä¹‹å‰ä¸º
<code>Arc&lt;T&gt;</code> å®ç° <code>Drop</code> trait çš„æ—¶å€™ï¼Œä½¿ç”¨çš„æ˜¯
<code>Release</code>ã€‚ä½†æ˜¯åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä»…éœ€åœ¨ä»…å‰© 1 ä¸ª <code>Arc</code>
çš„æ—¶å€™ï¼Œæ‰æœ‰å¿…è¦å»ºç«‹ happens-beforeï¼Œæ‰€ä»¥å½“ <code>is_unique=true</code>
æ—¶ï¼Œæˆ‘ä»¬è¡¥ä¸€ä¸ª <code>fence(Acquire)</code> å±éšœï¼Œæ¥å»ºç«‹è·Ÿ
<code>drop(Arc&lt;T&gt;)</code> çš„ happens-beforeã€‚</p>
<hr />
<p>åœ¨åˆ†æç¬¬ 3 ä¸ªä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ¥å°è¯•æŒ–ä¸€ä¸‹å½“å‰ <code>get_mut</code>
çš„æ¼æ´ï¼ç›¸ä¿¡æœ‰éƒ¨åˆ†è¯»è€…åœ¨çœ‹åˆ°ä¸Šè¿°å®ç°åï¼Œè·Ÿç¬”è€…ä¸€æ ·ï¼Œä¼šæœ‰ä¸€ä¸ªç–‘æƒ‘ï¼š<strong><font color="red">ä¸Šè¿°
2
ä¸ªæ¡ä»¶çš„æ£€æŸ¥ï¼Œå¹¶ä¸æ˜¯åŸå­çš„ï¼Œè¿™æ ·çš„æ£€æŸ¥è¿˜å®‰å…¨å¯é å—ï¼Ÿ</font></strong></p>
<p>æ¯”å¦‚è¯´ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">get_mut</span>(arc: &amp;<span class="keyword">mut</span> Arc&lt;T&gt;) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;&amp;<span class="keyword">mut</span> T&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> arc</span><br><span class="line">        .<span class="title function_ invoke__">data</span>()</span><br><span class="line">        .alloc_ref_count</span><br><span class="line">        .<span class="title function_ invoke__">compare_exchange</span>(<span class="number">1</span>, <span class="type">usize</span>::MAX, Ordering::Acquire, Ordering::Relaxed)</span><br><span class="line">        .<span class="title function_ invoke__">is_err</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &lt;------- åœ¨è¿™ä¸ªé—´éš™ï¼šå¦å¤–ä¸€ä¸ª Arc downgrade() -&gt; Weakï¼Œç„¶å drop(Arc)</span></span><br><span class="line">    <span class="comment">// &lt;------- é‚£å®ƒä¹Ÿæ˜¯æ£€æŸ¥é€šè¿‡çš„ã€‚</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">is_unique</span> = arc.<span class="title function_ invoke__">data</span>().data_ref_count.<span class="title function_ invoke__">load</span>(Ordering::Relaxed) == <span class="number">1</span>;</span><br><span class="line">    arc.<span class="title function_ invoke__">data</span>().alloc_ref_count.<span class="title function_ invoke__">store</span>(<span class="number">1</span>, Ordering::Release);</span><br><span class="line">    <span class="keyword">if</span> !is_unique &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">fence</span>(Ordering::Acquire);</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; <span class="title function_ invoke__">Some</span>(&amp;<span class="keyword">mut</span> *arc.<span class="title function_ invoke__">data</span>().data.<span class="title function_ invoke__">get</span>()) &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­ï¼š</p>
<ol type="1">
<li>å‡è®¾æˆ‘ä»¬å·²ç»é€šè¿‡äº†ç¬¬ä¸€ä¸ªæ£€æŸ¥ï¼›</li>
<li>åœ¨è¿›è¡Œç¬¬äºŒä¸ªæ£€æŸ¥ä¹‹å‰çš„è¿™ä¸ªé—´éš™ä¸­ï¼Œå­˜åœ¨å¦å¤–ä¸€ä¸ª
<code>Arc&lt;T&gt;</code>ï¼›</li>
<li>ç„¶åå®ƒé€šè¿‡ <code>downgrade()</code> ç”Ÿæˆäº†ä¸€ä¸ª
<code>Weak&lt;T&gt;</code>ï¼›</li>
<li>ç„¶åå† <code>drop(Arc&lt;T&gt;)</code>ï¼›</li>
<li>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å†æ£€æŸ¥ <code>Arc&lt;T&gt;</code> çš„æ—¶å€™ï¼Œä¼šå‘ç°åªæœ‰ 1
ä¸ªï¼Œæ£€æŸ¥å°±é€šè¿‡äº†ã€‚ä½†æ˜¯å…¶å®è¿™ä¸ªæ—¶å€™ï¼Œå­˜åœ¨äº†å…¶ä»–çš„
<code>Weak&lt;T&gt;</code>ï¼Œæ‰€ä»¥æ˜¯æœ‰é—®é¢˜çš„ï¼</li>
</ol>
<pre class="mermaid">sequenceDiagram
    participant A as T1 :get_mut()
    participant B as T2 :downgrade()+drop(Arc)
    participant C as ArcData

    A->>C: CAS alloc_ref 1â†’MAX âœ”
    Note over A,B: éåŸå­çª—å£
    B->>C: clone Weak <br> alloc_ref++ (Relaxed)
    B->>C: drop(Arc) <br> fetch_sub data_ref (Release)
    A->>C: load data_ref ==1 âœ”
    A->>C: store alloc_ref MAXâ†’1 (Release)
    A-->>A: fence(Acquire) â†’ è¿”å› &mut Tï¼ˆå·²å¤±æ•ˆï¼‰</pre>
<p>æ‰€ä»¥ï¼š<strong><font color="green">æˆ‘ä»¬ä¸èƒ½è®©
Â <code>downgrade()</code>Â 
åœ¨è¿™ä¸ªé—´éš™ä¸­æˆåŠŸæ‰§è¡Œï¼</font></strong>è¿™ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨å‰é¢å°†
<code>alloc_ref_count</code> ç½®ä¸º
<code>usize::Max</code>ï¼ˆä¸Šé”ï¼‰çš„åŸå› ï¼Œåœ¨åé¢çš„ <code>downgrade()</code>
ä¸­ï¼Œæˆ‘ä»¬è‚¯å®šè¦æ£€æŸ¥è¿™ä¸ªå€¼ï¼Œå¦‚æœ
<code>alloc_ref_count=usize::Max</code>ï¼Œå°±ä¸èƒ½ <code>downgrade()</code>
æˆåŠŸï¼Œç›´åˆ° <code>alloc_ref_store(1, _)</code> çš„æ—¶å€™ï¼Œæ‰èƒ½
<code>downgrade()</code> æˆåŠŸã€‚ä¸è¿‡è¿™ä¸ªæ—¶å€™å·²ç»æ™šäº†ï¼å¦‚æœæ˜¯è¿™æ ·ï¼Œé‚£
<code>is_unique</code> è‚¯å®šå°±ä¸ä¸º <code>true</code>ï¼Œæ‰€ä»¥ä¼šè¿”å›
<code>None</code>ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬ä¸ä¼šè¿”å›
<code>&amp;mut T</code>ï¼Œæ‰€ä»¥ï¼Œå±æœºå°±è§£é™¤äº†ï¼</p>
<h3 id="downgrade">downgrade()</h3>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ <code>downgrade()</code> çš„å®ç°ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; Arc&lt;T&gt; &#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">downgrade</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> Weak&lt;T&gt; &#123;</span><br><span class="line">        <span class="comment">// è·å– Weak çš„å¼•ç”¨è®¡æ•°</span></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">n</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().alloc_ref_count.<span class="title function_ invoke__">load</span>(Ordering::Relaxed);</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœä¸º usize::MAXï¼Œè¯´æ˜å·²ç»è¢«é”ä½äº†ï¼Œè¿™ä¸ªæ—¶å€™è‡ªæ—‹é‡è¯•ï¼</span></span><br><span class="line">            <span class="keyword">if</span> n == <span class="type">usize</span>::MAX &#123;</span><br><span class="line">                std::hint::<span class="title function_ invoke__">spin_loop</span>();</span><br><span class="line">                n = <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().alloc_ref_count.<span class="title function_ invoke__">load</span>(Ordering::Relaxed);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">assert!</span>(n &lt; <span class="type">usize</span>::MAX - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// alloc_ref_count æ²¡è¢«é”ä½ï¼Œå°è¯•è¿›è¡Œ +1 æ“ä½œã€‚</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Err</span>(e) = <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>().alloc_ref_count.<span class="title function_ invoke__">compare_exchange_weak</span>(</span><br><span class="line">                n,</span><br><span class="line">                n + <span class="number">1</span>,</span><br><span class="line">                Ordering::Acquire,</span><br><span class="line">                Ordering::Relaxed,</span><br><span class="line">            ) &#123;</span><br><span class="line">                <span class="comment">// +1 å¤±è´¥ï¼Œé‡è¯•ã€‚</span></span><br><span class="line">                n = e;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// +1 æˆåŠŸï¼Œè¡¨ç¤ºé™çº§æˆåŠŸï¼Œè¿”å› Weakã€‚</span></span><br><span class="line">            <span class="keyword">return</span> Weak &#123; ptr: <span class="keyword">self</span>.ptr &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>downgrade()</code> çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬è·Ÿ <code>get_mut</code>
é¥ç›¸å‘¼åº”ï¼š</p>
<ol type="1">
<li><p>å¦‚æœ
<code>alloc_ref_count=usize::MAX</code>ï¼Œè¯´æ˜è¢«é”ä½ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦è‡ªæ—‹ç­‰å¾…å¹¶é‡è¯•ã€‚</p>
<blockquote>
<p><code>std::hint::spin_loop()</code>ä¼šå‘ CPU å‘é€ç‰¹å®šæŒ‡ä»¤ï¼ˆå¦‚ x86 çš„
pause æˆ– ARM çš„ yieldï¼‰ï¼Œæç¤ºå½“å‰å¤„äºå¿™ç­‰å¾…çŠ¶æ€ï¼Œæœ‰åˆ©äºä¼˜åŒ– CPU
è¡Œä¸ºã€‚</p>
</blockquote></li>
<li><p>å¦‚æœ <code>alloc_ref_count</code> æ²¡è¢«é”ä½ï¼Œæˆ‘ä»¬å°è¯•è¿›è¡Œ
CASï¼Œè¿™é‡ŒæˆåŠŸçš„æ—¶å€™ä½¿ç”¨çš„ <code>Acquire</code>
ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿè¿™æ˜¯ä¸ºäº†è·Ÿå‰é¢è¿˜æœªè®¨è®ºçš„<strong>ç¬¬ 3 ä¸ªåŸå­æ“ä½œ</strong>å»ºç«‹
happens-beforeï¼</p></li>
</ol>
<p>ç°åœ¨æˆ‘ä»¬ç»ˆäºå¯ä»¥æ¥è§£å¼€è¿™ç¬¬ 3 ä¸ªåŸå­æ“ä½œçš„åŸå­é¡ºåºè°œå›¢äº†ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é‡Šæ”¾ alloc_ref_count</span></span><br><span class="line">arc.<span class="title function_ invoke__">data</span>().alloc_ref_count.<span class="title function_ invoke__">store</span>(<span class="number">1</span>, Ordering::Release);</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘ä»¬å¿…é¡»ä¿è¯è·Ÿ <code>download()</code> çš„
<code>compare_exchange(_,_,Acquire,_)</code> å»ºç«‹èµ· happens-before
å…³ç³»ï¼Œå³å°† <code>alloc_ref_count</code> ç½®ä¸º 1 çš„ç»“æœå¿…é¡»è¢«
<code>downgrade()</code> æ‰€åœ¨çš„çº¿ç¨‹çœ‹åˆ°ã€‚ä¸ç„¶çš„è¯ï¼Œè¿™é‡Œ
<code>compare_exchange</code> æˆåŠŸäº†ï¼Œå°† <code>alloc_ref_count</code>
ç½®ä¸º 2 äº†ï¼Œä½†æ˜¯ <code>get_mut</code> åˆå°†å…¶ç½®ä¸º 1 äº†ï¼Œå°±ä¹±å¥—äº†ï¼</p>
<h3 id="å®Œæ•´ä»£ç -1">å®Œæ•´ä»£ç </h3>
<p>åˆ°è¿™é‡Œæˆ‘ä»¬ç»ˆäºæ˜¯å®Œæˆäº† v3
ç‰ˆæœ¬çš„ä¼˜åŒ–å·¥ä½œäº†ï¼ŒçœŸæ£’ï¼ä»‹äºç¯‡å¹…å·²ç»å¤Ÿé•¿äº†ï¼Œè¿™é‡Œå°±ä¸å†è´´å‡ºå®Œæ•´çš„ä»£ç äº†ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥å‚é˜…ï¼š<a
target="_blank" rel="noopener" href="https://github.com/hedon-rust-road/conutils/blob/main/src/arc.rs">hedon-rust-road/conutils/arc</a>ã€‚</p>
<h2 id="æµ…æ¢æ ‡å‡†åº“çš„-arct">æµ…æ¢æ ‡å‡†åº“çš„ Arc&lt;T&gt;</h2>
<p>åœ¨æœ€åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ ‡å‡†åº“çš„ <code>Arc&lt;T&gt;</code>
æ˜¯å¦‚ä½•å®ç°çš„ï¼Œçœ‹æ–‡ç« å¼€å¤´è¯´çš„<strong>å®ç°ä¸€ä¸ªå¯ä»¥åª²ç¾æ ‡å‡†åº“çš„
<code>Arc&lt;T&gt;</code></strong> æ˜¯ä¸æ˜¯åœ¨å¹ç‰›ï¼</p>
<p>æ ‡å‡†åº“ï¼ˆrustc 1.87.0ï¼‰çš„ <code>Arc&lt;T&gt;</code> ä½äº <a
target="_blank" rel="noopener" href="https://github.com/rust-lang/rust/blob/1.87.0/library/alloc/src/sync.rs">sync.rs</a>
æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒçš„æ•°æ®ç»“æ„å®šä¹‰ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Arc</span>&lt;</span><br><span class="line">    T: ?<span class="built_in">Sized</span>,</span><br><span class="line">    <span class="meta">#[unstable(feature = <span class="string">&quot;allocator_api&quot;</span>, issue = <span class="string">&quot;32838&quot;</span>)]</span> A: Allocator = Global,</span><br><span class="line">&gt; &#123;</span><br><span class="line">    ptr: NonNull&lt;ArcInner&lt;T&gt;&gt;,</span><br><span class="line">    phantom: PhantomData&lt;ArcInner&lt;T&gt;&gt;,</span><br><span class="line">    alloc: A,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Weak</span>&lt;</span><br><span class="line">    T: ?<span class="built_in">Sized</span>,</span><br><span class="line">    <span class="meta">#[unstable(feature = <span class="string">&quot;allocator_api&quot;</span>, issue = <span class="string">&quot;32838&quot;</span>)]</span> A: Allocator = Global,</span><br><span class="line">&gt; &#123;</span><br><span class="line">    ptr: NonNull&lt;ArcInner&lt;T&gt;&gt;,</span><br><span class="line">    alloc: A,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä»–ä¸€äº›è«åå…¶å¦™çš„æ ‡è®°å’±å°±ä¸ç®¡äº†ï¼Œæ˜ å…¥çœ¼å¸˜å¯ä»¥çœ‹åˆ°ä¸€ä¸ª
<code>ArcInner</code>ï¼Œè¿™ä¸å°±æ˜¯å’±çš„ <code>ArcData</code>
å—ï¼ç‚¹è¿›å»çœ‹ä¸‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ArcInner</span>&lt;T: ?<span class="built_in">Sized</span>&gt; &#123;</span><br><span class="line">    strong: atomic::AtomicUsize,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// the value usize::MAX acts as a sentinel for temporarily &quot;locking&quot; the</span></span><br><span class="line">    <span class="comment">// ability to upgrade weak pointers or downgrade strong ones; this is used</span></span><br><span class="line">    <span class="comment">// to avoid races in `make_mut` and `get_mut`.</span></span><br><span class="line">    weak: atomic::AtomicUsize,</span><br><span class="line"></span><br><span class="line">    data: T,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¥½å®¶ä¼™ï¼è¿™ä¸å°±æ˜¯å’±çš„ <code>ArcData</code> !</p>
<ul>
<li><code>strong</code>: å¯¹åº”æˆ‘ä»¬çš„ <code>data_ref_count</code></li>
<li><code>weak</code>: å¯¹åº”æˆ‘ä»¬çš„ <code>alloc_ref_count</code></li>
</ul>
<p><code>weak</code>
å­—æ®µä¸Šé¢çš„æ³¨é‡Šä¹Ÿæ­ç¤ºäº†å…¶æ ¸å¿ƒé€»è¾‘è·Ÿå’±æ˜¯é«˜åº¦ä¸€è‡´çš„ï¼</p>
<p>æˆ‘ä»¬ç®€å•çœ‹ä¸‹æœ€é‡è¦çš„ <code>Drop</code> å’Œ <code>Clone</code>
çš„å®ç°ï¼Œå› ä¸ºè¿™æ¶‰åŠåˆ°å¼•ç”¨è®¡æ•°çš„ç»´æŠ¤ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> MAX_REFCOUNT: <span class="type">usize</span> = (<span class="type">isize</span>::MAX) <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Arc: Clone</span></span><br><span class="line"><span class="keyword">impl</span>&lt;T: ?<span class="built_in">Sized</span>, A: Allocator + <span class="built_in">Clone</span>&gt; <span class="built_in">Clone</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T, A&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">clone</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> Arc&lt;T, A&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">old_size</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">inner</span>().strong.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Relaxed); <span class="comment">// fetch_add</span></span><br><span class="line">        <span class="keyword">if</span> old_size &gt; MAX_REFCOUNT &#123; <span class="comment">// æº¢å‡ºä¿æŠ¤</span></span><br><span class="line">            <span class="title function_ invoke__">abort</span>();</span><br><span class="line">        &#125;</span><br><span class="line">      	<span class="comment">// è¿”å›</span></span><br><span class="line">        <span class="keyword">unsafe</span> &#123; <span class="keyword">Self</span>::<span class="title function_ invoke__">from_inner_in</span>(<span class="keyword">self</span>.ptr, <span class="keyword">self</span>.alloc.<span class="title function_ invoke__">clone</span>()) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Arc: Drop</span></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;<span class="meta">#[may_dangle]</span> T: ?<span class="built_in">Sized</span>, A: Allocator&gt; <span class="built_in">Drop</span> <span class="keyword">for</span> <span class="title class_">Arc</span>&lt;T, A&gt; &#123;</span><br><span class="line">    <span class="meta">#[inline]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="comment">// fetch_sub release å¼ºå¼•ç”¨</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="title function_ invoke__">inner</span>().strong.<span class="title function_ invoke__">fetch_sub</span>(<span class="number">1</span>, Release) != <span class="number">1</span> &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      	<span class="comment">// æœ€åä¸€ä¸ª Arc é‡Šæ”¾çš„æ—¶å€™ï¼Œè¡¥ä¸€ä¸ª fence(Acquire)ï¼Œ</span></span><br><span class="line">      	<span class="comment">// ä¸å‰é¢æ‰€æœ‰çš„ release å»ºç«‹ happens-beforeã€‚</span></span><br><span class="line">        acquire!(<span class="keyword">self</span>.<span class="title function_ invoke__">inner</span>().strong);</span><br><span class="line"></span><br><span class="line">      	<span class="comment">// æœ€åä¸€ä¸ª Arc é‡Šæ”¾çš„æ—¶å€™ï¼Œé‡Šæ”¾ ArcInner é‡Œé¢çš„ data</span></span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.<span class="title function_ invoke__">drop_slow</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Weak: Clone</span></span><br><span class="line"><span class="keyword">impl</span>&lt;T: ?<span class="built_in">Sized</span>, A: Allocator + <span class="built_in">Clone</span>&gt; <span class="built_in">Clone</span> <span class="keyword">for</span> <span class="title class_">Weak</span>&lt;T, A&gt; &#123;</span><br><span class="line">    <span class="meta">#[inline]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">clone</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> Weak&lt;T, A&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(inner) = <span class="keyword">self</span>.<span class="title function_ invoke__">inner</span>() &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">old_size</span> = inner.weak.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Relaxed); <span class="comment">// fetch_add å¼±å¼•ç”¨æ•°é‡</span></span><br><span class="line">            <span class="keyword">if</span> old_size &gt; MAX_REFCOUNT &#123; <span class="comment">// æº¢å‡ºä¿æŠ¤</span></span><br><span class="line">                <span class="title function_ invoke__">abort</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      	<span class="comment">// è¿”å› Weak</span></span><br><span class="line">        Weak &#123; ptr: <span class="keyword">self</span>.ptr, alloc: <span class="keyword">self</span>.alloc.<span class="title function_ invoke__">clone</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Weak: Drop</span></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;<span class="meta">#[may_dangle]</span> T: ?<span class="built_in">Sized</span>, A: Allocator&gt; <span class="built_in">Drop</span> <span class="keyword">for</span> <span class="title class_">Weak</span>&lt;T, A&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">inner</span> = <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(inner) = <span class="keyword">self</span>.<span class="title function_ invoke__">inner</span>() &#123; inner &#125; <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> inner.weak.<span class="title function_ invoke__">fetch_sub</span>(<span class="number">1</span>, Release) == <span class="number">1</span> &#123; <span class="comment">// fetch_sub release å¼±å¼•ç”¨</span></span><br><span class="line">            acquire!(inner.weak);  <span class="comment">// æœ€åä¸€ä¸ªè¡¥ä¸€ä¸ª fence(acquire)</span></span><br><span class="line">            <span class="keyword">unsafe</span> &#123;  <span class="comment">// é‡Šæ”¾ ArcInner</span></span><br><span class="line">                <span class="keyword">self</span>.alloc.<span class="title function_ invoke__">deallocate</span>(<span class="keyword">self</span>.ptr.<span class="title function_ invoke__">cast</span>(), Layout::for_value_raw(<span class="keyword">self</span>.ptr.<span class="title function_ invoke__">as_ptr</span>()))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°è·Ÿå’±å‰é¢çš„å®ç°æ˜¯ä¸€æ ·ä¸€æ ·çš„ï¼ä¸ºå•¥ï¼Ÿå› ä¸º <a
target="_blank" rel="noopener" href="https://marabos.nl/atomics/">Rust Atomics and Locks</a>
ä¸€ä¹¦çš„ä½œè€…<a target="_blank" rel="noopener" href="https://github.com/m-ou-se">Mara Bos</a> å°±æ˜¯ Rust
æ ‡å‡†åº“å›¢é˜Ÿçš„é¢†å¯¼ä¹‹ä¸€ï¼ç‰›é€¼ï¼</p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>é€šè¿‡ä¸‰è½®è¿­ä»£ï¼Œæˆ‘ä»¬ä¸ä»…å®ç°äº†ä¸€ä¸ªåª²ç¾äº†æ ‡å‡†åº“çš„
<code>Arc&lt;T&gt;</code> ï¼Œè¿˜æ›´è¿›ä¸€æ­¥ä½“éªŒäº† <strong>Rust
å¹¶å‘æŠ½è±¡çš„è®¾è®¡å“²å­¦</strong>ï¼š</p>
<ul>
<li><strong>v0 â€”â€” èƒ½ç”¨</strong>ï¼šå•è®¡æ•° <code>ArcData&lt;T&gt;</code>
è§£å†³äº†è·¨çº¿ç¨‹å¤šæ‰€æœ‰æƒï¼Œä½†ä»ç¼ºä¹å¯å˜è§†å›¾ä¸æ–­ç¯èƒ½åŠ›ã€‚</li>
<li><strong>v1 â€”â€” èƒ½æ”¹</strong>ï¼šå€ŸåŠ©ç‹¬å 
<code>&amp;mut Arc&lt;T&gt;</code> + åŸå­ <em>é”</em>ï¼Œåœ¨
<strong>ä¸ç ´åå¹¶å‘å®‰å…¨</strong> çš„å‰æä¸‹å¼€æ”¾äº†
<code>get_mut</code>ã€‚</li>
<li><strong>v2 â€”â€” èƒ½å›æ”¶</strong>ï¼šåŒè®¡æ•° + <code>Weak&lt;T&gt;</code>
æ¶ˆé™¤äº†çˆ¶å­äº’æŒ‡é€ æˆçš„æ³„æ¼ï¼Œå±•ç¤ºäº† <em>å¼±å¼•ç”¨</em>
åœ¨æ‰€æœ‰æƒå›¾ä¸­çš„ä»·å€¼ã€‚</li>
<li><strong>v3 â€”â€” æ›´è½»å·§</strong>ï¼šå°† <code>Weak</code> ç‹¬ç«‹ã€ç”¨
<code>ManuallyDrop</code> æ›¿æ¢
<code>Option&lt;T&gt;</code>ï¼Œè®©æ²¡æœ‰å¾ªç¯å¼•ç”¨éœ€æ±‚çš„åœºæ™¯ä¸å†ä¸ºå¼±å¼•ç”¨ä¹°å•ã€‚</li>
</ul>
<p>ä¸‹ç¯‡æˆ‘ä»¬å°†å°è¯•å®ç°ä¸€ä¸ª <code>Mutex&lt;T&gt;</code>ï¼Œæ•¬è¯·æœŸå¾…ï¼</p>
<p>Happy Coding! Peace~</p>
<h2 id="é™„å½•">é™„å½•</h2>
<h3 id="nonnullt">1. NonNull&lt;T&gt;</h3>
<p><code>std::ptr::NonNull&lt;T&gt;</code> æ˜¯ä¸€ä¸ª
<strong>é›¶æˆæœ¬ã€éç©ºã€åå˜</strong>
çš„è£¸æŒ‡é’ˆåŒ…è£…å™¨ã€‚å®ƒæœ¬è´¨ä¸Šåªæ˜¯æŠŠä¸€ä¸ªåŸå§‹æŒ‡é’ˆå¡è¿›
<code>#[repr(transparent)]</code> çš„æ–°ç±»å‹ä¸­ï¼Œä½†å¼ºåˆ¶ä¿è¯
<strong>ç»ä¸ä¸ºç©º</strong>ï¼Œå› æ­¤å¯ä»¥æ‹¿åˆ°ã€Œç©ºå€¼å½“ä½œæšä¸¾åˆ¤åˆ«ä½ã€è¿™ä»½é¢å¤–ä¿¡æ¯
â€”â€” <code>Option&lt;NonNull&lt;T&gt;&gt;</code>
ä¸ä¸€ä¸ªæ™®é€šæŒ‡é’ˆå ç”¨åŒæ ·å¤§å°ã€‚</p>
<p>é‡è¦ç‰¹æ€§ï¼š</p>
<ul>
<li><strong>æ°¸è¿œéç©º</strong>ï¼šåˆ›å»ºæ—¶è‹¥ä¼ å…¥ç©ºæŒ‡é’ˆå³è§¦å‘
<strong>æœªå®šä¹‰è¡Œä¸º</strong>ã€‚ç¼–è¯‘å™¨å¯ä¾èµ–è¿™ä¸€ç‚¹åšä¼˜åŒ–ï¼Œä¾‹å¦‚æŠŠ
<code>Option&lt;NonNull&lt;T&gt;&gt;</code> åˆå¹¶ä¸ºä¸€ä¸ªæŒ‡é’ˆå®½åº¦ã€‚</li>
<li><strong>åå˜</strong>ï¼šä¸ <code>*mut T</code>
ä¸åŒï¼Œ<code>NonNull&lt;T&gt;</code> å¯ä»¥åœ¨
<code>U: Deref&lt;Target = T&gt;</code>
çš„åœºæ™¯ä¸‹å®‰å…¨å‘å­ç±»å‹è½¬æ¢ï¼ˆå› ä¸ºç¦æ­¢ç©ºå€¼å¸¦æ¥äº†é¢å¤–ä¿è¯ï¼‰ï¼Œè¿™ä½¿å®ƒéå¸¸é€‚åˆæ„å»ºè‡ªå®šä¹‰æ™ºèƒ½æŒ‡é’ˆã€‚</li>
<li><strong>æ— è‡ªåŠ¨ Drop</strong>ï¼š<code>NonNull</code>
åªå­˜åœ°å€ï¼Œä¸æŒæœ‰æ‰€æœ‰æƒï¼›é”€æ¯ä¸é‡Šæ”¾å†…å­˜ä»ç”±å¤–éƒ¨é€»è¾‘å†³å®šï¼ˆå¦‚
<code>Box::from_raw</code>ã€<code>Vec::dealloc</code> ç­‰ï¼‰ã€‚</li>
</ul>
<p>æˆ‘ä»¬å°†å…¶ä¸è£¸æŒ‡é’ˆã€ <code>Box&lt;T&gt;</code> æ™ºèƒ½æŒ‡é’ˆå’Œå¼•ç”¨
<code>&amp;T</code> åšä¸€ä¸ªç®€å•çš„æ¯”è¾ƒï¼š</p>
<table>
<colgroup>
<col style="width: 22%" />
<col style="width: 21%" />
<col style="width: 39%" />
<col style="width: 15%" />
</colgroup>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th><code>*mut T</code> / <code>*const T</code></th>
<th><code>NonNull&lt;T&gt;</code></th>
<th><code>Box&lt;T&gt;</code> / <code>&amp;T</code></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>æ˜¯å¦å…è®¸ä¸ºç©º</strong></td>
<td>âœ…</td>
<td><strong>âŒ å¿…é¡»éç©º</strong></td>
<td>ä¸é€‚ç”¨</td>
</tr>
<tr>
<td><strong>åå˜æ€§</strong></td>
<td><code>*mut</code> ä¸åå˜</td>
<td><strong>åå˜</strong>ï¼ˆå¯å®‰å…¨å‘å­ç±»å‹è½¬æ¢ï¼‰</td>
<td><code>&amp;T</code> åå˜</td>
</tr>
<tr>
<td><strong>Option ä¼˜åŒ–</strong></td>
<td>âŒ å¤š 1 B åˆ¤åˆ«å­—èŠ‚</td>
<td><strong>âœ… ä¸è£¸æŒ‡é’ˆåŒå°ºå¯¸</strong></td>
<td>å·²è‡ªå¸¦ä¼˜åŒ–</td>
</tr>
<tr>
<td><strong>æ‰€æœ‰æƒ / drop è´£ä»»</strong></td>
<td>æ²¡æœ‰</td>
<td>æ²¡æœ‰ï¼ˆçº¯æŒ‡é’ˆï¼‰</td>
<td>æœ‰</td>
</tr>
<tr>
<td><strong>Send / Sync</strong></td>
<td>ä¸ <code>T</code> æ— å…³</td>
<td>é»˜è®¤ <code>!Send !Sync</code></td>
<td>å–å†³äº <code>T</code></td>
</tr>
<tr>
<td><strong>å¸¸è§ç”¨é€”</strong></td>
<td>FFIã€åº•å±‚ç®—æ³•</td>
<td><strong>æ™ºèƒ½æŒ‡é’ˆå†…éƒ¨ã€ä¾µå…¥å¼å®¹å™¨ã€è£æ‰ç©ºåˆ¤</strong></td>
<td>é«˜å±‚æ‰€æœ‰æƒæ¨¡å‹</td>
</tr>
</tbody>
</table>
<p>å…³é”®çš„ APIï¼š</p>
<table>
<colgroup>
<col style="width: 5%" />
<col style="width: 43%" />
<col style="width: 51%" />
</colgroup>
<thead>
<tr>
<th>åˆ†ç»„</th>
<th>ä»£è¡¨æ–¹æ³•</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>æ„é€ </strong></td>
<td><code>NonNull::new(ptr)</code> â†’
<code>Option&lt;NonNull&lt;T&gt;&gt;</code>
<br><code>unsafe &#123; NonNull::new_unchecked(ptr) &#125;</code>
<br><code>NonNull::dangling()</code></td>
<td>å®‰å…¨ / ä¸å®‰å…¨ / å ä½</td>
</tr>
<tr>
<td><strong>å¼•ç”¨è§†å›¾</strong></td>
<td><code>unsafe</code> <br><code>fn as_ref</code> /
<code>as_mut</code></td>
<td>æŠŠè£¸æŒ‡é’ˆä¸´æ—¶å€Ÿç”¨æˆ <code>&amp;T</code> /
<code>&amp;mut T</code></td>
</tr>
<tr>
<td><strong>è£¸æŒ‡é’ˆäº’è½¬</strong></td>
<td><code>fn as_ptr</code></td>
<td>å–å› <code>*mut T</code>ï¼Œè§£å¼•ç”¨ä»éœ€ <code>unsafe</code></td>
</tr>
<tr>
<td><strong>ç±»å‹è½¬æ¢</strong></td>
<td><code>fn cast&lt;U&gt;</code> <br><code>fn cast_mut</code> /
<code>cast_const</code></td>
<td>ä¿ç•™åœ°å€ï¼Œæ¢ç±»å‹æˆ–å¯å˜æ€§</td>
</tr>
<tr>
<td><strong>åœ°å€è¿ç®—</strong></td>
<td><code>unsafe fn add / byte_add / sub / offset</code></td>
<td>æŒ‡é’ˆç®—æœ¯ï¼Œä¸ <code>ptr::add</code> æ—ä¸€è‡´</td>
</tr>
<tr>
<td><strong>åˆ‡ç‰‡åŠ©æ‰‹</strong></td>
<td><code>NonNull::slice_from_raw_parts(data, len)</code>
<br><code>fn len()</code></td>
<td>1.70+ ç¨³å®šï¼Œä¸º <code>[T]</code> æä¾›éç©ºè£¸åˆ‡ç‰‡æ„é€  (<a
target="_blank" rel="noopener" href="https://rustwiki.org/zh-CN/std/ptr/struct.NonNull.html?utm_source=chatgpt.com">rustwiki.org</a>)</td>
</tr>
</tbody>
</table>
<blockquote>
<p>âš ï¸ ä»»ä½•æŠŠ <code>NonNull</code> é‡æ–°è§£é‡Šä¸ºå¼•ç”¨æˆ–è§£å¼•ç”¨çš„æ“ä½œï¼Œéƒ½å¿…é¡»åœ¨
<code>unsafe</code> å—é‡Œæ‰‹åŠ¨ä¿è¯å†…å­˜æœ‰æ•ˆæ€§ä¸åˆ«åè§„åˆ™ã€‚</p>
</blockquote>
<p>å…¸å‹ä½¿ç”¨åœºæ™¯ï¼š</p>
<table>
<colgroup>
<col style="width: 36%" />
<col style="width: 63%" />
</colgroup>
<thead>
<tr>
<th>åœºæ™¯</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>æ™ºèƒ½æŒ‡é’ˆå†…éƒ¨å®ç°</strong>
(<code>Box</code>/<code>Rc</code>/<code>Arc</code>)</td>
<td>éœ€è¦ <em>éç©º</em> åŸå§‹æŒ‡é’ˆå­˜æ”¾è¢«ç®¡å¯¹è±¡ï¼Œä¸”è¦åœ¨ <code>Option</code>
ç­‰åœºæ™¯ä¸‹èŠ‚çœç©ºé—´</td>
</tr>
<tr>
<td><strong>è‡ªç ”ä¾µå…¥å¼é“¾è¡¨ / çº¢é»‘æ ‘</strong></td>
<td>èŠ‚ç‚¹è‡ªèº«æŒæœ‰å‰åæŒ‡é’ˆå­—æ®µ
<code>NonNull&lt;Node&lt;T&gt;&gt;</code>ï¼Œå¤©ç„¶é¿å…ç©ºåˆ¤åˆ†æ”¯</td>
</tr>
<tr>
<td><strong>æƒ°æ€§åˆå§‹åŒ– / <code>Vec::new</code></strong></td>
<td>å…ˆç”¨ <code>NonNull::dangling()</code>
å ä½ï¼Œç­‰çœŸæ­£åˆ†é…åå†å†™å…¥æ­£ç¡®åœ°å€</td>
</tr>
<tr>
<td><strong>FFI</strong></td>
<td>C API æ˜ç¡®ä¿è¯å‚æ•°æ°¸ä¸ä¸ºç©ºæ—¶ï¼Œç”¨ <code>NonNull</code>
åœ¨ç±»å‹å±‚é¢è¡¨è¾¾å‰ç½®æ¡ä»¶</td>
</tr>
<tr>
<td><strong>è‡ªå¼•ç”¨ç»“æ„ï¼ˆPin å·¥ä½œåŒºï¼‰</strong></td>
<td>åœ¨å®ŒæˆçœŸæ­£åˆå§‹åŒ–å‰ä½¿ç”¨ <code>NonNull::dangling()</code>
ä¿å­˜æŒ‡å‘è‡ªèº«å­—æ®µçš„æŒ‡é’ˆ</td>
</tr>
</tbody>
</table>
<h3 id="manuallydropt">2. ManuallyDrop&lt;T&gt;</h3>
<p><code>std::mem::ManuallyDrop&lt;T&gt;</code>
æ˜¯ä¸€ä¸ªé›¶æˆæœ¬ï¼ˆzero-costï¼‰åŒ…è£…å™¨ã€‚æŠŠå€¼åŒ…åœ¨ <code>ManuallyDrop</code>
é‡Œä¼šå‘Šè¯‰ç¼–è¯‘å™¨ï¼š<strong>è¯·ä¸è¦åœ¨ä½œç”¨åŸŸç»“æŸæ—¶è‡ªåŠ¨è°ƒç”¨å®ƒçš„
<code>Drop</code>
å®ç°ï¼Œä»€ä¹ˆæ—¶å€™é‡Šæ”¾ï¼ˆæˆ–æ˜¯å¦é‡Šæ”¾ï¼‰ç”±æˆ‘æ‰‹åŠ¨å†³å®šã€‚</strong></p>
<ul>
<li><code>ManuallyDrop&lt;T&gt;</code> åªæ˜¯æŠŠ <strong>"æ˜¯å¦è‡ªåŠ¨
drop"</strong> è¿™ä¸€è¯­ä¹‰ä»ç¼–è¯‘å™¨æ¬åˆ°äº†ç¨‹åºå‘˜èº«ä¸Šï¼›</li>
<li>å®ƒ<strong>ä¸æ”¹å˜</strong> <code>T</code>
çš„å¸ƒå±€ï¼Œä¹Ÿä¸ä¼šäº§ç”Ÿé¢å¤–çš„å­—èŠ‚ï¼Œå› æ­¤æ˜¯é›¶å¼€é”€ï¼›</li>
<li><strong>unsafe
è´£ä»»</strong>ï¼šä½ å¿…é¡»ä¿è¯ä¸€ä»½å€¼<strong>æ°å¥½ææ„ä¸€æ¬¡</strong>ï¼ˆä¸èƒ½æ¼æ‰ï¼Œä¹Ÿä¸èƒ½å¤šè°ƒï¼‰ã€‚</li>
</ul>
<p>å®ƒçš„æ ¸å¿ƒ API å¦‚è¡¨æ‰€ç¤ºï¼š</p>
<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 32%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th>API</th>
<th>ä½œç”¨</th>
<th>é‡è¦æ³¨æ„ç‚¹</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong><code>ManuallyDrop::new(value)</code></strong></td>
<td>æŠŠ <code>T</code> åŒ…è£…æˆ
<code>ManuallyDrop&lt;T&gt;</code>ï¼Œå…³é—­è‡ªåŠ¨ææ„</td>
<td>é›¶å¼€é”€ï¼›ä¹‹åéœ€æ˜¾å¼ drop æˆ–ç§»åŠ¨èµ°</td>
</tr>
<tr>
<td><strong><code>ManuallyDrop::drop(&amp;mut self)</code></strong>
<em>(unsafe)</em></td>
<td>æ‰‹åŠ¨è§¦å‘å†…éƒ¨å€¼çš„ææ„</td>
<td>å¿…é¡»ä¿è¯ä¹‹åä¸ä¼šå†è®¿é—® / å† drop</td>
</tr>
<tr>
<td><strong><code>ManuallyDrop::take(&amp;mut self)</code></strong>
<em>(unsafe)</em></td>
<td>ä»åŒ…è£…é‡Œ"æ¬èµ°"å€¼ï¼ˆç­‰ä»·äº <code>ptr::read</code>ï¼‰</td>
<td><code>v</code> é‡Œç•™ä¸‹æœªåˆå§‹åŒ–å†…å­˜ï¼Œä¸èƒ½å†ç”¨æˆ–å† drop</td>
</tr>
<tr>
<td><strong><code>ManuallyDrop::into_inner(self)</code></strong>
<em>(unsafe)</em></td>
<td>æ¶ˆè´¹ <code>ManuallyDrop</code> è¿”å›å†…éƒ¨å€¼</td>
<td>å–å¾—æ‰€æœ‰æƒåï¼ŒåŸåŒ…è£…å·²è¢«ç§»èµ°ï¼ˆä¸ä¼š double-dropï¼‰</td>
</tr>
</tbody>
</table>

<div class="article-footer fs14">
    <section id="references">
      <div class="header"><span>å‚è€ƒèµ„æ–™</span></div>
      <div class="body">
        <ul>
        <li class="post-title">
          <p><a target="_blank" rel="noopener" href="https://marabos.nl/atomics/">Rust Atomics and Locks</a></p>

        </li>
        
        <li class="post-title">
          <p><a target="_blank" rel="noopener" href="https://doc.rust-lang.org/book/">Rust Programming
Language</a></p>

        </li>
        
        <li class="post-title">
          <p><a href="https://hedon.top/2024/11/11/rust-memory-order/">Rust
åŸç†ä¸¨èŠä¸€èŠ Rust çš„ Atomic å’Œå†…å­˜é¡ºåº</a></p>

        </li>
        
        <li class="post-title">
          <p><a href="https://hedon.top/2025/05/13/rust-action-spinlock/">Rust
å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª SpinLock</a></p>

        </li>
        
        <li class="post-title">
          <p><a
href="https://hedon.top/2025/05/29/rust-action-oneshot-channel/">Rust
å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª oneshot channel</a></p>

        </li>
        </ul>
      </div>
    </section>
    
    <section id="license">
      <div class="header"><span>è®¸å¯åè®®</span></div>
      <div class="body"><p>æœ¬æ–‡é‡‡ç”¨ <a
target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº«
4.0 å›½é™…</a> è®¸å¯åè®®ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>
</div>
    </section>
    
    <section id="share">
      <div class="header"><span>åˆ†äº«æ–‡ç« </span></div>
      <div class="body">
        <div class="link"><input class="copy-area" readonly="true" id="copy-link" value="https://hedon.top/2025/06/03/rust-action-arc/" /></div>
        <div class="social-wrap dis-select"><a class="social share-item wechat" onclick="util.toggle(&quot;qrcode-wechat&quot;)"><img class="lazy"  src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/b32ef3da1162a.svg" /></a><a class="social share-item weibo" target="_blank" rel="external nofollow noopener noreferrer" href="https://service.weibo.com/share/share.php?url=https://hedon.top/2025/06/03/rust-action-arc/&title=Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª Arc - HedonWang&pics=/banner/rust-action-arc.jpg&summary=æœ¬æ–‡æ‰‹æŠŠæ‰‹å¸¦ä½ æ‹†è§£å¹¶é‡æ„ Arcï¼šä»å•çº¿ç¨‹å¼•ç”¨è®¡æ•°ï¼Œåˆ°è·¨çº¿ç¨‹ Weak é˜²ç¯ï¼Œå†åˆ°å‰¥ç¦»å¼º/å¼±å¼•ç”¨ä¸å†…å­˜åºä¼˜åŒ–ï¼Œå±‚å±‚æ·±å…¥ Rust å¹¶å‘ä¸å†…å­˜æ¨¡å‹æ ¸å¿ƒã€‚"><img class="lazy"  src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/80c07e4dbb303.svg" /></a><a class="social share-item email" href="mailto:?subject=Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª Arc - HedonWang&amp;body=https://hedon.top/2025/06/03/rust-action-arc/"><img class="lazy"  src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/a1b00e20f425d.svg" /></a><a class="social share-item link" onclick="util.copy(&quot;copy-link&quot;, &quot;å¤åˆ¶æˆåŠŸ&quot;)"><img class="lazy"  src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/8411ed322ced6.svg" /></a></div>
        
        <div class="qrcode" id="qrcode-wechat" style="opacity:0;height:0">
          <img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=https://hedon.top/2025/06/03/rust-action-arc/"/>
        </div>
        
      </div>
    </section>
    </div>
</article>
<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">è¾ƒæ–°æ–‡ç« </div><a href="/2025/06/05/rust-atomic-in-processor/">Rust åŸç†ä¸¨ä»æ±‡ç¼–è§’åº¦çœ‹åŸå­æ“ä½œ</a></div><div class="item" id="next"><div class="note">è¾ƒæ—©æ–‡ç« </div><a href="/2025/05/29/rust-action-oneshot-channel/">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª oneshot channel</a></div></section></div>




  <div class="related-wrap md-text" id="comments">
    <section class='header cmt-title cap theme'>
      <p>å¿«æ¥å‚ä¸è®¨è®ºå§~</p>

    </section>
    <section class='body cmt-body giscus'>
      

<svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg>

<div id="giscus" src="https://giscus.app/client.js" data-repo="hedon954/hedonspace" data-repo-id="R_kgDOKt17sQ" data-category="Q&A" data-category-id="DIC_kwDOKt17sc4CbAt-" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous"></div>

    </section>
  </div>



<footer class="page-footer footnote"><hr><div class="text"><p>æœ¬ç«™ç”± <a href="/">Hedon Wang</a> ä½¿ç”¨ <a
target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.29.1">Stellar
1.29.1</a> ä¸»é¢˜åˆ›å»ºã€‚ æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a
target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA
4.0</a> è®¸å¯åè®®ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper toc" id="data-toc" collapse="false"><div class="widget-header dis-select"><span class="name">æœ¬æ–‡ç›®å½•</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#arc-%E7%AE%80%E4%BB%8B"><span class="toc-text">Arc ç®€ä»‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BB%E5%AE%8C%E6%9C%AC%E7%AF%87%E4%BD%A0%E8%83%BD%E5%AD%A6%E5%88%B0%E4%BB%80%E4%B9%88"><span class="toc-text">è¯»å®Œæœ¬ç¯‡ä½ èƒ½å­¦åˆ°ä»€ä¹ˆ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#v0-%E5%9F%BA%E7%A1%80%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0"><span class="toc-text">v0: åŸºç¡€å¼•ç”¨è®¡æ•°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-text">æ•°æ®ç»“æ„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%B4%E6%8A%A4%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0"><span class="toc-text">ç»´æŠ¤å¼•ç”¨è®¡æ•°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81"><span class="toc-text">å®Œæ•´ä»£ç </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="toc-text">å•å…ƒæµ‹è¯•</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#v1-%E5%AE%9E%E7%8E%B0-get_mut-%E8%8E%B7%E5%8F%96%E5%8F%AF%E5%8F%98%E5%BC%95%E7%94%A8"><span class="toc-text">v1: å®ç° get_mut è·å–å¯å˜å¼•ç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#v2-%E5%BC%B1%E6%8C%87%E9%92%88-weakt-%E8%A7%A3%E5%86%B3%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8"><span class="toc-text">v2: å¼±æŒ‡é’ˆ Weak&lt;T&gt;
è§£å†³å¾ªç¯å¼•ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-text">å¾ªç¯å¼•ç”¨é—®é¢˜åˆ†æ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-1"><span class="toc-text">æ•°æ®ç»“æ„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%B4%E6%8A%A4%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0-1"><span class="toc-text">ç»´æŠ¤å¼•ç”¨è®¡æ•°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#get_mut"><span class="toc-text">get_mut()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dowgrade"><span class="toc-text">dowgrade()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#upgrade"><span class="toc-text">upgrade()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#v3-%E5%88%86%E7%A6%BB%E5%BC%BA%E5%BC%B1%E5%BC%95%E7%94%A8%E9%81%BF%E5%85%8D%E6%97%A0%E7%94%A8%E6%B6%88%E8%80%97"><span class="toc-text">v3: åˆ†ç¦»å¼ºå¼±å¼•ç”¨ï¼Œé¿å…æ— ç”¨æ¶ˆè€—</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-2"><span class="toc-text">æ•°æ®ç»“æ„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%B4%E6%8A%A4%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0-2"><span class="toc-text">ç»´æŠ¤å¼•ç”¨è®¡æ•°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#upgrade-1"><span class="toc-text">upgrade()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#get_mut-1"><span class="toc-text">get_mut()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#downgrade"><span class="toc-text">downgrade()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81-1"><span class="toc-text">å®Œæ•´ä»£ç </span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%85%E6%8E%A2%E6%A0%87%E5%87%86%E5%BA%93%E7%9A%84-arct"><span class="toc-text">æµ…æ¢æ ‡å‡†åº“çš„ Arc&lt;T&gt;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">æ€»ç»“</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%E5%BD%95"><span class="toc-text">é™„å½•</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nonnullt"><span class="toc-text">1. NonNull&lt;T&gt;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#manuallydropt"><span class="toc-text">2. ManuallyDrop&lt;T&gt;</span></a></li></ol></li></ol></div><div class="widget-footer">

<a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 12c0-4.714 0-7.071 1.464-8.536C4.93 2 7.286 2 12 2c4.714 0 7.071 0 8.535 1.464C22 4.93 22 7.286 22 12c0 4.714 0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12Z"/><path stroke-linecap="round" stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/></g></svg><span>å›åˆ°é¡¶éƒ¨</span></a><a class="buttom" onclick="util.scrollComment()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M10.46 1.25h3.08c1.603 0 2.86 0 3.864.095c1.023.098 1.861.3 2.6.752a5.75 5.75 0 0 1 1.899 1.899c.452.738.654 1.577.752 2.6c.095 1.004.095 2.261.095 3.865v1.067c0 1.141 0 2.036-.05 2.759c-.05.735-.153 1.347-.388 1.913a5.75 5.75 0 0 1-3.112 3.112c-.805.334-1.721.408-2.977.43a10.81 10.81 0 0 0-.929.036c-.198.022-.275.054-.32.08c-.047.028-.112.078-.224.232c-.121.166-.258.396-.476.764l-.542.916c-.773 1.307-2.69 1.307-3.464 0l-.542-.916a10.605 10.605 0 0 0-.476-.764c-.112-.154-.177-.204-.224-.232c-.045-.026-.122-.058-.32-.08c-.212-.023-.49-.03-.93-.037c-1.255-.021-2.171-.095-2.976-.429A5.75 5.75 0 0 1 1.688 16.2c-.235-.566-.338-1.178-.389-1.913c-.049-.723-.049-1.618-.049-2.76v-1.066c0-1.604 0-2.86.095-3.865c.098-1.023.3-1.862.752-2.6a5.75 5.75 0 0 1 1.899-1.899c.738-.452 1.577-.654 2.6-.752C7.6 1.25 8.857 1.25 10.461 1.25M6.739 2.839c-.914.087-1.495.253-1.959.537A4.25 4.25 0 0 0 3.376 4.78c-.284.464-.45 1.045-.537 1.96c-.088.924-.089 2.11-.089 3.761v1c0 1.175 0 2.019.046 2.685c.045.659.131 1.089.278 1.441a4.25 4.25 0 0 0 2.3 2.3c.515.214 1.173.294 2.429.316h.031c.398.007.747.013 1.037.045c.311.035.616.104.909.274c.29.17.5.395.682.645c.169.232.342.525.538.856l.559.944a.52.52 0 0 0 .882 0l.559-.944c.196-.331.37-.624.538-.856c.182-.25.392-.476.682-.645c.293-.17.598-.24.909-.274c.29-.032.639-.038 1.037-.045h.032c1.255-.022 1.913-.102 2.428-.316a4.25 4.25 0 0 0 2.3-2.3c.147-.352.233-.782.278-1.441c.046-.666.046-1.51.046-2.685v-1c0-1.651 0-2.837-.089-3.762c-.087-.914-.253-1.495-.537-1.959a4.25 4.25 0 0 0-1.403-1.403c-.464-.284-1.045-.45-1.96-.537c-.924-.088-2.11-.089-3.761-.089h-3c-1.651 0-2.837 0-3.762.089" clip-rule="evenodd"/><path fill="currentColor" d="M9 11a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0"/></svg><span>å‚ä¸è®¨è®º</span></a></div></widget>
</div></aside><div class='float-panel blur'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">
<script type="text/javascript">
  const ctx = {
    date_suffix: {
      just: `åˆšåˆš`,
      min: `åˆ†é’Ÿå‰`,
      hour: `å°æ—¶å‰`,
      day: `å¤©å‰`,
    },
    root : `/`,
    tag_plugins: {
      chat: Object.assign({"api":"https://siteinfo.listentothewind.cn/api/v1"}),
    }
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"all","path":"/search.json","content":true,"skip_search":null,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
  };
  const deps = {
    jquery: `https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js`,
    marked: `https://cdn.jsdelivr.net/npm/marked@13.0.1/lib/marked.umd.min.js`
  }
  

</script>

<script type="text/javascript">
  function RunItem() {
    this.list = []; // å­˜æ”¾å›è°ƒå‡½æ•°
    this.start = () => {
      for (var i = 0; i < this.list.length; i++) {
        this.list[i].run();
      }
    };
    this.push = (fn, name, setRequestAnimationFrame = true) => {
      let myfn = fn
      if (setRequestAnimationFrame) {
        myfn = () => {
          utils.requestAnimationFrame(fn)
        }
      }
      var f = new Item(myfn, name);
      this.list.push(f);
    };
    this.remove = (name) => {
      for (let index = 0; index < this.list.length; index++) {
        const e = this.list[index];
        if (e.name == name) {
          this.list.splice(index, 1);
        }
      }
    }
    // æ„é€ ä¸€ä¸ªå¯ä»¥runçš„å¯¹è±¡
    function Item(fn, name) {
      // å‡½æ•°åç§°
      this.name = name || fn.name;
      // runæ–¹æ³•
      this.run = () => {
        try {
          fn()
        } catch (error) {
          console.log(error);
        }
      };
    }
  }

  const utils = {
    // æ‡’åŠ è½½ css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')) {
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // é»˜è®¤å¼‚æ­¥ï¼Œå¦‚æœéœ€è¦åŒæ­¥ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥ {} å³å¯
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function () {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },

    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      let retryTimes = 3;
      utils.onLoading(el);
      function req() {
        return new Promise((resolve, reject) => {
          let status = 0; // 0 ç­‰å¾… 1 å®Œæˆ 2 è¶…æ—¶
          let timer = setTimeout(() => {
            if (status === 0) {
              status = 2;
              timer = null;
              reject('è¯·æ±‚è¶…æ—¶');
              if (retryTimes == 0) {
                onFailure();
              }
            }
          }, 5000);
          fetch(url).then(function (response) {
            if (status !== 2) {
              clearTimeout(timer);
              resolve(response);
              timer = null;
              status = 1;
            }
            if (response.ok) {
              return response.json();
            }
            throw new Error('Network response was not ok.');
          }).then(function (data) {
            retryTimes = 0;
            utils.onLoadSuccess(el);
            callback(data);
          }).catch(function (error) {
            if (retryTimes > 0) {
              retryTimes -= 1;
              setTimeout(() => {
                req();
              }, 5000);
            } else {
              utils.onLoadFailure(el);
              onFailure();
            }
          });
        });
      }
      req();
    },
    /********************** requestAnimationFrame ********************************/
    // 1ã€requestAnimationFrame ä¼šæŠŠæ¯ä¸€å¸§ä¸­çš„æ‰€æœ‰ DOM æ“ä½œé›†ä¸­èµ·æ¥ï¼Œåœ¨ä¸€æ¬¡é‡ç»˜æˆ–å›æµä¸­å°±å®Œæˆï¼Œå¹¶ä¸”é‡ç»˜æˆ–å›æµçš„æ—¶é—´é—´éš”ç´§ç´§è·Ÿéšæµè§ˆå™¨çš„åˆ·æ–°é¢‘ç‡ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œè¿™ä¸ªé¢‘ç‡ä¸ºæ¯ç§’60å¸§ã€‚
    // 2ã€åœ¨éšè—æˆ–ä¸å¯è§çš„å…ƒç´ ä¸­ï¼ŒrequestAnimationFrame å°†ä¸ä¼šè¿›è¡Œé‡ç»˜æˆ–å›æµï¼Œè¿™å½“ç„¶å°±æ„å‘³ç€æ›´å°‘çš„çš„ cpuï¼Œgpu å’Œå†…å­˜ä½¿ç”¨é‡ã€‚
    requestAnimationFrame: (fn) => {
      if (!window.requestAnimationFrame) {
        window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame;
      }
      window.requestAnimationFrame(fn)
    },
    dark: {},
  };

  // utils.dark.mode å½“å‰æ¨¡å¼ dark or light
  // utils.dark.toggle() æš—é»‘æ¨¡å¼è§¦å‘å™¨
  // utils.dark.push(callBack[,"callBackName"]) ä¼ å…¥è§¦å‘å™¨å›è°ƒå‡½æ•°
  utils.dark.method = {
    toggle: new RunItem(),
  };
  utils.dark = Object.assign(utils.dark, {
    push: utils.dark.method.toggle.push,
  });
</script>
<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>
<script type="text/javascript">
  (() => {
    const tagSwitchers = document.querySelectorAll('.tag-subtree.parent-tag > a > .tag-switcher-wrapper')
    for (const tagSwitcher of tagSwitchers) {
      tagSwitcher.addEventListener('click', (e) => {
        const parent = e.target.closest('.tag-subtree.parent-tag')
        parent.classList.toggle('expanded')
        e.preventDefault()
      })
    }

    // Get active tag from query string, then activate it.
    const urlParams = new URLSearchParams(window.location.search)
    const activeTag = urlParams.get('tag')
    if (activeTag) {
      let tag = document.querySelector(`.tag-subtree[data-tag="${activeTag}"]`)
      if (tag) {
        tag.querySelector('a').classList.add('active')
        
        while (tag) {
          tag.classList.add('expanded')
          tag = tag.parentElement.closest('.tag-subtree.parent-tag')
        }
      }
    }
  })()
</script>


<!-- required -->
<script src="/js/main.js?v=1.29.1" defer></script>

<script type="text/javascript">
  const applyTheme = (theme) => {
    if (theme === 'auto') {
      document.documentElement.removeAttribute('data-theme')
    } else {
      document.documentElement.setAttribute('data-theme', theme)
    }

    applyThemeToGiscus(theme)
  }

  const applyThemeToGiscus = (theme) => {
    theme = theme === 'auto' ? 'preferred_color_scheme' : theme

    const cmt = document.getElementById('giscus')
    if (cmt) {
      // This works before giscus load.
      cmt.setAttribute('data-theme', theme)
    }

    const iframe = document.querySelector('#comments > section.giscus > iframe')
    if (iframe) {
      // This works after giscus loaded.
      const src = iframe.src
      const newSrc = src.replace(/theme=[\w]+/, `theme=${theme}`)
      iframe.src = newSrc
    }
  }

  const switchTheme = () => {
    // light -> dark -> auto -> light -> ...
    const currentTheme = document.documentElement.getAttribute('data-theme')
    let newTheme;
    switch (currentTheme) {
      case 'light':
        newTheme = 'dark'
        break
      case 'dark':
        newTheme = 'auto'
        break
      default:
        newTheme = 'light'
    }
    applyTheme(newTheme)
    window.localStorage.setItem('Stellar.theme', newTheme)
    utils.dark.mode = newTheme === 'auto' ? (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light") : newTheme;
    utils.dark.method.toggle.start();

    const messages = {
      light: `åˆ‡æ¢åˆ°æµ…è‰²æ¨¡å¼`,
      dark: `åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼`,
      auto: `åˆ‡æ¢åˆ°è·Ÿéšç³»ç»Ÿé…è‰²`,
    }
    hud?.toast?.(messages[newTheme])
  }

  (() => {
    // Apply user's preferred theme, if any.
    const theme = window.localStorage.getItem('Stellar.theme')
    if (theme !== null) {
      applyTheme(theme)
    } else {
      utils.dark.mode = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
    }
    utils.dark.method.toggle.start();
  })()
</script>


<!-- optional -->

  <script type="module">
  const el = document.querySelector('#comments #giscus');
  util.viewportLazyload(el, load_discus, false);

  function load_discus() {
    if (!el) return;
    try {
        el.innerHTML = '';
      } catch (error) {
        console.error(error);
      }
      const script = document.createElement('script');
      script.async = true;
      for (const key of Object.keys(el.attributes)) {
        const attr = el.attributes[key];
        if (['class', 'id'].includes(attr.name) === false) {
          script.setAttribute(attr.name, attr.value);
        }
      }
      el.appendChild(script);
  }
</script>




<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":"https://site-info-api-hedon.vercel.app/api/v1?url={href}"},"ghinfo":{"js":"/js/services/ghinfo.js"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"},"voice":{"js":"/js/plugins/voice.js"},"video":{"js":"/js/plugins/video.js"},"download-file":{"js":"/js/plugins/download-file.js"},"twikoo":{"js":"/js/services/twikoo_latest_comment.js"},"waline":{"js":"/js/services/waline_latest_comment.js"},"artalk":{"js":"/js/services/artalk_latest_comment.js"},"giscus":{"js":"/js/services/giscus_latest_comment.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else if (id == 'voice') {
        ctx.voiceAudios = document.querySelectorAll('.voice>audio');
        if (ctx.voiceAudios?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            createVoiceDom(ctx.voiceAudios);
          });
        }
      } else if (id == 'video') {
        ctx.videos = document.querySelectorAll('.video>video');
        if (ctx.videos?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            videoEvents(ctx.videos);
          });
        }
      } else if (id == 'download-file') {
        ctx.files = document.querySelectorAll('.file');
        if (ctx.files?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            downloadFileEvent(ctx.files);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }

    // chat iphone time
    let phoneTimes = document.querySelectorAll('.chat .status-bar .time');

    if (phoneTimes.length > 0) {
      NowTime();
      var date = new Date();
      var sec = date.getSeconds();
      var firstAdjustInterval = setInterval(firstAdjustTime, 1000 * (60 - sec));
    }

    function firstAdjustTime() {
      NowTime();
      clearInterval(firstAdjustInterval);
      setInterval(NowTime, 1000 * 60);
    }

    function NowTime() {
      for (let i = 0; i < phoneTimes.length; ++i) {
        var timeSpan = phoneTimes[i];
        var date = new Date();
        var hour = date.getHours();
        var min = date.getMinutes();
        timeSpan.innerHTML = check(hour) + ":" + check(min);
      }
    };

    function check(val) {
      if (val < 10) {
        return ("0" + val);
      }
      return (val);
    }

    // chat quote
    const chat_quote_obverser = new IntersectionObserver((entries, observer) => {
      entries.filter((entry) => { return entry.isIntersecting }).sort((a, b) => a.intersectionRect.y !== b.intersectionRect.y ? a.intersectionRect.y - b.intersectionRect.y : a.intersectionRect.x - b.intersectionRect.x).forEach((entry, index) => {
          observer.unobserve(entry.target);
          setTimeout(() => {
            entry.target.classList.add('quote-blink');
            setTimeout(() => {
              entry.target.classList.remove('quote-blink');
            }, 1000);
          }, Math.max(100, 16) * (index + 1));
        });
    });

    var chatQuotes = document.querySelectorAll(".chat .talk .quote");
    chatQuotes.forEach((quote) => {
      quote.addEventListener('click', function () {
        var chatCellDom = document.getElementById("quote-" + quote.getAttribute("quotedCellTag"));
        if (chatCellDom) {
          var chatDiv = chatCellDom.parentElement;
          var mid = chatDiv.clientHeight / 2;
          var offsetTop = chatCellDom.offsetTop;
          if (offsetTop > mid - chatCellDom.clientHeight / 2) {
            chatDiv.scrollTo({
              top: chatCellDom.offsetTop - mid + chatCellDom.clientHeight / 2,
              behavior: "smooth"
            });
          } else {
            chatDiv.scrollTo({
              top: 0,
              behavior: "smooth"
            });
          }
          chat_quote_obverser.observe(chatCellDom);
        }
      });
    });
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://cdn.jsdelivr.net/npm/flying-pages@2/flying-pages.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@19.1.3/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });
</script><script>
  ctx.fancybox = {
    selector: `.timenode p>img, .md-text img:not([class]), .md-text .image img`,
    css: `https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css`,
    js: `https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js`
  };
  var selector = '[data-fancybox]:not(.error)';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const els = document.getElementsByClassName('ds-memos');
    if (els != undefined && els.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>
<script defer type="text/javascript" src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    var mermaid_config = {
      startOnLoad: true,
      theme:
        "" == "auto" &&
          window.matchMedia("(prefers-color-scheme: dark)").matches
          ? "dark"
          : "neutral",
      logLevel: 3,
      themeVariables: {
        darkMode: true
      },
      flowchart: {
        useMaxWidth: false,
        htmlLabels: true,
        curve: "linear"
      },
      gantt: {
        axisFormat: "%Y/%m/%d"
      },
      sequence: {
        actorMargin: 50
      }
    }
    mermaid.initialize(mermaid_config);
  });
</script><script>
  document.addEventListener('DOMContentLoaded', function () {
    window.codeElements = document.querySelectorAll('.code');
    if (window.codeElements.length > 0) {
      ctx.copycode = {
        default_text: `Copy`,
        success_text: `Copied`,
        toast: `å¤åˆ¶æˆåŠŸ`,
      };
      utils.js('/js/plugins/copycode.js');
    }
  });
</script>


<!-- inject -->

</div></body></html>
