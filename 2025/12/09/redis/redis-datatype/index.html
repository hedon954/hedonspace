
<!DOCTYPE html><html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.29.1" theme-name="Stellar" theme-version="1.29.1">
  
  <meta name="generator" content="Hexo 6.3.0">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  <link rel="preconnect" href="https://gcore.jsdelivr.net" crossorigin><link rel="preconnect" href="https://unpkg.com" crossorigin><link rel="preconnect" href="https://cdn.bootcdn.net" crossorigin>
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  <meta name="theme-color" content="#f9fafb">
  
  <title>ç›˜ç‚¹ Redis å„ç§æ•°æ®ç±»å‹ - HedonWang</title>

  
    <meta name="description" content="æœ¬æ–‡ç³»ç»Ÿæ¢³ç† Redis åä¸€ç§æ•°æ®ç±»å‹ï¼Œå¹¶ç»“åˆåº•å±‚å®ç°åŸç†ã€å…³é”®ä¼˜åŒ–ç»†èŠ‚ï¼Œæ·±å…¥è§£æå…¶é«˜æ€§èƒ½èƒŒåçš„è®¾è®¡æ™ºæ…§ä¸æŠ€æœ¯å–èˆã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="ç›˜ç‚¹ Redis å„ç§æ•°æ®ç±»å‹">
<meta property="og:url" content="https://hedon.top/2025/12/09/redis/redis-datatype/index.html">
<meta property="og:site_name" content="HedonWang">
<meta property="og:description" content="æœ¬æ–‡ç³»ç»Ÿæ¢³ç† Redis åä¸€ç§æ•°æ®ç±»å‹ï¼Œå¹¶ç»“åˆåº•å±‚å®ç°åŸç†ã€å…³é”®ä¼˜åŒ–ç»†èŠ‚ï¼Œæ·±å…¥è§£æå…¶é«˜æ€§èƒ½èƒŒåçš„è®¾è®¡æ™ºæ…§ä¸æŠ€æœ¯å–èˆã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20251209161405085.png">
<meta property="og:image" content="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20251209213942454.png">
<meta property="og:image" content="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250918190254554.png">
<meta property="og:image" content="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250918190417220.png">
<meta property="og:image" content="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20251209231456770.png">
<meta property="og:image" content="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/add-item-bloom-filter.webp">
<meta property="og:image" content="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20251210100627954.png">
<meta property="og:image" content="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20251210101309164.png">
<meta property="og:image" content="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20251210095612077.png">
<meta property="og:image" content="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/1280px-Radix_tree.svg.png">
<meta property="og:image" content="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20251210002143921.png">
<meta property="og:image" content="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20251210002239926.png">
<meta property="og:image" content="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/8887.1571235190.png">
<meta property="og:image" content="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/5646.1571235119.png">
<meta property="article:published_time" content="2025-12-09T07:06:00.000Z">
<meta property="article:modified_time" content="2025-12-10T04:55:36.212Z">
<meta property="article:author" content="Hedon Wang">
<meta property="article:tag" content="Redis">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20251209161405085.png">
  
  
  
  <meta name="keywords" content="Redis">

  <!-- feed -->
  
    <link rel="alternate" href="/atom.xml" title="HedonWang" type="application/atom+xml">
  

  <link rel="stylesheet" href="/css/main.css?v=1.29.1">


  
    <link rel="shortcut icon" href="/assets/favicon.png">
  

  

  <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon.png"><link rel="shortcut icon" href="/assets/favicon.png"><meta name="theme-color" content="#f8f8f8"><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC&display=swap" rel="stylesheet"><link rel="stylesheet" href="/css/markmap.css"><script src="https://cdn.jsdelivr.net/npm/markmap-autoloader@0.18"></script>
</head>
<body>

<div class="l_body s:aa content tech" id="start" layout="post" ><aside class="l_left"><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><div class="icon"><img no-lazy class="icon" src="/assets/favicon.png" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></div><a class="title" href="/"><div class="main" ff="title">HedonWang</div><div class="sub cap">å›å­æ±‚è¯¸å·±ï¼Œå¾‹å·±åˆ™å®‰ã€‚</div></a></div></header>

<div class="nav-area">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" placeholder="ç«™å†…æœç´¢"></form><div id="search-result"></div><div class="search-no-result">æ²¡æœ‰æ‰¾åˆ°å†…å®¹ï¼</div></div>


<nav class="menu dis-select"><a class="nav-item active" title="åšå®¢" href="/" style="color:#1BCDFC"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M5.879 2.879C5 3.757 5 5.172 5 8v8c0 2.828 0 4.243.879 5.121C6.757 22 8.172 22 11 22h2c2.828 0 4.243 0 5.121-.879C19 20.243 19 18.828 19 16V8c0-2.828 0-4.243-.879-5.121C17.243 2 15.828 2 13 2h-2c-2.828 0-4.243 0-5.121.879M8.25 17a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75M9 12.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5zM8.25 9A.75.75 0 0 1 9 8.25h6a.75.75 0 0 1 0 1.5H9A.75.75 0 0 1 8.25 9" clip-rule="evenodd"/><path fill="currentColor" d="M5.235 4.058C5 4.941 5 6.177 5 8v8c0 1.823 0 3.058.235 3.942L5 19.924c-.975-.096-1.631-.313-2.121-.803C2 18.243 2 16.828 2 14v-4c0-2.829 0-4.243.879-5.121c.49-.49 1.146-.707 2.121-.803zm13.53 15.884C19 19.058 19 17.822 19 16V8c0-1.823 0-3.059-.235-3.942l.235.018c.975.096 1.631.313 2.121.803C22 5.757 22 7.17 22 9.999v4c0 2.83 0 4.243-.879 5.122c-.49.49-1.146.707-2.121.803z" opacity=".5"/></svg></a><a class="nav-item" title="ä¸“æ " href="/topic/" style="color:#3DC550"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M14.25 4.48v3.057c0 .111 0 .27.02.406a.936.936 0 0 0 .445.683a.96.96 0 0 0 .783.072c.13-.04.272-.108.378-.159L17 8.005l1.124.534c.106.05.248.119.378.16a.958.958 0 0 0 .783-.073a.936.936 0 0 0 .444-.683c.021-.136.021-.295.021-.406V3.031c.113-.005.224-.01.332-.013C21.154 2.98 22 3.86 22 4.933v11.21c0 1.112-.906 2.01-2.015 2.08c-.97.06-2.108.179-2.985.41c-1.082.286-1.99 1.068-3.373 1.436c-.626.167-1.324.257-1.627.323V5.174c.32-.079 1.382-.203 1.674-.371c.184-.107.377-.216.576-.323m5.478 8.338a.75.75 0 0 1-.546.91l-4 1a.75.75 0 0 1-.364-1.456l4-1a.75.75 0 0 1 .91.546" clip-rule="evenodd"/><path fill="currentColor" d="M18.25 3.151c-.62.073-1.23.18-1.75.336a8.2 8.2 0 0 0-.75.27v3.182l.75-.356l.008-.005a1.13 1.13 0 0 1 .492-.13c.047 0 .094.004.138.01c.175.029.315.1.354.12l.009.005l.749.356V3.647z"/><path fill="currentColor" d="M12 5.214c-.334-.064-1.057-.161-1.718-.339C8.938 4.515 8.05 3.765 7 3.487c-.887-.234-2.041-.352-3.018-.412C2.886 3.007 2 3.9 2 4.998v11.146c0 1.11.906 2.01 2.015 2.079c.97.06 2.108.179 2.985.41c.486.129 1.216.431 1.873.726c1.005.451 2.052.797 3.127 1.034z" opacity=".5"/><path fill="currentColor" d="M4.273 12.818a.75.75 0 0 1 .91-.545l4 1a.75.75 0 1 1-.365 1.455l-4-1a.75.75 0 0 1-.545-.91m.909-4.545a.75.75 0 1 0-.364 1.455l4 1a.75.75 0 0 0 .364-1.455z"/></svg></a><a class="nav-item" title="å…³äºæˆ‘" href="/about/" style="color:#F44336"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="m13.629 20.472l-.542.916c-.483.816-1.69.816-2.174 0l-.542-.916c-.42-.71-.63-1.066-.968-1.262c-.338-.197-.763-.204-1.613-.219c-1.256-.021-2.043-.098-2.703-.372a5 5 0 0 1-2.706-2.706C2 14.995 2 13.83 2 11.5v-1c0-3.273 0-4.91.737-6.112a5 5 0 0 1 1.65-1.651C5.59 2 7.228 2 10.5 2h3c3.273 0 4.91 0 6.113.737a5 5 0 0 1 1.65 1.65C22 5.59 22 7.228 22 10.5v1c0 2.33 0 3.495-.38 4.413a5 5 0 0 1-2.707 2.706c-.66.274-1.447.35-2.703.372c-.85.015-1.275.022-1.613.219c-.338.196-.548.551-.968 1.262" opacity=".5"/><path fill="currentColor" d="M10.99 14.308c-1.327-.978-3.49-2.84-3.49-4.593c0-2.677 2.475-3.677 4.5-1.609c2.025-2.068 4.5-1.068 4.5 1.609c0 1.752-2.163 3.615-3.49 4.593c-.454.335-.681.502-1.01.502c-.329 0-.556-.167-1.01-.502"/></svg></a><a class="nav-item" title="æ€ç»´å¯¼å›¾" href="/html/mindmap.html" style="color:#F44336"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="m13.629 20.472l-.542.916c-.483.816-1.69.816-2.174 0l-.542-.916c-.42-.71-.63-1.066-.968-1.262c-.338-.197-.763-.204-1.613-.219c-1.256-.021-2.043-.098-2.703-.372a5 5 0 0 1-2.706-2.706C2 14.995 2 13.83 2 11.5v-1c0-3.273 0-4.91.737-6.112a5 5 0 0 1 1.65-1.651C5.59 2 7.228 2 10.5 2h3c3.273 0 4.91 0 6.113.737a5 5 0 0 1 1.65 1.65C22 5.59 22 7.228 22 10.5v1c0 2.33 0 3.495-.38 4.413a5 5 0 0 1-2.707 2.706c-.66.274-1.447.35-2.703.372c-.85.015-1.275.022-1.613.219c-.338.196-.548.551-.968 1.262" opacity=".5"/><path fill="currentColor" d="M10.99 14.308c-1.327-.978-3.49-2.84-3.49-4.593c0-2.677 2.475-3.677 4.5-1.609c2.025-2.068 4.5-1.068 4.5 1.609c0 1.752-2.163 3.615-3.49 4.593c-.454.335-.681.502-1.01.502c-.329 0-.556-.167-1.01-.502"/></svg></a></nav>
</div>
<div class="widgets">


<widget class="widget-wrapper post-list"><div class="widget-header dis-select"><span class="name">æœ€è¿‘æ›´æ–°</span></div><div class="widget-body fs14"><a class="item title" href="/2025/12/09/redis/redis-datatype/"><span class="title">ç›˜ç‚¹ Redis å„ç§æ•°æ®ç±»å‹</span></a><a class="item title" href="/2025/11/17/go/go-memory-model/"><span class="title">Go åº•å±‚åŸç†ä¸¨å†…å­˜æ¨¡å‹</span></a><a class="item title" href="/2025/12/08/mysql/mysql-binlog-practice/"><span class="title">MySQL Binlog å®è·µ CDC</span></a><a class="item title" href="/2025/04/09/note/note-unit-testing/"><span class="title">è¯»ä¹¦ç¬”è®°ä¸¨ã€ŠUnit Testing Principles, Practices, and Patternsã€‹</span></a><a class="item title" href="/2025/04/09/note/note-unit-testing-excerpt/"><span class="title">ä¹¦ç±æ‘˜æŠ„ä¸¨ã€ŠUnit Testing Principles, Practices, and Patternsã€‹</span></a><a class="item title" href="/2025/06/12/note/note-rust-atomics-and-locks/"><span class="title">è¯»ä¹¦ç¬”è®°ä¸¨ã€ŠRust Atomics and Locksã€‹</span></a><a class="item title" href="/2025/10/14/note/note-obsidian/"><span class="title">è¯»ä¹¦ç¬”è®°ä¸¨ã€Šä¸Šå¤´Obsidianï¼šæ‰‹æŠŠæ‰‹æ•™ä½ ç”¨AIåšå¥½çŸ¥è¯†ç®¡ç†ã€‹</span></a><a class="item title" href="/2025/07/24/note/note-fosa/"><span class="title">è¯»ä¹¦ç¬”è®°ä¸¨ã€ŠFundamentals of Software Architectureã€‹</span></a><a class="item title" href="/2025/03/11/note/note-ddd-awareness/"><span class="title">è¯»ä¹¦ç¬”è®°ä¸¨ã€Šæ‚Ÿé“é¢†åŸŸé©±åŠ¨è®¾è®¡ã€‹</span></a><a class="item title" href="/2025/12/06/mysql/sharding-page-search/"><span class="title">åˆ†åº“åˆ†è¡¨åçš„åˆ†é¡µæŸ¥è¯¢æ€è·¯æ€»ç»“</span></a></div></widget>
</div>

</div></aside><div class="l_main" id="main">





<div class="article banner top"><img class="bg lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/banner/redis-datatype.jpg">
  <div class="content">
    <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">ä¸»é¡µ</a>
<span class="sep"></span><a class="cap breadcrumb" href="/">æ–‡ç« </a><span class="sep"></span><a class="cap breadcrumb-link" href="/categories/Redis/">Redis</a></div>
<div class="flex-row" id="post-meta"><span class="text created">å‘å¸ƒäºï¼š<time datetime="2025-12-09T07:06:00.000Z">2025-12-09</time></span><span class="sep updated"></span><span class="text updated">æ›´æ–°äºï¼š<time datetime="2025-12-10T04:55:36.212Z">2025-12-10</time></span></div></div></div>
    
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>ç›˜ç‚¹ Redis å„ç§æ•°æ®ç±»å‹</span></h1>
        
      </div>
    </div>
    
  </div>
  </div><article class="md-text content"><p>ç†è§£ Redis å„ç±»æ•°æ®ç»“æ„çš„ç²¾å¦™ä¹‹å¤„ï¼Œç¦»ä¸å¼€ä¸¤ä¸ªåº•å±‚è®¾è®¡åŸåˆ™ï¼š</p>
<ol>
<li>æè‡´èŠ‚çœå†…å­˜ï¼šèƒ½çœå°±çœï¼Œæ—¢å‹ç¼©ç»“æ„æœ¬èº«ï¼Œä¹Ÿé‡‡ç”¨åŠ¨æ€æˆ–å…±äº«ç­‰æœºåˆ¶ç¡®ä¿æ¯ä¸€ä½ï¼ˆbitï¼‰éƒ½ç‰©å°½å…¶ç”¨ã€‚</li>
<li>æœ€å¤§åŒ– CPU ç¼“å­˜å‹å¥½ï¼šä¼˜å…ˆç”¨ä¸€å—è¿ç»­å°å†…å­˜ç®¡ç†æ•°æ®ï¼Œé™ä½æŒ‡é’ˆè·³è½¬å’Œç¢ç‰‡åŒ–ï¼Œä»¥æå‡è®¿é—®é€Ÿåº¦å’Œ CPU ç¼“å­˜å‘½ä¸­ç‡ã€‚</li>
</ol>
<p>è¿™ä¸¤ç‚¹æ”¯æ’‘ç€ Redis å„ç±»æ•°æ®ç±»å‹çš„æ¼”è¿›è·¯çº¿ä¸ç¼–ç é€‰æ‹©ã€‚</p>
<blockquote>
<p>ç‰ˆæœ¬å£°æ˜ï¼š<a target="_blank" rel="noopener" href="https://github.com/redis/redis/tree/8.4.0">Redis8.4.0</a></p>
</blockquote>
<h2 id="0-redisObject">0. redisObject</h2>
<p>åœ¨æ·±å…¥å…·ä½“ç±»å‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå¯¹ Redis å¯¹è±¡å¤´ <code>redisObject</code> åšä¸€ä¸ªç®€å•çš„äº†è§£ï¼Œå› ä¸º Redis ä¸­çš„æ‰€æœ‰ Key å’Œ Valueï¼Œåœ¨åº•å±‚éƒ½æ˜¯ä¸€ä¸ª <code>redisObject</code> ç»“æ„ä½“ã€‚è¿™æ˜¯ Redis å¤šæ€çš„åŸºçŸ³ã€‚<code>redisObject</code> çš„å®šä¹‰ä½äº <a target="_blank" rel="noopener" href="https://github.com/redis/redis/blob/8.4.0/src/server.h#L1057">src/server.h</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> LRU_BITS 24</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OBJ_REFCOUNT_BITS 30</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisObject</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> type:<span class="number">4</span>;</span><br><span class="line">    <span class="type">unsigned</span> encoding:<span class="number">4</span>;</span><br><span class="line">    <span class="type">unsigned</span> lru:LRU_BITS; <span class="comment">/* LRU time (relative to global lru_clock) or</span></span><br><span class="line"><span class="comment">                            * LFU data (least significant 8 bits frequency</span></span><br><span class="line"><span class="comment">                            * and most significant 16 bits access time). */</span></span><br><span class="line">    <span class="type">unsigned</span> iskvobj : <span class="number">1</span>;   <span class="comment">/* 1 if this struct serves as a kvobj base */</span></span><br><span class="line">    <span class="type">unsigned</span> expirable : <span class="number">1</span>; <span class="comment">/* 1 if this key has expiration time attached.</span></span><br><span class="line"><span class="comment">                             * If set, then this object is of type kvobj */</span></span><br><span class="line">    <span class="type">unsigned</span> refcount : OBJ_REFCOUNT_BITS;</span><br><span class="line">    <span class="type">void</span> *ptr;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>type</code>: é€»è¾‘æ•°æ®ç±»å‹ï¼ˆStringã€Listã€Hashã€Setã€ZSetï¼‰ã€‚</li>
<li><code>encoding</code>: ç‰©ç†ç¼–ç æ ¼å¼ï¼ˆintã€rowã€listpackã€skiplistï¼‰ã€‚</li>
<li><code>lru</code>: æ·˜æ±°ç­–ç•¥æ•°æ®ï¼Œå¦‚æœæ˜¯ LRU æ¨¡å¼ï¼Œåˆ™å­˜å‚¨æœ€åä¸€æ¬¡è®¿é—®çš„æ—¶é—´æˆ³ï¼ˆç§’çº§ï¼‰ã€‚å¦‚æœæ˜¯ LFU æ¨¡å¼ï¼Œåˆ™å­˜å‚¨æ–¹æ³•æ—¶é—´å’Œè®¿é—®é¢‘ç‡ã€‚å½“å†…å­˜è¾¾åˆ° <code>maxmemory</code> æ—¶ï¼ŒRedis æ ¹æ®æ­¤å­—æ®µå†³å®šæ·˜æ±°å“ªä¸ª Keyã€‚</li>
<li><code>iskvobj</code>: Redis 8.0 çš„æ–°ç‰¹æ€§ã€‚<code>1</code> è¡¨ç¤ºè¯¥å¯¹è±¡æ˜¯ä¸€ä¸ª <code>kvobj</code> ï¼ˆé”®å€¼å¯¹è±¡ï¼‰çš„ä¸€éƒ¨åˆ†ï¼Œæ„å‘³ç€ Keyã€Value å’Œå…ƒæ•°æ®åœ¨å†…å­˜ä¸­æ˜¯ç´§å‡‘/å†…åµŒå­˜å‚¨çš„ã€‚è¿™æ ·å¯ä»¥æ¶ˆé™¤&quot;é”®å€¼åˆ†ç¦»&quot;å¸¦æ¥çš„æŒ‡é’ˆè·³è½¬ï¼Œæå‡ CPU ç¼“å­˜å‘½ä¸­ç‡ã€‚</li>
<li><code>expirable</code>: Redis8.0 çš„æ–°ç‰¹æ€§ã€‚<code>1</code> è¡¨ç¤ºè¯¥ Key è®¾ç½®äº†è¿‡æœŸæ—¶é—´ã€‚è¿™æä¾›äº†ä¸€æ¡å¿«é€Ÿé€šé“ï¼Œè®¿é—®æ—¶è‹¥ä¸º 0ï¼Œç›´æ¥è·³è¿‡æŸ¥è¯¢ <code>expires</code> å“ˆå¸Œè¡¨çš„æ­¥éª¤ï¼ŒèŠ‚çœæ˜‚è´µçš„å“ˆå¸ŒæŸ¥æ‰¾å¼€é”€ã€‚</li>
<li><code>refcount</code>: è®°å½•æœ‰å¤šå°‘ä¸ªæŒ‡é’ˆå¼•ç”¨äº†è¯¥å¯¹è±¡ã€‚ç”¨äºå†…å­˜ç®¡ç†å’Œå¯¹è±¡å…±äº«ï¼ˆä¸»è¦ç”¨äºå°æ•´æ•°å…±äº«ï¼‰ã€‚å½“è®¡æ•°é™ä¸º 0 æ—¶ï¼Œå›æ”¶å†…å­˜ã€‚è¿™é‡Œä½¿ç”¨äº†ä½åŸŸå‹ç¼©ä»¥èŠ‚çœç©ºé—´ã€‚</li>
<li><code>ptr</code>: æŒ‡å‘å®é™…å­˜å‚¨æ•°æ®çš„å†…å­˜åœ°å€ï¼ˆå¦‚ SDSã€Dictã€Quicklist çš„åœ°å€ï¼‰ã€‚ç‰¹åˆ«åœ°ï¼Œå¦‚æœ encoding æ˜¯ <code>INT</code>ï¼Œè¿™é‡Œç›´æ¥å­˜å‚¨æ•´æ•°å€¼æœ¬èº«ï¼Œä¸å†æ˜¯æŒ‡é’ˆã€‚</li>
</ul>
<p>ä¸Šè¿°å¤šä¸ªå­—æ®µï¼Œæœ€é‡è¦çš„å°±æ˜¯ <code>type</code> å’Œ <code>encoding</code>ã€‚æ€»çš„æ¥è¯´ï¼Œ<code>type</code> å†³å®šäº†å®ƒå¯¹å¤–å£°ç§°æ˜¯ä»€ä¹ˆï¼ˆæ¯”å¦‚ Hashï¼‰ï¼Œè€Œ <code>encoding</code> å†³å®šäº†å®ƒåœ¨å†…å­˜é‡Œåˆ°åº•æ€ä¹ˆå­˜ï¼ˆæ¯”å¦‚æ˜¯å‹ç¼©åˆ—è¡¨è¿˜æ˜¯å“ˆå¸Œè¡¨ï¼‰ã€‚<strong>ä¼˜åŒ– Redis å†…å­˜çš„æ ¸å¿ƒï¼Œå°±æ˜¯æƒ³åŠæ³•è®©å®ƒä¿æŒåœ¨è½»é‡çº§çš„ <code>encoding</code> ä¸Šã€‚</strong></p>
<h2 id="1-String">1. String</h2>
<p>String æ˜¯ Redis æœ€åŸºæœ¬çš„æ•°æ®ç±»å‹ï¼Œä¹Ÿæ˜¯æ‰€æœ‰ Key çš„ç±»å‹ã€‚</p>
<h3 id="1-1-æ ¸å¿ƒæ“ä½œ">1.1 æ ¸å¿ƒæ“ä½œ</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŸºç¡€æ“ä½œ</span></span><br><span class="line">SET key value                 <span class="comment"># è®¾ç½®é”®å€¼å¯¹</span></span><br><span class="line">GET key                       <span class="comment"># è·å–å€¼</span></span><br><span class="line">DEL key                       <span class="comment"># åˆ é™¤é”®</span></span><br><span class="line">EXISTS key                    <span class="comment"># æ£€æŸ¥é”®æ˜¯å¦å­˜åœ¨</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰¹é‡æ“ä½œ</span></span><br><span class="line">MSET key1 value1 key2 value2  <span class="comment"># æ‰¹é‡è®¾ç½®</span></span><br><span class="line">MGET key1 key2 key3           <span class="comment"># æ‰¹é‡è·å–</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ•°å€¼æ“ä½œ</span></span><br><span class="line">INCR key                      <span class="comment"># åŸå­é€’å¢ +1</span></span><br><span class="line">DECR key                      <span class="comment"># åŸå­é€’å‡ -1</span></span><br><span class="line">INCRBY key increment          <span class="comment"># æŒ‰æŒ‡å®šå€¼é€’å¢</span></span><br><span class="line">DECRBY key decrement          <span class="comment"># æŒ‰æŒ‡å®šå€¼é€’å‡</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å­—ç¬¦ä¸²æ“ä½œ</span></span><br><span class="line">APPEND key value              <span class="comment"># è¿½åŠ å­—ç¬¦ä¸²</span></span><br><span class="line">STRLEN key                    <span class="comment"># è·å–å­—ç¬¦ä¸²é•¿åº¦</span></span><br><span class="line">GETRANGE key start end        <span class="comment"># è·å–å­å­—ç¬¦ä¸²ï¼ˆé—­åŒºé—´ï¼‰</span></span><br><span class="line">SETRANGE key offset value     <span class="comment"># ä»æŒ‡å®šåç§»é‡è®¾ç½®å­—ç¬¦ä¸²</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿‡æœŸæ—¶é—´</span></span><br><span class="line">SETEX key seconds value       <span class="comment"># è®¾ç½®å¸¦è¿‡æœŸæ—¶é—´çš„é”®</span></span><br><span class="line">TTL key                       <span class="comment"># æŸ¥çœ‹å‰©ä½™ç”Ÿå­˜æ—¶é—´</span></span><br><span class="line">EXPIRE key seconds            <span class="comment"># ä¸ºå·²æœ‰é”®è®¾ç½®è¿‡æœŸæ—¶é—´</span></span><br></pre></td></tr></table></figure>
<p><strong>å¸¸è§ä½¿ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li><strong>ç¼“å­˜å±‚</strong>ï¼šå­˜å‚¨ JSON åºåˆ—åŒ–åçš„å¯¹è±¡ï¼Œå¦‚ç”¨æˆ·ä¿¡æ¯ã€å•†å“è¯¦æƒ…</li>
<li><strong>è®¡æ•°å™¨</strong>ï¼šæ–‡ç« é˜…è¯»æ•°ã€ç‚¹èµæ•°ã€åº“å­˜æ•°é‡ç­‰åŸå­è®¡æ•°åœºæ™¯</li>
<li><strong>åˆ†å¸ƒå¼é”</strong>ï¼š<code>SET key value NX EX 30</code> å®ç°ç®€å•çš„åˆ†å¸ƒå¼é”</li>
<li><strong>é™æµå™¨</strong>ï¼šä½¿ç”¨ <code>INCR</code> å’Œ <code>EXPIRE</code> å®ç°æ»‘åŠ¨çª—å£é™æµ</li>
<li><strong>ä¼šè¯ç®¡ç†</strong>ï¼šå­˜å‚¨ç”¨æˆ· session ä¿¡æ¯ï¼Œé…åˆè¿‡æœŸæ—¶é—´è‡ªåŠ¨æ¸…ç†</li>
</ul>
<h3 id="1-2-åº•å±‚åŸç†">1.2 åº•å±‚åŸç†</h3>
<p>Redis æ²¡æœ‰ç›´æ¥ä½¿ç”¨ C è¯­è¨€çš„å­—ç¬¦ä¸² <code>char*</code>ï¼Œè€Œæ˜¯è‡ªå·±å°è£…äº† SDSï¼ˆSimple Dynamic Stringï¼‰ï¼Œè€Œä¸”è¿˜è¿›ä¸€æ­¥åˆ†æˆäº† <code>sdshdr5</code>ã€<code>sdshdr8</code>ã€<code>sdshdr16</code>ã€<code>sdshdr32</code> å’Œ <code>sdshdr64</code>ã€‚å…¶æ ¸å¿ƒç›®çš„æ˜¯æ ¹æ®<strong>å­—ç¬¦ä¸²çš„é•¿åº¦</strong>ï¼Œä½¿ç”¨ä¸åŒå¤§å°çš„å¤´éƒ¨ï¼Œä»è€Œè¿›ä¸€æ­¥å‹ç¼©å†…å­˜çš„ä½¿ç”¨ã€‚</p>
<p>SDS çš„å®šä¹‰ä½äº <a target="_blank" rel="noopener" href="https://github.com/redis/redis/blob/8.4.0/src/sds.h">src/sds.h</a>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Note: sdshdr5 is never used, we just access the flags byte directly.</span></span><br><span class="line"><span class="comment"> * However is here to document the layout of type 5 SDS strings. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr5</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> flags; <span class="comment">/* 3 lsb of type, and 5 msb of string length */</span></span><br><span class="line">    <span class="type">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr8</span> &#123;</span></span><br><span class="line">    <span class="type">uint8_t</span> len; <span class="comment">/* used */</span></span><br><span class="line">    <span class="type">uint8_t</span> alloc; <span class="comment">/* excluding the header and null terminator */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></span><br><span class="line">    <span class="type">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr16</span> &#123;</span></span><br><span class="line">    <span class="type">uint16_t</span> len; <span class="comment">/* used */</span></span><br><span class="line">    <span class="type">uint16_t</span> alloc; <span class="comment">/* excluding the header and null terminator */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></span><br><span class="line">    <span class="type">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr32</span> &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> len; <span class="comment">/* used */</span></span><br><span class="line">    <span class="type">uint32_t</span> alloc; <span class="comment">/* excluding the header and null terminator */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></span><br><span class="line">    <span class="type">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr64</span> &#123;</span></span><br><span class="line">    <span class="type">uint64_t</span> len; <span class="comment">/* used */</span></span><br><span class="line">    <span class="type">uint64_t</span> alloc; <span class="comment">/* excluding the header and null terminator */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></span><br><span class="line">    <span class="type">char</span> buf[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬é‡ç‚¹å…³æ³¨ 3 ä¸ªå­—æ®µï¼š</p>
<ul>
<li><code>len</code>: å·²ç”¨é•¿åº¦ã€‚</li>
<li><code>alloc</code>: åˆ†ç‰‡çš„æ€»å†…å­˜å¤§å°ï¼ˆä¸åŒ…æ‹¬å¤´éƒ¨å’Œæœ«å°¾çš„ <code>\0</code>ï¼‰ã€‚</li>
<li><code>buf[]</code>: å®é™…å­˜å‚¨å­—ç¬¦æ•°æ®çš„æŸ”æ€§æ•°ç»„ã€‚</li>
</ul>
<p>å³ä¾¿éƒ½æ˜¯ Stringï¼ŒRedis ä¸ºäº†çœå†…å­˜ï¼Œä¹Ÿä½¿ç”¨äº† 3 ç§ä¸åŒçš„ç¼–ç æ ¼å¼ï¼š</p>
<table>
<thead>
<tr>
<th><strong>ç¼–ç ç±»å‹</strong></th>
<th><strong>åœºæ™¯</strong></th>
<th><strong>ç‰¹ç‚¹</strong></th>
<th><strong>ä¼˜ç¼ºç‚¹</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>int</strong></td>
<td>çº¯æ•°å­—ä¸”åœ¨ long èŒƒå›´å†…</td>
<td><code>ptr</code> æŒ‡é’ˆç›´æ¥å­˜æ•°å€¼ï¼Œä¸éœ€è¦ SDSã€‚</td>
<td>æœ€çœå†…å­˜ï¼Œæ— é¢å¤–æŒ‡é’ˆå¼€é”€ã€‚</td>
</tr>
<tr>
<td><strong>embstr</strong></td>
<td>å­—ç¬¦ä¸² â‰¤ 44 å­—èŠ‚</td>
<td><code>redisObject</code> å’Œ <code>SDS</code> è¿ç»­åˆ†é…ï¼Œåªè°ƒç”¨ 1 æ¬¡ mallocã€‚</td>
<td><strong>å†…å­˜è¿ç»­</strong>ï¼Œç¼“å­˜äº²å’Œæ€§å¥½ï¼›ä½†åªè¯»ï¼Œä¿®æ”¹ä¼šè½¬ rawã€‚</td>
</tr>
<tr>
<td><strong>raw</strong></td>
<td>å­—ç¬¦ä¸² &gt; 44 å­—èŠ‚</td>
<td><code>redisObject</code> å’Œ <code>SDS</code> åˆ†å¼€åˆ†é…ï¼Œè°ƒç”¨ 2 æ¬¡ mallocã€‚</td>
<td>é€‚åˆé•¿å­—ç¬¦ä¸²ï¼Œä¿®æ”¹çµæ´»ã€‚</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!note]</p>
<p><strong>ğŸ’¡ 44 å­—èŠ‚æ€ä¹ˆæ¥çš„ï¼Ÿ</strong> <code>redisObject</code> (16B) + <code>SDS</code> å¤´ (3B) + <code>\0</code> (1B) = 20Bã€‚ å†…å­˜åˆ†é…å™¨ï¼ˆå¦‚ jemallocï¼‰é€šå¸¸åˆ†é… 64B çš„å—ã€‚ 64B - 20B = 44Bã€‚åˆšå¥½å¡«æ»¡ä¸€ä¸ªå†…å­˜å—ï¼Œä¸æµªè´¹ã€‚</p>
</blockquote>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20251209161405085.png" alt=""></p>
<h2 id="2-List">2. List</h2>
<p>List åœ¨ Redis ä¸­é€»è¾‘ä¸Šæ˜¯ä¸€ä¸ª <strong>åŒå‘é“¾è¡¨</strong>ã€‚è¿™æ„å‘³ç€ï¼š</p>
<ul>
<li><strong>å¤´å°¾æ“ä½œæå¿«</strong>ï¼š<code>LPUSH</code>/<code>RPOP</code> æ˜¯ <strong>O(1)</strong>ã€‚</li>
<li><strong>éšæœºè®¿é—®ææ…¢</strong>ï¼š<code>LINDEX</code> æ˜¯ <strong>O(N)</strong>ã€‚ï¼ˆåƒä¸‡åˆ«æŠŠå®ƒå½“æ•°ç»„ç”¨ï¼ï¼‰</li>
</ul>
<h3 id="2-1-æ ¸å¿ƒæ“ä½œ">2.1 æ ¸å¿ƒæ“ä½œ</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¤´éƒ¨æ“ä½œ</span></span><br><span class="line">LPUSH key value1 value2       <span class="comment"># ä»å·¦ä¾§å¤´éƒ¨æ¨å…¥å…ƒç´ ï¼ˆæ ˆï¼šå…ˆè¿›åå‡ºï¼‰</span></span><br><span class="line">RPUSH key value1 value2       <span class="comment"># ä»å³ä¾§å°¾éƒ¨æ¨å…¥å…ƒç´ ï¼ˆé˜Ÿåˆ—ï¼šå…ˆè¿›å…ˆå‡ºï¼‰</span></span><br><span class="line">LPOP key                      <span class="comment"># ä»å·¦ä¾§å¤´éƒ¨å¼¹å‡ºå…ƒç´ </span></span><br><span class="line">RPOP key                      <span class="comment"># ä»å³ä¾§å°¾éƒ¨å¼¹å‡ºå…ƒç´ </span></span><br><span class="line">LPOP key count                <span class="comment"># æ‰¹é‡ä»å·¦ä¾§å¼¹å‡ºå¤šä¸ªå…ƒç´ </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é˜»å¡æ“ä½œï¼ˆé‡è¦ï¼‰</span></span><br><span class="line">BLPOP key1 key2 <span class="built_in">timeout</span>       <span class="comment"># é˜»å¡å¼å·¦å¼¹å‡ºï¼Œç”¨äºæ¶ˆæ¯é˜Ÿåˆ—</span></span><br><span class="line">BRPOP key1 key2 <span class="built_in">timeout</span>       <span class="comment"># é˜»å¡å¼å³å¼¹å‡ºï¼Œç”¨äºæ¶ˆæ¯é˜Ÿåˆ—</span></span><br><span class="line">BLMOVE <span class="built_in">source</span> destination <span class="built_in">timeout</span> LEFT|RIGHT LEFT|RIGHT  <span class="comment"># é˜»å¡å¼ç§»åŠ¨å…ƒç´ </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥è¯¢æ“ä½œ</span></span><br><span class="line">LLEN key                      <span class="comment"># è·å–åˆ—è¡¨é•¿åº¦</span></span><br><span class="line">LRANGE key start end          <span class="comment"># è·å–æŒ‡å®šèŒƒå›´å†…çš„å…ƒç´ ï¼ˆæ”¯æŒè´Ÿæ•°ç´¢å¼•ï¼‰</span></span><br><span class="line">LINDEX key index              <span class="comment"># è·å–æŒ‡å®šç´¢å¼•çš„å…ƒç´ </span></span><br><span class="line">LPOS key value [COUNT count]  <span class="comment"># æŸ¥æ‰¾å…ƒç´ ä½ç½®</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹æ“ä½œ</span></span><br><span class="line">LSET key index value          <span class="comment"># è®¾ç½®æŒ‡å®šç´¢å¼•çš„å€¼</span></span><br><span class="line">LINSERT key BEFORE|AFTER pivot value  <span class="comment"># åœ¨æŒ‡å®šå…ƒç´ å‰/åæ’å…¥æ–°å…ƒç´ </span></span><br><span class="line">LTRIM key start end           <span class="comment"># ä¿®å‰ªåˆ—è¡¨ï¼Œåªä¿ç•™æŒ‡å®šèŒƒå›´å†…çš„å…ƒç´ </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç§»åŠ¨æ“ä½œ</span></span><br><span class="line">RPOPLPUSH <span class="built_in">source</span> destination  <span class="comment"># ä» source å³å¼¹å‡ºï¼Œdestination å·¦æ¨å…¥</span></span><br><span class="line">LMOVE <span class="built_in">source</span> destination LEFT|RIGHT LEFT|RIGHT  <span class="comment"># çµæ´»çš„å…ƒç´ ç§»åŠ¨</span></span><br></pre></td></tr></table></figure>
<p><strong>å¸¸è§ä½¿ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li><strong>æ¶ˆæ¯é˜Ÿåˆ—</strong>ï¼š<code>LPUSH/BRPOP</code> å®ç°ç®€å•çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ï¼Œ<code>BLPOP</code> æä¾›é˜»å¡å¼æ¶ˆè´¹</li>
<li><strong>æœ€æ–°åŠ¨æ€</strong>ï¼šç”¨æˆ·åŠ¨æ€ã€æ–°é—»åˆ—è¡¨ä½¿ç”¨ <code>LPUSH/LRANGE 0 10</code> è·å–æœ€æ–° 10 æ¡</li>
<li><strong>ä»»åŠ¡é˜Ÿåˆ—</strong>ï¼šå¼‚æ­¥ä»»åŠ¡å¤„ç†ï¼Œé…åˆ <code>RPOPLPUSH</code> å®ç°å¯é é˜Ÿåˆ—ï¼ˆå¤±è´¥é‡è¯•ï¼‰</li>
<li><strong>æ•°æ®åˆ†é¡µ</strong>ï¼šå­˜å‚¨åˆ†é¡µæ•°æ®ï¼Œä½¿ç”¨ <code>LRANGE</code> å®ç°é«˜æ•ˆåˆ†é¡µæŸ¥è¯¢</li>
<li><strong>æ’è¡Œæ¦œ</strong>ï¼šç»“åˆ <code>LPUSH/LTRIM</code> ç»´æŠ¤å›ºå®šå¤§å°çš„æ’è¡Œæ¦œæˆ–çƒ­æ¦œ</li>
<li><strong>é™æµé˜Ÿåˆ—</strong>ï¼šå®ç°æ»‘åŠ¨çª—å£é™æµï¼Œä½¿ç”¨ <code>LLEN</code> ç›‘æ§é˜Ÿåˆ—é•¿åº¦</li>
</ul>
<h3 id="2-2-åº•å±‚åŸç†">2.2 åº•å±‚åŸç†</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">listNode</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">listNode</span> *<span class="title">prev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">listNode</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="type">void</span> *value;</span><br><span class="line">&#125; listNode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">listIter</span> &#123;</span></span><br><span class="line">    listNode *next;</span><br><span class="line">    <span class="type">int</span> direction;</span><br><span class="line">&#125; listIter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">list</span> &#123;</span></span><br><span class="line">    listNode *head;</span><br><span class="line">    listNode *tail;</span><br><span class="line">    <span class="type">void</span> *(*dup)(<span class="type">void</span> *ptr);</span><br><span class="line">    <span class="type">void</span> (*<span class="built_in">free</span>)(<span class="type">void</span> *ptr);</span><br><span class="line">    <span class="type">int</span> (*match)(<span class="type">void</span> *ptr, <span class="type">void</span> *key);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> len;</span><br><span class="line">&#125; <span class="built_in">list</span>;</span><br></pre></td></tr></table></figure>
<p>Redis List çš„åº•å±‚å®ç°ç»å†äº†ä¸‰æ¬¡å¤§çš„å˜é©ï¼š</p>
<table>
<thead>
<tr>
<th><strong>Redis ç‰ˆæœ¬</strong></th>
<th><strong>åº•å±‚å®ç°</strong></th>
<th><strong>ç»“æ„æè¿°</strong></th>
<th><strong>ä¼˜ç¼ºç‚¹</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>v3.2 ä¹‹å‰</strong></td>
<td><strong>LinkedList</strong> (åŒå‘é“¾è¡¨)<br><strong>Ziplist</strong> (å‹ç¼©åˆ—è¡¨)</td>
<td>å…ƒç´ å°‘ç”¨ Ziplistï¼Œå¤šç”¨ LinkedListã€‚</td>
<td><strong>LinkedList</strong>ï¼šæŒ‡é’ˆå ç”¨å†…å­˜å·¨å¤§ï¼Œå†…å­˜ç¢ç‰‡å¤šï¼ŒCache äº²å’Œæ€§å·®ã€‚ <br><strong>Ziplist</strong>ï¼šçœå†…å­˜ï¼Œä½†æ›´æ–°æ•ˆç‡ä½ã€‚</td>
</tr>
<tr>
<td><strong>v3.2 - v6.2</strong></td>
<td><strong>Quicklist</strong> (å¿«é€Ÿåˆ—è¡¨)</td>
<td>é“¾è¡¨çš„èŠ‚ç‚¹æ˜¯å‹ç¼©åˆ—è¡¨ã€‚</td>
<td>é›†å¤§æˆè€…ã€‚æ—¢ä¿ç•™äº†é“¾è¡¨çš„ä¼¸ç¼©æ€§ï¼Œåˆåˆ©ç”¨äº†å‹ç¼©åˆ—è¡¨çš„çœå†…å­˜ç‰¹æ€§ã€‚</td>
</tr>
<tr>
<td><strong>v7.0+</strong></td>
<td><strong>Quicklist</strong> + <strong>Listpack</strong></td>
<td>å°† Quicklist å†…éƒ¨çš„ Ziplist æ›¿æ¢ä¸º Listpackã€‚</td>
<td>è§£å†³äº† Ziplist çš„çº§è”æ›´æ–°é—®é¢˜ã€‚</td>
</tr>
</tbody>
</table>
<h4 id="2-2-1-LinkedList">2.2.1 LinkedList</h4>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹ <code>LinkedList</code>ï¼Œè¿™æ˜¯æœ€ç›´è§‰çš„å®ç°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">          +------+     +------+     +------+</span><br><span class="line">... &lt;---- | prev | &lt;-&gt; | prev | &lt;-&gt; | prev | ----&gt; ...</span><br><span class="line">          | data |     | data |     | data |</span><br><span class="line">... &lt;---- | next | &lt;-&gt; | next | &lt;-&gt; | next | ----&gt; ...</span><br><span class="line">          +------+     +------+     +------+</span><br></pre></td></tr></table></figure>
<p>ä¼˜ç‚¹ï¼šå®Œç¾çš„ O(1) å¤´å°¾æ“ä½œ</p>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li><strong>é«˜æ˜‚çš„å†…å­˜å¼€é”€</strong>ï¼š<code>prev</code> å’Œ <code>next</code> æŒ‡é’ˆå æ®äº†å¤§é‡å†…å­˜ï¼Œå¦‚æœ <code>data</code> ä¸å¤Ÿå¤§ï¼Œé‚£æ€§ä»·æ¯”å°±å¾ˆä½äº†ã€‚</li>
<li><strong>ç³Ÿç³•çš„ CPU ç¼“å­˜å±€éƒ¨æ€§</strong>ï¼šé“¾è¡¨çš„èŠ‚ç‚¹åœ¨å†…å­˜ä¸­æ˜¯<strong>ç¦»æ•£</strong>åˆ†å¸ƒçš„ã€‚å½“ CPU éå†é“¾è¡¨æ—¶ï¼ŒæŒ‡é’ˆè·³è½¬çš„è¡Œä¸ºææ˜“å¯¼è‡´ <strong>CPU Cache Miss</strong>ã€‚</li>
</ul>
<h4 id="2-2-2-Ziplist">2.2.2 Ziplist</h4>
<p>ä¸ºäº†å…‹æœ <code>linkedlist</code> çš„åŒé‡ä»£ä»·ï¼ŒRedis çš„è®¾è®¡è€…ä»¬åˆ›é€ äº†ä¸€ç§æå…¶ç´§å‡‘çš„æ•°æ®ç»“æ„ï¼š<strong>å‹ç¼©åˆ—è¡¨ (ziplist)</strong>ã€‚</p>
<p><code>ziplist</code> çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œç”¨ä¸€å—<strong>è¿ç»­çš„ã€å®Œæ•´çš„å†…å­˜å—</strong>æ¥å­˜å‚¨æ‰€æœ‰å…ƒç´ ï¼Œä»è€Œå½»åº•æ¶ˆé™¤æŒ‡é’ˆå¼€é”€ï¼Œå¹¶æœ€å¤§åŒ–åˆ©ç”¨ CPU ç¼“å­˜ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;zlbytes&gt; &lt;zltail&gt; &lt;zllen&gt; &lt;entry_1&gt; &lt;entry_2&gt; ... &lt;entry_N&gt; &lt;zlend&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>&lt;zlbytes&gt;</code>: æ•´ä¸ª <code>ziplist</code> å ç”¨çš„æ€»å­—èŠ‚æ•°ã€‚</li>
<li><code>&lt;zltail&gt;</code>: åˆ°æœ€åä¸€ä¸ª entry çš„åç§»é‡ï¼Œç”¨äºå¿«é€Ÿå®šä½åˆ°è¡¨å°¾ã€‚</li>
<li><code>&lt;zllen&gt;</code>: entry çš„æ•°é‡ã€‚</li>
<li><code>&lt;entry&gt;</code>: çœŸæ­£çš„åˆ—è¡¨å…ƒç´ ï¼Œæ¯ä¸ª entry ä¹Ÿæ˜¯å˜é•¿çš„ã€‚</li>
<li><code>&lt;zlend&gt;</code>: ç‰¹æ®Šçš„ç»“æŸæ ‡è®° <code>0xFF</code>ã€‚</li>
</ul>
<p><code>ziplist</code> çš„ç²¾é«“åœ¨äº <code>entry</code> çš„è®¾è®¡ã€‚æ¯ä¸ª entry çš„å¤´éƒ¨ä¼šè®°å½•<strong>å‰ä¸€ä¸ª entry</strong> çš„é•¿åº¦ (<code>prev_len</code>)ï¼Œè¿™ä½¿å¾— <code>ziplist</code> å¯ä»¥ä»åå‘å‰éå†ã€‚</p>
<p>ä¼˜ç‚¹ï¼šå†…å­˜å ç”¨å°ä¸”å¯¹ CPU ç¼“å­˜å‹å¥½ã€‚</p>
<p>ç¼ºç‚¹ï¼šçº§è”æ›´æ–°ã€‚å› ä¸º <code>entry</code> åŒ…å«äº†å‰é¢èŠ‚ç‚¹çš„ä¿¡æ¯ï¼ˆ<code>prev_len</code>ï¼‰ï¼Œæ‰€ä»¥å‰é¢çš„èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå¾ˆå®¹æ˜“é€ æˆåé¢èŠ‚ç‚¹çš„çº§è”æ›´æ–°ã€‚</p>
<h4 id="2-2-3-Quicklist">2.2.3 Quicklist</h4>
<p>æ—¢ç„¶ <code>linkedlist</code> å’Œ <code>ziplist</code> å„æœ‰ä¼˜åŠ£ï¼Œèƒ½å¦å°†å®ƒä»¬ç»“åˆèµ·æ¥ï¼Œå–å…¶ç²¾åï¼Œå»å…¶ç³Ÿç²•ï¼Ÿ<strong>å¿«é€Ÿåˆ—è¡¨ (quicklist)</strong> åº”è¿è€Œç”Ÿï¼Œå¹¶ä» Redis 3.2 å¼€å§‹æˆä¸º List çš„é»˜è®¤å®ç°ã€‚</p>
<p><code>quicklist</code> çš„æœ¬è´¨ï¼Œå°±æ˜¯ä¸€ä¸ªç”± <code>ziplist</code>ï¼ˆæˆ–åæ¥çš„ <code>listpack</code>ï¼‰èŠ‚ç‚¹ç»„æˆçš„<strong>åŒå‘é“¾è¡¨</strong>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+----------------+     +----------------+     +----------------+</span><br><span class="line">| quicklistNode  | &lt;-&gt; | quicklistNode  | &lt;-&gt; | quicklistNode  |</span><br><span class="line">| (ziplist/pack) |     | (ziplist/pack) |     | (ziplist/pack) |</span><br><span class="line">+----------------+     +----------------+     +----------------+</span><br><span class="line">         ^                    ^                      ^</span><br><span class="line">         |                    |                      |</span><br><span class="line">   [ e1, e2, e3 ]       [ e4, e5 ]           [ e6, e7, e8, e9 ]</span><br></pre></td></tr></table></figure>
<p>å®ƒåœ¨å®è§‚ä¸Šæ˜¯ä¸€ä¸ª <code>linkedlist</code>ï¼Œä¿æŒäº† O(1) çš„å¤´å°¾æ’å…¥æ€§èƒ½å’Œçµæ´»æ€§ã€‚è€Œåœ¨å¾®è§‚ä¸Šï¼Œæ¯ä¸ªèŠ‚ç‚¹å†…éƒ¨æ˜¯ä¸€ä¸ª <code>ziplist</code> æˆ– <code>listpack</code>ï¼Œå­˜å‚¨äº†å¤šä¸ªå…ƒç´ ï¼Œæå¤§åœ°èŠ‚çœäº†å†…å­˜ï¼Œå¹¶æå‡äº†ç¼“å­˜å±€éƒ¨æ€§ã€‚<code>quicklist</code> é€šè¿‡å°†è¿é”æ›´æ–°çš„é£é™©<strong>é™åˆ¶</strong>åœ¨ä¸€ä¸ªä¸ªç‹¬ç«‹çš„å°èŠ‚ç‚¹å†…éƒ¨ï¼Œå®Œç¾åœ°è§„é¿äº† <code>ziplist</code> æœ€å¤§çš„é£é™©ã€‚</p>
<h4 id="2-2-4-Listpack">2.2.4 Listpack</h4>
<p><code>quicklist</code> è™½ç„¶å°† <code>ziplist</code> çš„ç¼ºç‚¹é™åˆ¶åœ¨äº†ä¸€ä¸ªèŠ‚ç‚¹ä¹‹é—´ï¼Œä½†æ˜¯å…¶ç¼ºç‚¹ä¾æ—§å­˜åœ¨ï¼Œä¸ºæ­¤ï¼Œ<strong>ç´§å‡‘åˆ—è¡¨(listpack)</strong> è¯ç”Ÿäº†ã€‚å®ƒå»æ‰äº† <code>prev_len</code>ï¼Œæ”¹ä¸ºåœ¨å½“å‰èŠ‚ç‚¹å†…éƒ¨è®°å½•è‡ªå·±çš„é•¿åº¦ <code>back-len</code>ï¼ˆå¹¶ä¸”ç»è¿‡ç‰¹æ®Šç¼–ç æ”¯æŒåå‘è§£ç ï¼‰ã€‚ä¿®æ”¹å½“å‰èŠ‚ç‚¹ï¼Œå†ä¹Ÿä¸ä¼šå½±å“ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„å¤´éƒ¨çš„é•¿åº¦äº†ã€‚</p>
<p>ä¸€ä¸ª <code>listpack</code> ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20251209213942454.png" alt=""></p>
<p>é‡ç‚¹åœ¨äºè¿™ä¸ª <code>back-len</code>ï¼Œå®ƒç­‰äºè¯¥æ¡ç›®è‡ªèº«çš„ <code>encoding-type</code> å’Œ <code>element-data</code> <strong>ä¸¤éƒ¨åˆ†åŠ èµ·æ¥çš„é•¿åº¦</strong>ï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸º&quot;éƒ¨åˆ†é•¿åº¦&quot;ï¼‰ã€‚å½“éœ€è¦ä»åå‘å‰éå†æ—¶ï¼Œè§£æå™¨ä¼šä»å‰ä¸€ä¸ªæ¡ç›®çš„<strong>å°¾éƒ¨</strong>ï¼Œåå‘è§£æå‡ºè¿™ä¸ª&quot;éƒ¨åˆ†é•¿åº¦&quot;ï¼Œç„¶åå†åŠ¨æ€è®¡ç®—å‡º <code>back-len</code> å­—æ®µè‡ªèº«çš„é•¿åº¦ï¼Œä¸¤è€…ç›¸åŠ å¾—åˆ°å‰ä¸€ä¸ªæ¡ç›®çš„<strong>æ€»é•¿åº¦</strong>ï¼Œä»è€Œå®ç°ç²¾ç¡®çš„å›æº¯è·³è½¬ã€‚</p>
<h2 id="3-Hash">3. Hash</h2>
<p>Hash æ˜¯ä¸€ä¸ª String ç±»å‹çš„ Field å’Œ Value çš„æ˜ å°„è¡¨ã€‚</p>
<h3 id="3-1-æ ¸å¿ƒæ“ä½œ">3.1 æ ¸å¿ƒæ“ä½œ</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŸºç¡€æ“ä½œ</span></span><br><span class="line">HSET key field value          <span class="comment"># è®¾ç½®å­—æ®µå€¼ï¼ˆå¯ä»¥åŒæ—¶è®¾ç½®å¤šä¸ªå­—æ®µï¼‰</span></span><br><span class="line">HGET key field                <span class="comment"># è·å–å­—æ®µå€¼</span></span><br><span class="line">HMSET key field1 value1 field2 value2  <span class="comment"># æ‰¹é‡è®¾ç½®å­—æ®µ</span></span><br><span class="line">HMGET key field1 field2 field3  <span class="comment"># æ‰¹é‡è·å–å­—æ®µ</span></span><br><span class="line">HGETALL key                   <span class="comment"># è·å–æ‰€æœ‰å­—æ®µå’Œå€¼</span></span><br><span class="line">HDEL key field1 field2        <span class="comment"># åˆ é™¤æŒ‡å®šå­—æ®µ</span></span><br><span class="line">HEXISTS key field             <span class="comment"># æ£€æŸ¥å­—æ®µæ˜¯å¦å­˜åœ¨</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å­—æ®µæ“ä½œ</span></span><br><span class="line">HLEN key                      <span class="comment"># è·å–å­—æ®µæ•°é‡</span></span><br><span class="line">HKEYS key                     <span class="comment"># è·å–æ‰€æœ‰å­—æ®µå</span></span><br><span class="line">HVALS key                     <span class="comment"># è·å–æ‰€æœ‰å­—æ®µå€¼</span></span><br><span class="line">HSTRLEN key field             <span class="comment"># è·å–å­—æ®µå€¼çš„å­—ç¬¦ä¸²é•¿åº¦</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ•°å€¼æ“ä½œ</span></span><br><span class="line">HINCRBY key field increment   <span class="comment"># å­—æ®µå€¼æŒ‰æŒ‡å®šæ•´æ•°é€’å¢</span></span><br><span class="line">HINCRBYFLOAT key field increment  <span class="comment"># å­—æ®µå€¼æŒ‰æŒ‡å®šæµ®ç‚¹æ•°é€’å¢</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é«˜çº§æ“ä½œï¼ˆRedis 6.2+ï¼‰</span></span><br><span class="line">HSETNX key field value        <span class="comment"># ä»…å½“å­—æ®µä¸å­˜åœ¨æ—¶è®¾ç½®</span></span><br><span class="line">HRANDFIELD key [count [WITHVALUES]]  <span class="comment"># éšæœºè·å–å­—æ®µ</span></span><br></pre></td></tr></table></figure>
<p><strong>å¸¸è§ä½¿ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li><strong>å¯¹è±¡ç¼“å­˜</strong>ï¼šå­˜å‚¨ç”¨æˆ·ä¿¡æ¯ã€å•†å“å±æ€§ç­‰ç»“æ„åŒ–æ•°æ®ï¼Œå¦‚ <code>user:1001 &#123;name: &quot;å¼ ä¸‰&quot;, age: 25, city: &quot;åŒ—äº¬&quot;&#125;</code></li>
<li><strong>è®¡æ•°å™¨é›†åˆ</strong>ï¼šæ–‡ç« çš„å¤šç»´ç»Ÿè®¡ï¼Œå¦‚ <code>article:1001 &#123;views: 1000, likes: 50, comments: 20&#125;</code></li>
<li><strong>é…ç½®ç®¡ç†</strong>ï¼šç³»ç»Ÿé…ç½®ã€ç”¨æˆ·åå¥½è®¾ç½®ç­‰é”®å€¼å¯¹é›†åˆ</li>
<li><strong>è´­ç‰©è½¦</strong>ï¼šç®€åŒ–ç‰ˆè´­ç‰©è½¦å®ç°ï¼Œ<code>cart:1001 &#123;item_001: 2, item_005: 1&#125;</code></li>
<li><strong>ä¼šè¯ç®¡ç†</strong>ï¼šæ¯” String æ›´çµæ´»çš„ session å­˜å‚¨ï¼Œæ”¯æŒç»†ç²’åº¦æ›´æ–°</li>
<li><strong>å®æ—¶ç»Ÿè®¡</strong>ï¼šç½‘ç«™åœ¨çº¿ç”¨æˆ·ç»Ÿè®¡ã€API è°ƒç”¨æ¬¡æ•°ç­‰åˆ†ç»„ç»Ÿè®¡åœºæ™¯</li>
<li><strong>æ ‡ç­¾ç³»ç»Ÿ</strong>ï¼šæ–‡ç« æ ‡ç­¾ç®¡ç†ï¼Œ<code>tags:article_001 &#123;tech: 1, redis: 1, database: 1&#125;</code></li>
</ul>
<h3 id="3-2-åº•å±‚åŸç†">3.2 åº•å±‚åŸç†</h3>
<p>Hash çš„åº•å±‚å®ç°æœ‰ä¸¤ç§ï¼š<strong>Listpack (åŸ Ziplist)</strong> å’Œ <strong>Hashtable</strong>ã€‚</p>
<table>
<thead>
<tr>
<th><strong>ç¼–ç ç±»å‹</strong></th>
<th><strong>Redis 7.0 å‰</strong></th>
<th><strong>Redis 7.0 å</strong></th>
<th><strong>è§¦å‘æ¡ä»¶ (é»˜è®¤é…ç½®)</strong></th>
<th><strong>å†…å­˜ç‰¹å¾</strong></th>
<th><strong>æŸ¥è¯¢å¤æ‚åº¦</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ç´§å‡‘å‹</strong></td>
<td><strong>Ziplist</strong></td>
<td><strong>Listpack</strong></td>
<td>å…ƒç´ æ•° &lt; 512 ä¸” å€¼é•¿åº¦ &lt; 64 å­—èŠ‚</td>
<td><strong>è¿ç»­å†…å­˜</strong>ï¼Œæ— æŒ‡é’ˆ</td>
<td><strong>O(N)</strong></td>
</tr>
<tr>
<td><strong>åˆ†æ•£å‹</strong></td>
<td><strong>Hashtable</strong></td>
<td><strong>Hashtable</strong></td>
<td>è¶…è¿‡ä¸Šè¿°ä»»ä¸€é˜ˆå€¼</td>
<td><strong>æŒ‡é’ˆ+é“¾è¡¨</strong>ï¼Œæœ‰ç¢ç‰‡</td>
<td><strong>O(1)</strong></td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!NOTE]</p>
<p><strong>ğŸ’¡ å…³é”®ç‚¹ï¼šHash çš„ Listpack å¸ƒå±€</strong> å’Œ List ä¸åŒï¼ŒHash åœ¨ Listpack ä¸­å­˜å‚¨æ—¶ï¼Œæ˜¯<strong>æˆå¯¹</strong>å‡ºç°çš„ã€‚ <code>[ Key1 | Val1 | Key2 | Val2 | ... ]</code> æŸ¥æ‰¾æ—¶ï¼ŒRedis ä»å¤´éå†ï¼Œæ‰¾åˆ° Key åï¼Œç´§æ¥ç€å–ä¸‹ä¸€ä¸ª Entry å°±æ˜¯ Valueã€‚</p>
</blockquote>
<p><code>listpack</code> çš„å­˜å‚¨ç»“æ„åœ¨ List æˆ‘ä»¬å·²ç»ä»‹ç»è¿‡äº†ï¼Œè¿™é‡Œå°±ä»‹ç» Hash çš„é»˜è®¤ç¼–ç æ ¼å¼ <code>hashtable</code>ã€‚æ„æˆ Redis å“ˆå¸Œè¡¨çš„æ ¸å¿ƒæ˜¯ <code>dict</code> åŠå…¶èŠ‚ç‚¹ <code>dictEntry</code> ç»“æ„ï¼Œæºç å¯çœ‹ï¼š<a target="_blank" rel="noopener" href="https://github.com/redis/redis/blob/8.4.0/src/dict.c">src/dict.c</a>ã€‚å®ƒä¸ä»…æ”¯æ’‘äº† Redis çš„ Hash æ•°æ®ç±»å‹ï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œ<strong>Redis æ•´ä¸ªæ•°æ®åº“ï¼ˆKV ç©ºé—´ï¼‰æœ¬èº«å°±æ˜¯ä¸€ä¸ªå·¨å¤§çš„ Dict</strong>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span> *<span class="title">next</span>;</span>  <span class="comment">/* æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè§£å†³å“ˆå¸Œå†²çª */</span></span><br><span class="line">    <span class="type">void</span> *key;               <span class="comment">/* é”® */</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span>                  <span class="comment">/* å€¼ï¼ˆä½¿ç”¨è”åˆä½“ä¼˜åŒ–å†…å­˜ï¼‰ */</span></span><br><span class="line">        <span class="type">void</span> *val;			<span class="comment">/* é€šå¸¸æŒ‡å‘ä¸€ä¸ª redisObject */</span></span><br><span class="line">        <span class="type">uint64_t</span> u64;		<span class="comment">/* æ— ç¬¦å·æ•´æ•° */</span></span><br><span class="line">        <span class="type">int64_t</span> s64;		<span class="comment">/* æœ‰ç¬¦å·æ•´æ•° */</span></span><br><span class="line">        <span class="type">double</span> d;				<span class="comment">/* æµ®ç‚¹æ•° */</span></span><br><span class="line">    &#125; v;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dict</span> &#123;</span></span><br><span class="line">    dictType *type;          <span class="comment">/* ç±»å‹ç‰¹å®šå‡½æ•° */</span></span><br><span class="line"></span><br><span class="line">    dictEntry **ht_table[<span class="number">2</span>]; <span class="comment">/* ä¸¤ä¸ªå“ˆå¸Œè¡¨ï¼Œå¹³æ—¶åªç”¨[0]ï¼Œè¿ç§»æ—¶å…±ç”¨[0]å’Œ[1] */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> ht_used[<span class="number">2</span>];<span class="comment">/* ä¸¤ä¸ªè¡¨å·²æœ‰çš„èŠ‚ç‚¹æ•°é‡ */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> rehashidx;          <span class="comment">/* Rehash è¿›åº¦ç´¢å¼• */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> pauserehash;    <span class="comment">/* Rehash æš‚åœæ ‡å¿— */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ç´§å‡‘æ’åˆ—çš„å°å˜é‡ï¼Œä¼˜åŒ–å†…å­˜å¡«å…… */</span></span><br><span class="line">    <span class="type">signed</span> <span class="type">char</span> ht_size_exp[<span class="number">2</span>]; <span class="comment">/* å¤§å°çš„æŒ‡æ•° (size = 1 &lt;&lt; exp) */</span></span><br><span class="line">    <span class="type">signed</span> pauseAutoResize: <span class="number">15</span>; <span class="comment">/* ç¦æ­¢è‡ªåŠ¨æ‰©å®¹æ ‡å¿— */</span></span><br><span class="line">    <span class="type">unsigned</span> useStoredKeyApi: <span class="number">1</span>;</span><br><span class="line">    <span class="type">void</span> *metadata[];           <span class="comment">/* å˜é•¿æ•°ç»„ï¼Œç”¨äºå­˜å‚¨é¢å¤–å…ƒæ•°æ® */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>æ‹‰é“¾æ³• (Chaining)</strong>ï¼š<code>dictEntry</code> ä¸­çš„ <code>next</code> æŒ‡é’ˆï¼Œæ˜¯ Redis è§£å†³å“ˆå¸Œå†²çªçš„åŸºç¡€æ‰‹æ®µï¼Œæ„å»ºäº† bucket å†…çš„å•å‘é“¾è¡¨ã€‚</li>
<li><strong>åŒè¡¨æ¶æ„ (Double Tables)</strong>ï¼š<code>ht_table[2]</code> æ˜¯ Redis å®ç°<strong>æ— é˜»å¡æ‰©å®¹</strong>çš„ç‰©ç†åŸºç¡€ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œåªæœ‰ <code>ht_table[0]</code> åœ¨å·¥ä½œï¼Œ<code>ht_table[1]</code> æ˜¯ç©ºçš„ã€‚å½“ <code>ht[0]</code> æ»¡äº†éœ€è¦æ‰©å®¹ï¼ˆæˆ–ç¼©å®¹ï¼‰æ—¶ï¼ŒRedis å¹¶ä¸æ˜¯åœ¨åŸè¡¨ä¸Šæ“ä½œï¼Œè€Œæ˜¯å…ˆç»™ <code>ht[1]</code> åˆ†é…æ›´å¤§çš„ç©ºé—´ï¼ˆä¸¤å€ï¼‰ï¼Œç„¶åå°† <code>ht[0]</code> çš„æ•°æ®æ…¢æ…¢æ¬åˆ° <code>ht[1]</code>ã€‚ç­‰æ¬å®Œåï¼Œåˆ é™¤ <code>ht[0]</code>ï¼ŒæŠŠ <code>ht[1]</code> å˜æˆæ–°çš„ <code>ht[0]</code>ã€‚</li>
<li><strong>æ¸è¿›å¼ Rehash (Incremental)</strong>ï¼š<code>rehashidx</code> è®°å½•å½“å‰æ¬è¿åˆ°äº† <code>ht[0]</code> çš„ç¬¬å‡ ä¸ª bucketï¼ˆæ•°ç»„ä¸‹æ ‡ï¼‰ã€‚æ¯æ¬¡å¯¹å­—å…¸è¿›è¡Œå¢åˆ æ”¹æŸ¥ï¼ˆCRUDï¼‰æ—¶ï¼Œé¡ºä¾¿æŠŠ <code>rehashidx</code> ä½ç½®çš„ä¸€ä¸ª bucket æ¬åˆ° <code>ht[1]</code>ï¼Œç„¶å <code>rehashidx++</code>ã€‚ä¸ç”¨æ‹…å¿ƒæ²¡æœ‰è¯·æ±‚æ—¶å°±ä¸€ç›´ä¸è¿ç§»ï¼Œåå°æœ‰å®šæ—¶ä»»åŠ¡ <code>serverCron</code> ä¼šåŒ…å« rehash æ“ä½œç”¨äºè¾…åŠ©è¿ç§»ï¼Œä»¥é¿å…è¿™ä¸ªé—®é¢˜ã€‚</li>
</ul>
<h2 id="4-Set">4. Set</h2>
<p>Set æ˜¯ä¸€ä¸ªæ— åºã€å”¯ä¸€çš„å­—ç¬¦ä¸²å…ƒç´ é›†åˆã€‚å…¶æ ¸å¿ƒä»·å€¼åœ¨äºé«˜æ•ˆçš„æˆå‘˜å…³ç³»åˆ¤æ–­ï¼ˆ<code>SISMEMBER</code>ï¼‰å’ŒæœåŠ¡å™¨ç«¯çš„é›†åˆè¿ç®—ï¼ˆ<code>SINTER</code>, <code>SUNION</code>, <code>SDIFF</code>ï¼‰ã€‚</p>
<h3 id="4-1-æ ¸å¿ƒæ“ä½œ">4.1 æ ¸å¿ƒæ“ä½œ</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŸºç¡€æ“ä½œ</span></span><br><span class="line">SADD key member1 member2        <span class="comment"># æ·»åŠ æˆå‘˜åˆ°é›†åˆ</span></span><br><span class="line">SREM key member1 member2        <span class="comment"># ä»é›†åˆä¸­åˆ é™¤æˆå‘˜</span></span><br><span class="line">SPOP key [count]                <span class="comment"># éšæœºå¼¹å‡ºå¹¶åˆ é™¤æˆå‘˜</span></span><br><span class="line">SRANDMEMBER key [count]         <span class="comment"># éšæœºè·å–æˆå‘˜ï¼ˆä¸åˆ é™¤ï¼‰</span></span><br><span class="line">SCARD key                       <span class="comment"># è·å–é›†åˆæˆå‘˜æ•°é‡</span></span><br><span class="line">SMEMBERS key                    <span class="comment"># è·å–æ‰€æœ‰æˆå‘˜</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆå‘˜åˆ¤æ–­</span></span><br><span class="line">SISMEMBER key member            <span class="comment"># æ£€æŸ¥æˆå‘˜æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">SMISMEMBER key member1 member2  <span class="comment"># æ‰¹é‡æ£€æŸ¥æˆå‘˜æ˜¯å¦å­˜åœ¨</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é›†åˆè¿ç®—ï¼ˆé‡è¦ï¼‰</span></span><br><span class="line">SINTER key1 key2 key3           <span class="comment"># è®¡ç®—å¤šä¸ªé›†åˆçš„äº¤é›†</span></span><br><span class="line">SINTERCARD numkeys key1 key2 [key3...] [LIMIT <span class="built_in">limit</span>]  <span class="comment"># è®¡ç®—äº¤é›†çš„åŸºæ•°</span></span><br><span class="line">SINTERSTORE destination key1 key2  <span class="comment"># è®¡ç®—äº¤é›†å¹¶å­˜å‚¨åˆ°æ–°é›†åˆ</span></span><br><span class="line">SUNION key1 key2 key3           <span class="comment"># è®¡ç®—å¤šä¸ªé›†åˆçš„å¹¶é›†</span></span><br><span class="line">SUNIONSTORE destination key1 key2  <span class="comment"># è®¡ç®—å¹¶é›†å¹¶å­˜å‚¨åˆ°æ–°é›†åˆ</span></span><br><span class="line">SDIFF key1 key2 key3            <span class="comment"># è®¡ç®—å·®é›†ï¼ˆkey1 - key2 - key3ï¼‰</span></span><br><span class="line">SDIFFSTORE destination key1 key2  <span class="comment"># è®¡ç®—å·®é›†å¹¶å­˜å‚¨åˆ°æ–°é›†åˆ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é›†åˆæ“ä½œï¼ˆRedis 6.2+ï¼‰</span></span><br><span class="line">SADD key member1 member2 [NX|XX]  <span class="comment"># NX:ä»…æ·»åŠ ä¸å­˜åœ¨çš„ï¼ŒXX:ä»…æ·»åŠ å·²å­˜åœ¨çš„</span></span><br><span class="line">SMOVE <span class="built_in">source</span> destination member   <span class="comment"># å°†æˆå‘˜ä»æºé›†åˆç§»åŠ¨åˆ°ç›®æ ‡é›†åˆ</span></span><br></pre></td></tr></table></figure>
<p><strong>å¸¸è§ä½¿ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li><strong>æ ‡ç­¾ç³»ç»Ÿ</strong>ï¼šæ–‡ç« æ ‡ç­¾ã€ç”¨æˆ·å…´è¶£æ ‡ç­¾ï¼Œ<code>SINTER</code> æ‰¾å…±åŒæ ‡ç­¾ï¼Œ<code>SUNION</code> æ‰¾æ‰€æœ‰æ ‡ç­¾</li>
<li><strong>å…±åŒå¥½å‹</strong>ï¼šç¤¾äº¤ç½‘ç»œä¸­æ‰¾å‡ºä¸¤ä¸ªç”¨æˆ·çš„å…±åŒå¥½å‹ï¼Œ<code>SINTER user:1001:friends user:1002:friends</code></li>
<li><strong>å»é‡ç»Ÿè®¡</strong>ï¼šè®¿é—®ç”¨æˆ·å»é‡ã€æœç´¢å…³é”®è¯å»é‡ï¼Œåˆ©ç”¨ Set çš„å¤©ç„¶å»é‡ç‰¹æ€§</li>
<li><strong>æƒé™æ§åˆ¶</strong>ï¼šè§’è‰²æƒé™ç®¡ç†ï¼Œ<code>SADD role:admin user,delete,create</code></li>
<li><strong>æ¨èç³»ç»Ÿ</strong>ï¼šåŸºäºå…±åŒå…´è¶£çš„ç”¨æˆ·æ¨èï¼Œ<code>SINTER user:1001:likes user:1002:likes</code></li>
<li><strong>é»‘åå•/ç™½åå•</strong>ï¼šIP é»‘ç™½åå•ã€ç”¨æˆ·é»‘åå•ç­‰ï¼Œ<code>SISMEMBER</code> å¿«é€Ÿåˆ¤æ–­</li>
<li><strong>æŠ½å¥–æ´»åŠ¨</strong>ï¼š<code>SRANDMEMBER</code> éšæœºæŠ½å–ä¸­å¥–ç”¨æˆ·ï¼Œ<code>SPOP</code> æŠ½å–å¹¶ç§»é™¤é¿å…é‡å¤ä¸­å¥–</li>
<li><strong>åœ¨çº¿ç”¨æˆ·</strong>ï¼šå®æ—¶åœ¨çº¿ç”¨æˆ·é›†åˆï¼Œ<code>SADD</code> ç”¨æˆ·ä¸Šçº¿ï¼Œ<code>SREM</code> ç”¨æˆ·ä¸‹çº¿</li>
</ul>
<h3 id="4-2-åº•å±‚åŸç†">4.2 åº•å±‚åŸç†</h3>
<p>Set åŒæ ·é‡‡ç”¨äº†åŒé‡ç¼–ç ç­–ç•¥ï¼Œåˆ†åˆ«æ˜¯ <code>hashtable</code> å’Œ <code>intset</code>ã€‚</p>
<table>
<thead>
<tr>
<th><strong>ç¼–ç ç±»å‹</strong></th>
<th><strong>åœºæ™¯</strong></th>
<th><strong>ç»“æ„æè¿°</strong></th>
<th><strong>ä¼˜ç¼ºç‚¹</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>IntSet</strong> (æ•´æ•°é›†åˆ)</td>
<td>å…ƒç´ <strong>å…¨éƒ¨æ˜¯æ•´æ•°</strong> ä¸” æ•°é‡ &lt; 512</td>
<td><strong>æœ‰åº</strong>çš„æ•´æ•°æ•°ç»„</td>
<td><strong>äºŒåˆ†æŸ¥æ‰¾ O(logN)</strong>ï¼›æè‡´çœå†…å­˜ã€‚</td>
</tr>
<tr>
<td><strong>Hashtable</strong> (å“ˆå¸Œè¡¨)</td>
<td>å…ƒç´ åŒ…å«éæ•´æ•° æˆ– æ•°é‡ &gt; 512</td>
<td>value ä¸º <code>NULL</code> çš„å­—å…¸</td>
<td>æŸ¥è¯¢ <strong>O(1)</strong>ï¼›å†…å­˜å ç”¨å¤§ã€‚</td>
</tr>
</tbody>
</table>
<p>å…¶ä¸­ <code>hashtable</code> å®Œå…¨å¤ç”¨ä¸Šæ–‡æ‰€è¿°çš„ dict ç»“æ„ã€‚é›†åˆä¸­çš„æ¯ä¸ªå…ƒç´ è¢«å­˜å‚¨ä¸º <code>dictEntry</code> ä¸­çš„ <code>key</code>ï¼Œè€Œ <code>union v</code> (å€¼) éƒ¨åˆ†åˆ™è¢«å¿½ç•¥ï¼ˆç»Ÿä¸€è®¾ä¸º NULLï¼‰ã€‚è¿™ç§è®¾è®¡ç›´æ¥åˆ©ç”¨äº† dict é”®çš„å”¯ä¸€æ€§æ¥ä¿è¯ Set å…ƒç´ çš„å”¯ä¸€æ€§ï¼Œå¹¶ç»§æ‰¿äº†å…¶ O(1) çš„æŸ¥æ‰¾æ€§èƒ½ã€‚</p>
<p>å½“ä¸€ä¸ª Set æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ—¶ï¼Œä¼šé‡‡ç”¨ <code>intset</code> ç¼–ç ï¼š</p>
<ol>
<li>é›†åˆä¸­æ‰€æœ‰å…ƒç´ å‡ä¸ºæ•´æ•°ã€‚</li>
<li>å…ƒç´ æ•°é‡æœªè¶…è¿‡ <code>set-max-intset-entries</code> é…ç½®é¡¹çš„é˜ˆå€¼ï¼ˆé»˜è®¤ä¸º 512ï¼‰ã€‚</li>
</ol>
<p><code>intset</code> æ˜¯ä¸€ç§è‡ªé€‚åº”æ•´æ•°ç¼–ç çš„æœ‰åºæ•°ç»„ã€‚å®ƒå¯ä»¥æ ¹æ®å­˜å…¥æ•´æ•°çš„èŒƒå›´ï¼Œå°†å†…éƒ¨å­˜å‚¨æ ¼å¼åŠ¨æ€å‡çº§ä¸º <code>int16_t</code>, <code>int32_t</code> æˆ– <code>int64_t</code>ï¼Œä»¥æœ€å°çš„å†…å­˜ç©ºé—´å­˜å‚¨æ•°æ®ã€‚æˆå‘˜æŸ¥æ‰¾é€šè¿‡äºŒåˆ†æœç´¢ç®—æ³•å®ç°ã€‚å®ƒçš„å®šä¹‰ä½äº <a target="_blank" rel="noopener" href="https://github.com/redis/redis/blob/8.4.0/src/intset.h#L35">src/intset.h</a>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> INTSET_ENC_INT16 (sizeof(int16_t))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INTSET_ENC_INT32 (sizeof(int32_t))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INTSET_ENC_INT64 (sizeof(int64_t))</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">intset</span> &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> encoding;  <span class="comment">// å½“å‰å…ƒç´ ç¼–ç å®½åº¦ï¼š16/32/64 ä½</span></span><br><span class="line">    <span class="type">uint32_t</span> length;    <span class="comment">// å…ƒç´ ä¸ªæ•°</span></span><br><span class="line">    <span class="type">int8_t</span> contents[];  <span class="comment">// ç´§å‡‘å­˜æ”¾æœ‰åºæ•´æ•°</span></span><br><span class="line">&#125; intset;</span><br></pre></td></tr></table></figure>
<p><strong>å‡çº§æœºåˆ¶</strong>ï¼š</p>
<ul>
<li>
<p>å¦‚æœå½“å‰å­˜çš„éƒ½æ˜¯å°æ•´æ•°ï¼ˆå¦‚ 1, 2, 100ï¼‰ï¼Œæ•°ç»„ç”¨ <code>int16</code> å­˜å‚¨ã€‚</p>
</li>
<li>
<p>å½“ä½ æ’å…¥ä¸€ä¸ªå¤§æ•´æ•°ï¼ˆå¦‚ 65536ï¼Œè¶…å‡ºäº† int16 èŒƒå›´ï¼‰ï¼ŒRedis ä¼š<strong>å°†æ•´ä¸ªæ•°ç»„çš„æ‰€æœ‰å…ƒç´ å‡çº§</strong>ä¸º <code>int32</code>ï¼Œå¹¶é‡æ–°åˆ†é…å†…å­˜ã€‚<strong>æ³¨æ„</strong>ï¼šIntSet <strong>ä¸æ”¯æŒé™çº§</strong>ã€‚ä¸€æ—¦å‡çº§ï¼Œè¿™å°±å›ä¸å»äº†ã€‚</p>
</li>
<li>
<p>å¦‚æœä½ å‘ä¸€ä¸ª IntSet æ’å…¥äº†ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ˆæ¯”å¦‚ â€œaâ€ï¼‰ï¼Œå³ä½¿ä¹‹å‰å­˜çš„å…¨æ˜¯æ•´æ•°ï¼ŒRedis ä¹Ÿä¼šç«‹åˆ»å°†å…¶è½¬æ¢ä¸º <strong>Hashtable</strong>ã€‚ä¸”ä¸å¯é€†ï¼šå°±ç®—ä½ åæ¥æŠŠ â€œaâ€ åˆ äº†ï¼Œå®ƒä¹Ÿä¸ä¼šå˜å› IntSetã€‚</p>
</li>
</ul>
<hr>
<p>è¿™é‡Œç®€å•è¡¥å……ä¸€ä¸‹ <code>int8_t contents[]</code> çš„å«ä¹‰ï¼Œå› ä¸ºç¬”è€…å¯¹ C/C++ å¹¶ä¸ç†Ÿæ‚‰ï¼Œæ‰€ä»¥ä¸€å¼€å§‹é˜…è¯»è¿™ä¸ªä»£ç å®šä¹‰çš„æ—¶å€™è¿˜è§‰å¾—å¾ˆå¥‡æ€ªï¼Ÿ</p>
<blockquote>
<p>â€”â€” ä¸ºä»€ä¹ˆ <code>int8_t[]</code> ç±»å‹çš„æ•°ç»„å¯ä»¥å­˜æ”¾ <code>int16/int32/int64</code> çš„å…ƒç´ ï¼Ÿ</p>
</blockquote>
<p>åœ¨ C99 æ ‡å‡†ä¸­ï¼Œç»“æ„ä½“æœ€åä¸€ä¸ªå…ƒç´ å¦‚æœæ˜¯æœªçŸ¥å¤§å°çš„æ•°ç»„ï¼ˆå¦‚ <code>contents[]</code>ï¼‰ï¼Œè¢«ç§°ä¸º<strong>æŸ”æ€§æ•°ç»„æˆå‘˜</strong>ã€‚<code>contents</code> æœ¬èº«ä¸å ç”¨ <code>intset</code> ç»“æ„ä½“çš„å¤§å°ï¼ˆæˆ–è€…åªè¢«è§†ä¸ºä¸€ä¸ªåç§»é‡æ ‡è®°ï¼‰ã€‚å½“æˆ‘ä»¬ä¸º <code>intset</code> åˆ†é…å†…å­˜æ—¶ï¼Œä¼šå¤šåˆ†é…ä¸€å—è¿ç»­å†…å­˜è·Ÿåœ¨ç»“æ„ä½“åé¢ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼ªä»£ç ï¼šåˆ†é…ä¸€ä¸ªåŒ…å« 10 ä¸ª int64 å…ƒç´ çš„ intset</span></span><br><span class="line"><span class="type">size_t</span> size = <span class="keyword">sizeof</span>(intset) + (<span class="number">10</span> * <span class="keyword">sizeof</span>(<span class="type">int64_t</span>));</span><br><span class="line">intset *is = <span class="built_in">malloc</span>(size);</span><br></pre></td></tr></table></figure>
<p>å£°æ˜ä¸º <code>int8_t</code>ï¼ˆå³ 1 å­—èŠ‚ï¼‰ï¼Œæ˜¯å› ä¸ºåœ¨ C è¯­è¨€ä¸­ï¼Œ<code>int8_t</code>ï¼ˆæˆ– <code>char</code>ï¼‰æ˜¯æœ€å°çš„å†…å­˜å¯»å€å•ä½ã€‚è¿™æ„å‘³ç€ <code>contents</code> æŒ‡å‘çš„æ˜¯ä¸€å—<strong>åŸå§‹çš„ã€æœªè¢«å®šä¹‰çš„å­—èŠ‚æµ</strong>ã€‚</p>
<p>Redis åœ¨è¯»å–æ•°æ®æ—¶ï¼Œå¹¶ä¸æ˜¯ç›´æ¥é€šè¿‡ä¸‹æ ‡ <code>contents[i]</code> æ¥è¯»å–ï¼ˆé‚£æ ·åªèƒ½è¯»åˆ° 1 ä¸ªå­—èŠ‚ï¼‰ï¼Œè€Œæ˜¯é€šè¿‡ä»¥ä¸‹é€»è¾‘è¿›è¡Œ<strong>æŒ‡é’ˆå¼ºè½¬å’Œåç§»è®¡ç®—</strong>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* * æ ¹æ®ç»™å®šçš„ç¼–ç æ–¹å¼ (encoding)ï¼Œè¿”å› intset ä¸­æŒ‡å®šä½ç½® (pos) çš„å…ƒç´ å€¼ã€‚</span></span><br><span class="line"><span class="comment"> * æ³¨æ„ï¼šè¿”å›å€¼ç»Ÿä¸€æå‡ä¸º int64_tï¼Œç¡®ä¿èƒ½å®¹çº³ int16, int32 å’Œ int64ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int64_t</span> _intsetGetEncoded(intset *is, <span class="type">int</span> pos, <span class="type">uint8_t</span> enc) &#123;</span><br><span class="line">    <span class="type">int64_t</span> v64;</span><br><span class="line">    <span class="type">int32_t</span> v32;</span><br><span class="line">    <span class="type">int16_t</span> v16;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æƒ…å†µ 1: é›†åˆå­˜å‚¨çš„æ˜¯ 64 ä½æ•´æ•° */</span></span><br><span class="line">    <span class="keyword">if</span> (enc == INTSET_ENC_INT64) &#123;</span><br><span class="line">        <span class="comment">/* * æ ¸å¿ƒæŒ‡é’ˆè¿ç®—ï¼š</span></span><br><span class="line"><span class="comment">         * 1. (int64_t*)is-&gt;contents : å°† int8_t* å¼ºè½¬ä¸º int64_t*ã€‚</span></span><br><span class="line"><span class="comment">         * è¿™å‘Šè¯‰ç¼–è¯‘å™¨ï¼šè¿™é‡Œçš„å†…å­˜æ­¥é•¿æ˜¯ 8 å­—èŠ‚ã€‚</span></span><br><span class="line"><span class="comment">         * 2. + pos : æŒ‡é’ˆå‘åç§»åŠ¨ pos * 8 ä¸ªå­—èŠ‚ï¼Œç²¾å‡†å®šä½åˆ°ç¬¬ pos ä¸ªå…ƒç´ ã€‚</span></span><br><span class="line"><span class="comment">         * 3. memcpy : ä»è®¡ç®—å‡ºçš„åœ°å€æ‹·è´ 8 ä¸ªå­—èŠ‚åˆ°æ ˆå˜é‡ v64 ä¸­ã€‚</span></span><br><span class="line"><span class="comment">         * ä½¿ç”¨ memcpy è€Œä¸æ˜¯ç›´æ¥èµ‹å€¼ (v64 = ...)ï¼Œæ˜¯ä¸ºäº†é˜²æ­¢å†…å­˜æœªå¯¹é½å¯¼è‡´çš„ CPU å¼‚å¸¸ã€‚</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;v64,((<span class="type">int64_t</span>*)is-&gt;contents)+pos,<span class="keyword">sizeof</span>(v64));</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* * å­—èŠ‚åºå¤„ç†ï¼š</span></span><br><span class="line"><span class="comment">         * å¦‚æœå½“å‰ CPU æ˜¯å¤§ç«¯åº (Big Endian)ï¼Œåˆ™ç¿»è½¬å­—èŠ‚é¡ºåºä¸ºå°ç«¯åºã€‚</span></span><br><span class="line"><span class="comment">         * å¦‚æœæ˜¯å°ç«¯åº (Little Endian)ï¼Œæ­¤å®ä¸åšä»»ä½•æ“ä½œã€‚</span></span><br><span class="line"><span class="comment">         * ä¿è¯æ•°æ®åœ¨å†…å­˜ä¸­ç»Ÿä¸€ä»¥å°ç«¯åºå­˜å‚¨ï¼Œå®ç°è·¨å¹³å°å…¼å®¹ã€‚</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        memrev64ifbe(&amp;v64);</span><br><span class="line">        <span class="keyword">return</span> v64;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (enc == INTSET_ENC_INT32) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;v32,((<span class="type">int32_t</span>*)is-&gt;contents)+pos,<span class="keyword">sizeof</span>(v32));</span><br><span class="line">        memrev32ifbe(&amp;v32);</span><br><span class="line">        <span class="keyword">return</span> v32;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;v16,((<span class="type">int16_t</span>*)is-&gt;contents)+pos,<span class="keyword">sizeof</span>(v16));</span><br><span class="line">        memrev16ifbe(&amp;v16);</span><br><span class="line">        <span class="keyword">return</span> v16;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-Sorted-Set">5. Sorted Set</h2>
<p>Sorted Setï¼Œå³ ZSetï¼Œå®ƒæ˜¯ä¸€ä¸ª <code>Member</code> (æˆå‘˜) åˆ° <code>Score</code> (åˆ†æ•°) çš„æœ‰åºæ˜ å°„ã€‚</p>
<ul>
<li><strong>ç‰¹æ€§</strong>ï¼šMember å”¯ä¸€ï¼ŒScore å¯é‡å¤ã€‚</li>
<li><strong>æ’åº</strong>ï¼šæŒ‰ Score ä»å°åˆ°å¤§æ’ï¼›Score ç›¸åŒï¼ŒæŒ‰ Member å­—å…¸åºæ’ã€‚</li>
</ul>
<h3 id="5-1-æ ¸å¿ƒæ“ä½œ">5.1 æ ¸å¿ƒæ“ä½œ</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŸºç¡€æ“ä½œ</span></span><br><span class="line">ZADD key score1 member1 score2 member2  <span class="comment"># æ·»åŠ æˆå‘˜åŠå…¶åˆ†æ•°</span></span><br><span class="line">ZREM key member1 member2                <span class="comment"># åˆ é™¤æŒ‡å®šæˆå‘˜</span></span><br><span class="line">ZCARD key                              <span class="comment"># è·å–é›†åˆæˆå‘˜æ•°é‡</span></span><br><span class="line">ZSCORE key member                      <span class="comment"># è·å–æˆå‘˜åˆ†æ•°</span></span><br><span class="line">ZCOUNT key min max                     <span class="comment"># ç»Ÿè®¡æŒ‡å®šåˆ†æ•°èŒƒå›´å†…çš„æˆå‘˜æ•°é‡</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ’åæŸ¥è¯¢ï¼ˆé‡è¦ï¼‰</span></span><br><span class="line">ZRANK key member                       <span class="comment"># è·å–æˆå‘˜æ’åï¼ˆä»0å¼€å§‹ï¼Œåˆ†æ•°ä»å°åˆ°å¤§ï¼‰</span></span><br><span class="line">ZREVRANK key member                    <span class="comment"># è·å–åå‘æ’åï¼ˆåˆ†æ•°ä»å¤§åˆ°å°ï¼‰</span></span><br><span class="line">ZRANGE key start stop [BYSCORE|BYLEX] [REV] [LIMIT offset count] [WITHSCORES]  <span class="comment"># è·å–æ’åèŒƒå›´å†…æˆå‘˜</span></span><br><span class="line">ZREVRANGE key start stop [WITHSCORES]  <span class="comment"># è·å–åå‘æ’åèŒƒå›´å†…æˆå‘˜</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ†æ•°èŒƒå›´æŸ¥è¯¢</span></span><br><span class="line">ZRANGEBYSCORE key min max [WITHSCORES] [LIMIT offset count]     <span class="comment"># æŒ‰åˆ†æ•°èŒƒå›´æŸ¥è¯¢</span></span><br><span class="line">ZREVRANGEBYSCORE key max min [WITHSCORES] [LIMIT offset count]  <span class="comment"># æŒ‰åˆ†æ•°èŒƒå›´åå‘æŸ¥è¯¢</span></span><br><span class="line">ZREMRANGEBYRANK key start stop         <span class="comment"># æŒ‰æ’åèŒƒå›´åˆ é™¤æˆå‘˜</span></span><br><span class="line">ZREMRANGEBYSCORE key min max           <span class="comment"># æŒ‰åˆ†æ•°èŒƒå›´åˆ é™¤æˆå‘˜</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ†æ•°æ“ä½œ</span></span><br><span class="line">ZINCRBY key increment member           <span class="comment"># å¢åŠ æŒ‡å®šæˆå‘˜çš„åˆ†æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é›†åˆè¿ç®—</span></span><br><span class="line">ZINTERSTORE destination numkeys key1 key2 [WEIGHTS w1 w2] [AGGREGATE SUM|MIN|MAX]  <span class="comment"># è®¡ç®—äº¤é›†</span></span><br><span class="line">ZUNIONSTORE destination numkeys key1 key2 [WEIGHTS w1 w2] [AGGREGATE SUM|MIN|MAX]  <span class="comment"># è®¡ç®—å¹¶é›†</span></span><br><span class="line">ZDIFFSTORE destination numkeys key1 key2  <span class="comment"># è®¡ç®—å·®é›†</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å­—å…¸åºæ“ä½œï¼ˆRedis 6.2+ï¼‰</span></span><br><span class="line">ZLEXCOUNT key min max                  <span class="comment"># ç»Ÿè®¡å­—å…¸åºèŒƒå›´å†…çš„æˆå‘˜æ•°é‡</span></span><br><span class="line">ZRANGEBYLEX key min max [LIMIT offset count]  <span class="comment"># æŒ‰å­—å…¸åºèŒƒå›´æŸ¥è¯¢</span></span><br><span class="line">ZREMRANGEBYLEX key min max             <span class="comment"># æŒ‰å­—å…¸åºèŒƒå›´åˆ é™¤</span></span><br><span class="line">ZMSCORE key member1 member2 member3    <span class="comment"># æ‰¹é‡è·å–æˆå‘˜åˆ†æ•°</span></span><br></pre></td></tr></table></figure>
<p><strong>å¸¸è§ä½¿ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li><strong>æ’è¡Œæ¦œç³»ç»Ÿ</strong>ï¼šæ¸¸æˆç§¯åˆ†æ¦œã€æ–‡ç« çƒ­åº¦æ¦œã€ç”¨æˆ·è´¢å¯Œæ¦œï¼Œ<code>ZRANGE/ZREVRANGE</code> è·å– Top N</li>
<li><strong>å»¶è¿Ÿé˜Ÿåˆ—</strong>ï¼šä»¥æ—¶é—´æˆ³ä¸ºåˆ†æ•°ï¼Œå®ç°å®šæ—¶ä»»åŠ¡è°ƒåº¦ï¼Œ<code>ZRANGEBYSCORE</code> è·å–åˆ°æœŸä»»åŠ¡</li>
<li><strong>ä¼˜å…ˆçº§é˜Ÿåˆ—</strong>ï¼šä»»åŠ¡ä¼˜å…ˆçº§ç®¡ç†ï¼Œé«˜ä¼˜å…ˆçº§ä»»åŠ¡åˆ†æ•°æ›´é«˜ï¼Œ<code>ZPOPMAX</code> è·å–æœ€é«˜ä¼˜å…ˆçº§ä»»åŠ¡</li>
<li><strong>èŒƒå›´æœç´¢</strong>ï¼šä»·æ ¼åŒºé—´å•†å“æŸ¥è¯¢ã€å¹´é¾„èŒƒå›´ç”¨æˆ·ç­›é€‰ï¼Œ<code>ZRANGEBYSCORE</code> é«˜æ•ˆèŒƒå›´æŸ¥è¯¢</li>
<li><strong>åŠ æƒæŠ•ç¥¨</strong>ï¼šç”¨æˆ·æŠ•ç¥¨ç³»ç»Ÿï¼ŒæŠ•ç¥¨æ—¶é—´è¶Šæ–°æƒé‡è¶Šé«˜ï¼ˆæ—¶é—´æˆ³ä½œä¸ºåˆ†æ•°ï¼‰</li>
<li><strong>å®æ—¶ç»Ÿè®¡</strong>ï¼šçƒ­é—¨æœç´¢è¯æ’è¡Œï¼Œæœç´¢æ¬¡æ•°ä½œä¸ºåˆ†æ•°ï¼Œ<code>ZINCRBY</code> å®æ—¶æ›´æ–°</li>
<li><strong>æ•™è‚²èµ„æº</strong>ï¼šå­¦ç”Ÿæˆç»©ç®¡ç†ï¼Œåˆ†æ•°ç›´æ¥ä½œä¸º zset åˆ†æ•°ï¼Œ<code>ZRANK</code> è·å–æ’å</li>
<li><strong>åœ°ç†ä½ç½®æ’åº</strong>ï¼šè™½ç„¶æœ‰ Geo ç±»å‹ï¼Œä½† zset å¯ä»¥å®ç°æ›´å¤æ‚çš„æ’åºé€»è¾‘</li>
</ul>
<h3 id="5-2-åº•å±‚åŸç†">5.2 åº•å±‚åŸç†</h3>
<p>Set åŒæ ·é‡‡ç”¨äº†åŒé‡ç¼–ç ç­–ç•¥ï¼Œåˆ†åˆ«æ˜¯ <code>ziplist/listpack</code> å’Œ <code>skiplist+dict</code>ã€‚</p>
<table>
<thead>
<tr>
<th><strong>ç¼–ç ç±»å‹</strong></th>
<th><strong>åœºæ™¯</strong></th>
<th><strong>ç»“æ„æè¿°</strong></th>
<th><strong>ä¼˜ç¼ºç‚¹</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ç´§å‡‘å‹</strong> (Ziplist / Listpack)</td>
<td>å…ƒç´ å°‘ï¼ˆ&lt; 128ï¼‰ä¸” å…ƒç´ å°ï¼ˆ&lt; 64 å­—èŠ‚ï¼‰</td>
<td><strong>ç´§å‡‘æ•°ç»„</strong>ã€‚Member å’Œ Score ç´§æŒ¨ç€å­˜ï¼ŒæŒ‰ Score æ’åºã€‚</td>
<td>çœå†…å­˜ï¼›æ’å…¥/æŸ¥è¯¢ <strong>O(N)</strong>ã€‚</td>
</tr>
<tr>
<td><strong>åˆ†æ•£å‹</strong> (Skiplist + Dict)</td>
<td>è¶…è¿‡é˜ˆå€¼</td>
<td><strong>è·³è¡¨ + å“ˆå¸Œè¡¨</strong> (åŒé‡ç´¢å¼•)ã€‚</td>
<td>æŸ¥è¯¢/æ’å…¥ <strong>O(logN)</strong>ï¼›å†…å­˜å ç”¨å¤§ã€‚</td>
</tr>
</tbody>
</table>
<p>ç›¸ä¿¡å¯¹é˜…è¯»åˆ°äº†è¿™é‡Œçš„è¯»è€…æ¥è¯´ï¼Œå·²ç»ä¸ä¼šå¯¹ ZSet ä½¿ç”¨ <code>listpack</code> æ„Ÿåˆ°æ„å¤–äº†ï¼Œè¿™æ˜¯ Redis é‡Œå…¸å‹çš„ç”¨æ—¶é—´æ¢ç©ºé—´çš„ç­–ç•¥äº†ã€‚</p>
<p>å½“ Sorted Set ä¸­å­˜å‚¨çš„å…ƒç´ æ•°é‡å¾ˆå°‘ï¼Œå¹¶ä¸”æ¯ä¸ªå…ƒç´ çš„å€¼éƒ½ä¸å¤§æ—¶ï¼ŒRedis ä¼šé€‰æ‹© <code>listpack</code> ç¼–ç ã€‚</p>
<p>æ¡ä»¶æ˜¯ï¼š</p>
<ul>
<li>å…ƒç´ æ•°é‡å°äº <code>zset-max-listpack-entries 128</code></li>
<li>æ‰€æœ‰å…ƒç´ å€¼çš„å­—èŠ‚é•¿åº¦å°äº <code>zset-max-listpack-value 64</code></li>
</ul>
<p>å®ƒå°†æ¯ä¸ª (member, score) å¯¹ç´§å‡‘åœ°åºåˆ—åŒ–å­˜å‚¨ã€‚ä¸ºäº†ä¿æŒæœ‰åºï¼Œæ¯æ¬¡æ’å…¥éƒ½éœ€è¦æ‰¾åˆ°æ­£ç¡®çš„ä½ç½®ï¼Œè¿™å¯èƒ½å¯¼è‡´å…¶åçš„æ•°æ®å‘ç”Ÿç§»åŠ¨ã€‚å½“ <code>N</code> éå¸¸å°ï¼ˆä¾‹å¦‚å°äº 128ï¼‰æ—¶ï¼Œğ‘‚(ğ‘) çš„æ“ä½œæˆæœ¬æä½ï¼Œå‡ ä¹æ˜¯ç¬æ—¶çš„ï¼Œè€ŒèŠ‚çœä¸‹æ¥çš„å†…å­˜å´éå¸¸å¯è§‚ã€‚</p>
<p>ä¸€æ—¦ <code>listpack</code> çš„ä»»ä¸€è§¦å‘æ¡ä»¶è¢«æ‰“ç ´ï¼ŒRedis ä¼šè‡ªåŠ¨å°†å…¶è½¬æ¢ä¸º <code>skiplist</code> + <code>dict</code> ç¼–ç ã€‚å…¶å® ZSet è¦é‡‡ç”¨&quot;åŒå¼•æ“&quot;æ¨¡å¼ï¼Œä¹Ÿä¸éš¾ç†è§£ï¼Œå®ƒè¦è§£å†³çš„æ ¸å¿ƒçŸ›ç›¾æ˜¯ï¼š<strong>å¦‚ä½•åˆ›å»ºä¸€ä¸ªæ—¢èƒ½é€šè¿‡æˆå‘˜ï¼ˆmemberï¼‰å¿«é€ŸæŸ¥æ‰¾ã€åˆèƒ½æ ¹æ®åˆ†æ•°ï¼ˆscoreï¼‰é«˜æ•ˆæ’åºå’ŒèŒƒå›´æŸ¥æ‰¾çš„æ•°æ®é›†åˆï¼Ÿ</strong></p>
<ul>
<li><strong><code>dict</code> (å­—å…¸/å“ˆå¸Œè¡¨)</strong>ï¼šè´Ÿè´£&quot;é›†åˆ&quot;çš„éƒ¨åˆ†ã€‚å®ƒå»ºç«‹äº†ä¸€ä¸ªä» <code>member</code> åˆ° <code>score</code> çš„æ˜ å°„ã€‚è¿™ä½¿å¾— <code>ZSCORE</code> è¿™ç§é€šè¿‡æˆå‘˜è·å–åˆ†æ•°çš„æ“ä½œï¼Œæ—¶é—´å¤æ‚åº¦ ğ‘‚(1)ã€‚</li>
<li><strong><code>skiplist</code> (è·³è¡¨)</strong>ï¼šè´Ÿè´£&quot;æ’åº&quot;çš„éƒ¨åˆ†ã€‚å®ƒå°†æ‰€æœ‰çš„ <code>(score, member)</code> å¯¹æŒ‰ç…§ <code>score</code>ï¼ˆåˆ†æ•°ç›¸åŒåˆ™æŒ‰ <code>member</code> å­—å…¸åºï¼‰è¿›è¡Œæ’åºã€‚è·³è¡¨çš„ç‰¹æ€§ä½¿å¾—æ’å…¥ã€åˆ é™¤å’ŒæŒ‰æ’å/åˆ†æ•°èŒƒå›´æŸ¥æ‰¾çš„å¹³å‡æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ ğ‘‚(ğ‘™ğ‘œğ‘”ğ‘)ã€‚</li>
</ul>
<blockquote>
<p>ä¸ºäº†èŠ‚çº¦å†…å­˜ï¼Œ<code>dict</code> å’Œ <code>skiplist</code> ä¸­çš„ <code>member</code> å­—ç¬¦ä¸²æ˜¯å…±äº«çš„ï¼Œå³å®ƒä»¬éƒ½æŒ‡å‘åŒä¸€ä¸ª <code>SDS (Simple Dynamic String)</code> å¯¹è±¡ã€‚</p>
</blockquote>
<p>è·³è¡¨çš„æ ¸å¿ƒæ€æƒ³æ˜¯<strong>ç©ºé—´æ¢æ—¶é—´</strong>å’Œ<strong>éšæœºåŒ–</strong>ã€‚</p>
<p>æƒ³è±¡ä¸€ä¸‹ï¼Œä¸€ä¸ªæ™®é€šçš„å•é“¾è¡¨ï¼ŒæŸ¥æ‰¾æ•ˆç‡æ˜¯ ğ‘‚(ğ‘)ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬ä»è¿™ä¸ªé“¾è¡¨ä¸­ï¼ŒéšæœºæŠ½å–ä¸€äº›èŠ‚ç‚¹ï¼Œç»™å®ƒä»¬å¢åŠ ä¸€ä¸ª&quot;ä¸Šå±‚æŒ‡é’ˆ&quot;ï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªè¢«æŠ½å–çš„èŠ‚ç‚¹ã€‚è¿™æ ·æˆ‘ä»¬å°±æ„å»ºäº†ç¬¬ 2 å±‚&quot;å¿«é€Ÿé€šé“&quot;ã€‚æˆ‘ä»¬å¯ä»¥ä¸æ–­é‡å¤è¿™ä¸ªè¿‡ç¨‹ï¼Œæ„å»ºå‡ºå¤šå±‚å¿«é€Ÿé€šé“ã€‚</p>
<p>å½“æˆ‘ä»¬è¦æŸ¥æ‰¾ä¸€ä¸ªå…ƒç´ æ—¶ï¼š</p>
<ol>
<li>ä»æœ€é«˜å±‚çš„&quot;å¿«é€Ÿé€šé“&quot;å¼€å§‹ã€‚</li>
<li>åœ¨å½“å‰å±‚å‘å³æŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ¯”ç›®æ ‡å¤§ï¼Œæˆ–è€…åˆ°äº†é“¾è¡¨æœ«å°¾ã€‚</li>
<li>ç„¶åä»å½“å‰èŠ‚ç‚¹ä¸‹é™ä¸€å±‚ï¼Œé‡å¤æ­¥éª¤ 2ã€‚</li>
<li>æœ€ç»ˆåœ¨æœ€åº•å±‚ï¼ˆåŸå§‹é“¾è¡¨ï¼‰æ‰¾åˆ°ç›®æ ‡ä½ç½®ã€‚</li>
</ol>
<p>å› ä¸ºé«˜å±‚ç´¢å¼•å¯ä»¥è®©ä½ &quot;è·³è¿‡&quot;å¤§é‡èŠ‚ç‚¹ï¼Œæ‰€ä»¥å¹³å‡æŸ¥æ‰¾æ•ˆç‡è¢«æå‡åˆ°äº† ğ‘‚(ğ‘™ğ‘œğ‘”ğ‘)ã€‚è€Œè¿™ç§å±‚çº§çš„å»ºç«‹æ˜¯å®Œå…¨éšæœºçš„ï¼Œå®ƒé€šè¿‡æ¦‚ç‡æ¥ç»´æŒæ•´ä½“çš„å¹³è¡¡ï¼Œé¿å…äº†çº¢é»‘æ ‘é‚£æ ·å¤æ‚çš„å¹³è¡¡æ“ä½œã€‚</p>
<p>è¿™å°±æ˜¯ Redis é€‰æ‹©è·³è¡¨çš„åŸå› ï¼š<strong>ç”¨æ›´ç®€å•çš„å®ç°ï¼Œè¾¾åˆ°äº†ä¸å¹³è¡¡æ ‘ç›¸åª²ç¾çš„æ€§èƒ½ã€‚</strong></p>
<p>åœ¨ Redis 8.4.0 çš„æºç ä¸­ï¼Œå…³äº <code>zset</code> çš„ç±»å‹å®šä¹‰ä½äº <a target="_blank" rel="noopener" href="https://github.com/redis/redis/blob/8.4.0/src/server.h#L1599">src/server.h</a> æ–‡ä»¶ä¸­ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼Œå®ƒä¸»è¦åŒ…å« 3 ä¸ªæ ¸å¿ƒæ•°æ®ç»“æ„ï¼š<code>zset</code>ã€<code>zskiplist</code> å’Œ <code>zskiplistNode</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·³è¡¨èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> &#123;</span></span><br><span class="line">    sds ele;          <span class="comment">/* æˆå‘˜å­—ç¬¦ä¸² */</span></span><br><span class="line">    <span class="type">double</span> score;     <span class="comment">/* åˆ†å€¼ï¼ˆæ’åºä¸»é”®ï¼‰ */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">backward</span>;</span> <span class="comment">/* åå‘éå†æŒ‡é’ˆï¼ˆæŒ‡å‘å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼‰ */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistLevel</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">forward</span>;</span> <span class="comment">/* æœ¬å±‚å‰è¿›æŒ‡é’ˆ */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> span;            <span class="comment">/* åˆ° forward çš„èŠ‚ç‚¹æ•°ï¼Œç”¨äºæ’åè®¡ç®— */</span></span><br><span class="line">    &#125; level[];        <span class="comment">/* å¯å˜å±‚é«˜çš„å±‚æ•°ç»„ */</span></span><br><span class="line">&#125; zskiplistNode;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·³è¡¨ç»“æ„</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zskiplist</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">header</span>, *<span class="title">tail</span>;</span> <span class="comment">/* å“¨å…µå¤´/å°¾ */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> length;                <span class="comment">/* èŠ‚ç‚¹æ€»æ•° */</span></span><br><span class="line">    <span class="type">int</span> level;                           <span class="comment">/* å½“å‰æœ€é«˜å±‚æ•° */</span></span><br><span class="line">    <span class="type">size_t</span> alloc_size;                   <span class="comment">/* å†…å­˜ç»Ÿè®¡ */</span></span><br><span class="line">&#125; zskiplist;</span><br><span class="line"></span><br><span class="line"><span class="comment">// zset ç»“æ„</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zset</span> &#123;</span></span><br><span class="line">    dict *dict;        <span class="comment">/* æˆå‘˜ -&gt; score æ˜ å°„ï¼ŒO(1) æŸ¥æ‰¾/åˆ¤é‡ */</span></span><br><span class="line">    zskiplist *zsl;    <span class="comment">/* æŒ‰ score+å­—å…¸åºæ’åºçš„è·³è¡¨ï¼Œæ”¯æŒèŒƒå›´/æ’å */</span></span><br><span class="line">&#125; zset;</span><br></pre></td></tr></table></figure>
<p>ä»æ¯”è¾ƒç›´è§‚çš„è§’åº¦æ¥è®²çš„è¯ï¼Œè·³è¡¨çš„ç»“æ„å¯ä»¥ç”¨ä¸‹å›¾æ¥æ¼”ç¤ºï¼š</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250918190254554.png" alt=""></p>
<p>å¦‚æœè¦å®Œå…¨å¤åˆ»ä¸Šè¿°æ‰€å®šä¹‰å‡ºæ¥çš„æ•°æ®ç»“æ„ï¼Œé‚£è¡¨ç¤ºèµ·æ¥å¯èƒ½ä¼šæœ‰ç‚¹å¤æ‚ï¼Œè¿™é‡Œæˆ‘ç”»äº†å¼ å›¾ï¼Œä¾›ä½ å‚è€ƒï¼š</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20250918190417220.png" alt=""></p>
<p>æœ¬ç¯‡é™äºç¯‡å¹…åŸå› å’Œé˜…è¯»æ€§ä»·æ¯”çš„å…³ç³»ï¼Œç¬”è€…å¯¹ç»å¤§å¤šæ•°æ•°æ®ç»“æ„éƒ½ä¸å¤ªæ„¿æ„å±•å¼€æºç ï¼Œä¸è¿‡ä»‹äº skiplist æ˜¯ä¸€ä¸ªéå¸¸å¸¸è€ƒçš„ç‚¹ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªæ¯”è¾ƒè‰ºæœ¯æ€§çš„å®ç°ï¼Œæ‰€ä»¥åœ¨æœ¬ç« èŠ‚æˆ‘ä»¬å°†ä»ä¸€ä¸ªæœ€æ ¸å¿ƒçš„<strong>æ’å…¥</strong>é€»è¾‘æ¥æ›´è¿›ä¸€æ­¥äº†è§£è·³è¡¨çš„å®ç°ç»†èŠ‚ã€‚ <code>zset</code> çš„æ ¸å¿ƒå®ç°é€»è¾‘ä½äº <a target="_blank" rel="noopener" href="https://github.com/redis/redis/blob/8.4.0/src/t_zset.c#L140">src/t_zset.c</a> æ–‡ä»¶ä¸­ï¼Œå…¶ä¸­æ’å…¥æ“ä½œç”± <code>zslInsert</code> å‡½æ•°æ¥å®ç°ã€‚è¿™é‡Œæˆ‘å…ˆæŠŠå®Œæ•´çš„ä»£ç å’Œæ³¨é‡Šç»™ä½ ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å†ä¸€ä¸€æ‹†è§£ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* åœ¨è·³è¡¨ä¸­æ’å…¥ä¸€ä¸ªæ–°èŠ‚ç‚¹ã€‚</span></span><br><span class="line"><span class="comment"> * å‡è®¾ï¼šè°ƒç”¨è€…å·²ç»æ£€æŸ¥è¿‡è¯¥å…ƒç´ ä¸å­˜åœ¨ï¼ˆRedis åœ¨è°ƒç”¨æ­¤å‡½æ•°å‰ä¼šåœ¨ dict ä¸­æ£€æŸ¥ï¼‰ã€‚</span></span><br><span class="line"><span class="comment"> * æ³¨æ„ï¼šè·³è¡¨ä¼šæ¥ç®¡ä¼ å…¥çš„ SDS å­—ç¬¦ä¸² &#x27;ele&#x27; çš„æ‰€æœ‰æƒã€‚*/</span></span><br><span class="line">zskiplistNode *<span class="title function_">zslInsert</span><span class="params">(zskiplist *zsl, <span class="type">double</span> score, sds ele)</span> &#123;</span><br><span class="line">    <span class="comment">// update[]: è®°å½•æ¯ä¸€å±‚ä¸­ï¼Œæ–°èŠ‚ç‚¹åº”è¯¥æ’å…¥åœ¨å“ªä¸ªèŠ‚ç‚¹ä¹‹åï¼ˆå³å‰é©±èŠ‚ç‚¹ï¼‰</span></span><br><span class="line">    zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x;</span><br><span class="line">    <span class="comment">// rank[]: è®°å½• update[i] èŠ‚ç‚¹åœ¨æ•´ä¸ªé“¾è¡¨ä¸­çš„æ’åï¼ˆä»å¤´èŠ‚ç‚¹åˆ°è¯¥èŠ‚ç‚¹çš„è·¨åº¦ä¹‹å’Œï¼‰</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rank[ZSKIPLIST_MAXLEVEL];</span><br><span class="line">    <span class="type">int</span> i, level;</span><br><span class="line"></span><br><span class="line">    serverAssert(!isnan(score));</span><br><span class="line">    x = zsl-&gt;header;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">     * æ­¥éª¤ 1: è‡ªé¡¶å‘ä¸‹æŸ¥æ‰¾æ’å…¥ä½ç½®</span></span><br><span class="line"><span class="comment">     * ---------------------------------------------------------------------- */</span></span><br><span class="line">    <span class="keyword">for</span> (i = zsl-&gt;level<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="comment">/* è®¡ç®— rank:</span></span><br><span class="line"><span class="comment">         * å¦‚æœæ˜¯æœ€é«˜å±‚ï¼Œrank åˆå§‹ä¸º 0ã€‚</span></span><br><span class="line"><span class="comment">         * å¦åˆ™ï¼Œrank ç»§æ‰¿ä¸Šä¸€å±‚å·²ç»èµ°è¿‡çš„æ­¥æ•° (rank[i+1])ã€‚</span></span><br><span class="line"><span class="comment">         * è¿™å®ç°äº†è·¯å¾„ç´¯åŠ ï¼šæ¯”å¦‚ L3 èµ°äº† 10 æ­¥ï¼Œé™åˆ° L2 æ—¶ï¼Œèµ·ç‚¹å°±æ˜¯ 10ã€‚</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        rank[i] = i == (zsl-&gt;level<span class="number">-1</span>) ? <span class="number">0</span> : rank[i+<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* å‘åéå†ï¼šç›´åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„ score &gt;= æ–° score (æˆ– score ç›¸ç­‰ä½† ele å­—å…¸åºæ›´å¤§) */</span></span><br><span class="line">        <span class="keyword">while</span> (x-&gt;level[i].forward &amp;&amp;</span><br><span class="line">                (x-&gt;level[i].forward-&gt;score &lt; score ||</span><br><span class="line">                    (x-&gt;level[i].forward-&gt;score == score &amp;&amp;</span><br><span class="line">                    sdscmp(x-&gt;level[i].forward-&gt;ele,ele) &lt; <span class="number">0</span>)))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// ç´¯åŠ ç»è¿‡çš„è·¨åº¦ span åˆ° rank[i]</span></span><br><span class="line">            rank[i] += x-&gt;level[i].span;</span><br><span class="line">            x = x-&gt;level[i].forward;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è®°å½•ç¬¬ i å±‚çš„å‰é©±èŠ‚ç‚¹</span></span><br><span class="line">        update[i] = x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æ­¤æ—¶ï¼Œrank[0] ä¿å­˜çš„æ˜¯æ’å…¥ä½ç½®å‰ä¸€ä¸ªèŠ‚ç‚¹çš„æ€»æ’å */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">     * æ­¥éª¤ 2: ç”Ÿæˆéšæœºå±‚æ•°</span></span><br><span class="line"><span class="comment">     * ---------------------------------------------------------------------- */</span></span><br><span class="line">    <span class="comment">// å¹‚æ¬¡å®šå¾‹éšæœºç”Ÿæˆå±‚æ•° (1/4 æ¦‚ç‡)</span></span><br><span class="line">    level = zslRandomLevel();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœæ–°ç”Ÿæˆçš„å±‚æ•°æ¯”å½“å‰è·³è¡¨æœ€é«˜å±‚è¿˜é«˜</span></span><br><span class="line">    <span class="keyword">if</span> (level &gt; zsl-&gt;level) &#123;</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–å¤šå‡ºæ¥çš„å±‚çº§</span></span><br><span class="line">        <span class="keyword">for</span> (i = zsl-&gt;level; i &lt; level; i++) &#123;</span><br><span class="line">            rank[i] = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// æ–°å±‚çº§çš„å‰é©±è‡ªç„¶æ˜¯ header</span></span><br><span class="line">            update[i] = zsl-&gt;header;</span><br><span class="line">            <span class="comment">// header åœ¨è¿™äº›æ–°å±‚çº§çš„ span æš‚æ—¶è¦†ç›–æ•´ä¸ªé“¾è¡¨é•¿åº¦</span></span><br><span class="line">            <span class="comment">// (å› ä¸º header åç›´æ¥å°±æ˜¯ NULLï¼Œæˆ–è€…å³å°†æ’å…¥çš„æ–°èŠ‚ç‚¹)</span></span><br><span class="line">            update[i]-&gt;level[i].span = zsl-&gt;length;</span><br><span class="line">        &#125;</span><br><span class="line">        zsl-&gt;level = level; <span class="comment">// æ›´æ–°è·³è¡¨æœ€å¤§å±‚æ•°</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">     * æ­¥éª¤ 3: åˆ›å»ºèŠ‚ç‚¹å¹¶è°ƒæ•´æŒ‡é’ˆä¸ Span (æœ€éš¾ç‚¹)</span></span><br><span class="line"><span class="comment">     * ---------------------------------------------------------------------- */</span></span><br><span class="line">    x = zslCreateNode(zsl,level,score,ele);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€å±‚å¤„ç†æŒ‡é’ˆé“¾æ¥å’Œ span è®¡ç®—</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; level; i++) &#123;</span><br><span class="line">        <span class="comment">// æ ‡å‡†çš„é“¾è¡¨æ’å…¥æ“ä½œ:</span></span><br><span class="line">        <span class="comment">// NewNode-&gt;Next = PrevNode-&gt;Next</span></span><br><span class="line">        <span class="comment">// PrevNode-&gt;Next = NewNode</span></span><br><span class="line">        x-&gt;level[i].forward = update[i]-&gt;level[i].forward;</span><br><span class="line">        update[i]-&gt;level[i].forward = x;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* è®¡ç®— span çš„é€»è¾‘ï¼š</span></span><br><span class="line"><span class="comment">         * update[i]-&gt;level[i].span æ˜¯åŸå…ˆ update[i] åˆ°å…¶ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„è·ç¦»ã€‚</span></span><br><span class="line"><span class="comment">         * ç°åœ¨ä¸­é—´æ’äº†ä¸ª xã€‚</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * rank[0]: æ’å…¥ç‚¹ä¹‹å‰çš„æ€»æ’åã€‚</span></span><br><span class="line"><span class="comment">         * rank[i]: update[i] èŠ‚ç‚¹çš„æ€»æ’åã€‚</span></span><br><span class="line"><span class="comment">         * (rank[0] - rank[i]): update[i] å’Œ å®é™…æ’å…¥ç‚¹(L0å±‚) ä¹‹é—´çš„è·ç¦»ã€‚</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. è®¾ç½®æ–°èŠ‚ç‚¹ x çš„ span</span></span><br><span class="line">        <span class="comment">// x çš„ span = åŸå‰é©±çš„ span - (å‰é©±åˆ° x çš„è·ç¦»)</span></span><br><span class="line">        x-&gt;level[i].span = update[i]-&gt;level[i].span - (rank[<span class="number">0</span>] - rank[i]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. æ›´æ–°å‰é©±èŠ‚ç‚¹ update[i] çš„ span</span></span><br><span class="line">        <span class="comment">// å‰é©±çš„ span = (å‰é©±åˆ° x çš„è·ç¦») + 1 (è¿™ä¸ª 1 æ˜¯ x èŠ‚ç‚¹æœ¬èº«)</span></span><br><span class="line">        update[i]-&gt;level[i].span = (rank[<span class="number">0</span>] - rank[i]) + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯¹äºæ¯”æ–°èŠ‚ç‚¹å±‚æ•°æ›´é«˜çš„å±‚çº§ï¼Œç»“æ„æ²¡å˜ï¼Œåªæ˜¯åº•å±‚å¤šäº†ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="comment">// æ‰€ä»¥è¿™äº›å±‚çº§çš„ span åªéœ€è¦ç®€å•çš„ +1</span></span><br><span class="line">    <span class="keyword">for</span> (i = level; i &lt; zsl-&gt;level; i++) &#123;</span><br><span class="line">        update[i]-&gt;level[i].span++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">     * æ­¥éª¤ 4: è®¾ç½®åé€€æŒ‡é’ˆ (ç”¨äº L0 å±‚åŒå‘éå†)</span></span><br><span class="line"><span class="comment">     * ---------------------------------------------------------------------- */</span></span><br><span class="line">    <span class="comment">// å¦‚æœå‰é©±æ˜¯ headerï¼Œbackward è®¾ä¸º NULL (header ä¸ä½œä¸ºæ•°æ®èŠ‚ç‚¹)</span></span><br><span class="line">    x-&gt;backward = (update[<span class="number">0</span>] == zsl-&gt;header) ? <span class="literal">NULL</span> : update[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„ backward æŒ‡å‘æ–°èŠ‚ç‚¹ x</span></span><br><span class="line">    <span class="keyword">if</span> (x-&gt;level[<span class="number">0</span>].forward)</span><br><span class="line">        x-&gt;level[<span class="number">0</span>].forward-&gt;backward = x;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">// å¦‚æœ x æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ›´æ–° tail æŒ‡é’ˆ</span></span><br><span class="line">        zsl-&gt;tail = x;</span><br><span class="line"></span><br><span class="line">    zsl-&gt;length++;</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ’å…¥æ“ä½œä¸»è¦åˆ†ä¸ºå››ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li><strong>æŸ¥æ‰¾æ’å…¥ä½ç½®ï¼ˆSearchï¼‰</strong>ï¼šä»æœ€é«˜å±‚å¾€ä¸‹æ‰¾ï¼Œè®°å½•æ¯å±‚çš„å‰é©±èŠ‚ç‚¹ï¼ˆ<code>update[]</code>ï¼‰å’Œåˆ°è¾¾å‰é©±èŠ‚ç‚¹çš„æ’åï¼ˆ<code>rank[]</code>ï¼‰ã€‚</li>
<li><strong>ç”Ÿæˆéšæœºå±‚æ•°ï¼ˆRandom Levelï¼‰</strong>ï¼šå†³å®šæ–°èŠ‚ç‚¹çš„é«˜åº¦ã€‚å¦‚æœæ¯”å½“å‰è·³è¡¨é«˜ï¼Œéœ€è¦åˆå§‹åŒ–é«˜å±‚çš„å‰é©±ã€‚</li>
<li><strong>åˆ›å»ºèŠ‚ç‚¹ä¸é“¾æ¥ï¼ˆLinkï¼‰</strong>ï¼šè°ƒæ•´æŒ‡é’ˆï¼Œåœ¨ <code>0</code> åˆ° <code>level-1</code> çš„æ¯ä¸€å±‚ä¸­å°†æ–°èŠ‚ç‚¹æ’å…¥é“¾è¡¨ï¼Œå¹¶<strong>æå…¶ç²¾ç»†åœ°è®¡ç®—æ–°æ—§èŠ‚ç‚¹çš„ span å€¼</strong>ã€‚</li>
<li><strong>æ”¶å°¾å·¥ä½œ</strong>ï¼šæ›´æ–°é«˜å±‚çš„ spanï¼ˆåªåŠ  1ï¼‰ï¼Œè®¾ç½®åé€€æŒ‡é’ˆï¼Œæ›´æ–°é•¿åº¦ã€‚</li>
</ol>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä¸€ä¸€æ‹†è§£è¿™æ®µä»£ç çš„æ¯ä¸€ä¸ªç»†èŠ‚ã€‚</p>
<p><strong>ç¬¬ 0 æ­¥ï¼šåˆå§‹åŒ–ä¸å‡†å¤‡</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">zskiplistNode *<span class="title function_">zslInsert</span><span class="params">(zskiplist *zsl, <span class="type">double</span> score, sds ele)</span> &#123;</span><br><span class="line">    <span class="comment">// update[]: è®°å½•æ¯ä¸€å±‚ä¸­ï¼Œæ–°èŠ‚ç‚¹åº”è¯¥æ’å…¥åœ¨å“ªä¸ªèŠ‚ç‚¹ä¹‹åï¼ˆå³å‰é©±èŠ‚ç‚¹ï¼‰</span></span><br><span class="line">    zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x;</span><br><span class="line">    <span class="comment">// rank[]: è®°å½• update[i] èŠ‚ç‚¹åœ¨æ•´ä¸ªé“¾è¡¨ä¸­çš„æ’åï¼ˆä»å¤´èŠ‚ç‚¹åˆ°è¯¥èŠ‚ç‚¹çš„è·¨åº¦ä¹‹å’Œï¼‰</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rank[ZSKIPLIST_MAXLEVEL];</span><br><span class="line">    <span class="type">int</span> i, level;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>zskiplistNode *update[ZSKIPLIST_MAXLEVEL]</code>: <strong>è·¯å¾„è®°å½•ä»ª</strong>ã€‚å®ƒæ˜¯ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„ï¼Œ<code>update[i]</code> å°†ç”¨äºå­˜å‚¨æ–°èŠ‚ç‚¹åœ¨ç¬¬ <code>i</code> å±‚çš„å‰é©±èŠ‚ç‚¹ã€‚ä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Ÿå› ä¸ºæ’å…¥æ“ä½œçš„æœ¬è´¨å°±æ˜¯åœ¨ <code>update[i]</code> å’Œå®ƒåŸæ¥çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¹‹é—´ï¼Œæ’å…¥æˆ‘ä»¬çš„æ–°èŠ‚ç‚¹ã€‚è¿™ä¸ªæ•°ç»„ä¸ºæˆ‘ä»¬ä¿å­˜äº†æ‰€æœ‰éœ€è¦ä¿®æ”¹çš„è¿æ¥ç‚¹ã€‚</li>
<li><code>unsigned long rank[ZSKIPLIST_MAXLEVEL]</code>: <strong>è·ç¦»è®¡æ•°å™¨</strong>ã€‚<code>rank[i]</code> ç”¨äºè®°å½•ä»è·³è¡¨ <code>header</code> å¤´èŠ‚ç‚¹å‡ºå‘ï¼Œåˆ°è¾¾ <code>update[i]</code> è¿™ä¸ªèŠ‚ç‚¹æ—¶ï¼Œåœ¨æœ€åº•å±‚ï¼ˆç¬¬ 0 å±‚ï¼‰æ€»å…±è·¨è¶Šäº†å¤šå°‘ä¸ªèŠ‚ç‚¹ã€‚å®ƒçš„æ ¸å¿ƒä½œç”¨æ˜¯ä¸ºåç»­ç²¾ç¡®è®¡ç®—å’Œæ›´æ–°èŠ‚ç‚¹çš„ <code>span</code>ï¼ˆè·¨åº¦ï¼‰æä¾›æ•°æ®æ”¯æŒï¼Œè¿™æ˜¯ <code>ZRANK</code> å‘½ä»¤èƒ½å¤Ÿå®ç° ğ‘‚(ğ‘™ğ‘œğ‘”ğ‘) çš„åŸºçŸ³ã€‚</li>
</ul>
<p><strong>ç¬¬ 1 æ­¥ï¼šæŸ¥æ‰¾æ’å…¥ä½ç½®å¹¶è®°å½•è·¯å¾„</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">x = zsl-&gt;header;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> * æ­¥éª¤ 1: è‡ªé¡¶å‘ä¸‹æŸ¥æ‰¾æ’å…¥ä½ç½®</span></span><br><span class="line"><span class="comment"> * ---------------------------------------------------------------------- */</span></span><br><span class="line"><span class="keyword">for</span> (i = zsl-&gt;level<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">    <span class="comment">/* è®¡ç®— rank:</span></span><br><span class="line"><span class="comment">     * å¦‚æœæ˜¯æœ€é«˜å±‚ï¼Œrank åˆå§‹ä¸º 0ã€‚</span></span><br><span class="line"><span class="comment">     * å¦åˆ™ï¼Œrank ç»§æ‰¿ä¸Šä¸€å±‚å·²ç»èµ°è¿‡çš„æ­¥æ•° (rank[i+1])ã€‚</span></span><br><span class="line"><span class="comment">     * è¿™å®ç°äº†è·¯å¾„ç´¯åŠ ï¼šæ¯”å¦‚ L3 èµ°äº† 10 æ­¥ï¼Œé™åˆ° L2 æ—¶ï¼Œèµ·ç‚¹å°±æ˜¯ 10ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    rank[i] = i == (zsl-&gt;level<span class="number">-1</span>) ? <span class="number">0</span> : rank[i+<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å‘åéå†ï¼šç›´åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„ score &gt;= æ–° score (æˆ– score ç›¸ç­‰ä½† ele å­—å…¸åºæ›´å¤§) */</span></span><br><span class="line">    <span class="keyword">while</span> (x-&gt;level[i].forward &amp;&amp;</span><br><span class="line">            (x-&gt;level[i].forward-&gt;score &lt; score ||</span><br><span class="line">                (x-&gt;level[i].forward-&gt;score == score &amp;&amp;</span><br><span class="line">                sdscmp(x-&gt;level[i].forward-&gt;ele,ele) &lt; <span class="number">0</span>)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// ç´¯åŠ ç»è¿‡çš„è·¨åº¦ span åˆ° rank[i]</span></span><br><span class="line">        rank[i] += x-&gt;level[i].span;</span><br><span class="line">        x = x-&gt;level[i].forward;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®°å½•ç¬¬ i å±‚çš„å‰é©±èŠ‚ç‚¹</span></span><br><span class="line">    update[i] = x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯è·³è¡¨ç®—æ³•çš„ç²¾é«“æ‰€åœ¨â€”â€”<strong>åˆ†å±‚æŸ¥æ‰¾</strong>ã€‚</p>
<ul>
<li><code>for (i = zsl-&gt;level-1; i &gt;= 0; i--)</code>: å¾ªç¯ä»æœ€é«˜å±‚ï¼ˆ<code>zsl-&gt;level-1</code>ï¼‰å¼€å§‹ï¼Œé€å±‚ä¸‹é™åˆ°æœ€åº•å±‚ï¼ˆ<code>0</code>ï¼‰ã€‚è¿™æ¨¡ä»¿äº†æˆ‘ä»¬åœ¨åœ°å›¾ä¸ŠæŸ¥æ‰¾ä½ç½®çš„è¿‡ç¨‹ï¼šå…ˆçœ‹æ´²é™…åœ°å›¾ï¼ˆé«˜å±‚ï¼‰ï¼Œå†çœ‹å›½å®¶åœ°å›¾ï¼ˆä¸­å±‚ï¼‰ï¼Œæœ€åçœ‹åŸå¸‚è¡—é“å›¾ï¼ˆåº•å±‚ï¼‰ã€‚é«˜å±‚çº§çš„&quot;å¿«é€Ÿé€šé“&quot;å¯ä»¥è®©æˆ‘ä»¬ä¸€æ¬¡æ€§è·³è¿‡å¤§é‡èŠ‚ç‚¹ã€‚</li>
<li><code>while (...)</code>: åœ¨å½“å‰å±‚çº§ï¼Œä¸æ–­å‘å³ç§»åŠ¨ã€‚åˆ¤æ–­æ¡ä»¶ <code>(score &lt; ... || (score == ... &amp;&amp; ele &lt; ...))</code> ä¿è¯äº†è·³è¡¨çš„æ’åºè§„åˆ™ï¼šä¼˜å…ˆæŒ‰ <code>score</code> å‡åºï¼Œå¦‚æœ <code>score</code> ç›¸åŒï¼Œåˆ™æŒ‰ <code>member</code> çš„å­—å…¸åºå‡åºã€‚</li>
<li><code>rank[i] += x-&gt;level[i].span;</code>: è¿™æ˜¯ <code>rank</code> æ•°ç»„å·¥ä½œçš„æ ¸å¿ƒã€‚æ¯å½“æˆ‘ä»¬ä» <code>x</code> èŠ‚ç‚¹è·³åˆ°å®ƒçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œå¹¶ä¸æ˜¯åªå‰è¿›äº†ä¸€æ­¥ï¼Œè€Œæ˜¯å‰è¿›äº† <code>x-&gt;level[i].span</code> æ­¥ã€‚æˆ‘ä»¬å°†è¿™ä¸ªè·¨åº¦ç´¯åŠ åˆ° <code>rank[i]</code> ä¸­ï¼Œ<code>rank[i]</code> å°±å®æ—¶è®°å½•äº†æˆ‘ä»¬è·ç¦»èµ·ç‚¹çš„æ€»æ­¥æ•°ã€‚</li>
<li><code>update[i] = x;</code>: å½“ <code>while</code> å¾ªç¯ç»“æŸæ—¶ï¼Œ<code>x</code> èŠ‚ç‚¹å°±æ˜¯æ–°èŠ‚ç‚¹åœ¨ç¬¬ <code>i</code> å±‚çš„å‰é©±èŠ‚ç‚¹ã€‚æˆ‘ä»¬å°†å…¶è®°å½•åœ¨ <code>update[i]</code> ä¸­ã€‚å½“æ•´ä¸ª <code>for</code> å¾ªç¯ç»“æŸåï¼Œ<code>update</code> æ•°ç»„å°±å®Œæ•´è®°å½•äº†ä»æœ€é«˜å±‚åˆ°æœ€åº•å±‚çš„ä¸€æ¡æ’å…¥è·¯å¾„ã€‚</li>
</ul>
<p><strong>ç¬¬ 2 æ­¥ï¼šç¡®å®šæ–°èŠ‚ç‚¹å±‚é«˜å¹¶å¤„ç†æ–°å±‚çº§</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> * æ­¥éª¤ 2: ç”Ÿæˆéšæœºå±‚æ•°</span></span><br><span class="line"><span class="comment"> * ---------------------------------------------------------------------- */</span></span><br><span class="line"><span class="comment">// å¹‚æ¬¡å®šå¾‹éšæœºç”Ÿæˆå±‚æ•° (1/4 æ¦‚ç‡)</span></span><br><span class="line">level = zslRandomLevel();</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœæ–°ç”Ÿæˆçš„å±‚æ•°æ¯”å½“å‰è·³è¡¨æœ€é«˜å±‚è¿˜é«˜</span></span><br><span class="line"><span class="keyword">if</span> (level &gt; zsl-&gt;level) &#123;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–å¤šå‡ºæ¥çš„å±‚çº§</span></span><br><span class="line">    <span class="keyword">for</span> (i = zsl-&gt;level; i &lt; level; i++) &#123;</span><br><span class="line">        rank[i] = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// æ–°å±‚çº§çš„å‰é©±è‡ªç„¶æ˜¯ header</span></span><br><span class="line">        update[i] = zsl-&gt;header;</span><br><span class="line">        <span class="comment">// header åœ¨è¿™äº›æ–°å±‚çº§çš„ span æš‚æ—¶è¦†ç›–æ•´ä¸ªé“¾è¡¨é•¿åº¦</span></span><br><span class="line">        <span class="comment">// (å› ä¸º header åç›´æ¥å°±æ˜¯ NULLï¼Œæˆ–è€…å³å°†æ’å…¥çš„æ–°èŠ‚ç‚¹)</span></span><br><span class="line">        update[i]-&gt;level[i].span = zsl-&gt;length;</span><br><span class="line">    &#125;</span><br><span class="line">    zsl-&gt;level = level; <span class="comment">// æ›´æ–°è·³è¡¨æœ€å¤§å±‚æ•°</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>level = zslRandomLevel()</code>: æ–°èŠ‚ç‚¹å°†æ‹¥æœ‰å‡ å±‚&quot;å¿«é€Ÿé€šé“&quot;ï¼Ÿè¿™é‡Œä¸æ˜¯ç”±å¤æ‚çš„å¹³è¡¡ç®—æ³•å†³å®šï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ªç®€å•çš„æ¦‚ç‡å‡½æ•°éšæœºç”Ÿæˆã€‚å¤§éƒ¨åˆ†èŠ‚ç‚¹åªæœ‰ 1 å±‚ï¼Œæå°‘æ•°èŠ‚ç‚¹ä¼šæœ‰å¾ˆé«˜çš„å±‚æ•°ã€‚æ­£æ˜¯è¿™ç§éšæœºæ€§ï¼Œä½¿å¾—è·³è¡¨åœ¨æ•´ä½“ä¸Šèƒ½å¤Ÿç»´æŒä¸€ä¸ªé«˜æ•ˆçš„å¯¹æ•°çº§ç»“æ„ã€‚</li>
<li><code>if (level &gt; zsl-&gt;level)</code>: å¤„ç†ä¸€ä¸ªç‰¹æ®Šæƒ…å†µã€‚å¦‚æœéšæœºå‡ºçš„ <code>level</code> æ¯”å½“å‰è·³è¡¨çš„æœ€å¤§å±‚æ•°è¿˜å¤§ï¼Œæ„å‘³ç€æˆ‘ä»¬éœ€è¦ä¸ºæ•´ä¸ªè·³è¡¨åŠ ç›–æ–°çš„æ¥¼å±‚ã€‚åœ¨è¿™äº›æ–°æ¥¼å±‚ï¼Œè·¯å¾„ä¸Šçš„å‰é©±èŠ‚ç‚¹è‡ªç„¶å°±æ˜¯ <code>header</code> èŠ‚ç‚¹ï¼Œå¹¶ä¸”å®ƒåˆ° <code>NULL</code> çš„è·¨åº¦å°±æ˜¯æ•´ä¸ªè·³è¡¨çš„é•¿åº¦ <code>zsl-&gt;length</code>ã€‚</li>
</ul>
<p><strong>ç¬¬ 3 æ­¥ï¼šèŠ‚ç‚¹åˆ›å»ºã€é“¾æ¥ä¸è·¨åº¦æ›´æ–°</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> * æ­¥éª¤ 3: åˆ›å»ºèŠ‚ç‚¹å¹¶è°ƒæ•´æŒ‡é’ˆä¸ Span (æœ€éš¾ç‚¹)</span></span><br><span class="line"><span class="comment"> * ---------------------------------------------------------------------- */</span></span><br><span class="line">x = zslCreateNode(zsl,level,score,ele);</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€å±‚å¤„ç†æŒ‡é’ˆé“¾æ¥å’Œ span è®¡ç®—</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; level; i++) &#123;</span><br><span class="line">    <span class="comment">// æ ‡å‡†çš„é“¾è¡¨æ’å…¥æ“ä½œ:</span></span><br><span class="line">    <span class="comment">// NewNode-&gt;Next = PrevNode-&gt;Next</span></span><br><span class="line">    <span class="comment">// PrevNode-&gt;Next = NewNode</span></span><br><span class="line">    x-&gt;level[i].forward = update[i]-&gt;level[i].forward;</span><br><span class="line">    update[i]-&gt;level[i].forward = x;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* è®¡ç®— span çš„é€»è¾‘ï¼š</span></span><br><span class="line"><span class="comment">     * update[i]-&gt;level[i].span æ˜¯åŸå…ˆ update[i] åˆ°å…¶ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„è·ç¦»ã€‚</span></span><br><span class="line"><span class="comment">     * ç°åœ¨ä¸­é—´æ’äº†ä¸ª xã€‚</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * rank[0]: æ’å…¥ç‚¹ä¹‹å‰çš„æ€»æ’åã€‚</span></span><br><span class="line"><span class="comment">     * rank[i]: update[i] èŠ‚ç‚¹çš„æ€»æ’åã€‚</span></span><br><span class="line"><span class="comment">     * (rank[0] - rank[i]): update[i] å’Œ å®é™…æ’å…¥ç‚¹(L0å±‚) ä¹‹é—´çš„è·ç¦»ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. è®¾ç½®æ–°èŠ‚ç‚¹ x çš„ span</span></span><br><span class="line">    <span class="comment">// x çš„ span = åŸå‰é©±çš„ span - (å‰é©±åˆ° x çš„è·ç¦»)</span></span><br><span class="line">    x-&gt;level[i].span = update[i]-&gt;level[i].span - (rank[<span class="number">0</span>] - rank[i]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. æ›´æ–°å‰é©±èŠ‚ç‚¹ update[i] çš„ span</span></span><br><span class="line">    <span class="comment">// å‰é©±çš„ span = (å‰é©±åˆ° x çš„è·ç¦») + 1 (è¿™ä¸ª 1 æ˜¯ x èŠ‚ç‚¹æœ¬èº«)</span></span><br><span class="line">    update[i]-&gt;level[i].span = (rank[<span class="number">0</span>] - rank[i]) + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯æ•´ä¸ªæ’å…¥è¿‡ç¨‹ä¸­æœ€æ ¸å¿ƒçš„é€»è¾‘ï¼š</p>
<p><strong>é“¾æ¥ <code>forward</code> æŒ‡é’ˆ</strong>: è¿™ä¸¤è¡Œæ˜¯ç»å…¸çš„é“¾è¡¨æ’å…¥æ“ä½œã€‚å‡è®¾åŸæ¥æ˜¯ <code>A -&gt; C</code>ï¼Œ<code>A</code> å°±æ˜¯ <code>update[i]</code>ï¼Œ<code>C</code> å°±æ˜¯ <code>update[i]-&gt;level[i].forward</code>ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å°†æ–°èŠ‚ç‚¹ <code>x</code> æ’å…¥å…¶ä¸­ï¼Œå˜ä¸º <code>A -&gt; x -&gt; C</code>ã€‚</p>
<p><strong>æ›´æ–° <code>span</code> (è·¨åº¦)</strong>: è¿™æ˜¯æœ€ç²¾å¦™çš„éƒ¨åˆ†ï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜ã€‚</p>
<ul>
<li>å‡è®¾åœ¨ç¬¬ <code>i</code> å±‚ï¼Œå‰é©±èŠ‚ç‚¹ <code>A</code> (å³ <code>update[i]</code>) åŸæ¥çš„ <code>span</code> æ˜¯ <code>10</code>ï¼Œå®ƒç›´æ¥æŒ‡å‘ <code>C</code>ã€‚</li>
<li>æˆ‘ä»¬åœ¨ç¬¬ 0 å±‚ï¼ˆæœ€åº•å±‚ï¼‰çš„æŸ¥æ‰¾è¿‡ç¨‹ä¸­ï¼Œä» <code>A</code> ä¹‹åï¼Œåˆå‰è¿›äº† 3 æ­¥æ‰æ‰¾åˆ°æ’å…¥ç‚¹ã€‚è¿™æ„å‘³ç€ <code>rank[0] - rank[i]</code> çš„å€¼æ˜¯ 3ï¼ˆå¯ä»¥ç†è§£ä¸º A åœ¨é«˜å±‚å’Œåº•å±‚ä¹‹é—´çš„æŠ•å½±åå·®ï¼‰ã€‚</li>
<li><code>update[i]-&gt;level[i].span = (rank[0] - rank[i]) + 1;</code>: <code>A</code> çš„æ–° <code>span</code> å˜ä¸º <code>3 + 1 = 4</code>ã€‚å› ä¸ºå®ƒç°åœ¨æŒ‡å‘æ–°èŠ‚ç‚¹ <code>x</code>ï¼Œå®ƒä¿©ä¹‹é—´è·¨è¶Šäº† <code>3</code> ä¸ªæ—§èŠ‚ç‚¹ï¼ŒåŠ ä¸Š <code>x</code> æœ¬èº«ï¼Œæ€»å…±æ˜¯ <code>4</code> æ­¥ã€‚</li>
<li><code>x-&gt;level[i].span = update[i]-&gt;level[i].span - (rank[0] - rank[i]);</code>: æ–°èŠ‚ç‚¹ <code>x</code> çš„ <code>span</code> ç­‰äº <code>A</code> çš„<strong>æ—§</strong> <code>span</code> (<code>10</code>) å‡å»å®ƒä¿©ä¹‹é—´çš„è·ç¦» (<code>3</code>)ï¼Œç­‰äº <code>7</code>ã€‚</li>
</ul>
<blockquote>
<p><strong>éªŒè¯</strong>: æ’å…¥åï¼Œ<code>A</code> çš„æ–° <code>span</code> (4) + <code>x</code> çš„æ–° <code>span</code> (7) = <code>11</code>ã€‚è€Œ <code>A</code> çš„æ—§ <code>span</code> æ˜¯ <code>10</code>ã€‚æ€»è·¨åº¦å¢åŠ äº† <code>1</code>ï¼Œæ­£å¥½ç­‰äºæ–°åŠ å…¥çš„èŠ‚ç‚¹æ•°é‡ã€‚å®Œç¾ï¼</p>
</blockquote>
<p>å¦å¤–ï¼Œå¯¹äºé‚£äº›é«˜äºæ–°èŠ‚ç‚¹ <code>level</code> çš„å±‚çº§ï¼Œæ–°èŠ‚ç‚¹å¹¶ä¸ä¼šè¢«æ’å…¥ã€‚ä½†æ˜¯ï¼Œç”±äºæ•´ä¸ªè·³è¡¨çš„æ€»é•¿åº¦å¢åŠ äº† 1ï¼Œè¿™äº›æ›´é«˜å±‚çº§ä¸Šã€ä½äºæ’å…¥è·¯å¾„ä¸Šçš„å‰é©±èŠ‚ç‚¹ï¼ˆ<code>update[i]</code>ï¼‰ï¼Œå®ƒä»¬æŒ‡å‘çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„ç›¸å¯¹è·ç¦»ä¹Ÿå¢åŠ  1ã€‚å› æ­¤ï¼Œå®ƒä»¬çš„ <code>span</code> å€¼éœ€è¦é€’å¢ã€‚</p>
<p><strong>ç¬¬ 4 æ­¥ï¼šæ›´æ–°åé€€æŒ‡é’ˆå’Œè¡¨å°¾</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> * æ­¥éª¤ 4: è®¾ç½®åé€€æŒ‡é’ˆ (ç”¨äº L0 å±‚åŒå‘éå†)</span></span><br><span class="line"><span class="comment"> * ---------------------------------------------------------------------- */</span></span><br><span class="line"><span class="comment">// å¦‚æœå‰é©±æ˜¯ headerï¼Œbackward è®¾ä¸º NULL (header ä¸ä½œä¸ºæ•°æ®èŠ‚ç‚¹)</span></span><br><span class="line">x-&gt;backward = (update[<span class="number">0</span>] == zsl-&gt;header) ? <span class="literal">NULL</span> : update[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„ backward æŒ‡å‘æ–°èŠ‚ç‚¹ x</span></span><br><span class="line"><span class="keyword">if</span> (x-&gt;level[<span class="number">0</span>].forward)</span><br><span class="line">    x-&gt;level[<span class="number">0</span>].forward-&gt;backward = x;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="comment">// å¦‚æœ x æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ›´æ–° tail æŒ‡é’ˆ</span></span><br><span class="line">    zsl-&gt;tail = x;</span><br><span class="line"></span><br><span class="line">zsl-&gt;length++;</span><br><span class="line"><span class="keyword">return</span> x;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>x-&gt;backward = ...</code>: è·³è¡¨çš„æœ€åº•å±‚ï¼ˆ<code>level[0]</code>ï¼‰æ˜¯ä¸€ä¸ª<strong>åŒå‘é“¾è¡¨</strong>ï¼Œ<code>backward</code> æŒ‡é’ˆç”¨äºæ”¯æŒ <code>ZREVRANGE</code> ç­‰åå‘éå†å‘½ä»¤ã€‚è¿™é‡Œå°†æ–°èŠ‚ç‚¹çš„åé€€æŒ‡é’ˆæ­£ç¡®åœ°æŒ‡å‘å®ƒçš„å‰é©±èŠ‚ç‚¹ <code>update[0]</code>ã€‚</li>
<li><code>if...else...</code>: æ›´æ–°æ–°èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹çš„ <code>backward</code> æŒ‡é’ˆï¼Œè®©å®ƒæŒ‡å‘æ–°èŠ‚ç‚¹ <code>x</code>ã€‚å¦‚æœæ–°èŠ‚ç‚¹æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ™æ›´æ–°æ•´ä¸ªè·³è¡¨çš„ <code>tail</code> æŒ‡é’ˆã€‚</li>
<li><code>zsl-&gt;length++</code>: æœ€åï¼Œå°†è·³è¡¨çš„æ€»é•¿åº¦åŠ  1ã€‚</li>
</ul>
<p>è‡³æ­¤ï¼Œä¸€ä¸ªæ–°èŠ‚ç‚¹è¢«å¤©è¡£æ— ç¼åœ°ç»‡å…¥äº†è·³è¡¨è¿™å¼ å¤§ç½‘ä¸­ï¼Œæ‰€æœ‰ç›¸å…³çš„æŒ‡é’ˆå’Œè·¨åº¦ä¿¡æ¯éƒ½å¾—åˆ°äº†åŸå­æ€§çš„æ›´æ–°ã€‚</p>
<h2 id="6-Bitmap">6. Bitmap</h2>
<p><code>Bitmap</code>ï¼ˆä½å›¾ï¼‰ åˆ©ç”¨ String çš„äºŒè¿›åˆ¶ä½ï¼ˆBitï¼‰æ¥å­˜æ•°æ®ï¼Œé€‚ç”¨äºå¤„ç† bit çº§åˆ«çš„æ•°æ®ã€‚å› ä¸º SDS æœ€å¤§ 512MBï¼Œæ‰€ä»¥ Bitmap æœ€å¤šèƒ½å­˜ $2^{32}$ (çº¦ 40 äº¿) ä¸ª bitã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŸºç¡€ä½æ“ä½œ</span></span><br><span class="line">SETBIT key offset value          <span class="comment"># è®¾ç½®æŒ‡å®šåç§»é‡çš„ä½å€¼ï¼ˆ0æˆ–1ï¼‰</span></span><br><span class="line">GETBIT key offset                <span class="comment"># è·å–æŒ‡å®šåç§»é‡çš„ä½å€¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½ç»Ÿè®¡</span></span><br><span class="line">BITCOUNT key [start end]         <span class="comment"># ç»Ÿè®¡ä½å›¾ä¸­å€¼ä¸º1çš„ä½æ•°</span></span><br><span class="line">BITPOS key bit [start end]       <span class="comment"># æŸ¥æ‰¾ç¬¬ä¸€ä¸ªæŒ‡å®šå€¼çš„ä½ç½®</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½è¿ç®—ï¼ˆé‡è¦ï¼‰</span></span><br><span class="line">BITOP operation destkey key1 key2 ...  <span class="comment"># ä½è¿ç®—æ“ä½œ</span></span><br><span class="line">  <span class="comment"># operation: AND(ä¸), OR(æˆ–), XOR(å¼‚æˆ–), NOT(é)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å­—ç¬¦ä¸²å’Œä½å›¾è½¬æ¢</span></span><br><span class="line">BITFIELD key [GET <span class="built_in">type</span> offset] [SET <span class="built_in">type</span> offset value] [INCRBY <span class="built_in">type</span> offset increment]  <span class="comment"># ä½åŸŸæ“ä½œ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰©å±•å‘½ä»¤ï¼ˆRedis 6.2+ï¼‰</span></span><br><span class="line">BITFIELD_RO key [GET <span class="built_in">type</span> offset] ...  <span class="comment"># åªè¯»çš„ä½åŸŸæ“ä½œ</span></span><br></pre></td></tr></table></figure>
<p><strong>å¸¸è§ä½¿ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li><strong>ç”¨æˆ·ç­¾åˆ°</strong>ï¼šç”¨ä½è¡¨ç¤ºç”¨æˆ·æ¯æ—¥ç­¾åˆ°çŠ¶æ€ï¼Œ1 è¡¨ç¤ºå·²ç­¾åˆ°ï¼Œ<code>BITCOUNT</code> ç»Ÿè®¡æœˆç­¾åˆ°å¤©æ•°</li>
<li><strong>åœ¨çº¿çŠ¶æ€</strong>ï¼šç”¨æˆ·åœ¨çº¿/ç¦»çº¿çŠ¶æ€è·Ÿè¸ªï¼Œ<code>SETBIT user:online 1001 1</code> è¡¨ç¤ºç”¨æˆ· 1001 åœ¨çº¿</li>
<li><strong>æƒé™ç®¡ç†</strong>ï¼šRBAC æƒé™ç³»ç»Ÿï¼Œæ¯ä½ä»£è¡¨ä¸€ç§æƒé™ï¼Œ<code>BITOP AND</code> å®ç°æƒé™äº¤é›†</li>
<li><strong>å¸ƒéš†è¿‡æ»¤å™¨åº•å±‚</strong>ï¼šå®ç°è‡ªå®šä¹‰å¸ƒéš†è¿‡æ»¤å™¨çš„åŸºç¡€æ•°æ®ç»“æ„</li>
<li><strong>ç”¨æˆ·ç‰¹å¾</strong>ï¼šç”¨æˆ·ç”»åƒæ ‡ç­¾ç³»ç»Ÿï¼Œ1 è¡¨ç¤ºæœ‰è¯¥ç‰¹å¾ï¼Œ<code>BITOP OR</code> æ‰¾ç›¸ä¼¼ç”¨æˆ·</li>
<li><strong>A/B æµ‹è¯•</strong>ï¼šç”¨æˆ·åˆ†ç»„æ ‡è¯†ï¼Œ0 ä¸ºå¯¹ç…§ç»„ï¼Œ1 ä¸ºå®éªŒç»„</li>
<li><strong>æ•°æ®ç»Ÿè®¡</strong>ï¼šæ—¥æ´»ç”¨æˆ·ç»Ÿè®¡ï¼Œ<code>BITOP OR</code> åˆå¹¶å¤šæ—¥æ´»è·ƒç”¨æˆ·è®¡ç®—æ€»æ´»è·ƒæ•°</li>
<li><strong>å»é‡ç»Ÿè®¡</strong>ï¼šå¤§é‡ ID å»é‡ï¼Œä½¿ç”¨ä½å›¾å­˜å‚¨å·²è§è¿‡çš„ IDï¼ŒèŠ‚çœå†…å­˜</li>
<li><strong>æ¸¸æˆç³»ç»Ÿ</strong>ï¼šæˆå°±ç³»ç»Ÿè§£é”çŠ¶æ€ï¼Œæ¯ä¸ªæˆå°±å¯¹åº”ä¸€ä¸ªä½ï¼Œ<code>BITCOUNT</code> ç»Ÿè®¡è§£é”æ•°é‡</li>
</ul>
<h2 id="7-HyperLogLog">7. HyperLogLog</h2>
<p><code>HyperLogLog</code> æ˜¯ä¸€ä¸ªæ¦‚ç‡æ•°æ®ç»“æ„ï¼Œç”¨äºä¼°è®¡é›†åˆçš„åŸºæ•°ã€‚å®ƒçš„åº•å±‚ä¹Ÿæ˜¯ String ç±»å‹ã€‚æ¯ä¸ª <code>HyperLogLog</code> æœ€å¤šæ¶ˆè€— 12KB çš„å†…å­˜ï¼Œåœ¨æ ‡å‡†è¯¯å·® 0.81% çš„å‰æä¸‹ï¼Œå¯ä»¥è®¡ç®— $2^{64}$ ä¸ªå…ƒç´ çš„åŸºæ•°ã€‚</p>
<h3 id="7-1-æ ¸å¿ƒæ“ä½œ">7.1 æ ¸å¿ƒæ“ä½œ</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŸºç¡€æ“ä½œ</span></span><br><span class="line">PFADD key element1 element2 ...  <span class="comment"># æ·»åŠ å…ƒç´ åˆ° HyperLogLog</span></span><br><span class="line">PFCOUNT key1 key2 key3 ...       <span class="comment"># è·å–ä¸€ä¸ªæˆ–å¤šä¸ª HyperLogLog çš„åŸºæ•°ä¼°è®¡</span></span><br><span class="line">PFMERGE destkey source1 source2 ...  <span class="comment"># åˆå¹¶å¤šä¸ª HyperLogLog åˆ°ç›®æ ‡é”®</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®ç”¨å‘½ä»¤ç»„åˆ</span></span><br><span class="line"><span class="comment"># åˆ›å»ºå¹¶åˆå§‹åŒ–</span></span><br><span class="line">PFADD daily_users_20231201 <span class="string">&quot;user_1001&quot;</span> <span class="string">&quot;user_1002&quot;</span> <span class="string">&quot;user_1003&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹åŸºæ•°ä¼°è®¡</span></span><br><span class="line">PFCOUNT daily_users_20231201</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå¹¶å¤šæ—¥æ•°æ®</span></span><br><span class="line">PFMERGE month_users daily_users_20231201 daily_users_20231202 daily_users_20231203</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤šé”®ç»Ÿè®¡</span></span><br><span class="line">PFCOUNT week_users month_users  <span class="comment"># å¯ä»¥åŒæ—¶æŸ¥è¯¢å¤šä¸ªé”®çš„åˆå¹¶åŸºæ•°</span></span><br></pre></td></tr></table></figure>
<p><strong>å¸¸è§ä½¿ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li><strong>UV ç»Ÿè®¡</strong>ï¼šç½‘ç«™/APP æ—¥æ´»ã€æœˆæ´»ç”¨æˆ·ç»Ÿè®¡ï¼Œ<code>PFADD</code> è®°å½•ç”¨æˆ·è®¿é—®ï¼Œ<code>PFCOUNT</code> è·å– UV æ•°é‡</li>
<li><strong>å¤§æ•°æ®å»é‡</strong>ï¼šæµ·é‡æ•°æ®å»é‡ç»Ÿè®¡ï¼Œå¦‚æ—¥å¿—åˆ†æä¸­çš„ç‹¬ç«‹ IP ç»Ÿè®¡</li>
<li><strong>å®æ—¶ç»Ÿè®¡</strong>ï¼šç¤¾äº¤å¹³å°çš„æ´»è·ƒç”¨æˆ·æ•°ã€ç”µå•†å¹³å°çš„è®¿å®¢æ•°ç­‰å®æ—¶å»é‡ç»Ÿè®¡</li>
<li><strong>ç”¨æˆ·è¡Œä¸ºåˆ†æ</strong>ï¼šé¡µé¢æµè§ˆé‡å»é‡ã€æœç´¢å…³é”®è¯å»é‡ç»Ÿè®¡</li>
<li><strong>å¹¿å‘Šæ›å…‰</strong>ï¼šå¹¿å‘Šç‹¬ç«‹æ›å…‰äººæ•°ç»Ÿè®¡ï¼Œé¿å…é‡å¤è®¡ç®—åŒä¸€ç”¨æˆ·</li>
<li><strong>æ•°æ®åˆ†æ</strong>ï¼šA/B æµ‹è¯•ä¸­çš„ç‹¬ç«‹ç”¨æˆ·æ•°ç»Ÿè®¡ã€è½¬åŒ–æ¼æ–—çš„å»é‡è®¡æ•°</li>
<li><strong>ç›‘æ§å‘Šè­¦</strong>ï¼šç³»ç»Ÿç‹¬ç«‹é”™è¯¯è§¦å‘æ¬¡æ•°ã€ç‹¬ç«‹å¼‚å¸¸ IP ç»Ÿè®¡</li>
<li><strong>å†…å®¹åˆ†å‘</strong>ï¼šè§†é¢‘ç‹¬ç«‹è§‚çœ‹äººæ•°ã€æ–‡ç« ç‹¬ç«‹é˜…è¯»æ•°ç»Ÿè®¡</li>
</ul>
<h3 id="7-2-åº•å±‚åŸç†">7.2 åº•å±‚åŸç†</h3>
<p><code>HyperLogLog</code> ä½¿ç”¨æ¦‚ç‡ç®—æ³•æ¥ç»Ÿè®¡é›†åˆçš„è¿‘ä¼¼åŸºæ•°ï¼Œè€Œæ¦‚ç‡ç®—æ³•çš„æœ¬è´¨æ˜¯ä¼¯åŠªåˆ©è¯•éªŒï¼ˆBernoulli Trialï¼‰ï¼Œä¼¯åŠªåˆ©è¯•éªŒå¯ä»¥çœ‹ä½œä¸€ä¸ªæŠ›ç¡¬å¸è¿‡ç¨‹ã€‚</p>
<p>å‡è®¾æˆ‘ä»¬ç©æŠ›ç¡¬å¸æ¸¸æˆï¼Œæˆ‘è®©ä½ ä¸€ç›´æŠ›ï¼Œç›´åˆ°æŠ›å‡º&quot;æ­£é¢&quot;ä¸ºæ­¢ï¼Œè¿™ç®—ä¸€è½®ã€‚</p>
<p>æˆ‘ä»¬è®°å½•æ¯ä¸€è½®ä¸­ï¼Œ&quot;åé¢&quot;è¿ç»­å‡ºç°çš„æ¬¡æ•°ï¼ˆä¹Ÿå°±æ˜¯å‰å¯¼ 0 çš„ä¸ªæ•°ï¼‰ã€‚</p>
<ul>
<li><strong>æƒ…å†µ 1</strong>ï¼šä½ æŠ›äº† 1 æ¬¡å°±å‡ºäº†æ­£é¢ã€‚å‰å¯¼ 0 ä¸ªæ•° = 0ã€‚</li>
<li><strong>æƒ…å†µ 2</strong>ï¼šä½ æŠ›äº† 2 æ¬¡ï¼ˆåã€æ­£ï¼‰ã€‚å‰å¯¼ 0 ä¸ªæ•° = 1ã€‚</li>
<li>â€¦</li>
<li><strong>æƒ…å†µ N</strong>ï¼šå¦‚æœä½ å‘Šè¯‰æˆ‘ï¼Œä½ åˆšåˆšé‚£ä¸€è½®ï¼Œ<strong>è¿ç»­æŠ›äº† 10 æ¬¡åé¢</strong>æ‰å‡ºæ­£é¢ï¼ˆå‰å¯¼ 0 = 10ï¼‰ã€‚</li>
</ul>
<p>æ¨æ–­ï¼šè¿ç»­æŠ› 10 æ¬¡åé¢çš„æ¦‚ç‡æ˜¯ $(1/2)^{10} = 1/1024$ã€‚</p>
<p>å¦‚æœä½ èƒ½åšåˆ°è¿™ä»¶äº‹ï¼Œæˆ‘ä¸ä»…è®¤ä¸ºä½ è¿æ°”å¥½ï¼Œæˆ‘æ›´æœ‰ç†ç”±ç›¸ä¿¡ï¼šä½ è‚¯å®šå·²ç»åœ¨èƒŒåå·å·æŠ›äº†å¾ˆå¤šå¾ˆå¤šè½®ï¼ˆå¤§æ¦‚ 1024 è½®å·¦å³ï¼‰ï¼Œæ‰ç¢°å·§å‡ºç°äº†ä¸€æ¬¡è¿™ä¹ˆç½•è§çš„æƒ…å†µã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡è§‚å¯Ÿ<strong>ä¸€ç»„éšæœºæ•°</strong>ï¼ˆHash å€¼ï¼‰ä¸­**â€œæœ€å¤§å‰å¯¼ 0 çš„ä¸ªæ•°â€**ï¼Œæ¥åæ¨è¿™ç»„éšæœºæ•°å¤§æ¦‚æœ‰å¤šå°‘ä¸ªï¼ˆåŸºæ•°ï¼‰ã€‚</p>
<table>
<thead>
<tr>
<th><strong>äºŒè¿›åˆ¶å½¢æ€</strong></th>
<th><strong>æè¿°</strong></th>
<th><strong>æ¦‚ç‡</strong></th>
<th><strong>å€’æ•° (é¢„ä¼°æ•°é‡)</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>1...</code></td>
<td>å¼€å¤´æ˜¯ 1 (0 ä¸ªé›¶)</td>
<td>$1/2$ (50%)</td>
<td>$2^1 = 2$</td>
</tr>
<tr>
<td><code>01...</code></td>
<td>å¼€å¤´æ˜¯ 01 (1 ä¸ªé›¶)</td>
<td>$1/4$ (25%)</td>
<td>$2^2 = 4$</td>
</tr>
<tr>
<td><code>001...</code></td>
<td>å¼€å¤´æ˜¯ 001 (2 ä¸ªé›¶)</td>
<td>$1/8$ (12.5%)</td>
<td>$2^3 = 8$</td>
</tr>
<tr>
<td>â€¦</td>
<td>â€¦</td>
<td>â€¦</td>
<td>â€¦</td>
</tr>
<tr>
<td><code>00...01</code> ($k$ ä¸ªé›¶)</td>
<td>å¼€å¤´ $k$ ä¸ª 0</td>
<td>$1 / 2^{k+1}$</td>
<td><strong>$2^{k+1}$</strong></td>
</tr>
</tbody>
</table>
<p>å¦‚æœåªä¾æ®ä¸€æ¬¡è¿æ°”æœ€å¥½çš„è®°å½•ï¼ˆæœ€å¤§å‰å¯¼ 0ï¼‰æ¥ä¼°ç®—ï¼Œå¶ç„¶æ€§å¤ªå¤§ï¼ˆæ¯”å¦‚æˆ‘ç¬¬ä¸€æ¬¡å°±èµ°äº†ç‹—å±è¿æŠ›äº† 10 ä¸ªåé¢ï¼Œä½ ä¸èƒ½è¯´æˆ‘æŠ›äº† 1000 æ¬¡ï¼‰ã€‚</p>
<p><code>HyperLogLog</code> å¼•å…¥äº† åˆ†æ¡¶ï¼ˆBucketingï¼‰çš„æ¦‚å¿µï¼š</p>
<ol>
<li>æŠŠæ•°æ®åˆ†æˆ $m$ ä¸ªæ¡¶ã€‚</li>
<li>åˆ†åˆ«ç»Ÿè®¡æ¯ä¸ªæ¡¶é‡Œçš„æœ€å¤§å‰å¯¼ 0ã€‚</li>
<li>å¯¹è¿™äº›æ¡¶çš„ç»“æœæ±‚<strong>è°ƒå’Œå¹³å‡æ•°</strong>ï¼ˆè€Œä¸æ˜¯ç®—æœ¯å¹³å‡æ•°ï¼‰ï¼Œä»¥æ¶ˆé™¤æç«¯å€¼ï¼ˆç¦»ç¾¤ç‚¹ï¼‰çš„å½±å“ã€‚</li>
</ol>
<blockquote>
<p>ç®—æœ¯å¹³å‡æ•°ï¼ˆArithmetic Meanï¼‰æˆ‘ä»¬éƒ½æ‡‚ï¼šåŠ èµ·æ¥é™¤ä»¥ Nã€‚</p>
<p>$$<br>
A = \frac{x_1 + x_2}{2}<br>
$$</p>
<p>è°ƒå’Œå¹³å‡æ•°æ˜¯ï¼šå€’æ•°çš„å¹³å‡æ•°ï¼Œå†å–å€’æ•°ã€‚</p>
<p>$$<br>
H = \frac{2}{\frac{1}{x_1} + \frac{1}{x_2}}<br>
$$</p>
<p>è°ƒå’Œå¹³å‡æ•°å¯¹å°æ•°å€¼æ›´æ•æ„Ÿï¼Œè€Œå¯¹å¤§æ•°å€¼ï¼ˆç¦»ç¾¤å€¼ï¼‰ä¸æ•æ„Ÿã€‚Redis å°±æ˜¯é€šè¿‡è¿™ 16384 ä¸ªæ¡¶çš„è°ƒå’Œå¹³å‡æ•°ï¼ŒæŠŠ&quot;è¿æ°”&quot;æˆåˆ†å¯¹å†²æ‰ï¼Œæœ€ç»ˆè®©è¯¯å·®ç¨³å®šåœ¨ <strong>0.81%</strong> å·¦å³ã€‚</p>
</blockquote>
<p>Redos å†…éƒ¨ä½¿ç”¨å­—ç¬¦ä¸² Bitmap æ¥å­˜å‚¨ <code>HyperLogLog</code> æ‰€æœ‰æ¡¶çš„è®¡æ•°å€¼ï¼Œä¸€å…±åŒ…å« $2^{14}=16384$ ä¸ªæ¡¶ï¼Œæ¯ä¸ªæ¡¶éƒ½æ˜¯ä¸€ä¸ª 6bit çš„æ•°ç»„ã€‚<code>HyperLogLog</code> çš„å¤´éƒ¨å®šä¹‰ä½äºï¼š<a target="_blank" rel="noopener" href="https://github.com/redis/redis/blob/8.4.0/src/hyperloglog.c#L181">src/hyperloglog.c</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> HLL_P 14 <span class="comment">/* The greater is P, the smaller the error. */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HLL_Q (64-HLL_P) <span class="comment">/* The number of bits of the hash value used for</span></span></span><br><span class="line"><span class="comment"><span class="meta">                            determining the number of leading zeros. */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HLL_REGISTERS (1&lt;&lt;HLL_P) <span class="comment">/* With P=14, 16384 registers. */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HLL_P_MASK (HLL_REGISTERS-1) <span class="comment">/* Mask to index register. */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HLL_BITS 6 <span class="comment">/* Enough to count up to 63 leading zeroes. */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* HyperLogLog å¤´éƒ¨ï¼š</span></span><br><span class="line"><span class="comment"> * magicï¼šå›ºå®šæ ‡è¯† &quot;HYLL&quot;ï¼Œç”¨äºæŒä¹…åŒ–æ ¼å¼è¯†åˆ«ã€‚</span></span><br><span class="line"><span class="comment"> * encodingï¼šä¸¤ç§å­˜å‚¨æ¨¡å¼</span></span><br><span class="line"><span class="comment"> *   - HLL_DENSEï¼šæ¯ä¸ªå¯„å­˜å™¨ 6 bitï¼Œ16K å¯„å­˜å™¨å…±çº¦ 12288 å­—èŠ‚ï¼Œå…ƒç´ å¤šæ—¶å†…å­˜å›ºå®šã€‚</span></span><br><span class="line"><span class="comment"> *   - HLL_SPARSEï¼šç¨€ç– RLE/æŒ‡ä»¤æµå‹ç¼©ï¼Œå…ƒç´ å°‘æ—¶å ç”¨å°ï¼Œè¶…è¿‡é˜ˆå€¼è‡ªåŠ¨è½¬ä¸º DENSEã€‚</span></span><br><span class="line"><span class="comment"> * notused[3]ï¼šä¿ç•™ä½ï¼Œå¿…é¡»ä¸º 0ã€‚</span></span><br><span class="line"><span class="comment"> * card[8]ï¼šç¼“å­˜çš„åŸºæ•°ä¼°è®¡å€¼ï¼ˆå°ç«¯ï¼‰ï¼Œä¸º 0 è¡¨ç¤ºç¼“å­˜å¤±æ•ˆï¼Œä¸‹æ¬¡æŸ¥è¯¢é‡ç®—å¹¶å†™å›ã€‚</span></span><br><span class="line"><span class="comment"> * registers[]ï¼šå¯„å­˜å™¨æ•°æ®åŒºï¼›</span></span><br><span class="line"><span class="comment"> *	 - DENSE ä¸ºç´§å‡‘ 6-bit æ•°ç»„ã€‚</span></span><br><span class="line"><span class="comment"> *	 - SPARSE ä¸ºæŒ‡ä»¤åºåˆ—ï¼ˆZERO/VAL/XZERO ç­‰è¡¨ç¤ºè¿ç»­å¯„å­˜å™¨æ®µï¼‰ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hllhdr</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> magic[<span class="number">4</span>];      <span class="comment">/* &quot;HYLL&quot; */</span></span><br><span class="line">    <span class="type">uint8_t</span> encoding;   <span class="comment">/* HLL_DENSE or HLL_SPARSE. */</span></span><br><span class="line">    <span class="type">uint8_t</span> notused[<span class="number">3</span>]; <span class="comment">/* Reserved for future use, must be zero. */</span></span><br><span class="line">    <span class="type">uint8_t</span> card[<span class="number">8</span>];    <span class="comment">/* Cached cardinality, little endian. */</span></span><br><span class="line">    <span class="type">uint8_t</span> registers[]; <span class="comment">/* Data bytes. */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20251209231456770.png" style="zoom: 33%;" />
<p>å½“æ‰§è¡Œ <code>PFADD key element</code> æ—¶ï¼š</p>
<ol>
<li><strong>Hash</strong>ï¼šRedis ä½¿ç”¨ MurmurHash64A ç®—æ³•å°† <code>element</code> è½¬æ¢ä¸ºä¸€ä¸ª <strong>64 ä½çš„æ•´æ•°</strong>ï¼ˆæ¯”ç‰¹ä¸²ï¼‰ã€‚</li>
<li><strong>åˆ†æ¡¶</strong>ï¼šRedis ä½¿ç”¨è¿™ä¸ª 64 ä½æ•´æ•°çš„ <strong>å‰ 14 ä½</strong> ä½œä¸ºæ¡¶çš„ç´¢å¼•ï¼ˆRegister Indexï¼‰ã€‚$2^{14} = 16384$ï¼Œæ‰€ä»¥æ‰è¯´ Redis å†…éƒ¨ç»´æŠ¤äº† 16384 ä¸ªæ¡¶ï¼ˆ<code>registers[]</code>ï¼‰ã€‚</li>
<li><strong>è®¡æ•°</strong>ï¼šä½¿ç”¨å‰©ä¸‹çš„ <strong>50 ä½</strong> (64 - 14) æ¥è®¡ç®—å‰å¯¼ 0 çš„ä¸ªæ•°ï¼Œå› ä¸ºåªæœ‰ 50 ä½ï¼Œæ‰€ä»¥ 6 ä¸ª bitï¼ˆ$2^6 = 64 &gt; 50$ï¼‰å°±è¶³å¤Ÿäº†ã€‚å¦‚æœç®—å‡ºæ¥å‰å¯¼ 0 æ˜¯ $k$ï¼Œå°±æŠŠç¬¬ $index$ ä¸ªæ¡¶çš„å€¼æ›´æ–°ä¸º $\max(\text{å½“å‰å€¼}, k+1)$ã€‚</li>
</ol>
<p>Redis ä¸ºäº†çœå†…å­˜ï¼Œä¹Ÿä¸ä¼šä¸€ä¸Šæ¥å°±ç”³è¯· 12KBï¼Œæ‰€ä»¥ <code>registers[]</code> å­˜åœ¨ä¸¤ç§ç¼–ç æ ¼å¼ï¼š</p>
<ul>
<li><strong>ç¨€ç–ç¼–ç  (Sparse)</strong>ï¼šå½“ HLL åˆšåˆ›å»ºï¼Œæˆ–è€…å…ƒç´ å¾ˆå°‘æ—¶ï¼ŒRedis ä½¿ç”¨ä¸€ç§ç±»ä¼¼ RLE (Run-Length Encoding) çš„å‹ç¼©æ ¼å¼ã€‚æ¯”å¦‚&quot;è¿ç»­ 100 ä¸ªæ¡¶éƒ½æ˜¯ 0&quot;ï¼Œå®ƒå°±å­˜&quot;100 ä¸ª 0&quot;ï¼Œè€Œä¸æ˜¯å­˜ 100 ä¸ª 0 çš„å®é™…æ•°æ®ã€‚</li>
<li><strong>å¯†é›†ç¼–ç  (Dense)</strong>ï¼šå½“æ•°æ®å¤šäº†ï¼Œç¨€ç–ç¼–ç å­˜ä¸ä¸‹äº†ï¼Œå°±ä¼šè½¬æ¢æˆæ ‡å‡†çš„ 12KB å¯†é›†æ•°ç»„ã€‚</li>
</ul>
<h2 id="8-Bloom-Filter">8. Bloom Filter</h2>
<p>Bloom Filterï¼ˆå¸ƒéš†è¿‡æ»¤å™¨ï¼‰æ˜¯ç”± Burton Howard Bloom äº 1970 å¹´æå‡ºçš„ï¼Œå®ƒæ˜¯ä¸€ç§ space efficient çš„æ¦‚ç‡å‹æ•°æ®ç»“æ„ï¼Œç”¨äºåˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦åœ¨é›†åˆä¸­ã€‚é€šå¸¸ç”¨äºå¿«é€Ÿåˆ¤æ–­æŸä¸ªå…ƒç´ æ˜¯å¦å¯èƒ½å­˜åœ¨äºä¸€ä¸ªå¤§å‹æ•°æ®é›†ä¸­ï¼Œè€Œæ— éœ€å®é™…å­˜å‚¨æ•´ä¸ªæ•°æ®é›†ã€‚</p>
<p>åœ¨ Redis 8 ä¹‹åï¼ŒBloom Filter å·²ç»å†…ç½®åœ¨ Redis ä¸­äº†ã€‚åœ¨è¿™ä¹‹å‰ï¼Œå®ƒä¸æ˜¯ Redis çš„æ ‡å‡†åŠŸèƒ½ï¼Œè€Œæ˜¯é€šè¿‡ Redis 4.0+ å¼•å…¥ Module æ’ä»¶æœºåˆ¶å®‰è£…çš„ï¼Œè¯¦ç»†å¯å‚è€ƒ <a target="_blank" rel="noopener" href="https://github.com/RedisBloom/RedisBloom">GitHub ä¸¨ RedisBloom</a>ã€‚</p>
<h3 id="8-1-æ ¸å¿ƒæ“ä½œ">8.1 æ ¸å¿ƒæ“ä½œ</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºå¸ƒéš†è¿‡æ»¤å™¨</span></span><br><span class="line">BF.ADD key item1 item2 item3       <span class="comment"># æ·»åŠ å…ƒç´ ï¼ˆè‡ªåŠ¨åˆ›å»ºè¿‡æ»¤å™¨ï¼‰</span></span><br><span class="line">BF.EXISTS key item                 <span class="comment"># æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">BF.MADD key item1 item2 item3      <span class="comment"># æ‰¹é‡æ·»åŠ å…ƒç´ </span></span><br><span class="line">BF.MEXISTS key item1 item2 item3   <span class="comment"># æ‰¹é‡æ£€æŸ¥å…ƒç´ </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰‹åŠ¨åˆ›å»ºå¹¶é…ç½®</span></span><br><span class="line">BF.RESERVE key error_rate capacity [EXPANSION expansion] [NONSCALING]</span><br><span class="line">  <span class="comment"># error_rate: æœŸæœ›çš„é”™è¯¯ç‡ï¼ˆå¦‚0.01è¡¨ç¤º1%ï¼‰</span></span><br><span class="line">  <span class="comment"># capacity: æœŸæœ›çš„å…ƒç´ æ•°é‡</span></span><br><span class="line">  <span class="comment"># EXPANSION: æ‰©å®¹å› å­ï¼ˆé»˜è®¤2ï¼‰</span></span><br><span class="line">  <span class="comment"># NONSCALING: ç¦ç”¨è‡ªåŠ¨æ‰©å®¹</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é«˜çº§æ“ä½œ</span></span><br><span class="line">BF.INSERT key [CAPACITY <span class="built_in">cap</span>] [ERROR error] [NOCREATE] ITEMS item1 item2 ...  <span class="comment"># æ’å…¥å…ƒç´ </span></span><br><span class="line">BF.INFO key                        <span class="comment"># æŸ¥çœ‹è¿‡æ»¤å™¨ä¿¡æ¯</span></span><br><span class="line">BF.CARD key                        <span class="comment"># è·å–è¿‡æ»¤å™¨ä¸­å…ƒç´ æ•°é‡ï¼ˆè¿‘ä¼¼å€¼ï¼‰</span></span><br><span class="line">BF.SCANDUMP key iterator           <span class="comment"># ç”¨äºæ•°æ®å¤‡ä»½å’Œæ¢å¤</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¡æ•°å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆCuckoo Filteræ›¿ä»£æ–¹æ¡ˆï¼‰</span></span><br><span class="line">CF.ADD key item                    <span class="comment"># æ·»åŠ å…ƒç´ åˆ°è®¡æ•°è¿‡æ»¤å™¨</span></span><br><span class="line">CF.ADDNX key item                  <span class="comment"># ä»…å½“å…ƒç´ ä¸å­˜åœ¨æ—¶æ·»åŠ </span></span><br><span class="line">CF.EXISTS key item                 <span class="comment"># æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">CF.DEL key item                    <span class="comment"># åˆ é™¤å…ƒç´ ï¼ˆæ”¯æŒåˆ é™¤ï¼‰</span></span><br><span class="line">CF.COUNT key item                  <span class="comment"># è·å–å…ƒç´ è®¡æ•°</span></span><br></pre></td></tr></table></figure>
<p><strong>å¸¸è§ä½¿ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li><strong>ç¼“å­˜ç©¿é€é˜²æŠ¤</strong>ï¼šæŸ¥è¯¢æ•°æ®åº“å‰å…ˆç”¨å¸ƒéš†è¿‡æ»¤å™¨æ£€æŸ¥ key æ˜¯å¦å­˜åœ¨ï¼Œé¿å…æ— æ•ˆæŸ¥è¯¢ç©¿é€åˆ°æ•°æ®åº“</li>
<li><strong>URL å»é‡</strong>ï¼šçˆ¬è™«ç³»ç»Ÿä¸­åˆ¤æ–­ URL æ˜¯å¦å·²ç»çˆ¬å–è¿‡ï¼Œé¿å…é‡å¤çˆ¬å–</li>
<li><strong>ç”¨æˆ·æ³¨å†Œ</strong>ï¼šæ£€æŸ¥ç”¨æˆ·å/é‚®ç®±æ˜¯å¦å·²è¢«æ³¨å†Œï¼Œå¿«é€Ÿå“åº”</li>
<li><strong>åƒåœ¾é‚®ä»¶è¿‡æ»¤</strong>ï¼šç»´æŠ¤å·²çŸ¥åƒåœ¾é‚®ä»¶å‘é€è€…é»‘åå•ï¼Œå¿«é€Ÿè¿‡æ»¤</li>
<li><strong>æ•°æ®åº“åˆ†ç‰‡</strong>ï¼šå¿«é€Ÿåˆ¤æ–­æŸä¸ª key åº”è¯¥å­˜å‚¨åœ¨å“ªä¸ªåˆ†ç‰‡ä¸Š</li>
<li><strong>æ¨èç³»ç»Ÿ</strong>ï¼šè¿‡æ»¤ç”¨æˆ·å·²ç»çœ‹è¿‡çš„å†…å®¹ï¼Œé¿å…é‡å¤æ¨è</li>
<li><strong>å®‰å…¨é˜²æŠ¤</strong>ï¼šIP é»‘åå•ã€æ¶æ„è¯·æ±‚è¿‡æ»¤ç­‰å®‰å…¨åœºæ™¯</li>
<li><strong>æ•°æ®åŒæ­¥</strong>ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿä¸­åˆ¤æ–­æ•°æ®æ˜¯å¦éœ€è¦åŒæ­¥ï¼Œå‡å°‘ç½‘ç»œä¼ è¾“</li>
</ul>
<h3 id="8-2-åº•å±‚åŸç†">8.2 åº•å±‚åŸç†</h3>
<p>å¸ƒéš†è¿‡æ»¤å™¨çš„æ•°æ®ç»“æ„åº•å±‚å…¶å®å°±æ˜¯ä¸€ä¸ªå·¨å¤§çš„ <code>Bitmap</code>ã€‚é€šè¿‡ä¸€ç»„å“ˆå¸Œå‡½æ•°ï¼Œå°†åŒä¸€ä¸ªå…ƒç´ è®¡ç®—å‡ºæ¥çš„å¤šä¸ªå“ˆå¸Œå€¼å¯¹åº”çš„ bit ä½ç½®ä¸º <code>1</code>ï¼Œä»è€Œåˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨ï¼š</p>
<ul>
<li>å¦‚æœå­˜åœ¨ bit ä½ä¸º <code>0</code> çš„ï¼šåˆ™è¯¥å…ƒç´ <strong>ä¸€å®šä¸å­˜åœ¨</strong>ã€‚</li>
<li>å¦‚æœä¸å­˜åœ¨ bit ä½ä¸º <code>0</code> çš„ï¼šåˆ™è¯¥å…ƒç´ <strong>å¤§æ¦‚ç‡å­˜åœ¨</strong>ã€‚</li>
</ul>
<p>æ‰€ä»¥å¾ˆæ˜¾ç„¶ï¼ŒBloom Filter æ˜¯ä¸æ”¯æŒåˆ é™¤å…ƒç´ çš„ã€‚</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/add-item-bloom-filter.webp" alt=""></p>
<h2 id="9-Geospatial">9. Geospatial</h2>
<p>Redis Geospatial æ˜¯ Redis 3.2 å¼•å…¥çš„ä¸€ç»„ç”¨äºå¤„ç†åœ°ç†ä½ç½®ä¿¡æ¯çš„å‘½ä»¤ã€‚å®ƒå…è®¸æˆ‘ä»¬å­˜å‚¨åœ°ç†åæ ‡ï¼ˆç»åº¦å’Œçº¬åº¦ï¼‰ï¼Œå¹¶æ‰§è¡Œè¯¸å¦‚&quot;è®¡ç®—ä¸¤ç‚¹è·ç¦»&quot;ã€&quot;æŸ¥æ‰¾é™„è¿‘çš„äºº&quot;ç­‰ LBSï¼ˆLocation-Based Serviceï¼‰æ“ä½œã€‚</p>
<h3 id="9-1-æ ¸å¿ƒæ“ä½œ">9.1 æ ¸å¿ƒæ“ä½œ</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŸºç¡€æ“ä½œ</span></span><br><span class="line">GEOADD key longitude latitude member [longitude latitude member ...]  <span class="comment"># æ·»åŠ åœ°ç†ä½ç½®</span></span><br><span class="line">GEOPOS key member1 member2 ...     <span class="comment"># è·å–æŒ‡å®šä½ç½®çš„åæ ‡</span></span><br><span class="line">GEODIST key member1 member2 [unit]  <span class="comment"># è®¡ç®—ä¸¤ä¸ªä½ç½®ä¹‹é—´çš„è·ç¦»</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å•ä½å‚æ•°ï¼šm(ç±³)ã€km(åƒç±³)ã€mi(è‹±é‡Œ)ã€ft(è‹±å°º)</span></span><br><span class="line">GEODIST cities beijing shanghai km  <span class="comment"># è®¡ç®—åŒ—äº¬åˆ°ä¸Šæµ·çš„å…¬é‡Œè·ç¦»</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># èŒƒå›´æŸ¥è¯¢ï¼ˆé‡è¦ï¼‰</span></span><br><span class="line">GEORADIUS key longitude latitude radius m|km|ft|mi [WITHCOORD] [WITHDIST] [WITHHASH] [COUNT count] [ASC|DESC] [STORE key] [STOREDIST key]</span><br><span class="line">GEORADIUSBYMEMBER key member radius m|km|ft|mi [WITHCOORD] [WITHDIST] [WITHHASH] [COUNT count] [ASC|DESC] [STORE key] [STOREDIST key]</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥è¯¢é€‰é¡¹è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment"># WITHCOORD: è¿”å›åæ ‡</span></span><br><span class="line"><span class="comment"># WITHDIST: è¿”å›è·ç¦»</span></span><br><span class="line"><span class="comment"># WITHHASH: è¿”å›geohashå€¼</span></span><br><span class="line"><span class="comment"># COUNT: é™åˆ¶è¿”å›æ•°é‡</span></span><br><span class="line"><span class="comment"># ASC|DESC: æŒ‰è·ç¦»æ’åº</span></span><br><span class="line"><span class="comment"># STORE: å­˜å‚¨ç»“æœåˆ°æœ‰åºé›†åˆ</span></span><br><span class="line"><span class="comment"># STOREDIST: å­˜å‚¨è·ç¦»åˆ°æœ‰åºé›†åˆ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æœç´¢ç¤ºä¾‹</span></span><br><span class="line">GEORADIUS restaurants 116.397128 39.916527 5 km WITHDIST WITHCOORD COUNT 10</span><br><span class="line">GEORADIUSBYMEMBER restaurants starbucks 2 km WITHDIST</span><br><span class="line"></span><br><span class="line"><span class="comment"># å“ˆå¸Œæ“ä½œ</span></span><br><span class="line">GEOHASH key member1 member2 ...  <span class="comment"># è·å–ä½ç½®çš„ geohash å­—ç¬¦ä¸²</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æœ‰åºé›†åˆæ“ä½œï¼ˆåº•å±‚æ˜¯zsetï¼‰</span></span><br><span class="line">ZSCORE key member               <span class="comment"># è·å–ä½ç½®çš„geohashåˆ†æ•°</span></span><br><span class="line">ZRANGE key start stop WITHSCORES  <span class="comment"># è·å–èŒƒå›´ä½ç½®å’Œåˆ†æ•°</span></span><br><span class="line">ZREM key member1 member2         <span class="comment"># åˆ é™¤ä½ç½®</span></span><br><span class="line">ZCARD key                       <span class="comment"># è·å–ä½ç½®æ•°é‡</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰¹é‡æ“ä½œï¼ˆRedis 6.2+ï¼‰</span></span><br><span class="line">GEOSEARCH key [FROMMEMBER member | FROMLONLAT longitude latitude] [BYRADIUS radius m|km|ft|mi | BYBOX width height m|km|ft|mi] [WITHCOORD] [WITHDIST] [WITHHASH] [COUNT count] [ASC|DESC]</span><br></pre></td></tr></table></figure>
<p><strong>å¸¸è§ä½¿ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li><strong>é™„è¿‘çš„äºº</strong>ï¼šç¤¾äº¤åº”ç”¨æŸ¥æ‰¾é™„è¿‘ç”¨æˆ·ï¼Œ<code>GEORADIUS</code> æŸ¥æ‰¾æŒ‡å®šèŒƒå›´å†…çš„ç”¨æˆ·</li>
<li><strong>é™„è¿‘å•†å®¶</strong>ï¼šç”Ÿæ´»æœåŠ¡å¹³å°æŸ¥æ‰¾é™„è¿‘é¤å…ã€é…’åº—ã€é“¶è¡Œç­‰</li>
<li><strong>æ‰“è½¦æœåŠ¡</strong>ï¼šæŸ¥æ‰¾é™„è¿‘å¸æœºã€è®¡ç®—é¢„ä¼°è·ç¦»å’Œè´¹ç”¨</li>
<li><strong>å¤–å–é…é€</strong>ï¼šæŸ¥æ‰¾é™„è¿‘å•†å®¶ã€è®¡ç®—é…é€è·ç¦»å’Œæ—¶é—´</li>
<li><strong>ä½ç½®ç­¾åˆ°</strong>ï¼šè®°å½•ç”¨æˆ·ä½ç½®ï¼Œå®ç°ç­¾åˆ°åŠŸèƒ½</li>
<li><strong>åœ°ç†å›´æ </strong>ï¼šè®¾å®šè™šæ‹Ÿåœ°ç†è¾¹ç•Œï¼Œè¿›å…¥æˆ–ç¦»å¼€æ—¶è§¦å‘äº‹ä»¶</li>
<li><strong>ä½ç½®è¥é”€</strong>ï¼šåŸºäºåœ°ç†ä½ç½®çš„ç²¾å‡†è¥é”€å’Œå¹¿å‘Šæ¨é€</li>
<li><strong>ç‰©æµè¿½è¸ª</strong>ï¼šå®æ—¶è¿½è¸ªåŒ…è£¹ä½ç½®ï¼ŒæŸ¥æ‰¾é™„è¿‘é…é€ç‚¹</li>
<li><strong>æ—…æ¸¸å¯¼èˆª</strong>ï¼šæŸ¥æ‰¾é™„è¿‘æ™¯ç‚¹ã€è®¡ç®—æ™¯ç‚¹é—´è·ç¦»</li>
<li><strong>ç´§æ€¥æœåŠ¡</strong>ï¼šæŸ¥æ‰¾é™„è¿‘çš„åŒ»é™¢ã€è­¦å¯Ÿå±€ç­‰ç´§æ€¥æœåŠ¡ç‚¹</li>
</ul>
<p><strong>å®ç”¨ç¤ºä¾‹ï¼š</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ·»åŠ åŸå¸‚ä½ç½®</span></span><br><span class="line">GEOADD cities 116.397128 39.916527 beijing</span><br><span class="line">GEOADD cities 121.473701 31.230416 shanghai</span><br><span class="line">GEOADD cities 113.264385 23.129112 guangzhou</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¡ç®—è·ç¦»</span></span><br><span class="line">GEODIST cities beijing shanghai km  <span class="comment"># è¾“å‡ºï¼š1067.5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥æ‰¾åŒ—äº¬500kmå†…çš„åŸå¸‚</span></span><br><span class="line">GEORADIUS cities 116.397128 39.916527 500 km WITHDIST</span><br></pre></td></tr></table></figure>
<h3 id="9-2-åº•å±‚åŸç†">9.2 åº•å±‚åŸç†</h3>
<p>Redis Geo å¹¶æ²¡æœ‰å¼•å…¥æ–°çš„åº•å±‚æ•°æ®ç»“æ„ï¼Œå…¶æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª <code>Sorted Set</code>ã€‚</p>
<p>åœ°ç†ä½ç½®æ˜¯ä¸€ä¸ªäºŒç»´åæ ‡ <code>(ç»åº¦, çº¬åº¦)</code>ï¼Œè€Œ Redis çš„ ZSet åªèƒ½æŒ‰ä¸€ä¸ªä¸€ç»´çš„ <code>score</code> è¿›è¡Œæ’åºã€‚ä¸ºäº†å¤ç”¨ ZSet çš„æ’åºå’ŒèŒƒå›´æŸ¥æ‰¾èƒ½åŠ›ï¼Œå¿…é¡»å°†äºŒç»´åæ ‡æ˜ å°„ä¸ºä¸€ç»´æ•´æ•°ã€‚</p>
<p><strong>GeoHash</strong> å°±æ˜¯è¿™ç§æ˜ å°„ç®—æ³•ã€‚å®ƒå°†åœ°çƒè¡¨é¢åˆ’åˆ†ä¸ºæ— æ•°ä¸ªçŸ©å½¢ç½‘æ ¼ï¼Œå¹¶åˆ©ç”¨ Z-Order Curveï¼ˆZ é˜¶æ›²çº¿ï¼‰å°†äºŒç»´ç½‘æ ¼ç¼–ç ä¸ºä¸€ç»´çš„äºŒè¿›åˆ¶ä¸²ã€‚GeoHash çš„ç¼–ç è¿‡ç¨‹å°±æ˜¯<u>å°†ç»åº¦å’Œçº¬åº¦åˆ†åˆ«äºŒåˆ†é€¼è¿‘ï¼Œå¤§äºä¸­é—´å€¼è®°ä¸º 1ï¼Œå°äºè®°ä¸º 0ã€‚ç„¶åå°†ç»çº¬åº¦çš„äºŒè¿›åˆ¶ä½äº¤é”™ç»„åˆï¼ˆå¶æ•°ä½æ”¾ç²¾åº¦ï¼Œå¥‡æ•°ä½æ”¾çº¬åº¦ï¼‰ï¼Œç”Ÿæˆæœ€ç»ˆçš„ 52 ä½æ•´æ•°ã€‚</u></p>
<p>å½“æˆ‘ä»¬è¦æŸ¥è¯¢&quot;é™„è¿‘çš„äºº&quot;æ—¶ï¼Œå®é™…ä¸Šæ˜¯åœ¨ ZSet ä¸­æŸ¥æ‰¾ <code>score</code>ï¼ˆGeoHash å€¼ï¼‰ç›¸è¿‘çš„å…ƒç´ ã€‚</p>
<p>ä½†æ˜¯ï¼ŒGeoHash å­˜åœ¨ä¸€ä¸ªè‘—åçš„<strong>è¾¹ç•Œé—®é¢˜</strong>ï¼šä¸¤ä¸ªç‚¹å¯èƒ½ç›´çº¿è·ç¦»å¾ˆè¿‘ï¼Œä½†åˆšå¥½ä½äºä¸¤ä¸ªæ ¼å­çš„è¾¹ç¼˜ï¼Œå¯¼è‡´å®ƒä»¬çš„ GeoHash å€¼å·®å¼‚å·¨å¤§ï¼ˆä¾‹å¦‚ä¸€ä¸ªåœ¨ Z æ›²çº¿çš„æœ«ç«¯ï¼Œä¸€ä¸ªåœ¨èµ·ç«¯ï¼‰ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRedis åœ¨æ‰§è¡Œ <code>GEORADIUS</code> æ—¶ï¼Œä¸ä»…ä¼šæœç´¢ä¸­å¿ƒç‚¹æ‰€åœ¨çš„é‚£ä¸ªæ ¼å­ï¼ˆGeoHash èŒƒå›´ï¼‰ï¼Œè¿˜ä¼šè‡ªåŠ¨è®¡ç®—å¹¶æœç´¢<strong>å‘¨å›´çš„ 8 ä¸ªé‚»å±…æ ¼å­</strong>ã€‚</p>
<p>æˆ‘è®© Gemini ç»˜åˆ¶äº†ä¸€ä¸ªç½‘é¡µï¼Œç”¨äºè¾…åŠ©ç†è§£ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯è‡ªè¡Œä¸‹è½½å‚è€ƒã€‚</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/hedon954/geohash-display">https://github.com/hedon954/geohash-display</a></p>
</blockquote>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20251210100627954.png" alt=""></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20251210101309164.png" alt=""></p>
<h2 id="10-PubSub">10. PubSub</h2>
<p>PubSubï¼ˆPublish/Subscribeï¼Œå‘å¸ƒ/è®¢é˜…ï¼‰æ˜¯ä¸€ç§æ¶ˆæ¯é€šä¿¡æ¨¡å¼ã€‚å‘é€è€…ï¼ˆPubï¼‰å°†æ¶ˆæ¯å‘é€åˆ°é¢‘é“ï¼ˆChannelï¼‰ï¼Œè€Œä¸ç”¨çŸ¥é“è°è®¢é˜…äº†å®ƒï¼›è®¢é˜…è€…ï¼ˆSubï¼‰æ¥æ”¶æ„Ÿå…´è¶£é¢‘é“çš„æ¶ˆæ¯ï¼Œè€Œä¸ç”¨çŸ¥é“è°å‘é€äº†å®ƒã€‚</p>
<p>Pub/Sub çš„æ ¸å¿ƒé€»è¾‘æ˜¯ <strong>å¹¿æ’­ (Broadcasting)</strong>ã€‚ å®ƒå’Œ List/Stream æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼š<strong>å®ƒä¸å­˜å‚¨æ¶ˆæ¯</strong>ã€‚</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20251210095612077.png" alt=""></p>
<h3 id="10-1-æ ¸å¿ƒæ“ä½œ">10.1 æ ¸å¿ƒæ“ä½œ</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å‘å¸ƒè®¢é˜…æ“ä½œ</span></span><br><span class="line">PUBLISH channel message         <span class="comment"># å‘æŒ‡å®šé¢‘é“å‘å¸ƒæ¶ˆæ¯</span></span><br><span class="line">SUBSCRIBE channel1 channel2 ... <span class="comment"># è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªé¢‘é“</span></span><br><span class="line">UNSUBSCRIBE channel1 channel2 ...  <span class="comment"># å–æ¶ˆè®¢é˜…æŒ‡å®šé¢‘é“</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¨¡å¼è®¢é˜…</span></span><br><span class="line">PSUBSCRIBE pattern1 pattern2 ...   <span class="comment"># è®¢é˜…åŒ¹é…æ¨¡å¼çš„é¢‘é“ï¼ˆæ”¯æŒé€šé…ç¬¦*å’Œ?ï¼‰</span></span><br><span class="line">PUNSUBSCRIBE pattern1 pattern2 ... <span class="comment"># å–æ¶ˆæ¨¡å¼è®¢é˜…</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥è¯¢æ“ä½œ</span></span><br><span class="line">PUBSUB CHANNELS [pattern]         <span class="comment"># åˆ—å‡ºæ´»è·ƒçš„é¢‘é“ï¼ˆæ”¯æŒæ¨¡å¼åŒ¹é…ï¼‰</span></span><br><span class="line">PUBSUB NUMSUB [channel1 channel2 ...]  <span class="comment"># æŸ¥çœ‹æŒ‡å®šé¢‘é“çš„è®¢é˜…è€…æ•°é‡</span></span><br><span class="line">PUBSUB NUMPAT                     <span class="comment"># æŸ¥çœ‹æ¨¡å¼è®¢é˜…çš„æ•°é‡</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="comment"># å‘å¸ƒè€…</span></span><br><span class="line">PUBLISH news:sports <span class="string">&quot;ä¸­å›½é˜Ÿè·å¾—å† å†›ï¼&quot;</span></span><br><span class="line">PUBLISH notifications:user:1001 <span class="string">&quot;æ‚¨æœ‰æ–°çš„æ¶ˆæ¯&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¢é˜…è€…</span></span><br><span class="line">SUBSCRIBE news:sports</span><br><span class="line">SUBSCRIBE notifications:user:1001</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¨¡å¼è®¢é˜…ï¼ˆè®¢é˜…æ‰€æœ‰æ–°é—»é¢‘é“ï¼‰</span></span><br><span class="line">PSUBSCRIBE news:*</span><br><span class="line">PSUBSCRIBE notifications:user:*</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹é¢‘é“çŠ¶æ€</span></span><br><span class="line">PUBSUB NUMSUB news:sports notifications:user:1001</span><br><span class="line">PUBSUB CHANNELS news:*</span><br></pre></td></tr></table></figure>
<p><strong>å¸¸è§ä½¿ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li><strong>å®æ—¶é€šçŸ¥</strong>ï¼šç³»ç»Ÿé€šçŸ¥ã€æ¶ˆæ¯æ¨é€ã€äº‹ä»¶æé†’ç­‰å®æ—¶é€šçŸ¥åœºæ™¯</li>
<li><strong>èŠå¤©å®¤</strong>ï¼šå¤šç”¨æˆ·å®æ—¶èŠå¤©ç³»ç»Ÿï¼Œç¾¤èŠå¹¿æ’­æ¶ˆæ¯</li>
<li><strong>å®æ—¶æ•°æ®æ¨é€</strong>ï¼šè‚¡ç¥¨ä»·æ ¼ã€æ¯”èµ›æ¯”åˆ†ã€å®æ—¶ç›‘æ§æ•°æ®æ¨é€</li>
<li><strong>äº‹ä»¶é©±åŠ¨æ¶æ„</strong>ï¼šå¾®æœåŠ¡é—´çš„äº‹ä»¶é€šä¿¡ï¼Œè§£è€¦ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…</li>
<li><strong>ç¼“å­˜å¤±æ•ˆ</strong>ï¼šå½“æ•°æ®æ›´æ–°æ—¶ï¼Œé€šè¿‡ PubSub é€šçŸ¥ç¼“å­˜å¤±æ•ˆï¼Œå®ç°ç¼“å­˜ä¸€è‡´æ€§</li>
<li><strong>æ—¥å¿—æ”¶é›†</strong>ï¼šåº”ç”¨æ—¥å¿—å®æ—¶æ”¶é›†å’Œåˆ†å‘åˆ°æ—¥å¿—å¤„ç†ç³»ç»Ÿ</li>
<li><strong>ç›‘æ§ç³»ç»Ÿ</strong>ï¼šç³»ç»Ÿå‘Šè­¦ã€æ€§èƒ½æŒ‡æ ‡å®æ—¶æ¨é€</li>
<li><strong>é…ç½®æ›´æ–°</strong>ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„é…ç½®å˜æ›´é€šçŸ¥</li>
<li><strong>æ¸¸æˆå®æ—¶é€šä¿¡</strong>ï¼šå¤šäººæ¸¸æˆä¸­çš„çŠ¶æ€åŒæ­¥ã€ä½ç½®æ›´æ–°ç­‰</li>
</ul>
<h3 id="10-2-åº•å±‚åŸç†">10.2 åº•å±‚åŸç†</h3>
<p>Redis æœåŠ¡å™¨ç»“æ„ä½“ <code>redisServer</code> ä¸­ç»´æŠ¤äº†å…³äº Pub/Sub çš„é‡è¦å­—æ®µï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* src/server.h */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span></span><br><span class="line">  kvstore *pubsub_channels;  <span class="comment">/* Map channels to list of subscribed clients */</span></span><br><span class="line">  dict *pubsub_patterns;  <span class="comment">/* A dict of pubsub_patterns */</span></span><br><span class="line">  <span class="type">int</span> notify_keyspace_events; <span class="comment">/* Events to propagate via Pub/Sub. This is an</span></span><br><span class="line"><span class="comment">                                 xor of NOTIFY_... flags. */</span></span><br><span class="line">  kvstore *pubsubshard_channels;  <span class="comment">/* Map shard channels in every slot to list of subscribed clients */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> pubsub_clients; <span class="comment">/* # of clients in Pub/Sub mode */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>kvstore *pubsub_channels</code>:</p>
<ul>
<li><strong>æ™®é€šé¢‘é“è®¢é˜…å…³ç³»è¡¨</strong>ã€‚Key æ˜¯é¢‘é“å (Channel)ï¼ŒValue æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œå­˜å‚¨äº†æ‰€æœ‰è®¢é˜…è¯¥é¢‘é“çš„å®¢æˆ·ç«¯ (Clients)ã€‚å¯¹åº” <code>SUBSCRIBE</code> å’Œ <code>PUBLISH</code> å‘½ä»¤ã€‚</li>
<li>åœ¨ Redis 7.0 ä¹‹å‰ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ª <code>dict *</code>ï¼ˆå­—å…¸ï¼‰ã€‚ä½†åœ¨æ–°ç‰ˆæœ¬ä¸­ï¼Œå®ƒå‡çº§ä¸ºäº† <strong><code>kvstore *</code></strong>ã€‚åœ¨ Redis Cluster æ¨¡å¼ä¸‹ï¼Œæ™®é€šçš„ Pub/Sub æ˜¯<strong>å¹¿æ’­</strong>çš„ï¼ˆä¸€ä¸ªèŠ‚ç‚¹æ”¶åˆ°æ¶ˆæ¯ï¼Œä¼šè½¬å‘ç»™é›†ç¾¤å†…æ‰€æœ‰èŠ‚ç‚¹ï¼‰ã€‚<code>kvstore</code> æ˜¯ Redis å†…éƒ¨å¯¹&quot;æ”¯æŒåˆ†æ§½ï¼ˆSlotï¼‰çš„å­—å…¸&quot;çš„æŠ½è±¡ã€‚è™½ç„¶æ™®é€šçš„ Pub/Sub æ˜¯å¹¿æ’­çš„ï¼Œä½†ä½¿ç”¨ <code>kvstore</code> ç»Ÿä¸€äº†å†…éƒ¨çš„æ•°æ®ç»“æ„æ¥å£ï¼Œæ–¹ä¾¿ç®¡ç†å’Œæ‰©å®¹ã€‚</li>
</ul>
<p><code>dict *pubsub_patterns</code>:</p>
<ul>
<li><strong>æ¨¡å¼è®¢é˜…å…³ç³»è¡¨</strong>ã€‚Key æ˜¯åŒ¹é…æ¨¡å¼ (Patternï¼Œå¦‚ <code>news.*</code>)ï¼ŒValue æ˜¯è®¢é˜…äº†è¯¥æ¨¡å¼çš„å®¢æˆ·ç«¯åˆ—è¡¨ã€‚å¯¹åº” <code>PSUBSCRIBE</code> å’Œ <code>PPUBLISH</code> å‘½ä»¤ã€‚</li>
<li>å½“æœ‰æ¶ˆæ¯å‘å¸ƒåˆ° <code>news.sports</code> é¢‘é“æ—¶ï¼ŒRedis ä¸ä»…è¦æŸ¥ <code>pubsub_channels</code>ï¼Œè¿˜è¦éå†è¿™ä¸ª <code>pubsub_patterns</code> å­—å…¸ï¼Œçœ‹ <code>news.sports</code> æ˜¯å¦åŒ¹é…å…¶ä¸­çš„æ¨¡å¼ã€‚</li>
</ul>
<p><code>int notify_keyspace_events</code>:</p>
<ul>
<li><strong>é”®ç©ºé—´é€šçŸ¥é…ç½®</strong>ã€‚è¿™æ˜¯ä¸€ä¸ª <strong>Bitmask (ä½æ©ç )</strong> æ•´æ•°ã€‚å¯¹åº” <code>redis.conf</code> é…ç½®ä¸­çš„ <code>notify-keyspace-events</code>ï¼ˆå¦‚ â€œExâ€ ä»£è¡¨è¿‡æœŸäº‹ä»¶ï¼‰ã€‚</li>
<li>Redis çš„é”®ç©ºé—´é€šçŸ¥ï¼ˆKeyspace Notificationsï¼‰æœ¬è´¨ä¸Šå°±æ˜¯åˆ©ç”¨ Pub/Sub æœºåˆ¶å®ç°çš„ã€‚å½“ä¸€ä¸ª Key è¢«ä¿®æ”¹æˆ–è¿‡æœŸæ—¶ï¼Œå¦‚æœè¿™ä¸ªæ©ç ä¸­å¯¹åº”çš„ä½è¢«ç½®ä¸º 1ï¼ŒRedis å°±ä¼šè‡ªåŠ¨å‘ç‰¹å®šçš„é¢‘é“ï¼ˆå¦‚ <code>__keyevent@0__:expired</code>ï¼‰å‘é€ä¸€æ¡ Pub/Sub æ¶ˆæ¯ã€‚</li>
</ul>
<p><code>kvstore *pubsubshard_channels</code>:</p>
<ul>
<li><strong>åˆ†ç‰‡é¢‘é“è®¢é˜…å…³ç³»è¡¨ (Sharded Pub/Sub)</strong>ã€‚å¯¹åº” <code>SSUBSCRIBE</code> å’Œ <code>SPUBLISH</code> å‘½ä»¤ (Redis 7.0 æ–°å¢)ã€‚</li>
<li>æ™®é€šçš„ Pub/Sub åœ¨é›†ç¾¤ä¸­æ˜¯<strong>å…¨é‡å¹¿æ’­</strong>çš„ã€‚ä½ åœ¨èŠ‚ç‚¹ A å‘å¸ƒæ¶ˆæ¯ï¼ŒèŠ‚ç‚¹ A ä¼šæŠŠå®ƒè½¬å‘ç»™ Bã€Cã€Dâ€¦ å³ä½¿ Bã€Cã€D ä¸Šæ ¹æœ¬æ²¡æœ‰å®¢æˆ·ç«¯è®¢é˜…è¿™ä¸ªé¢‘é“ã€‚è¿™é€ æˆäº†å·¨å¤§çš„ç½‘ç»œå¸¦å®½æµªè´¹ï¼ˆå†™æ”¾å¤§ï¼‰ã€‚</li>
<li><strong>Sharded Pub/Sub</strong> å°†é¢‘é“åé€šè¿‡ Hash ç®—æ³•æ˜ å°„åˆ°å…·ä½“çš„ <strong>Slot (æ§½)</strong>ï¼Œå°±åƒæ™®é€šçš„ Key ä¸€æ ·ã€‚æ¶ˆæ¯åªä¼šè¢«å‘é€åˆ°<strong>æŒæœ‰è¯¥ Slot çš„èŠ‚ç‚¹</strong>ï¼Œä¸å†å…¨ç½‘å¹¿æ’­ã€‚è¿™é‡Œçš„ <strong><code>kvstore</code></strong> å‘æŒ¥äº†å…³é”®ä½œç”¨ï¼šå®ƒèƒ½æ ¹æ® Slot å¿«é€Ÿç´¢å¼•å’Œç®¡ç†é¢‘é“ã€‚è¿™æ˜¯ Redis 7.0 é’ˆå¯¹é›†ç¾¤ Pub/Sub æ€§èƒ½ä¼˜åŒ–çš„ä¸€å¤§ä½“ç°ã€‚</li>
</ul>
<p><code>unsigned int pubsub_clients</code>:</p>
<ul>
<li><strong>å½“å‰çš„ Pub/Sub å®¢æˆ·ç«¯æ€»æ•°</strong>ã€‚ç”¨äº <code>INFO</code> å‘½ä»¤ç»Ÿè®¡å’Œç›‘æ§ã€‚</li>
<li>Redis éœ€è¦çŸ¥é“å½“å‰æœ‰å¤šå°‘ä¸ªè¿æ¥å¤„äº&quot;è®¢é˜…çŠ¶æ€&quot;ï¼Œå› ä¸ºå¤„äºè®¢é˜…çŠ¶æ€çš„å®¢æˆ·ç«¯ï¼Œå…¶ socket è¯»å–é€»è¾‘å’Œæ™®é€šå®¢æˆ·ç«¯ç•¥æœ‰ä¸åŒï¼ˆåªèƒ½å‘é€è®¢é˜…ç›¸å…³å‘½ä»¤ï¼‰ã€‚</li>
</ul>
<blockquote>
<p>[!WARNING]</p>
<p>æ³¨æ„ï¼Œè™½ç„¶ Pub/Sub ä¸ä¿å­˜æ¶ˆæ¯ï¼Œä½†æ˜¯ä¸ºäº†ä¿è¯æŠŠæ¶ˆæ¯æ¨ç»™ï¼ˆåœ¨çº¿çš„ï¼‰è®¢é˜…è€…ï¼Œä¼šæŠŠç§¯å‹çš„æ¶ˆæ¯æš‚æ—¶å­˜åœ¨è¯¥è®¢é˜…è€… Client çš„ <strong>è¾“å‡ºç¼“å†²åŒº (Output Buffer)</strong> ä¸­ã€‚å¦‚æœæ¶ˆè´¹è€…å¤„ç†å¾—å¾ˆæ…¢ï¼Œå¯¼è‡´ç§¯å‹è¶Šæ¥è¶Šå¤šï¼Œè¿™ä¸ªç¼“å†²åŒºä¼šæ— é™è†¨èƒ€ï¼Œæœ€ç»ˆ OOMã€‚</p>
<p>Redis é»˜è®¤é…ç½®äº†ä¿æŠ¤ç­–ç•¥ <code>client-output-buffer-limit</code>ï¼šå¦‚æœç¼“å†²åŒºè¶…è¿‡ 32MBï¼Œæˆ–è€…æŒç»­ 60 ç§’è¶…è¿‡ 8MBï¼ŒRedis ä¼š<strong>å¼ºåˆ¶æ–­å¼€</strong>è¿™ä¸ªè®¢é˜…è€…çš„è¿æ¥ã€‚è®¢é˜…è€…æ–­è¿ï¼Œæ¶ˆæ¯ä¸¢å¤±ï¼Œä½† Redis æ´»ä¸‹æ¥äº†ã€‚</p>
</blockquote>
<h2 id="11-Stream">11. Stream</h2>
<p>Redis Stream æ˜¯ Redis 5.0 å¼•å…¥çš„æœ€é‡é‡çº§ç‰¹æ€§ï¼Œå®ƒçš„å‡ºç°æ˜¯ä¸ºäº†å¡«è¡¥ Redis åœ¨æ¶ˆæ¯é˜Ÿåˆ—é¢†åŸŸçš„æœ€åä¸€å—çŸ­æ¿â€”â€”<strong>æŒä¹…åŒ–ä¸å¯é æ€§</strong>ã€‚</p>
<p>åœ¨æ­¤ä¹‹å‰ï¼Œä½¿ç”¨ Redis åšæ¶ˆæ¯é˜Ÿåˆ—ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼Œä½†éƒ½æœ‰è‡´å‘½ç¼ºé™·ï¼š</p>
<ol>
<li><strong>List (<code>BLPOP</code>)</strong>ï¼šæ— æ³•æ”¯æŒå¤šæ’­ï¼›æ›´è‡´å‘½çš„æ˜¯ï¼Œå®ƒæ²¡æœ‰ <strong>ACK æœºåˆ¶</strong>ã€‚æ¶ˆæ¯ä¸€æ—¦ä»é˜Ÿåˆ—ä¸­ <code>POP</code> å‡ºæ¥ï¼Œå¦‚æœæ¶ˆè´¹è€…å¤„ç†æ—¶å®•æœºï¼Œè¿™æ¡æ¶ˆæ¯å°±æ°¸ä¹…ä¸¢å¤±äº†ã€‚</li>
<li><strong>Pub/Sub</strong>ï¼šæ”¯æŒå¤šæ’­ï¼Œä½†å®ƒæ˜¯ <strong>Fire and Forget</strong>ï¼ˆå³å‘å³å¼ƒï¼‰æ¨¡å¼ã€‚å¦‚æœæ¶ˆè´¹è€…ä¸‹çº¿ï¼ŒæœŸé—´å‘é€çš„æ‰€æœ‰æ¶ˆæ¯éƒ½ä¼šä¸¢å¤±ï¼Œä¸”æ— æ³•å›æº¯ã€‚</li>
</ol>
<p>Stream çš„è®¾è®¡çµæ„Ÿæ·±å— Kafka å½±å“ï¼Œå®ƒä¸ä»…æ”¯æŒå¤šæ’­ï¼ˆæ¶ˆè´¹ç»„ï¼‰ï¼Œè¿˜å¼•å…¥äº† <strong>PEL (Pending Entries List)</strong> æœºåˆ¶æ¥ä¿è¯æ¶ˆæ¯çš„ç»å¯¹ä¸ä¸¢å¤±ï¼ŒåŒæ—¶åœ¨åº•å±‚ç»“æ„ä¸Šé’ˆå¯¹&quot;æ—¶é—´åºåˆ— ID&quot;åšäº†æè‡´çš„å†…å­˜å‹ç¼©ã€‚</p>
<h3 id="11-1-æ ¸å¿ƒæ“ä½œ">11.1 æ ¸å¿ƒæ“ä½œ</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŸºç¡€æ“ä½œ</span></span><br><span class="line">XADD key [MAXLEN len [~]] [NOMKSTREAM] *|ID field value [field value ...]  <span class="comment"># æ·»åŠ æ¶ˆæ¯</span></span><br><span class="line">XLEN key                              <span class="comment"># è·å–æµä¸­æ¶ˆæ¯æ•°é‡</span></span><br><span class="line">XRANGE key start end [COUNT count]    <span class="comment"># è¯»å–èŒƒå›´å†…çš„æ¶ˆæ¯ï¼ˆæ­£å‘ï¼‰</span></span><br><span class="line">XREVRANGE key end start [COUNT count] <span class="comment"># è¯»å–èŒƒå›´å†…çš„æ¶ˆæ¯ï¼ˆåå‘ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¶ˆæ¯è¯»å–</span></span><br><span class="line">XREAD [COUNT count] [BLOCK milliseconds] [NOACK] STREAMS key1 key2 ... ID1 ID2 ...</span><br><span class="line"><span class="comment"># IDé€‰é¡¹ï¼š$ï¼ˆæœ€æ–°æ¶ˆæ¯ï¼‰ã€&gt;ï¼ˆæ¶ˆè´¹è€…ç»„æ–°æ¶ˆæ¯ï¼‰ã€å…·ä½“æ—¶é—´æˆ³ID</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¶ˆè´¹ç»„æ“ä½œ</span></span><br><span class="line">XGROUP [CREATE key groupname <span class="built_in">id</span>|$] [MKSTREAM]           <span class="comment"># åˆ›å»ºæ¶ˆè´¹ç»„</span></span><br><span class="line">XGROUP [DESTROY key groupname]                         <span class="comment"># é”€æ¯æ¶ˆè´¹ç»„</span></span><br><span class="line">XGROUP [SETID key groupname <span class="built_in">id</span>|$]                      <span class="comment"># è®¾ç½®æ¶ˆè´¹ç»„æœ€åæ¶ˆæ¯ID</span></span><br><span class="line">XGROUP [DELCONSUMER key groupname consumername]        <span class="comment"># åˆ é™¤æ¶ˆè´¹è€…</span></span><br><span class="line">XINFO [GROUPS key]                                     <span class="comment"># æŸ¥çœ‹æ¶ˆè´¹ç»„ä¿¡æ¯</span></span><br><span class="line">XINFO [CONSUMERS key groupname]                        <span class="comment"># æŸ¥çœ‹æ¶ˆè´¹è€…ä¿¡æ¯</span></span><br><span class="line">XINFO [STREAM key] [FULL]                              <span class="comment"># æŸ¥çœ‹æµè¯¦ç»†ä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¶ˆè´¹è€…è¯»å–</span></span><br><span class="line">XREADGROUP GROUP group consumer [COUNT count] [BLOCK milliseconds] [NOACK] STREAMS key1 key2 ... ID1 ID2 ...</span><br><span class="line"><span class="comment"># IDé€‰é¡¹ï¼š&gt;ï¼ˆæ–°æ¶ˆæ¯ï¼‰ã€0ï¼ˆæ‰€æœ‰æœªå¤„ç†æ¶ˆæ¯ï¼‰ã€å…·ä½“ID</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¶ˆæ¯ç¡®è®¤</span></span><br><span class="line">XACK key group ID [ID ...]                            <span class="comment"># ç¡®è®¤æ¶ˆæ¯å·²å¤„ç†</span></span><br><span class="line">XPENDING key group [start end count consumer]         <span class="comment"># æŸ¥çœ‹å¾…å¤„ç†æ¶ˆæ¯</span></span><br><span class="line">XCLAIM key group consumer min_idle_time ID [ID ...] [IDLE ms] [TIME ms] [RETRYCOUNT count] [FORCE] [JUSTID] [LASTID <span class="built_in">id</span>]</span><br><span class="line">XDEL key ID [ID ...]                                  <span class="comment"># åˆ é™¤æ¶ˆæ¯</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®å‰ªæ“ä½œ</span></span><br><span class="line">XTRIM key MAXLEN len [~]                              <span class="comment"># ä¿®å‰ªæµåˆ°æŒ‡å®šé•¿åº¦</span></span><br><span class="line">XTRIM key MINID threshold [~]                         <span class="comment"># åˆ é™¤å°äºæŒ‡å®šIDçš„æ¶ˆæ¯</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="comment"># åˆ›å»ºæµå¹¶æ·»åŠ æ¶ˆæ¯</span></span><br><span class="line">XADD mystream * name <span class="string">&quot;å¼ ä¸‰&quot;</span> age 25</span><br><span class="line">XADD mystream * name <span class="string">&quot;æå››&quot;</span> age 30</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯»å–æ¶ˆæ¯</span></span><br><span class="line">XREAD COUNT 2 STREAMS mystream 0-0</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæ¶ˆè´¹ç»„</span></span><br><span class="line">XGROUP CREATE mystream mygroup $ MKSTREAM</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¶ˆè´¹è€…è¯»å–</span></span><br><span class="line">XREADGROUP GROUP mygroup consumer1 COUNT 1 STREAMS mystream &gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¡®è®¤æ¶ˆæ¯</span></span><br><span class="line">XACK mystream mygroup 1672502400000-0</span><br></pre></td></tr></table></figure>
<p><strong>å¸¸è§ä½¿ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li><strong>æ¶ˆæ¯é˜Ÿåˆ—</strong>ï¼šæ›¿ä»£ RabbitMQ/Kafkaï¼Œå¤„ç†å¼‚æ­¥ä»»åŠ¡ã€äº‹ä»¶é©±åŠ¨æ¶æ„</li>
<li><strong>äº‹ä»¶æº¯æº</strong>ï¼šè®°å½•ç³»ç»ŸçŠ¶æ€å˜æ›´å†å²ï¼Œæ”¯æŒäº‹ä»¶å›æ”¾å’Œæ—¶é—´æ—…è¡ŒæŸ¥è¯¢</li>
<li><strong>æ—¥å¿—æ”¶é›†</strong>ï¼šåº”ç”¨æ—¥å¿—çš„å¯é æ”¶é›†å’Œè½¬å‘ï¼Œæ”¯æŒæ¶ˆè´¹è€…ç»„å¹¶è¡Œå¤„ç†</li>
<li><strong>ç›‘æ§å‘Šè­¦</strong>ï¼šç³»ç»Ÿç›‘æ§æŒ‡æ ‡çš„æ—¶åºæ•°æ®å­˜å‚¨å’Œåˆ†æ</li>
<li><strong>æ•°æ®ç®¡é“</strong>ï¼šETL è¿‡ç¨‹ä¸­çš„æ•°æ®ç¼“å†²å’Œæ‰¹å¤„ç†</li>
<li><strong>å®æ—¶åˆ†æ</strong>ï¼šç”¨æˆ·è¡Œä¸ºåˆ†æã€ç‚¹å‡»æµå¤„ç†ç­‰å®æ—¶æ•°æ®æµå¤„ç†</li>
<li><strong>IoT æ•°æ®</strong>ï¼šç‰©è”ç½‘è®¾å¤‡æ•°æ®çš„æ—¶åºå­˜å‚¨å’Œå¤„ç†</li>
<li><strong>é‡‘èäº¤æ˜“</strong>ï¼šäº¤æ˜“æ—¥å¿—è®°å½•ã€å®¡è®¡è¿½è¸ªï¼Œæ”¯æŒç²¾ç¡®çš„æ—¶é—´åºåˆ—æŸ¥è¯¢</li>
<li><strong>æ¸¸æˆç³»ç»Ÿ</strong>ï¼šæ¸¸æˆäº‹ä»¶è®°å½•ã€ç©å®¶è¡Œä¸ºåˆ†æ</li>
<li><strong>èŠå¤©ç³»ç»Ÿ</strong>ï¼šå¯é çš„æ¶ˆæ¯æŠ•é€’ï¼Œæ”¯æŒç¦»çº¿æ¶ˆæ¯å’Œæ¶ˆæ¯é‡è¯•</li>
</ul>
<h3 id="11-2-åº•å±‚åŸç†">11.2 åº•å±‚åŸç†</h3>
<p>Stream æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª <strong>ä»…è¿½åŠ  (Append-only)</strong> çš„æ—¥å¿—ç»“æ„ã€‚ä¸ºäº†æ»¡è¶³é«˜æ•ˆçš„èŒƒå›´æŸ¥æ‰¾ï¼ˆæŒ‰æ—¶é—´èŒƒå›´è¯»æ¶ˆæ¯ï¼‰å’Œæè‡´çš„å†…å­˜èŠ‚çœï¼ŒRedis å¹¶æ²¡æœ‰ä½¿ç”¨ç®€å•çš„é“¾è¡¨æˆ–æ•°ç»„ï¼Œè€Œæ˜¯è®¾è®¡äº†ä¸€ç§æ··åˆç»“æ„ï¼š<strong>Radix Tree (åŸºæ•°æ ‘) + Listpack</strong>ã€‚</p>
<h4 id="11-2-1-stream">11.2.1 stream</h4>
<p>Stream å®šä¹‰åœ¨ <a target="_blank" rel="noopener" href="https://github.com/redis/redis/blob/8.4.0/src/stream.h#L16">src/stream.h</a>ï¼Œè´Ÿè´£ç»´æŠ¤æ¶ˆæ¯çš„å…ƒæ•°æ®ã€å­˜å‚¨å¼•æ“ï¼ˆRaxï¼‰å…¥å£ä»¥åŠæ¶ˆè´¹ç»„çŠ¶æ€ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Stream æ ¸å¿ƒç»“æ„ä½“</span></span><br><span class="line"><span class="comment"> * ä½äº src/stream.h */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">stream</span> &#123;</span></span><br><span class="line">    <span class="comment">/* ---- æ•°æ®å­˜å‚¨åŒº ---- */</span></span><br><span class="line">    rax *rax;               <span class="comment">/* æ ¸å¿ƒå­˜å‚¨å¼•æ“ï¼šRadix Treeã€‚</span></span><br><span class="line"><span class="comment">                             * Key: æ¶ˆæ¯ ID (å¤§ç«¯åºäºŒè¿›åˆ¶)</span></span><br><span class="line"><span class="comment">                             * Value: æŒ‡å‘ä¸€ä¸ª Listpack çš„æŒ‡é’ˆ (æ¯ä¸ª Listpack å­˜å¤šæ¡æ¶ˆæ¯) */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint64_t</span> length;        <span class="comment">/* å½“å‰ Stream ä¸­çš„æœ‰æ•ˆæ¶ˆæ¯æ•°é‡ (ä¸åŒ…å«å·²åˆ é™¤çš„æ¶ˆæ¯) */</span></span><br><span class="line"></span><br><span class="line">    streamID last_id;       <span class="comment">/* å½“å‰ Stream ä¸­æœ€åä¸€æ¡æ¶ˆæ¯çš„ ID (è‹¥ä¸ºç©ºåˆ™ä¸º 0-0) */</span></span><br><span class="line">    streamID first_id;      <span class="comment">/* å½“å‰ Stream ä¸­ç¬¬ä¸€æ¡æ¶ˆæ¯çš„ ID (è‹¥ä¸ºç©ºåˆ™ä¸º 0-0) */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ---- ç»Ÿè®¡ä¸æ¸…ç† ---- */</span></span><br><span class="line">    streamID max_deleted_entry_id;  <span class="comment">/* å†å²ä¸Šè¢«åˆ é™¤çš„æœ€å¤§æ¶ˆæ¯ ID (ç”¨äºåè®®å…¼å®¹) */</span></span><br><span class="line">    <span class="type">uint64_t</span> entries_added;         <span class="comment">/* å†å²ä¸Šç´¯è®¡å†™å…¥è¿‡çš„æ¶ˆæ¯æ€»æ•° (å³ ID åºåˆ—å·è®¡æ•°å™¨) */</span></span><br><span class="line">    <span class="type">size_t</span> alloc_size;              <span class="comment">/* Stream è‡ªèº«å ç”¨çš„å †å†…å­˜å¤§å° (ä¸å« key æœ¬èº«) */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ---- æ¶ˆè´¹ç»„ç®¡ç† ---- */</span></span><br><span class="line">    rax *cgroups;           <span class="comment">/* æ¶ˆè´¹ç»„å­—å…¸ã€‚</span></span><br><span class="line"><span class="comment">                             * Key: æ¶ˆè´¹ç»„åç§° (String)</span></span><br><span class="line"><span class="comment">                             * Value: streamCG ç»“æ„ä½“æŒ‡é’ˆ */</span></span><br><span class="line"></span><br><span class="line">    rax *cgroups_ref;       <span class="comment">/* è¾…åŠ©ç´¢å¼•ï¼šç”¨äºåŠ é€Ÿ NACK å¤„ç†ç­‰åœºæ™¯ */</span></span><br><span class="line"></span><br><span class="line">    streamID min_cgroup_last_id;    <span class="comment">/* ç¼“å­˜ï¼šæ‰€æœ‰æ¶ˆè´¹ç»„ä¸­ï¼Œè¿›åº¦æœ€æ…¢çš„é‚£ä¸ª last_idã€‚</span></span><br><span class="line"><span class="comment">                                     * ç”¨äºåƒåœ¾å›æ”¶ï¼Œåˆ¤æ–­å“ªäº›æ•°æ®å¯ä»¥å®‰å…¨æ¸…ç† */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> min_cgroup_last_id_valid: <span class="number">1</span>; <span class="comment">/* ç¼“å­˜æ˜¯å¦æœ‰æ•ˆæ ‡è®° */</span></span><br><span class="line">&#125; stream;</span><br></pre></td></tr></table></figure>
<h4 id="11-2-2-streamID">11.2.2 streamID</h4>
<p>Stream çš„æ¶ˆæ¯ ID é»˜è®¤æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œæ ¼å¼ä¸º <code>&lt;æ—¶é—´æˆ³&gt;-&lt;åºåˆ—å·&gt;</code>ï¼ˆä¾‹å¦‚ <code>1702108800000-0</code>ï¼‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">streamID</span> &#123;</span></span><br><span class="line">    <span class="type">uint64_t</span> ms;        <span class="comment">/* Unix time in milliseconds. */</span></span><br><span class="line">    <span class="type">uint64_t</span> seq;       <span class="comment">/* Sequence number. */</span></span><br><span class="line">&#125; streamID;</span><br></pre></td></tr></table></figure>
<p>è§‚å¯Ÿè¿™ç»„ IDï¼Œä½ ä¼šå‘ç°ä¸€ä¸ªæ˜¾è‘—ç‰¹å¾ï¼š<strong>å‰ç¼€é«˜åº¦é‡å¤</strong>ã€‚åœ¨åŒä¸€æ¯«ç§’ç”šè‡³åŒä¸€ç§’å†…äº§ç”Ÿçš„æ¶ˆæ¯ï¼Œå…¶ ID çš„é«˜ä½éƒ¨åˆ†æ˜¯å®Œå…¨ç›¸åŒçš„ã€‚å¦‚æœä½¿ç”¨æ™®é€šçš„ Hash è¡¨æˆ–è·³è¡¨å­˜å‚¨ï¼Œè¿™äº›é‡å¤çš„å‰ç¼€ä¼šæµªè´¹å¤§é‡å†…å­˜ã€‚</p>
<h4 id="11-2-3-Radix-Tree">11.2.3 Radix Tree</h4>
<p><strong>Radix Tree (Rax)</strong> æ˜¯ä¸€ç§å‰ç¼€æ ‘ã€‚å®ƒå°†å…¬å…±å‰ç¼€æå–å‡ºæ¥ä½œä¸ºçˆ¶èŠ‚ç‚¹ï¼Œå·®å¼‚éƒ¨åˆ†ä½œä¸ºå­èŠ‚ç‚¹ã€‚è¿™ç§ç»“æ„å¤©ç„¶é€‚åˆå­˜å‚¨æ—¶é—´åºåˆ—æ•°æ®ï¼Œæå¤§åœ°å‹ç¼©äº†ç´¢å¼•ç©ºé—´ã€‚</p>
<img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/1280px-Radix_tree.svg.png" alt="undefined" style="zoom: 25%;" />
<blockquote>
<p>è¿™å¹¶éæ ‡å‡†çš„ Radix Tree çš„å®ç°ï¼Œæ ‡å‡†çš„ Radix Tree ä¸€ä¸ªèŠ‚ç‚¹åªæœ‰ä¸€ä¸ªå­—ç¬¦ï¼Œå½“ç„¶è¿™å¯¹äº Stream è¿™ä¸ªåœºæ™¯ä¾æ—§æ˜¯æå¤§çš„æµªè´¹ï¼Œæ‰€ä»¥ä¸€ä¸ªæ”¹è¿›æ–¹æ¡ˆå°±æ˜¯å°†å¤šä¸ªç›¸åŒå‰ç¼€çš„å­—ç¬¦åˆå¹¶åœ¨ä¸€ä¸ªä½œä¸ºä¸€ä¸ªå…±äº«èŠ‚ç‚¹ã€‚</p>
<p>äº‹å®ä¸Š Go çš„ Gin æ¡†æ¶çš„è·¯ç”±æ ‘ä¹Ÿæ˜¯é‡‡å–çš„è¿™ç§ç­–ç•¥ï¼Œå…·ä½“å¯å‚è€ƒï¼š<a href="https://hedon.top/2025/06/30/go/go-gin/">Go åº•å±‚åŸç†ä¸¨æ·±åº¦å‰–æ Gin æ¡†æ¶æ ¸å¿ƒæœºåˆ¶ï¼šä» HTTP è¯·æ±‚ç”Ÿå‘½å‘¨æœŸåˆ°é«˜æ€§èƒ½è®¾è®¡å“²å­¦</a>ã€‚</p>
</blockquote>
<p>å¦‚æœ Rax çš„æ¯ä¸ªå¶å­èŠ‚ç‚¹åªæŒ‚ä¸€æ¡æ¶ˆæ¯ï¼Œé‚£æŒ‡é’ˆå¼€é”€ä¾ç„¶å¾ˆå¤§ã€‚Redis å†æ¬¡è¿ç”¨äº†&quot;æ‰“åŒ…&quot;çš„æ€æƒ³ã€‚</p>
<p>Stream åœ¨ Rax çš„èŠ‚ç‚¹ä¸­ï¼Œå¹¶ä¸ç›´æ¥å­˜å‚¨å•ä¸ªæ¶ˆæ¯ï¼Œè€Œæ˜¯å­˜å‚¨ä¸€ä¸ª <code>listpack</code>ï¼ˆåˆæ¥äº†ï¼Œç¥å¥‡çš„ listpackï¼‰ã€‚ä¸€ä¸ª Rax èŠ‚ç‚¹ï¼ˆç§°ä¸ºå®èŠ‚ç‚¹ï¼‰å¯èƒ½åŒ…å«å‡ åæ¡ç”šè‡³ä¸Šç™¾æ¡æ¶ˆæ¯ã€‚</p>
<ul>
<li><strong>å®è§‚ä¸Š</strong>ï¼šåˆ©ç”¨ Radix Tree å¯¹ ID å‰ç¼€è¿›è¡Œå‹ç¼©ï¼Œæ”¯æŒ $O(\log N)$ çš„æ—¶é—´èŒƒå›´æŸ¥æ‰¾ã€‚</li>
<li><strong>å¾®è§‚ä¸Š</strong>ï¼šåˆ©ç”¨ Listpack å¯¹å…·ä½“çš„æ¶ˆæ¯å†…å®¹ï¼ˆField-Valueï¼‰è¿›è¡Œç´§å‡‘å­˜å‚¨ï¼Œåˆ©ç”¨ CPU ç¼“å­˜è¡Œå¹¶å‡å°‘å†…å­˜ç¢ç‰‡ã€‚</li>
</ul>
<blockquote>
<p>[!IMPORTANT]</p>
<p>è¿™å†æ¬¡å°è¯äº† Redis çš„è®¾è®¡å“²å­¦ï¼šåœ¨å¤§è§„æ¨¡ç´¢å¼•ä¸Šä½¿ç”¨æ ‘/è·³è¡¨ï¼ˆç©ºé—´æ¢æ—¶é—´ï¼‰ï¼Œåœ¨å±€éƒ¨å°æ•°æ®å—ä¸Šä½¿ç”¨ç´§å‡‘æ•°ç»„ï¼ˆæ—¶é—´æ¢ç©ºé—´ï¼‰ã€‚</p>
</blockquote>
<p>Radix Tree å®šä¹‰åœ¨ <a target="_blank" rel="noopener" href="https://github.com/redis/redis/blob/8.4.0/src/rax.h#L78">src/rax.h</a>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Rax (Radix Tree) å¤´éƒ¨ */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">rax</span> &#123;</span></span><br><span class="line">    raxNode *head;          <span class="comment">/* æŒ‡å‘æ ¹èŠ‚ç‚¹çš„æŒ‡é’ˆ */</span></span><br><span class="line">    <span class="type">uint64_t</span> numele;        <span class="comment">/* æ ‘ä¸­å­˜å‚¨çš„å…ƒç´ æ€»æ•° (å³ Key çš„æ•°é‡) */</span></span><br><span class="line">    <span class="type">uint64_t</span> numnodes;      <span class="comment">/* æ ‘ä¸­èŠ‚ç‚¹çš„æ€»æ•° */</span></span><br><span class="line">    <span class="type">size_t</span> *alloc_size;     <span class="comment">/* æŒ‡å‘å¤–éƒ¨å˜é‡çš„æŒ‡é’ˆï¼Œç”¨äºç»Ÿè®¡è¯¥æ ‘å ç”¨çš„æ€»å†…å­˜ */</span></span><br><span class="line">    <span class="type">void</span> *metadata[];       <span class="comment">/* å¯é€‰çš„å…ƒæ•°æ®åŒºåŸŸ (é€šå¸¸ç”¨äºå¡«å……å¯¹é½) */</span></span><br><span class="line">&#125; rax;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Rax èŠ‚ç‚¹ */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">raxNode</span> &#123;</span></span><br><span class="line">    <span class="comment">/* ---- ä½åŸŸæ ‡å¿—å¤´ (4å­—èŠ‚) ---- */</span></span><br><span class="line">    <span class="type">uint32_t</span> iskey:<span class="number">1</span>;     <span class="comment">/* 1 è¡¨ç¤ºè¿™å°±åˆ°è¾¾äº†ä¸€ä¸ª Key çš„ç»ˆç‚¹ (åŒ…å« Value) */</span></span><br><span class="line">    <span class="type">uint32_t</span> isnull:<span class="number">1</span>;    <span class="comment">/* 1 è¡¨ç¤º Value ä¸º NULL (å³ä½¿ iskey=1) */</span></span><br><span class="line">    <span class="type">uint32_t</span> iscompr:<span class="number">1</span>;   <span class="comment">/* 1 è¡¨ç¤ºè¿™æ˜¯å‹ç¼©èŠ‚ç‚¹ (Compressed)ï¼Œ0 è¡¨ç¤ºéå‹ç¼© (Normal) */</span></span><br><span class="line">    <span class="type">uint32_t</span> size:<span class="number">29</span>;     <span class="comment">/* èŠ‚ç‚¹è´Ÿè½½å¤§å°ï¼š</span></span><br><span class="line"><span class="comment">                           * - è‹¥ iscompr=1: è¡¨ç¤ºå‹ç¼©åç¼€çš„é•¿åº¦ (å­—èŠ‚æ•°)</span></span><br><span class="line"><span class="comment">                           * - è‹¥ iscompr=0: è¡¨ç¤ºå­èŠ‚ç‚¹çš„æ•°é‡ (è¾¹æ•°) */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ---- æŸ”æ€§æ•°ç»„ï¼šæ•°æ®è´Ÿè½½åŒº ----</span></span><br><span class="line"><span class="comment">     * è¿™é‡Œçš„å¸ƒå±€æ ¹æ® iscompr çš„å€¼å®Œå…¨ä¸åŒ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> data[];</span><br><span class="line">&#125; raxNode;</span><br></pre></td></tr></table></figure>
<p>ç”±äº <code>data[]</code> æ˜¯å˜é•¿çš„ï¼ŒC è¯­è¨€æ— æ³•ç›´æ¥æè¿°å…¶ç»“æ„ï¼Œå…¶å†…å­˜å¸ƒå±€å¦‚ä¸‹ï¼š</p>
<p><strong>1. å‹ç¼©èŠ‚ç‚¹ï¼ˆiscompr = 1ï¼‰</strong></p>
<p>è¿™æ„å‘³ç€è¿™æ˜¯ä¸€æ¡<strong>å•è¡Œé“</strong>ã€‚ å½“å‰èŠ‚ç‚¹åªæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œä¸”ä¸­é—´ç»è¿‡äº†ä¸€ä¸²å­—ç¬¦ã€‚ æ¯”å¦‚ï¼šä»èŠ‚ç‚¹ A åˆ°èŠ‚ç‚¹ Bï¼Œä¸­é—´çš„è·¯å¾„å­—ç¬¦ä¸²æ˜¯ <code>&quot;QD&quot;</code>ã€‚</p>
<p><code>data[]</code> çš„å†…å­˜å¸ƒå±€ï¼šå®ƒåƒä¸‰æ˜æ²»ä¸€æ ·ï¼ŒæŠŠ<strong>è·¯å¾„å­—ç¬¦ä¸²â€<strong>å’Œ</strong>å”¯ä¸€çš„å­èŠ‚ç‚¹æŒ‡é’ˆ</strong>ç´§æŒ¨ç€æ”¾ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+-----------------------+ &lt;-- èŠ‚ç‚¹èµ·å§‹åœ°å€</span><br><span class="line">| Header (4 Bytes)      | iskey=1, iscompr=1, size=2</span><br><span class="line">+-----------------------+</span><br><span class="line">| &#x27;Q&#x27; (1 Byte)          | \</span><br><span class="line">+-----------------------+  &gt; å‹ç¼©å­—ç¬¦ä¸² &quot;QD&quot;</span><br><span class="line">| &#x27;D&#x27; (1 Byte)          | /</span><br><span class="line">+-----------------------+</span><br><span class="line">| Child Ptr (8 Bytes)   | --&gt; æŒ‡å‘ä¸‹ä¸€ä¸ª raxNode (ä»£è¡¨ ID åç»­éƒ¨åˆ†çš„èŠ‚ç‚¹)</span><br><span class="line">+-----------------------+</span><br><span class="line">| Value Ptr (8 Bytes)   | --&gt; æŒ‡å‘ Listpack (å­˜å‚¨æ¶ˆæ¯å†…å®¹) [ä»…å½“ iskey=1 æ—¶å­˜åœ¨]</span><br><span class="line">+-----------------------+</span><br></pre></td></tr></table></figure>
<img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20251210002143921.png" style="zoom:33%;" />
<p><strong>2. éå‹ç¼©èŠ‚ç‚¹ï¼ˆiscompr = 0ï¼‰</strong></p>
<p>è¿™æ„å‘³ç€è¿™æ˜¯ä¸€ä¸ª<strong>åå­—è·¯å£</strong>ï¼ˆåˆ†å‰ç‚¹ï¼‰ã€‚ å½“å‰èŠ‚ç‚¹æœ‰å¤šä¸ªå­èŠ‚ç‚¹ã€‚ æ¯”å¦‚ï¼šèŠ‚ç‚¹ A ä¸‹é¢åˆ†å‡ºäº† <code>'A'</code>, <code>'B'</code>, <code>'C'</code> ä¸‰æ¡è·¯ã€‚</p>
<p><strong><code>data[]</code> çš„å†…å­˜å¸ƒå±€</strong>ï¼š å®ƒæŠŠ**æ‰€æœ‰çš„è·¯ç‰Œï¼ˆå­—ç¬¦ï¼‰<strong>æ”¾ä¸€èµ·ï¼ŒæŠŠ</strong>æ‰€æœ‰çš„è·¯ï¼ˆæŒ‡é’ˆï¼‰**æ”¾ä¸€èµ·ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">+-----------------------+ &lt;-- èŠ‚ç‚¹èµ·å§‹åœ°å€</span><br><span class="line">| Header (4 Bytes)      | iskey=1, iscompr=0, size=3</span><br><span class="line">+-----------------------+</span><br><span class="line">| &#x27;A&#x27; (1 Byte)          | \</span><br><span class="line">+-----------------------+  |</span><br><span class="line">| &#x27;B&#x27; (1 Byte)          |  &gt; å­èŠ‚ç‚¹ç´¢å¼•å­—ç¬¦ (å…±3ä¸ª)</span><br><span class="line">+-----------------------+  |</span><br><span class="line">| &#x27;C&#x27; (1 Byte)          | /</span><br><span class="line">+-----------------------+</span><br><span class="line">| Padding (X Bytes)     | &lt;-- å†…å­˜å¯¹é½å¡«å…… (è§†å½“å‰åç§»é‡è€Œå®šï¼Œç¡®ä¿åç»­æŒ‡é’ˆåœ°å€å¯¹é½)</span><br><span class="line">+-----------------------+</span><br><span class="line">| Child Ptr 1 (8 Bytes) | --&gt; æŒ‡å‘ &#x27;A&#x27; åˆ†æ”¯çš„ä¸‹ä¸€ä¸ª raxNode</span><br><span class="line">+-----------------------+</span><br><span class="line">| Child Ptr 2 (8 Bytes) | --&gt; æŒ‡å‘ &#x27;B&#x27; åˆ†æ”¯çš„ä¸‹ä¸€ä¸ª raxNode</span><br><span class="line">+-----------------------+</span><br><span class="line">| Child Ptr 3 (8 Bytes) | --&gt; æŒ‡å‘ &#x27;C&#x27; åˆ†æ”¯çš„ä¸‹ä¸€ä¸ª raxNode</span><br><span class="line">+-----------------------+</span><br><span class="line">| Value Ptr (8 Bytes)   | --&gt; æŒ‡å‘ Listpack (å­˜å‚¨æ¶ˆæ¯å†…å®¹) [ä»…å½“ iskey=1 æ—¶å­˜åœ¨]</span><br><span class="line">+-----------------------+</span><br></pre></td></tr></table></figure>
<img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20251210002239926.png" style="zoom:33%;" />
<h4 id="11-2-4-streamCG">11.2.4 streamCG</h4>
<p>Stream èƒ½æ›¿ä»£ List æˆä¸ºä¼ä¸šçº§æ¶ˆæ¯é˜Ÿåˆ—çš„æ ¸å¿ƒï¼Œåœ¨äºå®ƒå¼•å…¥äº†<strong>æ¶ˆè´¹ç»„ (Consumer Group)</strong> å’Œ <strong>PEL (Pending Entries List)</strong>ã€‚</p>
<p>å½“æ¶ˆè´¹è€…è°ƒç”¨ <code>XREADGROUP</code> è¯»å–æ¶ˆæ¯æ—¶ï¼š</p>
<ol>
<li>æ¶ˆæ¯<strong>ä¸ä¼š</strong>ä» Stream ä¸­åˆ é™¤ï¼ˆè¿™ç‚¹ä¸ List ä¸åŒï¼‰ã€‚</li>
<li>æ¶ˆæ¯ ID ä¼šè¢«åŠ å…¥åˆ°è¯¥æ¶ˆè´¹è€…çš„ <strong>PEL</strong> ä¸­ã€‚</li>
<li>åªæœ‰å½“æ¶ˆè´¹è€…æ˜¾å¼è°ƒç”¨ <code>XACK</code> åï¼ŒRedis æ‰ä¼šæŠŠè¯¥ ID ä» PEL ä¸­ç§»é™¤ã€‚</li>
</ol>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/8887.1571235190.png" alt=""></p>
<p>è¿™èƒŒåçš„æ ¸å¿ƒæ•°æ®ç»“æ„æ˜¯ <code>streamCG</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Consumer group. */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">streamCG</span> &#123;</span></span><br><span class="line">    streamID last_id;       <span class="comment">/* è¯¥æ¶ˆè´¹ç»„æœ€åä¸€æ¬¡äº¤ä»˜ï¼ˆä½†æœªç¡®è®¤ï¼‰çš„æ¶ˆæ¯ IDã€‚</span></span><br><span class="line"><span class="comment">                               å½“æ¶ˆè´¹è€…è¯·æ±‚â€œæ–°æ¶ˆæ¯â€æ—¶ï¼ŒRedis ä¼šæä¾›å¤§äºæ­¤ ID çš„æ¶ˆæ¯ã€‚ */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> entries_read; <span class="comment">/* ç»Ÿè®¡ä¿¡æ¯ï¼šè¯¥ç»„è¯»å–çš„æ¶ˆæ¯æ€»æ•° */</span></span><br><span class="line"></span><br><span class="line">    rax *pel;               <span class="comment">/* Pending Entries List (å¾…å¤„ç†åˆ—è¡¨)ã€‚</span></span><br><span class="line"><span class="comment">                               è¿™æ˜¯ä¸€ä¸ª Radix Treeã€‚</span></span><br><span class="line"><span class="comment">                               Key: æ¶ˆæ¯ ID (64ä½å¤§ç«¯åº)</span></span><br><span class="line"><span class="comment">                               Value: streamNACK ç»“æ„ (è®°å½•äº†æŠ•é€’æ¬¡æ•°ã€æœ€åæŠ•é€’æ—¶é—´ç­‰)</span></span><br><span class="line"><span class="comment">                               ä½œç”¨: è®°å½•æ‰€æœ‰å·²å‘ç»™æ¶ˆè´¹è€…ä½†å°šæœª ACK çš„æ¶ˆæ¯ã€‚ */</span></span><br><span class="line"></span><br><span class="line">    rax *pel_by_time;       <span class="comment">/* è¾…åŠ©ç´¢å¼•ï¼šæŒ‰â€œæŠ•é€’æ—¶é—´â€æ’åºçš„ PELã€‚</span></span><br><span class="line"><span class="comment">                               Key: pelTimeKey (åŒ…å« delivery_time + stream ID)</span></span><br><span class="line"><span class="comment">                               Value: NULL (æ‰€æœ‰ä¿¡æ¯éƒ½åœ¨ Key é‡Œ)</span></span><br><span class="line"><span class="comment">                               ä½œç”¨: åŠ é€Ÿè¶…æ—¶æ¶ˆæ¯çš„æŸ¥è¯¢ (å¦‚ XPENDING ... IDLE &lt;time&gt;)ã€‚ */</span></span><br><span class="line"></span><br><span class="line">    rax *consumers;         <span class="comment">/* æ¶ˆè´¹è€…å­—å…¸ã€‚</span></span><br><span class="line"><span class="comment">                               Key: æ¶ˆè´¹è€…åç§°</span></span><br><span class="line"><span class="comment">                               Value: streamConsumer ç»“æ„ */</span></span><br><span class="line">&#125; streamCG;</span><br></pre></td></tr></table></figure>
<p>æ¯ä¸ªæ¶ˆè´¹ç»„éƒ½æœ‰ä¸€ä¸ªå…¨å±€æ¸¸æ ‡ <code>last_id</code>ã€‚</p>
<ul>
<li>å½“ä½ ä½¿ç”¨ <code>XREADGROUP GROUP mygroup alice &gt;</code> æ—¶ï¼Œé‚£ä¸ª <code>&gt;</code> ç¬¦å·å®é™…ä¸Šå°±æ˜¯å‘Šè¯‰ Redisï¼šâ€œè¯·æŠŠ <code>last_id</code> ä¹‹åçš„æ¶ˆæ¯å‘ç»™æˆ‘â€ã€‚</li>
<li>Redis å‘é€æ¶ˆæ¯åï¼Œä¼šæ›´æ–° <code>last_id</code>ã€‚è¿™ä¿è¯äº†åœ¨åŒä¸€ä¸ªç»„å†…ï¼Œæ¶ˆæ¯ä¸ä¼šè¢«é‡å¤æ¶ˆè´¹ï¼ˆé™¤éæ˜¾å¼å›æº¯ï¼‰ã€‚</li>
</ul>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¦‚æœæˆ‘ä»¬æŠŠ Radix Tree æ‘Šå¹³æ¥çœ‹ï¼Œæ¯ä¸ªæ¶ˆè´¹ç»„æœ‰è‡ªå·±çš„æ¸¸æ ‡ä½ç½®ï¼Œäº’ä¸å¹²æ‰°ï¼Œè€Œ <code>stream</code> ç»“æ„ä¸­çš„ <code>min_cgroup_last_id</code> å­—æ®µä¼šå­˜å‚¨æœ€æ»¡çš„ <code>last_id</code>ï¼Œé‚£å‰é¢çš„æ¶ˆæ¯å°±å¯ä»¥åˆ é™¤äº†ã€‚</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/5646.1571235119.png" alt=""></p>
<p><strong>PEL (Pending Entries List)</strong> æ˜¯ Stream å®ç° <strong>At Least Once</strong> çš„å…³é”®ã€‚<code>streamCG</code> ç»´æŠ¤äº†ä¸€ä¸ªåä¸º <code>pel</code> çš„ Radix Treeã€‚</p>
<ul>
<li><strong>å†™å…¥æ—¶æœº</strong>ï¼šå½“æ¶ˆæ¯è¢« <code>XREADGROUP</code> è¯»å–ä½†æœª <code>XACK</code> æ—¶ï¼Œå®ƒä¼šç«‹å³è¿›å…¥ <code>pel</code>ã€‚</li>
<li><strong>ç§»é™¤æ—¶æœº</strong>ï¼šåªæœ‰æ”¶åˆ° <code>XACK</code>ï¼ŒRedis æ‰ä¼šå°†è¯¥ ID ä» <code>pel</code> ä¸­ç§»é™¤ã€‚</li>
</ul>
<p>å¦‚æœæ¶ˆè´¹è€…å®•æœºï¼Œè¿™æ¡æ¶ˆæ¯ä¼šæ°¸ä¹…åœç•™åœ¨ <code>pel</code> ä¸­ã€‚è¿ç»´äººå‘˜å¯ä»¥é€šè¿‡ <code>XPENDING</code> å‘½ä»¤æŸ¥çœ‹åˆ°è¿™äº›æ¶ˆæ¯ï¼Œå¹¶å®‰æ’å…¶ä»–æ¶ˆè´¹è€…è¿›è¡Œ <strong>Claim (æ¥ç®¡)</strong>ã€‚</p>
<p>ä»”ç»†è§‚å¯Ÿç»“æ„ä½“ï¼Œä½ ä¼šå‘ç° <code>streamGC</code> ç»´æŠ¤äº†<strong>ä¸¤ä¸ª</strong>ä¸ PEL ç›¸å…³çš„ Radix Treeï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Consumer group. */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">streamCG</span> &#123;</span></span><br><span class="line">    rax *pel;</span><br><span class="line">    rax *pel_by_time;</span><br><span class="line">&#125; streamCG;</span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯ä¸€ç§å…¸å‹çš„<strong>ç©ºé—´æ¢æ—¶é—´</strong>è®¾è®¡ï¼š</p>
<ul>
<li><code>pel</code>: æŒ‰ ID ç´¢å¼•ï¼ŒKey æ˜¯ <code>æ¶ˆæ¯ ID</code>ã€‚å½“æ¶ˆè´¹è€…å‘é€ <code>XACK &lt;id&gt;</code> æ—¶ï¼ŒRedis éœ€è¦å¿«é€Ÿæ‰¾åˆ°è¿™æ¡æ¶ˆæ¯å¹¶æ ‡è®°å®Œæˆã€‚ä½¿ç”¨ ID ç´¢å¼•å¯ä»¥è¾¾åˆ° $O(\log N)$ çš„æŸ¥æ‰¾é€Ÿåº¦ã€‚</li>
<li><code>pel_by_time</code>: æŒ‰æ—¶é—´ç´¢å¼•ï¼ŒKey æ˜¯ <code>æŠ•é€’æ—¶é—´ + æ¶ˆæ¯ ID</code>ã€‚ç”¨äºæ•…éšœæ¢å¤ã€‚å½“æˆ‘ä»¬éœ€è¦æ‰¾å‡º&quot;å“ªäº›æ¶ˆæ¯å·²ç»è¶…æ—¶ 10 åˆ†é’Ÿæ²¡å¤„ç†äº†ï¼Ÿ&quot;ï¼ˆå³ <code>XPENDING ... IDLE &lt;time&gt;</code> å‘½ä»¤ï¼‰ï¼ŒRedis ä¸éœ€è¦éå†æ•´ä¸ª PELï¼Œè€Œæ˜¯ç›´æ¥åœ¨ <code>pel_by_time</code> è¿™ä¸ªæ—¶é—´æ ‘ä¸Šè¿›è¡ŒèŒƒå›´æŸ¥æ‰¾ã€‚</li>
</ul>
<p>è¿™ç§<strong>ä¸»é”®ç´¢å¼• + è¾…åŠ©ç´¢å¼•</strong>çš„è®¾è®¡ï¼Œç¡®ä¿äº† Stream æ— è®ºæ˜¯<strong>æ­£å¸¸ç¡®è®¤ (ACK)</strong> è¿˜æ˜¯<strong>æ•…éšœæ’æŸ¥ (Pending Query)</strong>ï¼Œéƒ½èƒ½ä¿æŒæé«˜çš„æ€§èƒ½ï¼Œä¸ä¼šå› ä¸ºç§¯å‹æ¶ˆæ¯è¿‡å¤šè€Œæ‹–æ…¢ Redisã€‚</p>
<blockquote>
<p>[!WARNING]</p>
<p>ä½†è¿™ä¸æ„å‘³ç€ Redis Stream å°±å¯ä»¥æ›¿ä»£ä¼ ç»Ÿçš„ MQ äº†ï¼Œå…¶æœ¬è´¨ä¸Šæ˜¯å—é™äºæ˜‚è´µçš„å†…å­˜å®¹é‡å’Œå¼‚æ­¥æŒä¹…åŒ–æœºåˆ¶ï¼Œæ— æ³•åƒåŸºäºç£ç›˜çš„ Kafka é‚£æ ·ä»¥ä½æˆæœ¬å®ç°æµ·é‡æ•°æ®çš„é•¿æœŸå †ç§¯ä¸é‡‘èçº§çš„é›¶ä¸¢å¤±ä¿éšœã€‚</p>
</blockquote>
<h2 id="12-åŸç†å’Œåº”ç”¨åœºæ™¯æ€»ç»“">12. åŸç†å’Œåº”ç”¨åœºæ™¯æ€»ç»“</h2>
<p>Redis çš„æ•°æ®ç±»å‹è™½ç„¶ä¸°å¯Œå¤šæ ·ï¼Œä½†ä¸‡å˜ä¸ç¦»å…¶å®—ã€‚å›é¡¾å…¨æ–‡ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Redis åœ¨è®¾è®¡ä¸Šå§‹ç»ˆåœ¨åš<strong>ä¸¤ä¸ªç»´åº¦çš„æƒè¡¡ï¼ˆTrade-offï¼‰</strong>ï¼š</p>
<ol>
<li><strong>å†…å­˜ vs CPU</strong>ï¼šåœ¨æ•°æ®é‡å°‘æ—¶ï¼Œå€¾å‘äºä½¿ç”¨æ—¶é—´æ¢ç©ºé—´çš„ç´§å‡‘ç»“æ„ï¼ˆå¦‚ Listpackã€Intsetï¼‰ï¼Œé€šè¿‡ CPU çš„è½®è¯¢è®¡ç®—æ¥èŠ‚çœæ˜‚è´µçš„å†…å­˜ï¼›åœ¨æ•°æ®é‡å¤§æ—¶ï¼Œå€¾å‘äºä½¿ç”¨ç©ºé—´æ¢æ—¶é—´çš„ç´¢å¼•ç»“æ„ï¼ˆå¦‚ Hashtableã€Skiplistï¼‰ï¼Œé€šè¿‡å¢åŠ æŒ‡é’ˆå¼€é”€æ¥ä¿è¯ O(1) æˆ– O(logN) çš„è®¿é—®é€Ÿåº¦ã€‚</li>
<li><strong>ç²¾ç¡® vs æ¦‚ç‡</strong>ï¼šåœ¨å¤„ç†æµ·é‡æ•°æ®ç»Ÿè®¡æ—¶ï¼Œä¸ºäº†çªç ´ç‰©ç†å†…å­˜çš„é™åˆ¶ï¼Œå¼•å…¥äº†æ¦‚ç‡å‹æ•°æ®ç»“æ„ï¼ˆHLLã€Bloom Filterï¼‰ï¼Œç”¨æå°çš„è¯¯å·®æ¢å–äº†å·¨å¤§çš„ç©ºé—´æ”¶ç›Šã€‚</li>
</ol>
<p>ä»¥ä¸‹æ˜¯å…¨ç³»æ•°æ®ç±»å‹çš„æ ¸å¿ƒåŸç†ä¸é€‰å‹æŒ‡å—ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left">æ•°æ®ç±»å‹</th>
<th style="text-align:left">åº•å±‚ç»“æ„ (Encoding)</th>
<th style="text-align:left">è®¾è®¡æƒè¡¡ (Trade-off)</th>
<th style="text-align:left">æ ¸å¿ƒé€‚ç”¨åœºæ™¯</th>
<th style="text-align:left">å…³é”®é™åˆ¶/æ³¨æ„</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><strong>String</strong></td>
<td style="text-align:left"><strong>int</strong> / <strong>embstr</strong> / <strong>raw</strong> (SDS)</td>
<td style="text-align:left">æ ¹æ®é•¿åº¦åŠ¨æ€åˆ†é…å¤´éƒ¨ï¼Œå‡å°‘å†…å­˜ç¢ç‰‡ã€‚</td>
<td style="text-align:left">ç¼“å­˜ã€è®¡æ•°å™¨ã€åˆ†å¸ƒå¼é”ã€ä¼šè¯</td>
<td style="text-align:left">æœ€å¤§ 512MBã€‚</td>
</tr>
<tr>
<td style="text-align:left"><strong>List</strong></td>
<td style="text-align:left"><strong>Quicklist</strong> (Listpack é“¾è¡¨)</td>
<td style="text-align:left"><strong>å®è§‚é“¾è¡¨ + å¾®è§‚æ•°ç»„</strong>ã€‚å¹³è¡¡äº†å†…å­˜ç´§å‡‘æ€§ä¸ä¸¤ç«¯æ“ä½œçš„çµæ´»æ€§ã€‚</td>
<td style="text-align:left">æ¶ˆæ¯é˜Ÿåˆ—ã€æœ€æ–° N æ¡åŠ¨æ€ã€æ ˆ</td>
<td style="text-align:left">éšæœºè®¿é—® (<code>LINDEX</code>) æ…¢ï¼Œé€‚åˆå¤´å°¾æ“ä½œã€‚</td>
</tr>
<tr>
<td style="text-align:left"><strong>Hash</strong></td>
<td style="text-align:left"><strong>Listpack</strong> $\to$ <strong>Hashtable</strong></td>
<td style="text-align:left">å°æ•°æ®ç”¨ç´§å‡‘æ•°ç»„ï¼ˆçœå†…å­˜ä½† O(N)ï¼‰ï¼Œå¤§æ•°æ®è½¬å“ˆå¸Œè¡¨ï¼ˆå¿«ä½†è´¹å†…å­˜ï¼‰ã€‚</td>
<td style="text-align:left">å¯¹è±¡å­˜å‚¨ã€è´­ç‰©è½¦ã€é…ç½®é¡¹</td>
<td style="text-align:left">é¿å…å¤§ Keyï¼Œå¤§ Hash è¿ç§»ä¼šé˜»å¡ï¼ˆè™½æœ‰æ¸è¿›å¼ Rehashï¼‰ã€‚</td>
</tr>
<tr>
<td style="text-align:left"><strong>Set</strong></td>
<td style="text-align:left"><strong>Intset</strong> $\to$ <strong>Hashtable</strong></td>
<td style="text-align:left">çº¯æ•´æ•°ä¸”æœ‰åºæ—¶æè‡´å‹ç¼©ï¼Œä¸€æ—¦æ’å…¥éæ•´æ•°<strong>ä¸å¯é€†</strong>è½¬ä¸ºå“ˆå¸Œè¡¨ã€‚</td>
<td style="text-align:left">æ ‡ç­¾ç³»ç»Ÿã€å…±åŒå¥½å‹ã€æŠ½å¥–</td>
<td style="text-align:left">å°½é‡å­˜æ•´æ•° ID ä»¥åˆ©ç”¨ Intset ä¼˜åŒ–ã€‚</td>
</tr>
<tr>
<td style="text-align:left"><strong>ZSet</strong></td>
<td style="text-align:left"><strong>Listpack</strong> $\to$ <strong>Skiplist</strong>+<strong>Dict</strong></td>
<td style="text-align:left">åŒé‡ç»“æ„ï¼šDict ä¿è¯æŸ¥è¯¢ O(1)ï¼Œè·³è¡¨ä¿è¯èŒƒå›´ O(logN)ã€‚</td>
<td style="text-align:left">æ’è¡Œæ¦œã€å»¶è¿Ÿé˜Ÿåˆ—ã€èŒƒå›´æŸ¥æ‰¾</td>
<td style="text-align:left">å†…å­˜å ç”¨è¾ƒé«˜ï¼ˆæŒ‡é’ˆå¤šï¼‰ï¼Œå…ƒç´ å¤šæ—¶æ³¨æ„æ€§èƒ½ã€‚</td>
</tr>
<tr>
<td style="text-align:left"><strong>Bitmap</strong></td>
<td style="text-align:left"><strong>String</strong> (ä½æ•°ç»„)</td>
<td style="text-align:left">ç”¨ Bit è¡¨ç¤ºçŠ¶æ€ï¼Œå°† String è§†ä¸ºç»“æ„ä½“æ•°ç»„ (<code>BITFIELD</code>)ã€‚</td>
<td style="text-align:left">æ—¥æ´»ç»Ÿè®¡ã€ç­¾åˆ°ã€ç”¨æˆ·çŠ¶æ€</td>
<td style="text-align:left">æ“ä½œç¨€ç–æ•°æ®æ—¶ä¼šæµªè´¹å¤§é‡å†…å­˜ã€‚</td>
</tr>
<tr>
<td style="text-align:left"><strong>HLL</strong></td>
<td style="text-align:left"><strong>String</strong> (Sparse/Dense)</td>
<td style="text-align:left"><strong>æ¦‚ç‡ç»Ÿè®¡</strong>ã€‚ç”¨è°ƒå’Œå¹³å‡æ•°æ¶ˆé™¤ç¦»ç¾¤å€¼ï¼Œ12KB ç»Ÿè®¡äº¿çº§åŸºæ•°ã€‚</td>
<td style="text-align:left">UV ç»Ÿè®¡ã€ç‹¬ç«‹ IP æ•°</td>
<td style="text-align:left">æœ‰ 0.81% è¯¯å·®ï¼Œæ— æ³•å–å‡ºå…·ä½“å…ƒç´ ã€‚</td>
</tr>
<tr>
<td style="text-align:left"><strong>Bloom</strong></td>
<td style="text-align:left"><strong>Bitmap</strong> + Hash å‡½æ•°</td>
<td style="text-align:left"><strong>æ¦‚ç‡åˆ¤å­˜</strong>ã€‚ç»æ— å‡é˜´æ€§ï¼Œä½†æœ‰å‡é˜³æ€§ã€‚</td>
<td style="text-align:left">ç¼“å­˜ç©¿é€é˜²æŠ¤ã€é»‘åå•æ ¡éªŒ</td>
<td style="text-align:left">ä¸æ”¯æŒåˆ é™¤ï¼ˆé™¤éç”¨ Counting BFï¼‰ï¼Œéœ€å®¹å¿è¯¯åˆ¤ã€‚</td>
</tr>
<tr>
<td style="text-align:left"><strong>Geo</strong></td>
<td style="text-align:left"><strong>ZSet</strong> (GeoHash)</td>
<td style="text-align:left"><strong>é™ç»´æ‰“å‡»</strong>ã€‚å°†äºŒç»´åæ ‡æ˜ å°„ä¸ºä¸€ç»´æ•´æ•°ï¼Œå¤ç”¨ ZSet æ’åºèƒ½åŠ›ã€‚</td>
<td style="text-align:left">é™„è¿‘çš„äººã€è·ç¦»è®¡ç®—</td>
<td style="text-align:left">å­˜åœ¨è¾¹ç•Œè¯¯å·®ï¼ˆéœ€æŸ¥ 9 å®«æ ¼ï¼‰ï¼Œé«˜çº¬åº¦ç•¸å˜ã€‚</td>
</tr>
<tr>
<td style="text-align:left"><strong>PubSub</strong></td>
<td style="text-align:left">Dict + LinkedList</td>
<td style="text-align:left"><strong>æ— çŠ¶æ€å¹¿æ’­</strong>ã€‚å³å‘å³å¼ƒï¼Œä¸å­˜å‚¨æ•°æ®ã€‚</td>
<td style="text-align:left">å®æ—¶é€šçŸ¥ã€é…ç½®åˆ·æ–°</td>
<td style="text-align:left">æ¶ˆè´¹è€…æ–­çº¿å³ä¸¢æ¶ˆæ¯ï¼Œæ— å †ç§¯èƒ½åŠ›ã€‚</td>
</tr>
<tr>
<td style="text-align:left"><strong>Stream</strong></td>
<td style="text-align:left"><strong>Radix Tree</strong> + <strong>Listpack</strong></td>
<td style="text-align:left"><strong>å‰ç¼€å‹ç¼©</strong>ã€‚é’ˆå¯¹æ—¶é—´åºåˆ— ID ä¼˜åŒ–ï¼Œå¼•å…¥æ¶ˆè´¹ç»„å’Œ PEL ä¿è¯å¯é æ€§ã€‚</td>
<td style="text-align:left">è½»é‡çº§ MQã€äº‹ä»¶æº¯æºã€æ—¥å¿—</td>
<td style="text-align:left">å†…å­˜å‹å­˜å‚¨ï¼Œä¸é€‚åˆæµ·é‡å†å²æ•°æ®å›æº¯ã€‚</td>
</tr>
</tbody>
</table>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/redis/redis/blob/8.4.0">Redis 8.4.0</a></li>
<li><a target="_blank" rel="noopener" href="https://redis.io/docs/latest/commands/">Redis Commands</a></li>
<li><a target="_blank" rel="noopener" href="https://systemdesign.one/bloom-filters-explained/">Bloom Filters Explained</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Radix_tree">Wikipedia-Radix tree</a></li>
<li><a target="_blank" rel="noopener" href="https://devopedia.org/redis-streams">redis streams</a></li>
</ul>

<div class="article-footer fs14">
    <section id="license">
      <div class="header"><span>è®¸å¯åè®®</span></div>
      <div class="body"><p>æœ¬æ–‡é‡‡ç”¨ <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…</a> è®¸å¯åè®®ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>
</div>
    </section>
    
    <section id="share">
      <div class="header"><span>åˆ†äº«æ–‡ç« </span></div>
      <div class="body">
        <div class="link"><input class="copy-area" readonly="true" id="copy-link" value="https://hedon.top/2025/12/09/redis/redis-datatype/" /></div>
        <div class="social-wrap dis-select"><a class="social share-item wechat" onclick="util.toggle(&quot;qrcode-wechat&quot;)"><img class="lazy"  src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/b32ef3da1162a.svg" /></a><a class="social share-item weibo" target="_blank" rel="external nofollow noopener noreferrer" href="https://service.weibo.com/share/share.php?url=https://hedon.top/2025/12/09/redis/redis-datatype/&title=ç›˜ç‚¹ Redis å„ç§æ•°æ®ç±»å‹ - HedonWang&pics=/banner/redis-datatype.jpg&summary=æœ¬æ–‡ç³»ç»Ÿæ¢³ç† Redis åä¸€ç§æ•°æ®ç±»å‹ï¼Œå¹¶ç»“åˆåº•å±‚å®ç°åŸç†ã€å…³é”®ä¼˜åŒ–ç»†èŠ‚ï¼Œæ·±å…¥è§£æå…¶é«˜æ€§èƒ½èƒŒåçš„è®¾è®¡æ™ºæ…§ä¸æŠ€æœ¯å–èˆã€‚"><img class="lazy"  src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/80c07e4dbb303.svg" /></a><a class="social share-item email" href="mailto:?subject=ç›˜ç‚¹ Redis å„ç§æ•°æ®ç±»å‹ - HedonWang&amp;body=https://hedon.top/2025/12/09/redis/redis-datatype/"><img class="lazy"  src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/a1b00e20f425d.svg" /></a><a class="social share-item link" onclick="util.copy(&quot;copy-link&quot;, &quot;å¤åˆ¶æˆåŠŸ&quot;)"><img class="lazy"  src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/8411ed322ced6.svg" /></a></div>
        
        <div class="qrcode" id="qrcode-wechat" style="opacity:0;height:0">
          <img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=https://hedon.top/2025/12/09/redis/redis-datatype/"/>
        </div>
        
      </div>
    </section>
    </div>
</article>
<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"></div><div class="item" id="next"><div class="note">è¾ƒæ—©æ–‡ç« </div><a href="/2025/12/08/mysql/mysql-binlog-practice/">MySQL Binlog å®è·µ CDC</a></div></section></div>




  <div class="related-wrap md-text" id="comments">
    <section class='header cmt-title cap theme'>
      <p>å¿«æ¥å‚ä¸è®¨è®ºå§~</p>

    </section>
    <section class='body cmt-body giscus'>
      

<svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg>

<div id="giscus" src="https://giscus.app/client.js" data-repo="hedon954/hedonspace" data-repo-id="R_kgDOKt17sQ" data-category="Q&A" data-category-id="DIC_kwDOKt17sc4CbAt-" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous"></div>

    </section>
  </div>



<footer class="page-footer footnote"><hr><div class="text"><p>æœ¬ç«™ç”± <a href="/">Hedon Wang</a> ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.29.1">Stellar 1.29.1</a> ä¸»é¢˜åˆ›å»ºã€‚<br>
æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper toc" id="data-toc" collapse="false"><div class="widget-header dis-select"><span class="name">æœ¬æ–‡ç›®å½•</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0-redisObject"><span class="toc-text">0. redisObject</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-String"><span class="toc-text">1. String</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E6%A0%B8%E5%BF%83%E6%93%8D%E4%BD%9C"><span class="toc-text">1.1 æ ¸å¿ƒæ“ä½œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86"><span class="toc-text">1.2 åº•å±‚åŸç†</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-List"><span class="toc-text">2. List</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E6%A0%B8%E5%BF%83%E6%93%8D%E4%BD%9C"><span class="toc-text">2.1 æ ¸å¿ƒæ“ä½œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86"><span class="toc-text">2.2 åº•å±‚åŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-LinkedList"><span class="toc-text">2.2.1 LinkedList</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-Ziplist"><span class="toc-text">2.2.2 Ziplist</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-3-Quicklist"><span class="toc-text">2.2.3 Quicklist</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-4-Listpack"><span class="toc-text">2.2.4 Listpack</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Hash"><span class="toc-text">3. Hash</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E6%A0%B8%E5%BF%83%E6%93%8D%E4%BD%9C"><span class="toc-text">3.1 æ ¸å¿ƒæ“ä½œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86"><span class="toc-text">3.2 åº•å±‚åŸç†</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Set"><span class="toc-text">4. Set</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E6%A0%B8%E5%BF%83%E6%93%8D%E4%BD%9C"><span class="toc-text">4.1 æ ¸å¿ƒæ“ä½œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86"><span class="toc-text">4.2 åº•å±‚åŸç†</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-Sorted-Set"><span class="toc-text">5. Sorted Set</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E6%A0%B8%E5%BF%83%E6%93%8D%E4%BD%9C"><span class="toc-text">5.1 æ ¸å¿ƒæ“ä½œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86"><span class="toc-text">5.2 åº•å±‚åŸç†</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-Bitmap"><span class="toc-text">6. Bitmap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-HyperLogLog"><span class="toc-text">7. HyperLogLog</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E6%A0%B8%E5%BF%83%E6%93%8D%E4%BD%9C"><span class="toc-text">7.1 æ ¸å¿ƒæ“ä½œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86"><span class="toc-text">7.2 åº•å±‚åŸç†</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-Bloom-Filter"><span class="toc-text">8. Bloom Filter</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-%E6%A0%B8%E5%BF%83%E6%93%8D%E4%BD%9C"><span class="toc-text">8.1 æ ¸å¿ƒæ“ä½œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86"><span class="toc-text">8.2 åº•å±‚åŸç†</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-Geospatial"><span class="toc-text">9. Geospatial</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-%E6%A0%B8%E5%BF%83%E6%93%8D%E4%BD%9C"><span class="toc-text">9.1 æ ¸å¿ƒæ“ä½œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86"><span class="toc-text">9.2 åº•å±‚åŸç†</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-PubSub"><span class="toc-text">10. PubSub</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-1-%E6%A0%B8%E5%BF%83%E6%93%8D%E4%BD%9C"><span class="toc-text">10.1 æ ¸å¿ƒæ“ä½œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-2-%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86"><span class="toc-text">10.2 åº•å±‚åŸç†</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-Stream"><span class="toc-text">11. Stream</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#11-1-%E6%A0%B8%E5%BF%83%E6%93%8D%E4%BD%9C"><span class="toc-text">11.1 æ ¸å¿ƒæ“ä½œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-2-%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86"><span class="toc-text">11.2 åº•å±‚åŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#11-2-1-stream"><span class="toc-text">11.2.1 stream</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-2-2-streamID"><span class="toc-text">11.2.2 streamID</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-2-3-Radix-Tree"><span class="toc-text">11.2.3 Radix Tree</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-2-4-streamCG"><span class="toc-text">11.2.4 streamCG</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-%E5%8E%9F%E7%90%86%E5%92%8C%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF%E6%80%BB%E7%BB%93"><span class="toc-text">12. åŸç†å’Œåº”ç”¨åœºæ™¯æ€»ç»“</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-text">å‚è€ƒ</span></a></li></ol></div><div class="widget-footer">

<a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 12c0-4.714 0-7.071 1.464-8.536C4.93 2 7.286 2 12 2c4.714 0 7.071 0 8.535 1.464C22 4.93 22 7.286 22 12c0 4.714 0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12Z"/><path stroke-linecap="round" stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/></g></svg><span>å›åˆ°é¡¶éƒ¨</span></a><a class="buttom" onclick="util.scrollComment()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M10.46 1.25h3.08c1.603 0 2.86 0 3.864.095c1.023.098 1.861.3 2.6.752a5.75 5.75 0 0 1 1.899 1.899c.452.738.654 1.577.752 2.6c.095 1.004.095 2.261.095 3.865v1.067c0 1.141 0 2.036-.05 2.759c-.05.735-.153 1.347-.388 1.913a5.75 5.75 0 0 1-3.112 3.112c-.805.334-1.721.408-2.977.43a10.81 10.81 0 0 0-.929.036c-.198.022-.275.054-.32.08c-.047.028-.112.078-.224.232c-.121.166-.258.396-.476.764l-.542.916c-.773 1.307-2.69 1.307-3.464 0l-.542-.916a10.605 10.605 0 0 0-.476-.764c-.112-.154-.177-.204-.224-.232c-.045-.026-.122-.058-.32-.08c-.212-.023-.49-.03-.93-.037c-1.255-.021-2.171-.095-2.976-.429A5.75 5.75 0 0 1 1.688 16.2c-.235-.566-.338-1.178-.389-1.913c-.049-.723-.049-1.618-.049-2.76v-1.066c0-1.604 0-2.86.095-3.865c.098-1.023.3-1.862.752-2.6a5.75 5.75 0 0 1 1.899-1.899c.738-.452 1.577-.654 2.6-.752C7.6 1.25 8.857 1.25 10.461 1.25M6.739 2.839c-.914.087-1.495.253-1.959.537A4.25 4.25 0 0 0 3.376 4.78c-.284.464-.45 1.045-.537 1.96c-.088.924-.089 2.11-.089 3.761v1c0 1.175 0 2.019.046 2.685c.045.659.131 1.089.278 1.441a4.25 4.25 0 0 0 2.3 2.3c.515.214 1.173.294 2.429.316h.031c.398.007.747.013 1.037.045c.311.035.616.104.909.274c.29.17.5.395.682.645c.169.232.342.525.538.856l.559.944a.52.52 0 0 0 .882 0l.559-.944c.196-.331.37-.624.538-.856c.182-.25.392-.476.682-.645c.293-.17.598-.24.909-.274c.29-.032.639-.038 1.037-.045h.032c1.255-.022 1.913-.102 2.428-.316a4.25 4.25 0 0 0 2.3-2.3c.147-.352.233-.782.278-1.441c.046-.666.046-1.51.046-2.685v-1c0-1.651 0-2.837-.089-3.762c-.087-.914-.253-1.495-.537-1.959a4.25 4.25 0 0 0-1.403-1.403c-.464-.284-1.045-.45-1.96-.537c-.924-.088-2.11-.089-3.761-.089h-3c-1.651 0-2.837 0-3.762.089" clip-rule="evenodd"/><path fill="currentColor" d="M9 11a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0"/></svg><span>å‚ä¸è®¨è®º</span></a></div></widget>
</div></aside><div class='float-panel blur'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">
<script type="text/javascript">
  const ctx = {
    date_suffix: {
      just: `åˆšåˆš`,
      min: `åˆ†é’Ÿå‰`,
      hour: `å°æ—¶å‰`,
      day: `å¤©å‰`,
    },
    root : `/`,
    tag_plugins: {
      chat: Object.assign({"api":"https://siteinfo.listentothewind.cn/api/v1"}),
    }
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"all","path":"/search.json","content":true,"skip_search":null,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
  };
  const deps = {
    jquery: `https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js`,
    marked: `https://cdn.jsdelivr.net/npm/marked@13.0.1/lib/marked.umd.min.js`
  }
  

</script>

<script type="text/javascript">
  function RunItem() {
    this.list = []; // å­˜æ”¾å›è°ƒå‡½æ•°
    this.start = () => {
      for (var i = 0; i < this.list.length; i++) {
        this.list[i].run();
      }
    };
    this.push = (fn, name, setRequestAnimationFrame = true) => {
      let myfn = fn
      if (setRequestAnimationFrame) {
        myfn = () => {
          utils.requestAnimationFrame(fn)
        }
      }
      var f = new Item(myfn, name);
      this.list.push(f);
    };
    this.remove = (name) => {
      for (let index = 0; index < this.list.length; index++) {
        const e = this.list[index];
        if (e.name == name) {
          this.list.splice(index, 1);
        }
      }
    }
    // æ„é€ ä¸€ä¸ªå¯ä»¥runçš„å¯¹è±¡
    function Item(fn, name) {
      // å‡½æ•°åç§°
      this.name = name || fn.name;
      // runæ–¹æ³•
      this.run = () => {
        try {
          fn()
        } catch (error) {
          console.log(error);
        }
      };
    }
  }

  const utils = {
    // æ‡’åŠ è½½ css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')) {
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // é»˜è®¤å¼‚æ­¥ï¼Œå¦‚æœéœ€è¦åŒæ­¥ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥ {} å³å¯
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function () {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },

    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      let retryTimes = 3;
      utils.onLoading(el);
      function req() {
        return new Promise((resolve, reject) => {
          let status = 0; // 0 ç­‰å¾… 1 å®Œæˆ 2 è¶…æ—¶
          let timer = setTimeout(() => {
            if (status === 0) {
              status = 2;
              timer = null;
              reject('è¯·æ±‚è¶…æ—¶');
              if (retryTimes == 0) {
                onFailure();
              }
            }
          }, 5000);
          fetch(url).then(function (response) {
            if (status !== 2) {
              clearTimeout(timer);
              resolve(response);
              timer = null;
              status = 1;
            }
            if (response.ok) {
              return response.json();
            }
            throw new Error('Network response was not ok.');
          }).then(function (data) {
            retryTimes = 0;
            utils.onLoadSuccess(el);
            callback(data);
          }).catch(function (error) {
            if (retryTimes > 0) {
              retryTimes -= 1;
              setTimeout(() => {
                req();
              }, 5000);
            } else {
              utils.onLoadFailure(el);
              onFailure();
            }
          });
        });
      }
      req();
    },
    /********************** requestAnimationFrame ********************************/
    // 1ã€requestAnimationFrame ä¼šæŠŠæ¯ä¸€å¸§ä¸­çš„æ‰€æœ‰ DOM æ“ä½œé›†ä¸­èµ·æ¥ï¼Œåœ¨ä¸€æ¬¡é‡ç»˜æˆ–å›æµä¸­å°±å®Œæˆï¼Œå¹¶ä¸”é‡ç»˜æˆ–å›æµçš„æ—¶é—´é—´éš”ç´§ç´§è·Ÿéšæµè§ˆå™¨çš„åˆ·æ–°é¢‘ç‡ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œè¿™ä¸ªé¢‘ç‡ä¸ºæ¯ç§’60å¸§ã€‚
    // 2ã€åœ¨éšè—æˆ–ä¸å¯è§çš„å…ƒç´ ä¸­ï¼ŒrequestAnimationFrame å°†ä¸ä¼šè¿›è¡Œé‡ç»˜æˆ–å›æµï¼Œè¿™å½“ç„¶å°±æ„å‘³ç€æ›´å°‘çš„çš„ cpuï¼Œgpu å’Œå†…å­˜ä½¿ç”¨é‡ã€‚
    requestAnimationFrame: (fn) => {
      if (!window.requestAnimationFrame) {
        window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame;
      }
      window.requestAnimationFrame(fn)
    },
    dark: {},
  };

  // utils.dark.mode å½“å‰æ¨¡å¼ dark or light
  // utils.dark.toggle() æš—é»‘æ¨¡å¼è§¦å‘å™¨
  // utils.dark.push(callBack[,"callBackName"]) ä¼ å…¥è§¦å‘å™¨å›è°ƒå‡½æ•°
  utils.dark.method = {
    toggle: new RunItem(),
  };
  utils.dark = Object.assign(utils.dark, {
    push: utils.dark.method.toggle.push,
  });
</script>
<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>
<script type="text/javascript">
  (() => {
    const tagSwitchers = document.querySelectorAll('.tag-subtree.parent-tag > a > .tag-switcher-wrapper')
    for (const tagSwitcher of tagSwitchers) {
      tagSwitcher.addEventListener('click', (e) => {
        const parent = e.target.closest('.tag-subtree.parent-tag')
        parent.classList.toggle('expanded')
        e.preventDefault()
      })
    }

    // Get active tag from query string, then activate it.
    const urlParams = new URLSearchParams(window.location.search)
    const activeTag = urlParams.get('tag')
    if (activeTag) {
      let tag = document.querySelector(`.tag-subtree[data-tag="${activeTag}"]`)
      if (tag) {
        tag.querySelector('a').classList.add('active')
        
        while (tag) {
          tag.classList.add('expanded')
          tag = tag.parentElement.closest('.tag-subtree.parent-tag')
        }
      }
    }
  })()
</script>


<!-- required -->
<script src="/js/main.js?v=1.29.1" defer></script>

<script type="text/javascript">
  const applyTheme = (theme) => {
    if (theme === 'auto') {
      document.documentElement.removeAttribute('data-theme')
    } else {
      document.documentElement.setAttribute('data-theme', theme)
    }

    applyThemeToGiscus(theme)
  }

  const applyThemeToGiscus = (theme) => {
    theme = theme === 'auto' ? 'preferred_color_scheme' : theme

    const cmt = document.getElementById('giscus')
    if (cmt) {
      // This works before giscus load.
      cmt.setAttribute('data-theme', theme)
    }

    const iframe = document.querySelector('#comments > section.giscus > iframe')
    if (iframe) {
      // This works after giscus loaded.
      const src = iframe.src
      const newSrc = src.replace(/theme=[\w]+/, `theme=${theme}`)
      iframe.src = newSrc
    }
  }

  const switchTheme = () => {
    // light -> dark -> auto -> light -> ...
    const currentTheme = document.documentElement.getAttribute('data-theme')
    let newTheme;
    switch (currentTheme) {
      case 'light':
        newTheme = 'dark'
        break
      case 'dark':
        newTheme = 'auto'
        break
      default:
        newTheme = 'light'
    }
    applyTheme(newTheme)
    window.localStorage.setItem('Stellar.theme', newTheme)
    utils.dark.mode = newTheme === 'auto' ? (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light") : newTheme;
    utils.dark.method.toggle.start();

    const messages = {
      light: `åˆ‡æ¢åˆ°æµ…è‰²æ¨¡å¼`,
      dark: `åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼`,
      auto: `åˆ‡æ¢åˆ°è·Ÿéšç³»ç»Ÿé…è‰²`,
    }
    hud?.toast?.(messages[newTheme])
  }

  (() => {
    // Apply user's preferred theme, if any.
    const theme = window.localStorage.getItem('Stellar.theme')
    if (theme !== null) {
      applyTheme(theme)
    } else {
      utils.dark.mode = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
    }
    utils.dark.method.toggle.start();
  })()
</script>


<!-- optional -->

  <script type="module">
  const el = document.querySelector('#comments #giscus');
  util.viewportLazyload(el, load_discus, false);

  function load_discus() {
    if (!el) return;
    try {
        el.innerHTML = '';
      } catch (error) {
        console.error(error);
      }
      const script = document.createElement('script');
      script.async = true;
      for (const key of Object.keys(el.attributes)) {
        const attr = el.attributes[key];
        if (['class', 'id'].includes(attr.name) === false) {
          script.setAttribute(attr.name, attr.value);
        }
      }
      el.appendChild(script);
  }
</script>




<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":"https://site-info-api-hedon.vercel.app/api/v1?url={href}"},"ghinfo":{"js":"/js/services/ghinfo.js"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"},"voice":{"js":"/js/plugins/voice.js"},"video":{"js":"/js/plugins/video.js"},"download-file":{"js":"/js/plugins/download-file.js"},"twikoo":{"js":"/js/services/twikoo_latest_comment.js"},"waline":{"js":"/js/services/waline_latest_comment.js"},"artalk":{"js":"/js/services/artalk_latest_comment.js"},"giscus":{"js":"/js/services/giscus_latest_comment.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else if (id == 'voice') {
        ctx.voiceAudios = document.querySelectorAll('.voice>audio');
        if (ctx.voiceAudios?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            createVoiceDom(ctx.voiceAudios);
          });
        }
      } else if (id == 'video') {
        ctx.videos = document.querySelectorAll('.video>video');
        if (ctx.videos?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            videoEvents(ctx.videos);
          });
        }
      } else if (id == 'download-file') {
        ctx.files = document.querySelectorAll('.file');
        if (ctx.files?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            downloadFileEvent(ctx.files);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }

    // chat iphone time
    let phoneTimes = document.querySelectorAll('.chat .status-bar .time');

    if (phoneTimes.length > 0) {
      NowTime();
      var date = new Date();
      var sec = date.getSeconds();
      var firstAdjustInterval = setInterval(firstAdjustTime, 1000 * (60 - sec));
    }

    function firstAdjustTime() {
      NowTime();
      clearInterval(firstAdjustInterval);
      setInterval(NowTime, 1000 * 60);
    }

    function NowTime() {
      for (let i = 0; i < phoneTimes.length; ++i) {
        var timeSpan = phoneTimes[i];
        var date = new Date();
        var hour = date.getHours();
        var min = date.getMinutes();
        timeSpan.innerHTML = check(hour) + ":" + check(min);
      }
    };

    function check(val) {
      if (val < 10) {
        return ("0" + val);
      }
      return (val);
    }

    // chat quote
    const chat_quote_obverser = new IntersectionObserver((entries, observer) => {
      entries.filter((entry) => { return entry.isIntersecting }).sort((a, b) => a.intersectionRect.y !== b.intersectionRect.y ? a.intersectionRect.y - b.intersectionRect.y : a.intersectionRect.x - b.intersectionRect.x).forEach((entry, index) => {
          observer.unobserve(entry.target);
          setTimeout(() => {
            entry.target.classList.add('quote-blink');
            setTimeout(() => {
              entry.target.classList.remove('quote-blink');
            }, 1000);
          }, Math.max(100, 16) * (index + 1));
        });
    });

    var chatQuotes = document.querySelectorAll(".chat .talk .quote");
    chatQuotes.forEach((quote) => {
      quote.addEventListener('click', function () {
        var chatCellDom = document.getElementById("quote-" + quote.getAttribute("quotedCellTag"));
        if (chatCellDom) {
          var chatDiv = chatCellDom.parentElement;
          var mid = chatDiv.clientHeight / 2;
          var offsetTop = chatCellDom.offsetTop;
          if (offsetTop > mid - chatCellDom.clientHeight / 2) {
            chatDiv.scrollTo({
              top: chatCellDom.offsetTop - mid + chatCellDom.clientHeight / 2,
              behavior: "smooth"
            });
          } else {
            chatDiv.scrollTo({
              top: 0,
              behavior: "smooth"
            });
          }
          chat_quote_obverser.observe(chatCellDom);
        }
      });
    });
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://cdn.jsdelivr.net/npm/flying-pages@2/flying-pages.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@19.1.3/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });
</script><script>
  ctx.fancybox = {
    selector: `.timenode p>img, .md-text img:not([class]), .md-text .image img`,
    css: `https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css`,
    js: `https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js`
  };
  var selector = '[data-fancybox]:not(.error)';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const els = document.getElementsByClassName('ds-memos');
    if (els != undefined && els.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"] ],
    processEscapes: true
  }
});
MathJax.Hub.Config({
  tex2jax: {
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  }
});
MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for(i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script>
<script defer type="text/javascript" src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    var mermaid_config = {
      startOnLoad: true,
      theme:
        "" == "auto" &&
          window.matchMedia("(prefers-color-scheme: dark)").matches
          ? "dark"
          : "neutral",
      logLevel: 3,
      themeVariables: {
        darkMode: true
      },
      flowchart: {
        useMaxWidth: false,
        htmlLabels: true,
        curve: "linear"
      },
      gantt: {
        axisFormat: "%Y/%m/%d"
      },
      sequence: {
        actorMargin: 50
      }
    }
    mermaid.initialize(mermaid_config);
  });
</script><script>
  document.addEventListener('DOMContentLoaded', function () {
    window.codeElements = document.querySelectorAll('.code');
    if (window.codeElements.length > 0) {
      ctx.copycode = {
        default_text: `Copy`,
        success_text: `Copied`,
        toast: `å¤åˆ¶æˆåŠŸ`,
      };
      utils.js('/js/plugins/copycode.js');
    }
  });
</script>


<!-- inject -->

</div></body></html>
