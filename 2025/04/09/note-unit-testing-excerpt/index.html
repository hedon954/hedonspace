
<!DOCTYPE html><html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.29.1" theme-name="Stellar" theme-version="1.29.1">
  
  <meta name="generator" content="Hexo 6.3.0">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  <link rel="preconnect" href="https://gcore.jsdelivr.net" crossorigin><link rel="preconnect" href="https://unpkg.com" crossorigin><link rel="preconnect" href="https://cdn.bootcdn.net" crossorigin>
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  <meta name="theme-color" content="#f9fafb">
  
  <title>ä¹¦ç±æ‘˜æŠ„ä¸¨ã€ŠUnit Testing Principles, Practices, and Patternsã€‹ - HedonWang</title>

  
    <meta name="description" content="æœ¬æ–‡å¯¹ã€ŠUnit Testingã€‹çš„å…³é”®è§‚ç‚¹è¿›è¡Œäº†æ¢³ç†æ€»ç»“ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="ä¹¦ç±æ‘˜æŠ„ä¸¨ã€ŠUnit Testing Principles, Practices, and Patternsã€‹">
<meta property="og:url" content="https://hedon.top/2025/04/09/note-unit-testing-excerpt/index.html">
<meta property="og:site_name" content="HedonWang">
<meta property="og:description" content="æœ¬æ–‡å¯¹ã€ŠUnit Testingã€‹çš„å…³é”®è§‚ç‚¹è¿›è¡Œäº†æ¢³ç†æ€»ç»“ã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://bu.dusays.com/2022/10/24/63567d3e092ff.png">
<meta property="og:image" content="https://bu.dusays.com/2022/10/24/63567d3e0ab55.png">
<meta property="article:published_time" content="2025-04-09T04:52:14.000Z">
<meta property="article:modified_time" content="2025-06-08T18:35:10.816Z">
<meta property="article:author" content="Hedon Wang">
<meta property="article:tag" content="å•å…ƒæµ‹è¯•">
<meta property="article:tag" content="ä¹¦ç±æ‘˜æŠ„">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://bu.dusays.com/2022/10/24/63567d3e092ff.png">
  
  
  
  <meta name="keywords" content="å•å…ƒæµ‹è¯•,ä¹¦ç±æ‘˜æŠ„">

  <!-- feed -->
  
    <link rel="alternate" href="/atom.xml" title="HedonWang" type="application/atom+xml">
  

  <link rel="stylesheet" href="/css/main.css?v=1.29.1">


  
    <link rel="shortcut icon" href="/assets/favicon.png">
  

  

  <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon.png"><link rel="shortcut icon" href="/assets/favicon.png"><meta name="theme-color" content="#f8f8f8"><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC&display=swap" rel="stylesheet"><link rel="stylesheet" href="/css/markmap.css"><script src="https://cdn.jsdelivr.net/npm/markmap-autoloader@0.18"></script>
</head>
<body>

<div class="l_body s:aa content tech" id="start" layout="post" ><aside class="l_left"><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><div class="icon"><img no-lazy class="icon" src="/assets/favicon.png" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></div><a class="title" href="/"><div class="main" ff="title">HedonWang</div><div class="sub cap">å›å­æ±‚è¯¸å·±ï¼Œå¾‹å·±åˆ™å®‰ã€‚</div></a></div></header>

<div class="nav-area">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" placeholder="ç«™å†…æœç´¢"></form><div id="search-result"></div><div class="search-no-result">æ²¡æœ‰æ‰¾åˆ°å†…å®¹ï¼</div></div>


<nav class="menu dis-select"><a class="nav-item active" title="åšå®¢" href="/" style="color:#1BCDFC"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M5.879 2.879C5 3.757 5 5.172 5 8v8c0 2.828 0 4.243.879 5.121C6.757 22 8.172 22 11 22h2c2.828 0 4.243 0 5.121-.879C19 20.243 19 18.828 19 16V8c0-2.828 0-4.243-.879-5.121C17.243 2 15.828 2 13 2h-2c-2.828 0-4.243 0-5.121.879M8.25 17a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75M9 12.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5zM8.25 9A.75.75 0 0 1 9 8.25h6a.75.75 0 0 1 0 1.5H9A.75.75 0 0 1 8.25 9" clip-rule="evenodd"/><path fill="currentColor" d="M5.235 4.058C5 4.941 5 6.177 5 8v8c0 1.823 0 3.058.235 3.942L5 19.924c-.975-.096-1.631-.313-2.121-.803C2 18.243 2 16.828 2 14v-4c0-2.829 0-4.243.879-5.121c.49-.49 1.146-.707 2.121-.803zm13.53 15.884C19 19.058 19 17.822 19 16V8c0-1.823 0-3.059-.235-3.942l.235.018c.975.096 1.631.313 2.121.803C22 5.757 22 7.17 22 9.999v4c0 2.83 0 4.243-.879 5.122c-.49.49-1.146.707-2.121.803z" opacity=".5"/></svg></a><a class="nav-item" title="ä¸“æ " href="/topic/" style="color:#3DC550"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M14.25 4.48v3.057c0 .111 0 .27.02.406a.936.936 0 0 0 .445.683a.96.96 0 0 0 .783.072c.13-.04.272-.108.378-.159L17 8.005l1.124.534c.106.05.248.119.378.16a.958.958 0 0 0 .783-.073a.936.936 0 0 0 .444-.683c.021-.136.021-.295.021-.406V3.031c.113-.005.224-.01.332-.013C21.154 2.98 22 3.86 22 4.933v11.21c0 1.112-.906 2.01-2.015 2.08c-.97.06-2.108.179-2.985.41c-1.082.286-1.99 1.068-3.373 1.436c-.626.167-1.324.257-1.627.323V5.174c.32-.079 1.382-.203 1.674-.371c.184-.107.377-.216.576-.323m5.478 8.338a.75.75 0 0 1-.546.91l-4 1a.75.75 0 0 1-.364-1.456l4-1a.75.75 0 0 1 .91.546" clip-rule="evenodd"/><path fill="currentColor" d="M18.25 3.151c-.62.073-1.23.18-1.75.336a8.2 8.2 0 0 0-.75.27v3.182l.75-.356l.008-.005a1.13 1.13 0 0 1 .492-.13c.047 0 .094.004.138.01c.175.029.315.1.354.12l.009.005l.749.356V3.647z"/><path fill="currentColor" d="M12 5.214c-.334-.064-1.057-.161-1.718-.339C8.938 4.515 8.05 3.765 7 3.487c-.887-.234-2.041-.352-3.018-.412C2.886 3.007 2 3.9 2 4.998v11.146c0 1.11.906 2.01 2.015 2.079c.97.06 2.108.179 2.985.41c.486.129 1.216.431 1.873.726c1.005.451 2.052.797 3.127 1.034z" opacity=".5"/><path fill="currentColor" d="M4.273 12.818a.75.75 0 0 1 .91-.545l4 1a.75.75 0 1 1-.365 1.455l-4-1a.75.75 0 0 1-.545-.91m.909-4.545a.75.75 0 1 0-.364 1.455l4 1a.75.75 0 0 0 .364-1.455z"/></svg></a><a class="nav-item" title="å…³äºæˆ‘" href="/about/" style="color:#F44336"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="m13.629 20.472l-.542.916c-.483.816-1.69.816-2.174 0l-.542-.916c-.42-.71-.63-1.066-.968-1.262c-.338-.197-.763-.204-1.613-.219c-1.256-.021-2.043-.098-2.703-.372a5 5 0 0 1-2.706-2.706C2 14.995 2 13.83 2 11.5v-1c0-3.273 0-4.91.737-6.112a5 5 0 0 1 1.65-1.651C5.59 2 7.228 2 10.5 2h3c3.273 0 4.91 0 6.113.737a5 5 0 0 1 1.65 1.65C22 5.59 22 7.228 22 10.5v1c0 2.33 0 3.495-.38 4.413a5 5 0 0 1-2.707 2.706c-.66.274-1.447.35-2.703.372c-.85.015-1.275.022-1.613.219c-.338.196-.548.551-.968 1.262" opacity=".5"/><path fill="currentColor" d="M10.99 14.308c-1.327-.978-3.49-2.84-3.49-4.593c0-2.677 2.475-3.677 4.5-1.609c2.025-2.068 4.5-1.068 4.5 1.609c0 1.752-2.163 3.615-3.49 4.593c-.454.335-.681.502-1.01.502c-.329 0-.556-.167-1.01-.502"/></svg></a><a class="nav-item" title="æ€ç»´å¯¼å›¾" href="/html/mindmap.html" style="color:#F44336"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="m13.629 20.472l-.542.916c-.483.816-1.69.816-2.174 0l-.542-.916c-.42-.71-.63-1.066-.968-1.262c-.338-.197-.763-.204-1.613-.219c-1.256-.021-2.043-.098-2.703-.372a5 5 0 0 1-2.706-2.706C2 14.995 2 13.83 2 11.5v-1c0-3.273 0-4.91.737-6.112a5 5 0 0 1 1.65-1.651C5.59 2 7.228 2 10.5 2h3c3.273 0 4.91 0 6.113.737a5 5 0 0 1 1.65 1.65C22 5.59 22 7.228 22 10.5v1c0 2.33 0 3.495-.38 4.413a5 5 0 0 1-2.707 2.706c-.66.274-1.447.35-2.703.372c-.85.015-1.275.022-1.613.219c-.338.196-.548.551-.968 1.262" opacity=".5"/><path fill="currentColor" d="M10.99 14.308c-1.327-.978-3.49-2.84-3.49-4.593c0-2.677 2.475-3.677 4.5-1.609c2.025-2.068 4.5-1.068 4.5 1.609c0 1.752-2.163 3.615-3.49 4.593c-.454.335-.681.502-1.01.502c-.329 0-.556-.167-1.01-.502"/></svg></a></nav>
</div>
<div class="widgets">


<widget class="widget-wrapper post-list"><div class="widget-header dis-select"><span class="name">æœ€è¿‘æ›´æ–°</span></div><div class="widget-body fs14"><a class="item title" href="/2025/07/27/back-propagation/"><span class="title">å¤§ç™½è¯è§£é‡Šåå‘ä¼ æ’­ç®—æ³•</span></a><a class="item title" href="/2025/06/08/rust-os-primitives/"><span class="title">Rust åŸç†ä¸¨æ“ä½œç³»ç»Ÿå¹¶å‘åŸè¯­</span></a><a class="item title" href="/2024/03/02/rust-crate-reqwest/"><span class="title">Rust reqwest ç®€æ˜æ•™ç¨‹</span></a><a class="item title" href="/2024/03/02/rust-crate-clap/"><span class="title">æ·±å…¥æ¢ç´¢ Rust çš„ clap åº“ï¼šå‘½ä»¤è¡Œè§£æçš„è‰ºæœ¯</span></a><a class="item title" href="/2024/11/11/rust-memory-order/"><span class="title">Rust åŸç†ä¸¨èŠä¸€èŠ Rust çš„ Atomic å’Œå†…å­˜é¡ºåº</span></a><a class="item title" href="/2024/06/06/rust-action-sse/"><span class="title">Rust å®æˆ˜ä¸¨SSE(Server-Sent Events)</span></a><a class="item title" href="/2024/03/05/rust-crate-anyhow/"><span class="title">Rust anyhow ç®€æ˜æ•™ç¨‹</span></a><a class="item title" href="/2025/06/05/rust-atomic-in-processor/"><span class="title">Rust åŸç†ä¸¨ä»æ±‡ç¼–è§’åº¦çœ‹åŸå­æ“ä½œ</span></a><a class="item title" href="/2024/05/11/rust-crate-chrono/"><span class="title">æ—¶é—´å¤„ç†åŸºç¡€ï¼šRust çš„ chrono åº“æ•™ç¨‹</span></a><a class="item title" href="/2025/06/09/rust-action-mutex/"><span class="title">Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª Mutex</span></a></div></widget>
</div>

</div></aside><div class="l_main" id="main">





<div class="article banner top"><img class="bg lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/banner/note-unit-testing.jpg">
  <div class="content">
    <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">ä¸»é¡µ</a>
<span class="sep"></span><a class="cap breadcrumb" href="/">æ–‡ç« </a><span class="sep"></span><a class="cap breadcrumb-link" href="/categories/%E4%B9%A6%E7%B1%8D%E6%91%98%E6%8A%84/">ä¹¦ç±æ‘˜æŠ„</a> <span class="sep"></span> <a class="cap breadcrumb-link" href="/categories/%E4%B9%A6%E7%B1%8D%E6%91%98%E6%8A%84/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/">å•å…ƒæµ‹è¯•</a></div>
<div class="flex-row" id="post-meta"><span class="text created">å‘å¸ƒäºï¼š<time datetime="2025-04-09T04:52:14.000Z">2025-04-09</time></span><span class="sep updated"></span><span class="text updated">æ›´æ–°äºï¼š<time datetime="2025-06-08T18:35:10.816Z">2025-06-09</time></span></div></div></div>
    
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>ä¹¦ç±æ‘˜æŠ„ä¸¨ã€ŠUnit Testing Principles, Practices, and Patternsã€‹</span></h1>
        
      </div>
    </div>
    
  </div>
  </div><article class="md-text content"><p>Learning unit testing doesnâ€™t stop at mastering the technical bits of
it, such as your favorite test framework, mocking library, and so on.
Thereâ€™s much more to unit testing than the act of writing tests. You
always have to achieve the best return on the time you invest in unit
testing, minimizing the effort you put into tests and maximizing the
benefits they provide. Achieving both things isnâ€™t an easy task.</p>
<ul>
<li>They grow effortlessly, donâ€™t require much maintenance, and can
quickly adapt to their customersâ€™ ever-changing needs.</li>
</ul>
<p>The ratio between the production code and the test code could be
anywhere between <code>1:1</code> and <code>1:3</code>.</p>
<h1 id="coverage-limitations">Coverage limitations</h1>
<ul>
<li>You canâ€™t guarantee that the test verifies all the possible outcomes
of the system under test.</li>
<li>No coverage metric can take into account code paths in external
libraries.</li>
</ul>
<h1 id="the-goal-of-unit-testing">The goal of unit testing</h1>
<ol type="1">
<li>lead to a better code design</li>
<li>enable sustainable(å¯æŒç»­çš„) growth of the software project</li>
</ol>
<p><img
src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image.png" /></p>
<p>the cost components of writing unit tests:</p>
<ol type="1">
<li>refactoring the test when you refactor the underlying code</li>
<li>running the test on each code change</li>
<li>dealing with false alarms raised by the test</li>
<li>spending time reading the test when youâ€™re trying to understanding
how the underlying code behaves</li>
</ol>
<p>a successful test suite must:</p>
<ol type="1">
<li>integrated into the development cycle</li>
<li>targets only the most important parts of the code base
<ol type="1">
<li>ğŸ‘‰ğŸ»Â domain logic</li>
<li>infrastructure code</li>
<li>external services and dependencies</li>
<li>code that glues everything together</li>
</ol></li>
<li>provides maximum value with minimum maintenance costs
<ol type="1">
<li>recognize a valuable test (and, by extension, a test of low
value)</li>
<li>write a valuable test</li>
</ol></li>
</ol>
<h1 id="what-is-a-unit-test">What is a unit test?</h1>
<p><img
src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%201.png" /></p>
<ol type="1">
<li>verifies a single unit of behavior</li>
<li>dose it quickly</li>
<li>dost it in isolation from other tests</li>
</ol>
<p>An integration test, then, is a test that doesnâ€™t meet one of these
criteria.</p>
<p>End-to-end tests are a subset of integration tests.</p>
<p><img
src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%202.png" /></p>
<h1 id="how-to-structure-a-unit-test">How to structure a unit test?</h1>
<table>
<thead>
<tr>
<th>Type</th>
<th>Components</th>
</tr>
</thead>
<tbody>
<tr>
<td>AAA</td>
<td>Arrange - Act - Assert</td>
</tr>
<tr>
<td>GWT</td>
<td>Given - When - Then</td>
</tr>
</tbody>
</table>
<ol type="1">
<li>avoid multiple arrange, act, and assert sections.</li>
<li>avoid if statements in tests.</li>
<li>name the test as if you were describing the scenario to a
non-programmer who is familiar with the problem domain.</li>
<li>separate words with underscores.</li>
<li>structure a test is to make it tell a story about the problem
domain</li>
</ol>
<h1 id="four-pillars-of-a-good-unit-test">Four pillars of a good unit
test</h1>
<blockquote>
<p><em>code is not an asset, itâ€™s a liability.</em></p>
</blockquote>
<ol type="1">
<li><p><strong>protection against regressions</strong></p>
<ol type="1">
<li>the amount of code that is executed during the test</li>
<li>the complexity of that code</li>
<li>the codeâ€™s domain significance</li>
</ol></li>
<li><p><strong>resistance to refactoring</strong></p>
<ol type="1">
<li>the fewer false positives the test generates, the better</li>
<li>tests provides an early warning when you break exisiting
functionality</li>
<li>you become confident that your code changes wonâ€™t lead to
regressions</li>
<li>the more the test is coupled to the implementation details of the
system under set(SUT), the more false alarms it generates</li>
<li>you need to make sure the test verifies the end result the SUT
delivers: its observable behavior, not the steps it takes to do
that.</li>
<li>the best way to structure a test is to make it tell a story about
the problem domain</li>
</ol>
<p><img
src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%203.png" /></p></li>
<li><p><strong>fast feedback</strong></p></li>
<li><p><strong>maintainability</strong></p>
<ol type="1">
<li>how hard it is to understand the test, which is a function of the
testâ€™s size</li>
<li>how hard it is to run the test, which is a function of how many
out-of-process dependencies the test works with directly</li>
</ol></li>
</ol>
<h2 id="the-intrinsic-connection-between-the-first-two-attributes">The
intrinsic connection between the first two attributes</h2>
<p><img
src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%204.png" /></p>
<p>Type II Error:</p>
<ul>
<li>if functionality is broken, the test should fail, but if the test
also passed, means it is not a good unit test, should if it fails, means
it offers protection against regressions.</li>
</ul>
<p>Type I Error:</p>
<ul>
<li>if functionality is correct but the test fails, means that the test
dose not test the nature of behavior. The good unit test should always
pass when the functionality is correct. This would help us a lot when we
try to do refactor. If we refactor the code correctly, but the unit
tests always failed, means that the unit tests are not good enough, we
need to optimize them.</li>
</ul>
<h1 id="an-ideal-test">An ideal test</h1>
<ul>
<li>value = <code>[0..1] * [0..1] * [0..1] * [0..1]</code>(corresponding
to the four pillars)</li>
</ul>
<p><img
src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%205.png" /></p>
<p><img
src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%206.png" /></p>
<p><img
src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%207.png" /></p>
<h2 id="black-box-and-white-box-testing">black-box and white-box
testing</h2>
<ol type="1">
<li>choose black-box testing over white-box testing by default.</li>
<li>the only exception is when the test covers utility code with high
algorithmic complexity</li>
<li>use code coverage tools to see which code branches are not
exercised, but then turn around and test them as if you know nothing
about the codeâ€™s internal structure.</li>
</ol>
<h1 id="mock">Mock</h1>
<h2 id="types-of-test-doubles">types of test doubles</h2>
<ul>
<li>mock: help to emulate and examine <code>outcoming</code>
interactions â€”â€” change state
<ul>
<li>mock: generated by tools</li>
<li>spy: written manually</li>
</ul></li>
<li>stub: help to emulate <code>incoming</code> interactions â€”â€” get
input data
<ul>
<li>stub: can configure to return different values for different
scenarios.</li>
<li>dummy: a simple, hardcoded value such as a null value or a made-up
string.</li>
<li>fake: the same as a stub for most purposes, only except for its
creation, it is usually implemented to replace a dependency that dose
not yet exist</li>
</ul></li>
</ul>
<p><img
src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%208.png" /></p>
<p><img
src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%209.png" /></p>
<blockquote>
<p>never asserting interactions with stubs.</p>
</blockquote>
<h2 id="observable-behavior">Observable behavior</h2>
<ol type="1">
<li>expose an <code>operation</code> that helps the client achieve one
of its goals. An operation is a method that performs a calculation or
incurs a side effect or both.</li>
<li>expose a <code>state</code> that helps the client achieve one of its
goals. State is the current condition of the system.</li>
</ol>
<blockquote>
<p>Whether the code is observable behavior depends on who its client is
and what the goals of that client are.</p>
</blockquote>
<blockquote>
<p>Ideally, the systemâ€™s public API surface should coincide with its
observable behavior, and all its implementation details should be hidden
from the eyes of the clients.</p>
</blockquote>
<p><img
src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2010.png" /></p>
<h2 id="mocks-and-test-fragility">Mocks and test fragility</h2>
<ul>
<li><code>Intra-system</code> communications are communications between
classes inside your application.</li>
<li><code>Inter-system</code> communications are when your application
talks to other applications.</li>
</ul>
<p><img
src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2011.png" /></p>
<ol type="1">
<li>The use of mocks is <code>beneficial</code> when verifying the
communication pattern between your system and external
applications.</li>
<li>Using mocks to verify communications between classes inside your
system results in tests that couple to implementation details and
therefore fall short of the <code>resistance-to-refactoring</code>
metric.</li>
</ol>
<p><img
src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2012.png" /></p>
<h2 id="types-of-dependencies">Types of dependencies</h2>
<ul>
<li><code>shared dependency</code>: a dependency shared by test (not
production code)</li>
<li><code>out-of-process dependency</code>: a dependency hosted by a
process other than the programâ€™s execution process (database, stmp
server)</li>
<li><code>private dependency</code>: any dependency that is not
shared</li>
</ul>
<p><img
src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2013.png" /></p>
<h1 id="styles-of-unit-testing">Styles of unit testing</h1>
<ul>
<li><code>output-based</code>: only need to verify the output.</li>
<li><code>state-based</code>: the underlying code changes its own state,
the state of its collaborators, or the state of an out-of-process
dependency.</li>
<li><code>communication-based</code>: use mocks to verify communications
between the SUT and its collaborators, to verify the communication
situations.</li>
</ul>
<h2 id="compare">compare</h2>
<h3 id="protection-against-regressions">protection against
regressions</h3>
<ul>
<li>for the most part, they are not very different</li>
<li>but overusing the <code>communication-based</code> style can result
in shallow tests that verify only a thin slice of code and mock out
everything else.</li>
</ul>
<h3 id="fast-feedback">fast feedback</h3>
<ul>
<li>for the most part, they are not very different</li>
<li><code>communication-based</code> testing can be slightly worse
because the cost of mocks.</li>
</ul>
<h3 id="resistance-to-refactoring">resistance to refactoring</h3>
<ul>
<li><code>state-based</code> is the best one.</li>
<li><code>communication-based</code> is the worse one, because it is the
most vulnerable to false alarms.</li>
</ul>
<h3 id="maintainability">maintainability</h3>
<ul>
<li><code>output-based</code> is the best one, because they do not deal
with out-of-process dependencies.</li>
<li><code>state-based</code> is less maintainable because state
verification takes up more space than output verification.</li>
<li><code>communication-based</code> is the worst one, it requires
setting up test doubles and interaction assertions, and that takes up a
lot of space.</li>
</ul>
<h2 id="functional-architecture">functional architecture</h2>
<p><code>*Functional architecture</code>* maximizes the amount of code
written in a purely functional (immutable) way, while minimizing code
that deals with side effects. <em>Immutable</em> means unchangeable:
once an object is created, its state canâ€™t be modified. This is in
contrast to a *mutable* object (changeable object), which can be
modified after it is created.</p>
<p>Separate two kinds of code:</p>
<ul>
<li>code that make a decision</li>
<li>code that acts upon that decision</li>
</ul>
<p><img
src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2014.png" /></p>
<h2 id="tips">Tips</h2>
<ul>
<li>Moving from using an out-of-process dependency to using mocks.</li>
<li>Moving from using mocks to using functional architecture</li>
</ul>
<h1 id="four-kinds-of-code">Four kinds of code</h1>
<ul>
<li>Domain model and algorithms</li>
<li>Trivial code</li>
<li>Controllers</li>
<li>Overcomplicated code</li>
</ul>
<h2 id="tips-1">Tips</h2>
<ol type="1">
<li>always write completed unit tests for
<code>domain model the algorithms</code> code</li>
<li>never test <code>trivial code</code></li>
<li>write integration test for <code>controllers</code></li>
<li>do not write overcomplicated code, try to separate it into
<code>domain model and algorithms</code> and
<code>controllers</code></li>
</ol>
<p><img
src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2015.png" /></p>
<h2 id="trade-off">Trade-off</h2>
<ul>
<li>domain model testability</li>
<li>controller simplicity</li>
<li>performance</li>
</ul>
<p><img
src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2016.png" /></p>
<ol type="1">
<li>push all external reads and writes to the edges anyway</li>
<li>inject the out-of-process dependencies into the domain model</li>
<li><strong>split the decision-making process into more granular
steps</strong> ğŸ‘ˆ
<ol type="1">
<li><code>CanExecute/Execute</code> pattern</li>
<li>domain events</li>
</ol></li>
</ol>
<h2 id="canexecuteexecute-pattern">CanExecute/Execute pattern</h2>
<p>You can use <code>CanExecute/Execute</code> pattern to balance the
<code>performance</code> and <code>testability</code> , but concedes
controller simplicity, but it is manageable in most cases.</p>
<p><img
src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2017.png" /></p>
<h2 id="domain-events">Domain events</h2>
<p>Domain events help track important changes in the domain model, and
then convert those changes to calls to out-of-process dependencies. This
pattern removes the tracking responsibility from the controller.</p>
<ul>
<li>extract a <code>DomainEvent</code> base class and introduce a base
class for all domain classes, which would contain a collection of such
events: <code>List&lt;DomainEvent&gt; events</code></li>
</ul>
<h1 id="integration-tests">Integration tests</h1>
<p><img
src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2018.png" /></p>
<ol type="1">
<li>check as many of the business scenarioâ€™s edge cases as possible with
unit tests</li>
<li>use integration tests to cover one happy path, as well as any edge
cases that canâ€™t be covered by unit tests</li>
<li>if thereâ€™s no one path that goes through all happy paths, write
additional integration testsâ€”as many as needed to capture communications
with <strong>every</strong> external system</li>
<li>attempt to apply the <code>fail-fast principle</code> as a viable
alternative to integration test.</li>
</ol>
<h2 id="two-types-of-out-of-process-dependencies">two types of
out-of-process dependencies</h2>
<ul>
<li><code>managed dependencies</code>: only accessible through your
application. it is implement details and should not be mock.</li>
<li><code>unmanaged dependencies</code>: you donâ€™t have full control
over it. It is observable behavior and you should mock it.</li>
</ul>
<p><img
src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2019.png" /></p>
<h2 id="interface-misunderstand">interface misunderstand</h2>
<div class="tag-plugin quot"><p class="content" type="icon"><img class="icon prefix lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://bu.dusays.com/2022/10/24/63567d3e092ff.png" /><span class="text">ğŸ™‹ğŸ»â€â™€ï¸ Genuine abstractions are discovered, not invented.</span><img class="icon prefix lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://bu.dusays.com/2022/10/24/63567d3e0ab55.png" /></p></div>
<p>ğŸ‘‰ğŸ»Â For an interface to be a genuine abstraction, it must have at
lease two implemtations.</p>
<p>The common reasoning behind the use of interfaces is that they help
to:</p>
<ol type="1">
<li>Abstract out-of-process dependencies, thus achieving loose
coupling.</li>
<li>Add new functionality without changing the existing code, thus
adhering to the <code>Open-Closed principle</code></li>
</ol>
<p>Misconceptions:</p>
<ol type="1">
<li>Interfaces with a single implementation are not abstractions and
donâ€™t provide loose coupling any more than concrete classes that
implement those interfaces.</li>
<li>The second reason violates a more foundational principle:
<code>YAGNI (You are not gonna need it)</code>.</li>
<li>The only reason to use interfaces for out-of-process dependencies it
is to <code>enable testing</code>!</li>
<li>Do not introduce interfaces for out-of-process dependencies unless
you need to mock out those dependencies.</li>
</ol>
<h2 id="integration-test-best-practices">integration test best
practices</h2>
<ol type="1">
<li>making domain model boundaries explicit</li>
<li>reducing the number of layers in the application</li>
<li>eliminating circular dependencies</li>
</ol>
<p><img
src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2020.png" /></p>
<h2 id="maximozing-mocks-value">maximozing mockâ€™s value</h2>
<ol type="1">
<li><p>when mocking, always try to <strong>verify interactions with
unmanaged dependencies at the very edges of your system</strong>.</p>
<blockquote>
<p>Mocking <code>IBus</code> instead of <code>IMessageBus</code>
maximizes the mockâ€™s protection against regressions.</p>
</blockquote>
<p><img
src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2021.png" /></p></li>
<li><p>A call to an unmanaged dependency goes through several stages
before it leaves your application. <strong>Pick the last such
stage</strong>. It is the best way to ensure backward compatibility with
external systems, which is the goal that mocks help you
achieve.</p></li>
<li><p>In some cases, you can use <code>spy</code> instead of
<code>mock</code> for more succinct and expressive.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Fact</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Changing_email_from_corporate_to_non_corporate</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> busSpy = <span class="keyword">new</span> BusSpy();</span><br><span class="line">    <span class="keyword">var</span> messageBus = <span class="keyword">new</span> MessageBus(busSpy);</span><br><span class="line">    <span class="keyword">var</span> loggerMock = <span class="keyword">new</span> Mock&lt;IDomainLogger&gt;();</span><br><span class="line">    <span class="keyword">var</span> sut = <span class="keyword">new</span> UserController(db, messageBus, loggerMock.Object);</span><br><span class="line">		<span class="comment">/* ... */</span></span><br><span class="line">    busSpy.ShouldSendNumberOfMessages(<span class="number">1</span>)</span><br><span class="line">        .WithEmailChangedMessage(user.UserId, <span class="string">&quot;new@gmail.com&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="mocking-best-practices">mocking best practices</h2>
<ol type="1">
<li>applying mocks to unmanaged dependencies only</li>
<li>verifying the interactions with those dependencies at the very edges
of your system</li>
<li>using mocks in integration tests only, not in unit test</li>
<li>always verifying the number of calls made to the mock</li>
<li>do not rely on production code when making assertions. Use a
separate set of literals and constants in tests.</li>
<li>mocking only types that you own
<ol type="1">
<li>always write your own adapters on top of third-party libraries and
mock those adapters instead of the underlying types.</li>
<li>only expose features you need from the library</li>
<li>do that using your projectâ€™s domain language</li>
<li>this guideline dose not apply to in-process dependencies. There is
no need to abstract in-memory or managed dependencies. Similarly,
thereâ€™s no need to abstract an ORM as long as itâ€™s used for accessing a
database that isnâ€™t visible to external applications.</li>
</ol></li>
</ol>
<h1 id="testing-the-database">Testing the database</h1>
<h2 id="prerequisites">prerequisites</h2>
<ol type="1">
<li><p>keeping the database in the source control system</p>
<ol type="1">
<li>database schemas</li>
<li>reference data</li>
</ol></li>
<li><p>using a separate database instance for every developer</p></li>
<li><p>applying the migration-based approach to database delivery</p>
<blockquote>
<p>applying every modification to the database schema (including
reference data) through migrations. Do not modify migrations once they
are committed to the source control. If a migration is incorrect, create
a new migration instead of fixing the old one. Make exceptions to this
rule only when the incorrect migration can lead to data loss.</p>
</blockquote></li>
</ol>
<h2 id="transaction">transaction</h2>
<p>split the <code>Database</code> class into <code>repositories</code>
and a <code>transaction</code>:</p>
<ul>
<li><code>repositories</code> are classes that enable access to and
modification of the data in the database.</li>
<li><code>transaction</code> is a class that either commits or rolls
back data updates in full. This will be a custom class relying on the
underlying databaseâ€™s transactions to provide atomicity of data
modification.</li>
</ul>
<p><img
src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2022.png" /></p>
<p><img
src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image%2023.png" /></p>
<h2 id="tips-2">tips</h2>
<ol type="1">
<li>use at least three transactions or units of work in an integrations
test: one per each arrange, act and assert section.</li>
<li>your tests should not depend on the state of the database. Your
tests should bring that state to the required condition on their
own.</li>
<li>create two collections for unit and integrations, and then disable
test parallelization in the collection with the integration test.</li>
<li>clean up data at the beginning of a test</li>
<li>write the SQL script manually. Itâ€™s simpler and gives you more
granular control over the deletion process.</li>
<li>the best way to shorten integration is by extracting technical,
non-business-related bits into private methods or helper classes.</li>
<li>only the most complex or important read operations should be test,
disregard the rest.</li>
<li>do not test repositories directly, only as part of the overarching
integration test suite.</li>
</ol>
<h1 id="unit-testing-anti-patterns">Unit testing anti-patterns</h1>
<blockquote>
<p>âš ï¸ Do not do the things like below!</p>
</blockquote>
<ol type="1">
<li><p>unit testing private methods</p>
<blockquote>
<p>Private methods are implementation details! Just test observable
behaviors!</p>
</blockquote>
<blockquote>
<p><strong>If the private method is too complex to be tested as part of
the public API that uses it, thatâ€™s an indication of a missing
abstraction. Extract this abstraction into a separate class instead of
making the private method public.</strong></p>
</blockquote></li>
<li><p>expose private state</p></li>
<li><p>leaking domain knowledges to tests</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CalculatorTests</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Fact</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Adding_two_numbers</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">int</span> value1 = <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">int</span> value2 = <span class="number">3</span>;</span><br><span class="line">        <span class="built_in">int</span> expected = value1 + value2;   <span class="comment">// &lt;-----The leakage</span></span><br><span class="line">        <span class="comment">// int expected = 4 // the better one</span></span><br><span class="line">        <span class="built_in">int</span> actual = Calculator.Add(value1, value2);</span><br><span class="line">        Assert.Equal(expected, actual);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>code pollution</p>
<blockquote>
<p>Code pollution is adding production code thatâ€™s only needed for
testing.</p>
</blockquote></li>
<li><p>mocking concrete classes</p></li>
<li><p>working with time</p></li>
</ol>

<div class="article-footer fs14">
    <section id="references">
      <div class="header"><span>å‚è€ƒèµ„æ–™</span></div>
      <div class="body">
        <ul>
        <li class="post-title">
          <p><a target="_blank" rel="noopener" href="https://www.manning.com/books/unit-testing">Unit Testing
Principles, Practices, and Patterns</a></p>

        </li>
        </ul>
      </div>
    </section>
    
    <section id="license">
      <div class="header"><span>è®¸å¯åè®®</span></div>
      <div class="body"><p>æœ¬æ–‡é‡‡ç”¨ <a
target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº«
4.0 å›½é™…</a> è®¸å¯åè®®ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>
</div>
    </section>
    
    <section id="share">
      <div class="header"><span>åˆ†äº«æ–‡ç« </span></div>
      <div class="body">
        <div class="link"><input class="copy-area" readonly="true" id="copy-link" value="https://hedon.top/2025/04/09/note-unit-testing-excerpt/" /></div>
        <div class="social-wrap dis-select"><a class="social share-item wechat" onclick="util.toggle(&quot;qrcode-wechat&quot;)"><img class="lazy"  src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/b32ef3da1162a.svg" /></a><a class="social share-item weibo" target="_blank" rel="external nofollow noopener noreferrer" href="https://service.weibo.com/share/share.php?url=https://hedon.top/2025/04/09/note-unit-testing-excerpt/&title=ä¹¦ç±æ‘˜æŠ„ä¸¨ã€ŠUnit Testing Principles, Practices, and Patternsã€‹ - HedonWang&pics=/banner/note-unit-testing.jpg&summary=æœ¬æ–‡å¯¹ã€ŠUnit Testingã€‹çš„å…³é”®è§‚ç‚¹è¿›è¡Œäº†æ¢³ç†æ€»ç»“ã€‚"><img class="lazy"  src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/80c07e4dbb303.svg" /></a><a class="social share-item email" href="mailto:?subject=ä¹¦ç±æ‘˜æŠ„ä¸¨ã€ŠUnit Testing Principles, Practices, and Patternsã€‹ - HedonWang&amp;body=https://hedon.top/2025/04/09/note-unit-testing-excerpt/"><img class="lazy"  src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/a1b00e20f425d.svg" /></a><a class="social share-item link" onclick="util.copy(&quot;copy-link&quot;, &quot;å¤åˆ¶æˆåŠŸ&quot;)"><img class="lazy"  src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/8411ed322ced6.svg" /></a></div>
        
        <div class="qrcode" id="qrcode-wechat" style="opacity:0;height:0">
          <img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=https://hedon.top/2025/04/09/note-unit-testing-excerpt/"/>
        </div>
        
      </div>
    </section>
    </div>
</article>
<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">è¾ƒæ–°æ–‡ç« </div><a href="/2025/04/09/note-unit-testing/">è¯»ä¹¦ç¬”è®°ä¸¨ã€ŠUnit Testing Principles, Practices, and Patternsã€‹</a></div><div class="item" id="next"><div class="note">è¾ƒæ—©æ–‡ç« </div><a href="/2025/04/08/mysql-ibd/">ä¸€æ­¥æ­¥æ¨å¯¼å‡º MySQL æ•°æ®çš„åº•å±‚å­˜å‚¨ç»“æ„</a></div></section></div>




  <div class="related-wrap md-text" id="comments">
    <section class='header cmt-title cap theme'>
      <p>å¿«æ¥å‚ä¸è®¨è®ºå§~</p>

    </section>
    <section class='body cmt-body giscus'>
      

<svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg>

<div id="giscus" src="https://giscus.app/client.js" data-repo="hedon954/hedonspace" data-repo-id="R_kgDOKt17sQ" data-category="Q&A" data-category-id="DIC_kwDOKt17sc4CbAt-" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous"></div>

    </section>
  </div>



<footer class="page-footer footnote"><hr><div class="text"><p>æœ¬ç«™ç”± <a href="/">Hedon Wang</a> ä½¿ç”¨ <a
target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.29.1">Stellar
1.29.1</a> ä¸»é¢˜åˆ›å»ºã€‚ æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a
target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA
4.0</a> è®¸å¯åè®®ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper toc" id="data-toc" collapse="false"><div class="widget-header dis-select"><span class="name">æœ¬æ–‡ç›®å½•</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#coverage-limitations"><span class="toc-text">Coverage limitations</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#the-goal-of-unit-testing"><span class="toc-text">The goal of unit testing</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#what-is-a-unit-test"><span class="toc-text">What is a unit test?</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#how-to-structure-a-unit-test"><span class="toc-text">How to structure a unit test?</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#four-pillars-of-a-good-unit-test"><span class="toc-text">Four pillars of a good unit
test</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#the-intrinsic-connection-between-the-first-two-attributes"><span class="toc-text">The
intrinsic connection between the first two attributes</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#an-ideal-test"><span class="toc-text">An ideal test</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#black-box-and-white-box-testing"><span class="toc-text">black-box and white-box
testing</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#mock"><span class="toc-text">Mock</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#types-of-test-doubles"><span class="toc-text">types of test doubles</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#observable-behavior"><span class="toc-text">Observable behavior</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mocks-and-test-fragility"><span class="toc-text">Mocks and test fragility</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#types-of-dependencies"><span class="toc-text">Types of dependencies</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#styles-of-unit-testing"><span class="toc-text">Styles of unit testing</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#compare"><span class="toc-text">compare</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#protection-against-regressions"><span class="toc-text">protection against
regressions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fast-feedback"><span class="toc-text">fast feedback</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#resistance-to-refactoring"><span class="toc-text">resistance to refactoring</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#maintainability"><span class="toc-text">maintainability</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#functional-architecture"><span class="toc-text">functional architecture</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tips"><span class="toc-text">Tips</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#four-kinds-of-code"><span class="toc-text">Four kinds of code</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#tips-1"><span class="toc-text">Tips</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#trade-off"><span class="toc-text">Trade-off</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#canexecuteexecute-pattern"><span class="toc-text">CanExecute&#x2F;Execute pattern</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#domain-events"><span class="toc-text">Domain events</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#integration-tests"><span class="toc-text">Integration tests</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#two-types-of-out-of-process-dependencies"><span class="toc-text">two types of
out-of-process dependencies</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#interface-misunderstand"><span class="toc-text">interface misunderstand</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#integration-test-best-practices"><span class="toc-text">integration test best
practices</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#maximozing-mocks-value"><span class="toc-text">maximozing mockâ€™s value</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mocking-best-practices"><span class="toc-text">mocking best practices</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#testing-the-database"><span class="toc-text">Testing the database</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#prerequisites"><span class="toc-text">prerequisites</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#transaction"><span class="toc-text">transaction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tips-2"><span class="toc-text">tips</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#unit-testing-anti-patterns"><span class="toc-text">Unit testing anti-patterns</span></a></li></ol></div><div class="widget-footer">

<a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 12c0-4.714 0-7.071 1.464-8.536C4.93 2 7.286 2 12 2c4.714 0 7.071 0 8.535 1.464C22 4.93 22 7.286 22 12c0 4.714 0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12Z"/><path stroke-linecap="round" stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/></g></svg><span>å›åˆ°é¡¶éƒ¨</span></a><a class="buttom" onclick="util.scrollComment()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M10.46 1.25h3.08c1.603 0 2.86 0 3.864.095c1.023.098 1.861.3 2.6.752a5.75 5.75 0 0 1 1.899 1.899c.452.738.654 1.577.752 2.6c.095 1.004.095 2.261.095 3.865v1.067c0 1.141 0 2.036-.05 2.759c-.05.735-.153 1.347-.388 1.913a5.75 5.75 0 0 1-3.112 3.112c-.805.334-1.721.408-2.977.43a10.81 10.81 0 0 0-.929.036c-.198.022-.275.054-.32.08c-.047.028-.112.078-.224.232c-.121.166-.258.396-.476.764l-.542.916c-.773 1.307-2.69 1.307-3.464 0l-.542-.916a10.605 10.605 0 0 0-.476-.764c-.112-.154-.177-.204-.224-.232c-.045-.026-.122-.058-.32-.08c-.212-.023-.49-.03-.93-.037c-1.255-.021-2.171-.095-2.976-.429A5.75 5.75 0 0 1 1.688 16.2c-.235-.566-.338-1.178-.389-1.913c-.049-.723-.049-1.618-.049-2.76v-1.066c0-1.604 0-2.86.095-3.865c.098-1.023.3-1.862.752-2.6a5.75 5.75 0 0 1 1.899-1.899c.738-.452 1.577-.654 2.6-.752C7.6 1.25 8.857 1.25 10.461 1.25M6.739 2.839c-.914.087-1.495.253-1.959.537A4.25 4.25 0 0 0 3.376 4.78c-.284.464-.45 1.045-.537 1.96c-.088.924-.089 2.11-.089 3.761v1c0 1.175 0 2.019.046 2.685c.045.659.131 1.089.278 1.441a4.25 4.25 0 0 0 2.3 2.3c.515.214 1.173.294 2.429.316h.031c.398.007.747.013 1.037.045c.311.035.616.104.909.274c.29.17.5.395.682.645c.169.232.342.525.538.856l.559.944a.52.52 0 0 0 .882 0l.559-.944c.196-.331.37-.624.538-.856c.182-.25.392-.476.682-.645c.293-.17.598-.24.909-.274c.29-.032.639-.038 1.037-.045h.032c1.255-.022 1.913-.102 2.428-.316a4.25 4.25 0 0 0 2.3-2.3c.147-.352.233-.782.278-1.441c.046-.666.046-1.51.046-2.685v-1c0-1.651 0-2.837-.089-3.762c-.087-.914-.253-1.495-.537-1.959a4.25 4.25 0 0 0-1.403-1.403c-.464-.284-1.045-.45-1.96-.537c-.924-.088-2.11-.089-3.761-.089h-3c-1.651 0-2.837 0-3.762.089" clip-rule="evenodd"/><path fill="currentColor" d="M9 11a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0"/></svg><span>å‚ä¸è®¨è®º</span></a></div></widget>
</div></aside><div class='float-panel blur'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">
<script type="text/javascript">
  const ctx = {
    date_suffix: {
      just: `åˆšåˆš`,
      min: `åˆ†é’Ÿå‰`,
      hour: `å°æ—¶å‰`,
      day: `å¤©å‰`,
    },
    root : `/`,
    tag_plugins: {
      chat: Object.assign({"api":"https://siteinfo.listentothewind.cn/api/v1"}),
    }
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"all","path":"/search.json","content":true,"skip_search":null,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
  };
  const deps = {
    jquery: `https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js`,
    marked: `https://cdn.jsdelivr.net/npm/marked@13.0.1/lib/marked.umd.min.js`
  }
  

</script>

<script type="text/javascript">
  function RunItem() {
    this.list = []; // å­˜æ”¾å›è°ƒå‡½æ•°
    this.start = () => {
      for (var i = 0; i < this.list.length; i++) {
        this.list[i].run();
      }
    };
    this.push = (fn, name, setRequestAnimationFrame = true) => {
      let myfn = fn
      if (setRequestAnimationFrame) {
        myfn = () => {
          utils.requestAnimationFrame(fn)
        }
      }
      var f = new Item(myfn, name);
      this.list.push(f);
    };
    this.remove = (name) => {
      for (let index = 0; index < this.list.length; index++) {
        const e = this.list[index];
        if (e.name == name) {
          this.list.splice(index, 1);
        }
      }
    }
    // æ„é€ ä¸€ä¸ªå¯ä»¥runçš„å¯¹è±¡
    function Item(fn, name) {
      // å‡½æ•°åç§°
      this.name = name || fn.name;
      // runæ–¹æ³•
      this.run = () => {
        try {
          fn()
        } catch (error) {
          console.log(error);
        }
      };
    }
  }

  const utils = {
    // æ‡’åŠ è½½ css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')) {
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // é»˜è®¤å¼‚æ­¥ï¼Œå¦‚æœéœ€è¦åŒæ­¥ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥ {} å³å¯
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function () {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },

    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      let retryTimes = 3;
      utils.onLoading(el);
      function req() {
        return new Promise((resolve, reject) => {
          let status = 0; // 0 ç­‰å¾… 1 å®Œæˆ 2 è¶…æ—¶
          let timer = setTimeout(() => {
            if (status === 0) {
              status = 2;
              timer = null;
              reject('è¯·æ±‚è¶…æ—¶');
              if (retryTimes == 0) {
                onFailure();
              }
            }
          }, 5000);
          fetch(url).then(function (response) {
            if (status !== 2) {
              clearTimeout(timer);
              resolve(response);
              timer = null;
              status = 1;
            }
            if (response.ok) {
              return response.json();
            }
            throw new Error('Network response was not ok.');
          }).then(function (data) {
            retryTimes = 0;
            utils.onLoadSuccess(el);
            callback(data);
          }).catch(function (error) {
            if (retryTimes > 0) {
              retryTimes -= 1;
              setTimeout(() => {
                req();
              }, 5000);
            } else {
              utils.onLoadFailure(el);
              onFailure();
            }
          });
        });
      }
      req();
    },
    /********************** requestAnimationFrame ********************************/
    // 1ã€requestAnimationFrame ä¼šæŠŠæ¯ä¸€å¸§ä¸­çš„æ‰€æœ‰ DOM æ“ä½œé›†ä¸­èµ·æ¥ï¼Œåœ¨ä¸€æ¬¡é‡ç»˜æˆ–å›æµä¸­å°±å®Œæˆï¼Œå¹¶ä¸”é‡ç»˜æˆ–å›æµçš„æ—¶é—´é—´éš”ç´§ç´§è·Ÿéšæµè§ˆå™¨çš„åˆ·æ–°é¢‘ç‡ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œè¿™ä¸ªé¢‘ç‡ä¸ºæ¯ç§’60å¸§ã€‚
    // 2ã€åœ¨éšè—æˆ–ä¸å¯è§çš„å…ƒç´ ä¸­ï¼ŒrequestAnimationFrame å°†ä¸ä¼šè¿›è¡Œé‡ç»˜æˆ–å›æµï¼Œè¿™å½“ç„¶å°±æ„å‘³ç€æ›´å°‘çš„çš„ cpuï¼Œgpu å’Œå†…å­˜ä½¿ç”¨é‡ã€‚
    requestAnimationFrame: (fn) => {
      if (!window.requestAnimationFrame) {
        window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame;
      }
      window.requestAnimationFrame(fn)
    },
    dark: {},
  };

  // utils.dark.mode å½“å‰æ¨¡å¼ dark or light
  // utils.dark.toggle() æš—é»‘æ¨¡å¼è§¦å‘å™¨
  // utils.dark.push(callBack[,"callBackName"]) ä¼ å…¥è§¦å‘å™¨å›è°ƒå‡½æ•°
  utils.dark.method = {
    toggle: new RunItem(),
  };
  utils.dark = Object.assign(utils.dark, {
    push: utils.dark.method.toggle.push,
  });
</script>
<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>
<script type="text/javascript">
  (() => {
    const tagSwitchers = document.querySelectorAll('.tag-subtree.parent-tag > a > .tag-switcher-wrapper')
    for (const tagSwitcher of tagSwitchers) {
      tagSwitcher.addEventListener('click', (e) => {
        const parent = e.target.closest('.tag-subtree.parent-tag')
        parent.classList.toggle('expanded')
        e.preventDefault()
      })
    }

    // Get active tag from query string, then activate it.
    const urlParams = new URLSearchParams(window.location.search)
    const activeTag = urlParams.get('tag')
    if (activeTag) {
      let tag = document.querySelector(`.tag-subtree[data-tag="${activeTag}"]`)
      if (tag) {
        tag.querySelector('a').classList.add('active')
        
        while (tag) {
          tag.classList.add('expanded')
          tag = tag.parentElement.closest('.tag-subtree.parent-tag')
        }
      }
    }
  })()
</script>


<!-- required -->
<script src="/js/main.js?v=1.29.1" defer></script>

<script type="text/javascript">
  const applyTheme = (theme) => {
    if (theme === 'auto') {
      document.documentElement.removeAttribute('data-theme')
    } else {
      document.documentElement.setAttribute('data-theme', theme)
    }

    applyThemeToGiscus(theme)
  }

  const applyThemeToGiscus = (theme) => {
    theme = theme === 'auto' ? 'preferred_color_scheme' : theme

    const cmt = document.getElementById('giscus')
    if (cmt) {
      // This works before giscus load.
      cmt.setAttribute('data-theme', theme)
    }

    const iframe = document.querySelector('#comments > section.giscus > iframe')
    if (iframe) {
      // This works after giscus loaded.
      const src = iframe.src
      const newSrc = src.replace(/theme=[\w]+/, `theme=${theme}`)
      iframe.src = newSrc
    }
  }

  const switchTheme = () => {
    // light -> dark -> auto -> light -> ...
    const currentTheme = document.documentElement.getAttribute('data-theme')
    let newTheme;
    switch (currentTheme) {
      case 'light':
        newTheme = 'dark'
        break
      case 'dark':
        newTheme = 'auto'
        break
      default:
        newTheme = 'light'
    }
    applyTheme(newTheme)
    window.localStorage.setItem('Stellar.theme', newTheme)
    utils.dark.mode = newTheme === 'auto' ? (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light") : newTheme;
    utils.dark.method.toggle.start();

    const messages = {
      light: `åˆ‡æ¢åˆ°æµ…è‰²æ¨¡å¼`,
      dark: `åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼`,
      auto: `åˆ‡æ¢åˆ°è·Ÿéšç³»ç»Ÿé…è‰²`,
    }
    hud?.toast?.(messages[newTheme])
  }

  (() => {
    // Apply user's preferred theme, if any.
    const theme = window.localStorage.getItem('Stellar.theme')
    if (theme !== null) {
      applyTheme(theme)
    } else {
      utils.dark.mode = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
    }
    utils.dark.method.toggle.start();
  })()
</script>


<!-- optional -->

  <script type="module">
  const el = document.querySelector('#comments #giscus');
  util.viewportLazyload(el, load_discus, false);

  function load_discus() {
    if (!el) return;
    try {
        el.innerHTML = '';
      } catch (error) {
        console.error(error);
      }
      const script = document.createElement('script');
      script.async = true;
      for (const key of Object.keys(el.attributes)) {
        const attr = el.attributes[key];
        if (['class', 'id'].includes(attr.name) === false) {
          script.setAttribute(attr.name, attr.value);
        }
      }
      el.appendChild(script);
  }
</script>




<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":"https://site-info-api-hedon.vercel.app/api/v1?url={href}"},"ghinfo":{"js":"/js/services/ghinfo.js"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"},"voice":{"js":"/js/plugins/voice.js"},"video":{"js":"/js/plugins/video.js"},"download-file":{"js":"/js/plugins/download-file.js"},"twikoo":{"js":"/js/services/twikoo_latest_comment.js"},"waline":{"js":"/js/services/waline_latest_comment.js"},"artalk":{"js":"/js/services/artalk_latest_comment.js"},"giscus":{"js":"/js/services/giscus_latest_comment.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else if (id == 'voice') {
        ctx.voiceAudios = document.querySelectorAll('.voice>audio');
        if (ctx.voiceAudios?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            createVoiceDom(ctx.voiceAudios);
          });
        }
      } else if (id == 'video') {
        ctx.videos = document.querySelectorAll('.video>video');
        if (ctx.videos?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            videoEvents(ctx.videos);
          });
        }
      } else if (id == 'download-file') {
        ctx.files = document.querySelectorAll('.file');
        if (ctx.files?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            downloadFileEvent(ctx.files);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }

    // chat iphone time
    let phoneTimes = document.querySelectorAll('.chat .status-bar .time');

    if (phoneTimes.length > 0) {
      NowTime();
      var date = new Date();
      var sec = date.getSeconds();
      var firstAdjustInterval = setInterval(firstAdjustTime, 1000 * (60 - sec));
    }

    function firstAdjustTime() {
      NowTime();
      clearInterval(firstAdjustInterval);
      setInterval(NowTime, 1000 * 60);
    }

    function NowTime() {
      for (let i = 0; i < phoneTimes.length; ++i) {
        var timeSpan = phoneTimes[i];
        var date = new Date();
        var hour = date.getHours();
        var min = date.getMinutes();
        timeSpan.innerHTML = check(hour) + ":" + check(min);
      }
    };

    function check(val) {
      if (val < 10) {
        return ("0" + val);
      }
      return (val);
    }

    // chat quote
    const chat_quote_obverser = new IntersectionObserver((entries, observer) => {
      entries.filter((entry) => { return entry.isIntersecting }).sort((a, b) => a.intersectionRect.y !== b.intersectionRect.y ? a.intersectionRect.y - b.intersectionRect.y : a.intersectionRect.x - b.intersectionRect.x).forEach((entry, index) => {
          observer.unobserve(entry.target);
          setTimeout(() => {
            entry.target.classList.add('quote-blink');
            setTimeout(() => {
              entry.target.classList.remove('quote-blink');
            }, 1000);
          }, Math.max(100, 16) * (index + 1));
        });
    });

    var chatQuotes = document.querySelectorAll(".chat .talk .quote");
    chatQuotes.forEach((quote) => {
      quote.addEventListener('click', function () {
        var chatCellDom = document.getElementById("quote-" + quote.getAttribute("quotedCellTag"));
        if (chatCellDom) {
          var chatDiv = chatCellDom.parentElement;
          var mid = chatDiv.clientHeight / 2;
          var offsetTop = chatCellDom.offsetTop;
          if (offsetTop > mid - chatCellDom.clientHeight / 2) {
            chatDiv.scrollTo({
              top: chatCellDom.offsetTop - mid + chatCellDom.clientHeight / 2,
              behavior: "smooth"
            });
          } else {
            chatDiv.scrollTo({
              top: 0,
              behavior: "smooth"
            });
          }
          chat_quote_obverser.observe(chatCellDom);
        }
      });
    });
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://cdn.jsdelivr.net/npm/flying-pages@2/flying-pages.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@19.1.3/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });
</script><script>
  ctx.fancybox = {
    selector: `.timenode p>img, .md-text img:not([class]), .md-text .image img`,
    css: `https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css`,
    js: `https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js`
  };
  var selector = '[data-fancybox]:not(.error)';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const els = document.getElementsByClassName('ds-memos');
    if (els != undefined && els.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    window.codeElements = document.querySelectorAll('.code');
    if (window.codeElements.length > 0) {
      ctx.copycode = {
        default_text: `Copy`,
        success_text: `Copied`,
        toast: `å¤åˆ¶æˆåŠŸ`,
      };
      utils.js('/js/plugins/copycode.js');
    }
  });
</script>


<!-- inject -->

</div></body></html>
