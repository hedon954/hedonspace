<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>æ·±å…¥ Go è¯­è¨€æ ¸å¿ƒï¼šç»“æ„ä½“çš„å…¨æ–¹ä½è§£æ</title>
    <link href="/2024/03/09/go-struct/"/>
    <url>/2024/03/09/go-struct/</url>
    
    <content type="html"><![CDATA[<p>Goè¯­è¨€ï¼Œä½œä¸ºä¸€ç§é«˜æ•ˆã€é™æ€ç±»å‹çš„ç¼–ç¨‹è¯­è¨€ï¼Œè‡ªå…¶é—®ä¸–ä»¥æ¥ä¾¿ä»¥å…¶å¹¶å‘å¤„ç†èƒ½åŠ›å’Œç®€æ´çš„è¯­æ³•ç»“æ„å¹¿å—å¼€å‘è€…æ¬¢è¿ã€‚è™½ç„¶Goä¸æ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„é¢å‘å¯¹è±¡è¯­è¨€ï¼Œå®ƒå´ä»¥ç‹¬ç‰¹çš„æ–¹å¼æ”¯æŒé¢å‘å¯¹è±¡ç¼–ç¨‹çš„æ ¸å¿ƒæ¦‚å¿µï¼Œå…¶ä¸­ç»“æ„ä½“æ‰®æ¼”äº†éå¸¸å…³é”®çš„è§’è‰²ã€‚</p><p>ç»“æ„ä½“åœ¨ Goè¯­è¨€ä¸­æ˜¯ä¸€ç§å¤åˆæ•°æ®ç±»å‹ï¼Œå…è®¸æˆ‘ä»¬å°†ä¸åŒç±»å‹çš„æ•°æ®èšåˆåˆ°ä¸€èµ·ã€‚å®ƒä¸ä»…æé«˜äº†æ•°æ®ç®¡ç†çš„æ•ˆç‡å’Œé€»è¾‘æ¸…æ™°åº¦ï¼Œè¿˜æ˜¯Goè¯­è¨€ä¸­å®ç°é¢å‘å¯¹è±¡ç¼–ç¨‹æ€æƒ³å¦‚å°è£…ã€ç»„åˆç­‰æ¦‚å¿µçš„åŸºçŸ³ã€‚äº†è§£å’ŒæŒæ¡ç»“æ„ä½“çš„ä½¿ç”¨ï¼Œå¯¹äºæ·±å…¥ç†è§£Go è¯­è¨€çš„ç‰¹æ€§å’Œç¼–å†™é«˜æ•ˆã€å¯ç»´æŠ¤çš„ Go ä»£ç è‡³å…³é‡è¦ã€‚</p><p>æœ¬æ–‡å°†å¸¦æ‚¨å…¨é¢æ·±å…¥åœ°æ¢ç´¢ Goè¯­è¨€ä¸­ç»“æ„ä½“çš„å„ä¸ªæ–¹é¢ï¼Œä»åŸºæœ¬å®šä¹‰ã€åˆå§‹åŒ–å’Œä½¿ç”¨ï¼Œåˆ°é«˜çº§ç‰¹æ€§å¦‚ç»“æ„ä½“çš„ç»„åˆã€æ–¹æ³•å®šä¹‰ã€å†…å­˜å¯¹é½ç­‰ï¼Œæ¯ä¸€ä¸ªç»†èŠ‚éƒ½å°†ä¸€ä¸€å±•å¼€ã€‚æ— è®ºæ‚¨æ˜¯Goè¯­è¨€çš„æ–°æ‰‹ï¼Œè¿˜æ˜¯æœ‰ä¸€å®šç»éªŒçš„å¼€å‘è€…ï¼Œç›¸ä¿¡æœ¬æ–‡éƒ½èƒ½ä¸ºæ‚¨æä¾›æœ‰ä»·å€¼çš„è§è§£å’Œå¸®åŠ©ã€‚è®©æˆ‘ä»¬ä¸€èµ·æ¢ç´¢Goç»“æ„ä½“çš„å¥¥ç§˜ï¼Œæ­å¼€å…¶èƒŒåçš„åŸç†ï¼Œä¼˜åŒ–æˆ‘ä»¬çš„ä»£ç ç»“æ„ï¼Œæå‡ç¼–ç¨‹æ•ˆç‡ã€‚</p><h1 id="ç‰ˆæœ¬å£°æ˜">ç‰ˆæœ¬å£°æ˜</h1><ul><li>Go 1.22.1</li><li>gopkg.in/yaml.v3 v3.0.1</li><li>os: m2max</li></ul><h1 id="å…¨æ–‡æ¦‚è§ˆ">å…¨æ–‡æ¦‚è§ˆ</h1><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%20Go%20%E8%AF%AD%E8%A8%80%E7%BB%93%E6%9E%84%E4%BD%93%20(1).png"alt="Go è¯­è¨€ç»“æ„ä½“" /><figcaption aria-hidden="true">Go è¯­è¨€ç»“æ„ä½“</figcaption></figure><h1 id="ç»“æ„ä½“çš„åŸºæœ¬ä½¿ç”¨">1. ç»“æ„ä½“çš„åŸºæœ¬ä½¿ç”¨</h1><h2 id="å®šä¹‰ç»“æ„ä½“">1.1 å®šä¹‰ç»“æ„ä½“</h2><p>ç»“æ„ä½“ç±»å‹çš„å®šä¹‰å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> T <span class="hljs-keyword">struct</span> &#123;<br>  Field T1,<br>  Field T2,<br>  ....<br>  FieldN Tn,<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¯”å¦‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;<br>  Name <span class="hljs-type">string</span><br>  Age <span class="hljs-type">int</span><br>  ExtraInfo <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»“æ„ä½“å†…éƒ¨ï¼Œä¹Ÿå¯ä»¥å†…åµŒ<strong>åŒ¿åç»“æ„ä½“</strong>ï¼Œå¦‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;<br>Name <span class="hljs-type">string</span><br>  Age <span class="hljs-type">int</span><br>  School <span class="hljs-keyword">struct</span> &#123;<br>    Name <span class="hljs-type">string</span><br>    Address <span class="hljs-type">string</span><br>    Phone <span class="hljs-type">string</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ä½†æ˜¯ï¼æ³¨æ„ï¼Œå¦‚æœ Person ä¸­åŒ…å«äº† Person å‘¢ï¼Ÿ</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;<br>person  Person<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä¼šæŠ¥é”™ï¼šä¸å…è®¸å¼•ç”¨è‡ªèº«ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./main.go:5:6: invalid recursive <span class="hljs-built_in">type</span>: Person refers to itself<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯å› ä¸º Goè¯­è¨€åœ¨ç¼–è¯‘æ—¶éœ€è¦çŸ¥é“æ¯ä¸ªç±»å‹çš„ç¡®åˆ‡å¤§å°ï¼Œä»¥ä¾¿æ­£ç¡®åœ°åˆ†é…å†…å­˜ã€‚ä½†åœ¨è¿™ä¸ªå®šä¹‰ä¸­ï¼Œå› ä¸º<code>Person</code> åŒ…å«è‡ªèº«ï¼Œç¼–è¯‘å™¨æ— æ³•ç¡®å®š <code>Person</code>çš„å¤§å°ï¼Œå› æ­¤ä¼šæŠ¥é”™ã€‚</p><p>å¦‚æœä½ éœ€è¦åœ¨ä¸€ä¸ªç»“æ„ä½“ä¸­å¼•ç”¨ç›¸åŒç±»å‹çš„æ•°æ®ï¼Œä½ åº”è¯¥ä½¿ç”¨æŒ‡é’ˆã€‚æŒ‡é’ˆçš„å¤§å°æ˜¯å›ºå®šçš„ï¼Œå› æ­¤ç¼–è¯‘å™¨å¯ä»¥ç¡®å®šç»“æ„ä½“çš„å¤§å°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;<br>  person *Person<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="åˆå§‹åŒ–ç»“æ„ä½“">1.2 åˆå§‹åŒ–ç»“æ„ä½“</h2><p>å‡è®¾æˆ‘ä»¬æœ‰ä»¥ä¸‹ç»“æ„ä½“ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;<br>Name      <span class="hljs-type">string</span><br>Age       <span class="hljs-type">int</span><br>ExtraInfo <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥æœ‰ä»¥ä¸‹å‡ ç§åˆå§‹åŒ–ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// é€ä¸ªå­—æ®µèµ‹å€¼ï¼Œé¡ºåºä¸é‡è¦ï¼Œä¹Ÿå¯ä»¥åªèµ‹å€¼éƒ¨åˆ†å­—æ®µ</span><br>person1 := Person&#123;<br>  Age:       <span class="hljs-number">18</span>,<br>  Name:      <span class="hljs-string">&quot;hedon&quot;</span>,<br>  ExtraInfo: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;),<br>&#125;<br>fmt.Println(person1) <span class="hljs-comment">// &#123;hedon 18 map[]&#125;</span><br><br><span class="hljs-comment">// å¯ä»¥ä¸æŒ‡å®šå­—æ®µï¼Œä¸¥æ ¼æŒ‰ç…§é¡ºåº</span><br>person2 := Person&#123;<span class="hljs-string">&quot;hedon2&quot;</span>, <span class="hljs-number">19</span>, <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;)&#125;<br>fmt.Println(person2) <span class="hljs-comment">// &#123;hedon2 19 map[]&#125;</span><br><br><span class="hljs-comment">// é»˜è®¤åˆå§‹åŒ–ï¼Œåˆ™ç»“æ„ä½“ä¸­çš„æ¯ä¸ªå­—æ®µéƒ½ä¼šè¢«é»˜è®¤èµ‹äºˆå…¶å¯¹åº”ç±»å‹çš„â€œé›¶å€¼â€</span><br><span class="hljs-keyword">var</span> person3 Person<br>fmt.Println(person3)                  <span class="hljs-comment">// &#123; 0 map[]&#125;</span><br>fmt.Println(person3.ExtraInfo == <span class="hljs-literal">nil</span>) <span class="hljs-comment">// true</span><br><br><span class="hljs-comment">// ä¹Ÿå¯ä»¥ä½¿ç”¨ new() æˆ– &amp; æ¥åˆå§‹åŒ–å¹¶è¿”å›æŒ‡é’ˆ</span><br>person3 := <span class="hljs-built_in">new</span>(Person)<br>fmt.Println(person3)  <span class="hljs-comment">// &amp;&#123; 0 map[]&#125;</span><br></code></pre></td></tr></table></figure><h2 id="ç©ºç»“æ„ä½“">1.3 ç©ºç»“æ„ä½“</h2><p>æœ‰ä¸€ç§ç‰¹æ®Šçš„ç»“æ„ä½“ï¼Œå®ƒä¸€ä¸ªå­—æ®µéƒ½æ²¡æœ‰ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œç©ºç»“æ„ä½“â€ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Empty <span class="hljs-keyword">struct</span>&#123;&#125;<br></code></pre></td></tr></table></figure><p>ç©ºç»“æ„ä½“éå¸¸ç‰¹æ®Šï¼Œå®ƒä¸å æ®ä»»ä½•ç©ºé—´ï¼ä½ å¯ä»¥è‡ªå·±éªŒè¯ä¸€ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Empty <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  fmt.Println(<span class="hljs-string">&quot;the size of empty:&quot;</span>, unsafe.Sizeof(Empty&#123;&#125;)) <span class="hljs-comment">// the size of empty: 0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è€Œä¸”ï¼Œæ‰€æœ‰ç©ºç»“æ„ä½“çš„åœ°å€éƒ½ä¸€æ ·ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Empty <span class="hljs-keyword">struct</span>&#123;&#125;<br><span class="hljs-keyword">type</span> Empty1 <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>e := Empty&#123;&#125;<br>e1 := Empty1&#123;&#125;<br>fmt.Printf(<span class="hljs-string">&quot;the address of empty: %p\n&quot;</span>, &amp;e) <span class="hljs-comment">// the address of empty: 0x10460f520</span><br>fmt.Printf(<span class="hljs-string">&quot;the address of empty1: %p\n&quot;</span>, &amp;e1)  <span class="hljs-comment">// the address of empty1: 0x10460f520</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯å› ä¸º Go è¯­è¨€ä¸ºæ‰€æœ‰å¤§å°ä¸º 0 çš„å˜é‡éƒ½æŒ‡å‘äº†åŒä¸€ä¸ªå€¼ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// base address for all 0-byte allocations</span><br><span class="hljs-keyword">var</span> zerobase <span class="hljs-type">uintptr</span><br></code></pre></td></tr></table></figure><p>å¥½å¤„å°±æ˜¯å‡å°‘äº†å†…å­˜çš„æµªè´¹ã€‚å…¸å‹çš„ç”¨æ³•å°±æ˜¯æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ map æ¥å®ç°Setï¼Œè¿™æ ·å°±åªèŠ±è´¹äº†å­˜å‚¨é”®çš„ç©ºé—´ï¼Œè€Œå€¼ä¸å ç”¨ä»»ä½•ç©ºé—´ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Set = <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">struct</span>&#123;&#125;<br></code></pre></td></tr></table></figure><h2 id="è®¿é—®å’Œä¿®æ”¹ç»“æ„ä½“">1.4 è®¿é—®å’Œä¿®æ”¹ç»“æ„ä½“</h2><ul><li>ç»“æ„ä½“å±æ€§çš„å¯è§æ€§è·Ÿ GoåŒ…çš„å¯è§æ€§è§„åˆ™ä¸€æ ·ï¼šå¤§å†™å¯¹åŒ…å¤–å¯è§ï¼Œå°å†™ä»…åŒ…å†…å¯è§ã€‚</li><li>ä½¿ç”¨ <code>.</code> è®¿é—®å’Œä¿®æ”¹ç»“æ„ä½“ä¸­çš„å±æ€§ã€‚</li><li>Goè¯­è¨€ä¸­åªæœ‰â€œ<strong>å€¼ä¼ é€’</strong>â€ï¼Œæ‰€ä»¥å¦‚æœä½ è¦å°†ç»“æ„ä½“ç¤ºä¾‹ä¼ å…¥ä¸€ä¸ªfunc è¿›è¡Œä¿®æ”¹ï¼Œåˆ™éœ€è¦ä¼ å…¥å…¶å¼•ç”¨ã€‚</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;<br>Name <span class="hljs-type">string</span><br>Age  <span class="hljs-type">int</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>p := Person&#123;Name: <span class="hljs-string">&quot;hedon&quot;</span>, Age: <span class="hljs-number">18</span>&#125;<br>UpdatePersonName(p)<br>fmt.Println(<span class="hljs-string">&quot;1:&quot;</span>, p)<br>UpdatePersonNameWithRef(&amp;p)<br>fmt.Println(<span class="hljs-string">&quot;2:&quot;</span>, p)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">UpdatePersonName</span><span class="hljs-params">(p Person)</span></span> &#123;<br>p.Name = <span class="hljs-string">&quot;hedon-1&quot;</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">UpdatePersonNameWithRef</span><span class="hljs-params">(p *Person)</span></span> &#123;<br>p.Name = <span class="hljs-string">&quot;hedon-2&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">1: &#123;hedon 18&#125;<br>2: &#123;hedon-2 18&#125;<br></code></pre></td></tr></table></figure><h1 id="ç»“æ„ä½“çš„é«˜çº§ç‰¹æ€§">2. ç»“æ„ä½“çš„é«˜çº§ç‰¹æ€§</h1><h2 id="ç»“æ„ä½“ç»„åˆ">2.1 ç»“æ„ä½“ç»„åˆ</h2><p>åœ¨ Goè¯­è¨€ä¸­ï¼Œå€¡å¯¼çš„æ˜¯â€œç»„åˆä¼˜äºç»§æ‰¿â€çš„å“²å­¦ï¼Œå³å€¡å¯¼ä½¿ç”¨ç»„åˆè€Œä¸æ˜¯ç»§æ‰¿æ¥å®ç°ä»£ç çš„å¤ç”¨ã€‚è¯¥ç†å¿µé¼“åŠ±å¼€å‘è€…é€šè¿‡ç»„åˆå’Œæ¥å£æ¥æ„å»ºçµæ´»ã€å¯ç»´æŠ¤çš„ä»£ç ï¼Œè€Œä¸æ˜¯ä¾èµ–äºæ›´ä¸¥æ ¼ã€æ›´æ˜“å‡ºé”™çš„ç»§æ‰¿å…³ç³»ã€‚è¿™ç§æ–¹å¼ä¿ƒè¿›äº†ä»£ç çš„è§£è€¦ï¼Œå¢å¼ºäº†ä»£ç çš„çµæ´»æ€§å’Œå¯é‡ç”¨æ€§ï¼ŒåŒæ—¶ä¹Ÿä½¿å¾—ä»£ç æ›´åŠ æ¸…æ™°å’Œæ˜“äºç†è§£ã€‚</p><p>åœ¨ Goä¸­ï¼Œç»„åˆæ˜¯é€šè¿‡å°†ä¸€ä¸ªæˆ–å¤šä¸ªç±»å‹ï¼ˆé€šå¸¸æ˜¯ç»“æ„ä½“ï¼‰åµŒå…¥åˆ°å¦ä¸€ä¸ªç»“æ„ä½“ä¸­æ¥å®ç°çš„ã€‚è¿™ä½¿å¾—åµŒå…¥çš„ç±»å‹çš„æ–¹æ³•è¢«â€œæå‡â€åˆ°åŒ…å«å®ƒçš„ç»“æ„ä½“ä¸­ï¼Œå…è®¸ä½ è°ƒç”¨è¿™äº›æ–¹æ³•å°±åƒå®ƒä»¬æ˜¯å¤–éƒ¨ç»“æ„ä½“çš„ä¸€éƒ¨åˆ†ä¸€æ ·ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Engine <span class="hljs-keyword">struct</span> &#123;<br>    Power <span class="hljs-type">int</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *Engine)</span></span> Start() &#123;<br>    <span class="hljs-comment">// å¯åŠ¨å¼•æ“çš„é€»è¾‘</span><br>&#125;<br><br><span class="hljs-keyword">type</span> Car <span class="hljs-keyword">struct</span> &#123;<br>    Engine <span class="hljs-comment">// é€šè¿‡ç»„åˆçš„æ–¹å¼åµŒå…¥ Engine</span><br>&#125;<br><br><span class="hljs-comment">// ç°åœ¨ Car å¯ä»¥ç›´æ¥è°ƒç”¨ Start æ–¹æ³•</span><br>car := Car&#123;Engine&#123;Power: <span class="hljs-number">100</span>&#125;&#125;<br>car.Start() <span class="hljs-comment">// è°ƒç”¨çš„æ˜¯ Engine çš„ Start æ–¹æ³•</span><br></code></pre></td></tr></table></figure><h2 id="ç»“æ„ä½“çš„æ–¹æ³•">2.2 ç»“æ„ä½“çš„æ–¹æ³•</h2><p>å‡è®¾æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªç»“æ„ä½“ Personï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;<br>Name <span class="hljs-type">string</span><br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ Go ä¸­ï¼Œä½ å¯ä»¥ä¸ºç»“æ„ä½“çš„å€¼æˆ–æŒ‡é’ˆå®ç°ç‰¹å®šçš„æ–¹æ³•ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(p Person)</span></span> SetName(name <span class="hljs-type">string</span>) <span class="hljs-type">string</span> &#123;<br>  p.Name = name<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(p *Person)</span></span> SetName(name <span class="hljs-type">string</span>) <span class="hljs-type">string</span> &#123;<br>  p.Name = name<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸¤è€…æœ€æ ¸å¿ƒçš„åŒºåˆ«æ˜¯ï¼š<strong>å½“ä½ ä¸ºç»“æ„ä½“çš„æŒ‡é’ˆç±»å‹å®šä¹‰æ–¹æ³•æ—¶ï¼Œè¯¥æ–¹æ³•ä¼šåœ¨åŸå§‹ç»“æ„ä½“å®ä¾‹ä¸Šæ“ä½œã€‚è¿™æ„å‘³ç€æ–¹æ³•å†…éƒ¨å¯¹ç»“æ„ä½“çš„ä»»ä½•ä¿®æ”¹éƒ½ä¼šå½±å“åˆ°åŸå§‹ç»“æ„ä½“ã€‚</strong></p><p>æ‰€ä»¥è¿™ä¸¤æ®µä»£ç çš„è¾“å‡ºæ˜¯ä¸ä¸€æ ·çš„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>p := Person&#123;Name: <span class="hljs-string">&quot;hedon&quot;</span>&#125;<br>p.SetName(<span class="hljs-string">&quot;new_name&quot;</span>)<br>fmt.Println(p.Name)   <span class="hljs-comment">// name_name</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Person)</span></span> SetName(name <span class="hljs-type">string</span>) &#123;<br>p.Name = name<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>p := Person&#123;Name: <span class="hljs-string">&quot;hedon&quot;</span>&#125;<br>p.SetName(<span class="hljs-string">&quot;new_name&quot;</span>)<br>fmt.Println(p.Name)  <span class="hljs-comment">// hedon</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p Person)</span></span> SetName(name <span class="hljs-type">string</span>) &#123;<br>p.Name = name<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™é‡Œæˆ‘æƒ³å†è¡¥å……ä¸¤ä¸ªå°ç‚¹ã€‚è¯·å…ˆæ€è€ƒä¸€ä¸‹ä¸‹é¢è¿™ä¸¤æ®µä»£ç æ˜¯å¦å¯ä»¥ç¼–è¯‘é€šè¿‡ï¼Ÿå¦‚æœå¯ä»¥è¾“å‡ºæ˜¯ä»€ä¹ˆï¼Ÿ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>p := Person&#123;Name: <span class="hljs-string">&quot;hedon&quot;</span>&#125;<br>p.SetName(<span class="hljs-string">&quot;new_name&quot;</span>)<br>fmt.Println(<span class="hljs-string">&quot;person name after set:&quot;</span>, p.Name)<br><br>pt := reflect.TypeOf(p)<br>fmt.Println(<span class="hljs-string">&quot;the number of person&#x27;s method: &quot;</span>, pt.NumMethod())<br><br>p2 := &amp;Person&#123;&#125;<br>pt = reflect.TypeOf(p2)<br>fmt.Println(<span class="hljs-string">&quot;the number of &amp;person&#x27;s method: &quot;</span>, pt.NumMethod())<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Person)</span></span> SetName(name <span class="hljs-type">string</span>) &#123;<br>p.Name = name<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>p := Person&#123;Name: <span class="hljs-string">&quot;hedon&quot;</span>&#125;<br>p.SetName(<span class="hljs-string">&quot;new_name&quot;</span>)<br>fmt.Println(<span class="hljs-string">&quot;person name after set:&quot;</span>, p.Name)<br><br>pt := reflect.TypeOf(p)<br>fmt.Println(<span class="hljs-string">&quot;the number of person&#x27;s method: &quot;</span>, pt.NumMethod())<br><br>p2 := &amp;Person&#123;&#125;<br>pt = reflect.TypeOf(p2)<br>fmt.Println(<span class="hljs-string">&quot;the number of &amp;person&#x27;s method: &quot;</span>, pt.NumMethod())<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p Person)</span></span> SetName(name <span class="hljs-type">string</span>) &#123;<br>p.Name = name<br>&#125;<br></code></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾è¿™ä¸¤æ®µä»£ç çš„å”¯ä¸€åŒºåˆ«å°±æ˜¯ï¼Œç¬¬ä¸€æ®µä»£ç æˆ‘ä»¬æ˜¯ä¸º<code>*Person</code> å®ç°äº† <code>SetName</code>æ–¹æ³•ï¼Œè€Œç¬¬äºŒæ®µä»£ç æˆ‘ä»¬æ˜¯ä¸º <code>Person</code> å®ç°äº†<code>SetName</code> æ–¹æ³•ã€‚ä¸¤æ®µä»£ç æˆ‘ä»¬éƒ½æ‰“å°äº†è°ƒç”¨ <code>SetName</code>å <code>p.name</code> çš„å€¼ï¼Œä»¥åŠåˆ©ç”¨æ–¹å¼åˆ†åˆ«è·å– <code>Person</code> å’Œ<code>*Person</code> å®ç°çš„æ–¹æ³•ä¸ªæ•°ã€‚</p><p>ç¬¬ä¸€æ®µä»£ç çš„è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs tex">person name after set: new<span class="hljs-built_in">_</span>name<br>the number of person&#x27;s method:  0<br>the number of <span class="hljs-built_in">&amp;</span>person&#x27;s method:  1<br></code></pre></td></tr></table></figure><p>ç¬¬äºŒæ®µä»£ç çš„è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs tex">person name after set: hedon<br>the number of person&#x27;s method:  1<br>the number of <span class="hljs-built_in">&amp;</span>person&#x27;s method:  1<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥å¾—å‡º 2 ä¸ªç»“è®ºï¼š</p><p><strong>â‘  ç»“æ„ä½“çš„ä¿®æ”¹ä¾èµ–äºæ–¹æ³•æ¥æ”¶å™¨çš„ç±»å‹</strong>ï¼š</p><ul><li>å½“æ–¹æ³•çš„æ¥æ”¶å™¨ä¸ºå€¼ç±»å‹ï¼ˆ<code>Person</code>ï¼‰æ—¶ï¼Œå¯¹ç»“æ„ä½“çš„ä¿®æ”¹ä¸ä¼šå½±å“åŸå§‹ç»“æ„ä½“å®ä¾‹ï¼Œå› ä¸ºæ–¹æ³•ä½œç”¨äºç»“æ„ä½“çš„å‰¯æœ¬ä¸Šã€‚</li><li>å½“æ–¹æ³•çš„æ¥æ”¶å™¨ä¸ºæŒ‡é’ˆç±»å‹ï¼ˆ<code>*Person</code>ï¼‰æ—¶ï¼Œå¯¹ç»“æ„ä½“çš„ä¿®æ”¹ä¼šå½±å“åŸå§‹ç»“æ„ä½“å®ä¾‹ï¼Œå› ä¸ºæ–¹æ³•ä½œç”¨äºç»“æ„ä½“çš„å¼•ç”¨ä¸Šã€‚</li></ul><p><strong>â‘¡ æ–¹æ³•é›†ä¾èµ–äºæ¥æ”¶å™¨çš„ç±»å‹</strong>ï¼š</p><ul><li>ä¸ºå€¼ç±»å‹ï¼ˆ<code>Person</code>ï¼‰å®ç°çš„æ–¹æ³•ï¼Œæ—¢å±äºå€¼ç±»å‹ä¹Ÿå±äºæŒ‡é’ˆç±»å‹ï¼ˆ<code>*Person</code>ï¼‰çš„æ–¹æ³•é›†ã€‚</li><li>ä¸ºæŒ‡é’ˆç±»å‹ï¼ˆ<code>*Person</code>ï¼‰å®ç°çš„æ–¹æ³•ï¼Œåªå±äºæŒ‡é’ˆç±»å‹çš„æ–¹æ³•é›†ã€‚</li></ul><p>å¯¹äº â‘¡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ Plan9 æ±‡ç¼–ä»£ç ä¸€æ¢ç©¶ç«Ÿã€‚</p><p>æˆ‘ä»¬ä¸ºç¬¬ä¸€æ®µä»£ç æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go build -gcflags -S main.go<br></code></pre></td></tr></table></figure><p>åœ¨è¾“å‡ºçš„æœ€ä¸Šé¢ï¼Œå¯ä»¥çœ‹åˆ°åªæœ‰<code>main.(*Person).GetName</code>ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"># command-line-arguments<br>main.main STEXT size=<span class="hljs-number">128</span> args=<span class="hljs-number">0x0</span> locals=<span class="hljs-number">0x48</span> funcid=<span class="hljs-number">0x0</span> align=<span class="hljs-number">0x0</span><br>        ...<br>main.(*Person).GetName STEXT size=<span class="hljs-number">16</span> args=<span class="hljs-number">0x8</span> locals=<span class="hljs-number">0x0</span> funcid=<span class="hljs-number">0x0</span> align=<span class="hljs-number">0x0</span> leaf<br>       ...<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å†æ¥ä¸ºç¬¬äºŒæ®µä»£ç æ‰§è¡Œç›¸åŒçš„å‘½ä»¤ã€‚å¯ä»¥åœ¨è¾“å‡ºçš„æœ€ä¸Šé¢ï¼Œçœ‹åˆ°ä¸ä»…æœ‰<code>main.Person.GetName</code>ï¼Œè¿˜å¯ä»¥å‘ç°ç¼–è¯‘å™¨è‡ªåŠ¨å¸®æˆ‘ä»¬ç”Ÿæˆäº†<code>main.(*Person).GetName</code>ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># command-line-arguments</span><br>main.main STEXT size=480 args=0x0 locals=0xe8 funcid=0x0 align=0x0<br>...<br>main.Person.SetName STEXT size=16 args=0x28 locals=0x0 funcid=0x0 align=0x0 leaf<br>   ...<br>main.(*Person).SetName STEXT dupok size=128 args=0x18 locals=0x8 funcid=0x16 align=0x0<br>...<br></code></pre></td></tr></table></figure><p>å¯¹äº â‘¡ï¼Œç¬”è€…å…¶å®æœ‰ä¸€ä¸ªä¸å¤ªç†è§£çš„åœ°æ–¹ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>p := &amp;Person&#123;Name: <span class="hljs-string">&quot;hedon&quot;</span>&#125;<br>p.SetName(<span class="hljs-string">&quot;new_name&quot;</span>)<br>fmt.Println(<span class="hljs-string">&quot;person name after set:&quot;</span>, p.Name) <span class="hljs-comment">// hedon</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p Person)</span></span> SetName(name <span class="hljs-type">string</span>) &#123;<br>p.Name = name<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œ <code>p</code> æ˜¯å¼•ç”¨ç±»å‹ï¼Œä¸‹é¢å®ç°çš„æ˜¯<code>Person.SetName</code>ï¼ŒæŒ‰ç…§æˆ‘ä»¬ä¸Šé¢çš„ç»“è®ºï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬å®ç°<code>(*Person).SetName</code>ã€‚æŒ‰ç…§è¿™ç§æ€è·¯ï¼Œè¾“å‡º <code>new_name</code>ä¹Ÿæ˜¯è§£é‡Šå¾—é€šçš„ã€‚å› ä¸ºæ—¢ç„¶æˆ‘ä»¬å£°æ˜çš„æ˜¯ä¸€ä¸ªå¼•ç”¨ç±»å‹ï¼Œé‚£ä¹ˆ <code>p</code>å®Œå…¨å¯ä»¥å»è°ƒç”¨è‡ªåŠ¨ç”Ÿæˆçš„<code>(*Person).SetName</code>ã€‚ä½†æ˜¯æœ€ç»ˆçš„ç»“æœè¿˜æ˜¯è¾“å‡º<code>hedon</code>ï¼Œæ‰€ä»¥è¿™é‡Œç¼–è¯‘å™¨è‡ªåŠ¨å¸®æˆ‘ä»¬å°† <code>p</code>è¿›è¡Œè§£å¼•ç”¨ï¼Œç„¶åè°ƒç”¨äº† <code>Person.SetName</code>ã€‚</p><p>è¿™æ˜¯æ¯”è¾ƒå›°æ‰°ç¬”è€…çš„ä¸€ä¸ªåœ°æ–¹ï¼Œæ¬¢è¿è¯„è®ºåŒºè®¨è®º~</p><p>å¯èƒ½ç¼–è¯‘å™¨è¿˜æ˜¯æ›´å¸Œæœ›å¯¹äºå¼€å‘è€…æ¥è¯´â€œæ‰€è§å³æ‰€å¾—â€ï¼Œæ—¢ç„¶å¼€å‘è€…å®ç°çš„æ˜¯<code>Person.SetName</code>ï¼Œé‚£ä¹ˆå¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œåº”è¯¥å°±æ˜¯å¸Œæœ›ä¸å½±å“åŸå§‹ç»“æ„ä½“çš„å€¼ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨è¿˜æ˜¯é€‰æ‹©éµå¾ªè¿™ç§â€œæ„æ„¿â€ï¼Œä¸ä¹±æ“ä½œã€‚</p><h2 id="ç»“æ„ä½“æ¯”è¾ƒ">2.3 ç»“æ„ä½“æ¯”è¾ƒ</h2><p>Go å…è®¸ç›´æ¥æ¯”è¾ƒä¸¤ä¸ªç»“æ„ä½“å®ä¾‹ï¼Œä½†æœ‰ä¸€å®šçš„é™åˆ¶ï¼š</p><ol type="1"><li><strong>å¯æ¯”è¾ƒæ€§</strong>ï¼šåªæœ‰å½“ç»“æ„ä½“ä¸­çš„æ‰€æœ‰å­—æ®µéƒ½æ˜¯å¯æ¯”è¾ƒçš„æ—¶ï¼Œç»“æ„ä½“æ‰æ˜¯å¯æ¯”è¾ƒçš„ã€‚åŸºæœ¬æ•°æ®ç±»å‹ï¼ˆå¦‚intã€string ç­‰ï¼‰æ˜¯å¯æ¯”è¾ƒçš„ï¼Œä½†åˆ‡ç‰‡ã€æ˜ å°„ã€å‡½æ•°ç­‰ç±»å‹ä¸å¯æ¯”è¾ƒã€‚</li><li><strong>ç›¸ç­‰æ€§æ£€æµ‹</strong>ï¼šå½“ä¸¤ä¸ªç»“æ„ä½“çš„å¯¹åº”å­—æ®µéƒ½ç›¸ç­‰æ—¶ï¼Œè¿™ä¸¤ä¸ªç»“æ„ä½“è¢«è®¤ä¸ºæ˜¯ç›¸ç­‰çš„ã€‚å¯ä»¥ä½¿ç”¨<code>==</code> å’Œ <code>!=</code> æ“ä½œç¬¦æ¥è¿›è¡Œæ¯”è¾ƒã€‚</li></ol><p>ä¸‹é¢è¿™æ®µç¤ºä¾‹ï¼Œ<code>p3==p4</code> è¿”å›äº†<code>true</code>ï¼Œè¿™ç¬¦åˆæˆ‘ä»¬ä¸Šé¢æ€»ç»“çš„ç»“è®ºã€‚<code>p1==p2</code> è¿”å›äº†<code>false</code>ï¼Œå› ä¸ºè¿™å…¶å®ä¸æ˜¯ç»“æ„ä½“ä¹‹é—´çš„æ¯”è¾ƒäº†ï¼Œè¿™æ˜¯æŒ‡é’ˆçš„æ¯”è¾ƒäº†ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">p1 := &amp;Person&#123;Name: <span class="hljs-string">&quot;hedon&quot;</span>, Age: <span class="hljs-number">18</span>&#125;<br>p2 := &amp;Person&#123;Name: <span class="hljs-string">&quot;hedon&quot;</span>, Age: <span class="hljs-number">18</span>&#125;<br>fmt.Println(p1 == p2) <span class="hljs-comment">// false</span><br>p3 := Person&#123;Name: <span class="hljs-string">&quot;hedon&quot;</span>, Age: <span class="hljs-number">18</span>&#125;<br>p4 := Person&#123;Name: <span class="hljs-string">&quot;hedon&quot;</span>, Age: <span class="hljs-number">18</span>&#125;<br>fmt.Println(p3 == p4) <span class="hljs-comment">// true</span><br></code></pre></td></tr></table></figure><p>ç»“æ„ä½“çš„æ¯”è¾ƒåªæ”¯æŒ <code>==</code> å’Œ <code>!=</code>ï¼Œä¸æ”¯æŒ<code>&lt;</code> å’Œ <code>&gt;</code> ç­‰å…¶ä»–è¿ç®—ç¬¦çš„æ¯”è¾ƒã€‚è€Œ Goè¯­è¨€åˆä¸æ”¯æŒæ¯”è¾ƒç¬¦é‡è½½ã€‚æ‰€ä»¥å¦‚æœä½ è¦æ¯”è¾ƒä¸¤ä¸ªç»“æ„ä½“çš„å¤§å°ï¼Œé‚£ä¹ˆåªèƒ½è‡ªè¡Œå°è£…ç±»å‹<code>compare</code>çš„å‡½æ•°ã€‚åœ¨è¿™æˆ‘ä»¬æ’åºç»“æ„ä½“æ•°ç»„æˆ–åˆ‡ç‰‡çš„æ—¶å€™ï¼Œç»å¸¸ä½¿ç”¨åˆ°ï¼Œæ¯”å¦‚æˆ‘ä»¬å¸Œæœ›æŒ‰<code>Age</code> å­—æ®µä»å°åˆ°å¤§æ’åºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">sort.Slice(persons, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i, j <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>  <span class="hljs-keyword">return</span> persons[i].Age &lt; persons[j].Age<br>&#125;)<br></code></pre></td></tr></table></figure><h2 id="ç»“æ„ä½“å¤åˆ¶">2.4 ç»“æ„ä½“å¤åˆ¶</h2><p>åœ¨ Goä¸­ï¼Œç»“æ„ä½“ä¹Ÿæ˜¯å€¼ç±»å‹ï¼Œè¿™æ„å‘³ç€å½“å®ƒä»¬è¢«èµ‹å€¼ç»™æ–°çš„å˜é‡æˆ–ä½œä¸ºå‡½æ•°å‚æ•°ä¼ é€’æ—¶ï¼Œå®é™…ä¸Šæ˜¯è¿›è¡Œäº†ä¸€æ¬¡æ·±æ‹·è´ï¼š</p><ol type="1"><li><strong>å€¼å¤åˆ¶</strong>ï¼šå½“å°†ä¸€ä¸ªç»“æ„ä½“èµ‹å€¼ç»™ä¸€ä¸ªæ–°å˜é‡æ—¶ï¼Œæ–°å˜é‡ä¼šè·å¾—åŸå§‹ç»“æ„ä½“çš„ä¸€ä¸ªå‰¯æœ¬ï¼Œå®ƒä»¬åœ¨å†…å­˜ä¸­å æœ‰ä¸åŒçš„ä½ç½®ã€‚</li><li><strong>ç‹¬ç«‹æ€§</strong>ï¼šå› ä¸ºæ˜¯æ·±æ‹·è´ï¼Œæ‰€ä»¥åŸå§‹ç»“æ„ä½“å’Œå‰¯æœ¬ç»“æ„ä½“æ˜¯å®Œå…¨ç‹¬ç«‹çš„ï¼›ä¿®æ”¹å…¶ä¸­ä¸€ä¸ªä¸ä¼šå½±å“å¦ä¸€ä¸ªã€‚</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Point <span class="hljs-keyword">struct</span> &#123;<br>    X, Y <span class="hljs-type">int</span><br>&#125;<br><br>original := Point&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>&#125;<br><span class="hljs-built_in">copy</span> := original<br><span class="hljs-built_in">copy</span>.X = <span class="hljs-number">3</span><br><br>fmt.Println(original) <span class="hljs-comment">// &#123;1, 2&#125;</span><br>fmt.Println(<span class="hljs-built_in">copy</span>)     <span class="hljs-comment">// &#123;3, 2&#125;</span><br></code></pre></td></tr></table></figure><h1 id="ç»“æ„ä½“ä¸æ¥å£">3. ç»“æ„ä½“ä¸æ¥å£</h1><p>åœ¨ Goè¯­è¨€ä¸­ï¼Œå¦‚æœä¸€ä¸ªç±»å‹å®ç°äº†æ¥å£ä¸­æ‰€æœ‰çš„æ–¹æ³•ï¼Œåˆ™è¿™ä¸ªç±»å‹å°±å®ç°äº†è¯¥æ¥å£ã€‚å…³äºæ¥å£éƒ¨åˆ†çš„çŸ¥è¯†ç‚¹ï¼Œæ¯”å¦‚æ¥å£å®šä¹‰ã€å¤šæ€å’Œæ–­è¨€ç­‰ï¼Œæœ¬æ–‡å°±ä¸èµ˜è¿°äº†ã€‚</p><p>åœ¨è¿™é‡Œæˆ‘ä¸»è¦æƒ³ä»å¦å¤–ä¸€ä¸ªè§’åº¦ç»§ç»­æ¥éªŒè¯å‰é¢æˆ‘ä»¬æ€»ç»“çš„ï¼š<strong>ä¸ºå€¼ç±»å‹ï¼ˆ<code>Person</code>ï¼‰å®ç°çš„æ–¹æ³•ï¼Œæ—¢å±äºå€¼ç±»å‹ä¹Ÿå±äºæŒ‡é’ˆç±»å‹ï¼ˆ<code>*Person</code>ï¼‰çš„æ–¹æ³•é›†</strong>ã€‚</p><p>è¯·çœ‹è¿™æ®µä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">interface</span> &#123;<br>GetName() <span class="hljs-type">string</span><br>&#125;<br><br><span class="hljs-keyword">type</span> Man <span class="hljs-keyword">struct</span> &#123;<br>Name <span class="hljs-type">string</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m Man)</span></span> GetName() <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> m.Name<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">PrintPersonName</span><span class="hljs-params">(p Person)</span></span> &#123;<br>fmt.Println(p.GetName())<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>m1 := Man&#123;Name: <span class="hljs-string">&quot;hedon1&quot;</span>&#125;<br>PrintPersonName(m1)<br>m2 := &amp;Man&#123;Name: <span class="hljs-string">&quot;hedon2&quot;</span>&#125;<br>PrintPersonName(m2)<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ®µä»£ç æˆ‘ä»¬å®šä¹‰äº† <code>Person</code> æ¥å£ï¼Œå®ƒåªæœ‰ä¸€ä¸ªæ–¹æ³•<code>GetName</code>ã€‚ç„¶åæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªç»“æ„ä½“<code>Man</code>ï¼Œå¹¶ä¸ºå®ƒçš„å€¼ç±»å‹å®ç°äº† <code>Person</code>æ¥å£ã€‚é€šè¿‡æˆ‘ä»¬ä¸Šé¢çš„ç»“è®ºï¼Œè¿™é‡Œ <code>Man</code> å’Œ <code>*Man</code>å…¶å®éƒ½å®ç°äº† <code>Person</code>æ¥å£ï¼Œæ‰€ä»¥ä¸Šé¢çš„ä»£ç æ˜¯å¯ä»¥ç¼–è¯‘é€šè¿‡çš„ã€‚</p><p>å¦‚æœæ”¹æˆä¸ºæŒ‡é’ˆç±»å‹å®ç°æ¥å£å‘¢ï¼Ÿä½ å¯ä»¥è¯•ä¸€ä¸‹~</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Man)</span></span> GetName() <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> m.Name<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="æ³›å‹ç»“æ„ä½“">4. æ³›å‹ç»“æ„ä½“</h1><p>Go è¯­è¨€åœ¨å…¶ 1.18ç‰ˆæœ¬ä¸­å¼•å…¥äº†æ³›å‹æ”¯æŒï¼Œè¿™åŒ…æ‹¬äº†å¯¹æ³›å‹ç»“æ„ä½“çš„æ”¯æŒã€‚é€šè¿‡ä½¿ç”¨æ³›å‹ï¼Œä½ å¯ä»¥åˆ›å»ºæ›´çµæ´»å’Œå¯é‡ç”¨çš„æ•°æ®ç»“æ„å’Œå‡½æ•°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Container[T any] <span class="hljs-keyword">struct</span> &#123;<br>items []T<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° Go è¯­è¨€ç”¨ <code>[]</code> æ¥å®ç°æ³›å‹ï¼Œè€Œä¸åƒå…¶ä»–è¯­è¨€ä¸€æ ·ç”¨<code>&lt;&gt;</code>ï¼ŒçœŸæ˜¯å–œæ¬¢æç‰¹æ®Šå•Š ğŸ¤¡ï¼Œåˆä¸‘åˆå®¹æ˜“è·Ÿ map å’Œ sliceæ··æ·†ã€‚</p><h1 id="ç»“æ„ä½“çš„æ ‡ç­¾tag">5. ç»“æ„ä½“çš„æ ‡ç­¾ï¼ˆTagï¼‰</h1><p>åœ¨ç»“æ„ä½“å­—æ®µåé¢ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ <strong>``</strong>æ¥æŒ‡å®šæ ‡ç­¾ï¼Œè¿™å…è®¸æˆ‘ä»¬å¯¹ç»“æ„ä½“å®šåˆ¶åŒ–ä¸€äº›å¸¸ç”¨æ“ä½œï¼Œæœ€ç»å…¸çš„å°±æ˜¯åºåˆ—åŒ–ä¸ååºåˆ—åŒ–ã€‚</p><h2 id="åºåˆ—åŒ–ä¸ååºåˆ—åŒ–">5.1 åºåˆ—åŒ–ä¸ååºåˆ—åŒ–</h2><p>å¯¹äºå¸¸è§çš„æ•°æ®ç»“æ„ï¼Œå¦‚<code>json</code>ã€<code>yaml</code>ã€<code>xml</code> æˆ–<code>toml</code>ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥é€šè¿‡åœ¨ç»“æ„ä½“ä¸­æŒ‡å®šæ ‡ç­¾ï¼Œç„¶åä½¿ç”¨å¯¹åº”è§£æåº“è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚æ¯”å¦‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;encoding/json&quot;</span><br><span class="hljs-string">&quot;fmt&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;<br>Name <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;name&quot;`</span><br>Age  <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;age&quot;`</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>p := Person&#123;Name: <span class="hljs-string">&quot;hedon&quot;</span>, Age: <span class="hljs-number">18</span>&#125;<br>bs, _ := json.Marshal(p) <span class="hljs-comment">// åºåˆ—åŒ–</span><br>fmt.Println(<span class="hljs-type">string</span>(bs))  <span class="hljs-comment">// &#123;&quot;name&quot;:&quot;hedon&quot;,&quot;age&quot;:18&#125;</span><br>newP := Person&#123;&#125;<br>_ = json.Unmarshal(bs, &amp;newP) <span class="hljs-comment">// ååºåˆ—åŒ–</span><br>fmt.Println(newP)             <span class="hljs-comment">// &#123;hedon 18&#125;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ç¬”è€…çš„å®è·µè¿‡ç¨‹ä¸­ï¼Œåœ¨ç»“æ„ä½“ç»„åˆçš„åœºæ™¯ä¸‹ï¼Œä¸åŒæ•°æ®æ ¼å¼çš„è§£æä¼šæœ‰ä¸€äº›å°å·®åˆ«ï¼Œè¿™åœ¨å®æˆ˜è¿‡ç¨‹ä¸­ä½ éœ€è¦é‡ç‚¹å…³æ³¨å’ŒéªŒè¯ã€‚æ¯”å¦‚<code>json</code> å’Œ <code>yaml</code> å°±ä¼šæœ‰ä¸€äº›ä¸åŒã€‚</p><p>æ¯”å¦‚è¯´æˆ‘è¿™é‡Œå®šä¹‰äº†ä¸‹é¢ 2 ä¸ªç»“æ„ä½“ï¼Œå…¶ä¸­ <code>Person</code> ç»„åˆäº†<code>School</code>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;<br>Name <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;name&quot; yaml:&quot;name&quot;`</span><br>Age  <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;age&quot; yaml:&quot;age&quot;`</span><br>School<br>&#125;<br><br><span class="hljs-keyword">type</span> School <span class="hljs-keyword">struct</span> &#123;<br>SchoolName    <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;school_name&quot; yaml:&quot;school_name&quot;`</span><br>SchoolAddress <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;school_address&quot; json:&quot;school_address&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å®ƒä»¬éƒ½åŠ ä¸Šäº† <code>json</code> å’Œ <code>yaml</code> æ ‡ç­¾ï¼Œå¯¹äº<code>json</code> ç±»å‹ï¼Œä½ å¯ä»¥ç”¨æ ‡å‡†åº“çš„ <code>encoding/json</code>æ¥è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œè€Œ <code>yaml</code> ä½ å¯ä»¥ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ï¼š<ahref="https://github.com/go-yaml/yaml">go-yaml</a>ã€‚</p><p>å…ˆæ¥çœ‹ç³»åˆ—åŒ–ç»“æœï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>p := Person&#123;Name: <span class="hljs-string">&quot;hedon&quot;</span>, Age: <span class="hljs-number">18</span>, School: School&#123;SchoolName: <span class="hljs-string">&quot;nb_school&quot;</span>, SchoolAddress: <span class="hljs-string">&quot;a_good_school_place&quot;</span>&#125;&#125;<br>bs, _ := json.Marshal(p)<br>fmt.Println(<span class="hljs-string">&quot;json:\n&quot;</span>, <span class="hljs-type">string</span>(bs))<br>bs, _ = yaml.Marshal(p)<br>fmt.Println(<span class="hljs-string">&quot;yaml:\n&quot;</span>, <span class="hljs-type">string</span>(bs))<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs tex">json:<br> &#123;&quot;name&quot;:&quot;hedon&quot;,&quot;age&quot;:18,&quot;school<span class="hljs-built_in">_</span>name&quot;:&quot;nb<span class="hljs-built_in">_</span>school&quot;,&quot;school<span class="hljs-built_in">_</span>address&quot;:&quot;a<span class="hljs-built_in">_</span>good<span class="hljs-built_in">_</span>school<span class="hljs-built_in">_</span>place&quot;&#125;<br>yaml:<br> name: hedon<br> age: 18<br> school:<br>    school<span class="hljs-built_in">_</span>name: nb<span class="hljs-built_in">_</span>school<br>    school<span class="hljs-built_in">_</span>address: a<span class="hljs-built_in">_</span>good<span class="hljs-built_in">_</span>school<span class="hljs-built_in">_</span>place<br></code></pre></td></tr></table></figure><p>é€šè¿‡è§‚å¯Ÿä½ å¯ä»¥å‘ç°å“ˆï¼Œåœ¨ <code>json</code> ä¸­ï¼Œç»„åˆçš„æ—¶å€™ï¼ˆæ²¡æœ‰ç»™School åŠ æ ‡ç­¾ï¼‰ç›´æ¥å°† <code>School</code> å¹³é“ºåœ¨ <code>Person</code>ä¸­ï¼Œæ‰€ä»¥åœ¨åºåˆ—åŒ–çš„ç»“æœä¸­ï¼Œæ‰¾ä¸åˆ° <code>"school": &#123;&#125;</code>ã€‚è€Œåœ¨<code>yaml</code> ä¸­ï¼Œå¹¶ä¸æ˜¯ç›´æ¥å¹³é“ºçš„ã€‚</p><p>è¿™ä¸ªåŒºåˆ«åœ¨ä½ è§£æé…ç½®æ–‡ä»¶çš„æ—¶å€™å°¤å…¶é‡è¦ï¼Œå¦‚æœä¸æ³¨æ„ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šå¯¼è‡´é…ç½®è§£æå¤±è´¥ã€‚</p><p>æˆ‘å‡†å¤‡äº† 4 ä¸ªé…ç½®æ–‡ä»¶ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// person1.json</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;hedon_json&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">18</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;school&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;school_name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;nb_json_school&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;school_address&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;a_good_place_in_json&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># person1.yaml</span><br><span class="hljs-attr">name:</span> <span class="hljs-string">&quot;hedon_yaml&quot;</span><br><span class="hljs-attr">age:</span> <span class="hljs-number">18</span><br><span class="hljs-attr">school:</span><br>  <span class="hljs-attr">school_name:</span> <span class="hljs-string">&quot;nb_yaml_school&quot;</span><br>  <span class="hljs-attr">school_address:</span> <span class="hljs-string">&quot;a_good_price_in_yaml&quot;</span><br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// person2.json</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;hedon_json&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">18</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;school_name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;nb_json_school&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;school_address&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;a_good_place_in_json&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># person2.yaml</span><br><span class="hljs-attr">name:</span> <span class="hljs-string">&quot;hedon_yaml&quot;</span><br><span class="hljs-attr">age:</span> <span class="hljs-number">18</span><br><span class="hljs-attr">school_name:</span> <span class="hljs-string">&quot;nb_yaml_school&quot;</span><br><span class="hljs-attr">school_address:</span> <span class="hljs-string">&quot;a_good_price_in_yaml&quot;</span><br></code></pre></td></tr></table></figure><p>è§£æä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>filenames := []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;person1.json&quot;</span>, <span class="hljs-string">&quot;person1.yaml&quot;</span>, <span class="hljs-string">&quot;person2.json&quot;</span>, <span class="hljs-string">&quot;person2.yaml&quot;</span>&#125;<br><span class="hljs-keyword">for</span> i, fn := <span class="hljs-keyword">range</span> filenames &#123;<br>bs := readFileIntoBytes(fn)<br>p := Person&#123;&#125;<br><span class="hljs-keyword">if</span> i%<span class="hljs-number">2</span> == <span class="hljs-number">0</span> &#123;<br>_ = json.Unmarshal(bs, &amp;p)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>_ = yaml.Unmarshal(bs, &amp;p)<br>&#125;<br>fmt.Printf(<span class="hljs-string">&quot;%s -&gt; %v\n&quot;</span>, fn, p)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">readFileIntoBytes</span><span class="hljs-params">(filename <span class="hljs-type">string</span>)</span></span> []<span class="hljs-type">byte</span> &#123;<br>f, err := os.Open(filename)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(err)<br>&#125;<br>bs, _ := io.ReadAll(f)<br><span class="hljs-keyword">return</span> bs<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs tex">person1.json -&gt; &#123;hedon<span class="hljs-built_in">_</span>json 18 &#123; &#125;&#125;<br>person1.yaml -&gt; &#123;hedon<span class="hljs-built_in">_</span>yaml 18 &#123;nb<span class="hljs-built_in">_</span>yaml<span class="hljs-built_in">_</span>school a<span class="hljs-built_in">_</span>good<span class="hljs-built_in">_</span>price<span class="hljs-built_in">_</span>in<span class="hljs-built_in">_</span>yaml&#125;&#125;<br>person2.json -&gt; &#123;hedon<span class="hljs-built_in">_</span>json 18 &#123;nb<span class="hljs-built_in">_</span>json<span class="hljs-built_in">_</span>school a<span class="hljs-built_in">_</span>good<span class="hljs-built_in">_</span>place<span class="hljs-built_in">_</span>in<span class="hljs-built_in">_</span>json&#125;&#125;<br>person2.yaml -&gt; &#123;hedon<span class="hljs-built_in">_</span>yaml 18 &#123; &#125;&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœç»™ <code>School</code> å­—æ®µåŠ ä¸Š <code>json tag</code>çš„è¯ï¼Œç»“æœåˆæ˜¯ä¸åŒï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;<br>Name   <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;name&quot; yaml:&quot;name&quot;`</span><br>Age    <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;age&quot; yaml:&quot;age&quot;`</span><br>School <span class="hljs-string">`json:&quot;school&quot; yaml:&quot;school&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs tex">person1.json -&gt; &#123;hedon<span class="hljs-built_in">_</span>json 18 &#123;nb<span class="hljs-built_in">_</span>json<span class="hljs-built_in">_</span>school a<span class="hljs-built_in">_</span>good<span class="hljs-built_in">_</span>place<span class="hljs-built_in">_</span>in<span class="hljs-built_in">_</span>json&#125;&#125;<br>person1.yaml -&gt; &#123;hedon<span class="hljs-built_in">_</span>yaml 18 &#123;nb<span class="hljs-built_in">_</span>yaml<span class="hljs-built_in">_</span>school a<span class="hljs-built_in">_</span>good<span class="hljs-built_in">_</span>price<span class="hljs-built_in">_</span>in<span class="hljs-built_in">_</span>yaml&#125;&#125;<br>person2.json -&gt; &#123;hedon<span class="hljs-built_in">_</span>json 18 &#123; &#125;&#125;<br>person2.yaml -&gt; &#123;hedon<span class="hljs-built_in">_</span>yaml 18 &#123; &#125;&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å—å½±å“çš„åªæœ‰ <code>json</code>ã€‚</p><p>åˆ°è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ€»ç»“ï¼š<strong>åœ¨ç»„åˆåœºæ™¯ä¸‹ï¼Œå¦‚æœä¸æ˜ç¡®æŒ‡å®š<code>tag</code>ï¼Œ<code>yaml</code> è§£ææœŸæœ›å­—æ®µæ˜¯åµŒå¥—çš„ï¼Œè€Œ<code>json</code> è§£ææœŸæœ›å­—æ®µæ˜¯å¹³é“ºçš„</strong>ã€‚</p><h2 id="è‡ªå®šä¹‰-tag">5.2 è‡ªå®šä¹‰ Tag</h2><p>åœ¨ Goä¸­ï¼Œä½ å¯ä»¥ä¸ºç»“æ„ä½“å­—æ®µå®šä¹‰ä»»æ„çš„æ ‡ç­¾ã€‚è¿™äº›æ ‡ç­¾åœ¨ç¼–è¯‘æ—¶ä¼šè¢«å­˜å‚¨ï¼Œå¹¶ä¸”å¯ä»¥åœ¨è¿è¡Œæ—¶é€šè¿‡åå°„ï¼ˆreflectionï¼‰æ¥è®¿é—®ã€‚</p><p>å‡è®¾æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªåä¸º <code>check</code>çš„æ ‡ç­¾ï¼Œå®ƒç”¨äºæˆ‘ä»¬å¯¹ç»“æ„ä½“å­—æ®µçš„æ£€æŸ¥ï¼Œå‡è®¾æˆ‘ä»¬è¿™ä¸ªæ ‡ç­¾æ”¯æŒä»¥ä¸‹åŠŸèƒ½ï¼š</p><ul><li><code>check:"strnoempty"</code>: å­—ç¬¦ä¸²ä¸å¯ä»¥ä¸ºç©ºã€‚</li></ul><p>å‡å¦‚åŠ å…¥ <code>check</code> æ ‡ç­¾çš„ <code>Person</code>ç»“æ„ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;<br>Name <span class="hljs-type">string</span> <span class="hljs-string">`check:&quot;strnoempty&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥ä¸º <code>check</code> å®ç°è§£æå‡½æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CheckPerson</span><span class="hljs-params">(p Person)</span></span> <span class="hljs-type">error</span> &#123;<br>pt := reflect.TypeOf(p)<br>pv := reflect.ValueOf(p)<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; pt.NumField(); i++ &#123;<br>field := pt.Field(i)<br>tagValue := field.Tag.Get(<span class="hljs-string">&quot;check&quot;</span>)<br><span class="hljs-keyword">if</span> tagValue == <span class="hljs-string">&quot;&quot;</span> &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><span class="hljs-keyword">if</span> field.Type.Kind() == reflect.String &amp;&amp; tagValue == <span class="hljs-string">&quot;strnoempty&quot;</span> &#123;<br><span class="hljs-keyword">if</span> err := checkStrNoEmpty(field.Name, pv.Field(i).Interface()); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> err<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">checkStrNoEmpty</span><span class="hljs-params">(fieldName <span class="hljs-type">string</span>, v any)</span></span> <span class="hljs-type">error</span> &#123;<br>s, ok := v.(<span class="hljs-type">string</span>)<br><span class="hljs-keyword">if</span> !ok &#123;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;%v is not string&quot;</span>, v)<br>&#125;<br><span class="hljs-keyword">if</span> s == <span class="hljs-string">&quot;&quot;</span> &#123;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;[check] %s should not be empty&quot;</span>, fieldName)<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æµ‹è¯•å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>p1 := Person&#123;&#125;<br>p2 := Person&#123;Name: <span class="hljs-string">&quot;hedon&quot;</span>&#125;<br>fmt.Println(CheckPerson(p1)) <span class="hljs-comment">// [check] Name should not be empty</span><br>fmt.Println(CheckPerson(p2)) <span class="hljs-comment">// &lt;nil&gt;</span><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="ç»“æ„ä½“å†…å­˜å¯¹é½">6. ç»“æ„ä½“å†…å­˜å¯¹é½</h1><p>åœ¨æœ¬å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†æ¢è®¨ Go è¯­è¨€ç»“æ„ä½“çš„å†…å­˜ç»“æ„å’Œå¯¹é½ç­–ç•¥ã€‚</p><h2 id="é—®é¢˜å¼•å‡º">6.1 é—®é¢˜å¼•å‡º</h2><p>æ€è€ƒä¸‹é¢è¿™æ®µä»£ç çš„è¾“å‡ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> S1 <span class="hljs-keyword">struct</span> &#123;<br>num2 <span class="hljs-type">int8</span><br>num1 <span class="hljs-type">int16</span><br>flag <span class="hljs-type">bool</span><br>&#125;<br><br><span class="hljs-keyword">type</span> S2 <span class="hljs-keyword">struct</span> &#123;<br>num1 <span class="hljs-type">int8</span><br>flag <span class="hljs-type">bool</span><br>num2 <span class="hljs-type">int16</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(unsafe.Sizeof(S1&#123;&#125;))<br>fmt.Println(unsafe.Sizeof(S2&#123;&#125;))<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆä»…æ˜¯å­—æ®µé¡ºåºä¸åŒï¼Œ<code>S1&#123;&#125;</code> å’Œ <code>S2&#123;&#125;</code>çš„å¤§å°å°±ä¸ä¸€æ ·äº†ï¼Ÿ</p><p>æˆ‘ä»¬å¯ä»¥å†™ä¸ªç®€å•çš„ç¨‹åºæ¥è¾“å‡º <code>S1</code> å’Œ <code>S2</code>çš„å†…å­˜ç»“æ„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>s1 := S1&#123;&#125;<br>s2 := S2&#123;&#125;<br>fmt.Print(<span class="hljs-string">&quot;s1: &quot;</span>)<br>printMemory(s1)<br>fmt.Print(<span class="hljs-string">&quot;s2: &quot;</span>)<br>printMemory(s2)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">printMemory</span><span class="hljs-params">(a any)</span></span> &#123;<br>t := reflect.TypeOf(a)<br>mem := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-type">int</span>(t.Size()))<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; t.NumField(); i++ &#123;<br>field := t.Field(i)<br>offset := <span class="hljs-type">int</span>(field.Offset)<br>size := <span class="hljs-type">int</span>(field.Type.Size())<br><span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; size; j++ &#123;<br>mem[j+offset] = i + <span class="hljs-number">1</span><br>&#125;<br>&#125;<br>fmt.Println(mem)<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">s1: [<span class="hljs-number">1</span> <span class="hljs-number">0</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">0</span>]<br>s2: [<span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span>]<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>1</code>ã€<code>2</code>ã€<code>3</code>åˆ†åˆ«æ›¿ä»£ç»“æ„ä½“ä¸­çš„ç¬¬ 1/2/3 ä¸ªå­—æ®µæ‰€å ç”¨çš„å†…å­˜ã€‚è¿™é‡Œå¯ä»¥çœ‹åˆ°<code>s1</code> çš„é•¿åº¦æ˜¯ 6 å­—èŠ‚ï¼Œè€Œ <code>s2</code> æ˜¯ 4 å­—èŠ‚ã€‚è¿™é‡Œ<code>s1</code> æ¯” <code>s2</code> å¤šå‡ºçš„ 2 ä¸ªå­—èŠ‚å°±æ˜¯è¿™ä¸¤ä¸ªå¡«å……çš„<code>0</code>ã€‚è¿™è€Œ 2ä¸ªå­—èŠ‚çš„å¡«å……ï¼Œå°±æ˜¯ä¸ºäº†<strong>å†…å­˜å¯¹é½</strong>ã€‚</p><h2 id="å†…å­˜å¯¹é½">6.2 å†…å­˜å¯¹é½</h2><p>å¦‚ä¸Šåˆ†æï¼Œ<code>s1</code> çš„å†…å­˜ç»“æ„å¦‚ä¸‹ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240310154903219.png"alt="s1 å†…å­˜ç»“æ„" /><figcaption aria-hidden="true">s1 å†…å­˜ç»“æ„</figcaption></figure><p>å¦‚æœæ²¡æœ‰å†…å­˜å¯¹é½å‘¢ï¼Ÿ<code>s1</code> çš„ç»“æ„å¯èƒ½å¦‚ä¸‹ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240310155353882.png"alt="æ²¡æœ‰å†…å­˜å¯¹é½çš„ s1 å†…å­˜ç»“æ„" /><figcaption aria-hidden="true">æ²¡æœ‰å†…å­˜å¯¹é½çš„ s1 å†…å­˜ç»“æ„</figcaption></figure><p>å¦‚æœæ˜¯ 16 ä½ç³»ç»Ÿçš„è¯ï¼Œé‚£ä¹ˆæ²¡æœ‰å†…å­˜å¯¹é½çš„æƒ…å†µä¸‹ï¼Œè¦è®¿é—®<code>s1.num2</code> å­—æ®µï¼Œå°±éœ€è¦è·¨è¿‡ 2ä¸ªç³»ç»Ÿå­—é•¿çš„å†…å­˜ï¼Œæ•ˆç‡å°±ä½äº†ã€‚å…·ä½“æ¥è¯´ï¼Œå†…å­˜å¯¹é½æ˜¯è®¡ç®—æœºå†…å­˜åˆ†é…çš„ä¸€ç§ä¼˜åŒ–æ–¹å¼ï¼Œç”¨äºç¡®ä¿æ•°æ®ç»“æ„çš„å­˜å‚¨æŒ‰ç…§ç‰¹å®šçš„å­—èŠ‚è¾¹ç•Œå¯¹é½ã€‚è¿™ç§å¯¹é½æ˜¯ä¸ºäº†æé«˜è®¡ç®—æœºå¤„ç†æ•°æ®çš„æ•ˆç‡ã€‚</p><h2 id="å¯¹é½ç³»æ•°">6.3 å¯¹é½ç³»æ•°</h2><ul><li>å¯¹é½ç³»æ•°ï¼šå˜é‡çš„å†…å­˜åœ°å€å¿…é¡»è¢«å¯¹é½ç³»æ•°æ•´é™¤ã€‚</li><li><code>unsafe.Alignof()</code>: å¯ä»¥æŸ¥çœ‹å€¼åœ¨å†…å­˜ä¸­çš„å¯¹é½ç³»æ•°ã€‚</li></ul><h2 id="åŸºæœ¬ç±»å‹å¯¹é½">6.4 åŸºæœ¬ç±»å‹å¯¹é½</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">fmt.Printf(<span class="hljs-string">&quot;bool size: %d, align: %d\n&quot;</span>, unsafe.Sizeof(<span class="hljs-type">bool</span>(<span class="hljs-literal">true</span>)), unsafe.Alignof(<span class="hljs-type">bool</span>(<span class="hljs-literal">true</span>)))<br>fmt.Printf(<span class="hljs-string">&quot;byte size: %d, align: %d\n&quot;</span>, unsafe.Sizeof(<span class="hljs-type">byte</span>(<span class="hljs-number">0</span>)), unsafe.Alignof(<span class="hljs-type">byte</span>(<span class="hljs-number">0</span>)))<br>fmt.Printf(<span class="hljs-string">&quot;int8 size: %d, align: %d\n&quot;</span>, unsafe.Sizeof(<span class="hljs-type">int8</span>(<span class="hljs-number">0</span>)), unsafe.Alignof(<span class="hljs-type">int8</span>(<span class="hljs-number">0</span>)))<br>fmt.Printf(<span class="hljs-string">&quot;int16 size: %d, align: %d\n&quot;</span>, unsafe.Sizeof(<span class="hljs-type">int16</span>(<span class="hljs-number">0</span>)), unsafe.Alignof(<span class="hljs-type">int16</span>(<span class="hljs-number">0</span>)))<br>fmt.Printf(<span class="hljs-string">&quot;int32 size: %d, align: %d\n&quot;</span>, unsafe.Sizeof(<span class="hljs-type">int32</span>(<span class="hljs-number">0</span>)), unsafe.Alignof(<span class="hljs-type">int32</span>(<span class="hljs-number">0</span>)))<br>fmt.Printf(<span class="hljs-string">&quot;int64 size: %d, align: %d\n&quot;</span>, unsafe.Sizeof(<span class="hljs-type">int64</span>(<span class="hljs-number">0</span>)), unsafe.Alignof(<span class="hljs-type">int64</span>(<span class="hljs-number">0</span>)))<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-type">bool</span> size: <span class="hljs-number">1</span>, align: <span class="hljs-number">1</span><br><span class="hljs-type">byte</span> size: <span class="hljs-number">1</span>, align: <span class="hljs-number">1</span><br><span class="hljs-type">int8</span> size: <span class="hljs-number">1</span>, align: <span class="hljs-number">1</span><br><span class="hljs-type">int16</span> size: <span class="hljs-number">2</span>, align: <span class="hljs-number">2</span><br><span class="hljs-type">int32</span> size: <span class="hljs-number">4</span>, align: <span class="hljs-number">4</span><br><span class="hljs-type">int64</span> size: <span class="hljs-number">8</span>, align: <span class="hljs-number">8</span><br></code></pre></td></tr></table></figure><p>ç»“è®ºï¼šåŸºæœ¬ç±»å‹çš„å¯¹é½ç³»æ•°è·Ÿå®ƒçš„é•¿åº¦ä¸€è‡´ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240310160412598.png"alt="åŸºæœ¬ç±»å‹å†…å­˜å¯¹é½" /><figcaption aria-hidden="true">åŸºæœ¬ç±»å‹å†…å­˜å¯¹é½</figcaption></figure><h2 id="ç»“æ„ä½“å†…éƒ¨å¯¹é½">6.5 ç»“æ„ä½“å†…éƒ¨å¯¹é½</h2><p>ç»“æ„ä½“å†…å­˜å¯¹é½åˆ†ä¸ºå†…éƒ¨å¯¹é½å’Œç»“æ„ä½“ä¹‹é—´å¯¹é½ã€‚</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹ç»“æ„ä½“å†…éƒ¨å¯¹é½ï¼š</p><ul><li>æŒ‡çš„æ˜¯ç»“æ„ä½“å†…éƒ¨æˆå‘˜çš„ç›¸å¯¹ä½ç½®ï¼ˆåç§»é‡ï¼‰ï¼›</li><li>æ¯ä¸ªæˆå‘˜çš„åç§»é‡æ˜¯ <strong>è‡ªèº«å¤§å°</strong> å’Œ<strong>å¯¹é½ç³»æ•°</strong> çš„è¾ƒå°å€¼çš„å€æ•°</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Demo <span class="hljs-keyword">struct</span> &#123;<br>  a <span class="hljs-type">bool</span><br>  b <span class="hljs-type">string</span><br>  c <span class="hljs-type">int16</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å‡å¦‚æˆ‘ä»¬å®šä¹‰äº†ä¸Šé¢çš„ç»“æ„ä½“ <code>Demo</code>ï¼Œå¦‚æœåœ¨ 64ä½ç³»ç»Ÿä¸Šï¼ˆå­—é•¿ä¸º 8 å­—èŠ‚ï¼‰é€šè¿‡ä¸Šé¢çš„è§„åˆ™ï¼Œå¯ä»¥åˆ¤æ–­å‡ºï¼šï¼ˆå•ä½ä¸ºå­—èŠ‚ï¼‰</p><ul><li>a: size=1, align=1</li><li>b: size=16, align=8</li><li>c: size=2, align=2</li></ul><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240310163126556.png"alt="Demo å†…å­˜ç»“æ„" /><figcaption aria-hidden="true">Demo å†…å­˜ç»“æ„</figcaption></figure><p>å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ç¨‹åºè¾“å‡ºæ¥éªŒè¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Demo <span class="hljs-keyword">struct</span> &#123;<br>a <span class="hljs-type">bool</span>   <span class="hljs-comment">// size=1, align=1</span><br>b <span class="hljs-type">string</span> <span class="hljs-comment">// size=16, align=8</span><br>c <span class="hljs-type">int16</span>  <span class="hljs-comment">// size=2, align=2</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>d := Demo&#123;&#125;<br>fmt.Printf(<span class="hljs-string">&quot;a: size=%d, align=%d\n&quot;</span>, unsafe.Sizeof(d.a), unsafe.Alignof(d.a))<br>fmt.Printf(<span class="hljs-string">&quot;b: size=%d, align=%d\n&quot;</span>, unsafe.Sizeof(d.b), unsafe.Alignof(d.b))<br>fmt.Printf(<span class="hljs-string">&quot;c: size=%d, align=%d\n&quot;</span>, unsafe.Sizeof(d.c), unsafe.Alignof(d.c))<br>printMemory(d)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">printMemory</span><span class="hljs-params">(a any)</span></span> &#123;<br>t := reflect.TypeOf(a)<br>mem := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-type">int</span>(t.Size()))<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; t.NumField(); i++ &#123;<br>field := t.Field(i)<br>offset := <span class="hljs-type">int</span>(field.Offset)<br>size := <span class="hljs-type">int</span>(field.Type.Size())<br><span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; size; j++ &#123;<br>mem[j+offset] = i + <span class="hljs-number">1</span><br>&#125;<br>&#125;<br>fmt.Println(mem)<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go">a: size=<span class="hljs-number">1</span>, align=<span class="hljs-number">1</span><br>b: size=<span class="hljs-number">16</span>, align=<span class="hljs-number">8</span><br>c: size=<span class="hljs-number">2</span>, align=<span class="hljs-number">2</span><br>[<span class="hljs-number">1</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span>]<br></code></pre></td></tr></table></figure><h2 id="ç»“æ„ä½“é•¿åº¦å¡«å……">6.6 ç»“æ„ä½“é•¿åº¦å¡«å……</h2><p>ä¸Šé¢ Demo ç»“æ„ä½“æœ€åè¿˜å¡«äº† 6 ä¸ªå­—èŠ‚çš„ 0ï¼Œè¿™å°±æ˜¯ç»“æ„ä½“é•¿åº¦å¡«å……ï¼š</p><ul><li>ç»“æ„ä½“é€šè¿‡å¡«å……é•¿åº¦ï¼Œæ¥å¯¹é½ç³»ç»Ÿå­—é•¿ã€‚</li><li>ç»“æ„ä½“é•¿åº¦æ˜¯ <strong>æœ€å¤§æˆå‘˜é•¿åº¦</strong> å’Œ<strong>ç³»ç»Ÿå­—é•¿</strong> è¾ƒå°å€¼çš„æ•´æ•°å€ã€‚</li></ul><p>æˆ‘çš„ç³»ç»Ÿç¯å¢ƒæ˜¯ m2maxï¼Œç³»ç»Ÿå­—é•¿æ˜¯ 8 å­—èŠ‚ï¼ŒDemo æœ€å¤§æˆå‘˜é•¿åº¦æ˜¯<code>b string</code>ï¼Œå³ 16 ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥ <code>Demo</code> çš„é•¿åº¦åº”è¯¥æ˜¯<code>8</code> çš„å€æ•°ï¼Œæ‰€ä»¥æœ€åå¡«å……äº† 6 ä¸ªå­—èŠ‚çš„ 0ã€‚</p><h2 id="ç»“æ„ä½“ä¹‹é—´å¯¹é½">6.7 ç»“æ„ä½“ä¹‹é—´å¯¹é½</h2><ul><li>ç»“æ„ä½“ä¹‹é—´å¯¹é½ï¼Œæ˜¯ä¸ºäº†ç¡®å®šç»“æ„ä½“çš„ç¬¬ä¸€ä¸ªæˆå‘˜å˜é‡çš„å†…å­˜åœ°å€ï¼Œä»¥è®©åé¢çš„æˆå‘˜åœ°å€éƒ½åˆæ³•ã€‚</li><li>ç»“æ„ä½“çš„å¯¹é½ç³»æ•°æ˜¯ <strong>å…¶æˆå‘˜çš„æœ€å¤§å¯¹é½ç³»æ•°</strong>ï¼›</li></ul><h2 id="ç©ºç»“æ„ä½“å¯¹é½">6.8 ç©ºç»“æ„ä½“å¯¹é½</h2><p>å‰é¢æˆ‘ä»¬ä¸“é—¨è®¨è®ºäº†ç©ºç»“æ„ä½“<code>struct&#123;&#125;</code>ï¼Œå®ƒä»¬çš„å†…å­˜åœ°å€ç»Ÿä¸€æŒ‡å‘<code>zerobase</code>ï¼Œè€Œä¸”å†…å­˜é•¿åº¦ä¸º0ã€‚è¿™ä¹Ÿå¯¼è‡´äº†å®ƒçš„å†…å­˜å¯¹é½è§„åˆ™ï¼Œæœ‰ä¸€äº›ä¸åŒã€‚å…·ä½“å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ 4ä¸ªæƒ…å†µã€‚</p><h3 id="ç©ºç»“æ„ä½“å•ç‹¬å­˜åœ¨">6.8.1 ç©ºç»“æ„ä½“å•ç‹¬å­˜åœ¨</h3><p>ç©ºç»“æ„ä½“å•ç‹¬å­˜åœ¨æ—¶ï¼Œå…¶å†…å­˜åœ°å€ä¸º<code>zerobase</code>ï¼Œä¸é¢å¤–åˆ†é…å†…å­˜ã€‚</p><h3 id="ç©ºç»“æ„ä½“åœ¨ç»“æ„ä½“æœ€å‰">6.8.2 ç©ºç»“æ„ä½“åœ¨ç»“æ„ä½“æœ€å‰</h3><p>ç©ºç»“æ„ä½“æ˜¯ç»“æ„ä½“ç¬¬ä¸€ä¸ªå­—æ®µæ—¶ï¼Œå®ƒçš„åœ°å€è·Ÿç»“æ„ä½“æœ¬èº«åŠç»“æ„ä½“ç¬¬ 2ä¸ªå­—æ®µä¸€æ ·ï¼Œä¸å æ®å†…å­˜ç©ºé—´ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> TestEmpty <span class="hljs-keyword">struct</span> &#123;<br>empty <span class="hljs-keyword">struct</span>&#123;&#125;<br>a     <span class="hljs-type">bool</span><br>b     <span class="hljs-type">string</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>te := TestEmpty&#123;&#125;<br>fmt.Printf(<span class="hljs-string">&quot;address of te: %p\n&quot;</span>, &amp;te)<br>fmt.Printf(<span class="hljs-string">&quot;address of te.empty: %p\n&quot;</span>, &amp;(te.empty))<br>fmt.Printf(<span class="hljs-string">&quot;address of te.a: %p\n&quot;</span>, &amp;(te.a))<br>fmt.Printf(<span class="hljs-string">&quot;empty: size=%d, align=%d\n&quot;</span>, unsafe.Sizeof(te.empty), unsafe.Alignof(te.empty))<br>fmt.Printf(<span class="hljs-string">&quot;a: size=%d, align=%d\n&quot;</span>, unsafe.Sizeof(te.a), unsafe.Alignof(te.a))<br>fmt.Printf(<span class="hljs-string">&quot;b: size=%d, align=%d\n&quot;</span>, unsafe.Sizeof(te.b), unsafe.Alignof(te.b))<br>printMemory(te)<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">address of te: <span class="hljs-number">0x140000ba000</span><br>address of te.empty: <span class="hljs-number">0x140000ba000</span><br>address of te.a: <span class="hljs-number">0x140000ba000</span><br>empty: size=<span class="hljs-number">0</span>, align=<span class="hljs-number">1</span><br>a: size=<span class="hljs-number">1</span>, align=<span class="hljs-number">1</span><br>b: size=<span class="hljs-number">16</span>, align=<span class="hljs-number">8</span><br>[<span class="hljs-number">2</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span>]<br></code></pre></td></tr></table></figure><h3 id="ç©ºç»“æ„ä½“åœ¨ç»“æ„ä½“ä¸­é—´">6.8.3 ç©ºç»“æ„ä½“åœ¨ç»“æ„ä½“ä¸­é—´</h3><p>ç©ºç»“æ„ä½“å‡ºç°åœ¨ç»“æ„ä½“ä¸­æ—¶ï¼Œåœ°å€è·Ÿéšå‰ä¸€ä¸ªå˜é‡ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240310165025700.png"alt="ç©ºç»“æ„ä½“åœ¨ç»“æ„ä½“ä¸­é—´å†…å­˜å¯¹é½" /><figcaption aria-hidden="true">ç©ºç»“æ„ä½“åœ¨ç»“æ„ä½“ä¸­é—´å†…å­˜å¯¹é½</figcaption></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> TestEmpty <span class="hljs-keyword">struct</span> &#123;<br>a     <span class="hljs-type">bool</span><br>empty <span class="hljs-keyword">struct</span>&#123;&#125;<br>b     <span class="hljs-type">string</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>te := TestEmpty&#123;&#125;<br>fmt.Printf(<span class="hljs-string">&quot;address of te: %p\n&quot;</span>, &amp;te)<br>fmt.Printf(<span class="hljs-string">&quot;address of te.a: %p\n&quot;</span>, &amp;(te.a))<br>fmt.Printf(<span class="hljs-string">&quot;address of te.empty: %p\n&quot;</span>, &amp;(te.empty))<br>fmt.Printf(<span class="hljs-string">&quot;a: size=%d, align=%d\n&quot;</span>, unsafe.Sizeof(te.a), unsafe.Alignof(te.a))<br>fmt.Printf(<span class="hljs-string">&quot;empty: size=%d, align=%d\n&quot;</span>, unsafe.Sizeof(te.empty), unsafe.Alignof(te.empty))<br>fmt.Printf(<span class="hljs-string">&quot;b: size=%d, align=%d\n&quot;</span>, unsafe.Sizeof(te.b), unsafe.Alignof(te.b))<br>printMemory(te)<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">address of te: <span class="hljs-number">0x14000128000</span><br>address of te.a: <span class="hljs-number">0x14000128000</span><br>address of te.empty: <span class="hljs-number">0x14000128001</span><br>a: size=<span class="hljs-number">1</span>, align=<span class="hljs-number">1</span><br>empty: size=<span class="hljs-number">0</span>, align=<span class="hljs-number">1</span><br>b: size=<span class="hljs-number">16</span>, align=<span class="hljs-number">8</span><br>[<span class="hljs-number">1</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span> <span class="hljs-number">3</span>]<br></code></pre></td></tr></table></figure><h3 id="ç©ºç»“æ„ä½“åœ¨ç»“æ„ä½“æœ€å">6.8.4 ç©ºç»“æ„ä½“åœ¨ç»“æ„ä½“æœ€å</h3><p>ç©ºç»“æ„ä½“å‡ºç°åœ¨ç»“æ„ä½“æœ€åï¼Œå¦‚æœå¼€å¯äº†ä¸€ä¸ªæ–°çš„ç³»ç»Ÿå­—é•¿ï¼Œåˆ™éœ€è¦è¡¥é›¶ï¼Œé˜²æ­¢ä¸å…¶ä»–ç»“æ„ä½“æ··ç”¨åœ°å€ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240310164933867.png"alt="ç©ºç»“æ„ä½“åœ¨ç»“æ„ä½“æœ€åå†…å­˜å¯¹é½" /><figcaption aria-hidden="true">ç©ºç»“æ„ä½“åœ¨ç»“æ„ä½“æœ€åå†…å­˜å¯¹é½</figcaption></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> TestEmpty <span class="hljs-keyword">struct</span> &#123;<br>a     <span class="hljs-type">bool</span><br>b     <span class="hljs-type">string</span><br>empty <span class="hljs-keyword">struct</span>&#123;&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>te := TestEmpty&#123;&#125;<br>fmt.Printf(<span class="hljs-string">&quot;address of te: %p\n&quot;</span>, &amp;te)<br>fmt.Printf(<span class="hljs-string">&quot;address of te.a: %p\n&quot;</span>, &amp;(te.a))<br>fmt.Printf(<span class="hljs-string">&quot;address of te.empty: %p\n&quot;</span>, &amp;(te.empty))<br>fmt.Printf(<span class="hljs-string">&quot;a: size=%d, align=%d\n&quot;</span>, unsafe.Sizeof(te.a), unsafe.Alignof(te.a))<br>fmt.Printf(<span class="hljs-string">&quot;b: size=%d, align=%d\n&quot;</span>, unsafe.Sizeof(te.b), unsafe.Alignof(te.b))<br>fmt.Printf(<span class="hljs-string">&quot;empty: size=%d, align=%d\n&quot;</span>, unsafe.Sizeof(te.empty), unsafe.Alignof(te.empty))<br>printMemory(te)<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">address of te: <span class="hljs-number">0x1400006a020</span><br>address of te.a: <span class="hljs-number">0x1400006a020</span><br>address of te.empty: <span class="hljs-number">0x1400006a038</span><br>a: size=<span class="hljs-number">1</span>, align=<span class="hljs-number">1</span><br>b: size=<span class="hljs-number">16</span>, align=<span class="hljs-number">8</span><br>empty: size=<span class="hljs-number">0</span>, align=<span class="hljs-number">1</span><br>[<span class="hljs-number">1</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span>]<br></code></pre></td></tr></table></figure><h2 id="ä½¿ç”¨-fieldalignment--fix-å·¥å…·ä¼˜åŒ–ç»“æ„ä½“å†…å­˜å¯¹é½">6.9 ä½¿ç”¨fieldalignment -fix å·¥å…·ä¼˜åŒ–ç»“æ„ä½“å†…å­˜å¯¹é½</h2><p>è¿˜è®°å¾—æˆ‘ä»¬æœ€å¼€å§‹æå‡ºçš„é—®é¢˜å—ï¼Ÿ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> S1 <span class="hljs-keyword">struct</span> &#123;<br>num2 <span class="hljs-type">int8</span><br>num1 <span class="hljs-type">int16</span><br>flag <span class="hljs-type">bool</span><br>&#125;<br><br><span class="hljs-keyword">type</span> S2 <span class="hljs-keyword">struct</span> &#123;<br>num1 <span class="hljs-type">int8</span><br>flag <span class="hljs-type">bool</span><br>num2 <span class="hljs-type">int16</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(unsafe.Sizeof(S1&#123;&#125;))<br>fmt.Println(unsafe.Sizeof(S2&#123;&#125;))<br>&#125;<br></code></pre></td></tr></table></figure><p><code>S1</code> å’Œ <code>S2</code> æä¾›çš„ç¨‹åºåŠŸèƒ½æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯<code>S1</code> å´æ¯” <code>S2</code>èŠ±è´¹äº†æ›´å¤šçš„å†…å­˜ç©ºé—´ã€‚æ‰€ä»¥æœ‰æ—¶å€™æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»…ä»…è°ƒæ•´ç»“æ„ä½“å†…éƒ¨å­—æ®µçš„é¡ºåºå°±å‡å°‘ä¸å°‘çš„å†…å­˜ç©ºé—´æ¶ˆè€—ã€‚åœ¨è¿™ä¸ªæ—¶å€™<code>fieldalignment</code> å¯ä»¥å¸®åŠ©æˆ‘ä»¬è‡ªåŠ¨æ£€æµ‹å¹¶ä¼˜åŒ–ã€‚</p><p>ä½ å¯ä»¥è¿è¡Œä¸‹é¢å‘½ä»¤å®‰è£… <code>fieldalignment</code> å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go install golang.org/x/tools/go/analysis/passes/fieldalignment/cmd/fieldalignment@latest<br></code></pre></td></tr></table></figure><p>ç„¶ååœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹è¿è¡Œä¸‹é¢å‘½ä»¤ï¼Œå¯¹æˆ‘ä»¬çš„ä»£ç è¿›è¡Œæ£€æŸ¥ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go vet -vettool=$(<span class="hljs-built_in">which</span> fieldalignment) ./...<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä¼šè¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./main.go:9:9: struct of size 6 could be 4<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™å¯ä»¥æ‰§è¡Œ <code>fieldalignment -fix ç›®å½•|æ–‡ä»¶</code>ï¼Œå®ƒä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬çš„ä»£ç è¿›è¡Œä¿®å¤ï¼Œä½†æ˜¯<strong>å¼ºçƒˆå»ºè®®ä½ åœ¨è¿è¡Œä¹‹å‰ï¼Œå¤‡ä»½ä½ çš„ä»£ç ï¼Œå› ä¸ºæ³¨é‡Šä¼šè¢«åˆ é™¤ï¼</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">fieldalignment -fix ./...<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">/Users/hedon/GolandProjects/learn-<span class="hljs-keyword">go</span>-<span class="hljs-keyword">struct</span>/main.<span class="hljs-keyword">go</span>:<span class="hljs-number">9</span>:<span class="hljs-number">9</span>: <span class="hljs-keyword">struct</span> of size <span class="hljs-number">6</span> could be <span class="hljs-number">4</span><br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™ <code>S1</code> å·²ç»è¢«ä¼˜åŒ–å¥½äº†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> S1 <span class="hljs-keyword">struct</span> &#123;<br>num1 <span class="hljs-type">int16</span><br>num2 <span class="hljs-type">int8</span><br>flag <span class="hljs-type">bool</span><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Rust å®æˆ˜ä¸¨HTTPie</title>
    <link href="/2024/03/06/rust-action-httpie/"/>
    <url>/2024/03/06/rust-action-httpie/</url>
    
    <content type="html"><![CDATA[<h1 id="æ¦‚è¿°">æ¦‚è¿°</h1><p>ä¹‹å‰å­¦ä¹ è¿‡ã€Šé™ˆå¤©Â·Rust ç¼–ç¨‹ç¬¬ä¸€è¯¾ - 04ï½œget hands dirtyï¼šæ¥å†™ä¸ªå®ç”¨çš„CLI å°å·¥å…·ã€‹ï¼Œå­¦çš„æ—¶å€™è¿·è¿·ç³Šç³Šã€‚åæ¥åœ¨ç³»ç»Ÿå­¦ä¹ å®Œ Ruståï¼Œé‡æ–°å›è¿‡å¤´æ¥çœ‹è¿™ä¸ªå®æˆ˜å°æ¡ˆä¾‹ï¼ŒåŸºæœ¬ä¸Šéƒ½èƒ½æŒæ¡ï¼Œå¹¶ä¸”æœ‰äº†ä¸€äº›æ–°çš„ç†è§£ã€‚æ‰€ä»¥æˆ‘å†³å®šä»¥ä¸€ä¸ªRust åˆå­¦è€…çš„è§’åº¦ï¼Œå¹¶ä»¥æœ€æ–°ç‰ˆæœ¬çš„ Rustï¼ˆ1.7.6ï¼‰å’Œclapï¼ˆ4.5.1ï¼‰æ¥é‡æ–°å®ç°è¿™ä¸ªæ¡ˆä¾‹ï¼ŒæœŸæœ›èƒ½å¯¹ Rustæ„Ÿå…´è¶£çš„åˆå­¦è€…æä¾›ä¸€äº›å¸®åŠ©ã€‚</p><p>æœ¬æ–‡å°†å®ç°çš„åº”ç”¨å« HTTPieï¼ŒHTTPie æ˜¯ä¸€ä¸ªç”¨ Python ç¼–å†™çš„å‘½ä»¤è¡Œ HTTPå®¢æˆ·ç«¯ï¼Œå…¶ç›®æ ‡æ˜¯ä½¿ CLI ä¸ web æœåŠ¡çš„äº¤äº’å°½å¯èƒ½æ„‰å¿«ã€‚å®ƒè¢«è®¾è®¡ä¸ºä¸€ä¸ª<code>curl</code> å’Œ <code>wget</code>çš„æ›¿ä»£å“ï¼Œæä¾›æ˜“äºä½¿ç”¨çš„ç•Œé¢å’Œä¸€äº›ç”¨æˆ·å‹å¥½çš„åŠŸèƒ½ï¼Œå¦‚ JSONæ”¯æŒã€è¯­æ³•é«˜äº®å’Œæ’ä»¶ã€‚å®ƒå¯¹äºæµ‹è¯•ã€è°ƒè¯•å’Œé€šå¸¸ä¸ HTTP æœåŠ¡å™¨æˆ– RESTful APIè¿›è¡Œäº¤äº‘çš„å¼€å‘äººå‘˜æ¥è¯´éå¸¸æœ‰ç”¨ã€‚</p><p>HTTPie çš„ä¸€äº›å…³é”®ç‰¹æ€§åŒ…æ‹¬ï¼š</p><ol type="1"><li><strong>JSON æ”¯æŒ</strong>ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼ŒHTTPie ä¼šè‡ªåŠ¨å‘é€JSONï¼Œå¹¶ä¸”å¯ä»¥è½»æ¾åœ°é€šè¿‡å‘½ä»¤è¡Œå‘é€ JSON è¯·æ±‚ä½“ã€‚</li><li><strong>è¯­æ³•é«˜äº®</strong>ï¼šå®ƒä¼šä¸º HTTPå“åº”è¾“å‡ºæä¾›è¯­æ³•é«˜äº®æ˜¾ç¤ºï¼Œä½¿å¾—ç»“æœæ›´åŠ æ˜“äºé˜…è¯»ã€‚</li><li><strong>æ’ä»¶</strong>ï¼šHTTPie æ”¯æŒæ’ä»¶ï¼Œå…è®¸æ‰©å±•å…¶æ ¸å¿ƒåŠŸèƒ½ã€‚</li><li><strong>è¡¨å•å’Œæ–‡ä»¶ä¸Šä¼ </strong>ï¼šå¯ä»¥å¾ˆå®¹æ˜“åœ°é€šè¿‡è¡¨å•ä¸Šä¼ æ–‡ä»¶ã€‚</li><li><strong>è‡ªå®šä¹‰ HTTP æ–¹æ³•å’Œå¤´éƒ¨</strong>ï¼šå¯ä»¥å‘é€ä»»ä½• HTTPæ–¹æ³•çš„è¯·æ±‚ï¼Œè‡ªå®šä¹‰è¯·æ±‚å¤´éƒ¨ã€‚</li><li><strong>HTTPSã€ä»£ç†å’Œèº«ä»½éªŒè¯æ”¯æŒ</strong>ï¼šæ”¯æŒ HTTPSè¯·æ±‚ã€ä½¿ç”¨ä»£ç†ä»¥åŠå¤šç§ HTTP èº«ä»½éªŒè¯æœºåˆ¶ã€‚</li><li><strong>æµå¼ä¸Šä¼ å’Œä¸‹è½½</strong>ï¼šæ”¯æŒå¤§æ–‡ä»¶çš„æµå¼ä¸Šä¼ å’Œä¸‹è½½ã€‚</li><li><strong>ä¼šè¯æ”¯æŒ</strong>ï¼šå¯ä»¥ä¿å­˜å’Œé‡ç”¨å¸¸ç”¨çš„è¯·æ±‚å’Œé›†åˆã€‚</li></ol><p>æœ¬æ–‡æˆ‘ä»¬å°†å®ç°å…¶ä¸­çš„ <code>1</code>ã€<code>2</code> å’Œ<code>5</code>ã€‚æˆ‘ä»¬ä¼šæ”¯æŒå‘é€ GET å’Œ POST è¯·æ±‚ï¼Œå…¶ä¸­ POSTæ”¯æŒè®¾ç½®è¯·æ±‚å¤´å’Œ JSON æ•°æ®ã€‚</p><p>åœ¨æœ¬æ–‡ä¸­ï¼Œä½ å¯ä»¥å­¦ä¹ åˆ°ï¼š</p><ul><li>å¦‚ä½•ç”¨ <code>clap</code> è§£æå‘½ä»¤è¡Œå‚æ•°ã€‚</li><li>å¦‚ä½•ç”¨ <code>tokio</code> è¿›è¡Œå¼‚æ­¥ç¼–ç¨‹ã€‚</li><li>å¦‚ä½•ç”¨ <code>reqwest</code> å‘é€ HTTP è¯·æ±‚ã€‚</li><li>å¦‚ä½•ç”¨ <code>colored</code> åœ¨ç»ˆç«¯è¾“å‡ºå¸¦é¢œè‰²çš„å†…å®¹ã€‚</li><li>å¦‚ä½•ç”¨ <code>jsonxf</code> ç¾åŒ– json å­—ç¬¦ä¸²ã€‚</li><li>å¦‚ä½•ç”¨ <code>anyhow</code> é…åˆ <code>?</code> è¿›è¡Œé”™è¯¯ä¼ æ’­ã€‚</li><li>å¦‚ä½•ä½¿ç”¨ <code>HTTPie</code> æ¥è¿›è¡Œ HTTP æ¥å£æµ‹è¯•ã€‚</li></ul><p>åœ¨è¿›è¡Œå®é™…å¼€å‘ä¹‹å‰ï¼Œæ¨èä½ å…ˆäº†è§£ä¸€ä¸‹ï¼š</p><ul><li><a href="https://hedon.top/2024/03/02/rust-crate-reqwest/">Rustreqwest ç®€æ˜æ•™ç¨‹</a></li><li><a href="https://hedon.top/2024/03/05/rust-crate-anyhow/">Rustanyhow ç®€æ˜æ•™ç¨‹</a></li><li><a href="https://hedon.top/2024/03/02/rust-crate-clap/">æ·±å…¥æ¢ç´¢Rust çš„ clap åº“ï¼šå‘½ä»¤è¡Œè§£æçš„è‰ºæœ¯</a></li></ul><p>æœ¬æ–‡å®Œæ•´ä»£ç ï¼š<ahref="https://github.com/hedon954/httpie">hedon954/httpie</a></p><h1 id="å¼€å‘æ€è·¯">å¼€å‘æ€è·¯</h1><h2 id="http-åè®®">HTTP åè®®</h2><p>å›é¡¾ä¸€ä¸‹ HTTP åè®®çš„è¯·æ±‚ä½“å’Œå“åº”ä½“ç»“æ„ã€‚</p><p>è¯·æ±‚ç»“æ„ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240303131157545.png"alt="http request structure" /><figcaption aria-hidden="true">http request structure</figcaption></figure><p>å“åº”ç»“æ„ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240303131123618.png"alt="http response structure" /><figcaption aria-hidden="true">http response structure</figcaption></figure><h2 id="å‘½ä»¤åˆ†æ">å‘½ä»¤åˆ†æ</h2><p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°±å®ç° HTTPie cli å®˜æ–¹çš„è¿™ä¸ª<ahref="https://github.com/httpie/cli?tab=readme-ov-file#examples">ç¤ºä¾‹</a>ï¼šå³å…è®¸æŒ‡å®šè¯·æ±‚æ–¹æ³•ã€æºå¸¦headers å’Œ json æ•°æ®å‘é€è¯·æ±‚ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240303131445159.png"alt="HTTPie å®˜æ–¹ç¤ºä¾‹" /><figcaption aria-hidden="true">HTTPie å®˜æ–¹ç¤ºä¾‹</figcaption></figure><p>æˆ‘ä»¬æ¥æ‹†è§£ä¸€ä¸‹ï¼Œè¿™ä¸ªå‘½ä»¤å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tex">httpie &lt;METHOD&gt; &lt;URL&gt; [headers | params]...<br></code></pre></td></tr></table></figure><ul><li><code>&lt;METHOD&gt;</code>: è¯·æ±‚æ–¹æ³•ï¼Œæœ¬æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬ä»…æ”¯æŒ GET å’ŒPOSTã€‚</li><li><code>&lt;URL&gt;</code>: è¯·æ±‚åœ°å€ã€‚</li><li><code>&lt;HEADERS&gt;</code>: è¯·æ±‚å¤´ï¼Œæ ¼å¼ä¸º<code>h1:v1</code>ã€‚</li><li><code>&lt;PARAMS&gt;</code>: è¯·æ±‚å‚æ•°ï¼Œæ ¼å¼ä¸º<code>k1=v1</code>ï¼Œæœ€ç»ˆä»¥ json ç»“æ„å‘é€ã€‚</li></ul><h2 id="æ•ˆæœå±•ç¤º">æ•ˆæœå±•ç¤º</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  httpie git:(master) âœ— ./Httpie --<span class="hljs-built_in">help</span>                                              <br>Usage: Httpie &lt;COMMAND&gt;<br><br>Commands:<br>  get   <br>  post  <br>  <span class="hljs-built_in">help</span>  Print this message or the <span class="hljs-built_in">help</span> of the given subcommand(s)<br><br>Options:<br>  -h, --<span class="hljs-built_in">help</span>     Print <span class="hljs-built_in">help</span><br>  -V, --version  Print version<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ post å­å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">Usage: Httpie post &lt;URL&gt; &lt;BODY&gt;...<br><br>Arguments:<br>  &lt;URL&gt;      Specify the url you wanna request to<br>  &lt;BODY&gt;...  Set the request body. Examples: headers: header1:value1 params: key1=value1<br><br>Options:<br>  -h, --<span class="hljs-built_in">help</span>  Print <span class="hljs-built_in">help</span><br></code></pre></td></tr></table></figure><p>è¯·æ±‚ç¤ºä¾‹ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240305225846224.png"alt="httpie response demo" /><figcaption aria-hidden="true">httpie response demo</figcaption></figure><h2 id="æ€è·¯æ¢³ç†">æ€è·¯æ¢³ç†</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240306223319742.png"alt="httpie å¼€å‘æ€è·¯æ¢³ç†" /><figcaption aria-hidden="true">httpie å¼€å‘æ€è·¯æ¢³ç†</figcaption></figure><p><strong>ç¬¬ 1 æ­¥ï¼šè§£æå‘½ä»¤è¡Œå‚æ•°</strong></p><p>æœ¬æ¡ˆä¾‹ä¸­ httpie æ”¯æŒ 2 ä¸ªå­å‘½ä»¤ï¼š</p><ul><li>get æ”¯æŒ url å‚æ•°</li><li>post æ”¯æŒ urlã€body å‚æ•°ï¼Œå› ä¸ºå…¶ä¸­ headers å’Œ paramsæ˜¯å˜é•¿çš„ï¼Œæˆ‘ä»¬ç»Ÿä¸€ç”¨ <code>Vec&lt;String&gt;</code> ç±»å‹çš„ bodyæ¥æ¥æ”¶ï¼Œç„¶åç”¨ <code>:</code> å’Œ <code>=</code> æ¥åŒºåˆ†å®ƒä»¬ã€‚</li></ul><p><strong>ç¬¬ 2 æ­¥ï¼šå‘é€è¯·æ±‚</strong></p><ol type="1"><li>ä½¿ç”¨ reqwest åˆ›å»º http clientï¼›</li><li>è®¾ç½® urlï¼›</li><li>è®¾ç½® methodï¼›</li><li>è®¾ç½® headersï¼›</li><li>è®¾ç½® paramsï¼›</li><li>å‘é€è¯·æ±‚ï¼›</li><li>è·å–å“åº”ä½“ã€‚</li></ol><p><strong>ç¬¬ 3 æ­¥ï¼šæ‰“å°å“åº”</strong></p><ol type="1"><li>æ‰“å° http version å’Œ statusï¼Œå¹¶ä½¿ç”¨ colored èµ‹äºˆè“è‰²ï¼›</li><li>æ‰“å° response headersï¼Œå¹¶ä½¿ç”¨ colored èµ‹äºˆç»¿è‰²ï¼›</li><li>ç¡®å®š content-typeï¼Œå¦‚æœæ˜¯ jsonï¼Œæˆ‘ä»¬å°±ç”¨ jsonxf ç¾åŒ– json ä¸²å¹¶ä½¿ç”¨colored èµ‹äºˆè“ç»¿è‰²è¾“å‡ºï¼Œå¦‚æœæ˜¯å…¶ä»–ç±»å‹ï¼Œè¿™é‡Œæˆ‘ä»¬å°±è¾“å‡ºåŸæ–‡å³å¯ã€‚</li></ol><h1 id="å®æˆ˜è¿‡ç¨‹">å®æˆ˜è¿‡ç¨‹</h1><h2 id="åˆ›å»ºé¡¹ç›®">1. åˆ›å»ºé¡¹ç›®</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo new httpie<br></code></pre></td></tr></table></figure><h2 id="æ·»åŠ ä¾èµ–">2. æ·»åŠ ä¾èµ–</h2><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs toml"><span class="hljs-section">[package]</span><br><span class="hljs-attr">name</span> = <span class="hljs-string">&quot;httpie&quot;</span><br><span class="hljs-attr">version</span> = <span class="hljs-string">&quot;0.1.0&quot;</span><br><span class="hljs-attr">edition</span> = <span class="hljs-string">&quot;2021&quot;</span><br><br><span class="hljs-section">[dependencies]</span><br><span class="hljs-attr">anyhow</span> = <span class="hljs-string">&quot;1.0.80&quot;</span><br><span class="hljs-attr">clap</span> = &#123; version = <span class="hljs-string">&quot;4.5.1&quot;</span>, features = [<span class="hljs-string">&quot;derive&quot;</span>] &#125;<br><span class="hljs-attr">colored</span> = <span class="hljs-string">&quot;2.1.0&quot;</span><br><span class="hljs-attr">jsonxf</span> = <span class="hljs-string">&quot;1.1.1&quot;</span><br><span class="hljs-attr">mime</span> = <span class="hljs-string">&quot;0.3.17&quot;</span><br><span class="hljs-attr">reqwest</span> = &#123; version = <span class="hljs-string">&quot;0.11.24&quot;</span>, features = [<span class="hljs-string">&quot;json&quot;</span>] &#125;<br><span class="hljs-attr">tokio</span> = &#123; version = <span class="hljs-string">&quot;1.36.0&quot;</span>, features = [<span class="hljs-string">&quot;rt&quot;</span>, <span class="hljs-string">&quot;rt-multi-thread&quot;</span>, <span class="hljs-string">&quot;macros&quot;</span>] &#125;<br></code></pre></td></tr></table></figure><ul><li><code>anyhow</code>: ç”¨äºç®€åŒ–å¼‚å¸¸å¤„ç†ã€‚</li><li><code>clap</code>: è§£æå‘½ä»¤è¡Œå‚æ•°ã€‚</li><li><code>colored</code>: ä¸ºç»ˆç«¯è¾“å‡ºå†…å®¹èµ‹äºˆé¢œè‰²ã€‚</li><li><code>jsonxf</code>: ç¾åŒ– json ä¸²ã€‚</li><li><code>mime</code>: æä¾›äº†å„ç§ Media Type çš„ç±»å‹å°è£…ã€‚</li><li><code>reqwest</code>: http å®¢æˆ·ç«¯ã€‚</li><li><code>tokio</code>: å¼‚æ­¥åº“ï¼Œæœ¬æ¡ˆä¾‹ç§æˆ‘ä»¬ä½¿ç”¨ reqwestçš„å¼‚æ­¥åŠŸèƒ½ã€‚</li></ul><h2 id="å®Œæ•´æºç ">3. å®Œæ•´æºç </h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// src/main.rs  ä¸ºå‡å°ç¯‡å¹…ï¼Œçœç•¥äº†å•å…ƒæµ‹è¯•ï¼Œè¯»è€…å¯è‡ªè¡Œè¡¥å……ã€‚</span><br><span class="hljs-keyword">use</span> std::collections::HashMap;<br><span class="hljs-keyword">use</span> reqwest::&#123;Client, header, Response&#125;;<br><span class="hljs-keyword">use</span> std::<span class="hljs-type">str</span>::FromStr;<br><span class="hljs-keyword">use</span> anyhow::anyhow;<br><span class="hljs-keyword">use</span> clap::&#123;Args, Parser, Subcommand&#125;;<br><span class="hljs-keyword">use</span> colored::Colorize;<br><span class="hljs-keyword">use</span> mime::Mime;<br><span class="hljs-keyword">use</span> reqwest::header::&#123;HeaderMap, HeaderName, HeaderValue&#125;;<br><span class="hljs-keyword">use</span> reqwest::Url;<br><br><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(version, author, about, long_about = None)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Httpie</span> &#123;<br>    <span class="hljs-meta">#[command(subcommand)]</span><br>    methods: Method,<br>&#125;<br><br><span class="hljs-meta">#[derive(Subcommand)]</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Method</span> &#123;<br>    <span class="hljs-title function_ invoke__">Get</span>(Get),<br>    <span class="hljs-title function_ invoke__">Post</span>(Post)<br>&#125;<br><br><span class="hljs-meta">#[derive(Args)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Get</span> &#123;<br>    <span class="hljs-meta">#[arg(value_parser = parse_url)]</span><br>    url: <span class="hljs-type">String</span>,<br>&#125;<br><br><span class="hljs-meta">#[derive(Args)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Post</span> &#123;<br>    <span class="hljs-comment">/// Specify the url you wanna request to.</span><br>    <span class="hljs-meta">#[arg(value_parser = parse_url)]</span><br>    url: <span class="hljs-type">String</span>,<br><br>    <span class="hljs-comment">/// Set the request body.</span><br>    <span class="hljs-comment">/// Examples:</span><br>    <span class="hljs-comment">///     headers:</span><br>    <span class="hljs-comment">///         header1:value1</span><br>    <span class="hljs-comment">///     params:</span><br>    <span class="hljs-comment">///         key1=value1</span><br>    <span class="hljs-meta">#[arg(required = true, value_parser = parse_kv_pairs)]</span><br>    body: <span class="hljs-type">Vec</span>&lt;KvPair&gt;<br>&#125;<br><br><span class="hljs-meta">#[derive(Debug, Clone)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">KvPair</span> &#123;<br>    k: <span class="hljs-type">String</span>,<br>    v: <span class="hljs-type">String</span>,<br>    t: KvPairType,<br>&#125;<br><br><span class="hljs-meta">#[derive(Debug,Clone)]</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">KvPairType</span> &#123;<br>    Header,<br>    Param,<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">FromStr</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">KvPair</span> &#123;<br>    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Err</span> = anyhow::Error;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from_str</span>(s: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-keyword">Self</span>, <span class="hljs-keyword">Self</span>::<span class="hljs-literal">Err</span>&gt; &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">pair_type</span>: KvPairType;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">split_char</span> = <span class="hljs-keyword">if</span> s.<span class="hljs-title function_ invoke__">contains</span>(<span class="hljs-string">&#x27;:&#x27;</span>) &#123;<br>            pair_type = KvPairType::Header;<br>            <span class="hljs-string">&#x27;:&#x27;</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            pair_type = KvPairType::Param;<br>            <span class="hljs-string">&#x27;=&#x27;</span><br>        &#125;;<br><br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">split</span> = s.<span class="hljs-title function_ invoke__">split</span>(split_char);<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">err</span> = || anyhow!(<span class="hljs-built_in">format!</span>(<span class="hljs-string">&quot;failed to parse pairs &#123;&#125;&quot;</span>,s));<br>        <span class="hljs-title function_ invoke__">Ok</span>(<span class="hljs-keyword">Self</span> &#123;<br>            k: (split.<span class="hljs-title function_ invoke__">next</span>().<span class="hljs-title function_ invoke__">ok_or_else</span>(err)?).<span class="hljs-title function_ invoke__">to_string</span>(),<br>            v: (split.<span class="hljs-title function_ invoke__">next</span>().<span class="hljs-title function_ invoke__">ok_or_else</span>(err)?).<span class="hljs-title function_ invoke__">to_string</span>(),<br>            t: pair_type,<br>        &#125;)<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">parse_url</span>(s: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> anyhow::<span class="hljs-type">Result</span>&lt;<span class="hljs-type">String</span>&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">_url</span>: Url = s.<span class="hljs-title function_ invoke__">parse</span>()?;<br>    <span class="hljs-title function_ invoke__">Ok</span>(s.<span class="hljs-title function_ invoke__">into</span>())<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">parse_kv_pairs</span>(s: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> anyhow::<span class="hljs-type">Result</span>&lt;KvPair&gt; &#123;<br>    <span class="hljs-title function_ invoke__">Ok</span>(s.<span class="hljs-title function_ invoke__">parse</span>()?)<br>&#125;<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get</span>(client: Client, args: &amp;Get) <span class="hljs-punctuation">-&gt;</span> anyhow::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>   <span class="hljs-keyword">let</span> <span class="hljs-variable">resp</span> = client.<span class="hljs-title function_ invoke__">get</span>(&amp;args.url).<span class="hljs-title function_ invoke__">send</span>().<span class="hljs-keyword">await</span>?;<br>    <span class="hljs-title function_ invoke__">Ok</span>(<span class="hljs-title function_ invoke__">print_resp</span>(resp).<span class="hljs-keyword">await</span>?)<br>&#125;<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">post</span>(client: Client, args: &amp;Post) <span class="hljs-punctuation">-&gt;</span> anyhow::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">body</span> = HashMap::<span class="hljs-title function_ invoke__">new</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">header_map</span> = HeaderMap::<span class="hljs-title function_ invoke__">new</span>();<br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">pair</span> <span class="hljs-keyword">in</span> args.body.<span class="hljs-title function_ invoke__">iter</span>() &#123;<br>        <span class="hljs-keyword">match</span> pair.t &#123;<br>            KvPairType::Param =&gt;  &#123;body.<span class="hljs-title function_ invoke__">insert</span>(&amp;pair.k, &amp;pair.v);&#125;<br>            KvPairType::Header =&gt; &#123;<br>                <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Ok</span>(name) = HeaderName::<span class="hljs-title function_ invoke__">from_str</span>(pair.k.<span class="hljs-title function_ invoke__">as_str</span>()) &#123;<br>                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Ok</span>(value) = HeaderValue::<span class="hljs-title function_ invoke__">from_str</span>(pair.v.<span class="hljs-title function_ invoke__">as_str</span>()) &#123;<br>                        header_map.<span class="hljs-title function_ invoke__">insert</span>(name,value);<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Invalid header value for key: &#123;&#125;&quot;</span>, pair.v);<br>                    &#125;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Invalid header key: &#123;&#125;&quot;</span>, pair.k);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">resp</span> = client.<span class="hljs-title function_ invoke__">post</span>(&amp;args.url)<br>        .<span class="hljs-title function_ invoke__">headers</span>(header_map)<br>        .<span class="hljs-title function_ invoke__">json</span>(&amp;body).<span class="hljs-title function_ invoke__">send</span>().<span class="hljs-keyword">await</span>?;<br>    <span class="hljs-title function_ invoke__">Ok</span>(<span class="hljs-title function_ invoke__">print_resp</span>(resp).<span class="hljs-keyword">await</span>?)<br>&#125;<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">print_resp</span>(resp: Response) <span class="hljs-punctuation">-&gt;</span> anyhow::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-title function_ invoke__">print_status</span>(&amp;resp);<br>    <span class="hljs-title function_ invoke__">print_headers</span>(&amp;resp);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">mime</span> = <span class="hljs-title function_ invoke__">get_content_type</span>(&amp;resp);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">body</span> = resp.<span class="hljs-title function_ invoke__">text</span>().<span class="hljs-keyword">await</span>?;<br>    <span class="hljs-title function_ invoke__">print_body</span>(mime, &amp;body);<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">print_status</span>(resp: &amp;Response) &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">status</span> = <span class="hljs-built_in">format!</span>(<span class="hljs-string">&quot;&#123;:?&#125; &#123;&#125;&quot;</span>, resp.<span class="hljs-title function_ invoke__">version</span>(), resp.<span class="hljs-title function_ invoke__">status</span>()).<span class="hljs-title function_ invoke__">blue</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;\n&quot;</span>, status);<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">print_headers</span>(resp: &amp;Response) &#123;<br>    <span class="hljs-keyword">for</span> (k,v) <span class="hljs-keyword">in</span> resp.<span class="hljs-title function_ invoke__">headers</span>() &#123;<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;: &#123;:?&#125;&quot;</span>, k.<span class="hljs-title function_ invoke__">to_string</span>().<span class="hljs-title function_ invoke__">green</span>(), v);<br>    &#125;<br>    <span class="hljs-built_in">print!</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">print_body</span>(mime: <span class="hljs-type">Option</span>&lt;Mime&gt;, resp: &amp;<span class="hljs-type">String</span>) &#123;<br>    <span class="hljs-keyword">match</span> mime &#123;<br>        <span class="hljs-title function_ invoke__">Some</span>(v) =&gt; &#123;<br>            <span class="hljs-keyword">if</span> v == mime::APPLICATION_JSON &#123;<br>                <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, jsonxf::<span class="hljs-title function_ invoke__">pretty_print</span>(resp).<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-title function_ invoke__">cyan</span>())<br>            &#125;<br>        &#125;<br>        _ =&gt; <span class="hljs-built_in">print!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, resp),<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_content_type</span>(resp: &amp;Response) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;Mime&gt; &#123;<br>    resp.<span class="hljs-title function_ invoke__">headers</span>()<br>        .<span class="hljs-title function_ invoke__">get</span>(header::CONTENT_TYPE)<br>        .<span class="hljs-title function_ invoke__">map</span>(|v|v.<span class="hljs-title function_ invoke__">to_str</span>().<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-title function_ invoke__">parse</span>().<span class="hljs-title function_ invoke__">unwrap</span>())<br>&#125;<br><br><span class="hljs-meta">#[tokio::main]</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-&gt;</span> anyhow::<span class="hljs-type">Result</span>&lt;()&gt;&#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">httpie</span> = Httpie::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">client</span> = Client::<span class="hljs-title function_ invoke__">new</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">result</span> = <span class="hljs-keyword">match</span> httpie.methods &#123;<br>        Method::<span class="hljs-title function_ invoke__">Get</span>(<span class="hljs-keyword">ref</span> args) =&gt; <span class="hljs-title function_ invoke__">get</span>(client, args).<span class="hljs-keyword">await</span>?,<br>        Method::<span class="hljs-title function_ invoke__">Post</span>(<span class="hljs-keyword">ref</span> args) =&gt; <span class="hljs-title function_ invoke__">post</span>(client, args).<span class="hljs-keyword">await</span>?,<br>    &#125;;<br>    <span class="hljs-title function_ invoke__">Ok</span>(result)<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå³ä½¿ç®—ä¸Š <code>use</code> éƒ¨åˆ†ï¼Œæ€»ä»£ç ä¹Ÿä¸è¿‡160è¡Œå·¦å³ï¼ŒRust çš„ <code>clap</code> åº“åœ¨ CLI å¼€å‘ä¸Šç¡®å® yydsï¼</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä¸€ä¸€æ‹†è§£è¿™éƒ¨åˆ†çš„ä»£ç ï¼Œå…¶ä¸­å…³äº <code>clap</code>çš„éƒ¨åˆ†æˆ‘ä¸ä¼šè¿‡å¤šå±•å¼€ï¼Œåˆšå…´è¶£çš„è¯»è€…å¯ä»¥å‚é˜…ï¼š<ahref="https://hedon.top/2024/03/02/rust-crate-clap/">æ·±å…¥æ¢ç´¢ Rust çš„clap åº“ï¼šå‘½ä»¤è¡Œè§£æçš„è‰ºæœ¯</a>ã€‚</p><h3 id="å‘½ä»¤è¡Œè§£æ">3.1 å‘½ä»¤è¡Œè§£æ</h3><p>æˆ‘ä»¬å…ˆä» <code>main()</code> å¼€å§‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[tokio::main]</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-&gt;</span> anyhow::<span class="hljs-type">Result</span>&lt;()&gt;&#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">httpie</span> = Httpie::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">client</span> = Client::<span class="hljs-title function_ invoke__">new</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">result</span> = <span class="hljs-keyword">match</span> httpie.methods &#123;<br>        Method::<span class="hljs-title function_ invoke__">Get</span>(<span class="hljs-keyword">ref</span> args) =&gt; <span class="hljs-title function_ invoke__">get</span>(client, args).<span class="hljs-keyword">await</span>?,<br>        Method::<span class="hljs-title function_ invoke__">Post</span>(<span class="hljs-keyword">ref</span> args) =&gt; <span class="hljs-title function_ invoke__">post</span>(client, args).<span class="hljs-keyword">await</span>?,<br>    &#125;;<br>    <span class="hljs-title function_ invoke__">Ok</span>(result)<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¸Œæœ›ä½¿ç”¨ <code>clap</code> çš„å¼‚æ­¥åŠŸèƒ½ï¼Œæ‰€ä»¥ä½¿ç”¨äº†<code>async</code> å…³é”®å­—ï¼ŒåŒæ—¶åŠ ä¸Šäº† <code>tokio</code> æä¾›çš„å±æ€§å®<code>#[tokio::main]</code>ï¼Œç”¨äºè®¾ç½®å¼‚æ­¥ç¯å¢ƒã€‚ä¸ºäº†èƒ½å¤Ÿä½¿ç”¨<code>?</code> å¿«é€Ÿä¼ æ’­é”™è¯¯ï¼Œæˆ‘ä»¬è®¾ç½®è¿”å›å€¼ä¸º<code>anyhow::Result&lt;()&gt;</code>ï¼Œæœ¬é¡¹ç›®ä¸­æˆ‘ä»¬ä¸å¯¹é”™è¯¯è¿›è¡Œè¿‡å¤šå¤„ç†ï¼Œæ‰€ä»¥è¿™ç§æ–¹å¼å¯ä»¥å¤§å¤§ç®€åŒ–æˆ‘ä»¬çš„é”™è¯¯å¤„ç†è¿‡ç¨‹ã€‚</p><p><code>main()</code> ä¸­æˆ‘ä»¬ä½¿ç”¨ <code>Httpie::parse()</code>è§£æå‘½ä»¤è¡Œä¸­çš„å‚æ•°ï¼Œä½¿ç”¨ <code>Client::new()</code> åˆ›å»ºä¸€ä¸ª httpclientï¼Œæ ¹æ®è§£æåˆ°çš„å‘½ä»¤è¡Œå‚æ•°ï¼Œæˆ‘ä»¬åŒ¹é…å­å‘½ä»¤<code>methods</code>ï¼Œåˆ†åˆ«è°ƒç”¨ <code>get()</code> å’Œ <code>post()</code>æ¥å‘é€ GET å’Œ POST è¯·æ±‚ã€‚</p><p><code>Httpie</code> çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(version, author, about, long_about = None)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Httpie</span> &#123;<br>    <span class="hljs-meta">#[command(subcommand)]</span><br>    methods: Method,<br>&#125;<br></code></pre></td></tr></table></figure><p><code>#[derive(Parser)]</code> æ˜¯ä¸€ä¸ªè¿‡ç¨‹å®ï¼ˆproceduralmacroï¼‰ï¼Œç”¨äºè‡ªåŠ¨ä¸ºç»“æ„ä½“å®ç° <code>clap::Parser</code>traitã€‚è¿™ä½¿å¾—è¯¥ç»“æ„ä½“å¯ä»¥ç”¨æ¥è§£æå‘½ä»¤è¡Œå‚æ•°ã€‚</p><p>åœ¨ <code>Httpie</code> ä¸­æˆ‘ä»¬å®šä¹‰äº†å­å‘½ä»¤ <code>Method</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[derive(Subcommand)]</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Method</span> &#123;<br>    <span class="hljs-title function_ invoke__">Get</span>(Get),<br>    <span class="hljs-title function_ invoke__">Post</span>(Post)<br>&#125;<br></code></pre></td></tr></table></figure><p><code>#[derive(Subcommand)]</code>å±æ€§å®ä¼šè‡ªåŠ¨ä¸ºæšä¸¾æ´¾ç”Ÿä¸€äº›ä»£ç ï¼Œä»¥ä¾¿å®ƒå¯ä»¥ä½œä¸ºå­å‘½ä»¤æ¥è§£æå‘½ä»¤è¡Œå‚æ•°ã€‚ç›®å‰æ”¯æŒ<code>Get</code> å’Œ <code>Post</code> ä¸¤ä¸ªå­å‘½ä»¤ï¼Œå®ƒä»¬åˆ†åˆ«æ¥æ”¶<code>Get</code> å’Œ <code>Post</code> å‚æ•°ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[derive(Args)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Get</span> &#123;<br>    <span class="hljs-meta">#[arg(value_parser = parse_url)]</span><br>    url: <span class="hljs-type">String</span>,<br>&#125;<br><br><span class="hljs-meta">#[derive(Args)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Post</span> &#123;<br>    <span class="hljs-meta">#[arg(value_parser = parse_url)]</span><br>    url: <span class="hljs-type">String</span>,<br>  <br>    <span class="hljs-meta">#[arg(value_parser = parse_kv_pairs)]</span><br>    body: <span class="hljs-type">Vec</span>&lt;KvPair&gt;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>#[derive(Args)]</code> å±æ€§å®è¡¨æ˜å½“å‰ struct æ˜¯å‘½ä»¤çš„å‚æ•°ï¼Œå…¶ä¸­<code>Get</code> ä»…æ”¯æŒ <code>url</code> å‚æ•°ï¼Œ<code>Post</code> æ”¯æŒ<code>url</code> å’Œ <code>body</code> å‚æ•°ã€‚</p><p><code>url</code> å‚æ•°æˆ‘ä»¬ä½¿ç”¨ <code>parse_url</code>å‡½æ•°æ¥è¿›è¡Œè§£æï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> reqwest::Url;<br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">parse_url</span>(s: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> anyhow::<span class="hljs-type">Result</span>&lt;<span class="hljs-type">String</span>&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">_url</span>: Url = s.<span class="hljs-title function_ invoke__">parse</span>()?;<br>    <span class="hljs-title function_ invoke__">Ok</span>(s.<span class="hljs-title function_ invoke__">into</span>())<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œ <code>reqwest::Url</code> å·²ç»å®ç°äº† <code>FromStr</code>traitï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è°ƒç”¨ <code>s.parse()</code> æ¥è§£æ<code>url</code>ã€‚</p><p>è€Œ <code>body</code>ï¼Œå› ä¸ºæˆ‘ä»¬æœŸæœ› CLI ä½¿ç”¨èµ·æ¥åƒï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">httpie url header1:value1 param1=v1<br></code></pre></td></tr></table></figure><p><code>body</code> å°±æ˜¯ <code>header1:value1 param1=v1</code>ï¼Œä¸€å¯¹ kvå°±ä»£è¡¨ç€ä¸€ä¸ª header æˆ–è€… paramï¼Œç”¨ <code>:</code> å’Œ <code>=</code>æ¥åŒºåˆ†ã€‚å› ä¸º kv å¯¹çš„ä¸ªæ•°çš„å˜é•¿çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨<code>Vec&lt;KvPair&gt;</code> æ¥æ¥æ”¶ <code>body</code> è¿™ä¸ªå‚æ•°ï¼Œå¹¶ä½¿ç”¨<code>parse_kv_pairs</code> æ¥è§£æ kv å¯¹ã€‚</p><p><code>KvPair</code> æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„ç±»å‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[derive(Debug, Clone)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">KvPair</span> &#123;<br>    k: <span class="hljs-type">String</span>,<br>    v: <span class="hljs-type">String</span>,<br>    t: KvPairType,<br>&#125;<br><br><span class="hljs-meta">#[derive(Debug,Clone)]</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">KvPairType</span> &#123;<br>    Header,<br>    Param,<br>&#125;<br></code></pre></td></tr></table></figure><p><code>parse_kv_pairs</code> çš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">parse_kv_pairs</span>(s: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> anyhow::<span class="hljs-type">Result</span>&lt;KvPair&gt; &#123;<br>    <span class="hljs-title function_ invoke__">Ok</span>(s.<span class="hljs-title function_ invoke__">parse</span>()?)<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œï¼Œä½ å¯ä»¥åœ¨ <code>parse_kv_pairs()</code> å‡½æ•°ä¸­ï¼Œå¯¹<code>s</code> è¿›è¡Œè§£æå¹¶è¿”å›<code>anyhow::Result&lt;KvPair&gt;</code>ã€‚ä¸è¿‡ï¼Œæ›´ä¼˜é›…ï¼Œæ›´ç»Ÿä¸€çš„æ–¹å¼æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå°±æ˜¯åƒ<code>reqwest::Url</code> ä¸€æ ·ï¼Œä¸º <code>KvPair</code> å®ç°<code>FromStr</code> traitï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥è°ƒç”¨ <code>s.parse()</code>æ¥è¿›è¡Œè§£æäº†ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">FromStr</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">KvPair</span> &#123;<br>    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Err</span> = anyhow::Error;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from_str</span>(s: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-keyword">Self</span>, <span class="hljs-keyword">Self</span>::<span class="hljs-literal">Err</span>&gt; &#123;<br>        ...<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å‘é€è¯·æ±‚">3.2 å‘é€è¯·æ±‚</h3><p>å‚æ•°è§£æå®Œï¼Œå°±åˆ°äº†å‘é€è¯·æ±‚çš„åœ°æ–¹äº†ï¼Œè¿™é‡Œä½¿ç”¨ <code>reqwest</code>crate å°±éå¸¸æ–¹ä¾¿äº†ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ï¼Œå…·ä½“å¯ä»¥å‚è€ƒï¼š<ahref="https://hedon.top/2024/03/02/rust-crate-reqwest/">Rust reqwestç®€æ˜æ•™ç¨‹</a>ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get</span>(client: Client, args: &amp;Get) <span class="hljs-punctuation">-&gt;</span> anyhow::<span class="hljs-type">Result</span>&lt;()&gt; &#123; ... &#125;<br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">post</span>(client: Client, args: &amp;Post) <span class="hljs-punctuation">-&gt;</span> anyhow::<span class="hljs-type">Result</span>&lt;()&gt; &#123; ... &#125;<br></code></pre></td></tr></table></figure><h3 id="æ‰“å°å“åº”">3.3 æ‰“å°å“åº”</h3><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240305225846224.png"alt="httpie response demo" /><figcaption aria-hidden="true">httpie response demo</figcaption></figure><p>å“åº”åˆ†ä¸º 3 ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>print_status()</li><li>print_headers()</li><li>print_body()</li></ul><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">print_resp</span>(resp: Response) <span class="hljs-punctuation">-&gt;</span> anyhow::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-title function_ invoke__">print_status</span>(&amp;resp);<br>    <span class="hljs-title function_ invoke__">print_headers</span>(&amp;resp);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">mime</span> = <span class="hljs-title function_ invoke__">get_content_type</span>(&amp;resp);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">body</span> = resp.<span class="hljs-title function_ invoke__">text</span>().<span class="hljs-keyword">await</span>?;<br>    <span class="hljs-title function_ invoke__">print_body</span>(mime, &amp;body);<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></td></tr></table></figure><p><code>print_status()</code> æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯æ‰“å° HTTPç‰ˆæœ¬å’Œå“åº”çŠ¶æ€ç ï¼Œç„¶åæˆ‘ä»¬ä½¿ç”¨ <code>colored</code> crate çš„<code>blue()</code> ä½¿å…¶åœ¨ç»ˆç«¯ä»¥<font color="blue">è“è‰²</font>è¾“å‡ºã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">print_status</span>(resp: &amp;Response) &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">status</span> = <span class="hljs-built_in">format!</span>(<span class="hljs-string">&quot;&#123;:?&#125; &#123;&#125;&quot;</span>, resp.<span class="hljs-title function_ invoke__">version</span>(), resp.<span class="hljs-title function_ invoke__">status</span>()).<span class="hljs-title function_ invoke__">blue</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;\n&quot;</span>, status);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>print_headers()</code> ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>green()</code> ä½¿header_name åœ¨ç»ˆç«¯ä»¥<font color="green">ç»¿è‰²</font>è¾“å‡ºã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">print_headers</span>(resp: &amp;Response) &#123;<br>    <span class="hljs-keyword">for</span> (k,v) <span class="hljs-keyword">in</span> resp.<span class="hljs-title function_ invoke__">headers</span>() &#123;<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;: &#123;:?&#125;&quot;</span>, k.<span class="hljs-title function_ invoke__">to_string</span>().<span class="hljs-title function_ invoke__">green</span>(), v);<br>    &#125;<br>    <span class="hljs-built_in">print!</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>å“åº”ä½“çš„æ ¼å¼ï¼ˆMedia Typeï¼‰æœ‰å¾ˆå¤šï¼Œæœ¬æ¡ˆä¾‹ä¸­æˆ‘ä»¬ä»…æ”¯æŒ<code>application/json</code>ï¼Œæ‰€ä»¥åœ¨ <code>print_body()</code>ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆè¯»å– response header ä¸­çš„ content-typeï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_content_type</span>(resp: &amp;Response) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;Mime&gt; &#123;<br>    resp.<span class="hljs-title function_ invoke__">headers</span>()<br>        .<span class="hljs-title function_ invoke__">get</span>(header::CONTENT_TYPE)<br>        .<span class="hljs-title function_ invoke__">map</span>(|v|v.<span class="hljs-title function_ invoke__">to_str</span>().<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-title function_ invoke__">parse</span>().<span class="hljs-title function_ invoke__">unwrap</span>())<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ <code>print_resp()</code> ä¸­ï¼Œå¯¹äº<code>application/json</code>ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>jsonxf</code> crateå¯¹è¿›è¡Œç¾åŒ–ï¼Œå¹¶ä½¿ç”¨ <code>cyan()</code>ä½¿å…¶åœ¨ç»ˆç«¯ä»¥<font color="cyan">è“ç»¿è‰²</font>è¾“å‡ºã€‚å¯¹äºå…¶ä»–ç±»å‹ï¼Œæˆ‘ä»¬å§‘ä¸”ç…§åŸæ–‡è¾“å‡ºã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">print_body</span>(mime: <span class="hljs-type">Option</span>&lt;Mime&gt;, resp: &amp;<span class="hljs-type">String</span>) &#123;<br>    <span class="hljs-keyword">match</span> mime &#123;<br>        <span class="hljs-title function_ invoke__">Some</span>(v) =&gt; &#123;<br>            <span class="hljs-keyword">if</span> v == mime::APPLICATION_JSON &#123;<br>                <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, jsonxf::<span class="hljs-title function_ invoke__">pretty_print</span>(resp).<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-title function_ invoke__">cyan</span>())<br>            &#125;<br>        &#125;<br>        _ =&gt; <span class="hljs-built_in">print!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, resp),<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="æ€»ç»“">æ€»ç»“</h1><p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬æ·±å…¥æ¢è®¨äº†å¦‚ä½•ä½¿ç”¨ Rust è¯­è¨€æ¥å®ç°ä¸€ä¸ªç±»ä¼¼äº HTTPieçš„å‘½ä»¤è¡Œå·¥å…·ã€‚è¿™ä¸ªè¿‡ç¨‹åŒ…æ‹¬äº†å¯¹ HTTP åè®®çš„ç†è§£ã€å‘½ä»¤è¡Œå‚æ•°çš„è§£æã€HTTPå®¢æˆ·ç«¯çš„åˆ›å»ºå’Œè¯·æ±‚å‘é€ï¼Œä»¥åŠå¯¹å“åº”çš„å¤„ç†å’Œå±•ç¤ºã€‚é€šè¿‡æœ¬æ–‡ï¼Œè¯»è€…ä¸ä»…èƒ½å¤Ÿè·å¾—ä¸€ä¸ªå®ç”¨çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œè¿˜èƒ½å¤Ÿå­¦ä¹ åˆ°å¦‚ä½•ä½¿ç”¨Rust çš„åº“æ¥æ„å»ºå®é™…çš„åº”ç”¨ç¨‹åºï¼ŒåŒ…æ‹¬<code>clap</code>ã€<code>reqwest</code>ã€<code>tokio</code> å’Œ<code>colored</code> ç­‰ã€‚æ­¤å¤–ï¼Œæ–‡ç« ä¹Ÿè¯´æ˜äº†åœ¨ Rustä¸­è¿›è¡Œå¼‚æ­¥ç¼–ç¨‹å’Œé”™è¯¯å¤„ç†çš„ä¸€äº›å¸¸è§æ¨¡å¼ã€‚å°½ç®¡ç¤ºä¾‹ä»£ç çš„é”™è¯¯å¤„ç†è¾ƒä¸ºç®€å•ï¼Œä½†å®ƒæä¾›äº†ä¸€ä¸ªè‰¯å¥½çš„èµ·ç‚¹ï¼Œå¼€å‘è€…å¯ä»¥åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œæ‰©å±•å’Œæ”¹è¿›ï¼Œä»¥é€‚åº”æ›´å¤æ‚çš„åº”ç”¨åœºæ™¯ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Rust</category>
      
      <category>Rust å®æˆ˜</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Rust</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Rust anyhow ç®€æ˜æ•™ç¨‹</title>
    <link href="/2024/03/05/rust-crate-anyhow/"/>
    <url>/2024/03/05/rust-crate-anyhow/</url>
    
    <content type="html"><![CDATA[<p><a href="https://docs.rs/anyhow/latest/anyhow/index.html">anyhow</a>æ˜¯ Rust ä¸­çš„ä¸€ä¸ªåº“ï¼Œæ—¨åœ¨æä¾›çµæ´»çš„ã€å…·ä½“çš„é”™è¯¯å¤„ç†èƒ½åŠ›ï¼Œå»ºç«‹åœ¨<code>std::error::Error</code>åŸºç¡€ä¸Šã€‚å®ƒä¸»è¦ç”¨äºé‚£äº›éœ€è¦ç®€å•é”™è¯¯å¤„ç†çš„åº”ç”¨ç¨‹åºå’ŒåŸå‹å¼€å‘ä¸­ï¼Œå°¤å…¶æ˜¯åœ¨é”™è¯¯ç±»å‹ä¸éœ€è¦è¢«ä¸¥æ ¼åŒºåˆ†çš„åœºæ™¯ä¸‹ã€‚</p><p>ä»¥ä¸‹æ˜¯ <code>anyhow</code> çš„å‡ ä¸ªå…³é”®ç‰¹æ€§ï¼š</p><ul><li><strong>æ˜“ç”¨æ€§</strong>: <code>anyhow</code> æä¾›äº†ä¸€ä¸ª<code>Error</code> ç±»å‹ï¼Œè¿™ä¸ªç±»å‹å¯ä»¥åŒ…å«ä»»ä½•å®ç°äº†<code>std::error::Error</code> çš„é”™è¯¯ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥ä½¿ç”¨<code>anyhow::Error</code>æ¥åŒ…è£…å‡ ä¹æ‰€æœ‰ç±»å‹çš„é”™è¯¯ï¼Œæ— éœ€æ‹…å¿ƒå…·ä½“çš„é”™è¯¯ç±»å‹ã€‚</li><li><strong>ç®€æ´çš„é”™è¯¯é“¾</strong>: <code>anyhow</code> æ”¯æŒé€šè¿‡<code>?</code>æ“ä½œç¬¦æ¥ä¼ æ’­é”™è¯¯ï¼ŒåŒæ—¶ä¿ç•™é”™è¯¯å‘ç”Ÿçš„ä¸Šä¸‹æ–‡ã€‚è¿™è®©é”™è¯¯å¤„ç†æ›´åŠ ç›´è§‚ï¼ŒåŒæ—¶è¿˜èƒ½ä¿ç•™é”™è¯¯é“¾ï¼Œä¾¿äºè°ƒè¯•ã€‚</li><li><strong>ä¾¿äºè°ƒè¯•</strong>: <code>anyhow</code> æ”¯æŒé€šè¿‡<code>&#123;:#&#125;</code>æ ¼å¼åŒ–æŒ‡ç¤ºç¬¦æ¥æ‰“å°é”™è¯¯åŠå…¶æ‰€æœ‰ç›¸å…³çš„ä¸Šä¸‹æ–‡å’ŒåŸå› ï¼Œè¿™ä½¿å¾—è°ƒè¯•å¤æ‚çš„é”™è¯¯é“¾å˜å¾—æ›´åŠ ç®€å•ã€‚</li><li><strong>æ— éœ€å…³å¿ƒé”™è¯¯ç±»å‹</strong>:åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œç‰¹åˆ«æ˜¯åœ¨åº”ç”¨ç¨‹åºçš„é¡¶å±‚ï¼Œä½ å¯èƒ½ä¸éœ€è¦å…³å¿ƒé”™è¯¯çš„å…·ä½“ç±»å‹ï¼Œåªéœ€è¦çŸ¥é“å‡ºé”™äº†å¹¶ä¸”èƒ½å¤Ÿå°†é”™è¯¯ä¿¡æ¯ä¼ é€’ç»™ç”¨æˆ·æˆ–æ—¥å¿—ã€‚<code>anyhow</code>è®©è¿™ä¸€è¿‡ç¨‹å˜å¾—ç®€å•ï¼Œå› ä¸ºå®ƒå¯ä»¥åŒ…è£…ä»»ä½•é”™è¯¯ï¼Œè€Œä¸éœ€è¦æ˜¾å¼åœ°æŒ‡å®šé”™è¯¯ç±»å‹ã€‚</li></ul><p>ä½¿ç”¨ <code>anyhow</code>çš„å…¸å‹åœºæ™¯åŒ…æ‹¬å¿«é€ŸåŸå‹å¼€å‘ã€åº”ç”¨ç¨‹åºé¡¶å±‚çš„é”™è¯¯å¤„ç†ï¼Œæˆ–è€…åœ¨åº“ä¸­ä½œä¸ºè¿”å›é”™è¯¯ç±»å‹çš„ä¸€ä¸ªç®€ä¾¿é€‰æ‹©ï¼Œå°¤å…¶æ˜¯åœ¨åº“çš„ä½¿ç”¨è€…ä¸éœ€è¦å…³å¿ƒå…·ä½“é”™è¯¯ç±»å‹çš„æ—¶å€™ã€‚</p><h2 id="anyhowerror">anyhow::Error</h2><p><code>anyhow::Error</code> æ˜¯ <code>anyhow</code>åº“å®šä¹‰çš„ä¸€ä¸ªé”™è¯¯ç±»å‹ã€‚å®ƒæ˜¯ä¸€ä¸ªåŒ…è£…å™¨ï¼ˆwrapperï¼‰ç±»å‹ï¼Œå¯ä»¥åŒ…å«ä»»ä½•å®ç°äº†<code>std::error::Error</code> traitçš„é”™è¯¯ç±»å‹ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥å°†å‡ ä¹æ‰€æœ‰çš„é”™è¯¯è½¬æ¢ä¸º<code>anyhow::Error</code>ç±»å‹ï¼Œä»è€Œåœ¨å‡½æ•°ä¹‹é—´ä¼ é€’ï¼Œè€Œä¸éœ€è¦åœ¨æ„å…·ä½“çš„é”™è¯¯ç±»å‹ã€‚è¿™åœ¨å¿«é€ŸåŸå‹å¼€å‘æˆ–åº”ç”¨ç¨‹åºé¡¶å±‚é”™è¯¯å¤„ç†ä¸­ç‰¹åˆ«æœ‰ç”¨ï¼Œå› ä¸ºå®ƒç®€åŒ–äº†é”™è¯¯å¤„ç†çš„é€»è¾‘ã€‚</p><p>å®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[cfg_attr(not(doc), repr(transparent))]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Error</span> &#123;<br>    inner: Own&lt;ErrorImpl&gt;,<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­æ ¸å¿ƒæ˜¯ <code>ErrorImpl</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[repr(C)]</span><br><span class="hljs-title function_ invoke__">pub</span>(<span class="hljs-keyword">crate</span>) <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ErrorImpl</span>&lt;E = ()&gt; &#123;<br>    vtable: &amp;<span class="hljs-symbol">&#x27;static</span> ErrorVTable,<br>    backtrace: <span class="hljs-type">Option</span>&lt;Backtrace&gt;,<br>    <span class="hljs-comment">// <span class="hljs-doctag">NOTE:</span> Don&#x27;t use directly. Use only through vtable. Erased type may have</span><br>    <span class="hljs-comment">// different alignment.</span><br>    _object: E,<br>&#125;<br></code></pre></td></tr></table></figure><p><code>ErrorImpl</code> æ˜¯ä¸€ä¸ªå†…éƒ¨ç»“æ„ä½“ï¼Œç”¨äºå®ç°<code>anyhow::Error</code> ç±»å‹çš„å…·ä½“åŠŸèƒ½ã€‚å®ƒåŒ…å«äº†ä¸‰ä¸ªä¸»è¦å­—æ®µï¼š</p><ul><li><code>vtable</code>æ˜¯ä¸€ä¸ªæŒ‡å‘é™æ€è™šæ‹Ÿè¡¨çš„æŒ‡é’ˆï¼Œç”¨äºåŠ¨æ€æ´¾å‘é”™è¯¯ç›¸å…³çš„æ–¹æ³•ã€‚</li><li><code>backtrace</code>æ˜¯ä¸€ä¸ªå¯é€‰çš„å›æº¯ï¼ˆBacktraceï¼‰ç±»å‹ï¼Œç”¨äºå­˜å‚¨é”™è¯¯å‘ç”Ÿæ—¶çš„è°ƒç”¨æ ˆä¿¡æ¯ã€‚</li><li><code>_object</code>å­—æ®µç”¨äºå­˜å‚¨å…·ä½“çš„é”™è¯¯å¯¹è±¡ï¼Œå…¶ç±»å‹åœ¨ç¼–è¯‘æ—¶è¢«æ“¦é™¤ä»¥æä¾›ç±»å‹å®‰å…¨çš„åŠ¨æ€é”™è¯¯å¤„ç†ã€‚</li></ul><p>è¿™ç§è®¾è®¡å…è®¸ <code>anyhow</code>é”™è¯¯å°è£…å¹¶è¡¨ç¤ºå„ç§ä¸åŒçš„é”™è¯¯ç±»å‹ï¼ŒåŒæ—¶æä¾›äº†æ–¹æ³•åŠ¨æ€æ´¾å‘å’Œå›æº¯åŠŸèƒ½ï¼Œä»¥ä¾¿äºé”™è¯¯è°ƒè¯•ã€‚</p><p><code>anyhow::Error</code> å¯ä»¥åŒ…å«ä»»ä½•å®ç°äº†<code>std::error::Error</code> trait çš„é”™è¯¯ç±»å‹ï¼Œè¿™é‡Œå› ä¸ºä¸‹é¢çš„<code>impl</code>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go">impl&lt;E&gt; StdError <span class="hljs-keyword">for</span> ErrorImpl&lt;E&gt;<br>where<br>    E: StdError,<br>&#123;<br>    fn source(&amp;self) -&gt; Option&lt;&amp;(dyn StdError + <span class="hljs-string">&#x27;static)&gt; &#123;</span><br><span class="hljs-string">        unsafe &#123; ErrorImpl::error(self.erase()).source() &#125;</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    #[cfg(error_generic_member_access)]</span><br><span class="hljs-string">    fn provide&lt;&#x27;</span>a&gt;(&amp;<span class="hljs-string">&#x27;a self, request: &amp;mut Request&lt;&#x27;</span>a&gt;) &#123;<br>        unsafe &#123; ErrorImpl::provide(self.erase(), request) &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="anyhowresult">anyhow::Result</h2><p><code>anyhow::Result</code> æ˜¯ä¸€ä¸ªåˆ«åï¼ˆtype aliasï¼‰ï¼Œå®ƒæ˜¯<code>std::result::Result&lt;T, anyhow::Error&gt;</code> çš„ç®€å†™ã€‚åœ¨ä½¿ç”¨<code>anyhow</code>åº“è¿›è¡Œé”™è¯¯å¤„ç†æ—¶ï¼Œä½ ä¼šé¢‘ç¹åœ°çœ‹åˆ°è¿™ä¸ªç±»å‹ã€‚å®ƒåŸºæœ¬ä¸Šæ˜¯æ ‡å‡†çš„<code>Result</code> ç±»å‹ï¼Œä½†é”™è¯¯ç±»å‹è¢«å›ºå®šä¸º<code>anyhow::Error</code>ã€‚è¿™ä½¿å¾—ä½ å¯ä»¥å¾ˆå®¹æ˜“åœ°åœ¨å‡½æ•°ä¹‹é—´ä¼ é€’é”™è¯¯ï¼Œè€Œä¸éœ€è¦å£°æ˜å…·ä½“çš„é”™è¯¯ç±»å‹ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">Result</span>&lt;T, E = Error&gt; = core::result::<span class="hljs-type">Result</span>&lt;T, E&gt;;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>anyhow::Result</code>çš„å¥½å¤„åœ¨äºå®ƒæä¾›äº†ä¸€ç§ç»Ÿä¸€çš„æ–¹å¼æ¥å¤„ç†é”™è¯¯ã€‚ä½ å¯ä»¥ä½¿ç”¨ <code>?</code>æ“ä½œç¬¦æ¥ä¼ æ’­é”™è¯¯ï¼ŒåŒæ—¶ä¿ç•™é”™è¯¯çš„ä¸Šä¸‹æ–‡ä¿¡æ¯å’Œå›æº¯ã€‚è¿™æå¤§åœ°ç®€åŒ–äº†é”™è¯¯å¤„ç†ä»£ç ï¼Œå°¤å…¶æ˜¯åœ¨å¤šä¸ªå¯èƒ½äº§ç”Ÿä¸åŒé”™è¯¯ç±»å‹çš„æ“ä½œé“¾ä¸­ã€‚</p><h2 id="ä¸ªæ ¸å¿ƒä½¿ç”¨æŠ€å·§">3 ä¸ªæ ¸å¿ƒä½¿ç”¨æŠ€å·§</h2><ul><li>ä½¿ç”¨ <code>Result&lt;T, anyhow::Error&gt;</code> æˆ–è€…<code>anyhow::Result&lt;T&gt;</code> ä½œä¸ºè¿”å›å€¼ï¼Œç„¶ååˆ©ç”¨ <code>?</code>è¯­æ³•ç³–æ— è„‘ä¼ æ’­æŠ¥é”™ã€‚</li><li>ä½¿ç”¨ with_context(f) æ¥é™„åŠ é”™è¯¯ä¿¡æ¯ã€‚</li><li>ä½¿ç”¨ downcast åè§£å…·ä½“çš„é”™è¯¯ç±»å‹ã€‚</li></ul><h2 id="å®æˆ˜æ¡ˆä¾‹">å®æˆ˜æ¡ˆä¾‹</h2><p>ä¸‹é¢æˆ‘ä»¬ç”¨ä¸€ä¸ªæ¡ˆä¾‹æ¥ä½“ä¼š <code>anyhow</code> çš„ä½¿ç”¨æ–¹å¼ï¼š</p><p>æˆ‘ä»¬çš„éœ€æ±‚æ˜¯ï¼šæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œè§£ææ–‡ä»¶ä¸­çš„æ•°æ®å¹¶è¿›è¡Œå¤§å†™åŒ–ï¼Œç„¶åè¾“å‡ºå¤„ç†åçš„æ•°æ®ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> anyhow::&#123;<span class="hljs-type">Result</span>, Context&#125;;<br><span class="hljs-keyword">use</span> std::&#123;fs, io&#125;;<br><br><span class="hljs-comment">// 1. è¯»å–æ–‡ä»¶ã€è§£ææ•°æ®å’Œæ‰§è¡Œæ•°æ®æ“ä½œéƒ½å¯èƒ½å‡ºç°é”™è¯¯ï¼Œ</span><br><span class="hljs-comment">// æ‰€ä»¥æˆ‘ä»¬éœ€è¦è¿”å› Result æ¥å…¼å®¹å¼‚å¸¸æƒ…å†µã€‚</span><br><span class="hljs-comment">// è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ anyhow::Result æ¥ç®€åŒ–å’Œä¼ æ’­é”™è¯¯ã€‚</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">read_and_process_file</span>(file_path: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-comment">// å°è¯•è¯»å–æ–‡ä»¶</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">data</span> = fs::<span class="hljs-title function_ invoke__">read_to_string</span>(file_path)<br>        <span class="hljs-comment">// 2. ä½¿ç”¨ with_context æ¥é™„åŠ é”™è¯¯ä¿¡æ¯ï¼Œç„¶ååˆ©ç”¨ ? è¯­æ³•ç³–ä¼ æ’­é”™è¯¯ã€‚</span><br>        .<span class="hljs-title function_ invoke__">with_context</span>(||<span class="hljs-built_in">format!</span>(<span class="hljs-string">&quot;failed to read file `&#123;&#125;`&quot;</span>, file_path))?;<br><br>    <span class="hljs-comment">// è§£ææ•°æ®</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">processed_data</span> = <span class="hljs-title function_ invoke__">parse_data</span>(&amp;data)<br>        .<span class="hljs-title function_ invoke__">with_context</span>(||<span class="hljs-built_in">format!</span>(<span class="hljs-string">&quot;failed to parse data from file `&#123;&#125;`&quot;</span>, file_path))?;<br><br>    <span class="hljs-comment">// æ‰§è¡Œæ•°æ®æ“ä½œ</span><br>    <span class="hljs-title function_ invoke__">perform_some_operation</span>(processed_data)<br>        .<span class="hljs-title function_ invoke__">with_context</span>(|| <span class="hljs-string">&quot;failed to perform operation based on file data&quot;</span>)?;<br><br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">parse_data</span>(data: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-type">String</span>&gt; &#123;<br>    <span class="hljs-title function_ invoke__">Ok</span>(data.<span class="hljs-title function_ invoke__">to_uppercase</span>())<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">perform_some_operation</span>(data: <span class="hljs-type">String</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;processed data: &#123;&#125;&quot;</span>, data);<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">file_path</span> = <span class="hljs-string">&quot;./anyhow.txt&quot;</span>;<br>  <span class="hljs-comment">// æ‰§è¡Œå¤„ç†é€»è¾‘</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">res</span> =  <span class="hljs-title function_ invoke__">read_and_process_file</span>(file_path);<br>  <span class="hljs-comment">// å¤„ç†ç»“æœ</span><br>    <span class="hljs-keyword">match</span> res &#123;<br>        <span class="hljs-title function_ invoke__">Ok</span>(_) =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;successfully!&quot;</span>),<br>        <span class="hljs-title function_ invoke__">Err</span>(e) =&gt; &#123;<br>            <span class="hljs-comment">// 3. ä½¿ç”¨ downcast æ¥åè§£å‡ºå®é™…çš„é”™è¯¯å®ä¾‹ï¼Œæœ¬æ¡ˆä¾‹ä¸­å¯èƒ½å‡ºç°çš„å¼‚å¸¸æ˜¯ io::Errorã€‚</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(my_error) = e.downcast_ref::&lt;io::Error&gt;() &#123;<br>                <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;has io error: &#123;:#&#125;&quot;</span>, my_error);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;unknown error: &#123;:?&#125;&quot;</span>, e);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Rust</category>
      
      <category>Rust å¸¸ç”¨åº“</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Rust</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ·±å…¥æ¢ç´¢ Rust çš„ clap åº“ï¼šå‘½ä»¤è¡Œè§£æçš„è‰ºæœ¯</title>
    <link href="/2024/03/02/rust-crate-clap/"/>
    <url>/2024/03/02/rust-crate-clap/</url>
    
    <content type="html"><![CDATA[<h1 id="ç‰ˆæœ¬å£°æ˜">ç‰ˆæœ¬å£°æ˜</h1><ul><li>Rust: 1.76</li><li><a href="https://docs.rs/clap/4.5.1/clap/index.html">clap:4.5.1</a></li><li><ahref="https://docs.rs/clap_complete/4.5.1/clap_complete/index.html">clap_complete4.5.1</a></li><li><ahref="https://docs.rs/rpassword/7.3.1/rpassword/index.html">rpassword:7.3.1</a></li></ul><h1 id="ç»“è®ºå…ˆè¡Œ">ç»“è®ºå…ˆè¡Œ</h1><p>æœ¬æ–‡å°†ä» CLIï¼ˆCommand LineInterfaceï¼‰å‘½ä»¤è¡Œå·¥å…·çš„æ¦‚è¿°è®²èµ·ï¼Œä»‹ç»ä¸€ä¸ªä¼˜ç§€çš„å‘½ä»¤è¡Œå·¥å…·åº”è¯¥å…·å¤‡çš„åŠŸèƒ½å’Œç‰¹æ€§ã€‚ç„¶åä»‹ç»Rust ä¸­ä¸€ä¸ªéå¸¸ä¼˜ç§€çš„å‘½ä»¤è¡Œè§£æå·¥å…· <code>clap</code>ç»å…¸ä½¿ç”¨æ–¹æ³•ï¼Œå¹¶åˆ©ç”¨ <code>clap</code> å®ç°ä¸€ä¸ªç±»ä¼¼äº <code>curl</code>çš„å·¥å…· <code>httpie</code>ã€‚æ–‡ç« æœ€åè¿˜å°† <code>clap</code> äº Goè¯­è¨€ä¸­åŒæ ·ä¼˜ç§€çš„å‘½ä»¤è¡Œè§£æå·¥å…· <code>cobra</code>è¿›è¡Œä¸€ä¸ªç®€å•å¯¹æ¯”ï¼Œä¾¿äºè¯»è€…è¿›ä¸€æ­¥ä½“ä¼š <code>clap</code>çš„ç®€æ´å’Œä¼˜ç§€ã€‚</p><p>æœ¬æ–‡å°†åŒ…å«ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p><ol type="1"><li><strong>CLI æ¦‚è¿°</strong>ï¼šä» CLIçš„åŸºæœ¬æ¦‚å¿µå‡ºå‘ï¼Œä»‹ç»ä¼˜ç§€å‘½ä»¤è¡Œå·¥å…·åº”è¯¥å…·å¤‡çš„åŠŸèƒ½ç‰¹æ€§ï¼Œå¹¶ä»¥ curlä½œä¸ºç»å…¸èŒƒä¾‹è¿›è¡Œè¯´æ˜ã€‚</li><li><strong>è¯¦ç»†ä»‹ç» clap</strong>ï¼šåŸºäº clap å®˜æ–¹æ–‡æ¡£ï¼Œåˆ†åˆ«è¯¦ç»†ä»‹ç»clap ä»¥ derive å’Œ builder ä¸¤ä¸ªæ–¹å¼æ„å»º cli çš„å¸¸ç”¨æ–¹æ³•ã€‚</li><li><strong>å®æˆ˜ httpie</strong>ï¼šå‚è€ƒé™ˆå¤©è€å¸ˆçš„ã€ŠRustç¼–ç¨‹ç¬¬ä¸€è¯¾ã€‹ï¼Œç”¨æœ€æ–°çš„ clap ç‰ˆæœ¬ï¼ˆ1.7.6ï¼‰å®ç° httpie å·¥å…·ã€‚</li><li><strong>å¯¹æ¯”cobra</strong>ï¼šä»è®¾è®¡ç†å¿µå’Œç›®æ ‡ã€åŠŸèƒ½ç‰¹ç‚¹ã€ä½¿ç”¨åœºæ™¯ç­‰æ–¹é¢ç®€è¦å¯¹æ¯” clapå’Œ Go æµè¡Œçš„å‘½ä»¤è¡Œè§£æåº“ cobraã€‚</li></ol><p>ç‰¹æ­¤å£°æ˜ï¼Œæœ¬æ–‡åŒ…å« AI è¾…åŠ©ç”Ÿæˆå†…å®¹ï¼Œå¦‚æœ‰é”™è¯¯é—æ¼ä¹‹å¤„ï¼Œæ•¬è¯·æŒ‡å‡ºã€‚</p><h1 id="cli-æ¦‚è¿°">CLI æ¦‚è¿°</h1><p>CLIï¼ˆCommand LineInterfaceï¼Œå‘½ä»¤è¡Œç•Œé¢ï¼‰æ˜¯ä¸€ç§å…è®¸ç”¨æˆ·é€šè¿‡æ–‡æœ¬å‘½ä»¤ä¸è®¡ç®—æœºç¨‹åºæˆ–æ“ä½œç³»ç»Ÿè¿›è¡Œäº¤äº’çš„æ¥å£ã€‚ä¸å›¾å½¢ç”¨æˆ·ç•Œé¢ï¼ˆGUIï¼ŒGraphicalUser Interfaceï¼‰ç›¸æ¯”ï¼ŒCLIä¸æä¾›å›¾å½¢å…ƒç´ ï¼Œå¦‚æŒ‰é’®æˆ–å›¾æ ‡ï¼Œè€Œæ˜¯ä¾èµ–äºæ–‡æœ¬è¾“å…¥ã€‚ç”¨æˆ·é€šè¿‡é”®ç›˜è¾“å…¥ç‰¹å®šçš„å‘½ä»¤è¡ŒæŒ‡ä»¤ï¼Œå‘½ä»¤è¡Œç•Œé¢è§£é‡Šè¿™äº›æŒ‡ä»¤å¹¶æ‰§è¡Œç›¸åº”çš„æ“ä½œã€‚</p><p>ä¸€æ¬¾ä¼˜ç§€çš„ CLIå·¥å…·åº”è¯¥å…·å¤‡ä»¥ä¸‹çš„åŠŸèƒ½å’Œç‰¹æ€§ï¼Œä»¥æå‡ç”¨æˆ·ä½“éªŒå’Œæ•ˆç‡ï¼š</p><p>ä¸€ä¸ªä¼˜ç§€çš„å‘½ä»¤è¡Œå·¥å…·ï¼ˆCLI, Command LineInterfaceï¼‰åº”è¯¥å…·å¤‡ä»¥ä¸‹åŠŸèƒ½å’Œç‰¹æ€§ï¼Œä»¥æå‡ç”¨æˆ·ä½“éªŒå’Œæ•ˆç‡ï¼š</p><ol type="1"><li><strong>ç›´è§‚æ˜“ç”¨</strong>ï¼š<ul><li><strong>ç®€æ´çš„å‘½ä»¤è¯­æ³•</strong>ï¼šå‘½ä»¤å’Œå‚æ•°çš„è®¾è®¡åº”ç›´è§‚æ˜“æ‡‚ï¼Œæ–¹ä¾¿ç”¨æˆ·è®°å¿†å’Œä½¿ç”¨ã€‚</li><li><strong>è‡ªåŠ¨è¡¥å…¨</strong>ï¼šæ”¯æŒå‘½ä»¤å’Œå‚æ•°çš„è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ï¼Œæé«˜ç”¨æˆ·è¾“å…¥æ•ˆç‡ã€‚</li><li><strong>å‘½ä»¤åˆ«å</strong>ï¼šæä¾›å¸¸ç”¨å‘½ä»¤çš„ç®€çŸ­åˆ«åï¼Œå‡å°‘è¾“å…¥çš„å·¥ä½œé‡ã€‚</li></ul></li><li><strong>å¼ºå¤§çš„å¸®åŠ©ç³»ç»Ÿ</strong>ï¼š<ul><li><strong>è¯¦ç»†çš„å¸®åŠ©æ–‡æ¡£</strong>ï¼šæ¯ä¸ªå‘½ä»¤å’Œå‚æ•°éƒ½åº”æœ‰æ¸…æ™°çš„è¯´æ˜æ–‡æ¡£ã€‚</li><li><strong>ç¤ºä¾‹ä½¿ç”¨æ–¹å¼</strong>ï¼šæä¾›å¸¸è§çš„ä½¿ç”¨ç¤ºä¾‹ï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿç†è§£å’Œåº”ç”¨ã€‚</li><li><strong>å†…ç½®å¸®åŠ©å‘½ä»¤</strong>ï¼šé€šè¿‡å¦‚<code>--help</code>æˆ–<code>-h</code>å‚æ•°è½»æ¾è®¿é—®å¸®åŠ©ä¿¡æ¯ã€‚</li></ul></li><li><strong>é”™è¯¯å¤„ç†ä¸åé¦ˆ</strong>ï¼š<ul><li><strong>æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯</strong>ï¼šå‡ºç°é”™è¯¯æ—¶ï¼Œæä¾›æ˜ç¡®ã€å…·ä½“çš„é”™è¯¯ä¿¡æ¯ï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿå®šä½é—®é¢˜ã€‚</li><li><strong>å»ºè®®å’Œè§£å†³æ–¹æ¡ˆ</strong>ï¼šåœ¨å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œç»™å‡ºé”™è¯¯è§£å†³çš„å»ºè®®æˆ–è‡ªåŠ¨ä¿®å¤é€‰é¡¹ã€‚</li></ul></li><li><strong>é«˜æ•ˆçš„æ‰§è¡Œå’Œè¾“å‡º</strong>ï¼š<ul><li><strong>å¿«é€Ÿå“åº”</strong>ï¼šå‘½ä»¤æ‰§è¡Œåº”è¿…é€Ÿï¼Œå‡å°‘ç”¨æˆ·ç­‰å¾…æ—¶é—´ã€‚</li><li><strong>æ ¼å¼åŒ–çš„è¾“å‡º</strong>ï¼šæä¾›æ˜“äºé˜…è¯»å’Œè§£æçš„è¾“å‡ºæ ¼å¼ï¼Œå¦‚è¡¨æ ¼ã€JSONæˆ– XML ç­‰ã€‚</li><li><strong>è¾“å‡ºè¿‡æ»¤å’Œæ’åº</strong>ï¼šå…è®¸ç”¨æˆ·æ ¹æ®éœ€è¦è¿‡æ»¤å’Œæ’åºè¾“å‡ºç»“æœï¼Œæé«˜ä¿¡æ¯çš„æŸ¥æ‰¾æ•ˆç‡ã€‚</li></ul></li><li><strong>è·¨å¹³å°å…¼å®¹</strong>ï¼š<ul><li><strong>å¤šå¹³å°æ”¯æŒ</strong>ï¼šèƒ½å¤Ÿåœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸Šè¿è¡Œï¼Œå¦‚Windowsã€macOSã€Linux ç­‰ã€‚</li><li><strong>ç¯å¢ƒé€‚åº”æ€§</strong>ï¼šè‡ªåŠ¨é€‚åº”ä¸åŒçš„ç»ˆç«¯ç¯å¢ƒå’Œå­—ç¬¦ç¼–ç ï¼Œç¡®ä¿è¾“å‡ºæ˜¾ç¤ºæ­£ç¡®ã€‚</li></ul></li><li><strong>å®‰å…¨æ€§</strong>ï¼š<ul><li><strong>å®‰å…¨çš„é»˜è®¤è®¾ç½®</strong>ï¼šé»˜è®¤é…ç½®åº”å¼ºè°ƒå®‰å…¨ï¼Œé¿å…æš´éœ²æ•æ„Ÿä¿¡æ¯ã€‚</li><li><strong>æ•°æ®åŠ å¯†</strong>ï¼šåœ¨å¤„ç†æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚å¯†ç ï¼‰æ—¶ï¼Œåº”ä½¿ç”¨åŠ å¯†æ‰‹æ®µä¿æŠ¤æ•°æ®å®‰å…¨ã€‚</li></ul></li><li><strong>ç‰ˆæœ¬ç®¡ç†</strong>ï¼š<ul><li><strong>ç‰ˆæœ¬æ§åˆ¶</strong>ï¼šæä¾›å‘½ä»¤æŸ¥çœ‹å·¥å…·ç‰ˆæœ¬ï¼Œæ”¯æŒå¤šç‰ˆæœ¬å…±å­˜æˆ–å‡çº§ã€‚</li><li><strong>å‘åå…¼å®¹</strong>ï¼šæ–°ç‰ˆæœ¬åº”å°½é‡ä¿æŒä¸æ—§ç‰ˆæœ¬çš„å…¼å®¹æ€§ï¼Œé¿å…ç ´åç”¨æˆ·ç°æœ‰çš„å·¥ä½œæµç¨‹ã€‚</li></ul></li></ol><p>è¿™äº›ç‰¹æ€§ä¸ä»…èƒ½å¤Ÿæé«˜ç”¨æˆ·çš„å·¥ä½œæ•ˆç‡ï¼Œè¿˜èƒ½å¢å¼ºç”¨æˆ·ä½“éªŒï¼Œä½¿å‘½ä»¤è¡Œå·¥å…·æ›´åŠ å¼ºå¤§å’Œæ˜“ç”¨ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬ä»¥ <code>curl</code> ä¸ºä¾‹ï¼Œçœ‹çœ‹ä¼˜ç§€çš„ CLIå·¥å…·å¤§æ¦‚é•¿ä»€ä¹ˆæ ·å­ã€‚</p><p><code>curl</code>æ˜¯ä¸€ç§å‘½ä»¤è¡Œå·¥å…·å’Œåº“ï¼Œç”¨äºä¼ è¾“æ•°æ®ã€‚å®ƒæ”¯æŒå¤šç§åè®®ï¼ŒåŒ…æ‹¬HTTPã€HTTPSã€FTPã€FTPSã€SCPã€SFTPã€TFTPã€TELNETã€DICTã€LDAPã€LDAPSã€IMAPã€POP3ã€SMTPå’Œ RTSP ç­‰ã€‚<code>curl</code>æ˜¯ä¸€ä¸ªéå¸¸å¼ºå¤§å’Œçµæ´»çš„å·¥å…·ï¼Œå¹¿æ³›åº”ç”¨äºè‡ªåŠ¨åŒ–è„šæœ¬ã€ç³»ç»Ÿæµ‹è¯•ã€æ•°æ®æ”¶é›†å’Œè®¸å¤šå…¶ä»–ç”¨é€”ã€‚</p><p>è¿›å…¥ç»ˆç«¯ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸‹é¢å‘½ä»¤æŸ¥çœ‹ <code>curl</code> çš„è¯´æ˜æ–‡æ¡£ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  ~ curl --<span class="hljs-built_in">help</span><br>Usage: curl [options...] &lt;url&gt;<br> -d, --data &lt;data&gt;          HTTP POST data<br> -f, --fail                 Fail fast with no output on HTTP errors<br> -h, --<span class="hljs-built_in">help</span> &lt;category&gt;      Get <span class="hljs-built_in">help</span> <span class="hljs-keyword">for</span> commands<br> -i, --include              Include protocol response headers <span class="hljs-keyword">in</span> the output<br> -o, --output &lt;file&gt;        Write to file instead of stdout<br> -O, --remote-name          Write output to a file named as the remote file<br> -s, --silent               Silent mode<br> -T, --upload-file &lt;file&gt;   Transfer <span class="hljs-built_in">local</span> FILE to destination<br> -u, --user &lt;user:password&gt; Server user and password<br> -A, --user-agent &lt;name&gt;    Send User-Agent &lt;name&gt; to server<br> -v, --verbose              Make the operation more talkative<br> -V, --version              Show version number and quit<br><br>This is not the full <span class="hljs-built_in">help</span>, this menu is stripped into categories.<br>Use <span class="hljs-string">&quot;--help category&quot;</span> to get an overview of all categories.<br>For all options use the manual or <span class="hljs-string">&quot;--help all&quot;</span>.<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p><ul><li>ä¸‹è½½æ–‡ä»¶ï¼š <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -O http://example.com/file.txt<br></code></pre></td></tr></table></figure></li><li>å‘é€ POST è¯·æ±‚ï¼š <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -d <span class="hljs-string">&quot;param1=value1&amp;param2=value2&quot;</span> http://example.com/resource<br></code></pre></td></tr></table></figure></li><li>ä½¿ç”¨ HTTPS å¹¶å¿½ç•¥è¯ä¹¦éªŒè¯ï¼š <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -k https://example.com<br></code></pre></td></tr></table></figure></li><li>ä½¿ç”¨åŸºæœ¬è®¤è¯ï¼š <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -u username:password http://example.com<br></code></pre></td></tr></table></figure></li></ul><p><code>curl</code>çš„è¿™äº›ç‰¹æ€§ä½¿å…¶æˆä¸ºå¼€å‘è€…ã€ç³»ç»Ÿç®¡ç†å‘˜å’Œè‡ªåŠ¨åŒ–è„šæœ¬ä¸­å¹¿æ³›ä½¿ç”¨çš„å·¥å…·ä¹‹ä¸€ã€‚</p><h1 id="clap">clap</h1><h2 id="æ¦‚è¿°">æ¦‚è¿°</h2><p><code>clap</code>ï¼Œä»£è¡¨ <em>Command Line ArgumentParser</em>ï¼Œæ˜¯ä¸€ä¸ªæ—¨åœ¨åˆ›å»ºç›´è§‚ã€æ˜“ç”¨ä¸”åŠŸèƒ½å¼ºå¤§çš„å‘½ä»¤è¡Œç•Œé¢çš„ Ruståº“ã€‚æˆªè‡³ç›®å‰ï¼ˆ2024.2ï¼‰ï¼Œ<code>clap</code> å·²ç»å‘å±•åˆ°äº† 4.5.1ç‰ˆæœ¬ï¼Œå®ƒé€šè¿‡ç®€åŒ–å‘½ä»¤è¡Œå‚æ•°çš„å¤„ç†ï¼Œè®©å¼€å‘è€…èƒ½æ›´ä¸“æ³¨äºåº”ç”¨é€»è¾‘çš„æ„å»ºã€‚</p><p><code>clap</code> ä¹‹æ‰€ä»¥åœ¨ Rustç¤¾åŒºå¦‚æ­¤æµè¡Œï¼Œå¾—ç›Šäºä»¥ä¸‹å‡ ä¸ªä¼˜ç‚¹ï¼š</p><p><strong>1. æ˜“äºä½¿ç”¨</strong></p><p><code>clap</code>çš„è®¾è®¡ç†å¿µæ˜¯è®©å‘½ä»¤è¡Œå‚æ•°çš„è§£æå˜å¾—ç®€å•è€Œç›´è§‚ã€‚å³ä½¿æ˜¯æ²¡æœ‰ç»éªŒçš„å¼€å‘è€…ä¹Ÿèƒ½å¿«é€Ÿä¸Šæ‰‹ï¼Œé€šè¿‡å‡ è¡Œä»£ç å°±èƒ½å®ç°å¤æ‚çš„å‘½ä»¤è¡Œå‚æ•°è§£æã€‚</p><p><strong>2. åŠŸèƒ½ä¸°å¯Œ</strong></p><p><code>clap</code>æä¾›äº†å¹¿æ³›çš„åŠŸèƒ½æ¥æ»¡è¶³å„ç§å‘½ä»¤è¡Œè§£æéœ€æ±‚ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š</p><ul><li><strong>è‡ªåŠ¨ç”Ÿæˆçš„å¸®åŠ©ä¿¡æ¯</strong>ï¼š<code>clap</code>èƒ½æ ¹æ®å®šä¹‰çš„å‚æ•°è‡ªåŠ¨ç”Ÿæˆå¸®åŠ©ä¿¡æ¯ï¼ŒåŒ…æ‹¬å‚æ•°çš„è¯´æ˜ã€ç±»å‹ã€é»˜è®¤å€¼ç­‰ã€‚</li><li><strong>å¼ºå¤§çš„é”™è¯¯æç¤º</strong>ï¼šå½“ç”¨æˆ·è¾“å…¥æ— æ•ˆçš„å‘½ä»¤è¡Œå‚æ•°æ—¶ï¼Œ<code>clap</code>ä¼šæä¾›æ¸…æ™°ä¸”æœ‰ç”¨çš„é”™è¯¯æç¤ºï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿå®šä½é—®é¢˜ã€‚</li><li><strong>å‚æ•°éªŒè¯</strong>ï¼šå¼€å‘è€…å¯ä»¥ä¸ºå‚æ•°è®¾å®šéªŒè¯è§„åˆ™ï¼Œç¡®ä¿è¾“å…¥çš„å‚æ•°ç¬¦åˆé¢„æœŸã€‚</li><li><strong>å¤æ‚çš„å‘½ä»¤ç»“æ„</strong>ï¼šæ”¯æŒå­å‘½ä»¤çš„åµŒå¥—ï¼Œå…è®¸æ„å»ºå¤æ‚çš„å‘½ä»¤è¡Œåº”ç”¨ç»“æ„ã€‚</li><li><strong>è‡ªå®šä¹‰æ´¾ç”Ÿ</strong>ï¼šé€šè¿‡ <code>clap</code>çš„æ´¾ç”Ÿå®ï¼Œå¯ä»¥ç®€åŒ–å‘½ä»¤è¡Œè§£æå™¨çš„å®šä¹‰ï¼Œä½¿ä»£ç æ›´åŠ æ¸…æ™°ã€‚</li></ul><p><strong>3. é«˜åº¦å¯å®šåˆ¶</strong></p><p><code>clap</code>å…è®¸å¼€å‘è€…é«˜åº¦å®šåˆ¶å‘½ä»¤è¡Œè§£æçš„è¡Œä¸ºå’Œå¤–è§‚ï¼ŒåŒ…æ‹¬è‡ªå®šä¹‰å¸®åŠ©ä¿¡æ¯çš„æ ¼å¼ã€æ§åˆ¶é”™è¯¯æ¶ˆæ¯çš„æ˜¾ç¤ºæ–¹å¼ç­‰ã€‚è¿™ç§çµæ´»æ€§æ„å‘³ç€ä½ å¯ä»¥æ ¹æ®åº”ç”¨ç¨‹åºçš„éœ€æ±‚è°ƒæ•´<code>clap</code> çš„è¡Œä¸ºã€‚</p><p><strong>4. æ€§èƒ½ä¼˜å¼‚</strong></p><p>å°½ç®¡ <code>clap</code>åŠŸèƒ½å¼ºå¤§ï¼Œä½†å®ƒä»ç„¶éå¸¸æ³¨é‡æ€§èƒ½ã€‚<code>clap</code>ç»è¿‡ä¼˜åŒ–ï¼Œä»¥å°½å¯èƒ½å°‘çš„æ€§èƒ½å¼€é”€å¤„ç†å‘½ä»¤è¡Œå‚æ•°ã€‚</p><p><strong>5. æ´»è·ƒçš„ç¤¾åŒºæ”¯æŒ</strong></p><p><code>clap</code> æœ‰ä¸€ä¸ªéå¸¸æ´»è·ƒçš„ç¤¾åŒºï¼Œåœ¨ GitHubä¸Šä¸æ–­æœ‰æ–°çš„è´¡çŒ®è€…åŠ å…¥ã€‚è¿™æ„å‘³ç€ <code>clap</code>ä¸æ–­åœ°å¾—åˆ°æ”¹è¿›å’Œæ›´æ–°ï¼ŒåŒæ—¶ä¹Ÿæœ‰å¤§é‡çš„ç¤¾åŒºèµ„æºå¯ä¾›å‚è€ƒã€‚</p><h2 id="derive-vs-builder-1-åˆæ¢">Derive vs Builder (1) åˆæ¢</h2><p><code>clap</code> æä¾›äº† 2 ç§æ„å»ºå‘½ä»¤è¡Œçš„æ–¹å¼ï¼Œåˆ†åˆ«ä¸º<code>Derive</code> å’Œ<code>Builder</code>ã€‚é¡¾åæ€ä¹‰ï¼Œ<code>Derive</code>å°±æ˜¯åˆ©ç”¨å®å¼ºå¤§çš„åŠŸèƒ½æ¥æ„å»ºå‘½ä»¤è¡Œï¼Œè€Œ <code>Builder</code>åˆ™é‡‡ç”¨æ„å»ºè€…æ¨¡å¼é“¾å¼æ„å»ºå‘½ä»¤è¡Œå·¥å…·ã€‚</p><p>åœ¨è¿™é‡Œæˆ‘ä»¬å…ˆç»™å‡ºç¤ºä¾‹æ¥ç›´è§‚æ„Ÿå—è¿™ 2 ç§æ„å»ºæ–¹å¼çš„ä¸åŒï¼š</p><p>Derive:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(version, author, about, long_about = None)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cli</span> &#123;<br>    <span class="hljs-comment">/// Specify your name</span><br>    name: <span class="hljs-type">String</span>,<br><br>    <span class="hljs-comment">/// Specify your age optionally</span><br>    <span class="hljs-meta">#[arg(short, long)]</span><br>    age: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">i8</span>&gt;,<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cli</span> = Cli::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;name: &#123;&#125;&quot;</span>, cli.name);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;age: &#123;:?&#125;&quot;</span>, cli.age);<br>&#125;<br></code></pre></td></tr></table></figure><p>Builder:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">matches</span> = Command::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;myapp&quot;</span>)<br>  .<span class="hljs-title function_ invoke__">version</span>(<span class="hljs-string">&quot;1.0.0&quot;</span>)<br>  .<span class="hljs-title function_ invoke__">author</span>(<span class="hljs-string">&quot;hedon&quot;</span>)<br>  .<span class="hljs-title function_ invoke__">about</span>(<span class="hljs-string">&quot;this is the short about&quot;</span>)<br>  .<span class="hljs-title function_ invoke__">long_about</span>(<span class="hljs-string">&quot;this is the long about&quot;</span>)<br>        .<span class="hljs-title function_ invoke__">arg</span>(arg!([NAME]).<span class="hljs-title function_ invoke__">required</span>(<span class="hljs-literal">true</span>).<span class="hljs-title function_ invoke__">help</span>(<span class="hljs-string">&quot;Specify your name&quot;</span>))<br>        .<span class="hljs-title function_ invoke__">arg</span>(arg!(-a --age &lt;AGE&gt;)<br>            .<span class="hljs-title function_ invoke__">value_parser</span>(clap::value_parser!(<span class="hljs-type">u8</span>))<br>            .<span class="hljs-title function_ invoke__">help</span>(<span class="hljs-string">&quot;Specify your age optionally&quot;</span>))<br>        .<span class="hljs-title function_ invoke__">get_matches</span>();<br><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;name: &#123;:?&#125;&quot;</span>, matches.get_one::&lt;<span class="hljs-type">String</span>&gt;(<span class="hljs-string">&quot;NAME&quot;</span>));<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;age: &#123;:?&#125;&quot;</span>, matches.get_one::&lt;<span class="hljs-type">u8</span>&gt;(<span class="hljs-string">&quot;age&quot;</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ 2 ä¸ªç¨‹åºéƒ½å®ç°äº†ç›¸åŒçš„åŠŸèƒ½ï¼Œä½¿ç”¨ <code>--help</code>ï¼Œè¾“å‡ºçš„å†…å®¹å¤§è‡´éƒ½å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">Usage: derive [OPTIONS] &lt;NAME&gt;<br><br>Arguments:<br>  &lt;NAME&gt;  Specify your name<br><br>Options:<br>  -a, --age &lt;AGE&gt;  Specify your age optionally<br>  -h, --<span class="hljs-built_in">help</span>       Print <span class="hljs-built_in">help</span><br></code></pre></td></tr></table></figure><p>é€šè¿‡è§‚å¯Ÿï¼Œå¯ä»¥å‘ç° Derive æ¨¡å¼ä¸‹ï¼Œå®ä¸­çš„æ¯ä¸€ä¸ªå±æ€§ï¼Œå¦‚<code>version</code>ã€<code>author</code> ç­‰ï¼Œéƒ½å¯¹åº”åˆ° Builderæ¨¡å¼ä¸‹ä¸€ä¸ªåŒåçš„å‡½æ•°ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å°†ä»<strong>ã€Œåº”ç”¨é…ç½®ã€</strong>ã€<strong>ã€Œå‚æ•°ç±»å‹ã€</strong>å’Œ<strong>ã€Œå‚æ•°æ ¡éªŒã€</strong>ä¸‰ä¸ªæ–¹é¢ï¼Œåˆ†åˆ«ä»‹ç»<code>clap</code> ä¸­ Derive å’Œ Builder ä¸¤ç§æ¨¡å¼æ„å»º CLI çš„å¸¸ç”¨æ–¹æ³•ã€‚</p><p>ç‰¹åˆ«è¯´æ˜ï¼šåç»­çš„ä¾‹å­å‡åœ¨ <code>examples</code>ç›®å½•ä¸‹å®ç°ï¼Œæ•…ç¼–è¯‘å’Œæ‰§è¡Œå‘½ä»¤éƒ½åŒ…å« exampleã€‚</p><p>ç›®å½•ç»“æ„å¤§æ¦‚å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  learn-clap git:(master) âœ— tree         <br>.<br>â”œâ”€â”€ Cargo.lock<br>â”œâ”€â”€ Cargo.toml<br>â”œâ”€â”€ examples<br>â”‚Â Â  â”œâ”€â”€ optional.rs<br>â”œâ”€â”€ src<br>â”‚   â””â”€â”€ main.rs<br>â””â”€â”€ target<br>    â””â”€â”€ release<br>        â””â”€â”€ examples<br>        â””â”€â”€ optional<br></code></pre></td></tr></table></figure><h2 id="derive">Derive</h2><p>è¦ä½¿ç”¨ <code>clap</code> çš„ Derive æ¨¡å¼ï¼Œéœ€è¦ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo add clap --features derive<br></code></pre></td></tr></table></figure><h3 id="åº”ç”¨é…ç½®">1. åº”ç”¨é…ç½®</h3><p>æˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ª <code>strut</code> æ¥è¡¨ç¤ºæˆ‘ä»¬çš„<code>application</code>ï¼Œåˆ©ç”¨å®ƒæ¥æ‰¿è½½åº”ç”¨çš„å‚æ•°ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">/// The example of clap derive</span><br><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(version, author, about, long_about = None)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cli</span> &#123;<br>    <span class="hljs-comment">/// Specify your name</span><br>    name: <span class="hljs-type">String</span>,<br><br>    <span class="hljs-comment">/// Specify your age optionally</span><br>    <span class="hljs-meta">#[arg(short, long)]</span><br>    age: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">i8</span>&gt;,<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cli</span> = Cli::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;name: &#123;&#125;&quot;</span>, cli.name);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;age: &#123;:?&#125;&quot;</span>, cli.age);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>#[derive(Parser)]</code> æ˜¯ä¸€ä¸ªè¿‡ç¨‹å®ï¼ˆproceduralmacroï¼‰ï¼Œç”¨äºè‡ªåŠ¨ä¸ºç»“æ„ä½“å®ç° <code>clap::Parser</code>traitã€‚è¿™ä½¿å¾—è¯¥ç»“æ„ä½“å¯ä»¥ç”¨æ¥è§£æå‘½ä»¤è¡Œå‚æ•°ã€‚</p><ul><li>ä½¿ç”¨<code>#[derive(Parser)]</code>ï¼Œä½ å¯ä»¥ç®€åŒ–å‘½ä»¤è¡Œè§£æçš„ä»£ç ï¼Œå› ä¸º<code>clap</code> ä¼šæ ¹æ®ç»“æ„ä½“çš„å­—æ®µè‡ªåŠ¨ç”Ÿæˆå‘½ä»¤è¡Œè§£æçš„é€»è¾‘ã€‚</li><li>æ¯ä¸ªå­—æ®µéƒ½å¯¹åº”ä¸€ä¸ªå‘½ä»¤è¡Œå‚æ•°ï¼Œå­—æ®µçš„ç±»å‹å’Œå±æ€§ç”¨æ¥å†³å®šå‚æ•°çš„è§£ææ–¹å¼å’ŒéªŒè¯è§„åˆ™ã€‚</li></ul><p><code>#[command(version, about, long_about = None)]</code>å±æ€§ç”¨äºä¸ºæ•´ä¸ªå‘½ä»¤è¡Œç¨‹åºæä¾›å…ƒä¿¡æ¯ï¼Œå®ƒæ”¯æŒä»¥ä¸‹å‡ ä¸ªå…ƒç´ ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240301202114143.png"alt="#[command] æ”¯æŒçš„å…ƒç´ " /><figcaption aria-hidden="true">#[command] æ”¯æŒçš„å…ƒç´ </figcaption></figure><p><code>#[arg(short, long)]</code>å±æ€§ç”¨äºé…ç½®å‘½ä»¤å‚æ•°çš„å…ƒä¿¡æ¯ï¼Œå®ƒæ”¯æŒä»¥ä¸‹å‡ ä¸ªå±æ€§ï¼š</p><table><thead><tr class="header"><th>å±æ€§</th><th>æ–¹æ³•</th><th>é»˜è®¤å€¼/è¡Œä¸º</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr class="odd"><td>id</td><td>Arg::id</td><td>fieldâ€™s name</td><td>å½“å±æ€§ä¸å­˜åœ¨æ—¶ï¼Œä½¿ç”¨å­—æ®µå</td></tr><tr class="even"><td>value_parser</td><td>Arg::value_parser</td><td>auto-select based on field type</td><td>å½“å±æ€§ä¸å­˜åœ¨æ—¶ï¼Œä¼šåŸºäºå­—æ®µç±»å‹è‡ªåŠ¨é€‰æ‹©å®ç°</td></tr><tr class="odd"><td>action</td><td>Arg::action</td><td>auto-select based on field type</td><td>å½“å±æ€§ä¸å­˜åœ¨æ—¶ï¼Œä¼šåŸºäºå­—æ®µç±»å‹è‡ªåŠ¨é€‰æ‹©åŠ¨ä½œ</td></tr><tr class="even"><td>help</td><td>Arg::help</td><td>Doc comment summary</td><td>å½“å±æ€§ä¸å­˜åœ¨æ—¶ï¼Œä½¿ç”¨æ–‡æ¡£æ³¨é‡Šæ‘˜è¦</td></tr><tr class="odd"><td>long_help</td><td>Arg::long_help</td><td>Doc comment with blank line, else nothing</td><td>å½“å±æ€§ä¸å­˜åœ¨æ—¶ï¼Œä½¿ç”¨æ–‡æ¡£æ³¨é‡Šï¼Œå¦‚æœæœ‰ç©ºè¡Œ</td></tr><tr class="even"><td>verbatim_doc_comment</td><td>Minimizes preprocessing</td><td>-</td><td>å°†æ–‡æ¡£æ³¨é‡Šè½¬æ¢ä¸º help/long_help æ—¶æœ€å°åŒ–é¢„å¤„ç†</td></tr><tr class="odd"><td>short</td><td>Arg::short</td><td>no short set</td><td>å½“å±æ€§ä¸å­˜åœ¨æ—¶ï¼Œæ²¡æœ‰çŸ­åç§°è®¾ç½®</td></tr><tr class="even"><td>long</td><td>Arg::long</td><td>no long set</td><td>å½“å±æ€§ä¸å­˜åœ¨æ—¶ï¼Œæ²¡æœ‰é•¿åç§°è®¾ç½®</td></tr><tr class="odd"><td>env</td><td>Arg::env</td><td>no env set</td><td>å½“å±æ€§ä¸å­˜åœ¨æ—¶ï¼Œæ²¡æœ‰ç¯å¢ƒå˜é‡è®¾ç½®</td></tr><tr class="even"><td>from_global</td><td>Read Arg::global</td><td>-</td><td>æ— è®ºåœ¨å“ªä¸ªå­å‘½ä»¤ä¸­ï¼Œéƒ½è¯»å– Arg::global å‚æ•°</td></tr><tr class="odd"><td>value_enum</td><td>Parse with ValueEnum</td><td>-</td><td>ä½¿ç”¨ ValueEnum è§£æå€¼</td></tr><tr class="even"><td>skip</td><td>Ignore this field</td><td>fills the field with Default::default()</td><td>å¿½ç•¥æ­¤å­—æ®µï¼Œç”¨ &lt;expr&gt; æˆ– Default::default() å¡«å……</td></tr><tr class="odd"><td>default_value</td><td>Arg::default_value</td><td>Arg::required(false)</td><td>è®¾ç½®é»˜è®¤å€¼ï¼Œå¹¶å°† Arg è®¾ç½®ä¸ºéå¿…é¡»</td></tr><tr class="even"><td>default_value_t</td><td>Arg::default_value</td><td>Arg::required(false)</td><td>è¦æ±‚ std::fmt::Display ä¸ Arg::value_parser ç›¸åŒ¹é…</td></tr><tr class="odd"><td>default_values_t</td><td>Arg::default_values</td><td>Arg::required(false)</td><td>è¦æ±‚å­—æ®µç±»å‹ä¸º Vec&lt;T&gt;ï¼ŒT å®ç° std::fmt::Display</td></tr><tr class="even"><td>default_value_os_t</td><td>Arg::default_value_os</td><td>Arg::required(false)</td><td>è¦æ±‚ std::convert::Into&lt;OsString&gt;</td></tr><tr class="odd"><td>default_values_os_t</td><td>Arg::default_values_os</td><td>Arg::required(false)</td><td>è¦æ±‚å­—æ®µç±»å‹ä¸º Vec&lt;T&gt;ï¼ŒTå®ç°std::convert::Into&lt;OsString&gt;</td></tr></tbody></table><h3 id="å‚æ•°ç±»å‹">2. å‚æ•°ç±»å‹</h3><h4 id="arguments-options">2.1 Arguments &amp; Options</h4><p>ä»ä¸Šé¢è¿™ä¸ªè¾“å‡ºæ ·ä¾‹ä¸­ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">the example of clap derive<br><br>Usage: derive [OPTIONS] &lt;NAME&gt;<br><br>Arguments:<br>  &lt;NAME&gt;  Specify your name<br><br>Options:<br>  -a, --age &lt;AGE&gt;  Specify your age optionally<br>  -h, --<span class="hljs-built_in">help</span>       Print <span class="hljs-built_in">help</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è·Ÿåœ¨å‘½ä»¤åé¢æœ‰ 2 ä¸­å‚æ•°ç±»å‹ï¼š</p><ul><li><strong>Arguments</strong>: ç›´æ¥åœ¨å‘½ä»¤åé¢æŒ‡å®šå€¼ï¼Œå¦‚<code>cmd hedon</code>ï¼Œæœ‰ä¸¥æ ¼çš„é¡ºåºè¦æ±‚ã€‚</li><li><strong>Options</strong>: éœ€è¦ç”¨ <code>-&#123;short&#125;</code> æˆ–<code>--&#123;long&#125;</code> æ¥æŒ‡å®šæ˜¯å“ªä¸ªå‚æ•°ï¼Œæ— ä¸¥æ ¼çš„é¡ºåºè¦æ±‚ã€‚</li></ul><p>å®ƒä»¬çš„å®šä¹‰åŒºåˆ«å°±æ˜¯æ˜¯å¦ä½¿ç”¨äº† <code>#[arg]</code>ï¼š</p><ul><li><strong>Options</strong>: æŒ‡å®šäº† short æˆ– longã€‚</li><li><strong>Arguments</strong>: æ²¡æœ‰ short å’Œ longã€‚</li></ul><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cli</span> &#123;<br>  <span class="hljs-comment">/// ä¼šè¢«è§£ææˆ [NAME]</span><br>  name: <span class="hljs-type">String</span>,<br>  <br>  <span class="hljs-comment">/// ä¼šè¢«è§£ææˆ -a &lt;AGE&gt;</span><br>  <span class="hljs-meta">#[arg(short, long)]</span><br>  age: <span class="hljs-type">u8</span>,<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å¯é€‰å‚æ•°">2.2 å¯é€‰å‚æ•°</h4><p>å¯ä»¥ä½¿ç”¨ <code>Option</code> æ¥å®ç°å¯é€‰å‚æ•°ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::Parser;<br><br><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(version, author, about, long_about = None)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cli</span> &#123;<br>    name: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">String</span>&gt;,<br><br>    <span class="hljs-meta">#[arg(short, long)]</span><br>    age: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">u8</span>&gt;,<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cli</span> = Cli::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;name: &#123;:?&#125;&quot;</span>, cli.name);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;age: &#123;:?&#125;&quot;</span>, cli.age);<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo build --example optional --release<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">/target/release/examples/optional --<span class="hljs-built_in">help</span> <br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">this is the about from Cargo.toml<br><br>Usage: optional [OPTIONS] [NAME]<br><br>Arguments:<br>  [NAME]  <br><br>Options:<br>  -a, --age &lt;AGE&gt;  <br>  -h, --<span class="hljs-built_in">help</span>       Print <span class="hljs-built_in">help</span><br>  -V, --version    Print version<br></code></pre></td></tr></table></figure><p>æµ‹è¯•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  learn-clap git:(master) âœ— ./target/release/examples/optional       <br>name: None<br>age: None<br>âœ  learn-clap git:(master) âœ— ./target/release/examples/optional -a 1  <br>name: None<br>age: Some(1)<br>âœ  learn-clap git:(master) âœ— ./target/release/examples/optional hedon  <br>name: Some(<span class="hljs-string">&quot;hedon&quot;</span>)<br>age: None<br>âœ  learn-clap git:(master) âœ— ./target/release/examples/optional hedon -a 18<br>name: Some(<span class="hljs-string">&quot;hedon&quot;</span>)<br>age: Some(18)<br></code></pre></td></tr></table></figure><h4 id="æšä¸¾å‚æ•°">2.3 æšä¸¾å‚æ•°</h4><p>å¯ä»¥ä½¿ç”¨ <code>enum</code> æ­é… <code>value_enum</code>æ¥å®ç°å¤šé€‰ä¸€å‚æ•°ï¼Œå¹¶é™åˆ¶å¯é€‰å‚æ•°çš„å–å€¼ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::&#123;Parser, ValueEnum&#125;;<br><br><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(version, author, about, long_about = None)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cli</span> &#123;<br>    <span class="hljs-comment">/// Choose the program mode run in</span><br>    <span class="hljs-meta">#[arg(value_enum)]</span><br>    mode: Mode,<br>&#125;<br><br><span class="hljs-meta">#[derive(Copy, Clone, PartialEq, Eq, PartialOrd, Ord, ValueEnum)]</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Mode</span> &#123;<br>    <span class="hljs-comment">/// run in fast mode</span><br>    Fast,<br>    <span class="hljs-comment">/// run in slow mode</span><br>    Slow,<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cli</span> = Cli::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-keyword">match</span> cli.mode &#123;<br>        Mode::Fast =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;fast!!!!!&quot;</span>),<br>        Mode::Slow =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;slow......&quot;</span>),<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">Usage: enum &lt;MODE&gt;<br><br>Arguments:<br>  &lt;MODE&gt;<br>          Choose the program mode run <span class="hljs-keyword">in</span><br><br>          Possible values:<br>          - fast: run <span class="hljs-keyword">in</span> fast mode<br>          - slow: run <span class="hljs-keyword">in</span> slow mode<br><br>Options:<br>  -h, --<span class="hljs-built_in">help</span><br>          Print <span class="hljs-built_in">help</span> (see a summary with <span class="hljs-string">&#x27;-h&#x27;</span>)<br><br>  -V, --version<br>          Print version<br></code></pre></td></tr></table></figure><h4 id="ç´¯è®¡å‚æ•°">2.4 ç´¯è®¡å‚æ•°</h4><p>ç´¯ç§¯å‚æ•°å…è®¸ç”¨æˆ·é€šè¿‡é‡å¤æŒ‡å®šåŒä¸€ä¸ªæ ‡å¿—ï¼ˆä¾‹å¦‚<code>-d</code>ï¼‰æ¥ç´¯åŠ å€¼æˆ–æ•ˆæœï¼Œé€šå¸¸ç”¨äºæ§åˆ¶å‘½ä»¤è¡Œåº”ç”¨çš„è¯¦ç»†çº§åˆ«ï¼ˆverbositylevelï¼‰æˆ–å…¶ä»–éœ€è¦æ ¹æ®æ¬¡æ•°å˜åŒ–çš„è¡Œä¸ºã€‚</p><p>åœ¨å¾ˆå¤šå‘½ä»¤è¡Œå·¥å…·ä¸­ï¼Œç´¯ç§¯å‚æ•°å¸¸è§äºæ§åˆ¶æ—¥å¿—è¾“å‡ºçš„è¯¦ç»†ç¨‹åº¦ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ª<code>-v</code>ï¼ˆverboseï¼‰æ ‡å¿—å¯èƒ½æ¯è¢«æŒ‡å®šä¸€æ¬¡ï¼Œå°±å¢åŠ ä¸€å±‚è¯¦ç»†çº§åˆ«ã€‚æ‰€ä»¥ï¼Œ<code>-vvv</code>ï¼ˆç­‰ä»·äº<code>-v -v -v</code>ï¼‰ ä¼šæ¯”å•ä¸ª <code>-v</code>æä¾›æ›´å¤šçš„è¯¦ç»†ä¿¡æ¯ã€‚</p><p>åœ¨ <code>clap</code> ä¸­å¯ä»¥é€šè¿‡ <code>clap::ArgAction::Count</code>æ¥å®ç°è¿™ç§ç´¯ç§¯å‚æ•°ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::Parser;<br><br><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(version, author, about, long_about = None)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cli</span> &#123;<br>    <span class="hljs-meta">#[arg(short, long, action = clap::ArgAction::Count)]</span><br>    verbose: <span class="hljs-type">u8</span>,<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cli</span> = Cli::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;verbose: &#123;&#125;&quot;</span>, cli.verbose);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  learn-clap git:(master) âœ— ./target/release/examples/accurate --<span class="hljs-built_in">help</span><br>this is the about from Cargo.toml<br><br>Usage: accurate [OPTIONS]<br><br>Options:<br>  -v, --verbose...  <br>  -h, --<span class="hljs-built_in">help</span>        Print <span class="hljs-built_in">help</span><br>  -V, --version     Print version<br>âœ  learn-clap git:(master) âœ— ./target/release/examples/accurate -v    <br>verbose: 1<br>âœ  learn-clap git:(master) âœ— ./target/release/examples/accurate -vvvv<br>verbose: 4<br></code></pre></td></tr></table></figure><h4 id="å˜é•¿å‚æ•°">2.5 å˜é•¿å‚æ•°</h4><p>æœ‰æ—¶å€™æˆ‘ä»¬å¸Œæœ›æ¥æ”¶å˜é•¿å‚æ•°ï¼Œæ¯”å¦‚è¯´ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">del file1 file2 file3<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™å¯ä»¥ä½¿ç”¨ <code>Vec&lt;&gt;</code> æ¥å®ç°ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::Parser;<br><br><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(version, author, about, long_about = None)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cli</span> &#123;<br>    files: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">String</span>&gt;,<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cli</span> = Cli::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;files: &#123;:?&#125;&quot;</span>, cli.files);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  learn-clap git:(master) âœ— ./target/release/examples/var_length --<span class="hljs-built_in">help</span><br>this is the about from Cargo.toml<br><br>Usage: var_length [FILES]...<br><br>Arguments:<br>  [FILES]...  <br><br>Options:<br>  -h, --<span class="hljs-built_in">help</span>     Print <span class="hljs-built_in">help</span><br>  -V, --version  Print version<br>âœ  learn-clap git:(master) âœ— ./target/release/examples/var_length       <br>files: []<br>âœ  learn-clap git:(master) âœ— ./target/release/examples/var_length file1 <br>files: [<span class="hljs-string">&quot;file1&quot;</span>]<br>âœ  learn-clap git:(master) âœ— ./target/release/examples/var_length file1 file2<br>files: [<span class="hljs-string">&quot;file1&quot;</span>, <span class="hljs-string">&quot;file2&quot;</span>]<br>âœ  learn-clap git:(master) âœ— ./target/release/examples/var_length file1 file2 file3<br>files: [<span class="hljs-string">&quot;file1&quot;</span>, <span class="hljs-string">&quot;file2&quot;</span>, <span class="hljs-string">&quot;file3&quot;</span>]<br></code></pre></td></tr></table></figure><h4 id="æ ‡å¿—å‚æ•°">2.6 æ ‡å¿—å‚æ•°</h4><p>å¯¹äºæ ‡å¿—å‚æ•°ï¼Œåªè¦æŒ‡å®šç±»å‹ä¸º<code>bool</code>ï¼Œå°±å¯ä»¥è‡ªåŠ¨å®ç°äº†ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::Parser;<br><br><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(version, author, about, long_about = None)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cli</span> &#123;<br>    <span class="hljs-meta">#[arg(short, long)]</span><br>    verbose: <span class="hljs-type">bool</span>,<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cli</span> = Cli::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;verbose: &#123;&#125;&quot;</span>, cli.verbose);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  learn-clap git:(master) âœ— ./target/release/examples/flag --<span class="hljs-built_in">help</span><br>Usage: flag [OPTIONS]<br><br>Options:<br>  -v, --verbose  <br>  -h, --<span class="hljs-built_in">help</span>     Print <span class="hljs-built_in">help</span><br>  -V, --version  Print version<br>âœ  learn-clap git:(master) âœ— ./target/release/examples/flag       <br>verbose: <span class="hljs-literal">false</span><br>âœ  learn-clap git:(master) âœ— ./target/release/examples/flag -v    <br>verbose: <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><h4 id="å­å‘½ä»¤">2.7 å­å‘½ä»¤</h4><p>åœ¨æ›´å¤æ‚çš„å‘½ä»¤è¡Œå·¥å…·ä¸­ï¼Œé™¤äº†ä¸»å‘½ä»¤ï¼Œè¿˜æœ‰å­å‘½ä»¤ï¼Œç”šè‡³å­å‘½ä»¤ä¸‹é¢è¿˜æœ‰å­å‘½ä»¤ï¼Œå…¶å®å°±æ˜¯ä¸€é¢—å‘½ä»¤æ ‘ã€‚</p><figure><imgsrc="https://cdn.jsdelivr.net/gh/hedon954/mapStorage/img/image-20240228183301763.png"alt="command tree" /><figcaption aria-hidden="true">command tree</figcaption></figure><p>åœ¨ <code>clap</code> ä¸­å¯ä»¥ä½¿ç”¨ <code>#[command(subcommand)]</code>æ­é… <code>#[derive(Subcommand)]</code> å®ç°å­å‘½ä»¤åŠŸèƒ½ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::&#123;Parser, Subcommand&#125;;<br><br><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(version, author, about, long_about = None)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cli</span> &#123;<br>    <span class="hljs-meta">#[command(subcommand)]</span><br>    test: <span class="hljs-type">Option</span>&lt;Test&gt;,<br>&#125;<br><br><span class="hljs-meta">#[derive(Subcommand)]</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-comment">/// Add a number</span><br>    Add &#123;<br>        <span class="hljs-meta">#[arg(short, long)]</span><br>        num: <span class="hljs-type">u16</span>,<br>    &#125;,<br>    <span class="hljs-comment">/// Sub a number</span><br>    Sub &#123;<br>        <span class="hljs-meta">#[arg(short, long)]</span><br>        num: <span class="hljs-type">u16</span>,<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cli</span> = Cli::<span class="hljs-title function_ invoke__">parse</span>();<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(test) = cli.test &#123;<br>        <span class="hljs-keyword">match</span> test &#123;<br>            Test::Add &#123;num&#125; =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;test add num: &#123;:?&#125;&quot;</span>, num),<br>            Test::Sub &#123;num&#125; =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;test sub num: &#123;:?&#125;&quot;</span>, num),<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  learn-clap git:(master) âœ— ./target/release/examples/subcommand --<span class="hljs-built_in">help</span>      <br>this is the about from Cargo.toml<br><br>Usage: subcommand [COMMAND]<br><br>Commands:<br>  add   Add a number<br>  sub   Sub a number<br>  <span class="hljs-built_in">help</span>  Print this message or the <span class="hljs-built_in">help</span> of the given subcommand(s)<br><br>Options:<br>  -h, --<span class="hljs-built_in">help</span>     Print <span class="hljs-built_in">help</span><br>  -V, --version  Print version<br>âœ  learn-clap git:(master) âœ— ./target/release/examples/subcommand add --<span class="hljs-built_in">help</span><br>Add a number<br><br>Usage: subcommand add --num &lt;NUM&gt;<br><br>Options:<br>  -n, --num &lt;NUM&gt;  <br>  -h, --<span class="hljs-built_in">help</span>       Print <span class="hljs-built_in">help</span><br>âœ  learn-clap git:(master) âœ— ./target/release/examples/subcommand add -n 1  <br><span class="hljs-built_in">test</span> add num: 1<br>âœ  learn-clap git:(master) âœ— ./target/release/examples/subcommand sub -n 2<br><span class="hljs-built_in">test</span> sub num: 2<br></code></pre></td></tr></table></figure><h3 id="å‚æ•°æ ¡éªŒ">3. å‚æ•°æ ¡éªŒ</h3><h4 id="ç±»å‹æ ¡éªŒ">3.1 ç±»å‹æ ¡éªŒ</h4><p>å¯ä»¥å‘ç°ï¼Œä½¿ç”¨ Deriveæ¨¡å¼çš„æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨å‚æ•°åé¢æŒ‡å®šå‚æ•°ç±»å‹çš„æ—¶å€™ï¼Œ<code>clap</code>å°±ä¼šå¯¹æˆ‘ä»¬è¾“å…¥å‚æ•°è¿›è¡Œç±»å‹æ£€æŸ¥ï¼Œä¸åŒ¹é…çš„æ—¶å€™ä¼šè¾“å‡ºä¸°å¯Œçš„æŠ¥é”™ä¿¡æ¯å’ŒæŒ‡å¯¼å»ºè®®ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">error: invalid value <span class="hljs-string">&#x27;xxxx&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;--num &lt;NUM&gt;&#x27;</span>: invalid digit found <span class="hljs-keyword">in</span> string<br><br>For more information, try <span class="hljs-string">&#x27;--help&#x27;</span>.<br></code></pre></td></tr></table></figure><p>é»˜è®¤æ”¯æŒï¼š</p><ul><li>åŸç”Ÿç±»å‹ï¼š<code>bool</code>, <code>String</code>,<code>OsString</code>,<code>PathBuf</code>ã€<code>usize</code>ã€<code>isize</code></li><li>èŒƒå›´æ•°æ®ï¼š<code>u8</code>, <code>i8</code>, <code>u16</code>,<code>i16</code>, <code>u32</code>, <code>i32</code>, <code>u64</code>,<code>i64</code></li><li>å®ç°äº† <code>ValueEnum</code> çš„ enum ç±»å‹</li><li>å®ç°äº†<code>From&lt;OsString&gt;</code>ã€<code>From&lt;&amp;OsStr&gt;</code>ã€<code>FromStr</code> çš„ç±»å‹</li></ul><p>è¿™æ˜¯å› ä¸ºä»–ä»¬éƒ½å®ç°äº† <code>TypedValueParser</code>traitï¼Œä½ è‡ªå®šä¹‰çš„ç±»å‹ä¹Ÿå¯ä»¥å®ç°è¿™ä¸ªtriatï¼Œè¿™æ ·å°±å¯ä»¥è‡ªåŠ¨è¿›è¡Œç±»å‹æ ¡éªŒäº†ã€‚</p><p><code>clap</code> è¿˜æä¾›äº†ä¸€äº›æ›´åŠ ä¸¥æ ¼çš„å‚æ•°æ ¡éªŒåŠŸèƒ½ã€‚ğŸ‘‡ğŸ»</p><h4 id="æšä¸¾æ ¡éªŒ">3.2 æšä¸¾æ ¡éªŒ</h4><p>å¯¹äºå®ç° <code>ValueEnum</code>çš„æšä¸¾ç±»å‹ï¼Œå¦‚æœè¾“å…¥çš„å€¼ä¸æ˜¯æšä¸¾ä¸­å®šä¹‰çš„ï¼Œåˆ™ <code>clap</code>ä¼šæŠ¥é”™å¹¶æç¤ºå¯é€‰å€¼ã€‚</p><p>æˆ‘ä»¬å¤ç”¨ä¸Šé¢ä»‹ç»ã€Œå¤šé€‰ä¸€å‚æ•°ã€çš„ä»£ç ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::&#123;Parser, ValueEnum&#125;;<br><br><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(version, author, about, long_about = None)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cli</span> &#123;<br>    <span class="hljs-comment">/// Choose the program mode run in</span><br>    <span class="hljs-meta">#[arg(value_enum)]</span><br>    mode: Mode,<br>&#125;<br><br><span class="hljs-meta">#[derive(Copy, Clone, PartialEq, Eq, PartialOrd, Ord, ValueEnum)]</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Mode</span> &#123;<br>    <span class="hljs-comment">/// run in fast mode</span><br>    Fast,<br>    <span class="hljs-comment">/// run in slow mode</span><br>    Slow,<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cli</span> = Cli::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-keyword">match</span> cli.mode &#123;<br>        Mode::Fast =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;fast!!!!!&quot;</span>),<br>        Mode::Slow =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;slow......&quot;</span>),<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨é”™è¯¯çš„å€¼è¿›è¡Œå°è¯•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  learn-clap git:(master) âœ— ./target/release/examples/enum xxxx               <br>error: invalid value <span class="hljs-string">&#x27;xxxx&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;&lt;MODE&gt;&#x27;</span><br>  [possible values: fast, slow]<br><br>For more information, try <span class="hljs-string">&#x27;--help&#x27;</span>.<br></code></pre></td></tr></table></figure><h4 id="èŒƒå›´æ ¡éªŒ">3.3 èŒƒå›´æ ¡éªŒ</h4><p>å¦‚æœä½ æƒ³è¦å®ç°æ•°å­—ç±»å‹èŒƒå›´é™åˆ¶çš„è¯ï¼Œæ¯”å¦‚ç«¯å£å·å‚æ•°çš„èŒƒå›´åº”è¯¥æ˜¯ [1,65535]ï¼Œé‚£å¯ä»¥ä½¿ç”¨<code>value_parser! = clap::value_parser!(u16).range(1..)</code>æ¥å®ç°è¿™ä¸ªåŠŸèƒ½ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::Parser;<br><br><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(version, author, about, long_about = None)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cli</span> &#123;<br>    <span class="hljs-meta">#[arg(short, long, value_parser = clap::value_parser!(u16).range(1..))]</span><br>    port: <span class="hljs-type">u16</span>,<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cli</span> = Cli::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;port: &#123;:?&#125;&quot;</span>, cli.port);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  learn-clap git:(master) âœ— ./target/release/examples/range --<span class="hljs-built_in">help</span>             <br>this is the about from Cargo.toml<br><br>Usage: range --port &lt;PORT&gt;<br><br>Options:<br>  -p, --port &lt;PORT&gt;  <br>  -h, --<span class="hljs-built_in">help</span>         Print <span class="hljs-built_in">help</span><br>  -V, --version      Print version<br>  <br>âœ  learn-clap git:(master) âœ— ./target/release/examples/range -p 0  <br>error: invalid value <span class="hljs-string">&#x27;0&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;--port &lt;PORT&gt;&#x27;</span>: 0 is not <span class="hljs-keyword">in</span> 1..=65535<br><br>For more information, try <span class="hljs-string">&#x27;--help&#x27;</span>.<br><br>âœ  learn-clap git:(master) âœ— ./target/release/examples/range -p 11111111<br>error: invalid value <span class="hljs-string">&#x27;11111111&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;--port &lt;PORT&gt;&#x27;</span>: 11111111 is not <span class="hljs-keyword">in</span> 1..=65535<br><br>For more information, try <span class="hljs-string">&#x27;--help&#x27;</span>.<br><br>âœ  learn-clap git:(master) âœ— ./target/release/examples/range -p 1111    <br>port: 1111<br></code></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>value_parser = clap::value_parser!(u16).range(1..)</code>çš„å«ä¹‰å¯ä»¥åˆ†ä¸ºä¸¤éƒ¨åˆ†è§£é‡Šï¼š</p><p><strong>1. clap::value_parser!(u16)</strong></p><p>è¿™éƒ¨åˆ†ä½¿ç”¨ <code>value_parser!</code> å®ä¸ºå‘½ä»¤è¡Œå‚æ•°æŒ‡å®šäº†<code>u16</code> ç±»å‹çš„è§£æå™¨ã€‚è¿™æ„å‘³ç€è¾“å…¥çš„å‚æ•°å€¼ä¼šè¢«å°è¯•è§£æä¸ºæ— ç¬¦å·16 ä½æ•´æ•°ï¼ˆ<code>u16</code>ï¼‰ã€‚å¦‚æœè¾“å…¥ä¸èƒ½è¢«æˆåŠŸè§£æä¸º <code>u16</code>ç±»å‹ï¼ˆä¾‹å¦‚ï¼Œè¾“å…¥æ˜¯éæ•°å­—å­—ç¬¦ä¸²æˆ–è€…æ•°å­—è¿‡å¤§/è¿‡å°è€Œä¸ç¬¦åˆ <code>u16</code>çš„èŒƒå›´ï¼‰ï¼Œ<code>clap</code> ä¼šæŠ¥é”™å¹¶æç¤ºç”¨æˆ·è¾“å…¥æœ‰æ•ˆçš„å‚æ•°å€¼ã€‚</p><p><strong>2. .range(1..)</strong></p><p>è¿™éƒ¨åˆ†è¿›ä¸€æ­¥é™åˆ¶äº†å‚æ•°å€¼çš„æœ‰æ•ˆèŒƒå›´ã€‚<code>.range(1..)</code>æŒ‡å®šäº†å‚æ•°å€¼å¿…é¡»å¤§äºæˆ–ç­‰äº 1ï¼ˆåŒ…å« 1ï¼‰ï¼Œä½†æ²¡æœ‰ä¸Šé™ã€‚æ¢å¥è¯è¯´ï¼Œä»»ä½•å°äº 1çš„å€¼éƒ½å°†è¢«è®¤ä¸ºæ˜¯æ— æ•ˆçš„ï¼Œ<code>clap</code>ä¼šå› æ­¤æŠ¥é”™å¹¶è¦æ±‚ç”¨æˆ·è¾“å…¥ä¸€ä¸ªç¬¦åˆèŒƒå›´è¦æ±‚çš„å€¼ã€‚è¿™åœ¨éœ€è¦é™å®šå‚æ•°å€¼ä¸ºæ­£æ•°æ—¶éå¸¸æœ‰ç”¨ã€‚</p><p>ç»“åˆèµ·æ¥ï¼Œ<code>value_parser = clap::value_parser!(u16).range(1..)</code>åˆ›å»ºäº†ä¸€ä¸ªè§„åˆ™ï¼Œè¦æ±‚å‘½ä»¤è¡Œå‚æ•°å¿…é¡»æ˜¯ä¸€ä¸ªå¤§äºæˆ–ç­‰äº 1 çš„ <code>u16</code>ç±»å‹çš„æ•°å€¼ã€‚è¿™åœ¨å¾ˆå¤šåœºæ™¯ä¸‹éƒ½éå¸¸æœ‰ç”¨ï¼Œæ¯”å¦‚å½“ä½ éœ€è¦ç”¨æˆ·æŒ‡å®šä¸€ä¸ªæ­£æ•°ç«¯å£å·æ—¶ã€‚</p><p>åœ¨ RustRover ä¸­ï¼Œä½ å¯ä»¥åœ¨ Builder æ¨¡å¼ï¼Œé€šè¿‡åœ¨<code>clap::value_parser!()</code> ä¸­æŒ‡å®šå…¶ä»–çš„ç±»å‹ï¼Œç„¶åè¾“å…¥<code>.</code> è·å¾—å…¶ä»–ç±»å‹çš„å†…ç½®æ ¡éªŒè§„åˆ™ã€‚</p><h4 id="è‡ªå®šä¹‰æ ¡éªŒ">3.4 è‡ªå®šä¹‰æ ¡éªŒ</h4><p>å¯¹äºæ›´å¤æ‚çš„è§„åˆ™ï¼Œ<code>clap</code> è¿˜æ”¯æŒè‡ªå®šä¹‰æ ¡éªŒè§„åˆ™ã€‚æ¯”å¦‚ä¸Šé¢å¯¹port çš„æ ¡éªŒï¼Œä¹Ÿå¯ä»¥è‡ªå·±å®ç°ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> std::ops::RangeInclusive;<br><span class="hljs-keyword">use</span> clap::Parser;<br><br><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(version, author, about, long_about = None)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cli</span> &#123;<br>    <span class="hljs-meta">#[arg(short, long, value_parser = parse_port)]</span><br>    port: <span class="hljs-type">u16</span>,<br>&#125;<br><br><span class="hljs-keyword">const</span> PORT_RANGE: RangeInclusive&lt;<span class="hljs-type">usize</span>&gt; = <span class="hljs-number">1</span>..=<span class="hljs-number">65535</span>;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">parse_port</span>(s: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-type">u16</span>, <span class="hljs-type">String</span>&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">port</span>: <span class="hljs-type">usize</span> = s<br>        .<span class="hljs-title function_ invoke__">parse</span>()<br>        .<span class="hljs-title function_ invoke__">map_err</span>(|_| <span class="hljs-built_in">format!</span>(<span class="hljs-string">&quot;`&#123;s&#125;` isn&#x27;t a port number`&quot;</span>))?;<br><br>    <span class="hljs-keyword">if</span> PORT_RANGE.<span class="hljs-title function_ invoke__">contains</span>(&amp;port) &#123;<br>        <span class="hljs-title function_ invoke__">Ok</span>(port <span class="hljs-keyword">as</span> <span class="hljs-type">u16</span>)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-title function_ invoke__">Err</span>(<span class="hljs-built_in">format!</span>(<br>            <span class="hljs-string">&quot;port not in range &#123;&#125;-&#123;&#125;&quot;</span>,<br>            PORT_RANGE.<span class="hljs-title function_ invoke__">start</span>(),<br>            PORT_RANGE.<span class="hljs-title function_ invoke__">end</span>(),<br>        ))<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cli</span> = Cli::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;port: &#123;:?&#125;&quot;</span>, cli.port);<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ä»£ç ä¸­ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ <code>value_parser = parse_port</code>æ¥æŒ‡å®šè‡ªå®šä¹‰çš„æ ¡éªŒè§„åˆ™ã€‚</p><p>æˆ‘ä»¬è‡ªå®šä¹‰çš„æ ¡éªŒè§„åˆ™ä¸ºï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">parse_port</span>(s: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-type">u16</span>, <span class="hljs-type">String</span>&gt; &#123;&#125;<br></code></pre></td></tr></table></figure><p>å®ƒéœ€è¦æ»¡è¶³ï¼š</p><ul><li>å…¥å‚æ˜¯ &amp;str</li><li>å‡ºå‚æ˜¯ Result&lt;å‚æ•°ç±»å‹, String&gt;</li></ul><p>å¯ä»¥æµ‹è¯•è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  learn-clap git:(master) âœ— ./target/release/examples/custom --<span class="hljs-built_in">help</span><br>this is the about from Cargo.toml<br><br>Usage: custom --port &lt;PORT&gt;<br><br>Options:<br>  -p, --port &lt;PORT&gt;  <br>  -h, --<span class="hljs-built_in">help</span>         Print <span class="hljs-built_in">help</span><br>  -V, --version      Print version<br>  <br>âœ  learn-clap git:(master) âœ— ./target/release/examples/custom -p xxx<br>error: invalid value <span class="hljs-string">&#x27;xxx&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;--port &lt;PORT&gt;&#x27;</span>: `xxx` isn<span class="hljs-string">&#x27;t a port number`</span><br><span class="hljs-string"></span><br><span class="hljs-string">For more information, try &#x27;</span>--<span class="hljs-built_in">help</span><span class="hljs-string">&#x27;.</span><br><span class="hljs-string"></span><br><span class="hljs-string">âœ  learn-clap git:(master) âœ— ./target/release/examples/custom -p 0  </span><br><span class="hljs-string">error: invalid value &#x27;</span>0<span class="hljs-string">&#x27; for &#x27;</span>--port &lt;PORT&gt;<span class="hljs-string">&#x27;: port not in range 1-65535</span><br><span class="hljs-string"></span><br><span class="hljs-string">For more information, try &#x27;</span>--<span class="hljs-built_in">help</span><span class="hljs-string">&#x27;.</span><br><span class="hljs-string"></span><br><span class="hljs-string">âœ  learn-clap git:(master) âœ— ./target/release/examples/custom -p 9527</span><br><span class="hljs-string">port: 9527</span><br></code></pre></td></tr></table></figure><h4 id="å…³è”å‚æ•°">3.5 å…³è”å‚æ•°</h4><p>æœ‰æ—¶å€™å‚æ•°ç›´æ¥è¿˜æœ‰å…³è”å…³ç³»ï¼Œæ¯”å¦‚è¯´ï¼š</p><ul><li>ä¾èµ–ï¼šå¿…é¡»å­˜åœ¨ <code>-a</code> å‚æ•°ï¼Œ<code>-b</code>å‚æ•°æ‰æœ‰æ„ä¹‰ï¼Œå³è¦ä½¿ç”¨ <code>-b</code> å‚æ•°æ—¶ï¼Œå¿…é¡»æŒ‡å®š <code>-a</code>å‚æ•°ã€‚</li><li>äº’æ–¥ï¼š<code>-a</code> å’Œ <code>-b</code> åªèƒ½åŒæ—¶å­˜åœ¨ä¸€ä¸ªã€‚</li></ul><p><strong>å¯ä»¥ä½¿ç”¨ requires å®ç°ä¾èµ–å…³ç³»ï¼š</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::Parser;<br><br><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(version, author, about, long_about = None)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cli</span> &#123;<br>    <span class="hljs-meta">#[arg(short, long)]</span><br>    a: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">String</span>&gt;,<br><br>    <span class="hljs-meta">#[arg(short, long,requires = <span class="hljs-string">&quot;a&quot;</span>)]</span><br>    b: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">String</span>&gt;,<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cli</span> = Cli::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;a: &#123;:?&#125;&quot;</span>, cli.a);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;b: &#123;:?&#125;&quot;</span>, cli.b);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬åœ¨å‚æ•° <code>b</code> ä¸­åŠ å…¥äº†<code>requires = "a"</code>ï¼Œè¡¨ç¤ºè¦ä½¿ç”¨ <code>b</code> å‚æ•°å¿…é¡»è¦æœ‰<code>a</code> å‚æ•°ã€‚</p><p>è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  learn-clap git:(master) âœ— ./target/release/examples/relation      <br>a: None<br>b: None<br>âœ  learn-clap git:(master) âœ— ./target/release/examples/relation -b 1 <br>error: the following required arguments were not provided:<br>  --a &lt;A&gt;<br><br>Usage: relation --a &lt;A&gt; --b &lt;B&gt;<br><br>For more information, try <span class="hljs-string">&#x27;--help&#x27;</span>.<br><br>âœ  learn-clap git:(master) âœ— ./target/release/examples/relation -a 1<br>a: Some(<span class="hljs-string">&quot;1&quot;</span>)<br>b: None<br><br>âœ  learn-clap git:(master) âœ— ./target/release/examples/relation -a 1 -b 2<br>a: Some(<span class="hljs-string">&quot;1&quot;</span>)<br>b: Some(<span class="hljs-string">&quot;2&quot;</span>)<br></code></pre></td></tr></table></figure><p><strong>å¯ä»¥ä½¿ç”¨ #[group(required = true, mutiple = false)]æ¥å®ç°äº’æ–¥å…³ç³»ï¼š</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::&#123;Args, Parser&#125;;<br><br><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(version, author, about, long_about = None)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cli</span> &#123;<br>    <span class="hljs-meta">#[command(flatten)]</span><br>    args: Only,<br>&#125;<br><br><span class="hljs-meta">#[derive(Args, Debug)]</span><br><span class="hljs-meta">#[group(required = true, multiple = false)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Only</span> &#123;<br>    <span class="hljs-meta">#[arg(long)]</span><br>    a: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">String</span>&gt;,<br>    <span class="hljs-meta">#[arg(long)]</span><br>    b: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">String</span>&gt;,<br>    <span class="hljs-meta">#[arg(long)]</span><br>    c: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">String</span>&gt;,<br>    <span class="hljs-meta">#[arg(long)]</span><br>    d: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">String</span>&gt;,<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cli</span> = Cli::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;only: &#123;:?&#125;&quot;</span>, cli.args)<br>&#125;<br></code></pre></td></tr></table></figure><p><code>#[command(flattern)]</code> ç›´æ¥å°†ç»“æ„ä½“é‡Œé¢çš„å‚æ•°å¹³é“ºã€‚</p><p><code>#[group]</code>ç”¨äºå°†ä¸€ç»„å‚æ•°å½’ä¸ºä¸€ä¸ªç»„ï¼Œ<code>required = true</code> è¡¨ç¤ºå¿…é¡»æä¾›è¯¥group ä¸­çš„å‚æ•°ï¼Œ<code>multiple = false</code>è¡¨ç¤ºåªèƒ½æœ‰ä¸€ä¸ªå‚æ•°è¢«æä¾›ã€‚</p><p>æµ‹è¯•è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  learn-clap git:(master) âœ— ./target/release/examples/only_one --<span class="hljs-built_in">help</span><br>this is the about from Cargo.toml<br><br>Usage: only_one &lt;--a &lt;A&gt;|--b &lt;B&gt;|--c &lt;C&gt;|--d &lt;D&gt;&gt;<br><br>Options:<br>      --a &lt;A&gt;    <br>      --b &lt;B&gt;    <br>      --c &lt;C&gt;    <br>      --d &lt;D&gt;    <br>  -h, --<span class="hljs-built_in">help</span>     Print <span class="hljs-built_in">help</span><br>  -V, --version  Print version<br>  <br>âœ  learn-clap git:(master) âœ— ./target/release/examples/only_one       <br>error: the following required arguments were not provided:<br>  &lt;--a &lt;A&gt;|--b &lt;B&gt;|--c &lt;C&gt;|--d &lt;D&gt;&gt;<br><br>Usage: only_one &lt;--a &lt;A&gt;|--b &lt;B&gt;|--c &lt;C&gt;|--d &lt;D&gt;&gt;<br><br>For more information, try <span class="hljs-string">&#x27;--help&#x27;</span>.<br><br>âœ  learn-clap git:(master) âœ— ./target/release/examples/only_one --a 1      <br>only: Only &#123; a: Some(<span class="hljs-string">&quot;1&quot;</span>), b: None, c: None, d: None &#125;<br><br>âœ  learn-clap git:(master) âœ— ./target/release/examples/only_one --a 1 --b 2<br>error: the argument <span class="hljs-string">&#x27;--a &lt;A&gt;&#x27;</span> cannot be used with <span class="hljs-string">&#x27;--b &lt;B&gt;&#x27;</span><br><br>Usage: only_one &lt;--a &lt;A&gt;|--b &lt;B&gt;|--c &lt;C&gt;|--d &lt;D&gt;&gt;<br><br>For more information, try <span class="hljs-string">&#x27;--help&#x27;</span>.<br><br>âœ  learn-clap git:(master) âœ— ./target/release/examples/only_one --b 2      <br>only: Only &#123; a: None, b: Some(<span class="hljs-string">&quot;2&quot;</span>), c: None, d: None &#125;<br></code></pre></td></tr></table></figure><h2 id="builder">Builder</h2><p>ä½¿ç”¨ <code>clap</code> çš„ Builderæ¨¡å¼ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸éœ€è¦é¢å¤–å¼•å…¥å…¶ä»–çš„ featuresï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo add clap<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯å¦‚æœè¦ä½¿ç”¨ <code>command!</code> æ¥æ„å»ºåº”ç”¨çš„è¯ï¼Œéœ€è¦å¼•å…¥<code>cargo</code> è¿™ä¸ª featuresï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo add clap --features cargo<br></code></pre></td></tr></table></figure><h3 id="åº”ç”¨é…ç½®-1">1. åº”ç”¨é…ç½®</h3><p>åœ¨ Builder æ¨¡å¼ä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>command!()</code> æˆ–<code>Command::new("appname")</code> æ¥æ„å»ºä¸€ä¸ªå‘½ä»¤è¡Œåº”ç”¨ï¼Œå…¶ä¸­<code>command!()</code> é»˜è®¤å°† appname è®¾ç½®åº”ç”¨åç§°ï¼Œè€Œ<code>Command::new()</code> å¿…é¡»æ˜¾ç¤ºæŒ‡å®š appnameã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::&#123;arg, Arg, Command, command, value_parser&#125;;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-comment">// let matches = command!()</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">matches</span> = Command::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;MyApp&quot;</span>)<br>        <span class="hljs-comment">// Application configuration</span><br>        .<span class="hljs-title function_ invoke__">version</span>(<span class="hljs-string">&quot;1.0.0&quot;</span>)<br>        .<span class="hljs-title function_ invoke__">author</span>(<span class="hljs-string">&quot;hedon&quot;</span>)<br>        .<span class="hljs-title function_ invoke__">about</span>(<span class="hljs-string">&quot;This the intro of the cli application&quot;</span>)<br>        <span class="hljs-comment">// Application args</span><br>        .<span class="hljs-title function_ invoke__">arg</span>(arg!([NAME]).<span class="hljs-title function_ invoke__">help</span>(<span class="hljs-string">&quot;Specify your name&quot;</span>))<br>        .<span class="hljs-title function_ invoke__">arg</span>(<br>            Arg::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;age&quot;</span>).<span class="hljs-title function_ invoke__">short</span>(<span class="hljs-string">&#x27;a&#x27;</span>).<span class="hljs-title function_ invoke__">long</span>(<span class="hljs-string">&quot;age&quot;</span>).<span class="hljs-title function_ invoke__">value_parser</span>(value_parser!(<span class="hljs-type">u8</span>))<br>        )<br>    .<span class="hljs-title function_ invoke__">get_matches</span>();<br><br>    <span class="hljs-comment">// Read and parse command args</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(name) = matches.get_one::&lt;<span class="hljs-type">String</span>&gt;(<span class="hljs-string">&quot;NAME&quot;</span>) &#123;<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Value for name: &#123;name&#125;&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(age) = matches.get_one::&lt;<span class="hljs-type">u8</span>&gt;(<span class="hljs-string">&quot;age&quot;</span>) &#123;<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Value for age: &#123;age&#125;&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ®µä»£ç åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p><p><strong>1. åˆ›å»ºå‘½ä»¤è¡Œåº”ç”¨å®ä¾‹</strong>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">matches</span> = Command::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;MyApp&quot;</span>)<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨ <code>Command::new</code>æ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å‘½ä»¤è¡Œåº”ç”¨å®ä¾‹ï¼Œå‘½åä¸º <code>"MyApp"</code>ã€‚</p><p><strong>2. é…ç½®åº”ç”¨</strong>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs rust">.<span class="hljs-title function_ invoke__">version</span>(<span class="hljs-string">&quot;1.0.0&quot;</span>)<br>.<span class="hljs-title function_ invoke__">author</span>(<span class="hljs-string">&quot;hedon&quot;</span>)<br>.<span class="hljs-title function_ invoke__">about</span>(<span class="hljs-string">&quot;This the intro of the cli application&quot;</span>)<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œä½¿ç”¨é“¾å¼è°ƒç”¨æ–¹æ³•é…ç½®åº”ç”¨çš„ç‰ˆæœ¬å·ä¸º<code>"1.0.0"</code>ï¼Œä½œè€…ä¸º<code>"hedon"</code>ï¼Œå¹¶æ·»åŠ äº†ä¸€ä¸ªç®€çŸ­çš„æè¿°ã€‚</p><p>è¿™é‡Œç­‰ä»·äº Builder æ¨¡å¼ä¸‹çš„ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[command(version, author, about)]</span><br></code></pre></td></tr></table></figure><p><strong>3. æ·»åŠ å‘½ä»¤è¡Œå‚æ•°</strong>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs rust">.<span class="hljs-title function_ invoke__">arg</span>(arg!([NAME]).<span class="hljs-title function_ invoke__">help</span>(<span class="hljs-string">&quot;Specify your name&quot;</span>))<br>.<span class="hljs-title function_ invoke__">arg</span>(<br>    Arg::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;age&quot;</span>).<span class="hljs-title function_ invoke__">short</span>(<span class="hljs-string">&#x27;a&#x27;</span>).<span class="hljs-title function_ invoke__">long</span>(<span class="hljs-string">&quot;age&quot;</span>).<span class="hljs-title function_ invoke__">value_parser</span>(value_parser!(<span class="hljs-type">u8</span>))<br>)<br></code></pre></td></tr></table></figure><p>è¿™éƒ¨åˆ†ä»£ç æ·»åŠ äº†ä¸¤ä¸ªå‘½ä»¤è¡Œå‚æ•°ï¼š -<code>.arg(arg!([NAME]).required(true).help("Specify your name"))</code>ä½¿ç”¨ <code>arg!</code> å®æ·»åŠ äº†ä¸€ä¸ªåä¸º <code>NAME</code>çš„å¿…éœ€å‚æ•°ï¼Œå¹¶æä¾›äº†ä¸€äº›å¸®åŠ©ä¿¡æ¯ã€‚ -<code>.arg(Arg::new("age").short('a').long("age").value_parser(value_parser!(u8)))</code>åˆ›å»ºäº†å¦ä¸€ä¸ªå‚æ•° <code>age</code>ï¼Œå¯ä»¥é€šè¿‡ <code>-a</code> æˆ–<code>--age</code> æ¥æŒ‡å®šã€‚è¿™ä¸ªå‚æ•°ä½¿ç”¨äº† <code>value_parser</code>å®æ¥æŒ‡æ˜å®ƒçš„å€¼åº”è¢«è§£æä¸º <code>u8</code> ç±»å‹çš„æ•°å­—ã€‚</p><p><strong>4. è§£æå‘½ä»¤è¡Œå‚æ•°</strong>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust">.<span class="hljs-title function_ invoke__">get_matches</span>();<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>.get_matches()</code> æ–¹æ³•æ¥è§£æå‘½ä»¤è¡Œå‚æ•°å¹¶å°†ç»“æœå­˜å‚¨åœ¨<code>matches</code> å˜é‡ä¸­ã€‚</p><p><strong>5. è¯»å–å¹¶æ‰“å°å‚æ•°å€¼</strong>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(name) = matches.get_one::&lt;<span class="hljs-type">String</span>&gt;(<span class="hljs-string">&quot;NAME&quot;</span>) &#123;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Value for name: &#123;name&#125;&quot;</span>);<br>&#125;<br><span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(age) = matches.get_one::&lt;<span class="hljs-type">u8</span>&gt;(<span class="hljs-string">&quot;age&quot;</span>) &#123;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Value for age: &#123;age&#125;&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€åï¼Œä½¿ç”¨ <code>matches.get_one::&lt;T&gt;("arg_name")</code>æ–¹æ³•å°è¯•è·å–æŒ‡å®šåç§°çš„å‚æ•°å€¼ã€‚å¦‚æœæˆåŠŸæ‰¾åˆ°ï¼Œåˆ™å°†å…¶æ‰“å°å‡ºæ¥ã€‚è¿™é‡Œåˆ†åˆ«å°è¯•è·å–<code>"NAME"</code> å’Œ <code>"age"</code> å‚æ•°çš„å€¼ï¼Œå¹¶ä½¿ç”¨<code>println!</code> å®å°†å®ƒä»¬æ‰“å°åˆ°æ§åˆ¶å°ã€‚</p><p>ä½¿ç”¨ <code>-- help</code> æµ‹è¯•è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">This the intro of the cli application<br><br>Usage: app2 [OPTIONS] [NAME]<br><br>Arguments:<br>  [NAME]  Specify your name<br><br>Options:<br>  -a, --age &lt;AGE&gt;  <br>  -h, --<span class="hljs-built_in">help</span>       Print <span class="hljs-built_in">help</span><br>  -V, --version    Print version<br></code></pre></td></tr></table></figure><p>ä½ å¯ä»¥å°†å…¶ä¸ã€ŒDerive -åº”ç”¨é…ç½®ã€è¿›è¡Œæ¯”è¾ƒï¼Œåº”è¯¥å¾ˆå®¹æ˜“æ‰¾åˆ°å®ƒä»¬ä¹‹é—´çš„å¯¹åº”å…³ç³»ã€‚</p><p>åœ¨ Derive ä¸­ <code>#[command]</code> å’Œ <code>#[arg]</code>æ”¯æŒçš„å±æ€§ï¼Œéƒ½å¯ä»¥åœ¨ Builderä¸­æ‰¾åˆ°å¯¹åº”çš„åŒåçš„å‡½æ•°ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚</p><h3 id="å‚æ•°ç±»å‹-1">2. å‚æ•°ç±»å‹</h3><p>åœ¨ Builder æ¨¡å¼ä¸­ï¼Œé…ç½®å‚æ•°æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><ul><li>arg!([-short] [--long] id)</li><li>Args::new("id").short('s').long("long")</li></ul><h4 id="arguments-options-1">2.1 Arguments &amp; Options</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">Arguments:<br>  [NAME]  Specify your name<br><br>Options:<br>  -a, --age &lt;AGE&gt;  <br></code></pre></td></tr></table></figure><ul><li><strong>Argument:</strong> ä¸åŒ…å« <code>-&#123;short&#125;</code> å’Œ<code>--&#123;long&#125;</code>ã€‚</li><li><strong>Options:</strong> åŒ…å« <code>-&#123;short&#125;</code> æˆ–<code>--&#123;long&#125;</code>ã€‚</li></ul><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs rust">.<span class="hljs-title function_ invoke__">arg</span>(arg!([NAME]).<span class="hljs-title function_ invoke__">help</span>(<span class="hljs-string">&quot;Specify your name&quot;</span>))<br>.<span class="hljs-title function_ invoke__">arg</span>(arg!(-a --age &lt;AGE&gt;).<span class="hljs-title function_ invoke__">value_parser</span>(value_parser!(<span class="hljs-type">u16</span>)))<br></code></pre></td></tr></table></figure><h4 id="å¯é€‰å‚æ•°-1">2.2 å¯é€‰å‚æ•°</h4><p>æ ¹æ®çº¦å®šï¼Œ<code>&lt;&gt;</code> è¡¨ç¤ºå¿…é¡»ï¼Œè€Œ <code>[]</code>è¡¨ç¤ºå¯é€‰ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs rust">.<span class="hljs-title function_ invoke__">arg</span>(arg!(&lt;NAME&gt;)   <span class="hljs-comment">// å¿…é¡»</span><br>.<span class="hljs-title function_ invoke__">arg</span>(arg!([ADDRESS]))  <span class="hljs-comment">// å¯é€‰</span><br></code></pre></td></tr></table></figure><p>ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>.required(bool)</code> å‡½æ•°æ˜ç¡®æŒ‡å‡ºæ˜¯å¦å¿…é¡»ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust">.<span class="hljs-title function_ invoke__">arg</span>(arg!(&lt;NAME&gt;).<span class="hljs-title function_ invoke__">required</span>(<span class="hljs-literal">true</span>))<br></code></pre></td></tr></table></figure><p><code>.required()</code> çš„ä¼˜å…ˆçº§é«˜äº <code>&lt;&gt;</code> å’Œ<code>[]</code>ï¼Œä½†æ˜¯å»ºè®®ä½ åœ¨æ„å»ºçš„æ—¶å€™è¿˜æ˜¯éµå¾ªçº¦å®šã€‚</p><h4 id="æšä¸¾å‚æ•°-1">2.3 æšä¸¾å‚æ•°</h4><p><strong>ç¬¬ 1 ç§ï¼šåœ¨ value_parser()ä¸­ç›´æ¥æŒ‡å®šå¯é€‰çš„æšä¸¾å‚æ•°</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust">.<span class="hljs-title function_ invoke__">arg</span>(arg!(&lt;MODE&gt;).<span class="hljs-title function_ invoke__">value_parser</span>([<span class="hljs-string">&quot;fast, slow&quot;</span>]))<br></code></pre></td></tr></table></figure><p><strong>ç¬¬ 2 ç§ï¼šä½¿ç”¨æšä¸¾ï¼Œä½†æ˜¯æšä¸¾éœ€è¦å®ç° ValueEnumtrait</strong></p><p>è¿™é‡Œåˆæœ‰ 2 ç§æ–¹å¼ï¼Œä½ å¯ä»¥å‘ Derive ä¸€æ ·å¼•å…¥ <code>derive</code>featuresï¼Œç„¶åç›´æ¥ <code>#[derive(ValueElem)]</code>ä½¿ç”¨é»˜è®¤å®ç°ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨å®ç°ã€‚æˆ‘æ›´å€¾å‘äºå‰è€…ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::&#123;arg, command, value_parser, ValueEnum&#125;;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">matches</span> = command!()<br>        <span class="hljs-comment">// .arg(arg!(&lt;MODE&gt;).value_parser([&quot;fast, slow&quot;]))</span><br>        .<span class="hljs-title function_ invoke__">arg</span>(<br>            arg!(&lt;MODE&gt;).<span class="hljs-title function_ invoke__">value_parser</span>(value_parser!(Mode)).<span class="hljs-title function_ invoke__">required</span>(<span class="hljs-literal">true</span>)<br>        )<br>        .<span class="hljs-title function_ invoke__">get_matches</span>();<br><br>    <span class="hljs-keyword">match</span> matches.get_one::&lt;Mode&gt;(<span class="hljs-string">&quot;MODE&quot;</span>)<br>        .<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">&quot;&#x27;Mode&#x27; is required and parsing will fail if its missing&quot;</span>)&#123;<br>        Mode::Fast =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;fast&quot;</span>),<br>        Mode::Slow =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;slow&quot;</span>),<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">#[derive(Copy, Clone, Ord, PartialOrd, Eq, PartialEq, ValueEnum)]</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Mode</span> &#123;<br>    <span class="hljs-comment">/// Run in fast mode</span><br>    Fast,<br>    <span class="hljs-comment">/// Run in slow mode</span><br>    Slow,<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ç´¯è®¡å‚æ•°-1">2.4 ç´¯è®¡å‚æ•°</h4><p>ä½¿ç”¨ <code>clap::ArgAction::Count</code> è®¾ç½®å‚æ•°ä¸ºç´¯è®¡å‚æ•°ï¼Œç„¶åä½¿ç”¨<code>get_count(id)</code> è·å–å‚æ•°çš„å€¼ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::&#123;arg, command&#125;;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">matches</span> = command!()<br>        .<span class="hljs-title function_ invoke__">arg</span>(arg!(-v --verbose...).<span class="hljs-title function_ invoke__">action</span>(clap::ArgAction::Count))<br>        .<span class="hljs-title function_ invoke__">get_matches</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;v count: &#123;:?&#125;&quot;</span>, matches.<span class="hljs-title function_ invoke__">get_count</span>(<span class="hljs-string">&quot;verbose&quot;</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œè¦æ³¨æ„ï¼Œ<code>arg!()</code> ä¸­å‚æ•°çš„å®šä¹‰ï¼Œä¹Ÿè¦ç¬¦åˆç´¯è®¡å‚æ•°çš„æ ¼å¼<code>-&#123;short&#125; --&#123;long&#125;...</code>ã€‚</p><h4 id="å˜é•¿å‚æ•°-1">2.5 å˜é•¿å‚æ•°</h4><p>ä½¿ç”¨ <code>clap::ArgAction::Append</code>è®¾ç½®å‚æ•°ä¸ºå˜é•¿å‚æ•°ï¼Œç„¶åä½¿ç”¨ <code>get_many::&lt;ç±»å‹&gt;("id")</code>è·å–å‚æ•°çš„å€¼ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::&#123;arg, Command&#125;;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">matches</span> = Command::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;append-application&quot;</span>)<br>        .<span class="hljs-title function_ invoke__">arg</span>(arg!([FILES]...).<span class="hljs-title function_ invoke__">action</span>(clap::ArgAction::Append))<br>        .<span class="hljs-title function_ invoke__">get_matches</span>();<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">files</span> = matches<br>        .get_many::&lt;<span class="hljs-type">String</span>&gt;(<span class="hljs-string">&quot;FILES&quot;</span>)<br>        .<span class="hljs-title function_ invoke__">unwrap_or_default</span>()<br>        .<span class="hljs-title function_ invoke__">map</span>(|v|v.<span class="hljs-title function_ invoke__">as_str</span>())<br>        .collect::&lt;<span class="hljs-type">Vec</span>&lt;_&gt;&gt;();<br><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;files: &#123;:?&#125;&quot;</span>, files);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œè¦æ³¨æ„ï¼Œ<code>arg!()</code> ä¸­å‚æ•°çš„å®šä¹‰ï¼Œä¹Ÿè¦ç¬¦åˆå˜é•¿å‚æ•°çš„æ ¼å¼<code>[arg]|&lt;arg&gt;...</code>ã€‚</p><h4 id="æ ‡å¿—å‚æ•°-1">2.6 æ ‡å¿—å‚æ•°</h4><p>ä½¿ç”¨ <code>clap::ArgAction::SetTrue</code> æˆ–<code>clap::ArgAction::SetFalse</code> è®¾ç½®å‚æ•°ä¸ºæ ‡å¿—å‚æ•°ï¼Œç„¶åä½¿ç”¨<code>get_flag()</code> è·å–å‚æ•°çš„å€¼ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::&#123;arg, command&#125;;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">matches</span> = command!()<br>        .<span class="hljs-title function_ invoke__">arg</span>(arg!(-d --debug).<span class="hljs-title function_ invoke__">action</span>(clap::ArgAction::SetTrue))<br>        .<span class="hljs-title function_ invoke__">arg</span>(arg!(-v --verbose).<span class="hljs-title function_ invoke__">action</span>(clap::ArgAction::SetFalse))<br>        .<span class="hljs-title function_ invoke__">get_matches</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;debug: &#123;:?&#125;&quot;</span>, matches.<span class="hljs-title function_ invoke__">get_flag</span>(<span class="hljs-string">&quot;debug&quot;</span>));<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;verbose: &#123;:?&#125;&quot;</span>, matches.<span class="hljs-title function_ invoke__">get_flag</span>(<span class="hljs-string">&quot;verbose&quot;</span>))<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ï¼š</p><ul><li><code>clap::ArgAction::SetTrue</code> : è®¾ç½®å‚æ•°çš„è¯ï¼Œåˆ™ä¸ºtrueï¼Œå¦åˆ™ falseï¼ˆé»˜è®¤ï¼‰ã€‚</li><li><code>clap::ArgAction::SetFalse</code> : è®¾ç½®å‚æ•°çš„è¯ï¼Œåˆ™ä¸ºfalseï¼Œå¦åˆ™ trueï¼ˆé»˜è®¤ï¼‰ã€‚</li></ul><p>æµ‹è¯•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  learn-clap-builder git:(master) âœ— ./target/release/examples/flag      <br>debug: <span class="hljs-literal">false</span><br>verbose: <span class="hljs-literal">true</span><br>âœ  learn-clap-builder git:(master) âœ— ./target/release/examples/flag -d   <br>debug: <span class="hljs-literal">true</span><br>verbose: <span class="hljs-literal">true</span><br>âœ  learn-clap-builder git:(master) âœ— ./target/release/examples/flag -v   <br>debug: <span class="hljs-literal">false</span><br>verbose: <span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure><h4 id="å­å‘½ä»¤-1">2.7 å­å‘½ä»¤</h4><p>å¯ä»¥ä½¿ç”¨ <code>subcommand(sub_cmd)</code> å’Œ<code>subcommand([sub_cmd1, sub_cmd2])</code>æ¥æ·»åŠ å­å‘½ä»¤ï¼Œè§£æçš„æ—¶å€™ä½¿ç”¨ <code>matches.subcommand()</code>åŒ¹é…å­å‘½ä»¤ï¼Œå†æŒ‰ç…§ä¹‹å‰çš„è§„åˆ™è§£æå­å‘½ä»¤ä¸­å¯¹åº”çš„å‚æ•°å³å¯ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::&#123;arg, Command, value_parser&#125;;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">matches</span> = Command::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;myapp&quot;</span>)<br>        .<span class="hljs-title function_ invoke__">subcommands</span>([<br>            Command::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;add&quot;</span>)<br>                .<span class="hljs-title function_ invoke__">arg</span>(arg!(&lt;NUM&gt;).<span class="hljs-title function_ invoke__">value_parser</span>(value_parser!(<span class="hljs-type">i16</span>))),<br>            Command::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;sub&quot;</span>)<br>                .<span class="hljs-title function_ invoke__">arg</span>(arg!(&lt;NUM&gt;).<span class="hljs-title function_ invoke__">value_parser</span>(value_parser!(<span class="hljs-type">i16</span>))),<br>        ])<br>        .<span class="hljs-title function_ invoke__">get_matches</span>();<br><br>    <span class="hljs-keyword">match</span> matches.<span class="hljs-title function_ invoke__">subcommand</span>() &#123;<br>        <span class="hljs-title function_ invoke__">Some</span>((<span class="hljs-string">&quot;add&quot;</span>, add_cmd)) =&gt; <span class="hljs-built_in">println!</span>(<br>            <span class="hljs-string">&quot;&#x27;myapp add&#x27; was used, num is: &#123;:?&#125;&quot;</span>,<br>            add_cmd.get_one::&lt;<span class="hljs-type">i16</span>&gt;(<span class="hljs-string">&quot;NUM&quot;</span>),<br>        ),<br>        <span class="hljs-title function_ invoke__">Some</span>((<span class="hljs-string">&quot;sub&quot;</span>, sub_cmd)) =&gt; <span class="hljs-built_in">println!</span>(<br>            <span class="hljs-string">&quot;&#x27;myapp sub&#x27; was used, num is: &#123;:?&#125;&quot;</span>,<br>            sub_cmd.get_one::&lt;<span class="hljs-type">i16</span>&gt;(<span class="hljs-string">&quot;NUM&quot;</span>),<br>        ),<br>        _ =&gt; <span class="hljs-built_in">unreachable!</span>()<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å‚æ•°æ ¡éªŒ-1">3. å‚æ•°æ ¡éªŒ</h3><h4 id="ç±»å‹æ ¡éªŒ-1">3.1 ç±»å‹æ ¡éªŒ</h4><p>ä½¿ç”¨ <code>value_parser!()</code> åœ¨æ‹¬å·ä¸­æŒ‡å®šç±»å‹ï¼Œ<code>clap</code>å°±ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬å¯¹å‚æ•°è¿›è¡Œç±»å‹æ ¡éªŒï¼Œå½“ç„¶ä½ åœ¨è·å–å‚æ•°å€¼<code>get_one::&lt;ç±»å‹&gt;()</code> çš„æ—¶å€™ï¼Œç±»å‹è¦å¯¹ä¸Šï¼Œå¦åˆ™ä¼španicã€‚</p><p>é»˜è®¤æ”¯æŒï¼š</p><ul><li>åŸç”Ÿç±»å‹ï¼š<code>bool</code>, <code>String</code>,<code>OsString</code>,<code>PathBuf</code>ã€<code>usize</code>ã€<code>isize</code></li><li>èŒƒå›´æ•°æ®ï¼š<code>u8</code>, <code>i8</code>, <code>u16</code>,<code>i16</code>, <code>u32</code>, <code>i32</code>, <code>u64</code>,<code>i64</code></li><li>å®ç°äº† <code>ValueEnum</code> çš„ enum ç±»å‹</li><li>å®ç°äº†<code>From&lt;OsString&gt;</code>ã€<code>From&lt;&amp;OsStr&gt;</code>ã€<code>FromStr</code> çš„ç±»å‹</li></ul><h4 id="æšä¸¾æ ¡éªŒ-1">3.2 æšä¸¾æ ¡éªŒ</h4><p>2.3 ä¸­æšä¸¾å‚æ•°çš„è¯´æ˜ä¸­ï¼Œå·²ç»ä½“ç°äº†æšä¸¾æ ¡éªŒçš„åŠŸèƒ½äº†ï¼Œè¿™é‡Œä¸èµ˜è¿°ã€‚</p><h4 id="èŒƒå›´æ ¡éªŒ-1">3.3 èŒƒå›´æ ¡éªŒ</h4><p>å¯¹äºä¸Šè¿°æåˆ°çš„ã€ŒèŒƒå›´æ•°æ®ã€ï¼Œå¯ä»¥ä½¿ç”¨<code>value_parser!(ç±»å‹).range()</code> è¿›è¡ŒèŒƒå›´æ ¡éªŒã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs rust">arg!(&lt;PORT&gt;)<br>  .<span class="hljs-title function_ invoke__">value_parser</span>(value_parser!(<span class="hljs-type">u16</span>).<span class="hljs-title function_ invoke__">range</span>(<span class="hljs-number">1</span>..))<br></code></pre></td></tr></table></figure><h4 id="è‡ªå®šä¹‰æ ¡éªŒ-1">3.4 è‡ªå®šä¹‰æ ¡éªŒ</h4><p><code>value_parser()</code>ä¸­ä¹Ÿå¯ä»¥ä¼ è‡ªå®šä¹‰çš„æ ¡éªŒå‡½æ•°ï¼Œè¯¥å‡½æ•°çš„ç­¾åéœ€è¦æ»¡è¶³çš„æ¡ä»¶è·Ÿæˆ‘ä»¬åœ¨ä»‹ç»Derive æ—¶ä¸€æ ·ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> std::ops::RangeInclusive;<br><span class="hljs-keyword">use</span> clap::&#123;arg, command&#125;;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">matches</span> = command!()<br>        .<span class="hljs-title function_ invoke__">arg</span>(arg!(&lt;PORT&gt;).<span class="hljs-title function_ invoke__">value_parser</span>(port_in_range))<br>        .<span class="hljs-title function_ invoke__">get_matches</span>();<br><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;port: &#123;:?&#125;&quot;</span>, matches.get_one::&lt;<span class="hljs-type">u16</span>&gt;(<span class="hljs-string">&quot;PORT&quot;</span>))<br>&#125;<br><br><span class="hljs-keyword">const</span> PORT_RANGE: RangeInclusive&lt;<span class="hljs-type">usize</span>&gt; = RangeInclusive::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">1</span>, <span class="hljs-number">65535</span>);<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">port_in_range</span>(s: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-type">u16</span>, <span class="hljs-type">String</span>&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">port</span>: <span class="hljs-type">usize</span> = s<br>        .<span class="hljs-title function_ invoke__">parse</span>()<br>        .<span class="hljs-title function_ invoke__">map_err</span>(|_|<span class="hljs-built_in">format!</span>(<span class="hljs-string">&quot;`&#123;s&#125;` is not a port number&quot;</span>))?;<br>    <span class="hljs-keyword">if</span> PORT_RANGE.<span class="hljs-title function_ invoke__">contains</span>(&amp;port) &#123;<br>        <span class="hljs-title function_ invoke__">Ok</span>(port <span class="hljs-keyword">as</span> <span class="hljs-type">u16</span>)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-title function_ invoke__">Err</span>(<span class="hljs-built_in">format!</span>(<br>            <span class="hljs-string">&quot;port not in range &#123;&#125;-&#123;&#125;&quot;</span>,<br>            PORT_RANGE.<span class="hljs-title function_ invoke__">start</span>(),<br>            PORT_RANGE.<span class="hljs-title function_ invoke__">end</span>(),<br>        ))<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å…³è”å‚æ•°-1">3.5 å…³è”å‚æ•°</h4><ul><li><strong>ä¾èµ–å…³ç³»ï¼š</strong>ä½¿ç”¨<code>requires(id | group)</code></li><li><strong>æ’æ–¥å…³ç³»</strong>ï¼šä½¿ç”¨<code>group().multiple(false).required(true)</code></li></ul><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs rust">.<span class="hljs-title function_ invoke__">group</span>(<br>    ArgGroup::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;vers&quot;</span>)<br>  <span class="hljs-comment">// è¡¨ç¤º &quot;set-ver&quot;, &quot;major&quot;, &quot;minor&quot;, &quot;patch&quot; å¿…é¡»æœ‰ä¸€ä¸ªä¸”åªèƒ½æœ‰ä¸€ä¸ªå­˜åœ¨</span><br>        .<span class="hljs-title function_ invoke__">multiple</span>(<span class="hljs-literal">false</span>)<br>        .<span class="hljs-title function_ invoke__">required</span>(<span class="hljs-literal">true</span>)<br>        .<span class="hljs-title function_ invoke__">args</span>([<span class="hljs-string">&quot;set-ver&quot;</span>, <span class="hljs-string">&quot;major&quot;</span>, <span class="hljs-string">&quot;minor&quot;</span>, <span class="hljs-string">&quot;patch&quot;</span>]),<br>)<br>.<span class="hljs-title function_ invoke__">arg</span>(<br>    arg!([INPUT_FILE] <span class="hljs-string">&quot;some regular input&quot;</span>)<br>        .<span class="hljs-title function_ invoke__">value_parser</span>(value_parser!(PathBuf))<br>        .<span class="hljs-title function_ invoke__">group</span>(<span class="hljs-string">&quot;input&quot;</span>),<br>)<br>.<span class="hljs-title function_ invoke__">arg</span>(<br>    arg!(config: -c &lt;CONFIG&gt;)<br>        .<span class="hljs-title function_ invoke__">value_parser</span>(value_parser!(PathBuf))<br>   <span class="hljs-comment">// è¡¨ç¤º -c éœ€è¦æœ‰ group ä¸º input çš„å‘½ä»¤å­˜åœ¨æ‰å¯ä»¥ä½¿ç”¨</span><br>        .<span class="hljs-title function_ invoke__">requires</span>(<span class="hljs-string">&quot;input&quot;</span>),<br>)<br></code></pre></td></tr></table></figure><h2 id="derive-vs-builder-2-å¯¹æ¯”">Derive vs Builder (2) å¯¹æ¯”</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/screencapture-wepie-feishu-cn-wiki-Bdb3wl4cViE6hqkUuykctkrqn8i-2024-03-01-20_52_38.png"alt="Derive vs Builder" /><figcaption aria-hidden="true">Derive vs Builder</figcaption></figure><h2 id="clap-rpassword-å®ç°åŠ å¯†è¾“å…¥">clap + rpassword å®ç°åŠ å¯†è¾“å…¥</h2><p>å¯¹äºå¯†ç ã€å¯†é’¥ç­‰å…³é”®ä¿¡æ¯çš„è¾“å…¥ï¼Œä¸ºäº†ä¿¡æ¯å®‰å…¨ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šä½¿ç”¨åŠ å¯†è¾“å‡ºï¼Œ<code>clap</code>æœ¬èº«ä¸æ”¯æŒåŠ å¯†è¾“å…¥åŠŸèƒ½ã€‚è‹¥ä½ æœ‰è¿™æ–¹é¢çš„éœ€æ±‚ï¼Œå¯ä»¥ä½¿ç”¨<code>rpassword</code> crate è¾…åŠ©å®Œæˆã€‚</p><p>ç¤ºä¾‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::Parser;<br><span class="hljs-keyword">use</span> rpassword::read_password;<br><br><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(version, author, about, long_about = None)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cli</span> &#123;<br>    <span class="hljs-meta">#[arg(short, long)]</span><br>    username: <span class="hljs-type">String</span>,<br><br>    <span class="hljs-meta">#[arg(short, long, required = true)]</span><br>    password: <span class="hljs-type">bool</span>,<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cli</span> = Cli::<span class="hljs-title function_ invoke__">parse</span>();<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">password</span> = <span class="hljs-keyword">if</span> cli.password &#123;<br>        <span class="hljs-comment">// Prompt user to enter password</span><br>        <span class="hljs-title function_ invoke__">read_password</span>().<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">&quot;Failed to read password&quot;</span>)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-string">&quot;&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>()<br>    &#125;;<br><br>    <span class="hljs-comment">// Use username and password to do something</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;username: &#123;&#125;, password: &#123;&#125;&quot;</span>, cli.username, password);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="clap_complete-å®ç°è‡ªåŠ¨è¡¥å…¨">clap_complete å®ç°è‡ªåŠ¨è¡¥å…¨</h2><p>è¦å®ç°è‡ªåŠ¨è¡¥å…¨ï¼Œéœ€è¦åœ¨ <code>.zshrc</code> æˆ– <code>.bashrc</code> ç­‰<code>SHELL</code> æ–‡ä»¶ä¸­åŠ å…¥å‘½ä»¤è‡ªåŠ¨è¡¥å…¨è„šæœ¬ã€‚è¿™æ—¶å€™å¯ä»¥ä½¿ç”¨<code>clap_complete</code> æ¥å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚</p><p>ä¸‹é¢çš„ç¤ºä¾‹ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">â”œâ”€â”€ Cargo.lock<br>â”œâ”€â”€ Cargo.toml<br>â”œâ”€â”€ build.rs<br>â””â”€â”€ src<br>    â”œâ”€â”€ cli.rs<br>    â””â”€â”€ main.rs<br></code></pre></td></tr></table></figure><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦å¼•å…¥ <code>clap</code> å’Œ <code>clap_complete</code>crateï¼Œå…¶ä¸­ <code>clap_complete</code> åªéœ€åœ¨ buildç¯å¢ƒä¸‹å³å¯ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ <code>Cargo.tmol</code> å¦‚ä¸‹ï¼š</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs toml"><span class="hljs-section">[package]</span><br><span class="hljs-attr">name</span> = <span class="hljs-string">&quot;myapp&quot;</span><br><span class="hljs-attr">version</span> = <span class="hljs-string">&quot;0.1.0&quot;</span><br><span class="hljs-attr">edition</span> = <span class="hljs-string">&quot;2021&quot;</span><br><br><span class="hljs-attr">build</span> = <span class="hljs-string">&quot;build.rs&quot;</span><br><br><span class="hljs-section">[dependencies]</span><br><span class="hljs-attr">clap</span> = &#123; version = <span class="hljs-string">&quot;4.5.1&quot;</span> &#125;<br><span class="hljs-attr">dirs</span> = <span class="hljs-string">&quot;5.0.1&quot;</span><br><br><span class="hljs-section">[build-dependencies]</span><br><span class="hljs-attr">clap</span> = &#123; version = <span class="hljs-string">&quot;4.5.1&quot;</span>&#125;<br><span class="hljs-attr">clap_complete</span> = <span class="hljs-string">&quot;4.5.1&quot;</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆåœ¨ <code>src/cli.rs</code> ä¸­å®ç°ä¸€ä¸ªç®€å•çš„å‘½ä»¤è¡Œç¨‹åº<strong>myapp</strong>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::&#123;Arg, ArgAction, Command&#125;;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">build_cli</span>() <span class="hljs-punctuation">-&gt;</span> Command &#123;<br>    Command::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;myapp&quot;</span>)<br>        .<span class="hljs-title function_ invoke__">about</span>(<span class="hljs-string">&quot;Tests completions&quot;</span>)<br>        .<span class="hljs-title function_ invoke__">arg</span>(Arg::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;file&quot;</span>)<br>            .<span class="hljs-title function_ invoke__">help</span>(<span class="hljs-string">&quot;some input file&quot;</span>))<br>        .<span class="hljs-title function_ invoke__">subcommand</span>(Command::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;test&quot;</span>)<br>            .<span class="hljs-title function_ invoke__">about</span>(<span class="hljs-string">&quot;tests things&quot;</span>)<br>            .<span class="hljs-title function_ invoke__">arg</span>(Arg::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;case&quot;</span>)<br>                .<span class="hljs-title function_ invoke__">long</span>(<span class="hljs-string">&quot;case&quot;</span>)<br>                .<span class="hljs-title function_ invoke__">action</span>(ArgAction::Set)<br>                .<span class="hljs-title function_ invoke__">help</span>(<span class="hljs-string">&quot;the case to test&quot;</span>)))<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸»è¦æ˜¯æ¼”ç¤ºè¿™ä¸ªè‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ï¼Œä¸ºäº†çœäº‹ï¼Œ<code>src/main.rs</code>ä¸­å°±ä¸å®ç°å…·ä½“é€»è¾‘äº†ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">mod</span> cli;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">_m</span> = cli::<span class="hljs-title function_ invoke__">build_cli</span>().<span class="hljs-title function_ invoke__">get_matches</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ç€ï¼Œæˆ‘ä»¬åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹å®ç°<code>build.rs</code>ï¼Œå®ƒå°†ä¸ºæˆ‘ä»¬æŒ‡å®šçš„å‘½ä»¤ç”Ÿæˆè‡ªåŠ¨è¡¥å…¨è„šæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">touch</span> build.rs<br></code></pre></td></tr></table></figure><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap_complete::&#123;generate_to, shells::Bash&#125;;<br><span class="hljs-keyword">use</span> std::env;<br><span class="hljs-keyword">use</span> std::io::Error;<br><br>include!(<span class="hljs-string">&quot;src/cli.rs&quot;</span>);<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;(), Error&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">outdir</span> = <span class="hljs-keyword">match</span> env::<span class="hljs-title function_ invoke__">var_os</span>(<span class="hljs-string">&quot;OUT_DIR&quot;</span>) &#123;<br>        <span class="hljs-literal">None</span> =&gt; <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Ok</span>(()),<br>        <span class="hljs-title function_ invoke__">Some</span>(outdir) =&gt; outdir,<br>    &#125;;<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">cmd</span> = <span class="hljs-title function_ invoke__">build_cli</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">path</span> = <span class="hljs-title function_ invoke__">generate_to</span>(<br>        Bash,<br>        &amp;<span class="hljs-keyword">mut</span> cmd, <span class="hljs-comment">// We need to specify what generator to use</span><br>        <span class="hljs-string">&quot;myapp&quot;</span>,  <span class="hljs-comment">// We need to specify the bin name manually</span><br>        outdir,   <span class="hljs-comment">// We need to specify where to write to</span><br>    )?;<br><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;cargo:warning=completion file is generated: &#123;path:?&#125;&quot;</span>);<br><br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½ éœ€è¦æŠŠå…¶ä¸­çš„ <strong>myapp</strong> æ›¿æ¢ä¸ºä½ çš„å‘½ä»¤ã€‚</p><p>æ‰§è¡Œæ„å»ºå‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo build<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">warning: myapp@0.1.0: completion file is generated: <span class="hljs-string">&quot;/Users/hedon/RustroverProjects/learn-clap-complete/target/debug/build/myapp-42e401d08c044ca3/out/myapp.bash&quot;</span><br>    Finished dev [unoptimized + debuginfo] target(s) <span class="hljs-keyword">in</span> 1.90s<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä¼šè¾“å‡ºç”Ÿæˆè„šæœ¬æ‰€åœ¨çš„ä½ç½®ï¼Œæˆ‘è¿™é‡Œæ˜¯<code>/Users/hedon/RustroverProjects/learn-clap-complete/target/debug/build/myapp-42e401d08c044ca3/out/myapp.bash</code>ã€‚</p><p>æˆ‘çš„ç»ˆç«¯ä½¿ç”¨çš„æ˜¯ zshï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  <span class="hljs-built_in">echo</span> <span class="hljs-variable">$SHELL</span>      <br>/bin/zsh<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘éœ€è¦å°†è¿™ä¸ªæ–‡ä»¶çš„å†…å®¹åŠ åˆ° <code>~/.zshrc</code> æ–‡ä»¶çš„æœ«å°¾ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /Users/hedon/RustroverProjects/learn-clap-complete/target/debug/build/myapp-42e401d08c044ca3/out/myapp.bash &gt;&gt; ~/.zshrc<br></code></pre></td></tr></table></figure><p>é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">source</span> ~/.zshrc<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™ä½ ä½¿ç”¨ <strong>myapp</strong> å‘½ä»¤çš„æ—¶å€™ï¼ŒæŒ‰ <code>tap</code>é”®ï¼Œå°±æœ‰è‡ªåŠ¨è¡¥å…¨äº†ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">âœ  ./target/debug/myapp <br>--<span class="hljs-built_in">help</span>    -h        \[file\]  <span class="hljs-built_in">help</span>      <span class="hljs-built_in">test</span> <br></code></pre></td></tr></table></figure><h1 id="httpie">HTTPie</h1><p>ç”±äºç¯‡å¹…åŸå› ï¼Œå®æˆ˜ HTTPie éƒ¨åˆ†è¯·çœ‹ï¼š<ahref="https://hedon.top/2024/03/06/rust-action-httpie/">Rustå®æˆ˜ä¸¨HTTPie</a></p><h1 id="ä¸-go-è¯­è¨€-cobra-æ¯”è¾ƒ">ä¸ Go è¯­è¨€ cobra æ¯”è¾ƒ</h1><p>Go çš„ <code>cobra</code> ä¹Ÿæ˜¯ç”¨äºæ„å»ºå‘½ä»¤è¡Œåº”ç”¨ç¨‹åºçš„åº“ï¼Œå®ƒåœ¨ Goè¯­è¨€ç”Ÿæ€ä¸­éå¸¸å—æ¬¢è¿ã€‚</p><p>ä¸ºäº†ç›´è§‚å±•ç¤ºè¿™ 2ä¸ªåº“æ„å»ºå‘½ä»¤è¡Œåº”ç”¨ç¨‹åºçš„åŒºåˆ«ï¼Œæˆ‘ä»¬æ¥è®¾è®¡ä¸€ä¸ªç®€å•çš„å‘½ä»¤è¡Œç¨‹åºï¼Œç”¨<code>clap</code> å’Œ <code>cobra</code>åˆ†åˆ«å®ç°ï¼Œä»¥å±•ç¤ºå¦‚ä½•ç”¨è¿™ä¸¤ä¸ªåº“å®ç°ç›¸åŒçš„åŠŸèƒ½ã€‚</p><p>è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª CLI ç¨‹åºï¼Œå®ƒæœ‰ä¸€ä¸ª <code>greet</code> å­å‘½ä»¤ï¼Œæ¥å—ä¸€ä¸ª<code>-n</code> æˆ– <code>--name</code> å‚æ•°ï¼Œå¹¶æ‰“å°å‡ºä¸€æ¡æ¬¢è¿ä¿¡æ¯ã€‚</p><h2 id="rust-clap-å®ç°">Rust clap å®ç°</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> clap::&#123; Parser, Subcommand&#125;;<br><br><span class="hljs-meta">#[derive(Parser)]</span><br><span class="hljs-meta">#[command(bin_name = <span class="hljs-string">&quot;greet_app&quot;</span>)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cli</span> &#123;<br>    <span class="hljs-meta">#[command(subcommand)]</span><br>    sub: <span class="hljs-type">Option</span>&lt;Sub&gt;,<br>&#125;<br><br><span class="hljs-meta">#[derive(Subcommand)]</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Sub</span> &#123;<br>    Greet &#123;<br>        <span class="hljs-meta">#[arg(short, long)]</span><br>        name: <span class="hljs-type">String</span>,<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cli</span> = Cli::<span class="hljs-title function_ invoke__">parse</span>();<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(sub) = cli.sub &#123;<br>        <span class="hljs-keyword">match</span> sub &#123;<br>            Sub::Greet&#123;name&#125; =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;greeting: &#123;:?&#125;&quot;</span>, name),<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="go-cobra-å®ç°">Go cobra å®ç°</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;os&quot;</span><br><br><span class="hljs-string">&quot;github.com/spf13/cobra&quot;</span><br>)<br><br><span class="hljs-keyword">var</span> rootCmd = &amp;cobra.Command&#123;<br>Use:   <span class="hljs-string">&quot;greet_app&quot;</span>,<br>Short: <span class="hljs-string">&quot;A simple greeting application&quot;</span>,<br>Long:  <span class="hljs-string">`This is a simple greeting application with a greet command.`</span>,<br>&#125;<br><br><span class="hljs-keyword">var</span> greetCmd = &amp;cobra.Command&#123;<br>Use:   <span class="hljs-string">&quot;greet&quot;</span>,<br>Short: <span class="hljs-string">&quot;Greets a user&quot;</span>,<br>Long:  <span class="hljs-string">`Prints a greeting message for the specified user.`</span>,<br>Run: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(cmd *cobra.Command, args []<span class="hljs-type">string</span>)</span></span> &#123;<br>name, _ := cmd.Flags().GetString(<span class="hljs-string">&quot;name&quot;</span>)<br>fmt.Printf(<span class="hljs-string">&quot;Hello, %s!\n&quot;</span>, name)<br>&#125;,<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;<br>rootCmd.AddCommand(greetCmd)<br>greetCmd.Flags().StringP(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;n&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;Sets the name to greet&quot;</span>)<br>greetCmd.MarkFlagRequired(<span class="hljs-string">&quot;name&quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> err := rootCmd.Execute(); err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(err)<br>os.Exit(<span class="hljs-number">1</span>)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">This is a simple greeting application with a greet <span class="hljs-built_in">command</span>.<br><br>Usage:<br>  greet_app [<span class="hljs-built_in">command</span>]<br><br>Available Commands:<br>  completion  Generate the autocompletion script <span class="hljs-keyword">for</span> the specified shell<br>  greet       Greets a user<br>  <span class="hljs-built_in">help</span>        Help about any <span class="hljs-built_in">command</span><br><br>Flags:<br>  -h, --<span class="hljs-built_in">help</span>   <span class="hljs-built_in">help</span> <span class="hljs-keyword">for</span> greet_app<br><br>Use <span class="hljs-string">&quot;greet_app [command] --help&quot;</span> <span class="hljs-keyword">for</span> more information about a <span class="hljs-built_in">command</span>.<br></code></pre></td></tr></table></figure><h2 id="å¯¹æ¯”">å¯¹æ¯”</h2><h3 id="è®¾è®¡å“²å­¦å’Œæ˜“ç”¨æ€§">è®¾è®¡å“²å­¦å’Œæ˜“ç”¨æ€§</h3><p><strong>clap</strong>:</p><ul><li>ä½¿ç”¨ Rust çš„å®æ¥æä¾›å¼ºå¤§çš„ç¼–è¯‘æ—¶åŠŸèƒ½ï¼Œå¦‚å‚æ•°è§£æã€éªŒè¯ç­‰ã€‚</li><li>åˆ©ç”¨ Rust çš„ç±»å‹å®‰å…¨ç‰¹æ€§ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯ã€‚</li><li>æ”¯æŒé€šè¿‡æ´¾ç”Ÿå®è‡ªåŠ¨ä»ç»“æ„ä½“ç”Ÿæˆå‘½ä»¤è¡Œè§£æä»£ç ï¼Œç®€åŒ–å¼€å‘æµç¨‹ã€‚</li></ul><p><strong>cobra</strong>:</p><ul><li>é‡‡ç”¨æ›´ä¼ ç»Ÿçš„å‘½ä»¤å¼ç¼–ç¨‹æ¨¡å‹ï¼Œç›´è§‚ä¸”æ˜“äºä¸Šæ‰‹ã€‚</li><li>é€šè¿‡ç»„åˆå‘½ä»¤å¯¹è±¡æ¥æ„å»ºå¤æ‚çš„å‘½ä»¤è¡Œåº”ç”¨ã€‚</li><li>æä¾›äº†ä¸€å¥—å®Œæ•´çš„ç”Ÿæˆå·¥å…·æ¥åˆ›å»ºå‘½ä»¤å’Œé…ç½®ï¼Œä¿ƒè¿›äº†å¼€å‘é€Ÿåº¦ã€‚</li></ul><h3 id="åŠŸèƒ½å’Œç‰¹æ€§">åŠŸèƒ½å’Œç‰¹æ€§</h3><p><strong>clap</strong>:</p><ul><li>è‡ªåŠ¨ç”Ÿæˆå¸®åŠ©ä¿¡æ¯ã€ç‰ˆæœ¬ä¿¡æ¯ç­‰ã€‚</li><li>æ”¯æŒå¤šçº§å­å‘½ä»¤ã€‚</li><li>æ”¯æŒè‡ªå®šä¹‰éªŒè¯å™¨å’Œå¤æ‚çš„å‚æ•°å…³ç³»ï¼ˆå¦‚äº’æ–¥ã€ä¾èµ–ç­‰ï¼‰ã€‚</li></ul><p><strong>cobra</strong>:</p><ul><li>æ”¯æŒè‡ªåŠ¨ç”Ÿæˆå¸®åŠ©æ–‡æ¡£ã€‚</li><li><strong>å†…ç½®å‘½ä»¤è‡ªåŠ¨è¡¥å…¨è„šæœ¬ç”ŸæˆåŠŸèƒ½</strong>ã€‚</li><li><strong>æ”¯æŒæŒä¹…åŒ–å‘½ä»¤è¡Œæ ‡å¿—åˆ°é…ç½®æ–‡ä»¶</strong>ã€‚</li><li>é€šè¿‡æ’ä»¶æ”¯æŒå¢åŠ é¢å¤–çš„å­å‘½ä»¤ã€‚</li><li>èƒ½å¤Ÿè½»æ¾åœ°ä¸å…¶ä»– Go åº“é›†æˆï¼Œå¦‚ Viper ç”¨äºé…ç½®ç®¡ç†ã€‚</li></ul><h3 id="æ€§èƒ½">æ€§èƒ½</h3><p><strong>clap</strong>:</p><ul><li>ç”±äº Rust çš„ç¼–è¯‘æ—¶ä¼˜åŒ–ï¼Œ<code>clap</code>åœ¨è§£æå‘½ä»¤è¡Œå‚æ•°æ—¶é€šå¸¸ä¼šæœ‰æ›´å¥½çš„æ€§èƒ½ã€‚</li><li>æ›´å°‘çš„è¿è¡Œæ—¶å¼€é”€ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†å¤§é‡å¤æ‚å‘½ä»¤è¡Œå‚æ•°æ—¶ã€‚</li></ul><p><strong>cobra</strong>:</p><ul><li>æ€§èƒ½å¯¹äºå¤§å¤šæ•°å‘½ä»¤è¡Œåº”ç”¨æ¥è¯´å·²ç»è¶³å¤Ÿï¼Œä½†å¯èƒ½ä¸å¦‚ <code>clap</code>ä¼˜åŒ–ã€‚</li><li>Go çš„è¿è¡Œæ—¶å¯èƒ½ä¼šå¼•å…¥é¢å¤–çš„å¼€é”€ï¼Œå°¤å…¶æ˜¯åœ¨å¹¶å‘å¤„ç†æ—¶ã€‚</li></ul>]]></content>
    
    
    <categories>
      
      <category>Rust</category>
      
      <category>Rust å¸¸ç”¨åº“</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Rust</tag>
      
      <tag>clap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Rust reqwest ç®€æ˜æ•™ç¨‹</title>
    <link href="/2024/03/02/rust-crate-reqwest/"/>
    <url>/2024/03/02/rust-crate-reqwest/</url>
    
    <content type="html"><![CDATA[<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2><p><code>reqwest</code> æ˜¯ Rust ä¸­ä¸€ä¸ªéå¸¸æµè¡Œå’Œå¼ºå¤§çš„ HTTPå®¢æˆ·ç«¯åº“ï¼Œå®ƒæä¾›äº†ä¸€ç§ç®€å•çš„æ–¹å¼æ¥å‘é€ HTTPè¯·æ±‚å¹¶å¤„ç†å“åº”ã€‚<code>reqwest</code>æ”¯æŒé˜»å¡å’Œéé˜»å¡ï¼ˆå¼‚æ­¥ï¼‰è¯·æ±‚ï¼Œä½¿å…¶é€‚åˆäºå„ç§ä¸åŒçš„åº”ç”¨åœºæ™¯ã€‚åœ¨è¿™ç¯‡åšæ–‡ä¸­ï¼Œæˆ‘ä»¬å°†è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨<code>reqwest</code> å‘é€å„ç§ HTTP è¯·æ±‚ï¼Œå¹¶å¤„ç†è¿”å›çš„å“åº”ã€‚</p><h2 id="å¼€å§‹ä¹‹å‰">å¼€å§‹ä¹‹å‰</h2><p>åœ¨å¼€å§‹ç¼–å†™ä»£ç ä¹‹å‰ï¼Œä½ éœ€è¦åœ¨ä½ çš„ Rust é¡¹ç›®ä¸­æ·»åŠ  <code>reqwest</code>ä¾èµ–ã€‚æ‰“å¼€ä½ çš„ <code>Cargo.toml</code> æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs toml"><span class="hljs-section">[dependencies]</span><br><span class="hljs-attr">reqwest</span> = <span class="hljs-string">&quot;0.11.24&quot;</span><br><span class="hljs-attr">tokio</span> = &#123; version = <span class="hljs-string">&quot;1&quot;</span>, features = [<span class="hljs-string">&quot;full&quot;</span>] &#125;<br><span class="hljs-attr">serde</span> = &#123; version = <span class="hljs-string">&quot;1.0.197&quot;</span>, features = [<span class="hljs-string">&quot;derive&quot;</span>] &#125;<br><span class="hljs-attr">serde_json</span> = <span class="hljs-string">&quot;1.0.114&quot;</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬è¿˜æ·»åŠ äº†å…¶ä»–å‡ ä¸ªä¾èµ–ï¼š</p><ul><li><code>tokio</code>: åœ¨åé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ <code>reqwest</code>çš„å¼‚æ­¥åŠŸèƒ½ã€‚</li><li><code>serde</code>: ç”¨äºæ•°æ®è§£æï¼Œåœ¨ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä¼šæ¼”ç¤º jsonæ•°æ®çš„è§£æã€‚</li><li><code>serde_json</code>: ä¾¿äºä½¿ç”¨ <code>json!</code> å®å¿«é€Ÿæ„å»º jsonæ•°æ®ã€‚</li></ul><h2 id="å‘é€-get-è¯·æ±‚">å‘é€ GET è¯·æ±‚</h2><p>å‘é€ä¸€ä¸ª GET è¯·æ±‚æ˜¯æœ€åŸºæœ¬çš„ HTTP æ“ä½œã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨<code>reqwest</code> å‘é€ GET è¯·æ±‚å¹¶è®¾ç½®è¯·æ±‚å¤´çš„ç¤ºä¾‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> reqwest::header;<br><br><span class="hljs-meta">#[tokio::main]</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;(), reqwest::Error&gt;&#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">params</span> = [(<span class="hljs-string">&quot;key1&quot;</span>, <span class="hljs-string">&quot;value1&quot;</span>), (<span class="hljs-string">&quot;key2&quot;</span>, <span class="hljs-string">&quot;values&quot;</span>)];<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">client</span> = reqwest::Client::<span class="hljs-title function_ invoke__">new</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">body</span> = client.<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">&quot;http://httpbin.org/get&quot;</span>)<br>  <span class="hljs-comment">// set query params</span><br>        .form(&amp;params)<br>  <span class="hljs-comment">// set request headers</span><br>        .<span class="hljs-title function_ invoke__">header</span>(header::USER_AGENT, <span class="hljs-string">&quot;My Rust Program&quot;</span>)<br>        .<span class="hljs-title function_ invoke__">header</span>(header::CONTENT_TYPE, <span class="hljs-string">&quot;application/json&quot;</span>)<br>        .<span class="hljs-keyword">await</span>?<br>        .<span class="hljs-title function_ invoke__">text</span>()<br>        .<span class="hljs-keyword">await</span>?;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;body = &#123;:?&#125;&quot;</span>, body);<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>reqwest::get</code> å‡½æ•°å‘é€ä¸€ä¸ª GETè¯·æ±‚åˆ° "https://httpbin.org/get"ï¼Œå¹¶é€šè¿‡ <code>text</code>æ–¹æ³•è·å–å“åº”çš„æ–‡æœ¬å†…å®¹ã€‚</p><h2 id="å‘é€-post---text-è¯·æ±‚">å‘é€ POST - text è¯·æ±‚</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> reqwest::Client;<br><br><span class="hljs-meta">#[tokio::main]</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;(), reqwest::Error&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">client</span> = Client::<span class="hljs-title function_ invoke__">new</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">res</span> = client.<span class="hljs-title function_ invoke__">post</span>(<span class="hljs-string">&quot;http://httpbin.org/post&quot;</span>)<br>        .<span class="hljs-title function_ invoke__">body</span>(<span class="hljs-string">&quot;the exact body that is sent&quot;</span>)<br>        .<span class="hljs-title function_ invoke__">send</span>()<br>        .<span class="hljs-keyword">await</span>?<br>        .<span class="hljs-title function_ invoke__">text</span>()<br>        .<span class="hljs-keyword">await</span>?;<br><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;body: &#123;:?&#125;&quot;</span>, res);<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å‘é€-post---form-è¯·æ±‚">å‘é€ POST - form è¯·æ±‚</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[tokio::main]</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;(), reqwest::Error&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">params</span> = [(<span class="hljs-string">&quot;key1&quot;</span>, <span class="hljs-string">&quot;value1&quot;</span>), (<span class="hljs-string">&quot;key2&quot;</span>, <span class="hljs-string">&quot;values&quot;</span>)];<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">client</span> = reqwest::Client::<span class="hljs-title function_ invoke__">new</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">res</span> = client.<span class="hljs-title function_ invoke__">post</span>(<span class="hljs-string">&quot;http://httpbin.org/post&quot;</span>)<br>        .form(&amp;params)<br>        .<span class="hljs-title function_ invoke__">send</span>()<br>        .<span class="hljs-keyword">await</span>?<br>        .<span class="hljs-title function_ invoke__">text</span>()<br>        .<span class="hljs-keyword">await</span>?;<br><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;body: &#123;:?&#125;&quot;</span>, res);<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å‘é€-post---json-è¯·æ±‚">å‘é€ POST - json è¯·æ±‚</h2><p>å‘é€ POST è¯·æ±‚é€šå¸¸ç”¨äºå‘æœåŠ¡å™¨æäº¤æ•°æ®ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨<code>reqwest</code> å‘é€åŒ…å« JSON æ•°æ®çš„ POST è¯·æ±‚çš„ç¤ºä¾‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> reqwest;<br><span class="hljs-keyword">use</span> serde_json::json;<br><br><span class="hljs-meta">#[tokio::main]</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;(), reqwest::Error&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">client</span> = reqwest::Client::<span class="hljs-title function_ invoke__">new</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">res</span> = client.<span class="hljs-title function_ invoke__">post</span>(<span class="hljs-string">&quot;https://httpbin.org/post&quot;</span>)<br>        .<span class="hljs-title function_ invoke__">json</span>(&amp;json!(&#123;<span class="hljs-string">&quot;key&quot;</span>: <span class="hljs-string">&quot;value&quot;</span>&#125;))<br>        .<span class="hljs-title function_ invoke__">send</span>()<br>        .<span class="hljs-keyword">await</span>?;<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">body</span> = res.<span class="hljs-title function_ invoke__">text</span>().<span class="hljs-keyword">await</span>?;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Body:\n&#123;&#125;&quot;</span>, body);<br><br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ <code>Client::post</code> æ–¹æ³•åˆ›å»ºä¸€ä¸ª POST è¯·æ±‚ï¼Œå¹¶é€šè¿‡<code>json</code> æ–¹æ³•è®¾ç½® JSON è´Ÿè½½ã€‚ç„¶åï¼Œæˆ‘ä»¬è°ƒç”¨ <code>send</code>æ–¹æ³•å‘é€è¯·æ±‚ã€‚</p><h2 id="å¤„ç†-json-å“åº”">å¤„ç† JSON å“åº”</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> reqwest;<br><span class="hljs-keyword">use</span> serde::Deserialize;<br><br><span class="hljs-meta">#[derive(Deserialize)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Ip</span> &#123;<br>    origin: <span class="hljs-type">String</span>,<br>&#125;<br><br><span class="hljs-meta">#[tokio::main]</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;(), reqwest::Error&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">ip</span>: Ip = reqwest::<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">&quot;https://httpbin.org/ip&quot;</span>)<br>        .<span class="hljs-keyword">await</span>?<br>        .<span class="hljs-title function_ invoke__">json</span>()<br>        .<span class="hljs-keyword">await</span>?;<br><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;IP: &#123;&#125;&quot;</span>, ip.origin);<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª <code>Ip</code> ç»“æ„ä½“æ¥è¡¨ç¤º JSONå“åº”ï¼Œç„¶åä½¿ç”¨ <code>json</code> æ–¹æ³•å°†å“åº”ååºåˆ—åŒ–ä¸º <code>Ip</code>ç±»å‹ã€‚</p><h2 id="æ€»ç»“">æ€»ç»“</h2><p><code>reqwest</code> åº“ä¸º Rust æä¾›äº†ä¸€ä¸ªåŠŸèƒ½ä¸°å¯Œè€Œçµæ´»çš„ HTTPå®¢æˆ·ç«¯ï¼Œé€‚ç”¨äºå„ç§ç½‘ç»œç¼–ç¨‹ä»»åŠ¡ã€‚æ— è®ºæ˜¯ç®€å•çš„æ•°æ®è·å–è¿˜æ˜¯å¤æ‚çš„ APIäº¤äº’ï¼Œ<code>reqwest</code> éƒ½èƒ½å¸®åŠ©ä½ ä»¥ç®€æ´çš„ Rustä»£ç å®Œæˆä»»åŠ¡ã€‚å¸Œæœ›è¿™ç¯‡åšæ–‡èƒ½å¸®åŠ©ä½ å¼€å§‹ä½¿ç”¨ <code>reqwest</code>æ¥å¼€å‘ç½‘ç»œç›¸å…³çš„ Rust åº”ç”¨ï¼</p>]]></content>
    
    
    <categories>
      
      <category>Rust</category>
      
      <category>Rust å¸¸ç”¨åº“</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Rust</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ·±å…¥æµ…å‡º Go è¯­è¨€çš„ GPM æ¨¡å‹ï¼ˆGo1.21ï¼‰</title>
    <link href="/2024/01/20/go-gpm/"/>
    <url>/2024/01/20/go-gpm/</url>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€">å¼•è¨€</h1><p>åœ¨ç°ä»£è½¯ä»¶å¼€å‘ä¸­ï¼Œæœ‰æ•ˆåœ°åˆ©ç”¨å¹¶å‘æ˜¯æé«˜åº”ç”¨æ€§èƒ½å’Œå“åº”é€Ÿåº¦çš„å…³é”®ã€‚éšç€å¤šæ ¸å¤„ç†å™¨çš„æ™®åŠï¼Œç¼–ç¨‹è¯­è¨€å’Œæ¡†æ¶å¦‚ä½•é«˜æ•ˆã€ç®€ä¾¿åœ°æ”¯æŒå¹¶å‘ç¼–ç¨‹ï¼Œæˆä¸ºäº†è½¯ä»¶å·¥ç¨‹å¸ˆä»¬è¯„ä¼°å’Œé€‰æ‹©å·¥å…·æ—¶çš„ä¸€ä¸ªé‡è¦è€ƒé‡ã€‚åœ¨è¿™æ–¹é¢ï¼ŒGoè¯­è¨€å‡­å€Ÿå…¶åˆ›æ–°çš„å¹¶å‘æ¨¡å‹â€”GPMï¼ˆGoroutine, P,Mï¼‰â€”åœ¨ä¼—å¤šç¼–ç¨‹è¯­è¨€ä¸­è„±é¢–è€Œå‡ºï¼Œä¸ºå¼€å‘è€…æä¾›äº†å¼ºå¤§çš„å·¥å…·ï¼Œä»¥ç®€å•ã€é«˜æ•ˆçš„æ–¹å¼å®ç°å¹¶å‘ã€‚</p><p>è‡ªä» 2009 å¹´é¦–æ¬¡å‘å¸ƒä»¥æ¥ï¼ŒGoè¯­è¨€å°±ä»¥å…¶å‡ºè‰²çš„æ€§èƒ½ã€ç®€æ´çš„è¯­æ³•å’Œå¯¹å¹¶å‘çš„åŸç”Ÿæ”¯æŒèµ¢å¾—äº†å¹¿æ³›çš„å…³æ³¨ã€‚å°¤å…¶æ˜¯å…¶å¹¶å‘æ¨¡å‹ï¼Œè¢«è®¾è®¡ä¸ºèƒ½å¤Ÿå……åˆ†åˆ©ç”¨ç°ä»£å¤šæ ¸å¤„ç†å™¨çš„èƒ½åŠ›ï¼ŒåŒæ—¶éšè—åº•å±‚çš„çº¿ç¨‹ç®¡ç†å’ŒåŒæ­¥å¤æ‚æ€§ï¼Œè®©å¼€å‘è€…èƒ½å¤Ÿä»¥æ›´ç›´è§‚ã€æ›´é«˜çº§çš„æŠ½è±¡æ¥æ„å»ºå¹¶å‘ç¨‹åºã€‚GPMæ¨¡å‹ï¼Œä½œä¸º Go è¯­è¨€å¹¶å‘ç¼–ç¨‹çš„æ ¸å¿ƒï¼Œé€šè¿‡Goroutineã€Pï¼ˆprocessorï¼‰ã€Mï¼ˆmachineï¼‰ä¸‰è€…çš„ååŒå·¥ä½œï¼Œå®ç°äº†ä¸€ç§é«˜æ•ˆä¸”æ˜“äºç®¡ç†çš„å¹¶å‘æœºåˆ¶ã€‚</p><p>æœ¬æ–‡å°†åŸºäº <strong>Go1.21</strong> æ·±å…¥æµ…å‡ºåœ°æ¢è®¨ Go è¯­è¨€çš„ GPMæ¨¡å‹ï¼Œä¸»è¦åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>é¦–å…ˆä»å…¶è®¾è®¡ç†å¿µå‡ºå‘ï¼Œè¯¦ç»†è§£æ Goroutineã€P å’Œ Mä¸‰è€…çš„è§’è‰²ã€å·¥ä½œåŸç†åŠå…¶ç›¸äº’ä¹‹é—´çš„äº¤äº’æ–¹å¼ã€‚</li><li>ç„¶åå¼•å…¥å‡ ä¸ªå…³é”®é—®é¢˜ï¼Œæˆ‘ä»¬ä¼šä»ç»“è®ºä¸Šå…ˆæ€»ç»“ GPMçš„æ ¸å¿ƒè¦ç‚¹ï¼Œå†…å®¹åŒ…æ‹¬åç¨‹è°ƒåº¦å¾ªç¯ã€è°ƒåº¦ç­–ç•¥å’Œè°ƒåº¦æ—¶æœºã€‚</li><li>æ¥ç€æˆ‘ä»¬ä¼šæ·±å…¥æºç ï¼Œå»ä¸€æ­¥æ­¥æ´å¯Ÿ Go è¯­è¨€è®¾è®¡è€…æ˜¯å¦‚ä½•å®ç° GPMæ¨¡å‹ä¸­çš„å„ä¸ªè¦ç‚¹çš„ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šæ¯”è¾ƒç¹çï¼Œä½†å…¶å®ä¹Ÿæ¯”è¾ƒæœ‰è¶£ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥é˜…è¯»è¿™ä¸€å—ï¼Œè‹¥åªæ˜¯æƒ³å¯¹GPM æ¨¡å‹æœ‰ä¸ªå¤§æ¦‚äº†è§£ï¼Œé‚£ä¹ˆåœç•™åœ¨ä¸Šä¸€æ­¥ä¹Ÿè¶³çŸ£äº†ã€‚</li><li>æœ€åæˆ‘ä»¬åŸºäºå‰é¢çš„åˆ†æï¼Œæ€»ç»“ Gã€Pã€M ä¸‰å¤§ç»„ä»¶åœ¨ Goç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­çš„çŠ¶æ€æµè½¬å›¾ã€‚</li></ul><p>é€šè¿‡å¯¹ GPM æ¨¡å‹çš„æ¢è®¨ï¼Œæˆ‘ä»¬ä¸ä»…èƒ½å¤Ÿç†è§£ Goè¯­è¨€å¦‚ä½•åœ¨ä¼—å¤šç°ä»£ç¼–ç¨‹è¯­è¨€ä¸­ä»¥å…¶å¹¶å‘ç¼–ç¨‹èƒ½åŠ›è„±é¢–è€Œå‡ºï¼Œè¿˜èƒ½å¤Ÿæ´å¯Ÿå…¶è®¾è®¡èƒŒåçš„æ™ºæ…§ï¼Œä»¥åŠè¿™ä¸€æ¨¡å‹å¦‚ä½•éšç€Go è¯­è¨€ç‰ˆæœ¬çš„è¿­ä»£è€Œä¸æ–­è¿›åŒ–å’Œä¼˜åŒ–ã€‚æ— è®ºä½ æ˜¯å¯¹ Goè¯­è¨€å……æ»¡å¥½å¥‡çš„æ–°æ‰‹ï¼Œè¿˜æ˜¯å¸Œæœ›æ·±åŒ–ç†è§£å…¶å¹¶å‘æ¨¡å‹çš„ç»éªŒå¼€å‘è€…ï¼Œæœ¬æ–‡éƒ½å°†ä¸ºä½ æä¾›å®è´µçš„è§†è§’å’Œæ·±åˆ»çš„æ´è§ã€‚</p><h1 id="ç»“è®ºå…ˆè¡Œ">ç»“è®ºå…ˆè¡Œ</h1><h2 id="gpm-è°ƒåº¦åŸç†å›¾">GPM è°ƒåº¦åŸç†å›¾</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240126214830929.png"alt="Goroutine è°ƒåº¦åŸç†å›¾" /><figcaption aria-hidden="true">Goroutine è°ƒåº¦åŸç†å›¾</figcaption></figure><h2 id="goroutine-åº•å±‚ç»“æ„">Goroutine åº•å±‚ç»“æ„</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/e6c9d24egy1h569pjiiosj21cu0u040p.jpg"alt="Goroutine åº•å±‚ç»“æ„ç¤ºä¾‹" /><figcaption aria-hidden="true">Goroutine åº•å±‚ç»“æ„ç¤ºä¾‹</figcaption></figure><h2 id="è°ƒåº¦å™¨-p-åº•å±‚ç»“æ„">è°ƒåº¦å™¨ P åº•å±‚ç»“æ„</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/e6c9d24egy1h57sl36b40j20o40u8js7.jpg"alt="P åº•å±‚ç»“æ„" /><figcaption aria-hidden="true">P åº•å±‚ç»“æ„</figcaption></figure><h2 id="gpm-è°ƒåº¦å¾ªç¯">GPM è°ƒåº¦å¾ªç¯</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/e6c9d24egy1h57qxoptk4j21hm0simyy.jpg"alt="GPM è°ƒåº¦å¾ªç¯å›¾" /><figcaption aria-hidden="true">GPM è°ƒåº¦å¾ªç¯å›¾</figcaption></figure><h2 id="gpm-åç¨‹è°ƒåº¦ä¼˜å…ˆçº§ä¸é¡ºåº">GPM åç¨‹è°ƒåº¦ä¼˜å…ˆçº§ä¸é¡ºåº</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240127161341751.png"alt="Go åç¨‹è°ƒåº¦ä¼˜å…ˆçº§ä¸é¡ºåº" /><figcaption aria-hidden="true">Go åç¨‹è°ƒåº¦ä¼˜å…ˆçº§ä¸é¡ºåº</figcaption></figure><h2 id="å¯»æ‰¾å¯æ‰§è¡Œ-g-è¿‡ç¨‹">å¯»æ‰¾å¯æ‰§è¡Œ G è¿‡ç¨‹</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240128212451142.png"alt="findRunnable()" /><figcaption aria-hidden="true">findRunnable()</figcaption></figure><h2 id="åç¨‹åˆ‡æ¢æ—¶æœº">åç¨‹åˆ‡æ¢æ—¶æœº</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240129000028727.png"alt="Go åç¨‹åˆ‡æ¢æ—¶æœº" /><figcaption aria-hidden="true">Go åç¨‹åˆ‡æ¢æ—¶æœº</figcaption></figure><h1 id="gpm-æ¨¡å‹">GPM æ¨¡å‹</h1><h2 id="æ¦‚è§ˆ">1. æ¦‚è§ˆ</h2><p>è¿™é‡Œæœ‰ä¸€å¼ å¾ˆæµè¡Œçš„ Goroutine è°ƒåº¦åŸç†å›¾ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240126214830929.png"alt="Goroutine è°ƒåº¦åŸç†å›¾" /><figcaption aria-hidden="true">Goroutine è°ƒåº¦åŸç†å›¾</figcaption></figure><table><thead><tr class="header"><th>ä»£å·</th><th>åç§°</th><th>å®šä¹‰ä½ç½®</th><th>ä½œç”¨</th></tr></thead><tbody><tr class="odd"><td>Sched</td><td>è°ƒåº¦å™¨</td><td>proc.c</td><td>ç»´æŠ¤æœ‰å­˜å‚¨ M å’Œ G çš„é˜Ÿåˆ—ä»¥åŠè°ƒåº¦å™¨çš„ä¸€äº›çŠ¶æ€ä¿¡æ¯ç­‰ã€‚</td></tr><tr class="even"><td>M</td><td>Machine ç³»ç»Ÿçº¿ç¨‹</td><td>runtime.h</td><td>å®ƒç”±æ“ä½œç³»ç»Ÿç®¡ç†çš„ï¼ŒGoroutine å°±æ˜¯è·‘åœ¨ M ä¹‹ä¸Šçš„ï¼›Mæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„ç»“æ„ï¼Œé‡Œé¢ç»´æŠ¤å°å¯¹è±¡å†…å­˜ cacheï¼ˆmcacheï¼‰ã€å½“å‰æ‰§è¡Œçš„Goroutineã€éšæœºæ•°å‘ç”Ÿå™¨ç­‰ç­‰éå¸¸å¤šçš„ä¿¡æ¯ã€‚</td></tr><tr class="odd"><td>P</td><td>Processor å¤„ç†å™¨</td><td>runtime.h</td><td>å®ƒçš„ä¸»è¦ç”¨é€”å°±æ˜¯ç”¨æ¥æ‰§è¡Œ Goroutine çš„ï¼Œå®ƒç»´æŠ¤äº†ä¸€ä¸ª Goroutineé˜Ÿåˆ—ï¼Œå³ runqueueã€‚Processor æ˜¯è®©æˆ‘ä»¬ä» N:1 è°ƒåº¦åˆ° M:Nè°ƒåº¦çš„é‡è¦éƒ¨åˆ†ã€‚æ‰€æœ‰çš„ P éƒ½åœ¨ç¨‹åºå¯åŠ¨æ—¶åˆ›å»ºï¼Œå¹¶ä¿å­˜åœ¨æ•°ç»„ä¸­ï¼Œæœ€å¤šæœ‰GOMAXPROCSï¼ˆå¯é…ç½®ï¼‰ä¸ªã€‚</td></tr><tr class="even"><td>G</td><td>Goroutine å®ç°çš„æ ¸å¿ƒç»“æ„</td><td>runtime.h</td><td>å®ƒåŒ…å«äº†æ ˆï¼ŒæŒ‡ä»¤æŒ‡é’ˆï¼Œä»¥åŠå…¶ä»–å¯¹è°ƒåº¦ Goroutineå¾ˆé‡è¦çš„ä¿¡æ¯ï¼Œä¾‹å¦‚å…¶é˜»å¡çš„ channelã€‚</td></tr><tr class="odd"><td>Global Queue</td><td>å…¨å±€é˜Ÿåˆ—</td><td>proc.h</td><td>å­˜æ”¾ç­‰å¾…è¿è¡Œçš„ Gã€‚å…¨å±€é˜Ÿåˆ—å¯èƒ½è¢«ä»»æ„çš„ P åŠ é”å»è·å–é‡Œé¢çš„ Gã€‚</td></tr><tr class="even"><td>P Local Queue</td><td>P çš„æœ¬åœ°é˜Ÿåˆ—</td><td>proc.h</td><td>åŒå…¨å±€é˜Ÿåˆ—ç±»ä¼¼ï¼Œå­˜æ”¾çš„ä¹Ÿæ˜¯ç­‰å¾…è¿è¡Œçš„ Gï¼Œä½†å­˜æ”¾çš„æ•°æ®æœ‰é™ï¼Œä¸ä¼šè¶…è¿‡256 ä¸ªã€‚æ–°å»º G æ—¶ï¼ŒGä¼šä¼˜å…ˆåŠ å…¥æœ¬åœ°é˜Ÿåˆ—ã€‚å¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™ä¼šæŠŠæœ¬åœ°é˜Ÿåˆ—ä¸­ä¸€åŠçš„ G ä»¥åŠæ–° Gä¸€èµ·ç§»åŠ¨åˆ°å…¨å±€é˜Ÿåˆ—ã€‚</td></tr></tbody></table><p>é€šè¿‡è¿™ä¸ªåŸç†å›¾æˆ‘ä»¬çŸ¥é“ Go è¯­è¨€çš„ GPMæ¨¡å‹çš„ä½œç”¨éå¸¸ç®€å•ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªâ€œç²¾æ‰“ç»†ç®—â€çš„å·¥å…·ã€‚ä»¥å‰å•è¿›ç¨‹æ— æ³•å……åˆ†åˆ©ç”¨CPUèµ„æºï¼Œæ‰€ä»¥å¼•å…¥äº†å¤šè¿›ç¨‹ã€‚åˆå› ä¸ºè¿›ç¨‹æ‹¥æœ‰çš„èµ„æºå¤ªå¤šï¼Œå…¶åˆ›å»ºã€åˆ‡æ¢å’Œé”€æ¯éƒ½ä¼šå ç”¨å¾ˆé•¿æ—¶é—´ï¼Œæ‰€ä»¥å¼•å…¥äº†æ›´å°ç²’åº¦çš„çº¿ç¨‹ã€‚éšç€è®¡ç®—æœºç§‘å­¦çš„è¿›æ­¥ï¼Œç°åœ¨çœ‹æ¥ï¼Œçº¿ç¨‹æ‹¥æœ‰çš„èµ„æºä¹Ÿæ˜¯â€œæ¯”è¾ƒå¤šâ€çš„ï¼Œæ‰€ä»¥çº¿ç¨‹çš„åˆ›å»ºã€åˆ‡æ¢å’Œé”€æ¯ä»£ä»·ä¹Ÿæ˜¯â€œç›¸å¯¹å¤§â€çš„ã€‚æ‰€ä»¥å¾ˆå¤šç¼–ç¨‹è¯­è¨€å°±å¼•å…¥äº†åç¨‹è¿™ä¸ªæ¦‚å¿µï¼Œå…¶æ ¸å¿ƒç›®çš„å°±æ˜¯åº”ç”¨å±‚è‡ªå·±æŠ½è±¡ä¸€ä¸ªæ¯”çº¿ç¨‹æ›´å°ç²’åº¦çš„è°ƒåº¦å•å…ƒï¼Œåº”ç”¨å±‚ç»“åˆæ“ä½œç³»ç»Ÿçš„å¤šçº¿ç¨‹èƒ½åŠ›ï¼Œè‡ªå·±æ¥ç®¡ç†â€œè°ƒåº¦å•å…ƒâ€çš„åˆ›å»ºã€åˆ‡æ¢å’Œé”€æ¯ï¼Œä»è€Œå°½å¯èƒ½å‡å°‘ç”±çº¿ç¨‹åˆ‡æ¢å¸¦æ¥çš„å¼€é”€ï¼Œä»¥åšåˆ°æ›´è½»é‡çº§çš„å¹¶å‘ã€‚</p><p>ä¸åŒçš„ç¼–ç¨‹è¯­è¨€å¯èƒ½æœ‰ä¸åŒçš„å®ç°ï¼Œè€Œå…³é”®å°±åœ¨äºå¦‚ä½•è®©è°ƒåº¦æ›´å¿«ã€å¼€é”€æ›´å°ã€‚è¿™ä¾¿æ˜¯æˆ‘ä»¬æœ¬æ–‡è¦æ¢è®¨çš„ä¸»è¦å†…å®¹ã€‚</p><div class="note note-info">            <p><strong>Go è¯­è¨€çš„å®ç°ï¼š</strong></p><p>çº¿ç¨‹æƒ³è¿è¡Œä»»åŠ¡å°±å¾—è·å– Pï¼Œä» P çš„æœ¬åœ°é˜Ÿåˆ—è·å– Gï¼Œå½“ Pçš„æœ¬åœ°é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼ŒM ä¼šå°è¯•ä»å…¨å±€é˜Ÿåˆ—è·å¾—ä¸€æ‰¹ G æ”¾åˆ° Pçš„æœ¬åœ°é˜Ÿåˆ—ï¼Œæˆ–è€…ä»å…¶ä»– P çš„æœ¬åœ°é˜Ÿåˆ—ä¸­â€œå·â€ä¸€åŠ G æ”¾åˆ°è‡ªå·±çš„æœ¬åœ°é˜Ÿåˆ—ã€‚ç„¶åM è¿è¡Œ Gï¼ŒG æ‰§è¡Œä¹‹åï¼Œå†ä» P è·å–ä¸‹ä¸€ä¸ª Gï¼Œå¦‚æ­¤ä¸æ–­é‡å¤ä¸‹å»ã€‚</p>          </div><p>åœ¨è¿›å…¥æ›´åŠ å…·ä½“æ·±å…¥çš„è®¨è®ºä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦é‡ç‚¹æ€è€ƒä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š</p><ol type="1"><li>G æˆ‘ä»¬å¯ä»¥éšä¾¿åˆ›å»ºï¼Œå¯èƒ½æœ‰æˆåƒä¸Šä¸‡ä¸ªï¼Œé‚£ P å’Œ M æœ‰å¤šå°‘ä¸ªå‘¢ï¼Ÿ</li><li>P å’Œ M ä»€ä¹ˆæ—¶å€™è¢«åˆ›å»ºå‘¢ï¼Ÿ</li><li>æ“ä½œç³»ç»ŸåªçŸ¥é“çº¿ç¨‹ï¼Œæ‰€ä»¥å®é™…ä¸Šè¿˜æ˜¯çº¿ç¨‹åœ¨æ‰§è¡Œä»»åŠ¡ï¼Œé‚£ä¹ˆ Gæ˜¯å¦‚ä½•è°ƒåº¦åˆ°çº¿ç¨‹ä¸Šå¹¶æ‰§è¡Œçš„å‘¢ï¼Ÿ</li><li>å¦‚ä½•é˜²æ­¢åç¨‹é¥¥é¥¿ï¼Ÿ</li><li>å¦‚ä½•å‡å°‘é¢‘ç¹åœ°åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ï¼Ÿ</li><li>å¤šä¸ªçº¿ç¨‹ä»å…¨å±€é˜Ÿåˆ—æ‹¿ Gå¦‚ä½•è§£å†³å¹¶å‘é—®é¢˜ï¼Ÿåˆå¦‚ä½•å‡å°‘è¿™ç§æ•°æ®ç«äº‰å‘¢ï¼Ÿ</li><li>åœ¨æ•´ä¸ª Go è°ƒåº¦åç¨‹çš„è¿‡ç¨‹ä¸­ï¼ŒGã€Pã€Mæœ‰å“ªäº›çŠ¶æ€ï¼Ÿå®ƒä»¬åˆæ˜¯å¦‚ä½•è½®è½¬çš„å‘¢ï¼Ÿ</li></ol><p>å¦‚æœä½ å¯¹è¿™å‡ ä¸ªé—®é¢˜æœ‰å…´è¶£ï¼Œè¯·ç»§ç»­é˜…è¯»ä¸‹æ–‡ã€‚</p><h2 id="p-å’Œ-m-çš„ä¸ªæ•°é—®é¢˜">2. P å’Œ M çš„ä¸ªæ•°é—®é¢˜</h2><ol type="1"><li>P çš„æ•°é‡ç”±å¯åŠ¨æ—¶ç¯å¢ƒå˜é‡ <code>$GOMAXPROCS</code> æˆ–è€…ç¨‹åºä¸­<code>runtime.GOMAXPROCS()</code>å†³å®šã€‚è¿™æ„å‘³ç€åœ¨ç¨‹åºæ‰§è¡Œçš„ä»»æ„æ—¶åˆ»éƒ½åªæœ‰ <code>GOMAXPROCS</code> ä¸ªGoroutine åœ¨åŒæ—¶è¿è¡Œã€‚</li><li>M çš„æ•°é‡ç”± Go è¯­è¨€æœ¬èº«çš„é™åˆ¶å†³å®šï¼ŒGo ç¨‹åºå¯åŠ¨æ—¶ä¼šè®¾ç½® M çš„æœ€å¤§æ•°é‡ä¸º<strong>10000</strong>ä¸ªï¼Œä½†æ˜¯å†…æ ¸å¾ˆéš¾æ”¯æŒè¿™ä¹ˆå¤šçš„çº¿ç¨‹æ•°ï¼Œæ‰€ä»¥è¿™ä¸ªé™åˆ¶å¯ä»¥å¿½ç•¥ã€‚å¯ä»¥ä½¿ç”¨<code>runtime.SetMaxThreads()</code> è®¾ç½® M çš„æœ€å¤§æ•°é‡ã€‚</li></ol><h2 id="p-å’Œ-m-ä½•æ—¶è¢«åˆ›å»º">3. P å’Œ M ä½•æ—¶è¢«åˆ›å»º</h2><ol type="1"><li>P çš„åˆ›å»ºæ—¶æœºåœ¨ç¡®å®šäº† P çš„æœ€å¤§æ•°é‡ n åï¼Œruntime ä¼šæ ¹æ®è¿™ä¸ªæ•°é‡åˆ›å»º nä¸ª Pã€‚</li><li>M åˆ›å»ºçš„æ—¶æœºæ˜¯åœ¨å½“æ²¡æœ‰è¶³å¤Ÿçš„ M æ¥å…³è” P å¹¶è¿è¡Œå…¶ä¸­å¯è¿è¡Œçš„ Gçš„æ—¶å€™ï¼Œå¦‚æ‰€æœ‰çš„ M æ­¤æ—¶éƒ½é˜»å¡ä½äº†ï¼Œè€Œ Pä¸­è¿˜æœ‰å¾ˆå¤šå°±ç»ªä»»åŠ¡ï¼Œå°±ä¼šå»å¯»æ‰¾ç©ºé—²çš„ Mï¼Œå¦‚æœæ²¡æœ‰ç©ºé—²çš„ Mï¼Œå°±ä¼šå»åˆ›å»ºæ–°çš„Mã€‚</li></ol><h2 id="è°ƒåº¦å¾ªç¯">4. è°ƒåº¦å¾ªç¯</h2><p>åœ¨è®¨è®º G æ˜¯å¦‚ä½•è¢«è°ƒåº¦åˆ° M å»æ‰§è¡Œçš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å…ˆä»‹ç» GPMæ¨¡å‹ä¸­ä¸¤ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„è§’è‰²ï¼š<code>m0</code> å’Œ <code>g0</code>ã€‚</p><h3 id="m0">4.1 m0</h3><ul><li><strong>å®šä¹‰</strong>ï¼šm0 æ˜¯ Go ç¨‹åºå¯åŠ¨æ—¶åˆ›å»ºçš„ç¬¬ä¸€ä¸ª Mã€‚å®ƒæ˜¯ç”± Goè¿è¡Œæ—¶ç³»ç»Ÿç›´æ¥ä»æ“ä½œç³»ç»Ÿçº¿ç¨‹åˆ›å»ºçš„ï¼Œä¸æ˜¯ä»çº¿ç¨‹æ± ä¸­è·å–çš„ã€‚</li><li><strong>ä½œç”¨</strong>ï¼šm0 è´Ÿè´£åˆå§‹åŒ–å’Œå¯åŠ¨ Goè¿è¡Œæ—¶ç¯å¢ƒï¼ŒåŒ…æ‹¬åˆ›å»ºè°ƒåº¦å™¨ã€åˆ†é…ç¬¬ä¸€ä¸ªPï¼ˆp0ï¼‰ï¼Œå¹¶åˆ›å»ºå…¶ä»–ç³»ç»Ÿçº§åˆ«çš„èµ„æºã€‚åœ¨ç¨‹åºçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­ï¼Œm0ä¼šç»§ç»­å­˜åœ¨ï¼Œå³ä½¿å®ƒå¯èƒ½ä¸æ‰§è¡Œä»»ä½• Go ä»£ç ã€‚</li><li><strong>ç‰¹ç‚¹</strong>ï¼šm0 ä¸åŒäºå…¶ä»–Mï¼Œå› ä¸ºå®ƒä¸æ˜¯ä»çº¿ç¨‹æ± ä¸­è·å–çš„ã€‚å®ƒå¯èƒ½æ²¡æœ‰ç»‘å®šä»»ä½• Pï¼Œé™¤éç¨‹åºä¸­åªæœ‰ä¸€ä¸ªPï¼ˆå³ GOMAXPROCS è®¾ç½®ä¸º 1ï¼‰ã€‚</li></ul><h3 id="g0">4.2 g0</h3><ul><li><strong>å®šä¹‰</strong>ï¼šg0 æ˜¯æ¯ä¸ª M çš„ç‰¹æ®ŠGoroutineï¼Œå®ƒä¸æ‰§è¡Œä»»ä½•å®é™…çš„ Go ä»£ç ã€‚æ¯ä¸ª M åœ¨åˆ›å»ºæ—¶éƒ½ä¼šåˆ†é…ä¸€ä¸ªg0ã€‚</li><li><strong>ä½œç”¨</strong>ï¼šg0 ä¸»è¦ç”¨äºæ‰§è¡Œè°ƒåº¦å™¨ä»£ç å’Œè¿›è¡Œç³»ç»Ÿè°ƒç”¨ã€‚å½“ Méœ€è¦æ‰§è¡Œè¿™äº›éç”¨æˆ·ä»£ç æ—¶ï¼Œä¼šåˆ‡æ¢åˆ° g0 çš„æ ˆä¸Šè¿è¡Œã€‚</li><li><strong>ç‰¹ç‚¹</strong>ï¼šg0æ‹¥æœ‰è‡ªå·±çš„æ ˆï¼Œè¿™ä¸ªæ ˆç”¨äºå­˜æ”¾è°ƒåº¦å™¨å‡½æ•°å’Œç³»ç»Ÿè°ƒç”¨çš„æ•°æ®ã€‚è¿™æ„å‘³ç€å½“æ‰§è¡Œè¿™äº›æ“ä½œæ—¶ï¼Œä¸ä¼šå½±å“å½“å‰è¿è¡Œçš„ç”¨æˆ·Goroutine çš„æ ˆã€‚</li></ul><h3 id="åç¨‹æ ˆåˆ‡æ¢">4.3 åç¨‹æ ˆåˆ‡æ¢</h3><p>g0 æ˜¯ M ä¸­è´Ÿè´£è°ƒåº¦å…¶ä»– g çš„åç¨‹ï¼Œæ‰€ä»¥ä¸€ä¸ª M ä¸­çš„åç¨‹è°ƒåº¦å…¶å®å°±æ˜¯åœ¨ gå’Œ g0 ä¹‹é—´ä¸æ–­åˆ‡æ¢ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240127155030695.png"alt="åç¨‹ g ä¸ åç¨‹ g0 çš„å¯¹åº”å…³ç³»" /><figcaption aria-hidden="true">åç¨‹ g ä¸ åç¨‹ g0 çš„å¯¹åº”å…³ç³»</figcaption></figure><p>å¤§è‡´è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol type="1"><li>å½“ M æ‰§è¡Œä¸€ä¸ª Gï¼ˆç”¨æˆ· Goroutineï¼‰æ—¶ï¼Œå®ƒä½¿ç”¨ Gçš„æ ˆæ¥è¿è¡Œç”¨æˆ·ä»£ç ã€‚</li><li>å½“éœ€è¦æ‰§è¡Œç³»ç»Ÿè°ƒç”¨æˆ–è°ƒåº¦å™¨ç›¸å…³çš„ä»£ç æ—¶ï¼ŒM ä¼šåˆ‡æ¢åˆ° g0ã€‚g0æ‹¥æœ‰è‡ªå·±çš„æ ˆï¼Œä¸“é—¨ç”¨äºæ‰§è¡Œç³»ç»Ÿè°ƒç”¨å’Œè°ƒåº¦å™¨ä»£ç ï¼Œè¿™æ ·å¯ä»¥é¿å…æ±¡æŸ“ç”¨æˆ·Goroutine çš„æ ˆç©ºé—´ã€‚åœ¨ g0 ä¸Šï¼ŒM å¯ä»¥æ‰§è¡Œå¦‚å†…å­˜åˆ†é…ã€è°ƒåº¦å†³ç­–ã€å¤„ç†Goroutine çš„åˆ›å»ºå’Œé”€æ¯ç­‰æ“ä½œã€‚</li><li>å®Œæˆç³»ç»Ÿè°ƒç”¨æˆ–è°ƒåº¦å™¨ä»»åŠ¡åï¼ŒM ä¼šåˆ‡æ¢å›ä¹‹å‰çš„Gï¼Œç»§ç»­æ‰§è¡Œç”¨æˆ·ä»£ç ã€‚è¿™ä¸ªè¿‡ç¨‹ä¼šä» g0 çš„æ ˆåˆ‡æ¢å› G çš„æ ˆã€‚</li></ol><p>è¯¦ç»†ç»†èŠ‚æˆ‘ä»¬ç•™åˆ°åé¢çš„æºç åˆ†ææ­æ™“ã€‚</p><h2 id="è°ƒåº¦ç­–ç•¥">5. è°ƒåº¦ç­–ç•¥</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240127161341751.png"alt="Go åç¨‹è°ƒåº¦ä¼˜å…ˆçº§ä¸é¡ºåº" /><figcaption aria-hidden="true">Go åç¨‹è°ƒåº¦ä¼˜å…ˆçº§ä¸é¡ºåº</figcaption></figure><h3 id="è·å–æœ¬åœ°è¿è¡Œé˜Ÿåˆ—">5.1 è·å–æœ¬åœ°è¿è¡Œé˜Ÿåˆ—</h3><p>P ä¼šä¼˜å…ˆå°è¯•ä»è‡ªå·±çš„æœ¬åœ°é˜Ÿåˆ—ä¸­å¯»æ‰¾å°±ç»ªçš„Gï¼Œå®ƒ<strong>ä¸€èˆ¬</strong>ä¼šä¼˜å…ˆè°ƒåº¦æœ€è¿‘åŠ å…¥çš„ã€‚</p><p>å› ä¸ºè¿™ä¸ªæ—¶å€™å¯èƒ½ç”±å…¶ä»– P æ¥çªƒå– Gï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯éœ€è¦åŒæ­¥æœºåˆ¶çš„ï¼ŒGoé‡‡ç”¨åŸå­æ“ä½œæ¥é™ä½åŒæ­¥å¼€é”€ã€‚</p><p>æœ¬åœ°é˜Ÿåˆ— G çš„ä¸ªæ•°ä¸è¶…è¿‡ <strong>256</strong> ä¸ªï¼Œ<strong>å¦‚æœåœ¨åˆ›å»º Gçš„æ—¶å€™æœ¬åœ°é˜Ÿåˆ—æ»¡äº†ï¼Œä¼šå°†æœ¬åœ°é˜Ÿåˆ—ä¸­ 1/2 çš„ G è¿åŒæ–°åˆ›å»ºçš„ Gä¸€èµ·æ”¾å…¥å…¨å±€é˜Ÿåˆ—ä¸­ã€‚</strong></p><h3 id="è·å–å…¨å±€è¿è¡Œé˜Ÿåˆ—">5.2 è·å–å…¨å±€è¿è¡Œé˜Ÿåˆ—</h3><p>P ä¼šä¼˜å…ˆæœ¬åœ°é˜Ÿåˆ—ï¼Œç„¶åæ‰å…¨å±€é˜Ÿåˆ—ï¼Œè¿™æœ‰ä¸ªå¥½å¤„ï¼š</p><ul><li>å¦‚æœåªæœ‰å…¨å±€é˜Ÿåˆ—ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„ P éƒ½éœ€è¦å»ç«äº‰å…¨å±€é˜Ÿåˆ—ä¸­çš„Gï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦ä¸Šé”ï¼Œä¸”æ•°æ®ç«äº‰ä¼šæ¯”è¾ƒæ¿€çƒˆï¼Œæ€§èƒ½è¾ƒå·®ã€‚</li><li>é€šè¿‡æ¯ä¸ª Pç»´æŠ¤ä¸€ä¸ªè‡ªå·±çš„æœ¬åœ°é˜Ÿåˆ—å¯ä»¥å‡å°‘å¹¶å‘å†²çªï¼Œå¦‚æœå®åœ¨éœ€è¦å»å…¨å±€é˜Ÿåˆ—æ‹¿Gï¼Œä¹Ÿå¯ä»¥ä¸€æ¬¡æ€§æ‹¿å¤šä¸ªï¼Œå¤§å¤§å‡å°‘äº†å¹¶å‘å†²çªçš„æƒ…å†µå‘ç”Ÿã€‚</li></ul><p>ä½†è¿™åˆå¸¦æ¥äº†ä¸€ä¸ªé—®é¢˜ï¼Œå…¨å±€é˜Ÿåˆ—ä¸­åç¨‹çš„é¥¥é¥¿é—®é¢˜ï¼Œå› ä¸º Pä¼šä¼˜å…ˆè°ƒåº¦æœ€è¿‘åŠ å…¥åˆ°è‡ªå·±æœ¬åœ°é˜Ÿåˆ—ä¸­çš„ Gï¼Œé‚£å¯èƒ½ä¼šä¸€ç›´æœ‰æ–°çš„ Gè¢«åˆ›å»ºï¼Œå¯¼è‡´å…¨å±€é˜Ÿåˆ—ä¸­çš„ G æ²¡æœ‰æœºä¼šè¢«è°ƒåº¦åˆ°ã€‚Go çš„è§£å†³æ€è·¯æ˜¯ï¼š</p><ul><li>P æ¯è°ƒåº¦ <strong>61</strong> æ¬¡åï¼Œå°±ä¼šä»å…¨å±€é˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ª Gæ¥è¿è¡Œã€‚</li></ul><h3 id="è·å–å‡†å¤‡å°±ç»ªçš„ç½‘ç»œåç¨‹">5.3 è·å–å‡†å¤‡å°±ç»ªçš„ç½‘ç»œåç¨‹</h3><p>å¦‚æœæœ¬åœ°é˜Ÿåˆ—å’Œå…¨å±€é˜Ÿåˆ—éƒ½æ‰¾ä¸åˆ°å°±ç»ªçš„ G å¯ä»¥æ‰§è¡Œçš„è¯ã€‚è°ƒåº¦ä¼šé€šè¿‡<code>runtime.netpoll</code> è·å–å¯ä»¥è¿è¡Œçš„ç½‘ç»œåç¨‹ã€‚</p><p>Go è¯­è¨€çš„ç½‘ç»œæ¨¡å‹æ˜¯å¯¹ä¸åŒæ“ä½œç³»ç»Ÿå¹³å°ä¸Š I/O å¤šè·¯å¤ç”¨æŠ€æœ¯çš„å°è£…ã€‚</p><p>å½“ Goroutine åœ¨è¿›è¡Œç½‘ç»œ I/O æ—¶ï¼Œå®ƒä¼šè¢«æŒ‚èµ·ï¼Œçº¿ç¨‹ä¼šå»æ‰§è¡Œå…¶ä»–Goroutineã€‚ä¸€æ—¦ I/O æ“ä½œå®Œæˆï¼Œè¯¥ Goroutineä¼šè¢«å”¤é†’å¹¶é‡æ–°æ’é˜Ÿç­‰å¾…æ‰§è¡Œã€‚</p><h3 id="ç³»ç»Ÿè°ƒç”¨">5.4 ç³»ç»Ÿè°ƒç”¨</h3><p>å½“ä¸€ä¸ª Goroutineæ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå®ƒå¯èƒ½ä¼šè¢«é˜»å¡ï¼Œè¿™æ—¶å®ƒçš„æ‰§è¡Œçº¿ç¨‹ï¼ˆMï¼‰å¯èƒ½ä¼šé‡Šæ”¾å½“å‰ç»‘å®šçš„å¤„ç†å™¨ï¼ˆPï¼‰ï¼Œä»¥ä¾¿å…¶ä»–Goroutine å¯ä»¥åœ¨è¯¥ P ä¸Šè¿è¡Œã€‚</p><h3 id="åç¨‹çªƒå–">5.5 åç¨‹çªƒå–</h3><p>ç©ºé—²çš„ M å¦‚æœç»‘å®šäº† Pï¼Œé‚£ä¹ˆå®ƒçš„ P ä¼šä¸€ç›´å°è¯•ä»å…¶ä»– P çš„é˜Ÿåˆ—ä¸­çªƒå–Goroutineï¼Œä»¥å¹³è¡¡è´Ÿè½½å’Œé¿å…ç©ºé—²ã€‚è¿™ä¸ªæ—¶å€™ä¸ºäº†è®©æ¯ä¸ª P éƒ½æœ‰å¯èƒ½è¢«çªƒå–ï¼ŒGoæ²¡æœ‰ç›´æ¥é¡ºåºéå† P åˆ—è¡¨ï¼Œè€Œæ˜¯é‡‡ç”¨äº†ä¸€ç§ç›¸å¯¹éšæœºçš„æ–¹å¼å»éå† Påˆ—è¡¨ï¼Œç›´åˆ°æ‰¾åˆ°å¯ä»¥è¿è¡Œçš„åç¨‹å°±è¿”å›ã€‚M ä¸æ–­å¯»æ‰¾å¯æ‰§è¡Œ Gçš„è¿™æ®µæœŸé—´ï¼Œå®ƒè¢«ç§°ä¸º<strong>è‡ªæ—‹çº¿ç¨‹</strong>ã€‚</p><p>æ‰€ä»¥ä¸ºå‡å°‘åˆ›å»ºã€åˆ‡æ¢å’Œé”€æ¯çº¿ç¨‹çš„å¼€é”€ï¼ŒGo åšäº†è‡³å°‘ä¸¤ç‚¹åŠªåŠ›ï¼š</p><ol type="1"><li><p>å·å–ï¼ˆWork Stealingï¼‰æœºåˆ¶</p><p>å½“æœ¬çº¿ç¨‹æ— å¯è¿è¡Œçš„ G æ—¶ï¼Œå®ƒæ‰€ç»‘å®šçš„ P ä¼šå°è¯•ä»å…¶ä»–çº¿ç¨‹ç»‘å®šçš„ P çªƒå–Gï¼Œè€Œä¸æ˜¯é”€æ¯çº¿ç¨‹ã€‚</p></li><li><p>ç§»äº¤ï¼ˆHand Offï¼‰æœºåˆ¶</p><p>å½“æœ¬çº¿ç¨‹å› ä¸º G è¿›è¡Œç³»ç»Ÿè°ƒç”¨è€Œé˜»å¡æ—¶ï¼Œçº¿ç¨‹ä¼šé‡Šæ”¾ç»‘å®šçš„ Pï¼ŒæŠŠ Pç§»äº¤ç»™å…¶ä»–ç©ºé—²çš„çº¿ç¨‹æ‰§è¡Œã€‚</p></li></ol><h2 id="è°ƒåº¦æ—¶æœº">6. è°ƒåº¦æ—¶æœº</h2><p>Go è¯­è¨€çš„è°ƒåº¦å™¨ç»“åˆäº†æŠ¢å å¼è°ƒåº¦å’Œåä½œå¼è°ƒåº¦ï¼Œä»¥ä¸‹æ˜¯ Goä¸­è¿™ä¸¤ç§è°ƒåº¦æ–¹å¼çš„å…·ä½“å®ç°å’Œç‰¹æ€§ï¼š</p><h3 id="åä½œå¼è°ƒåº¦cooperative-scheduling">6.1 åä½œå¼è°ƒåº¦ï¼ˆCooperativeSchedulingï¼‰</h3><p><strong>é˜»å¡æ“ä½œ</strong>ï¼š</p><ul><li>å½“ Goroutineæ‰§è¡Œé˜»å¡æ“ä½œï¼ˆå¦‚é€šé“æ“ä½œã€ç­‰å¾…é”ã€ç³»ç»Ÿè°ƒç”¨ç­‰ï¼‰æ—¶ï¼Œå®ƒä¼šä¸»åŠ¨æ”¾å¼ƒ CPUæ§åˆ¶æƒï¼Œå…è®¸è°ƒåº¦å™¨åˆ‡æ¢åˆ°å…¶ä»– Goroutineã€‚</li></ul><p><strong>æ˜¾å¼è°ƒåº¦</strong>ï¼š</p><ul><li>Goroutine æ˜¾å¼è¯·æ±‚ <code>runtime.Gosched()</code>è°ƒç”¨ï¼Œè°ƒåº¦å™¨è¿›è¡Œè°ƒåº¦ã€‚</li><li>è¿™ä¸ªæ—¶å€™å›ä»å½“å‰åç¨‹åˆ‡æ¢åˆ° g0 åç¨‹ï¼Œå–æ¶ˆ G ä¸ M ä¹‹é—´çš„ç»‘å®šå…³ç³»ï¼ŒæŠŠ Gæ”¾å…¥å…¨å±€é˜Ÿåˆ—ä¸­ã€‚</li></ul><h3 id="æŠ¢å å¼è°ƒåº¦preemptive-scheduling">6.2 æŠ¢å å¼è°ƒåº¦ï¼ˆPreemptiveSchedulingï¼‰</h3><p><strong>åŸºäºæ—¶é—´çš„æŠ¢å </strong>ï¼š</p><ul><li>ä» Go 1.14 å¼€å§‹ï¼Œè°ƒåº¦å™¨å¼•å…¥äº†åŸºäºæ—¶é—´çš„æŠ¢å æœºåˆ¶ã€‚å¦‚æœä¸€ä¸ª Goroutineè¿è¡Œæ—¶é—´è¶…è¿‡ 10 æ¯«ç§’ï¼Œæˆ–è€…åœ¨ç³»ç»Ÿè°ƒç”¨ä¸­è¶…è¿‡äº† 20å¾®å¦™ï¼Œè°ƒåº¦å™¨ä¼šåœ¨å®‰å…¨ç‚¹ï¼ˆå¦‚å‡½æ•°è°ƒç”¨ã€å¾ªç¯è¿­ä»£ã€é˜»å¡æ“ä½œç­‰ï¼‰å°è¯•æš‚åœè¯¥Goroutineã€‚</li><li>è¿™ç§æŠ¢å ä¸ä¾èµ–äº Goroutineçš„æ˜¾å¼æ”¾å¼ƒæ§åˆ¶ï¼Œè€Œæ˜¯ç”±è°ƒåº¦å™¨ä¸»åŠ¨è§¦å‘ã€‚</li><li>å®‰å…¨ç‚¹çš„é€‰æ‹©æ—¨åœ¨å‡å°‘å¯¹ Goroutineæ‰§è¡Œçš„å¹²æ‰°ï¼ŒåŒæ—¶ç¡®ä¿è°ƒåº¦çš„å…¬å¹³æ€§å’Œå“åº”æ€§ã€‚</li></ul><p><strong>åŸºäºä¿¡å·çš„æŠ¢å ï¼š</strong></p><ul><li>å½“ç¨‹åºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ—¢æ— æ³•ä¸»åŠ¨æŒ‚èµ·ï¼Œä¹Ÿä¸èƒ½è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œä¸”æ— æ³•è¿›è¡Œå‡½æ•°è°ƒç”¨æ—¶ï¼Œå°±å¯ä»¥ä½¿ç”¨ä¿¡å·æ¥è°ƒåº¦ã€‚</li><li>ä¿¡å·å…¶å®å°±æ˜¯çº¿ç¨‹ä¿¡å·ï¼Œåœ¨æ“ä½œç³»ç»Ÿä¸­æœ‰å¾ˆå¤šåŸºäºä¿¡å·çš„åº•å±‚é€šä¿¡æ–¹å¼ï¼ˆSIGPIPE/ SIGURG / SIGHUPï¼‰ï¼Œè€Œæˆ‘ä»¬çš„çº¿ç¨‹å¯ä»¥æ³¨å†Œå¯¹åº”ä¿¡å·çš„å¤„ç†å‡½æ•°ã€‚</li><li>å½“çº¿ç¨‹æ¥æ”¶åˆ°æŠ¢å ä¿¡å·æ—¶ï¼Œä¼šè¿›å…¥ä¸€ä¸ªä¸“é—¨çš„ä¿¡å·å¤„ç†å™¨ã€‚è¿™ä¸ªå¤„ç†å™¨ä¼šæ£€æŸ¥æ˜¯å¦å¤„äºå®‰å…¨ç‚¹ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æš‚åœå½“å‰Goroutine å¹¶è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</li></ul><h1 id="æºç åˆ†æ">æºç åˆ†æ</h1><p>å‰é¢æˆ‘ä»¬å¯¹ Go è¯­è¨€çš„ GPMæ¨¡å‹åœ¨åŸºæœ¬æ¦‚å¿µã€è°ƒåº¦å¾ªç¯ã€è°ƒåº¦ç­–ç•¥å’Œè°ƒåº¦æ—¶æœºå„ä¸ªæ–¹é¢éƒ½è¿›è¡Œäº†è¯¦ç»†çš„é˜è¿°ã€‚å¦‚æœè¯»è€…åªæ˜¯æƒ³ç®€å•äº†è§£ä¸€ä¸‹GPMæ¨¡å‹çš„ä¸€äº›æ¦‚å¿µå’Œè®¾è®¡æ€æƒ³ï¼Œé‚£ä¹ˆé˜…è¯»åˆ°è¿™é‡Œå°±åŸºæœ¬è¶³å¤Ÿäº†ã€‚å¦‚æœå¯¹å…¶æºç å®ç°æœ‰å…´è¶£çš„è¯ï¼Œé‚£ä¹ˆè¯·ç»§ç»­å¾€ä¸‹é˜…è¯»~</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ¥å¯¹ Go è¯­è¨€çš„ GPM æ¨¡å‹è¿›è¡Œæºç åˆ†æï¼š</p><ol type="1"><li>Gã€Pã€M åœ¨ Go è¯­è¨€ä¸­çš„è¡¨ç¤ºã€‚</li><li>G çš„åˆ›å»ºè¿‡ç¨‹ã€‚</li><li>g å’Œ g0 çš„åˆ‡æ¢è¿‡ç¨‹ã€‚</li><li>GPM çš„è°ƒåº¦æœºåˆ¶ã€‚</li></ol><h2 id="g-çš„åº•å±‚ç»“æ„">1. G çš„åº•å±‚ç»“æ„</h2><p>G åœ¨ Go é‡Œé¢å°±æ˜¯ <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/runtime2.go">runtime2.go</a>é‡Œé¢å®šä¹‰çš„ <code>g</code> ç»“æ„ä½“ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> g <span class="hljs-keyword">struct</span> &#123;<br><span class="hljs-comment">// æ ˆå‚æ•°ã€‚</span><br><span class="hljs-comment">// stack æè¿°å®é™…çš„æ ˆå†…å­˜ï¼š[stack.lo, stack.hi)ã€‚</span><br><span class="hljs-comment">// stackguard0 æ˜¯åœ¨ Go æ ˆå¢é•¿åºè¨€ä¸­æ¯”è¾ƒçš„æ ˆæŒ‡é’ˆã€‚</span><br><span class="hljs-comment">// é€šå¸¸æ˜¯ stack.lo+StackGuardï¼Œä½†å¯ä»¥æ˜¯ StackPreempt æ¥è§¦å‘æŠ¢å ã€‚</span><br><span class="hljs-comment">// stackguard1 æ˜¯åœ¨ C æ ˆå¢é•¿åºè¨€ä¸­æ¯”è¾ƒçš„æ ˆæŒ‡é’ˆã€‚</span><br><span class="hljs-comment">// åœ¨ g0 å’Œ gsignal æ ˆä¸Šæ˜¯ stack.lo+StackGuardã€‚</span><br><span class="hljs-comment">// åœ¨å…¶ä»– goroutine æ ˆä¸Šæ˜¯ ~0ï¼Œä»¥è§¦å‘å¯¹ morestackc çš„è°ƒç”¨ï¼ˆå¹¶å´©æºƒï¼‰ã€‚</span><br>stack       stack   <span class="hljs-comment">// è¿è¡Œæ—¶/CGO å·²çŸ¥çš„åç§»</span><br>stackguard0 <span class="hljs-type">uintptr</span> <span class="hljs-comment">// liblink å·²çŸ¥çš„åç§»</span><br>stackguard1 <span class="hljs-type">uintptr</span> <span class="hljs-comment">// liblink å·²çŸ¥çš„åç§»</span><br><br>_panic    *_panic <span class="hljs-comment">// æœ€å†…å±‚çš„ panic - liblink å·²çŸ¥çš„åç§»</span><br>_defer    *_defer <span class="hljs-comment">// æœ€å†…å±‚çš„ defer</span><br>m         *m      <span class="hljs-comment">// å½“å‰ mï¼›arm liblink å·²çŸ¥çš„åç§»</span><br>sched     gobuf   <span class="hljs-comment">// å½“å‰åç¨‹çš„è¿è¡Œç°åœº</span><br>syscallsp <span class="hljs-type">uintptr</span> <span class="hljs-comment">// å¦‚æœ status==Gsyscall, syscallsp = sched.sp åœ¨ gc æœŸé—´ä½¿ç”¨</span><br>syscallpc <span class="hljs-type">uintptr</span> <span class="hljs-comment">// å¦‚æœ status==Gsyscall, syscallpc = sched.pc åœ¨ gc æœŸé—´ä½¿ç”¨</span><br>stktopsp  <span class="hljs-type">uintptr</span> <span class="hljs-comment">// æ ˆé¡¶çš„é¢„æœŸ spï¼Œç”¨äºå›æº¯æ£€æŸ¥</span><br><span class="hljs-comment">// param æ˜¯ä¸€ä¸ªé€šç”¨çš„æŒ‡é’ˆå‚æ•°å­—æ®µï¼Œç”¨äºåœ¨ç‰¹å®šä¸Šä¸‹æ–‡ä¸­ä¼ é€’å€¼ï¼Œ</span><br><span class="hljs-comment">// å…¶ä»–å­˜å‚¨å‚æ•°çš„æ–¹å¼éš¾ä»¥æ‰¾åˆ°ã€‚ç›®å‰æœ‰ä¸‰ç§ç”¨é€”ï¼š</span><br><span class="hljs-comment">// 1. å½“é€šé“æ“ä½œå”¤é†’ä¸€ä¸ªé˜»å¡çš„ goroutine æ—¶ï¼Œå®ƒå°† param è®¾ç½®ä¸º</span><br><span class="hljs-comment">//    æŒ‡å‘å·²å®Œæˆé˜»å¡æ“ä½œçš„ sudogã€‚</span><br><span class="hljs-comment">// 2. ç”± gcAssistAlloc1 ä½¿ç”¨ï¼Œä»¥å‘å…¶è°ƒç”¨è€…ä¿¡å·ï¼Œè¡¨æ˜ goroutine å®Œæˆäº† GC å‘¨æœŸã€‚</span><br><span class="hljs-comment">//    ä»¥ä»»ä½•å…¶ä»–æ–¹å¼è¿™æ ·åšæ˜¯ä¸å®‰å…¨çš„ï¼Œå› ä¸ºæ­¤æ—¶ goroutine çš„æ ˆå¯èƒ½å·²ç»ç§»åŠ¨ã€‚</span><br><span class="hljs-comment">// 3. ç”± debugCallWrap ä½¿ç”¨ï¼Œä»¥å°†å‚æ•°ä¼ é€’ç»™æ–°çš„ goroutineï¼Œå› ä¸ºåœ¨è¿è¡Œæ—¶åˆ†é…é—­åŒ…æ˜¯è¢«ç¦æ­¢çš„ã€‚</span><br>param        unsafe.Pointer<br>atomicstatus atomic.Uint32<br>stackLock    <span class="hljs-type">uint32</span> <span class="hljs-comment">// sigprof/scang é”ï¼›<span class="hljs-doctag">TODO:</span> åˆå¹¶åˆ° atomicstatus</span><br>goid         <span class="hljs-type">uint64</span><br>schedlink    guintptr<br>waitsince    <span class="hljs-type">int64</span>      <span class="hljs-comment">// g å˜ä¸ºé˜»å¡çš„å¤§è‡´æ—¶é—´</span><br>waitreason   waitReason <span class="hljs-comment">// å¦‚æœ status==Gwaiting</span><br><br>preempt       <span class="hljs-type">bool</span> <span class="hljs-comment">// æŠ¢å ä¿¡å·ï¼Œå¤åˆ¶ stackguard0 = stackpreempt</span><br>preemptStop   <span class="hljs-type">bool</span> <span class="hljs-comment">// åœ¨æŠ¢å æ—¶è½¬æ¢ä¸º _Gpreemptedï¼›å¦åˆ™ï¼Œåªæ˜¯å–æ¶ˆè°ƒåº¦</span><br>preemptShrink <span class="hljs-type">bool</span> <span class="hljs-comment">// åœ¨åŒæ­¥å®‰å…¨ç‚¹ç¼©å°æ ˆ</span><br><br><span class="hljs-comment">// asyncSafePoint è®¾ç½®ä¸º true è¡¨ç¤º g åœ¨å¼‚æ­¥å®‰å…¨ç‚¹åœæ­¢ã€‚</span><br><span class="hljs-comment">// è¿™æ„å‘³ç€æ ˆä¸Šæœ‰æ²¡æœ‰ç²¾ç¡®æŒ‡é’ˆä¿¡æ¯çš„å¸§ã€‚</span><br>asyncSafePoint <span class="hljs-type">bool</span><br><br>paniconfault <span class="hljs-type">bool</span> <span class="hljs-comment">// åœ¨æ„å¤–çš„æ•…éšœåœ°å€ä¸Šè§¦å‘ panicï¼ˆè€Œä¸æ˜¯å´©æºƒï¼‰</span><br>gcscandone   <span class="hljs-type">bool</span> <span class="hljs-comment">// g å·²æ‰«ææ ˆï¼›ç”± _Gscan ä½åœ¨çŠ¶æ€ä¸­ä¿æŠ¤</span><br>throwsplit   <span class="hljs-type">bool</span> <span class="hljs-comment">// å¿…é¡»ä¸åˆ†å‰²æ ˆ</span><br><span class="hljs-comment">// activeStackChans è¡¨ç¤ºæœ‰æœªé”å®šçš„é€šé“æŒ‡å‘è¿™ä¸ª goroutine çš„æ ˆã€‚</span><br><span class="hljs-comment">// å¦‚æœä¸º trueï¼Œæ ˆå¤åˆ¶éœ€è¦è·å–é€šé“é”æ¥ä¿æŠ¤è¿™äº›æ ˆåŒºåŸŸã€‚</span><br>activeStackChans <span class="hljs-type">bool</span><br><span class="hljs-comment">// parkingOnChan è¡¨ç¤º goroutine å³å°†åœ¨ chansend æˆ– chanrecv ä¸Šåœè½¦ã€‚</span><br><span class="hljs-comment">// ç”¨äºæ ‡è®°æ ˆç¼©å°çš„ä¸å®‰å…¨ç‚¹ã€‚</span><br>parkingOnChan atomic.Bool<br><br>raceignore    <span class="hljs-type">int8</span>  <span class="hljs-comment">// å¿½ç•¥ç«æ€æ£€æµ‹äº‹ä»¶</span><br>tracking      <span class="hljs-type">bool</span>  <span class="hljs-comment">// æ˜¯å¦è·Ÿè¸ªæ­¤ G ä»¥è·å–è°ƒåº¦å»¶è¿Ÿç»Ÿè®¡</span><br>trackingSeq   <span class="hljs-type">uint8</span> <span class="hljs-comment">// ç”¨äºå†³å®šæ˜¯å¦è·Ÿè¸ªæ­¤ G</span><br>trackingStamp <span class="hljs-type">int64</span> <span class="hljs-comment">// G æœ€åå¼€å§‹è¢«è·Ÿè¸ªçš„æ—¶é—´æˆ³</span><br>runnableTime  <span class="hljs-type">int64</span> <span class="hljs-comment">// å¯è¿è¡Œæ—¶é—´ï¼Œè¿è¡Œæ—¶æ¸…é™¤ï¼Œä»…åœ¨è·Ÿè¸ªæ—¶ä½¿ç”¨</span><br>lockedm       muintptr<br>sig           <span class="hljs-type">uint32</span><br>writebuf      []<span class="hljs-type">byte</span><br>sigcode0      <span class="hljs-type">uintptr</span><br>sigcode1      <span class="hljs-type">uintptr</span><br>sigpc         <span class="hljs-type">uintptr</span><br>parentGoid    <span class="hljs-type">uint64</span>          <span class="hljs-comment">// åˆ›å»ºæ­¤ goroutine çš„ goroutine çš„ goid</span><br>gopc          <span class="hljs-type">uintptr</span>         <span class="hljs-comment">// åˆ›å»ºæ­¤ goroutine çš„ go è¯­å¥çš„ pc</span><br>ancestors     *[]ancestorInfo <span class="hljs-comment">// åˆ›å»ºæ­¤ goroutine çš„ç¥–å…ˆ goroutine çš„ä¿¡æ¯ï¼ˆä»…åœ¨ debug.tracebackancestors ä½¿ç”¨ï¼‰</span><br>startpc       <span class="hljs-type">uintptr</span>         <span class="hljs-comment">// goroutine å‡½æ•°çš„ pc</span><br>racectx       <span class="hljs-type">uintptr</span><br>waiting       *sudog         <span class="hljs-comment">// æ­¤ g æ­£åœ¨ç­‰å¾…çš„ sudog ç»“æ„ï¼ˆå…·æœ‰æœ‰æ•ˆçš„ elem æŒ‡é’ˆï¼‰ï¼›æŒ‰é”é¡ºåº</span><br>cgoCtxt       []<span class="hljs-type">uintptr</span>      <span class="hljs-comment">// cgo å›æº¯ä¸Šä¸‹æ–‡</span><br>labels        unsafe.Pointer <span class="hljs-comment">// åˆ†æå™¨æ ‡ç­¾</span><br>timer         *timer         <span class="hljs-comment">// ç¼“å­˜çš„è®¡æ—¶å™¨ï¼Œç”¨äº time.Sleep</span><br>selectDone    atomic.Uint32  <span class="hljs-comment">// æˆ‘ä»¬æ˜¯å¦å‚ä¸ select å¹¶ä¸”æœ‰äººèµ¢å¾—äº†ç«èµ›ï¼Ÿ</span><br><br><span class="hljs-comment">// goroutineProfiled æŒ‡ç¤ºå½“å‰ goroutine çš„æ ˆçŠ¶æ€</span><br>  <span class="hljs-comment">// æ˜¯å¦å·²ç»è¢«è®°å½•åœ¨è¿›è¡Œä¸­çš„ goroutine æ€§èƒ½åˆ†æä¸­ã€‚</span><br>goroutineProfiled goroutineProfileStateHolder<br><br><span class="hljs-comment">// æ¯ä¸ª G çš„è¿½è¸ªçŠ¶æ€ã€‚</span><br>trace gTraceState<br><br><span class="hljs-comment">// æ¯ä¸ª G çš„ GC çŠ¶æ€</span><br><br><span class="hljs-comment">// gcAssistBytes æ˜¯æ­¤ G çš„ GC ååŠ©ä¿¡ç”¨ï¼Œä»¥åˆ†é…çš„å­—èŠ‚ä¸ºå•ä½ã€‚</span><br><span class="hljs-comment">// å¦‚æœä¸ºæ­£ï¼Œåˆ™ G æœ‰ä¿¡ç”¨åˆ†é… gcAssistBytes å­—èŠ‚è€Œä¸ååŠ©ã€‚</span><br><span class="hljs-comment">// å¦‚æœä¸ºè´Ÿï¼Œåˆ™ G å¿…é¡»é€šè¿‡æ‰§è¡Œæ‰«æå·¥ä½œæ¥çº æ­£è¿™ä¸€ç‚¹ã€‚</span><br><span class="hljs-comment">// æˆ‘ä»¬ä»¥å­—èŠ‚ä¸ºå•ä½è·Ÿè¸ªè¿™ä¸€ç‚¹ï¼Œä»¥ä¾¿åœ¨ malloc çƒ­è·¯å¾„ä¸­å¿«é€Ÿæ›´æ–°å’Œæ£€æŸ¥å€ºåŠ¡ã€‚</span><br><span class="hljs-comment">// ååŠ©æ¯”ç‡å†³å®šäº†è¿™å¦‚ä½•å¯¹åº”äºæ‰«æå·¥ä½œå€ºåŠ¡ã€‚</span><br>gcAssistBytes <span class="hljs-type">int64</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° <code>g</code> ç»“æ„å­—æ®µéå¸¸å¤šï¼Œè¿™ä¸ªç»“æ„ä½“çš„è®¾è®¡åæ˜ äº† Goè¯­è¨€å¯¹å¹¶å‘å’Œåç¨‹ç®¡ç†çš„åº•å±‚æœºåˆ¶ï¼ŒåŒ…æ‹¬æ ˆç®¡ç†ã€è°ƒåº¦ã€åƒåœ¾å›æ”¶ã€å¼‚å¸¸å¤„ç†ç­‰å¤šä¸ªæ–¹é¢ã€‚é€šè¿‡è¿™ç§æŠ½è±¡ï¼ŒGoè¯­è¨€èƒ½å¤Ÿæœ‰æ•ˆåœ°ç®¡ç†æˆåƒä¸Šä¸‡çš„<code>goroutine</code>ï¼Œä½¿å¾—å¹¶å‘ç¼–ç¨‹å˜å¾—æ›´åŠ ç®€å•å’Œé«˜æ•ˆã€‚</p><p>è¿™é‡Œæˆ‘ä»¬åªå…³æ³¨ GPM æ¨¡å‹ç›¸å…³çš„å†…å®¹ï¼Œéœ€è¦é‡ç‚¹å…³å¿ƒä»¥ä¸‹å‡ ä¸ªå­—æ®µï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> g <span class="hljs-keyword">struct</span> &#123;<br>stack     stack   <span class="hljs-comment">// å½“å‰åç¨‹çš„åç¨‹æ ˆ</span><br>m         *m      <span class="hljs-comment">// å½“å‰çº¿ç¨‹</span><br>sched     gobuf  <span class="hljs-comment">// ä¿å­˜åç¨‹çš„è¿è¡Œç°åœº</span><br>atomicstatus atomic.Uint32<span class="hljs-comment">// åç¨‹çŠ¶æ€</span><br>goid         <span class="hljs-type">uint64</span><span class="hljs-comment">// åç¨‹ID</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åç¨‹æ ˆ-stack">1.1 åç¨‹æ ˆ stack</h3><p>å…¶ä¸­ <code>stack</code>ç»“æ„å¦‚ä¸‹ï¼Œå®ƒå­˜å‚¨äº†åç¨‹æ ˆçš„ä½åœ°å€å’Œé«˜åœ°å€ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> stack <span class="hljs-keyword">struct</span> &#123;<br>lo <span class="hljs-type">uintptr</span> <span class="hljs-comment">// æ ˆçš„ä½åœ°å€</span><br>hi <span class="hljs-type">uintptr</span> <span class="hljs-comment">// æ ˆçš„é«˜åœ°å€</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="çº¿ç¨‹æŠ½è±¡-m">1.2 çº¿ç¨‹æŠ½è±¡ m</h3><p>è€Œ <code>m</code> å°±æ˜¯ Goè¯­è¨€å¯¹æ“ä½œç³»ç»Ÿçº¿ç¨‹çš„æŠ½è±¡ï¼Œè¿™ä¸æ˜¯å®é™…çš„çº¿ç¨‹ï¼Œè¿™åªæ˜¯ Goè¯­è¨€å¯¹çº¿ç¨‹ç›¸å…³ä¿¡æ¯çš„æŠ½è±¡ï¼Œä»¥æ–¹ä¾¿æ›´å¥½åœ°è°ƒåº¦åç¨‹ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> m <span class="hljs-keyword">struct</span> &#123;<br>g0      *g     <span class="hljs-comment">// g0 åç¨‹ï¼ŒGo ä¸­çš„ä¸»åç¨‹</span><br>curg    *g       <span class="hljs-comment">// ç°åœ¨æ­£åœ¨è¿è¡Œçš„åç¨‹</span><br>id      <span class="hljs-type">int64</span> <span class="hljs-comment">// çº¿ç¨‹ID</span><br>mOS<span class="hljs-comment">// å½“å‰æ“ä½œç³»ç»Ÿå¯¹çº¿ç¨‹çš„é¢å¤–æè¿°ä¿¡æ¯</span><br>...<br>&#125;<br></code></pre></td></tr></table></figure><p><code>m</code>ç»“æ„ä½“åŒ…å«äº†è®¸å¤šå­—æ®µï¼Œè¿™äº›å­—æ®µæ¶‰åŠåˆ°çº¿ç¨‹ç®¡ç†ã€è°ƒåº¦ã€ä¿¡å·å¤„ç†ã€ç³»ç»Ÿè°ƒç”¨ã€é”ç®¡ç†ç­‰å¤šä¸ªæ–¹é¢ã€‚è¿™ä¸ªç»“æ„ä½“æ˜¯Go å¹¶å‘æ¨¡å‹çš„æ ¸å¿ƒéƒ¨åˆ†ä¹‹ä¸€ï¼Œå®ƒä¸ <code>g</code>ï¼ˆgoroutineï¼‰å’Œ<code>p</code>ï¼ˆprocessorï¼‰ç»“æ„ä½“ä¸€èµ·ï¼Œæ„æˆäº† Goçš„è°ƒåº¦ç³»ç»Ÿçš„åŸºç¡€ã€‚é€šè¿‡è¿™ç§è®¾è®¡ï¼ŒGoèƒ½å¤Ÿæœ‰æ•ˆåœ°åœ¨å¤šä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ä¹‹é—´è°ƒåº¦æˆåƒä¸Šä¸‡çš„goroutineï¼Œå®ç°é«˜æ•ˆçš„å¹¶å‘æ‰§è¡Œã€‚</p><h3 id="åç¨‹ä¸Šä¸‹æ–‡-gobuf">1.3 åç¨‹ä¸Šä¸‹æ–‡ gobuf</h3><p><code>gobuf</code> ç»“æ„ä½“åœ¨ Go è¯­è¨€çš„è¿è¡Œæ—¶ç³»ç»Ÿä¸­ç”¨äºä¿å­˜<code>Goroutine</code>çš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œç‰¹åˆ«æ˜¯åœ¨è°ƒåº¦å’Œç³»ç»Ÿè°ƒç”¨ä¸­ã€‚è¿™ä¸ªç»“æ„ä½“ä¿å­˜äº†è¶³å¤Ÿçš„ä¿¡æ¯ä»¥ä¾¿åœ¨<code>Goroutine</code> è¢«æš‚åœåèƒ½å¤Ÿæ¢å¤æ‰§è¡Œã€‚</p><p>ä¸‹é¢æ˜¯å¯¹ <code>gobuf</code> ç»“æ„ä½“ä¸­å„ä¸ªå­—æ®µçš„è§£é‡Šï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> gobuf <span class="hljs-keyword">struct</span> &#123;<br><span class="hljs-comment">// sp, pc å’Œ g çš„åç§»é‡æ˜¯å·²çŸ¥çš„ï¼ˆåœ¨ libmach ä¸­ç¡¬ç¼–ç ï¼‰ã€‚</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// ctxt åœ¨ GC æ–¹é¢æ¯”è¾ƒç‰¹æ®Šï¼šå®ƒå¯èƒ½æ˜¯ä¸€ä¸ªå †åˆ†é…çš„ funcvalï¼Œ</span><br><span class="hljs-comment">// å› æ­¤ GC éœ€è¦è·Ÿè¸ªå®ƒï¼Œä½†å®ƒéœ€è¦åœ¨æ±‡ç¼–ä¸­è®¾ç½®å’Œæ¸…é™¤ï¼Œ</span><br><span class="hljs-comment">// åœ¨é‚£é‡Œå®ç°å†™å±éšœæ¯”è¾ƒå›°éš¾ã€‚ç„¶è€Œï¼Œctxt å®é™…ä¸Šæ˜¯ä¸€ä¸ªä¿å­˜çš„ã€æ´»è·ƒçš„å¯„å­˜å™¨ï¼Œ</span><br><span class="hljs-comment">// æˆ‘ä»¬åªåœ¨çœŸå®å¯„å­˜å™¨å’Œ gobuf ä¹‹é—´äº¤æ¢å®ƒã€‚å› æ­¤ï¼Œæˆ‘ä»¬åœ¨æ ˆæ‰«ææœŸé—´å°†å…¶è§†ä¸ºæ ¹ï¼Œ</span><br><span class="hljs-comment">// è¿™æ„å‘³ç€ä¿å­˜å’Œæ¢å¤å®ƒçš„æ±‡ç¼–ä¸éœ€è¦å†™å±éšœã€‚å®ƒä»ç„¶è¢«ç±»å‹åŒ–ä¸ºæŒ‡é’ˆï¼Œ</span><br><span class="hljs-comment">// ä»¥ä¾¿ä»»ä½•å…¶ä»–ä» Go è¿›è¡Œçš„å†™æ“ä½œéƒ½ä¼šè·å¾—å†™å±éšœã€‚</span><br>sp   <span class="hljs-type">uintptr</span>        <span class="hljs-comment">// æ ˆæŒ‡é’ˆ</span><br>pc   <span class="hljs-type">uintptr</span>        <span class="hljs-comment">// ç¨‹åºè®¡æ•°å™¨</span><br>g    guintptr       <span class="hljs-comment">// æŒ‡å‘å½“å‰ goroutine çš„æŒ‡é’ˆ</span><br>ctxt unsafe.Pointer <span class="hljs-comment">// ä¸Šä¸‹æ–‡ï¼Œç”¨äºä¿å­˜é¢å¤–çš„çŠ¶æ€æˆ–ä¿¡æ¯</span><br>ret  <span class="hljs-type">uintptr</span>        <span class="hljs-comment">// ç”¨äºä¿å­˜å‡½æ•°è¿”å›å€¼</span><br>lr   <span class="hljs-type">uintptr</span>        <span class="hljs-comment">// é“¾æ¥å¯„å­˜å™¨ï¼ˆåœ¨æŸäº›æ¶æ„ä¸­ç”¨äºå‡½æ•°è°ƒç”¨ï¼‰</span><br>bp   <span class="hljs-type">uintptr</span>        <span class="hljs-comment">// åŸºæŒ‡é’ˆï¼ˆåœ¨å¯ç”¨å¸§æŒ‡é’ˆçš„æ¶æ„ä¸­ä½¿ç”¨ï¼‰</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬é‡ç‚¹éœ€è¦å…³æ³¨ 2 ä¸ªå­—æ®µï¼š</p><ul><li><code>sp</code>ï¼šæ ˆæŒ‡é’ˆï¼Œè¡¨ç¤ºå½“å‰åç¨‹è¿è¡Œåˆ°æ ˆä¸­çš„å“ªä¸ªä½ç½®äº†ã€‚</li><li><code>pc</code>ï¼šç¨‹åºè®¡æ•°å™¨ï¼Œè¡¨ç¤ºå½“å‰åç¨‹è¿è¡Œåˆ°å“ªä¸€è¡Œä»£ç äº†ã€‚</li></ul><h3 id="åç¨‹çŠ¶æ€-atomicstatus">1.4 åç¨‹çŠ¶æ€ atomicstatus</h3><p>æˆ‘è®°å¾—åœ¨ Go1.16 ç‰ˆæœ¬ä¸­ï¼Œè¿™ä¸ªå­—æ®µçš„ç±»å‹è¿˜æ˜¯ <code>uint32</code>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">atomicstatus <span class="hljs-type">uint32</span><br></code></pre></td></tr></table></figure><p>ç°åœ¨ Go1.21 ç‰ˆæœ¬ä¸­ï¼Œå·²ç»ç”¨äº†åŸå­æ“ä½œæ¥å‡å°‘å¹¶å‘å†²çªäº†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">atomicstatus atomic.Uint32<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° Go çš„åº•å±‚ä¹Ÿæ˜¯éšç€ç‰ˆæœ¬æ›´æ–°ä¸æ–­ä¼˜åŒ–ä¸­çš„ã€‚</p><p><ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/runtime2.go">runtime2.go</a>å®šä¹‰äº† G çš„å„ç§çŠ¶æ€ï¼Œå¦‚ï¼š</p><ul><li><code>_Gidle (0)</code>: è¡¨ç¤º G åˆšåˆšè¢«åˆ†é…ï¼Œå°šæœªåˆå§‹åŒ–ã€‚</li><li><code>_Grunnable (1)</code>: è¡¨ç¤º Gåœ¨è¿è¡Œé˜Ÿåˆ—ä¸Šã€‚å®ƒå½“å‰æ²¡æœ‰æ‰§è¡Œç”¨æˆ·ä»£ç ã€‚æ ˆä¸è¢«è¯¥ <code>goroutine</code>æ‹¥æœ‰ã€‚</li><li>...</li></ul><p>åé¢æˆ‘ä»¬ä¼šç»™å‡º G çŠ¶æ€çš„æµè½¬å›¾ã€‚</p><h3 id="ä¸¾ä¸ªä¾‹å­">1.5 ä¸¾ä¸ªä¾‹å­</h3><p>å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰ä»¥ä¸‹ Go ä»£ç ï¼šmain() è°ƒç”¨ do1()ï¼Œdo1() è°ƒç”¨do2()ï¼Œdo2() è°ƒç”¨ do3()ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">do3</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;here is do3&quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">do2</span><span class="hljs-params">()</span></span> &#123;<br>do3()<span class="hljs-comment">//&lt;---------------</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">do1</span><span class="hljs-params">()</span></span> &#123;<br>do2()<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>do1()<br>&#125;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆå½“è¿™æ®µç¨‹åºè¿è¡Œåˆ°ç¬¬ 6 è¡Œçš„æ—¶å€™ï¼Œå®ƒçš„åº•å±‚ç»“æ„å¤§æ¦‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/e6c9d24egy1h569pjiiosj21cu0u040p.jpg"alt="Goroutine åº•å±‚ç»“æ„ç¤ºä¾‹" /><figcaption aria-hidden="true">Goroutine åº•å±‚ç»“æ„ç¤ºä¾‹</figcaption></figure><p>è‡³äºä¸ºä»€ä¹ˆè¿™é‡Œæœ‰ä¸ª <code>goexit()</code>ï¼Œå…¶å®å°±æ˜¯ä¸ºäº†å¯ä»¥è·³å›åˆ°<code>g0</code> åç¨‹ï¼Œåé¢æˆ‘ä»¬ä¼šå…·ä½“åˆ†æåˆ°ã€‚</p><h2 id="p-çš„åº•å±‚ç»“æ„">2. P çš„åº•å±‚ç»“æ„</h2><p>P çš„æœ¬è´¨æ˜¯ <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/runtime2.go">runtime2.go</a>é‡Œé¢å®šä¹‰çš„ <code>p</code> ç»“æ„ä½“ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> p <span class="hljs-keyword">struct</span> &#123;<br>    id          <span class="hljs-type">int32</span>          <span class="hljs-comment">// P çš„å”¯ä¸€æ ‡è¯†ç¬¦</span><br>    status      <span class="hljs-type">uint32</span>         <span class="hljs-comment">// P çš„çŠ¶æ€ï¼Œå¦‚ pidle/prunning/...</span><br>    link        puintptr       <span class="hljs-comment">// P é“¾æ¥</span><br>    schedtick   <span class="hljs-type">uint32</span>         <span class="hljs-comment">// æ¯æ¬¡è°ƒåº¦å™¨è°ƒç”¨æ—¶é€’å¢</span><br>    syscalltick <span class="hljs-type">uint32</span>         <span class="hljs-comment">// æ¯æ¬¡ç³»ç»Ÿè°ƒç”¨æ—¶é€’å¢</span><br>    sysmontick  sysmontick     <span class="hljs-comment">// sysmon è§‚å¯Ÿåˆ°çš„æœ€åä¸€ä¸ª tick</span><br>    m           muintptr       <span class="hljs-comment">// å…³è”çš„ M çš„åå‘é“¾æ¥ï¼ˆå¦‚æœç©ºé—²åˆ™ä¸º nilï¼‰</span><br>    mcache      *mcache        <span class="hljs-comment">// M ç¼“å­˜</span><br>    pcache      pageCache      <span class="hljs-comment">// é¡µé¢ç¼“å­˜</span><br>    raceprocctx <span class="hljs-type">uintptr</span>        <span class="hljs-comment">// ç”¨äºç«æ€æ£€æµ‹çš„ä¸Šä¸‹æ–‡</span><br><br>    <span class="hljs-comment">// å»¶è¿Ÿç»“æ„ä½“æ± </span><br>    deferpool    []*_defer<br>    deferpoolbuf [<span class="hljs-number">32</span>]*_defer<br><br>    <span class="hljs-comment">// Goroutine ID ç¼“å­˜ï¼Œå‡å°‘å¯¹ runtimeÂ·sched.goidgen çš„è®¿é—®</span><br>    goidcache    <span class="hljs-type">uint64</span><br>    goidcacheend <span class="hljs-type">uint64</span><br><br>    <span class="hljs-comment">// å¯è¿è¡Œ goroutine é˜Ÿåˆ—ï¼Œæ— é”è®¿é—®</span><br>    runqhead <span class="hljs-type">uint32</span><br>    runqtail <span class="hljs-type">uint32</span><br>    runq     [<span class="hljs-number">256</span>]guintptr<br>    runnext  guintptr <span class="hljs-comment">// ä¸‹ä¸€ä¸ªè¦è¿è¡Œçš„ G</span><br><br>    <span class="hljs-comment">// ç©ºé—² G çš„åˆ—è¡¨ï¼ˆçŠ¶æ€ == Gdeadï¼‰</span><br>    gFree <span class="hljs-keyword">struct</span> &#123;<br>        gList<br>        n <span class="hljs-type">int32</span><br>    &#125;<br><br>    <span class="hljs-comment">// sudog ç¼“å­˜</span><br>    sudogcache []*sudog<br>    sudogbuf   [<span class="hljs-number">128</span>]*sudog<br><br>    <span class="hljs-comment">// å †ä¸Š mspan å¯¹è±¡çš„ç¼“å­˜</span><br>    mspancache <span class="hljs-keyword">struct</span> &#123;<br>        <span class="hljs-built_in">len</span> <span class="hljs-type">int</span><br>        buf [<span class="hljs-number">128</span>]*mspan<br>    &#125;<br><br>    <span class="hljs-comment">// pinner å¯¹è±¡çš„ç¼“å­˜</span><br>    pinnerCache *pinner<br><br>  <span class="hljs-comment">// P çŠ¶æ€è·Ÿè¸ª</span><br>    trace pTraceState<br><br>    <span class="hljs-comment">// æ¯ä¸ª P çš„æŒä¹…åˆ†é…ï¼Œé¿å…äº’æ–¥</span><br>    palloc persistentAlloc <br><br>    <span class="hljs-comment">// å®šæ—¶å™¨ç›¸å…³å­—æ®µ</span><br>    timer0When             atomic.Int64<br>    timerModifiedEarliest  atomic.Int64<br>    timersLock             mutex<br>    timers                 []*timer<br>    numTimers              atomic.Uint32<br>    deletedTimers          atomic.Uint32<br>    timerRaceCtx           <span class="hljs-type">uintptr</span><br><br>    <span class="hljs-comment">// GC ç›¸å…³å­—æ®µ</span><br>    gcAssistTime         <span class="hljs-type">int64</span><br>    gcFractionalMarkTime <span class="hljs-type">int64</span><br>    gcw                  gcWork<br>    wbBuf                wbBuf<br><br>    <span class="hljs-comment">// æŒ‡ç¤ºæ˜¯å¦åœ¨ä¸‹ä¸€ä¸ªå®‰å…¨ç‚¹è¿è¡Œç‰¹å®šçš„å‡½æ•°</span><br>    runSafePointFn <span class="hljs-type">uint32</span><br>  <br>    <span class="hljs-comment">// æŒ‡ç¤ºå½“å‰ P æ˜¯å¦æ­£åœ¨å†™å…¥ä»»ä½•ç»Ÿè®¡æ•°æ®ã€‚</span><br>  <span class="hljs-comment">// å¶æ•°æ—¶è¡¨ç¤ºæ²¡æœ‰å†™å…¥ï¼Œå¥‡æ•°æ—¶è¡¨ç¤ºæ­£åœ¨å†™å…¥ã€‚</span><br>    statsSeq       atomic.Uint32<br>  <br>    <span class="hljs-comment">// æŒ‡ç¤ºå½“å‰çš„ P åº”è¯¥å°½å¿«è¿›å…¥è°ƒåº¦å™¨ï¼Œæ— è®ºå…¶ä¸Šè¿è¡Œçš„æ˜¯å“ªä¸ª Gã€‚</span><br><span class="hljs-comment">// è¿™æ˜¯å®ç°æŠ¢å å¼è°ƒåº¦çš„ä¸€éƒ¨åˆ†ï¼Œå…è®¸è°ƒåº¦å™¨åœ¨å¿…è¦æ—¶ä¸­æ–­é•¿æ—¶é—´è¿è¡Œçš„ goroutineï¼Œ</span><br>    <span class="hljs-comment">// ä»¥ä¾¿å…¶ä»– goroutine æœ‰æœºä¼šè¿è¡Œã€‚</span><br>    preempt        <span class="hljs-type">bool</span><br>  <br>    <span class="hljs-comment">// è®°å½•é¡µé¢åˆ†é…ã€é‡Šæ”¾å’Œæ¸…ç†è·Ÿè¸ªä¿¡æ¯çš„ç¼“å†²åŒºã€‚</span><br>    pageTraceBuf   pageTraceBuf<br>&#125;<br></code></pre></td></tr></table></figure><p><code>p</code> ç»“æ„ä½“åœ¨ Goè¯­è¨€çš„è¿è¡Œæ—¶ç³»ç»Ÿä¸­ä»£è¡¨äº†ä¸€ä¸ªå¤„ç†å™¨ï¼ˆprocessorï¼‰ï¼Œå®ƒæ˜¯è°ƒåº¦å™¨çš„æ ¸å¿ƒç»„æˆéƒ¨åˆ†ã€‚æ¯ä¸ª<code>p</code> è´Ÿè´£ç®¡ç†ä¸€ç»„ <code>goroutine</code>çš„è¿è¡Œã€‚è¿™ä¸ªç»“æ„ä½“åŒ…å«äº†è®¸å¤šå­—æ®µï¼Œæ¶‰åŠåˆ° <code>goroutine</code>çš„è°ƒåº¦ã€å†…å­˜åˆ†é…ã€åƒåœ¾å›æ”¶å’Œå…¶ä»–ç³»ç»Ÿçº§åˆ«çš„æ“ä½œã€‚</p><p>æˆ‘ä»¬é‡ç‚¹å…³æ³¨ä»¥ä¸‹å‡ ä¸ªå­—æ®µï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> p <span class="hljs-keyword">struct</span> &#123;<br>m           muintptr   <span class="hljs-comment">// å½“å‰è´Ÿè´£çš„çº¿ç¨‹</span><br>  <br><span class="hljs-comment">// æœ¬åœ°å¯è¿è¡Œçš„åç¨‹çš„é˜Ÿåˆ—ï¼Œå¯æ— é”è®¿é—®</span><br>runqhead <span class="hljs-type">uint32</span> <span class="hljs-comment">// é˜Ÿå¤´</span><br>runqtail <span class="hljs-type">uint32</span> <span class="hljs-comment">// é˜Ÿå°¾</span><br>runq     [<span class="hljs-number">256</span>]guintptr   <span class="hljs-comment">// é•¿åº¦ä¸º 256</span><br>runnext guintptr <span class="hljs-comment">// ä¸‹ä¸€ä¸ªå¯ç”¨çš„åç¨‹çš„æŒ‡é’ˆ</span><br>  <br>  <span class="hljs-comment">// æŠ¢å æ ‡è¯†ï¼ŒæŒ‡ç¤ºå½“å‰çš„ P åº”è¯¥å°½å¿«è¿›å…¥è°ƒåº¦å™¨ï¼Œæ— è®ºå…¶ä¸Šè¿è¡Œçš„æ˜¯å“ªä¸ª Gã€‚</span><br>  preempt <span class="hljs-type">bool</span><br>&#125;<br></code></pre></td></tr></table></figure><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/e6c9d24egy1h57sl36b40j20o40u8js7.jpg"alt="P åº•å±‚ç»“æ„" /><figcaption aria-hidden="true">P åº•å±‚ç»“æ„</figcaption></figure><h2 id="goroutine-çš„åˆ›å»º">3. Goroutine çš„åˆ›å»º</h2><p>Go å¹¶å‘èƒ½åŠ›çš„ä¼˜ç§€ä¹‹å¤„ï¼Œå°±åœ¨äºå®ƒå¯åŠ¨ä¸€ä¸ªæ–°çš„åç¨‹å®åœ¨æ˜¯å¤ªæ–¹ä¾¿äº†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; ... &#125;()<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆåº•å±‚ç©¶ç«Ÿåšäº†ä»€ä¹ˆå‘¢ï¼Ÿ</p><h3 id="newproc">3.1 newproc()</h3><p>Goroutine é€šè¿‡ <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/proc.go">proc.go</a>ä¸­çš„ <code>newproc()</code> åˆ›å»ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newproc</span><span class="hljs-params">(fn *funcval)</span></span> &#123;<br>    gp := getg()<br>    pc := getcallerpc()<br>    systemstack(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        newg := newproc1(fn, gp, pc)<br><br>        pp := getg().m.p.ptr()<br>        runqput(pp, newg, <span class="hljs-literal">true</span>)<br><br>        <span class="hljs-keyword">if</span> mainStarted &#123;<br>            wakep()<br>        &#125;<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure><ol type="1"><li><strong>è·å–å½“å‰ goroutine å’Œè°ƒç”¨è€… PC</strong>: <code>getg()</code>è·å–å½“å‰æ­£åœ¨æ‰§è¡Œçš„ <code>goroutine</code>ï¼Œ<code>getcallerpc()</code>è·å–è°ƒç”¨è€…çš„ç¨‹åºè®¡æ•°å™¨åœ°å€ã€‚</li><li><strong>åœ¨ç³»ç»Ÿæ ˆä¸Šæ‰§è¡Œ <code>newproc1</code></strong>:<code>systemstack</code> ç¡®ä¿ <code>newproc1</code>åœ¨ç³»ç»Ÿæ ˆä¸Šæ‰§è¡Œï¼Œè€Œä¸æ˜¯å½“å‰ <code>goroutine</code> çš„æ ˆã€‚è¿™æ˜¯å› ä¸ºæ–°çš„<code>goroutine</code> å¯èƒ½éœ€è¦æ›´å¤šçš„æ ˆç©ºé—´ã€‚</li><li><strong>åˆ›å»ºæ–°çš„ goroutine</strong>: <code>newproc1</code>è¢«è°ƒç”¨æ¥å®é™…åˆ›å»ºæ–°çš„ <code>goroutine</code>ã€‚</li><li><strong>å°†æ–°çš„ goroutine æ”¾å…¥è¿è¡Œé˜Ÿåˆ—</strong>: <code>runqput</code>å°†æ–°åˆ›å»ºçš„ <code>goroutine</code> æ”¾å…¥è¿è¡Œé˜Ÿåˆ—ã€‚</li><li><strong>å”¤é†’å¤„ç†å™¨</strong>:å¦‚æœä¸»å‡½æ•°å·²ç»å¼€å§‹æ‰§è¡Œï¼Œ<code>wakep</code> ç”¨äºå”¤é†’ä¸€ä¸ªç©ºé—²çš„ Pæ¥è¿è¡Œæ–°çš„ <code>goroutine</code>ã€‚</li></ol><h3 id="newproc1">3.2 newproc1()</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newproc1</span><span class="hljs-params">(fn *funcval, callergp *g, callerpc <span class="hljs-type">uintptr</span>)</span></span> *g &#123;<br>    <span class="hljs-comment">// ... (çœç•¥äº†é”™è¯¯æ£€æŸ¥å’Œè·å– M çš„ä»£ç )</span><br><br>  <span class="hljs-comment">// å°è¯•ä» P çš„ç©ºé—²åˆ—è¡¨è·å–ä¸€ä¸ª Gï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„</span><br>    newg := gfget(pp)<br>    <span class="hljs-keyword">if</span> newg == <span class="hljs-literal">nil</span> &#123;<br>        newg = malg(stackMin)<br>        casgstatus(newg, _Gidle, _Gdead)<br>        allgadd(newg)<br>    &#125;<br><br>    <span class="hljs-comment">// è®¾ç½®æ–° G çš„æ ˆ</span><br>    totalSize := <span class="hljs-type">uintptr</span>(<span class="hljs-number">4</span>*goarch.PtrSize + sys.MinFrameSize)<br>    totalSize = alignUp(totalSize, sys.StackAlign)<br>    sp := newg.stack.hi - totalSize<br>  spArg := sp<br>  <br>    <span class="hljs-comment">// æ¸…ç©ºå¹¶è®¾ç½®æ–° G çš„è°ƒåº¦å™¨ç›¸å…³å­—æ®µ</span><br>    memclrNoHeapPointers(unsafe.Pointer(&amp;newg.sched), unsafe.Sizeof(newg.sched))<br>    newg.sched.sp = sp<br>    newg.stktopsp = sp<br>    newg.sched.pc = abi.FuncPCABI0(goexit) + sys.PCQuantum<br>    newg.sched.g = guintptr(unsafe.Pointer(newg))<br>  <br>    <span class="hljs-comment">// è®¾ç½®æ–° G çš„å…¶ä»–å­—æ®µ</span><br>    gostartcallfn(&amp;newg.sched, fn)<br>    newg.parentGoid = callergp.goid<br>    newg.gopc = callerpc<br>    newg.startpc = fn.fn<br>    <br>  <span class="hljs-comment">// ... (çœç•¥äº†è·Ÿè¸ªå’Œè°ƒè¯•ç›¸å…³çš„ä»£ç )</span><br><br>    casgstatus(newg, _Gdead, _Grunnable)<br><br>    <span class="hljs-keyword">return</span> newg<br>&#125;<br></code></pre></td></tr></table></figure><ol type="1"><li><strong>åˆ›å»ºæˆ–è·å–ä¸€ä¸ªæ–°çš„ goroutine</strong>: <code>gfget</code>å°è¯•ä» P çš„ç©ºé—²åˆ—è¡¨ä¸­è·å–ä¸€ä¸ª<code>goroutine</code>ï¼Œå¦‚æœæ²¡æœ‰å¯ç”¨çš„ï¼Œåˆ™é€šè¿‡ <code>malg</code>åˆ†é…ä¸€ä¸ªæ–°çš„ã€‚</li><li><strong>åˆå§‹åŒ– goroutine çš„æ ˆå’Œè°ƒåº¦å™¨</strong>: è®¾ç½®æ–°<code>goroutine</code>çš„æ ˆã€ç¨‹åºè®¡æ•°å™¨ã€è°ƒç”¨å‡½æ•°ç­‰ã€‚è¿™é‡Œæœ‰ä¸ªéå¸¸æ ¸å¿ƒçš„ç‚¹<code>newg.sched.pc = abi.FuncPCABI0(goexit) + sys.PCQuantum</code>ï¼Œæˆ‘ä»¬å‰é¢ç•™äº†ä¸ªç–‘é—®ï¼Œåç¨‹æ ˆé¡¶çš„<code>goexit</code> æ˜¯å“ªé‡Œæ¥çš„ï¼Œå°±æ˜¯è¿™é‡Œæ¥çš„ã€‚è¿™é‡Œè®¾ç½®æ–°<code>goroutine</code> çš„ç¨‹åºè®¡æ•°å™¨ï¼ˆ<code>pc</code>ï¼‰æŒ‡å‘<code>goexit</code> å‡½æ•°ã€‚<code>goexit</code> æ˜¯æ¯ä¸ª<code>goroutine</code> åœ¨é€€å‡ºæ—¶å¿…é¡»è°ƒç”¨çš„å‡½æ•°ï¼Œç”¨äºæ‰§è¡Œæ¸…ç†å·¥ä½œå¹¶åˆ‡æ¢åˆ°g0 æ ˆã€‚</li><li><strong>è®¾ç½®çˆ¶ goroutine ID å’Œåˆ›å»ºç‚¹</strong>: è®°å½•åˆ›å»ºè¿™ä¸ªæ–°<code>goroutine</code> çš„çˆ¶ <code>goroutine</code> çš„ ID å’Œ<code>go</code> è¯­å¥çš„ä½ç½®ã€‚</li><li><strong>æ›´æ”¹ goroutine çŠ¶æ€</strong>: å°†æ–° <code>goroutine</code>çš„çŠ¶æ€ä» <code>_Gdead</code> æ”¹ä¸º<code>_Grunnable</code>ï¼Œä½¿å…¶å‡†å¤‡å¥½è¢«è°ƒåº¦ã€‚</li><li><strong>è¿”å›æ–°çš„ goroutine</strong>: å‡½æ•°è¿”å›æ–°åˆ›å»ºçš„<code>goroutine</code>ã€‚</li></ol><h3 id="runqput">3.3 runqput()</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// runqput tries to put g on the local runnable queue.</span><br><span class="hljs-comment">// If next is false, runqput adds g to the tail of the runnable queue.</span><br><span class="hljs-comment">// If next is true, runqput puts g in the pp.runnext slot.</span><br><span class="hljs-comment">// If the run queue is full, runnext puts g on the global queue.</span><br><span class="hljs-comment">// Executed only by the owner P.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">runqput</span><span class="hljs-params">(pp *p, gp *g, next <span class="hljs-type">bool</span>)</span></span> &#123;<br><span class="hljs-keyword">if</span> randomizeScheduler &amp;&amp; next &amp;&amp; fastrandn(<span class="hljs-number">2</span>) == <span class="hljs-number">0</span> &#123;<br>next = <span class="hljs-literal">false</span><br>&#125;<br><br><span class="hljs-keyword">if</span> next &#123;<br>retryNext:<br>oldnext := pp.runnext<br><span class="hljs-keyword">if</span> !pp.runnext.cas(oldnext, guintptr(unsafe.Pointer(gp))) &#123;<br><span class="hljs-keyword">goto</span> retryNext<br>&#125;<br><span class="hljs-keyword">if</span> oldnext == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br>gp = oldnext.ptr()<br>&#125;<br><br>retry:<br>h := atomic.LoadAcq(&amp;pp.runqhead) <br>t := pp.runqtail<br><span class="hljs-keyword">if</span> t-h &lt; <span class="hljs-type">uint32</span>(<span class="hljs-built_in">len</span>(pp.runq)) &#123;<br>pp.runq[t%<span class="hljs-type">uint32</span>(<span class="hljs-built_in">len</span>(pp.runq))].set(gp)<br>atomic.StoreRel(&amp;pp.runqtail, t+<span class="hljs-number">1</span>) <br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">if</span> runqputslow(pp, gp, h, t) &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">goto</span> retry<br>&#125;<br></code></pre></td></tr></table></figure><ol type="1"><li><strong>éšæœºè°ƒåº¦å™¨</strong>ï¼šå¦‚æœå¯ç”¨äº†è°ƒåº¦å™¨çš„éšæœºåŒ–ï¼ˆ<code>randomizeScheduler</code>ï¼‰ï¼Œå¹¶ä¸”<code>next</code> ä¸º <code>true</code>ï¼ˆnewproc è°ƒç”¨çš„æ—¶å€™æ°¸è¿œéƒ½æ˜¯ä¼ çš„trueï¼‰ï¼Œåˆ™æœ‰ä¸€åŠçš„æ¦‚ç‡å°† <code>next</code> è®¾ç½®ä¸º<code>false</code>ã€‚è¿™æœ‰åŠ©äºé˜²æ­¢è°ƒåº¦å™¨çš„è¡Œä¸ºè¿‡äºå¯é¢„æµ‹ã€‚</li><li><strong>å¤„ç† <code>runnext</code> æ§½</strong>ï¼šå¦‚æœ<code>next</code> ä¸º <code>true</code>ï¼Œå‡½æ•°å°è¯•å°† <code>gp</code> æ”¾å…¥<code>pp.runnext</code> æ§½ã€‚å¦‚æœè¯¥æ§½å·²è¢«å ç”¨ï¼Œåˆ™å°†åŸæœ‰çš„<code>goroutine</code> ç§»åŠ¨åˆ°å¸¸è§„è¿è¡Œé˜Ÿåˆ—ï¼Œå¹¶é‡è¯•å°†æ–°çš„ <code>gp</code>æ”¾å…¥ <code>runnext</code>ã€‚</li><li><strong>æ”¾å…¥æœ¬åœ°è¿è¡Œé˜Ÿåˆ—</strong>ï¼šå¦‚æœ <code>next</code> ä¸º<code>false</code> æˆ– <code>runnext</code> æ§½å·²æ»¡ï¼Œå‡½æ•°å°è¯•å°†<code>gp</code> æ”¾å…¥æœ¬åœ°è¿è¡Œé˜Ÿåˆ—çš„å°¾éƒ¨ã€‚å¦‚æœé˜Ÿåˆ—æœªæ»¡ï¼Œ<code>gp</code>å°†è¢«æˆåŠŸæ·»åŠ ã€‚</li><li><strong>å¤„ç†é˜Ÿåˆ—æ»¡çš„æƒ…å†µ</strong>ï¼šå¦‚æœæœ¬åœ°è¿è¡Œé˜Ÿåˆ—å·²æ»¡ï¼Œ<code>runqputslow</code>è¢«è°ƒç”¨ï¼Œå°è¯•å°† <code>gp</code> è¿åŒè‡ªå·±é˜Ÿåˆ—ä¸­ä¸€åŠçš„ gæ”¾å…¥å…¨å±€è¿è¡Œé˜Ÿåˆ—ã€‚å¦‚æœè¿™ä¹Ÿå¤±è´¥äº†ï¼Œå‡½æ•°ä¼šé‡è¯•å°† <code>gp</code>æ”¾å…¥æœ¬åœ°é˜Ÿåˆ—ã€‚</li><li><strong>åŸå­æ“ä½œ</strong>ï¼šå‡½æ•°ä½¿ç”¨åŸå­æ“ä½œæ¥åŠ è½½å’Œå­˜å‚¨é˜Ÿåˆ—å¤´ï¼ˆ<code>runqhead</code>ï¼‰å’Œå°¾ï¼ˆ<code>runqtail</code>ï¼‰æŒ‡é’ˆï¼Œä»¥ç¡®ä¿å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„æ•°æ®ä¸€è‡´æ€§å’Œçº¿ç¨‹å®‰å…¨ã€‚</li></ol><h3 id="runqputslow">3.4 runqputslow()</h3><p><code>runqputslow</code> å‡½æ•°å¤„ç†æœ¬åœ°è¿è¡Œé˜Ÿåˆ—æ»¡çš„æƒ…å†µï¼Œå°†<code>goroutine</code>æ‰¹é‡è½¬ç§»åˆ°å…¨å±€é˜Ÿåˆ—ã€‚è¿™ä¸ªå‡½æ•°é€šè¿‡åŸå­æ“ä½œå’Œé”æ¥ç¡®ä¿æ“ä½œçš„åŸå­æ€§å’Œçº¿ç¨‹å®‰å…¨ã€‚éšæœºåŒ–è°ƒåº¦å™¨çš„ä½¿ç”¨å¢åŠ äº†è°ƒåº¦çš„éšæœºæ€§å’Œå…¬å¹³æ€§ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Put g and a batch of work from local runnable queue on global queue.</span><br><span class="hljs-comment">// Executed only by the owner P.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">runqputslow</span><span class="hljs-params">(pp *p, gp *g, h, t <span class="hljs-type">uint32</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br><br>  <span class="hljs-comment">// ä» pp çš„æœ¬åœ°é˜Ÿåˆ—ä¸­è·å–ä¸€åŠçš„ goroutine</span><br>  <span class="hljs-keyword">var</span> batch [<span class="hljs-built_in">len</span>(pp.runq)/<span class="hljs-number">2</span> + <span class="hljs-number">1</span>]*g<br>n := t - h<br>n = n / <span class="hljs-number">2</span><br><span class="hljs-keyword">if</span> n != <span class="hljs-type">uint32</span>(<span class="hljs-built_in">len</span>(pp.runq)/<span class="hljs-number">2</span>) &#123;<br>throw(<span class="hljs-string">&quot;runqputslow: queue is not full&quot;</span>)<br>&#125;<br><span class="hljs-keyword">for</span> i := <span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>); i &lt; n; i++ &#123;<br>batch[i] = pp.runq[(h+i)%<span class="hljs-type">uint32</span>(<span class="hljs-built_in">len</span>(pp.runq))].ptr()<br>&#125;<br><span class="hljs-keyword">if</span> !atomic.CasRel(&amp;pp.runqhead, h, h+n) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br>batch[n] = gp<br><br>  <span class="hljs-comment">// éšæœºæ‰“ä¹± goroutine çš„é¡ºåºï¼Œä»¥å¢åŠ è°ƒåº¦çš„éšæœºæ€§</span><br><span class="hljs-keyword">if</span> randomizeScheduler &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-type">uint32</span>(<span class="hljs-number">1</span>); i &lt;= n; i++ &#123;<br>j := fastrandn(i + <span class="hljs-number">1</span>)<br>batch[i], batch[j] = batch[j], batch[i]<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// ä¸²æˆé˜Ÿåˆ—</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>); i &lt; n; i++ &#123;<br>batch[i].schedlink.set(batch[i+<span class="hljs-number">1</span>])<br>&#125;<br><span class="hljs-keyword">var</span> q gQueue<br>q.head.set(batch[<span class="hljs-number">0</span>])<br>q.tail.set(batch[n])<br><br><span class="hljs-comment">// æ”¾å…¥å…¨å±€é˜Ÿåˆ—ä¸­</span><br>lock(&amp;sched.lock)<br>globrunqputbatch(&amp;q, <span class="hljs-type">int32</span>(n+<span class="hljs-number">1</span>))<br>unlock(&amp;sched.lock)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure><ol type="1"><li><strong>åˆ›å»ºæ‰¹å¤„ç†æ•°ç»„</strong>ï¼šå‡½æ•°é¦–å…ˆåˆ›å»ºä¸€ä¸ª <code>batch</code>æ•°ç»„ï¼Œç”¨äºå­˜å‚¨ä»æœ¬åœ°é˜Ÿåˆ—ä¸­å–å‡ºçš„ <code>goroutine</code>ã€‚</li><li><strong>ä»æœ¬åœ°é˜Ÿåˆ—ä¸­è·å–ä¸€æ‰¹<code>goroutine</code></strong>ï¼šå‡½æ•°è®¡ç®—å‡ºè¦ä»æœ¬åœ°é˜Ÿåˆ—ä¸­å–å‡ºå¤šå°‘ä¸ª<code>goroutine</code>ï¼ˆé€šå¸¸æ˜¯é˜Ÿåˆ—é•¿åº¦çš„ä¸€åŠï¼‰ï¼Œå¹¶å°†å®ƒä»¬æ·»åŠ åˆ°<code>batch</code> æ•°ç»„ä¸­ã€‚</li><li><strong>åŸå­æ“ä½œæ›´æ–°é˜Ÿåˆ—å¤´éƒ¨</strong>ï¼šä½¿ç”¨åŸå­æ“ä½œ<code>atomic.CasRel</code>æ›´æ–°æœ¬åœ°è¿è¡Œé˜Ÿåˆ—çš„å¤´éƒ¨ç´¢å¼•ï¼Œè¿™æ˜¯ä¸€ä¸ªé‡Šæ”¾ï¼ˆreleaseï¼‰æ“ä½œï¼Œç¡®ä¿ä¹‹å‰çš„è¯»å–æ“ä½œå®Œæˆã€‚</li><li><strong>å°†å½“å‰ <code>goroutine</code>æ·»åŠ åˆ°æ‰¹å¤„ç†ä¸­</strong>ï¼šå°†ä¼ å…¥çš„ <code>gp</code> æ·»åŠ åˆ°<code>batch</code> æ•°ç»„çš„æœ«å°¾ã€‚</li><li><strong>éšæœºåŒ–è°ƒåº¦å™¨</strong>ï¼šå¦‚æœå¯ç”¨äº†éšæœºè°ƒåº¦å™¨ï¼Œå‡½æ•°ä¼šéšæœºæ‰“ä¹±<code>batch</code> æ•°ç»„ä¸­çš„ <code>goroutine</code>é¡ºåºï¼Œä»¥å¢åŠ è°ƒåº¦çš„éšæœºæ€§ã€‚</li><li><strong>é“¾æ¥ <code>goroutine</code></strong>ï¼šå°† <code>batch</code>æ•°ç»„ä¸­çš„ <code>goroutine</code> é“¾æ¥èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªé˜Ÿåˆ—ã€‚</li><li><strong>å‡†å¤‡å…¨å±€é˜Ÿåˆ—</strong>ï¼šåˆ›å»ºä¸€ä¸ª <code>gQueue</code>ç»“æ„ï¼Œå¹¶è®¾ç½®å…¶å¤´éƒ¨å’Œå°¾éƒ¨æŒ‡å‘ <code>batch</code> æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ª<code>goroutine</code>ã€‚</li><li><strong>å°†æ‰¹å¤„ç†æ”¾å…¥å…¨å±€é˜Ÿåˆ—</strong>ï¼šåŠ é”è®¿é—®å…¨å±€è°ƒåº¦å™¨çš„é”ï¼Œç„¶åå°†æ•´ä¸ª<code>batch</code> é˜Ÿåˆ—æ”¾å…¥å…¨å±€è¿è¡Œé˜Ÿåˆ—ã€‚</li></ol><h2 id="è°ƒåº¦è¿‡ç¨‹-schedule">4. è°ƒåº¦è¿‡ç¨‹ schedule()</h2><p>Go çš„è°ƒåº¦å™¨æ ¸å¿ƒæ‰§è¡Œé€»è¾‘éƒ½åœ¨ <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/proc.go">proc.go</a>çš„ <code>schedule()</code>å‡½æ•°ä¸­ã€‚æˆ‘ä»¬å…ˆä¸æ¢è®¨è¿‡å¤šçš„ç»†èŠ‚ï¼Œæˆ‘ä»¬å…ˆæŠŠæ•´ä¸ªå¤§ä½“è„‰ç»œç†æ¸…æ¥šå†è¯´ã€‚</p><p>ç®€åŒ–åçš„ <code>schedule()</code> å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">schedule</span><span class="hljs-params">()</span></span> &#123;<br>  <span class="hljs-comment">// è·å–å½“å‰æ­£åœ¨æ‰§è¡Œçš„ M</span><br>mp := getg().m<br>  ...<br>  <span class="hljs-comment">// æŸ¥æ‰¾ä¸€ä¸ªå¯è¿è¡Œçš„ Gï¼Œä¼šé˜»å¡ä½ç›´åˆ°è¿”å›ã€‚</span><br>gp, inheritTime, tryWakeP := findRunnable() <br>  ...<br><span class="hljs-comment">// æ‰§è¡Œ g</span><br>execute(gp, inheritTime)<br>&#125;<br></code></pre></td></tr></table></figure><p><code>execute()</code> æ‰§è¡Œ gï¼Œå®ƒç®€åŒ–åå¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">execute</span><span class="hljs-params">(gp *g, inheritTime <span class="hljs-type">bool</span>)</span></span> &#123;<br>mp := getg().m<br>..<br>gogo(&amp;gp.sched)<br>&#125;<br></code></pre></td></tr></table></figure><p>å®ƒè°ƒç”¨äº† <code>gogo()</code>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">gogo</span><span class="hljs-params">(buf *gobuf)</span></span><br></code></pre></td></tr></table></figure><p>ä¸€èˆ¬è¿™ç§æ ¼å¼è¯´æ˜å‡½æ•°æ˜¯ç”¨æ±‡ç¼–å®ç°çš„ï¼Œæˆ‘ä»¬åœ¨ Goland ä¸Šå¯ä»¥åŒå‡» shiftç„¶åæœç´¢ <code>runtimeÂ·gogo</code>ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240128130637007.png"alt="runtimeÂ·gogo" /><figcaption aria-hidden="true">runtimeÂ·gogo</figcaption></figure><p>ä¸åŒçš„å¹³å°æœ‰ä¸åŒçš„å®ç°ï¼Œä½†æ˜¯æ ¸å¿ƒé€»è¾‘éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå®ƒç›´æ¥æ“ä½œå¤„ç†å™¨çš„å¯„å­˜å™¨å’Œæ ˆï¼Œä»¥å®ç°ä»ä¸€ä¸ª <code>goroutine</code>åˆ‡æ¢åˆ°å¦ä¸€ä¸ª <code>goroutine</code> çš„åŠŸèƒ½ã€‚</p><p>æˆ‘ä»¬åé¢çš„å‘å†…å¿ƒä¼šå‘ç° <code>goexit()</code> æœ€ç»ˆä¼šè°ƒç”¨<code>schedule()</code>ã€‚</p><p>è¿™å°±ä¸²èµ·æ¥äº†ï¼ŒGo ç¨‹åºå¯åŠ¨åä¼šåˆ›å»º m0 å’Œg0ï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ª<code>schedule()</code> æ˜¯ g0 è°ƒç”¨çš„ï¼Œæœ€åé€šè¿‡<code>gogo</code> åˆ‡æ¢åˆ°ç”¨æˆ·åç¨‹ g ä¸Šé¢æ‰§è¡Œä¸šåŠ¡æ–¹æ³•ï¼Œå®Œäº‹å g é€šè¿‡<code>goexit</code> å›åˆ° <code>schedule()</code>ï¼Œä»¥æ­¤å¾ªç¯åå¤ä¸‹å»ã€‚</p><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥æ¥æ€»ç»“ä¸€ä¸‹ GPM è°ƒåº¦å¾ªç¯çš„è¿‡ç¨‹ï¼Œå¤§æ¦‚å¦‚ä¸‹å›¾è¡¨ç¤ºï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/e6c9d24egy1h57qxoptk4j21hm0simyy.jpg"alt="GPM è°ƒåº¦å¾ªç¯å›¾" /><figcaption aria-hidden="true">GPM è°ƒåº¦å¾ªç¯å›¾</figcaption></figure><p>ä¸‹é¢æˆ‘ä»¬å†å¯¹è¿™ä¸ªè¿‡ç¨‹ä¸­çš„å…³é”®å‡½æ•°è¿›è¡Œç»†è‡´åˆ†æï¼š</p><ul><li><code>schedule()</code>ï¼šè°ƒåº¦å…¥å£ã€‚</li><li><code>findRunnable()</code>ï¼šå¯»æ‰¾å¯æ‰§è¡Œçš„ Gã€‚</li><li><code>execute()</code>ï¼šæ‰§è¡Œ Gã€‚</li><li><code>gogo()</code>ï¼šåˆ‡æ¢åç¨‹æ ˆ g0 åˆ° gã€‚</li><li><code>goexit()</code>ï¼šé€€å‡º g åç¨‹ï¼Œåˆ‡æ¢å› g0 æ ˆã€‚</li></ul><h3 id="schedule">4.1 schedule()</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">schedule</span><span class="hljs-params">()</span></span> &#123;<br>  <span class="hljs-comment">// è·å–å½“å‰æ­£åœ¨æ‰§è¡Œçš„ M</span><br>mp := getg().m<br><br>  <span class="hljs-comment">// æœ‰é”çš„è¯æŠ›å‡ºå¼‚å¸¸ï¼Œé¿å…è¯¥æƒ…å†µä¸‹è°ƒåº¦å‡ºç°æ­»é”æˆ–å…¶ä»–é—®é¢˜</span><br><span class="hljs-keyword">if</span> mp.locks != <span class="hljs-number">0</span> &#123;<br>throw(<span class="hljs-string">&quot;schedule: holding locks&quot;</span>)<br>&#125;<br><br>  <span class="hljs-comment">// M è¢«é”å®šäº†ç‰¹å®šçš„ Gï¼Œè¿™ä¸ªæ—¶å€™ç›´æ¥æ‰§è¡Œè¿™ä¸ªé”å®šçš„ Gã€‚</span><br><span class="hljs-keyword">if</span> mp.lockedg != <span class="hljs-number">0</span> &#123;<br>stoplockedm()<br>execute(mp.lockedg.ptr(), <span class="hljs-literal">false</span>) <span class="hljs-comment">// Never returns.</span><br>&#125;<br><br><span class="hljs-comment">// CGO è°ƒç”¨éœ€è¦ g0 æ ˆï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™ä¸ç»§ç»­è°ƒåº¦äº†ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚</span><br><span class="hljs-keyword">if</span> mp.incgo &#123;<br>throw(<span class="hljs-string">&quot;schedule: in cgo&quot;</span>)<br>&#125;<br><br>top:<br>pp := mp.p.ptr()<br>pp.preempt = <span class="hljs-literal">false</span><br><br><span class="hljs-comment">// å®‰å…¨ç‚¹æ£€æŸ¥ï¼šå¦‚æœå½“å‰ M åœ¨è‡ªæ—‹çš„è¯ï¼Œåº”è¯¥æ˜¯æ²¡æœ‰å¯æ‰§è¡Œ G çš„ã€‚</span><br><span class="hljs-keyword">if</span> mp.spinning &amp;&amp; (pp.runnext != <span class="hljs-number">0</span> || pp.runqhead != pp.runqtail) &#123;<br>throw(<span class="hljs-string">&quot;schedule: spinning with local work&quot;</span>)<br>&#125;<br><br>  <span class="hljs-comment">// æŸ¥æ‰¾ä¸€ä¸ªå¯è¿è¡Œçš„ Gï¼Œä¼šé˜»å¡ä½ç›´åˆ°è¿”å›ã€‚</span><br>gp, inheritTime, tryWakeP := findRunnable() <br><br>  <span class="hljs-comment">// è°ƒè¯•çš„æ—¶å€™ç³»ç»Ÿä¼šå¤„äºâ€œå†»ç»“â€çŠ¶æ€ï¼Œ</span><br>  <span class="hljs-comment">// è¿™é‡Œæ•…æ„é€šè¿‡ä¸¤æ¬¡ lock å¼•å…¥æ­»é”ä½¿å½“å‰ M é™·å…¥æ— é™ç­‰å¾…ï¼Œ</span><br>  <span class="hljs-comment">// ä»¥åœ¨è°ƒè¯•æ—¶ä¿æŒå½“å‰çš„è°ƒåº¦å™¨å’Œè¿è¡Œæ—¶çŠ¶æ€ä¸å˜ã€‚</span><br><span class="hljs-keyword">if</span> debug.dontfreezetheworld &gt; <span class="hljs-number">0</span> &amp;&amp; freezing.Load() &#123;<br>lock(&amp;deadlock)<br>lock(&amp;deadlock)<br>&#125;<br><br>  <span class="hljs-comment">// å¦‚æœå½“å‰ M ä¹‹å‰æ˜¯è‡ªæ—‹çš„ï¼Œä½†æ˜¯ç°åœ¨è¦å‡†å¤‡æ‰§è¡Œ G äº†ï¼Œé‚£å°±ä¸æ˜¯è‡ªæ—‹äº†ã€‚</span><br><span class="hljs-keyword">if</span> mp.spinning &#123;<br>resetspinning()<br>&#125;<br><br>  <span class="hljs-comment">// å½“ç”¨æˆ·çº§è°ƒåº¦è¢«ç¦ç”¨æ—¶ï¼Œé‡‡ç”¨åŒé‡æ£€æŸ¥åå¦‚æœç¡®å®è¢«ç¦ç”¨äº†ï¼Œ</span><br>  <span class="hljs-comment">// é‚£ä¹ˆå°±æŠŠå½“å‰ g æ”¾åœ¨ sched.disable.runnable åˆ—è¡¨ä¸­ï¼Œ</span><br>  <span class="hljs-comment">// ç­‰å¾…è°ƒåº¦é‡å¯å¯ç”¨æ—¶å†å¤„ç†ã€‚</span><br>  <span class="hljs-comment">// åœ¨ gc çš„æ—¶å€™ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼š</span><br>  <span class="hljs-comment">// gcStart()    -&gt;  schedEnableUser(false)</span><br>  <span class="hljs-comment">// gcMarkDone() -&gt;  schedEnableUser(true)</span><br><span class="hljs-keyword">if</span> sched.disable.user &amp;&amp; !schedEnabled(gp) &#123;<br>lock(&amp;sched.lock)<br><span class="hljs-keyword">if</span> schedEnabled(gp) &#123;<br>unlock(&amp;sched.lock)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>sched.disable.runnable.pushBack(gp)<br>sched.disable.n++<br>unlock(&amp;sched.lock)<br><span class="hljs-keyword">goto</span> top<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦éœ€è¦å”¤é†’ä¸€ä¸ª Pã€‚</span><br>  <span class="hljs-comment">// å¦‚æœè¿”å›çš„ g æ¯”è¾ƒç‰¹æ®Šï¼Œæ¯”å¦‚è¦è´Ÿè´£ gcï¼Œé‚£ä¹ˆè¿™ä¸ªå€¼ä¼šæ˜¯ trueã€‚</span><br><span class="hljs-keyword">if</span> tryWakeP &#123;<br>wakep()<br>&#125;<br>  <br>  <span class="hljs-comment">// å¦‚æœ g å·²ç»ç»‘å®šäº† Mï¼Œåˆ™ç›´æ¥å¯åŠ¨è¯¥ M å»æ‰§è¡Œ gã€‚</span><br><span class="hljs-keyword">if</span> gp.lockedm != <span class="hljs-number">0</span> &#123;<br>startlockedm(gp)<br><span class="hljs-keyword">goto</span> top<br>&#125;<br><br>  <span class="hljs-comment">// æ‰§è¡Œ g</span><br>execute(gp, inheritTime)<br>&#125;<br></code></pre></td></tr></table></figure><p><code>schedule()</code> å‡½æ•°æ˜¯ Go è°ƒåº¦å™¨çš„æ ¸å¿ƒï¼Œè´Ÿè´£ç®¡ç†<code>goroutine</code> çš„æ‰§è¡Œã€‚å®ƒåŒ…æ‹¬å¤šä¸ªæ­¥éª¤ï¼Œå¦‚æ£€æŸ¥å½“å‰ Mçš„çŠ¶æ€ï¼Œå¤„ç†ç‰¹æ®Šæƒ…å†µï¼ˆå¦‚ <code>goroutine</code> è¢«é”å®šåˆ°ç‰¹å®šçš„ Mï¼Œæˆ–è€… Mæ­£åœ¨æ‰§è¡Œ CGO è°ƒç”¨ï¼‰ï¼Œä»¥åŠé€‰æ‹©å’Œæ‰§è¡Œå¯è¿è¡Œçš„ <code>goroutine</code>ã€‚</p><h3 id="findrunnable">4.2 findRunnable()</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Finds a runnable goroutine to execute.</span><br><span class="hljs-comment">// Tries to steal from other P&#x27;s, get g from local or global queue, poll network.</span><br><span class="hljs-comment">// tryWakeP indicates that the returned goroutine is not normal (GC worker, trace reader) so the caller should try to wake a P.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">findRunnable</span><span class="hljs-params">()</span></span> (gp *g, inheritTime, tryWakeP <span class="hljs-type">bool</span>) &#123;<br></code></pre></td></tr></table></figure><p>é€šè¿‡æ³¨é‡Šå°±å¯ä»¥çŸ¥é“è¿™ä¸ªå‡½æ•°çš„ä½œç”¨ï¼šå¯»æ‰¾ä¸€ä¸ªå¯æ‰§è¡Œçš„ goroutineï¼š</p><ol type="1"><li>å°è¯•ä»å…¶ä»– P çªƒå– gã€ä»æœ¬åœ°è·å– gã€ä»å…¨å±€é˜Ÿåˆ—è·å–gã€ä»ç½‘ç»œè½®è¯¢å™¨è·å– gï¼›</li><li>å¦‚æœæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ gï¼Œå¦‚è¦è´Ÿè´£ gc æˆ– traceï¼Œé‚£ä¹ˆä¼šå°†<code>tryWakeP</code> ç½®ä¸º<code>true</code>ï¼Œè¡¨ç¤ºè°ƒåº¦å™¨éœ€è¦å°è¯•å”¤é†’æˆ–å¯åŠ¨ä¸€ä¸ªæ–°çš„ P æ¥è¿è¡Œè¿™ä¸ªgï¼Œä»¥ç¡®ä¿äº†å³ä½¿åœ¨ç³»ç»Ÿè´Ÿè½½è¾ƒä½æ—¶ï¼Œè¿™äº›ç‰¹æ®Šçš„g ä¹Ÿèƒ½å¾—åˆ°åŠæ—¶å¤„ç†ã€‚</li></ol><p>æˆ‘ä»¬åªå…³å¿ƒå®ƒçš„æ ¸å¿ƒéƒ¨åˆ†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">findRunnable</span><span class="hljs-params">()</span></span> (gp *g, inheritTime, tryWakeP <span class="hljs-type">bool</span>) &#123;<br>  <span class="hljs-comment">// è·å–å½“å‰ M</span><br>mp := getg().m<br>top:<br>  <br>  <span class="hljs-comment">// è·å– M ç»‘å®šçš„ P</span><br>pp := mp.p.ptr()<br><br><span class="hljs-comment">// 1. æ¯ 61 æ¬¡å¾ªç¯è°ƒåº¦ï¼Œå°±ä¼šå»å…¨å±€é˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ª g æ¥æ‰§è¡Œ</span><br><span class="hljs-keyword">if</span> pp.schedtick%<span class="hljs-number">61</span> == <span class="hljs-number">0</span> &amp;&amp; sched.runqsize &gt; <span class="hljs-number">0</span> &#123;<br>lock(&amp;sched.lock)<br>gp := globrunqget(pp, <span class="hljs-number">1</span>)<br>unlock(&amp;sched.lock)<br><span class="hljs-keyword">if</span> gp != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> gp, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span><br>&#125;<br>&#125;<br><br><br><span class="hljs-comment">// 2. ä»æœ¬åœ°é˜Ÿåˆ—ä¸­è·å– g</span><br><span class="hljs-keyword">if</span> gp, inheritTime := runqget(pp); gp != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> gp, inheritTime, <span class="hljs-literal">false</span><br>&#125;<br><br><span class="hljs-comment">// 3. ä»å…¨å±€é˜Ÿåˆ—ä¸­è·å– g</span><br><span class="hljs-keyword">if</span> sched.runqsize != <span class="hljs-number">0</span> &#123;<br>lock(&amp;sched.lock)<br>gp := globrunqget(pp, <span class="hljs-number">0</span>)<br>unlock(&amp;sched.lock)<br><span class="hljs-keyword">if</span> gp != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> gp, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span><br>&#125;<br>&#125;<br><br><span class="hljs-comment">// 4. ä»ç½‘ç»œè½®è¯¢å™¨ä¸­è·å– g</span><br><span class="hljs-keyword">if</span> netpollinited() &amp;&amp; netpollWaiters.Load() &gt; <span class="hljs-number">0</span> &amp;&amp; sched.lastpoll.Load() != <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">if</span> list := netpoll(<span class="hljs-number">0</span>); !list.empty() &#123; <span class="hljs-comment">// non-blocking</span><br>gp := list.pop()<br>injectglist(&amp;list)<br>casgstatus(gp, _Gwaiting, _Grunnable)<br><span class="hljs-keyword">if</span> traceEnabled() &#123;<br>traceGoUnpark(gp, <span class="hljs-number">0</span>)<br>&#125;<br><span class="hljs-keyword">return</span> gp, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span><br>&#125;<br>&#125;<br><br><span class="hljs-comment">// 5. è‡ªæ—‹ï¼Œä»å…¶ä»– P çªƒå– g</span><br>  <span class="hljs-comment">// mp.spinning è¿™ä¸ªæ¡ä»¶æ£€æŸ¥å½“å‰ Mï¼ˆæ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼‰æ˜¯å¦åº”è¯¥è¿›å…¥è‡ªæ—‹çŠ¶æ€ã€‚</span><br>  <span class="hljs-comment">// è‡ªæ—‹çŠ¶æ€æ„å‘³ç€ M ä¼šç§¯æåœ°å¯»æ‰¾å·¥ä½œï¼Œè€Œä¸æ˜¯ä¼‘çœ ã€‚</span><br>  <span class="hljs-comment">// 2*sched.nmspinning.Load() &lt; gomaxprocs-sched.npidle.Load()</span><br>  <span class="hljs-comment">// è¿™ä¸ªæ¡ä»¶ç¡®ä¿ç³»ç»Ÿä¸­è‡ªæ—‹çš„ M çš„æ•°é‡ä¸ä¼šè¶…è¿‡ä¸€å®šæ¯”ä¾‹ã€‚</span><br>  <span class="hljs-comment">// è¿™æ˜¯ä¸ºäº†é˜²æ­¢åœ¨ä½å¹¶å‘æƒ…å†µä¸‹è¿‡å¤šçš„ CPU ä½¿ç”¨ã€‚</span><br><span class="hljs-keyword">if</span> mp.spinning || <span class="hljs-number">2</span>*sched.nmspinning.Load() &lt; gomaxprocs-sched.npidle.Load() &#123;<br><span class="hljs-keyword">if</span> !mp.spinning &#123;<br>mp.becomeSpinning()<br>&#125;<br> <br>gp, inheritTime, tnow, w, newWork := stealWork(now)<br><span class="hljs-keyword">if</span> gp != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> gp, inheritTime, <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-keyword">if</span> newWork &#123;<br><span class="hljs-keyword">goto</span> top<br>&#125;<br><br>now = tnow<br><span class="hljs-keyword">if</span> w != <span class="hljs-number">0</span> &amp;&amp; (pollUntil == <span class="hljs-number">0</span> || w &lt; pollUntil) &#123;<br>pollUntil = w<br>&#125;<br>&#125;<br>  ...<br><span class="hljs-keyword">goto</span> top<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è¿™ä¸ªè¿‡ç¨‹æ¶‰åŠåˆ°å‡ ä¸ªé‡è¦çš„å‡½æ•°ï¼š</p><ul><li><code>globrunqget()</code>ï¼šä»å…¨å±€é˜Ÿåˆ—ä¸­å¯»æ‰¾å¯è¿è¡Œçš„ Gã€‚</li><li><code>runqget()</code>ï¼šä»æœ¬åœ°é˜Ÿåˆ—ä¸­å¯»æ‰¾å¯è¿è¡Œçš„ Gã€‚</li><li><code>netpoll()</code>ï¼šå¯»æ‰¾å¯ä»¥è¿è¡Œçš„ç½‘ç»œåç¨‹ã€‚</li><li><code>stealWork()</code>ï¼šä»å…¶ä»– P çªƒå–å¯è¿è¡Œçš„ Gã€‚</li></ul><h3 id="globrunqget">4.3 globrunqget()</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">globrunqget</span><span class="hljs-params">(pp *p, max <span class="hljs-type">int32</span>)</span></span> *g &#123;<br>  <span class="hljs-comment">// æŠ¢å…¨å±€åˆ—è¡¨çš„é”</span><br>    assertLockHeld(&amp;sched.lock)<br><br>  <span class="hljs-comment">// å¦‚æœä¸ºç©ºåˆ™ç›´æ¥è¿”å›</span><br>    <span class="hljs-keyword">if</span> sched.runqsize == <span class="hljs-number">0</span> &#123;<br>       <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    &#125;<br><br>  <span class="hljs-comment">// ç¡®å®š n çš„å¤§å°ï¼Œå³è¦ä»å…¨å±€é˜Ÿåˆ—ä¸­è·å–çš„ g çš„ä¸ªæ•°ã€‚</span><br>  <span class="hljs-comment">// è¿™é‡Œä¼šç»“åˆå…¥å‚ max å¯¹è¾¹ç•Œå€¼è¿›è¡Œåˆ¤æ–­ï¼Œä»¥è·å¾—ä¸€ä¸ªåˆç†çš„ nã€‚</span><br>  <span class="hljs-comment">// ä¸€æ¬¡æ€§æœ€å¤šæ‹¿ len(pp.runq)/2 ä¸ª gã€‚</span><br>    n := sched.runqsize/gomaxprocs + <span class="hljs-number">1</span><br>    <span class="hljs-keyword">if</span> n &gt; sched.runqsize &#123;<br>       n = sched.runqsize<br>    &#125;<br>    <span class="hljs-keyword">if</span> max &gt; <span class="hljs-number">0</span> &amp;&amp; n &gt; max &#123;<br>       n = max<br>    &#125;<br>    <span class="hljs-keyword">if</span> n &gt; <span class="hljs-type">int32</span>(<span class="hljs-built_in">len</span>(pp.runq))/<span class="hljs-number">2</span> &#123;<br>       n = <span class="hljs-type">int32</span>(<span class="hljs-built_in">len</span>(pp.runq)) / <span class="hljs-number">2</span><br>    &#125;<br><br>    sched.runqsize -= n<br><br>  <span class="hljs-comment">// é€šè¿‡ pop() ä»å…¨å±€é˜Ÿåˆ—ä¸­å¼¹å‡º g</span><br>    gp := sched.runq.pop()<br>    n--<br>    <span class="hljs-keyword">for</span> ; n &gt; <span class="hljs-number">0</span>; n-- &#123;<br>       gp1 := sched.runq.pop()<br>       <span class="hljs-comment">// å°† g æ”¾å…¥ pp çš„æœ¬åœ°é˜Ÿåˆ—ä¸­</span><br>       <span class="hljs-comment">// runqput åœ¨å‰é¢åˆ›å»ºåç¨‹çš„åœ°æ–¹å·²ç»ä»‹ç»è¿‡äº†ï¼Œè¿™é‡Œä¸èµ˜è¿°ã€‚</span><br>       runqput(pp, gp1, <span class="hljs-literal">false</span>)<br>    &#125;<br>    <span class="hljs-keyword">return</span> gp<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="runqget">4.4 runqget()</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">runqget</span><span class="hljs-params">(pp *p)</span></span> (gp *g, inheritTime <span class="hljs-type">bool</span>) &#123;<br><span class="hljs-comment">// runnext çš„ g ä¼šä¼˜å…ˆæ‰§è¡Œ</span><br>next := pp.runnext<br><span class="hljs-keyword">if</span> next != <span class="hljs-number">0</span> &amp;&amp; pp.runnext.cas(next, <span class="hljs-number">0</span>) &#123;<br><span class="hljs-keyword">return</span> next.ptr(), <span class="hljs-literal">true</span><br>&#125;<br><br><span class="hljs-keyword">for</span> &#123;<br>    <span class="hljs-comment">// åŸå­æ“ä½œè·å–é˜Ÿå¤´æŒ‡é’ˆ</span><br>h := atomic.LoadAcq(&amp;pp.runqhead) <br>t := pp.runqtail<br><span class="hljs-keyword">if</span> t == h &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">false</span><br>&#125;<br>    <span class="hljs-comment">// ä»é˜Ÿå¤´è·å– gï¼Œå¹¶é€šè¿‡åŸå­æ“ä½œæ›´æ–°é˜Ÿå¤´ï¼ˆå³æŠ¢è¿™ä¸ª gï¼‰</span><br>gp := pp.runq[h%<span class="hljs-type">uint32</span>(<span class="hljs-built_in">len</span>(pp.runq))].ptr()<br><span class="hljs-keyword">if</span> atomic.CasRel(&amp;pp.runqhead, h, h+<span class="hljs-number">1</span>) &#123; <br><span class="hljs-keyword">return</span> gp, <span class="hljs-literal">false</span><br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>runqget()</code> å‡½æ•°ç”¨äºä»æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ªå¯è¿è¡Œçš„<code>goroutine</code>ã€‚è¿™ä¸ªå‡½æ•°åªèƒ½ç”±æ‹¥æœ‰è¯¥é˜Ÿåˆ—çš„å¤„ç†å™¨ï¼ˆPï¼‰æ‰§è¡Œã€‚ä¸‹é¢æ˜¯å¯¹è¿™ä¸ªå‡½æ•°çš„è¯¦ç»†è§£é‡Šï¼š</p><p><strong>1. æ£€æŸ¥ <code>runnext</code></strong>ï¼š</p><ul><li><code>runnext</code> æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å­—æ®µï¼Œç”¨äºå­˜å‚¨ä¸‹ä¸€ä¸ªè¦è¿è¡Œçš„<code>goroutine</code>ã€‚å¦‚æœ <code>runnext</code>éé›¶ï¼Œå¹¶ä¸”èƒ½æˆåŠŸé€šè¿‡åŸå­æ“ä½œï¼ˆCASï¼‰å°†å…¶è®¾ç½®ä¸ºé›¶ï¼Œåˆ™ç›´æ¥è¿”å›è¿™ä¸ª<code>goroutine</code>ã€‚</li><li>å¦‚æœæˆåŠŸè·å– <code>runnext</code> æŒ‡å‘çš„<code>goroutine</code>ï¼Œ<code>inheritTime</code> è¢«è®¾ç½®ä¸º<code>true</code>ï¼Œè¡¨ç¤ºè¿™ä¸ª <code>goroutine</code>åº”è¯¥ç»§æ‰¿å½“å‰æ—¶é—´ç‰‡çš„å‰©ä½™æ—¶é—´ã€‚</li><li>å¦‚æœæ²¡æˆåŠŸï¼Œæ„å‘³ç€ runnext çš„è¿™ä¸ª g å·²ç»è¢«å…¶ä»– Pç»™æŠ¢äº†ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥å‘ç°æœ¬ P åªå¯èƒ½å°†å…¶è®¾ç½®ä¸º 0ï¼Œåªæœ‰å…¶ä»– Pæ‰ä¼šå°†å…¶è®¾ç½®ä»¥ä¸ºé 0ã€‚</li></ul><p><strong>2. ä»æœ¬åœ°é˜Ÿåˆ—ä¸­è·å– <code>goroutine</code></strong>ï¼š</p><ul><li>ä½¿ç”¨åŸå­æ“ä½œåŠ è½½<code>runqhead</code>ï¼ˆé˜Ÿåˆ—å¤´æŒ‡é’ˆï¼‰ï¼Œ<code>runqtail</code>ï¼ˆé˜Ÿåˆ—å°¾æŒ‡é’ˆï¼‰ã€‚</li><li>å¦‚æœ <code>runqhead</code> ç­‰äº<code>runqtail</code>ï¼Œè¡¨ç¤ºé˜Ÿåˆ—ä¸ºç©ºï¼Œè¿”å› <code>nil</code>ã€‚</li><li>å¦åˆ™ï¼Œä»é˜Ÿåˆ—ä¸­è·å– <code>runqhead</code> æŒ‡å‘çš„<code>goroutine</code>ï¼Œå¹¶å°è¯•é€šè¿‡åŸå­æ“ä½œï¼ˆCASï¼‰æ›´æ–°<code>runqhead</code>ã€‚</li><li>å¦‚æœæ›´æ–°æˆåŠŸï¼Œè¿”å›è·å–åˆ°çš„<code>goroutine</code>ï¼Œ<code>inheritTime</code> è¢«è®¾ç½®ä¸º<code>false</code>ï¼Œè¡¨ç¤ºè¿™ä¸ª <code>goroutine</code>åº”è¯¥å¼€å§‹ä¸€ä¸ªæ–°çš„æ—¶é—´ç‰‡ã€‚</li></ul><p>ä¸¤ä¸ªé—®é¢˜ï¼š</p><p><strong>1. ä¸ºä»€ä¹ˆè·å– runqhead éœ€è¦ä¸Šé”ï¼Œè·å– runqtailå°±ä¸éœ€è¦ï¼Ÿ</strong></p><p><strong>å•ä¸€ç”Ÿäº§è€…</strong>ï¼šæ¯ä¸ªæœ¬åœ°è¿è¡Œé˜Ÿåˆ—åªæœ‰ä¸€ä¸ªç”Ÿäº§è€…ï¼Œå³ä¸ä¹‹å…³è”çš„å½“å‰Pã€‚åªæœ‰è¿™ä¸ª P å¯ä»¥å‘é˜Ÿåˆ—å°¾éƒ¨æ·»åŠ æ–°çš„<code>goroutine</code>ã€‚ç”±äºä¸å­˜åœ¨å¤šä¸ªç”Ÿäº§è€…çš„å¹¶å‘å†™å…¥é—®é¢˜ï¼Œå› æ­¤ä¸éœ€è¦é”æ¥ä¿æŠ¤é˜Ÿå°¾ã€‚</p><p><strong>2. inheritTime æœ‰ä»€ä¹ˆç”¨ï¼Ÿ</strong></p><p><code>inheritTime</code> çš„ä¸»è¦ä½œç”¨æ˜¯å†³å®šæ–°è°ƒåº¦çš„<code>goroutine</code>æ˜¯å¦åº”è¯¥ç«‹å³å¼€å§‹ä¸€ä¸ªæ–°çš„æ—¶é—´ç‰‡ï¼Œæˆ–è€…ç»§ç»­ä½¿ç”¨å½“å‰æ—¶é—´ç‰‡çš„å‰©ä½™éƒ¨åˆ†ã€‚è¿™åœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¸‹å°¤ä¸ºé‡è¦ï¼š</p><ul><li><strong>ç»§æ‰¿æ—¶é—´ç‰‡</strong> (<code>inheritTime == true</code>)ï¼šå½“<code>runqget</code> ä» <code>runnext</code> å­—æ®µè·å–<code>goroutine</code> æ—¶ï¼Œè¿™ä¸ª <code>goroutine</code>è¢«è®¤ä¸ºæ˜¯ç‰¹åˆ«ä¼˜å…ˆçš„ï¼Œå› æ­¤å®ƒç»§æ‰¿äº†å½“å‰æ—¶é—´ç‰‡çš„å‰©ä½™æ—¶é—´ã€‚è¿™é€šå¸¸å‘ç”Ÿåœ¨<code>goroutine</code>é€šè¿‡ç‰¹å®šçš„åŒæ­¥æœºåˆ¶ï¼ˆå¦‚é€šé“æ“ä½œï¼‰è¢«æ˜ç¡®å”¤é†’æ—¶ã€‚</li><li><strong>å¼€å§‹æ–°çš„æ—¶é—´ç‰‡</strong>(<code>inheritTime == false</code>)ï¼šå½“ <code>runqget</code>ä»æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ä¸­æ­£å¸¸è·å– <code>goroutine</code> æ—¶ï¼Œè¿™ä¸ª<code>goroutine</code>å°†å¼€å§‹ä¸€ä¸ªå…¨æ–°çš„æ—¶é—´ç‰‡ã€‚è¿™ç¡®ä¿äº†è°ƒåº¦çš„å…¬å¹³æ€§ï¼Œä½¿å¾—æ¯ä¸ª<code>goroutine</code> éƒ½æœ‰æœºä¼šåœ¨ç»™å®šçš„æ—¶é—´ç‰‡å†…è¿è¡Œã€‚</li></ul><h3 id="netpoll">4.5 netpoll()</h3><p><code>netpoll()</code> å‡½æ•°æ˜¯ Goè¯­è¨€è¿è¡Œæ—¶ç½‘ç»œè½®è¯¢æœºåˆ¶çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºæ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦å‡†å¤‡å¥½è¿›è¡Œéé˜»å¡ I/Oæ“ä½œã€‚è¿™ä¸ªå‡½æ•°è¿”å›ä¸€ç»„å·²ç»å˜ä¸ºå¯è¿è¡ŒçŠ¶æ€çš„ <code>goroutine</code>ï¼Œè¿™äº›<code>goroutine</code> ä¹‹å‰å¯èƒ½å› ç­‰å¾…ç½‘ç»œ I/O è€Œè¢«æŒ‚èµ·ã€‚</p><p>è¿™é‡Œæ¶‰åŠåˆ° Go è¯­è¨€ç½‘ç»œç¼–ç¨‹åŸç†ï¼Œåœ¨æœ¬æ–‡ä¸­ä¸ç»†ç©¶ï¼Œå°±ç®€å•å¸¦è¿‡äº†ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">netpoll</span><span class="hljs-params">(delay <span class="hljs-type">int64</span>)</span></span> gList &#123;<br>  <span class="hljs-comment">// æ£€æŸ¥è½®è¯¢å™¨æ˜¯å¦åˆå§‹åŒ–ã€‚</span><br><span class="hljs-keyword">if</span> kq == <span class="hljs-number">-1</span> &#123;<br><span class="hljs-keyword">return</span> gList&#123;&#125;<br>&#125;<br>  <span class="hljs-comment">// è®¾ç½®è½®è¯¢è¶…æ—¶ã€‚</span><br><span class="hljs-keyword">var</span> tp *timespec<br><span class="hljs-keyword">var</span> ts timespec<br><span class="hljs-keyword">if</span> delay &lt; <span class="hljs-number">0</span> &#123;<br>tp = <span class="hljs-literal">nil</span><br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> delay == <span class="hljs-number">0</span> &#123;<br>tp = &amp;ts<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>ts.setNsec(delay)<br><span class="hljs-keyword">if</span> ts.tv_sec &gt; <span class="hljs-number">1e6</span> &#123;<br>ts.tv_sec = <span class="hljs-number">1e6</span><br>&#125;<br>tp = &amp;ts<br>&#125;<br>  <span class="hljs-comment">// ä½¿ç”¨ kevent è¿›è¡Œè½®è¯¢æ“ä½œï¼Œç»“æœæ”¾åœ¨ events ä¸­ã€‚</span><br><span class="hljs-keyword">var</span> events [<span class="hljs-number">64</span>]keventt<br>retry:<br>n := kevent(kq, <span class="hljs-literal">nil</span>, <span class="hljs-number">0</span>, &amp;events[<span class="hljs-number">0</span>], <span class="hljs-type">int32</span>(<span class="hljs-built_in">len</span>(events)), tp)<br><span class="hljs-keyword">if</span> n &lt; <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">if</span> n != -_EINTR &#123;<br><span class="hljs-built_in">println</span>(<span class="hljs-string">&quot;runtime: kevent on fd&quot;</span>, kq, <span class="hljs-string">&quot;failed with&quot;</span>, -n)<br>throw(<span class="hljs-string">&quot;runtime: netpoll failed&quot;</span>)<br>&#125;<br><span class="hljs-keyword">if</span> delay &gt; <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> gList&#123;&#125;<br>&#125;<br><span class="hljs-keyword">goto</span> retry<br>&#125;<br>  <span class="hljs-comment">// éå† events å¤„ç†è½®è¯¢äº‹ä»¶ã€‚</span><br><span class="hljs-keyword">var</span> toRun gList<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-type">int</span>(n); i++ &#123;<br>ev := &amp;events[i]<br><br>    <span class="hljs-comment">// netpollBreakRd ç”¨äºå”¤é†’è½®è¯¢ï¼Œå³å”¤é†’ç­‰å¾…ä¸­çš„ goroutineã€‚</span><br><span class="hljs-keyword">if</span> <span class="hljs-type">uintptr</span>(ev.ident) == netpollBreakRd &#123;<br><span class="hljs-keyword">if</span> ev.filter != _EVFILT_READ &#123;<br><span class="hljs-built_in">println</span>(<span class="hljs-string">&quot;runtime: netpoll: break fd ready for&quot;</span>, ev.filter)<br>throw(<span class="hljs-string">&quot;runtime: netpoll: break fd ready for something unexpected&quot;</span>)<br>&#125;<br><span class="hljs-keyword">if</span> delay != <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">var</span> tmp [<span class="hljs-number">16</span>]<span class="hljs-type">byte</span><br>read(<span class="hljs-type">int32</span>(netpollBreakRd), noescape(unsafe.Pointer(&amp;tmp[<span class="hljs-number">0</span>])), <span class="hljs-type">int32</span>(<span class="hljs-built_in">len</span>(tmp)))<br>netpollWakeSig.Store(<span class="hljs-number">0</span>)<br>&#125;<br><span class="hljs-keyword">continue</span><br>&#125;<br><br>    <span class="hljs-comment">// æ ¹æ®è½®è¯¢äº‹ä»¶çš„ç±»å‹ï¼ˆè¯»æˆ–å†™ï¼‰ï¼Œå”¤é†’ç›¸åº”ç­‰å¾…ç½‘ç»œ I/O çš„ groutineã€‚</span><br><span class="hljs-keyword">var</span> mode <span class="hljs-type">int32</span><br><span class="hljs-keyword">switch</span> ev.filter &#123;<br><span class="hljs-keyword">case</span> _EVFILT_READ:<br>mode += <span class="hljs-string">&#x27;r&#x27;</span><br><span class="hljs-keyword">if</span> ev.flags&amp;_EV_EOF != <span class="hljs-number">0</span> &#123;<br>mode += <span class="hljs-string">&#x27;w&#x27;</span><br>&#125;<br><span class="hljs-keyword">case</span> _EVFILT_WRITE:<br>mode += <span class="hljs-string">&#x27;w&#x27;</span><br>&#125;<br><span class="hljs-keyword">if</span> mode != <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">var</span> pd *pollDesc<br><span class="hljs-keyword">var</span> tag <span class="hljs-type">uintptr</span><br><span class="hljs-keyword">if</span> goarch.PtrSize == <span class="hljs-number">4</span> &#123;<br>pd = (*pollDesc)(unsafe.Pointer(ev.udata))<br>tag = <span class="hljs-number">0</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br>tp := taggedPointer(<span class="hljs-type">uintptr</span>(unsafe.Pointer(ev.udata)))<br>pd = (*pollDesc)(tp.pointer())<br>tag = tp.tag()<br><span class="hljs-keyword">if</span> pd.fdseq.Load() != tag &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br>&#125;<br>pd.setEventErr(ev.flags == _EV_ERROR, tag)<br>      <span class="hljs-comment">// æ ‡è®° goroutine å¯æ‰§è¡Œã€‚</span><br>netpollready(&amp;toRun, pd, mode)<br>&#125;<br>&#125;<br>  <br>  <span class="hljs-comment">// è¿”å›å¯è¿è¡Œçš„ goroutine åˆ—è¡¨ã€‚</span><br><span class="hljs-keyword">return</span> toRun<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="stealwork">4.6 stealWork()</h3><p><code>stealWork()</code> å‡½æ•°ç”¨äºå°è¯•ä»å…¶ä»–å¤„ç†å™¨ï¼ˆPï¼‰çªƒå–å¯è¿è¡Œçš„<code>goroutine</code> æˆ–å®šæ—¶å™¨ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">stealWork</span><span class="hljs-params">(now <span class="hljs-type">int64</span>)</span></span> (gp *g, inheritTime <span class="hljs-type">bool</span>, rnow, pollUntil <span class="hljs-type">int64</span>, newWork <span class="hljs-type">bool</span>) &#123;<br>  <br>  <span class="hljs-comment">// è·å–å½“å‰ M ç»‘å®šçš„ Pã€‚</span><br>pp := getg().m.p.ptr()<br><br>ranTimer := <span class="hljs-literal">false</span><br><br>  <span class="hljs-comment">// å°è¯• 4 æ¬¡ã€‚</span><br><span class="hljs-keyword">const</span> stealTries = <span class="hljs-number">4</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; stealTries; i++ &#123;<br>    <span class="hljs-comment">// å‰ 3 æ¬¡å°è¯•çªƒå– gã€‚</span><br>    <span class="hljs-comment">// ç¬¬ 4 æ¬¡å°è¯•çªƒå– timerï¼Œå¹¶ä¸”å°è¯•è·å–å…¶ä»– P çš„ runnext ä¸­çš„ gã€‚</span><br>stealTimersOrRunNextG := i == stealTries<span class="hljs-number">-1</span><br><br>    <span class="hljs-comment">// éšæœºé€‰ä¸€ä¸ª Pã€‚</span><br><span class="hljs-keyword">for</span> enum := stealOrder.start(fastrand()); !enum.done(); enum.next() &#123;<br><span class="hljs-comment">// å¦‚æœç³»ç»Ÿæ­£åœ¨ GCï¼Œåˆ™å¯ä»¥ç›´æ¥è¿”å› trueï¼Œå› ä¸ºå¯èƒ½è¦è´Ÿè´£ gc äº†ï¼Œæœ‰äº‹å¹²äº†ã€‚</span><br>      <span class="hljs-keyword">if</span> sched.gcwaiting.Load() &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">false</span>, now, pollUntil, <span class="hljs-literal">true</span><br>&#125;<br>      <br>      <span class="hljs-comment">// è·å–é€‰ä¸­çš„ Pï¼Œå¦‚æœæ˜¯å½“å‰ P åˆ™ç›´æ¥ continueï¼Œé‡è¯•ã€‚</span><br>p2 := allp[enum.position()]<br><span class="hljs-keyword">if</span> pp == p2 &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><br>      <span class="hljs-comment">// ç¬¬ 4 æ¬¡å°è¯•å»çªƒå– p2 çš„ timerã€‚</span><br><span class="hljs-keyword">if</span> stealTimersOrRunNextG &amp;&amp; timerpMask.read(enum.position()) &#123;<br>        <span class="hljs-comment">// æ£€æŸ¥å¹¶å¯èƒ½æ‰§è¡Œ timerã€‚</span><br>tnow, w, ran := checkTimers(p2, now)<br>now = tnow<br><span class="hljs-keyword">if</span> w != <span class="hljs-number">0</span> &amp;&amp; (pollUntil == <span class="hljs-number">0</span> || w &lt; pollUntil) &#123;<br>pollUntil = w<br>&#125;<br>        <span class="hljs-comment">// å¦‚æœæ‰§è¡Œäº† timerï¼Œåˆ™æ£€æŸ¥æœ¬åœ°é˜Ÿåˆ—æ˜¯å¦æœ‰ g å¯ä»¥è¿è¡Œï¼Œ</span><br>        <span class="hljs-comment">// å› ä¸º timer ä¼šå”¤é†’è¢«æŒ‚èµ·çš„ gã€‚</span><br><span class="hljs-keyword">if</span> ran &#123;<br><span class="hljs-keyword">if</span> gp, inheritTime := runqget(pp); gp != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> gp, inheritTime, now, pollUntil, ranTimer<br>&#125;<br>ranTimer = <span class="hljs-literal">true</span><br>&#125;<br>&#125;<br><br>      <span class="hljs-comment">// å‰ 3 æ¬¡å°è¯•æˆ–è€…ç¬¬ 4 æ¬¡å°è¯•æ²¡æœ‰çªƒå–åˆ° timer çš„æ—¶å€™ï¼Œ</span><br>      <span class="hljs-comment">// å°±ä»å…¶ä»–éç©ºé—² P çš„æœ¬åœ°é˜Ÿåˆ—ä¸­å°è¯•çªƒå– gã€‚</span><br><span class="hljs-keyword">if</span> !idlepMask.read(enum.position()) &#123;<br>        <span class="hljs-comment">// å¦‚æœ stealTimersOrRunNextG ä¸º trueï¼Œ</span><br>        <span class="hljs-comment">// é‚£ä¹ˆä¼šåœ¨çªƒå–çš„æ—¶å€™ï¼Œå°è¯•çªƒå– p2 çš„ runnextã€‚</span><br><span class="hljs-keyword">if</span> gp := runqsteal(pp, p2, stealTimersOrRunNextG); gp != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> gp, <span class="hljs-literal">false</span>, now, pollUntil, ranTimer<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">false</span>, now, pollUntil, ranTimer<br>&#125;<br></code></pre></td></tr></table></figure><p>é˜…è¯»æºç çš„å¥½å¤„è¿™å°±ä½“ç°äº†ï¼Œæ‰€æœ‰äººéƒ½å‘Šè¯‰æˆ‘ä»¬ P æ‰¾ä¸åˆ°å¯è¿è¡Œ Gçš„æ—¶å€™å°±ä¼šå»çªƒå–å…¶ä»– P çš„Gï¼Œä½†æ²¡äººå‘Šè¯‰æˆ‘ä»¬ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹<strong>è¿˜å¯èƒ½ä¼šå»çªƒå–å…¶ä»– P çš„ timer å’Œrunnext</strong>ã€‚</p><p>æ‰€è°“<code>timer</code>ï¼Œå³å®šæ—¶å™¨ï¼Œç”¨äºåœ¨æŒ‡å®šçš„æ—¶é—´åæ‰§è¡ŒæŸäº›æ“ä½œã€‚è¿™äº›æ“ä½œé€šå¸¸åŒ…æ‹¬å”¤é†’ç­‰å¾…ç‰¹å®šæ—¶é—´çš„<code>goroutine</code>ï¼Œæˆ–æ‰§è¡Œä¸æ—¶é—´ç›¸å…³çš„ä»»åŠ¡ã€‚å®šæ—¶å™¨åœ¨ Goçš„å¹¶å‘æ¨¡å‹ä¸­æ‰®æ¼”ç€é‡è¦çš„è§’è‰²ï¼Œç‰¹åˆ«æ˜¯åœ¨æ¶‰åŠåˆ°æ—¶é—´å»¶è¿Ÿæˆ–å‘¨æœŸæ€§ä»»åŠ¡çš„åœºæ™¯ä¸­ã€‚åœ¨è°ƒåº¦å™¨å±‚é¢ï¼Œå®šæ—¶å™¨çš„ç®¡ç†å¯¹äºç¡®ä¿åŠæ—¶å“åº”æ—¶é—´ç›¸å…³çš„äº‹ä»¶å’Œç»´æŒé«˜æ•ˆçš„è°ƒåº¦è‡³å…³é‡è¦ã€‚é€šè¿‡åˆç†åœ°å¤„ç†å®šæ—¶å™¨äº‹ä»¶ï¼ŒGoèƒ½å¤Ÿåœ¨ä¿æŒé«˜å¹¶å‘æ€§çš„åŒæ—¶ï¼Œæœ‰æ•ˆåœ°ç®¡ç†æ—¶é—´å»¶è¿Ÿå’Œå‘¨æœŸæ€§ä»»åŠ¡ã€‚</p><p>åœ¨ Go è¯­è¨€çš„è°ƒåº¦å™¨ä¸­ï¼Œè·¨ P çš„å®šæ—¶å™¨çªƒå–æ˜¯ä¸€ç§ä¼˜åŒ–æœºåˆ¶ï¼Œå®ƒæœ‰ 2ä¸ªå¥½å¤„ï¼š</p><ul><li><strong>ä¿æŒå¤„ç†å™¨æ´»è·ƒ</strong>ï¼šå½“ä¸€ä¸ª Pæ²¡æœ‰è¶³å¤Ÿçš„æœ¬åœ°å·¥ä½œæ—¶ï¼Œå®ƒå¯ä»¥å°è¯•ä»å…¶ä»– Pçªƒå–å®šæ—¶å™¨ä»»åŠ¡ã€‚è¿™æ ·åšå¯ä»¥ä¿æŒè¯¥ Pæ´»è·ƒï¼Œé¿å…å®ƒè¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œä»è€Œæé«˜æ•´ä½“ç³»ç»Ÿçš„æ•ˆç‡ã€‚</li><li><strong>å¹³è¡¡ç³»ç»Ÿè´Ÿè½½</strong>ï¼šåœ¨å¤šæ ¸ç³»ç»Ÿä¸­ï¼Œä¸åŒçš„ På¯èƒ½ä¼šæœ‰ä¸åŒçš„è´Ÿè½½ã€‚è·¨ P çš„å®šæ—¶å™¨çªƒå–æœ‰åŠ©äºåœ¨ Pä¹‹é—´å¹³è¡¡è´Ÿè½½ï¼Œç‰¹åˆ«æ˜¯åœ¨ä¸€äº› P éå¸¸å¿™ç¢Œè€Œå…¶ä»– P ç›¸å¯¹ç©ºé—²çš„æƒ…å†µä¸‹ã€‚</li></ul><p>å¥½çš„ï¼Œå›è¿‡å¤´æ¥ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬ä¼šè¯´çªƒå–çš„æ—¶å€™ä¼šä»é˜Ÿå¤´çªƒå–å‘¢ï¼Ÿä¸ºä»€ä¹ˆæ˜¯çªƒå–p2 ä¸€åŠçš„ g å‘¢ï¼Ÿè¿™ä¸ªè¿‡ç¨‹å°±åœ¨ <code>runqsteal()</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">runqsteal</span><span class="hljs-params">(pp, p2 *p, stealRunNextG <span class="hljs-type">bool</span>)</span></span> *g &#123;<br>t := pp.runqtail<br>  <br>  <span class="hljs-comment">// ä» p2 ä¸­è·å– n ä¸ª gã€‚</span><br>n := runqgrab(p2, &amp;pp.runq, t, stealRunNextG)<br><span class="hljs-keyword">if</span> n == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br>  <br>  <span class="hljs-comment">// è¿”å›ç¬¬ 1 ä¸ª gï¼Œå› ä¸ºå®ƒå¯ä»¥ç›´æ¥æ‰§è¡Œäº†ã€‚</span><br>n--<br>gp := pp.runq[(t+n)%<span class="hljs-type">uint32</span>(<span class="hljs-built_in">len</span>(pp.runq))].ptr()<br><span class="hljs-keyword">if</span> n == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> gp<br>&#125;<br>  <span class="hljs-comment">// å¦‚æœè¿˜æœ‰å‰©ä¸‹çš„ gï¼Œé‚£ä¹ˆå°±åŠ å…¥åˆ°æœ¬åœ°é˜Ÿåˆ—ä¸­ã€‚</span><br>  <span class="hljs-comment">// è¿™é‡Œå¯ä»¥çœ‹åˆ°æ˜¯ä»é˜Ÿå¤´åŠ å…¥çš„ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨åŸå­æ“ä½œè·å–é˜Ÿå¤´ã€‚</span><br>h := atomic.LoadAcq(&amp;pp.runqhead)<br><span class="hljs-keyword">if</span> t-h+n &gt;= <span class="hljs-type">uint32</span>(<span class="hljs-built_in">len</span>(pp.runq)) &#123;<br>throw(<span class="hljs-string">&quot;runqsteal: runq overflow&quot;</span>)<br>&#125;<br>atomic.StoreRel(&amp;pp.runqtail, t+n)<br><span class="hljs-keyword">return</span> gp<br>&#125;<br></code></pre></td></tr></table></figure><p><code>runqgrab()</code> æ˜¯çªƒå– n ä¸ª g çš„è¿‡ç¨‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">runqgrab</span><span class="hljs-params">(pp *p, batch *[256]guintptr, batchHead <span class="hljs-type">uint32</span>, stealRunNextG <span class="hljs-type">bool</span>)</span></span> <span class="hljs-type">uint32</span> &#123;<br>  <span class="hljs-comment">// ä½¿ç”¨æ— é™å¾ªç¯æ¥å°è¯•çªƒå–å·¥ä½œï¼Œç›´åˆ°æˆåŠŸæˆ–ç¡®å®šæ²¡æœ‰å¯çªƒå–çš„å·¥ä½œã€‚</span><br><span class="hljs-keyword">for</span> &#123;<br>h := atomic.LoadAcq(&amp;pp.runqhead) <br>t := atomic.LoadAcq(&amp;pp.runqtail) <br>n := t - h<br>    <br>    <span class="hljs-comment">// è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œè¦çªƒå–çš„ä¸ªæ•°ï¼Œå°±æ˜¯ pp æœ¬åœ°é˜Ÿåˆ—ä¸­ g ä¸ªæ•°çš„ä¸€åŠ</span><br>n = n - n/<span class="hljs-number">2</span><br>    <br>    <span class="hljs-comment">// å¦‚æœ n ä¸º 0ï¼Œä¸” stealRunNextG == trueï¼Œ</span><br>    <span class="hljs-comment">// é‚£ä¹ˆå°±å°è¯•çªƒå– pp çš„ runnext ä¸­çš„ gã€‚</span><br><span class="hljs-keyword">if</span> n == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">if</span> stealRunNextG &#123;<br><span class="hljs-keyword">if</span> next := pp.runnext; next != <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">if</span> !pp.runnext.cas(next, <span class="hljs-number">0</span>) &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br>batch[batchHead%<span class="hljs-type">uint32</span>(<span class="hljs-built_in">len</span>(batch))] = next<br><span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>&#125;<br>    <br>    <span class="hljs-comment">// å¦‚æœ n ä¸ä¸ºé˜Ÿåˆ—é•¿åº¦çš„ä¸€åŠï¼Œåˆ™è¯´æ˜é˜Ÿåˆ—å‘ç”Ÿäº†å˜åŒ–ï¼Œ</span><br>    <span class="hljs-comment">// è¿™ä¸ªæ—¶å€™é‡æ–°å°è¯•çªƒå–ã€‚</span><br><span class="hljs-keyword">if</span> n &gt; <span class="hljs-type">uint32</span>(<span class="hljs-built_in">len</span>(pp.runq)/<span class="hljs-number">2</span>) &#123; <br><span class="hljs-keyword">continue</span><br>&#125;<br>    <span class="hljs-comment">// å°†è¦çªƒå–çš„ g ä» pp.runq ä¸­è½¬ç§»åˆ° batch ä¸­ã€‚</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>); i &lt; n; i++ &#123;<br>g := pp.runq[(h+i)%<span class="hljs-type">uint32</span>(<span class="hljs-built_in">len</span>(pp.runq))]<br>batch[(batchHead+i)%<span class="hljs-type">uint32</span>(<span class="hljs-built_in">len</span>(batch))] = g<br>&#125;<br>    <span class="hljs-comment">// ä½¿ç”¨åŸå­æ“ä½œå°è¯•æ›´æ–° pp çš„é˜Ÿåˆ—å¤´éƒ¨ï¼Œå³å°† g ä» pp.runq ä¸­ç§»é™¤ã€‚</span><br><span class="hljs-keyword">if</span> atomic.CasRel(&amp;pp.runqhead, h, h+n) &#123; <br><span class="hljs-keyword">return</span> n<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>findRunnable()</code>çš„å…¨éƒ¨è¿‡ç¨‹æˆ‘ä»¬æ€»ç®—æ˜¯æ¢³ç†å®Œäº†ï¼Œè¿™ä¸ªè¿‡ç¨‹ç¡®å®éå¸¸ç²¾å½©ï¼ŒGoè°ƒåº¦å™¨åœ¨æé«˜è°ƒåº¦æ€§èƒ½ã€ç¡®ä¿è°ƒåº¦çš„å…¬å¹³æ€§ã€å¹³è¡¡ç³»ç»Ÿè´Ÿè½½ã€é™ä½åŒæ­¥å¼€é”€ã€å‡å°‘èµ„æºå†åˆ†é…ç­‰æ–¹é¢éƒ½åšäº†å¾ˆå¤šçš„åŠªåŠ›ï¼Œè¿™æ‰è®©Go è¯­è¨€çš„å¹¶å‘åˆå¼ºå¤§åˆæ˜“ç”¨ã€‚</p><p>ä¸‹é¢æ˜¯å¯¹ <code>findRunnable()</code> ä¸€ä¸ªç®€å•çš„æ€»ç»“ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240128212451142.png"alt="findRunnable()" /><figcaption aria-hidden="true">findRunnable()</figcaption></figure><h3 id="execute">4.7 execute()</h3><p><code>findRunnable()</code> ä¹‹åå°±æ˜¯<code>execute()</code>ï¼Œå®ƒçš„æ ¸å¿ƒè¿‡ç¨‹å¦‚ä¸‹ï¼ˆæœ‰åˆ å‡ï¼‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">execute</span><span class="hljs-params">(gp *g, inheritTime <span class="hljs-type">bool</span>)</span></span> &#123;<br>mp := getg().m<br><span class="hljs-comment">// å°† g0 d çº¿ç¨‹ä¿¡æ¯å¤åˆ¶åˆ°å³å°†è¦è°ƒç”¨çš„åç¨‹ gp ä¸­ã€‚</span><br>mp.curg = gp<br>gp.m = mp<br>  <span class="hljs-comment">// ä¿®æ”¹ gp çš„çŠ¶æ€ä¸º _Grunningï¼Œå³è¿è¡Œä¸­ã€‚</span><br>casgstatus(gp, _Grunnable, _Grunning)<br>gp.waitsince = <span class="hljs-number">0</span><br>  <span class="hljs-comment">// æ ‡è®°ä¸ºéæŠ¢å </span><br>gp.preempt = <span class="hljs-literal">false</span><br>  <span class="hljs-comment">// ç”¨äºæ ˆä¿æŠ¤ï¼Œæ£€æµ‹æ ˆæº¢å‡º</span><br>gp.stackguard0 = gp.stack.lo + stackGuard<br>  <span class="hljs-comment">// gogo ä¼šå®Œæˆ g0 åˆ° g çš„åç¨‹æ ˆçš„åˆ‡æ¢ï¼Œå¹¶ä» gp.sched å¼€å§‹æ‰§è¡Œã€‚</span><br>  <span class="hljs-comment">// sched å­—æ®µæˆ‘ä»¬å‰é¢ä»‹ç»è¿‡ï¼Œå®ƒæ˜¯ gobuf ç»“æ„ä½“ï¼Œå­˜å‚¨äº† sp å’Œ pcã€‚</span><br>gogo(&amp;gp.sched)<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥ <code>execute()</code> çš„å·¥ä½œéå¸¸ç®€å•ï¼Œå…¶å®å°±æ˜¯å°† g0çš„çº¿ç¨‹ä¿¡æ¯å¤åˆ¶åˆ° gp ä¸Šï¼Œå¹¶ä¿®æ”¹çŠ¶æ€å’Œä¸€äº›å…ƒæ•°æ®ï¼Œæ ¸å¿ƒéƒ¨åˆ†å…¶å®åœ¨<code>gogo()</code> ä¸­ã€‚</p><h3 id="gogo">4.8 gogo()</h3><p>å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼Œ<code>gogo()</code> ä¼šå®Œæˆ g0 æ ˆåˆ° gæ ˆçš„åˆ‡æ¢ï¼Œä¸”åœ¨ä¸åŒå¹³å°ä¸‹æœ‰ä¸åŒçš„è§†çº¿ï¼Œè¿™é‡Œæˆ‘ä»¬ä»¥ <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/asm_arm64.s">asm_arm64.s</a>ä¸ºä»£è¡¨æ¥çœ‹ä¸€ä¸‹ <code>gogo()</code> çš„æ±‡ç¼–å®ç°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs assembly">TEXT runtimeÂ·gogo(SB), NOSPLIT|NOFRAME, $0-8<br>MOVDbuf+0(FP), R5<br>MOVDgobuf_g(R5), R6<br>MOVD0(R6), R4// make sure g != nil<br>Bgogo&lt;&gt;(SB)<br><br>TEXT gogo&lt;&gt;(SB), NOSPLIT|NOFRAME, $0<br>MOVDR6, g<br>BLruntimeÂ·save_g(SB)<br><br>MOVDgobuf_sp(R5), R0<br>MOVDR0, RSP<br>MOVDgobuf_bp(R5), R29<br>MOVDgobuf_lr(R5), LR<br>MOVDgobuf_ret(R5), R0<br>MOVDgobuf_ctxt(R5), R26<br>MOVD$0, gobuf_sp(R5)<br>MOVD$0, gobuf_bp(R5)<br>MOVD$0, gobuf_ret(R5)<br>MOVD$0, gobuf_lr(R5)<br>MOVD$0, gobuf_ctxt(R5)<br>CMPZR, ZR // set condition codes for == test, needed by stack split<br>MOVDgobuf_pc(R5), R6<br>B(R6)<br></code></pre></td></tr></table></figure><p>å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol type="1"><li><strong><code>runtimeÂ·gogo</code>å‡½æ•°</strong>ï¼šè¿™ä¸ªå‡½æ•°ç”¨äºè®¾ç½®æ–°çš„ <code>goroutine</code>ä¸Šä¸‹æ–‡ã€‚å®ƒæ¥æ”¶ä¸€ä¸ªæŒ‡å‘ <code>gobuf</code>ç»“æ„çš„æŒ‡é’ˆï¼ˆ<code>buf+0(FP)</code>ï¼‰ï¼Œè¯¥ç»“æ„åŒ…å«äº†<code>goroutine</code> çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</li><li><strong>åŠ è½½ <code>gobuf</code> å¹¶æ£€æŸ¥ <code>g</code></strong>ï¼šåŠ è½½<code>gobuf</code> ç»“æ„ï¼Œå¹¶æ£€æŸ¥ <code>g</code> æ˜¯å¦ä¸º<code>nil</code>ã€‚</li><li><strong>è·³è½¬åˆ° <code>gogo&lt;&gt;</code></strong>ï¼šæ‰§è¡Œæ— æ¡ä»¶è·³è½¬åˆ°<code>gogo&lt;&gt;</code> å‡½æ•°ã€‚</li><li><strong><code>gogo&lt;&gt;</code>å‡½æ•°</strong>ï¼šè¿™ä¸ªå‡½æ•°å®é™…ä¸Šå®Œæˆäº†ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚<ul><li>è®¾ç½®å½“å‰ <code>goroutine</code>ï¼šå°† <code>R6</code>å¯„å­˜å™¨ä¸­çš„å€¼ï¼ˆæ–°çš„ <code>goroutine</code>ï¼‰è®¾ç½®ä¸ºå½“å‰<code>goroutine</code>ã€‚</li><li>ä¿å­˜å½“å‰ <code>goroutine</code>ï¼šè°ƒç”¨ <code>runtimeÂ·save_g</code>ä¿å­˜å½“å‰ <code>goroutine</code> çš„çŠ¶æ€ã€‚</li><li>æ¢å¤æ ˆæŒ‡é’ˆå’Œå…¶ä»–å¯„å­˜å™¨ï¼šä» <code>gobuf</code>ç»“æ„ä¸­æ¢å¤æ ˆæŒ‡é’ˆï¼ˆ<code>RSP</code>ï¼‰ã€åŸºæŒ‡é’ˆï¼ˆ<code>R29</code>ï¼‰ã€é“¾æ¥å¯„å­˜å™¨ï¼ˆ<code>LR</code>ï¼‰ã€è¿”å›å€¼ï¼ˆ<code>R0</code>ï¼‰å’Œä¸Šä¸‹æ–‡ï¼ˆ<code>R26</code>ï¼‰ã€‚</li><li>æ¸…ç©º <code>gobuf</code> ç»“æ„ï¼šå°† <code>gobuf</code>ç»“æ„ä¸­çš„å­—æ®µæ¸…é›¶ã€‚</li><li>å‡†å¤‡è·³è½¬åˆ°æ–°çš„ç¨‹åºè®¡æ•°å™¨ä½ç½®ï¼šä» <code>gobuf</code>ä¸­åŠ è½½æ–°çš„ç¨‹åºè®¡æ•°å™¨åœ°å€ï¼ˆ<code>gobuf_pc(R5)</code>ï¼‰åˆ°<code>R6</code>ã€‚</li><li>è·³è½¬æ‰§è¡Œï¼šé€šè¿‡ <code>B (R6)</code>è·³è½¬åˆ°æ–°çš„ç¨‹åºè®¡æ•°å™¨åœ°å€ï¼Œç»§ç»­æ‰§è¡Œæ–° <code>goroutine</code>çš„ä»£ç ã€‚</li></ul></li></ol><p>è¿™æ®µæ±‡ç¼–ä»£ç æ˜¯ Go è¿è¡Œæ—¶ä¸­å¤„ç† <code>goroutine</code>ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å…³é”®éƒ¨åˆ†ã€‚å®ƒç›´æ¥æ“ä½œå¤„ç†å™¨çš„å¯„å­˜å™¨å’Œæ ˆï¼Œä»¥å®ç°ä»ä¸€ä¸ª<code>goroutine</code> åˆ‡æ¢åˆ°å¦ä¸€ä¸ª <code>goroutine</code> çš„åŠŸèƒ½ã€‚</p><p>åœ¨ <code>execute()</code> ä¸­æ˜¯è¿™ä¹ˆè°ƒç”¨ <code>gogo()</code> çš„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">gogo(&amp;gp.sched)<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥å®Œæˆæ ˆçš„åˆ‡æ¢åä¼šä» <code>gp.sched</code>å¼€å§‹ï¼Œæ‰§è¡Œä»£ç ï¼Œå‰é¢æˆ‘ä»¬ä»‹ç»è¿‡ <code>sched</code> æ˜¯ä¸€ä¸ª<code>gobuf</code> ç»“æ„ä½“ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> gobuf <span class="hljs-keyword">struct</span> &#123;<br>sp   <span class="hljs-type">uintptr</span><br>pc   <span class="hljs-type">uintptr</span><br>g    guintptr<br>ctxt unsafe.Pointer<br>ret  <span class="hljs-type">uintptr</span><br>lr   <span class="hljs-type">uintptr</span><br>bp   <span class="hljs-type">uintptr</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥ä¼šä» pc å¤„å¼€å§‹æ‰§è¡Œä¸šåŠ¡ä»£ç ï¼Œå‰é¢åœ¨ <code>newproc()</code>çš„æ—¶å€™ï¼Œæˆ‘ä»¬æè¿‡ä¸€è¡Œä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">newg.sched.pc = abi.FuncPCABI0(goexit) + sys.PCQuantum<br></code></pre></td></tr></table></figure><p>è¿™è¡Œä»£ç çš„ä½œç”¨ï¼Œæ˜¯åœ¨åç¨‹åˆ›å»ºçš„æ—¶å€™æ’å…¥ä¸€ä¸ª <code>goexit</code>å‡½æ•°çš„åœ°å€ï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™ <code>g</code>åˆšåˆ›å»ºï¼Œæ‰€ä»¥å…¶å®å°±æ˜¯å¾€åç¨‹æ ˆé¡¶æ’å…¥äº† <code>goexit</code> çš„åœ°å€ã€‚æ‰€ä»¥å½“<code>g</code> æ‰§è¡Œå®Œä¸šåŠ¡ä»£ç åï¼Œå½“æ ˆä¸­å…ƒç´ ä¸æ–­å¼¹å‡ºåï¼Œæœ€ç»ˆå°±ä¼šå¼¹å‡º<code>goexit</code> çš„åœ°å€ï¼Œç„¶åæ‰§è¡Œ <code>goexit()</code>å‡½æ•°ï¼Œé€€å‡ºå½“å‰ <code>g</code>ï¼Œåˆ‡æ¢å› <code>g0</code>ã€‚</p><h3 id="goexit">4.9 goexit()</h3><p><code>goexit</code> å®šä¹‰åœ¨ <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/stubs.go">runtime/stubs.go</a>ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// goexit is the return stub at the top of every goroutine call stack.</span><br><span class="hljs-comment">// Each goroutine stack is constructed as if goexit called the</span><br><span class="hljs-comment">// goroutine&#x27;s entry point function, so that when the entry point</span><br><span class="hljs-comment">// function returns, it will return to goexit, which will call goexit1</span><br><span class="hljs-comment">// to perform the actual exit.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// This function must never be called directly. Call goexit1 instead.</span><br><span class="hljs-comment">// gentraceback assumes that goexit terminates the stack. A direct</span><br><span class="hljs-comment">// call on the stack will cause gentraceback to stop walking the stack</span><br><span class="hljs-comment">// prematurely and if there is leftover state it may panic.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">goexit</span><span class="hljs-params">(neverCallThisFunction)</span></span><br></code></pre></td></tr></table></figure><p>é€šè¿‡æ³¨é‡Šæˆ‘ä»¬å¯ä»¥å¾—åˆ° 2 ä¸ªä¿¡æ¯ï¼š</p><ul><li><code>goexit</code> çš„ä½äºæ¯ä¸ª goroutine è°ƒç”¨æ ˆçš„é¡¶éƒ¨ã€‚æ¯ä¸ªgoroutine çš„æ ˆè¢«æ„é€ å¾—å¥½åƒ <code>goexit</code> è°ƒç”¨äº† goroutineçš„å…¥å£å‡½æ•°ã€‚è¿™æ„å‘³ç€å½“å…¥å£å‡½æ•°è¿”å›æ—¶ï¼Œå®ƒå®é™…ä¸Šè¿”å›åˆ°<code>goexit</code>ã€‚</li><li>ä¸è¦ç›´æ¥è°ƒç”¨ <code>goexit</code>ï¼Œåº”è¯¥è°ƒç”¨<code>goexit1</code>ã€‚</li></ul><p><code>goexit1</code> ä½äº <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/proc.go">runtime/proc.go</a>ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Finishes execution of the current goroutine.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">goexit1</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> raceenabled &#123;<br>racegoend()<br>&#125;<br><span class="hljs-keyword">if</span> traceEnabled() &#123;<br>traceGoEnd()<br>&#125;<br>mcall(goexit0)<br>&#125;<br></code></pre></td></tr></table></figure><p>å¥½å§ï¼Œå®ƒè°ƒç”¨äº†<code>goexit0</code>ï¼ŒåŸæ¥è¿™æ‰æ˜¯çœŸæ­£çš„é€€å‡ºå…¥å£ï¼Œå®ƒä¹Ÿä½äº <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/proc.go">runtime/proc.go</a>ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">goexit0</span><span class="hljs-params">(gp *g)</span></span> &#123;<br>  <span class="hljs-comment">// è·å–å½“å‰çš„ M å’Œ P</span><br>mp := getg().m<br>pp := mp.p.ptr()<br><br>  <span class="hljs-comment">// ä¿®æ”¹ gp çš„çŠ¶æ€ä¸º _Gdeadï¼Œæ ‡å¿—å®ƒçš„ç»ˆæ­¢</span><br>casgstatus(gp, _Grunning, _Gdead)<br>  <span class="hljs-comment">// æ ‡è®° gc çš„æ ˆå†…å­˜æ˜¯å¯ä»¥è¿›è¡Œ gc æ‰«æçš„</span><br>gcController.addScannableStack(pp, -<span class="hljs-type">int64</span>(gp.stack.hi-gp.stack.lo))<br><span class="hljs-comment">// å¦‚æœ gp æ˜¯ç³»ç»Ÿ goroutineï¼Œåˆ™å°†ç³»ç»Ÿ goroutine çš„è®¡æ•°å‡å°‘</span><br>  <span class="hljs-keyword">if</span> isSystemGoroutine(gp, <span class="hljs-literal">false</span>) &#123;<br>sched.ngsys.Add(<span class="hljs-number">-1</span>)<br>&#125;<br>  <span class="hljs-comment">// æ¸…ç† gp çš„çŠ¶æ€</span><br>gp.m = <span class="hljs-literal">nil</span><br>locked := gp.lockedm != <span class="hljs-number">0</span><br>gp.lockedm = <span class="hljs-number">0</span><br>mp.lockedg = <span class="hljs-number">0</span><br>gp.preemptStop = <span class="hljs-literal">false</span><br>gp.paniconfault = <span class="hljs-literal">false</span><br>gp._defer = <span class="hljs-literal">nil</span> <br>gp._panic = <span class="hljs-literal">nil</span><br>gp.writebuf = <span class="hljs-literal">nil</span><br>gp.waitreason = waitReasonZero<br>gp.param = <span class="hljs-literal">nil</span><br>gp.labels = <span class="hljs-literal">nil</span><br>gp.timer = <span class="hljs-literal">nil</span><br><br>  <span class="hljs-comment">// å¦‚æœå¯ç”¨äº†åƒåœ¾å›æ”¶ï¼ˆGCï¼‰å¹¶ä¸” gp.gcAssistBytes å¤§äº 0ï¼Œ</span><br>  <span class="hljs-comment">// åˆ™å°†è¾…åŠ©ä¿¡ç”¨å½’è¿˜ç»™å…¨å±€æ± ã€‚è¿™æœ‰åŠ©äºæ›´å¥½åœ°æ§åˆ¶åƒåœ¾å›æ”¶è¿›ç¨‹ã€‚</span><br><span class="hljs-keyword">if</span> gcBlackenEnabled != <span class="hljs-number">0</span> &amp;&amp; gp.gcAssistBytes &gt; <span class="hljs-number">0</span> &#123;<br>assistWorkPerByte := gcController.assistWorkPerByte.Load()<br>scanCredit := <span class="hljs-type">int64</span>(assistWorkPerByte * <span class="hljs-type">float64</span>(gp.gcAssistBytes))<br>gcController.bgScanCredit.Add(scanCredit)<br>gp.gcAssistBytes = <span class="hljs-number">0</span><br>&#125;<br><br>  <span class="hljs-comment">// å°†å½“å‰ g ä» P çš„è¿è¡Œé˜Ÿåˆ—ä¸­ç§»é™¤</span><br>dropg()<br><br>  <span class="hljs-comment">// WebAssembly å¹³å°ç‰¹æ®Šå¤„ç†</span><br><span class="hljs-keyword">if</span> GOARCH == <span class="hljs-string">&quot;wasm&quot;</span> &#123; <br>gfput(pp, gp)<br>schedule() <br>&#125;<br><br>  <span class="hljs-comment">// å°† gp æ”¾å›å¤„ç†å™¨çš„å¯ç”¨é˜Ÿåˆ—ä¸­ï¼Œè¿™æ ·å¯ä»¥å¤ç”¨ g</span><br>gfput(pp, gp)<br><br>  <span class="hljs-comment">// å¦‚æœ goroutine è¢«ç»‘å®šåˆ°å½“å‰çº¿ç¨‹ä¸Šï¼Œ</span><br>  <span class="hljs-comment">// é‚£å¯èƒ½æ˜¯åœ¨åšç³»ç»Ÿè°ƒç”¨ï¼Œcgo è°ƒç”¨æˆ–å…¶ä»–ç‰¹æ®Šä»»åŠ¡ï¼Œ</span><br>  <span class="hljs-comment">// é‚£ä¹ˆå°±éœ€è¦åˆ‡åˆ° g0ï¼Œè®© g0 æ¥å®Œæˆåé¢çš„è°ƒåº¦ã€‚</span><br>  <span class="hljs-keyword">if</span> locked &#123;<br><span class="hljs-comment">// å¦‚æœ goroutine åœ¨ç»ˆæ­¢å‰æ›¾é”å®šå½“å‰çº¿ç¨‹ï¼Œ</span><br>    <span class="hljs-comment">// åˆ™æ ¹æ®ä¸åŒçš„æ“ä½œç³»ç»Ÿæ‰§è¡Œä¸åŒçš„å¤„ç†ã€‚</span><br>    <span class="hljs-comment">// åœ¨å¤§å¤šæ•°æ“ä½œç³»ç»Ÿä¸Šï¼Œä¼šè·³è½¬åˆ° mstart å‡½æ•°ï¼Œé‡Šæ”¾ P å¹¶é€€å‡ºçº¿ç¨‹ã€‚</span><br>    <span class="hljs-comment">// ä½†åœ¨ Plan 9 æ“ä½œç³»ç»Ÿä¸Šï¼Œä¼šæ¸…é™¤ lockedExtã€‚</span><br><span class="hljs-keyword">if</span> GOOS != <span class="hljs-string">&quot;plan9&quot;</span> &#123; <span class="hljs-comment">// See golang.org/issue/22227.</span><br>gogo(&amp;mp.g0.sched)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>mp.lockedExt = <span class="hljs-number">0</span><br>&#125;<br>&#125;<br>  <br>  <span class="hljs-comment">// ç»§ç»­è°ƒåº¦</span><br>  <span class="hljs-comment">// å¦‚æœæ‰§è¡Œäº† gogoï¼Œé‚£å°±æ˜¯ g0 åœ¨è°ƒåº¦ã€‚</span><br>  <span class="hljs-comment">// å¦‚æœæ²¡æœ‰æ‰§è¡Œ gogoï¼Œé‚£å°±æ˜¯ gp åœ¨è°ƒåº¦ã€‚</span><br>schedule()<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œæˆ‘ä»¬å°±å®Œæˆäº†å¯¹ GPM è°ƒåº¦å¾ªç¯çš„å…¨è¿‡ç¨‹æºç åˆ†æäº†ï¼Œä½ å¯ä»¥å›åˆ° <ahref="##4.%20è°ƒåº¦è¿‡ç¨‹%20schedule()">4. è°ƒåº¦è¿‡ç¨‹ schedule()</a>çœ‹ä¸€ä¸‹æˆ‘æ€»ç»“çš„é‚£å¼ å›¾ï¼Œè¿™å›ä½ åº”è¯¥ä¼šæœ‰æ›´åŠ æ·±å…¥çš„ç†è§£äº†ã€‚</p><h2 id="åç¨‹åˆ‡æ¢">5. åç¨‹åˆ‡æ¢</h2><p>å¦‚æœè¦ä¸€ä¸ªåç¨‹è¦ä¸€ç›´åˆ°æ‰§è¡Œå®Œæ¯•æ‰é€€å‡ºçš„è¯ï¼Œé‚£å¾ˆå¯èƒ½ä¼šé€ æˆå…¶ä»–åç¨‹é¥¥é¥¿çš„é—®é¢˜ã€‚æ‰€ä»¥Goå…¶å®ä¼šåœ¨ä¸€äº›ç‰¹æ®Šçš„æ—¶æœºå¯¹åç¨‹è¿›è¡Œåˆ‡æ¢ï¼Œè¿™ä¸ªè¿‡ç¨‹æœ‰æŠ¢å å¼è°ƒåº¦ï¼Œä¹Ÿæœ‰åä½œå¼çš„è°ƒåº¦ã€‚</p><p>åç¨‹åˆ‡æ¢çš„æ—¶å€™ï¼Œæœ€æ ¸å¿ƒçš„å°±æ˜¯è¦ä¿å­˜å½“å‰åç¨‹çš„ç°åœºï¼Œä»¥æ–¹ä¾¿å›åˆ°è¯¥åç¨‹çš„æ—¶å€™ç»§ç»­æ‰§è¡Œå‰©ä¸‹çš„å†…å®¹ã€‚å¤§è‡´è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/e6c9d24egy1h57vi6wrdqj21ho0sqjtn.jpg"alt="Go åç¨‹åˆ‡æ¢" /><figcaption aria-hidden="true">Go åç¨‹åˆ‡æ¢</figcaption></figure><p>æœ‰å“ªäº›æ—¶æœºä¼šè§¦å‘åˆ‡æ¢å‘¢ï¼Œè¿™é‡Œæˆ‘ç›´æ¥ç»™å‡ºç»“è®ºï¼š</p><p>åŸºäºåä½œçš„æŠ¢å å¼è°ƒåº¦</p><ul><li>ä¸»åŠ¨æŒ‚èµ·ï¼š<code>runtime.gopark()</code></li><li>ç³»ç»Ÿè°ƒç”¨ç»“æŸæ—¶ï¼š<code>exitsyscall()</code></li><li>å‡½æ•°è·³è½¬æ—¶ï¼š<code>morestack()</code></li></ul><p>åŸºäºä¿¡å·çš„æŠ¢å å¼è°ƒåº¦</p><ul><li>ä¿¡å·è°ƒåº¦ï¼š<code>doSigPreempt()</code></li></ul><h3 id="ä¸»åŠ¨æŒ‚èµ·-runtime.gopack">5.1 ä¸»åŠ¨æŒ‚èµ· runtime.gopack()</h3><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/e6c9d24egy1h57vq4flf5j21j20s4jto.jpg"alt="gopack åç¨‹åˆ‡æ¢" /><figcaption aria-hidden="true">gopack åç¨‹åˆ‡æ¢</figcaption></figure><p>è¿™ä¸ªå‡½æ•°ä½äº <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/proc.go">runtime/proc.go</a>ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">gopark</span><span class="hljs-params">(unlockf <span class="hljs-keyword">func</span>(*g, unsafe.Pointer)</span></span> <span class="hljs-type">bool</span>, lock unsafe.Pointer, reason waitReason, traceReason traceBlockReason, traceskip <span class="hljs-type">int</span>) &#123;<br><span class="hljs-keyword">if</span> reason != waitReasonSleep &#123;<br>checkTimeouts() <br>&#125;<br>mp := acquirem()<br>gp := mp.curg<br>status := readgstatus(gp)<br><span class="hljs-keyword">if</span> status != _Grunning &amp;&amp; status != _Gscanrunning &#123;<br>throw(<span class="hljs-string">&quot;gopark: bad g status&quot;</span>)<br>&#125;<br>mp.waitlock = lock<br>mp.waitunlockf = unlockf<br>gp.waitreason = reason<br>mp.waitTraceBlockReason = traceReason<br>mp.waitTraceSkip = traceskip<br>releasem(mp)<br>mcall(park_m)<br>&#125;<br></code></pre></td></tr></table></figure><p><code>gopark</code> å‡½æ•°çš„ä¸»è¦ç›®çš„æ˜¯ä½¿ Gè¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œç­‰å¾…è¢«å”¤é†’ã€‚</p><p>æœ€åå®ƒè°ƒç”¨äº† <code>mcall()</code>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// mcall switches from the g to the g0 stack and invokes fn(g)</span><br><span class="hljs-comment">// mcall åˆ‡æ¢åˆ° g0ï¼Œå¹¶æ‰§è¡Œ fnã€‚</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">mcall</span><span class="hljs-params">(fn <span class="hljs-keyword">func</span>(*g)</span></span>)<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥è¿™é‡Œåˆ‡æ¢å› <code>g0</code>ï¼Œå¹¶æ‰§è¡Œäº† <code>pack_m</code>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">park_m</span><span class="hljs-params">(gp *g)</span></span> &#123;<br>...<br>schedule()<br>&#125;<br></code></pre></td></tr></table></figure><p><code>pack_m()</code> å…¶å®å°±æ˜¯è°ƒç”¨äº† <code>schedule()</code>å»è¿›è¡Œä¸‹ä¸€è½®è°ƒåº¦ï¼Œè¿™å°±å®Œæˆäº†åç¨‹çš„åˆ‡æ¢ã€‚</p><p>å½“åç¨‹è¢«é˜»å¡çš„æ—¶å€™ï¼Œå°±ä¼šå»è°ƒç”¨ <code>runtime.gopark()</code> ä¸»åŠ¨è®©å‡ºCPUï¼Œåˆ‡å› <code>g0</code>ï¼Œç­‰å¾…è¢«å”¤é†’ï¼Œä»¥æ­¤ä¿è¯æœ€å¤§åŒ–åˆ©ç”¨ CPUèµ„æºã€‚æ¯”å¦‚ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š</p><ul><li>ä¼‘çœ </li><li>channel é€šé“é˜»å¡</li><li>ç½‘ç»œ I/O é˜»å¡</li><li>å› ä¸ºæ‰§è¡Œåƒåœ¾å›æ”¶è€Œæš‚åœ</li></ul><h3 id="ç³»ç»Ÿè°ƒç”¨ç»“æŸæ—¶-exitsyscall">5.2 ç³»ç»Ÿè°ƒç”¨ç»“æŸæ—¶exitsyscall()</h3><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/e6c9d24egy1h57vx0tfayj21g60r4tb4.jpg"alt="exitsyscall åç¨‹åˆ‡æ¢" /><figcaption aria-hidden="true">exitsyscall åç¨‹åˆ‡æ¢</figcaption></figure><p>Go é€šè¿‡ <code>entersyscall()</code> è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œå®Œäº‹åä¼šæ‰§è¡Œ<code>exitsyscall()</code>ï¼Œå®ƒä¹Ÿä½äº <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/proc.go">runtime/proc.go</a>ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">exitsyscall</span><span class="hljs-params">()</span></span> &#123;<br>...<br>mcall(exitsyscall0)<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶å®å®ƒæœ€ç»ˆä¹Ÿæ˜¯è°ƒç”¨ <code>mcall()</code> åˆ‡æ¢åˆ° <code>g0</code>ï¼Œæˆ‘ä»¬ä¸éš¾çŒœå‡ºï¼Œå®ƒè¿™é‡Œè®© <code>g0</code> å»æ‰§è¡Œ <code>exitsyscall0</code>å‡½æ•°ï¼Œåšå®Œç³»ç»Ÿè°ƒç”¨çš„å–„ååï¼Œè‚¯å®šè¿˜æ˜¯ä¼šæ‰§è¡Œ <code>schedule()</code>å‡½æ•°è¿›è¡Œåç¨‹è°ƒåº¦ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">exitsyscall0</span><span class="hljs-params">(gp *g)</span></span> &#123;<br>...<br>schedule()<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å‡½æ•°è·³è½¬æ—¶-morestack">5.3 å‡½æ•°è·³è½¬æ—¶ morestack()</h3><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/e6c9d24egy1h57w74gg19j21iq0smwgs.jpg"alt="morestack åç¨‹åˆ‡æ¢" /><figcaption aria-hidden="true">morestack åç¨‹åˆ‡æ¢</figcaption></figure><p>å› ä¸ºå‡½æ•°è·³è½¬æ„å‘³ç€â€œå‹æ ˆâ€ï¼Œå‡½æ•°è·³è½¬æ—¶éƒ½ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œå®ƒçš„æœ¬æ„åœ¨äºæ£€æŸ¥å½“å‰åç¨‹æ ˆç©ºé—´æ˜¯å¦æœ‰è¶³å¤Ÿå†…å­˜ï¼Œå¦‚æœä¸å¤Ÿå°±è¦æ‰©å¤§è¯¥æ ˆç©ºé—´ã€‚</p><p>ä¸ºäº†è®©æ¯ä¸ªåç¨‹éƒ½æœ‰æ‰§è¡Œçš„æœºä¼šï¼Œå¹¶ä¸”æœ€å¤§åŒ–åˆ©ç”¨ CPU èµ„æºï¼ŒGoè¯­è¨€åœ¨åˆå§‹åŒ–æ—¶ä¼šå¯åŠ¨ä¸€ä¸ªç‰¹æ®Šçš„çº¿ç¨‹æ¥æ‰§è¡Œç³»ç»Ÿç›‘æ§ä»»åŠ¡ï¼Œç³»ç»Ÿç›‘æ§åœ¨ä¸€ä¸ªç‹¬ç«‹çš„M ä¸Šè¿è¡Œï¼Œä¸ç”¨ç»‘å®šé€»è¾‘å¤„ç†å™¨ Pã€‚å½“ç³»ç»Ÿç›‘æ§åˆ°åç¨‹è¿è¡Œè¶…è¿‡<code>10ms</code>ï¼Œå°±å°† <code>g.stackguard0</code> ç½®ä¸º<code>stackPreempt</code>ï¼ˆè¯¥å€¼æ˜¯ä¸€ä¸ªæŠ¢å æ ‡å¿—ï¼‰ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">const</span> forcePreemptNS = <span class="hljs-number">10</span> * <span class="hljs-number">1000</span> * <span class="hljs-number">1000</span> <span class="hljs-comment">// 10ms</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">retake</span><span class="hljs-params">(now <span class="hljs-type">int64</span>)</span></span> <span class="hljs-type">uint32</span> &#123;<br><span class="hljs-comment">// éå†æ‰€æœ‰çš„ P</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(allp); i++ &#123;<br>pp := allp[i]<br>pd := &amp;pp.sysmontick<br>s := pp.status<br>sysretake := <span class="hljs-literal">false</span><br><span class="hljs-keyword">if</span> s == _Prunning || s == _Psyscall &#123;<br>t := <span class="hljs-type">int64</span>(pp.schedtick)<br><span class="hljs-keyword">if</span> <span class="hljs-type">int64</span>(pd.schedtick) != t &#123;<br>pd.schedtick = <span class="hljs-type">uint32</span>(t)<br>pd.schedwhen = now<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> pd.schedwhen+forcePreemptNS &lt;= now &#123;<br>        <span class="hljs-comment">// å¦‚æœ G è¿è¡Œæ—¶é—´è¿‡é•¿ï¼Œè¶…è¿‡äº† forcePreemptNS(10ms)ï¼Œ</span><br>        <span class="hljs-comment">// åˆ™æ ‡è®°æŠ¢å </span><br>preemptone(pp)<br>sysretake = <span class="hljs-literal">true</span><br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> s == _Psyscall &#123;<br>      <span class="hljs-comment">// å¦‚æœæ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œä¸”å·²ç»è¶…è¿‡äº†ä¸€ä¸ªç³»ç»Ÿç›‘æ§çš„ tick(20us)ï¼Œ</span><br>      <span class="hljs-comment">// åˆ™ä»ç³»ç»Ÿè°ƒç”¨ä¸­æŠ¢å  pã€‚</span><br>      t := <span class="hljs-type">int64</span>(pp.syscalltick)<br><span class="hljs-keyword">if</span> !sysretake &amp;&amp; <span class="hljs-type">int64</span>(pd.syscalltick) != t &#123;<br>pd.syscalltick = <span class="hljs-type">uint32</span>(t)<br>pd.syscallwhen = now<br><span class="hljs-keyword">continue</span><br>&#125;<br>...<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// æ ‡è®°æŠ¢å </span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">preemptone</span><span class="hljs-params">(pp *p)</span></span> <span class="hljs-type">bool</span> &#123;<br>mp := pp.m.ptr()<br>gp := mp.curg<br>gp.preempt = <span class="hljs-literal">true</span><br>gp.stackguard0 = stackPreempt<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å·§çš„å°±æ˜¯ï¼ŒGo è®¾è®¡è€…ï¼Œè®©ç¨‹åºåœ¨æ‰§è¡Œ <code>morestack()</code>å‡½æ•°æ—¶é¡ºä¾¿åˆ¤æ–­ä¸€ä¸‹ <code>g</code> ä¸­çš„ <code>stackguard</code>æ˜¯å¦å·²ç»è¢«ç½®ä¸ºæŠ¢å  <code>stackPreempt</code>ï¼Œå¦‚æœçš„ç¡®è¢«æ ‡è®°æŠ¢å ï¼Œå°±å›åˆ°<code>schedule()</code> æ–¹æ³•ï¼Œå¹¶å°†å½“å‰åç¨‹æ”¾å›é˜Ÿåˆ—ä¸­ã€‚</p><p><code>morestack</code> æ˜¯æ±‡ç¼–å®ç°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs assembly">TEXT runtimeÂ·morestack(SB),NOSPLIT|NOFRAME,$0-0<br>...<br>BLruntimeÂ·newstack(SB)<br></code></pre></td></tr></table></figure><p>å®ƒæœ€ç»ˆä¼šè°ƒç”¨ <code>newstack()</code>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newstack</span><span class="hljs-params">()</span></span> &#123;<br>  thisg := getg()<br>  gp := thisg.m.curg<br>  <span class="hljs-comment">// 1. åˆ¤æ–­ gp.stackguard0 æ˜¯å¦è¢«æ ‡è®°ä¸ºæŠ¢å </span><br>  stackguard0 := atomic.Loaduintptr(&amp;gp.stackguard0)<br>preempt := stackguard0 == stackPreempt<br>  <span class="hljs-comment">// 2. å¦‚æœè¢«æ ‡è®°ä½æŠ¢å ï¼Œè°ƒç”¨ gopreempt_m()</span><br>  <span class="hljs-keyword">if</span> preempt &#123;<br><span class="hljs-comment">// 3. æœ€ç»ˆä¼šå»è°ƒç”¨  schedule() å»è°ƒæ–°çš„åç¨‹æ‰§è¡Œ</span><br>gopreempt_m(gp) <span class="hljs-comment">// never return</span><br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">gopreempt_m</span><span class="hljs-params">(gp *g)</span></span> &#123;<br><span class="hljs-keyword">if</span> traceEnabled() &#123;<br>traceGoPreempt()<br>&#125;<br>goschedImpl(gp)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">goschedImpl</span><span class="hljs-params">(gp *g)</span></span> &#123;<br>...<br>schedule()<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ä¿¡å·è°ƒåº¦-dosigpreempt">5.4 ä¿¡å·è°ƒåº¦ doSigPreempt()</h3><p>å½“ç¨‹åºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ—¢æ— æ³•ä¸»åŠ¨æŒ‚èµ·ï¼Œä¹Ÿä¸èƒ½è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œä¸”æ— æ³•è¿›è¡Œå‡½æ•°è°ƒç”¨æ—¶ï¼Œå°±å¯ä»¥ä½¿ç”¨ä¿¡å·æ¥è°ƒåº¦ã€‚</p><p>ä¿¡å·å…¶å®å°±æ˜¯çº¿ç¨‹ä¿¡å·ï¼Œåœ¨æ“ä½œç³»ç»Ÿä¸­æœ‰å¾ˆå¤šåŸºäºä¿¡å·çš„åº•å±‚é€šä¿¡æ–¹å¼ï¼ˆSIGPIPE/ SIGURG / SIGHUPï¼‰ï¼Œè€Œæˆ‘ä»¬çš„çº¿ç¨‹å¯ä»¥æ³¨å†Œå¯¹åº”ä¿¡å·çš„å¤„ç†å‡½æ•°ã€‚</p><p>Go ä¸­æ˜¯æ³¨å†Œäº† <code>SIGURG</code> ä¿¡å·çš„å¤„ç†å‡½æ•°<code>doSigPreempt()</code>ï¼Œåœ¨ GCå·¥ä½œæ—¶ï¼Œå‘ç›®æ ‡çº¿ç¨‹å‘é€ä¿¡å·ã€‚çº¿ç¨‹æ”¶åˆ°ä¿¡å·åï¼Œä¼šè§¦å‘è°ƒåº¦ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/e6c9d24egy1h57wecvgwdj21hk0ssgny.jpg"alt="doSigPreempt åç¨‹åˆ‡æ¢" /><figcaption aria-hidden="true">doSigPreempt åç¨‹åˆ‡æ¢</figcaption></figure><p><code>doSigPreempt</code> ä½äº <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/signal_unix.go">runtime.signal_unix.go</a>ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">doSigPreempt</span><span class="hljs-params">(gp *g, ctxt *sigctxt)</span></span> &#123;<br><span class="hljs-comment">// æ£€æŸ¥æ­¤ g æ˜¯å¦è¦è¢«æŠ¢å å¹¶ä¸”å®‰å…¨æŠ¢å </span><br><span class="hljs-keyword">if</span> wantAsyncPreempt(gp) &#123;<br><span class="hljs-keyword">if</span> ok, newpc := isAsyncSafePoint(gp, ctxt.sigpc(), ctxt.sigsp(), ctxt.siglr()); ok &#123;<br><span class="hljs-comment">// 2. è°ƒæ•´ç¨‹åºè®¡æ•°å™¨ PC å¹¶å¼‚æ­¥è°ƒç”¨ asyncPreempt</span><br>ctxt.pushCall(abi.FuncPCABI0(asyncPreempt), newpc)<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>asyncPreempt</code> çš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">asyncPreempt</span><span class="hljs-params">()</span></span><br><br><span class="hljs-comment">// </span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">asyncPreempt2</span><span class="hljs-params">()</span></span> &#123;<br>gp := getg()<br>gp.asyncSafePoint = <span class="hljs-literal">true</span><br>  <span class="hljs-comment">// </span><br><span class="hljs-keyword">if</span> gp.preemptStop &#123;<br>mcall(preemptPark)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>mcall(gopreempt_m)<br>&#125;<br>gp.asyncSafePoint = <span class="hljs-literal">false</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>asyncPreempt</code> æ˜¯æ±‡ç¼–å®ç°ï¼Œæœ€ç»ˆæ˜¯è°ƒçš„<code>asyncPreempt2</code>ï¼Œå®ƒä¼šè°ƒç”¨ <code>mcall</code> åˆ‡å›<code>g0</code>ï¼Œå¹¶æ‰§è¡Œ <code>preemptPark</code> æˆ–<code>gopreempt_m</code>ï¼Œ <code>gopreempt_m</code> å°±æ˜¯å‰é¢<code>morestack</code> æœ€åè°ƒçš„ï¼ä¸å‡ºæ„å¤–ï¼Œ<code>preemptPack</code>æœ€åè‚¯å®šè¿˜æ˜¯è°ƒçš„ <code>schedule()</code>ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">preemptPark</span><span class="hljs-params">(gp *g)</span></span> &#123;<br>...<br>schedule()<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="runtime.gosched">5.5 runtime.Gosched()</h3><p>åœ¨æˆ‘ä»¬å®é™…ç¼–ç¨‹ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡æ˜¾å¼è°ƒç”¨ <code>runtime.Gosched()</code>æ¥ä¸»åŠ¨è®©å‡º CPUï¼Œä¿ƒè¿› Go çš„ä¸‹ä¸€è½®è°ƒåº¦ï¼Œæˆ‘ä»¬æ¥çœ‹å®ƒçš„å…·ä½“å®ç°ï¼Œè‚¯å®šè¿˜æ˜¯è°ƒçš„<code>schedule()</code>ï¼Œæ²¡æœ‰æ„å¤–ï¼</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Gosched</span><span class="hljs-params">()</span></span> &#123;<br>checkTimeouts()<br>mcall(gosched_m)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">gosched_m</span><span class="hljs-params">(gp *g)</span></span> &#123;<br><span class="hljs-keyword">if</span> traceEnabled() &#123;<br>traceGoSched()<br>&#125;<br>goschedImpl(gp)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">goschedImpl</span><span class="hljs-params">(gp *g)</span></span> &#123;<br>status := readgstatus(gp)<br><span class="hljs-keyword">if</span> status&amp;^_Gscan != _Grunning &#123;<br>dumpgstatus(gp)<br>throw(<span class="hljs-string">&quot;bad g status&quot;</span>)<br>&#125;<br>casgstatus(gp, _Grunning, _Grunnable)<br>dropg()<br>lock(&amp;sched.lock)<br>globrunqput(gp)<br>unlock(&amp;sched.lock)<br><br>schedule()<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ€»ç»“">5.6 æ€»ç»“</h3><p>Go è¯­è¨€ä¸ºäº†ç¡®ä¿ P ä¸ä¼šå› ä¸º Gè¿è¡Œæ—¶é—´è¿‡é•¿æˆ–ç³»ç»Ÿè°ƒç”¨é˜»å¡æ—¶é—´è¿‡é•¿è€Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚å®ƒä¼šå°è¯•è¿›è¡Œåç¨‹åˆ‡æ¢ï¼Œä»¥ç¡®ä¿ä»»åŠ¡å¯ä»¥é€‚æ—¶åœ°è¢«åˆ†é…å’Œæ‰§è¡Œã€‚è¿™æœ‰åŠ©äºä¿æŒGoç¨‹åºçš„å¹¶å‘æ€§èƒ½å’Œå“åº”æ€§ã€‚è€Œåç¨‹åˆ‡æ¢çš„æ–¹å¼æœ‰åŸºäºåä½œçš„æŠ¢å å¼è°ƒåº¦ï¼ˆä¸»åŠ¨æŒ‚èµ·<code>runtime.gopark()</code>ï¼Œç³»ç»Ÿè°ƒç”¨ç»“æŸæ—¶<code>exitsyscall()</code>ï¼Œå‡½æ•°è·³è½¬æ—¶<code>morestack()</code>ï¼‰ï¼Œä¹Ÿæœ‰åŸºäºä¿¡å·çš„æŠ¢å å¼è°ƒåº¦<code>doSigPreempt()</code>ï¼Œä»–ä»¬éƒ½æ— ä¸€ä¾‹å¤–çš„æœ€ç»ˆè°ƒç”¨äº†<code>schedule()</code>ã€‚</p><p>æ‰€ä»¥æ€»ç»“ä¸‹æ¥å…¶å®è¿˜æ˜¯è¿™å¼ å›¾ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/e6c9d24egy1h57vi6wrdqj21ho0sqjtn.jpg"alt="Go åç¨‹åˆ‡æ¢" /><figcaption aria-hidden="true">Go åç¨‹åˆ‡æ¢</figcaption></figure><h1 id="gpm-çŠ¶æ€æµè½¬">Gã€Pã€M çŠ¶æ€æµè½¬</h1><p>ç»è¿‡æˆ‘ä»¬å‰é¢çš„åˆ†æï¼Œä½ å¯ä»¥è‡ªè¡Œæ•´ç† Gã€Pã€MçŠ¶æ€çš„æµè½¬ï¼Œè¿™é‡Œæˆ‘ç»™å‡ºå‡ å¼ å›¾ä¾›ä½ å‚è€ƒï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240126224853429.png"alt="Go åç¨‹ï¼ˆGï¼‰çŠ¶æ€è½¬æ¢å›¾" /><figcaption aria-hidden="true">Go åç¨‹ï¼ˆGï¼‰çŠ¶æ€è½¬æ¢å›¾</figcaption></figure><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240126225021035.png"alt="Go å¤„ç†å™¨ï¼ˆPï¼‰çŠ¶æ€è½¬æ¢å›¾" /><figcaption aria-hidden="true">Go å¤„ç†å™¨ï¼ˆPï¼‰çŠ¶æ€è½¬æ¢å›¾</figcaption></figure><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240126225849169.png"alt="Go Mï¼ˆæ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼‰çŠ¶æ€è½¬æ¢" /><figcaption aria-hidden="true">Go Mï¼ˆæ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼‰çŠ¶æ€è½¬æ¢</figcaption></figure><h1 id="æ€»ç»“-1">æ€»ç»“</h1><p>ä»¥ä¸Šä¾¿æ˜¯å¯¹ Go è¯­è¨€ GPM æ¨¡å‹çš„å…¨éƒ¨åˆ†äº«å•¦ï¼GPM æ¨¡å‹ä½¿å¾— Goè¯­è¨€èƒ½å¤Ÿå¹¶å‘æ‰§è¡Œæˆåƒä¸Šä¸‡ä¸ªåç¨‹ã€‚</p><p>ä¸ºäº†å‡å°‘çº¿ç¨‹â€œç›¸å¯¹æ˜‚è´µâ€çš„åˆ‡æ¢ä»£ä»·ï¼ŒGo å¼•å…¥äº† GPMï¼Œå°†å¤§é‡çš„ Goroutineåˆ†é…åˆ°å°‘é‡çš„ç³»ç»Ÿçº¿ç¨‹ä¸Šå»æ‰§è¡Œï¼Œå¹¶åˆ©ç”¨å¤šæ ¸å¹¶è¡Œï¼Œå®ç°æ›´å¼ºå¤§çš„å¹¶å‘ã€‚</p><p>ä¸ºäº†å‡å°å¹¶å‘å†²çªï¼ŒGo åœ¨å…¨å±€é˜Ÿåˆ—çš„åŸºç¡€ä¸Šå¼•å…¥äº†æœ¬åœ°é˜Ÿåˆ—ã€‚</p><p>ä¸ºäº†é¿å…åç¨‹é¥¥é¥¿ï¼ŒGo åˆå¼•å…¥äº†å¤šç§åç¨‹è°ƒåº¦çš„ç­–ç•¥ã€‚</p><p>ä¸ºäº†é¿å…åç¨‹é˜»å¡æµªè´¹ CPUï¼ŒGo å¼•å…¥äº†å¤šç§åç¨‹åˆ‡æ¢çš„æ–¹å¼ã€‚</p><p>Go è¯­è¨€è®¾è®¡è€…è¿›è¡Œäº†å¦‚æ­¤å¤æ‚çš„è°ƒåº¦å™¨å®ç°ï¼Œæœ€ç»ˆäº¤ä»˜ç»™ Gopherçš„ï¼Œä»…ä»…æ˜¯ä¸€ä¸ª <code>go</code>å…³é”®å­—è¿™ä¹ˆç®€å•ï¼ŒçœŸçš„æ˜¯å¤§é“è‡³ç®€ï¼Œè¿™ä¹Ÿæ˜¯å……åˆ†å°è¯äº†é‚£å¥è¯ï¼šâ€œGoä¸ºå¹¶å‘è€Œç”Ÿâ€ã€‚</p><p>å¸Œæœ›æœ¬æ–‡èƒ½å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œenjoy~ happy coding~</p><h1 id="å‚è€ƒ">å‚è€ƒ</h1><ul><li><a href="https://book.douban.com/subject/36403287/">æ·±å…¥ç†è§£ Goè¯­è¨€</a></li><li><a href="https://book.douban.com/subject/35556889/">Goè¯­è¨€åº•å±‚åŸç†å‰–æ</a></li><li><a href="https://coding.imooc.com/class/576.html">æ·±å…¥ Goåº•å±‚åŸç†</a></li><li>ChatGPT4</li></ul><h1 id="ä½œå›¾å·¥å…·">ä½œå›¾å·¥å…·</h1><ul><li><a href="https://excalidraw.com/">excalidraw</a></li><li><a href="https://whimsical.com/">whimsical</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Rust å®æˆ˜ä¸¨ç»˜åˆ¶æ›¼å¾·åšé›†</title>
    <link href="/2024/01/17/rust-action-mandelbrot/"/>
    <url>/2024/01/17/rust-action-mandelbrot/</url>
    
    <content type="html"><![CDATA[<h1 id="æ›¼å¾·åšé›†">æ›¼å¾·åšé›†</h1><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/2560px-Mandelset_hires-20240118170914026.png"alt="æ›¼å¾·åšé›†" /><figcaption aria-hidden="true">æ›¼å¾·åšé›†</figcaption></figure><p>æ›¼å¾·åšé›†å…¶å®æ˜¯ä¸€ä¸ªâ€œæ²¡ä»€ä¹ˆç”¨â€çš„å‘ç°ã€‚</p><p>æ›¼å¾·åšé›†ï¼ˆMandelbrotSetï¼‰æ˜¯ä¸€ç§åœ¨å¤å¹³é¢ä¸Šå½¢æˆç‹¬ç‰¹ä¸”å¤æ‚å›¾æ¡ˆçš„ç‚¹çš„é›†åˆã€‚è¿™ä¸ªé›†åˆæ˜¯ä»¥æ•°å­¦å®¶æœ¬åÂ·æ›¼å¾·åšï¼ˆBenoitMandelbrotï¼‰çš„åå­—å‘½åçš„ï¼Œä»–åœ¨ç ”ç©¶å¤æ‚ç»“æ„å’Œæ··æ²Œç†è®ºæ—¶å‘ç°äº†è¿™ä¸ªé›†åˆã€‚æ›¼å¾·åšé›†æ˜¯åˆ†å½¢å‡ ä½•çš„ä¸€ä¸ªç»å…¸ä¾‹å­ï¼Œæ˜¾ç¤ºäº†ä¸€ä¸ªç®€å•çš„æ•°å­¦å…¬å¼å¦‚ä½•èƒ½äº§ç”Ÿæ— é™å¤æ‚å’Œç¾ä¸½çš„å›¾æ¡ˆã€‚</p><p>æ›¼å¾·åšé›†çš„å®šä¹‰ç›¸å¯¹ç®€å•ã€‚å¯¹äºæ¯ä¸€ä¸ªå¤æ•° <spanclass="math inline">\(c\)</span>ï¼Œæˆ‘ä»¬è€ƒè™‘ä»¥ä¸‹è¿­ä»£åºåˆ—ï¼š <spanclass="math display">\[Z_{n+1} = z_n^2 + c \;\;\\ å…¶ä¸­ \;\; (z_0 = 0)\]</span> <strong>æ›¼å¾·åšé›†åˆç”±é‚£äº›ä½¿å¾—ä¸Šè¿°åºåˆ—ä¸è¶‹äºæ— é™å¤§çš„å¤æ•° <spanclass="math inline">\(c\)</span>ç»„æˆ</strong>ã€‚åœ¨å¤å¹³é¢ä¸Šï¼Œè¿™äº›ç‚¹å½¢æˆäº†ä¸€ç§ç‹¬ç‰¹çš„å›¾æ¡ˆï¼Œé€šå¸¸ä»¥ä¸€ç§ç¾ä¸½ä¸”è‰ºæœ¯çš„æ–¹å¼å‘ˆç°ã€‚è¿™ä¸ªå›¾æ¡ˆçš„è¾¹ç•Œéå¸¸å¤æ‚ï¼ŒåŒ…å«äº†æ— é™çš„ç»†èŠ‚å’Œè‡ªç›¸ä¼¼çš„ç»“æ„ã€‚è¿™æ„å‘³ç€æ— è®ºä½ æ”¾å¤§å›¾æ¡ˆçš„å“ªä¸€éƒ¨åˆ†ï¼Œä½ éƒ½ä¼šå‘ç°è¶Šæ¥è¶Šç²¾ç»†çš„ç»“æ„ï¼Œè¿™äº›ç»“æ„åœ¨å½¢å¼ä¸Šä¸æ•´ä½“å›¾æ¡ˆç›¸ä¼¼ã€‚</p><p>æ›¼å¾·åšé›†åˆä¸ä»…åœ¨æ•°å­¦ä¸Šæœ‰æ„ä¹‰ï¼Œä¹Ÿåœ¨è‰ºæœ¯å’Œç§‘å­¦ä¸­æœ‰å¹¿æ³›çš„åº”ç”¨ï¼Œå°¤å…¶æ˜¯åœ¨ç ”ç©¶æ··æ²Œç†è®ºå’Œå¤æ‚ç³»ç»Ÿæ—¶ã€‚</p><p>å…·ä½“å¯ä»¥çœ‹</p><ul><li><ahref="https://zh.wikipedia.org/wiki/%E6%9B%BC%E5%BE%B7%E5%8D%9A%E9%9B%86%E5%90%88">ç»´åŸºç™¾ç§‘-æ›¼å¾·åšé›†</a></li><li><a href="https://www.bilibili.com/video/BV1kA411T7at">bilibili -2000äº¿å€æ”¾å¤§æ›¼å¾·åšé›†</a></li></ul><h1 id="ç›®æ ‡åŠŸèƒ½">ç›®æ ‡åŠŸèƒ½</h1><p>æœ€ç»ˆæˆ‘ä»¬å°†å®ç°ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œå®ƒä¼šæ ¹æ®æˆ‘ä»¬è¾“å…¥çš„å‚æ•°ç”Ÿæˆæ›¼å¾·åšé›†å›¾ï¼Œä½¿ç”¨å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./mandelbrot &lt;FILE&gt; &lt;PIXELS&gt; &lt;UPPERLEFT&gt; &lt;LOWERRIGHT&gt;<br></code></pre></td></tr></table></figure><ul><li><code>FILE</code>: æ›¼å¾·åšé›†å›¾ç”Ÿæˆçš„å›¾ç‰‡è·¯ç»ã€‚</li><li><code>PIXELS</code>: å›¾ç‰‡åˆ†è¾¨ç‡ï¼Œå¦‚ <code>4x3</code>ã€‚</li><li><code>UPPERLEFT</code>: æŒ‡å®šåœ¨å¤å¹³é¢ä¸­å›¾ç‰‡è¦†ç›–çš„å·¦ä¸Šè§’ï¼Œå¦‚<code>4.0,3.0</code>ã€‚</li><li><code>LOWERRIGHT</code>: åˆ¶å®šåœ¨å¤å¹³é¢ä¸­å›¾ç‰‡è¦†ç›–çš„å³ä¸‹è§’ã€‚</li></ul><p>æ‰€ä»¥æˆ‘ä»¬æœ€ç»ˆä¼šæ ¹æ®æŒ‡å®šçš„å›¾ç‰‡èŒƒå›´ï¼Œæˆªå– <code>PIXELS</code>åˆ†è¾¨ç‡å¤§å°çš„æ›¼å¾·åšé›†å›¾ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240118171322832.png"alt="æˆªå–æ›¼å¾·åšé›†ç¤ºæ„å›¾" /><figcaption aria-hidden="true">æˆªå–æ›¼å¾·åšé›†ç¤ºæ„å›¾</figcaption></figure><p>åŸºäºä»¥ä¸Šç›®æ ‡ï¼Œæˆ‘ä»¬æ‹†åˆ†æˆå‡ ä¸ªé—®é¢˜ï¼š</p><ol type="1"><li>å¦‚ä½•è¡¨ç¤ºå¤æ•°ï¼Ÿ</li><li>å¦‚ä½•è§£æåˆ†è¾¨ç‡å’Œåæ ‡ï¼Ÿ</li><li>å¦‚ä½•å°†å›¾ä¸Šåƒç´ æ˜ å°„åˆ°å¤æ•°ï¼Ÿ</li><li>å¦‚ä½•ç”Ÿæˆæ›¼å¾·åšé›†å›¾ï¼Ÿå³å¦‚ä½•æ‰¾åˆ°é‚£äº›ç¬¦åˆæ›¼å¾·åšé›†çš„ç‚¹ï¼Œå¹¶å°†å…¶è¿›è¡Œç€è‰²æ ‡æ³¨ï¼Ÿ</li><li>å¦‚ä½•å†™å…¥å›¾ç‰‡æ–‡ä»¶ï¼Ÿ</li><li>å¦‚ä½•æ¸²æŸ“æ›¼å¾·åšé›†ï¼Ÿ</li><li>å¦‚ä½•è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Ÿ</li><li>å¦‚ä½•å¹¶å‘å†™å…¥å›¾ç‰‡æ–‡ä»¶ï¼Ÿ</li></ol><h1 id="èƒ½å­¦åˆ°ä»€ä¹ˆ">èƒ½å­¦åˆ°ä»€ä¹ˆ</h1><ol type="1"><li>æ›¼å¾·åšé›†æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>Rust ä¸­çš„å¤æ•°çš„åŸç†ä¸åº”ç”¨ã€‚</li><li>Rust æ³›å‹åˆæ¢ã€‚</li><li>Rust ä¸­çš„ Option å’Œ Result åˆæ¢ã€‚</li><li>Rust å¹¶å‘åˆæ¢ã€‚</li><li>Rust ä¸­å¦‚ä½•è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Ÿ</li><li>Rust å¦‚ä½•å†™å…¥å›¾åƒæ–‡ä»¶ï¼Ÿ</li><li>Rust å¦‚ä½•å†™æµ‹è¯•ç”¨ä¾‹ï¼Ÿ</li><li>Rust å®ç”¨ crate<code>num</code>ã€<code>image</code>ã€<code>crossbeam</code>ã€‚</li></ol><h1 id="ç‰ˆæœ¬">ç‰ˆæœ¬</h1><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs toml"><span class="hljs-section">[package]</span><br><span class="hljs-attr">name</span> = <span class="hljs-string">&quot;mandelbrot&quot;</span><br><span class="hljs-attr">version</span> = <span class="hljs-string">&quot;0.1.0&quot;</span><br><span class="hljs-attr">edition</span> = <span class="hljs-string">&quot;2021&quot;</span><br><br><span class="hljs-section">[dependencies]</span><br><span class="hljs-attr">image</span> = &#123;version = <span class="hljs-string">&quot;0.13.0&quot;</span>, features = [<span class="hljs-string">&quot;default&quot;</span>, <span class="hljs-string">&quot;png&quot;</span>]&#125;<br><span class="hljs-attr">num</span> = <span class="hljs-string">&quot;0.4.1&quot;</span><br><span class="hljs-attr">crossbeam</span> = <span class="hljs-string">&quot;0.8&quot;</span><br></code></pre></td></tr></table></figure><p>å®Œæ•´ä»£ç ï¼šhttps://github.com/hedon954/mandelbrot/blob/master/src/main.rs</p><h1 id="ç¼–ç å®ç°">ç¼–ç å®ç°</h1><h2 id="åˆ›å»ºé¡¹ç›®">0. åˆ›å»ºé¡¹ç›®</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo new mandelbrot<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> mandelbrot<br></code></pre></td></tr></table></figure><h2 id="å¤æ•°è¡¨ç¤º">1. å¤æ•°è¡¨ç¤º</h2><p>ä½¿ç”¨å¤æ•°ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥ä¸€ä¸ª creteï¼š<code>num</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo add num<br></code></pre></td></tr></table></figure><p>å…¶ä¸­å®šä¹‰äº†ä¸€ä¸ªå¤æ•°ç±»å‹ <code>Complex</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Complex</span>&lt;T&gt; &#123;<br>    <span class="hljs-comment">/// å¤æ•°çš„å®éƒ¨</span><br>    <span class="hljs-keyword">pub</span> re: T,<br>    <span class="hljs-comment">/// å¤æ•°çš„è™šéƒ¨</span><br>    <span class="hljs-keyword">pub</span> im: T,<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œ <code>T</code> æ˜¯ Rust ä¸­çš„æ³›å‹åŠŸèƒ½ï¼Œè¡¨ç¤ºä»»æ„ç±»å‹<code>T</code>ï¼Œç¡®å®šå¥½è¿™ä¸ªç»“æ„ä½“çš„ <code>T</code> çš„ç±»å‹åï¼Œå…¶ä¸­çš„å±æ€§<code>re</code> å’Œ <code>im</code> çš„ç±»å‹ä¹Ÿå°±éšä¹‹ç¡®å®šäº†ã€‚</p><h2 id="è§£æåˆ†è¾¨ç‡å’Œåæ ‡">2. è§£æåˆ†è¾¨ç‡å’Œåæ ‡</h2><ul><li>åˆ†è¾¨ç‡æ ¼å¼ä¸ºï¼š4000x3000</li><li>åæ ‡æ ¼å¼ä¸ºï¼š-1.0,2.0</li></ul><h3 id="è§£ææ•°å¯¹">2.1 è§£ææ•°å¯¹</h3><p>æˆ‘ä»¬è¦åšçš„å°±æ˜¯ï¼Œå°†åˆ†è¾¨ç‡æ‹†æˆ (4000,3000)ï¼Œå°†åæ ‡æ‹†ä¸º (-1.0,2.0)ã€‚è¿™é‡Œï¼š</p><ul><li>å¸¦è§£æçš„å…ƒç´  <code>s</code> æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²<code>&amp;str</code>ã€‚</li><li>åˆ†éš”ç¬¦ <code>separator</code> æ˜¯ä¸€ä¸ªå­—ç¬¦ <code>char</code>ã€‚</li><li>è¿”å›å€¼æ˜¯ä¸€ä¸ªå…ƒç»„ <code>(T, T)</code>ï¼Œå…¶ä¸­ <code>T</code> è¿™é‡Œå¯ä»¥æ˜¯u64/f32 ç­‰æ•°å­—ï¼Œå®ƒä»¬éƒ½éœ€è¦èƒ½ä»å­—ç¬¦ä¸²è½¬åŒ–è€Œæ¥ï¼Œå³<code>&lt;T:FromStr&gt;</code>ã€‚</li><li>å› ä¸ºè§£æå¯èƒ½å‡ºé”™ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ <code>Option</code> æ¥æ‰¿è½½ã€‚</li></ul><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">/// æŠŠå­—ç¬¦ä¸² `s`ï¼ˆå½¢å¦‚ `&quot;400Ã—600&quot;` æˆ– ``&quot;1.0,0.5&quot;ï¼‰è§£ææˆä¸€ä¸ªåæ ‡å¯¹</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// å…·ä½“æ¥è¯´ï¼Œ`s` åº”è¯¥å…·æœ‰&lt;left&gt;&lt;sep&gt;&lt;right&gt;çš„æ ¼å¼ï¼Œå…¶ä¸­&lt;sep&gt;æ˜¯ç”±`separator`</span><br><span class="hljs-comment">/// å‚æ•°ç»™å‡ºçš„å­—ç¬¦ï¼Œè€Œ&lt;left&gt;å’Œ&lt;right&gt;æ˜¯å¯ä»¥è¢« `T:from_str` è§£æçš„å­—ç¬¦ä¸²ã€‚</span><br><span class="hljs-comment">/// `separator` å¿…é¡»æ˜¯ ASCII å­—ç¬¦</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// å¦‚æœ `s` å…·æœ‰æ­£ç¡®çš„æ ¼å¼ï¼Œå°±è¿”å› `Some(x,y)`ï¼Œå¦åˆ™è¿”å› `None`</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">parse_pair</span>&lt;T: FromStr&gt;(s: &amp;<span class="hljs-type">str</span>, separator: <span class="hljs-type">char</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;(T, T)&gt; &#123;<br>    <span class="hljs-keyword">match</span> s.<span class="hljs-title function_ invoke__">find</span>(separator) &#123;<br>        <span class="hljs-literal">None</span> =&gt; <span class="hljs-literal">None</span>,<br>        <span class="hljs-title function_ invoke__">Some</span>(index) =&gt; <span class="hljs-keyword">match</span> (T::<span class="hljs-title function_ invoke__">from_str</span>(&amp;s[..index]), T::<span class="hljs-title function_ invoke__">from_str</span>(&amp;s[index + <span class="hljs-number">1</span>..])) &#123;<br>            (<span class="hljs-title function_ invoke__">Ok</span>(l), <span class="hljs-title function_ invoke__">Ok</span>(r)) =&gt; <span class="hljs-title function_ invoke__">Some</span>((l, r)),<br>            _ =&gt; <span class="hljs-literal">None</span>,<br>        &#125;,<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥å†™å‡ ä¸ªæµ‹è¯•ç”¨ä¾‹æ¥éªŒè¯ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„æ­£ç¡®æ€§ï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨åˆ°<code>#[test]</code> å’Œ <code>assert_eq!</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[test]</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">test_parse_pair</span>() &#123;<br>    <span class="hljs-built_in">assert_eq!</span>(parse_pair::&lt;<span class="hljs-type">i32</span>&gt;(<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&#x27;,&#x27;</span>), <span class="hljs-literal">None</span>);<br>    <span class="hljs-built_in">assert_eq!</span>(parse_pair::&lt;<span class="hljs-type">i32</span>&gt;(<span class="hljs-string">&quot;10,&quot;</span>, <span class="hljs-string">&#x27;,&#x27;</span>), <span class="hljs-literal">None</span>);<br>    <span class="hljs-built_in">assert_eq!</span>(parse_pair::&lt;<span class="hljs-type">i32</span>&gt;(<span class="hljs-string">&quot;,10&quot;</span>, <span class="hljs-string">&#x27;,&#x27;</span>), <span class="hljs-literal">None</span>);<br>    <span class="hljs-built_in">assert_eq!</span>(parse_pair::&lt;<span class="hljs-type">i32</span>&gt;(<span class="hljs-string">&quot;10,20&quot;</span>, <span class="hljs-string">&#x27;,&#x27;</span>), <span class="hljs-title function_ invoke__">Some</span>((<span class="hljs-number">10</span>, <span class="hljs-number">20</span>)));<br>    <span class="hljs-built_in">assert_eq!</span>(parse_pair::&lt;<span class="hljs-type">i32</span>&gt;(<span class="hljs-string">&quot;10,20xy&quot;</span>, <span class="hljs-string">&#x27;,&#x27;</span>), <span class="hljs-literal">None</span>);<br>    <span class="hljs-built_in">assert_eq!</span>(parse_pair::&lt;<span class="hljs-type">f64</span>&gt;(<span class="hljs-string">&quot;0.5x&quot;</span>, <span class="hljs-string">&#x27;x&#x27;</span>), <span class="hljs-literal">None</span>);<br>    <span class="hljs-built_in">assert_eq!</span>(parse_pair::&lt;<span class="hljs-type">f64</span>&gt;(<span class="hljs-string">&quot;0.5x1.5&quot;</span>, <span class="hljs-string">&#x27;x&#x27;</span>), <span class="hljs-title function_ invoke__">Some</span>((<span class="hljs-number">0.5</span>, <span class="hljs-number">1.5</span>)));<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="è½¬ä¸ºå¤æ•°">2.2 è½¬ä¸ºå¤æ•°</h3><p>æˆ‘ä»¬éœ€è¦çš„å‚æ•° <code>upper_left</code> å’Œ <code>lower_right</code>éƒ½æ˜¯å¤å¹³é¢ä¸­çš„ä¸€ä¸ªç‚¹ï¼Œæ‰€ä»¥ä»å­—ç¬¦ä¸²ä¸­å°†æ•°å¯¹è§£æå®Œæ¯•åï¼Œæˆ‘ä»¬å°†å…¶èµ‹å€¼åˆ°å¤æ•°çš„å®éƒ¨å’Œè™šéƒ¨ï¼Œè½¬ä¸ºå¤æ•°å®ä¾‹ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// æŠŠä¸€å¯¹ç”¨é€—å·éš”å¼€çš„æµ®ç‚¹æ•°è§£æä¸ºå¤æ•°</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">parse_complex</span>(s: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;Complex&lt;<span class="hljs-type">f64</span>&gt;&gt; &#123;<br>    <span class="hljs-keyword">match</span> <span class="hljs-title function_ invoke__">parse_pair</span>(s, <span class="hljs-string">&#x27;,&#x27;</span>) &#123;<br>        <span class="hljs-title function_ invoke__">Some</span>((re, im)) =&gt; <span class="hljs-title function_ invoke__">Some</span>(Complex &#123; re, im &#125;),<br>        <span class="hljs-literal">None</span> =&gt; <span class="hljs-literal">None</span>,<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å°†åƒç´ ç‚¹æ˜ å°„æˆå¤æ•°">3. å°†åƒç´ ç‚¹æ˜ å°„æˆå¤æ•°</h2><p>ç¬¬ 2 æ­¥æˆ‘ä»¬å…¶å®ç¡®å®šäº†ä¸¤ä»¶äº‹ï¼š</p><ol type="1"><li>ç¡®å®šæˆªå–æ›¼å¾·åšé›†çš„å“ªä¸€éƒ¨åˆ†ã€‚</li><li>è¦åœ¨è¿™ä¸ªéƒ¨åˆ†ä¸­ç”»å¤šå°‘ä¸ªç‚¹ã€‚</li></ol><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240118174407537.png"alt="ç›®æ ‡åŒºåŸŸä¸­çš„åƒç´ ç‚¹" /><figcaption aria-hidden="true">ç›®æ ‡åŒºåŸŸä¸­çš„åƒç´ ç‚¹</figcaption></figure><p>è¿™ä¸€æ­¥æˆ‘ä»¬éœ€è¦æŠŠ <code>x</code>ç‚¹è½¬ä¸ºå¤æ•°ï¼Œå³ç¡®å®šå®ƒçš„æ¨ªåæ ‡å’Œçºµåæ ‡ã€‚è¿™éƒ¨åˆ†å¯èƒ½éœ€è¦å‘æŒ¥ä¸€ä¸‹ä½ çš„å‡ ä½•æ•°å­¦èƒ½åŠ›äº†ï¼ˆğŸ¤¡ğŸ¤¡ğŸ¤¡ï¼‰ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">/// ç»™å®šè¾“å‡ºå›¾åƒé‡åƒç´ çš„è¡Œå’Œåˆ—ï¼Œè¿”å›å¤å¹³é¢ä¸­å¯¹åº”çš„åæ ‡</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// `pixed` æ˜¯è¡¨ç¤ºç»™å›¾ç‰‡ä¸­ç‰¹å®šåƒç´ çš„ (column, row) äºŒå…ƒç»„ã€‚</span><br><span class="hljs-comment">/// `upper_left` å‚æ•°å’Œ `lower_right` å‚æ•°æ˜¯åœ¨å¤å¹³é¢ä¸­è¡¨ç¤ºæŒ‡å®šå›¾åƒè¦†ç›–èŒƒå›´çš„ç‚¹ã€‚</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">pixed_to_point</span>(<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    Â·--------------------&gt; bounds.0  re</span><br><span class="hljs-comment">    ä¸¨</span><br><span class="hljs-comment">    ä¸¨</span><br><span class="hljs-comment">    ä¸¨</span><br><span class="hljs-comment">    bounds.1  im</span><br><span class="hljs-comment">     */</span><br>    bounds: (<span class="hljs-type">usize</span>, <span class="hljs-type">usize</span>),<br>    pixed: (<span class="hljs-type">usize</span>, <span class="hljs-type">usize</span>),<br>    upper_left: Complex&lt;<span class="hljs-type">f64</span>&gt;,<br>    lower_right: Complex&lt;<span class="hljs-type">f64</span>&gt;,<br>) <span class="hljs-punctuation">-&gt;</span> Complex&lt;<span class="hljs-type">f64</span>&gt; &#123;<br>    <span class="hljs-keyword">let</span> (width, height) = (<br>        lower_right.re - upper_left.re, <span class="hljs-comment">// å³-å·¦</span><br>        upper_left.im - lower_right.im, <span class="hljs-comment">// ä¸Š-ä¸‹</span><br>    );<br><br>    Complex &#123;<br>        re: upper_left.re + pixed.<span class="hljs-number">0</span> <span class="hljs-keyword">as</span> <span class="hljs-type">f64</span> * width / bounds.<span class="hljs-number">0</span> <span class="hljs-keyword">as</span> <span class="hljs-type">f64</span>,<br>        im: upper_left.im - pixed.<span class="hljs-number">1</span> <span class="hljs-keyword">as</span> <span class="hljs-type">f64</span> * height / bounds.<span class="hljs-number">1</span> <span class="hljs-keyword">as</span> <span class="hljs-type">f64</span>,<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">#[test]</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">test_pixed_to_point</span>() &#123;<br>    <span class="hljs-built_in">assert_eq!</span>(<br>        <span class="hljs-title function_ invoke__">pixed_to_point</span>(<br>            (<span class="hljs-number">100</span>, <span class="hljs-number">200</span>),<br>            (<span class="hljs-number">25</span>, <span class="hljs-number">175</span>),<br>            Complex &#123; re: -<span class="hljs-number">1.0</span>, im: <span class="hljs-number">1.0</span> &#125;,<br>            Complex &#123; re: <span class="hljs-number">1.0</span>, im: -<span class="hljs-number">1.0</span> &#125;<br>        ),<br>        Complex &#123;<br>            re: -<span class="hljs-number">0.5</span>,<br>            im: -<span class="hljs-number">0.75</span>,<br>        &#125;<br>    );<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å¯»æ‰¾æ›¼å¾·åšé›†ç‚¹">4. å¯»æ‰¾æ›¼å¾·åšé›†ç‚¹</h2><p>ä»€ä¹ˆæ˜¯æ›¼å¾·åšé›†ç‚¹ï¼Ÿçœ‹çœ‹ä¸Šé¢çš„å®šä¹‰ï¼š<strong>æ›¼å¾·åšé›†åˆç”±é‚£äº›ä½¿å¾—ä¸Šè¿°åºåˆ—ä¸è¶‹äºæ— é™å¤§çš„å¤æ•°<span class="math inline">\(c\)</span> ç»„æˆ</strong>ã€‚</p><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥æ¥è¡¨ç¤ºä¸Šè¿°çš„å…¬å¼ <span class="math inline">\(Z_{n+1} =z_n^2 + c\)</span> äº†ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">complex_square_add_loop</span>(c: Complex&lt;<span class="hljs-type">f64</span>&gt;) &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">z</span> = Complex &#123; re: <span class="hljs-number">0.0</span>, im: <span class="hljs-number">0.0</span> &#125;;<br>    <span class="hljs-keyword">loop</span> &#123;<br>        z = z * z + c<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­æˆ‘ä»¬å°†æ³›å‹ç»“æ„ä½“ <code>Complex</code> çš„ <code>T</code> ç¡®å®šä¸º<code>f64</code>ï¼Œå¹¶ä½¿ç”¨ <code>loop</code> å…³é”®å­—è¿›è¡Œæ— é™å¾ªç¯ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ<strong>æ‰¾åˆ°ä»¤ <code>z</code>ä¸ä¼šâ€œé£åˆ°â€æ— ç©·è¿œçš„ <code>c</code></strong>ã€‚</p><p>ç”±äºå¤æ•° <span class="math inline">\(c\)</span> å…·æœ‰å®éƒ¨ re å’Œè™šéƒ¨imï¼Œå› æ­¤å¯ä»¥æŠŠå®ƒä»¬è§†ä¸ºç¬›å¡å°”å¹³é¢ä¸ŠæŸä¸ªç‚¹çš„ x åæ ‡å’Œ y åæ ‡ï¼Œå¦‚æœ <spanclass="math inline">\(c\)</span>åœ¨æ›¼å¾·åšé›†ä¸­ï¼Œå°±åœ¨å…¶ä¸­ç”¨é»‘è‰²ç€è‰²ï¼Œå¦åˆ™å°±ç”¨æµ…è‰²ã€‚å› æ­¤ï¼Œå¯¹äºå›¾åƒä¸­çš„æ¯ä¸ªåƒç´ ï¼Œå¿…é¡»åœ¨å¤å¹³é¢ä¸Šç›¸åº”ç‚¹ä½è¿è¡Œå‰é¢çš„å¾ªç¯ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦é€ƒé€¸åˆ°æ— ç©·è¿œè¿˜æ˜¯æ°¸è¿œç»•ç€åŸç‚¹è¿è¡Œï¼Œå¹¶ç›¸åº”å°†å…¶ç€è‰²ã€‚</p><p>æ— é™å¾ªç¯è‚¯å®šæ˜¯ä¸ç°å®çš„ï¼Œæˆ‘ä»¬æ€»è¦æ‰¾åˆ°é€€å‡ºå¾ªç¯çš„æœºä¼šï¼Œæœ‰ 2 ä¸ªæ€è·¯ï¼š</p><ol type="1"><li>è¿›è¡Œæœ‰é™æ¬¡æ•°çš„è¿­ä»£ï¼Œè¿™æ ·å¯ä»¥è·å¾—è¯¥é›†åˆçš„ä¸€ä¸ªä¸é”™çš„è¿‘ä¼¼å€¼ï¼Œè¿­ä»£çš„æ¬¡æ•°å–å†³äº†ç²¾åº¦çš„éœ€è¦ï¼›</li><li>ä¸šç•Œå·²è¯æ˜ï¼Œ<strong>ä¸€æ—¦ <code>z</code> ç¦»å¼€äº†ä»¥åŸç‚¹ä¸ºä¸­å¿ƒçš„åŠå¾„ 2çš„åœ†ï¼Œå®ƒæœ€ç»ˆä¸€å®šä¼šâ€œé£åˆ°â€æ— ç©·è¿œ</strong>ã€‚</li></ol><p>æ‰€ä»¥æˆ‘ä»¬æœ€ç»ˆç¡®å®šçš„å‡½æ•°å¦‚ä¸‹ï¼Œå…¶ä¸­ <code>norm_sqr()</code> ä¼šè¿”å›<code>z</code> è·Ÿå¤å¹³é¢åŸç‚¹çš„è·ç¦»çš„å¹³æ–¹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">/// å°è¯•æµ‹è¯• `c` æ˜¯å¦ä½äºæ›¼å¾·åšé›†ä¸­ï¼Œä½¿ç”¨æœ€å¤š `limit` æ¬¡è¿­ä»£æ¥åˆ¤å®š</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// å¦‚æœ `c` ä¸æ˜¯é›†åˆæˆå‘˜ä¹‹ä¸€ï¼Œåˆ™è¿”å› `Some(i)`ï¼Œå…¶ä¸­ `i` æ˜¯ `c` ç¦»å¼€ä»¥åŸç‚¹</span><br><span class="hljs-comment">/// ä¸ºä¸­å¿ƒçš„åŠå¾„ä¸º 2 çš„åœ†æ—¶æ‰€éœ€çš„è¿­ä»£æ¬¡æ•°ã€‚å¦‚æœ `c` ä¼¼ä¹æ˜¯é›†ç¾¤æˆå‘˜ä¹‹ä¸€ï¼ˆç¡®</span><br><span class="hljs-comment">/// åˆ‡è€Œè¨€æ˜¯è¾¾åˆ°äº†è¿­ä»£æ¬¡æ•°é™åˆ¶ä½†ä»ç„¶æ— æ³•è¯æ˜ `c` ä¸æ˜¯æˆå‘˜ï¼‰ï¼Œåˆ™è¿”å› `None`</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">escape_time</span>(c: Complex&lt;<span class="hljs-type">f64</span>&gt;, limit: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-type">usize</span>&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">z</span> = Complex &#123; re: <span class="hljs-number">0.0</span>, im: <span class="hljs-number">0.0</span> &#125;;<br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..limit &#123;<br>        <span class="hljs-keyword">if</span> z.<span class="hljs-title function_ invoke__">norm_sqr</span>() &gt; <span class="hljs-number">4.0</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Some</span>(i);<br>        &#125;<br>        z = z * z + c<br>    &#125;<br>    <span class="hljs-literal">None</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å†™å…¥å›¾ç‰‡æ–‡ä»¶">5. å†™å…¥å›¾ç‰‡æ–‡ä»¶</h2><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>image</code> è¿™ä¸ª crateæ¥å†™å…¥å›¾ç‰‡æ–‡ä»¶ï¼Œå®ƒæ”¯æŒå¤šç§æ ¼å¼å›¾ç‰‡çš„è¯»å†™ï¼Œå¹¶å†…ç½®äº†å¤šç§é¢œè‰²è‰²å€¼ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬å‡†å¤‡ç”Ÿæˆ pngå›¾ç‰‡ï¼Œä¸”éœ€è¦å¯¹å›¾ç‰‡è¿›è¡Œä¸åŒé¢œè‰²çš„ç€è‰²ï¼Œæ‰€ä»¥æˆ‘ä»¬å¼•å…¥ <code>default</code>å’Œ <code>png</code> è¿™ä¸¤ä¸ª featureã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo add image --features default,png<br></code></pre></td></tr></table></figure><h3 id="åˆ›å»ºæ–‡ä»¶-filecreate">5.1 åˆ›å»ºæ–‡ä»¶ File::create()</h3><p>æˆ‘ä»¬å¯ä»¥ç”¨æ ‡å‡†åº“ä¸­çš„ <code>File::create(filename)</code>æ¥åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼ŒæˆåŠŸçš„è¯ä¼šè¿”å›ä¸€ä¸ªæ–‡ä»¶å¥æŸ„ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">output</span> = File::<span class="hljs-title function_ invoke__">create</span>(filename)?;<br></code></pre></td></tr></table></figure><h3 id="å†™å…¥å›¾ç‰‡-pngencoder">5.2 å†™å…¥å›¾ç‰‡ PNGEncoder</h3><p><code>image</code> ä¸­æä¾›äº† <code>PNGEncoder</code> ç”¨äºå†™å…¥ pngå›¾ç‰‡ï¼Œå®ƒæœ‰ä¸¤ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">impl</span>&lt;W: Write&gt; PNGEncoder&lt;W&gt; &#123;<br>    <span class="hljs-comment">/// Create a new encoder that writes its output to ```w```</span><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(w: W) <span class="hljs-punctuation">-&gt;</span> PNGEncoder&lt;W&gt; &#123;<br>        PNGEncoder &#123;<br>            w: w<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/// Encodes the image ```image```</span><br>    <span class="hljs-comment">/// that has dimensions ```width``` and ```height```</span><br>    <span class="hljs-comment">/// and ```ColorType``` ```c```</span><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">encode</span>(<span class="hljs-keyword">self</span>, data: &amp;[<span class="hljs-type">u8</span>], width: <span class="hljs-type">u32</span>, height: <span class="hljs-type">u32</span>, color: ColorType) <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>        <span class="hljs-keyword">let</span> (ct, bits) = color.<span class="hljs-title function_ invoke__">into</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">encoder</span> = png::Encoder::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-keyword">self</span>.w, width, height);<br>        encoder.<span class="hljs-title function_ invoke__">set</span>(ct).<span class="hljs-title function_ invoke__">set</span>(bits);<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">writer</span> = <span class="hljs-built_in">try!</span>(encoder.<span class="hljs-title function_ invoke__">write_header</span>());<br>        writer.<span class="hljs-title function_ invoke__">write_image_data</span>(data).<span class="hljs-title function_ invoke__">map_err</span>(|e| e.<span class="hljs-title function_ invoke__">into</span>())<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>new(w)</code>: ä¼ è¿›ç›®æ ‡ writerï¼Œå³æˆ‘ä»¬ä¸Šé¢åˆ›å»ºçš„<code>output</code>ã€‚</li><li><code>encode()</code>: å†™å…¥å›¾ç‰‡ä¿¡æ¯ï¼Œè¿™é‡Œæœ‰å‡ ä¸ªå‚æ•°ï¼š<ul><li><code>width: u32</code>: å›¾ç‰‡å®½åº¦ã€‚</li><li><code>height: u32</code>: å›¾ç‰‡é«˜åº¦ã€‚</li><li><code>color: ColorType</code>: é¢œè‰²ç±»å‹ï¼Œå¯ä»¥æ˜¯ RGB, Gray(8)ç­‰ã€‚</li><li><code>data: &amp;[u8]</code>: åƒç´ è‰²å€¼åˆ—è¡¨ï¼Œå®ƒçš„é•¿åº¦åº”è¯¥ç”±ä¸Šé¢ 3ä¸ªå­—æ®µå…±åŒå†³å®šï¼Œå¦‚æœé€‰å–çš„é¢œè‰²æ˜¯ RGBï¼Œæ„å‘³ç€éœ€è¦ 3 ä¸ª u8æ‰èƒ½è¡¨ç¤ºä¸€ä¸ªåƒç´ ç‚¹çš„é¢œè‰²ï¼Œæ‰€ä»¥é•¿åº¦ä¸º width * height *3ï¼Œå¦‚æœé€‰å–çš„é¢œè‰²æ˜¯ Gray(8)ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç”¨ 1 ä¸ª u8å°±å¯ä»¥è¡¨ç¤ºä¸€ä¸ªåƒç´ ç‚¹çš„ç°åº¦å€¼ï¼Œæ‰€ä»¥é•¿åº¦ä¸º width * height *1ã€‚æœ¬æ–‡ä¸­æˆ‘ä»¬ä¼šé‡‡ç”¨ Gray(8) æ¥æ±‡æ€»æ›¼å¾·åšé›†çš„é»‘ç™½å›¾ã€‚</li></ul></li></ul><h2 id="æ¸²æŸ“æ›¼å¾·åšé›†">6. æ¸²æŸ“æ›¼å¾·åšé›†</h2><p>è¿™ä¸€æ­¥æˆ‘ä»¬éœ€è¦æ¥ç¡®å®šä¸Šè¿° <code>PNGEncoder::encode()</code> çš„ 4ä¸ªå‚æ•°ï¼š</p><ul><li><p><code>width: u32</code>:å›¾ç‰‡å®½åº¦ç”±å‘½ä»¤è¡Œå‚æ•°ä¸­æŒ‡å®šå³å¯ã€‚</p></li><li><p><code>height: u32</code>:å›¾ç‰‡é«˜åº¦ç”±å‘½ä»¤è¡Œå‚æ•°ä¸­æŒ‡å®šå³å¯ã€‚</p></li><li><p><code>color: ColorType</code>: æœ¬æ–‡æˆ‘ä»¬åªç»˜åˆ¶é»‘ç™½å›¾ï¼Œè¿™é‡Œä½¿ç”¨<code>ColorType::Gray(8)</code>ï¼Œå®ƒè¡¨ç¤ºå›¾åƒæ˜¯ä¸€ä¸ªç°åº¦ï¼ˆå•è‰²ï¼‰å›¾åƒï¼Œæ¯ä¸ªåƒç´ ç”¨8ä½ï¼ˆå³1ä¸ªå­—èŠ‚ï¼‰æ¥è¡¨ç¤ºã€‚åœ¨è¿™ç§æ ¼å¼ä¸­ï¼Œæ¯ä¸ªåƒç´ çš„ç°åº¦å€¼èŒƒå›´æ˜¯0 åˆ° 255ï¼Œå…¶ä¸­ 0 é€šå¸¸è¡¨ç¤ºé»‘è‰²ï¼Œ255è¡¨ç¤ºç™½è‰²ï¼Œä¸­é—´å€¼è¡¨ç¤ºä¸åŒçš„ç°åº¦ã€‚</p></li><li><p><code>data: &amp;[u8]</code>: åƒç´ è‰²å€¼åˆ—è¡¨ï¼Œæˆ‘ä»¬éœ€è¦ç¡®å®š width *height ä¸ªåƒç´ çš„ç°åº¦å€¼ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬æ ¹æ®ç¬¬ 3 æ­¥å°†åƒç´ ç‚¹æ˜ å°„æˆå¤æ•° <spanclass="math inline">\(c\)</span>ï¼Œç„¶åä½¿ç”¨ç¬¬ 4 æ­¥ä¸­çš„<code>escape_time()</code> å‡½æ•°æ¥åˆ¤æ–­å¤æ•° <spanclass="math inline">\(c\)</span>æ˜¯å¦ä½äºæ›¼å¾·åšé›†ä¸­ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ç€é»‘è‰²ï¼Œå³èµ‹å€¼<code>0</code>ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™çœ‹å®ƒè¿­ä»£äº†å¤šå°‘æ¬¡æ‰å¤±è´¥ï¼Œæ¬¡æ•°è¶Šå¤šï¼Œåˆ™è¶Šæ¥è¿‘æ›¼å¾·åšé›†ï¼Œé¢œè‰²è¶Šæ·±ï¼Œå³è¶Šé è¿‘0ï¼Œæ‰€ä»¥èµ‹å€¼ <code>255-time</code>ã€‚</p></li></ul><p>æœ€ç»ˆæˆ‘ä»¬å®ç°çš„å‡½æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">/// å°†æ›¼å¾·åšé›†å¯¹åº”çš„çŸ©å½¢æ¸²æŸ“åˆ°åƒç´ ç¼“å†²åŒºä¸­</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// `bounds` å‚æ•°ä¼šç»™ç¼“å†²åŒº `pixels` çš„å®½åº¦å’Œé«˜åº¦ï¼Œæ­¤ç¼“å†²åŒºçš„æ¯ä¸ªå­—èŠ‚éƒ½</span><br><span class="hljs-comment">/// åŒ…å«ä¸€ä¸ªç°åº¦åƒç´ ã€‚`upper_left` å’Œ `lower_right` å‚æ•°åˆ†åˆ«æŒ‡å®šäº†</span><br><span class="hljs-comment">/// å¤å¹³é¢ä¸­å¯¹åº”äºåƒç´ ç¼“å†²åŒºå·¦ä¸Šè§’å’Œå³ä¸Šè§’çš„ç‚¹ã€‚</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">render</span>(<br>    pixels: &amp;<span class="hljs-keyword">mut</span> [<span class="hljs-type">u8</span>],<br>    bounds: (<span class="hljs-type">usize</span>, <span class="hljs-type">usize</span>),<br>    upper_left: Complex&lt;<span class="hljs-type">f64</span>&gt;,<br>    lower_right: Complex&lt;<span class="hljs-type">f64</span>&gt;,<br>) &#123;<br>    <span class="hljs-built_in">assert_eq!</span>(pixels.<span class="hljs-title function_ invoke__">len</span>(), bounds.<span class="hljs-number">0</span> * bounds.<span class="hljs-number">1</span>);<br><br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">raw</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..bounds.<span class="hljs-number">1</span> &#123;<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">column</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..bounds.<span class="hljs-number">0</span> &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">point</span> = <span class="hljs-title function_ invoke__">pixed_to_point</span>(bounds, (column, raw), upper_left, lower_right);<br>            pixels[raw * bounds.<span class="hljs-number">0</span> + column] = <span class="hljs-keyword">match</span> <span class="hljs-title function_ invoke__">escape_time</span>(point, <span class="hljs-number">255</span>) &#123;<br>                <span class="hljs-literal">None</span> =&gt; <span class="hljs-number">0</span>,<br>                <span class="hljs-title function_ invoke__">Some</span>(count) =&gt; <span class="hljs-number">255</span> - count <span class="hljs-keyword">as</span> <span class="hljs-type">u8</span>,<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="è§£æå‘½ä»¤è¡Œå‚æ•°">7. è§£æå‘½ä»¤è¡Œå‚æ•°</h2><p>æ ¸å¿ƒé€»è¾‘éƒ¨åˆ†åˆ°è¿™é‡Œå…¶å®å°±å®Œæˆäº†ï¼Œç°åœ¨æˆ‘ä»¬è¦åšæœ€åä¸€æ­¥ï¼Œå°±æ˜¯è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Œè®©ç¨‹åºå¯ä»¥æ ¹æ®æˆ‘ä»¬çš„è¦æ±‚ç»˜åˆ¶æ›¼å¾·åšé›†å›¾ã€‚</p><h3 id="è§£æ-stdenvargs">7.1 è§£æ std::env::args()</h3><p>åœ¨ Rustä¸­è§£æå‘½ä»¤è¡Œå‚æ•°çš„ä¸€ä¸ªå¸¸ç”¨æ–¹æ³•æ˜¯ä½¿ç”¨<code>std::env::args</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ªè¿­ä»£å™¨ï¼Œå®ƒåŒ…å«äº†å‘½ä»¤è¡Œä¸Šä¼ é€’ç»™ç¨‹åºçš„æ‰€æœ‰å‚æ•°ã€‚å¯¹äºæ›´å¤æ‚çš„å‘½ä»¤è¡Œå‚æ•°è§£æï¼Œå¯ä»¥ä½¿ç”¨åƒ<code>clap</code>æˆ–<code>structopt</code>è¿™æ ·çš„ç¬¬ä¸‰æ–¹åº“ï¼Œè¿™äº›åº“æä¾›äº†æ›´é«˜çº§çš„åŠŸèƒ½å’Œæ›´å¥½çš„é”™è¯¯å¤„ç†ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨<code>std::env::args</code>çš„åŸºæœ¬ä¾‹å­ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> std::env;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">args</span>: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">String</span>&gt; = env::<span class="hljs-title function_ invoke__">args</span>().<span class="hljs-title function_ invoke__">collect</span>();<br><br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">arg</span> <span class="hljs-keyword">in</span> args.<span class="hljs-title function_ invoke__">iter</span>() &#123;<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, arg);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åŸºç¡€ç‰ˆç¨‹åº">7.2 åŸºç¡€ç‰ˆç¨‹åº</h3><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±å¯ä»¥å®ç°å®Œæ•´çš„åŸºç¡€ç‰ˆç¨‹åºäº†ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>  <span class="hljs-comment">// è¯»å–å‚æ•°</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">args</span>: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">String</span>&gt; = env::<span class="hljs-title function_ invoke__">args</span>().<span class="hljs-title function_ invoke__">collect</span>();<br>  <span class="hljs-comment">// å‚æ•°ä¸ªæ•° = 1 + 4ï¼Œå…¶ä¸­ç¬¬ 1 ä¸ªæ˜¯åº”ç”¨ç¨‹åºå</span><br>    <span class="hljs-keyword">if</span> args.<span class="hljs-title function_ invoke__">len</span>() != <span class="hljs-number">5</span> &#123;<br>        <span class="hljs-built_in">eprintln!</span>(<span class="hljs-string">&quot;Usage: &#123;&#125; FILE PIXELS UPPERLEFT LOWERRIGHT&quot;</span>, args[<span class="hljs-number">0</span>]);<br>        <span class="hljs-built_in">eprintln!</span>(<br>            <span class="hljs-string">&quot;Example: &#123;&#125; mandel.png 1000x700 -1.20,0.35 -1,0.20&quot;</span>,<br>            args[<span class="hljs-number">0</span>]<br>        );<br>        std::process::<span class="hljs-title function_ invoke__">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br><span class="hljs-comment">// è§£æå‚æ•°</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">bounds</span> = <span class="hljs-title function_ invoke__">parse_pair</span>(&amp;args[<span class="hljs-number">2</span>], <span class="hljs-string">&#x27;x&#x27;</span>).<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">&quot;error parsing image dimensions&quot;</span>);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">upper_left</span> = <span class="hljs-title function_ invoke__">parse_complex</span>(&amp;args[<span class="hljs-number">3</span>]).<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">&quot;error parsing upper left corner point&quot;</span>);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">lower_right</span> = <span class="hljs-title function_ invoke__">parse_complex</span>(&amp;args[<span class="hljs-number">4</span>]).<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">&quot;error parsing lower right corner point&quot;</span>);<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">pixels</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">0</span>; bounds.<span class="hljs-number">0</span> * bounds.<span class="hljs-number">1</span>];<br>    <span class="hljs-comment">// æ¸²æŸ“æ›¼å¾·åšé›†</span><br>    <span class="hljs-title function_ invoke__">render</span>(&amp;<span class="hljs-keyword">mut</span> pixels, bounds, upper_left, lower_right);<br>  <span class="hljs-comment">// è¾“å‡ºå›¾ç‰‡</span><br>    <span class="hljs-title function_ invoke__">write_image</span>(&amp;args[<span class="hljs-number">1</span>], &amp;pixels, bounds).<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">&quot;error writing PNG file&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹ç¼–è¯‘ä¸€ä¸‹ç¨‹åºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo build --release<br></code></pre></td></tr></table></figure><p>ä¼šåœ¨ target/release ä¸‹ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ‰§è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./target/release/mandelbrot mandel.png 4000x3000 -1.20,0.35 -1,0.20<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œåä½ åº”è¯¥å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ç”Ÿæˆçš„æ›¼å¾·åšé›†å›¾å¦‚ä¸‹ï¼š</p><figure><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/mandel.png"alt="ç¨‹åºç”Ÿæˆçš„æ›¼å¾·åšé›†" /><figcaption aria-hidden="true">ç¨‹åºç”Ÿæˆçš„æ›¼å¾·åšé›†</figcaption></figure><p>å¤§æ¦‚æ˜¯å¤„äºè¿™ä¸ªä½ç½®ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240118191624303.png"alt="ç¨‹åºæˆªå–çš„å±€éƒ¨æ›¼å¾·åšé›†å¤„äºæ•´ä¸ªæ›¼å¾·åšé›†ä¸­çš„ä½ç½®" /><figcaptionaria-hidden="true">ç¨‹åºæˆªå–çš„å±€éƒ¨æ›¼å¾·åšé›†å¤„äºæ•´ä¸ªæ›¼å¾·åšé›†ä¸­çš„ä½ç½®</figcaption></figure><h2 id="å¹¶å‘æ¸²æŸ“">8. å¹¶å‘æ¸²æŸ“</h2><p>åœ¨ macOS æˆ– linux ç³»ç»Ÿä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>time</code>æ¥è¾“å‡ºç¨‹åºçš„æ‰§è¡Œæ—¶é—´ï¼š</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs txt">time ./target/release/mandelbrot mandel.png 4000x3000 -1.20,0.35 -1,0.20<br>./target/release/mandelbrot mandel.png 4000x3000 -1.20,0.35 -1,0.20  3.30s user 0.01s system 98% cpu 3.341 total<br></code></pre></td></tr></table></figure><p>ç¬”è€…ä½¿ç”¨çš„ç”µè„‘ä¸º macbook Pro m2 max èŠ¯ç‰‡ 32 G å†…å­˜ 12æ ¸ï¼Œå¯ä»¥çœ‹åˆ°åœ¨å•æ ¸æ¨¡å¼ä¸‹ï¼Œå·®ä¸å¤šéœ€è¦ 3~4s çš„æ—¶é—´ã€‚</p><p>å‡ ä¹æ‰€æœ‰çš„ç°ä»£æœºå™¨éƒ½æœ‰å¤šä¸ªå¤„ç†å™¨æ ¸å¿ƒï¼Œè€Œå½“å‰è¿™ä¸ªç¨‹åºåªä½¿ç”¨äº†ä¸€ä¸ªã€‚å¦‚æœå¯ä»¥æŠŠæ­¤å·¥ä½œåˆ†æ´¾ä¸ªæœºå™¨æä¾›çš„å¤šä¸ªå¤„ç†å™¨æ ¸å¿ƒï¼Œåˆ™åº”è¯¥å¯ä»¥æ›´å¿«åœ°ç”»å®Œå›¾åƒã€‚</p><p>ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å°†å›¾åƒåˆ’åˆ†æˆå¤šä¸ªéƒ¨åˆ†ï¼Œæ¯ä¸ªå¤„ç†å™¨è´Ÿè´£å…¶ä¸­çš„ä¸€ä¸ªéƒ¨åˆ†ï¼Œå¹¶è®©æ¯ä¸ªå¤„ç†å™¨ä¸ºåˆ†æ´¾ç»™å®ƒçš„åƒç´ ç€è‰²ã€‚ä¸ºç®€å•èµ·è§ï¼Œå¯ä»¥å°†å…¶åˆ†æˆä¸€äº›æ°´å¹³æ¡å¸¦ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/CleanShot%202024-01-18%20at%2021.28.20.jpg"alt="å°†åƒç´ ç¼“å†²åŒºåˆ’åˆ†ä¸ºä¸€äº›æ¡å¸¦ä»¥è¿›è¡Œå¹¶å‘æ¸²æŸ“" /><figcaptionaria-hidden="true">å°†åƒç´ ç¼“å†²åŒºåˆ’åˆ†ä¸ºä¸€äº›æ¡å¸¦ä»¥è¿›è¡Œå¹¶å‘æ¸²æŸ“</figcaption></figure><p>crossbeam æ˜¯ Rustä¸­çš„ä¸€ä¸ªå¹¶å‘ç¼–ç¨‹å·¥å…·ç®±ï¼Œå®ƒå¹¿æ³›ç”¨äºæä¾›å„ç§å¹¶å‘å’Œå¤šçº¿ç¨‹ç¼–ç¨‹çš„ç»„ä»¶ã€‚</p><p><code>crossbeam::scope</code> æ˜¯ crossbeamæä¾›çš„ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„åŠŸèƒ½ï¼Œå®ƒå…è®¸ä½ å®‰å…¨åœ°åˆ›å»ºä¸´æ—¶çš„çº¿ç¨‹ï¼Œå¹¶ç¡®ä¿è¿™äº›çº¿ç¨‹åœ¨ç¦»å¼€ä½œç”¨åŸŸä¹‹å‰ç»“æŸã€‚</p><p>è¿™é‡Œæˆ‘ä»¬å¼•å…¥ crossbeamï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo add crossbeam<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å°† <code>fn main()</code> ä¸­çš„ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-title function_ invoke__">render</span>(&amp;<span class="hljs-keyword">mut</span> pixels, bounds, upper_left, lower_right);<br></code></pre></td></tr></table></figure><p>æ›¿æ¢æˆï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// ä½¿ç”¨ 8 ä¸ªçº¿ç¨‹æ¥å¹¶å‘æ‰§è¡Œ</span><br><span class="hljs-keyword">let</span> <span class="hljs-variable">threads</span> = <span class="hljs-number">8</span>;<br><span class="hljs-comment">// è®¡ç®—æ¯ä¸ªçº¿ç¨‹è´Ÿè´£æ¸²æŸ“çš„é«˜åº¦ï¼Œå‘ä¸Šå–æ•´</span><br><span class="hljs-keyword">let</span> <span class="hljs-variable">rows_per_band</span> = bounds.<span class="hljs-number">1</span> / threads + <span class="hljs-number">1</span>;<br>&#123;<br>  <span class="hljs-comment">// chunks_mut() ä¼šè¿”å›ä¸€ä¸ªè¿­ä»£å™¨ï¼Œè¯¥è¿­ä»£å™¨ä¼šç”Ÿæˆæ­¤ç¼“å†²åŒºçš„å¯å˜ä¸”ä¸å¯è¿­ä»£çš„åˆ‡ç‰‡</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">bands</span>: <span class="hljs-type">Vec</span>&lt;&amp;<span class="hljs-keyword">mut</span> [<span class="hljs-type">u8</span>]&gt; = pixels.<span class="hljs-title function_ invoke__">chunks_mut</span>(rows_per_band * bounds.<span class="hljs-number">0</span>).<span class="hljs-title function_ invoke__">collect</span>();<br>  <span class="hljs-comment">// crossbeam::scope ç¡®ä¿æ‰€æœ‰å­çº¿ç¨‹åœ¨ä½œç”¨åŸŸç»“æŸä¹‹å‰å®Œæˆï¼Œ</span><br>  <span class="hljs-comment">// è¿™é˜²æ­¢äº†æ‚¬å‚æŒ‡é’ˆå’Œå…¶ä»–æ•°æ®ç«äº‰é—®é¢˜ã€‚</span><br>    crossbeam::<span class="hljs-title function_ invoke__">scope</span>(|spawner| &#123;<br>      <span class="hljs-comment">// éå†åƒç´ ç¼“å†²åŒºçš„å„ä¸ªæ¡å¸¦ï¼Œ</span><br>      <span class="hljs-comment">// è¿™é‡Œ into_iter() è¿­ä»£å™¨ä¼šä¸ºå¾ªç¯ä½“çš„æ¯æ¬¡è¿­ä»£èµ‹äºˆç‹¬å ä¸€ä¸ªæ¡å¸¦çš„æ‰€æœ‰æƒï¼Œ</span><br>      <span class="hljs-comment">// ç¡®ä¿ä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥å†™å…¥å®ƒã€‚</span><br>        <span class="hljs-keyword">for</span> (i, band) <span class="hljs-keyword">in</span> bands.<span class="hljs-title function_ invoke__">into_iter</span>().<span class="hljs-title function_ invoke__">enumerate</span>() &#123;<br>          <span class="hljs-comment">// ç¡®å®šæ¯ä¸ªæ¡å¸¦çš„å‚æ•°</span><br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">top</span> = rows_per_band * i;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">height</span> = band.<span class="hljs-title function_ invoke__">len</span>() / bounds.<span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">band_bounds</span> = (bounds.<span class="hljs-number">0</span>, height);<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">band_upper_left</span> = <span class="hljs-title function_ invoke__">pixed_to_point</span>(bounds, (<span class="hljs-number">0</span>, top), upper_left, lower_right);<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">band_lower_right</span> =<br>                <span class="hljs-title function_ invoke__">pixed_to_point</span>(bounds, (bounds.<span class="hljs-number">0</span>, top + height), upper_left, lower_right);<br>          <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œæ¸²æŸ“å›¾åƒ</span><br>          <span class="hljs-comment">// move è¡¨ç¤ºè¿™ä¸ªé—­åŒ…ä¼šæ¥æ‰‹å®ƒæ‰€ç”¨éå†çš„æ‰€æœ‰æƒï¼Œ</span><br>          <span class="hljs-comment">// æ‰€ä»¥åªæœ‰æ­¤é—­å…³ï¼Œå³åªæœ‰æ­¤çº¿ç¨‹å¯ä»¥ä½¿ç”¨å¯å˜åˆ‡ç‰‡ bandã€‚</span><br>            spawner.<span class="hljs-title function_ invoke__">spawn</span>(<span class="hljs-keyword">move</span> |_| &#123;<br>                <span class="hljs-title function_ invoke__">render</span>(band, band_bounds, band_upper_left, band_lower_right);<br>            &#125;);<br>        &#125;<br>    &#125;)<br>    .<span class="hljs-title function_ invoke__">unwrap</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>å†æ¬¡æ‰§è¡Œï¼š</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs llvm">time ./<span class="hljs-keyword">target</span>/<span class="hljs-keyword">release</span>/mandelbrot mandel.png <span class="hljs-number">4000</span><span class="hljs-keyword">x</span><span class="hljs-number">3000</span> <span class="hljs-number">-1.20</span><span class="hljs-punctuation">,</span><span class="hljs-number">0.35</span> <span class="hljs-number">-1</span><span class="hljs-punctuation">,</span><span class="hljs-number">0.20</span><br>./<span class="hljs-keyword">target</span>/<span class="hljs-keyword">release</span>/mandelbrot mandel.png <span class="hljs-number">4000</span><span class="hljs-keyword">x</span><span class="hljs-number">3000</span> <span class="hljs-number">-1.20</span><span class="hljs-punctuation">,</span><span class="hljs-number">0.35</span> <span class="hljs-number">-1</span><span class="hljs-punctuation">,</span><span class="hljs-number">0.20</span>  <span class="hljs-number">3.57</span>s user <span class="hljs-number">0.01</span>s system <span class="hljs-number">335</span>% cpu <span class="hljs-number">1.067</span> total<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è™½ç„¶æ€»å…±ä½¿ç”¨çš„ CPU æ—¶é—´è¿˜æ˜¯3~4sï¼Œä½†æ˜¯æ•´ä¸ªç¨‹åºçš„æ‰§è¡Œæ—¶é—´åªç¼©çŸ­åˆ° 1s å·¦å³äº†ã€‚</p><p>ä»¥ä¸Šå°±æ˜¯å®ç”¨ Rust ç»˜åˆ¶æ›¼å¾·åšé›†å®æˆ˜çš„å…¨éƒ¨å†…å®¹ï¼Œenjoyï¼Œhappycoding~</p>]]></content>
    
    
    <categories>
      
      <category>Rust</category>
      
      <category>Rust å®æˆ˜</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Rust</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Rust Web æ¡†æ¶ Axum æŒ‡å—</title>
    <link href="/2024/01/14/rust-axum/"/>
    <url>/2024/01/14/rust-axum/</url>
    
    <content type="html"><![CDATA[<h1 id="ç»“è®ºå…ˆè¡Œ">ç»“è®ºå…ˆè¡Œ</h1><h1 id="hello-world">Hello World</h1><p>å…ˆæ¥çœ‹çœ‹ Axum çš„ Hello Worldï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> axum::Router;<br><span class="hljs-keyword">use</span> axum::routing::get;<br><br><span class="hljs-meta">#[tokio::main]</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªåº”ç”¨ï¼Œå¸¦ä¸€ä¸ª / è·¯ç”±ï¼Œè¾“å‡º Hello World</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">app</span> = Router::<span class="hljs-title function_ invoke__">new</span>()<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-title function_ invoke__">get</span>(|| <span class="hljs-keyword">async</span> &#123; <span class="hljs-string">&quot;Hello World!&quot;</span> &#125;));<br><br>    <span class="hljs-comment">// ç›‘å¬ 3000 ç«¯å£</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">listener</span> = tokio::net::TcpListener::<span class="hljs-title function_ invoke__">bind</span>(<span class="hljs-string">&quot;0.0.0.0:3000&quot;</span>).<span class="hljs-keyword">await</span>.<span class="hljs-title function_ invoke__">unwrap</span>();<br><br>    <span class="hljs-comment">// å¯åŠ¨æœåŠ¡</span><br>    axum::<span class="hljs-title function_ invoke__">serve</span>(listener, app).<span class="hljs-keyword">await</span>.<span class="hljs-title function_ invoke__">unwrap</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢è¿™ä¸ªä¾‹å­ï¼Œå¯ä»¥å¾—åˆ°çš„ç¬¬ä¸€ä¸ªä¿¡æ¯å°±æ˜¯ï¼š<code>Axum</code> æ˜¯<code>tokic</code> ç”Ÿæ€ä¸‹çš„ä¸€å‘˜ã€‚</p><blockquote><p>æœ¬æ–‡é»˜è®¤è¯»è€…å¯¹ <code>tokio</code> å…·æœ‰åŸºæœ¬çš„äº†è§£ã€‚</p></blockquote><p>æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦å¼•å…¥ä¸¤ä¸ªç»„ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo add tokio --features macros,rt-multi-thread<br>cargo add axum<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªä¾‹å­æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªè·¯ç”±ï¼Œä¸‹é¢æˆ‘ä»¬å°±å…ˆä» Axum çš„è·¯ç”±å¼€å§‹ä»‹ç»ã€‚</p><h1 id="routing-è·¯ç”±">Routing è·¯ç”±</h1><h2 id="å•ä¸ªè·¯ç”±">å•ä¸ªè·¯ç”±</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust">Router::<span class="hljs-title function_ invoke__">new</span>().<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-title function_ invoke__">get</span>(|| <span class="hljs-keyword">async</span> &#123; <span class="hljs-string">&quot;Hello World!&quot;</span> &#125;));<br></code></pre></td></tr></table></figure><p>å®é™…ä¸Šå®ƒç­‰ä»·äºï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[tokio::main]</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">app</span> = Router::<span class="hljs-title function_ invoke__">new</span>()<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-title function_ invoke__">get</span>(handler_hello_world));<br> ...<br>&#125;<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">handler_hello_world</span> () <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">impl</span> <span class="hljs-title class_">IntoResponse</span> &#123;<br>    <span class="hljs-string">&quot;Hello World&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è·¯ç”±æ³¨å†Œéƒ¨åˆ†ä¸ºä¸º <code>path</code>ã€<code>method</code> å’Œ<code>handler</code> ä¸‰ä¸ªéƒ¨åˆ†ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20240114141604009.png"alt="è·¯ç”±æ³¨å†Œéƒ¨åˆ†" /><figcaption aria-hidden="true">è·¯ç”±æ³¨å†Œéƒ¨åˆ†</figcaption></figure><p>å…¶ä¸­ <code>get</code> å¯ä»¥æ›¿æ¢ä¸º<code>post</code>ã€<code>patch</code>ã€<code>delete</code>ã€<code>head</code>å’Œ <code>options</code> ç­‰ http methodã€‚</p><p>å…¶ä¸­ <code>handler</code>çš„è¿”å›å€¼éœ€è¦æ»¡è¶³ï¼š<code>impl IntoResponse</code>ï¼Œå¸¸ç”¨çš„<code>å­—ç¬¦ä¸²</code>ã€<code>json</code> å’Œ <code>html</code> éƒ½å·²ç»å®ç°äº†<code>IntoResponse</code>ï¼Œæ‰€ä»¥éƒ½æ˜¯å¯ä»¥ç›´æ¥è¿”å›çš„ã€‚</p><h2 id="è·¯ç”±åˆ†ç»„">è·¯ç”±åˆ†ç»„</h2><p>ä½ å¯ä»¥ä½¿ç”¨ <code>merge()</code> å’Œ <code>nest()</code>æ¥è¿›è¡Œè·¯ç”±åˆ†ç»„ï¼Œå…¶ä¸­ <code>nest()</code> å¯ä»¥æŒ‡å®šç»Ÿä¸€è·¯ç”±å‰ç¼€ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[tokio::main]</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">app</span> = Router::<span class="hljs-title function_ invoke__">new</span>()<br>        .<span class="hljs-title function_ invoke__">merge</span>(<span class="hljs-title function_ invoke__">todo_routers</span>())<br>        .<span class="hljs-title function_ invoke__">nest</span>(<span class="hljs-string">&quot;/v2/todo&quot;</span>, <span class="hljs-title function_ invoke__">todo_routers_v2</span>());<br>...<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">todo_routers</span>() <span class="hljs-punctuation">-&gt;</span> Router &#123;<br>    Router::<span class="hljs-title function_ invoke__">new</span>()<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;/todo/delete/:id&quot;</span>, <span class="hljs-title function_ invoke__">delete</span>(handler_todo_delete))<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;/todo/list&quot;</span>, <span class="hljs-title function_ invoke__">get</span>(handler_todo_list))<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;/todo/create&quot;</span>, <span class="hljs-title function_ invoke__">post</span>(handler_todo_create))<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;/todo/update&quot;</span>, <span class="hljs-title function_ invoke__">put</span>(handler_todo_update))<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">todo_routers_v2</span>() <span class="hljs-punctuation">-&gt;</span> Router &#123;<br>    Router::<span class="hljs-title function_ invoke__">new</span>()<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;/delete/:id&quot;</span>, <span class="hljs-title function_ invoke__">delete</span>(handler_todo_delete))<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;/list&quot;</span>, <span class="hljs-title function_ invoke__">get</span>(handler_todo_list))<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;/create&quot;</span>, <span class="hljs-title function_ invoke__">post</span>(handler_todo_create))<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;/update&quot;</span>, <span class="hljs-title function_ invoke__">put</span>(handler_todo_update))<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="é™æ€è·¯ç”±">é™æ€è·¯ç”±</h2><p>å¯ä»¥ä½¿ç”¨åŒ <code>tokio</code> ç”Ÿæ€ä¸‹çš„ <code>tower-http</code>æ¥å®ç°é™æ€è·¯ç”±ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">static_routers</span>() <span class="hljs-punctuation">-&gt;</span> Router &#123;<br>    Router::<span class="hljs-title function_ invoke__">new</span>().<span class="hljs-title function_ invoke__">nest_service</span>(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-title function_ invoke__">get_service</span>(ServeDir::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;./&quot;</span>)))<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä½ éœ€è¦æ·»åŠ  <code>tower-http</code> ç»„ä»¶ï¼Œè‡³å°‘éœ€è¦è½½å…¥<code>fs</code> ç‰¹æ€§ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo add tower-http --features fs<br></code></pre></td></tr></table></figure><h1 id="å‚è€ƒ">å‚è€ƒ</h1><ul><li><a href="https://docs.rs/axum/latest/axum/">Rust-Axum</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Rust</category>
      
      <category>web æ¡†æ¶</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Rust</tag>
      
      <tag>Axum</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä¸€æ–‡å½»åº•æŒæ¡æµ®ç‚¹æ•°</title>
    <link href="/2023/12/23/floating-point-number/"/>
    <url>/2023/12/23/floating-point-number/</url>
    
    <content type="html"><![CDATA[<h2 id="ç»å…¸é—®é¢˜">ç»å…¸é—®é¢˜</h2><p>0.1 + 0.2 = ï¼Ÿ</p><p>æˆ‘ä»¬å†™ä¸ª Go ç¨‹åºæ¥æµ‹è¯•ä¸€ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> f1 <span class="hljs-type">float64</span> = <span class="hljs-number">0.1</span><br><span class="hljs-keyword">var</span> f2 <span class="hljs-type">float64</span> = <span class="hljs-number">0.2</span><br>fmt.Println(f1+f2 == <span class="hljs-number">0.3</span>)<br>fmt.Println(f1 + f2)<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-literal">false</span><br>0.30000000000000004<br></code></pre></td></tr></table></figure><p>å¦‚æ­¤è¿èƒŒ â€œå¸¸è¯†â€çš„ç»“æœï¼Œå…¶å®æ˜¯å› ä¸ºå½“ä¸‹è®¡ç®—æœºä½“ç³»ä¸­å°æ•°çš„è¡¨ç¤ºæ–¹å¼æ˜¯æµ®ç‚¹æ•°ï¼Œè€Œè®¡ç®—æœºä¸­å¯¹æµ®ç‚¹æ•°çš„è¡¨ç¤ºå¹¶éç™¾åˆ†ç™¾ç²¾ç¡®çš„ï¼Œåœ¨è¡¨ç¤ºå’Œè®¡ç®—è¿‡ç¨‹ä¸­éƒ½æœ‰å¯èƒ½ä¼šä¸¢å¤±ç²¾åº¦ã€‚</p><p>è¿™è¿«ä½¿å¿…é¡»æ·±å…¥ç†è§£æµ®ç‚¹æ•°åœ¨è®¡ç®—æœºä¸­çš„å­˜å‚¨æ–¹å¼åŠæ€§è´¨ï¼Œæ‰èƒ½æ­£ç¡®å¤„ç†å…³äºæ•°å­—çš„è®¡ç®—é—®é¢˜ã€‚</p><h2 id="ç»“è®ºå…ˆè¡Œ">ç»“è®ºå…ˆè¡Œ</h2><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/IEEE-754%20%E6%B5%AE%E7%82%B9%E6%95%B0.jpg"alt="IEEE-754 æµ®ç‚¹æ•°" /><figcaption aria-hidden="true">IEEE-754 æµ®ç‚¹æ•°</figcaption></figure><h2 id="å®šç‚¹æ•°">å®šç‚¹æ•°</h2><p>è¦ç†è§£æµ®ç‚¹æ•°çš„ç¬¬ä¸€æ­¥æ˜¯è€ƒè™‘å«æœ‰å°æ•°å€¼çš„äºŒè¿›åˆ¶æ•°å­—ã€‚åœ¨è¿™ä¹‹å‰ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æ›´åŠ ç†Ÿæ‚‰çš„åè¿›åˆ¶è¡¨ç¤ºæ³•ï¼š</p><p><span class="math display">\[d_md_{m-1} Â·Â·Â· d_1d_0 . d_{-1}d_{-2}Â·Â·Â· d_{-n}\]</span></p><p>å°æ•°ç‚¹ <code>.</code>å·¦è¾¹æ˜¯æ•´æ•°éƒ¨åˆ†ï¼Œå³è¾¹æ˜¯å°æ•°éƒ¨åˆ†ã€‚å…¶ä¸­æ¯ä¸ªåè¿›åˆ¶æ•° <code>di</code>çš„å–å€¼èŒƒå›´æ˜¯ 0~9ã€‚</p><p>å¦‚åè¿›åˆ¶çš„ <code>12.34</code> å³å¯ä»¥è¡¨ç¤ºä¸ºï¼š</p><p><span class="math display">\[1Ã—10^1+2Ã—10^0+3Ã—10^{-1}+4Ã—10^{-2}\]</span></p><p>é‚£å…¶å®äºŒè¿›åˆ¶ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ï¼Œåªä¸è¿‡æŠŠå…¶ä¸­çš„ <code>10</code> æ¢æˆ<code>2</code>ï¼Œè€Œ <code>di</code> çš„å–å€¼èŒƒå›´ä¸º 0~1ã€‚</p><p>å¦‚äºŒè¿›åˆ¶çš„ <code>101.11</code> å¯ä»¥è¡¨ç¤ºä¸ºï¼š</p><p><span class="math display">\[1Ã—2^2+0Ã—2^1+1Ã—2^0+1Ã—2^{-1}+1Ã—2^{-2}\]</span></p><p>å¦‚æœæˆ‘ä»¬ä»…è€ƒè™‘æœ‰é™é•¿åº¦çš„ç¼–ç ï¼Œé‚£ä¹ˆåè¿›åˆ¶è¡¨ç¤ºæ³•ä¸èƒ½å‡†ç¡®è¡¨è¾¾åƒ 1/3 å’Œ5/7è¿™æ ·çš„æ•°ã€‚ç±»ä¼¼çš„ï¼Œå°æ•°çš„äºŒè¿›åˆ¶è¡¨ç¤ºæ³•åªèƒ½è¡¨ç¤ºé‚£äº›èƒ½å¤Ÿè¢«å†™æˆä»¥ä¸‹å½¢å¼çš„æ•°ï¼š</p><p><span class="math display">\[x Ã— 2^y\]</span></p><p>å…¶ä»–çš„å€¼å°±åªèƒ½è¿‘ä¼¼åœ°è¡¨ç¤ºã€‚</p><p>å®šç‚¹æ•°çš„æ•´æ•°éƒ¨åˆ†æ˜¯å°æ•°éƒ¨åˆ†çš„ä½æ•°æ˜¯å›ºå®šä¸å˜çš„ï¼Œåœ¨ä½æ•°æœ‰é™çš„æƒ…å†µä¸‹ï¼Œå®šç‚¹æ•°çš„å–å€¼èŒƒå›´å’Œç²¾åº¦éƒ½æ¯”è¾ƒå·®ã€‚äºæ˜¯å°±æœ‰äº†IEEE-754 æå‡ºçš„æµ®ç‚¹æ•°è¡¨ç¤ºæ³•ã€‚</p><h2 id="æµ®ç‚¹æ•°">æµ®ç‚¹æ•°</h2><p>æ‰€è°“â€œæµ®ç‚¹æ•°â€ï¼ˆFloating-pointnumbersï¼‰ï¼Œå³å°æ•°ç‚¹å¯ä»¥â€œ<strong>æµ®åŠ¨</strong>â€ï¼Œå³å°æ•°ç‚¹çš„ä½ç½®ä¸æ˜¯å›ºå®šçš„ï¼Œè€Œæ˜¯å¯ä»¥æ ¹æ®æ•°å€¼çš„å¤§å°å’Œç²¾åº¦éœ€æ±‚ç§»åŠ¨çš„ã€‚è¿™ç§è¡¨ç¤ºæ³•å…è®¸åœ¨å¹¿æ³›çš„èŒƒå›´å†…è¡¨ç¤ºæ•°å€¼ï¼ŒåŒæ—¶ä¿æŒç›¸å¯¹æ’å®šçš„ç²¾åº¦ã€‚</p><p>åœ¨è®¡ç®—æœºä¸­ï¼Œæµ®ç‚¹æ•°é€šå¸¸éµå¾ª IEEE-754æ ‡å‡†ã€‚è¿™ä¸ªæ ‡å‡†å®šä¹‰äº†æµ®ç‚¹æ•°çš„å­˜å‚¨å’Œè¿ç®—æ–¹å¼ï¼Œç¡®ä¿äº†ä¸åŒè®¡ç®—æœºç³»ç»Ÿä¹‹é—´çš„ä¸€è‡´æ€§ã€‚IEEE-754ç”¨ä»¥ä¸‹å½¢å¼æ¥è¡¨ç¤ºä¸€ä¸ªæ•°ï¼š</p><p><span class="math display">\[V = (-1)^sÃ—MÃ—2^E\]</span></p><p>å…¶ä¸­ï¼š</p><ul><li><strong>s ç¬¦å·ä½ï¼ˆSign bitï¼‰</strong>ï¼šè¡¨ç¤ºæ•°å€¼çš„æ­£è´Ÿã€‚</li><li><strong>M å°¾æ•°ï¼ˆMantissaï¼‰</strong>ï¼šè¡¨ç¤ºæ•°å€¼çš„æœ‰æ•ˆæ•°å­—ã€‚</li><li><strong>E æŒ‡æ•°ï¼ˆExponentï¼‰</strong>ï¼šå†³å®šå°æ•°ç‚¹çš„ä½ç½®ã€‚</li></ul><p>IEEE-754å°†æµ®ç‚¹æ•°çš„ä½è¡¨ç¤ºåˆ’åˆ†æˆä¸‰ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«å¯¹å„ä¸ªéƒ¨åˆ†è¿›è¡Œç¼–ç ï¼Œå¯¹åº”ä¸Šé¢å…¬å¼å³è¾¹çš„3 ä¸ªå­—æ¯ï¼š</p><ul><li>ä¸€ä¸ªå•ç‹¬çš„ç¬¦å·ä½ <code>s</code> ç›´æ¥ç¼–ç ç¬¦å· <code>s</code>ã€‚</li><li><span class="math inline">\(k\)</span> ä½çš„é˜¶ç å­—æ®µ <spanclass="math inline">\(exp=e_{k-1}\cdots e_1e_0\)</span> ç¼–ç é˜¶ç <code>E</code>ã€‚</li><li><span class="math inline">\(n\)</span> ä½å°æ•°å­—æ®µ <spanclass="math inline">\(frac=f_{n-1}\cdots f_1f_0\)</span> ç¼–ç å°¾æ•°<code>M</code>ï¼Œä½†æ˜¯ç¼–ç å‡ºæ¥çš„å€¼ä¹Ÿä¾èµ–äºé˜¶ç å­—æ®µçš„å€¼æ˜¯å¦ç­‰äº 0ã€‚</li></ul><p>åœ¨ IEEE-754 æ ‡å‡†ä¸­ï¼Œå®šä¹‰äº†ä¸¤ç§ç²¾åº¦çš„æµ®ç‚¹æ•°ï¼Œåˆ†åˆ«æ˜¯å•ç²¾åº¦æµ®ç‚¹æ•°ï¼ˆ32ä½ï¼‰å’ŒåŒç²¾åº¦æµ®ç‚¹æ•°ï¼ˆ64 ä½ï¼‰ã€‚</p><p>å•ç²¾åº¦ï¼š</p><ul><li>1 ä½ç¬¦å·ä½ s</li><li>8 ä½æŒ‡æ•° exp</li><li>23 ä½å°¾æ•° frac</li></ul><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20231224102703581.png"alt="å•ç²¾åº¦æµ®ç‚¹æ•°" /><figcaption aria-hidden="true">å•ç²¾åº¦æµ®ç‚¹æ•°</figcaption></figure><p>åŒç²¾åº¦ï¼š</p><ul><li>1 ä½ç¬¦å·ä½ s</li><li>11 ä½æŒ‡æ•° exp</li><li>52 ä½å°¾æ•° frac</li></ul><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20231224102756244.png"alt="åŒç²¾åº¦æµ®ç‚¹æ•°" /><figcaption aria-hidden="true">åŒç²¾åº¦æµ®ç‚¹æ•°</figcaption></figure><p>æ ¹æ® <code>exp</code> çš„å€¼ï¼Œæµ®ç‚¹æ•°åˆå¯ä»¥åˆ†æˆä¸‰ç±»ï¼š</p><ol type="1"><li>è§„æ ¼åŒ–çš„</li><li>éè§„æ ¼åŒ–çš„</li><li>ç‰¹æ®Šçš„</li></ol><p>å…¶ä¸­ç¬¬ä¸‰ç±»â€œç‰¹æ®Šçš„â€åˆå¯ä»¥æ ¹æ® <code>frac</code> åˆ†æˆä¸¤ç±»ï¼š</p><ol type="1"><li>æ— ç©·å¤§</li><li>ä¸æ˜¯ä¸€ä¸ªæ•° NaNï¼ˆNot a Numberï¼‰</li></ol><p>å…·ä½“å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p><table><thead><tr class="header"><th></th><th style="text-align: center;">exp</th><th style="text-align: center;">frac</th></tr></thead><tbody><tr class="odd"><td>è§„æ ¼åŒ–çš„</td><td style="text-align: center;">â‰ 0 &amp; â‰  255</td><td style="text-align: center;">f</td></tr><tr class="even"><td>éè§„æ ¼åŒ–çš„</td><td style="text-align: center;">0</td><td style="text-align: center;">f</td></tr><tr class="odd"><td>ç‰¹æ®Šçš„</td><td style="text-align: center;">1</td><td style="text-align: center;">f</td></tr><tr class="even"><td>- æ— ç©·å¤§</td><td style="text-align: center;">1</td><td style="text-align: center;">0</td></tr><tr class="odd"><td>- NaN</td><td style="text-align: center;">1</td><td style="text-align: center;">â‰ 0</td></tr></tbody></table><p>å¯¹äºä¸åŒç±»å‹çš„æµ®ç‚¹æ•°ï¼Œåœ¨è®¡ç®—å…¬å¼ <spanclass="math inline">\(V=(-1)^sÃ—MÃ—2^E\)</span>ä¸­ï¼Œ<code>exp -&gt; E</code> å’Œ <code>frac -&gt; M</code>çš„æ–¹å¼æœ‰æ‰€ä¸åŒã€‚</p><p>ä¸‹é¢æˆ‘ä»¬æ¥å¯¹è¿™å‡ ç§ä¸åŒç±»å‹è¿›è¡Œè¯¦ç»†è®¨è®ºï¼Œå…¶ä¸­ä¸ä¹æœ‰ä¸€äº›å¾ˆæœ‰è¶£ä¸”å……æ»¡æ™ºæ…§çš„è®¾è®¡ç†å¿µã€‚</p><h3 id="ç‰¹æ®Šå€¼-special-values">ç‰¹æ®Šå€¼ Special Values</h3><ul><li><strong>æŒ‡æ•°éƒ¨åˆ†</strong>ï¼šå…¨ä¸º 0ã€‚</li><li><strong>å°¾æ•°éƒ¨åˆ†</strong>ï¼šå…¨ä¸º 0 åˆ™è¡¨ç¤ºæ— ç©·å¤§ï¼Œä¸å…¨ä¸º 0 åˆ™è¡¨ç¤ºNaNã€‚</li><li><strong>ä½œç”¨</strong>ï¼šç‰¹æ®Šå€¼ç”¨äºè¡¨ç¤ºé‚£äº›æ— æ³•ç”¨å¸¸è§„æ•°å€¼è¡¨ç¤ºçš„æƒ…å†µï¼Œå¦‚æ— ç©·å¤§ã€éæ•°ï¼ˆNaNï¼‰ç­‰ã€‚è¿™äº›å€¼é€šå¸¸ç”¨äºæ“ä½œçš„é”™è¯¯æˆ–ç‰¹æ®Šæƒ…å†µçš„ç»“æœï¼Œå¦‚é™¤ä»¥0ã€æ— æ•ˆæ“ä½œç­‰ã€‚</li></ul><h3 id="è§„æ ¼åŒ–çš„å€¼-normalize-values">è§„æ ¼åŒ–çš„å€¼ Normalize Values</h3><ul><li><strong>æŒ‡æ•°éƒ¨åˆ†</strong>ï¼šä¸å…¨ä¸º 0 ä¸”ä¸å…¨ä¸º 1ã€‚</li><li><strong>å°¾æ•°éƒ¨åˆ†</strong>ï¼šå¯ä»¥æ˜¯ä»»æ„å€¼ã€‚</li><li><strong>ä½œç”¨</strong>ï¼šç”¨äºè¡¨ç¤ºå¤§å¤šæ•°éé›¶æ•°å€¼</li></ul><p>åœ¨è§„æ ¼åŒ–å€¼ä¸­ï¼š</p><ul><li><span class="math inline">\(E=e-bias\)</span></li><li><span class="math inline">\(M=1+f\)</span></li></ul><p>å…¶ä¸­ <code>e</code> å³ä¸º <code>exp</code>ï¼Œï¼Œ<code>bias</code>æ˜¯åç½®é‡ï¼Œå®ƒçš„å€¼ä¸º <span class="math inline">\(2^{k-1} -1\)</span>ï¼Œå…¶ä¸­<code>k</code> ä¸º <code>exp</code> çš„ä½æ•°ï¼Œæ•…ï¼š</p><ul><li>åœ¨å•ç²¾åº¦ä¸­ï¼Œ<spanclass="math inline">\(bias=2^{8-1}-1=2^7-1=128-1=127\)</span></li><li>åœ¨åŒç²¾åº¦ä¸­ï¼Œ<spanclass="math inline">\(bias=2^{11-1}-1=2^{10}-1=1024-1=1023\)</span></li></ul><p>å…¶ä¸­ <code>f</code> ä¸º <code>frac</code> è¡¨ç¤ºçš„æ•°ï¼ŒèŒƒå›´ <spanclass="math inline">\(0â‰¤f&lt;1\)</span>ã€‚</p><p>æ‰€ä»¥ä¸€ä¸ªè§„æ ¼åŒ–æ•°ï¼Œå…·ä½“å¯ä»¥è¡¨ç¤ºä¸ºï¼š</p><p><span class="math display">\[V=(-1)^{sign}Ã—1.fracÃ—2^{(exp-bias)}\]</span></p><p>è¿™é‡Œæœ‰ 4 ä¸ªé—®é¢˜ï¼š</p><ol type="1"><li>è¿™ä¸ª <code>bias</code> æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>ä¸ºä»€ä¹ˆ <code>E</code> è¦ <code>e</code> å»å‡æ‰ä¸€ä¸ª<code>bias</code>ï¼Ÿ</li><li><code>bias</code> çš„å€¼æ˜¯æ€ä¹ˆå®šä¸‹çš„ï¼Œå¦‚å•ç²¾åº¦ä¸ºä»€ä¹ˆæ˜¯ 127ï¼Œä¸æ˜¯ 126æˆ– 128ï¼Ÿ</li><li><code>M</code> ä¸ºä»€ä¹ˆéœ€è¦ <code>f</code> å»åŠ ä¸Šä¸€ä¸ª<code>1</code>ï¼Ÿ</li></ol><p>ä¸‹é¢æˆ‘ä»¬æ¥å¯¹è¿™ 4 ä¸ªé—®é¢˜è¿›è¡Œä¸€ä¸€è§£ç­”ã€‚</p><p><strong>ç¬¬ 1 ä¸ªé—®é¢˜ï¼Œè¿™ä¸ª bias æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p><blockquote><p><code>bias</code>æ˜¯ä¸€ä¸ªé¢„è®¾çš„åç§»é‡ï¼Œç”¨äºå°†æŒ‡æ•°éƒ¨åˆ†çš„å€¼åç§»åˆ°å…¨æ­£æ•°ï¼Œä»è€Œç®€åŒ–å¤„ç†ã€‚</p></blockquote><p><strong>ç¬¬ 2 ä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆ E è¦ e å»å‡å»ä¸€ä¸ª biasï¼Ÿ</strong></p><blockquote><p>å…ˆè¯´ç»“è®ºï¼šä½¿ç”¨ biasï¼ˆåç½®æŒ‡æ•°ï¼Œbiasedexponentï¼‰å¯ä»¥å…è®¸æµ®ç‚¹æ•°ä»¥ç»Ÿä¸€çš„æ–¹å¼è¡¨ç¤ºï¼ŒåŒæ—¶ä¹Ÿä½¿å¾—æµ®ç‚¹æ•°çš„æ’åºå’Œæ¯”è¾ƒå˜å¾—ç®€å•ã€‚</p></blockquote><p>é¦–å…ˆæŒ‡æ•°è‚¯å®šå¾—æ”¯æŒæ­£è´Ÿå½¢å¼çš„å‡ºç°ï¼Œé‚£ä¹ˆç›´æ¥ä½¿ç”¨æ— ç¬¦å·æ•´å‹æ¥è¡¨ç¤ºæŒ‡æ•°è‚¯å®šæ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºå®ƒæ— æ³•è¡¨ç¤ºè´ŸæŒ‡æ•°ã€‚æš‚æ—¶å…ˆæŠ›å¼€IEEE-754 å®šä¸‹çš„æ ‡å‡†ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•ç”¨è¡¥ç æ¥è¡¨ç¤ºæŒ‡æ•°ã€‚</p><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ª 32 ä½çš„æµ®ç‚¹æ•° <code>A</code> å’Œ<code>B</code>ï¼Œå¹¶ä¸”æˆ‘ä»¬å‡è®¾å®ƒä»¬çš„æŒ‡æ•°éƒ¨åˆ†ä½¿ç”¨ 8 ä½äºŒè¿›åˆ¶è¡¥ç è¡¨ç¤ºï¼ˆè¿™ä¸IEEE-754 æ ‡å‡†ä¸åŒï¼‰ã€‚</p><ul><li><code>A</code>çš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼š<code>0 0000010 00000000000000000000000</code></li><li><code>B</code>çš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼š<code>0 1111110 00000000000000000000000</code></li></ul><p>åœ¨è¿™é‡Œï¼Œç¬¬ä¸€ä½æ˜¯ç¬¦å·ä½ï¼ˆ0 è¡¨ç¤ºæ­£æ•°ï¼‰ï¼Œæ¥ä¸‹æ¥çš„ 8ä½æ˜¯ä»¥è¡¥ç å½¢å¼è¡¨ç¤ºçš„æŒ‡æ•°ï¼Œå‰©ä¸‹çš„ 23 ä½æ˜¯å°¾æ•°ã€‚</p><p>æˆ‘ä»¬æƒ³è¦æ¯”è¾ƒè¿™ä¸¤ä¸ªæ•°çš„å¤§å°ï¼Œéœ€è¦æ€ä¹ˆåšå‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å…ˆè§£æè¿™ 2 ä¸ªæ•°ï¼š</p><ul><li>ç¬¦å·ä½ï¼šå¯¹äº <code>A</code> å’Œ <code>B</code>ï¼Œç¬¦å·ä½éƒ½æ˜¯0ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸¤ä¸ªæ­£æ•°ã€‚</li><li>æŒ‡æ•°éƒ¨åˆ†ï¼ˆä½¿ç”¨è¡¥ç è¡¨ç¤ºï¼‰<ul><li><code>A</code> çš„æŒ‡æ•°ä¸º <code>0000010</code>ï¼Œè§£è¯»ä¸ºæ­£æ•° +2ã€‚</li><li><code>B</code> çš„æŒ‡æ•°ä¸º<code>1111110</code>ï¼Œåœ¨è¡¥ç è¡¨ç¤ºä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ªè´Ÿæ•°ã€‚å…ˆåŠ å–åååŠ  1è½¬æ¢ä¸ºæ­£æ•° <code>00000010</code>ï¼Œå®ƒè¡¨ç¤º -2ã€‚</li></ul></li></ul><p>è¦æ¯”è¾ƒè¿™ 2 ä¸ªæ•°ï¼š</p><ul><li>å½“æˆ‘ä»¬æ¯”è¾ƒ <code>A</code> å’Œ <code>B</code>æ—¶ï¼Œé¦–å…ˆéœ€è¦è€ƒè™‘å®ƒä»¬çš„æŒ‡æ•°ã€‚</li><li>æŒ‡æ•° <code>A</code> ä¸º +2ï¼Œè€Œ <code>B</code> ä¸º-2ã€‚å³ä½¿å®ƒä»¬çš„å°¾æ•°éƒ¨åˆ†ç›¸åŒï¼ˆåœ¨è¿™ä¸ªä¾‹å­ä¸­éƒ½æ˜¯ 0ï¼‰ï¼Œ<code>A</code>çš„å®é™…å€¼è¦å¤§äº<code>B</code>ï¼Œå› ä¸ºæ­£æŒ‡æ•°è¡¨ç¤ºçš„æ•°å€¼èŒƒå›´è¿œå¤§äºè´ŸæŒ‡æ•°ã€‚</li></ul><p>å¯ä»¥çœ‹å‡ºï¼šä½¿ç”¨è¡¥ç è¡¨ç¤ºæŒ‡æ•°å¢åŠ äº†æ¯”è¾ƒè¿‡ç¨‹çš„å¤æ‚æ€§ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦è§£è¯»è¡¥ç å¹¶è€ƒè™‘å…¶æ­£è´Ÿã€‚ç‰¹åˆ«æ˜¯åœ¨æ¶‰åŠåˆ°è´ŸæŒ‡æ•°çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸èƒ½ä»…ä»…æ¯”è¾ƒäºŒè¿›åˆ¶è¡¨ç¤ºçš„å¤§å°ï¼Œè€Œå¿…é¡»å°†è¡¥ç è½¬æ¢ä¸ºå®é™…çš„æ•°å€¼ï¼Œç„¶åå†è¿›è¡Œæ¯”è¾ƒã€‚</p><p>ç°åœ¨å›è¿‡å¤´æ¥çœ‹çœ‹ IEEE-754 çš„è®¾è®¡ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªå•ç²¾åº¦ï¼ˆ32 ä½ï¼‰æµ®ç‚¹æ•°<code>A</code> å’Œ <code>B</code>ï¼š</p><ul><li><code>A</code>çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸ºï¼š<code>0 10000010 00000000000000000000000</code></li><li><code>B</code>çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸ºï¼š<code>0 01111110 00000000000000000000000</code></li></ul><p>è§£æè¿™ä¸¤ä¸ªæ•°ï¼š</p><ul><li><code>A</code>ï¼šç¬¦å·ä½ä¸º 0ï¼ˆæ­£æ•°ï¼‰ï¼ŒæŒ‡æ•°éƒ¨åˆ†ä¸º<code>10000010</code>ï¼ˆäºŒè¿›åˆ¶ï¼Œå¯¹åº”åè¿›åˆ¶çš„ 130ï¼‰ï¼Œå°¾æ•°éƒ¨åˆ†ä¸ºå…¨ 0ã€‚</li><li><code>B</code>ï¼šç¬¦å·ä½ä¸º 0ï¼ˆæ­£æ•°ï¼‰ï¼ŒæŒ‡æ•°éƒ¨åˆ†ä¸º<code>01111110</code>ï¼ˆäºŒè¿›åˆ¶ï¼Œå¯¹åº”åè¿›åˆ¶çš„ 126ï¼‰ï¼Œå°¾æ•°éƒ¨åˆ†ä¸ºå…¨ 0ã€‚</li></ul><p>è®¡ç®—å®é™…æŒ‡æ•°å€¼ï¼šå•ç²¾åº¦æµ®ç‚¹æ•°çš„åç½®å€¼ <code>bias</code> ä¸º127ï¼Œæ•…ï¼š</p><ul><li><code>A</code> çš„å®é™…æŒ‡æ•° <code>E = 130 - 127 = 3</code>ã€‚</li><li><code>B</code> çš„å®é™…æŒ‡æ•° <code>E = 126 - 127 = -1</code>ã€‚</li></ul><p>æ¯”è¾ƒè¿™ä¸¤ä¸ªæ•°ï¼š</p><ul><li>åœ¨å‡å» <code>bias</code>åï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ¯”è¾ƒæŒ‡æ•°éƒ¨åˆ†çš„äºŒè¿›åˆ¶è¡¨ç¤ºæ¥ç¡®å®šæ•°å€¼çš„å¤§å°ã€‚</li><li>ç”±äº <code>10000010</code>ï¼ˆ130ï¼‰å¤§äº<code>01111110</code>ï¼ˆ126ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç›´æ¥å¾—å‡º <code>A</code> å¤§äº<code>B</code>ï¼Œè€Œæ— éœ€è€ƒè™‘è´ŸæŒ‡æ•°çš„å¤æ‚è¡¨ç¤ºé—®é¢˜ã€‚</li></ul><p>è¿™ä¸ªä¾‹å­è¯´æ˜äº†é€šè¿‡å‡å»åç½®å€¼ï¼ŒIEEE-754æ ‡å‡†èƒ½å¤Ÿç®€åŒ–æµ®ç‚¹æ•°çš„æ¯”è¾ƒå’Œæ’åºæ“ä½œã€‚åç½®åçš„æŒ‡æ•°è¡¨ç¤ºæ–¹æ³•å…è®¸è®¡ç®—æœºä»¥ç»Ÿä¸€å’Œé«˜æ•ˆçš„æ–¹å¼å¤„ç†æµ®ç‚¹æ•°ï¼Œæ— è®ºå®ƒä»¬çš„å®é™…æ•°å€¼å¤§å°å¦‚ä½•ã€‚</p><p><strong>ç¬¬ 3 ä¸ªé—®é¢˜ï¼šbias çš„å€¼æ˜¯æ€ä¹ˆå®šä¸‹çš„ï¼Œå¦‚å•ç²¾åº¦ä¸ºä»€ä¹ˆæ˜¯127ï¼Œè€Œä¸æ˜¯ 126 æˆ– 128ï¼Ÿ</strong></p><blockquote><p><code>bias</code>å€¼çš„é€‰æ‹©ï¼Œæ˜¯ä¸ºäº†å¹³è¡¡æ­£è´ŸæŒ‡æ•°çš„è¡¨ç¤ºèŒƒå›´ï¼Œå¹¶ä¸”å……åˆ†åˆ©ç”¨æŒ‡æ•°éƒ¨åˆ†çš„å­˜å‚¨ç©ºé—´ã€‚</p></blockquote><p>ä»¥å•ç²¾åº¦ä¸ºä¾‹ï¼Œ<code>exp</code> å äº† 8 ä½ï¼Œ8ä½äºŒè¿›åˆ¶å¯ä»¥è¡¨ç¤ºçš„å€¼çš„èŒƒå›´æ˜¯ <spanclass="math inline">\([0,255]\)</span>ã€‚å¦‚æœæˆ‘ä»¬é€‰æ‹© 127 ä½œä¸º<code>bias</code>ï¼Œåˆ™å­˜å‚¨çš„æŒ‡æ•°èŒƒå›´å°±æ˜¯ <spanclass="math inline">\([-127,128]\)</span>ã€‚è¿™æ ·å¯ä»¥ä½¿å¾—æŒ‡æ•°éƒ¨åˆ†å¯ä»¥å‡åŒ€åœ°è¡¨ç¤ºä»è´Ÿå¤§æ•°åˆ°æ­£å¤§æ•°çš„èŒƒå›´ï¼ˆå¯¹ç§°ï¼‰ã€‚</p><p>åœ¨ IEEE-754 æ ‡å‡†ä¸­ï¼Œå…¨ 0 çš„æŒ‡æ•°è¡¨ç¤ºä¸ºéè§„æ ¼åŒ–æ•°æˆ– 0ï¼Œè€Œå…¨ 1çš„æŒ‡æ•°ç”¨äºè¡¨ç¤ºæ— ç©·å¤§æˆ– NaNï¼‰ã€‚é€‰æ‹© 127 ä½œä¸º <code>bias</code>å¯ä»¥åœ¨ä¿ç•™è¿™äº›ç‰¹æ®Šå€¼çš„åŒæ—¶ï¼Œæä¾›æœ€å¤§çš„æœ‰æ•ˆæŒ‡æ•°èŒƒå›´ã€‚</p><p><strong>ç¬¬ 4 ä¸ªé—®é¢˜ï¼šM ä¸ºä»€ä¹ˆéœ€è¦ f å»åŠ ä¸Šä¸€ä¸ª 1ï¼Ÿ</strong></p><blockquote><p>åœ¨è§„æ ¼åŒ–æ•°ä¸­éšå«æœ€é«˜ä½ 1æ˜¯ä¸ºäº†æé«˜å°¾æ•°éƒ¨åˆ†çš„è¡¨ç¤ºæ•ˆç‡ï¼Œä»è€Œå¢åŠ ç²¾åº¦ã€‚</p></blockquote><p>å…¶å®è¿™è·Ÿç§‘å­¦è®¡æ•°æ³•çš„å¾ˆåƒçš„ï¼Œä¸ºäº†ç¡®ä¿æµ®ç‚¹æ•°è¡¨ç¤ºçš„<strong>å”¯ä¸€æ€§</strong>ï¼ŒIEEE-754è§„å®šè§„æ ¼åŒ–æµ®ç‚¹æ•°æœ€é«˜ä½ä¸€å®šæ˜¯éé›¶çš„ã€‚å¦‚æœä¸è§„å®šæœ€é«˜ä½éé›¶ï¼ŒåŒä¸€ä¸ªæ•°å¯ä»¥æœ‰å¤šç§ä¸åŒçš„æµ®ç‚¹è¡¨ç¤ºï¼Œä¾‹å¦‚ï¼Œåœ¨äºŒè¿›åˆ¶ä¸­<code>0.5</code> å¯ä»¥è¡¨ç¤ºä¸º <spanclass="math inline">\(1.0Ã—2^{-1}\)</span>ï¼Œä¹Ÿå¯ä»¥è¡¨ç¤ºä½ <spanclass="math inline">\(0.1Ã—2^0\)</span> æˆ– <spanclass="math inline">\(0.01Ã—2^1\)</span>ç­‰ç­‰ã€‚è¿™ç§å¤šé‡è¡¨ç¤ºä¼šä½¿æµ®ç‚¹è¿ç®—å˜å¾—å¤æ‚ä¸”ä½æ•ˆã€‚</p><p>é‚£æ—¢ç„¶æœ€é«˜ä½æ€»æ˜¯ 1ï¼Œé‚£å°±æ²¡å¿…è¦æ˜¾ç¤ºå­˜å‚¨äº†ï¼Œè¿˜å¯ä»¥ä½¿å°¾æ•°éƒ¨åˆ†ä¸­å¤š 1ä½çš„å­˜å‚¨ç©ºé—´ï¼Œä»è€Œå…è®¸å­˜å‚¨æ›´å¤šçš„æœ‰æ•ˆæ•°å­—ï¼Œä»¥<strong>æé«˜ç²¾åº¦</strong>ã€‚</p><h3 id="éè§„æ ¼åŒ–çš„å€¼-denormalized-values">éè§„æ ¼åŒ–çš„å€¼ DenormalizedValues</h3><ul><li><strong>æŒ‡æ•°éƒ¨åˆ†</strong>ï¼šå…¨ä¸º 0ã€‚</li><li><strong>å°¾æ•°éƒ¨åˆ†</strong>ï¼šå¯ä»¥æ˜¯ä»»æ„å€¼ã€‚</li><li><strong>ä½œç”¨</strong>ï¼š<ul><li>æä¾›è¡¨ç¤ºæ•°å€¼ 0 çš„æ–¹æ³•ã€‚å› ä¸ºè§„æ ¼åŒ–ä¸­ <spanclass="math inline">\(Mâ‰¥1\)</span>ï¼Œæ‰€ä»¥æ— æ³•è¡¨ç¤º 0ã€‚</li><li>ç”¨äºè¡¨ç¤ºéå¸¸æ¥è¿‘äº 0çš„æ•°å€¼ï¼Œè¿™äº›æ•°å€¼å¤ªå°ï¼Œæ— æ³•ç”¨è§„æ ¼åŒ–æ ¼å¼è¡¨ç¤ºã€‚å®ƒä»¬å¡«è¡¥äº† 0å’Œæœ€å°è§„æ ¼åŒ–æ­£æ•°ä¹‹é—´çš„é—´éš™ï¼Œæä¾›äº†æ¸è¿‘äº 0çš„è¿ç»­è¡¨ç¤ºï¼Œé˜²æ­¢äº†æ‰€è°“çš„â€œä¸‹æº¢â€ã€‚</li></ul></li></ul><p>åœ¨éè§„æ ¼åŒ–å€¼ä¸­ï¼š</p><ul><li><span class="math inline">\(E=1-bias\)</span></li><li><span class="math inline">\(M=f\)</span></li></ul><p>æ‰€ä»¥ä¸€ä¸ªè§„æ ¼åŒ–æ•°ï¼Œå…·ä½“å¯ä»¥è¡¨ç¤ºä¸ºï¼š</p><p><span class="math display">\[V=(-1)^{sign}Ã—0.fracÃ—2^{(1-bias)}\]</span></p><p>é‚£è¿™é‡Œåˆæœ‰ 2 ä¸ªé—®é¢˜äº†ï¼š</p><ol type="1"><li>ä¸ºä»€ä¹ˆæŒ‡æ•°éƒ¨åˆ†ä¸æ˜¯ <span class="math inline">\(0-bias\)</span> è€Œæ˜¯<span class="math inline">\(1-bias\)</span>ï¼Ÿ</li><li>ä¸ºä»€ä¹ˆ M ä¸éœ€è¦éšå«çš„ 1 äº†ï¼Ÿ</li></ol><p><strong>ç¬¬ 1 ä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆæŒ‡æ•°éƒ¨åˆ†ä¸æ˜¯ 0-bias è€Œæ˜¯1-biasï¼Ÿ</strong></p><blockquote><p>è¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„è®¾è®¡ï¼Œæ—¨åœ¨ä½¿éè§„æ ¼åŒ–æ•°èƒ½å¤Ÿå¹³æ»‘åœ°è¿æ¥åˆ°è§„æ ¼åŒ–æ•°çš„æœ€å°æ­£å€¼ã€‚</p></blockquote><p>æœ€å°çš„è§„æ ¼åŒ–æ•°çš„æŒ‡æ•°ä¸º<code>1 - bias</code>ã€‚ä¸ºäº†åœ¨æ•°å€¼ä¸Šå¹³æ»‘åœ°è¿‡æ¸¡åˆ°éè§„æ ¼åŒ–æ•°ï¼Œéè§„æ ¼åŒ–æ•°çš„å®é™…æŒ‡æ•°ä¹Ÿè¢«è®¾å®šä¸º<code>1 - bias</code>ã€‚è¿™æ ·ï¼Œéè§„æ ¼åŒ–æ•°å°±å¯ä»¥ä»£è¡¨é‚£äº›å°äºæœ€å°è§„æ ¼åŒ–æ­£æ•°çš„æ•°å€¼ï¼Œè€Œä¸ä¼šå‡ºç°ä¸€ä¸ªæ•°å€¼çš„â€œé—´éš™â€ã€‚</p><p><strong>ç¬¬ 2 ä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆ M ä¸éœ€è¦éšå«çš„ 1 äº†ï¼Ÿ</strong></p><blockquote><p>ä¸åŒ…å«éšå«çš„ 1 ä½¿å¾—éè§„æ ¼åŒ–æ•°èƒ½å¤Ÿåœ¨æµ®ç‚¹æ•°è¡¨ç¤ºä¸­å¡«è¡¥ 0å’Œæœ€å°è§„æ ¼åŒ–æ•°ä¹‹é—´çš„ç©ºéš™ï¼Œæä¾›å¯¹æå°æ•°å€¼çš„è¿ç»­è¡¨ç¤ºã€‚</p></blockquote><ul><li><strong>é¿å…ä¸‹æº¢</strong>ï¼šéè§„æ ¼åŒ–æ•°é€šè¿‡å…è®¸å°¾æ•°éƒ¨åˆ†ä¸ä»¥éšå«çš„ 1å¼€å§‹ï¼ˆè€Œæ˜¯ä»¥æ˜¾å¼çš„ 0å¼€å§‹ï¼‰ï¼Œä½¿å¾—å®ƒä»¬å¯ä»¥è¡¨ç¤ºæ¯”æœ€å°è§„æ ¼åŒ–æ•°è¿˜è¦å°çš„æ•°å€¼ã€‚è¿™å¯¹äºé¿å…æ•°å€¼ä¸‹æº¢è‡³0 éå¸¸é‡è¦ï¼Œå°¤å…¶æ˜¯åœ¨ç´¯ç§¯äº†å¤šæ¬¡è¿ç®—åçš„åœºåˆã€‚</li><li><strong>ç²¾åº¦ç‰ºç‰²</strong>ï¼šä½¿ç”¨éè§„æ ¼åŒ–æ•°çš„ä»£ä»·æ˜¯ç‰ºç‰²äº†ä¸€äº›ç²¾åº¦ã€‚ç”±äºæ²¡æœ‰éšå«çš„æœ€é«˜ä½1ï¼Œéè§„æ ¼åŒ–æ•°çš„ç²¾åº¦è¾ƒä½ã€‚ä½†è¿™æ˜¯ä¸ºäº†åœ¨éå¸¸å°çš„æ•°å€¼èŒƒå›´å†…æä¾›æ•°å€¼çš„è¿ç»­æ€§æ‰€åšçš„å¿…è¦å¦¥åã€‚</li></ul><h3 id="æ€»ç»“">æ€»ç»“</h3><p>è§„æ ¼åŒ–å€¼ã€éè§„æ ¼åŒ–å€¼å’Œç‰¹æ®Šå€¼ä¸‰ç§ç±»å‹å…±åŒæ„æˆäº† IEEE-754æµ®ç‚¹æ•°æ ‡å‡†çš„å®Œæ•´è¡¨ç¤ºä½“ç³»ï¼Œä½¿å¾—æµ®ç‚¹æ•°èƒ½å¤Ÿåœ¨è®¡ç®—æœºä¸­æœ‰æ•ˆä½å¤„ç†ä»éå¸¸å°åˆ°éå¸¸å¤§çš„æ•°å€¼èŒƒå›´ï¼ŒåŒæ—¶è¿˜èƒ½åº”å¯¹ç‰¹æ®Šçš„è®¡ç®—æƒ…å†µã€‚</p><h3 id="ä¸¾ä¾‹">ä¸¾ä¾‹</h3><p>å‚è€ƒã€Šæ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿã€‹ï¼Œæˆ‘ä»¬ä»¥ 8 ä½æµ®ç‚¹æ•°ä¸ºä¾‹ï¼Œå…¶ä¸­ï¼š</p><ul><li>1 ä½ç¬¦å· s</li><li>4 ä½æŒ‡æ•° exp</li><li>3 ä½å°¾æ•° frac</li></ul><p>å¯ä»¥ç®—å‡º <spanclass="math inline">\(bias=2^{4-1}-1=2^3-1=8-1=7\)</span>ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/544558-20211104211145834-189368139.png"alt="8 ä½æµ®ç‚¹æ•°ï¼ˆâ‰¥0éƒ¨åˆ†ï¼‰" /><figcaption aria-hidden="true">8 ä½æµ®ç‚¹æ•°ï¼ˆâ‰¥0éƒ¨åˆ†ï¼‰</figcaption></figure><p>å…¶ä¸­é è¿‘ 0 çš„æ˜¯éè§„æ ¼åŒ–å€¼ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20231224130157112.png"alt="8 ä½æµ®ç‚¹æ•° - éè§„æ ¼åŒ–å€¼" /><figcaption aria-hidden="true">8 ä½æµ®ç‚¹æ•° - éè§„æ ¼åŒ–å€¼</figcaption></figure><p>ä»¥ <code>0 0000 001</code> ä¸ºä¾‹ï¼š</p><p><span class="math display">\[V = (-1)^sÃ—MÃ—2^E \\= (-1)^sÃ—0.fracÃ—2^{1-bias} \\= (-1)^0Ã—(0+(1/8))Ã—2^{1-7} \\= 1Ã—1/8Ã—2^{-6} \\=2^{(-9)} \\= 1/512\]</span></p><p>å†å¾€ä¸‹ï¼Œå°±æ˜¯è§„æ ¼åŒ–å€¼ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20231224130849986.png"alt="8 ä½æµ®ç‚¹æ•° - è§„æ ¼åŒ–å€¼" /><figcaption aria-hidden="true">8 ä½æµ®ç‚¹æ•° - è§„æ ¼åŒ–å€¼</figcaption></figure><p>ä»¥ <code>0 0110 110</code> ä¸ºä¾‹ï¼š</p><p><span class="math display">\[V = (-1)^sÃ—MÃ—2^E \\= (-1)^sÃ—1.fracÃ—2^{e-bias} \\= (-1)^0Ã—(1+6/8)Ã—2^{6-7} \\=1Ã—14/8Ã—2^{-1} \\= 14/16 \\=7/8\]</span></p><h2 id="æ•´å‹è½¬ä¸ºæµ®ç‚¹å‹">æ•´å‹è½¬ä¸ºæµ®ç‚¹å‹</h2><p>ä¸‹é¢ä»¥ä¸€ä¸ªä¾‹å­æ¥ç›´è§‚æ„Ÿå—ä¸€ä¸‹ä¸€ä¸ªæ•´å‹æ˜¯å¦‚ä½•è½¬ä¸ºæµ®ç‚¹å‹çš„ã€‚</p><p>ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ª int32 çš„æ•´å‹<code>123</code>ï¼Œæˆ‘ä»¬å¸Œæœ›å°†å…¶è½¬ä¸ºå•ç²¾åº¦æµ®ç‚¹å‹ <code>123.0</code>ã€‚</p><p><strong>1. å°†æ•´å‹ç”¨äºŒè¿›åˆ¶è¡¨ç¤ºå‡ºæ¥</strong></p><p><span class="math display">\[12345_{(10)} = 1111011_{(2)}\]</span></p><p><strong>2. è§„èŒƒåŒ–è¡¨ç¤º</strong></p><p><span class="math display">\[1111011= 1.111011Ã—2^6\]</span></p><p><strong>3. è®¡ç®—æŒ‡æ•°</strong></p><p><span class="math display">\[exp = 6 + 127 = 133_{(10)} = 10000101_{(2)}\]</span></p><p><strong>4. ç¡®å®šå°¾æ•°**</strong></p><p>è¿™æ˜¯ä¸ªè§„èŒƒåŒ–å€¼ï¼Œæ‰€ä»¥ <code>1.frac</code> çš„ <code>1</code>çœç•¥ï¼Œåˆå› ä¸ºå•ç²¾åº¦æµ®ç‚¹æ•° <code>frac</code> å  23 ä½ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨<code>111011</code> åé¢å†å¡« 17 ä¸ª 0ï¼Œå³ï¼š</p><p><span class="math display">\[frac = 111011 0000 0000 0000 0000 0\]</span></p><p><strong>5. ç¡®å®šç¬¦å·ä½</strong></p><p><span class="math display">\[s = 0_{(2)}\]</span></p><p><strong>6. ç»„åˆèµ·æ¥</strong></p><p><code>12345.0</code> =<code>0  10000101 11101100000000000000000</code></p><h2 id="æµ®ç‚¹æ•°èˆå…¥">æµ®ç‚¹æ•°èˆå…¥</h2><p>ç”±äºæµ®ç‚¹æ•°çš„è¡¨ç¤ºå…·æœ‰å›ºå®šçš„ç²¾åº¦ï¼Œåœ¨è¿›è¡Œè¿ç®—æˆ–è¡¨ç¤ºæ—¶ï¼Œç»å¸¸ä¼šé‡åˆ°æ— æ³•ç²¾ç¡®è¡¨ç¤ºçš„æ•°å€¼ï¼Œè¿™å°±éœ€è¦é‡‡ç”¨èˆå…¥æ–¹æ³•æ¥è¿‘ä¼¼è¡¨ç¤ºè¿™äº›æ•°å€¼ã€‚IEEE-754æ ‡å‡†å®šä¹‰äº†å‡ ç§ä¸åŒçš„èˆå…¥æ¨¡å¼ï¼Œä»¥é€‚åº”ä¸åŒçš„è®¡ç®—éœ€æ±‚ã€‚</p><h3 id="èˆå…¥æ¨¡å¼">èˆå…¥æ¨¡å¼</h3><p><strong>æœ€è¿‘èˆå…¥ï¼ˆRound to Nearestï¼‰</strong>:</p><ul><li>è¿™æ˜¯æœ€å¸¸ç”¨çš„èˆå…¥æ¨¡å¼ï¼Œä¹Ÿæ˜¯é»˜è®¤çš„æ¨¡å¼ã€‚</li><li>è§„åˆ™æ˜¯å‘æœ€æ¥è¿‘çš„å¯è¡¨ç¤ºå€¼èˆå…¥ã€‚å¦‚æœç²¾ç¡®ç»“æœä½äºä¸¤ä¸ªå¯è¡¨ç¤ºå€¼çš„ä¸­ç‚¹ï¼Œé€šå¸¸èˆå…¥åˆ°æœ€è¿‘çš„å¶æ•°ï¼ˆå³å°¾æ•°çš„æœ€åä¸€ä½ä¸º0ï¼‰ã€‚</li><li>è¿™ç§æ–¹æ³•å‡å°‘äº†ç´¯ç§¯è¯¯å·®ï¼Œç¡®ä¿äº†åœ¨å¤šæ¬¡è¿ç®—åçš„æ€»ä½“ç²¾åº¦ã€‚</li></ul><p><strong>å‘é›¶èˆå…¥ï¼ˆRound Toward Zeroï¼‰</strong>:</p><ul><li>è¿™ç§æ¨¡å¼æ€»æ˜¯èˆå…¥åˆ°é›¶çš„æ–¹å‘ï¼Œå³èˆå»å°æ•°éƒ¨åˆ†ã€‚</li><li>å¯¹äºæ­£æ•°ï¼Œè¿™ç›¸å½“äºå–ä¸‹é™ï¼Œå¯¹äºè´Ÿæ•°ï¼Œç›¸å½“äºå–ä¸Šé™ã€‚</li></ul><p><strong>å‘ä¸Šèˆå…¥ï¼ˆRound Upï¼‰</strong>:</p><ul><li>æ— è®ºæ­£è´Ÿï¼Œéƒ½å‘è¿œç¦»é›¶çš„æ–¹å‘èˆå…¥ã€‚</li><li>å¯¹äºæ­£æ•°ï¼Œèˆå…¥åçš„å€¼ä¸å°äºåŸå€¼ï¼›å¯¹äºè´Ÿæ•°ï¼Œèˆå…¥åçš„å€¼ä¸å¤§äºåŸå€¼ã€‚</li></ul><p><strong>å‘ä¸‹èˆå…¥ï¼ˆRound Downï¼‰</strong>:</p><ul><li>æ— è®ºæ­£è´Ÿï¼Œéƒ½å‘æ¥è¿‘é›¶çš„æ–¹å‘èˆå…¥ã€‚</li><li>å¯¹äºæ­£æ•°ï¼Œèˆå…¥åçš„å€¼ä¸å¤§äºåŸå€¼ï¼›å¯¹äºè´Ÿæ•°ï¼Œèˆå…¥åçš„å€¼ä¸å°äºåŸå€¼ã€‚</li></ul><h3 id="èˆå…¥çš„å½±å“">èˆå…¥çš„å½±å“</h3><ul><li><strong>ç²¾åº¦æŸå¤±</strong>ï¼šç”±äºå›ºå®šçš„å°¾æ•°ä½æ•°ï¼Œèˆå…¥å¯èƒ½å¯¼è‡´ç²¾åº¦çš„æŸå¤±ã€‚</li><li><strong>èˆå…¥è¯¯å·®</strong>ï¼šèˆå…¥æ“ä½œæœ¬èº«å¯èƒ½å¼•å…¥è¯¯å·®ï¼Œè¿™äº›è¯¯å·®åœ¨è¿ç»­è¿ç®—ä¸­å¯èƒ½ä¼šç´¯ç§¯ã€‚</li><li><strong>é€‰æ‹©åˆé€‚çš„èˆå…¥æ¨¡å¼</strong>ï¼šä¸åŒçš„èˆå…¥æ¨¡å¼é€‚åˆä¸åŒçš„åº”ç”¨åœºæ™¯ã€‚ä¾‹å¦‚ï¼Œé‡‘èè®¡ç®—å¯èƒ½æ›´å€¾å‘äºä½¿ç”¨å‘é›¶èˆå…¥ï¼Œè€Œç§‘å­¦è®¡ç®—é€šå¸¸ä½¿ç”¨æœ€è¿‘èˆå…¥ä»¥å‡å°‘ç´¯ç§¯è¯¯å·®ã€‚</li></ul><h3 id="å®ä¾‹">å®ä¾‹</h3><table><thead><tr class="header"><th>Mode</th><th style="text-align: center;">1.40</th><th style="text-align: center;">1.60</th><th style="text-align: center;">1.50</th><th style="text-align: center;">2.50</th><th style="text-align: center;">-1.50</th></tr></thead><tbody><tr class="odd"><td>æœ€è¿‘èˆå…¥</td><td style="text-align: center;">1</td><td style="text-align: center;">2</td><td style="text-align: center;">2</td><td style="text-align: center;">2</td><td style="text-align: center;">-2</td></tr><tr class="even"><td>å‘é›¶èˆå…¥</td><td style="text-align: center;">1</td><td style="text-align: center;">1</td><td style="text-align: center;">1</td><td style="text-align: center;">2</td><td style="text-align: center;">-1</td></tr><tr class="odd"><td>å‘ä¸Šèˆå…¥</td><td style="text-align: center;">2</td><td style="text-align: center;">2</td><td style="text-align: center;">2</td><td style="text-align: center;">3</td><td style="text-align: center;">-1</td></tr><tr class="even"><td>å‘ä¸‹èˆå…¥</td><td style="text-align: center;">1</td><td style="text-align: center;">1</td><td style="text-align: center;">1</td><td style="text-align: center;">2</td><td style="text-align: center;">-2</td></tr></tbody></table><h2 id="æµ®ç‚¹æ•°è¿ç®—">æµ®ç‚¹æ•°è¿ç®—</h2><p>å› ä¸ºæµ®ç‚¹æ•°æœ¬èº«å°±å­˜åœ¨ç²¾åº¦é—®é¢˜ï¼Œæ‰€ä»¥æµ®ç‚¹æ•°è¿ç®—åœ¨è®¡ç®—æœºä¸­æ˜¯ä¸€ä¸ªè¿‘ä¼¼è¿‡ç¨‹ï¼Œæ¶‰åŠåˆ°ç²¾ç¡®åº¦çš„æƒè¡¡ã€ç‰¹æ®Šå€¼çš„å¤„ç†ã€é”™è¯¯çš„ä¼ æ’­ï¼Œä»¥åŠèˆå…¥è§„åˆ™çš„åº”ç”¨ã€‚</p><h3 id="æµ®ç‚¹æ•°åŠ å‡">æµ®ç‚¹æ•°åŠ å‡</h3><ol type="1"><li>æµ®ç‚¹æ•°åŠ æ³•å’Œå‡æ³•é¦–å…ˆéœ€è¦å¯¹æ“ä½œæ•°è¿›è¡Œå¯¹é½ï¼Œä½¿å¾—å®ƒä»¬çš„æŒ‡æ•°ç›¸åŒã€‚è¿™å¯èƒ½æ¶‰åŠå°†å°¾æ•°çš„äºŒè¿›åˆ¶è¡¨ç¤ºå‘å³ç§»ä½ï¼Œå¯èƒ½å¯¼è‡´ç²¾åº¦æŸå¤±ã€‚</li><li>ç„¶åæ‰§è¡ŒåŠ æ³•æˆ–å‡æ³•æ“ä½œã€‚</li><li>å¯¹ç»“æœè¿›è¡Œè§„èŒƒåŒ–å’Œèˆå…¥ã€‚</li></ol><p>æ³¨æ„ï¼Œæµ®ç‚¹æ•°çš„åŠ å‡æ³•<strong>ä¸æ»¡è¶³</strong>ç»“åˆå¾‹ã€äº¤æ¢å¾‹å’Œåˆ†é…å¾‹ï¼Œè¿™ä½ ç®€å•åˆ†æä¸‹åº”è¯¥å°±å¯ä»¥ç†è§£äº†ï¼Œè¿™é‡Œä¸èµ˜è¿°äº†ã€‚</p><p>å‡è®¾æˆ‘ä»¬è¦åœ¨å•ç²¾åº¦æµ®ç‚¹æ•°æ ¼å¼ä¸‹è®¡ç®—ï¼š</p><p><span class="math display">\[12.375 + 0.1 = ?\]</span></p><p><strong>ç¬¬ 1 æ­¥ï¼šè½¬ä¸ºäºŒè¿›åˆ¶è¡¨ç¤º</strong></p><p>å…¶ä¸­ 12.375 æˆ‘ä»¬å¯ä»¥ç”¨äºŒè¿›åˆ¶ç²¾ç¡®è¡¨ç¤ºï¼š</p><p><span class="math display">\[12.375_{(10)} = 1100.011_{(2)}\]</span></p><p>è€Œ 0.1 å°±æ¯”è¾ƒç‰¹æ®Šäº†ï¼Œç”¨äºŒè¿›åˆ¶è¡¨ç¤ºçš„è¯å®ƒä¼šæ— é™å¾ªç¯ã€‚</p><blockquote><p>å°†åè¿›åˆ¶å°æ•°è½¬æ¢ä¸ºäºŒè¿›åˆ¶è¡¨ç¤ºæ¶‰åŠåˆ°é‡å¤ä¹˜ä»¥ 2çš„è¿‡ç¨‹ï¼Œå¹¶æå–æ¯æ¬¡ä¹˜æ³•åæ•´æ•°éƒ¨åˆ†ä½œä¸ºäºŒè¿›åˆ¶ä½ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯ä¸€ä¸ªä¸æ–­é‡å¤çš„è¿‡ç¨‹ï¼Œç›´åˆ°å°æ•°éƒ¨åˆ†å˜ä¸º0 æˆ–å¼€å§‹å¾ªç¯ã€‚</p></blockquote><ol type="1"><li><p>å– <code>0.1</code> çš„å°æ•°éƒ¨åˆ†ä¹˜ä»¥ 2ï¼ˆå³<code>0.1 Ã— 2 = 0.2</code>ï¼‰ï¼Œæ•´æ•°éƒ¨åˆ†æ˜¯ <code>0</code>ï¼Œå°æ•°éƒ¨åˆ†æ˜¯<code>0.2</code>ã€‚</p></li><li><p>å†æ¬¡å–å°æ•°éƒ¨åˆ†ä¹˜ä»¥ 2ï¼ˆå³ <code>0.2 Ã— 2 = 0.4</code>ï¼‰ï¼Œæ•´æ•°éƒ¨åˆ†æ˜¯<code>0</code>ï¼Œå°æ•°éƒ¨åˆ†æ˜¯ <code>0.4</code>ã€‚</p></li><li><p>ç»§ç»­è¿™ä¸ªè¿‡ç¨‹ï¼Œæˆ‘ä»¬å¾—åˆ°ä»¥ä¸‹åºåˆ—ï¼š</p><p><code>0.4 Ã— 2 = 0.8</code> â†’ æ•´æ•°éƒ¨åˆ† <code>0</code></p><p><code>0.8 Ã— 2 = 1.6</code> â†’ æ•´æ•°éƒ¨åˆ† <code>1</code></p><p><code>0.6 Ã— 2 = 1.2</code> â†’ æ•´æ•°éƒ¨åˆ† <code>1</code></p><p><code>0.2 Ã— 2 = 0.4</code> â†’ æ•´æ•°éƒ¨åˆ† <code>0</code></p><p>â€¦ï¼ˆå¾ªç¯å¼€å§‹ï¼‰</p></li></ol><p>æ‰€ä»¥ï¼Œ<code>0.1</code> çš„äºŒè¿›åˆ¶è¡¨ç¤ºå¼€å§‹ä¸º<code>0.0001100110011â€¦</code>ï¼Œå¹¶ä¸”è¿™ä¸ªæ¨¡å¼ä¼šæ— é™å¾ªç¯ä¸‹å»ã€‚</p><p><strong>ç¬¬ 2 æ­¥ï¼šè§„æ ¼åŒ–</strong></p><p>å›é¡¾ä¸€ä¸‹è¿™å¼ å›¾ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20231224102703581.png"alt="å•ç²¾åº¦æµ®ç‚¹æ•°" /><figcaption aria-hidden="true">å•ç²¾åº¦æµ®ç‚¹æ•°</figcaption></figure><p>æ‰€ä»¥ 12.375 è§„æ ¼åŒ–è¡¨ç¤ºä¸ºï¼š</p><ul><li>å…ˆè§„èŒƒåŒ–ä¸º 1.xxxx å½¢å¼ï¼š <span class="math inline">\(1100.011_{(2)}= 1.100011 Ã— 2^3\)</span></li><li>æŒ‡æ•°ä¸ºï¼š<span class="math inline">\(3 + 127 = 130 =10000010_{(2)}\)</span></li><li>å°¾æ•°ä¸ºï¼š<spanclass="math inline">\(10001100000000000000000ï¼ˆ23\;ä½ï¼Œå³è¾¹è¡¥\;0ï¼‰\)</span></li><li>æ±‡æ€»ï¼š<spanclass="math inline">\(0\;10000010\;10001100000000000000000\)</span></li></ul><p>è€Œ 0.1 ç”±äºæ— é™å¾ªç¯ï¼Œæˆ‘ä»¬åœ¨å•ç²¾åº¦ä¸‹åªèƒ½ä¿ç•™ 23ä½ï¼Œå¹¶é‡‡ç”¨<strong>æœ€è¿‘èˆå…¥</strong>ï¼Œæ‰€ä»¥ 0.1 è§„æ ¼åŒ–è¡¨ç¤ºä¸ºï¼š</p><ul><li>å…ˆè§„èŒƒä¸º 1.xxxx å½¢å¼ï¼š<spanclass="math inline">\(0.00011001100110011001100(å¾ªç¯) =1.10011001100110011001100 Ã— 2^-4\)</span></li><li>æŒ‡æ•°ä¸ºï¼š<span class="math inline">\(-4 + 127 = 123 =01111011_{(2)}\)</span></li><li>å°¾æ•°ä¸ºï¼š<spanclass="math inline">\(10011001100110011001100\)</span></li><li>æ±‡æ€»ï¼š<spanclass="math inline">\(0\;01111011\;10011001100110011001100\)</span></li></ul><p><strong>ç¬¬ 3 æ­¥ï¼šå¯¹é½æŒ‡æ•°</strong></p><p>å…ˆæŠŠ 2 ä¸ªæµ®ç‚¹è¡¨ç¤ºæ”¾åœ¨ä¸€èµ·ï¼Œå¥½å¯¹æ¯”ï¼š</p><ul><li><spanclass="math inline">\(0\;10000010\;10001100000000000000000\)</span></li><li><spanclass="math inline">\(0\;01111011\;10011001100110011001100\)</span></li></ul><p>å°†ä¸¤ä¸ªæ•°çš„æŒ‡æ•°å¯¹é½ï¼Œè¾ƒå°çš„æŒ‡æ•°å¢åŠ ï¼ŒåŒæ—¶ç›¸åº”åœ°è°ƒæ•´å°¾æ•°ã€‚</p><p>è¿™é‡Œéœ€è¦è°ƒæ•´å°† <code>0.1</code> çš„æŒ‡æ•°ä» <code>01111011</code> è°ƒæ•´åˆ°<code>10000010</code>ï¼Œè¿™é‡ŒåŠ äº† <code>7</code>ï¼Œæ‰€ä»¥ <code>0.1</code>çš„å°¾æ•° <code>1.10011001100110011001100</code>éœ€è¦å³ç§» <code>7</code>ä½ï¼Œå³ï¼š<code>0.00000011001100110011001</code>ã€‚</p><p><strong>ç¬¬ 4 æ­¥ï¼šç›¸åŠ </strong></p><p>ç°åœ¨ä¸¤ä¸ªæ•°çš„æŒ‡æ•°ç›¸åŒäº†ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æŠŠå®ƒä»¬çš„å°¾æ•°ç›¸åŠ ï¼š</p><p><span class="math display">\[\;\;\;1.10001100000000000000000 \\+\;0.00000011001100110011001 \\=\;1.10001111001100110011001\]</span></p><p><strong>ç¬¬ 5 æ­¥ï¼šè§„èŒƒåŒ–ç»“æœ</strong></p><p>è¿™é‡Œæ— éœ€è§„èŒƒåŒ–ã€‚</p><p><strong>ç¬¬ 6 æ­¥ï¼šèˆå…¥</strong></p><p>è¿™é‡Œæ²¡æœ‰è¿›ä½ï¼Œä¸éœ€è¦èˆå…¥ã€‚</p><p><strong>ç¬¬ 7 æ­¥ï¼šæµ®ç‚¹åŒ–è¡¨ç¤º</strong></p><p><span class="math display">\[0\;10000010\;10001111001100110011001\]</span></p><p><strong>ç¬¬ 8 æ­¥ï¼šè½¬ä¸ºåè¿›åˆ¶</strong></p><p><span class="math display">\[V =(-1)^sÃ—MÃ—2^E \\= (-1)^sÃ—1.fracÃ—2^{e-bias} \\= 1.10001111001100110011001 Ã— 2^3 \\= 1100.01111001100110011001_{(2)} \\= 12.47499942779541015625_{(10)} \\â‰ˆ 12.475_{(10)}\]</span></p><h3 id="æµ®ç‚¹æ•°ä¹˜æ³•">æµ®ç‚¹æ•°ä¹˜æ³•</h3><ol type="1"><li><strong>ç¬¦å·ä½è®¡ç®—</strong>ï¼šç»“æœçš„ç¬¦å·ç”±ä¸¤ä¸ªæ“ä½œæ•°çš„ç¬¦å·ä½å†³å®šã€‚å¦‚æœç¬¦å·ä½ç›¸åŒï¼ˆéƒ½æ˜¯æ­£æ•°æˆ–éƒ½æ˜¯è´Ÿæ•°ï¼‰ï¼Œç»“æœä¸ºæ­£ï¼›å¦‚æœç¬¦å·ä½ä¸åŒï¼Œç»“æœä¸ºè´Ÿã€‚</li><li><strong>æŒ‡æ•°ç›¸åŠ </strong>ï¼šä¸¤ä¸ªæ•°çš„æŒ‡æ•°ç›¸åŠ ï¼Œå¹¶å‡å»åç½®å€¼ï¼ˆå•ç²¾åº¦æµ®ç‚¹æ•°ä¸­ä¸º127ï¼ŒåŒç²¾åº¦ä¸º 1023ï¼‰ã€‚</li><li><strong>å°¾æ•°ç›¸ä¹˜</strong>ï¼šä¸¤ä¸ªæ•°çš„å°¾æ•°ç›¸ä¹˜ã€‚è¿™é‡Œçš„å°¾æ•°åŒ…æ‹¬éšå«çš„æœ€é«˜ä½1ã€‚</li><li><strong>ç»“æœè§„èŒƒåŒ–</strong>ï¼šå¦‚æœä¹˜æ³•çš„ç»“æœéœ€è¦è§„èŒƒåŒ–ï¼ˆå³è°ƒæ•´ä¸º<code>1.xxxx</code> çš„å½¢å¼ï¼‰ï¼Œåˆ™ç›¸åº”è°ƒæ•´æŒ‡æ•°ã€‚</li><li><strong>èˆå…¥å¤„ç†</strong>ï¼šå¦‚æœéœ€è¦ï¼Œå¯¹ç»“æœè¿›è¡Œèˆå…¥ä»¥é€‚åº”ç›®æ ‡æ ¼å¼ã€‚</li><li><strong>æ£€æŸ¥æº¢å‡ºæˆ–ä¸‹æº¢</strong>ï¼šå¦‚æœæŒ‡æ•°è¶…å‡ºäº†è¡¨ç¤ºèŒƒå›´ï¼Œåˆ™å‘ç”Ÿæº¢å‡ºï¼ˆç»“æœå¯èƒ½ä¸ºæ— ç©·å¤§æˆ–ç‰¹æ®Šå€¼ï¼‰ï¼›å¦‚æœæŒ‡æ•°å¤ªå°ï¼Œå‘ç”Ÿä¸‹æº¢ï¼ˆç»“æœå¯èƒ½ä¸º0 æˆ–éè§„æ ¼åŒ–æ•°ï¼‰ã€‚</li></ol><p>å‡è®¾æˆ‘ä»¬è¦åœ¨å•ç²¾åº¦æµ®ç‚¹æ•°æ ¼å¼ä¸‹è®¡ç®—ï¼š</p><p><span class="math display">\[2.0 Ã— 3.0 = ?\]</span></p><p><strong>ç¬¬ 1 æ­¥ï¼šè½¬ä¸ºäºŒè¿›åˆ¶è¡¨ç¤º</strong></p><p><span class="math display">\[2.0_{(10)} = 1_{(2)} \\3.0_{(10)} = 11_{(2)}\]</span></p><p><strong>ç¬¬ 2 æ­¥ï¼šè§„èŒƒåŒ–</strong></p><p><span class="math display">\[1 = 1.0 Ã— 2^0 \\11 = 1.1 Ã— 2^1\]</span></p><p><strong>ç¬¬ 3 æ­¥ï¼šæµ®ç‚¹åŒ–</strong></p><p><span class="math display">\[2.0 = 0\;00000001\;00000000000000000000000 \\3.0 = 0\;00000001\;10000000000000000000000\]</span></p><p><strong>ç¬¬ 4 æ­¥ï¼šä¹˜æ³•æ“ä½œ</strong></p><ul><li>ç¬¦å·ä½ï¼šæ­£æ­£å¾—æ­£ï¼š<span class="math inline">\(0_{(2)} Ã— 0_{(2)} =0_{(2)}\)</span></li><li>æŒ‡æ•°ç›¸åŠ å¹¶å‡å»åç½®å€¼ï¼š<spanclass="math inline">\((127+1)+(127+1)-127=129\)</span></li><li>å°¾æ•°ç›¸ä¹˜ï¼š<span class="math inline">\(1.0_{(2)}Ã—1.1_{(2)} =1.1_{(2)}\)</span></li></ul><p><strong>ç¬¬ 5 æ­¥ï¼šè§„èŒƒåŒ–</strong></p><p>è¿™é‡Œæ— éœ€è§„èŒƒåŒ–ã€‚</p><p><strong>ç¬¬ 6 æ­¥ï¼šèˆå…¥</strong></p><p>è¿™é‡Œæ— éœ€èˆå…¥ã€‚</p><p><strong>ç¬¬ 7 æ­¥ï¼šæµ®ç‚¹åŒ–ç»“æœ</strong></p><p><span class="math display">\[0\;00000010\;10000000000000000000000\]</span></p><p><strong>ç¬¬ 8 æ­¥ï¼šè½¬ä¸ºåè¿›åˆ¶</strong></p><p><span class="math display">\[V = (-1)^sÃ—1.fracÃ—2^{(e-127)} \\= 0 Ã— 1.1 Ã— 2^2 \\= 110_{(2)} \\= 6.0_{(10)}\]</span></p><h3 id="æµ®ç‚¹æ•°é™¤æ³•">æµ®ç‚¹æ•°é™¤æ³•</h3><p>æµ®ç‚¹æ•°é™¤æ³•ç±»ä¼¼äºä¹˜æ³•ï¼Œä½†æœ‰ä¸€äº›ä¸åŒï¼š</p><ol type="1"><li><strong>ç¬¦å·ä½è®¡ç®—</strong>ï¼šä¸ä¹˜æ³•ç±»ä¼¼ï¼Œç»“æœçš„ç¬¦å·ç”±ä¸¤ä¸ªæ“ä½œæ•°çš„ç¬¦å·ä½å†³å®šã€‚</li><li><strong>æŒ‡æ•°ç›¸å‡</strong>ï¼šè¢«é™¤æ•°çš„æŒ‡æ•°å‡å»é™¤æ•°çš„æŒ‡æ•°ï¼Œå†åŠ ä¸Šåç½®å€¼ã€‚</li><li><strong>å°¾æ•°ç›¸é™¤</strong>ï¼šè¢«é™¤æ•°çš„å°¾æ•°é™¤ä»¥é™¤æ•°çš„å°¾æ•°ã€‚</li><li><strong>ç»“æœè§„èŒƒåŒ–</strong>ï¼šå¦‚æœå¿…è¦ï¼Œè°ƒæ•´ç»“æœä½¿å…¶è§„èŒƒåŒ–ã€‚</li><li><strong>èˆå…¥å¤„ç†</strong>ï¼šå¦‚æœéœ€è¦ï¼Œå¯¹ç»“æœè¿›è¡Œèˆå…¥ã€‚</li><li><strong>æ£€æŸ¥æº¢å‡ºæˆ–ä¸‹æº¢</strong>ï¼šä¸ä¹˜æ³•ç±»ä¼¼çš„æ£€æŸ¥ã€‚</li></ol><p>å‡è®¾æˆ‘ä»¬è¦åœ¨å•ç²¾åº¦æµ®ç‚¹æ•°æ ¼å¼ä¸‹è®¡ç®—ï¼š</p><p><span class="math display">\[6.0 Ã· 3.0 =?\]</span></p><p><strong>ç¬¬ 1 æ­¥ï¼šè½¬ä¸ºäºŒè¿›åˆ¶è¡¨ç¤º</strong></p><p><span class="math display">\[6.0_{(10)} = 110_{(2)} \\3.0_{(10)} = 11_{(2)}\]</span></p><p><strong>ç¬¬ 2 æ­¥ï¼šè§„èŒƒåŒ–</strong></p><p><span class="math display">\[6.0 = 110 = 1.10 Ã— 2^2 \\3.0 = 11 = 1.1 Ã— 2^1\]</span></p><p><strong>ç¬¬ 3 æ­¥ï¼šæµ®ç‚¹åŒ–</strong></p><p><span class="math display">\[6.0 = 0\;00000020\;10000000000000000000000 \\3.0 = 0\;00000001\;10000000000000000000000\]</span></p><p><strong>ç¬¬ 4 æ­¥ï¼šé™¤æ³•æ“ä½œ</strong></p><ul><li>ç¬¦å·ä½ï¼šæ­£æ­£å¾—æ­£ï¼š<span class="math inline">\(0_{(2)} Ã— 0_{(2)} =0_{(2)}\)</span></li><li>æŒ‡æ•°å‡å¹¶åŠ ä¸Šåç½®å€¼ï¼š<spanclass="math inline">\((127+2)-(127+1)+127=128\)</span></li><li>å°¾æ•°ç›¸é™¤ï¼š<span class="math inline">\(1.1_{(2)}Ã—1.1_{(2)} =1.0_{(2)}\)</span></li></ul><p><strong>ç¬¬ 5 æ­¥ï¼šè§„èŒƒåŒ–</strong></p><p>è¿™é‡Œæ— éœ€è§„èŒƒåŒ–ã€‚</p><p><strong>ç¬¬ 6 æ­¥ï¼šèˆå…¥</strong></p><p>è¿™é‡Œæ— éœ€èˆå…¥ã€‚</p><p><strong>ç¬¬ 7 æ­¥ï¼šæµ®ç‚¹åŒ–ç»“æœ</strong></p><p><span class="math display">\[0\;00000001\;00000000000000000000000\]</span></p><p><strong>ç¬¬ 8 æ­¥ï¼šè½¬ä¸ºåè¿›åˆ¶</strong></p><p><span class="math display">\[V = (-1)^sÃ—1.fracÃ—2^{(e-127)} \\= 0 Ã— 1.0 Ã— 2^1 \\= 10_{(2)} \\= 2.0_{(10)}\]</span></p><h2 id="go-è¯­è¨€è¾“å‡ºæµ®ç‚¹æ•°">Go è¯­è¨€è¾“å‡ºæµ®ç‚¹æ•°</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> number <span class="hljs-type">float32</span> = <span class="hljs-number">12.375</span><br>fmt.Printf(<span class="hljs-string">&quot;æµ®ç‚¹æ•°ï¼š%f\n&quot;</span>, number)<br>fmt.Printf(<span class="hljs-string">&quot;ç§‘å­¦è®¡æ•°æ³•ï¼š%e\n&quot;</span>, number)<br>fmt.Printf(<span class="hljs-string">&quot;ä¿ç•™ 2 ä½å°æ•°ï¼š%.2f\n&quot;</span>, number)<br><br>bits := math.Float32bits(number)<br>bitsStr := fmt.Sprintf(<span class="hljs-string">&quot;%.32b&quot;</span>, bits)<br>fmt.Printf(<span class="hljs-string">&quot;è¾“å‡º32ä½æµ®ç‚¹è¡¨ç¤ºï¼š%s %s %s\n&quot;</span>, bitsStr[:<span class="hljs-number">1</span>], bitsStr[<span class="hljs-number">1</span>:<span class="hljs-number">9</span>], bitsStr[<span class="hljs-number">9</span>:])<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="mathbig">math/big</h2><p>Go è¯­è¨€çš„ <code>math/big</code>åŒ…æä¾›äº†å¯¹å¤§æ•°çš„ç²¾ç¡®è®¡ç®—æ”¯æŒï¼Œè¿™äº›å¤§æ•°çš„å¤§å°è¶…å‡ºäº†æ ‡å‡†æ•´æ•°ç±»å‹ï¼ˆå¦‚<code>int64</code>ï¼‰æˆ–æµ®ç‚¹ç±»å‹ï¼ˆå¦‚<code>float64</code>ï¼‰çš„èŒƒå›´ã€‚è¿™ä¸ªåŒ…ä¸»è¦ç”¨äºéœ€è¦é«˜ç²¾åº¦è®¡ç®—çš„é¢†åŸŸï¼Œå¦‚åŠ å¯†ã€ç§‘å­¦è®¡ç®—ç­‰ã€‚</p><p>ä¸»è¦åŠŸèƒ½ï¼š</p><ul><li><strong>ç®—æœ¯è¿ç®—</strong>ï¼šæ”¯æŒåŸºæœ¬çš„åŠ ã€å‡ã€ä¹˜ã€é™¤ç­‰ç®—æœ¯è¿ç®—ã€‚</li><li><strong>æ¯”è¾ƒæ“ä½œ</strong>ï¼šå¯ä»¥æ¯”è¾ƒä¸¤ä¸ªå¤§æ•°çš„å¤§å°ã€‚</li><li><strong>ä½æ“ä½œ</strong>ï¼šå¯¹å¤§æ•´æ•°è¿›è¡Œä½æ“ä½œï¼Œå¦‚ä½ç§»ã€ä¸ã€æˆ–ã€å¼‚æˆ–ç­‰ã€‚</li><li><strong>è§£æå’Œæ ¼å¼åŒ–</strong>ï¼šå¯ä»¥ä»å­—ç¬¦ä¸²è§£æå¤§æ•°ï¼Œä¹Ÿå¯ä»¥å°†å¤§æ•°æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²ã€‚</li></ul><p>ç¤ºä¾‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>a := big.NewFloat(math.MaxFloat64)<br>b := big.NewFloat(math.MaxFloat64)<br>sum := big.NewFloat(<span class="hljs-number">0</span>)<br>sum.Add(a, b)<br>fmt.Println(<span class="hljs-string">&quot;a:&quot;</span>, a)<br>fmt.Println(<span class="hljs-string">&quot;sum:&quot;</span>, sum)<br>sum2 := big.NewFloat(<span class="hljs-number">0</span>).<br>SetPrec(<span class="hljs-number">15</span>).        <span class="hljs-comment">// è®¾ç½®ç²¾åº¦ï¼Œprec è¶Šå¤§ï¼Œç²¾åº¦è¶Šé«˜ï¼Œè®¡ç®—è¶Šå¤æ‚</span><br>SetMode(big.ToZero) <span class="hljs-comment">// è®¾ç½®èˆå…¥ç­–ç•¥</span><br>sum2.Add(a, b)<br>fmt.Println(<span class="hljs-string">&quot;sum2:&quot;</span>, sum2)<br>&#125;<br><br><span class="hljs-comment">// a: 1.7976931348623157e+308</span><br><span class="hljs-comment">// sum: 3.5953862697246314e+308</span><br><span class="hljs-comment">// sum2: 3.5953e+308</span><br></code></pre></td></tr></table></figure><p>æ³¨æ„äº‹é¡¹ï¼š</p><ul><li><strong>æ€§èƒ½è€ƒè™‘</strong>ï¼šç”±äº <code>math/big</code>æä¾›çš„æ˜¯ä»»æ„ç²¾åº¦è®¡ç®—ï¼Œå…¶æ€§èƒ½é€šå¸¸ä½äºåŸç”Ÿçš„å›ºå®šå¤§å°æ•°å€¼ç±»å‹ã€‚</li><li><strong>å†…å­˜ä½¿ç”¨</strong>ï¼šå¤§æ•°è¿ç®—å¯èƒ½ä¼šæ¶ˆè€—æ›´å¤šçš„å†…å­˜ã€‚</li><li><strong>æ–¹æ³•é“¾å¼è°ƒç”¨</strong>ï¼š<code>math/big</code>çš„è®¸å¤šæ–¹æ³•è¿”å›æ¥æ”¶è€…æœ¬èº«ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨ã€‚</li></ul><h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2><ul><li><ahref="https://people.eecs.berkeley.edu/~wkahan/ieee754status/IEEE754.PDF">IEEE-754</a></li><li>æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ</li><li>Go è¯­è¨€åº•å±‚åŸç†å‰–æ</li><li>https://www.bilibili.com/video/BV1zK4y1j7Cn</li><li>ChatGPT-4</li></ul>]]></content>
    
    
    <categories>
      
      <category>è®¡ç®—æœºåŸºç¡€</category>
      
    </categories>
    
    
    <tags>
      
      <tag>è®¡ç®—æœºåŸç†</tag>
      
      <tag>æµ®ç‚¹æ•°</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go1.21.0 ç¨‹åºå¯åŠ¨è¿‡ç¨‹</title>
    <link href="/2023/12/07/go-start/"/>
    <url>/2023/12/07/go-start/</url>
    
    <content type="html"><![CDATA[<h2 id="ç‰ˆæœ¬è¯´æ˜">ç‰ˆæœ¬è¯´æ˜</h2><ul><li>Go 1.21.0</li><li>æ“ä½œç³»ç»Ÿï¼šWindows11 Intel64</li></ul><h2 id="ç»“è®ºå…ˆè¡Œ">ç»“è®ºå…ˆè¡Œ</h2><h3 id="å¼€å‘å…³æ³¨ç‰ˆ">å¼€å‘å…³æ³¨ç‰ˆ</h3><p>åœ¨ Go è¯­è¨€ä¸­ï¼Œå¯åŠ¨é¡ºåºé€šå¸¸å¦‚ä¸‹ï¼š</p><ol type="1"><li><strong>å¯¼å…¥åŒ…</strong>ï¼šé¦–å…ˆï¼ŒGo ç¼–è¯‘å™¨æŒ‰ç…§æºæ–‡ä»¶ä¸­çš„<code>import</code> è¯­å¥å¯¼å…¥æ‰€æœ‰éœ€è¦çš„åŒ…ã€‚</li><li><strong>åˆå§‹åŒ–å¸¸é‡å’Œå˜é‡</strong>ï¼šæ¥ç€ï¼Œç¼–è¯‘å™¨ä¼šåˆå§‹åŒ–åŒ…çº§åˆ«ï¼ˆå…¨å±€ï¼‰çš„å¸¸é‡å’Œå˜é‡ã€‚å®ƒä»¬çš„åˆå§‹åŒ–é¡ºåºæŒ‰ç…§å®ƒä»¬åœ¨æºæ–‡ä»¶ä¸­å‡ºç°çš„é¡ºåºè¿›è¡Œã€‚</li><li><strong>æ‰§è¡Œ init å‡½æ•°</strong>ï¼šç„¶åï¼Œç¼–è¯‘å™¨ä¼šæ‰§è¡ŒåŒ…çº§åˆ«çš„<code>init</code> å‡½æ•°ã€‚å¦‚æœä¸€ä¸ªåŒ…æœ‰å¤šä¸ª <code>init</code>å‡½æ•°ï¼Œå®ƒä»¬çš„æ‰§è¡Œé¡ºåºå’Œå®ƒä»¬åœ¨æºæ–‡ä»¶ä¸­å‡ºç°çš„é¡ºåºä¸€è‡´ã€‚</li><li><strong>æ‰§è¡Œ main.main å‡½æ•°</strong>ï¼šæœ€åï¼Œç¼–è¯‘å™¨ä¼šæ‰§è¡Œ<code>main</code> å‡½æ•°ã€‚</li></ol><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/710735-20211213134644475-1604352048.png"alt="Go ç¨‹åºå¯åŠ¨æµç¨‹ - å¼€å‘å…³æ³¨ç‰ˆ" /><figcaption aria-hidden="true">Go ç¨‹åºå¯åŠ¨æµç¨‹ - å¼€å‘å…³æ³¨ç‰ˆ</figcaption></figure><h3 id="æ·±å…¥åŸç†ç‰ˆ">æ·±å…¥åŸç†ç‰ˆ</h3><ol type="1"><li><strong>å‘½ä»¤è¡Œå‚æ•°å¤åˆ¶</strong>ï¼šè¯»å–å‘½ä»¤è¡Œå‚æ•°ï¼Œå¤åˆ¶åˆ° argc å’Œargvã€‚</li><li><strong>åˆå§‹åŒ– g0 æ ˆ</strong>ï¼šg0 æ˜¯è¿è¡Œæ—¶ç³»ç»Ÿçš„ä¸€ä¸ªç‰¹æ®Šçš„goroutineï¼Œå®ƒåœ¨ç¨‹åºå¯åŠ¨æ—¶è¢«åˆ›å»ºï¼Œç”¨äºæ‰§è¡Œç³»ç»Ÿè°ƒç”¨å’Œåç¨‹è°ƒåº¦ã€‚</li><li><strong>runtime.check è¿è¡Œæ—¶æ£€æŸ¥</strong>ï¼š<ol type="1"><li>ç±»å‹é•¿åº¦</li><li>æŒ‡é’ˆæ“ä½œ</li><li>ç»“æ„ä½“å­—æ®µåç§»é‡</li><li>CAS</li><li>atomic æ“ä½œ</li><li>æ ˆå¤§å°æ˜¯å¦ä¸º 2 çš„å¹‚æ¬¡ã€‚</li></ol></li><li><strong>runtime.args å‚æ•°åˆå§‹åŒ–</strong>ï¼šå°† argc å’Œ argvçš„å‚æ•°èµ‹å€¼åˆ° Go çš„å˜é‡ä¸­ã€‚</li><li><strong>runtime.osinitåˆå§‹åŒ–æ“ä½œç³»ç»Ÿç‰¹ç‚¹çš„è®¾ç½®</strong>ï¼šä¸»è¦æ˜¯åˆ¤æ–­ç³»ç»Ÿå­—é•¿å’Œ CPU æ ¸æ•°ã€‚</li><li><strong>runtime.schedinit åˆå§‹åŒ–è°ƒåº¦å™¨</strong>ï¼š<ol type="1"><li>é”åˆå§‹åŒ–</li><li>ç«æ€æ£€æµ‹å™¨åˆå§‹åŒ–</li><li>è°ƒåº¦å™¨è®¾ç½®ï¼Œè®¾ç½®è°ƒåº¦å™¨å¯ä»¥ç®¡ç†çš„æœ€å¤§çº¿ç¨‹ï¼ˆMï¼‰æ•°ç›®</li><li>ç³»ç»Ÿåˆå§‹åŒ–ï¼Œåˆå§‹åŒ–å†…å­˜ç®¡ç†ã€CPUè®¾ç½®ã€ç®—æ³•ç­‰ï¼Œè¿™äº›éƒ½æ˜¯è°ƒåº¦å™¨æ­£å¸¸å·¥ä½œçš„åŸºç¡€</li><li>è®¾ç½®å½“å‰ M çš„ä¿¡å·æ©ç </li><li>è§£æç¨‹åºå‚æ•°å’Œç¯å¢ƒå˜é‡</li><li>åƒåœ¾æ”¶é›†å™¨åˆå§‹åŒ–</li><li>è®¾ç½® process çš„æ•°é‡</li></ol></li><li><strong>runtime.newproc åˆ›å»ºä¸»åç¨‹ g0å¹¶å°†å…¶æ”¾å…¥é˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œ</strong>ã€‚</li><li><strong>runtime. mstart å¯åŠ¨è°ƒåº¦å™¨</strong>ï¼šåˆå§‹åŒ– m0ï¼Œå¹¶è°ƒåº¦ g0å»æ‰§è¡Œ <code>runtime.main</code>ã€‚</li><li><strong>runtime.main ç¨‹åºçœŸæ­£å…¥å£</strong>ï¼š<ol type="1"><li>runtime.init</li><li>å¯åŠ¨ gc</li><li>æ‰§è¡Œç”¨æˆ·åŒ… init</li><li>æ‰§è¡Œç”¨æˆ·å‡½æ•° main.main</li></ol></li></ol><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20231210224929126.png"alt="Go ç¨‹åºå¯åŠ¨æµç¨‹ - æ·±å…¥åŸç†ç‰ˆ" /><figcaption aria-hidden="true">Go ç¨‹åºå¯åŠ¨æµç¨‹ - æ·±å…¥åŸç†ç‰ˆ</figcaption></figure><blockquote><p>å¦‚æœåªæ˜¯æƒ³å¯¹ Goè¯­è¨€ç¨‹åºçš„å¯åŠ¨è¿‡ç¨‹æœ‰ä¸€ä¸ªç®€å•çš„äº†è§£ï¼Œé‚£ä¹ˆé˜…è¯»åˆ°è¿™é‡Œå°±å¯ä»¥ç»“æŸäº†ã€‚</p></blockquote><h2 id="runtime">Runtime</h2><p>åœ¨åˆ†æ Go ç¨‹åºçš„å¯åŠ¨è¿‡ç¨‹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ä¸€ä¸‹ Go ä¸­çš„Runtimeã€‚æ‰€è°“ Runtimeï¼Œå³ Go çš„è¿è¡Œæ—¶ç¯å¢ƒï¼Œå¯ä»¥ç†è§£ä¸º Java çš„JVMã€JavaScript ä¾èµ–çš„æµè§ˆå™¨å†…æ ¸ã€‚</p><p>Go çš„ Runtimeæ˜¯ä¸€ä»½ä»£ç ï¼Œå®ƒä¼šéšç€ç”¨æˆ·ç¨‹åºä¸€èµ·æ‰“åŒ…æˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œéšç€ç¨‹åºä¸€èµ·è¿è¡Œã€‚</p><p>Runtime å…·æœ‰å†…å­˜ç®¡ç†ã€GCã€åç¨‹ã€å±è”½ä¸åŒæ“ä½œç³»ç»Ÿè°ƒç”¨ç­‰èƒ½åŠ›ã€‚</p><p>ç»¼ä¸Šï¼ŒGo ç¨‹åºçš„è¿è¡Œéƒ½ä¾èµ–äº Runtime è¿è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨åˆ†æ Goè¯­è¨€ç¨‹åºçš„å¯åŠ¨è¿‡ç¨‹çš„æ—¶å€™ï¼Œé¦–å…ˆè¦ç¡®å®šç¨‹åºçš„å…¥å£ï¼Œå³ Runtimeã€‚</p><p>è¿™éƒ¨åˆ†ä»£ç ä½äº go æºç ä¸­ <ahref="https://github.com/golang/go/tree/go1.21.0/src/runtime">src/runtime</a>ç›®å½•ä¸‹ï¼Œå½“ä½ åœ¨æœ¬æœºå®‰è£… go åï¼Œä½ å¯ä»¥è¿›å…¥ç›¸åº”çš„ä»£ç ç›®å½•ä¸‹ï¼Œåœ¨ Windowsä¸Šï¼Œä½ å¯ä»¥åœ¨è¯¥ç›®å½•ä¸‹è¿è¡Œä¸‹é¢å‘½ä»¤ï¼š</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">dir</span> | findstr <span class="hljs-string">&quot;rt0&quot;</span> |  findstr <span class="hljs-string">&quot;amd&quot;</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬è¾“å‡º go å®˜æ–¹ä¸ºå¤šç§ <code>amd</code>å¤„ç†å™¨æ¶æ„çš„æ“ä½œç³»ç»Ÿæ‰€å®ç°çš„ runtimeï¼Œå¦‚ï¼š</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-literal">-a----</span>         <span class="hljs-number">2023</span>/<span class="hljs-number">8</span>/<span class="hljs-number">25</span>     <span class="hljs-number">23</span>:<span class="hljs-number">44</span>            <span class="hljs-number">754</span> rt0_android_amd64.s<br><span class="hljs-literal">-a----</span>         <span class="hljs-number">2023</span>/<span class="hljs-number">8</span>/<span class="hljs-number">25</span>     <span class="hljs-number">23</span>:<span class="hljs-number">44</span>            <span class="hljs-number">399</span> rt0_darwin_amd64.s<br><span class="hljs-literal">-a----</span>         <span class="hljs-number">2023</span>/<span class="hljs-number">8</span>/<span class="hljs-number">25</span>     <span class="hljs-number">23</span>:<span class="hljs-number">44</span>            <span class="hljs-number">448</span> rt0_dragonfly_amd64.s<br><span class="hljs-literal">-a----</span>         <span class="hljs-number">2023</span>/<span class="hljs-number">8</span>/<span class="hljs-number">25</span>     <span class="hljs-number">23</span>:<span class="hljs-number">44</span>            <span class="hljs-number">442</span> rt0_freebsd_amd64.s<br><span class="hljs-literal">-a----</span>         <span class="hljs-number">2023</span>/<span class="hljs-number">8</span>/<span class="hljs-number">25</span>     <span class="hljs-number">23</span>:<span class="hljs-number">44</span>            <span class="hljs-number">311</span> rt0_illumos_amd64.s<br><span class="hljs-literal">-a----</span>         <span class="hljs-number">2023</span>/<span class="hljs-number">8</span>/<span class="hljs-number">25</span>     <span class="hljs-number">23</span>:<span class="hljs-number">44</span>            <span class="hljs-number">425</span> rt0_ios_amd64.s<br><span class="hljs-literal">-a----</span>         <span class="hljs-number">2023</span>/<span class="hljs-number">8</span>/<span class="hljs-number">25</span>     <span class="hljs-number">23</span>:<span class="hljs-number">44</span>            <span class="hljs-number">307</span> rt0_linux_amd64.s<br><span class="hljs-literal">-a----</span>         <span class="hljs-number">2023</span>/<span class="hljs-number">8</span>/<span class="hljs-number">25</span>     <span class="hljs-number">23</span>:<span class="hljs-number">44</span>            <span class="hljs-number">309</span> rt0_netbsd_amd64.s<br><span class="hljs-literal">-a----</span>         <span class="hljs-number">2023</span>/<span class="hljs-number">8</span>/<span class="hljs-number">25</span>     <span class="hljs-number">23</span>:<span class="hljs-number">44</span>            <span class="hljs-number">311</span> rt0_openbsd_amd64.s<br><span class="hljs-literal">-a----</span>         <span class="hljs-number">2023</span>/<span class="hljs-number">8</span>/<span class="hljs-number">25</span>     <span class="hljs-number">23</span>:<span class="hljs-number">44</span>            <span class="hljs-number">481</span> rt0_plan9_amd64.s<br><span class="hljs-literal">-a----</span>         <span class="hljs-number">2023</span>/<span class="hljs-number">8</span>/<span class="hljs-number">25</span>     <span class="hljs-number">23</span>:<span class="hljs-number">44</span>            <span class="hljs-number">311</span> rt0_solaris_amd64.s<br><span class="hljs-literal">-a----</span>         <span class="hljs-number">2023</span>/<span class="hljs-number">8</span>/<span class="hljs-number">25</span>     <span class="hljs-number">23</span>:<span class="hljs-number">44</span>           <span class="hljs-number">1166</span> rt0_windows_amd64.s<br></code></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œä¹Ÿå°±æ˜ç™½äº†ï¼Œå‰é¢æ‰€è¯´çš„ Go Runtime èƒ½åŠ›ä¹‹â€œå±è”½ä¸åŒæ“ä½œç³»ç»Ÿè°ƒç”¨èƒ½åŠ›â€çš„æ–¹å¼ä¾¿æ˜¯é’ˆå¯¹æ¯ä¸€ç§æ“ä½œç³»ç»Ÿå•ç‹¬åšå®ç°ï¼Œæœ€ååœ¨ç¼–è¯‘çš„æ—¶å€™æ ¹æ®æ“ä½œç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„å®ç°å³å¯ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬ä»¥ <ahref="https://github.com/golang/go/blob/go1.21.0/src/runtime/rt0_windows_amd64.s">rt0_windows_amd64.s</a>ä¸ºä¾‹ï¼Œçœ‹çœ‹è¿™ä¸ªæ–‡ä»¶å†™äº†äº›ä»€ä¹ˆï¼š</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">TEXT</span> _rt0_amd64_windows(<span class="hljs-built_in">SB</span>),NOSPLIT<span class="hljs-title">|NOFRAME,$-8</span><br><span class="hljs-title">JMP_rt0_amd64(SB)</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒä¼šç›´æ¥è·³åˆ° <code>_rt0_amd64(SB)</code> è¿™é‡Œï¼Œåœ¨Goland IDE ä¸­ï¼Œä½ å¯ä»¥åŒå‡» Shift é”®æ‰“å¼€æœç´¢ï¼Œæœç´¢<code>TEXT _rt0_amd64</code>ï¼Œå°±å¯ä»¥å‘ç°è¿™ä¸ªå‡½æ•°ä½äº <ahref="https://github.com/golang/go/blob/go1.21.0/src/runtime/asm_amd64.s">asm_amd64.s</a>æ–‡ä»¶ä¸­ï¼ŒæŸ¥çœ‹è¯¥æ–‡ä»¶ï¼š</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-comment">// _rt0_amd64 is common startup code for most amd64 systems when using</span><br><span class="hljs-comment">// internal linking. This is the entry point for the program from the</span><br><span class="hljs-comment">// kernel for an ordinary -buildmode=exe program. The stack holds the</span><br><span class="hljs-comment">// number of arguments and the C-style argv.</span><br><span class="hljs-symbol">TEXT</span> _rt0_amd64(<span class="hljs-built_in">SB</span>),NOSPLIT,$-<span class="hljs-number">8</span><br>MOVQ<span class="hljs-number">0</span>(<span class="hljs-built_in">SP</span>), DI<span class="hljs-comment">// argc</span><br>LEAQ<span class="hljs-number">8</span>(<span class="hljs-built_in">SP</span>), SI<span class="hljs-comment">// argv</span><br>JMPruntimeÂ·rt0_go(<span class="hljs-built_in">SB</span>)<br></code></pre></td></tr></table></figure><p>ç¿»è¯‘ä¸€ä¸‹ä¸Šé¢çš„æ³¨é‡Šï¼š<code>_rt0_amd64</code> æ˜¯å¤§å¤šæ•°<code>amd64</code> ç³»ç»Ÿåœ¨ä½¿ç”¨å†…éƒ¨é“¾æ¥æ—¶çš„é€šç”¨å¯åŠ¨ä»£ç ã€‚è¿™æ˜¯<code>exe</code> ç¨‹åºä»å†…æ ¸è¿›å…¥ç¨‹åºçš„å…¥å£ç‚¹ã€‚å †æ ˆä¿å­˜äº†å‚æ•°çš„æ•°é‡å’Œ Cè¯­è¨€é£æ ¼çš„ argvã€‚</p><p>åˆ°è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥éå¸¸ç¡®å®šåœ°æ‰¾åˆ°äº†å¯¹åº”æ“ä½œç³»ç»Ÿçš„ Goè¯­è¨€ç¨‹åºå¯åŠ¨å…¥å£äº†ï¼Œæ¥ä¸‹æ¥åªéœ€è¦æ²¿ç€è¯¥å…¥å£ç»§ç»­åˆ†æå³å¯ã€‚</p><h2 id="runtimert0_go">runtimeÂ·rt0_go</h2><p>ä¸Šé¢æˆ‘ä»¬åˆ†æåˆ° <code>_rt0_adm64</code> ä¼š JMP åˆ°<code>runtimeÂ·rt0_go</code> æ‰§è¡Œï¼Œè¿™ä¸ªå‡½æ•°ä¹Ÿä½äº <ahref="https://github.com/golang/go/blob/go1.21.0/src/runtime/asm_amd64.s">asm_amd64.s</a>æ–‡ä»¶ä¸­ï¼Œé€šè¿‡åˆ†æè¿™ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥äº†è§£åˆ° Go è¯­è¨€ç¨‹åºçš„æ•´ä¸ªå¯åŠ¨è¿‡ç¨‹ã€‚</p><p>ä¸‹é¢å°†å¯¹è¿™æ•´ä¸ªå‡½æ•°è¿›è¡Œä¸€ä¸ªæ¦‚è§ˆï¼Œåé¢ä¼šå¯¹é‡ç‚¹è¿‡ç¨‹é€ä¸ªè¯¦è¿°ã€‚</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">TEXT</span> runtimeÂ·rt0_go(<span class="hljs-built_in">SB</span>),NOSPLIT<span class="hljs-title">|NOFRAME|</span>TOPFRAME,<span class="hljs-number">$0</span><br><span class="hljs-comment">// è¯»å–å‘½ä»¤è¡Œå‚æ•°ï¼Œå¤åˆ¶å‚æ•°å˜é‡ argc å’Œ argv åˆ°æ ˆä¸Š</span><br>MOVQDI, AX<span class="hljs-comment">// argc</span><br>MOVQSI, <span class="hljs-keyword">BX</span><span class="hljs-comment">// argv</span><br>SUBQ$(<span class="hljs-number">5</span>*<span class="hljs-number">8</span>), <span class="hljs-built_in">SP</span><br>ANDQ$~<span class="hljs-number">15</span>, <span class="hljs-built_in">SP</span><br>MOVQAX, <span class="hljs-number">24</span>(<span class="hljs-built_in">SP</span>)<br>MOVQBX, <span class="hljs-number">32</span>(<span class="hljs-built_in">SP</span>)<br><br><span class="hljs-comment">// ä»ç»™å®šçš„ï¼ˆæ“ä½œç³»ç»Ÿï¼‰å †æ ˆåˆ›å»ºistackã€‚</span><br><span class="hljs-comment">// è¿™æ˜¯åœ¨è®¾ç½® g0 çš„å †æ ˆï¼Œg0 æ˜¯è¿è¡Œæ—¶ç³»ç»Ÿçš„ä¸€ä¸ªç‰¹æ®Šçš„ goroutineã€‚</span><br><span class="hljs-comment">// å®ƒåœ¨ç¨‹åºå¯åŠ¨æ—¶è¢«åˆ›å»ºï¼Œç”¨äºæ‰§è¡Œç³»ç»Ÿè°ƒç”¨å’Œåç¨‹è°ƒåº¦ã€‚</span><br><span class="hljs-comment">// è¿™é‡Œåªæ˜¯åˆå§‹åŒ– g0 çš„å †æ ˆï¼Œè¿˜æ²¡æœ‰å¯åŠ¨ g0ã€‚</span><br>MOVQ$runtimeÂ·g0(<span class="hljs-built_in">SB</span>), DI<br>LEAQ(-<span class="hljs-number">64</span>*<span class="hljs-number">1024</span>)(<span class="hljs-built_in">SP</span>), <span class="hljs-keyword">BX</span><br>MOVQBX, g_stackguard0(DI)<br>MOVQBX, g_stackguard1(DI)<br>MOVQBX, (g_stack+stack_lo)(DI)<br>MOVQ<span class="hljs-built_in">SP</span>, (g_stack+stack_hi)(DI)<br><br><span class="hljs-comment">// æ£€æŸ¥ CPU çš„å‚å•† IDï¼š</span><br><span class="hljs-comment">//å¦‚æœæ²¡æœ‰ CPU ä¿¡æ¯ï¼Œåˆ™è·³è½¬åˆ° nocpuinfoï¼›</span><br><span class="hljs-comment">//å¦‚æœæ˜¯ Intel çš„ CPUï¼Œå°±è®¾ç½® runtimeÂ·isIntel=1ï¼Œå¦åˆ™è·³åˆ° notintelã€‚</span><br>MOVL<span class="hljs-number">$0</span>, AX<br>CPUID<br>CMPLAX, <span class="hljs-number">$0</span><br>JEnocpuinfo<br>CMPLBX, <span class="hljs-number">$0x756E6547</span>  <span class="hljs-comment">// &quot;Genu&quot;</span><br>JNEnotintel<br>CMPLDX, <span class="hljs-number">$0x49656E69</span>  <span class="hljs-comment">// &quot;ineI&quot;</span><br>JNEnotintel<br>CMPLCX, <span class="hljs-number">$0x6C65746E</span>  <span class="hljs-comment">// &quot;ntel&quot;</span><br>JNEnotintel<br>MOVB<span class="hljs-number">$1</span>, runtimeÂ·isIntel(<span class="hljs-built_in">SB</span>)<br><br><span class="hljs-symbol">notintel:</span>  <span class="hljs-comment">// åŠ è½½ EXA=1 çš„ cpuid æ ‡å¿—å’Œç‰ˆæœ¬ä¿¡æ¯</span><br>MOVL<span class="hljs-number">$1</span>, AX<br>CPUID<br>MOVLAX, runtimeÂ·processorVersionInfo(<span class="hljs-built_in">SB</span>)<br><br><span class="hljs-symbol">nocpuinfo:</span>  <br><span class="hljs-comment">// å¦‚æœæœ‰ _cgo_init å°±è°ƒç”¨å®ƒ</span><br>MOVQ_cgo_init(<span class="hljs-built_in">SB</span>), AX<br>TESTQAX, AX<br><span class="hljs-comment">// å¦‚æœ _cgo_init ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆè·³è¿‡åé¢çš„ä»£ç ï¼Œ</span><br><span class="hljs-comment">// ç›´æ¥è¿›å…¥åˆ° needtls è¿›è¡Œ TLS çš„åˆå§‹åŒ–ã€‚</span><br><span class="hljs-comment">// TLSï¼Œå…¨ç§°ä¸ºThread-Local Storageï¼ˆçº¿ç¨‹å±€éƒ¨å­˜å‚¨ï¼‰ï¼Œ</span><br><span class="hljs-comment">// æ˜¯æ“ä½œç³»ç»Ÿæä¾›çš„ä¸€ç§æœºåˆ¶ï¼Œå…è®¸æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰ä¸€ä»½è‡ªå·±çš„æ•°æ®å‰¯æœ¬ã€‚</span><br><span class="hljs-comment">// è¿™äº›æ•°æ®åœ¨åŒä¸€çº¿ç¨‹çš„æ‰€æœ‰å‡½æ•°ä¸­éƒ½æ˜¯å¯è§çš„ï¼Œä½†å¯¹å…¶ä»–çº¿ç¨‹æ˜¯ä¸å¯è§çš„ã€‚</span><br><span class="hljs-comment">// è¿™æ ·ï¼Œæ¯ä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®å’Œä¿®æ”¹è‡ªå·±çš„æ•°æ®ï¼Œè€Œä¸ä¼šå½±å“å…¶ä»–çº¿ç¨‹ã€‚</span><br>JZneedtls<br><span class="hljs-comment">// å°† setg_gcc å‡½æ•°çš„åœ°å€åŠ è½½åˆ° SI å¯„å­˜å™¨ä¸­ã€‚</span><br><span class="hljs-comment">// è¿™æ˜¯ _cgo_init å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ã€‚</span><br>MOVQ$setg_gcc&lt;&gt;(<span class="hljs-built_in">SB</span>), SI <span class="hljs-comment">// arg 2: setg_gcc</span><br><span class="hljs-comment">// åœ¨ä½¿ç”¨å¹³å°çš„TLSæ—¶ä¸ä½¿ç”¨è¿™ç¬¬3å’Œç¬¬4ä¸ªå‚æ•°ã€‚</span><br>MOVQ<span class="hljs-number">$0</span>, DX<br>MOVQ<span class="hljs-number">$0</span>, CX<br><span class="hljs-comment">#ifdef GOOS_android</span><br>MOVQ$runtimeÂ·tls_g(<span class="hljs-built_in">SB</span>), DX <span class="hljs-comment">// arg 3: &amp;tls_g</span><br><span class="hljs-comment">// arg 4: TLS base, stored in slot 0 (Android&#x27;s TLS_SLOT_SELF).</span><br><span class="hljs-comment">// Compensate for tls_g (+16).</span><br>MOVQ-<span class="hljs-number">16</span>(TLS), CX<br><span class="hljs-comment">#endif</span><br><span class="hljs-comment">#ifdef GOOS_windows</span><br>MOVQ$runtimeÂ·tls_g(<span class="hljs-built_in">SB</span>), DX <span class="hljs-comment">// arg 3: &amp;tls_g</span><br><span class="hljs-comment">// è°ƒæ•´ Win64 çš„è°ƒç”¨çº¦å®šã€‚</span><br>MOVQCX, <span class="hljs-built_in">R9</span> <span class="hljs-comment">// arg 4</span><br>MOVQDX, <span class="hljs-built_in">R8</span> <span class="hljs-comment">// arg 3</span><br>MOVQSI, DX <span class="hljs-comment">// arg 2</span><br>MOVQDI, CX <span class="hljs-comment">// arg 1</span><br><span class="hljs-comment">#endif</span><br><span class="hljs-comment">// å‰é¢ MOVQ_cgo_init(SB), AXï¼Œè¿™é‡Œå°±æ˜¯è°ƒç”¨ _cgo_init</span><br>CALLAX<br><span class="hljs-comment">// åœ¨ _cgo_init ä¹‹åæ›´æ–° stackguard</span><br>MOVQ$runtimeÂ·g0(<span class="hljs-built_in">SB</span>), CX<br>MOVQ(g_stack+stack_lo)(CX), AX<br>ADDQ$const_stackGuard, AX<br>MOVQAX, g_stackguard0(CX)<br>MOVQAX, g_stackguard1(CX)<br><br><span class="hljs-comment">#ifndef GOOS_windows</span><br>JMP ok<br><span class="hljs-comment">#endif</span><br><br><span class="hljs-comment">// é’ˆå¯¹ä¸åŒæ“ä½œç³»ç»Ÿå¯¹ TLS è¿›è¡Œè®¾ç½®</span><br><span class="hljs-symbol">needtls:</span>  <br><span class="hljs-comment">#ifdef GOOS_plan9</span><br><span class="hljs-comment">// skip TLS setup on Plan 9</span><br>JMP ok<br><span class="hljs-comment">#endif</span><br><span class="hljs-comment">#ifdef GOOS_solaris</span><br><span class="hljs-comment">// skip TLS setup on Solaris</span><br>JMP ok<br><span class="hljs-comment">#endif</span><br><span class="hljs-comment">#ifdef GOOS_illumos</span><br><span class="hljs-comment">// skip TLS setup on illumos</span><br>JMP ok<br><span class="hljs-comment">#endif</span><br><span class="hljs-comment">#ifdef GOOS_darwin</span><br><span class="hljs-comment">// skip TLS setup on Darwin</span><br>JMP ok<br><span class="hljs-comment">#endif</span><br><span class="hljs-comment">#ifdef GOOS_openbsd</span><br><span class="hljs-comment">// skip TLS setup on OpenBSD</span><br>JMP ok<br><span class="hljs-comment">#endif</span><br><br><span class="hljs-comment">#ifdef GOOS_windows</span><br>CALLruntimeÂ·wintls(<span class="hljs-built_in">SB</span>)<br><span class="hljs-comment">#endif</span><br><br>LEAQruntimeÂ·m0+m_tls(<span class="hljs-built_in">SB</span>), DI<br>CALLruntimeÂ·settls(<span class="hljs-built_in">SB</span>)<br><br><span class="hljs-comment">// æ£€æŸ¥ TLS æ˜¯å¦æ­£å¸¸å·¥ä½œ</span><br>get_tls(BX)<br>MOVQ<span class="hljs-number">$0x123</span>, g(BX)<br>MOVQruntimeÂ·m0+m_tls(<span class="hljs-built_in">SB</span>), AX<br>CMPQAX, <span class="hljs-number">$0x123</span><br>JEQ <span class="hljs-number">2</span>(<span class="hljs-built_in">PC</span>)<br>CALLruntimeÂ·abort(<span class="hljs-built_in">SB</span>)<br><span class="hljs-symbol">ok:</span><br><span class="hljs-comment">//è®¾ç½® g0 å’Œ m0 å’Œ TLS</span><br>get_tls(BX)<br>LEAQruntimeÂ·g0(<span class="hljs-built_in">SB</span>), CX<br>MOVQCX, g(BX)<br>LEAQruntimeÂ·m0(<span class="hljs-built_in">SB</span>), AX<br>MOVQCX, m_g0(AX)<br>MOVQAX, g_m(CX)<br>CLD<br><br><span class="hljs-comment">// ä¸‹é¢çš„ ifdef NEED_xxx ä¸»è¦æ˜¯åœ¨æ£€æŸ¥ CPU æ˜¯å¦æ”¯æŒ Go è¿è¡Œæ—¶ç³»ç»Ÿéœ€è¦çš„ç‰¹æ€§ã€‚</span><br><span class="hljs-comment">// æˆ‘ä»¬éœ€è¦åœ¨è®¾ç½®äº† TLS ä¹‹ååšè¿™ä¸ªï¼Œ</span><br><span class="hljs-comment">// å¦‚æœå¤±è´¥å°±è·³è½¬åˆ° bad_cpu æŠ¥å‘Šé”™è¯¯ã€‚</span><br><span class="hljs-comment">#ifdef NEED_FEATURES_CX</span><br>MOVL<span class="hljs-number">$0</span>, AX<br>CPUID<br>CMPLAX, <span class="hljs-number">$0</span><br>JEbad_cpu<br>MOVL<span class="hljs-number">$1</span>, AX<br>CPUID<br>ANDL$NEED_FEATURES_CX, CX<br>CMPLCX, $NEED_FEATURES_CX<br>JNEbad_cpu<br><span class="hljs-comment">#endif</span><br><br><span class="hljs-comment">#ifdef NEED_MAX_CPUID</span><br>MOVL<span class="hljs-number">$0x80000000</span>, AX<br>CPUID<br>CMPLAX, $NEED_MAX_CPUID<br>JLbad_cpu<br><span class="hljs-comment">#endif</span><br><br><span class="hljs-comment">#ifdef NEED_EXT_FEATURES_BX</span><br>MOVL<span class="hljs-number">$7</span>, AX<br>MOVL<span class="hljs-number">$0</span>, CX<br>CPUID<br>ANDL$NEED_EXT_FEATURES_BX, <span class="hljs-keyword">BX</span><br>CMPLBX, $NEED_EXT_FEATURES_BX<br>JNEbad_cpu<br><span class="hljs-comment">#endif</span><br><br><span class="hljs-comment">#ifdef NEED_EXT_FEATURES_CX</span><br>MOVL<span class="hljs-number">$0x80000001</span>, AX<br>CPUID<br>ANDL$NEED_EXT_FEATURES_CX, CX<br>CMPLCX, $NEED_EXT_FEATURES_CX<br>JNEbad_cpu<br><span class="hljs-comment">#endif</span><br><br><span class="hljs-comment">#ifdef NEED_OS_SUPPORT_AX</span><br>XORL    CX, CX<br>XGETBV<br>ANDL$NEED_OS_SUPPORT_AX, AX<br>CMPLAX, $NEED_OS_SUPPORT_AX<br>JNEbad_cpu<br><span class="hljs-comment">#endif</span><br><br><span class="hljs-comment">#ifdef NEED_DARWIN_SUPPORT</span><br>MOVQ$commpage64_version, <span class="hljs-keyword">BX</span><br>CMPW(BX), <span class="hljs-number">$13</span>  <span class="hljs-comment">// cpu_capabilities64 undefined in versions &lt; 13</span><br>JLbad_cpu<br>MOVQ$commpage64_cpu_capabilities64, <span class="hljs-keyword">BX</span><br>MOVQ(BX), <span class="hljs-keyword">BX</span><br>MOVQ$NEED_DARWIN_SUPPORT, CX<br>ANDQCX, <span class="hljs-keyword">BX</span><br>CMPQBX, CX<br>JNEbad_cpu<br><span class="hljs-comment">#endif</span><br><br><span class="hljs-comment">// æ£€æŸ¥å®Œ AMD64 ä¸åŒæ“ä½œç³»ç»Ÿæ˜¯å¦æ”¯æŒ Go è¿è¡Œæ—¶ç³»ç»Ÿéœ€è¦çš„ç‰¹æ€§åï¼Œ</span><br><span class="hljs-comment">// è¿™é‡Œæ‰§è¡Œ runtimeÂ·check å¯¹ä»£ç åšä¸€ä¸‹è¿è¡Œæ—¶æ£€æŸ¥ã€‚</span><br>CALLruntimeÂ·check(<span class="hljs-built_in">SB</span>)<br><br><span class="hljs-comment">// å¤åˆ¶ argcï¼ˆå‘½ä»¤è¡Œå‚æ•°çš„æ•°é‡ï¼‰åˆ° AX å¯„å­˜å™¨ï¼Œ</span><br><span class="hljs-comment">// ç„¶åæŠŠ AX å¯„å­˜å™¨çš„å€¼å­˜åˆ°æ ˆä¸Šã€‚</span><br>MOVL<span class="hljs-number">24</span>(<span class="hljs-built_in">SP</span>), AX<br>MOVLAX, <span class="hljs-number">0</span>(<span class="hljs-built_in">SP</span>)<br><span class="hljs-comment">// å¤åˆ¶ argvï¼ˆå‘½ä»¤è¡Œå‚æ•°çš„æ•°ç»„ï¼‰åˆ° AX å¯„å­˜å™¨ï¼Œ</span><br><span class="hljs-comment">// ç„¶åæŠŠ AX å¯„å­˜å™¨çš„å€¼å­˜åˆ°æ ˆä¸Šã€‚</span><br>MOVQ<span class="hljs-number">32</span>(<span class="hljs-built_in">SP</span>), AX<br>MOVQAX, <span class="hljs-number">8</span>(<span class="hljs-built_in">SP</span>)<br><span class="hljs-comment">// è°ƒç”¨ runtimeÂ·args å‡½æ•°å¤„ç†å‘½ä»¤è¡Œå‚æ•°ã€‚</span><br>CALLruntimeÂ·args(<span class="hljs-built_in">SB</span>)<br><span class="hljs-comment">// è°ƒç”¨ runtimeÂ·osinit å‡½æ•°åˆå§‹åŒ–æ“ä½œç³»ç»Ÿç‰¹å®šçš„è®¾ç½®ã€‚</span><br>CALLruntimeÂ·osinit(<span class="hljs-built_in">SB</span>)<br><span class="hljs-comment">// è°ƒç”¨ runtimeÂ·schedinit å‡½æ•°åˆå§‹åŒ–è°ƒåº¦å™¨ã€‚</span><br>CALLruntimeÂ·schedinit(<span class="hljs-built_in">SB</span>)<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">   è¡¥å……ï¼šè¿™æ˜¯è¯¥æ–‡ä»¶ä¸‹é¢å¯¹ runtimeÂ·mainPC çš„å£°æ˜</span><br><span class="hljs-comment">    // mainPC is a function value for runtime.main, to be passed to newproc.</span><br><span class="hljs-comment">    // The reference to runtime.main is made via ABIInternal, since the</span><br><span class="hljs-comment">    // actual function (not the ABI0 wrapper) is needed by newproc.</span><br><span class="hljs-comment">    DATAruntimeÂ·mainPC+0(SB)/8,$runtimeÂ·main&lt;ABIInternal&gt;(SB)</span><br><span class="hljs-comment">    */</span><br>        <br>    <span class="hljs-comment">// å– runtimeÂ·mainPC çš„åœ°å€ï¼Œè¿™å…¶å®å°±æ˜¯ runtime åŒ…ä¸‹çš„ main() æ–¹æ³•ã€‚</span><br>    <span class="hljs-comment">// å®ƒæ˜¯ Go è¯­è¨€ç¨‹åºçš„çœŸæ­£å…¥å£ï¼Œè€Œä¸æ˜¯ main.main()ã€‚</span><br>MOVQ$runtimeÂ·mainPC(<span class="hljs-built_in">SB</span>), AX<br>PUSHQAX<br>    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„ goroutine æ¥è¿è¡Œç¨‹åºçš„ä¸»å‡½æ•°ã€‚</span><br>    <span class="hljs-comment">// è¿™é‡Œè¿˜æ²¡æœ‰æ­£åœ¨çš„è¿è¡Œï¼Œå› ä¸ºè°ƒåº¦å™¨è¿˜æ²¡æœ‰å¯åŠ¨ï¼Œ</span><br>    <span class="hljs-comment">// åªæ˜¯å°† runtime.main æ”¾è¿› goroutine çš„ queue ä¸­ç­‰å¾…æ‰§è¡Œã€‚</span><br>CALLruntimeÂ·newproc(<span class="hljs-built_in">SB</span>)<br>POPQAX<br><br><span class="hljs-comment">// è°ƒç”¨ runtimeÂ·mstart å‡½æ•°å¯åŠ¨ Mï¼ˆmachineï¼Œä»£è¡¨ä¸€ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼‰ï¼Œ</span><br><span class="hljs-comment">// å¼€å§‹æ‰§è¡Œ goroutinesã€‚</span><br>CALLruntimeÂ·mstart(<span class="hljs-built_in">SB</span>)<br><br><span class="hljs-comment">//  å¦‚æœ runtimeÂ·mstart å‡½æ•°è¿”å›ï¼Œé‚£ä¹ˆå°±è°ƒç”¨ runtimeÂ·abort å‡½æ•°ç»ˆæ­¢ç¨‹åºã€‚</span><br><span class="hljs-comment">// å› ä¸º runtimeÂ·mstart å‡½æ•°åœ¨æ­£å¸¸æƒ…å†µä¸‹æ˜¯ä¸åº”è¯¥è¿”å›çš„ï¼Œå¦‚æœè¿”å›äº†ï¼Œè¯´æ˜æœ‰é”™è¯¯å‘ç”Ÿã€‚</span><br>CALLruntimeÂ·abort(<span class="hljs-built_in">SB</span>)<span class="hljs-comment">// mstart should never return</span><br>RET<br><br><span class="hljs-symbol">bad_cpu:</span> <span class="hljs-comment">// å½“å‰ CPU ä¸æ”¯æŒ Go è¿è¡Œæ—¶ç³»ç»Ÿéœ€è¦çš„æ—¶å€™çš„é”™è¯¯æŠ¥å‘Šã€‚</span><br>MOVQ<span class="hljs-number">$2</span>, <span class="hljs-number">0</span>(<span class="hljs-built_in">SP</span>)<br>MOVQ$bad_cpu_msg&lt;&gt;(<span class="hljs-built_in">SB</span>), AX<br>MOVQAX, <span class="hljs-number">8</span>(<span class="hljs-built_in">SP</span>)<br>MOVQ<span class="hljs-number">$84</span>, <span class="hljs-number">16</span>(<span class="hljs-built_in">SP</span>)<br>CALLruntimeÂ·write(<span class="hljs-built_in">SB</span>)<br>MOVQ<span class="hljs-number">$1</span>, <span class="hljs-number">0</span>(<span class="hljs-built_in">SP</span>)<br>CALLruntimeÂ·exit(<span class="hljs-built_in">SB</span>)<br>CALLruntimeÂ·abort(<span class="hljs-built_in">SB</span>)<br>RET<br><br><span class="hljs-comment">// Prevent dead-code elimination of debugCallV2, which is</span><br><span class="hljs-comment">// intended to be called by debuggers.</span><br>MOVQ$runtimeÂ·debugCallV2&lt;ABIInternal&gt;(<span class="hljs-built_in">SB</span>), AX<br>RET<br></code></pre></td></tr></table></figure><p>æ•´ç†ä¸€ä¸‹ï¼Œ<code>runtimeÂ·rt0_go</code> çš„å¤§ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol type="1"><li>è¯»å–å‘½ä»¤è¡Œå‚æ•°ï¼Œå¤åˆ¶å‚æ•°å˜é‡ argc å’Œ argv åˆ°æ ˆä¸Šã€‚</li><li>åˆå§‹åŒ– g0 æ ˆï¼Œg0 æ˜¯ä¸ºäº†è°ƒåº¦åç¨‹è€Œäº§ç”Ÿçš„åç¨‹ï¼Œæ˜¯ g0æ˜¯è¿è¡Œæ—¶ç³»ç»Ÿçš„ä¸€ä¸ªç‰¹æ®Šçš„goroutineï¼Œå®ƒåœ¨ç¨‹åºå¯åŠ¨æ—¶è¢«åˆ›å»ºï¼Œç”¨äºæ‰§è¡Œç³»ç»Ÿè°ƒç”¨å’Œåç¨‹è°ƒåº¦ã€‚</li><li>è·å– CPU ä¿¡æ¯ã€‚</li><li>å¦‚æœå­˜åœ¨ <code>_cgo_init</code>ï¼Œè¿™è°ƒç”¨å®ƒã€‚</li><li>æ£€æŸ¥å¹¶è®¾ç½®çº¿æ€§å±€éƒ¨å­˜å‚¨ï¼ˆTLSï¼‰ã€‚</li><li>æ£€æŸ¥ CPU æ˜¯å¦æ”¯æŒ Go è¿è¡Œæ—¶ç³»ç»Ÿéœ€è¦çš„ç‰¹æ€§ã€‚</li><li>å®Œæˆè¿è¡Œæ—¶ç³»ç»Ÿæ£€æŸ¥å’Œåˆå§‹åŒ–ï¼š<ul><li>è°ƒç”¨ <code>runtimeÂ·check</code> å¯¹ä»£ç è¿›è¡Œè¿è¡Œæ—¶æ£€æŸ¥ã€‚</li><li>è°ƒç”¨ <code>runtimeÂ·args</code> å‡½æ•°å¤„ç†å‘½ä»¤è¡Œå‚æ•°ã€‚</li><li>è°ƒç”¨ <code>runtimeÂ·osinit</code> å‡½æ•°åˆå§‹åŒ–æ“ä½œç³»ç»Ÿç‰¹å®šçš„è®¾ç½®ã€‚</li><li>è°ƒç”¨ <code>runtimeÂ·schedinit</code> å‡½æ•°åˆå§‹åŒ–è°ƒåº¦å™¨ã€‚</li></ul></li><li>è°ƒç”¨ <code>runtimeÂ·newproc</code> åˆ›å»ºä¸€ä¸ªæ–°çš„ goroutineæ¥è¿è¡Œç¨‹åºçš„ä¸»å‡½æ•°ã€‚</li><li>è°ƒç”¨ <code>runtimeÂ·mstart</code> å¯åŠ¨å½“å‰çš„ machineï¼Œæ‰§è¡Œgoroutinesï¼Œæ‰§è¡Œç¨‹åºã€‚</li></ol><p>ä¸€å¥è¯ï¼š<code>runtimeÂ·rt0_go</code> æ˜¯ Goè¯­è¨€è¿è¡Œæ—¶çš„å…¥å£ç‚¹ï¼Œå®ƒè´Ÿè´£è®¾ç½®å’Œåˆå§‹åŒ–è¿è¡Œæ—¶ç¯å¢ƒï¼Œç„¶ååˆ›å»º g0 å’Œ m0æ¥è¿è¡Œç¨‹åºçš„ä¸»å‡½æ•°ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/3EGyo5Q3LRKr4XdNg1dHFr.png"alt="Go è¿è¡Œæ—¶ç³»ç»Ÿåˆå§‹åŒ–æµç¨‹" /><figcaption aria-hidden="true">Go è¿è¡Œæ—¶ç³»ç»Ÿåˆå§‹åŒ–æµç¨‹</figcaption></figure><p>äº†è§£å®Œ Go ç¨‹åºçš„æ•´ä½“å¯åŠ¨æµç¨‹åï¼Œæˆ‘ä»¬é‡ç‚¹æ¥åˆ†æä¸€ä¸‹å…¶ä¸­çš„<code>runtimeÂ·check</code>ã€<code>runtimeÂ·args</code>ã€<code>runtimeÂ·osinit</code>ã€<code>runtimeÂ·schedinit</code>ã€<code>runtimeÂ·newproc</code>å’Œ <code>runtimeÂ·mstart</code>ã€‚</p><blockquote><p>å¯¹äº†ï¼Œå……åˆ†ç†è§£ Go å¯åŠ¨æµç¨‹ï¼Œå¯èƒ½éœ€è¦ä½ å¯¹ Go çš„ GMP æ¨¡å‹æœ‰ä¸€å®šçš„äº†è§£ã€‚// TODO</p></blockquote><h2 id="runtimecheck">runtimeÂ·check</h2><p>åœ¨ Goland IDE ä¸Šï¼Œæˆ‘ä»¬åŒå‡» Shiftï¼Œå…¨å±€æœç´¢ <code>runtimeÂ·check</code>ä¼šå‘ç°æ‰¾ä¸åˆ°å‡½æ•°çš„å®ç°ã€‚</p><p>Go è¯­è¨€çš„è¿è¡Œæ—¶ç³»ç»Ÿå¤§éƒ¨åˆ†æ˜¯ç”¨ Goè‡ªå·±ç¼–å†™çš„ï¼Œä½†æ˜¯æœ‰ä¸€éƒ¨åˆ†ï¼Œç‰¹åˆ«æ˜¯ä¸å¹³å°ç›¸å…³çš„éƒ¨åˆ†ï¼Œæ˜¯ç”¨æ±‡ç¼–è¯­è¨€ç¼–å†™çš„ã€‚åœ¨æ±‡ç¼–è¯­è¨€ä¸­ï¼Œè°ƒç”¨Go å‡½æ•°çš„ä¸€ç§æ–¹å¼æ˜¯ä½¿ç”¨ <code>CALL</code>æŒ‡ä»¤å’Œå‡½æ•°çš„å…¨åï¼ŒåŒ…æ‹¬åŒ…åå’Œå‡½æ•°åã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>runtimeÂ·check</code>å°±æ˜¯è°ƒç”¨ <code>runtime</code> åŒ…ä¸‹çš„ <code>check()</code> å‡½æ•°ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦åŒå‡» Shiftï¼Œæœç´¢ <code>runtine.check</code>ï¼Œå³å°†<code>Â·</code> æ¢æˆ<code>.</code>ï¼ˆåé¢æ‰€æœ‰å‡½æ•°å‡æ˜¯è¿™ä¸ªé“ç†ï¼‰ã€‚æˆ‘ä»¬ä¼šå‘ç°<code>check()</code> ä½äº <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/runtime1.go">runtime/runtime1.go</a>ä¸­ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">check</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> (<br>a     <span class="hljs-type">int8</span><br>b     <span class="hljs-type">uint8</span><br>c     <span class="hljs-type">int16</span><br>d     <span class="hljs-type">uint16</span><br>e     <span class="hljs-type">int32</span><br>f     <span class="hljs-type">uint32</span><br>g     <span class="hljs-type">int64</span><br>h     <span class="hljs-type">uint64</span><br>i, i1 <span class="hljs-type">float32</span><br>j, j1 <span class="hljs-type">float64</span><br>k     unsafe.Pointer<br>l     *<span class="hljs-type">uint16</span><br>m     [<span class="hljs-number">4</span>]<span class="hljs-type">byte</span><br>)<br><span class="hljs-keyword">type</span> x1t <span class="hljs-keyword">struct</span> &#123;<br>x <span class="hljs-type">uint8</span><br>&#125;<br><span class="hljs-keyword">type</span> y1t <span class="hljs-keyword">struct</span> &#123;<br>x1 x1t<br>y  <span class="hljs-type">uint8</span><br>&#125;<br><span class="hljs-keyword">var</span> x1 x1t<br><span class="hljs-keyword">var</span> y1 y1t<br>    <span class="hljs-comment">// æ£€æŸ¥å„ç§ç±»å‹çš„å˜é‡çš„å¤§å°æ˜¯å¦ç¬¦åˆé¢„æœŸ</span><br><span class="hljs-keyword">if</span> unsafe.Sizeof(a) != <span class="hljs-number">1</span> &#123;<br>throw(<span class="hljs-string">&quot;bad a&quot;</span>)<br>&#125;<br>    ...<br>    <span class="hljs-comment">// æ£€æŸ¥æŒ‡é’ˆæ“ä½œ</span><br><span class="hljs-keyword">if</span> unsafe.Sizeof(k) != goarch.PtrSize &#123;<br>throw(<span class="hljs-string">&quot;bad k&quot;</span>)<br>&#125;<br>    ...<br><span class="hljs-comment">// æ£€æŸ¥ç»“æ„ä½“ä¸­å­—æ®µçš„åç§»é‡æ˜¯å¦ç¬¦åˆé¢„æœŸ </span><br><span class="hljs-keyword">if</span> unsafe.Offsetof(y1.y) != <span class="hljs-number">1</span> &#123;<br>throw(<span class="hljs-string">&quot;bad offsetof y1.y&quot;</span>)<br>&#125;<br>    <span class="hljs-comment">// timediv å‡½æ•°çš„ç›®çš„æ˜¯åœ¨ 32 ä½å¤„ç†å™¨ä¸Šå®ç° 64 ä½çš„é™¤æ³•è¿ç®—ã€‚</span><br>    <span class="hljs-comment">// ç”±äºåœ¨ 32 ä½å¤„ç†å™¨ä¸Šï¼Œ64 ä½çš„é™¤æ³•è¿ç®—ä¼šè¢«è½¬æ¢ä¸º _divv() å‡½æ•°è°ƒç”¨ï¼Œ</span><br>    <span class="hljs-comment">// è¿™å¯èƒ½ä¼šè¶…å‡º nosplit å‡½æ•°çš„æ ˆé™åˆ¶ï¼Œæ‰€ä»¥éœ€è¦è¿™ä¸ªç‰¹æ®Šçš„å‡½æ•°æ¥è¿›è¡Œå¤„ç†ã€‚</span><br>    <span class="hljs-comment">// //go:nosplit æ˜¯ä¸€ä¸ªç¼–è¯‘å™¨æŒ‡ä»¤ï¼Œå®ƒå‘Šè¯‰ç¼–è¯‘å™¨ä¸è¦åœ¨è¿™ä¸ªå‡½æ•°ä¸­æ’å…¥æ ˆåˆ†å‰²æ£€æŸ¥ã€‚</span><br>    <span class="hljs-comment">// è¿™æ„å‘³ç€è¿™ä¸ªå‡½æ•°å¿…é¡»åœ¨å½“å‰çš„æ ˆå¸§ä¸­è¿è¡Œï¼Œä¸èƒ½å¢åŠ æ ˆçš„å¤§å°ã€‚</span><br>    <span class="hljs-comment">// å¦‚æœè¿™ä¸ªå‡½æ•°éœ€è¦æ›´å¤šçš„æ ˆç©ºé—´ï¼Œé‚£ä¹ˆå®ƒå°†ä¼šå¯¼è‡´æ ˆæº¢å‡ºã€‚</span><br><span class="hljs-keyword">if</span> timediv(<span class="hljs-number">12345</span>*<span class="hljs-number">1000000000</span>+<span class="hljs-number">54321</span>, <span class="hljs-number">1000000000</span>, &amp;e) != <span class="hljs-number">12345</span> || e != <span class="hljs-number">54321</span> &#123;<br>throw(<span class="hljs-string">&quot;bad timediv&quot;</span>)<br>&#125;<br>    <span class="hljs-comment">// CAS æ“ä½œæ£€æŸ¥</span><br><span class="hljs-keyword">var</span> z <span class="hljs-type">uint32</span><br>z = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> !atomic.Cas(&amp;z, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>) &#123;<br>throw(<span class="hljs-string">&quot;cas1&quot;</span>)<br>&#125;<br>...<br>    <span class="hljs-comment">// æ£€æŸ¥ atomic åŸå­æ“ä½œ</span><br>m = [<span class="hljs-number">4</span>]<span class="hljs-type">byte</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>&#125;<br>atomic.Or8(&amp;m[<span class="hljs-number">1</span>], <span class="hljs-number">0xf0</span>)<br><span class="hljs-keyword">if</span> m[<span class="hljs-number">0</span>] != <span class="hljs-number">1</span> || m[<span class="hljs-number">1</span>] != <span class="hljs-number">0xf1</span> || m[<span class="hljs-number">2</span>] != <span class="hljs-number">1</span> || m[<span class="hljs-number">3</span>] != <span class="hljs-number">1</span> &#123;<br>throw(<span class="hljs-string">&quot;atomicor8&quot;</span>)<br>&#125;<br>    <span class="hljs-comment">// æµ‹è¯•æµ®ç‚¹æ•° NaNï¼ˆNot a Numberï¼‰çš„è¡Œä¸º</span><br>*(*<span class="hljs-type">uint64</span>)(unsafe.Pointer(&amp;j)) = ^<span class="hljs-type">uint64</span>(<span class="hljs-number">0</span>)<br><span class="hljs-keyword">if</span> j == j &#123;<br>throw(<span class="hljs-string">&quot;float64nan&quot;</span>)<br>&#125;<br><span class="hljs-keyword">if</span> !(j != j) &#123;<br>throw(<span class="hljs-string">&quot;float64nan1&quot;</span>)<br>&#125;<br>    <span class="hljs-comment">// æµ‹è¯• 64 ä½åŸå­æ“ä½œ</span><br>testAtomic64()<br>    <span class="hljs-comment">// æ£€æŸ¥æ ˆå¤§å°æ˜¯å¦æ˜¯ 2 çš„ n æ¬¡å¹‚</span><br><span class="hljs-keyword">if</span> fixedStack != round2(fixedStack) &#123;<br>throw(<span class="hljs-string">&quot;FixedStack is not power-of-2&quot;</span>)<br>&#125;<br>    <span class="hljs-comment">// ä¸ŠæŠ¥ç¼–ä»£ç çš„è¿è¡Œæ—¶æ£€æŸ¥ä¸­æ˜¯å¦æœ‰å¼‚å¸¸</span><br><span class="hljs-keyword">if</span> !checkASM() &#123;<br>throw(<span class="hljs-string">&quot;assembly checks failed&quot;</span>)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»¼ä¸Šï¼š<code>runtimeÂ·check</code> ä¸»è¦æ˜¯åšä¸€äº›è¿è¡Œæ—¶çš„æ£€æŸ¥ã€‚</p><ol type="1"><li>ä½¿ç”¨ <code>unsafe.Sizeof</code>å‡½æ•°æ£€æŸ¥å„ç§ç±»å‹çš„å˜é‡çš„å¤§å°æ˜¯å¦ç¬¦åˆé¢„æœŸã€‚</li><li>ä½¿ç”¨ <code>unsafe.Offsetof</code>å‡½æ•°æ£€æŸ¥ç»“æ„ä½“ä¸­å­—æ®µçš„åç§»é‡æ˜¯å¦ç¬¦åˆé¢„æœŸã€‚</li><li>æµ‹è¯• <code>timediv</code> å‡½æ•°æ£€æŸ¥åœ¨ 32 ä½æœºå™¨ä¸Šè¿›è¡Œ 64ä½é™¤æ³•è¿ç®—çš„ç»“æœæ˜¯å¦ç¬¦åˆé¢„æœŸã€‚</li><li>ä½¿ç”¨ <code>atomic.Cas</code> å‡½æ•°ï¼ˆCompare andSwapï¼‰è¿›è¡ŒåŸå­æ¯”è¾ƒå’Œäº¤æ¢æµ‹è¯•ã€‚</li><li>ä½¿ç”¨ <code>atomic.Or8</code> å’Œ <code>atomic.And8</code>å‡½æ•°è¿›è¡ŒåŸå­ä½æ“ä½œæµ‹è¯•ã€‚</li><li>æµ‹è¯•æµ®ç‚¹æ•° NaNï¼ˆNot a Numberï¼‰çš„è¡Œä¸ºã€‚</li><li>è°ƒç”¨ <code>testAtomic64</code> å‡½æ•°æµ‹è¯• 64 ä½çš„åŸå­æ“ä½œã€‚</li><li>æ£€æŸ¥ <code>fixedStack</code> æ ˆå¤§å°æ˜¯å¦æ˜¯ 2 çš„å¹‚ã€‚</li><li>è°ƒç”¨ <code>checkASM</code>å‡½æ•°æ£€æŸ¥æ±‡ç¼–ä»£ç æ£€æŸ¥è¿è¡Œæ—¶ä¸­æ˜¯å¦æœ‰å¼‚å¸¸ã€‚</li></ol><h2 id="runtimeargs">runtimeÂ·args</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> runtime<br><br><span class="hljs-keyword">var</span> (<br>argc <span class="hljs-type">int32</span><br>argv **<span class="hljs-type">byte</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">args</span><span class="hljs-params">(c <span class="hljs-type">int32</span>, v **<span class="hljs-type">byte</span>)</span></span> &#123;<br>argc = c<br>argv = v<br>sysargs(c, v)<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å°†å‘½ä»¤è¡Œå‚æ•°æ‹·è´åˆ° <code>runtime</code>åŒ…ä¸‹çš„å…¨å±€å˜é‡ <code>argc</code> å’Œ <code>argv</code> ä¸Šã€‚åé¢åœ¨<code>shcedinit()</code> å‡½æ•°ä¸­ä¼šè°ƒç”¨ <code>goargs()</code> æ¥éå† argvå°†å‚æ•°å¤åˆ¶åˆ° slice ä¸Šã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">goargs</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> GOOS == <span class="hljs-string">&quot;windows&quot;</span> &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br>argslice = <span class="hljs-built_in">make</span>([]<span class="hljs-type">string</span>, argc)<br><span class="hljs-keyword">for</span> i := <span class="hljs-type">int32</span>(<span class="hljs-number">0</span>); i &lt; argc; i++ &#123;<br>argslice[i] = gostringnocopy(argv_index(argv, i))<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="runtimeosinit">runtimeÂ·osinit</h2><p>è¿™é‡Œå‡½æ•°ä¸»è¦æ˜¯åˆå§‹åŒ–æ“ä½œç³»ç»Ÿç‰¹ç‚¹çš„è®¾ç½®ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œé’ˆå¯¹ä¸åŒæ“ä½œç³»ç»Ÿéƒ½åšäº†å®ç°ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20231209131939116.png"alt="osinit" /><figcaption aria-hidden="true">osinit</figcaption></figure><p>è¿™é‡Œæˆ‘ä»¬ä»¥ <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/os_windows.go">os_windows.go</a>ä¸ºä¾‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">osinit</span><span class="hljs-params">()</span></span> &#123;<br>    <br>    <span class="hljs-comment">// è·å– asmstdcall å‡½æ•°çš„åœ°å€ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºä¸€ä¸ªä¸å®‰å…¨çš„æŒ‡é’ˆã€‚</span><br>    <span class="hljs-comment">// è¿™é€šå¸¸åœ¨éœ€è¦ç›´æ¥æ“ä½œå†…å­˜æˆ–è¿›è¡Œç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™ä½¿ç”¨ã€‚</span><br>asmstdcallAddr = unsafe.Pointer(abi.FuncPCABI0(asmstdcall))<br><br>    <span class="hljs-comment">// åŠ è½½ä¸€äº›å¯é€‰çš„ç³»ç»Ÿè°ƒç”¨ã€‚</span><br>loadOptionalSyscalls()<br><br>    <span class="hljs-comment">// é˜»æ­¢æ˜¾ç¤ºé”™è¯¯å¯¹è¯æ¡†ã€‚è¿™å¯èƒ½æ˜¯ä¸ºäº†é˜²æ­¢åœ¨å‡ºç°é”™è¯¯æ—¶æ‰“æ–­ç”¨æˆ·ã€‚</span><br>preventErrorDialogs()<br><br>    <span class="hljs-comment">// åˆå§‹åŒ–å¼‚å¸¸å¤„ç†å™¨ï¼Œç”¨äºå¤„ç†è¿è¡Œæ—¶å‘ç”Ÿçš„å¼‚å¸¸ã€‚</span><br>initExceptionHandler()<br><br>    <span class="hljs-comment">// åˆå§‹åŒ–é«˜åˆ†è¾¨ç‡è®¡æ—¶å™¨ï¼Œç”¨äºç²¾ç¡®çš„æ—¶é—´æµ‹é‡ã€‚</span><br>initHighResTimer()<br>timeBeginPeriodRetValue = osRelax(<span class="hljs-literal">false</span>)<br><br>    <span class="hljs-comment">// åˆå§‹åŒ–ç³»ç»Ÿç›®å½•</span><br>initSysDirectory()<br>    <br>    <span class="hljs-comment">// å¯ç”¨é•¿è·¯å¾„æ”¯æŒã€‚</span><br>    <span class="hljs-comment">// åœ¨ Windows ä¸­ï¼Œè·¯å¾„çš„é•¿åº¦é€šå¸¸é™åˆ¶ä¸º 260 ä¸ªå­—ç¬¦ã€‚å¯ç”¨é•¿è·¯å¾„æ”¯æŒå¯ä»¥çªç ´è¿™ä¸ªé™åˆ¶ã€‚</span><br>initLongPathSupport()<br><br>    <span class="hljs-comment">// ç è·å–å¤„ç†å™¨çš„æ•°é‡å¹¶å°†å…¶èµ‹ç»™ ncpuã€‚</span><br>    ncpu = getproccount()<br><br>    <span class="hljs-comment">// è·å–å†…å­˜é¡µçš„å¤§å°å¹¶å°†å…¶èµ‹ç»™ physPageSizeï¼Œä¸ºäº†åé¢è¿›è¡Œå†…å­˜ç®¡ç†ã€‚</span><br>physPageSize = getPageSize()<br><br>    <span class="hljs-comment">// è°ƒç”¨ SetProcessPriorityBoost å‡½æ•°ï¼Œç¦ç”¨åŠ¨æ€ä¼˜å…ˆçº§æå‡ã€‚</span><br>    <span class="hljs-comment">// åœ¨ Windows ä¸­ï¼ŒåŠ¨æ€ä¼˜å…ˆçº§æå‡æ˜¯ä¸€ç§æœºåˆ¶ï¼Œå¯ä»¥æ ¹æ®çº¿ç¨‹çš„ç±»å‹å’Œè¡Œä¸ºè‡ªåŠ¨è°ƒæ•´å…¶ä¼˜å…ˆçº§ã€‚</span><br>    <span class="hljs-comment">// ä½†åœ¨ Go çš„ç¯å¢ƒä¸­ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½æ˜¯ç­‰ä»·çš„ï¼Œéƒ½å¯èƒ½è¿›è¡Œ GUIã€IOã€è®¡ç®—ç­‰å„ç§æ“ä½œï¼Œ</span><br>    <span class="hljs-comment">// æ‰€ä»¥åŠ¨æ€ä¼˜å…ˆçº§æå‡å¯èƒ½ä¼šå¸¦æ¥é—®é¢˜ï¼Œå› æ­¤è¿™é‡Œé€‰æ‹©ç¦ç”¨å®ƒã€‚</span><br>stdcall2(_SetProcessPriorityBoost, currentProcess, <span class="hljs-number">1</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="runtimeschedinit">runtimeÂ·schedinit â˜…</h2><p>è¿™ä¸ªå‡½æ•°å°±éå¸¸é‡è¦äº†ï¼Œä»åå­—å°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¿™æ˜¯ Goè¯­è¨€è°ƒåº¦å™¨çš„åˆå§‹åŒ–è¿‡ç¨‹ã€‚è¿™ä¸ªå‡½æ•°ä½äºï¼š<ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/proc.go">runtime/proc.go</a>ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å…ˆæ¥çœ‹çœ‹ <code>schedinit()</code> çš„å‡½æ•°æ³¨é‡Šï¼Œè¿™é‡Œä¹Ÿé€éœ²äº† Goè¯­è¨€ç¨‹åºçš„å¯åŠ¨æµç¨‹çš„æ ¸å¿ƒé¡ºåºã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// The bootstrap sequence is:å¯åŠ¨æµç¨‹é¡ºåºï¼š</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//call osinit  1. è°ƒç”¨ osinit</span><br><span class="hljs-comment">//call schedinit2. è°ƒç”¨ schedinit</span><br><span class="hljs-comment">//make &amp; queue new G3. åˆ›å»ºä¸€ä¸ªåç¨‹ G</span><br><span class="hljs-comment">//call runtimeÂ·mstart4. è°ƒç”¨ mstart</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// The new G calls runtimeÂ·main. 5. G æ‰§è¡Œ runtime.main</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">schedinit</span><span class="hljs-params">()</span></span> &#123;&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬è¯¦ç»†æ¥çœ‹çœ‹ <code>schedinit()</code> éƒ½åšäº†äº›ä»€ä¹ˆï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">schedinit</span><span class="hljs-params">()</span></span> &#123;<br>    <br>    <span class="hljs-comment">// åˆå§‹åŒ–å„ç§é”ï¼Œå…¶ä¸­ lockRankXXX æŒ‡å®šé”çš„çº§åˆ«ã€‚</span><br>lockInit(&amp;sched.lock, lockRankSched)<br>lockInit(&amp;sched.sysmonlock, lockRankSysmon)<br>lockInit(&amp;sched.deferlock, lockRankDefer)<br>lockInit(&amp;sched.sudoglock, lockRankSudog)<br>lockInit(&amp;deadlock, lockRankDeadlock)<br>lockInit(&amp;paniclk, lockRankPanic)<br>lockInit(&amp;allglock, lockRankAllg)<br>lockInit(&amp;allpLock, lockRankAllp)<br>lockInit(&amp;reflectOffs.lock, lockRankReflectOffs)<br>lockInit(&amp;finlock, lockRankFin)<br>lockInit(&amp;cpuprof.lock, lockRankCpuprof)<br>traceLockInit()<br>lockInit(&amp;memstats.heapStats.noPLock, lockRankLeafRank)<br><br><span class="hljs-comment">// å¦‚æœå¯ç”¨äº†ç«æ€æ£€æµ‹ï¼Œåˆ™åˆå§‹åŒ–ç«æ€æ£€æµ‹å™¨ï¼Œ</span><br>    <span class="hljs-comment">// å³æˆ‘ä»¬ä½¿ç”¨ -race çš„æ—¶å€™ä¼šæ‰§è¡Œè¿™é‡Œã€‚</span><br>gp := getg()<br><span class="hljs-keyword">if</span> raceenabled &#123;<br>gp.racectx, raceprocctx0 = raceinit()<br>&#125;<br><br>    <span class="hljs-comment">// é™åˆ¶ M çš„æ•°é‡ï¼Œå³çº¿ç¨‹çš„æ•°é‡ã€‚</span><br>    <span class="hljs-comment">// maxmcount    int32    // maximum number of m&#x27;s allowed (or die)</span><br>sched.maxmcount = <span class="hljs-number">10000</span><br><br><span class="hljs-comment">// å°†è°ƒåº¦å™¨è®¾ç½®ä¸ºåˆå§‹æš‚åœçŠ¶æ€ï¼Œåœ¨å¿…è¦çš„åˆå§‹åŒ–å®Œæˆä¹‹å‰ä¸è°ƒåº¦ä»»ä½•åç¨‹ã€‚</span><br>worldStopped()<br><br>    <span class="hljs-comment">// è¿›è¡Œä¸€ç³»åˆ—çš„ç³»ç»Ÿåˆå§‹åŒ–ï¼ˆå†…å­˜ç®¡ç†ã€CPU è®¾ç½®ã€æ ˆã€ç®—æ³•ç­‰ï¼‰</span><br>moduledataverify()<br>stackinit()<br>mallocinit()<br>godebug := getGodebugEarly()<br>initPageTrace(godebug) <span class="hljs-comment">// must run after mallocinit but before anything allocates</span><br>cpuinit(godebug)       <span class="hljs-comment">// must run before alginit</span><br>alginit()              <span class="hljs-comment">// maps, hash, fastrand must not be used before this call</span><br>fastrandinit()         <span class="hljs-comment">// must run before mcommoninit</span><br>mcommoninit(gp.m, <span class="hljs-number">-1</span>)<br>modulesinit()   <span class="hljs-comment">// provides activeModules</span><br>typelinksinit() <span class="hljs-comment">// uses maps, activeModules</span><br>itabsinit()     <span class="hljs-comment">// uses activeModules</span><br>stkobjinit()    <span class="hljs-comment">// must run before GC starts</span><br><br>    <span class="hljs-comment">// è®¾ç½®å’Œä¿å­˜å½“å‰ M çš„ä¿¡å·æ©ç </span><br>sigsave(&amp;gp.m.sigmask)<br>initSigmask = gp.m.sigmask<br><br>    <span class="hljs-comment">// è§£æç¨‹åºå‚æ•°å’Œç¯å¢ƒå˜é‡</span><br>goargs()<br>goenvs()<br>secure()<br>parsedebugvars()<br>    <br>    <span class="hljs-comment">// åˆå§‹åŒ–åƒåœ¾å›æ”¶å™¨</span><br>gcinit()<br><br><span class="hljs-comment">// å¦‚æœè®¾ç½®äº† disableMemoryProfilingï¼Œå³ç¦ç”¨å†…å­˜åˆ†æï¼Œ</span><br>    <span class="hljs-comment">// åˆ™å°† MemProfileRate ç½®ä¸º 0ï¼Œå…³é—­å†…å­˜åˆ†æã€‚</span><br><span class="hljs-keyword">if</span> disableMemoryProfiling &#123;<br>MemProfileRate = <span class="hljs-number">0</span><br>&#125;<br><br>    <span class="hljs-comment">// é”å®šè°ƒåº¦å™¨ï¼Œå¤„ç†ç¯å¢ƒå˜é‡ GOMAXPROCSï¼Œè¿™æ˜¯å¼€å‘è€…å¯ä»¥è®¾ç½®çš„å…è®¸çš„æœ€å¤šçš„ P çš„æ•°é‡ã€‚</span><br>lock(&amp;sched.lock)<br>sched.lastpoll.Store(nanotime())<br>procs := ncpu<br><span class="hljs-keyword">if</span> n, ok := atoi32(gogetenv(<span class="hljs-string">&quot;GOMAXPROCS&quot;</span>)); ok &amp;&amp; n &gt; <span class="hljs-number">0</span> &#123;<br>procs = n<br>&#125;<br><span class="hljs-keyword">if</span> procresize(procs) != <span class="hljs-literal">nil</span> &#123;<br>throw(<span class="hljs-string">&quot;unknown runnable goroutine during bootstrap&quot;</span>)<br>&#125;<br>unlock(&amp;sched.lock)<br><br><span class="hljs-comment">// å°†è°ƒåº¦å™¨è®¾ç½®ä¸ºå¼€å§‹çŠ¶æ€ã€‚</span><br>worldStarted()<br><br>    <span class="hljs-comment">// ç¡®ä¿æ„å»ºç‰ˆæœ¬å’Œæ¨¡å—ä¿¡æ¯è¢«ä¿ç•™åœ¨æœ€ç»ˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚</span><br><span class="hljs-keyword">if</span> buildVersion == <span class="hljs-string">&quot;&quot;</span> &#123;<br>buildVersion = <span class="hljs-string">&quot;unknown&quot;</span><br>&#125;<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(modinfo) == <span class="hljs-number">1</span> &#123;<br>modinfo = <span class="hljs-string">&quot;&quot;</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ€»ç»“ï¼š<code>schedinit</code> æ˜¯ Goè¯­è¨€è¿è¡Œæ—¶ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œè´Ÿè´£åˆå§‹åŒ–è°ƒåº¦å™¨åŠå…¶ç›¸å…³ç»„ä»¶ï¼Œå¦‚é”ã€ä¿¡å·æ©ç ã€å†…å­˜åˆ†é…ã€ä»¥åŠå…¶ä»–ç³»ç»Ÿçº§åˆ«çš„è®¾ç½®ï¼Œç¡®ä¿å¹¶å‘æ‰§è¡Œç¯å¢ƒçš„æ­£ç¡®é…ç½®å’Œé«˜æ•ˆè¿ä½œã€‚</p><p>å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol type="1"><li><strong>é”åˆå§‹åŒ–</strong>:<ul><li>å‡½æ•°å¼€å§‹æ—¶ï¼Œé€šè¿‡ <code>lockInit</code> è°ƒç”¨åˆå§‹åŒ–äº†å¤šä¸ªé”ã€‚åœ¨ Goçš„è°ƒåº¦å™¨ä¸­ï¼Œé”ç”¨äºä¿æŠ¤å…±äº«èµ„æºå’Œè°ƒåº¦æ•°æ®ç»“æ„ï¼Œç¡®ä¿åœ¨å¤šä¸ªçº¿ç¨‹æˆ–åç¨‹ä¸­çš„å®‰å…¨è®¿é—®ã€‚æ¯ä¸ªé”éƒ½æœ‰ä¸€ä¸ªç‰¹å®šçš„çº§åˆ«ï¼Œè¿™æœ‰åŠ©äºé˜²æ­¢æ­»é”ã€‚</li></ul></li><li><strong>ç«æ€æ£€æµ‹å™¨åˆå§‹åŒ–</strong>:<ul><li>å¦‚æœå¯ç”¨äº†ç«æ€æ£€æµ‹(<code>raceenabled</code>)ï¼Œåˆ™åˆå§‹åŒ–ç«æ€ä¸Šä¸‹æ–‡ã€‚è¿™å¯¹äºåœ¨å¼€å‘é˜¶æ®µæ£€æµ‹å’Œé¿å…ç«æ€æ¡ä»¶éå¸¸é‡è¦ã€‚</li></ul></li><li><strong>è°ƒåº¦å™¨è®¾ç½®</strong>:<ul><li><code>sched.maxmcount = 10000</code>è®¾ç½®è°ƒåº¦å™¨å¯ä»¥ç®¡ç†çš„æœ€å¤§çº¿ç¨‹ï¼ˆMï¼‰æ•°ç›®ï¼Œè¿™å¯¹äºæ§åˆ¶èµ„æºä½¿ç”¨å’Œæ€§èƒ½è°ƒä¼˜å¾ˆé‡è¦ã€‚</li><li><code>worldStopped()</code>å°†è°ƒåº¦å™¨è®¾ç½®ä¸ºåˆå§‹æš‚åœçŠ¶æ€ï¼Œåœ¨å¿…è¦çš„åˆå§‹åŒ–å®Œæˆä¹‹å‰ä¸è°ƒåº¦ä»»ä½•åç¨‹ã€‚</li></ul></li><li><strong>ç³»ç»Ÿåˆå§‹åŒ–</strong>:<ul><li>æ¥ä¸‹æ¥è°ƒç”¨ä¸€ç³»åˆ—å‡½æ•°ï¼ˆå¦‚ <code>moduledataverify</code>,<code>mallocinit</code>, <code>cpuinit</code>, <code>alginit</code>ç­‰ï¼‰æ¥åˆå§‹åŒ–å†…å­˜ç®¡ç†ã€CPUè®¾ç½®ã€ç®—æ³•ç­‰ï¼Œè¿™äº›éƒ½æ˜¯è°ƒåº¦å™¨æ­£å¸¸å·¥ä½œçš„åŸºç¡€ã€‚</li></ul></li><li><strong>ç¯å¢ƒå’Œè°ƒè¯•å˜é‡è®¾ç½®</strong>:<ul><li>è§£æç¨‹åºå‚æ•°ã€ç¯å¢ƒå˜é‡ã€å®‰å…¨è®¾ç½®å’Œè°ƒè¯•å˜é‡ã€‚</li></ul></li><li><strong>åƒåœ¾æ”¶é›†å™¨åˆå§‹åŒ–</strong>:<ul><li><code>gcinit()</code> åˆå§‹åŒ–åƒåœ¾æ”¶é›†å™¨ï¼Œè¿™æ˜¯ Goè¿è¡Œæ—¶çš„å…³é”®ç»„æˆéƒ¨åˆ†ï¼Œè´Ÿè´£è‡ªåŠ¨å†…å­˜ç®¡ç†ã€‚</li></ul></li><li><strong>å†…å­˜åˆ†æè®¾ç½®</strong>:<ul><li>æ ¹æ® <code>disableMemoryProfiling</code>æ ‡å¿—å†³å®šæ˜¯å¦å…³é—­å†…å­˜åˆ†æåŠŸèƒ½ã€‚</li></ul></li><li><strong>å¤„ç†å™¨æ•°é‡è®¾ç½®å’Œè°ƒåº¦å™¨é”</strong>:<ul><li>é”å®šè°ƒåº¦å™¨æ¥å®‰å…¨åœ°åŸºäºç¯å¢ƒå˜é‡ <code>GOMAXPROCS</code>è®¾ç½®å¤„ç†å™¨ï¼ˆ<code>procs</code>ï¼‰æ•°é‡ã€‚</li><li>ä½¿ç”¨ <code>procresize</code>å‡½æ•°æ ¹æ®å¤„ç†å™¨æ•°é‡è°ƒæ•´è°ƒåº¦å™¨çš„å†…éƒ¨ç»“æ„ã€‚</li></ul></li><li><strong>æœ€ç»ˆæ­¥éª¤å’Œé”™è¯¯æ£€æŸ¥</strong>:<ul><li>è°ƒç”¨ <code>worldStarted()</code>è¡¨ç¤ºè°ƒåº¦å™¨å·²å‡†å¤‡å¥½å¼€å§‹è°ƒåº¦åç¨‹ã€‚</li><li>æ£€æŸ¥å’Œè®¾ç½®æ„å»ºç‰ˆæœ¬å’Œæ¨¡å—ä¿¡æ¯ï¼Œä¿è¯è¿™äº›ä¿¡æ¯åœ¨æœ€ç»ˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚</li></ul></li></ol><p>è¿™é‡Œæœ‰å‡ ä¸ªåœ°æ–¹æ¯”è¾ƒæœ‰è¶£ï¼Œæˆ‘ä»¬æ¥åšä¸€ä¸‹ç®€å•çš„äº†è§£ã€‚ï¼ˆå¯è·³è¿‡ï¼‰</p><h3 id="åˆå§‹åŒ–é”-lockinitmutex-rank">åˆå§‹åŒ–é” lockInit(mutex, rank)</h3><p>æˆ‘ä»¬çŸ¥é“ <code>lockInit(mutex,rank)</code> æ˜¯ç”¨æ¥åˆå§‹åŒ–é”çš„ï¼Œç¬¬ 2ä¸ªå‚æ•° <code>rank</code> ä¾¿æ˜¯é”çš„ç­‰çº§ã€‚å¦‚æœè¿™ä¸ªæ—¶å€™ä½ é“¾æ¥åˆ°<code>lcokInit</code> å®ç°çš„åœ°æ–¹ï¼Œä½ ä¼šå‘ç°é»˜è®¤ä¼šè·³åˆ° <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/lockrank_off.go">lockrank_off.go</a>ï¼Œè€Œä¸”ä½ ä¼šå‘ç°ï¼Œå®ƒçš„å®ç°æ˜¯ç©ºçš„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//go:build !goexperiment.staticlockranking</span><br><br><span class="hljs-keyword">package</span> runtime<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">lockInit</span><span class="hljs-params">(l *mutex, rank lockRank)</span></span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶å® <code>lockInit</code> è¿˜æœ‰å¦å¤–ä¸€ä¸ªå®ç°ï¼Œåœ¨ <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/lockrank_on.go">lockrank_on.go</a>æ–‡ä»¶ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//go:build goexperiment.staticlockranking</span><br><br><span class="hljs-keyword">package</span> runtime<br><br><span class="hljs-keyword">const</span> staticLockRanking = <span class="hljs-literal">true</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getLockRank</span><span class="hljs-params">(l *mutex)</span></span> lockRank &#123;<br><span class="hljs-keyword">return</span> l.rank<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿé€šè¿‡æ–‡ä»¶åç§°æˆ‘ä»¬å…¶å®å°±å¯ä»¥çŒœåˆ°äº†ï¼Œ<code>lockrank_off.go</code>æ˜¯æä¾›äº†æ— é”çº§åˆ«çš„é”ï¼Œè€Œ <code>lockrank_on.go</code>æ˜¯æä¾›äº†æœ‰é”çº§åˆ«çš„é”ã€‚è‡³äºåº”è¯¥é‡‡ç”¨å“ªä¸€ä¸ªï¼Œæ˜¯é€šè¿‡ go build ä¸­çš„<code>goexperiment.staticlockranking</code> å‚æ•°æ¥æ§åˆ¶çš„ã€‚</p><p>è¿™é‡Œæ¶‰åŠä¸€ä¸ªæ¦‚å¿µï¼Œå«åšé”æ’åºï¼ˆLock Rankingï¼‰ï¼š</p><ul><li>é”æ’åºæ˜¯ä¸€ç§ç”¨äºé¿å…æ­»é”çš„æŠ€æœ¯ã€‚åœ¨è¿™ç§æœºåˆ¶ä¸­ï¼Œæ¯ä¸ªé”éƒ½è¢«èµ‹äºˆä¸€ä¸ªç­‰çº§ï¼ˆæˆ–ç§°ä¸ºâ€œrankâ€ï¼‰ï¼Œå¹¶ä¸”æœ‰è§„åˆ™ç¡®ä¿é”çš„è·å–éµå¾ªè¿™äº›ç­‰çº§çš„é¡ºåºã€‚</li><li>é€šå¸¸ï¼Œè¿™æ„å‘³ç€ä¸€ä¸ªçº¿ç¨‹åœ¨è·å–ç­‰çº§è¾ƒä½çš„é”ä¹‹å‰ï¼Œå¿…é¡»å…ˆé‡Šæ”¾æ‰€æœ‰ç­‰çº§è¾ƒé«˜çš„é”ã€‚è¿™æ ·å¯ä»¥é˜²æ­¢æ­»é”ï¼Œå› ä¸ºå®ƒé¿å…äº†å¾ªç¯ç­‰å¾…æ¡ä»¶çš„å‘ç”Ÿã€‚</li><li>Go è¯­è¨€ä¸­é”çš„ç­‰çº§å’Œé¡ºåºå®šä¹‰åœ¨ <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/lockrank.go">lockrank.go</a>æ–‡ä»¶ä¸­ã€‚</li></ul><p>é”æ’åºçš„ä½œç”¨ï¼š</p><ul><li>åœ¨ Goçš„å¹¶å‘æ¨¡å‹ä¸­ï¼Œé”æ˜¯åŒæ­¥å…±äº«èµ„æºè®¿é—®çš„é‡è¦æœºåˆ¶ã€‚<code>lockInit</code>å‡½æ•°åœ¨è¿è¡Œæ—¶åˆå§‹åŒ–é”ï¼Œä¸ºå…¶åˆ†é…ç­‰çº§ï¼Œæœ‰åŠ©äºç»´æŠ¤ç¨‹åºçš„ç¨³å®šæ€§å’Œæ€§èƒ½ã€‚</li><li>é”æ’åºåŠŸèƒ½çš„å¼€å¯æˆ–å…³é—­å–å†³äºæ˜¯å¦éœ€è¦é¢å¤–çš„æ­»é”æ£€æµ‹ã€‚åœ¨å¼€å‘å’Œè°ƒè¯•é˜¶æ®µï¼Œå¼€å¯é”æ’åºå¯ä»¥å¸®åŠ©å‘ç°æ­»é”é—®é¢˜ã€‚ç„¶è€Œï¼Œå®ƒå¯èƒ½å¼•å…¥é¢å¤–çš„æ€§èƒ½å¼€é”€ï¼Œå› æ­¤åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¯èƒ½ä¼šè¢«å…³é—­ã€‚</li></ul><p>æœ€åæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ <code>schedinit()</code> éƒ½åˆå§‹åŒ–äº†å“ªäº›é”ï¼š</p><table><thead><tr class="header"><th>Lock</th><th>Description</th></tr></thead><tbody><tr class="odd"><td>sched.lock</td><td>åˆå§‹åŒ–è°ƒåº¦å™¨çš„ä¸»é”ã€‚è¿™ä¸ªé”ç”¨äºæ§åˆ¶å¯¹è°ƒåº¦å™¨çš„è®¿é—®ï¼Œä¿è¯è°ƒåº¦è¿‡ç¨‹çš„æ­£ç¡®æ€§ã€‚</td></tr><tr class="even"><td>sched.sysmonlock</td><td>ç³»ç»Ÿç›‘æ§é”ï¼Œç”¨äºä¿æŠ¤ç³»ç»Ÿç›‘æ§ç›¸å…³çš„æ•°æ®ç»“æ„ã€‚</td></tr><tr class="odd"><td>sched.deferlock</td><td>ç”¨äºæ§åˆ¶å»¶è¿Ÿæ‰§è¡Œå‡½æ•°åˆ—è¡¨çš„é”ã€‚</td></tr><tr class="even"><td>sched.sudoglock</td><td>sudog æ˜¯ Go ä¸­è¡¨ç¤ºç­‰å¾…é€šä¿¡çš„ goroutine çš„ç»“æ„ã€‚è¿™ä¸ªé”ä¿æŠ¤ä¸ sudogç›¸å…³çš„æ“ä½œã€‚</td></tr><tr class="odd"><td>deadlock</td><td>å¯èƒ½ç”¨äºæ£€æµ‹æˆ–é˜²æ­¢æ­»é”çš„é”ã€‚</td></tr><tr class="even"><td>paniclk</td><td>åœ¨å¤„ç† panic æ—¶ä½¿ç”¨çš„é”ã€‚</td></tr><tr class="odd"><td>allglock</td><td>ç”¨äºæ§åˆ¶å¯¹æ‰€æœ‰ goroutine åˆ—è¡¨çš„è®¿é—®ã€‚</td></tr><tr class="even"><td>allpLock</td><td>æ§åˆ¶å¯¹æ‰€æœ‰å¤„ç†å™¨ï¼ˆPï¼‰çš„è®¿é—®ã€‚</td></tr><tr class="odd"><td>reflectOffs.lock</td><td>ç”¨äºåå°„æ“ä½œçš„é”ã€‚</td></tr><tr class="even"><td>finlock</td><td>ç®¡ç†ç»ˆç»“å™¨åˆ—è¡¨çš„é”ã€‚</td></tr><tr class="odd"><td>cpuprof.lock</td><td>ç”¨äº CPU åˆ†ææ•°æ®çš„é”ã€‚</td></tr><tr class="even"><td>traceLockInit()</td><td>ä¸“é—¨ç”¨äºè¿½è¸ªç³»ç»Ÿçš„é”åˆå§‹åŒ–å‡½æ•°ã€‚</td></tr><tr class="odd"><td>memstats.heapStats.noPLock</td><td>è¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„é”ï¼Œè¢«æ ‡è®°ä¸º<code>lockRankLeafRank</code>ï¼Œæ„å‘³ç€å®ƒåº”è¯¥æ˜¯é”å±‚çº§ä¸­çš„æœ€æœ«ç«¯ï¼ˆleafï¼‰ã€‚è¿™æ ·çš„é”åº”è¯¥åªåœ¨éå¸¸çŸ­çš„å…³é”®éƒ¨åˆ†ä¸­ä½¿ç”¨ï¼Œä»¥é¿å…æˆä¸ºæ­»é”çš„æºå¤´ã€‚</td></tr></tbody></table><h3 id="ä¿¡å·æ©ç -initsigmask">ä¿¡å·æ©ç  initSigmask</h3><p>è¿™ä¸¤è¡Œä»£ç æ˜¯åœ¨æå•¥å‘¢ï¼Ÿ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">sigsave(&amp;gp.m.sigmask)<br>initSigmask = gp.m.sigmask<br></code></pre></td></tr></table></figure><ul><li><code>sigmask</code> çš„ä¸­æ–‡æ„æ€æ˜¯ <code>ä¿¡å·æ©ç </code>ã€‚</li></ul><p>å…ˆçœ‹ä¸€ä¸‹æºç ä¸­ <code>initSigmast</code> çš„æ³¨é‡Šï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Value to use for signal mask for newly created M&#x27;s.</span><br><span class="hljs-keyword">var</span> initSigmask sigset<br></code></pre></td></tr></table></figure><ul><li><code>initSigmask</code> æ˜¯ä¸€ä¸ªå˜é‡ï¼Œå­˜å‚¨ç€ç”¨äºæ–°åˆ›å»ºçš„Mï¼ˆMachineï¼Œå³æ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼‰çš„åˆå§‹ä¿¡å·æ©ç ã€‚</li></ul><p>ä»€ä¹ˆæ˜¯ä¿¡å·æ©ç ï¼š</p><ul><li>ä¿¡å·æ©ç æ˜¯æ“ä½œç³»ç»Ÿä¸­ç”¨äºæ§åˆ¶ä¿¡å·ä¼ é€’ç»™è¿›ç¨‹æˆ–çº¿ç¨‹çš„ä¸€ç§æœºåˆ¶ã€‚å®ƒå…è®¸è¿›ç¨‹æˆ–çº¿ç¨‹æŒ‡å®šå“ªäº›ä¿¡å·å¯ä»¥è¢«é˜»å¡ï¼ˆæš‚æ—¶å¿½ç•¥ï¼‰æˆ–å…è®¸ã€‚åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œè¿™ä¸ªæœºåˆ¶å°¤å…¶é‡è¦ï¼Œå› ä¸ºå®ƒå¸®åŠ©ç¡®ä¿çº¿ç¨‹å®‰å…¨åœ°å¤„ç†ä¿¡å·ã€‚</li></ul><p>ä¿¡å·æ©ç çš„ä½œç”¨ï¼š</p><ul><li>ä¿¡å·æ©ç å®šä¹‰äº†ä¸€ç»„ä¿¡å·ï¼Œè¿™äº›ä¿¡å·åœ¨ç‰¹å®šæ—¶é—´å†…ä¸ä¼šä¼ é€’ç»™è¿›ç¨‹æˆ–çº¿ç¨‹ï¼Œå³ä½¿è¿™äº›ä¿¡å·å‘ç”Ÿäº†ä¹Ÿä¼šè¢«ç³»ç»ŸæŒ‚èµ·ã€‚è¿™å…è®¸è¿›ç¨‹æˆ–çº¿ç¨‹åœ¨ä¸€ä¸ªç¨³å®šçš„çŠ¶æ€ä¸‹è¿è¡Œï¼Œä¸è¢«ç‰¹å®šä¿¡å·ä¸­æ–­ã€‚</li><li>è¿™ç§æœºåˆ¶å¯¹äºå¤„ç†é‚£äº›å¯èƒ½åœ¨å…³é”®æ“ä½œæœŸé—´å¯¼è‡´ä¸ç¨³å®šçŠ¶æ€çš„ä¿¡å·ç‰¹åˆ«é‡è¦ã€‚</li></ul><p>ä¿¡å·æ©ç çš„é‡è¦æ€§ï¼š</p><ul><li>åœ¨å¤šçº¿ç¨‹ç¨‹åºä¸­ï¼Œä¸åŒçš„çº¿ç¨‹å¯èƒ½éœ€è¦å“åº”ä¸åŒçš„ä¿¡å·æˆ–ä»¥ä¸åŒæ–¹å¼å¤„ç†ç›¸åŒçš„ä¿¡å·ã€‚é€šè¿‡ä¸ºæ¯ä¸ªçº¿ç¨‹è®¾ç½®é€‚å½“çš„ä¿¡å·æ©ç ï¼Œå¯ä»¥ç¡®ä¿çº¿ç¨‹åªå¤„ç†å¯¹å®ƒä»¬æ¥è¯´é‡è¦çš„ä¿¡å·ã€‚</li><li>è¿™æœ‰åŠ©äºé˜²æ­¢çº¿ç¨‹åœ¨æ‰§è¡Œå…³é”®ä»£ç æ—¶è¢«ä¸ç›¸å…³çš„ä¿¡å·æ‰“æ–­ã€‚</li></ul><p><strong>sigsave(&amp;gp.m.sigmask)</strong>ï¼š</p><ul><li><code>sigsave(&amp;gp.m.sigmask)</code> è¿™ä¸ªè°ƒç”¨æ˜¯åœ¨ä¿å­˜å½“å‰ Mçš„ä¿¡å·æ©ç ã€‚<code>gp</code> æŒ‡çš„æ˜¯å½“å‰çš„ goroutineï¼Œ<code>gp.m</code>æ˜¯è¯¥ goroutine æ­£åœ¨è¿è¡Œçš„ Mï¼ˆæ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼‰ã€‚</li><li><code>sigsave</code> å‡½æ•°çš„ä½œç”¨æ˜¯å°† <code>gp.m</code>çš„å½“å‰ä¿¡å·æ©ç ä¿å­˜åˆ°æä¾›çš„åœ°å€ï¼ˆåœ¨è¿™é‡Œæ˜¯<code>&amp;gp.m.sigmask</code>ï¼‰ã€‚è¿™å¯¹äºæ¢å¤çº¿ç¨‹çš„ä¿¡å·æ©ç åˆ°ä¸€ä¸ªå·²çŸ¥çŠ¶æ€æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚</li></ul><p><strong>initSigmask = gp.m.sigmask</strong>ï¼š</p><ul><li>è¿™ä¸€è¡Œå°† <code>gp.m</code> çš„ä¿¡å·æ©ç èµ‹å€¼ç»™<code>initSigmask</code>ã€‚è¿™æ„å‘³ç€ <code>initSigmask</code>ç°åœ¨ä¿å­˜äº†å½“å‰ M çš„ä¿¡å·æ©ç ï¼Œè¿™ä¸ªæ©ç å°†è¢«ç”¨ä½œæ–°åˆ›å»ºçš„ Mçš„åˆå§‹ä¿¡å·æ©ç ã€‚</li><li>è¿™æ˜¯ä¸€ä¸ªé‡è¦çš„æ­¥éª¤ï¼Œå› ä¸ºå®ƒç¡®ä¿äº†æ‰€æœ‰æ–°åˆ›å»ºçš„ M éƒ½å°†å…·æœ‰ä¸å½“å‰ Mç›¸åŒçš„ä¿¡å·å¤„ç†è¡Œä¸ºã€‚</li><li>è¿™æ„å‘³ç€æ‰€æœ‰æ–°çº¿ç¨‹éƒ½ä¼šä»¥ä¸€è‡´çš„ä¿¡å·æ©ç å¯åŠ¨ï¼Œè¿™æœ‰åŠ©äºé¿å…ç”±äºä¸åŒçº¿ç¨‹å¤„ç†ä¿¡å·çš„ä¸ä¸€è‡´æ€§å¯¼è‡´çš„é—®é¢˜ã€‚</li></ul><p>æ€»ä½“æ¥è¯´ï¼ŒGoè¯­è¨€åœ¨å…¶è¿è¡Œæ—¶ä¸­è¿™æ ·å¤„ç†ä¿¡å·æ©ç ï¼Œæ˜¯ä¸ºäº†ç¡®ä¿åœ¨å¹¶å‘æ‰§è¡Œå’Œçº¿ç¨‹è°ƒåº¦ä¸­èƒ½å¤Ÿå®‰å…¨ã€ä¸€è‡´åœ°å¤„ç†ä¿¡å·ï¼Œè¿™å¯¹äºç»´æŠ¤é«˜æ•ˆå’Œç¨³å®šçš„è¿è¡Œæ—¶ç¯å¢ƒè‡³å…³é‡è¦ã€‚</p><h3 id="åˆå§‹åŒ–åƒåœ¾å›æ”¶å™¨-gcinit">åˆå§‹åŒ–åƒåœ¾å›æ”¶å™¨ gcinit()</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">gcinit</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-comment">// æ£€æŸ¥ workbuf ç»“æ„ä½“çš„å¤§å°æ˜¯å¦ç­‰äºé¢„æœŸçš„ _WorkbufSizeã€‚</span><br>    <span class="hljs-comment">// å¦‚æœä¸æ˜¯ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚è¿™æ˜¯ä¸ºäº†ç¡®ä¿ workbuf çš„å¤§å°æ˜¯æœ€ä¼˜çš„ï¼Œ</span><br>    <span class="hljs-comment">// workbuf ç”¨äºåƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­çš„å†…éƒ¨å·¥ä½œã€‚</span><br>    <span class="hljs-keyword">if</span> unsafe.Sizeof(workbuf&#123;&#125;) != _WorkbufSize &#123;<br>       throw(<span class="hljs-string">&quot;size of Workbuf is suboptimal&quot;</span>)<br>    &#125;<br>    <span class="hljs-comment">// ç¬¬ä¸€ä¸ªåƒåœ¾å›æ”¶å‘¨æœŸä¸è¿›è¡Œæ‰«ææ“ä½œã€‚</span><br>    <span class="hljs-comment">// åœ¨ Go çš„åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­ï¼Œæ‰«ææ˜¯å›æ”¶å‰æ¸…ç†å†…å­˜çš„é‡è¦æ­¥éª¤ã€‚</span><br>    sweep.active.state.Store(sweepDrainedMask)<br><br>    <span class="hljs-comment">// ä½¿ç”¨ç¯å¢ƒå˜é‡ GOGC å’Œ GOMEMLIMIT æ¥è®¾ç½®åˆå§‹çš„åƒåœ¾å›æ”¶ç™¾åˆ†æ¯”å’Œå†…å­˜é™åˆ¶ã€‚</span><br>    gcController.init(readGOGC(), readGOMEMLIMIT())<br><br>    <span class="hljs-comment">// åˆå§‹åŒ–ç”¨äºæ§åˆ¶åƒåœ¾å›æ”¶å·¥ä½œæµç¨‹çš„ä¿¡å·é‡ã€‚</span><br>    <span class="hljs-comment">// è¿™äº›ä¿¡å·é‡ç”¨äºåŒæ­¥åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­çš„ä¸åŒé˜¶æ®µã€‚</span><br>    work.startSema = <span class="hljs-number">1</span><br>    work.markDoneSema = <span class="hljs-number">1</span><br>    <br>    <span class="hljs-comment">// åˆå§‹åŒ–äº†ç”¨äºåƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­çš„å„ç§é”ã€‚</span><br>    <span class="hljs-comment">// è¿™äº›é”ç”¨äºä¿æŠ¤åƒåœ¾å›æ”¶ç›¸å…³æ•°æ®ç»“æ„çš„å¹¶å‘è®¿é—®ï¼Œç¡®ä¿åƒåœ¾å›æ”¶è¿‡ç¨‹çš„çº¿ç¨‹å®‰å…¨ã€‚</span><br>    lockInit(&amp;work.sweepWaiters.lock, lockRankSweepWaiters)<br>    lockInit(&amp;work.assistQueue.lock, lockRankAssistQueue)<br>    lockInit(&amp;work.wbufSpans.lock, lockRankWbufSpans)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *gcControllerState)</span></span> init(gcPercent <span class="hljs-type">int32</span>, memoryLimit <span class="hljs-type">int64</span>) &#123;<br>    <span class="hljs-comment">// è®¾ç½® heapMinimum ä¸ºé»˜è®¤çš„æœ€å°å †å¤§å°ã€‚</span><br>    <span class="hljs-comment">// è¿™æ˜¯åƒåœ¾å›æ”¶å™¨è€ƒè™‘å¯åŠ¨æ–°å›æ”¶å‘¨æœŸå‰çš„æœ€å°å †å†…å­˜å¤§å°ã€‚</span><br>c.heapMinimum = defaultHeapMinimum<br>    <br>    <span class="hljs-comment">// å°† triggered è®¾ç½®ä¸º uint64 çš„æœ€å¤§å€¼ã€‚</span><br>    <span class="hljs-comment">// è¿™ä¸ªå­—æ®µç”¨äºè¡¨ç¤ºè§¦å‘åƒåœ¾å›æ”¶çš„å†…å­˜é˜ˆå€¼ï¼Œ</span><br>    <span class="hljs-comment">// è¿™é‡Œçš„è®¾ç½®æ„å‘³ç€åœ¨åˆå§‹çŠ¶æ€ä¸‹ä¸ä¼šè‡ªåŠ¨è§¦å‘åƒåœ¾å›æ”¶</span><br>c.triggered = ^<span class="hljs-type">uint64</span>(<span class="hljs-number">0</span>)<br>    <br>    <span class="hljs-comment">// è®¾ç½®åƒåœ¾å›æ”¶çš„ç™¾åˆ†æ¯”é˜ˆå€¼ã€‚</span><br>    <span class="hljs-comment">// gcPercent å‚æ•°è¡¨ç¤ºè§¦å‘åƒåœ¾å›æ”¶çš„å†…å­˜å¢é•¿ç™¾åˆ†æ¯”ã€‚</span><br>    <span class="hljs-comment">// è¿™ä¸ªè®¾ç½®æ§åˆ¶äº†å †å†…å­˜å¢é•¿åˆ°å¤šå°‘ç™¾åˆ†æ¯”æ—¶ä¼šè§¦å‘åƒåœ¾å›æ”¶ã€‚</span><br>c.setGCPercent(gcPercent)<br>    <br>    <span class="hljs-comment">// è®¾ç½®å†…å­˜é™åˆ¶ã€‚</span><br>    <span class="hljs-comment">// memoryLimit å‚æ•°å¯èƒ½è¡¨ç¤ºå †å†…å­˜çš„æœ€å¤§é™åˆ¶ï¼Œ</span><br>    <span class="hljs-comment">// ç”¨äºæ§åˆ¶åƒåœ¾å›æ”¶å™¨åœ¨å†…å­˜ä½¿ç”¨æ–¹é¢çš„è¡Œä¸ºã€‚</span><br>c.setMemoryLimit(memoryLimit)<br>    <br>    <span class="hljs-comment">// æäº¤åƒåœ¾å›æ”¶æ§åˆ¶å™¨çš„å½“å‰è®¾ç½®ï¼Œå¹¶æŒ‡ç¤ºç¬¬ä¸€æ¬¡åƒåœ¾å›æ”¶å‘¨æœŸæ²¡æœ‰æ‰«æï¼ˆsweepï¼‰é˜¶æ®µã€‚</span><br>    <span class="hljs-comment">// åœ¨ Go çš„åƒåœ¾å›æ”¶ä¸­ï¼Œæ‰«ææ˜¯å›æ”¶å‘¨æœŸçš„ä¸€éƒ¨åˆ†ï¼Œè¿™é‡ŒæŒ‡æ˜åœ¨ç¬¬ä¸€æ¬¡åƒåœ¾å›æ”¶æ—¶è·³è¿‡æ‰«æé˜¶æ®µã€‚</span><br>c.commit(<span class="hljs-literal">true</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="runtimenewproc">runtimeÂ·newproc â˜…</h2><p>åˆå§‹åŒ–å®Œè°ƒåº¦å™¨åï¼Œå°±è¿›å…¥åˆ°åˆ›å»º g0çš„é˜¶æ®µäº†ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªåç¨‹æ¥è¿è¡Œç¨‹åºçš„å…¥å£ï¼š<code>runtime.main</code>ã€‚</p><p><code>newproc()</code> çš„ä½œç”¨å¦‚æ³¨é‡Šæ‰€è¯´ï¼š<strong>åˆ›å»ºä¸€ä¸ªæ–°çš„goroutine æ¥æ‰§è¡Œ <code>fn</code>ï¼Œå¹¶å°†å®ƒæ”¾å…¥ç­‰å¾…è¿è¡Œçš„ gé˜Ÿåˆ—ä¸­ã€‚</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Create a new g running fn.</span><br><span class="hljs-comment">// Put it on the queue of g&#x27;s waiting to run.</span><br><span class="hljs-comment">// The compiler turns a go statement into a call to this.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newproc</span><span class="hljs-params">(fn *funcval)</span></span> &#123;<br>gp := getg()<span class="hljs-comment">// è·å–å½“å‰åç¨‹</span><br>pc := getcallerpc()<span class="hljs-comment">// è·å–å½“å‰ç¨‹åºè®¡æ•°å™¨</span><br>systemstack(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<span class="hljs-comment">// åœ¨ç³»ç»Ÿæ ˆä¸Šæ‰§è¡Œæ–° goroutine çš„åˆ›å»º</span><br>newg := newproc1(fn, gp, pc)<span class="hljs-comment">// åˆ›å»ºæ–° goroutine</span><br><br>pp := getg().m.p.ptr()<span class="hljs-comment">// è·å–å½“å‰ M ç»‘å®šçš„ P</span><br>runqput(pp, newg, <span class="hljs-literal">true</span>)<span class="hljs-comment">// å°†æ–°åˆ›å»ºçš„ goroutine æ”¾å…¥ P çš„æœ¬åœ°é˜Ÿåˆ—ä¸­</span><br><br><span class="hljs-keyword">if</span> mainStarted &#123;<br>wakep()<span class="hljs-comment">// å¦‚æœä¸»ç¨‹åºå·²ç»å¯åŠ¨ï¼Œåˆ™å”¤é†’æˆ–å¯åŠ¨ä¸€ä¸ª Mï¼Œä»¥ç¡®ä¿æ–°çš„ goroutine æœ‰æœºä¼šè¢«æ‰§è¡Œ</span><br>&#125;<br>&#125;)<br>&#125;<br></code></pre></td></tr></table></figure><p>é‡ç‚¹æ¥çœ‹ä¸€ä¸‹ <code>newproc1()</code> å’Œ <code>runqput()</code>ã€‚</p><h3 id="åˆ›å»ºåç¨‹-newproc1">åˆ›å»ºåç¨‹ newproc1()</h3><p>è¿™æ®µä»£ç çš„ä¸»è¦ä½œç”¨æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„ goroutineå¹¶è®¾ç½®å…¶åˆå§‹çŠ¶æ€ï¼Œä»¥ä¾¿å®ƒå¯ä»¥è¢«è°ƒåº¦å™¨å®‰æ’è¿è¡Œã€‚å®ƒå¤„ç†äº†ä»åˆ†é… goroutineçš„å†…å­˜åˆ°è®¾ç½®å…¶æ ˆç©ºé—´å’Œè°ƒåº¦ä¿¡æ¯ç­‰ä¸€ç³»åˆ—æ­¥éª¤ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„ goroutineï¼ŒçŠ¶æ€ä¸º _Grunnableï¼Œä»å‡½æ•° fn å¼€å§‹æ‰§è¡Œã€‚</span><br><span class="hljs-comment">// callerpc æ˜¯åˆ›å»ºæ­¤ goroutine çš„ go è¯­å¥çš„åœ°å€ã€‚</span><br><span class="hljs-comment">// è°ƒç”¨è€…è´Ÿè´£å°†æ–°çš„ g æ·»åŠ åˆ°è°ƒåº¦å™¨ä¸­ã€‚</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newproc1</span><span class="hljs-params">(fn *funcval, callergp *g, callerpc <span class="hljs-type">uintptr</span>)</span></span> *g &#123;<br><span class="hljs-keyword">if</span> fn == <span class="hljs-literal">nil</span> &#123;<br>fatal(<span class="hljs-string">&quot;go of nil func value&quot;</span>) <span class="hljs-comment">// å¦‚æœ fn æ˜¯ nilï¼ŒæŠ›å‡ºè‡´å‘½é”™è¯¯</span><br>&#125;<br><br>mp := acquirem() <span class="hljs-comment">// ç¦ç”¨æŠ¢å ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨å±€éƒ¨å˜é‡ä¸­æŒæœ‰ M å’Œ P</span><br>pp := mp.p.ptr()<br>newg := gfget(pp) <span class="hljs-comment">// å°è¯•ä» P çš„ç©ºé—²åˆ—è¡¨ä¸­è·å–ä¸€ä¸ª g</span><br><span class="hljs-keyword">if</span> newg == <span class="hljs-literal">nil</span> &#123;<br>newg = malg(stackMin) <span class="hljs-comment">// å¦‚æœæ²¡æœ‰ç©ºé—²çš„ gï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„</span><br>casgstatus(newg, _Gidle, _Gdead) <span class="hljs-comment">// å°† g çš„çŠ¶æ€ä» _Gidle æ”¹ä¸º _Gdead</span><br>allgadd(newg) <span class="hljs-comment">// å°†æ–°çš„ g æ·»åŠ åˆ°æ‰€æœ‰ goroutine çš„åˆ—è¡¨ä¸­</span><br>&#125;<br><span class="hljs-keyword">if</span> newg.stack.hi == <span class="hljs-number">0</span> &#123;<br>throw(<span class="hljs-string">&quot;newproc1: newg missing stack&quot;</span>) <span class="hljs-comment">// å¦‚æœæ–°çš„ g æ²¡æœ‰æ ˆï¼ŒæŠ›å‡ºå¼‚å¸¸</span><br>&#125;<br><br><span class="hljs-keyword">if</span> readgstatus(newg) != _Gdead &#123;<br>throw(<span class="hljs-string">&quot;newproc1: new g is not Gdead&quot;</span>) <span class="hljs-comment">// ç¡®ä¿æ–°çš„ g çš„çŠ¶æ€ä¸º _Gdead</span><br>&#125;<br><br>totalSize := <span class="hljs-type">uintptr</span>(<span class="hljs-number">4</span>*goarch.PtrSize + sys.MinFrameSize) <span class="hljs-comment">// è®¡ç®—é¢å¤–çš„æ ˆç©ºé—´å¤§å°</span><br>totalSize = alignUp(totalSize, sys.StackAlign) <span class="hljs-comment">// æ ˆç©ºé—´å¯¹é½</span><br>sp := newg.stack.hi - totalSize <span class="hljs-comment">// è®¾ç½®æ ˆæŒ‡é’ˆ</span><br>spArg := sp<br><span class="hljs-keyword">if</span> usesLR &#123;<br>*(*<span class="hljs-type">uintptr</span>)(unsafe.Pointer(sp)) = <span class="hljs-number">0</span> <span class="hljs-comment">// é’ˆå¯¹ LR æ¶æ„ï¼Œè®¾ç½®è°ƒç”¨è€…çš„ LR</span><br>prepGoExitFrame(sp)<br>spArg += sys.MinFrameSize<br>&#125;<br><br>memclrNoHeapPointers(unsafe.Pointer(&amp;newg.sched), unsafe.Sizeof(newg.sched)) <span class="hljs-comment">// æ¸…é™¤è°ƒåº¦å™¨çš„å†…å­˜</span><br>newg.sched.sp = sp <span class="hljs-comment">// è®¾ç½®è°ƒåº¦å™¨çš„æ ˆæŒ‡é’ˆ</span><br>newg.stktopsp = sp <span class="hljs-comment">// è®¾ç½®æ ˆé¡¶æŒ‡é’ˆ</span><br><span class="hljs-comment">// è®¾ç½®è°ƒåº¦å™¨çš„ç¨‹åºè®¡æ•°å™¨ï¼Œ+PCQuantum ä½¿å¾—å‰ä¸€ä¸ªæŒ‡ä»¤åœ¨åŒä¸€å‡½æ•°ä¸­</span><br>newg.sched.pc = abi.FuncPCABI0(goexit) + sys.PCQuantum <br>newg.sched.g = guintptr(unsafe.Pointer(newg)) <span class="hljs-comment">// è®¾ç½®è°ƒåº¦å™¨çš„ g æŒ‡é’ˆ</span><br>gostartcallfn(&amp;newg.sched, fn) <span class="hljs-comment">// å¯åŠ¨æ–°çš„ g æ‰§è¡Œå‡½æ•° fn</span><br>newg.parentGoid = callergp.goid <span class="hljs-comment">// è®¾ç½®æ–° g çš„çˆ¶ goroutine ID</span><br>newg.gopc = callerpc <span class="hljs-comment">// è®¾ç½®æ–° g çš„åˆ›å»ºä½ç½®</span><br>newg.ancestors = saveAncestors(callergp) <span class="hljs-comment">// ä¿å­˜ç¥–å…ˆä¿¡æ¯</span><br>newg.startpc = fn.fn <span class="hljs-comment">// è®¾ç½®æ–° g çš„èµ·å§‹å‡½æ•°åœ°å€</span><br><span class="hljs-keyword">if</span> isSystemGoroutine(newg, <span class="hljs-literal">false</span>) &#123;<br>sched.ngsys.Add(<span class="hljs-number">1</span>) <span class="hljs-comment">// å¦‚æœæ˜¯ç³»ç»Ÿ goroutineï¼Œå¢åŠ è®¡æ•°</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">if</span> mp.curg != <span class="hljs-literal">nil</span> &#123;<br>newg.labels = mp.curg.labels <span class="hljs-comment">// åªæœ‰ç”¨æˆ· goroutines ç»§æ‰¿ pprof æ ‡ç­¾</span><br>&#125;<br><span class="hljs-keyword">if</span> goroutineProfile.active &#123;<br>newg.goroutineProfiled.Store(goroutineProfileSatisfied) <span class="hljs-comment">// æ ‡è®°ä¸éœ€è¦çº³å…¥ goroutine åˆ†æ</span><br>&#125;<br>&#125;<br>newg.trackingSeq = <span class="hljs-type">uint8</span>(fastrand()) <span class="hljs-comment">// è®¾ç½®è¿½è¸ªåºåˆ—å·</span><br><span class="hljs-keyword">if</span> newg.trackingSeq%gTrackingPeriod == <span class="hljs-number">0</span> &#123;<br>newg.tracking = <span class="hljs-literal">true</span> <span class="hljs-comment">// æ˜¯å¦å¯ç”¨è¿½è¸ª</span><br>&#125;<br>casgstatus(newg, _Gdead, _Grunnable) <span class="hljs-comment">// å°†æ–° g çš„çŠ¶æ€ä» _Gdead æ”¹ä¸º _Grunnable</span><br>gcController.addScannableStack(pp, <span class="hljs-type">int64</span>(newg.stack.hi-newg.stack.lo)) <span class="hljs-comment">// å°†æ–° g çš„æ ˆæ·»åŠ åˆ°å¯æ‰«ææ ˆåˆ—è¡¨</span><br><br><span class="hljs-keyword">if</span> pp.goidcache == pp.goidcacheend &#123;<br>pp.goidcache = sched.goidgen.Add(_GoidCacheBatch) <span class="hljs-comment">// åˆ†é…æ–°çš„ goroutine ID</span><br>pp.goidcache -= _GoidCacheBatch - <span class="hljs-number">1</span><br>pp.goidcacheend = pp.goidcache + _GoidCacheBatch<br>&#125;<br>newg.goid = pp.goidcache <span class="hljs-comment">// è®¾ç½®æ–° g çš„ ID</span><br>pp.goidcache++<br><span class="hljs-keyword">if</span> raceenabled &#123;<br>newg.racectx = racegostart(callerpc) <span class="hljs-comment">// è®¾ç½®ç«æ€æ£€æµ‹ä¸Šä¸‹æ–‡</span><br>newg.raceignore = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> newg.labels != <span class="hljs-literal">nil</span> &#123;<br>racereleasemergeg(newg, unsafe.Pointer(&amp;labelSync)) <span class="hljs-comment">// åŒæ­¥ç«æ€æ£€æµ‹å’Œä¿¡å·å¤„ç†</span><br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> traceEnabled() &#123;<br>traceGoCreate(newg, newg.startpc) <span class="hljs-comment">// è®°å½•è¿½è¸ªä¿¡æ¯</span><br>&#125;<br>releasem(mp) <span class="hljs-comment">// é‡Šæ”¾å½“å‰ M</span><br><br><span class="hljs-keyword">return</span> newg <span class="hljs-comment">// è¿”å›æ–°åˆ›å»ºçš„ goroutine</span><br>&#125;<br></code></pre></td></tr></table></figure><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20231210231623561.png"alt="newproc1() å‡½æ•°æ¦‚è¿°" /><figcaption aria-hidden="true">newproc1() å‡½æ•°æ¦‚è¿°</figcaption></figure><p>æœ‰å‡ ä¸ªåœ°æ–¹æ¯”è¾ƒæœ‰è¶£ï¼Œæˆ‘ä»¬å¯ä»¥æ¥ç ”ç©¶ä¸€ä¸‹ã€‚</p><h4 id="è·å–-g">è·å– g</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// The minimum size of stack used by Go code</span><br>stackMin = <span class="hljs-number">2048</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newproc1</span><span class="hljs-params">()</span></span> &#123;<br>    ...<br>    newg := gfget(pp) <span class="hljs-comment">// å°è¯•ä» P çš„ç©ºé—²åˆ—è¡¨ä¸­è·å–ä¸€ä¸ª g</span><br>    <span class="hljs-keyword">if</span> newg == <span class="hljs-literal">nil</span> &#123;<br>        newg = malg(stackMin) <span class="hljs-comment">// å¦‚æœæ²¡æœ‰ç©ºé—²çš„ gï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„</span><br>        casgstatus(newg, _Gidle, _Gdead) <span class="hljs-comment">// å°† g çš„çŠ¶æ€ä» _Gidle æ”¹ä¸º _Gdead</span><br>        allgadd(newg) <span class="hljs-comment">// å°†æ–°çš„ g æ·»åŠ åˆ°æ‰€æœ‰ goroutine çš„åˆ—è¡¨ä¸­</span><br>    &#125;<br>    ...<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼ŒGo è¯­è¨€æ¯ä¸ªæ–°åˆ›å»ºçš„åç¨‹åˆ†é…çš„é»˜è®¤å¤§å°å°±æ˜¯<code>stackMin</code>ï¼Œå³ <code>2KB</code>ã€‚</p><p>å…¶å® <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/stack.go">statck.go</a>è¿˜å®šä¹‰äº†å¦å¤–ä¸€ä¸ªå­—æ®µï¼Œå³æ ˆæœ€å¤§ä¸º <code>2GB</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒGoåç¨‹æ ˆå¤§å° <code>[2KB, 2GB]</code>ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> maxstacksize <span class="hljs-type">uintptr</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">20</span> <span class="hljs-comment">// enough until runtime.main sets it for real</span><br></code></pre></td></tr></table></figure><p>å¦å¤–æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥ï¼ŒGo è¯­è¨€ä¼šå°½å¯èƒ½é‡ç”¨ç°æœ‰çš„ç©ºé—²goroutineï¼Œä»¥å‡å°‘å†…å­˜åˆ†é…çš„å¼€é”€ï¼Œæä¾›åˆ›å»ºæ–° goroutine çš„æ•ˆç‡ã€‚</p><p>é‡ç”¨çš„å…·ä½“é€»è¾‘åœ¨ <code>gfget(pp)</code> ä¸­ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯ä»ä¸å½“å‰M ç»‘å®šçš„ P çš„ç©ºé—²åˆ—è¡¨ä¸­è·å–ä¸€ä¸ªç©ºé—²çš„gï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™å°è¯•ä»å…¨å±€ç©ºé—²åˆ—è¡¨ä¸­è·å– gã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Get from gfree list.</span><br><span class="hljs-comment">// If local list is empty, grab a batch from global list.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">gfget</span><span class="hljs-params">(pp *p)</span></span> *g &#123;<br>retry:<br>    <span class="hljs-comment">// å¦‚æœå½“å‰ P çš„ç©ºé—²é˜Ÿåˆ—ä¸ºç©ºï¼Œå¹¶ä¸”å…¨å±€ç©ºé—²é˜Ÿåˆ—ä¸­æœ‰å¯ç”¨çš„ goroutineï¼Œåˆ™è¿›è¡Œä¸‹åˆ—æ“ä½œã€‚</span><br><span class="hljs-keyword">if</span> pp.gFree.empty() &amp;&amp; (!sched.gFree.stack.empty() || !sched.gFree.noStack.empty()) &#123;<br>        <span class="hljs-comment">// æ·é”å…¨å±€ç©ºé—²åˆ—è¡¨</span><br>lock(&amp;sched.gFree.lock)<br><span class="hljs-comment">// å°†æœ€å¤š 32 ä¸ªç©ºé—²çš„ g ä»å…¨å±€åˆ—è¡¨ä¸­ç§»åŠ¨åˆ°å½“å‰ P çš„ç©ºé—²åˆ—è¡¨</span><br><span class="hljs-keyword">for</span> pp.gFree.n &lt; <span class="hljs-number">32</span> &#123;<br><span class="hljs-comment">// ä¼˜å…ˆé€‰æ‹©æœ‰æ ˆçš„ g</span><br>gp := sched.gFree.stack.pop()<br><span class="hljs-keyword">if</span> gp == <span class="hljs-literal">nil</span> &#123;<br>                <span class="hljs-comment">// å®åœ¨æ²¡æœ‰æ ˆï¼Œä¹Ÿå¯ä»¥æ¥å—</span><br>gp = sched.gFree.noStack.pop()<br><span class="hljs-keyword">if</span> gp == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">break</span><br>&#125;<br>&#125;<br>sched.gFree.n--<br>pp.gFree.push(gp)<br>pp.gFree.n++<br>&#125;<br>unlock(&amp;sched.gFree.lock)<br>        <span class="hljs-comment">// ä¸€ç›´å°è¯•ï¼ŒçŸ¥é“ P æœ‰ç©ºé—² gï¼Œæˆ–è€…å…¨å±€åˆ—è¡¨ä¹Ÿæ²¡æœ‰ç©ºé—² g äº†ï¼Œå°±é€€å‡º for å¾ªç¯ï¼Œè¿›è¡Œä¸‹é¢çš„æ“ä½œã€‚</span><br><span class="hljs-keyword">goto</span> retry<br>&#125;<br>    <br>    <span class="hljs-comment">// ä» P çš„ç©ºé—²åˆ—è¡¨ä¸­å–å‡ºä¸€ä¸ª g</span><br>gp := pp.gFree.pop()<br><span class="hljs-keyword">if</span> gp == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br>pp.gFree.n--<br>    <br>    <span class="hljs-comment">// æ£€æŸ¥è·å–åˆ°çš„ g æ˜¯å¦æœ‰ä¸€ä¸ªæœ‰æ•ˆçš„æ ˆï¼Œå¦‚æœæ ˆä¸ç¬¦åˆé¢„æœŸçš„å¤§å°ï¼Œåˆ™é‡Šæ”¾æ—§æ ˆ</span><br><span class="hljs-keyword">if</span> gp.stack.lo != <span class="hljs-number">0</span> &amp;&amp; gp.stack.hi-gp.stack.lo != <span class="hljs-type">uintptr</span>(startingStackSize) &#123;<br>systemstack(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>stackfree(gp.stack)<br>gp.stack.lo = <span class="hljs-number">0</span><br>gp.stack.hi = <span class="hljs-number">0</span><br>gp.stackguard0 = <span class="hljs-number">0</span><br>&#125;)<br>&#125;<br>    <span class="hljs-comment">// å¦‚æœ g æ²¡æœ‰æœ‰æ•ˆçš„æ ˆï¼Œæˆ–è€…åˆšåˆšè¢«é‡Šæ”¾äº†ï¼Œåˆ™åˆ†é…æ–°æ ˆç»™ g</span><br><span class="hljs-keyword">if</span> gp.stack.lo == <span class="hljs-number">0</span> &#123;<br>systemstack(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>gp.stack = stackalloc(startingStackSize)<br>&#125;)<br>gp.stackguard0 = gp.stack.lo + stackGuard<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">if</span> raceenabled &#123;<br>racemalloc(unsafe.Pointer(gp.stack.lo), gp.stack.hi-gp.stack.lo)<br>&#125;<br><span class="hljs-keyword">if</span> msanenabled &#123;<br>msanmalloc(unsafe.Pointer(gp.stack.lo), gp.stack.hi-gp.stack.lo)<br>&#125;<br><span class="hljs-keyword">if</span> asanenabled &#123;<br>asanunpoison(unsafe.Pointer(gp.stack.lo), gp.stack.hi-gp.stack.lo)<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> gp<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>startingStackSize</code> è¡¨ç¤ºæ–°åˆ›å»ºçš„ goroutineå¼€å§‹æ—¶çš„æ ˆå¤§å°ã€‚å®ƒè¢«åˆå§‹åŒ–ä¸º <code>fixedStack</code>çš„å€¼ã€‚<code>startingStackSize</code>åœ¨æ¯æ¬¡åƒåœ¾å›æ”¶ï¼ˆGCï¼‰åå¯èƒ½ä¼šæ›´æ–°ï¼Œä»¥åæ˜ åœ¨ GCè¿‡ç¨‹ä¸­æ‰«æçš„æ ˆçš„å¹³å‡å¤§å°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> startingStackSize <span class="hljs-type">uint32</span> = fixedStack<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">gcComputeStartingStackSize</span><span class="hljs-params">()</span></span> &#123;<br>...<br>    <span class="hljs-comment">// æ±‚å‡ºæ ˆå¹³å‡å¤§å°</span><br>avg := scannedStackSize/scannedStacks + stackGuard<br><br><span class="hljs-keyword">if</span> avg &gt; <span class="hljs-type">uint64</span>(maxstacksize) &#123;<br>avg = <span class="hljs-type">uint64</span>(maxstacksize)<br>&#125;<br><span class="hljs-keyword">if</span> avg &lt; fixedStack &#123;<br>avg = fixedStack<br>&#125;<br>    <span class="hljs-comment">// æ›´æ–° startingStackSize</span><br>startingStackSize = <span class="hljs-type">uint32</span>(round2(<span class="hljs-type">int32</span>(avg)))<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="åˆå§‹åŒ–åç¨‹æ ˆ">åˆå§‹åŒ–åç¨‹æ ˆ</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go">totalSize := <span class="hljs-type">uintptr</span>(<span class="hljs-number">4</span>*goarch.PtrSize + sys.MinFrameSize) <span class="hljs-comment">// è®¡ç®—é¢å¤–çš„æ ˆç©ºé—´å¤§å°</span><br>totalSize = alignUp(totalSize, sys.StackAlign) <span class="hljs-comment">// æ ˆç©ºé—´å¯¹é½</span><br>sp := newg.stack.hi - totalSize <span class="hljs-comment">// è®¾ç½®æ ˆæŒ‡é’ˆ</span><br>spArg := sp<br><span class="hljs-keyword">if</span> usesLR &#123;<br>    *(*<span class="hljs-type">uintptr</span>)(unsafe.Pointer(sp)) = <span class="hljs-number">0</span> <span class="hljs-comment">// é’ˆå¯¹ LR æ¶æ„ï¼Œè®¾ç½®è°ƒç”¨è€…çš„ LR</span><br>    prepGoExitFrame(sp)<br>    spArg += sys.MinFrameSize<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>1. è®¡ç®—é¢å¤–çš„æ ˆç©ºé—´å¤§å°</strong>:</p><p><code>totalSize := uintptr(4*goarch.PtrSize + sys.MinFrameSize)</code>è¿™è¡Œä»£ç è®¡ç®—æ–° goroutine éœ€è¦çš„é¢å¤–æ ˆç©ºé—´å¤§å°ã€‚</p><p><code>4*goarch.PtrSize</code>æ˜¯ä¸ºäº†ç•™å‡ºè¶³å¤Ÿçš„ç©ºé—´æ¥å­˜å‚¨å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­çš„ä¸€äº›é¢å¤–ä¿¡æ¯ï¼ˆä¾‹å¦‚è¿”å›åœ°å€ã€å¯„å­˜å™¨ä¿å­˜ç­‰ï¼‰ã€‚</p><p><code>sys.MinFrameSize</code>ï¼šæ˜¯ç³»ç»Ÿä¸ºæ¯ä¸ªæ ˆå¸§ä¿ç•™çš„æœ€å°ç©ºé—´ï¼Œç”¨äºå­˜å‚¨ä¸€äº›ç‰¹å®šäºæ¶æ„çš„ä¿¡æ¯ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// MinFrameSize is the size of the system-reserved words at the bottom</span><br><span class="hljs-comment">// of a frame (just above the architectural stack pointer).</span><br><span class="hljs-comment">// It is zero on x86 and PtrSize on most non-x86 (LR-based) systems.</span><br><span class="hljs-comment">// On PowerPC it is larger, to cover three more reserved words:</span><br><span class="hljs-comment">// the compiler word, the link editor word, and the TOC save word.</span><br><span class="hljs-keyword">const</span> MinFrameSize = goarch.MinFrameSize<br></code></pre></td></tr></table></figure><p><code>goarch.PtrSize</code>ï¼šæŒ‡é’ˆå¤§å°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// PtrSize is the size of a pointer in bytes - unsafe.Sizeof(uintptr(0)) but as an ideal constant.</span><br><span class="hljs-comment">// It is also the size of the machine&#x27;s native word size (that is, 4 on 32-bit systems, 8 on 64-bit).</span><br><span class="hljs-keyword">const</span> PtrSize = <span class="hljs-number">4</span> &lt;&lt; (^<span class="hljs-type">uintptr</span>(<span class="hljs-number">0</span>) &gt;&gt; <span class="hljs-number">63</span>)<br></code></pre></td></tr></table></figure><p><strong>2. æ ˆç©ºé—´å¯¹é½</strong>:</p><p><code>totalSize = alignUp(totalSize, sys.StackAlign)</code>:æ ¹æ®ç³»ç»Ÿçš„æ ˆå¯¹é½è¦æ±‚è°ƒæ•´ <code>totalSize</code>çš„å¤§å°ã€‚æ ˆå¯¹é½æ˜¯ä¸ºäº†ç¡®ä¿æ ˆä¸Šçš„æ•°æ®æŒ‰ç…§ç¡¬ä»¶è¦æ±‚çš„è¾¹ç•Œå¯¹é½ï¼Œè¿™é€šå¸¸æ˜¯ä¸ºäº†æé«˜è®¿é—®æ•ˆç‡æˆ–æ»¡è¶³ç‰¹å®šçš„ç¡¬ä»¶è¦æ±‚ã€‚</p><p><strong>3. è®¾ç½®æ ˆæŒ‡é’ˆ (<code>sp</code>)</strong>:</p><p><code>sp := newg.stack.hi - totalSize</code>: è®¡ç®—æ–° goroutineçš„æ ˆé¡¶æŒ‡é’ˆã€‚<code>newg.stack.hi</code> æ˜¯åˆ†é…ç»™è¿™ä¸ª goroutineçš„æ ˆçš„é«˜åœ°å€ï¼ˆæ ˆé¡¶ï¼‰ï¼Œä»è¿™é‡Œå‘ä¸‹åˆ†é…ç©ºé—´ã€‚é€šè¿‡ä»æ ˆé¡¶åœ°å€å‡å»è®¡ç®—å‡ºçš„<code>totalSize</code>ï¼Œè®¾ç½®æ–°çš„æ ˆé¡¶ä½ç½®ã€‚</p><p><strong>4. å¤„ç†é“¾æ¥å¯„å­˜å™¨ï¼ˆLRï¼‰æ¶æ„</strong>:</p><p>åœ¨æŸäº›æ¶æ„ä¸Šï¼ˆå¦‚ARMã€PowerPCï¼‰ï¼Œå‡½æ•°è°ƒç”¨çš„è¿”å›åœ°å€ä¸æ˜¯å­˜å‚¨åœ¨æ ˆä¸Šï¼Œè€Œæ˜¯å­˜å‚¨åœ¨ä¸€ä¸ªåä¸ºé“¾æ¥å¯„å­˜å™¨ï¼ˆLRï¼‰çš„ç‰¹æ®Šå¯„å­˜å™¨ä¸­ã€‚è¿™å‡ è¡Œä»£ç æ£€æŸ¥æ˜¯å¦åœ¨è¿™ç§æ¶æ„ä¸Šè¿è¡Œ(<code>usesLR</code>)ã€‚</p><ul><li>å¦‚æœæ˜¯ï¼Œåˆ™åœ¨æ ˆä¸Šçš„é€‚å½“ä½ç½®å­˜å‚¨ä¸€ä¸ª 0 å€¼ä½œä¸ºè¿”å›åœ°å€ï¼Œå¹¶è°ƒç”¨<code>prepGoExitFrame</code> æ¥å‡†å¤‡ goroutineé€€å‡ºæ—¶çš„æ ˆå¸§ã€‚è¿™æ˜¯ä¸ºäº†æ¨¡æ‹Ÿåœ¨é LR æ¶æ„ä¸Šçš„æ ˆå¸§ç»“æ„ã€‚</li><li><code>spArg</code>æ˜¯ä¸€ä¸ªè¾…åŠ©å˜é‡ï¼Œç”¨äºè®°å½•å‚æ•°ä¼ é€’æ—¶åº”è¯¥ä½¿ç”¨çš„æ ˆåœ°å€ã€‚åœ¨ LRæ¶æ„ä¸Šï¼Œå®ƒéœ€è¦æ ¹æ® <code>sys.MinFrameSize</code>è¿›è¡Œè°ƒæ•´ï¼Œä»¥ä¿è¯å‡½æ•°å‚æ•°çš„æ­£ç¡®ä½ç½®ã€‚</li></ul><h3 id="æ”¾å…¥é˜Ÿåˆ—-runqput">æ”¾å…¥é˜Ÿåˆ— runqput()</h3><p><code>runqput()</code> è´Ÿè´£å°† goroutine (<code>gp</code>)æ”¾å…¥åˆ°æœ¬åœ°å¯è¿è¡Œé˜Ÿåˆ—æˆ–å…¨å±€é˜Ÿåˆ—ä¸­ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// runqput å°è¯•å°† g æ”¾å…¥å½“å‰çš„æ‰§è¡Œé˜Ÿåˆ—ä¸­</span><br><span class="hljs-comment">// å¦‚æœ next=falseï¼Œåˆ™å°† g æ”¾åœ¨é˜Ÿåˆ—æœ«å°¾ï¼Œ</span><br><span class="hljs-comment">// å¦‚æœ next=trueï¼Œåˆ™å°† g æ”¾åœ¨ pp.runnextï¼Œå³ä¸‹ä¸€ä¸ªè¦æ‰§è¡Œçš„ goroutineã€‚</span><br><span class="hljs-comment">// å¦‚æœæœ¬åœ°é˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™åŠ å…¥åˆ°å…¨å±€é˜Ÿåˆ—ã€‚</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">runqput</span><span class="hljs-params">(pp *p, gp *g, next <span class="hljs-type">bool</span>)</span></span> &#123;<br>    <span class="hljs-comment">// å¦‚æœå¯ç”¨äº†éšæœºè°ƒåº¦å™¨ (randomizeScheduler)ï¼Œ</span><br>    <span class="hljs-comment">// å¹¶ä¸”è°ƒç”¨è€…æŒ‡ç¤ºå°† goroutine æ”¾å…¥ runnext ä½ç½® (next ä¸º true)ï¼Œ</span><br>    <span class="hljs-comment">// åˆ™æœ‰ 50% çš„æ¦‚ç‡å°† next è®¾ç½®ä¸º falseï¼Œä»¥éšæœºåœ°å°† goroutine æ”¾å…¥é˜Ÿåˆ—å°¾éƒ¨ã€‚</span><br><span class="hljs-keyword">if</span> randomizeScheduler &amp;&amp; next &amp;&amp; fastrandn(<span class="hljs-number">2</span>) == <span class="hljs-number">0</span> &#123;<br>next = <span class="hljs-literal">false</span><br>&#125;<br><br><span class="hljs-keyword">if</span> next &#123;<br>retryNext:<br>        <span class="hljs-comment">// å¦‚æœä¸º nextï¼Œåˆ™å°è¯•å°† p æ”¾å…¥ pp.runnext æ’æ§½</span><br>oldnext := pp.runnext<br><span class="hljs-keyword">if</span> !pp.runnext.cas(oldnext, guintptr(unsafe.Pointer(gp))) &#123;<br><span class="hljs-keyword">goto</span> retryNext<br>&#125;<br>        <span class="hljs-comment">// å¦‚æœè¿™ä¸ªæ§½ä¹‹å‰æ²¡æœ‰è¢«å ç”¨ï¼Œåˆ™ç›´æ¥è¿”å›</span><br><span class="hljs-keyword">if</span> oldnext == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br>        <span class="hljs-comment">// å¦‚æœè¿™ä¸ªæ§½ä¹‹å‰å·²ç»è¢«å ç”¨äº†ï¼Œåˆ™å‰”é™¤æ—§ goroutineï¼Œ</span><br>        <span class="hljs-comment">// ç„¶åè¿›è¡Œä¸‹é¢çš„é€»è¾‘ï¼Œå³å°†å…¶æ”¾å…¥å¸¸è§„çš„è¿è¡Œé˜Ÿåˆ—ä¸­</span><br>gp = oldnext.ptr()<br>&#125;<br><br>retry:<br>h := atomic.LoadAcq(&amp;pp.runqhead) <span class="hljs-comment">// å–å‡ºé˜Ÿåˆ—å¤´éƒ¨</span><br>t := pp.runqtail<span class="hljs-comment">// å–å‡ºé˜Ÿåˆ—å°¾éƒ¨</span><br>    <span class="hljs-comment">// å¦‚æœè¿˜æ²¡æ»¡ï¼Œåˆ™å°† gp æ”¾å…¥æœ¬åœ°é˜Ÿåˆ—ä¸­ï¼ˆå¯èƒ½æ˜¯æ–° gï¼Œä¹Ÿå¯èƒ½æ˜¯ä¹‹å‰åœ¨ runnext çš„ g</span><br><span class="hljs-keyword">if</span> t-h &lt; <span class="hljs-type">uint32</span>(<span class="hljs-built_in">len</span>(pp.runq)) &#123;<br>pp.runq[t%<span class="hljs-type">uint32</span>(<span class="hljs-built_in">len</span>(pp.runq))].set(gp)<br>atomic.StoreRel(&amp;pp.runqtail, t+<span class="hljs-number">1</span>) <span class="hljs-comment">// store-release, makes the item available for consumption</span><br><span class="hljs-keyword">return</span><br>&#125;<br>    <span class="hljs-comment">// å¦‚æœæœ¬åœ°é˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™å°è¯•å°†å…¶æ”¾å…¥å…¨å±€é˜Ÿåˆ—ä¸­</span><br><span class="hljs-keyword">if</span> runqputslow(pp, gp, h, t) &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">goto</span> retry<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>runqputslow()</code> ä¸ä»…ä¼šå°è¯•å°† <code>gp</code>æ”¾å…¥å…¨å±€é˜Ÿåˆ—ä¸­ï¼Œè¿˜ä¼šå°è¯•å°†æœ¬åœ°é˜Ÿåˆ—çš„éƒ¨åˆ† gæ”¾å…¥å…¨å±€é˜Ÿåˆ—ä¸­ï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™æœ¬åœ°é˜Ÿåˆ—å·²ç»æ»¡äº†ï¼Œæ”¾å…¥å…¨å±€é˜Ÿåˆ—ä¸­å°±æœ‰æœºä¼šè¢«å…¶ä»–P æ‰€è°ƒåº¦ï¼Œå‡å°‘é¥¥é¥¿ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Put g and a batch of work from local runnable queue on global queue.</span><br><span class="hljs-comment">// Executed only by the owner P.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">runqputslow</span><span class="hljs-params">(pp *p, gp *g, h, t <span class="hljs-type">uint32</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>    <br>    <span class="hljs-comment">// åˆå§‹åŒ–ä¸€ä¸ªæ•°ç»„ batchï¼Œå¤§å°ä¸ºæœ¬åœ°é˜Ÿåˆ—çš„ä¸€åŠï¼Œ</span><br>    <span class="hljs-comment">// å®ƒç”¨æ¥å­˜å‚¨å°†è¦ç§»åŠ¨åˆ°å…¨å±€é˜Ÿåˆ—çš„ goroutineã€‚</span><br><span class="hljs-keyword">var</span> batch [<span class="hljs-built_in">len</span>(pp.runq)/<span class="hljs-number">2</span> + <span class="hljs-number">1</span>]*g<br><br>n := t - h<br>n = n / <span class="hljs-number">2</span><br>    <span class="hljs-comment">// åªæœ‰æœ¬åœ°é˜Ÿåˆ—æ»¡æ‰è¿™ä¹ˆæ“ä½œ</span><br><span class="hljs-keyword">if</span> n != <span class="hljs-type">uint32</span>(<span class="hljs-built_in">len</span>(pp.runq)/<span class="hljs-number">2</span>) &#123;<br>throw(<span class="hljs-string">&quot;runqputslow: queue is not full&quot;</span>)<br>&#125;<br>    <span class="hljs-comment">// å°†æœ¬åœ°é˜Ÿåˆ—ä¸€åŠçš„ g å¤åˆ¶åˆ° batch ä¸­</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>); i &lt; n; i++ &#123;<br>batch[i] = pp.runq[(h+i)%<span class="hljs-type">uint32</span>(<span class="hljs-built_in">len</span>(pp.runq))].ptr()<br>&#125;<br>    <span class="hljs-comment">// CAS æ›´æ–°æœ¬åœ°é˜Ÿåˆ—å¤´æŒ‡é’ˆï¼Œå¦‚æœå¤±è´¥ï¼Œåˆ™è¿”å›</span><br><span class="hljs-keyword">if</span> !atomic.CasRel(&amp;pp.runqhead, h, h+n) &#123; <span class="hljs-comment">// cas-release, commits consume</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br>    <span class="hljs-comment">// å°†å½“å‰è¦è°ƒåº¦çš„ gp æ”¾å…¥ batch çš„æœ«å°¾</span><br>batch[n] = gp<br><br>    <span class="hljs-comment">// å¦‚æœå¯åŠ¨äº†éšæœºè°ƒåº¦å™¨ï¼Œåˆ™éšæœºåŒ– batch æ•°ç»„</span><br><span class="hljs-keyword">if</span> randomizeScheduler &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-type">uint32</span>(<span class="hljs-number">1</span>); i &lt;= n; i++ &#123;<br>j := fastrandn(i + <span class="hljs-number">1</span>)<br>batch[i], batch[j] = batch[j], batch[i]<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// é“¾æ¥ goroutineï¼Œä»¥ä¾¿å®ƒä»¬å¯ä»¥ä½œä¸ºä¸€ä¸ªè¿ç»­çš„é˜Ÿåˆ—è¢«å¤„ç†</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>); i &lt; n; i++ &#123;<br>batch[i].schedlink.set(batch[i+<span class="hljs-number">1</span>])<br>&#125;<br><span class="hljs-keyword">var</span> q gQueue<br>q.head.set(batch[<span class="hljs-number">0</span>])<br>q.tail.set(batch[n])<br><br><span class="hljs-comment">// å°† batch æ”¾å…¥å…¨å±€é˜Ÿåˆ—ä¸­</span><br>lock(&amp;sched.lock)<br>globrunqputbatch(&amp;q, <span class="hljs-type">int32</span>(n+<span class="hljs-number">1</span>))<br>unlock(&amp;sched.lock)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20231210231353833.png"alt="runqput() å‡½æ•°æ¦‚è¿°" /><figcaption aria-hidden="true">runqput() å‡½æ•°æ¦‚è¿°</figcaption></figure><h3 id="æ€»ç»“">æ€»ç»“</h3><p>åˆ°è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ€»ç»“ï¼Œ<code>runtimeÂ·newproc</code>çš„æ ¸å¿ƒåŠŸèƒ½å°±æ˜¯åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„goroutineï¼Œå¹¶å°†å…¶æ”¾å…¥é˜Ÿåˆ—ä¸­è¿›è¡Œè°ƒåº¦ã€‚å…¶ä¸­</p><ul><li><code>newproc1()</code> ä¼šæ–°å»ºæˆ–å¤ç”¨ç©ºé—²çš„goroutineï¼Œç„¶ååˆå§‹åŒ–å…¶æ ˆç©ºé—´å’Œè°ƒåº¦ä¿¡æ¯ï¼›</li><li><code>runqput()</code> ä¼šä¼˜å…ˆå°† gæ”¾å…¥æœ¬åœ°é˜Ÿåˆ—ä¸­è°ƒåº¦ï¼Œå¦‚æœæœ¬åœ°é˜Ÿåˆ—æ»¡äº†ï¼Œä¼šè¿å¸¦æœ¬åœ°é˜Ÿåˆ—ä¸­ä¸€åŠçš„ goroutineä¸€èµ·è½¬ç§»åˆ°å…¨å±€é˜Ÿåˆ—ä¸­è°ƒåº¦ã€‚</li></ul><h2 id="runtimemstart">runtimeÂ·mstart</h2><p>è°ƒåº¦å™¨ m0 å’Œä¸»åç¨‹ g0éƒ½åˆå§‹åŒ–å®Œæ¯•äº†ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥å¯åŠ¨è°ƒåº¦å™¨æ¥è°ƒåº¦åç¨‹å·¥ä½œäº†ã€‚</p><p>æˆ‘ä»¬æ‰¾åˆ° <code>mstart()</code> å‡½æ•°çš„å£°æ˜ï¼Œä½äºï¼š<ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/proc.go">proc.go</a></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// mstart is the entry-point for new Ms.</span><br><span class="hljs-comment">// It is written in assembly, uses ABI0, is marked TOPFRAME, and calls mstart0.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">mstart</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œ <code>mstart()</code>æ˜¯æ²¡ç”¨å‡½æ•°ä½“çš„ï¼Œé€šè¿‡æ³¨é‡Šæˆ‘ä»¬å¯ä»¥çŸ¥é“è¿™ä¸ªå‡½æ•°çš„å®ç°éƒ¨åˆ†æ˜¯ç”¨æ±‡ç¼–å®ç°çš„ï¼ŒGoç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘çš„æ—¶å€™å¾€è¿™ä¸ªå‡½æ•°é‡Œé¢æ’å…¥ç›¸å…³æŒ‡ä»¤ã€‚å¦å¤–æ³¨é‡Šä¹Ÿå‘Šè¯‰æˆ‘ä»¬ï¼Œè¿™é‡Œæœ€ç»ˆå…¶å®å°±æ˜¯è°ƒç”¨<code>mstart0()</code> å‡½æ•°ã€‚æˆ‘ä»¬æ‰¾åˆ°ç›¸å…³çš„æ±‡ç¼–ä»£ç ï¼Œæœç„¶æ˜¯å¦‚æ­¤ï¼š</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">TEXT</span> runtimeÂ·mstart(<span class="hljs-built_in">SB</span>),NOSPLIT<span class="hljs-title">|TOPFRAME,$0</span><br><span class="hljs-title">CALLruntimeÂ·mstart0(SB)</span><br><span class="hljs-title">RET // not reached</span><br></code></pre></td></tr></table></figure><p><code>mstart0()</code> å°±åœ¨ <code>mstart()</code> çš„ä¸‹é¢ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">mstart0</span><span class="hljs-params">()</span></span> &#123;<br>gp := getg()<br>osStack := gp.stack.lo == <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> osStack &#123;<br><span class="hljs-comment">// Initialize stack bounds from system stack.</span><br><span class="hljs-comment">// Cgo may have left stack size in stack.hi.</span><br><span class="hljs-comment">// minit may update the stack bounds.</span><br>size := gp.stack.hi<br><span class="hljs-keyword">if</span> size == <span class="hljs-number">0</span> &#123;<br>size = <span class="hljs-number">8192</span> * sys.StackGuardMultiplier<br>&#125;<br>gp.stack.hi = <span class="hljs-type">uintptr</span>(noescape(unsafe.Pointer(&amp;size)))<br>gp.stack.lo = gp.stack.hi - size + <span class="hljs-number">1024</span><br>&#125;<br><span class="hljs-comment">// Initialize stack guard so that we can start calling regular</span><br><span class="hljs-comment">// Go code.</span><br>gp.stackguard0 = gp.stack.lo + stackGuard<br><span class="hljs-comment">// This is the g0, so we can also call go:systemstack</span><br><span class="hljs-comment">// functions, which check stackguard1.</span><br>gp.stackguard1 = gp.stackguard0<br>mstart1()<br><span class="hljs-comment">// Exit this thread.</span><br><span class="hljs-keyword">if</span> mStackIsSystemAllocated() &#123;<br><span class="hljs-comment">// Windows, Solaris, illumos, Darwin, AIX and Plan 9 always system-allocate</span><br><span class="hljs-comment">// the stack, but put it in gp.stack before mstart,</span><br><span class="hljs-comment">// so the logic above hasn&#x27;t set osStack yet.</span><br>osStack = <span class="hljs-literal">true</span><br>&#125;<br>mexit(osStack)<br>&#125;<br></code></pre></td></tr></table></figure><p>ç®€å•è¿‡ä¸€ä¸‹ <code>mstart0()</code> åï¼Œæˆ‘ä»¬ä¼šå‘ç°å…¶å®<code>mstart0()</code> ä¹Ÿä¸æ˜¯å…³é”®ï¼Œå…³é”®æ˜¯ <code>mstart1()</code>ã€‚</p><p>æˆ‘ä»¬å…ˆå¯¹ <code>mstart0()</code> åšä¸€ä¸ªç®€å•çš„æ€»ç»“ï¼šå®ƒæ˜¯ Goè¯­è¨€è¿è¡Œæ—¶ä¸­æ–°Mï¼ˆæ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼‰çš„å…¥å£ç‚¹ã€‚è¿™ä¸ªå‡½æ•°è´Ÿè´£åˆå§‹åŒ–æ–°çº¿ç¨‹çš„æ ˆå’Œä¸€äº›å…¶ä»–è®¾ç½®ï¼Œç„¶åè°ƒç”¨<code>mstart1</code> æ¥ç»§ç»­çº¿ç¨‹çš„åˆå§‹åŒ–è¿‡ç¨‹ã€‚</p><p>æˆ‘ä»¬ç»§ç»­æ¥çœ‹<code>mstart1()</code>ï¼Œå®ƒç”¨äºè¿›ä¸€æ­¥è®¾ç½®æ–°çº¿ç¨‹å¹¶æœ€ç»ˆå°†æ§åˆ¶æƒäº¤ç»™è°ƒåº¦å™¨ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">mstart1</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-comment">// è·å–å½“å‰åç¨‹</span><br>gp := getg()<br>    <span class="hljs-comment">// åªæœ‰ g0 åç¨‹å¯ä»¥æ‰§è¡Œ mstart1()ï¼Œå³å¯åŠ¨ m0ã€‚</span><br>    <span class="hljs-comment">// æ¯ä¸€ä¸ª M éƒ½æœ‰ä¸€ä¸ªç‰¹æ®Šçš„ goroutineï¼Œå…¶è¢«ç§°ä¸º g0ï¼Œå®ƒç”¨äºæ‰§è¡Œç³»ç»Ÿçº§ä»»åŠ¡ã€‚</span><br><span class="hljs-keyword">if</span> gp != gp.m.g0 &#123;<br>throw(<span class="hljs-string">&quot;bad runtimeÂ·mstart&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// è®¾ç½® gp.sched è°ƒåº¦ä¿¡æ¯ï¼Œä»¥ä¾¿ goroutine èƒ½å¤Ÿåœ¨æœªæ¥è¢«æ­£ç¡®è°ƒåº¦ã€‚</span><br>gp.sched.g = guintptr(unsafe.Pointer(gp))<span class="hljs-comment">// goroutine æŒ‡é’ˆ</span><br>gp.sched.pc = getcallerpc()<span class="hljs-comment">// ç¨‹åºè®¡æ•°å™¨</span><br>gp.sched.sp = getcallersp()<span class="hljs-comment">// æ ˆæŒ‡é’ˆ</span><br><br>    <span class="hljs-comment">// åˆå§‹åŒ–äºæ±‡ç¼–ç›¸å…³çš„è®¾ç½®ã€‚</span><br>asminit()<br>    <span class="hljs-comment">// åˆå§‹åŒ–å½“å‰ M çš„çº¿ç¨‹å±€éƒ¨å­˜å‚¨å’Œå…¶ä»–çº¿ç¨‹ç›¸å…³çš„æ•°æ®ã€‚</span><br>minit()<br><br><span class="hljs-comment">// å¦‚æœæ˜¯ m0ï¼Œåˆ™å®‰è£…ä¿¡å·å¤„ç†å™¨</span><br><span class="hljs-keyword">if</span> gp.m == &amp;m0 &#123;<br>mstartm0()<br>&#125;<br><br>    <span class="hljs-comment">// å¦‚æœ M å¯åŠ¨æ—¶é…ç½®äº†å‡½æ•°ï¼Œåˆ™è°ƒç”¨å®ƒ</span><br><span class="hljs-keyword">if</span> fn := gp.m.mstartfn; fn != <span class="hljs-literal">nil</span> &#123;<br>fn()<br>&#125;<br><br>    <span class="hljs-comment">// å¦‚æœå½“å‰ç°åœºä¸æ˜¯ m0ï¼ˆä¸»çº¿ç¨‹ï¼‰ï¼Œåˆ™è·å–ä¸€ä¸ª Pï¼Œå‡†å¤‡å¼€å§‹æ‰§è¡Œ goroutine</span><br><span class="hljs-keyword">if</span> gp.m != &amp;m0 &#123;<br>acquirep(gp.m.nextp.ptr())<br>gp.m.nextp = <span class="hljs-number">0</span><br>&#125;<br>    <span class="hljs-comment">// è°ƒç”¨ schedule() å°†æ§åˆ¶æƒäº¤ç»™è°ƒåº¦å™¨ï¼Œå¼€å§‹æ‰§è¡Œ goroutine</span><br>schedule()<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">mstartm0</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> (iscgo || GOOS == <span class="hljs-string">&quot;windows&quot;</span>) &amp;&amp; !cgoHasExtraM &#123;<br>cgoHasExtraM = <span class="hljs-literal">true</span><br>newextram()<br>&#125;<br>    <span class="hljs-comment">// å®‰è£…ä¿¡å·å¤„ç†å™¨</span><br>initsig(<span class="hljs-literal">false</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>schedule()</code> æ˜¯è°ƒåº¦å™¨çš„å…·ä½“è°ƒåº¦è¿‡ç¨‹ï¼Œè¿™éƒ¨åˆ†ä¼šåœ¨ GMPç¯‡ç« è¿›è¡Œå±•å¼€ï¼ˆTODO ğŸ˜ï¼‰ã€‚</p><p>æ³¨æ„è¿™é‡Œï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// å¦‚æœ M å¯åŠ¨æ—¶é…ç½®äº†å‡½æ•°ï¼Œåˆ™è°ƒç”¨å®ƒ</span><br><span class="hljs-keyword">if</span> fn := gp.m.mstartfn; fn != <span class="hljs-literal">nil</span> &#123;<br>    fn()<br>&#125;<br></code></pre></td></tr></table></figure><p>å‰é¢æˆ‘ä»¬æåˆ° <code>runtimeÂ·newproc</code> çš„æ—¶å€™ï¼Œè·å–å¹¶è®¾ç½®äº†<code>runtime.main</code> çš„å‡½æ•°åœ°å€ï¼š</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-comment">// å– runtimeÂ·mainPC çš„åœ°å€ï¼Œè¿™å…¶å®å°±æ˜¯ runtime åŒ…ä¸‹çš„ main() æ–¹æ³•ã€‚</span><br><span class="hljs-comment">// å®ƒæ˜¯ Go è¯­è¨€ç¨‹åºçš„çœŸæ­£å…¥å£ï¼Œè€Œä¸æ˜¯ main.main()ã€‚</span><br><span class="hljs-symbol">MOVQ</span>$runtimeÂ·mainPC(<span class="hljs-built_in">SB</span>), AX<br><span class="hljs-symbol">PUSHQ</span>AX<br><span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„ goroutine æ¥è¿è¡Œç¨‹åºçš„ä¸»å‡½æ•°ã€‚</span><br><span class="hljs-comment">// è¿™é‡Œè¿˜æ²¡æœ‰æ­£åœ¨çš„è¿è¡Œï¼Œå› ä¸ºè°ƒåº¦å™¨è¿˜æ²¡æœ‰å¯åŠ¨ï¼Œ</span><br><span class="hljs-comment">// åªæ˜¯å°† runtime.main æ”¾è¿› goroutine çš„ queue ä¸­ç­‰å¾…æ‰§è¡Œã€‚</span><br><span class="hljs-symbol">CALL</span>runtimeÂ·newproc(<span class="hljs-built_in">SB</span>)<br><span class="hljs-symbol">POPQ</span>AX<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥è¿™é‡Œå…¶å®å°±æ˜¯è°ƒç”¨<code>runtime.main()</code>ï¼Œåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬ç»ˆäºå¼€å§‹æ‰§è¡Œç¨‹åºçš„ä¸»å‡½æ•°äº†ã€‚</p><h2 id="runtime.main">runtime.main â˜…</h2><p>ç»ˆäºæˆ‘ä»¬åˆ°äº† <code>runtime.main</code> è¿™ä¸ª Go è¯­è¨€ä¸–ç•Œä¸­ â€œçœŸæ­£â€çš„ä¸»å‡½æ•°äº†ï¼Œå®ƒä½äºï¼š<ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/runtime/proc.go">proc.go</a>ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// The main goroutine.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <br>    <span class="hljs-comment">// è·å–å½“å‰çš„ M</span><br>mp := getg().m<br><br>mp.g0.racectx = <span class="hljs-number">0</span><br><br><span class="hljs-comment">// é™åˆ¶æ ˆå¤§å°çš„ä¸Šé™ï¼Œ64 ä½ç³»ç»Ÿä¸º 1Gï¼Œ32 ä½ç³»ç»Ÿä¸º 250M</span><br><span class="hljs-keyword">if</span> goarch.PtrSize == <span class="hljs-number">8</span> &#123;<br>maxstacksize = <span class="hljs-number">1000000000</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br>maxstacksize = <span class="hljs-number">250000000</span><br>&#125;<br><br><span class="hljs-comment">// è¿™é‡Œå°±å°†æ ˆçš„ä¸Šé™æå‡ 2 å€ï¼Œç”¨äºé¿å…åœ¨åˆ†é…è¿‡å¤§çš„æ ˆæ—¶å´©æºƒã€‚</span><br>    <span class="hljs-comment">// æ‰€ä»¥å…¶å® 64 ä½ç³»ç»Ÿæœ€å¤§æ ˆ 2Gï¼Œ32 ä½ç³»ç»Ÿæœ€å¤§æ ˆ 500Mã€‚</span><br>maxstackceiling = <span class="hljs-number">2</span> * maxstacksize<br><br><span class="hljs-comment">// å°† mainStarted ç½®ä¸º trueï¼Œå…è®¸ newproc å¯åŠ¨æ–°çš„ Mã€‚</span><br>mainStarted = <span class="hljs-literal">true</span><br><br>    <span class="hljs-comment">// WebAssemby ä¸Šæš‚æ—¶æ²¡æœ‰çº¿ç¨‹å’Œç³»ç»Ÿç›‘è§†å™¨ï¼Œæ‰€ä»¥è¿™é‡Œè¿‡æ»¤æ‰ã€‚</span><br><span class="hljs-keyword">if</span> GOARCH != <span class="hljs-string">&quot;wasm&quot;</span> &#123; <br>        <span class="hljs-comment">// å…¶ä»–æ¶æ„å°±å¯åŠ¨ç³»ç»Ÿç›‘è§†å™¨ã€‚</span><br>systemstack(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>newm(sysmon, <span class="hljs-literal">nil</span>, <span class="hljs-number">-1</span>)<br>&#125;)<br>&#125;<br><br><span class="hljs-comment">// åœ¨åˆå§‹åŒ–æœŸé—´å°† g0 é”å®šåœ¨ m0 ä¸Šã€‚</span><br>lockOSThread()<br><br>    <span class="hljs-comment">// åªæœ‰ m0 å¯ä»¥è¿è¡Œ runtime.main</span><br><span class="hljs-keyword">if</span> mp != &amp;m0 &#123;<br>throw(<span class="hljs-string">&quot;runtime.main not on m0&quot;</span>)<br>&#125;<br><br>    <span class="hljs-comment">// è®°å½• runtime çš„å¼€å§‹æ—¶é—´ï¼Œéœ€è¦åœ¨ doInit() ä¹‹å‰ï¼Œå› ä¸ºè¿™æ ·æ‰æŠŠ init ä¹Ÿè¿½è¸ªä¸Šã€‚</span><br>runtimeInitTime = nanotime()<br><span class="hljs-keyword">if</span> runtimeInitTime == <span class="hljs-number">0</span> &#123;<br>throw(<span class="hljs-string">&quot;nanotime returning zero&quot;</span>)<br>&#125;<br><br>    <span class="hljs-comment">// åˆå§‹åŒ– trace</span><br><span class="hljs-keyword">if</span> debug.inittrace != <span class="hljs-number">0</span> &#123;<br>inittrace.id = getg().goid<br>inittrace.active = <span class="hljs-literal">true</span><br>&#125;<br><br>    <span class="hljs-comment">// æ‰§è¡Œ runtime çš„ init() æ–¹æ³•</span><br>doInit(runtime_inittasks) <span class="hljs-comment">// Must be before defer.</span><br>    <br><span class="hljs-comment">// defer è§£é”ï¼Œä»¥ä¾¿åœ¨åˆå§‹åŒ–æœŸé—´è°ƒç”¨ runtime.Goexit æ—¶ä¹Ÿèƒ½è§£é”ã€‚</span><br>needUnlock := <span class="hljs-literal">true</span><br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> needUnlock &#123;<br>unlockOSThread()<br>&#125;<br>&#125;()<br><br>    <span class="hljs-comment">// å¯åŠ¨åƒåœ¾å›æ”¶æœŸ</span><br>gcenable()<br><br>    <span class="hljs-comment">// ç›‘å¬åˆå§‹åŒ–å®Œæˆçš„ä¿¡å·</span><br>main_init_done = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>)<br>    <br>    <span class="hljs-comment">// å¦‚æœä½¿ç”¨ cgoï¼Œåˆ™è¿›è¡Œç›¸å…³çš„åˆå§‹åŒ–</span><br><span class="hljs-keyword">if</span> iscgo &#123;<br>...<br>cgocall(_cgo_notify_runtime_init_done, <span class="hljs-literal">nil</span>)<br>&#125;<br><br>    <span class="hljs-comment">// æ‰§è¡Œæ‰€æœ‰æ¨¡å—çš„ init()</span><br><span class="hljs-keyword">for</span> _, m := <span class="hljs-keyword">range</span> activeModules() &#123;<br>doInit(m.inittasks)<br>&#125;<br><br><span class="hljs-comment">// åˆå§‹åŒ–ä»»åŠ¡éƒ½å®Œæˆåï¼Œåˆ™ç¦ç”¨åˆå§‹åŒ– traceã€‚</span><br>inittrace.active = <span class="hljs-literal">false</span><br><br>    <span class="hljs-comment">// å…³é—­åˆå§‹åŒ–å®Œæˆçš„ä¿¡å·é€šé“</span><br><span class="hljs-built_in">close</span>(main_init_done)<br><br>    <span class="hljs-comment">// è§£é” m0 çº¿ç¨‹</span><br>needUnlock = <span class="hljs-literal">false</span><br>unlockOSThread()<br><br>    <span class="hljs-comment">// ä»¥ -buildmode=(c-archive|c-shared) æ–¹å¼è¿›è¡Œæ„å»ºç¨‹åºçš„è¯ï¼Œåˆ™ä¸æ‰§è¡Œ main.main</span><br><span class="hljs-keyword">if</span> isarchive || islibrary &#123;<br><span class="hljs-comment">// A program compiled with -buildmode=c-archive or c-shared</span><br><span class="hljs-comment">// has a main, but it is not executed.</span><br><span class="hljs-keyword">return</span><br>&#125;<br>    <br>    <span class="hljs-comment">// æ‰§è¡Œ main.main() å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è‡ªå·±å†™çš„ main()</span><br>fn := main_main <br>fn()  <span class="hljs-comment">// å¦‚æœæˆ‘ä»¬å¯åŠ¨äº†ä¸€ä¸ª server æœåŠ¡ï¼Œè¿™é‡Œå°±ä¼šè¢«é˜»å¡ä½ï¼Œç›´åˆ°æˆ‘ä»¬çš„ main è¿”å›ã€‚</span><br>    <br>    <span class="hljs-comment">// é™æ€æ£€æµ‹è¾“å‡º</span><br><span class="hljs-keyword">if</span> raceenabled &#123;<br>runExitHooks(<span class="hljs-number">0</span>) <span class="hljs-comment">// run hooks now, since racefini does not return</span><br>racefini()<br>&#125;<br><br><span class="hljs-comment">// å¤„ç†åœ¨ main è¿”å›æ—¶åŒæ—¶å­˜åœ¨çš„å…¶ä»– goroutine çš„ panic</span><br><span class="hljs-keyword">if</span> runningPanicDefers.Load() != <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">for</span> c := <span class="hljs-number">0</span>; c &lt; <span class="hljs-number">1000</span>; c++ &#123;<br>            <span class="hljs-comment">// æ‰§è¡Œ defer</span><br><span class="hljs-keyword">if</span> runningPanicDefers.Load() == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">break</span><br>&#125;<br>Gosched()<br>&#125;<br>&#125;<br>    <span class="hljs-comment">// é˜»å¡ g0 çš„æ‰§è¡Œï¼Œç›´åˆ°æ‰€æœ‰çš„ panic éƒ½å¤„ç†å®Œæ¯•</span><br><span class="hljs-keyword">if</span> panicking.Load() != <span class="hljs-number">0</span> &#123;<br>gopark(<span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, waitReasonPanicWait, traceBlockForever, <span class="hljs-number">1</span>)<br>&#125;<br>    <br>    <span class="hljs-comment">// æ‰§è¡Œ hook é€€å‡ºå‡½æ•°</span><br>runExitHooks(<span class="hljs-number">0</span>)<br>    <span class="hljs-comment">// é€€å‡ºç¨‹åºï¼Œ0 è¡¨ç¤ºæ­£å¸¸é€€å‡º</span><br>exit(<span class="hljs-number">0</span>)<br>    <span class="hljs-comment">// ç†è®ºä¸Š exit(0) åº”è¯¥é€€å‡ºç¨‹åºçš„ï¼Œ</span><br>    <span class="hljs-comment">// å¦‚æœè¿˜æ²¡é€€å‡ºï¼Œä½¿ç”¨ nil æŒ‡é’ˆå¼ºè¡Œèµ‹å€¼ï¼Œå¼•å‘å´©æºƒï¼Œå¼ºè¡Œé€€å‡ºç¨‹åºã€‚</span><br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-keyword">var</span> x *<span class="hljs-type">int32</span><br>*x = <span class="hljs-number">0</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ€»çš„æ¥è¯´ï¼Œ<code>runtime.main()</code> å¹²è¿™ä¹ˆå‡ ä»¶äº‹ï¼š</p><ol type="1"><li>é¦–å…ˆè¿›è¡Œä¸€äº›åŸºæœ¬çš„è®¾ç½®å’Œæ£€æŸ¥ï¼ŒåŒ…æ‹¬è®¾ç½®æ ˆå¤§å°é™åˆ¶å’Œé”å®šä¸» goroutineåˆ°ä¸» OS çº¿ç¨‹ã€‚</li><li>ç„¶åï¼Œå‡½æ•°æ‰§è¡Œä¸€ç³»åˆ—åˆå§‹åŒ–æ“ä½œï¼ŒåŒ…æ‹¬å¯åŠ¨åƒåœ¾å›æ”¶å™¨ã€å¤„ç† CGoäº¤äº’ã€æ‰§è¡ŒåŒ…çš„ init()ã€‚</li><li>åœ¨å®Œæˆæ‰€æœ‰ init() åï¼Œå‡½æ•°è°ƒç”¨ç”¨æˆ·å®šä¹‰çš„ <code>main.main</code>å‡½æ•°ã€‚</li><li>æœ€åï¼Œå‡½æ•°å¤„ç†ç¨‹åºé€€å‡ºï¼ŒåŒ…æ‹¬æ‰§è¡Œ deferã€ç­‰å¾… panicå¤„ç†å®Œæˆï¼Œå¹¶æ­£å¼é€€å‡ºç¨‹åºã€‚</li></ol><p>æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å°±çŸ¥é“äº†ä¸ºä»€ä¹ˆ <code>init()</code> ä¼šåœ¨<code>main.main()</code> ä¹‹å‰è¢«æ‰§è¡Œï¼Œè€Œä¸”å¦‚æœä¸€ä¸ª packageåœ¨æ•´ä¸ªç¨‹åºè·¯å¾„éƒ½æ²¡æœ‰è¢« import çš„æ—¶å€™ï¼Œ<code>init()</code>æ˜¯ä¸ä¼šè¢«æ‰§è¡Œçš„ï¼Œå°±æ˜¯å› ä¸º <code>runtime.main()</code> åªå¤„ç†äº†<code>activeModules()</code> çš„ <code>initTasks()</code>ã€‚</p><div class="note note-info">            <p>åˆ°è¿™é‡Œï¼Œè¿˜æœ‰ä¸ªé—ç•™é—®é¢˜ï¼Œå¼€å‘æ—¶æˆ‘ä»¬éœ€è¦å…³æ³¨çš„ <code>init()</code> å’Œ<code>main.main()</code>å¯ä»¥è®¨è®ºè¿‡äº†ï¼Œé‚£å…¨å±€å˜é‡çš„åˆå§‹åŒ–æ˜¯åœ¨å“ªé‡Œåšçš„å‘¢ï¼Ÿ</p><p>åœ¨ Goè¯­è¨€çš„ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œå…¨å±€å˜é‡çš„åˆå§‹åŒ–ä¸»è¦å‘ç”Ÿåœ¨é“¾æ¥é˜¶æ®µã€‚ç¼–è¯‘å™¨é¦–å…ˆç¼–è¯‘æ¯ä¸ªåŒ…ï¼Œç”Ÿæˆå¯¹è±¡æ–‡ä»¶ã€‚ç„¶ååœ¨é“¾æ¥é˜¶æ®µï¼Œç¼–è¯‘å™¨æˆ–é“¾æ¥å™¨å°†è¿™äº›å¯¹è±¡æ–‡ä»¶åˆå¹¶æˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œç¼–è¯‘å™¨æˆ–é“¾æ¥å™¨è´Ÿè´£ç”Ÿæˆåˆå§‹åŒ–å…¨å±€å˜é‡çš„ä»£ç ï¼Œå¹¶å®‰æ’è¿™äº›ä»£ç åœ¨ç¨‹åºå¯åŠ¨æ—¶æ‰§è¡Œã€‚</p><p>è¿™äº›åˆå§‹åŒ–ä»£ç é€šå¸¸åµŒå…¥åœ¨ç¨‹åºçš„å¯åŠ¨åºåˆ—ä¸­ï¼Œç¡®ä¿åœ¨æ‰§è¡Œä»»ä½•åŒ…çº§<code>init</code> å‡½æ•°æˆ–ç”¨æˆ·å®šä¹‰çš„ <code>main</code>å‡½æ•°ä¹‹å‰ï¼Œæ‰€æœ‰å…¨å±€å˜é‡å·²ç»è¢«åˆå§‹åŒ–ã€‚ç”±äºè¿™äº›æ“ä½œæ˜¯ç¼–è¯‘å™¨åœ¨å†…éƒ¨æ‰§è¡Œçš„ï¼Œå®ƒä»¬ä¸ä¼šç›´æ¥æ˜¾ç¤ºåœ¨æºä»£ç æˆ–è¿è¡Œæ—¶ä»£ç ä¸­ã€‚</p>          </div><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20231210232155964.png"alt="runtime.main å‡½æ•°æ¦‚è¿°" /><figcaption aria-hidden="true">runtime.main å‡½æ•°æ¦‚è¿°</figcaption></figure><hr /><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±åˆ†æå®Œ Goè¯­è¨€ç¨‹åºçš„æ•´ä¸ªå¯åŠ¨è¿‡ç¨‹äº†ã€‚å…·ä½“çš„å¯åŠ¨æµç¨‹æ€»ç»“ï¼Œå¯ä»¥å›åˆ°å¼€å¤´çš„ â€œç»“è®ºå…ˆè¡Œâ€æŸ¥çœ‹ã€‚</p><h2 id="å‚è€ƒ">å‚è€ƒ</h2><ul><li><ahref="https://coding.imooc.com/class/576.html">æ…•è¯¾ç½‘-æ·±å…¥Goåº•å±‚åŸç†</a></li><li>Go1.21.0 å®˜æ–¹æºç </li><li>ChatGPT-4</li></ul>]]></content>
    
    
    <categories>
      
      <category>Go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go1.21.0 ç¨‹åºç¼–è¯‘è¿‡ç¨‹</title>
    <link href="/2023/11/29/go-compilation/"/>
    <url>/2023/11/29/go-compilation/</url>
    
    <content type="html"><![CDATA[<h2 id="ç‰ˆæœ¬è¯´æ˜">ç‰ˆæœ¬è¯´æ˜</h2><ul><li>Go 1.21</li></ul><h2 id="å®˜æ–¹æ–‡æ¡£">å®˜æ–¹æ–‡æ¡£</h2><p>Go è¯­è¨€å®˜æ–¹æ–‡æ¡£è¯¦ç»†é˜è¿°äº† Go è¯­è¨€ç¼–è¯‘å™¨çš„å…·ä½“æ‰§è¡Œè¿‡ç¨‹ï¼ŒGo1.21ç‰ˆæœ¬å¯ä»¥çœ‹è¿™ä¸ªï¼šhttps://github.com/golang/go/tree/release-branch.go1.21/src/cmd/compile</p><p>å¤§è‡´è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol type="1"><li><strong>è§£æ</strong> (<code>cmd/compile/internal/syntax</code>):<ul><li><strong>è¯æ³•åˆ†æå™¨å’Œè¯­æ³•åˆ†æå™¨</strong>ï¼šæºä»£ç è¢«åˆ†è¯ï¼ˆè¯æ³•åˆ†æï¼‰å¹¶è§£æï¼ˆè¯­æ³•åˆ†æï¼‰ã€‚</li><li><strong>è¯­æ³•æ ‘æ„å»º</strong>ï¼šä¸ºæ¯ä¸ªæºæ–‡ä»¶æ„å»ºä¸€ä¸ªè¯­æ³•æ ‘ã€‚</li></ul></li><li><strong>ç±»å‹æ£€æŸ¥</strong>(<code>cmd/compile/internal/types2</code>):<ul><li><strong>ç±»å‹æ£€æŸ¥</strong>ï¼š<code>types2</code> åŒ…æ˜¯<code>go/types</code> çš„ä¸€ä¸ªç§»æ¤ç‰ˆæœ¬ï¼Œå®ƒä½¿ç”¨ <code>syntax</code> åŒ…çš„ASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰è€Œä¸æ˜¯ <code>go/ast</code>ã€‚</li></ul></li><li><strong>IR æ„å»ºï¼ˆ"noding"ï¼‰</strong>:<ul><li><strong>ç¼–è¯‘å™¨ç±»å‹</strong>(<code>cmd/compile/internal/types</code>)</li><li><strong>ç¼–è¯‘å™¨ AST</strong>(<code>cmd/compile/internal/ir</code>)</li><li><strong>AST è½¬æ¢</strong>(<code>cmd/compile/internal/typecheck</code>)</li><li><strong>åˆ›å»ºç¼–è¯‘å™¨ AST</strong>(<code>cmd/compile/internal/noder</code>)</li><li>è¿™ä¸ªé˜¶æ®µä½¿ç”¨è‡ªå·±çš„ AST å®šä¹‰å’Œ Go ç±»å‹çš„è¡¨ç¤ºï¼Œè¿™äº›å®šä¹‰å’Œè¡¨ç¤ºå½¢å¼æ˜¯ç”¨Cç¼–å†™æ—¶é—ç•™ä¸‹æ¥çš„ã€‚å®ƒçš„æ‰€æœ‰ä»£ç éƒ½æ˜¯æ ¹æ®è¿™äº›ç¼–å†™çš„ï¼Œå› æ­¤ç±»å‹æ£€æŸ¥åçš„ä¸‹ä¸€æ­¥æ˜¯è½¬æ¢è¯­æ³•å’Œ<code>types2</code> è¡¨ç¤ºå½¢å¼åˆ° <code>ir</code> å’Œ<code>types</code>ã€‚è¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¸ºâ€œnodingâ€ã€‚</li></ul></li><li><strong>ä¸­é—´é˜¶æ®µ</strong>:<ul><li><strong>æ­»ä»£ç æ¶ˆé™¤</strong>(<code>cmd/compile/internal/deadcode</code>)</li><li><strong>å‡½æ•°è°ƒç”¨å†…è”</strong>(<code>cmd/compile/internal/inline</code>)</li><li><strong>å·²çŸ¥æ¥å£æ–¹æ³•è°ƒç”¨çš„å»è™šæ‹ŸåŒ–</strong>(<code>cmd/compile/internal/devirtualize</code>)</li><li><strong>é€ƒé€¸åˆ†æ</strong>(<code>cmd/compile/internal/escape</code>)</li><li>åœ¨ IRè¡¨ç¤ºä¸Šæ‰§è¡Œå‡ ä¸ªä¼˜åŒ–è¿‡ç¨‹ï¼šæ­»ä»£ç æ¶ˆé™¤ã€ï¼ˆæ—©æœŸçš„ï¼‰å»è™šæ‹ŸåŒ–ã€å‡½æ•°è°ƒç”¨å†…è”å’Œé€ƒé€¸åˆ†æã€‚</li></ul></li><li><strong>Walk</strong> (<code>cmd/compile/internal/walk</code>):<ul><li><strong>æ±‚å€¼é¡ºåºå’Œè¯­æ³•ç³–</strong>ï¼šè¿™æ˜¯å¯¹ IRè¡¨ç¤ºçš„æœ€åä¸€æ¬¡éå†ï¼Œå®ƒæœ‰ä¸¤ä¸ªç›®çš„ï¼šå°†å¤æ‚çš„è¯­å¥åˆ†è§£ä¸ºç®€å•çš„å•ä¸ªè¯­å¥ï¼Œå¼•å…¥ä¸´æ—¶å˜é‡å¹¶éµå®ˆæ±‚å€¼é¡ºåºï¼›å°†é«˜çº§Go æ„é€ è½¬æ¢ä¸ºæ›´åŸå§‹çš„æ„é€ ã€‚</li></ul></li><li><strong>é€šç”¨ SSA</strong> (<code>cmd/compile/internal/ssa</code> å’Œ<code>cmd/compile/internal/ssagen</code>):<ul><li>åœ¨è¿™ä¸ªé˜¶æ®µï¼ŒIRè¢«è½¬æ¢ä¸ºé™æ€å•èµ‹å€¼ï¼ˆSSAï¼‰å½¢å¼ï¼Œè¿™æ˜¯ä¸€ç§å…·æœ‰ç‰¹å®šå±æ€§çš„ä½çº§ä¸­é—´è¡¨ç¤ºï¼Œä½¿å¾—ä»ä¸­å®ç°ä¼˜åŒ–å¹¶æœ€ç»ˆç”Ÿæˆæœºå™¨ä»£ç å˜å¾—æ›´å®¹æ˜“ã€‚</li></ul></li><li><strong>ç”Ÿæˆæœºå™¨ä»£ç </strong> (<code>cmd/compile/internal/ssa</code>å’Œ <code>cmd/internal/obj</code>):<ul><li>è¿™æ˜¯ç¼–è¯‘å™¨çš„æœºå™¨ä¾èµ–é˜¶æ®µï¼Œä»¥â€œlowerâ€è¿‡ç¨‹å¼€å§‹ï¼Œå°†é€šç”¨å€¼é‡å†™ä¸ºå®ƒä»¬çš„æœºå™¨ç‰¹å®šå˜ä½“ã€‚ç„¶åè¿›è¡Œæœ€ç»ˆçš„ä»£ç ä¼˜åŒ–è¿‡ç¨‹ã€‚æœ€åï¼ŒGoå‡½æ•°è¢«è½¬æ¢ä¸ºä¸€ç³»åˆ— <code>obj.Prog</code>æŒ‡ä»¤ï¼Œè¿™äº›æŒ‡ä»¤è¢«æ±‡ç¼–å™¨ï¼ˆ<code>cmd/internal/obj</code>ï¼‰è½¬æ¢ä¸ºæœºå™¨ä»£ç ï¼Œå¹¶å†™å‡ºæœ€ç»ˆçš„ç›®æ ‡æ–‡ä»¶ã€‚</li></ul></li></ol><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img5eRkfKJ8cMojTjPoZzjr1i-20231129143006857.png"alt="Goç¼–è¯‘å™¨æ¦‚è§ˆ" /><figcaption aria-hidden="true">Goç¼–è¯‘å™¨æ¦‚è§ˆ</figcaption></figure><h2 id="ç¼–è¯‘è¿‡ç¨‹">ç¼–è¯‘è¿‡ç¨‹</h2><p>Goç¨‹åºçš„ç¼–è¯‘è¿‡ç¨‹ç¬¦åˆç»å…¸ç¼–è¯‘åŸç†çš„è¿‡ç¨‹æ‹†è§£ï¼Œå³ä¸‰é˜¶æ®µç¼–è¯‘å™¨ï¼Œåˆ†åˆ«ä¸ºç¼–è¯‘å™¨å‰ç«¯ã€ä¸­ç«¯å’Œåç«¯ï¼š</p><ul><li><strong>å‰ç«¯ï¼ˆFront Endï¼‰ï¼š</strong>å‰ç«¯çš„ä»»åŠ¡æ˜¯è¿›è¡Œè¯­æ³•åˆ†æå’Œè¯­ä¹‰åˆ†æã€‚è¿™ä¸€é˜¶æ®µä¼šå°†æºä»£ç è½¬æ¢ä¸ºä¸€ä¸ªä¸­é—´è¡¨ç¤ºã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œç¼–è¯‘å™¨ä¼šæ£€æŸ¥ä»£ç çš„è¯­æ³•å’Œè¯­ä¹‰ï¼Œæ¯”å¦‚è¯­æ³•é”™è¯¯ã€ç±»å‹é”™è¯¯ç­‰ã€‚å‰ç«¯é€šå¸¸æ˜¯ä¾èµ–äºå…·ä½“è¯­è¨€çš„ï¼Œæ¯”å¦‚Go çš„å‰ç«¯å’Œ C++ çš„å‰ç«¯å°±ä¼šæœ‰å¾ˆå¤§çš„ä¸åŒã€‚</li><li><strong>ä¸­é—´ç«¯ï¼ˆMiddle Endï¼‰ï¼š</strong>ä¸­é—´ç«¯çš„ä»»åŠ¡æ˜¯å¯¹ä¸­é—´è¡¨ç¤ºè¿›è¡Œä¼˜åŒ–ã€‚è¿™ä¸€é˜¶æ®µçš„ä¼˜åŒ–æ˜¯è¯­è¨€æ— å…³çš„ï¼Œæ¯”å¦‚å¸¸é‡æŠ˜å ã€æ­»ä»£ç æ¶ˆé™¤ã€å¾ªç¯ä¼˜åŒ–ç­‰ã€‚è¿™äº›ä¼˜åŒ–å¯ä»¥æé«˜ç”Ÿæˆçš„ä»£ç çš„æ€§èƒ½ï¼Œä½†æ˜¯ä¸ä¼šæ”¹å˜ç¨‹åºçš„è¯­ä¹‰ã€‚</li><li><strong>åç«¯ï¼ˆBack Endï¼‰ï¼š</strong>åç«¯çš„ä»»åŠ¡æ˜¯å°†ä¼˜åŒ–åçš„ä¸­é—´è¡¨ç¤ºè½¬æ¢ä¸ºç›®æ ‡æœºå™¨ä»£ç ã€‚è¿™ä¸€é˜¶æ®µä¼šè¿›è¡Œæ›´å¤šçš„ä¼˜åŒ–ï¼Œæ¯”å¦‚å¯„å­˜å™¨åˆ†é…ã€æŒ‡ä»¤é€‰æ‹©ã€æŒ‡ä»¤è°ƒåº¦ç­‰ã€‚åç«¯é€šå¸¸æ˜¯ä¾èµ–äºå…·ä½“æœºå™¨çš„ï¼Œæ¯”å¦‚x86 çš„åç«¯å’Œ ARM çš„åç«¯å°±ä¼šæœ‰å¾ˆå¤§çš„ä¸åŒã€‚</li></ul><p>å‚è€ƒã€ŠGo è¯­è¨€åº•å±‚åŸç†å‰–æï¼ˆéƒ‘å»ºå‹‹ï¼‰ã€‹ä¸€ä¹¦ï¼Œæœ¬æ–‡å°† Goè¯­è¨€ç¼–è¯‘å™¨æ‰§è¡Œæµç¨‹æ‹†åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š</p><ul><li>è¯æ³•è§£æ</li><li>è¯­æ³•è§£æ</li><li>æŠ½è±¡è¯­æ³•æ ‘æ„å»º</li><li>ç±»å‹æ£€æŸ¥</li><li>æ­»ä»£ç æ¶ˆé™¤</li><li>å»è™šæ‹ŸåŒ–</li><li>å‡½æ•°å†…è”</li><li>é€ƒé€¸åˆ†æ</li><li>å˜é‡æ•è·</li><li>é—­åŒ…é‡å†™</li><li>éå†å‡½æ•°</li><li>SSA ç”Ÿæˆ</li><li>æœºå™¨ç ç”Ÿæˆ</li></ul><p>ä¸‹é¢æœ¬æ–‡å°†ä»¥æ­¤ä¹¦ä¸ºå‚è€ƒå¹¶ç»“åˆ Go1.21.0 ç‰ˆæœ¬ï¼Œå¯¹æ¯ä¸ªè¿‡ç¨‹è¿›è¡Œé˜è¿°ã€‚</p><blockquote><p>å¦‚æœåªæƒ³å¯¹ Goç¨‹åºçš„ç¼–è¯‘è¿‡ç¨‹åšä¸€ä¸ªç®€å•çš„äº†è§£ï¼Œé‚£é˜…è¯»åˆ°è¿™é‡Œå°±å·²ç»è¶³å¤Ÿäº†ã€‚</p></blockquote><h2 id="è¯æ³•è§£æ">è¯æ³•è§£æ</h2><p>è¯æ³•è§£æè¿‡ç¨‹ä¸»è¦è´Ÿè´£å°†æºä»£ç ä¸­çš„å­—ç¬¦åºåˆ—è½¬æ¢æˆä¸€ç³»åˆ—çš„æ ‡è®°ï¼ˆtokensï¼‰ï¼Œè¿™äº›æ ‡è®°æ˜¯ç¼–è¯‘å™¨æ›´è¿›ä¸€æ­¥å¤„ç†çš„åŸºæœ¬å•ä½ã€‚åœ¨Go è¯­è¨€çš„ç¼–è¯‘å™¨ä¸­ï¼Œ<code>tokens.go</code>æ–‡ä»¶åŒ…å«äº†ä¸è¯æ³•åˆ†ææœ‰å…³çš„æ ‡è®°å®šä¹‰ã€‚</p><p>è¯æ³•è§£æçš„è¿‡ç¨‹å¯ä»¥åˆ†ä¸ºå‡ ä¸ªå…³é”®æ­¥éª¤ï¼š</p><ol type="1"><li><strong>æ‰«æï¼ˆScanningï¼‰</strong>ï¼šç¼–è¯‘å™¨çš„æ‰«æå™¨ä¼šé€å­—ç¬¦è¯»å–æºä»£ç ï¼Œè¯†åˆ«å‡ºåŸºæœ¬çš„è¯­æ³•å•ä½ï¼Œå¦‚æ ‡è¯†ç¬¦ã€å…³é”®å­—ã€å­—é¢é‡ã€è¿ç®—ç¬¦ç­‰ã€‚</li><li><strong>æ ‡è®°ç”Ÿæˆï¼ˆTokenGenerationï¼‰</strong>ï¼šæ¯å½“æ‰«æå™¨è¯†åˆ«å‡ºä¸€ä¸ªæœ‰æ•ˆçš„è¯­æ³•å•ä½æ—¶ï¼Œå®ƒä¼šç”Ÿæˆä¸€ä¸ªç›¸åº”çš„æ ‡è®°ã€‚ä¾‹å¦‚ï¼Œå¯¹äºä¸€ä¸ªå˜é‡åï¼Œæ‰«æå™¨ä¼šç”Ÿæˆä¸€ä¸ªæ ‡è¯†ç¬¦æ ‡è®°ã€‚</li><li><strong>å»é™¤ç©ºç™½å­—ç¬¦å’Œæ³¨é‡Š</strong>ï¼šåœ¨ç”Ÿæˆæ ‡è®°çš„è¿‡ç¨‹ä¸­ï¼Œæ‰«æå™¨è¿˜ä¼šå¿½ç•¥ç©ºç™½å­—ç¬¦ï¼ˆå¦‚ç©ºæ ¼ã€æ¢è¡Œç¬¦ï¼‰å’Œæ³¨é‡Šï¼Œå› ä¸ºå®ƒä»¬å¯¹ç¨‹åºçš„é€»è¾‘æ²¡æœ‰å½±å“ã€‚</li><li><strong>é”™è¯¯å¤„ç†</strong>ï¼šå¦‚æœæ‰«æå™¨åœ¨æºä»£ç ä¸­é‡åˆ°æ— æ³•è¯†åˆ«çš„å­—ç¬¦æˆ–åºåˆ—ï¼Œå®ƒä¼šç”Ÿæˆä¸€ä¸ªé”™è¯¯æ¶ˆæ¯ã€‚</li></ol><p>æˆ‘ä»¬æ¥çœ‹ä»¥ä¸‹ <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/cmd/compile/internal/syntax/tokens.go">tokens.go</a>æ–‡ä»¶ä¸­çš„ <code>token</code> å®šä¹‰ï¼Œå®ƒä»¬å®è´¨ä¸Šæ˜¯ç”¨ <code>iota</code>å£°æ˜çš„ä¸€ç³»åˆ—æ•´æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">const</span> (<br>_    token = <span class="hljs-literal">iota</span><br>_EOF       <span class="hljs-comment">// EOF</span><br><br><span class="hljs-comment">// names and literals</span><br>_Name    <span class="hljs-comment">// name</span><br>_Literal <span class="hljs-comment">// literal</span><br><br><span class="hljs-comment">// operators and operations</span><br><span class="hljs-comment">// _Operator is excluding &#x27;*&#x27; (_Star)</span><br>_IncOp    <span class="hljs-comment">// opop</span><br>    _Define   <span class="hljs-comment">// :=</span><br>    ...<br><br><span class="hljs-comment">// delimiters</span><br>_Lparen    <span class="hljs-comment">// (</span><br>_Rparen    <span class="hljs-comment">// )</span><br>...<br><br><span class="hljs-comment">// keywords</span><br>_Break       <span class="hljs-comment">// break</span><br>...<br><br><span class="hljs-comment">// empty line comment to exclude it from .String</span><br>tokenCount <span class="hljs-comment">//</span><br>)<br></code></pre></td></tr></table></figure><p>ä¸¾ä¸ªä¾‹å­ï¼Œ<code>a := b + c(12)</code>è¿™ä¸ªè¡¨è¾¾å¼ï¼Œè¢«è§£æåï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20231202200135678.png"alt="Go è¯­è¨€ç¼–è¯‘å™¨è¯æ³•è§£æç¤ºä¾‹å›¾" /><figcaption aria-hidden="true">Go è¯­è¨€ç¼–è¯‘å™¨è¯æ³•è§£æç¤ºä¾‹å›¾</figcaption></figure><h2 id="è¯­æ³•è§£æ">è¯­æ³•è§£æ</h2><p>è¯­æ³•è§£æå‘ç”Ÿåœ¨è¯æ³•è§£æä¹‹åï¼Œå…¶ä¸»è¦ç›®çš„æ˜¯åˆ†ææºä»£ç ä¸­æ ‡è®°ï¼ˆtokensï¼‰çš„æ’åˆ—å’Œç»“æ„ï¼Œä»¥ç¡®å®šå®ƒä»¬æ˜¯å¦å½¢æˆäº†æœ‰æ•ˆçš„è¯­å¥ã€‚æ ¸å¿ƒç®—æ³•ä½äºä¸¤ä¸ªæ–‡ä»¶ä¸­ï¼š</p><ul><li><ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/cmd/compile/internal/syntax/nodes.go">syntax/nodes.go</a>ï¼šå®šä¹‰äº†è¯­æ³•èŠ‚ç‚¹ï¼ˆSyntaxNodesï¼‰ï¼Œè¿™äº›èŠ‚ç‚¹æ˜¯æ„æˆæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰çš„åŸºæœ¬å…ƒç´ ã€‚æ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨äº† Goè¯­æ³•ä¸­çš„ä¸€ä¸ªæ„é€ ï¼Œæ¯”å¦‚å˜é‡å£°æ˜ã€å‡½æ•°è°ƒç”¨ã€è¡¨è¾¾å¼ç­‰ã€‚é€šè¿‡è¿™äº›èŠ‚ç‚¹ï¼Œç¼–è¯‘å™¨èƒ½å¤Ÿç†è§£å’Œè¡¨ç¤ºç¨‹åºä»£ç çš„ç»“æ„ã€‚</li><li><ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/cmd/compile/internal/syntax/parser.go">syntax/parser.go</a>ï¼šåŒ…å«äº†è§£æå™¨çš„å®ç°ã€‚è§£æå™¨è´Ÿè´£è¯»å–è¯æ³•åˆ†æé˜¶æ®µç”Ÿæˆçš„æ ‡è®°æµï¼Œå¹¶æ ¹æ®è¿™äº›æ ‡è®°æ„å»ºASTã€‚å®ƒéµå¾ª Goè¯­è¨€çš„è¯­æ³•è§„åˆ™ï¼Œç¡®ä¿ä»£ç ç¬¦åˆè¯­æ³•ç»“æ„ï¼Œå¹¶åœ¨é‡åˆ°è¯­æ³•é”™è¯¯æ—¶æä¾›ç›¸åº”çš„åé¦ˆã€‚</li></ul><p>Go è¯­è¨€é‡‡ç”¨äº†æ ‡å‡†çš„è‡ªä¸Šè€Œä¸‹çš„é€’å½’ä¸‹é™ï¼ˆTop-DownRecursive-Descentï¼‰ç®—æ³•ï¼Œä»¥ç®€å•é«˜æ•ˆçš„æ–¹å¼å®Œæˆæ— é¡»å›æº¯çš„è¯­æ³•æ‰«æã€‚</p><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹ <code>nodes.go</code>æ–‡ä»¶ä¸­å¯¹å„ä¸ªèŠ‚ç‚¹çš„å£°æ˜ï¼ˆä»¥ä¸‹éƒ½çœç•¥äº† struct ä¸­çš„å…·ä½“å±æ€§ï¼‰ï¼š</p><h3 id="å£°æ˜-declarations">å£°æ˜ Declarations</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> (<br>Decl <span class="hljs-keyword">interface</span> &#123;<br>Node<br>aDecl()<br>&#125;<br>ImportDecl <span class="hljs-keyword">struct</span> &#123;&#125;   <span class="hljs-comment">// å¯¼å…¥å£°æ˜</span><br>ConstDecl <span class="hljs-keyword">struct</span> &#123;&#125;   <span class="hljs-comment">// å¸¸é‡å£°æ˜</span><br>TypeDecl <span class="hljs-keyword">struct</span> &#123;&#125;   <span class="hljs-comment">// ç±»å‹å£°æ˜</span><br>VarDecl <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// å˜é‡å£°æ˜</span><br>FuncDecl <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// å‡½æ•°å£°æ˜</span><br>)<br></code></pre></td></tr></table></figure><h3 id="è¡¨è¾¾å¼-expressions">è¡¨è¾¾å¼ Expressions</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> (<br>Expr <span class="hljs-keyword">interface</span> &#123;<br>Node<br>typeInfo<br>aExpr()<br>&#125;<br><span class="hljs-comment">// çœç•¥äº†ç»“æ„ä½“å±æ€§</span><br>BadExpr <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// æ— æ•ˆè¡¨è¾¾å¼</span><br>Name <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// Value</span><br>BasicLit <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// Value</span><br>CompositeLit <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// Type &#123; ElemList[0], ElemList[1], ... &#125;</span><br>    KeyValueExpr <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// Key: Value</span><br>FuncLit <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// func Type &#123; Body &#125;</span><br>ParenExpr <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// (X)</span><br>SelectorExpr <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// X.Sel</span><br>IndexExpr <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// X[Index]</span><br>SliceExpr <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// X[Index[0] : Index[1] : Index[2]]</span><br>AssertExpr <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// X.(Type)</span><br>TypeSwitchGuard <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// Lhs := X.(type)</span><br>Operation <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// æ“ä½œ +-*\</span><br>CallExpr <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// Fun(ArgList[0], ArgList[1], ...)</span><br>ListExpr <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// ElemList[0], ElemList[1], ...</span><br>ArrayType <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// [Len]Elem</span><br>SliceType <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// []Elem</span><br>DotsType <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// ...Elem</span><br>StructType <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// struct &#123; FieldList[0] TagList[0]; FieldList[1] TagList[1]; ... &#125;</span><br>Field <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// Name Type</span><br>InterfaceType <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// interface &#123; MethodList[0]; MethodList[1]; ... &#125;</span><br>    FuncType <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// type FuncName func (param1, param2) return1, return2</span><br>MapType <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// map[Key]Value</span><br>ChanType <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// chan Elem, &lt;-chan Elem, chan&lt;- Elem</span><br>)<br></code></pre></td></tr></table></figure><h3 id="è¯­å¥-statements">è¯­å¥ Statements</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> (<br>    <span class="hljs-comment">// æ‰€æœ‰è¯­å¥çš„é€šç”¨æ¥å£</span><br>    Stmt <span class="hljs-keyword">interface</span> &#123;<br>       Node<br>       aStmt()<br>    &#125;<br><span class="hljs-comment">// æ›´åŠ ç®€å•è¯­å¥çš„é€šç”¨æ¥å£</span><br>    SimpleStmt <span class="hljs-keyword">interface</span> &#123;&#125;<br><br>    EmptyStmt <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// ç©ºè¯­å¥</span><br>    LabeledStmt <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// æ ‡ç­¾è¯­å¥</span><br>    BlockStmt <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// ä»£ç å—è¯­å¥</span><br>    ExprStmt <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// è¡¨è¾¾å¼è¯­å¥</span><br>    SendStmt <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// å‘é€è¯­å¥ï¼Œç”¨äº channel</span><br>    DeclStmt <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// å£°æ˜è¯­å¥</span><br>    AssignStmt <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// èµ‹å€¼è¯­å¥</span><br>    BranchStmt <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// åˆ†æ”¯è¯­å¥ï¼Œbreak, continue</span><br>    CallStmt <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// è°ƒç”¨è¯­å¥</span><br>    ReturnStmt <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// è¿”å›è¯­å¥</span><br>    IfStmt <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// if æ¡ä»¶è¯­å¥</span><br>    ForStmt <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// for å¾ªç¯è¯­å¥</span><br>    SwitchStmt <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// switch è¯­å¥</span><br>    SelectStmt <span class="hljs-keyword">struct</span> &#123;&#125;<span class="hljs-comment">// select è¯­å¥</span><br>)<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥é‡ç‚¹æ¥çœ‹ä¸€ä¸‹æœ€å¸¸ç”¨çš„èµ‹å€¼è¯­å¥ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> AssignStmt <span class="hljs-keyword">struct</span> &#123;<br>    Op       Operator <span class="hljs-comment">// æ“ä½œç¬¦ 0 means no operation</span><br>    Lhs, Rhs Expr     <span class="hljs-comment">// å·¦å³ä¸¤ä¸ªè¡¨è¾¾å¼ Rhs == nil means Lhs++ (Op == Add) or Lhs-- (Op == Sub)</span><br>    simpleStmt<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ä¸¾ä¾‹">ä¸¾ä¾‹</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-keyword">const</span> name = <span class="hljs-string">&quot;hedon&quot;</span><br><span class="hljs-keyword">type</span> String <span class="hljs-type">string</span><br><span class="hljs-keyword">var</span> s String = <span class="hljs-string">&quot;hello &quot;</span> + word<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(s)<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„æºä»£ç ä¼šè¢«è§£ææˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20231202195439495.png"alt="Go ç¼–è¯‘å™¨è¯­æ³•è§£æç¤ºä¾‹å›¾" /><figcaption aria-hidden="true">Go ç¼–è¯‘å™¨è¯­æ³•è§£æç¤ºä¾‹å›¾</figcaption></figure><p>å†æ¥çœ‹ä¸€ä¸ªèµ‹å€¼è¯­å¥æ˜¯å¦‚ä½•è§£æçš„ï¼Œå°±ä»¥ä¹‹å‰çš„<code>a := b + c(12)</code> ä¸ºä¾‹ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20231203003155036.png"alt="ç‰¹å®šèµ‹å€¼è¯­å¥çš„è¯­æ³•è§£æç¤ºä¾‹" /><figcaption aria-hidden="true">ç‰¹å®šèµ‹å€¼è¯­å¥çš„è¯­æ³•è§£æç¤ºä¾‹</figcaption></figure><h2 id="æŠ½è±¡è¯­æ³•æ ‘æ„å»º">æŠ½è±¡è¯­æ³•æ ‘æ„å»º</h2><p>ç¼–è¯‘å™¨å‰ç«¯å¿…é¡»æ„å»ºç¨‹åºçš„ä¸­é—´è¡¨ç¤ºå½¢å¼ï¼Œä»¥ä¾¿åœ¨ç¼–è¯‘å™¨ä¸­ç«¯åŠåç«¯ä½¿ç”¨ï¼ŒæŠ½è±¡è¯­æ³•æ ‘ï¼ˆAbstractSyntax Treeï¼ŒASTï¼‰æ˜¯ä¸€ç§å¸¸è§çš„æ ‘çŠ¶ç»“æ„çš„ä¸­é—´æ€ã€‚</p><h3 id="æŠ½è±¡è¯­æ³•æ ‘">æŠ½è±¡è¯­æ³•æ ‘</h3><p>æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼ŒAbstract SyntaxTreeï¼‰æ˜¯æºä»£ç çš„æ ‘çŠ¶ç»“æ„è¡¨ç¤ºï¼Œå®ƒç”¨äºè¡¨ç¤ºç¼–ç¨‹è¯­è¨€çš„è¯­æ³•ç»“æ„ï¼Œä½†ä¸åŒ…æ‹¬æ‰€æœ‰è¯­æ³•ç»†èŠ‚ã€‚ASTæ˜¯ç¼–è¯‘å™¨è®¾è®¡ä¸­çš„å…³é”®æ¦‚å¿µï¼Œå¹¿æ³›åº”ç”¨äºç¼–è¯‘å™¨çš„å„ä¸ªé˜¶æ®µã€‚</p><p>åŸºæœ¬æ¦‚å¿µï¼š</p><ul><li>ç»“æ„ï¼šASTæ˜¯ä¸€ç§æ ‘å½¢ç»“æ„ï¼Œå…¶ä¸­æ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨ç¨‹åºä¸­çš„ä¸€ç§æ„é€ ï¼ˆå¦‚è¡¨è¾¾å¼ã€è¯­å¥ç­‰ï¼‰ã€‚</li><li>æŠ½è±¡æ€§ï¼šå®ƒæŠ½è±¡å‡ºäº†ä»£ç çš„è¯­æ³•ç»“æ„ï¼Œçœç•¥äº†æŸäº›è¯­æ³•ç»†èŠ‚ï¼ˆå¦‚æ‹¬å·ã€ç‰¹å®šçš„è¯­æ³•æ ¼å¼ç­‰ï¼‰ã€‚</li></ul><p>èŠ‚ç‚¹ç±»å‹ï¼š</p><ul><li>æ ¹èŠ‚ç‚¹ï¼šä»£è¡¨æ•´ä¸ªç¨‹åºæˆ–ä¸€æ®µå®Œæ•´ä»£ç ã€‚</li><li>å†…éƒ¨èŠ‚ç‚¹ï¼šé€šå¸¸ä»£è¡¨æ§åˆ¶ç»“æ„ï¼ˆå¦‚å¾ªç¯ã€æ¡ä»¶è¯­å¥ï¼‰å’Œæ“ä½œç¬¦ï¼ˆå¦‚åŠ ã€å‡ã€ä¹˜ã€é™¤ï¼‰ã€‚</li><li>å¶èŠ‚ç‚¹ï¼šä»£è¡¨ç¨‹åºä¸­çš„åŸºæœ¬å…ƒç´ ï¼Œå¦‚å¸¸é‡ã€å˜é‡å’Œæ ‡è¯†ç¬¦ã€‚</li></ul><p>æ„å»ºè¿‡ç¨‹ï¼š</p><ul><li>è¯æ³•åˆ†æï¼šæºä»£ç é¦–å…ˆç»è¿‡è¯æ³•åˆ†æï¼Œåˆ†è§£ä¸ºä¸€ç³»åˆ—æ ‡è®°ï¼ˆtokensï¼‰ã€‚</li><li>è¯­æ³•åˆ†æï¼šç„¶åï¼ŒåŸºäºè¿™äº›æ ‡è®°ï¼Œè¯­æ³•åˆ†æå™¨æ ¹æ®ç¼–ç¨‹è¯­è¨€çš„è¯­æ³•è§„åˆ™æ„å»ºASTã€‚</li><li>æ ‘çš„æ„å»ºï¼šåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œåˆ†æå™¨ä¼šæ ¹æ®è¯­è¨€çš„è¯­æ³•åˆ›å»ºä¸åŒç±»å‹çš„èŠ‚ç‚¹ï¼Œå¹¶æŒ‰ç…§ç¨‹åºçš„ç»“æ„å°†å®ƒä»¬ç»„ç»‡æˆæ ‘ã€‚</li></ul><p>ä½¿ç”¨åœºæ™¯ï¼š</p><ul><li>è¯­ä¹‰åˆ†æï¼šç¼–è¯‘å™¨ä½¿ç”¨ AST æ¥è¿›è¡Œç±»å‹æ£€æŸ¥å’Œå…¶ä»–è¯­ä¹‰åˆ†æã€‚</li><li>ä»£ç ä¼˜åŒ–ï¼šåœ¨ä¼˜åŒ–é˜¶æ®µï¼Œç¼–è¯‘å™¨ä¼šå¯¹ ASTè¿›è¡Œå˜æ¢ï¼Œä»¥æé«˜ä»£ç çš„æ‰§è¡Œæ•ˆç‡ã€‚</li><li>ä»£ç ç”Ÿæˆï¼šç¼–è¯‘å™¨æ ¹æ® AST ç”Ÿæˆä¸­é—´ä»£ç æˆ–ç›®æ ‡ä»£ç ã€‚</li></ul><p>ä¼˜ç‚¹ï¼š</p><ul><li>ç®€åŒ–å¤„ç†ï¼šç”±äºçœç•¥äº†ä¸å¿…è¦çš„è¯­æ³•ç»†èŠ‚ï¼ŒASTä½¿å¾—ç¼–è¯‘å™¨çš„è®¾è®¡æ›´ä¸ºç®€æ´å’Œé«˜æ•ˆã€‚</li><li>çµæ´»æ€§ï¼šAST å¯ä»¥è½»æ¾åœ°è¿›è¡Œä¿®æ”¹å’Œæ‰©å±•ï¼Œä¾¿äºå®ç°å„ç§ç¼–è¯‘å™¨åŠŸèƒ½ã€‚</li><li>å¯è§†åŒ–ï¼šASTçš„æ ‘å½¢ç»“æ„ä½¿å¾—ä»£ç çš„é€»è¾‘ç»“æ„ä¸€ç›®äº†ç„¶ï¼Œæœ‰åŠ©äºç†è§£å’Œè°ƒè¯•ã€‚</li></ul><h3 id="go-æ„å»ºæŠ½è±¡è¯­æ³•æ ‘">Go æ„å»ºæŠ½è±¡è¯­æ³•æ ‘</h3><p>åœ¨ Go è¯­è¨€æºæ–‡ä»¶ä¸­çš„ä»»ä½•ä¸€ç§ Declarations éƒ½æ˜¯ä¸€ä¸ªæ ¹èŠ‚ç‚¹ï¼Œå¦‚ä¸‹<code>pkgInit(decls)</code>å‡½æ•°å°†æºæ–‡ä»¶ä¸­çš„æ‰€æœ‰å£°æ˜è¯­å¥éƒ½è½¬æ¢ä¸ºèŠ‚ç‚¹ï¼ˆNodeï¼‰ï¼Œä»£ç ä½äºï¼š<ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/cmd/compile/internal/syntax/syntax.go">syntax/syntax.go</a>å’Œ <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/cmd/compile/internal/syntax/parser.go">syntax/parser.go</a>ä¸­ã€‚</p><h4 id="parse">Parse()</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Parse</span><span class="hljs-params">(base *PosBase, src io.Reader, errh ErrorHandler, pragh PragmaHandler, mode Mode)</span></span> (_ *File, first <span class="hljs-type">error</span>) &#123;<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> p := <span class="hljs-built_in">recover</span>(); p != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">if</span> err, ok := p.(Error); ok &#123;<br>first = err<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-built_in">panic</span>(p)<br>&#125;<br>&#125;()<br><br><span class="hljs-keyword">var</span> p parser<br>p.init(base, src, errh, pragh, mode)<br>p.next()<br><span class="hljs-keyword">return</span> p.fileOrNil(), p.first<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯å¯¹ <code>Parse()</code> å‡½æ•°çš„ä¸€ä¸ªç®€å•è§£é‡Šï¼š</p><ul><li>ä½œç”¨ï¼šè§£æå•ä¸ª Go æºæ–‡ä»¶å¹¶è¿”å›ç›¸åº”çš„è¯­æ³•æ ‘ã€‚</li><li>å‚æ•°<ul><li><code>base</code>: ä½ç½®åŸºç¡€ä¿¡æ¯ã€‚</li><li><code>src</code>: è¦è§£æçš„æºæ–‡ä»¶ã€‚</li><li><code>errh</code>: é”™è¯¯å¤„ç†å‡½æ•°ã€‚</li><li><code>pragh</code>: ç”¨äºå¤„ç†æ¯ä¸ªé‡åˆ°çš„ç¼–è¯‘æŒ‡ä»¤ï¼ˆpragmaï¼‰ã€‚</li><li><code>mode</code>: è§£ææ¨¡å¼ã€‚</li></ul></li><li>è¿”å›å€¼ï¼šè¿”å›ä¸€ä¸ª <code>File</code> ç±»å‹çš„æŒ‡é’ˆï¼Œè¡¨ç¤ºè§£æåçš„ASTï¼Œä»¥åŠå¯èƒ½çš„é”™è¯¯ã€‚</li><li>é”™è¯¯å¤„ç†<ul><li>å¦‚æœ <code>errh</code>ä¸ä¸ºç©ºï¼šå°†ä¼šè°ƒç”¨å®ƒå¤„ç†æ¯ä¸ªé‡åˆ°çš„é”™è¯¯ï¼Œè§£æå™¨å°½å¯èƒ½å¤šåœ°å¤„ç†æºæ–‡ä»¶ã€‚æ­¤æ—¶ï¼Œåªæœ‰åœ¨æ²¡æœ‰æ‰¾åˆ°æ­£ç¡®çš„åŒ…å£°æ˜æ—¶ï¼Œè¿”å›çš„è¯­æ³•æ ‘æ‰ä¸º<code>nil</code>ã€‚</li><li>å¦‚æœ <code>errh</code>ä¸ºç©ºï¼šè§£æå™¨åœ¨é‡åˆ°ç¬¬ä¸€ä¸ªé”™è¯¯æ—¶ç«‹å³ç»ˆæ­¢ï¼Œè¿”å›çš„è¯­æ³•æ ‘ä¸º<code>nil</code>ã€‚</li></ul></li></ul><p>å…¶ä¸­ <code>File</code> ç±»å‹ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> File <span class="hljs-keyword">struct</span> &#123;<br>Pragma    Pragma <span class="hljs-comment">// ç¼–è¯‘æŒ‡ä»¤</span><br>PkgName   *Name  <span class="hljs-comment">// åŒ…å</span><br>DeclList  []Decl <span class="hljs-comment">// æºæ–‡ä»¶ä¸­çš„å„ç§å£°æ˜</span><br>EOF       Pos <span class="hljs-comment">// è§£æä½ç½®</span><br>GoVersion <span class="hljs-type">string</span> <span class="hljs-comment">// go ç‰ˆæœ¬</span><br>node<span class="hljs-comment">// è¯¥æºæ–‡ä»¶çš„ AST æ ¹èŠ‚ç‚¹</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="parser.fileornil">parser.fileOrNil()</h4><p>å…·ä½“çš„è§£æè¿‡ç¨‹åœ¨ <code>parser.fileOrNil()</code> æ–¹æ³•ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *parser)</span></span> fileOrNil() *File &#123;<br><span class="hljs-keyword">if</span> trace &#123;<br><span class="hljs-keyword">defer</span> p.trace(<span class="hljs-string">&quot;file&quot;</span>)()<br>&#125;<br><br>    <span class="hljs-comment">// 1. åˆå§‹åŒ–æ–‡ä»¶èŠ‚ç‚¹</span><br>f := <span class="hljs-built_in">new</span>(File)<br>f.pos = p.pos()<br><br><span class="hljs-comment">// 2. è§£æåŒ…å£°æ˜</span><br>f.GoVersion = p.goVersion<br>p.top = <span class="hljs-literal">false</span><br><span class="hljs-keyword">if</span> !p.got(_Package) &#123;<span class="hljs-comment">// åŒ…å£°æ˜å¿…é¡»æ”¾åœ¨ç¬¬ä¸€ä½ï¼Œè¿™è·Ÿæˆ‘ä»¬å­¦ Go è¯­æ³•å¯¹åº”ä¸Šäº†</span><br>p.syntaxError(<span class="hljs-string">&quot;package statement must be first&quot;</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br>f.Pragma = p.takePragma() <span class="hljs-comment">// è·å–ç¼–è¯‘æŒ‡ä»¤</span><br>f.PkgName = p.name()<span class="hljs-comment">// è·å–åŒ…å</span><br>    p.want(_Semi) <span class="hljs-comment">// _Semi åœ¨ä¹‹å‰çš„ tokens.go ä¸­å¯ä»¥å‘ç°æ˜¯åˆ†å·ï¼ˆ;)ï¼Œæ˜¯çš„ï¼ŒåŒ…å£°æ˜åé¢å°±æ˜¯å¾—å¸¦åˆ†å·</span><br><br><span class="hljs-comment">// 3. å¤„ç†åŒ…å£°æ˜é”™è¯¯</span><br><span class="hljs-keyword">if</span> p.first != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// 4. å¾ªç¯è§£æé¡¶å±‚å£°æ˜</span><br>    <span class="hljs-comment">// å¾ªç¯å¤„ç†æ–‡ä»¶ä¸­çš„æ‰€æœ‰å£°æ˜ï¼ŒåŒ…æ‹¬ importã€constã€typeã€var å’Œ func</span><br>    <span class="hljs-comment">// å¯¹æ¯ç§ç±»å‹çš„å£°æ˜ï¼Œè°ƒç”¨å…¶è§£æå‡½æ•°ï¼Œå¦‚ importDeclã€constDecl è¿›è¡Œè§£æ</span><br>prev := _Import<br><span class="hljs-keyword">for</span> p.tok != _EOF &#123;<br><span class="hljs-keyword">if</span> p.tok == _Import &amp;&amp; prev != _Import &#123;<br>p.syntaxError(<span class="hljs-string">&quot;imports must appear before other declarations&quot;</span>)<br>&#125;<br>prev = p.tok<br><br><span class="hljs-keyword">switch</span> p.tok &#123;<br><span class="hljs-keyword">case</span> _Import:<br>p.next()<br>f.DeclList = p.appendGroup(f.DeclList, p.importDecl)<br><br><span class="hljs-keyword">case</span> _Const:<br>p.next()<br>f.DeclList = p.appendGroup(f.DeclList, p.constDecl)<br><br><span class="hljs-keyword">case</span> _Type:<br>p.next()<br>f.DeclList = p.appendGroup(f.DeclList, p.typeDecl)<br><br><span class="hljs-keyword">case</span> _Var:<br>p.next()<br>f.DeclList = p.appendGroup(f.DeclList, p.varDecl)<br><br><span class="hljs-keyword">case</span> _Func:<br>p.next()<br><span class="hljs-keyword">if</span> d := p.funcDeclOrNil(); d != <span class="hljs-literal">nil</span> &#123;<br>f.DeclList = <span class="hljs-built_in">append</span>(f.DeclList, d)<br>&#125;<br><br><span class="hljs-keyword">default</span>:<br>             <span class="hljs-comment">// 5. å¤„ç†å¼‚å¸¸å’Œé”™è¯¯</span><br><span class="hljs-keyword">if</span> p.tok == _Lbrace &amp;&amp; <span class="hljs-built_in">len</span>(f.DeclList) &gt; <span class="hljs-number">0</span> &amp;&amp; isEmptyFuncDecl(f.DeclList[<span class="hljs-built_in">len</span>(f.DeclList)<span class="hljs-number">-1</span>]) &#123;<br>p.syntaxError(<span class="hljs-string">&quot;unexpected semicolon or newline before &#123;&quot;</span>)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>p.syntaxError(<span class="hljs-string">&quot;non-declaration statement outside function body&quot;</span>)<br>&#125;<br>p.advance(_Import, _Const, _Type, _Var, _Func)<br><span class="hljs-keyword">continue</span><br>&#125;<br><br><span class="hljs-comment">// Reset p.pragma BEFORE advancing to the next token (consuming &#x27;;&#x27;)</span><br><span class="hljs-comment">// since comments before may set pragmas for the next function decl.</span><br>p.clearPragma()<br><br><span class="hljs-keyword">if</span> p.tok != _EOF &amp;&amp; !p.got(_Semi) &#123;<br>p.syntaxError(<span class="hljs-string">&quot;after top level declaration&quot;</span>)<br>p.advance(_Import, _Const, _Type, _Var, _Func)<br>&#125;<br>&#125;<br><br>    <span class="hljs-comment">// 6. å®Œæˆè§£æï¼Œè®°å½•æ–‡ä»¶ç»“æŸçš„ä½ç½®</span><br>p.clearPragma()<br>f.EOF = p.pos()<br><br><span class="hljs-keyword">return</span> f<br>&#125;<br></code></pre></td></tr></table></figure><p>æ€»ç»“ <code>parser.fileOrNil()</code> æ–¹æ³•çš„å¤„ç†è¿‡ç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p><ol type="1"><li><strong>åˆå§‹åŒ–æ–‡ä»¶èŠ‚ç‚¹</strong>ï¼š<ul><li><code>f := new(File)</code>: åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>File</code>èŠ‚ç‚¹ã€‚</li><li><code>f.pos = p.pos()</code>: è®¾ç½®èŠ‚ç‚¹çš„ä½ç½®ä¿¡æ¯ã€‚</li></ul></li><li><strong>è§£æåŒ…å£°æ˜ï¼ˆPackage Clauseï¼‰</strong>ï¼š<ul><li><code>f.GoVersion = p.goVersion</code>: è®°å½• Go ç‰ˆæœ¬ã€‚</li><li><code>p.top = false</code>: è®¾ç½®çŠ¶æ€ï¼Œè¡¨ç¤ºä¸å†å¤„äºæ–‡ä»¶é¡¶å±‚ã€‚</li><li><code>if !p.got(_Package) &#123;...&#125;</code>:æ£€æŸ¥æ˜¯å¦å­˜åœ¨åŒ…å£°æ˜ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™æŠ¥é”™å¹¶è¿”å› <code>nil</code>ã€‚</li><li><code>f.Pragma = p.takePragma()</code>:è·å–ä¸åŒ…å£°æ˜ç›¸å…³çš„ç¼–è¯‘æŒ‡ä»¤ã€‚</li><li><code>f.PkgName = p.name()</code>: è·å–åŒ…åã€‚</li><li><code>p.want(_Semi)</code>: ç¡®è®¤åŒ…å£°æ˜åæœ‰åˆ†å·ã€‚</li></ul></li><li><strong>å¤„ç†åŒ…å£°æ˜é”™è¯¯</strong>ï¼š<ul><li><code>if p.first != nil &#123;...&#125;</code>: å¦‚æœå·²æœ‰é”™è¯¯ï¼Œåœæ­¢è§£æå¹¶è¿”å›<code>nil</code>ã€‚</li></ul></li><li><strong>è§£æé¡¶å±‚å£°æ˜</strong>ï¼š<ul><li>é€šè¿‡ä¸€ä¸ªå¾ªç¯å¤„ç†æ–‡ä»¶ä¸­çš„æ‰€æœ‰å£°æ˜ï¼ŒåŒ…æ‹¬å¯¼å…¥ï¼ˆimportï¼‰ã€å¸¸é‡ï¼ˆconstï¼‰ã€ç±»å‹ï¼ˆtypeï¼‰ã€å˜é‡ï¼ˆvarï¼‰å’Œå‡½æ•°ï¼ˆfuncï¼‰ã€‚</li><li>å¯¹æ¯ç§ç±»å‹çš„å£°æ˜ï¼Œè°ƒç”¨ç›¸åº”çš„è§£æå‡½æ•°ï¼ˆå¦‚<code>p.importDecl</code>ã€<code>p.constDecl</code> ç­‰ï¼‰ã€‚</li><li>å°†è§£æå¾—åˆ°çš„å£°æ˜æ·»åŠ åˆ° <code>f.DeclList</code> ä¸­ã€‚</li></ul></li><li><strong>å¤„ç†å¼‚å¸¸å’Œé”™è¯¯</strong>ï¼š<ul><li>åœ¨è§£æè¿‡ç¨‹ä¸­é‡åˆ°çš„ä»»ä½•ä¸ç¬¦åˆè¯­æ³•çš„æƒ…å†µéƒ½ä¼šè§¦å‘é”™è¯¯å¤„ç†ã€‚</li><li>ä½¿ç”¨ <code>p.syntaxError</code> æŠ¥å‘Šè¯­æ³•é”™è¯¯ã€‚</li><li>ä½¿ç”¨ <code>p.advance</code>åœ¨é‡åˆ°é”™è¯¯æ—¶è·³è¿‡ä¸€äº›æ ‡è®°ï¼Œä»¥å°è¯•æ¢å¤åˆ°ä¸€ä¸ªå·²çŸ¥çš„ç¨³å®šçŠ¶æ€ã€‚</li></ul></li><li><strong>å®Œæˆè§£æ</strong>ï¼š<ul><li>å½“é‡åˆ°æ–‡ä»¶ç»“æŸæ ‡è®°ï¼ˆEOFï¼‰æ—¶ï¼Œå®Œæˆè§£æã€‚</li><li><code>f.EOF = p.pos()</code>: è®°å½•æ–‡ä»¶ç»“æŸçš„ä½ç½®ã€‚</li><li>è¿”å›æ„å»ºçš„ <code>File</code> èŠ‚ç‚¹ã€‚</li></ul></li></ol><h3 id="op-å­—æ®µ">Op å­—æ®µ</h3><p>AST æ¯ä¸ªèŠ‚ç‚¹éƒ½åŒ…å«äº†å½“å‰èŠ‚ç‚¹å±æ€§çš„ Op å­—æ®µï¼Œå®šä¹‰åœ¨<code>ir/node.go</code> ä¸­ï¼Œä»¥ O å¼€å¤´ã€‚ä¸è¯æ³•è§£æé˜¶æ®µä¸­çš„ tokenç›¸åŒçš„æ˜¯ï¼ŒOp å­—æ®µä¹Ÿæ˜¯ä¸€ä¸ªæ•´æ•°ã€‚ä¸åŒçš„æ˜¯ï¼Œæ¯ä¸ª Opå­—æ®µéƒ½åŒ…å«äº†è¯­ä¹‰ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œå½“ä¸€ä¸ªèŠ‚ç‚¹çš„ Op æ“ä½œä¸º OASæ—¶ï¼Œè¯¥èŠ‚ç‚¹ä»£è¡¨çš„è¯­ä¹‰ä¸º Left := Rightï¼Œè€Œå½“èŠ‚ç‚¹çš„æ“ä½œä¸º OAS2æ—¶ï¼Œä»£ç çš„è¯­ä¹‰ä¸º x,y,z = a,b,cã€‚</p><p>è¿™é‡Œä»…å±•ç¤ºéƒ¨åˆ† Op å­—æ®µçš„å®šä¹‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Op <span class="hljs-type">uint8</span><br><br><span class="hljs-comment">// Node ops.</span><br><span class="hljs-keyword">const</span> (<br>OXXX Op = <span class="hljs-literal">iota</span><br><br><span class="hljs-comment">// names</span><br>ONAME <span class="hljs-comment">// var or func name</span><br><span class="hljs-comment">// Unnamed arg or return value: f(int, string) (int, error) &#123; etc &#125;</span><br><span class="hljs-comment">// Also used for a qualified package identifier that hasn&#x27;t been resolved yet.</span><br>ONONAME<br>OTYPE    <span class="hljs-comment">// type name</span><br>OLITERAL <span class="hljs-comment">// literal</span><br>ONIL     <span class="hljs-comment">// nil</span><br><br><span class="hljs-comment">// expressions</span><br>OADD          <span class="hljs-comment">// X + Y</span><br>...<br><span class="hljs-comment">// X = Y or (if Def=true) X := Y</span><br><span class="hljs-comment">// If Def, then Init includes a DCL node for X.</span><br>OAS<br><span class="hljs-comment">// Lhs = Rhs (x, y, z = a, b, c) or (if Def=true) Lhs := Rhs</span><br><span class="hljs-comment">// If Def, then Init includes DCL nodes for Lhs</span><br>OAS2<br>...<br>    <br>    <span class="hljs-comment">// statements</span><br>    OLABEL    <span class="hljs-comment">// Label:</span><br>    ...<br>OEND<br>)<br></code></pre></td></tr></table></figure><p>ä»¥å‰é¢ä¸¾ä¾‹çš„èµ‹å€¼è¯­å¥ <code>a := b + c(12)</code>ä¸ºä¾‹ï¼Œè¯¥èµ‹å€¼è¯­å¥æœ€ç»ˆä¼šç¼–ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºçš„æŠ½è±¡è¯­æ³•æ ‘ï¼ŒèŠ‚ç‚¹ä¹‹é—´å…·æœ‰ä»ä¸Šåˆ°ä¸‹çš„å±‚æ¬¡ç»“æ„å’Œä¾èµ–å…³ç³»ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20231203003058976.png"alt="æŠ½è±¡è¯­æ³•æ ‘ç¤ºä¾‹å›¾" /><figcaption aria-hidden="true">æŠ½è±¡è¯­æ³•æ ‘ç¤ºä¾‹å›¾</figcaption></figure><h2 id="ç±»å‹æ£€æŸ¥">ç±»å‹æ£€æŸ¥</h2><p>å®Œæˆ ASTçš„åˆæ­¥æ„å»ºåï¼Œå°±è¿›å…¥ç±»å‹æ£€æŸ¥é˜¶æ®µéå†èŠ‚ç‚¹æ ‘å¹¶å†³å®šèŠ‚ç‚¹çš„ç±»å‹ã€‚å…·ä½“çš„ä»£ç åœ¨<ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/cmd/compile/internal/types2/check.go">types2/check,go</a>ã€‚</p><h3 id="checker.checkfiles">checker.CheckFiles()</h3><p>å…¶ä¸­æœ€æ ¸å¿ƒçš„æ–¹æ³•å°±æ˜¯ <code>checker.CheckFiles()</code>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(check *Checker)</span></span> checkFiles(files []*syntax.File) (err <span class="hljs-type">error</span>) &#123;<br>    <span class="hljs-comment">// 1. ä¸æ£€æŸ¥ unsafe åŒ…</span><br><span class="hljs-keyword">if</span> check.pkg == Unsafe &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br>    <span class="hljs-comment">// 2. æ£€æŸ¥ go ç‰ˆæœ¬</span><br>check.version, err = parseGoVersion(check.conf.GoVersion)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> err<br>&#125;<br><span class="hljs-keyword">if</span> check.version.after(version&#123;<span class="hljs-number">1</span>, goversion.Version&#125;) &#123;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;package requires newer Go version %v&quot;</span>, check.version)<br>&#125;<br><span class="hljs-keyword">if</span> check.conf.FakeImportC &amp;&amp; check.conf.go115UsesCgo &#123;<br><span class="hljs-keyword">return</span> errBadCgo<br>&#125;<br><br>    <span class="hljs-comment">// 3. é”™è¯¯å¤„ç†</span><br><span class="hljs-keyword">defer</span> check.handleBailout(&amp;err)<br><br>    <span class="hljs-comment">// 4. è¯¦ç»†æ£€æŸ¥æ¯ä¸ªåœ°æ–¹</span><br><span class="hljs-built_in">print</span> := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(msg <span class="hljs-type">string</span>)</span></span> &#123;<br><span class="hljs-keyword">if</span> check.conf.Trace &#123;<br>fmt.Println()<br>fmt.Println(msg)<br>&#125;<br>&#125;<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;== initFiles ==&quot;</span>)<br>check.initFiles(files)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;== collectObjects ==&quot;</span>)<br>check.collectObjects()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;== packageObjects ==&quot;</span>)<br>check.packageObjects()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;== processDelayed ==&quot;</span>)<br>check.processDelayed(<span class="hljs-number">0</span>) <span class="hljs-comment">// incl. all functions</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;== cleanup ==&quot;</span>)<br>check.cleanup()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;== initOrder ==&quot;</span>)<br>check.initOrder()<br><span class="hljs-keyword">if</span> !check.conf.DisableUnusedImportCheck &#123;<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;== unusedImports ==&quot;</span>)<br>check.unusedImports()<br>&#125;<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;== recordUntyped ==&quot;</span>)<br>check.recordUntyped()<br><span class="hljs-keyword">if</span> check.firstErr == <span class="hljs-literal">nil</span> &#123;<br>check.monomorph()<br>&#125;<br>check.pkg.goVersion = check.conf.GoVersion<br>check.pkg.complete = <span class="hljs-literal">true</span><br><br><span class="hljs-comment">// 5. æ›´æ–°å’Œæ¸…ç†</span><br>check.imports = <span class="hljs-literal">nil</span><br>check.dotImportMap = <span class="hljs-literal">nil</span><br>check.pkgPathMap = <span class="hljs-literal">nil</span><br>check.seenPkgMap = <span class="hljs-literal">nil</span><br>check.recvTParamMap = <span class="hljs-literal">nil</span><br>check.brokenAliases = <span class="hljs-literal">nil</span><br>check.unionTypeSets = <span class="hljs-literal">nil</span><br>check.ctxt = <span class="hljs-literal">nil</span><br><span class="hljs-keyword">return</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ€»ç»“ <code>checker.checkFiles()</code> çš„è¿‡ç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p><ol type="1"><li><strong>æ£€æŸ¥ç‰¹æ®ŠåŒ…</strong>ï¼šå¦‚æœæ˜¯ <code>Unsafe</code>åŒ…ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œå› ä¸ºå®ƒä¸èƒ½è¿›è¡Œç±»å‹æ£€æŸ¥ä¸”ä¸åº”è¢«ä¿®æ”¹ã€‚</li><li><strong>è§£æGoç‰ˆæœ¬</strong>ï¼šæ ¹æ®é…ç½®è§£æ Goç‰ˆæœ¬ï¼Œå¹¶è¿›è¡Œå…¼å®¹æ€§æ£€æŸ¥ã€‚</li><li><strong>é”™è¯¯å¤„ç†</strong>ï¼šè®¾ç½®ä¸€ä¸ªå»¶è¿Ÿå‡½æ•°æ¥å¤„ç†ä»»ä½•å¯èƒ½å‡ºç°çš„é”™è¯¯ã€‚</li><li><strong>ç±»å‹æ£€æŸ¥çš„æ­¥éª¤</strong>ï¼š<ul><li><code>initFiles</code>: åˆå§‹åŒ–æ–‡ä»¶ã€‚</li><li><code>collectObjects</code>: æ”¶é›†å¯¹è±¡ã€‚</li><li><code>packageObjects</code>: æ‰“åŒ…å¯¹è±¡ã€‚</li><li><code>processDelayed</code>: å¤„ç†å»¶è¿Ÿçš„ä»»åŠ¡ï¼ˆåŒ…æ‹¬æ‰€æœ‰å‡½æ•°ï¼‰ã€‚</li><li><code>cleanup</code>: æ¸…ç†ã€‚</li><li><code>initOrder</code>: åˆå§‹åŒ–é¡ºåºã€‚</li><li><code>unusedImports</code>: æ£€æŸ¥æœªä½¿ç”¨çš„å¯¼å…¥ã€‚</li><li><code>recordUntyped</code>: è®°å½•æœªå®šç±»å‹ã€‚</li><li><code>monomorph</code>: å¦‚æœæ²¡æœ‰é”™è¯¯ï¼Œè¿›è¡Œå•æ€åŒ–å¤„ç†ã€‚</li></ul></li><li><strong>æ›´æ–°å’Œæ¸…ç†</strong>ï¼š<ul><li>æ›´æ–°åŒ…çš„ Go ç‰ˆæœ¬å’Œå®ŒæˆçŠ¶æ€ã€‚</li><li>æ¸…ç†ä¸å†éœ€è¦çš„å†…éƒ¨æ•°æ®ç»“æ„ï¼Œé‡Šæ”¾å†…å­˜ã€‚</li></ul></li><li><strong>è¿”å›</strong>ï¼šå‡½æ•°å®Œæˆç±»å‹æ£€æŸ¥å¹¶è¿”å›ã€‚</li></ol><p>å¯ä»¥çœ‹å‡ºå…·ä½“çš„æ£€æŸ¥æ­¥éª¤éƒ½å°è£…åœ¨ç¬¬ 4ç‚¹çš„å„ä¸ªå‡½æ•°ä¸­ï¼Œå…¶å®æ£€æŸ¥çš„ä¸œè¥¿æˆ‘ä»¬å­¦ä¹  Goè¯­è¨€æ—¶æ‰€éœ€è¦æŒæ¡çš„é‚£äº›è¯­æ³•ï¼Œæˆ‘ä»¬ä»¥ <code>initFiles</code>ä¸ºä¾‹å­æ¥åˆ†æä¸€ä¸‹ï¼Œå¯¹äºå…¶ä»–æ£€æŸ¥å‡½æ•°ï¼Œä½ æœ‰å…´è¶£çš„è¯ä¹Ÿå¯ä»¥äº†è§£ä¸€ä¸‹ï¼Œè¿™é‡Œæ¨èå°†å‡½æ•°æºä»£ç æ‹·è´å‘ç»™<strong>ChatGPT-4</strong>ï¼Œç›¸ä¿¡å¯¹ä½ ä¼šæœ‰å¾ˆå¤§çš„å¸®åŠ©ã€‚</p><h3 id="checker.initfiles">checker.initFiles()</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// initFiles åˆå§‹åŒ–ä¸æ–‡ä»¶ç›¸å…³çš„ç±»å‹æ£€æŸ¥å™¨</span><br><span class="hljs-comment">// å‚æ•°ä¸­çš„ files å¿…é¡»éƒ½å±äºåŒä¸€ä¸ª package</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(check *Checker)</span></span> initFiles(files []*syntax.File) &#123;<br><span class="hljs-comment">// 1. åˆå§‹åŒ–</span><br>check.files = <span class="hljs-literal">nil</span><br>check.imports = <span class="hljs-literal">nil</span><br>check.dotImportMap = <span class="hljs-literal">nil</span><br>check.firstErr = <span class="hljs-literal">nil</span><br>check.methods = <span class="hljs-literal">nil</span><br>check.untyped = <span class="hljs-literal">nil</span><br>check.delayed = <span class="hljs-literal">nil</span><br>check.objPath = <span class="hljs-literal">nil</span><br>check.cleaners = <span class="hljs-literal">nil</span><br><br><span class="hljs-comment">// 2. ç¡®å®šåŒ…åå’Œæœ‰æ•ˆæ–‡ä»¶</span><br>pkg := check.pkg<br><span class="hljs-keyword">for</span> _, file := <span class="hljs-keyword">range</span> files &#123;<br><span class="hljs-keyword">switch</span> name := file.PkgName.Value; pkg.name &#123;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;&quot;</span>:<br><span class="hljs-keyword">if</span> name != <span class="hljs-string">&quot;_&quot;</span> &#123;<br>pkg.name = name<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>check.<span class="hljs-type">error</span>(file.PkgName, BlankPkgName, <span class="hljs-string">&quot;invalid package name _&quot;</span>)<br>&#125;<br><span class="hljs-keyword">fallthrough</span><br><br><span class="hljs-keyword">case</span> name:<br>check.files = <span class="hljs-built_in">append</span>(check.files, file)<br><br><span class="hljs-keyword">default</span>:<br>check.errorf(file, MismatchedPkgName, <span class="hljs-string">&quot;package %s; expected %s&quot;</span>, name, pkg.name)<br><span class="hljs-comment">// ignore this file</span><br>&#125;<br>&#125;<br><br>    <span class="hljs-comment">// 3. å¯¹æ¯ä¸ªæ–‡ä»¶ï¼Œè§£æå…¶ä¸­æŒ‡å®šçš„ Go ç‰ˆæœ¬</span><br><span class="hljs-keyword">for</span> _, file := <span class="hljs-keyword">range</span> check.files &#123;<br>v, _ := parseGoVersion(file.GoVersion)<br><span class="hljs-keyword">if</span> v.major &gt; <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">if</span> v.equal(check.version) &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><span class="hljs-comment">// Go 1.21 introduced the feature of setting the go.mod</span><br><span class="hljs-comment">// go line to an early version of Go and allowing //go:build lines</span><br><span class="hljs-comment">// to â€œupgradeâ€ the Go version in a given file.</span><br><span class="hljs-comment">// We can do that backwards compatibly.</span><br><span class="hljs-comment">// Go 1.21 also introduced the feature of allowing //go:build lines</span><br><span class="hljs-comment">// to â€œdowngradeâ€ the Go version in a given file.</span><br><span class="hljs-comment">// That can&#x27;t be done compatibly in general, since before the</span><br><span class="hljs-comment">// build lines were ignored and code got the module&#x27;s Go version.</span><br><span class="hljs-comment">// To work around this, downgrades are only allowed when the</span><br><span class="hljs-comment">// module&#x27;s Go version is Go 1.21 or later.</span><br><span class="hljs-comment">// If there is no check.version, then we don&#x27;t really know what Go version to apply.</span><br><span class="hljs-comment">// Legacy tools may do this, and they historically have accepted everything.</span><br><span class="hljs-comment">// Preserve that behavior by ignoring //go:build constraints entirely in that case.</span><br><span class="hljs-keyword">if</span> (v.before(check.version) &amp;&amp; check.version.before(version&#123;<span class="hljs-number">1</span>, <span class="hljs-number">21</span>&#125;)) || check.version.equal(version&#123;<span class="hljs-number">0</span>, <span class="hljs-number">0</span>&#125;) &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><span class="hljs-keyword">if</span> check.posVers == <span class="hljs-literal">nil</span> &#123;<br>check.posVers = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[*syntax.PosBase]version)<br>&#125;<br>check.posVers[base(file.Pos())] = v<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ€»ç»“ <code>checker.initFiles()</code> æ–¹æ³•çš„å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š</p><ol type="1"><li><strong>åˆå§‹åŒ–çŠ¶æ€</strong>ï¼šæ¸…ç©º <code>Checker</code>ç»“æ„ä½“ä¸­ä¸æ–‡ä»¶ç›¸å…³çš„å¤šä¸ªå­—æ®µï¼Œå¦‚ <code>files</code>,<code>imports</code>, <code>dotImportMap</code>ç­‰ï¼Œä¸ºæ–°çš„æ£€æŸ¥è¿‡ç¨‹åšå‡†å¤‡ã€‚</li><li><strong>ç¡®å®šåŒ…åå’Œæœ‰æ•ˆæ–‡ä»¶</strong>ï¼š<ul><li>éå†æä¾›çš„æ–‡ä»¶ï¼Œç¡®å®šåŒ…åï¼Œå¹¶æ”¶é›†æœ‰æ•ˆçš„æ–‡ä»¶ã€‚</li><li>å¦‚æœæ–‡ä»¶çš„åŒ…åä¸ <code>Checker</code>ä¸­çš„åŒ…åä¸åŒ¹é…ï¼Œåˆ™æŠ¥é”™å¹¶å¿½ç•¥è¯¥æ–‡ä»¶ã€‚</li></ul></li><li><strong>å¤„ç†Goç‰ˆæœ¬</strong>ï¼š<ul><li>å¯¹æ¯ä¸ªæ–‡ä»¶ï¼Œè§£æå…¶ä¸­æŒ‡å®šçš„ Go ç‰ˆæœ¬ã€‚</li><li>å¤„ç† Go ç‰ˆæœ¬çš„å…¼å®¹æ€§å’Œå‡çº§é€»è¾‘ï¼Œå°¤å…¶æ˜¯åœ¨ Go 1.21 å¼•å…¥çš„ä¸€äº›ç‰¹æ€§ï¼Œå¦‚<code>//go:build</code> è¡Œçš„å¤„ç†ã€‚</li></ul></li></ol><p>å¯ä»¥çœ‹åˆ° Go è¯­è¨€å¼€å‘å›¢é˜Ÿåœ¨è¿™é‡Œå†™äº†ä¸€å¤§æ®µå…³äº Go1.21çš„æ³¨é‡Šï¼Œè¿™æ®µæ³¨é‡Šæè¿°äº† Go 1.21 ç‰ˆæœ¬å¼•å…¥çš„å…³äº Goç‰ˆæœ¬è®¾ç½®çš„ä¸¤ä¸ªæ–°ç‰¹æ€§,è¿™é‡Œç®€å•è§£é‡Šä¸€ä¸‹ï¼š</p><ol type="1"><li><strong>å‡çº§ Go ç‰ˆæœ¬çš„ç‰¹æ€§</strong>ï¼šåœ¨ Go 1.21 ç‰ˆæœ¬ä¸­ï¼Œå¯ä»¥åœ¨<code>go.mod</code> æ–‡ä»¶é‡Œè®¾ç½®ä¸€ä¸ªè¾ƒæ—§çš„Goç‰ˆæœ¬ï¼ŒåŒæ—¶å…è®¸åœ¨æºæ–‡ä»¶ä¸­é€šè¿‡<code>//go:build</code> è¡Œæ¥æŒ‡å®šä¸€ä¸ªæ›´é«˜çš„ Goç‰ˆæœ¬ã€‚è¿™æ ·åšå¯ä»¥å‘åå…¼å®¹ï¼Œå³å…è®¸æ—§ç‰ˆæœ¬ä»£ç åœ¨æ–°ç‰ˆæœ¬çš„ Goç¯å¢ƒä¸­è¿è¡Œã€‚</li><li><strong>é™çº§ Go ç‰ˆæœ¬çš„é™åˆ¶</strong>ï¼šGo 1.21 ä¹Ÿå…è®¸é€šè¿‡<code>//go:build</code> è¡Œæ¥é™ä½æºæ–‡ä»¶ä¸­çš„ Goç‰ˆæœ¬ã€‚ä½†è¿™é€šå¸¸ä¸æ˜¯å‘åå…¼å®¹çš„ï¼Œå› ä¸ºåœ¨ä»¥å‰ï¼Œ<code>//go:build</code>è¡Œè¢«å¿½ç•¥ï¼Œä»£ç æ€»æ˜¯ä½¿ç”¨æ¨¡å—å®šä¹‰çš„ Go ç‰ˆæœ¬ã€‚ä¸ºäº†é¿å…å…¼å®¹æ€§é—®é¢˜ï¼Œä»…å½“æ¨¡å—çš„Go ç‰ˆæœ¬ä¸º 1.21 æˆ–æ›´é«˜æ—¶ï¼Œæ‰å…è®¸è¿™ç§é™çº§ã€‚</li></ol><p><strong>æœªæŒ‡å®šç‰ˆæœ¬çš„æƒ…å†µ</strong>ï¼šå¦‚æœæ²¡æœ‰æ˜ç¡®æŒ‡å®š<code>check.version</code>ï¼Œç¼–è¯‘å™¨å°±ä¸ç¡®å®šåº”è¯¥ä½¿ç”¨å“ªä¸ª Goç‰ˆæœ¬ã€‚ä¸ºäº†ä¿æŒä¸æ—§å·¥å…·çš„å…¼å®¹ï¼Œå¦‚æœæ²¡æœ‰æ˜ç¡®çš„ç‰ˆæœ¬çº¦æŸï¼Œç¼–è¯‘å™¨å°†å¿½ç•¥<code>//go:build</code> è¡Œçš„é™åˆ¶ã€‚</p><h2 id="æ­»ä»£ç æ¶ˆé™¤">æ­»ä»£ç æ¶ˆé™¤</h2><p>ç±»å‹æ£€æŸ¥é˜¶æ®µå®Œæˆåï¼Œç¼–è¯‘å™¨å‰ç«¯å·¥ä½œåŸºæœ¬å®Œæˆï¼Œåé¢å°±è¿›å…¥ä¸­ç«¯äº†ã€‚è¿™ä¸ªé˜¶æ®µGo è¯­è¨€ç¼–è¯‘å™¨å°†å¯¹ AST è¿›è¡Œåˆ†æå’Œé‡æ„ï¼Œä»è€Œå®Œæˆä¸€ç³»åˆ—ä¼˜åŒ–ã€‚</p><p>ç¬¬ä¸€éƒ¨åˆ†æ˜¯æ­»ä»£ç æ¶ˆé™¤ï¼ˆdead codeeliminationï¼‰ï¼Œè¿‡ç¨‹è¯†åˆ«å¹¶ç§»é™¤ä¸ä¼šåœ¨è¿è¡Œæ—¶æ‰§è¡Œçš„ä»£ç ã€‚è¿™åŒ…æ‹¬æœªä½¿ç”¨çš„å˜é‡ã€å‡½æ•°ã€å¸¸é‡ç­‰ã€‚é€šè¿‡åˆ é™¤è¿™äº›æ— ç”¨ä»£ç ç‰‡æ®µï¼Œå¯ä»¥å‡å°æœ€ç»ˆç¨‹åºçš„å¤§å°å¹¶æé«˜è¿è¡Œæ•ˆç‡ã€‚</p><p>è¿™éƒ¨åˆ†çš„ä»£ç åœ¨ï¼š<ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/cmd/compile/internal/deadcode/deadcode.go">deadcode/deadcode.go</a>ã€‚æ‰“å¼€ä»£ç æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°æ ¸å¿ƒå°±æ˜¯<code>Func()</code> å’Œ <code>stmt()</code> è¿™ 2 ä¸ªå‡½æ•°ã€‚</p><h3 id="func">Func()</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Func</span><span class="hljs-params">(fn *ir.Func)</span></span> &#123;<br>    <br>    <span class="hljs-comment">// 1. å¯¹å‡½æ•°ä½“è¿›è¡Œé¢„å¤„ç†</span><br>stmts(&amp;fn.Body)<br><br>    <span class="hljs-comment">// 2. ç©ºå‡½æ•°ä½“ç›´æ¥è¿”å›</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(fn.Body) == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><br>    <span class="hljs-comment">// 3. éå†å‡½æ•°ä½“ï¼Œå¯¹å…¶ä¸­æ¯ä¸ªèŠ‚ç‚¹è¿›è¡Œå¤„ç†</span><br><span class="hljs-keyword">for</span> _, n := <span class="hljs-keyword">range</span> fn.Body &#123;<br>        <span class="hljs-comment">// èŠ‚ç‚¹æœ‰ä»»ä½•åˆå§‹åŒ–æ“ä½œï¼Œåˆ™ä¸å¯æ¶ˆé™¤ï¼Œæå‰è¿”å›ã€‚</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(n.Init()) &gt; <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">switch</span> n.Op() &#123;<br><span class="hljs-keyword">case</span> ir.OIF:<br>n := n.(*ir.IfStmt)<br>            <span class="hljs-comment">// å¦‚æœ if è¯­å¥åˆ¤æ–­æ¡ä»¶ä¸æ˜¯å¸¸é‡ï¼Œæˆ–è€… if else ä¸­çš„ body ä¸ä¸ºç©ºï¼Œåˆ™ä¸å¯æ¶ˆé™¤ï¼Œæå‰è¿”å›</span><br><span class="hljs-keyword">if</span> !ir.IsConst(n.Cond, constant.Bool) || <span class="hljs-built_in">len</span>(n.Body) &gt; <span class="hljs-number">0</span> || <span class="hljs-built_in">len</span>(n.Else) &gt; <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">case</span> ir.OFOR:<br>n := n.(*ir.ForStmt)<br>            <span class="hljs-comment">// å¦‚æœ for å¾ªç¯æ¡ä»¶ä¸æ˜¯å¸¸é‡æˆ–ä¸€ç›´ä¸ºçœŸï¼Œåˆ™ä¸å¯æ¶ˆé™¤ï¼Œæå‰è¿”å›</span><br><span class="hljs-keyword">if</span> !ir.IsConst(n.Cond, constant.Bool) || ir.BoolVal(n.Cond) &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">return</span><br>&#125;<br>&#125;<br><br>    <span class="hljs-comment">// 4. æ ‡è®°éšè—é—­åŒ…ä¸ºæ­»ä»£ç </span><br>ir.VisitList(fn.Body, markHiddenClosureDead)<br>    <span class="hljs-comment">// 5. é‡ç½®å‡½æ•°ä½“ï¼Œæ›¿æ¢ä¸ºä¸€ä¸ªç©ºè¯­å¥ï¼Œè¿›è¡Œæ¸…ç†å’Œä¼˜åŒ–</span><br>fn.Body = []ir.Node&#123;ir.NewBlockStmt(base.Pos, <span class="hljs-literal">nil</span>)&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><ol type="1"><li><strong>è¯­å¥å¤„ç†ï¼ˆ<code>stmts(&amp;fn.Body)</code>ï¼‰</strong>ï¼šå¯¹å‡½æ•°ä½“ä¸­çš„è¯­å¥è¿›è¡Œé¢„å¤„ç†æˆ–è½¬æ¢ï¼Œä»¥ä¾¿äºåç»­çš„åˆ†æå’Œä¼˜åŒ–ã€‚</li><li><strong>ç©ºå‡½æ•°ä½“ç›´æ¥è¿”å›</strong>ï¼šå¦‚æœå‡½æ•°ä½“ä¸ºç©ºï¼Œæ²¡æœ‰ä»»ä½•ä»£ç éœ€è¦æ‰§è¡Œï¼Œå› æ­¤å‡½æ•°ç›´æ¥è¿”å›ã€‚è¿™æ˜¯ä¸€ç§ä¼˜åŒ–ï¼Œé¿å…å¯¹ç©ºå‡½æ•°ä½“è¿›è¡Œä¸å¿…è¦çš„åˆ†æã€‚</li><li><strong>éå†å‡½æ•°ä½“</strong>:<ul><li><strong>èŠ‚ç‚¹åˆå§‹åŒ–æ£€æŸ¥</strong>ï¼šå¦‚æœä»»ä½•èŠ‚ç‚¹æœ‰åˆå§‹åŒ–æ“ä½œï¼Œæ„å‘³ç€å¯èƒ½å­˜åœ¨å‰¯ä½œç”¨æˆ–å¿…è¦çš„ä»£ç æ‰§è¡Œï¼Œå› æ­¤å‡½æ•°æå‰è¿”å›ã€‚</li><li><code>If</code> å’Œ <code>For</code> è¯­å¥ç‰¹æ®Šå¤„ç†<ul><li><code>ir.OIF</code>ï¼šå¦‚æœ <code>If</code>è¯­å¥çš„æ¡ä»¶ä¸æ˜¯å¸¸é‡å¸ƒå°”å€¼ï¼Œæˆ–è€… <code>If</code> è¯­å¥æœ‰éç©ºçš„ body æˆ– elseåˆ†æ”¯ï¼Œåˆ™æå‰è¿”å›ï¼Œå› ä¸ºè¿™äº›åˆ†æ”¯å¯èƒ½åŒ…å«é‡è¦çš„ä»£ç ã€‚</li><li><code>ir.OFOR</code>ï¼šå¯¹äº <code>For</code>å¾ªç¯ï¼Œå¦‚æœæ¡ä»¶ä¸æ˜¯å¸¸é‡å¸ƒå°”å€¼æˆ–è€…å¸ƒå°”å€¼ä¸ºçœŸï¼Œæ„å‘³ç€å¾ªç¯å¯èƒ½æ‰§è¡Œï¼Œå› æ­¤æå‰è¿”å›ã€‚</li></ul></li></ul></li><li><strong>æ ‡è®°éšè—é—­åŒ…ä¸ºæ­»ä»£ç ï¼ˆ<code>markHiddenClosureDead</code>ï¼‰</strong>ï¼šå¦‚æœæ‰€æœ‰èŠ‚ç‚¹éƒ½ä¸è§¦å‘æå‰è¿”å›ï¼Œæ„å‘³ç€æ•´ä¸ªå‡½æ•°ä½“å¯èƒ½æ²¡æœ‰æœ‰æ•ˆçš„ä»£ç æ‰§è¡Œã€‚æ­¤æ—¶ï¼Œå°†éšè—çš„é—­åŒ…æ ‡è®°ä¸ºæ­»ä»£ç ï¼Œå¯èƒ½æ˜¯ä¸ºäº†è¿›ä¸€æ­¥çš„ä¼˜åŒ–å¤„ç†ï¼Œå¦‚ç§»é™¤è¿™äº›ä»£ç ã€‚</li><li><strong>é‡ç½®å‡½æ•°ä½“</strong>ï¼šæœ€åï¼Œå°†å‡½æ•°ä½“æ›¿æ¢ä¸ºä¸€ä¸ªç©ºçš„æ–°å—è¯­å¥ï¼Œè¿™è¡¨æ˜åŸå§‹çš„å‡½æ•°ä½“è¢«è®¤ä¸ºæ˜¯æ— æ•ˆçš„æˆ–ä¸ä¼šè¢«æ‰§è¡Œï¼Œä»è€Œè¿›è¡Œäº†ä»£ç çš„æ¸…ç†å’Œä¼˜åŒ–ã€‚</li></ol><h3 id="stmt">stmt()</h3><p>è¿™ä¸ªå‡½æ•°çš„ç›®çš„æ˜¯é€šè¿‡åˆ†æå’Œç®€åŒ–æ§åˆ¶æµç»“æ„ï¼Œæ¥è¯†åˆ«å’Œç§»é™¤é‚£äº›åœ¨ç¨‹åºæ‰§è¡Œä¸­æ°¸è¿œä¸ä¼šåˆ°è¾¾çš„ä»£ç éƒ¨åˆ†ã€‚è¿™æ ·çš„ä¼˜åŒ–å¯ä»¥å‡å°‘ç¼–è¯‘åçš„ä»£ç é‡ï¼Œå¹¶æé«˜ç¨‹åºè¿è¡Œæ—¶çš„æ•ˆç‡ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">stmts</span><span class="hljs-params">(nn *ir.Nodes)</span></span> &#123;<br>    <br>    <span class="hljs-comment">// 1. æ ‡è®°æœ€åä¸€ä¸ªæ ‡ç­¾ï¼Œå…¶å¯¹åº”çš„ Op å­—æ®µå°±æ˜¯ OLABEL</span><br><span class="hljs-keyword">var</span> lastLabel = <span class="hljs-number">-1</span><br><span class="hljs-keyword">for</span> i, n := <span class="hljs-keyword">range</span> *nn &#123;<br><span class="hljs-keyword">if</span> n != <span class="hljs-literal">nil</span> &amp;&amp; n.Op() == ir.OLABEL &#123;<br>lastLabel = i<br>&#125;<br>&#125;<br>    <br>    <span class="hljs-comment">// 2. å¤„ç† if å’Œ switch è¯­å¥</span><br><span class="hljs-keyword">for</span> i, n := <span class="hljs-keyword">range</span> *nn &#123;<br>cut := <span class="hljs-literal">false</span><br><span class="hljs-keyword">if</span> n == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><span class="hljs-keyword">if</span> n.Op() == ir.OIF &#123;<br>n := n.(*ir.IfStmt)<br>n.Cond = expr(n.Cond)<br>             <span class="hljs-comment">// if è¯­å¥æ ¹æ®æ¡ä»¶æ˜¯å¦ä¸ºå¸¸é‡æ¥ä¿ç•™å’Œç§»é™¤åˆ†æ”¯</span><br><span class="hljs-keyword">if</span> ir.IsConst(n.Cond, constant.Bool) &#123;<br><span class="hljs-keyword">var</span> body ir.Nodes<br><span class="hljs-keyword">if</span> ir.BoolVal(n.Cond) &#123;<br>ir.VisitList(n.Else, markHiddenClosureDead)<br>n.Else = ir.Nodes&#123;&#125;<br>body = n.Body<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>ir.VisitList(n.Body, markHiddenClosureDead)<br>n.Body = ir.Nodes&#123;&#125;<br>body = n.Else<br>&#125;<br>                 <span class="hljs-comment">// å¦‚æœ then æˆ– else åˆ†æ”¯ä»¥ panic æˆ– return è¯­å¥ç»“æŸï¼Œé‚£ä¹ˆå¯ä»¥å®‰å…¨åœ°ç§»é™¤è¯¥èŠ‚ç‚¹ä¹‹åçš„æ‰€æœ‰è¯­å¥ã€‚</span><br>                 <span class="hljs-comment">// è¿™æ˜¯å› ä¸º panic æˆ– return ä¼šå¯¼è‡´å‡½æ•°ç»ˆæ­¢ï¼Œåç»­çš„ä»£ç æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œã€‚</span><br>                 <span class="hljs-comment">// åŒæ—¶ï¼Œæ³¨é‡Šæåˆ°è¦é¿å…ç§»é™¤æ ‡ç­¾ï¼ˆlabelsï¼‰ï¼Œå› ä¸ºå®ƒä»¬å¯èƒ½æ˜¯ goto è¯­å¥çš„ç›®æ ‡ï¼Œ</span><br>                 <span class="hljs-comment">// è€Œä¸”ä¸ºäº†é¿å… goto ç›¸å…³çš„å¤æ‚æ€§ï¼Œæ²¡æœ‰ä½¿ç”¨ isterminating æ ‡è®°ã€‚</span><br>                 <span class="hljs-comment">// might be the target of a goto. See issue 28616.</span><br><span class="hljs-keyword">if</span> body := body; <span class="hljs-built_in">len</span>(body) != <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">switch</span> body[(<span class="hljs-built_in">len</span>(body) - <span class="hljs-number">1</span>)].Op() &#123;<br><span class="hljs-keyword">case</span> ir.ORETURN, ir.OTAILCALL, ir.OPANIC:<br><span class="hljs-keyword">if</span> i &gt; lastLabel &#123;<br>cut = <span class="hljs-literal">true</span><br>&#125;<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br>        <span class="hljs-comment">// å°è¯•ç®€åŒ– switch è¯­å¥ï¼Œæ ¹æ®æ¡ä»¶å€¼å†³å®šå“ªä¸ªåˆ†æ”¯å§‹ç»ˆè¢«æ‰§è¡Œ</span><br><span class="hljs-keyword">if</span> n.Op() == ir.OSWITCH &#123;<br>n := n.(*ir.SwitchStmt)<br><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> n.Tag != <span class="hljs-literal">nil</span> &amp;&amp; n.Tag.Op() == ir.OTYPESW &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-comment">// no special type-switch case yet.</span><br>&#125;<br><span class="hljs-keyword">var</span> x constant.Value <span class="hljs-comment">// value we&#x27;re switching on</span><br><span class="hljs-keyword">if</span> n.Tag != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">if</span> ir.ConstType(n.Tag) == constant.Unknown &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br>x = n.Tag.Val()<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>x = constant.MakeBool(<span class="hljs-literal">true</span>) <span class="hljs-comment">// switch &#123; ... &#125;  =&gt;  switch true &#123; ... &#125;</span><br>&#125;<br><span class="hljs-keyword">var</span> def *ir.CaseClause<br><span class="hljs-keyword">for</span> _, cas := <span class="hljs-keyword">range</span> n.Cases &#123;<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(cas.List) == <span class="hljs-number">0</span> &#123; <span class="hljs-comment">// default case</span><br>def = cas<br><span class="hljs-keyword">continue</span><br>&#125;<br><span class="hljs-keyword">for</span> _, c := <span class="hljs-keyword">range</span> cas.List &#123;<br><span class="hljs-keyword">if</span> ir.ConstType(c) == constant.Unknown &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-comment">// can&#x27;t statically tell if it matches or not - give up.</span><br>&#125;<br><span class="hljs-keyword">if</span> constant.Compare(x, token.EQL, c.Val()) &#123;<br><span class="hljs-keyword">for</span> _, n := <span class="hljs-keyword">range</span> cas.Body &#123;<br><span class="hljs-keyword">if</span> n.Op() == ir.OFALL &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-comment">// fallthrough makes it complicated - abort.</span><br>&#125;<br>&#125;<br><span class="hljs-comment">// This switch entry is the one that always triggers.</span><br><span class="hljs-keyword">for</span> _, cas2 := <span class="hljs-keyword">range</span> n.Cases &#123;<br><span class="hljs-keyword">for</span> _, c2 := <span class="hljs-keyword">range</span> cas2.List &#123;<br>ir.Visit(c2, markHiddenClosureDead)<br>&#125;<br><span class="hljs-keyword">if</span> cas2 != cas &#123;<br>ir.VisitList(cas2.Body, markHiddenClosureDead)<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Rewrite to switch &#123; case true: ... &#125;</span><br>n.Tag = <span class="hljs-literal">nil</span><br>cas.List[<span class="hljs-number">0</span>] = ir.NewBool(c.Pos(), <span class="hljs-literal">true</span>)<br>cas.List = cas.List[:<span class="hljs-number">1</span>]<br>n.Cases[<span class="hljs-number">0</span>] = cas<br>n.Cases = n.Cases[:<span class="hljs-number">1</span>]<br><span class="hljs-keyword">return</span><br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> def != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">for</span> _, n := <span class="hljs-keyword">range</span> def.Body &#123;<br><span class="hljs-keyword">if</span> n.Op() == ir.OFALL &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-comment">// fallthrough makes it complicated - abort.</span><br>&#125;<br>&#125;<br><span class="hljs-keyword">for</span> _, cas := <span class="hljs-keyword">range</span> n.Cases &#123;<br><span class="hljs-keyword">if</span> cas != def &#123;<br>ir.VisitList(cas.List, markHiddenClosureDead)<br>ir.VisitList(cas.Body, markHiddenClosureDead)<br>&#125;<br>&#125;<br>n.Cases[<span class="hljs-number">0</span>] = def<br>n.Cases = n.Cases[:<span class="hljs-number">1</span>]<br><span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> handle case bodies ending with panic/return as we do in the IF case above.</span><br><br><span class="hljs-comment">// entire switch is a nop - no case ever triggers</span><br><span class="hljs-keyword">for</span> _, cas := <span class="hljs-keyword">range</span> n.Cases &#123;<br>ir.VisitList(cas.List, markHiddenClosureDead)<br>ir.VisitList(cas.Body, markHiddenClosureDead)<br>&#125;<br>n.Cases = n.Cases[:<span class="hljs-number">0</span>]<br>&#125;()<br>&#125;<br><br>        <span class="hljs-comment">// 3. å¯¹èŠ‚ç‚¹çš„åˆå§‹åŒ–è¯­å¥é€’å½’è°ƒç”¨ stmt å‡½æ•°è¿›è¡Œå¤„ç†</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(n.Init()) != <span class="hljs-number">0</span> &#123;<br>stmts(n.(ir.InitNode).PtrInit())<br>&#125;<br>        <span class="hljs-comment">// 4. éå†å…¶ä»–æ§åˆ¶ç»“æ„ï¼Œé€’å½’å¤„ç†å®ƒä»¬çš„å†…éƒ¨è¯­å¥</span><br><span class="hljs-keyword">switch</span> n.Op() &#123;<br><span class="hljs-keyword">case</span> ir.OBLOCK:<br>n := n.(*ir.BlockStmt)<br>stmts(&amp;n.List)<br><span class="hljs-keyword">case</span> ir.OFOR:<br>n := n.(*ir.ForStmt)<br>stmts(&amp;n.Body)<br><span class="hljs-keyword">case</span> ir.OIF:<br>n := n.(*ir.IfStmt)<br>stmts(&amp;n.Body)<br>stmts(&amp;n.Else)<br><span class="hljs-keyword">case</span> ir.ORANGE:<br>n := n.(*ir.RangeStmt)<br>stmts(&amp;n.Body)<br><span class="hljs-keyword">case</span> ir.OSELECT:<br>n := n.(*ir.SelectStmt)<br><span class="hljs-keyword">for</span> _, cas := <span class="hljs-keyword">range</span> n.Cases &#123;<br>stmts(&amp;cas.Body)<br>&#125;<br><span class="hljs-keyword">case</span> ir.OSWITCH:<br>n := n.(*ir.SwitchStmt)<br><span class="hljs-keyword">for</span> _, cas := <span class="hljs-keyword">range</span> n.Cases &#123;<br>stmts(&amp;cas.Body)<br>&#125;<br>&#125;<br><br>        <span class="hljs-comment">// 5. å¦‚æœç¡®å®šäº†æ˜¯å¯ä»¥æ¶ˆé™¤çš„ä»£ç ï¼Œåˆ™å¯¹å‡½æ•°ä½“è¿›è¡Œé˜¶æ®µï¼Œä¸”æ ‡è®°å…¶ä¸­çš„é—­åŒ…ä¸ºæ­»ä»£ç </span><br><span class="hljs-keyword">if</span> cut &#123;<br>ir.VisitList((*nn)[i+<span class="hljs-number">1</span>:<span class="hljs-built_in">len</span>(*nn)], markHiddenClosureDead)<br>*nn = (*nn)[:i+<span class="hljs-number">1</span>]<br><span class="hljs-keyword">break</span><br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol type="1"><li><strong>æ ‡è®°æœ€åä¸€ä¸ªæ ‡ç­¾</strong>ï¼šéå†æ‰€æœ‰èŠ‚ç‚¹ï¼Œè®°å½•æœ€åä¸€ä¸ªæ ‡ç­¾ï¼ˆ<code>OLABEL</code>ï¼‰çš„ä½ç½®ã€‚è¿™å¯¹äºåé¢åˆ¤æ–­æ˜¯å¦å¯ä»¥å®‰å…¨åœ°ç§»é™¤ä»£ç éå¸¸é‡è¦ã€‚</li><li><strong>å¤„ç† <code>if</code> å’Œ <code>switch</code> è¯­å¥</strong>ï¼š<ul><li>å¯¹äº <code>if</code>è¯­å¥ï¼Œå®ƒæ ¹æ®æ¡ä»¶æ˜¯å¦ä¸ºå¸¸é‡æ¥å†³å®šä¿ç•™å“ªä¸ªåˆ†æ”¯ï¼Œç§»é™¤å¦ä¸€ä¸ªåˆ†æ”¯ã€‚</li><li>å¯¹äº <code>switch</code> è¯­å¥ï¼Œå®ƒå°è¯•ç®€åŒ–<code>switch</code>ï¼Œæ ¹æ®æ¡ä»¶å€¼å†³å®šå“ªä¸ªåˆ†æ”¯å°†å§‹ç»ˆè¢«æ‰§è¡Œã€‚</li></ul></li><li><strong>èŠ‚ç‚¹åˆå§‹åŒ–</strong>ï¼šå¦‚æœèŠ‚ç‚¹æœ‰åˆå§‹åŒ–è¯­å¥ï¼Œå¯¹è¿™äº›åˆå§‹åŒ–è¯­å¥é€’å½’è°ƒç”¨<code>stmts</code> å‡½æ•°ã€‚</li><li><strong>éå†å…¶ä»–æ§åˆ¶ç»“æ„</strong>ï¼šå¯¹äº<code>for</code>ã€<code>if</code>ã€<code>range</code>ã€<code>select</code>å’Œ <code>switch</code> ç­‰æ§åˆ¶ç»“æ„ï¼Œé€’å½’åœ°å¤„ç†å®ƒä»¬çš„å†…éƒ¨è¯­å¥ã€‚</li><li><strong>æ¶ˆé™¤æ­»ä»£ç </strong>ï¼šå¦‚æœåˆ¤æ–­ä¸€ä¸ªèŠ‚ç‚¹ä¹‹åçš„æ‰€æœ‰ä»£ç éƒ½æ˜¯æ— æ•ˆçš„ï¼Œå®ƒä¼šæ ‡è®°è¿™äº›ä»£ç ä¸ºæ­»ä»£ç å¹¶æˆªæ–­å‡½æ•°ä½“ã€‚</li></ol><h2 id="å»è™šæ‹ŸåŒ–">å»è™šæ‹ŸåŒ–</h2><p>å»è™šæ‹ŸåŒ–ï¼ˆDevirtualizationï¼‰æ˜¯ç¼–è¯‘å™¨ä¼˜åŒ–çš„ä¸€ç§æŠ€æœ¯ï¼Œç”¨äºæé«˜é¢å‘å¯¹è±¡ç¨‹åºçš„æ€§èƒ½ã€‚åœ¨é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­ï¼Œæ–¹æ³•è°ƒç”¨é€šå¸¸æ˜¯é€šè¿‡è™šæ‹Ÿå‡½æ•°è¡¨ï¼ˆvtableï¼‰åŠ¨æ€è§£æçš„ï¼Œè¿™è¢«ç§°ä¸ºè™šæ‹Ÿè°ƒç”¨ã€‚è™šæ‹Ÿè°ƒç”¨å…è®¸å¯¹è±¡åœ¨è¿è¡Œæ—¶è¡¨ç°å‡ºå¤šæ€è¡Œä¸ºï¼Œä½†è¿™ä¹Ÿå¸¦æ¥äº†ä¸€å®šçš„æ€§èƒ½å¼€é”€ã€‚</p><p>å»è™šæ‹ŸåŒ–çš„ç›®çš„æ˜¯åœ¨ç¼–è¯‘æ—¶é™æ€ç¡®å®šæ–¹æ³•è°ƒç”¨çš„ç›®æ ‡ï¼Œä»è€Œé¿å…è¿è¡Œæ—¶çš„åŠ¨æ€æŸ¥æ‰¾ã€‚å¦‚æœç¼–è¯‘å™¨èƒ½å¤Ÿç¡®å®šä¸€ä¸ªç‰¹å®šçš„æ¥å£è°ƒç”¨æ€»æ˜¯è°ƒç”¨åŒä¸€ä¸ªæ–¹æ³•ï¼Œå®ƒå¯ä»¥å°†è¿™ä¸ªè™šæ‹Ÿè°ƒç”¨æ›¿æ¢ä¸ºç›´æ¥è°ƒç”¨ï¼Œå‡å°‘è¿è¡Œæ—¶å¼€é”€ã€‚è¿™ç§ä¼˜åŒ–ç‰¹åˆ«é€‚ç”¨äºé‚£äº›è°ƒç”¨ç›®æ ‡ä¸ä¼šå› ä¸ºç¨‹åºæ‰§è¡Œçš„ä¸åŒè·¯å¾„è€Œæ”¹å˜çš„æƒ…å†µã€‚</p><p>è¿™éƒ¨åˆ†çš„ä»£ç åœ¨ <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/cmd/compile/internal/devirtualize/devirtualize.go">devirtuailze/devirtualize.go</a>ã€‚</p><p>æ ¸å¿ƒå°± 2 ä¸ªå‡½æ•°ï¼š</p><ul><li><code>Static()</code> ï¼šéå†å‡½æ•°ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œå°¤å…¶æ³¨æ„è·³è¿‡åœ¨<code>go</code> æˆ– <code>defer</code>è¯­å¥ä¸­çš„è°ƒç”¨ï¼Œå¹¶å¯¹å…¶ä»–æ¥å£æ–¹æ³•è°ƒç”¨å°è¯•è¿›è¡Œé™æ€å»è™šæ‹ŸåŒ–ä¼˜åŒ–ã€‚</li><li><code>staticCall()</code>ï¼šé’ˆå¯¹ä¸€ä¸ªå…·ä½“çš„æ¥å£æ–¹æ³•è°ƒç”¨ï¼Œå¦‚æœå¯èƒ½ï¼Œå°†å…¶æ›¿æ¢ä¸ºç›´æ¥çš„å…·ä½“ç±»å‹æ–¹æ³•è°ƒç”¨ï¼Œä»¥ä¼˜åŒ–æ€§èƒ½ã€‚</li></ul><h3 id="static">Static()</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Static</span><span class="hljs-params">(fn *ir.Func)</span></span> &#123;<br>ir.CurFunc = fn<br>goDeferCall := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[*ir.CallExpr]<span class="hljs-type">bool</span>)<br>    <span class="hljs-comment">// 1. VisitList å¯¹ fn.Body ä¸­æ‰€æœ‰èŠ‚ç‚¹è°ƒç”¨åé¢çš„ func</span><br>ir.VisitList(fn.Body, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(n ir.Node)</span></span> &#123;<br><span class="hljs-keyword">switch</span> n := n.(<span class="hljs-keyword">type</span>) &#123;<br>        <span class="hljs-comment">// 2. è·³è¿‡ go å’Œ defer è¯­å¥</span><br><span class="hljs-keyword">case</span> *ir.GoDeferStmt:<br><span class="hljs-keyword">if</span> call, ok := n.Call.(*ir.CallExpr); ok &#123;<br>goDeferCall[call] = <span class="hljs-literal">true</span><br>&#125;<br><span class="hljs-keyword">return</span><br>        <span class="hljs-comment">// 3. è°ƒç”¨ staticCall å°è¯•è¿›è¡Œå»è™šæ‹ŸåŒ–</span><br><span class="hljs-keyword">case</span> *ir.CallExpr:<br><span class="hljs-keyword">if</span> !goDeferCall[n] &#123;<br>staticCall(n)<br>&#125;<br>&#125;<br>&#125;)<br>&#125;<br></code></pre></td></tr></table></figure><ol type="1"><li>è®¾å®šå½“å‰å‡½æ•°ä¸º <code>fn</code>ã€‚</li><li>éå†å‡½æ•°ä½“å†…çš„èŠ‚ç‚¹ï¼Œç‰¹åˆ«æ³¨æ„ <code>go</code> å’Œ <code>defer</code>è¯­å¥ã€‚å¦‚æœè°ƒç”¨å‘ç”Ÿåœ¨è¿™äº›è¯­å¥ä¸­ï¼Œå®ƒä¼šè¢«è·³è¿‡ï¼Œå› ä¸ºå»è™šæ‹ŸåŒ–å¯èƒ½æ”¹å˜ç¨‹åºçš„è¯­ä¹‰ã€‚</li><li>å¯¹äºä¸åœ¨ <code>go</code> æˆ– <code>defer</code>è¯­å¥ä¸­çš„æ¥å£æ–¹æ³•è°ƒç”¨ï¼Œè°ƒç”¨ <code>staticCall</code>å‡½æ•°å°è¯•è¿›è¡Œå»è™šæ‹ŸåŒ–ã€‚</li></ol><h3 id="staticcall">staticCall()</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">staticCall</span><span class="hljs-params">(call *ir.CallExpr)</span></span> &#123;<br>    <span class="hljs-comment">// 1. æ£€æŸ¥è°ƒç”¨æ˜¯å¦ä¸ºæ¥å£æ–¹æ³•è°ƒç”¨ï¼Œå¦‚æœä¸æ˜¯ï¼Œç›´æ¥è¿”å›</span><br><span class="hljs-keyword">if</span> call.Op() != ir.OCALLINTER &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br>    <br>    <span class="hljs-comment">// 2. è·å–æ¥æ”¶å™¨å’Œç›¸å…³ç±»å‹</span><br>sel := call.X.(*ir.SelectorExpr)<br>r := ir.StaticValue(sel.X)<br>    <br>     <span class="hljs-comment">// 3. æ£€æŸ¥æ¥æ”¶å™¨æ˜¯å¦æ˜¯æ¥å£è½¬æ¢ï¼Œå¦‚æœä¸æ˜¯ï¼Œç›´æ¥è¿”å›</span><br><span class="hljs-keyword">if</span> r.Op() != ir.OCONVIFACE &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br>recv := r.(*ir.ConvExpr)<br><br>   <span class="hljs-comment">// 4. æå–æ¥æ”¶å™¨ç±»å‹</span><br>typ := recv.X.Type()<br><span class="hljs-keyword">if</span> typ.IsInterface() &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-comment">// 5. shape ç±»å‹ç›´æ¥è¿”å›ï¼Œå› ä¸ºè¿™ä¸€èˆ¬æ¶‰åŠåˆ°æ³›å‹ï¼Œéœ€è¦é€šè¿‡å­—å…¸è¿›è¡Œé—´æ¥è°ƒç”¨</span><br><span class="hljs-keyword">if</span> typ.IsShape() &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">if</span> typ.HasShape() &#123;<br><span class="hljs-keyword">if</span> base.Flag.LowerM != <span class="hljs-number">0</span> &#123;<br>base.WarnfAt(call.Pos(), <span class="hljs-string">&quot;cannot devirtualize %v: shaped receiver %v&quot;</span>, call, typ)<br>&#125;<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">if</span> sel.X.Type().HasShape() &#123;<br><span class="hljs-keyword">if</span> base.Flag.LowerM != <span class="hljs-number">0</span> &#123;<br>base.WarnfAt(call.Pos(), <span class="hljs-string">&quot;cannot devirtualize %v: shaped interface %v&quot;</span>, call, sel.X.Type())<br>&#125;<br><span class="hljs-keyword">return</span><br>&#125;<br><br>    <span class="hljs-comment">// 6. ç±»å‹æ–­è¨€å’Œæ–¹æ³•é€‰æ‹©ï¼Œå°è¯•ç¡®å®šè°ƒç”¨çš„å…·ä½“æ–¹æ³•</span><br>dt := ir.NewTypeAssertExpr(sel.Pos(), sel.X, <span class="hljs-literal">nil</span>)<br>dt.SetType(typ)<br>x := typecheck.Callee(ir.NewSelectorExpr(sel.Pos(), ir.OXDOT, dt, sel.Sel))<br><span class="hljs-keyword">switch</span> x.Op() &#123;<br><span class="hljs-keyword">case</span> ir.ODOTMETH:<br>x := x.(*ir.SelectorExpr)<br><span class="hljs-keyword">if</span> base.Flag.LowerM != <span class="hljs-number">0</span> &#123;<br>base.WarnfAt(call.Pos(), <span class="hljs-string">&quot;devirtualizing %v to %v&quot;</span>, sel, typ)<br>&#125;<br>call.SetOp(ir.OCALLMETH)<br>call.X = x<br><span class="hljs-keyword">case</span> ir.ODOTINTER:<br>x := x.(*ir.SelectorExpr)<br><span class="hljs-keyword">if</span> base.Flag.LowerM != <span class="hljs-number">0</span> &#123;<br>base.WarnfAt(call.Pos(), <span class="hljs-string">&quot;partially devirtualizing %v to %v&quot;</span>, sel, typ)<br>&#125;<br>call.SetOp(ir.OCALLINTER)<br>call.X = x<br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">if</span> base.Flag.LowerM != <span class="hljs-number">0</span> &#123;<br>base.WarnfAt(call.Pos(), <span class="hljs-string">&quot;failed to devirtualize %v (%v)&quot;</span>, x, x.Op())<br>&#125;<br><span class="hljs-keyword">return</span><br>    <br>    <span class="hljs-comment">// 7. æ ¹æ®ç±»å‹æ–­è¨€çš„ç»“æœï¼Œå°è¯•å°†æ¥å£æ–¹æ³•è°ƒç”¨è½¬æ¢ä¸ºç›´æ¥æ–¹æ³•è°ƒç”¨æˆ–ä¿ç•™ä¸ºæ¥å£æ–¹æ³•è°ƒç”¨ã€‚</span><br>types.CheckSize(x.Type())<br><span class="hljs-keyword">switch</span> ft := x.Type(); ft.NumResults() &#123;<br><span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br><span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>call.SetType(ft.Results().Field(<span class="hljs-number">0</span>).Type)<br><span class="hljs-keyword">default</span>:<br>call.SetType(ft.Results())<br>&#125;<br><br><span class="hljs-comment">// 8. å¯¹å¯èƒ½ä¿®æ”¹åçš„æ–¹æ³•è°ƒç”¨è¿›è¡Œè¿›ä¸€æ­¥çš„ç±»å‹æ£€æŸ¥å’Œè°ƒæ•´ã€‚</span><br>typecheck.FixMethodCall(call)<br>&#125;<br></code></pre></td></tr></table></figure><ol type="1"><li><strong>æ£€æŸ¥æ˜¯å¦ä¸ºæ¥å£æ–¹æ³•è°ƒç”¨</strong>ï¼šå‡½æ•°é¦–å…ˆåˆ¤æ–­ä¼ å…¥çš„è°ƒç”¨æ˜¯å¦æ˜¯æ¥å£æ–¹æ³•è°ƒç”¨ï¼ˆ<code>ir.OCALLINTER</code>ï¼‰ï¼Œè¿™æ˜¯å»è™šæ‹ŸåŒ–çš„å‰ææ¡ä»¶ã€‚</li><li><strong>å¤„ç†å½¢çŠ¶ç±»å‹</strong>ï¼šä»£ç ä¸­æåˆ°ï¼Œå¦‚æœæ¥æ”¶å™¨çš„ç±»å‹æ˜¯å½¢çŠ¶ç±»å‹ï¼ˆç”¨äºæ³›å‹ï¼‰ï¼Œåˆ™æ— æ³•å»è™šæ‹ŸåŒ–ï¼Œå› ä¸ºè¿™éœ€è¦é€šè¿‡å­—å…¸è¿›è¡Œé—´æ¥è°ƒç”¨ã€‚</li><li><strong>å¤„ç†å½¢çŠ¶ç±»å‹çš„æ¥æ”¶å™¨</strong>ï¼šå¦‚æœæ¥æ”¶å™¨çš„ç±»å‹å…·æœ‰å½¢çŠ¶ç±»å‹ï¼Œåˆ™å½“å‰æ— æ³•è¿›è¡Œå»è™šæ‹ŸåŒ–ã€‚æ³¨é‡Šä¸­è¿˜æåˆ°äº†ä¸€äº›å¾…å®ç°ï¼ˆTODOï¼‰çš„ä¼˜åŒ–ç‚¹ï¼Œä¾‹å¦‚å¤„ç†éæ³›å‹çš„æå‡æ–¹æ³•ã€‚</li><li><strong>å¤„ç†å½¢çŠ¶ç±»å‹çš„æ¥å£</strong>ï¼šå¦‚æœè°ƒç”¨çš„æ¥å£æœ¬èº«æ˜¯ä¸€ä¸ªå½¢çŠ¶ç±»å‹ï¼Œç”±äºæŒ‡é’ˆèº«ä»½çš„ä¸åŒï¼Œç±»å‹æ–­è¨€å¯èƒ½ä¼šå¤±è´¥ï¼Œå› æ­¤åœ¨è¿™ç§æƒ…å†µä¸‹ä¹Ÿæ— æ³•å»è™šæ‹ŸåŒ–ã€‚</li><li><strong>è½¬æ¢æ–¹æ³•è°ƒç”¨</strong>ï¼šæ ¹æ®è°ƒç”¨çš„å…·ä½“æƒ…å†µï¼Œå°†æ¥å£æ–¹æ³•è°ƒç”¨è½¬æ¢ä¸ºç›´æ¥çš„æ–¹æ³•è°ƒç”¨ï¼ˆ<code>OCALLMETH</code>ï¼‰æˆ–ä¿ç•™ä¸ºæ¥å£æ–¹æ³•è°ƒç”¨ï¼ˆ<code>OCALLINTER</code>ï¼‰ã€‚</li><li><strong>æ›´æ–°è°ƒç”¨ç±»å‹</strong>ï¼šä¸ºäº†æ­£ç¡®å¤„ç†å‡½æ•°è¿”å›å€¼ï¼Œéœ€è¦æ›´æ–°è°ƒç”¨çš„ç±»å‹ï¼Œç¡®ä¿å‚æ•°å¤§å°å’Œæ ˆåç§»é‡æ­£ç¡®ã€‚</li><li><strong>åç³–åŒ–æ–¹æ³•è°ƒç”¨</strong>ï¼šå¦‚æœåˆ›å»ºäº†ç›´æ¥æ–¹æ³•è°ƒç”¨ï¼Œéœ€è¦å¯¹å…¶è¿›è¡Œåç»­çš„ç±»å‹æ£€æŸ¥å’Œè°ƒæ•´ã€‚</li></ol><h2 id="å‡½æ•°å†…è”">å‡½æ•°å†…è”</h2><p>å‡½æ•°å†…è”æ˜¯å°†ä¸€ä¸ªå‡½æ•°çš„ä»£ç ç›´æ¥æ’å…¥åˆ°æ¯ä¸ªè°ƒç”¨ç‚¹ï¼Œè€Œä¸æ˜¯è¿›è¡Œå¸¸è§„çš„å‡½æ•°è°ƒç”¨ã€‚è¿™æ„å‘³ç€å‡½æ•°çš„æ•´ä¸ªä½“è¢«å¤åˆ¶åˆ°æ¯ä¸ªè°ƒç”¨è¯¥å‡½æ•°çš„åœ°æ–¹ã€‚</p><p>ä¼˜ç‚¹ï¼š</p><ul><li><strong>å‡å°‘å¼€é”€</strong>ï¼šå†…è”æ¶ˆé™¤äº†å‡½æ•°è°ƒç”¨çš„å¼€é”€ï¼Œå¦‚å‚æ•°ä¼ é€’ã€æ ˆæ“ä½œç­‰ã€‚</li><li><strong>æå‡æ€§èƒ½</strong>ï¼šæœ‰åŠ©äºå…¶ä»–ä¼˜åŒ–ï¼Œæ¯”å¦‚å¾ªç¯å±•å¼€ã€å¸¸é‡ä¼ æ’­ï¼Œå› ä¸ºç¼–è¯‘å™¨å¯ä»¥çœ‹åˆ°å‡½æ•°ä½“å†…çš„ä»£ç ã€‚</li></ul><p>é€‰æ‹©å“ªäº›å‡½æ•°å†…è”ï¼š</p><ul><li><strong>å°å‡½æ•°</strong>ï¼šé€šå¸¸æ˜¯å°å‡½æ•°ï¼Œå› ä¸ºå®ƒä»¬çš„å†…è”å¸¦æ¥çš„æ€§èƒ½æå‡ç›¸å¯¹äºä»£ç è†¨èƒ€çš„ä»£ä»·æ¥è¯´æ˜¯å€¼å¾—çš„ã€‚</li><li><strong>è°ƒç”¨é¢‘ç‡é«˜çš„å‡½æ•°</strong>ï¼šè¿™äº›å‡½æ•°å¦‚æœå†…è”ï¼Œå¯ä»¥æ˜¾è‘—å‡å°‘è¿è¡Œæ—¶çš„è°ƒç”¨å¼€é”€ã€‚</li></ul><p>åœ¨ Go è¯­è¨€ä¸­ï¼Œå¯ä»¥é€šè¿‡ <code>//go:noinline</code>æ¥ç¦æ­¢å‡½æ•°å†…è”ã€‚</p><p>è¿™éƒ¨åˆ†çš„ä¸»è¦å®ç°åœ¨ <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/cmd/compile/internal~/inl.go">inline.inl.go</a>ï¼Œæ ¸å¿ƒå‡½æ•°æ˜¯ï¼š<code>CanInline()</code>å’Œ <code>InlineImpossible()</code>ã€‚</p><h3 id="caninline">CanInline()</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Inlining budget parameters, gathered in one place</span><br><span class="hljs-keyword">const</span> (<br>    <span class="hljs-comment">// budget æ˜¯å†…è”å¤æ‚åº¦çš„è¡¡é‡ï¼Œ</span><br>    <span class="hljs-comment">// è¶…è¿‡ 80 è¡¨ç¤ºç¼–è¯‘å™¨è®¤ä¸ºè¿™ä¸ªå‡½æ•°å¤ªå¤æ‚äº†ï¼Œå°±ä¸è¿›è¡Œå‡½æ•°å†…è”äº†</span><br>inlineMaxBudget       = <span class="hljs-number">80</span><br>)<br><br><span class="hljs-comment">// CanInline ç”¨äºåˆ¤æ–­ fn æ˜¯å¦å¯å†…è”ã€‚</span><br><span class="hljs-comment">// å¦‚æœå¯ä»¥ï¼Œä¼šå°† fn.Body å’Œ fn.Dcl æ‹·è´ä¸€ä»½æ”¾åˆ° fn.Inlï¼Œ</span><br><span class="hljs-comment">// å…¶ä¸­ fn å’Œ fn.Body éœ€è¦ç¡®ä¿å·²ç»ç»è¿‡ç±»å‹æ£€æŸ¥äº†ã€‚</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CanInline</span><span class="hljs-params">(fn *ir.Func, profile *pgo.Profile)</span></span> &#123;<br>    <br>    <span class="hljs-comment">// å‡½æ•°åå¿…é¡»æœ‰æ•ˆ</span><br><span class="hljs-keyword">if</span> fn.Nname == <span class="hljs-literal">nil</span> &#123;<br>base.Fatalf(<span class="hljs-string">&quot;CanInline no nname %+v&quot;</span>, fn)<br>&#125;<br><br>    <span class="hljs-comment">// å¦‚æœä¸èƒ½å†…è”ï¼Œè¾“å‡ºåŸå› </span><br><span class="hljs-keyword">var</span> reason <span class="hljs-type">string</span><br><span class="hljs-keyword">if</span> base.Flag.LowerM &gt; <span class="hljs-number">1</span> || logopt.Enabled() &#123;<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> reason != <span class="hljs-string">&quot;&quot;</span> &#123;<br><span class="hljs-keyword">if</span> base.Flag.LowerM &gt; <span class="hljs-number">1</span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;%v: cannot inline %v: %s\n&quot;</span>, ir.Line(fn), fn.Nname, reason)<br>&#125;<br><span class="hljs-keyword">if</span> logopt.Enabled() &#123;<br>logopt.LogOpt(fn.Pos(), <span class="hljs-string">&quot;cannotInlineFunction&quot;</span>, <span class="hljs-string">&quot;inline&quot;</span>, ir.FuncName(fn), reason)<br>&#125;<br>&#125;<br>&#125;()<br>&#125;<br><br>    <span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦ç¬¦åˆä¸å¯èƒ½å†…è”çš„æƒ…å†µï¼Œå¦‚æœè¿”å›çš„ reason ä¸ä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºæœ‰ä¸å¯ä»¥å†…è”çš„åŸå› </span><br>reason = InlineImpossible(fn)<br><span class="hljs-keyword">if</span> reason != <span class="hljs-string">&quot;&quot;</span> &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">if</span> fn.Typecheck() == <span class="hljs-number">0</span> &#123;<br>base.Fatalf(<span class="hljs-string">&quot;CanInline on non-typechecked function %v&quot;</span>, fn)<br>&#125;<br><br>n := fn.Nname<br><span class="hljs-keyword">if</span> n.Func.InlinabilityChecked() &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">defer</span> n.Func.SetInlinabilityChecked(<span class="hljs-literal">true</span>)<br><br>cc := <span class="hljs-type">int32</span>(inlineExtraCallCost)<br><span class="hljs-keyword">if</span> base.Flag.LowerL == <span class="hljs-number">4</span> &#123;<br>cc = <span class="hljs-number">1</span> <span class="hljs-comment">// this appears to yield better performance than 0.</span><br>&#125;<br><br><span class="hljs-comment">// è®¾ç½®å†…è”é¢„ç®—ï¼Œåé¢å¦‚æœæ£€æŸ¥å‡½æ•°çš„å¤æ‚åº¦è¶…è¿‡é¢„ç®—äº†ï¼Œå°±ä¸å†…è”äº†</span><br>budget := <span class="hljs-type">int32</span>(inlineMaxBudget)<br><span class="hljs-keyword">if</span> profile != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">if</span> n, ok := profile.WeightedCG.IRNodes[ir.LinkFuncName(fn)]; ok &#123;<br><span class="hljs-keyword">if</span> _, ok := candHotCalleeMap[n]; ok &#123;<br>budget = <span class="hljs-type">int32</span>(inlineHotMaxBudget)<br><span class="hljs-keyword">if</span> base.Debug.PGODebug &gt; <span class="hljs-number">0</span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;hot-node enabled increased budget=%v for func=%v\n&quot;</span>, budget, ir.PkgFuncName(fn))<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br><br>    <span class="hljs-comment">// éå†å‡½æ•°ä½“ï¼Œè®¡ç®—å¤æ‚åº¦ï¼Œåˆ¤æ–­æ˜¯å¦è¶…è¿‡å†…è”é¢„ç®—</span><br>visitor := hairyVisitor&#123;<br>curFunc:       fn,<br>budget:        budget,<br>maxBudget:     budget,<br>extraCallCost: cc,<br>profile:       profile,<br>&#125;<br><span class="hljs-keyword">if</span> visitor.tooHairy(fn) &#123;<br>reason = visitor.reason<br><span class="hljs-keyword">return</span><br>&#125;<br><br>    <span class="hljs-comment">// å‰é¢æ£€æŸ¥éƒ½æ²¡é—®é¢˜ï¼Œåˆ™æ ‡è®°ä¸ºå¯ä»¥å†…è”ï¼Œå¹¶å¤åˆ¶å…¶å‡½æ•°ä½“å’Œå£°æ˜åˆ°å†…è”ç»“æ„ä½“ä¸­</span><br>n.Func.Inl = &amp;ir.Inline&#123;<br>Cost: budget - visitor.budget,<br>Dcl:  pruneUnusedAutos(n.Defn.(*ir.Func).Dcl, &amp;visitor),<br>Body: inlcopylist(fn.Body),<br><br>CanDelayResults: canDelayResults(fn),<br>&#125;<br><br>    <span class="hljs-comment">// æ—¥å¿—å’Œè°ƒè¯•</span><br><span class="hljs-keyword">if</span> base.Flag.LowerM &gt; <span class="hljs-number">1</span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;%v: can inline %v with cost %d as: %v &#123; %v &#125;\n&quot;</span>, ir.Line(fn), n, budget-visitor.budget, fn.Type(), ir.Nodes(n.Func.Inl.Body))<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> base.Flag.LowerM != <span class="hljs-number">0</span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;%v: can inline %v\n&quot;</span>, ir.Line(fn), n)<br>&#125;<br><span class="hljs-keyword">if</span> logopt.Enabled() &#123;<br>logopt.LogOpt(fn.Pos(), <span class="hljs-string">&quot;canInlineFunction&quot;</span>, <span class="hljs-string">&quot;inline&quot;</span>, ir.FuncName(fn), fmt.Sprintf(<span class="hljs-string">&quot;cost: %d&quot;</span>, budget-visitor.budget))<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol type="1"><li><strong>åŸºæœ¬æ£€æŸ¥</strong>ï¼šéªŒè¯å‡½æ•°æ˜¯å¦å·²ç»è¿›è¡Œäº†ç±»å‹æ£€æŸ¥ï¼Œä»¥åŠå‡½æ•°åæ˜¯å¦æœ‰æ•ˆã€‚</li><li><strong>åˆ¤æ–­æ˜¯å¦å¯ä»¥å†…è”</strong>ï¼šè°ƒç”¨<code>InlineImpossible</code>å‡½æ•°æ¥æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•åŸºæœ¬çš„é™åˆ¶æ¡ä»¶é˜»æ­¢å†…è”ï¼ˆä¾‹å¦‚å‡½æ•°å¤ªå¤§ã€é€’å½’ç­‰ï¼‰ã€‚</li><li><strong>å†…è”é¢„ç®—è®¾ç½®</strong>ï¼šæ ¹æ®å‡½æ•°çš„ç‰¹å¾å’Œå¯èƒ½çš„æ€§èƒ½å‰–æä¿¡æ¯æ¥è®¾å®šå†…è”é¢„ç®—ã€‚è¿™ä¸ªé¢„ç®—æ˜¯å†…è”å†³ç­–çš„å…³é”®å‚æ•°ä¹‹ä¸€ã€‚</li><li><strong>è¯¦ç»†åˆ†æ</strong>ï¼š<code>hairyVisitor</code>ç»“æ„ç”¨äºéå†å‡½æ•°ä½“ï¼Œåˆ¤æ–­æ˜¯å¦è¶…å‡ºäº†å†…è”é¢„ç®—ã€‚è¿™æ¶‰åŠå¯¹å‡½æ•°ä½“çš„å¤æ‚åº¦å’Œå¤§å°çš„è¯„ä¼°ã€‚</li><li><strong>å†…è”å†³ç­–</strong>ï¼šå¦‚æœå‡½æ•°é€šè¿‡äº†æ‰€æœ‰æ£€æŸ¥å¹¶ä¸”æœªè¶…å‡ºé¢„ç®—ï¼Œåˆ™æ ‡è®°ä¸ºå¯ä»¥å†…è”ï¼Œå¹¶å¤åˆ¶å…¶å‡½æ•°ä½“å’Œå£°æ˜ï¼ˆDclï¼‰åˆ°å†…è”ç»“æ„ä½“ä¸­ã€‚</li><li><strong>æ—¥å¿—å’Œè°ƒè¯•</strong>ï¼šæ ¹æ®ç¼–è¯‘å™¨çš„æ—¥å¿—çº§åˆ«ï¼Œè¾“å‡ºå…³äºå†…è”å†³ç­–çš„è¯¦ç»†ä¿¡æ¯ï¼Œä¾‹å¦‚ä¸ºä»€ä¹ˆä¸€ä¸ªå‡½æ•°ä¸èƒ½è¢«å†…è”æˆ–è€…å®ƒçš„å†…è”æˆæœ¬æ˜¯å¤šå°‘ã€‚</li></ol><h3 id="inlineimpossible">InlineImpossible()</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InlineImpossible</span><span class="hljs-params">(fn *ir.Func)</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">var</span> reason <span class="hljs-type">string</span> <span class="hljs-comment">// reason, if any, that the function can not be inlined.</span><br><span class="hljs-keyword">if</span> fn.Nname == <span class="hljs-literal">nil</span> &#123;<br>reason = <span class="hljs-string">&quot;no name&quot;</span><br><span class="hljs-keyword">return</span> reason<br>&#125;<br><br><span class="hljs-comment">// If marked &quot;go:noinline&quot;, don&#x27;t inline.</span><br><span class="hljs-keyword">if</span> fn.Pragma&amp;ir.Noinline != <span class="hljs-number">0</span> &#123;<br>reason = <span class="hljs-string">&quot;marked go:noinline&quot;</span><br><span class="hljs-keyword">return</span> reason<br>&#125;<br><br><span class="hljs-comment">// If marked &quot;go:norace&quot; and -race compilation, don&#x27;t inline.</span><br><span class="hljs-keyword">if</span> base.Flag.Race &amp;&amp; fn.Pragma&amp;ir.Norace != <span class="hljs-number">0</span> &#123;<br>reason = <span class="hljs-string">&quot;marked go:norace with -race compilation&quot;</span><br><span class="hljs-keyword">return</span> reason<br>&#125;<br><br><span class="hljs-comment">// If marked &quot;go:nocheckptr&quot; and -d checkptr compilation, don&#x27;t inline.</span><br><span class="hljs-keyword">if</span> base.Debug.Checkptr != <span class="hljs-number">0</span> &amp;&amp; fn.Pragma&amp;ir.NoCheckPtr != <span class="hljs-number">0</span> &#123;<br>reason = <span class="hljs-string">&quot;marked go:nocheckptr&quot;</span><br><span class="hljs-keyword">return</span> reason<br>&#125;<br><br><span class="hljs-comment">// If marked &quot;go:cgo_unsafe_args&quot;, don&#x27;t inline, since the function</span><br><span class="hljs-comment">// makes assumptions about its argument frame layout.</span><br><span class="hljs-keyword">if</span> fn.Pragma&amp;ir.CgoUnsafeArgs != <span class="hljs-number">0</span> &#123;<br>reason = <span class="hljs-string">&quot;marked go:cgo_unsafe_args&quot;</span><br><span class="hljs-keyword">return</span> reason<br>&#125;<br><br><span class="hljs-comment">// If marked as &quot;go:uintptrkeepalive&quot;, don&#x27;t inline, since the keep</span><br><span class="hljs-comment">// alive information is lost during inlining.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// TODO(prattmic): This is handled on calls during escape analysis,</span><br><span class="hljs-comment">// which is after inlining. Move prior to inlining so the keep-alive is</span><br><span class="hljs-comment">// maintained after inlining.</span><br><span class="hljs-keyword">if</span> fn.Pragma&amp;ir.UintptrKeepAlive != <span class="hljs-number">0</span> &#123;<br>reason = <span class="hljs-string">&quot;marked as having a keep-alive uintptr argument&quot;</span><br><span class="hljs-keyword">return</span> reason<br>&#125;<br><br><span class="hljs-comment">// If marked as &quot;go:uintptrescapes&quot;, don&#x27;t inline, since the escape</span><br><span class="hljs-comment">// information is lost during inlining.</span><br><span class="hljs-keyword">if</span> fn.Pragma&amp;ir.UintptrEscapes != <span class="hljs-number">0</span> &#123;<br>reason = <span class="hljs-string">&quot;marked as having an escaping uintptr argument&quot;</span><br><span class="hljs-keyword">return</span> reason<br>&#125;<br><br><span class="hljs-comment">// The nowritebarrierrec checker currently works at function</span><br><span class="hljs-comment">// granularity, so inlining yeswritebarrierrec functions can confuse it</span><br><span class="hljs-comment">// (#22342). As a workaround, disallow inlining them for now.</span><br><span class="hljs-keyword">if</span> fn.Pragma&amp;ir.Yeswritebarrierrec != <span class="hljs-number">0</span> &#123;<br>reason = <span class="hljs-string">&quot;marked go:yeswritebarrierrec&quot;</span><br><span class="hljs-keyword">return</span> reason<br>&#125;<br><br><span class="hljs-comment">// If a local function has no fn.Body (is defined outside of Go), cannot inline it.</span><br><span class="hljs-comment">// Imported functions don&#x27;t have fn.Body but might have inline body in fn.Inl.</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(fn.Body) == <span class="hljs-number">0</span> &amp;&amp; !typecheck.HaveInlineBody(fn) &#123;<br>reason = <span class="hljs-string">&quot;no function body&quot;</span><br><span class="hljs-keyword">return</span> reason<br>&#125;<br><br><span class="hljs-comment">// If fn is synthetic hash or eq function, cannot inline it.</span><br><span class="hljs-comment">// The function is not generated in Unified IR frontend at this moment.</span><br><span class="hljs-keyword">if</span> ir.IsEqOrHashFunc(fn) &#123;<br>reason = <span class="hljs-string">&quot;type eq/hash function&quot;</span><br><span class="hljs-keyword">return</span> reason<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><ol type="1"><li><strong>æ— å‡½æ•°å</strong>ï¼šå¦‚æœå‡½æ•°æ²¡æœ‰åå­—ï¼Œä¸èƒ½å†…è”ã€‚</li><li><strong>æœ‰ <code>go:noinline</code>æŒ‡ä»¤</strong>ï¼šæ˜¾å¼æ ‡è®°ä¸ºä¸å†…è”ã€‚</li><li><strong>æœ‰ <code>go:norace</code> æŒ‡ä»¤å¹¶åœ¨ <code>-race</code>ç¼–è¯‘æ¨¡å¼ä¸‹</strong>ï¼šåœ¨ç«æ€æ£€æµ‹ç¼–è¯‘æ¨¡å¼ä¸‹ä¸å†…è”æ ‡è®°ä¸º<code>norace</code> çš„å‡½æ•°ã€‚</li><li><strong>æœ‰ <code>go:nocheckptr</code> æŒ‡ä»¤å¹¶åœ¨<code>-d checkptr</code>ç¼–è¯‘æ¨¡å¼ä¸‹</strong>ï¼šåœ¨æŒ‡é’ˆæ£€æŸ¥ç¼–è¯‘æ¨¡å¼ä¸‹ä¸å†…è”æ ‡è®°ä¸º<code>nocheckptr</code> çš„å‡½æ•°ã€‚</li><li><strong>æœ‰ <code>go:cgo_unsafe_args</code> æŒ‡ä»¤</strong>ï¼šå¯¹äºæ ‡è®°ä¸º<code>cgo_unsafe_args</code> çš„å‡½æ•°ï¼Œç”±äºå‚æ•°å¸ƒå±€çš„å‡è®¾ï¼Œä¸å†…è”ã€‚</li><li><strong>æœ‰ <code>go:uintptrkeepalive</code>æŒ‡ä»¤</strong>ï¼šä¸å†…è”æ ‡è®°ä¸º <code>uintptrkeepalive</code> çš„å‡½æ•°ã€‚</li><li><strong>æœ‰ <code>go:uintptrescapes</code>æŒ‡ä»¤</strong>ï¼šä¸å†…è”æ ‡è®°ä¸º <code>uintptrescapes</code> çš„å‡½æ•°ã€‚</li><li><strong>æœ‰ <code>go:yeswritebarrierrec</code>æŒ‡ä»¤</strong>ï¼šä¸ºäº†é˜²æ­¢å†™å±éšœè®°å½•æ£€æŸ¥å™¨çš„æ··æ·†ï¼Œä¸å†…è”æ ‡è®°ä¸º<code>yeswritebarrierrec</code> çš„å‡½æ•°ã€‚</li><li><strong>æ— å‡½æ•°ä½“</strong>ï¼šæœ¬åœ°å®šä¹‰ä½†æ²¡æœ‰å‡½æ•°ä½“çš„å‡½æ•°ï¼ˆå¤–éƒ¨å®šä¹‰çš„ Goå‡½æ•°ï¼‰ä¸å¯å†…è”ã€‚</li><li><strong>æ˜¯åˆæˆçš„ hash æˆ– eqå‡½æ•°</strong>ï¼šä¸èƒ½å†…è”è¿™äº›ç±»å‹çš„å‡½æ•°ã€‚</li></ol><h3 id="ä¸¾ä¾‹-1">ä¸¾ä¾‹</h3><p>æˆ‘ä»¬é€šè¿‡ä¸€æ®µä»£ç æ¥çœ‹çœ‹ç¼–è¯‘å™¨çš„å‡½æ•°å†…è”æƒ…å†µã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SayHello</span><span class="hljs-params">()</span></span> <span class="hljs-type">string</span> &#123;<br>s := <span class="hljs-string">&quot;hello, &quot;</span> + <span class="hljs-string">&quot;world&quot;</span><br><span class="hljs-keyword">return</span> s<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Fib</span><span class="hljs-params">(index <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br><span class="hljs-keyword">if</span> index &lt; <span class="hljs-number">2</span> &#123;<br><span class="hljs-keyword">return</span> index<br>&#125;<br><span class="hljs-keyword">return</span> Fib(index<span class="hljs-number">-1</span>) + Fib(index<span class="hljs-number">-2</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ForSearch</span><span class="hljs-params">()</span></span> <span class="hljs-type">int</span> &#123;<br><span class="hljs-keyword">var</span> s = []<span class="hljs-type">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">0</span>&#125;<br>res := <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(s); i++ &#123;<br><span class="hljs-keyword">if</span> s[i] == i &#123;<br>res = i<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> res<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>SayHello()<br>Fib(<span class="hljs-number">65</span>)<br>ForSearch()<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ç¼–è¯‘æ—¶æˆ‘ä»¬å¯ä»¥åŠ å…¥ <code>-m=2</code>æ ‡ç­¾ï¼Œæ¥æ‰“å°å‡½æ•°çš„å†…è”è°ƒè¯•ä¿¡æ¯ã€‚åœ¨ <code>main.go</code> ç›®å½•ä¸‹æ‰§è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go tool compile -m=2 main.go<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">main.go:3:6: can inline SayHello with cost 7 as: func() string &#123; s := <span class="hljs-string">&quot;hello, &quot;</span> + <span class="hljs-string">&quot;world&quot;</span>; <span class="hljs-built_in">return</span> s &#125;<br>main.go:8:6: cannot inline Fib: recursive<br>main.go:15:6: can inline ForSearch with cost 45 as: func() int &#123; s := []int&#123;...&#125;; res := 0; <span class="hljs-keyword">for</span> loop; <span class="hljs-built_in">return</span> res &#125;<br>main.go:26:6: cannot inline main: <span class="hljs-keyword">function</span> too complex: cost 116 exceeds budget 80<br>main.go:27:10: inlining call to SayHello<br>main.go:29:11: inlining call to ForSearch<br>main.go:16:15: []int&#123;...&#125; does not escape<br>main.go:29:11: []int&#123;...&#125; does not escape<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° <code>SayHello()</code> å’Œ <code>ForSearch</code>éƒ½è¢«å†…è”äº†ï¼Œè€Œ <code>Fib()</code> å› ä¸ºæœ‰é€’å½’ï¼Œæ‰€ä»¥ä¸ä¼šè¢«å†…è”ã€‚</p><h2 id="é€ƒé€¸åˆ†æ">é€ƒé€¸åˆ†æ</h2><p>é€ƒé€¸åˆ†ææ˜¯ Goè¯­è¨€ä¸­éå¸¸é‡è¦çš„ä¼˜åŒ–é˜¶æ®µï¼Œ<strong>ç”¨äºæ ‡è¯†å˜é‡å†…å­˜åº”è¯¥è¢«åˆ†é…åœ¨æ ˆä¸Šè¿˜æ˜¯å †ä¸Š</strong>ã€‚</p><p>åœ¨ä¼ ç»Ÿçš„ C æˆ– C++å¼€å‘ä¸­ï¼Œå¼€å‘è€…ç»å¸¸ä¼šçŠ¯çš„é”™è¯¯å°±æ˜¯å‡½æ•°è¿”å›äº†ä¸€ä¸ªæ ˆä¸Šçš„å¯¹è±¡æŒ‡é’ˆï¼Œåœ¨å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œå‡½æ•°æ ˆä¼šè¢«é”€æ¯ï¼Œå¦‚æœç»§ç»­è®¿é—®è¢«é”€æ¯æ ˆä¸Šçš„å¯¹è±¡æŒ‡é’ˆï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°é—®é¢˜ã€‚</p><p>Goè¯­è¨€èƒ½å¤Ÿé€šè¿‡ç¼–è¯‘æ—¶çš„é€ƒé€¸åˆ†æè¯†åˆ«è¿™ç§é—®é¢˜ï¼Œè‡ªåŠ¨å°†è¿™ç±»å˜é‡æ”¾ç½®åˆ°å †åŒºï¼Œå¹¶å€ŸåŠ©Goè¿è¡Œæ—¶çš„åƒåœ¾å›æ”¶æœºåˆ¶è‡ªåŠ¨é‡Šæ”¾å†…å­˜ã€‚ç¼–è¯‘å™¨ä¼šå°½å¯èƒ½åœ°å°†å˜é‡æ”¾ç½®åœ¨æ ˆä¸Šï¼Œå› ä¸ºæ ˆä¸­çš„å¯¹è±¡ä¼šéšç€å‡½æ•°è°ƒç”¨ç»“æŸè¢«è‡ªåŠ¨é”€æ¯ï¼Œè¿™å¯ä»¥å‡è½»è¿è¡Œæ—¶åˆ†é…å’Œåƒåœ¾å›æ”¶çš„è´Ÿæ‹…ã€‚</p><p>åœ¨ Goè¯­è¨€ä¸­ï¼Œå¼€å‘è€…æ¨¡ç³Šäº†æ ˆåŒºå’Œå †åŒºçš„åŒºåˆ«ï¼Œä¸ç®¡æ˜¯å­—ç¬¦ä¸²ã€æ•°ç»„å­—é¢é‡ï¼Œè¿˜æ˜¯é€šè¿‡newã€makeæ ‡è¯†ç¬¦åˆ›å»ºçš„å¯¹è±¡ï¼Œéƒ½æ—¢å¯èƒ½è¢«åˆ†é…åˆ°æ ˆä¸Šï¼Œä¹Ÿå¯èƒ½è¢«åˆ†é…åˆ°å †ä¸Šã€‚ä½†æ˜¯ï¼Œæ•´ä½“ä¸Šä¼šéµå¾ª2 ä¸ªåŸåˆ™ï¼š</p><ol type="1"><li>æŒ‡å‘æ ˆä¸Šå¯¹è±¡çš„æŒ‡é’ˆä¸èƒ½è¢«å­˜å‚¨åˆ°å †ä¸Šï¼›</li><li>æŒ‡å‘æ ˆä¸Šå¯¹è±¡çš„æŒ‡é’ˆä¸èƒ½è¶…è¿‡è¯¥æ ˆå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚</li></ol><p>è¿™éƒ¨åˆ†çš„ä»£ç ä¸»è¦åœ¨ <ahref="https://github.com/golang/go/tree/release-branch.go1.21/src/cmd/compile/internal/escape">escape</a>ã€‚</p><h3 id="åˆ†æè¿‡ç¨‹">åˆ†æè¿‡ç¨‹</h3><p>Go è¯­è¨€é€šè¿‡å¯¹ AST çš„é™æ€æ•°æ®æµåˆ†ææ¥å®ç°é€ƒé€¸åˆ†æï¼ˆ<ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/cmd/compile/internal/escape/graph.go">escape/graph.go</a>ï¼‰ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ï¼Œå®ƒä¼šæ„å»ºå¸¦æƒé‡çš„æœ‰å‘å›¾ï¼Œå…¶ä¸­æƒé‡å¯ä»¥è¡¨é¢å½“å‰å˜é‡å¼•ç”¨å’Œè§£å¼•ç”¨çš„æ•°é‡ã€‚</p><ul><li>å¼•ç”¨ï¼ˆ&amp;aï¼‰ å‡ 1</li><li>è§£å¼•ç”¨ï¼ˆ*aï¼‰åŠ  1</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(k hole)</span></span> deref(where ir.Node, why <span class="hljs-type">string</span>) hole &#123; <span class="hljs-keyword">return</span> k.shift(<span class="hljs-number">1</span>).note(where, why) &#125; <span class="hljs-comment">// è§£å¼•ç”¨</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(k hole)</span></span> addr(where ir.Node, why <span class="hljs-type">string</span>) hole  &#123; <span class="hljs-keyword">return</span> k.shift(<span class="hljs-number">-1</span>).note(where, why) &#125; <span class="hljs-comment">// å¼•ç”¨</span><br></code></pre></td></tr></table></figure><p>å…·ä½“æ¥è¯´ï¼ŒGoé€ƒé€¸åˆ†æä¼šæŒ‰ç…§å¦‚ä¸‹è§„åˆ™ç”Ÿæˆæ•°æ®æµå›¾ï¼ˆå¸¦æƒé‡çš„æœ‰å‘å›¾ï¼‰ï¼š</p><ol type="1"><li>æ¯ä¸ªå˜é‡ä½œä¸ºä¸€ä¸ªèŠ‚ç‚¹ï¼ˆlocationï¼‰ï¼›</li><li>æ¯ä¸ªèµ‹å€¼åŠ¨ä½œæ˜¯ä¸€ä¸ªæœ‰å‘è¾¹ï¼ˆedgeï¼‰ï¼Œèµ‹å€¼ç»™è°åˆ™æŒ‡å‘è°ï¼›</li><li>è§£å¼•ç”¨ï¼ˆderefï¼‰ï¼Œå³ <code>*</code>æ“ä½œä¼šç»™è¾¹çš„æƒé‡ +1ï¼›</li><li>å¼•ç”¨ï¼ˆaddrï¼‰ï¼Œå³ <code>&amp;</code> æ“ä½œä¼šç»™è¾¹æƒé‡ -1ã€‚</li></ol><p>å…¶ä¸­ï¼š<strong>èŠ‚ç‚¹æƒé‡ = æŒ‡å‘çš„èŠ‚ç‚¹æƒé‡ + è¾¹æƒé‡</strong></p><p>é€ƒé€¸åˆ†æçš„ç›®æ ‡å°±æ˜¯<strong>æ‰¾åˆ°å…¶ä¸­èŠ‚ç‚¹æƒé‡ä¸º -1çš„å˜é‡</strong>ï¼Œå¹¶ç»“åˆä¸Šè¿°æåˆ°çš„ 2ä¸ªåŸåˆ™ï¼Œæ¥åˆ¤æ–­è¦ä¸è¦å°†å˜é‡åˆ†é…åˆ°å †ä¸Šã€‚</p><h3 id="åˆ†æå®ä¾‹">åˆ†æå®ä¾‹</h3><p>æˆ‘ä»¬ä¸¾ä¸€ä¸ªä¾‹å­æ¥è¿›è¡Œåˆ†æï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><span class="hljs-keyword">var</span> o *<span class="hljs-type">int</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>l := <span class="hljs-built_in">new</span>(<span class="hljs-type">int</span>) <br>*l = <span class="hljs-number">42</span><br>m := &amp;l<br>n := &amp;m<br>o = **n<br>&#125;<br></code></pre></td></tr></table></figure><p>å†æ¬¡å›é¡¾ä¸€ä¸‹ï¼Œ<code>*</code> æ˜¯åŠ  1ï¼Œ<code>&amp;</code>æ˜¯å‡ä¸€ã€‚æŒ‰ç…§å¸¸è§„æ€è·¯ï¼Œæˆ‘ä»¬ä»ä¸Šå¾€ä¸‹åˆ†æï¼š</p><p>å…ˆç”»å‡ºèŠ‚ç‚¹çš„èµ‹å€¼é¡ºåºï¼Œèµ‹å€¼ç»™è°ï¼Œè¾¹å°±æŒ‡å‘è°ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20231203193913047.png"alt="ç¬¬1æ­¥ï¼šæ¢³ç†èŠ‚ç‚¹é¡ºåº" /><figcaption aria-hidden="true">ç¬¬1æ­¥ï¼šæ¢³ç†èŠ‚ç‚¹é¡ºåº</figcaption></figure><p>ç„¶åæ ¹æ®å¼•ç”¨å’Œè§£å¼•ç”¨ç»™è¾¹èµ‹æƒé‡ï¼Œå› ä¸º <code>new(int)</code>å…¶å®å°±æ˜¯åˆ†é…ä¸€ä¸ª <code>int(0)</code> å¹¶å–åœ°å€ï¼Œç›¸å½“äº<code>&amp;</code>ï¼Œæ‰€ä»¥æŒ‡å‘ <code>l</code> çš„è¾¹æƒé‡æ˜¯<code>-1</code>ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20231203194101882.png"alt="ç¬¬2æ­¥ï¼šç»™è¾¹èµ‹å€¼" /><figcaption aria-hidden="true">ç¬¬2æ­¥ï¼šç»™è¾¹èµ‹å€¼</figcaption></figure><p>èŠ‚ç‚¹æƒé‡ = è¾¹æƒé‡ + æŒ‡å‘èŠ‚ç‚¹æƒé‡ï¼Œå› ä¸ºæ²¡æœ‰å¯¹ <code>o</code>å˜é‡è¿›è¡Œä»»ä½•çš„æ“ä½œï¼Œæ‰€ä»¥ <code>o</code> æƒé‡ä¸º0ï¼Œä»å³å¾€å·¦æ¨å¯ä»¥å¾—åˆ°ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20231203194432349.png"alt="ç¬¬3æ­¥ï¼šè®¡ç®—èŠ‚ç‚¹æƒé‡" /><figcaption aria-hidden="true">ç¬¬3æ­¥ï¼šè®¡ç®—èŠ‚ç‚¹æƒé‡</figcaption></figure><p>ç»è¿‡åˆ†æï¼Œæˆ‘ä»¬å°±æ‰¾åˆ°äº†èŠ‚ç‚¹æƒé‡ä¸º <code>-1</code> çš„èŠ‚ç‚¹<code>new(int)</code>ï¼Œåˆç”±äºå®ƒçš„èŠ‚ç‚¹å˜é‡åœ°å€æœ€ç»ˆä¼šè¢«ä¼ é€’åˆ°å˜é‡<code>o</code> ä¸Šï¼Œç»“åˆä¹‹å‰çš„ 2 ä¸ªåŸåˆ™ï¼Œ<code>o</code>æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå£°æ˜å‘¨æœŸæ˜¯è¶…è¿‡å‡½æ•°æ ˆçš„ï¼Œæ‰€ä»¥ <code>new(int)</code>ä¼šè¢«åˆ†é…åˆ°å †ä¸Šã€‚</p><p>å¯ä»¥æ‰§è¡Œä¸‹é¢è¯­å¥è¾“å‡ºé€ƒé€¸ç»“æœï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go tool compile -m main.go<br></code></pre></td></tr></table></figure><p>å¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">/escape/main.go:5:6: can inline main<br>/escape/main.go:6:10: new(int) escapes to hea<br></code></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥æ‰§è¡Œä¸‹é¢è¯­å¥è¾“å‡ºæ•°æ®æµå›¾æ„å»ºè¿‡ç¨‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go build -gcflags=<span class="hljs-string">&quot;-m -m -l&quot;</span> main.go<br></code></pre></td></tr></table></figure><p>å¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># command-line-arguments</span><br>./main.go:6:10: new(int) escapes to heap:<br>./main.go:6:10:   flow: l = &amp;&#123;storage <span class="hljs-keyword">for</span> new(int)&#125;:<br>./main.go:6:10:     from new(int) (spill) at ./main.go:6:10<br>./main.go:6:10:     from l := new(int) (assign) at ./main.go:6:4<br>./main.go:6:10:   flow: m = &amp;l:<br>./main.go:6:10:     from &amp;l (address-of) at ./main.go:8:7<br>./main.go:6:10:     from m := &amp;l (assign) at ./main.go:8:4<br>./main.go:6:10:   flow: n = &amp;m:<br>./main.go:6:10:     from &amp;m (address-of) at ./main.go:9:7<br>./main.go:6:10:     from n := &amp;m (assign) at ./main.go:9:4<br>./main.go:6:10:   flow: &#123;heap&#125; = **n:<br>./main.go:6:10:     from *n (indirection) at ./main.go:10:7<br>./main.go:6:10:     from *(*n) (indirection) at ./main.go:10:6<br>./main.go:6:10:     from o = *(*n) (assign) at ./main.go:10:4<br>./main.go:6:10: new(int) escapes to heap<br></code></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬è¯•ä¸€ä¸‹ï¼ŒæŠŠ <code>o</code> æ”¾åœ¨ <code>main()</code>é‡Œé¢å‘¢ï¼Ÿ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> o *<span class="hljs-type">int</span><br>l := <span class="hljs-built_in">new</span>(<span class="hljs-type">int</span>)<br>*l = <span class="hljs-number">42</span><br>m := &amp;l <br>n := &amp;m <br>o = **n <br>o = o   <span class="hljs-comment">// è®©ç¼–è¯‘é€šè¿‡</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œä¸‹é¢è¯­å¥ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go tool compile -m main.go<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">/escape/main.go:3:6: can inline main<br>/escape/main.go:5:10: new(int) does not escape<br></code></pre></td></tr></table></figure><p>å¦‚æˆ‘ä»¬æ‰€æƒ³ï¼Œè™½ç„¶ <code>new(int)</code> çš„æƒé‡ä¸º<code>-1</code>ï¼Œä½†æ˜¯å®ƒçš„å£°æ˜å‘¨æœŸå§‹ç»ˆæ²¡æœ‰è¶…è¿‡<code>main()</code>ï¼Œæ‰€ä»¥æ²¡å¿…è¦é€ƒé€¸åˆ°å †ä¸Šã€‚</p><h2 id="å˜é‡æ•è·">å˜é‡æ•è·</h2><p>å˜é‡æ•è·ä¸»è¦æ˜¯é’ˆå¯¹é—­åŒ…ï¼ˆclosureï¼‰åœºæ™¯è€Œè¨€çš„ï¼Œç”±äºé—­åŒ…å‡½æ•°ä¸­å¯èƒ½å¼•ç”¨é—­åŒ…å¤–çš„å˜é‡ï¼Œå› æ­¤å˜é‡æ•è·éœ€è¦æ˜ç¡®åœ¨é—­åŒ…ä¸­é€šè¿‡å€¼å¼•ç”¨æˆ–è€…åœ°å€å¼•ç”¨çš„æ–¹å¼æ¥æ•è·å˜é‡ã€‚</p><p>è¿™ä¸€è¿‡ç¨‹åœ¨å‰é¢æåˆ°çš„é€ƒé€¸åˆ†æè¿‡ç¨‹ä¸­è¿›è¡Œï¼Œå…·ä½“å®ç°åœ¨ <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/cmd/compile/internal/escape/escape.go">escape/escape.go</a>çš„ <code>flowClosure()</code> å‡½æ•°ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *batch)</span></span> flowClosure(k hole, clo *ir.ClosureExpr) &#123;<br>    <span class="hljs-comment">// éå†é—­åŒ…ä¸­çš„æ‰€æœ‰å˜é‡</span><br>    <span class="hljs-keyword">for</span> _, cv := <span class="hljs-keyword">range</span> clo.Func.ClosureVars &#123;<br>        n := cv.Canonical()<br>        loc := b.oldLoc(cv)<br>        <span class="hljs-comment">// å¦‚æœå˜é‡æœªè¢«æ•è·ï¼Œåˆ™è§¦å‘é”™è¯¯</span><br>        <span class="hljs-keyword">if</span> !loc.captured &#123;<br>            base.FatalfAt(cv.Pos(), <span class="hljs-string">&quot;closure variable never captured: %v&quot;</span>, cv)<br>        &#125;<br><br>        <span class="hljs-comment">// æ ¹æ®å˜é‡çš„ç‰¹æ€§å†³å®šæ˜¯é€šè¿‡å€¼è¿˜æ˜¯å¼•ç”¨æ•è·</span><br>        <span class="hljs-comment">// å¦‚æœå˜é‡æœªè¢«é‡æ–°èµ‹å€¼æˆ–å–å€ï¼Œå¹¶ä¸”å°äºç­‰äº 128 å­—èŠ‚ï¼Œåˆ™é€šè¿‡å€¼æ•è·</span><br>        n.SetByval(!loc.addrtaken &amp;&amp; !loc.reassigned &amp;&amp; n.Type().Size() &lt;= <span class="hljs-number">128</span>)<br>        <span class="hljs-keyword">if</span> !n.Byval() &#123;<br>            n.SetAddrtaken(<span class="hljs-literal">true</span>)<br>            <span class="hljs-comment">// ç‰¹æ®Šæƒ…å†µå¤„ç†ï¼šå­—å…¸å˜é‡ä¸é€šè¿‡å€¼æ•è·</span><br>            <span class="hljs-keyword">if</span> n.Sym().Name == typecheck.LocalDictName &#123;<br>                base.FatalfAt(n.Pos(), <span class="hljs-string">&quot;dictionary variable not captured by value&quot;</span>)<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// è®°å½•é—­åŒ…æ•è·å˜é‡çš„æ–¹å¼ï¼ˆå€¼æˆ–å¼•ç”¨ï¼‰</span><br>        <span class="hljs-keyword">if</span> base.Flag.LowerM &gt; <span class="hljs-number">1</span> &#123;<br>            how := <span class="hljs-string">&quot;ref&quot;</span><br>            <span class="hljs-keyword">if</span> n.Byval() &#123;<br>                how = <span class="hljs-string">&quot;value&quot;</span><br>            &#125;<br>            base.WarnfAt(n.Pos(), <span class="hljs-string">&quot;%v capturing by %s: %v (addr=%v assign=%v width=%d)&quot;</span>, n.Curfn, how, n, loc.addrtaken, loc.reassigned, n.Type().Size())<br>        &#125;<br><br>        <span class="hljs-comment">// å»ºç«‹é—­åŒ…å˜é‡çš„æ•°æ®æµ</span><br>        k := k<br>        <span class="hljs-keyword">if</span> !cv.Byval() &#123;<br>            k = k.addr(cv, <span class="hljs-string">&quot;reference&quot;</span>)<br>        &#125;<br>        b.flow(k.note(cv, <span class="hljs-string">&quot;captured by a closure&quot;</span>), loc)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>a := <span class="hljs-number">1</span><br>b := <span class="hljs-number">2</span><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>add(a, b)<br>&#125;()<br>a = <span class="hljs-number">99</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">add</span><span class="hljs-params">(a, b <span class="hljs-type">int</span>)</span></span> &#123;<br>a = a + b<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œä¸‹é¢è¯­å¥çœ‹çœ‹å˜é‡çš„æ•è·æ–¹å¼ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go tool compile -m=2 main.go  | grep <span class="hljs-string">&quot;capturing&quot;</span><br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">main.go:4:2: main capturing by ref: a (addr=<span class="hljs-literal">false</span> assign=<span class="hljs-literal">true</span> width=8)<br>main.go:5:2: main capturing by value: b (addr=<span class="hljs-literal">false</span> assign=<span class="hljs-literal">false</span> width=8)<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° <code>a</code> æ˜¯é€šè¿‡ <code>ref åœ°å€å¼•ç”¨</code>çš„æ–¹å¼è¿›è¡Œå¼•ç”¨çš„ï¼Œè€Œ <code>b</code> æ˜¯é€šè¿‡ <code>value å€¼ä¼ é€’</code>çš„æ–¹å¼è¿›è¡Œå¼•ç”¨çš„ã€‚</p><p>ç®€å•åˆ†æä¸€ä¸‹ï¼šä¸Šè¿°ä¾‹å­ä¸­ï¼Œé—­åŒ…å¼•ç”¨äº† <code>a</code> å’Œ <code>b</code>è¿™ 2 ä¸ªé—­åŒ…å¤–å£°æ˜çš„å˜é‡ï¼Œè€Œå˜é‡ <code>a</code>åœ¨é—­åŒ…ä¹‹å‰åˆåšäº†ä¸€äº›å…¶ä»–çš„æ“ä½œï¼Œè€Œ b æ²¡æœ‰ï¼Œæ‰€ä»¥å¯¹äº<code>a</code>ï¼Œå› ä¸ºé—­åŒ…å¤–æœ‰æ“ä½œï¼Œæ‰€ä»¥é—­åŒ…å†…çš„æ“ä½œå¯èƒ½æ˜¯æœ‰ç‰¹æ®Šæ„ä¹‰çš„ï¼Œéœ€è¦åé¦ˆåˆ°é—­åŒ…å¤–ï¼Œå°±éœ€è¦ç”¨<code>ref åœ°å€å¼•ç”¨</code>äº†ï¼Œè€Œ <code>b</code>åœ¨é—­åŒ…å¤–å¹¶ä¸å…³å¿ƒï¼Œæ‰€ä»¥é—­åŒ…å†…çš„æ“ä½œä¸ä¼šå½±å“åˆ°é—­åŒ…å¤–ï¼Œæ•…ç›´æ¥ä½¿ç”¨<code>value å€¼ä¼ é€’</code> å³å¯ã€‚</p><h2 id="é—­åŒ…é‡å†™">é—­åŒ…é‡å†™</h2><p>é€ƒé€¸åˆ†æåï¼Œç°åœ¨æˆ‘ä»¬è¿›å…¥ <code>walk</code>é˜¶æ®µäº†ã€‚è¿™é‡Œé¦–å…ˆä¼šè¿›è¡Œé—­åŒ…é‡å†™ã€‚å…¶æ ¸å¿ƒé€»è¾‘åœ¨ <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/cmd/compile/internal/walk/closure.go">walk/closure.go</a>ä¸­ã€‚</p><p>é—­åŒ…é‡å†™åˆ†ä¸º 2 ç§æƒ…å†µï¼š</p><ul><li>é—­åŒ…å®šä¹‰åè¢«ç«‹å³è°ƒç”¨</li><li>é—­åŒ…å®šä¹‰åä¸ç«‹å³è°ƒç”¨</li></ul><h3 id="é—­åŒ…å®šä¹‰åè¢«ç«‹å³è°ƒç”¨">é—­åŒ…å®šä¹‰åè¢«ç«‹å³è°ƒç”¨</h3><p>åœ¨é—­åŒ…å®šä¹‰åè¢«ç«‹å³è°ƒç”¨çš„æƒ…å†µä¸‹ï¼Œé—­åŒ…åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œè¿™æ—¶å¯ä»¥å°†é—­åŒ…è½¬æ¢ä¸ºæ™®é€šå‡½æ•°çš„è°ƒç”¨å½¢å¼ã€‚</p><p>å¦‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>a := <span class="hljs-number">1</span><br>b := <span class="hljs-number">2</span><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>add(a, b)<br>&#125;()<br>a = <span class="hljs-number">99</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">add</span><span class="hljs-params">(a, b <span class="hljs-type">int</span>)</span></span> &#123;<br>a = a + b<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¼šè¢«è½¬æ¢ä¸ºæ™®é€šå‡½æ•°çš„è°ƒç”¨å½¢å¼ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>a := <span class="hljs-number">1</span><br>b := <span class="hljs-number">2</span><br><span class="hljs-keyword">go</span> func1(&amp;a, b)<br>a = <span class="hljs-number">99</span><br>&#125;<br><br><span class="hljs-comment">// æ³¨æ„è¿™é‡Œ a çš„ç±»å‹çš„ *intï¼Œå› ä¸ºåœ¨å˜é‡æ•è·é˜¶æ®µï¼Œåˆ¤æ–­äº† a åº”è¯¥ç”¨åœ°å€å¼•ç”¨</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">func1</span><span class="hljs-params">(a *<span class="hljs-type">int</span>, b <span class="hljs-type">int</span>)</span></span> &#123;<br>add(*a, b)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">add</span><span class="hljs-params">(a, b <span class="hljs-type">int</span>)</span></span> &#123;<br>a = a + b<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘å™¨å…·ä½“çš„å¤„ç†é€»è¾‘åœ¨ <code>directClosureCall()</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// directClosureCall rewrites a direct call of a function literal into</span><br><span class="hljs-comment">// a normal function call with closure variables passed as arguments.</span><br><span class="hljs-comment">// This avoids allocation of a closure object.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// For illustration, the following call:</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//func(a int) &#123;</span><br><span class="hljs-comment">//println(byval)</span><br><span class="hljs-comment">//byref++</span><br><span class="hljs-comment">//&#125;(42)</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// becomes:</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//func(byval int, &amp;byref *int, a int) &#123;</span><br><span class="hljs-comment">//println(byval)</span><br><span class="hljs-comment">//(*&amp;byref)++</span><br><span class="hljs-comment">//&#125;(byval, &amp;byref, 42)</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">directClosureCall</span><span class="hljs-params">(n *ir.CallExpr)</span></span> &#123;<br>clo := n.X.(*ir.ClosureExpr)<br>clofn := clo.Func<br><br>    <span class="hljs-comment">// å¦‚æœé—­åŒ…è¶³å¤Ÿç®€å•ï¼Œä¸è¿›è¡Œå¤„ç†ï¼Œç•™ç»™ walkClosure å¤„ç†ã€‚</span><br><span class="hljs-keyword">if</span> ir.IsTrivialClosure(clo) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-comment">// leave for walkClosure to handle</span><br>&#125;<br><br><span class="hljs-comment">// å°†é—­åŒ…ä¸­çš„æ¯ä¸ªå˜é‡è½¬æ¢ä¸ºå‡½æ•°çš„å‚æ•°ã€‚å¯¹äºå¼•ç”¨æ•è·çš„å˜é‡ï¼Œåˆ›å»ºç›¸åº”çš„æŒ‡é’ˆå‚æ•°ã€‚</span><br><span class="hljs-keyword">var</span> params []*types.Field<br><span class="hljs-keyword">var</span> decls []*ir.Name<br><span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> clofn.ClosureVars &#123;<br><span class="hljs-keyword">if</span> !v.Byval() &#123;<br><span class="hljs-comment">// å¯¹äºå¼•ç”¨æ•è·çš„å˜é‡ï¼Œåˆ›å»ºç›¸åº”çš„æŒ‡é’ˆå‚æ•°ã€‚</span><br>addr := ir.NewNameAt(clofn.Pos(), typecheck.Lookup(<span class="hljs-string">&quot;&amp;&quot;</span>+v.Sym().Name))<br>addr.Curfn = clofn<br>addr.SetType(types.NewPtr(v.Type()))<br>v.Heapaddr = addr<br>v = addr<br>&#125;<br><br>v.Class = ir.PPARAM<br>decls = <span class="hljs-built_in">append</span>(decls, v)<br><br>fld := types.NewField(src.NoXPos, v.Sym(), v.Type())<br>fld.Nname = v<br>params = <span class="hljs-built_in">append</span>(params, fld)<br>&#125;<br><br><span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„å‡½æ•°ç±»å‹ï¼Œå°†æ•è·çš„å˜é‡ä½œä¸ºå‰ç½®å‚æ•°ï¼Œå¹¶æ›´æ–°å‡½æ•°çš„å£°æ˜ã€‚</span><br>f := clofn.Nname<br>typ := f.Type()<br>typ = types.NewSignature(<span class="hljs-literal">nil</span>, <span class="hljs-built_in">append</span>(params, typ.Params().FieldSlice()...), typ.Results().FieldSlice())<br>f.SetType(typ)<br>clofn.Dcl = <span class="hljs-built_in">append</span>(decls, clofn.Dcl...)<br><br><span class="hljs-comment">// å°†åŸå§‹çš„é—­åŒ…è°ƒç”¨é‡å†™ä¸ºå¯¹æ–°å‡½æ•°çš„è°ƒç”¨ï¼Œå¹¶å°†æ•è·çš„å˜é‡ä½œä¸ºå®é™…å‚æ•°ä¼ é€’ã€‚</span><br>n.X = f<br>n.Args.Prepend(closureArgs(clo)...)<br><br><span class="hljs-comment">// è°ƒæ•´è°ƒç”¨è¡¨è¾¾å¼çš„ç±»å‹ï¼Œä»¥åæ˜ å‚æ•°å’Œè¿”å›å€¼ç±»å‹çš„å˜åŒ–ã€‚</span><br><span class="hljs-keyword">if</span> typ.NumResults() == <span class="hljs-number">1</span> &#123;<br>n.SetType(typ.Results().Field(<span class="hljs-number">0</span>).Type)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>n.SetType(typ.Results())<br>&#125;<br><br><span class="hljs-comment">// è™½ç„¶ä¸å†æ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„é—­åŒ…ï¼Œä½†ä¸ºäº†ç¡®ä¿å‡½æ•°è¢«ç¼–è¯‘ï¼Œå°†å…¶æ·»åŠ åˆ°å¾…ç¼–è¯‘åˆ—è¡¨ä¸­ã€‚</span><br>ir.CurFunc.Closures = <span class="hljs-built_in">append</span>(ir.CurFunc.Closures, clofn)<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ®µä»£ç æ˜¯ Go ç¼–è¯‘å™¨ä¸­çš„ <code>directClosureCall</code>å‡½æ•°ï¼Œç”¨äºå°†ç›´æ¥è°ƒç”¨çš„å‡½æ•°å­—é¢é‡é‡å†™ä¸ºæ­£å¸¸çš„å‡½æ•°è°ƒç”¨ï¼ŒåŒæ—¶å°†é—­åŒ…å˜é‡ä½œä¸ºå‚æ•°ä¼ é€’ã€‚è¿™é¿å…äº†é—­åŒ…å¯¹è±¡çš„åˆ†é…ã€‚</p><p>ä¸»è¦æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol type="1"><li><strong>æ£€æŸ¥é—­åŒ…æ˜¯å¦ç®€å•</strong>ï¼šå¦‚æœé—­åŒ…è¶³å¤Ÿç®€å•ï¼Œä¸è¿›è¡Œå¤„ç†ï¼Œç•™ç»™<code>walkClosure</code> å¤„ç†ã€‚</li><li><strong>å¤„ç†é—­åŒ…å˜é‡</strong>ï¼šå°†é—­åŒ…ä¸­çš„æ¯ä¸ªå˜é‡è½¬æ¢ä¸ºå‡½æ•°çš„å‚æ•°ã€‚å¯¹äºå¼•ç”¨æ•è·çš„å˜é‡ï¼Œåˆ›å»ºç›¸åº”çš„æŒ‡é’ˆå‚æ•°ã€‚</li><li><strong>æ›´æ–°å‡½æ•°ç±»å‹å’Œå£°æ˜</strong>ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å‡½æ•°ç±»å‹ï¼Œå°†æ•è·çš„å˜é‡ä½œä¸ºå‰ç½®å‚æ•°ï¼Œå¹¶æ›´æ–°å‡½æ•°çš„å£°æ˜ã€‚</li><li><strong>é‡å†™è°ƒç”¨</strong>ï¼šå°†åŸå§‹çš„é—­åŒ…è°ƒç”¨é‡å†™ä¸ºå¯¹æ–°å‡½æ•°çš„è°ƒç”¨ï¼Œå¹¶å°†æ•è·çš„å˜é‡ä½œä¸ºå®é™…å‚æ•°ä¼ é€’ã€‚</li><li><strong>æ›´æ–°è°ƒç”¨è¡¨è¾¾å¼ç±»å‹</strong>ï¼šè°ƒæ•´è°ƒç”¨è¡¨è¾¾å¼çš„ç±»å‹ï¼Œä»¥åæ˜ å‚æ•°å’Œè¿”å›å€¼ç±»å‹çš„å˜åŒ–ã€‚</li><li><strong>æ·»åŠ åˆ°å¾…ç¼–è¯‘åˆ—è¡¨</strong>ï¼šè™½ç„¶ä¸å†æ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„é—­åŒ…ï¼Œä½†ä¸ºäº†ç¡®ä¿å‡½æ•°è¢«ç¼–è¯‘ï¼Œå°†å…¶æ·»åŠ åˆ°å¾…ç¼–è¯‘åˆ—è¡¨ä¸­ã€‚</li></ol><p>è¿™ä¸ªå‡½æ•°çš„ç›®çš„æ˜¯ä¼˜åŒ–é—­åŒ…çš„è°ƒç”¨ï¼Œé€šè¿‡é¿å…é—­åŒ…å¯¹è±¡çš„åˆ†é…æ¥æé«˜æ€§èƒ½ã€‚</p><h3 id="é—­åŒ…å®šä¹‰åä¸ç«‹å³è°ƒç”¨">é—­åŒ…å®šä¹‰åä¸ç«‹å³è°ƒç”¨</h3><p>å¦‚æœé—­åŒ…å®šä¹‰åä¸è¢«ç«‹å³è°ƒç”¨ï¼Œè€Œæ˜¯åç»­è°ƒç”¨ï¼Œé‚£ä¹ˆåŒä¸€ä¸ªé—­åŒ…å¯èƒ½ä¼šè¢«è°ƒç”¨å¤šæ¬¡ï¼Œè¿™ä¸ªæ—¶å€™å°±å¿…é¡»åˆ›å»ºé—­åŒ…å¯¹è±¡äº†ã€‚</p><p>ç¼–è¯‘å™¨å…·ä½“çš„å¤„ç†é€»è¾‘åœ¨ <code>walkClosure()</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">walkClosure</span><span class="hljs-params">(clo *ir.ClosureExpr, init *ir.Nodes)</span></span> ir.Node &#123;<br>clofn := clo.Func<br><br><span class="hljs-comment">// å¦‚æœæ²¡æœ‰é—­åŒ…å˜é‡ï¼Œé—­åŒ…è¢«è§†ä¸ºå…¨å±€å‡½æ•°ï¼Œç›´æ¥è¿”å›å‡½æ•°åã€‚</span><br><span class="hljs-keyword">if</span> ir.IsTrivialClosure(clo) &#123;<br><span class="hljs-keyword">if</span> base.Debug.Closure &gt; <span class="hljs-number">0</span> &#123;<br>base.WarnfAt(clo.Pos(), <span class="hljs-string">&quot;closure converted to global&quot;</span>)<br>&#125;<br><span class="hljs-keyword">return</span> clofn.Nname<br>&#125;<br><br><span class="hljs-comment">// å¯¹äºå¤æ‚é—­åŒ…ï¼Œè®¾ç½®éœ€è¦ä¸Šä¸‹æ–‡æ ‡è®°ï¼Œå¹¶è¿›è¡Œè¿è¡Œæ—¶æ£€æŸ¥ã€‚</span><br>ir.ClosureDebugRuntimeCheck(clo)<br>clofn.SetNeedctxt(<span class="hljs-literal">true</span>)<br><br><span class="hljs-comment">// ç¡®ä¿é—­åŒ…å‡½æ•°ä¸ä¼šè¢«é‡å¤æ·»åŠ åˆ°ç¼–è¯‘é˜Ÿåˆ—ã€‚</span><br><span class="hljs-keyword">if</span> !clofn.Walked() &#123;<br>clofn.SetWalked(<span class="hljs-literal">true</span>)<br>ir.CurFunc.Closures = <span class="hljs-built_in">append</span>(ir.CurFunc.Closures, clofn)<br>&#125;<br><br><span class="hljs-comment">// æ„é€ ä¸€ä¸ªå¤åˆå­—é¢é‡è¡¨è¾¾å¼æ¥è¡¨ç¤ºé—­åŒ…å®ä¾‹ã€‚</span><br>typ := typecheck.ClosureType(clo)<br><br>    <span class="hljs-comment">// å°†é—­åŒ…å‡½æ•°å’Œæ•è·çš„å˜é‡ä½œä¸ºå­—æ®µæ·»åŠ åˆ°é—­åŒ…ç»“æ„ä¸­ã€‚</span><br>clos := ir.NewCompLitExpr(base.Pos, ir.OCOMPLIT, typ, <span class="hljs-literal">nil</span>)<br>clos.SetEsc(clo.Esc())<br>clos.List = <span class="hljs-built_in">append</span>([]ir.Node&#123;ir.NewUnaryExpr(base.Pos, ir.OCFUNC, clofn.Nname)&#125;, closureArgs(clo)...)<br><span class="hljs-keyword">for</span> i, value := <span class="hljs-keyword">range</span> clos.List &#123;<br>clos.List[i] = ir.NewStructKeyExpr(base.Pos, typ.Field(i), value)<br>&#125;<br><br>    <span class="hljs-comment">// åˆ›å»ºé—­åŒ…ç»“æ„çš„åœ°å€ï¼Œå¹¶è¿›è¡Œç±»å‹è½¬æ¢ä»¥ç¬¦åˆé—­åŒ…ç±»å‹ã€‚</span><br>addr := typecheck.NodAddr(clos)<br>addr.SetEsc(clo.Esc())<br>cfn := typecheck.ConvNop(addr, clo.Type())<br><br><span class="hljs-comment">// å¦‚æœå­˜åœ¨é¢„åˆ†é…çš„é—­åŒ…å¯¹è±¡ï¼Œè¿›è¡Œç›¸å…³å¤„ç†ã€‚</span><br><span class="hljs-keyword">if</span> x := clo.Prealloc; x != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">if</span> !types.Identical(typ, x.Type()) &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;closure type does not match order&#x27;s assigned type&quot;</span>)<br>&#125;<br>addr.Prealloc = x<br>clo.Prealloc = <span class="hljs-literal">nil</span><br>&#125;<br><br>    <span class="hljs-comment">// å¯¹æœ€ç»ˆæ„å»ºçš„é—­åŒ…è¡¨è¾¾å¼è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ã€‚</span><br><span class="hljs-keyword">return</span> walkExpr(cfn, init)<br>&#125;<br></code></pre></td></tr></table></figure><ol type="1"><li><strong>æ£€æŸ¥æ˜¯å¦ä¸ºç®€å•é—­åŒ…</strong>ï¼šå¦‚æœæ²¡æœ‰é—­åŒ…å˜é‡ï¼Œé—­åŒ…è¢«è§†ä¸ºå…¨å±€å‡½æ•°ï¼Œç›´æ¥è¿”å›å‡½æ•°åã€‚</li><li><strong>å¤„ç†éç®€å•é—­åŒ…</strong>ï¼šå¯¹äºå¤æ‚é—­åŒ…ï¼Œè®¾ç½®éœ€è¦ä¸Šä¸‹æ–‡æ ‡è®°ï¼Œå¹¶è¿›è¡Œè¿è¡Œæ—¶æ£€æŸ¥ã€‚</li><li><strong>é˜²æ­¢é‡å¤å¤„ç†</strong>ï¼šç¡®ä¿é—­åŒ…å‡½æ•°ä¸ä¼šè¢«é‡å¤æ·»åŠ åˆ°ç¼–è¯‘é˜Ÿåˆ—ã€‚</li><li><strong>åˆ›å»ºé—­åŒ…ç»“æ„</strong>ï¼šæ„é€ ä¸€ä¸ªå¤åˆå­—é¢é‡è¡¨è¾¾å¼æ¥è¡¨ç¤ºé—­åŒ…å®ä¾‹ã€‚</li><li><strong>å¡«å……é—­åŒ…å‚æ•°</strong>ï¼šå°†é—­åŒ…å‡½æ•°å’Œæ•è·çš„å˜é‡ä½œä¸ºå­—æ®µæ·»åŠ åˆ°é—­åŒ…ç»“æ„ä¸­ã€‚</li><li><strong>åœ°å€å’Œç±»å‹è½¬æ¢</strong>ï¼šåˆ›å»ºé—­åŒ…ç»“æ„çš„åœ°å€ï¼Œå¹¶è¿›è¡Œç±»å‹è½¬æ¢ä»¥ç¬¦åˆé—­åŒ…ç±»å‹ã€‚</li><li><strong>å¤„ç†é¢„åˆ†é…çš„é—­åŒ…</strong>ï¼šå¦‚æœå­˜åœ¨é¢„åˆ†é…çš„é—­åŒ…å¯¹è±¡ï¼Œè¿›è¡Œç›¸å…³å¤„ç†ã€‚</li><li><strong>è¡¨è¾¾å¼å¤„ç†</strong>ï¼šå¯¹æœ€ç»ˆæ„å»ºçš„é—­åŒ…è¡¨è¾¾å¼è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ã€‚</li></ol><h2 id="éå†å‡½æ•°">éå†å‡½æ•°</h2><p>é—­åŒ…é‡å†™åï¼Œä¼šè¿›å…¥ walk é˜¶æ®µï¼Œå¦‚å®˜æ–¹ æ–‡æ¡£æ‰€è¯´ï¼šè¿™æ˜¯å¯¹ IRè¡¨ç¤ºçš„æœ€åä¸€æ¬¡éå†ï¼Œå®ƒæœ‰ä¸¤ä¸ªç›®çš„ï¼š</p><ol type="1"><li>å°†å¤æ‚çš„è¯­å¥åˆ†è§£ä¸ºç®€å•çš„å•ä¸ªè¯­å¥ï¼Œå¼•å…¥ä¸´æ—¶å˜é‡å¹¶éµå®ˆæ±‚å€¼é¡ºåºï¼›</li><li>å°†é«˜çº§ Go æ„é€ è½¬æ¢ä¸ºæ›´åŸå§‹çš„æ„é€ ã€‚</li></ol><p>ä¸¾ä¸ªä¾‹å­ï¼Œ<code>walkRange()</code> å‡½æ•°é’ˆå¯¹ä¸åŒç±»å‹çš„<code>range</code>è¯­å¥ï¼ˆæ•°ç»„ã€åˆ‡ç‰‡ã€æ˜ å°„ã€é€šé“å’Œå­—ç¬¦ä¸²ï¼‰è¿›è¡Œå¤„ç†ï¼Œå°†å…¶è½¬æ¢ä¸ºæ›´åŸºæœ¬çš„å¾ªç¯ç»“æ„ï¼Œå¹¶åº”ç”¨å¿…è¦çš„å˜æ¢ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">walkRange</span><span class="hljs-params">(nrange *ir.RangeStmt)</span></span> ir.Node &#123;<br>    <span class="hljs-comment">// ... çœç•¥ä»£ç  ...</span><br><br>    <span class="hljs-comment">// éå† range è¯­å¥çš„ä¸åŒæƒ…å†µ</span><br>    <span class="hljs-keyword">switch</span> t.Kind() &#123;<br>    <span class="hljs-keyword">default</span>:<br>        base.Fatalf(<span class="hljs-string">&quot;walkRange&quot;</span>)<br><br>    <span class="hljs-comment">// å¤„ç†æ•°ç»„ã€åˆ‡ç‰‡ã€æŒ‡é’ˆï¼ˆæŒ‡å‘æ•°ç»„ï¼‰çš„æƒ…å†µ</span><br>    <span class="hljs-keyword">case</span> types.TARRAY, types.TSLICE, types.TPTR:<br>        <span class="hljs-comment">// ... çœç•¥ä»£ç  ...</span><br><br>    <span class="hljs-comment">// å¤„ç†æ˜ å°„çš„æƒ…å†µ</span><br>    <span class="hljs-keyword">case</span> types.TMAP:<br>        <span class="hljs-comment">// ... çœç•¥ä»£ç  ...</span><br><br>    <span class="hljs-comment">// å¤„ç†é€šé“çš„æƒ…å†µ</span><br>    <span class="hljs-keyword">case</span> types.TCHAN:<br>        <span class="hljs-comment">// ... çœç•¥ä»£ç  ...</span><br><br>    <span class="hljs-comment">// å¤„ç†å­—ç¬¦ä¸²çš„æƒ…å†µ</span><br>    <span class="hljs-keyword">case</span> types.TSTRING:<br>        <span class="hljs-comment">// ... çœç•¥ä»£ç  ...</span><br>    &#125;<br><br>    <span class="hljs-comment">// ... çœç•¥ä»£ç  ...</span><br><br>    <span class="hljs-comment">// æ„å»ºå¹¶è¿”å›æ–°çš„ for è¯­å¥</span><br>    nfor.PtrInit().Append(init...)<br>    typecheck.Stmts(nfor.Cond.Init())<br>    nfor.Cond = typecheck.Expr(nfor.Cond)<br>    nfor.Cond = typecheck.DefaultLit(nfor.Cond, <span class="hljs-literal">nil</span>)<br>    nfor.Post = typecheck.Stmt(nfor.Post)<br>    typecheck.Stmts(body)<br>    nfor.Body.Append(body...)<br>    nfor.Body.Append(nrange.Body...)<br><br>    <span class="hljs-keyword">var</span> n ir.Node = nfor<br>    n = walkStmt(n)<br><br>    base.Pos = lno<br>    <span class="hljs-keyword">return</span> n<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™éƒ¨åˆ†ä»£ç åœ¨ <ahref="https://github.com/golang/go/tree/release-branch.go1.21/src/cmd/compile/internal/walk">walk</a>ï¼Œå¯¹å…¶ä»–ä¼˜åŒ–æ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥é˜…è¯»è¿™éƒ¨åˆ†çš„ä»£ç ã€‚</p><h2 id="ssa-ç”Ÿæˆ">SSA ç”Ÿæˆ</h2><p>éå†å‡½æ•°ï¼ˆWalkï¼‰é˜¶æ®µåï¼Œç¼–è¯‘å™¨ä¼šå°† ASTè½¬æ¢ä¸ºä¸‹ä¸€ä¸ªé‡è¦çš„ä¸­é—´è¡¨ç¤ºå½¢æ€ï¼Œç§°ä¸º SSAï¼Œå…¶å…¨ç§°ä¸º Static SingleAssignmentï¼Œé™æ€å•èµ‹å€¼ã€‚SSA è¢«å¤§å¤šæ•°ç°ä»£çš„ç¼–è¯‘å™¨ï¼ˆåŒ…æ‹¬ GCC å’ŒLLVMï¼‰ä½¿ç”¨ï¼Œç”¨äºç¼–è¯‘è¿‡ç¨‹ä¸­çš„ä¼˜åŒ–å’Œä»£ç ç”Ÿæˆã€‚å…¶æ ¸å¿ƒç‰¹ç‚¹å’Œç”¨é€”å¦‚ä¸‹ï¼š</p><ol type="1"><li><strong>å˜é‡å”¯ä¸€èµ‹å€¼</strong>ï¼šåœ¨ SSAå½¢å¼ä¸­ï¼Œæ¯ä¸ªå˜é‡åªè¢«èµ‹å€¼ä¸€æ¬¡ï¼Œä½¿å¾—å˜é‡çš„ä½¿ç”¨å’Œä¿®æ”¹æ›´åŠ æ¸…æ™°ã€‚</li><li><strong>æ–¹ä¾¿çš„æ•°æ®æµåˆ†æ</strong>ï¼šSSAä½¿å¾—æ•°æ®æµåˆ†ææ›´åŠ ç›´æ¥å’Œé«˜æ•ˆï¼Œå› ä¸ºæ¯ä¸ªå˜é‡çš„èµ‹å€¼ç‚¹åªæœ‰ä¸€ä¸ªã€‚</li><li><strong>ä¼˜åŒ–ç®—æ³•çš„åŸºç¡€</strong>ï¼šè®¸å¤šç¼–è¯‘å™¨ä¼˜åŒ–æŠ€æœ¯ï¼Œå¦‚æ­»ä»£ç æ¶ˆé™¤ã€å¸¸é‡ä¼ æ’­ã€å¼ºåº¦å‰Šå‡ç­‰ï¼Œåœ¨SSA å½¢å¼ä¸‹æ›´æ˜“å®ç°ã€‚</li><li><strong>Phi å‡½æ•°</strong>ï¼šSSA å¼•å…¥äº† Phiå‡½æ•°æ¥å¤„ç†å˜é‡åœ¨ä¸åŒæ§åˆ¶æµè·¯å¾„ä¸Šçš„ä¸åŒèµ‹å€¼ã€‚</li><li><strong>ä»£ç ç”Ÿæˆ</strong>ï¼šSSAå½¢å¼ç®€åŒ–äº†ç›®æ ‡ä»£ç ç”Ÿæˆçš„è¿‡ç¨‹ï¼Œå› ä¸ºå®ƒæä¾›äº†æ›´æ¸…æ™°çš„æ“ä½œå’Œå˜é‡ä½¿ç”¨è§†å›¾ã€‚</li></ol><p>å®˜æ–¹å¯¹ SSA ç”Ÿæˆé˜¶æ®µè¿›è¡Œäº†è¯¦ç»†çš„æè¿°ï¼š<ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/cmd/compile/internal/ssa/README.md">Introductionto the Go compiler's SSA backend</a></p><p>Go æä¾›äº†å¼ºæœ‰åŠ›çš„å·¥å…·æŸ¥çœ‹ SSAåˆå§‹åŠå…¶åç»­ä¼˜åŒ–é˜¶æ®µç”Ÿæˆçš„ä»£ç ç‰‡æ®µï¼Œå¯ä»¥é€šè¿‡ç¼–è¯‘æ—¶æŒ‡å®š<code>GOSSAFUNC=&#123;pkg.func&#125;</code> å®ç°ã€‚</p><p>ä»¥ä¸‹é¢ä»£ç ä¸ºä¾‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">var</span> d <span class="hljs-type">uint8</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> a <span class="hljs-type">uint8</span> = <span class="hljs-number">1</span><br>a = <span class="hljs-number">2</span><br><span class="hljs-keyword">if</span> <span class="hljs-literal">true</span> &#123;<br>a = <span class="hljs-number">3</span><br>&#125;<br>d = a<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥è‡ªè¡Œç®€å•åˆ†æä¸€ä¸‹ï¼Œè¿™æ®µä»£ç å‰é¢ <code>a</code>çš„æ‰€æœ‰æ“ä½œå…¶å®éƒ½æ˜¯æ— æ„ä¹‰çš„ï¼Œæ•´æ®µä»£ç å…¶å®å°±åœ¨è¯´ <code>d = 3</code>è¿™ä»¶äº‹ã€‚</p><p>åœ¨ linux æˆ–è€… mac ä¸Šæ‰§è¡Œï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">GOSSAFUNC=main.main <span class="hljs-keyword">go</span> build main.<span class="hljs-keyword">go</span><br></code></pre></td></tr></table></figure><p>åœ¨ Windows ä¸Šæ‰§è¡Œï¼š</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-variable">$env:GOSSAFUNC</span>=<span class="hljs-string">&quot;main&quot;</span><br>go build .\main.go<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¾“å‡ºï¼š</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell">dumped SSA to .\ssa.html<br></code></pre></td></tr></table></figure><p>é€šè¿‡æµè§ˆå™¨æ‰“å¼€ç”Ÿæˆçš„ <code>ssa.html</code> æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° SSAçš„åˆå§‹é˜¶æ®µã€ä¼˜åŒ–é˜¶æ®µå’Œæœ€ç»ˆé˜¶æ®µçš„ä»£ç ç‰‡æ®µã€‚</p><figure><img src="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/ssa.png"alt="ssa.html æ–‡ä»¶ç¤ºä¾‹" /><figcaption aria-hidden="true">ssa.html æ–‡ä»¶ç¤ºä¾‹</figcaption></figure><p>æˆ‘ä»¬ç›´æ¥çœ‹æœ€ç»ˆçš„ç»“æœï¼Œæ¥çœ‹çœ‹æˆ‘ä»¬å‰é¢çš„åˆ†ææ­£ç¡®ä¸å¦ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20231203211001137.png"alt="ssa æœ€ç»ˆç»“æœ" /><figcaption aria-hidden="true">ssa æœ€ç»ˆç»“æœ</figcaption></figure><p>å¯ä»¥çœ‹åˆ°è¿™ä¸€è¡Œï¼š<code>00003 (**+11**) MOVB $3, main.d(SB)</code>ï¼Œé‚£å…¶å®å°±æ˜¯ç›´æ¥<code>d = 3</code>ã€‚</p><h2 id="æœºå™¨ç ç”Ÿæˆ">æœºå™¨ç ç”Ÿæˆ</h2><p>åœ¨ SSAé˜¶æ®µï¼Œç¼–è¯‘å™¨å…ˆæ‰§è¡Œä¸ç‰¹å®šæŒ‡ä»¤é›†æ— å…³çš„ä¼˜åŒ–ï¼Œå†æ‰§è¡Œä¸ç‰¹å®šæŒ‡ä»¤é›†æœ‰å…³çš„ä¼˜åŒ–ï¼Œå¹¶æœ€ç»ˆç”Ÿæˆä¸ç‰¹å®šæŒ‡ä»¤é›†æœ‰å…³çš„æŒ‡ä»¤å’Œå¯„å­˜å™¨åˆ†é…æ–¹å¼ã€‚å¦‚<ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/cmd/compile/internal/ssa/_gen/genericOps.go">ssa/_gen/genericOps.go</a>ä¸­åŒ…å«äº†ä¸ç‰¹å®šæŒ‡ä»¤é›†æ— å…³çš„ Op æ“ä½œï¼Œåœ¨ <ahref="https://github.com/golang/go/blob/release-branch.go1.21/src/cmd/compile/internal/ssa/_gen/S390XOps.go">ssa/_gen/AMD64Ops.go</a>ä¸­åŒ…å«äº†å’Œ AMD64 æŒ‡ä»¤é›†ç›¸å…³çš„ Op æ“ä½œã€‚</p><p>æœºå™¨ç ç”Ÿæˆé˜¶æ®µæ˜¯ç¼–è¯‘å™¨çš„æœºå™¨ä¾èµ–é˜¶æ®µï¼Œä¸»è¦è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol type="1"><li><strong>Lowering è¿‡ç¨‹</strong>ï¼šè¿™ä¸ªè¿‡ç¨‹å°†é€šç”¨çš„ SSAå½¢å¼è½¬æ¢ä¸ºç‰¹å®šäºç›®æ ‡æœºå™¨çš„å˜ä½“ã€‚è¿™åŒ…æ‹¬å°†é€šç”¨æ“ä½œç¬¦æ›¿æ¢ä¸ºé’ˆå¯¹ç‰¹å®šç¡¬ä»¶ä¼˜åŒ–çš„æ“ä½œã€‚</li><li><strong>ä»£ç ä¼˜åŒ–</strong>ï¼šåœ¨æœºå™¨ç‰¹å®šçš„å½¢å¼ä¸Šæ‰§è¡Œæœ€ç»ˆä¼˜åŒ–ï¼Œè¿›ä¸€æ­¥æé«˜ä»£ç æ•ˆç‡ã€‚</li><li><strong>ç”Ÿæˆæœºå™¨æŒ‡ä»¤</strong>ï¼šå°† Go å‡½æ•°è½¬æ¢ä¸º<code>obj.Prog</code> æŒ‡ä»¤åºåˆ—ã€‚</li><li><strong>æ±‡ç¼–å’Œè¾“å‡º</strong>ï¼šè¿™äº›æŒ‡ä»¤ç”±<code>cmd/internal/obj</code>æ¨¡å—çš„æ±‡ç¼–å™¨å¤„ç†ï¼Œè½¬æ¢ä¸ºæœºå™¨ä»£ç ï¼Œå¹¶è¾“å‡ºæœ€ç»ˆçš„ç›®æ ‡æ–‡ä»¶ã€‚</li></ol><p>Go ä¸ºæˆ‘ä»¬äº†è§£ Goè¯­è¨€ç¨‹åºçš„ç¼–è¯‘å’Œé“¾æ¥è¿‡ç¨‹æä¾›äº†ä¸€ä¸ªéå¸¸å¥½ç”¨çš„å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go build -n<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>-n</code> è¡¨ç¤º<strong>åªè¾“å‡ºç¼–è¯‘è¿‡ç¨‹ä¸­å°†è¦æ‰§è¡Œçš„ shellå‘½ä»¤ï¼Œä½†ä¸æ‰§è¡Œ</strong>ã€‚</p><p>ä»¥ä¸‹é¢ç¨‹åºä¸ºä¾‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-string">&quot;github.com/spf13/cast&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>i := cast.ToInt(<span class="hljs-string">&quot;1&quot;</span>)<br>fmt.Println(i)<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªç¨‹åºå¼•å…¥äº†æ ‡å‡†åº“ <code>fmt</code> ä»¥åŠç¬¬ä¸‰æ–¹åº“<code>github.com/spf13/cast</code>ã€‚</p><p>åœ¨å·¥ç¨‹ç›®å½•ä¸‹æ‰§è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go build -n -o main<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$WORK</span>/b001/<br><span class="hljs-built_in">cat</span> &gt;<span class="hljs-variable">$WORK</span>/b001/importcfg.link &lt;&lt; <span class="hljs-string">&#x27;EOF&#x27;</span> <span class="hljs-comment"># internal</span><br>packagefile go-compilation=/Users/wangjiahan/Library/Caches/go-build/48/48745ff5ef7f8945297b5894ec377f47e246d94739e0b8f00e86b6d58879e71d-d<br>packagefile <span class="hljs-built_in">fmt</span>=/Users/wangjiahan/Library/Caches/go-build/10/10ab74ff0df27a2f4bdbe7651290f13ad466f3df63e11241e07ccd21c169b206-d<br>packagefile github.com/spf13/cast=/Users/wangjiahan/Library/Caches/go-build/77/77eed0b7028cfc4c90d78d6670325d982325399573dff9d7f82ffbf76e4559e8-d<br>...<br>packagefile net/url=/Users/wangjiahan/Library/Caches/go-build/72/72d0ef9b8f99a52bf1de760bb2f630998d6bb66a3d2a3fa66bd66f4efddfbc71-d<br>modinfo <span class="hljs-string">&quot;0w\xaf\f\x92t\b\x02A\xe1\xc1\a\xe6\xd6\x18\xe6path\tgo-compilation\nmod\tgo-compilation\t(devel)\t\ndep\tgithub.com/spf13/cast\tv1.6.0\th1:GEiTHELF+vaR5dhz3VqZfFSzZjYbgeKDpBxQVS4GYJ0=\nbuild\t-buildmode=exe\nbuild\t-compiler=gc\nbuild\tCGO_ENABLED=1\nbuild\tCGO_CFLAGS=\nbuild\tCGO_CPPFLAGS=\nbuild\tCGO_CXXFLAGS=\nbuild\tCGO_LDFLAGS=\nbuild\tGOARCH=arm64\nbuild\tGOOS=darwin\n\xf92C1\x86\x18 r\x00\x82B\x10A\x16\xd8\xf2&quot;</span><br>EOF<br><span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$WORK</span>/b001/exe/<br><span class="hljs-built_in">cd</span> .<br>/opt/homebrew/opt/go/libexec/pkg/tool/darwin_arm64/link -o <span class="hljs-variable">$WORK</span>/b001/exe/a.out -importcfg <span class="hljs-variable">$WORK</span>/b001/importcfg.link -buildmode=pie -buildid=FDJiS-4glijTlqBbjVbe/UWsngURatTblImv3DE6-/OjO-hZGekrr-XpHFs_zA/FDJiS-4glijTlqBbjVbe -extld=cc /Users/wangjiahan/Library/Caches/go-build/48/48745ff5ef7f8945297b5894ec377f47e246d94739e0b8f00e86b6d58879e71d-d<br>/opt/homebrew/opt/go/libexec/pkg/tool/darwin_arm64/buildid -w <span class="hljs-variable">$WORK</span>/b001/exe/a.out <span class="hljs-comment"># internal</span><br><span class="hljs-built_in">mv</span> <span class="hljs-variable">$WORK</span>/b001/exe/a.out main<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå»ºè®®ä½ å…ˆå°è¯•è‡ªè¡Œåˆ†æä¸€ä¸‹è¿™ä¸ªç¼–è¯‘è¿‡ç¨‹ï¼Œå†ç»§ç»­å¾€ä¸‹é˜…è¯»ã€‚</p><p>ç»è¿‡åˆ†æï¼Œä¸Šè¿°è¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ 8 ä¸ªæ­¥éª¤ï¼š</p><ol type="1"><li><strong>åˆ›å»ºå·¥ä½œç›®å½•</strong>ï¼š<code>mkdir -p $WORK/b001/</code>åˆ›å»ºä¸€ä¸ªä¸´æ—¶å·¥ä½œç›®å½•ï¼Œç”¨äºå­˜æ”¾ç¼–è¯‘è¿‡ç¨‹ä¸­çš„ä¸´æ—¶æ–‡ä»¶ã€‚</li><li><strong>ç”Ÿæˆå¯¼å…¥é…ç½®æ–‡ä»¶</strong>ï¼š<code>cat &gt;$WORK/b001/importcfg.link &lt;&lt; 'EOF'</code>å‘½ä»¤å¼€å§‹åˆ›å»ºä¸€ä¸ªåä¸º <code>importcfg.link</code>çš„æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶åŒ…å«äº†ç¼–è¯‘è¿‡ç¨‹ä¸­éœ€è¦çš„åŒ…æ–‡ä»¶è·¯å¾„ã€‚</li><li><strong>å†™å…¥åŒ…æ–‡ä»¶è·¯å¾„</strong>ï¼šæ¥ä¸‹æ¥çš„å¤šè¡Œå†…å®¹æ˜¯å¯¹<code>importcfg.link</code>æ–‡ä»¶çš„å¡«å……ï¼ŒæŒ‡å®šäº†å„ä¸ªä¾èµ–åŒ…çš„å­˜å‚¨ä½ç½®ã€‚</li><li><strong>ç»“æŸæ–‡ä»¶å†™å…¥</strong>ï¼š<code>EOF</code> æ ‡å¿—ç€<code>importcfg.link</code> æ–‡ä»¶å†…å®¹çš„ç»“æŸã€‚</li><li><strong>åˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶ç›®å½•</strong>ï¼š<code>mkdir -p $WORK/b001/exe/</code>åˆ›å»ºä¸€ä¸ªç›®å½•ï¼Œç”¨äºå­˜æ”¾æœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚</li><li><strong>ç¼–è¯‘é“¾æ¥</strong>ï¼š<code>/opt/homebrew/opt/go/libexec/pkg/tool/darwin_arm64/link -o $WORK/b001/exe/a.out ...</code>è¿™ä¸€æ­¥æ˜¯ç¼–è¯‘é“¾æ¥çš„æ ¸å¿ƒï¼Œå®ƒä½¿ç”¨Goçš„é“¾æ¥å·¥å…·ï¼Œæ ¹æ®ä¹‹å‰ç”Ÿæˆçš„<code>importcfg.link</code> æ–‡ä»¶ï¼Œå°†ä»£ç ç¼–è¯‘æˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚</li><li><strong>æ›´æ–°æ„å»ºID</strong>ï¼š<code>/opt/homebrew/opt/go/libexec/pkg/tool/darwin_arm64/buildid -w $WORK/b001/exe/a.out</code>è¿™ä¸€æ­¥æ›´æ–°äº†å¯æ‰§è¡Œæ–‡ä»¶çš„æ„å»ºIDã€‚</li><li><strong>ç§»åŠ¨å¯æ‰§è¡Œæ–‡ä»¶</strong>ï¼š<code>mv $WORK/b001/exe/a.out main</code>å°†ç¼–è¯‘å¥½çš„å¯æ‰§è¡Œæ–‡ä»¶ç§»åŠ¨åˆ°å½“å‰ç›®å½•ï¼Œå¹¶é‡å‘½åä¸º <code>main</code>ã€‚</li></ol><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img6sR2uDuHwbkSNk3FuUxHmY-20231129143014805.png"alt="Goè¯­è¨€ç¼–è¯‘å’Œé“¾æ¥è¿‡ç¨‹" /><figcaption aria-hidden="true">Goè¯­è¨€ç¼–è¯‘å’Œé“¾æ¥è¿‡ç¨‹</figcaption></figure><h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2><ul><li><ahref="https://github.com/golang/go/tree/release-branch.go1.21/src/cmd/compile">Go1.21å®˜æ–¹æ–‡æ¡£</a></li><li><a href="https://book.douban.com/subject/35556889/">ã€ŠGoè¯­è¨€åº•å±‚åŸç†å‰–æã€‹</a></li><li><ahref="https://draveness.me/golang/docs/part1-prerequisite/ch02-compile/golang-compile-intro/">ã€ŠGoè¯­è¨€è®¾è®¡ä¸å®ç°ã€‹</a></li><li><ahref="https://medium.com/a-journey-with-go/go-overview-of-the-compiler-4e5a153ca889">Go:Overview of the Compiler</a></li><li><ahref="https://en.wikipedia.org/wiki/Abstract_syntax_tree">ç»´åŸºç™¾ç§‘ -AST</a></li><li><ahref="https://en.wikipedia.org/wiki/Static_single-assignment_form">ç»´åŸºç™¾ç§‘- SSA</a></li><li><a href="https://zhuanlan.zhihu.com/p/592602585">Goæœºåˆ¶ï¼šé€ƒé€¸åˆ†æå­¦ä¹ ç¬”è®°</a></li><li>ChatGPT-4</li></ul><hr /><p>ä»¥ä¸Šä¾¿æ˜¯ Go è¯­è¨€åœ¨ 1.21.0è¿™ä¸ªç‰ˆæœ¬ä¸‹ç¼–è¯‘è¿‡ç¨‹çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œç¬”è€…ä¼šåœ¨é˜…è¯»å®Œã€Šç”¨ Goè¯­è¨€è‡ªåˆ¶è§£é‡Šå™¨ã€‹å’Œã€Šç”¨ Goè¯­è¨€è‡ªåˆ¶ç¼–è¯‘å™¨ã€‹è¿™ä¸¤æœ¬ä¹¦åï¼Œè‹¥æœ‰å¯¹ç¼–è¯‘åŸç†æœ‰æ›´æ·±å…¥çš„ä½“ä¼šå’Œæ„Ÿæ‚Ÿï¼Œå†å›è¿‡æ¥å¯¹æœ¬æ–‡çš„å†…å®¹è¿›è¡Œå‹˜è¯¯å’Œè¿›ä¸€æ­¥æç‚¼ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>ç¼–è¯‘åŸç†</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Kafka é¡ºåºæ¶ˆæ¯å®ç°</title>
    <link href="/2023/11/23/kafka-ordered-msg/"/>
    <url>/2023/11/23/kafka-ordered-msg/</url>
    
    <content type="html"><![CDATA[<h2 id="ç‰ˆæœ¬è¯´æ˜">ç‰ˆæœ¬è¯´æ˜</h2><p>æœ¬æ–‡æ‰€æœ‰çš„è®¨è®ºå‡åœ¨å¦‚ä¸‹ç‰ˆæœ¬è¿›è¡Œï¼Œå…¶ä»–ç‰ˆæœ¬å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒã€‚</p><ul><li>Kafka: 3.6.0</li><li>Pulsar: 2.9.0</li><li>RabbitMQ 3.7.8</li><li>RocketMQ 5.0</li><li>Go1.21</li><li>github.com/segmentio/kafka-go v0.4.45</li></ul><h2 id="ç»“è®ºå…ˆè¡Œ">ç»“è®ºå…ˆè¡Œ</h2><p>Kafkaåªèƒ½ä¿è¯å•ä¸€åˆ†åŒºå†…çš„é¡ºåºæ¶ˆæ¯ï¼Œæ— æ³•ä¿è¯å¤šåˆ†åŒºé—´çš„é¡ºåºæ¶ˆæ¯ã€‚å…·ä½“æ¥è¯´ï¼Œè¦åœ¨Kafka å®Œå…¨å®ç°é¡ºåºæ¶ˆæ¯ï¼Œè‡³å°‘éœ€è¦ä¿è¯ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶ï¼š</p><ol type="1"><li>åŒä¸€ç”Ÿäº§è€…ç”Ÿäº§æ¶ˆæ¯ï¼›</li><li>åŒæ­¥å‘é€æ¶ˆæ¯åˆ° Kafka brokerï¼›</li><li>æ‰€æœ‰æ¶ˆæ¯å‘å¸ƒåˆ°åŒä¸€ä¸ªåˆ†åŒºï¼›</li><li>åŒä¸€æ¶ˆè´¹è€…åŒæ­¥æŒ‰ç…§é¡ºåºæ¶ˆè´¹æ¶ˆæ¯ã€‚</li></ol><p>è€Œè¦æ»¡è¶³ç¬¬ 3 ç‚¹ï¼Œå¸¸ç”¨çš„æœ‰ 2 ç§æ€è·¯ï¼š</p><ol type="1"><li>å›ºå®šæ¶ˆæ¯çš„ keyï¼Œç”Ÿäº§ç«¯é‡‡ç”¨ <code>key hash</code> çš„æ–¹å¼å†™å…¥brokerï¼›</li><li>è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥ï¼Œè¦ä¿è¯é¡ºåºçš„æ¶ˆæ¯éƒ½å†™å…¥åˆ°æŒ‡å®šçš„åˆ†åŒºã€‚</li></ol><h2 id="æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„é¡ºåºæ¶ˆæ¯å¦‚ä½•å®ç°">æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„é¡ºåºæ¶ˆæ¯å¦‚ä½•å®ç°</h2><h3 id="é¡ºåºæ¶ˆæ¯å®šä¹‰">é¡ºåºæ¶ˆæ¯å®šä¹‰</h3><p>ç”Ÿäº§ç«¯å‘é€å‡ºæ¥çš„æ¶ˆæ¯çš„é¡ºåºå’Œæ¶ˆè´¹ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯çš„é¡ºåºæ˜¯ä¸€æ ·çš„ã€‚</p><h3 id="æ¶ˆæ¯å­˜å‚¨ç»“æ„">æ¶ˆæ¯å­˜å‚¨ç»“æ„</h3><p>ä¸€èˆ¬æ¥è¯´ï¼Œæ¶ˆæ¯é˜Ÿåˆ—éƒ½æ˜¯åŸºäº<strong>é¡ºåºå­˜å‚¨ç»“æ„</strong>æ¥å­˜å‚¨æ•°æ®çš„ï¼Œä¸éœ€è¦B æ ‘ã€B+æ ‘ç­‰å¤æ‚æ•°æ®ç»“æ„ï¼Œåˆ©ç”¨æ–‡ä»¶çš„é¡ºåºè¯»å†™ï¼Œæ€§èƒ½ä¹Ÿå¾ˆé«˜ã€‚æ‰€ä»¥ç†æƒ³æƒ…å†µä¸‹ï¼Œç”Ÿäº§è€…æŒ‰é¡ºåºå‘é€æ¶ˆæ¯ï¼Œbrokerä¼šæŒ‰é¡ºåºå­˜å‚¨æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…å†æŒ‰é¡ºåºæ¶ˆè´¹æ¶ˆæ¯ï¼Œé‚£ä¹ˆå¤©ç„¶å°±å®ç°äº†æˆ‘ä»¬è¦çš„<strong>é¡ºåºæ¶ˆæ¯</strong>äº†ï¼Œå¦‚ä¸‹ï¼š</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20231124235214392.png"alt="æ¶ˆæ¯é˜Ÿåˆ—é¡ºåºå­˜å‚¨ç»“æ„" /><figcaption aria-hidden="true">æ¶ˆæ¯é˜Ÿåˆ—é¡ºåºå­˜å‚¨ç»“æ„</figcaption></figure><h3 id="åŸºæœ¬æ¡ä»¶">åŸºæœ¬æ¡ä»¶</h3><p>ä½†æ˜¯ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¸ºäº†æ”¯æŒæ›´é«˜çš„å¹¶å‘å’Œååï¼Œå¤§å¤šæ•°éƒ½æœ‰åˆ†åŒºï¼ˆpartitionï¼‰å’Œæ¶ˆè´¹è€…ç»„ï¼ˆconsumergroupï¼‰æœºåˆ¶ï¼Œè€Œä¸ºäº†é«˜å¯ç”¨ï¼Œä¸€èˆ¬ä¹Ÿä¼šæœ‰å‰¯æœ¬ï¼ˆreplicaï¼‰æœºåˆ¶ï¼Œæ‰€ä»¥æƒ…å†µå°±å¤æ‚å¾—å¤šäº†ï¼Œå¦‚ä¸‹é¢å‡ ä¸ªä¾‹å­ï¼Œå°±ä¼šå¯¼è‡´æ¶ˆæ¯å¤±åºï¼š</p><ol type="1"><li>å¤šä¸ªç”Ÿäº§è€…åŒæ—¶å‘é€æ¶ˆæ¯ï¼Œé‚£ä¹ˆåˆ°è¾¾ broker çš„æ—¶é—´ä¹Ÿæ˜¯ä¸ç¡®å®šçš„ï¼Œæ‰€ä»¥broker å°±æ— æ³•ä¿è¯è½ç›˜çš„é¡ºåºæ€§äº†ï¼›</li><li>å•ä¸ªç”Ÿäº§è€…ï¼Œä½†æ˜¯é‡‡ç”¨å¼‚æ­¥å‘é€ï¼Œå› ä¸ºå¼‚æ­¥çº¿ç¨‹æ˜¯å¹¶å‘æ‰§è¡Œçš„ï¼Œç”± CPUè¿›è¡Œè°ƒåº¦ï¼Œä¸”æœ‰å¯èƒ½ä¼šå› ä¸ºå‘é€å¤±è´¥è€Œé‡è¯•ï¼Œæ‰€ä»¥ä¹Ÿæ— æ³•ä¿è¯æ¶ˆæ¯å¯ä»¥æŒ‰ç…§é¡ºåºåˆ°è¾¾brokerï¼ŒåŒç†ï¼Œæ¶ˆè´¹è€…å¼‚æ­¥å¤„ç†æ¶ˆæ¯ï¼Œä¹Ÿæ— æ³•ä¿è¯é¡ºåºæ€§ï¼›</li><li>ä¸€ä¸ª topicæœ‰å¤šä¸ªåˆ†åŒºï¼Œé‚£ä¹ˆå³ä½¿æ˜¯åŒä¸€ä¸ªç”Ÿäº§è€…ï¼Œç”±äºåˆ†åŒºç­–ç•¥ï¼Œæ¶ˆæ¯å¯èƒ½ä¼šè¢«åˆ†å‘åˆ°å¤šä¸ªåˆ†åŒºä¸­ï¼Œæ¶ˆè´¹è€…ä¹Ÿå°±æ— æ³•ä¿è¯é¡ºåºæ€§äº†ã€‚</li></ol><p>æ‰€ä»¥åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“å‡ºå®ç°é¡ºåºæ¶ˆæ¯ï¼Œè‡³å°‘éœ€è¦æ»¡è¶³ä»¥ä¸‹ 3 ç‚¹ï¼š</p><ol type="1"><li>å•ä¸€ç”Ÿäº§è€…åŒæ­¥å‘é€ï¼›</li><li>å•ä¸€åˆ†åŒºï¼›</li><li>å•ä¸€æ¶ˆè´¹è€…åŒæ­¥æ¶ˆè´¹ï¼›</li></ol><p>ç¬¬ 1ã€3 ç‚¹æ¯”è¾ƒç®€å•ï¼ŒKafka é€šè¿‡åˆ†åŒºå’Œ offsetçš„æ–¹å¼ä¿è¯äº†æ¶ˆæ¯çš„é¡ºåºã€‚æ¯ä¸ªåˆ†åŒºéƒ½æ˜¯ä¸€ä¸ªæœ‰åºçš„ã€ä¸å¯å˜çš„æ¶ˆæ¯åºåˆ—ï¼Œæ¯ä¸ªæ¶ˆæ¯åœ¨åˆ†åŒºä¸­éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„åºæ•°æ ‡è¯†ï¼Œç§°ä¸º<code>offset</code>ã€‚ç”Ÿäº§è€…åœ¨å‘é€æ¶ˆæ¯åˆ°åˆ†åŒºæ—¶ï¼ŒKafkaä¼šè‡ªåŠ¨ä¸ºæ¶ˆæ¯åˆ†é…ä¸€ä¸ª offsetã€‚æ¶ˆè´¹è€…åœ¨è¯»å–æ¶ˆæ¯æ—¶ï¼Œä¼šæŒ‰ç…§ offsetçš„é¡ºåºæ¥è¯»å–ï¼Œä»è€Œä¿è¯äº†æ¶ˆæ¯çš„é¡ºåºã€‚</p><p>ä¸‹é¢æˆ‘ä»¬ä¸»è¦æ¥è°ˆä¸€è°ˆç¬¬ 2 ç‚¹ã€‚</p><h2 id="kafka-é¡ºåºæ¶ˆæ¯çš„å®ç°">Kafka é¡ºåºæ¶ˆæ¯çš„å®ç°</h2><h3 id="å†™å…¥æ¶ˆæ¯çš„è¿‡ç¨‹">å†™å…¥æ¶ˆæ¯çš„è¿‡ç¨‹</h3><ol type="1"><li><strong>é…ç½®ç”Ÿäº§è€…</strong>ï¼šé¦–å…ˆï¼Œä½ éœ€è¦é…ç½® Kafkaç”Ÿäº§è€…ã€‚è¿™åŒ…æ‹¬æŒ‡å®š Kafkaé›†ç¾¤çš„åœ°å€å’Œç«¯å£ï¼Œä»¥åŠå…¶ä»–ç›¸å…³é…ç½®é¡¹ï¼Œå¦‚æ¶ˆæ¯åºåˆ—åŒ–å™¨ã€åˆ†åŒºç­–ç•¥ç­‰ã€‚</li><li><strong>åˆ›å»ºç”Ÿäº§è€…å®ä¾‹</strong>ï¼šåœ¨åº”ç”¨ç¨‹åºä¸­ï¼Œä½ éœ€è¦åˆ›å»ºä¸€ä¸ª Kafkaç”Ÿäº§è€…çš„å®ä¾‹ã€‚è¿™ä¸ªå®ä¾‹å°†ç”¨äºä¸ Kafka é›†ç¾¤è¿›è¡Œé€šä¿¡ã€‚</li><li><strong>åºåˆ—åŒ–æ¶ˆæ¯</strong>ï¼šåœ¨å°†æ¶ˆæ¯å‘é€åˆ° Kafkaé›†ç¾¤ä¹‹å‰ï¼Œä½ éœ€è¦å°†æ¶ˆæ¯è¿›è¡Œåºåˆ—åŒ–ã€‚Kafkaä½¿ç”¨å­—èŠ‚æ•°ç»„æ¥è¡¨ç¤ºæ¶ˆæ¯çš„å†…å®¹ï¼Œå› æ­¤ä½ éœ€è¦å°†æ¶ˆæ¯å¯¹è±¡åºåˆ—åŒ–ä¸ºå­—èŠ‚æ•°ç»„ã€‚è¿™é€šå¸¸æ¶‰åŠå°†æ¶ˆæ¯å¯¹è±¡è½¬æ¢ä¸ºJSONã€Avroã€Protobuf ç­‰æ ¼å¼ã€‚</li><li><strong>é€‰æ‹©åˆ†åŒº</strong>ï¼šKafkaçš„ä¸»é¢˜ï¼ˆtopicï¼‰è¢«åˆ†ä¸ºå¤šä¸ªåˆ†åŒºï¼ˆpartitionï¼‰ï¼Œæ¯ä¸ªåˆ†åŒºéƒ½æ˜¯æœ‰åºä¸”æŒä¹…åŒ–çš„æ¶ˆæ¯æ—¥å¿—ã€‚å½“ä½ å‘é€æ¶ˆæ¯æ—¶ï¼Œä½ å¯ä»¥é€‰æ‹©å°†æ¶ˆæ¯å‘é€åˆ°ç‰¹å®šçš„åˆ†åŒºï¼Œæˆ–è€…è®©Kafka æ ¹æ®åˆ†åŒºç­–ç•¥è‡ªåŠ¨é€‰æ‹©åˆ†åŒºã€‚</li><li><strong>å‘é€æ¶ˆæ¯</strong>ï¼šä¸€æ—¦æ¶ˆæ¯è¢«åºåˆ—åŒ–å¹¶é€‰æ‹©äº†ç›®æ ‡åˆ†åŒºï¼Œä½ å¯ä»¥ä½¿ç”¨Kafka ç”Ÿäº§è€…çš„ <code>send()</code> æ–¹æ³•å°†æ¶ˆæ¯å‘é€åˆ° Kafkaé›†ç¾¤ã€‚å‘é€æ¶ˆæ¯æ—¶ï¼Œç”Ÿäº§è€…ä¼šå°†æ¶ˆæ¯å‘é€åˆ°å¯¹åº”åˆ†åŒºçš„ leader å‰¯æœ¬ã€‚</li><li><strong>å¼‚æ­¥å‘é€</strong>ï¼šKafkaç”Ÿäº§è€…é€šå¸¸ä½¿ç”¨å¼‚æ­¥æ–¹å¼å‘é€æ¶ˆæ¯ï¼Œè¿™æ ·å¯ä»¥æé«˜ååé‡ã€‚ç”Ÿäº§è€…å°†æ¶ˆæ¯æ·»åŠ åˆ°ä¸€ä¸ªå‘é€ç¼“å†²åŒºï¼ˆsendbufferï¼‰ä¸­ï¼Œå¹¶åœ¨åå°çº¿ç¨‹ä¸­æ‰¹é‡å‘é€æ¶ˆæ¯åˆ° Kafka é›†ç¾¤ã€‚</li><li><strong>æ¶ˆæ¯æŒä¹…åŒ–</strong>ï¼šä¸€æ—¦æ¶ˆæ¯è¢«å‘é€åˆ° Kafka é›†ç¾¤çš„ leaderå‰¯æœ¬ï¼Œå®ƒå°†è¢«æŒä¹…åŒ–å¹¶å¤åˆ¶åˆ°å…¶ä»–å‰¯æœ¬ï¼Œä»¥ç¡®ä¿æ•°æ®çš„é«˜å¯é æ€§å’Œå†—ä½™æ€§ã€‚åªæœ‰å½“æ¶ˆæ¯è¢«æˆåŠŸå†™å…¥åˆ°æŒ‡å®šæ•°é‡çš„å‰¯æœ¬åï¼Œç”Ÿäº§è€…æ‰ä¼šæ”¶åˆ°ç¡®è®¤ï¼ˆacknowledgementï¼‰ã€‚</li><li><strong>é”™è¯¯å¤„ç†å’Œé‡è¯•</strong>ï¼šå¦‚æœå‘é€æ¶ˆæ¯æ—¶å‘ç”Ÿé”™è¯¯ï¼Œç”Ÿäº§è€…å¯ä»¥æ ¹æ®é…ç½®è¿›è¡Œé”™è¯¯å¤„ç†å’Œé‡è¯•ã€‚ä½ å¯ä»¥è®¾ç½®é‡è¯•æ¬¡æ•°ã€é‡è¯•é—´éš”ç­‰å‚æ•°æ¥æ§åˆ¶é‡è¯•è¡Œä¸ºã€‚</li></ol><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20231125013322459.png"alt="Kafka ç”Ÿäº§è€…ç»„ä»¶ -ã€ŠKafkaæƒå¨æŒ‡å—ç¬¬2ç‰ˆã€‹" /><figcaption aria-hidden="true">Kafka ç”Ÿäº§è€…ç»„ä»¶-ã€ŠKafkaæƒå¨æŒ‡å—ç¬¬2ç‰ˆã€‹</figcaption></figure><h3 id="å®ç°å•ä¸€åˆ†åŒº">å®ç°å•ä¸€åˆ†åŒº</h3><p>å† Kafka ä¸­ï¼Œæˆ‘ä»¬è¦å®ç°å°†æ¶ˆæ¯å†™å…¥åˆ°åŒä¸€ä¸ªåˆ†åŒºï¼Œæœ‰ 3 ç§æ€è·¯ï¼š</p><ul><li>é…ç½® <code>num.partitions=1</code> æˆ–è€…åˆ›å»º topic çš„æ—¶å€™æŒ‡å®šåªæœ‰ 1ä¸ªåˆ†åŒºï¼Œä½†è¿™ä¼šæ˜¾è‘—é™ä½ Kafka çš„ååé‡ã€‚</li><li><strong>å›ºå®šæ¶ˆæ¯çš„ key</strong>ï¼Œç„¶åé‡‡ç”¨ <strong>key hash</strong>çš„åˆ†åŒºç­–ç•¥ï¼Œè¿™æ ·å°±å¯ä»¥è®©æ‰€æœ‰æ¶ˆæ¯éƒ½è¢«åˆ†åˆ°åŒä¸€ä¸ªåˆ†åŒºä¸­ã€‚</li><li>å®ç°å¹¶æŒ‡å®š<strong>è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥</strong>ï¼Œå¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼Œå°†éœ€è¦é¡ºåºæ¶ˆè´¹çš„æ¶ˆæ¯éƒ½åˆ†åˆ°å›ºå®šä¸€ä¸ªåˆ†åŒºä¸­ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// å¦‚ä¸‹ä¾‹å­ï¼Œæ‰€æœ‰ä½¿ç”¨&quot;same-key&quot;ä½œä¸ºkeyçš„æ¶ˆæ¯éƒ½ä¼šè¢«å‘é€åˆ°åŒä¸€ä¸ªPartition</span><br>ProducerRecord&lt;String, String&gt; record = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProducerRecord</span>&lt;String, String&gt;(<span class="hljs-string">&quot;topic&quot;</span>, <span class="hljs-string">&quot;same-key&quot;</span>, <span class="hljs-string">&quot;message&quot;</span>);<br>producer.send(record);<br></code></pre></td></tr></table></figure><h3 id="é‡å¹³è¡¡å¸¦æ¥çš„é—®é¢˜">é‡å¹³è¡¡å¸¦æ¥çš„é—®é¢˜</h3><p>å¦‚æœé‡‡ç”¨ä¸Šè¿°çš„ç¬¬ 2 ç§æ€è·¯ï¼š<strong>å›ºå®šæ¶ˆæ¯ keyï¼Œä¾é  key hashåˆ†åŒºç­–ç•¥ï¼Œå®ç°å•ä¸€åˆ†åŒº</strong>ã€‚åœ¨æˆ‘ä»¬åªæœ‰ 1ä¸ªæ¶ˆè´¹è€…çš„æƒ…å†µä¸‹æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯æ¶ˆè´¹è€…ç»„ï¼Œé‚£ä¹ˆï¼Œåœ¨å‘ç”Ÿ<strong>é‡å¹³è¡¡</strong>æ“ä½œçš„æ—¶å€™ï¼Œå°±å¯èƒ½ä¼šæœ‰é—®é¢˜äº†ã€‚</p><p>Kafka çš„é‡å¹³è¡¡ï¼ˆRebalanceï¼‰æ˜¯æŒ‡ Kafka æ¶ˆè´¹è€…ç»„ï¼ˆConsumerGroupï¼‰ä¸­çš„æ¶ˆè´¹è€…å®ä¾‹å¯¹åˆ†åŒºçš„é‡æ–°åˆ†é…ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸»è¦å‘ç”Ÿåœ¨ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š</p><ol type="1"><li>æ¶ˆè´¹è€…ç»„ä¸­æ–°çš„æ¶ˆè´¹è€…åŠ å…¥ã€‚</li><li>æ¶ˆè´¹è€…ç»„ä¸­çš„æ¶ˆè´¹è€…ç¦»å¼€æˆ–è€…æŒ‚æ‰ã€‚</li><li>è®¢é˜…çš„ Topic çš„åˆ†åŒºæ•°å‘ç”Ÿå˜åŒ–ã€‚</li><li>æ¶ˆè´¹è€…è°ƒç”¨äº† <code>#unsubscribe()</code> æˆ–è€…<code>#subscribe()</code> æ–¹æ³•ã€‚</li></ol><p>é‡å¹³è¡¡çš„è¿‡ç¨‹ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p><ol type="1"><li><strong>Revoke</strong>ï¼šé¦–å…ˆï¼ŒKafkaä¼šæ’¤é”€æ¶ˆè´¹è€…ç»„ä¸­æ‰€æœ‰æ¶ˆè´¹è€…å½“å‰æŒæœ‰çš„åˆ†åŒºã€‚</li><li><strong>Assignment</strong>ï¼šç„¶åï¼ŒKafkaä¼šé‡æ–°è®¡ç®—åˆ†åŒºçš„åˆ†é…æƒ…å†µï¼Œç„¶åå°†åˆ†åŒºåˆ†é…ç»™æ¶ˆè´¹è€…ã€‚</li><li><strong>Resume</strong>ï¼šæœ€åï¼Œæ¶ˆè´¹è€…ä¼šå¼€å§‹æ¶ˆè´¹æ–°åˆ†é…åˆ°çš„åˆ†åŒºã€‚</li></ol><p>é‡å¹³è¡¡çš„ç›®çš„æ˜¯ä¸ºäº†ä¿è¯æ¶ˆè´¹è€…ç»„ä¸­çš„æ¶ˆè´¹è€…èƒ½å¤Ÿå…¬å¹³åœ°æ¶ˆè´¹ Topicçš„åˆ†åŒºã€‚é€šè¿‡é‡å¹³è¡¡ï¼ŒKafkaå¯ä»¥åœ¨æ¶ˆè´¹è€…çš„æ•°é‡å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒåŠ¨æ€åœ°è°ƒæ•´æ¶ˆè´¹è€…å¯¹åˆ†åŒºçš„åˆ†é…ï¼Œä»è€Œå®ç°è´Ÿè½½å‡è¡¡ã€‚</p><p>ç„¶è€Œï¼Œå½“å‘ç”Ÿé‡å¹³è¡¡æ—¶ï¼Œåˆ†åŒºå¯èƒ½ä¼šè¢«é‡æ–°åˆ†é…ç»™ä¸åŒçš„æ¶ˆè´¹è€…ï¼Œè¿™å¯èƒ½ä¼šå½±å“æ¶ˆæ¯çš„æ¶ˆè´¹é¡ºåºã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><ol type="1"><li>å‡è®¾æ¶ˆè´¹è€… A æ­£åœ¨æ¶ˆè´¹åˆ†åŒº P çš„æ¶ˆæ¯ï¼Œå®ƒå·²ç»æ¶ˆè´¹äº†æ¶ˆæ¯ 1ï¼Œæ¶ˆæ¯2ï¼Œæ­£åœ¨å¤„ç†æ¶ˆæ¯ 3ã€‚</li><li>æ­¤æ—¶ï¼Œå‘ç”Ÿäº†é‡å¹³è¡¡ï¼Œåˆ†åŒº P è¢«é‡æ–°åˆ†é…ç»™äº†æ¶ˆè´¹è€… Bã€‚</li><li>æ¶ˆè´¹è€… B å¼€å§‹æ¶ˆè´¹åˆ†åŒºPï¼Œå®ƒä¼šä»ä¸Šä¸€æ¬¡æäº¤çš„åç§»é‡ï¼ˆoffsetï¼‰å¼€å§‹æ¶ˆè´¹ã€‚å‡è®¾æ¶ˆè´¹è€… A åœ¨å¤„ç†æ¶ˆæ¯ 3æ—¶å‘ç”Ÿäº†æ•…éšœï¼Œæ²¡æœ‰æäº¤åç§»é‡ï¼Œé‚£ä¹ˆæ¶ˆè´¹è€… B ä¼šä»æ¶ˆæ¯ 3 å¼€å§‹æ¶ˆè´¹ã€‚</li><li>è¿™æ ·ï¼Œæ¶ˆæ¯ 3 å¯èƒ½ä¼šè¢«æ¶ˆè´¹ä¸¤æ¬¡ï¼Œè€Œä¸”å¦‚æœæ¶ˆè´¹è€… B å¤„ç†æ¶ˆæ¯ 3çš„é€Ÿåº¦å¿«äºæ¶ˆè´¹è€…Aï¼Œé‚£ä¹ˆæ¶ˆæ¯ 3 å¯èƒ½ä¼šåœ¨æ¶ˆæ¯ 2ä¹‹åè¢«å¤„ç†ï¼Œè¿™å°±æ‰“ç ´äº†æ¶ˆæ¯çš„é¡ºåºæ€§ã€‚</li></ol><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img/image-20231125003222491.png"alt="é‡å¹³è¡¡å¯¼è‡´æ¶ˆæ¯å¤±åº" /><figcaption aria-hidden="true">é‡å¹³è¡¡å¯¼è‡´æ¶ˆæ¯å¤±åº</figcaption></figure><p>å†ä¸¾ä¸ªä¾‹å­ï¼š</p><ol type="1"><li>topic-A æœ¬æ¥åªæœ‰ 3 ä¸ªåˆ†åŒºï¼ŒæŒ‰ç…§ key hashï¼Œkey ä¸º<code>same-key</code> çš„æ¶ˆæ¯åº”è¯¥éƒ½å‘åˆ° ç¬¬ 2 ä¸ªåˆ†åŒºï¼›</li><li>ä½†æ˜¯åæ¥ topic-A å˜æˆäº† 4 ä¸ªåˆ†åŒºï¼ŒæŒ‰ç…§ key hashï¼Œkey ä¸º<code>same-key</code> çš„æ¶ˆæ¯å¯èƒ½å°±è¢«å‘åˆ°ç¬¬ 3 ä¸ªåˆ†åŒºäº†ï¼›</li><li>è¿™å°±æ— æ³•åšåˆ°å•ä¸€åˆ†åŒºï¼Œå¯èƒ½ä¼šå¯¼è‡´æ¶ˆæ¯å¤±åºã€‚</li></ol><p>å½“ç„¶è¿™ä¸ªä¾‹å­ä¸æ˜¯ç”±é‡å¹³è¡¡ç›´æ¥å¼•èµ·çš„ï¼Œä½†æ˜¯è¿™ç§æƒ…å†µä¹Ÿæ˜¯æœ‰å¯èƒ½å¯¼è‡´æ¶ˆæ¯å¤±åºçš„ã€‚</p><h3 id="ç¼“è§£é‡å¹³è¡¡çš„é—®é¢˜">ç¼“è§£é‡å¹³è¡¡çš„é—®é¢˜</h3><ul><li><strong>é¿å…åŠ¨æ€æ”¹å˜åˆ†åŒºæ•°</strong>ï¼šåœ¨éœ€è¦ä¸¥æ ¼ä¿æŒæ¶ˆæ¯é¡ºåºçš„åœºæ™¯ä¸‹ï¼Œåº”é¿å…åŠ¨æ€åœ°æ”¹å˜åˆ†åŒºæ•°ã€‚è¿™æ„å‘³ç€åœ¨è®¾è®¡Kafka ä¸»é¢˜æ—¶ï¼Œåº”æå‰è§„åˆ’å¥½æ‰€éœ€çš„åˆ†åŒºæ•°ï¼Œä»¥é¿å…æ—¥åéœ€è¦è¿›è¡Œæ›´æ”¹ã€‚</li><li><strong>ä½¿ç”¨å•ä¸ªåˆ†åŒº</strong>ï¼šå¯¹äºä¸¥æ ¼é¡ºåºè¦æ±‚çš„åœºæ™¯ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨å•åˆ†åŒºä¸»é¢˜ã€‚è™½ç„¶è¿™ä¼šé™åˆ¶ååé‡å’Œå¹¶å‘æ€§ï¼Œä½†å¯ä»¥ä¿è¯æ¶ˆæ¯çš„å…¨å±€é¡ºåºã€‚</li><li><strong>ä½¿ç”¨å…¶ä»–ç­–ç•¥ä¿æŒé¡ºåº</strong>ï¼šåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯ä»¥é€šè¿‡åœ¨åº”ç”¨å±‚å®ç°é€»è¾‘æ¥ä¿æŒé¡ºåºï¼Œæ¯”å¦‚åœ¨æ¶ˆæ¯ä¸­åŒ…å«é¡ºåºå·æˆ–æ—¶é—´æˆ³ï¼Œå¹¶åœ¨æ¶ˆè´¹æ—¶æ ¹æ®è¿™äº›ä¿¡æ¯é‡å»ºæ­£ç¡®çš„é¡ºåºã€‚</li><li><strong>ä½¿ç”¨é™æ€æˆå‘˜åŠŸèƒ½</strong>ï¼šå®ƒå…è®¸æ¶ˆè´¹è€…åœ¨æ–­å¼€å’Œé‡æ–°è¿æ¥æ—¶ä¿æŒå…¶æ¶ˆè´¹è€…ç»„å†…çš„èº«ä»½ï¼Œè¿™å¯ä»¥å‡å°‘å› çŸ­æš‚çš„ç½‘ç»œé—®é¢˜æˆ–æ¶ˆè´¹è€…é‡å¯å¯¼è‡´çš„ä¸å¿…è¦çš„é‡å¹³è¡¡ã€‚</li></ul><p>ä¸Šé¢è¿™äº›æªæ–½ï¼Œåªèƒ½å‡å°‘é‡å¹³è¡¡å¸¦æ¥çš„é—®é¢˜ï¼Œå¹¶æ— æ³•æ ¹é™¤ï¼Œå¦‚æœéè¦å®ç°ä¸¥æ ¼æ„ä¹‰ä¸Šçš„é¡ºåºæ¶ˆæ¯ï¼Œè¦ä¹ˆåœ¨æ¶ˆæ¯ä¸­åŠ å…¥æ—¶é—´æˆ³ç­‰æ ‡è®°ï¼Œåœ¨ä¸šåŠ¡å±‚ä¿è¯é¡ºåºæ¶ˆè´¹ï¼Œè¦ä¹ˆå°±åªèƒ½é‡‡ç”¨<code>å•ä¸€ç”Ÿäº§è€…åŒæ­¥å‘é€ + å•ä¸€åˆ†åŒº +å•ä¸€æ¶ˆè´¹è€…åŒæ­¥æ¶ˆè´¹</code>è¿™ç§æ¨¡å¼äº†ã€‚</p><h3 id="é™æ€æˆå‘˜åŠŸèƒ½">é™æ€æˆå‘˜åŠŸèƒ½</h3><p>Kafka 2.3.0 ç‰ˆæœ¬å¼•å…¥äº†ä¸€é¡¹æ–°åŠŸèƒ½ï¼šé™æ€æˆå‘˜ï¼ˆStaticMembershipï¼‰ã€‚è¿™ä¸ªåŠŸèƒ½ä¸»è¦æ˜¯ä¸ºäº†å‡å°‘ç”±äºæ¶ˆè´¹è€…é‡å¹³è¡¡ï¼ˆrebalanceï¼‰å¼•èµ·çš„å¼€é”€å’Œå»¶è¿Ÿã€‚åœ¨ä¼ ç»Ÿçš„Kafkaæ¶ˆè´¹è€…ç»„ä¸­ï¼Œå½“æ–°çš„æ¶ˆè´¹è€…åŠ å…¥æˆ–ç¦»å¼€æ¶ˆè´¹è€…ç»„æ—¶ï¼Œä¼šè§¦å‘é‡å¹³è¡¡ã€‚è¿™ä¸ªè¿‡ç¨‹å¯èƒ½ä¼šå¯¼è‡´æ¶ˆæ¯çš„å¤„ç†å»¶è¿Ÿï¼Œå¹¶ä¸”åœ¨é«˜ååé‡çš„åœºæ™¯ä¸‹å¯èƒ½ä¼šå¯¹æ€§èƒ½é€ æˆå½±å“ã€‚é™æ€æˆå‘˜åŠŸèƒ½æ—¨åœ¨ç¼“è§£è¿™äº›é—®é¢˜ã€‚ä»¥ä¸‹æ˜¯å®ƒçš„ä¸€äº›å…³é”®ç‚¹ï¼š</p><p>é™æ€æˆå‘˜çš„å·¥ä½œåŸç†ï¼š</p><ol type="1"><li><p><strong>é™æ€æˆå‘˜æ ‡è¯†</strong>ï¼šæ¶ˆè´¹è€…åœ¨åŠ å…¥æ¶ˆè´¹è€…ç»„æ—¶å¯ä»¥æä¾›ä¸€ä¸ªé™æ€æˆå‘˜æ ‡è¯†ï¼ˆStaticMember IDï¼‰ã€‚è¿™å…è®¸ Kafka Brokerè¯†åˆ«ç‰¹å®šçš„æ¶ˆè´¹è€…å®ä¾‹ï¼Œè€Œä¸æ˜¯ä»…ä»…ä¾èµ–äºæ¶ˆè´¹è€…ç»„å†…çš„åŠ¨æ€åˆ†é…ã€‚</p></li><li><p><strong>é‡å¹³è¡¡ä¼˜åŒ–</strong>ï¼šå½“ä½¿ç”¨é™æ€æˆå‘˜åŠŸèƒ½æ—¶ï¼Œå¦‚æœä¸€ä¸ªå·²çŸ¥çš„æ¶ˆè´¹è€…ç”±äºæŸç§åŸå› ï¼ˆå¦‚ç½‘ç»œé—®é¢˜ï¼‰çŸ­æš‚æ–­å¼€åé‡æ–°è¿æ¥ï¼ŒKafkaä¸ä¼šç«‹å³è§¦å‘é‡å¹³è¡¡ã€‚ç›¸åï¼ŒKafkaä¼šç­‰å¾…ä¸€ä¸ªé¢„è®¾çš„è¶…æ—¶æœŸé™ï¼ˆsession.timeout.msï¼‰ï¼Œåœ¨æ­¤æœŸé—´å¦‚æœæ¶ˆè´¹è€…é‡æ–°è¿æ¥ï¼Œå®ƒå°†ä¿ç•™åŸæ¥çš„åˆ†åŒºåˆ†é…ã€‚</p></li><li><p><strong>å‡å°‘é‡å¹³è¡¡æ¬¡æ•°</strong>ï¼šè¿™å¤§å¤§å‡å°‘äº†ç”±äºæ¶ˆè´¹è€…å´©æºƒå’Œæ¢å¤ã€ç½‘ç»œé—®é¢˜æˆ–ç»´æŠ¤æ“ä½œå¼•èµ·çš„ä¸å¿…è¦çš„é‡å¹³è¡¡æ¬¡æ•°ã€‚</p></li></ol><p>ä½¿ç”¨é™æ€æˆå‘˜çš„ä¼˜ç‚¹ï¼š</p><ol type="1"><li><p><strong>æé«˜ç¨³å®šæ€§</strong>ï¼šå‡å°‘é‡å¹³è¡¡å¯ä»¥æé«˜æ¶ˆè´¹è€…ç»„çš„æ•´ä½“ç¨³å®šæ€§ï¼Œå°¤å…¶æ˜¯åœ¨å¤§å‹æ¶ˆè´¹è€…ç»„å’Œé«˜ååé‡çš„æƒ…å†µä¸‹ã€‚</p></li><li><p><strong>å‡å°‘å»¶è¿Ÿ</strong>ï¼šç”±äºå‡å°‘äº†é‡å¹³è¡¡çš„æ¬¡æ•°ï¼Œå¯ä»¥å‡å°‘å› é‡å¹³è¡¡å¯¼è‡´çš„æ¶ˆæ¯å¤„ç†å»¶è¿Ÿã€‚</p></li><li><p><strong>æŒä¹…çš„æ¶ˆè´¹è€…åˆ†åŒºåˆ†é…</strong>ï¼šè¿™ä½¿å¾—æ¶ˆè´¹è€…åœ¨åˆ†åŒºåˆ†é…ä¸Šæ›´åŠ æŒä¹…ï¼Œæœ‰åŠ©äºæ›´å¥½åœ°ç®¡ç†å’Œä¼˜åŒ–æ¶ˆæ¯çš„æ¶ˆè´¹ã€‚</p></li></ol><p>å¦‚ä½•ä½¿ç”¨ï¼š</p><ul><li>è¦ä½¿ç”¨é™æ€æˆå‘˜åŠŸèƒ½ï¼Œéœ€è¦åœ¨ Kafka æ¶ˆè´¹è€…çš„é…ç½®ä¸­è®¾ç½®<code>group.instance.id</code>ã€‚è¿™ä¸ª IDåº”è¯¥æ˜¯å”¯ä¸€çš„ï¼Œå¹¶ä¸”åœ¨æ¶ˆè´¹è€…é‡å¯æˆ–é‡æ–°è¿æ¥æ—¶ä¿æŒä¸å˜ã€‚åŒæ—¶ï¼Œè¿˜éœ€è¦é…ç½®<code>session.timeout.ms</code>ï¼Œä»¥å†³å®šåœ¨è§¦å‘é‡å¹³è¡¡ä¹‹å‰æ¶ˆè´¹è€…å¯ä»¥ç¦»çº¿å¤šé•¿æ—¶é—´ã€‚</li></ul><p>æ³¨æ„äº‹é¡¹ï¼š</p><ul><li>è™½ç„¶é™æ€æˆå‘˜åŠŸèƒ½å¯ä»¥å‡å°‘é‡å¹³è¡¡çš„å‘ç”Ÿï¼Œä½†å®ƒä¸ä¼šå®Œå…¨æ¶ˆé™¤é‡å¹³è¡¡ã€‚åœ¨æ¶ˆè´¹è€…ç»„æˆå‘˜çš„é•¿æœŸå˜åŒ–ï¼ˆå¦‚æ–°æ¶ˆè´¹è€…çš„åŠ å…¥æˆ–æ°¸ä¹…ç¦»å¼€ï¼‰æ—¶ï¼Œä»ç„¶ä¼šå‘ç”Ÿé‡å¹³è¡¡ã€‚</li><li>éœ€è¦åˆç†è®¾ç½®<code>session.timeout.ms</code>ï¼Œä»¥é¿å…æ¶ˆè´¹è€…ç”±äºçŸ­æš‚çš„ç½‘ç»œé—®é¢˜æˆ–å…¶ä»–åŸå› çš„æ–­å¼€è€Œè¿‡æ—©è§¦å‘é‡å¹³è¡¡ã€‚</li></ul><p>é™æ€æˆå‘˜åŠŸèƒ½åœ¨å¤„ç†å¤§è§„æ¨¡ Kafkaåº”ç”¨æ—¶å°¤å…¶æœ‰ç”¨ï¼Œå®ƒæä¾›äº†ä¸€ç§æœºåˆ¶æ¥ä¼˜åŒ–æ¶ˆè´¹è€…ç»„çš„æ€§èƒ½å’Œç¨³å®šæ€§ã€‚</p><h3 id="å¹‚ç­‰æ€§">å¹‚ç­‰æ€§</h3><p>Kafka 0.11ç‰ˆæœ¬åæä¾›äº†å¹‚ç­‰æ€§ç”Ÿäº§è€…ï¼Œè¿™æ„å‘³ç€å³ä½¿ç”Ÿäº§è€…å› ä¸ºæŸäº›é”™è¯¯é‡è¯•å‘é€ç›¸åŒçš„æ¶ˆæ¯ï¼Œè¿™äº›æ¶ˆæ¯ä¹Ÿåªä¼šè¢«è®°å½•ä¸€æ¬¡ã€‚è¿™æ˜¯é€šè¿‡ç»™æ¯ä¸€æ‰¹å‘é€åˆ°Kafka çš„æ¶ˆæ¯åˆ†é…ä¸€ä¸ªåºåˆ—å·å®ç°çš„ï¼Œbrokerä½¿ç”¨è¿™ä¸ªåºåˆ—å·æ¥åˆ é™¤é‡å¤å‘é€çš„æ¶ˆæ¯ã€‚ä½¿ç”¨å¹‚ç­‰æ€§ç”Ÿäº§è€…ï¼Œå¯ä»¥å‡å°‘é‡å¤æ¶ˆæ¯çš„é£é™©ï¼Œè¿™æ„å‘³ç€å³ä½¿åœ¨ç½‘ç»œé‡è¯•ç­‰æƒ…å†µä¸‹ï¼Œæ¶ˆæ¯çš„é¡ºåºä¹Ÿèƒ½å¾—åˆ°æ›´å¥½çš„ä¿è¯ã€‚å› ä¸ºé‡å¤æ¶ˆæ¯ä¸ä¼šè¢«å¤šæ¬¡è®°å½•ï¼Œæ‰€ä»¥ä¸ä¼šç ´åå·²æœ‰æ¶ˆæ¯çš„é¡ºåºã€‚</p><h2id="å…¶ä»–å¸¸è§æ¶ˆæ¯é˜Ÿåˆ—é¡ºåºæ¶ˆæ¯çš„å®ç°">å…¶ä»–å¸¸è§æ¶ˆæ¯é˜Ÿåˆ—é¡ºåºæ¶ˆæ¯çš„å®ç°</h2><h3 id="pulsar">Pulsar</h3><p>Pulsar å’Œ Kafka ä¸€æ ·ï¼Œéƒ½æ˜¯é€šè¿‡ç”Ÿäº§ç«¯æŒ‰ Key Hashçš„æ–¹æ¡ˆå°†æ•°æ®å†™å…¥åˆ°åŒä¸€ä¸ªåˆ†åŒºã€‚</p><h3 id="rabbitmq">RabbitMQ</h3><p>RabbitMQ åœ¨ç”Ÿäº§æ—¶æ²¡æœ‰ç”Ÿäº§åˆ†åŒºåˆ†é…çš„è¿‡ç¨‹ã€‚å®ƒæ˜¯é€šè¿‡<code>Exchange</code> å’Œ <code>Route Key</code>æœºåˆ¶æ¥å®ç°é¡ºåºæ¶ˆæ¯çš„ã€‚<code>Exchange</code> ä¼šæ ¹æ®è®¾ç½®å¥½çš„<code>Route Key</code> å°†æ•°æ®è·¯ç”±åˆ°ä¸åŒçš„ <code>Queue</code>ä¸­å­˜å‚¨ã€‚æ­¤æ—¶ <code>Route Key</code> çš„ä½œç”¨å’Œ Kafka çš„æ¶ˆæ¯çš„<code>Key</code> æ˜¯ä¸€æ ·çš„ã€‚</p><h3 id="rocketmq">RocketMQ</h3><p>RocektMQæ”¯æŒ<code>æ¶ˆæ¯ç»„ï¼ˆMessageGroupï¼‰</code>çš„æ¦‚å¿µã€‚åœ¨ç”Ÿäº§ç«¯æŒ‡å®šæ¶ˆæ¯ç»„ï¼Œåˆ™åŒä¸€ä¸ªæ¶ˆæ¯ç»„çš„æ¶ˆæ¯å°±ä¼šè¢«å‘é€åˆ°åŒä¸€ä¸ªåˆ†åŒºä¸­ã€‚æ­¤æ—¶è¿™ä¸ªæ¶ˆæ¯ç»„èµ·åˆ°çš„ä½œç”¨å’ŒKakfa çš„æ¶ˆæ¯çš„ Key æ˜¯ä¸€æ ·çš„ã€‚</p><h2 id="å®æˆ˜-kafka-å®ç°é¡ºåºæ¶ˆæ¯">å®æˆ˜ Kafka å®ç°é¡ºåºæ¶ˆæ¯</h2><blockquote><p>ä»£ç ä»“åº“ï¼šhttps://github.com/hedon954/kafka-go-examples/tree/master/orderedmsg</p></blockquote><p>ä¸‹é¢æˆ‘ä»¬æ¥å†™ä¸€å†™å®æˆ˜ç”¨ä¾‹ï¼Œæ›´åŠ ç›´è§‚åœ°æ„Ÿå—ä¸€ä¸‹ Kafkaé¡ºåºæ¶ˆæ¯çš„å®ç°ç»†èŠ‚ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬åœ¨é›†ç¾¤ä¸Šåˆ›å»ºä¸€ä¸ª topic <code>ordered-msg-topic</code>ï¼Œåˆ†åŒºä¸º<code>3</code> ä¸ªï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">/opt/kafka-3.6.0/bin/kafka-topics.sh --bootstrap-server localhost:9092 --create --topic ordered-msg-topic --partitions 3 --replication-factor 1<br></code></pre></td></tr></table></figure><p>æ­å»º Kafka é›†ç¾¤å¯ä»¥çœ‹è¿™ä¸¤ç¯‡ï¼š<ahref="https://hedon.top/2023/11/22/kakfa-cluster-deploy/">Kafkaé›†ç¾¤æ­å»º(Zookeeper)</a>ã€<ahref="https://hedon.top/2023/11/22/kafka-kraft-deploy/">Kafkaé›†ç¾¤æ­å»º(KRaft)</a>ã€‚</p><h3 id="å•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…">å•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…</h3><p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œä½¿ç”¨å•ä¸€ç”Ÿäº§è€…åŒæ­¥å‘é€å’Œå•ä¸€æ¶ˆè´¹è€…åŒæ­¥å‘é€ï¼Œåªè¦æˆ‘ä»¬ä¿è¯key æ˜¯å›ºå®šçš„ï¼Œåˆ™æ‰€æœ‰æ¶ˆæ¯éƒ½ä¼šå†™åˆ°åŒä¸€ä¸ªåˆ†åŒºï¼Œæ˜¯å¯ä»¥å®ç°é¡ºåºæ¶ˆæ¯çš„ã€‚</p><p>ä»£ç ç›®å½•å¦‚ä¸‹ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">â”œâ”€config<br>â”‚      config.go<span class="hljs-comment"># å¸¸é‡å®šä¹‰</span><br>â”œâ”€consumer<br>â”‚      consumer.go<span class="hljs-comment"># æ¶ˆè´¹è€…</span><br>â””â”€producer<br>        producer.go<span class="hljs-comment"># ç”Ÿäº§è€…</span><br></code></pre></td></tr></table></figure><p>é¦–å…ˆæˆ‘ä»¬å…ˆå®šä¹‰ä¸€äº›å¸¸é‡ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;github.com/segmentio/kafka-go&quot;</span><br><br><span class="hljs-keyword">var</span> (<br>Topic      = <span class="hljs-string">&quot;ordered-msg-topic&quot;</span><br>Brokers    = []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;kafka1.com:9092&quot;</span>, <span class="hljs-string">&quot;kafka2.com:9092&quot;</span>, <span class="hljs-string">&quot;kafka3.com:9092&quot;</span>&#125;<br>Addr       = kafka.TCP(Brokers...)<br>GroupId    = <span class="hljs-string">&quot;ordered-msg-group&quot;</span><br>MessageKey = []<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;message-key&quot;</span>)<br>)<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆå®ç°ç”Ÿäº§è€…ç«¯ï¼Œä¸»è¦æ˜¯ä¸æ–­å¾€ <code>ordered-msg-topic</code>ä¸­å†™å…¥æ•°æ®ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;context&quot;</span><br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;time&quot;</span><br><br><span class="hljs-string">&quot;kafka-go-examples/orderedmsg/config&quot;</span><br><br><span class="hljs-string">&quot;github.com/segmentio/kafka-go&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewProducer</span><span class="hljs-params">()</span></span> *kafka.Writer &#123;<br><span class="hljs-keyword">return</span> &amp;kafka.Writer&#123;<br>Addr:     config.Addr,<br>Topic:    config.Topic,<br>Balancer: &amp;kafka.Hash&#123;&#125;, <span class="hljs-comment">// å“ˆå¸Œåˆ†åŒº</span><br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewMessages</span><span class="hljs-params">(count <span class="hljs-type">int</span>)</span></span> []kafka.Message &#123;<br>res := <span class="hljs-built_in">make</span>([]kafka.Message, count)<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; count; i++ &#123;<br>res[i] = kafka.Message&#123;<br>Key:   config.MessageKey,<br>Value: []<span class="hljs-type">byte</span>(fmt.Sprintf(<span class="hljs-string">&quot;msg-%d&quot;</span>, i+<span class="hljs-number">1</span>)),<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> res<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>producer := NewProducer()<br>messages := NewMessages(<span class="hljs-number">100</span>)<br><span class="hljs-keyword">if</span> err := producer.WriteMessages(context.Background(), messages...); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(err)<br>&#125;<br>_ = producer.Close()<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å†æ¥å®ç°æ¶ˆè´¹è€…ï¼Œç›®å‰æˆ‘ä»¬å°±å¯åŠ¨ 1 ä¸ªæ¶ˆè´¹è€…ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;context&quot;</span><br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;time&quot;</span><br><br><span class="hljs-string">&quot;kafka-go-examples/orderedmsg/config&quot;</span><br><br><span class="hljs-string">&quot;github.com/segmentio/kafka-go&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> Consumer <span class="hljs-keyword">struct</span> &#123;<br>Id <span class="hljs-type">string</span><br>*kafka.Reader<br>&#125;<br><br><span class="hljs-comment">// NewConsumer åˆ›å»ºä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œå®ƒå±äº config.GroupId è¿™ä¸ªæ¶ˆè´¹è€…ç»„</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewConsumer</span><span class="hljs-params">(id <span class="hljs-type">string</span>)</span></span> *Consumer &#123;<br>c := &amp;Consumer&#123;<br>Id: id,<br>Reader: kafka.NewReader(kafka.ReaderConfig&#123;<br>Brokers: config.Brokers,<br>GroupID: config.GroupId,<br>Topic:   config.Topic,<br>Dialer: &amp;kafka.Dialer&#123;<br>ClientID: id,<br>&#125;,<br>&#125;),<br>&#125;<br><span class="hljs-keyword">return</span> c<br>&#125;<br><br><span class="hljs-comment">// Read è¯»å–æ¶ˆæ¯ï¼ŒintervalMs ç”¨æ¥æ§åˆ¶æ¶ˆè´¹è€…çš„æ¶ˆè´¹é€Ÿåº¦</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Consumer)</span></span> Read(intervalMs <span class="hljs-type">int</span>) &#123;<br>fmt.Printf(<span class="hljs-string">&quot;%s start read\n&quot;</span>, c.Id)<br><span class="hljs-keyword">for</span> &#123;<br>msg, err := c.ReadMessage(context.Background())<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;%s read msg err: %v\n&quot;</span>, c.Id, err)<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-comment">// æ¨¡æ‹Ÿæ¶ˆè´¹é€Ÿåº¦</span><br>time.Sleep(time.Millisecond * time.Duration(intervalMs))<br>fmt.Printf(<span class="hljs-string">&quot;%s read msg: %s, time: %s\n&quot;</span>, c.Id, <span class="hljs-type">string</span>(msg.Value), time.Now().Format(<span class="hljs-string">&quot;03-04-05&quot;</span>))<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>c1 := NewConsumer(<span class="hljs-string">&quot;consumer-1&quot;</span>)<br>c1.Read(<span class="hljs-number">500</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯åŠ¨ç”Ÿäº§è€…ç”Ÿäº§æ¶ˆæ¯ï¼Œç„¶åå¯åŠ¨æ¶ˆè´¹è€…ï¼Œè§‚å¯Ÿæ§åˆ¶å°ï¼Œä¸éš¾çœ‹å‡ºè¿™ç§æƒ…å†µä¸‹å°±æ˜¯é¡ºåºæ¶ˆè´¹ï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs tex">consumer-1 read msg: msg-10, time: 04:29:10<br>consumer-1 read msg: msg-11, time: 04:29:11<br>consumer-1 read msg: msg-12, time: 04:29:12<br>consumer-1 read msg: msg-13, time: 04:29:13<br>consumer-1 read msg: msg-14, time: 04:29:14<br>consumer-1 read msg: msg-15, time: 04:29:15<br>consumer-1 read msg: msg-16, time: 04:29:16<br></code></pre></td></tr></table></figure><h3 id="é‡å¹³è¡¡å¸¦æ¥çš„é—®é¢˜-1">é‡å¹³è¡¡å¸¦æ¥çš„é—®é¢˜</h3><p>æˆ‘ä»¬å…ˆé‡å»º topicï¼Œæ¸…æ¥šæ‰ä¹‹å‰çš„æ•°æ®ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">/opt/kafka-3.6.0/bin/kafka-topics.sh --bootstrap-server localhost:9092 --delete --topic ordered-msg-topic<br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">/opt/kafka-3.6.0/bin/kafka-topics.sh --bootstrap-server localhost:9092 --create --topic ordered-msg-topic --partitions 3 --replication-factor 1<br></code></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬æ¥é‡‡ç”¨æ¶ˆè´¹è€…ç»„çš„å½¢å¼æ¶ˆè´¹æ¶ˆæ¯ï¼Œåœ¨è¿™æœŸé—´ï¼Œæˆ‘ä»¬ä¸æ–­å¾€æ¶ˆè´¹è€…ç»„ä¸­æ–°å¢æ¶ˆè´¹è€…ï¼Œä½¿å…¶å‘ç”Ÿé‡å¹³è¡¡ï¼Œæˆ‘ä»¬æ¥è§‚å¯Ÿä¸‹æ¶ˆæ¯çš„æ¶ˆè´¹æƒ…å†µã€‚</p><p>ä¿®æ”¹æ¶ˆè´¹è€…ç«¯çš„ main()ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// å…ˆå¯åŠ¨ c1</span><br>c1 := NewConsumer(<span class="hljs-string">&quot;consumer-1&quot;</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>c1.Read(<span class="hljs-number">500</span>)<br>&#125;()<br><br><span class="hljs-comment">// 5 ç§’åå¯åŠ¨ c2</span><br>time.Sleep(<span class="hljs-number">5</span> * time.Second)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>c2 := NewConsumer(<span class="hljs-string">&quot;consumer-2&quot;</span>)<br>c2.Read(<span class="hljs-number">300</span>)<br>&#125;()<br><br><span class="hljs-comment">// å† 10 ç§’åå¯åŠ¨ c3 å’Œ c4</span><br>time.Sleep(<span class="hljs-number">10</span> * time.Second)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>c3 := NewConsumer(<span class="hljs-string">&quot;consumer-3&quot;</span>)<br>c3.Read(<span class="hljs-number">100</span>)<br>&#125;()<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>c4 := NewConsumer(<span class="hljs-string">&quot;consumer-4&quot;</span>)<br>c4.Read(<span class="hljs-number">100</span>)<br>&#125;()<br><br><span class="hljs-keyword">select</span> &#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…ˆå¯åŠ¨ç”Ÿäº§è€…é‡æ–°ç”Ÿäº§æ•°æ®ï¼Œç„¶åå†å¯åŠ¨æ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ®ï¼Œè§‚å¯Ÿæ§åˆ¶å°ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash">consumer-1 start <span class="hljs-built_in">read</span><br>consumer-1 <span class="hljs-built_in">read</span> msg: msg-1, time: 04:44:28<br>consumer-1 <span class="hljs-built_in">read</span> msg: msg-2, time: 04:44:28<br>consumer-1 <span class="hljs-built_in">read</span> msg: msg-3, time: 04:44:29<span class="hljs-comment"># consumer-1 æŒ‰é¡ºåºæ¶ˆè´¹</span><br>consumer-2 start <span class="hljs-built_in">read</span>  <span class="hljs-comment"># consumer-2 è¿›æ¥</span><br>consumer-1 <span class="hljs-built_in">read</span> msg: msg-4, time: 04:44:30<br>consumer-1 <span class="hljs-built_in">read</span> msg: msg-5, time: 04:44:30<br>consumer-1 <span class="hljs-built_in">read</span> msg: msg-6, time: 04:44:31      <span class="hljs-comment"># è¿™é‡Œç›¸å·®äº† 6sï¼Œå°±æ˜¯åœ¨è¿›è¡Œé‡å¹³è¡¡</span><br>consumer-2 <span class="hljs-built_in">read</span> msg: msg-7, time: 04:44:37      <span class="hljs-comment"># é‡å¹³è¡¡åå‘ç°åŸæ¥çš„åˆ†åŒºç»™ consumer-2 æ¶ˆè´¹äº†</span><br>consumer-1 <span class="hljs-built_in">read</span> msg: msg-7, time: 04:44:37    <span class="hljs-comment"># è¿™é‡Œå‘ç”Ÿäº†é‡å¤æ¶ˆè´¹</span><br>consumer-2 <span class="hljs-built_in">read</span> msg: msg-8, time: 04:44:37<br>consumer-2 <span class="hljs-built_in">read</span> msg: msg-9, time: 04:44:37<br>consumer-2 <span class="hljs-built_in">read</span> msg: msg-10, time: 04:44:38<br>consumer-2 <span class="hljs-built_in">read</span> msg: msg-11, time: 04:44:38<br>consumer-2 <span class="hljs-built_in">read</span> msg: msg-12, time: 04:44:38<br>consumer-2 <span class="hljs-built_in">read</span> msg: msg-13, time: 04:44:39<br>consumer-2 <span class="hljs-built_in">read</span> msg: msg-14, time: 04:44:39<br>consumer-2 <span class="hljs-built_in">read</span> msg: msg-15, time: 04:44:39      <span class="hljs-comment"># consumer-2 æŒ‰é¡ºåºæ¶ˆæ¯</span><br>consumer-4 start <span class="hljs-built_in">read</span>   <span class="hljs-comment"># consumer-3 å’Œ consumer-4 è¿›æ¥</span><br>consumer-3 start <span class="hljs-built_in">read</span><br>consumer-2 <span class="hljs-built_in">read</span> msg: msg-16, time: 04:44:40   <br>consumer-4 <span class="hljs-built_in">read</span> msg: msg-17, time: 04:44:46      <span class="hljs-comment"># è¿™é‡Œå‘ç”Ÿé‡å¹³è¡¡</span><br>consumer-4 <span class="hljs-built_in">read</span> msg: msg-18, time: 04:44:46      <span class="hljs-comment"># é‡å¹³è¡¡åç”± consumer-4 è´Ÿè´£è¯¥åˆ†åŒº</span><br>consumer-2 <span class="hljs-built_in">read</span> msg: msg-17, time: 04:44:46      <span class="hljs-comment"># è¿™é‡Œç”±äº 2 çš„é€Ÿåº¦æ¯” 4 æ…¢å¾ˆå¤šï¼Œæ‰€ä»¥å°±ä¹±åºäº†ï¼Œè¿˜é‡å¤æ¶ˆè´¹</span><br>consumer-4 <span class="hljs-built_in">read</span> msg: msg-19, time: 04:44:46<br>consumer-4 <span class="hljs-built_in">read</span> msg: msg-20, time: 04:44:46<br><span class="hljs-comment"># ...</span><br></code></pre></td></tr></table></figure><h3 id="æ€»ç»“">æ€»ç»“</h3><p>å½“æˆ‘ä»¬é‡‡ç”¨æ¶ˆè´¹è€…ç»„çš„æ—¶å€™ï¼Œç”±äºé‡å¹³è¡¡æœºåˆ¶çš„å­˜åœ¨ï¼Œå•çº¯ä» Kafkaçš„è§’åº¦æ¥è¯´æ˜¯æ— æ³•å®Œå…¨å®ç°é¡ºåºæ¶ˆæ¯çš„ï¼Œåªèƒ½é€šè¿‡é™æ€æˆå‘˜åŠŸèƒ½ã€é¿å…åˆ†åŒºæ•°é‡å˜åŒ–å’Œå‡å°‘æ¶ˆè´¹è€…ç»„æˆå‘˜æ•°é‡å˜åŒ–ç­‰æ–¹å¼æ¥å°½å¯èƒ½å‡å°‘é‡å¹³è¡¡çš„å‘ç”Ÿï¼Œè¿›è€Œå°½å¯èƒ½ç»´æŒæ¶ˆæ¯çš„é¡ºåºæ€§ã€‚</p><h2 id="å‚è€ƒ">å‚è€ƒ</h2><ul><li><a href="https://time.geekbang.com/column/intro/100552001">æå®¢æ—¶é—´- æ·±å…¥æ‹†è§£æ¶ˆæ¯é˜Ÿåˆ— 47 è®²ï¼ˆè®¸æ–‡å¼ºï¼‰</a></li><li><a href="https://www.qidian.com/book/1035938080/">ã€ŠKafkaæƒå¨æŒ‡å—ï¼ˆç¬¬ 2 ç‰ˆï¼‰ã€‹</a></li><li><ahref="https://pulsar.staged.apache.org/docs/zh-CN/next/concepts-messaging/#%E9%A1%BA%E5%BA%8F%E4%BF%9D%E8%AF%81">Pulsarå®˜æ–¹æ–‡æ¡£-åˆ†åŒºtopic-é¡ºåºä¿è¯</a></li><li><ahref="https://rocketmq.apache.org/zh/docs/featureBehavior/03fifomessage">RocketMQå®˜æ–¹æ–‡æ¡£-åŠŸèƒ½ç‰¹æ€§-é¡ºåºæ¶ˆæ¯</a></li><li><ahref="https://www.rabbitmq.com/tutorials/tutorial-two-go.html">RabbitMQå®˜æ–¹æ–‡æ¡£</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Kafka</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Kafka</tag>
      
      <tag>ä¸­é—´ä»¶</tag>
      
      <tag>æ¶ˆæ¯é˜Ÿåˆ—</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Kafka é›†ç¾¤éƒ¨ç½²ï¼ˆKRaftï¼‰</title>
    <link href="/2023/11/22/kafka-kraft-deploy/"/>
    <url>/2023/11/22/kafka-kraft-deploy/</url>
    
    <content type="html"><![CDATA[<h2 id="ç‰ˆæœ¬è¯´æ˜">ç‰ˆæœ¬è¯´æ˜</h2><ul><li>Ubuntu 18.04.6</li><li>Kafka 3.6.0</li><li>JDK8</li></ul><h2 id="é›†ç¾¤é…ç½®">é›†ç¾¤é…ç½®</h2><table><thead><tr class="header"><th style="text-align: center;">æ“ä½œç³»ç»Ÿ</th><th style="text-align: center;">ip</th><th style="text-align: center;">åŸŸå</th><th style="text-align: center;">Kafka Broker ç«¯å£</th><th style="text-align: center;">Kafka Controller ç«¯å£</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">Ubuntu 18.04.6</td><td style="text-align: center;">192.168.50.131</td><td style="text-align: center;">kafka1.com</td><td style="text-align: center;">9092</td><td style="text-align: center;">9093</td></tr><tr class="even"><td style="text-align: center;">Ubuntu 18.04.6</td><td style="text-align: center;">192.168.50.132</td><td style="text-align: center;">kafka2.com</td><td style="text-align: center;">9092</td><td style="text-align: center;">9093</td></tr><tr class="odd"><td style="text-align: center;">Ubuntu 18.04.6</td><td style="text-align: center;">192.168.50.133</td><td style="text-align: center;">kafka3.com</td><td style="text-align: center;">9092</td><td style="text-align: center;">9093</td></tr></tbody></table><h2 id="å®‰è£…-vim-curl">å®‰è£… vim, curl</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo apt update<br>sudo apt install vim<br>sudo apt install curl<br></code></pre></td></tr></table></figure><h2 id="é…ç½®é™æ€-ip-å’Œ-hosts">é…ç½®é™æ€ ip å’Œ hosts</h2><p>ä¸ºäº†ä½¿ç”¨åŸŸåï¼Œæ›´åŠ æ–¹ä¾¿çš„è¿›è¡Œé…ç½®ï¼Œè¿™é‡Œå°†è™šæ‹Ÿæœºçš„ DHCP æ”¹æˆäº†é™æ€åˆ†é…IPï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨è®¾ç½®ä¸€ä¸‹æ¯å°æœºå™¨ IP åœ°å€ï¼Œè¿™é‡Œä»¥<code>192.168.50.131</code> ä¸ºä¾‹ã€‚</p><ol type="1"><li><p>æ‰¾åˆ°ç½‘ç»œæ¥å£åç§°ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">ip addr<br></code></pre></td></tr></table></figure><p>æŸ¥æ‰¾ä»¥ <code>ens</code> æˆ– <code>eth</code>å¼€å¤´çš„æ¥å£åç§°ã€‚ä¾‹å¦‚ï¼Œ<code>ens33</code> æˆ– <code>eth0</code>ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh">hedon@ubuntu:~$ ip addr<br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    <span class="hljs-built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    <span class="hljs-built_in">link</span>/ether 00:0c:29:82:9e:69 brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.50.133/24 brd 192.168.50.255 scope global dynamic noprefixroute ens33<br>       valid_lft 1644sec preferred_lft 1644sec<br>    inet6 fe80::c367:c7cc:3ad4:23b3/64 scope <span class="hljs-built_in">link</span> <br>       valid_lft forever preferred_lft forever<br></code></pre></td></tr></table></figure><p>å¯ä»¥æ‰¾åˆ° <code>ens33</code>ï¼Œå…¶ä¸­ <code>inet 192.168.50.133/24</code>è¡¨ç¤º IP åœ°å€ä¸º <code>192.168.50.133</code>ï¼Œå­ç½‘æ©ç ä¸º<code>/24</code>ï¼ˆç­‰äº <code>255.255.255.0</code>ï¼‰ã€‚</p><p>è¿™ä¸ª IP åœ°å€æ˜¯ DHCP åŠ¨æ€åˆ†é…çš„ï¼Œè¯´æ˜å®¿ä¸»æœºåˆ†é…ç»™è™šæ‹Ÿæœºçš„ IP èŒƒå›´å°±åœ¨<code>192.168.50.xxx</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šå°†é™æ€ IPé…ç½®åœ¨è¿™ä¸ªèŒƒå›´å†…ã€‚</p></li><li><p>è·å–ç½‘å…³åœ°å€</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">ip route | grep default<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">hedon@ubuntu:~$ ip route | grep default<br>default via 192.168.50.2 dev ens33 proto dhcp metric 100<br></code></pre></td></tr></table></figure><p>è¯´æ˜é»˜è®¤ç½‘å…³æ˜¯ <code>192.168.50.2</code>ï¼Œ</p></li><li><p>ç¼–è¾‘ <code>/etc/network/interfaces</code> æ–‡ä»¶ï¼Œé…ç½®é™æ€ IPåœ°å€ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs tex">auto ens33<br>iface ens33 inet static<br>   address 192.168.50.131<br>   netmask 255.255.255.0<br>   gateway 192.168.50.2<br>   dns-nameservers 8.8.8.8 8.8.4.4<br></code></pre></td></tr></table></figure></li><li><p>é‡å¯</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">su reboot<br></code></pre></td></tr></table></figure></li><li><p>å†æ¬¡æŸ¥çœ‹ ip åœ°å€</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">ip addr<br></code></pre></td></tr></table></figure><p>æœ‰ä»¥ä¸‹è¾“å‡ºä¾¿è¯´æ˜é™æ€ IP é…ç½®æˆåŠŸäº†ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    <span class="hljs-built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    <span class="hljs-built_in">link</span>/ether 00:0c:29:82:9e:69 brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.50.131/24 brd 192.168.50.255 scope global ens33<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:fe82:9e69/64 scope <span class="hljs-built_in">link</span> <br>       valid_lft forever preferred_lft forever<br></code></pre></td></tr></table></figure></li><li><p>é…ç½®åŸŸå</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo vim /etc/hosts<br></code></pre></td></tr></table></figure><p>è¿½åŠ å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">192.168.50.131 kafka1.com<br>192.168.50.132 kafka2.com<br>192.168.50.133 kafka3.com<br></code></pre></td></tr></table></figure></li><li><p>ping ä¸€ä¸‹</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh">hedon@ubuntu:~$ ping kafka1.com<br>PING kafka1.com (192.168.50.131) 56(84) bytes of data.<br>64 bytes from kafka1.com (192.168.50.131): icmp_seq=1 ttl=64 time=0.024 ms<br>64 bytes from kafka1.com (192.168.50.131): icmp_seq=2 ttl=64 time=0.021 ms<br>64 bytes from kafka1.com (192.168.50.131): icmp_seq=3 ttl=64 time=0.029 ms<br>^C<br>--- kafka1.com ping statistics ---<br>3 packets transmitted, 3 received, 0% packet loss, time 2029ms<br>rtt min/avg/max/mdev = 0.021/0.024/0.029/0.006 ms<br></code></pre></td></tr></table></figure></li><li><p>ping ä¸€ä¸‹ç™¾åº¦ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½è®¿é—®å¤–ç½‘</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">hedon@ubuntu:~$ ping baidu.com<br>ping: baidu.com: Name or service not known<br></code></pre></td></tr></table></figure><p>å¦‚æœè¿™é‡Œå¯ä»¥è®¿é—®ï¼Œåˆ™ç›´æ¥è·³è¿‡è¿›å…¥ä¸‹ä¸€æ­¥ï¼Œä¸å¯ä»¥çš„è¯ï¼Œéœ€è¦é…ç½®ä¸€ä¸‹åŸŸåè§£æç³»ç»Ÿã€‚</p></li><li><p>é…ç½®åŸŸåè§£æç³»ç»Ÿ</p><p>Ubuntu ç³»ç»Ÿä½¿ç”¨ <code>systemd-resolved</code> æœåŠ¡æ¥ç®¡ç†DNSï¼Œä½ å¯ä»¥åœ¨ <code>/etc/systemd/resolved.conf</code> æ–‡ä»¶ä¸­è¿›è¡Œ DNSé…ç½®ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo vim /etc/systemd/resolved.conf<br></code></pre></td></tr></table></figure><p>å–æ¶ˆæˆ–æ·»åŠ  <code>DNS</code> çš„æ³¨é‡Šï¼Œå¹¶ä¿®æ”¹ä¸ºï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs tex">[Resolve]<br>DNS=8.8.8.8 8.8.4.4<br></code></pre></td></tr></table></figure><p>é‡å¯å¯åŠ¨ <code>systemd-resolved</code>ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo systemctl restart systemd-resolved<br></code></pre></td></tr></table></figure><p>å†å°è¯• ping ä¸€ä¸‹ç™¾åº¦ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh">hedon@ubuntu:~$ ping www.baidu.com<br>PING www.a.shifen.com (153.3.238.110) 56(84) bytes of data.<br>64 bytes from 153.3.238.110 (153.3.238.110): icmp_seq=1 ttl=128 time=15.9 ms<br>64 bytes from 153.3.238.110 (153.3.238.110): icmp_seq=2 ttl=128 time=15.9 ms<br>64 bytes from 153.3.238.110 (153.3.238.110): icmp_seq=3 ttl=128 time=16.1 ms<br>64 bytes from 153.3.238.110 (153.3.238.110): icmp_seq=4 ttl=128 time=15.3 ms<br>^C<br>--- www.a.shifen.com ping statistics ---<br>4 packets transmitted, 4 received, 0% packet loss, time 14104ms<br>rtt min/avg/max/mdev = 15.368/15.850/16.145/0.291 ms<br></code></pre></td></tr></table></figure></li></ol><div class="note note-info">            <p>è¡¥å……è¯´æ˜ï¼š<code>/etc/network/interfaces</code> æ–‡ä»¶çš„é…ç½®</p><p>è¿™æ˜¯ä¸€ä¸ªç”¨äºé…ç½® Linux ç³»ç»Ÿä¸Šç½‘ç»œæ¥å£çš„æ–‡ä»¶ã€‚åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä¸ºåä¸º<code>ens33</code> çš„ç½‘ç»œæ¥å£é…ç½®äº†é™æ€ IPåœ°å€å’Œç›¸å…³çš„ç½‘ç»œè®¾ç½®ã€‚ä¸‹é¢æ˜¯å„è¡Œçš„è§£é‡Šï¼š</p><ol type="1"><li><p><code>auto ens33</code>: è¿™ä¸€è¡Œè¡¨ç¤ºåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨æ¿€æ´»<code>ens33</code> ç½‘ç»œæ¥å£ã€‚<code>auto</code>å…³é”®å­—åé¢è·Ÿç€æ¥å£åç§°ã€‚</p></li><li><p><code>iface ens33 inet static</code>: è¿™ä¸€è¡Œå®šä¹‰äº†<code>ens33</code> ç½‘ç»œæ¥å£çš„é…ç½®ã€‚<code>iface</code>å…³é”®å­—åé¢è·Ÿç€æ¥å£åç§°ï¼Œ<code>inet</code> è¡¨ç¤ºæˆ‘ä»¬æ­£åœ¨é…ç½® IPv4åœ°å€ï¼Œ<code>static</code> è¡¨ç¤ºæˆ‘ä»¬è¦ä¸ºæ¥å£åˆ†é…ä¸€ä¸ªé™æ€ IPåœ°å€ï¼ˆè€Œä¸æ˜¯é€šè¿‡ DHCP è·å¾—ï¼‰ã€‚</p></li><li><p><code>address 192.168.50.131</code>: è¿™ä¸€è¡Œè®¾ç½®äº†ç½‘ç»œæ¥å£çš„é™æ€IP åœ°å€ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä¸º <code>ens33</code> æ¥å£åˆ†é…äº†<code>192.168.50.131</code> IP åœ°å€ã€‚</p><blockquote><p>IP åœ°å€æ˜¯ Internetåè®®ï¼ˆIPï¼‰ç”¨äºåœ¨ç½‘ç»œä¸­å”¯ä¸€æ ‡è¯†è®¾å¤‡çš„æ•°å­—æ ‡ç­¾ã€‚æ¯ä¸ªè¿æ¥åˆ°ç½‘ç»œçš„è®¾å¤‡éƒ½éœ€è¦ä¸€ä¸ªå”¯ä¸€çš„IP åœ°å€ï¼Œä»¥ä¾¿å…¶ä»–è®¾å¤‡å¯ä»¥æ‰¾åˆ°å¹¶ä¸ä¹‹é€šä¿¡ã€‚IP åœ°å€é€šå¸¸åˆ†ä¸ºä¸¤ç§ç‰ˆæœ¬ï¼šIPv4å’Œ IPv6ã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ª IPv4 åœ°å€ã€‚</p></blockquote></li><li><p><code>netmask 255.255.255.0</code>:è¿™ä¸€è¡Œå®šä¹‰äº†å­ç½‘æ©ç ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå­ç½‘æ©ç æ˜¯<code>255.255.255.0</code>ï¼Œè¡¨ç¤ºå‰ä¸‰ä¸ªå­—èŠ‚ï¼ˆ24ä½ï¼‰æ˜¯ç½‘ç»œåœ°å€ï¼Œæœ€åä¸€ä¸ªå­—èŠ‚ï¼ˆ8 ä½ï¼‰æ˜¯ä¸»æœºåœ°å€ã€‚</p><blockquote><p>å­ç½‘æ©ç ç”¨äºåˆ’åˆ† IP åœ°å€çš„ç½‘ç»œéƒ¨åˆ†å’Œä¸»æœºéƒ¨åˆ†ã€‚å­ç½‘æ©ç ä¸ IPåœ°å€è¿›è¡ŒæŒ‰ä½ä¸æ“ä½œï¼Œä»è€Œå¾—åˆ°ç½‘ç»œåœ°å€ã€‚è¿™æœ‰åŠ©äºç¡®å®šå“ªäº› IPåœ°å€å±äºåŒä¸€å­ç½‘ï¼Œä»¥ä¾¿æ­£ç¡®åœ°å°†æ•°æ®åŒ…è·¯ç”±åˆ°ç›®çš„åœ°ã€‚å­ç½‘åˆ’åˆ†æœ‰åŠ©äºç»„ç»‡ç½‘ç»œã€æé«˜å®‰å…¨æ€§å’Œç®¡ç†æ€§ã€‚</p></blockquote></li><li><p><code>gateway 192.168.50.2</code>:è¿™ä¸€è¡Œè®¾ç½®äº†é»˜è®¤ç½‘å…³ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†é»˜è®¤ç½‘å…³è®¾ç½®ä¸º<code>192.168.50.2</code>ã€‚é»˜è®¤ç½‘å…³æ˜¯ç”¨äºå°†æ•°æ®åŒ…å‘é€åˆ°å…¶ä»–ç½‘ç»œçš„è·¯ç”±å™¨æˆ–è®¾å¤‡çš„IP åœ°å€ã€‚</p><blockquote><p>ç½‘å…³æ˜¯ä¸€ä¸ªå……å½“ç½‘ç»œä¸­æ•°æ®åŒ…ä¼ è¾“çš„ä¸­ç»§ç‚¹çš„è®¾å¤‡ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªè·¯ç”±å™¨ã€‚å½“ä¸€ä¸ªè®¾å¤‡éœ€è¦å°†æ•°æ®åŒ…å‘é€åˆ°ä¸åŒå­ç½‘çš„å¦ä¸€ä¸ªè®¾å¤‡æ—¶ï¼Œå®ƒä¼šå°†æ•°æ®åŒ…å‘é€åˆ°ç½‘å…³ã€‚ç½‘å…³è´Ÿè´£å°†æ•°æ®åŒ…è·¯ç”±åˆ°æ­£ç¡®çš„ç›®çš„åœ°ã€‚é»˜è®¤ç½‘å…³æ˜¯è®¾å¤‡ç”¨äºå°†æ•°æ®åŒ…å‘é€åˆ°å…¶ä»–ç½‘ç»œçš„é¦–é€‰ç½‘å…³ã€‚</p></blockquote></li><li><p><code>dns-nameservers 8.8.8.8 8.8.4.4</code>: è¿™ä¸€è¡ŒæŒ‡å®šäº† DNSæœåŠ¡å™¨çš„ IP åœ°å€ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†è°·æ­Œçš„å…¬å…± DNS æœåŠ¡å™¨<code>8.8.8.8</code> å’Œ <code>8.8.4.4</code>ã€‚DNSæœåŠ¡å™¨ç”¨äºå°†ä¸»æœºåè§£æä¸º IP åœ°å€ã€‚</p><blockquote><p>åŸŸåç³»ç»Ÿï¼ˆDNSï¼‰æ˜¯å°†äººç±»å¯è¯»çš„åŸŸåï¼ˆä¾‹å¦‚ www.baidu.comï¼‰IPåœ°å€çš„ç³»ç»Ÿã€‚DNSæœåŠ¡å™¨æ˜¯è´Ÿè´£æ‰§è¡Œæ­¤è§£æè¿‡ç¨‹çš„æœåŠ¡å™¨ã€‚å½“æ‚¨åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ä¸€ä¸ªç½‘å€æ—¶ï¼Œè®¡ç®—æœºä¼šå‘DNS æœåŠ¡å™¨æŸ¥è¯¢è¯¥åŸŸåå¯¹åº”çš„ IP åœ°å€ï¼Œç„¶åå°†è¯·æ±‚å‘é€åˆ°è¯¥ IPåœ°å€ä»¥è·å–ç½‘é¡µå†…å®¹ã€‚</p></blockquote></li></ol><p>é…ç½®æ–‡ä»¶ä¸­çš„è¿™äº›è®¾ç½®å°†åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶ç”Ÿæ•ˆã€‚è¦ç«‹å³åº”ç”¨æ›´æ”¹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤é‡å¯ç½‘ç»œæœåŠ¡ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo systemctl restart networking<br></code></pre></td></tr></table></figure>          </div><h2 id="å®‰è£…-jdk">å®‰è£… jdk</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo apt update<br>sudo apt install openjdk-8-jdk<br></code></pre></td></tr></table></figure><p>éªŒè¯ java8 æ˜¯å¦å·²ç»å®‰è£…æˆåŠŸï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">java -version<br></code></pre></td></tr></table></figure><p>æœ‰ä»¥ä¸‹ç±»ä¼¼è¾“å‡ºçš„è¯åˆ™è¡¨æ˜å®‰è£…æˆåŠŸï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">openjdk version <span class="hljs-string">&quot;1.8.0_362&quot;</span><br>OpenJDK Runtime Environment (build 1.8.0_362-8u372-ga~us1-0ubuntu1~18.04-b09)<br>OpenJDK 64-Bit Server VM (build 25.362-b09, mixed mode)<br></code></pre></td></tr></table></figure><h2 id="å®‰è£…-kafka">å®‰è£… Kafka</h2><ol type="1"><li><p>ä¸‹è½½å¹¶è§£å‹ Kafka</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">wget https://archive.apache.org/dist/kafka/3.6.0/kafka_2.13-3.6.0.tgz<br>tar -zxvf kafka_2.13-3.6.0.tgz<br></code></pre></td></tr></table></figure></li><li><p>å°†è§£å‹ç¼©åçš„æ–‡ä»¶å¤¹ç§»åŠ¨åˆ° <code>/opt</code> ç›®å½•ä¸­ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo <span class="hljs-built_in">mv</span> kafka_2.13-3.6.0 /opt/kafka-3.6.0<br></code></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨ Kafka æä¾›çš„è„šæœ¬ç”Ÿæˆä¸€ä¸ª ClusterID</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">export</span> KAFKA_CLUSTER_ID=<span class="hljs-string">&quot;<span class="hljs-subst">$(/opt/kafka-3.6.0/bin/kafka-storage.sh random-uuid)</span>&quot;</span><br></code></pre></td></tr></table></figure><p>è¾“å‡º ClusterID</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">hedon@ubuntu:/opt/kafka-3.6.0$ <span class="hljs-built_in">echo</span> <span class="hljs-variable">$KAFKA_CLUSTER_ID</span><br>XiMRcbJ-QEO694L7sfDdBQ<br></code></pre></td></tr></table></figure><p>åœ¨å…¶ä»–èŠ‚ç‚¹ä¸Šå°† <code>KAFKA_CLUSTER_ID</code> è®¾ç½®ä¸ºä¸Šé¢çš„å€¼ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">export</span> KAFKA_CLUSTER_ID=XiMRcbJ-QEO694L7sfDdBQ<br></code></pre></td></tr></table></figure></li><li><p>å¤‡ä»½é…ç½®æ–‡ä»¶ï¼Œæ³¨æ„è¿™é‡Œçš„é…ç½®æ–‡ä»¶æ˜¯<code>config/kraft/server.properties</code>ï¼Œåœ¨ <code>config</code>ç›®å½•ä¸‹çš„ <code>kraft</code> ç›®å½•ä¸­ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cp</span> /opt/kafka-3.6.0/config/kraft/server.properties /opt/kafka-3.6.0/config/kraft/server.properties.bak<br></code></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹é…ç½®</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">vim /opt/kafka-3.6.0/config/kraft/server.properties<br></code></pre></td></tr></table></figure><p>ä¸»è¦ä¿®æ”¹å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># èŠ‚ç‚¹ IDï¼Œåˆ†åˆ«ä¸º 1ï¼Œ2ï¼Œ3</span><br><span class="hljs-attr">node.id</span>=<span class="hljs-string">1</span><br><span class="hljs-comment"># æ—¥å¿—ç›®å½•</span><br><span class="hljs-attr">log.dirs</span>=<span class="hljs-string">/opt/kafka-3.6.0/kafka-combined-logs</span><br><span class="hljs-comment"># å¯ä»¥æˆä¸ºæ§åˆ¶å™¨çš„èŠ‚ç‚¹å’Œå®ƒä»¬çš„ç«¯å£</span><br><span class="hljs-attr">controller.quorum.voters</span>=<span class="hljs-string">1@kafka1.com:9093,2@kafka2.com:9093,3@kafka3.com:9093</span><br><span class="hljs-comment"># å®šä¹‰ Kafka Broker å¦‚ä½•å‘å¤–éƒ¨å…¬å¸ƒå®ƒçš„åœ°å€ã€‚</span><br><span class="hljs-comment"># è¿™æ˜¯ Kafka Broker é€šçŸ¥ Producer å’Œ Consumer å¦‚ä½•è¿æ¥åˆ°è‡ªå·±çš„æ–¹å¼ã€‚</span><br><span class="hljs-comment"># ä¾‹å¦‚ï¼Œå¦‚æœä½ è®¾ç½® advertised.listeners=PLAINTEXT://my.public.ip:9092ï¼Œ</span><br><span class="hljs-comment"># é‚£ä¹ˆ Kafka Broker å°†å‘Šè¯‰ Producer å’Œ Consumer å®ƒçš„å…¬å…± IP åœ°å€æ˜¯ my.public.ipï¼Œå¹¶ä¸”å®ƒåœ¨ 9092 ç«¯å£ä¸Šç›‘å¬è¿æ¥ã€‚</span><br><span class="hljs-comment"># è¿™é‡Œæˆ‘ä»¬éœ€è¦åœ¨ 3 ä¸ªèŠ‚ç‚¹åˆ†åˆ«è®¾ç½®å¯¹åº”çš„åœ°å€</span><br><span class="hljs-attr">advertised.listeners</span>=<span class="hljs-string">PLAINTEXT://kafka1.com:9092</span><br></code></pre></td></tr></table></figure></li><li><p>æ ¼å¼åŒ–æ—¥å¿—ç›®å½•</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">/opt/kafka-3.6.0/bin/kafka-storage.sh format -t <span class="hljs-variable">$KAFKA_CLUSTER_ID</span> -c /opt/kafka-3.6.0/config/kraft/server.properties<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">Formatting /opt/kafka-3.6.0/kraft-combined-logs with metadata.version 3.6-IV2.<br></code></pre></td></tr></table></figure></li><li><p>ä¸‰ä¸ªèŠ‚ç‚¹éƒ½å¯åŠ¨ Kafka</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">/opt/kafka-3.6.0/bin/kafka-server-start.sh -daemon /opt/kafka-3.6.0/config/kraft/server.properties<br></code></pre></td></tr></table></figure></li><li><p>é€‰æ‹©ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹åˆ›å»ºä¸€ä¸ªæ–° topic</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">/opt/kafka-3.6.0/bin/kafka-topics.sh --bootstrap-server localhost:9092 --create --topic <span class="hljs-built_in">test</span> --replication-factor 1 --partitions=2<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">Created topic <span class="hljs-built_in">test</span>.<br></code></pre></td></tr></table></figure></li><li><p>åœ¨å…¶ä»–èŠ‚ç‚¹è·å– <code>test</code> è¿™ä¸ª <code>topic</code>çš„ä¿¡æ¯</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">/opt/kafka-3.6.0/bin/kafka-topics.sh --bootstrap-server localhost:9092 --describe --topic <span class="hljs-built_in">test</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å…³äº <code>test</code> è¿™ä¸ª <code>topic</code>çš„ä¿¡æ¯æ˜¯å¯ä»¥è·å–åˆ°çš„ï¼Œè¯´æ˜é›†ç¾¤ä¹‹å‰ä¿¡æ¯æ˜¯äº’é€šçš„ï¼Œé›†ç¾¤æ­å»ºå®Œæ¯•ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">Topic: <span class="hljs-built_in">test</span>TopicId: svJClTUpSFa9Z6FWDvkARgPartitionCount: 2ReplicationFactor: 1Configs: segment.bytes=1073741824<br>Topic: <span class="hljs-built_in">test</span>Partition: 0Leader: 2Replicas: 2Isr: 2<br>Topic: <span class="hljs-built_in">test</span>Partition: 1Leader: 3Replicas: 3Isr: 3<br></code></pre></td></tr></table></figure></li><li><p>éšä¾¿é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¾€ <code>test</code> é‡Œé¢å†™å…¥æ•°æ®ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">/opt/kafka-3.6.0/bin/kafka-console-producer.sh --bootstrap-server localhost:9092 --topic <span class="hljs-built_in">test</span><br></code></pre></td></tr></table></figure><p>è¾“å…¥æ•°æ®åæŒ‰å›è½¦å³å‘é€ä¸€æ¡æ•°æ®ï¼Œå¯ä»¥éšæ—¶æŒ‰ <code>Ctrl + C</code>é€€å‡ºï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">hedon@ubuntu:~/Downloads$ /opt/kafka-3.6.0/bin/kafka-console-producer.sh --bootstrap-server localhost:9092 --topic <span class="hljs-built_in">test</span><br>&gt;msg1<br>&gt;msg2<br>&gt;msg 3<br>&gt;^<br></code></pre></td></tr></table></figure></li><li><p>éšä¾¿é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¯åŠ¨æ¶ˆè´¹è€…æ¶ˆè´¹ <code>topic</code>ä¸­çš„æ•°æ®ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">/opt/kafka-3.6.0/bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic <span class="hljs-built_in">test</span> --from-beginning<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">hedon@ubuntu:/opt/kafka-3.6.0$ /opt/kafka-3.6.0/bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic <span class="hljs-built_in">test</span> --from-beginning<br>msg1<br>msg2<br>msg 3<br>^CProcessed a total of 3 messages<br></code></pre></td></tr></table></figure></li></ol><p>è‡³æ­¤ï¼ŒKafka çš„ KRaft ç‰ˆæœ¬é›†ç¾¤å°±éƒ¨ç½²å®Œæ¯•äº†ï¼</p><div class="note note-info">            <h2 id="è¡¥å……è¯´æ˜---kraft-é…ç½®æ–‡ä»¶">è¡¥å……è¯´æ˜ - KRaft é…ç½®æ–‡ä»¶</h2><p>ä¸‹é¢æ˜¯ Kafka KRaft ç‰ˆæœ¬é…ç½®æ–‡ä»¶æ¯ä¸ªé…ç½®é¡¹çš„è§£é‡Šï¼š</p><table><thead><tr class="header"><th>é…ç½®é¡¹</th><th>è¯´æ˜</th></tr></thead><tbody><tr class="odd"><td>process.roles</td><td>Kafka æœåŠ¡å™¨çš„è§’è‰²ï¼Œè®¾ç½®æ­¤é¡¹å°† Kafka ç½®äº KRaft æ¨¡å¼ã€‚å¯èƒ½çš„å€¼åŒ…æ‹¬"broker" å’Œ "controller"ã€‚</td></tr><tr class="even"><td>node.id</td><td>ä¸æ­¤å®ä¾‹å…³è”çš„èŠ‚ç‚¹ IDã€‚</td></tr><tr class="odd"><td>controller.quorum.voters</td><td>æ§åˆ¶å™¨é€‰ä¸¾çš„æŠ•ç¥¨èŠ‚ç‚¹ï¼Œæ ¼å¼ä¸º <code>node-id@host:port</code>ã€‚</td></tr><tr class="even"><td>listeners</td><td>æœåŠ¡å™¨ç›‘å¬çš„åœ°å€ï¼Œæ ¼å¼ä¸º<code>listener_name://host_name:port</code>ã€‚</td></tr><tr class="odd"><td>inter.broker.listener.name</td><td>ç”¨äº broker ä¹‹é—´é€šä¿¡çš„ç›‘å¬å™¨åç§°ã€‚</td></tr><tr class="even"><td>advertised.listeners</td><td>æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å®£å‘Šçš„ç›‘å¬å™¨åç§°ã€ä¸»æœºåå’Œç«¯å£ã€‚</td></tr><tr class="odd"><td>controller.listener.names</td><td>æ§åˆ¶å™¨ä½¿ç”¨çš„ç›‘å¬å™¨åç§°åˆ—è¡¨ã€‚</td></tr><tr class="even"><td>listener.security.protocol.map</td><td>ç›‘å¬å™¨åç§°åˆ°å®‰å…¨åè®®çš„æ˜ å°„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä»¬æ˜¯ç›¸åŒçš„ã€‚</td></tr><tr class="odd"><td>num.network.threads</td><td>æœåŠ¡å™¨ç”¨äºä»ç½‘ç»œæ¥æ”¶è¯·æ±‚å’Œå‘ç½‘ç»œå‘é€å“åº”çš„çº¿ç¨‹æ•°ã€‚</td></tr><tr class="even"><td>num.io.threads</td><td>æœåŠ¡å™¨ç”¨äºå¤„ç†è¯·æ±‚ï¼ˆå¯èƒ½åŒ…æ‹¬ç£ç›˜ I/Oï¼‰çš„çº¿ç¨‹æ•°ã€‚</td></tr><tr class="odd"><td>socket.send.buffer.bytes</td><td>æœåŠ¡å™¨ç”¨äºå‘é€æ•°æ®çš„ç¼“å†²åŒºå¤§å°ã€‚</td></tr><tr class="even"><td>socket.receive.buffer.bytes</td><td>æœåŠ¡å™¨ç”¨äºæ¥æ”¶æ•°æ®çš„ç¼“å†²åŒºå¤§å°ã€‚</td></tr><tr class="odd"><td>socket.request.max.bytes</td><td>æœåŠ¡å™¨æ¥å—çš„è¯·æ±‚çš„æœ€å¤§å¤§å°ï¼ˆç”¨äºé˜²æ­¢å†…å­˜æº¢å‡ºï¼‰ã€‚</td></tr><tr class="even"><td>log.dirs</td><td>ç”¨äºå­˜å‚¨æ—¥å¿—æ–‡ä»¶çš„ç›®å½•åˆ—è¡¨ã€‚</td></tr><tr class="odd"><td>num.partitions</td><td>æ¯ä¸ªä¸»é¢˜çš„é»˜è®¤æ—¥å¿—åˆ†åŒºæ•°ã€‚</td></tr><tr class="even"><td>num.recovery.threads.per.data.dir</td><td>æ¯ä¸ªæ•°æ®ç›®å½•åœ¨å¯åŠ¨æ—¶ç”¨äºæ—¥å¿—æ¢å¤å’Œå…³é—­æ—¶ç”¨äºåˆ·æ–°çš„çº¿ç¨‹æ•°ã€‚</td></tr><tr class="odd"><td>offsets.topic.replication.factor</td><td>å†…éƒ¨ä¸»é¢˜ "__consumer_offsets" å’Œ "__transaction_state"çš„å¤åˆ¶å› å­ã€‚</td></tr><tr class="even"><td>transaction.state.log.replication.factor</td><td>äº‹åŠ¡çŠ¶æ€æ—¥å¿—çš„å¤åˆ¶å› å­ã€‚</td></tr><tr class="odd"><td>transaction.state.log.min.isr</td><td>äº‹åŠ¡çŠ¶æ€æ—¥å¿—çš„æœ€å°åŒæ­¥å‰¯æœ¬æ•°ã€‚</td></tr><tr class="even"><td>log.flush.interval.messages</td><td>å¼ºåˆ¶å°†æ•°æ®åˆ·æ–°åˆ°ç£ç›˜ä¹‹å‰æ¥å—çš„æ¶ˆæ¯æ•°ã€‚</td></tr><tr class="odd"><td>log.flush.interval.ms</td><td>æ¶ˆæ¯åœ¨æ—¥å¿—ä¸­åœç•™çš„æœ€å¤§æ—¶é—´ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´å°±ä¼šå¼ºåˆ¶åˆ·æ–°åˆ°ç£ç›˜ã€‚</td></tr><tr class="even"><td>log.retention.hours</td><td>ç”±äºå¹´é¾„è€Œä½¿æ—¥å¿—æ–‡ä»¶æœ‰èµ„æ ¼è¢«åˆ é™¤çš„æœ€å°å¹´é¾„ã€‚</td></tr><tr class="odd"><td>log.retention.bytes</td><td>åŸºäºå¤§å°çš„æ—¥å¿—ä¿ç•™ç­–ç•¥ã€‚</td></tr><tr class="even"><td>log.segment.bytes</td><td>æ—¥å¿—æ®µæ–‡ä»¶çš„æœ€å¤§å¤§å°ã€‚</td></tr><tr class="odd"><td>log.retention.check.interval.ms</td><td>æ£€æŸ¥æ—¥å¿—æ®µæ˜¯å¦å¯ä»¥æ ¹æ®ä¿ç•™ç­–ç•¥è¢«åˆ é™¤çš„é—´éš”ã€‚</td></tr></tbody></table><p>è¯·æ³¨æ„ï¼Œè¿™åªæ˜¯ Kafka é…ç½®çš„ä¸€éƒ¨åˆ†ï¼ŒKafka é…ç½®çš„å®Œæ•´åˆ—è¡¨å¯ä»¥åœ¨ <ahref="https://kafka.apache.org/36/documentation.html#configuration">Kafkaçš„å®˜æ–¹æ–‡æ¡£</a>ä¸­æ‰¾åˆ°ã€‚</p>          </div>]]></content>
    
    
    <categories>
      
      <category>Kafka</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Kafka</tag>
      
      <tag>éƒ¨ç½²</tag>
      
      <tag>ä¸­é—´ä»¶</tag>
      
      <tag>æ¶ˆæ¯é˜Ÿåˆ—</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Kafka é›†ç¾¤éƒ¨ç½²</title>
    <link href="/2023/11/22/kakfa-cluster-deploy/"/>
    <url>/2023/11/22/kakfa-cluster-deploy/</url>
    
    <content type="html"><![CDATA[<h2 id="ç‰ˆæœ¬è¯´æ˜">ç‰ˆæœ¬è¯´æ˜</h2><ul><li>Ubuntu 18.04.6</li><li>Zookeeper 3.5.9</li><li>Kafka 2.7.0</li><li>JDK8</li></ul><h2 id="é›†ç¾¤é…ç½®">é›†ç¾¤é…ç½®</h2><table><thead><tr class="header"><th style="text-align: center;">æ“ä½œç³»ç»Ÿ</th><th style="text-align: center;">ip</th><th style="text-align: center;">åŸŸå</th><th style="text-align: center;">Zookeeper ç«¯å£</th><th style="text-align: center;">Kafka ç«¯å£</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">Ubuntu 18.04.6</td><td style="text-align: center;">192.168.50.131</td><td style="text-align: center;">kafka1.com</td><td style="text-align: center;">2181</td><td style="text-align: center;">9092</td></tr><tr class="even"><td style="text-align: center;">Ubuntu 18.04.6</td><td style="text-align: center;">192.168.50.132</td><td style="text-align: center;">kafka2.com</td><td style="text-align: center;">2181</td><td style="text-align: center;">9092</td></tr><tr class="odd"><td style="text-align: center;">Ubuntu 18.04.6</td><td style="text-align: center;">192.168.50.133</td><td style="text-align: center;">kafka3.com</td><td style="text-align: center;">2181</td><td style="text-align: center;">9092</td></tr></tbody></table><h2 id="å®‰è£…-vim-curl">å®‰è£… vim, curl</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo apt update<br>sudo apt install vim<br>sudo apt install curl<br></code></pre></td></tr></table></figure><h2 id="é…ç½®é™æ€-ip-å’Œ-hosts">é…ç½®é™æ€ ip å’Œ hosts</h2><p>ä¸ºäº†ä½¿ç”¨åŸŸåï¼Œæ›´åŠ æ–¹ä¾¿çš„è¿›è¡Œé…ç½®ï¼Œè¿™é‡Œå°†è™šæ‹Ÿæœºçš„ DHCP æ”¹æˆäº†é™æ€åˆ†é…IPï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨è®¾ç½®ä¸€ä¸‹æ¯å°æœºå™¨ IP åœ°å€ï¼Œè¿™é‡Œä»¥<code>192.168.50.131</code> ä¸ºä¾‹ã€‚</p><ol type="1"><li><p>æ‰¾åˆ°ç½‘ç»œæ¥å£åç§°ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">ip addr<br></code></pre></td></tr></table></figure><p>æŸ¥æ‰¾ä»¥ <code>ens</code> æˆ– <code>eth</code>å¼€å¤´çš„æ¥å£åç§°ã€‚ä¾‹å¦‚ï¼Œ<code>ens33</code> æˆ– <code>eth0</code>ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh">hedon@ubuntu:~$ ip addr<br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    <span class="hljs-built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    <span class="hljs-built_in">link</span>/ether 00:0c:29:82:9e:69 brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.50.133/24 brd 192.168.50.255 scope global dynamic noprefixroute ens33<br>       valid_lft 1644sec preferred_lft 1644sec<br>    inet6 fe80::c367:c7cc:3ad4:23b3/64 scope <span class="hljs-built_in">link</span> <br>       valid_lft forever preferred_lft forever<br></code></pre></td></tr></table></figure><p>å¯ä»¥æ‰¾åˆ° <code>ens33</code>ï¼Œå…¶ä¸­ <code>inet 192.168.50.133/24</code>è¡¨ç¤º IP åœ°å€ä¸º <code>192.168.50.133</code>ï¼Œå­ç½‘æ©ç ä¸º<code>/24</code>ï¼ˆç­‰äº <code>255.255.255.0</code>ï¼‰ã€‚</p><p>è¿™ä¸ª IP åœ°å€æ˜¯ DHCP åŠ¨æ€åˆ†é…çš„ï¼Œè¯´æ˜å®¿ä¸»æœºåˆ†é…ç»™è™šæ‹Ÿæœºçš„ IP èŒƒå›´å°±åœ¨<code>192.168.50.xxx</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šå°†é™æ€ IPé…ç½®åœ¨è¿™ä¸ªèŒƒå›´å†…ã€‚</p></li><li><p>è·å–ç½‘å…³åœ°å€</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">ip route | grep default<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">hedon@ubuntu:~$ ip route | grep default<br>default via 192.168.50.2 dev ens33 proto dhcp metric 100<br></code></pre></td></tr></table></figure><p>è¯´æ˜é»˜è®¤ç½‘å…³æ˜¯ <code>192.168.50.2</code>ï¼Œ</p></li><li><p>ç¼–è¾‘ <code>/etc/network/interfaces</code> æ–‡ä»¶ï¼Œé…ç½®é™æ€ IPåœ°å€ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs tex">auto ens33<br>iface ens33 inet static<br>address 192.168.50.131<br>netmask 255.255.255.0<br>gateway 192.168.50.2<br>dns-nameservers 8.8.8.8 8.8.4.4<br></code></pre></td></tr></table></figure></li><li><p>é‡å¯</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">su reboot<br></code></pre></td></tr></table></figure></li><li><p>å†æ¬¡æŸ¥çœ‹ ip åœ°å€</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">ip addr<br></code></pre></td></tr></table></figure><p>æœ‰ä»¥ä¸‹è¾“å‡ºä¾¿è¯´æ˜é™æ€ IP é…ç½®æˆåŠŸäº†ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    <span class="hljs-built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    <span class="hljs-built_in">link</span>/ether 00:0c:29:82:9e:69 brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.50.131/24 brd 192.168.50.255 scope global ens33<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:fe82:9e69/64 scope <span class="hljs-built_in">link</span> <br>       valid_lft forever preferred_lft forever<br></code></pre></td></tr></table></figure></li><li><p>é…ç½®åŸŸå</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo vim /etc/hosts<br></code></pre></td></tr></table></figure><p>è¿½åŠ å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">192.168.50.131 kafka1.com<br>192.168.50.132 kafka2.com<br>192.168.50.133 kafka3.com<br></code></pre></td></tr></table></figure></li><li><p>ping ä¸€ä¸‹</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh">hedon@ubuntu:~$ ping kafka1.com<br>PING kafka1.com (192.168.50.131) 56(84) bytes of data.<br>64 bytes from kafka1.com (192.168.50.131): icmp_seq=1 ttl=64 time=0.024 ms<br>64 bytes from kafka1.com (192.168.50.131): icmp_seq=2 ttl=64 time=0.021 ms<br>64 bytes from kafka1.com (192.168.50.131): icmp_seq=3 ttl=64 time=0.029 ms<br>^C<br>--- kafka1.com ping statistics ---<br>3 packets transmitted, 3 received, 0% packet loss, time 2029ms<br>rtt min/avg/max/mdev = 0.021/0.024/0.029/0.006 ms<br></code></pre></td></tr></table></figure></li><li><p>ping ä¸€ä¸‹ç™¾åº¦ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½è®¿é—®å¤–ç½‘</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">hedon@ubuntu:~$ ping baidu.com<br>ping: baidu.com: Name or service not known<br></code></pre></td></tr></table></figure><p>å¦‚æœè¿™é‡Œå¯ä»¥è®¿é—®ï¼Œåˆ™ç›´æ¥è·³è¿‡è¿›å…¥ä¸‹ä¸€æ­¥ï¼Œä¸å¯ä»¥çš„è¯ï¼Œéœ€è¦é…ç½®ä¸€ä¸‹åŸŸåè§£æç³»ç»Ÿã€‚</p></li><li><p>é…ç½®åŸŸåè§£æç³»ç»Ÿ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo vim /etc/resolv.conf<br></code></pre></td></tr></table></figure><p>è¿½åŠ ä¸‹é¢å†…å®¹ï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs tex">nameserver 8.8.8.8<br>nameserver 8.8.4.4<br></code></pre></td></tr></table></figure><p>å†å°è¯• ping ä¸€ä¸‹ç™¾åº¦ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh">hedon@ubuntu:~$ ping www.baidu.com<br>PING www.a.shifen.com (153.3.238.110) 56(84) bytes of data.<br>64 bytes from 153.3.238.110 (153.3.238.110): icmp_seq=1 ttl=128 time=15.9 ms<br>64 bytes from 153.3.238.110 (153.3.238.110): icmp_seq=2 ttl=128 time=15.9 ms<br>64 bytes from 153.3.238.110 (153.3.238.110): icmp_seq=3 ttl=128 time=16.1 ms<br>64 bytes from 153.3.238.110 (153.3.238.110): icmp_seq=4 ttl=128 time=15.3 ms<br>^C<br>--- www.a.shifen.com ping statistics ---<br>4 packets transmitted, 4 received, 0% packet loss, time 14104ms<br>rtt min/avg/max/mdev = 15.368/15.850/16.145/0.291 ms<br></code></pre></td></tr></table></figure></li></ol><div class="note note-info">            <p>è¡¥å……è¯´æ˜ï¼š<code>/etc/network/interfaces</code> æ–‡ä»¶çš„é…ç½®</p><p>è¿™æ˜¯ä¸€ä¸ªç”¨äºé…ç½® Linux ç³»ç»Ÿä¸Šç½‘ç»œæ¥å£çš„æ–‡ä»¶ã€‚åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä¸ºåä¸º<code>ens33</code> çš„ç½‘ç»œæ¥å£é…ç½®äº†é™æ€ IPåœ°å€å’Œç›¸å…³çš„ç½‘ç»œè®¾ç½®ã€‚ä¸‹é¢æ˜¯å„è¡Œçš„è§£é‡Šï¼š</p><ol type="1"><li><p><code>auto ens33</code>: è¿™ä¸€è¡Œè¡¨ç¤ºåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨æ¿€æ´»<code>ens33</code> ç½‘ç»œæ¥å£ã€‚<code>auto</code>å…³é”®å­—åé¢è·Ÿç€æ¥å£åç§°ã€‚</p></li><li><p><code>iface ens33 inet static</code>: è¿™ä¸€è¡Œå®šä¹‰äº†<code>ens33</code> ç½‘ç»œæ¥å£çš„é…ç½®ã€‚<code>iface</code>å…³é”®å­—åé¢è·Ÿç€æ¥å£åç§°ï¼Œ<code>inet</code> è¡¨ç¤ºæˆ‘ä»¬æ­£åœ¨é…ç½® IPv4åœ°å€ï¼Œ<code>static</code> è¡¨ç¤ºæˆ‘ä»¬è¦ä¸ºæ¥å£åˆ†é…ä¸€ä¸ªé™æ€ IPåœ°å€ï¼ˆè€Œä¸æ˜¯é€šè¿‡ DHCP è·å¾—ï¼‰ã€‚</p></li><li><p><code>address 192.168.50.131</code>: è¿™ä¸€è¡Œè®¾ç½®äº†ç½‘ç»œæ¥å£çš„é™æ€IP åœ°å€ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä¸º <code>ens33</code> æ¥å£åˆ†é…äº†<code>192.168.50.131</code> IP åœ°å€ã€‚</p><blockquote><p>IP åœ°å€æ˜¯ Internetåè®®ï¼ˆIPï¼‰ç”¨äºåœ¨ç½‘ç»œä¸­å”¯ä¸€æ ‡è¯†è®¾å¤‡çš„æ•°å­—æ ‡ç­¾ã€‚æ¯ä¸ªè¿æ¥åˆ°ç½‘ç»œçš„è®¾å¤‡éƒ½éœ€è¦ä¸€ä¸ªå”¯ä¸€çš„IP åœ°å€ï¼Œä»¥ä¾¿å…¶ä»–è®¾å¤‡å¯ä»¥æ‰¾åˆ°å¹¶ä¸ä¹‹é€šä¿¡ã€‚IP åœ°å€é€šå¸¸åˆ†ä¸ºä¸¤ç§ç‰ˆæœ¬ï¼šIPv4å’Œ IPv6ã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ª IPv4 åœ°å€ã€‚</p></blockquote></li><li><p><code>netmask 255.255.255.0</code>:è¿™ä¸€è¡Œå®šä¹‰äº†å­ç½‘æ©ç ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå­ç½‘æ©ç æ˜¯<code>255.255.255.0</code>ï¼Œè¡¨ç¤ºå‰ä¸‰ä¸ªå­—èŠ‚ï¼ˆ24ä½ï¼‰æ˜¯ç½‘ç»œåœ°å€ï¼Œæœ€åä¸€ä¸ªå­—èŠ‚ï¼ˆ8 ä½ï¼‰æ˜¯ä¸»æœºåœ°å€ã€‚</p><blockquote><p>å­ç½‘æ©ç ç”¨äºåˆ’åˆ† IP åœ°å€çš„ç½‘ç»œéƒ¨åˆ†å’Œä¸»æœºéƒ¨åˆ†ã€‚å­ç½‘æ©ç ä¸ IPåœ°å€è¿›è¡ŒæŒ‰ä½ä¸æ“ä½œï¼Œä»è€Œå¾—åˆ°ç½‘ç»œåœ°å€ã€‚è¿™æœ‰åŠ©äºç¡®å®šå“ªäº› IPåœ°å€å±äºåŒä¸€å­ç½‘ï¼Œä»¥ä¾¿æ­£ç¡®åœ°å°†æ•°æ®åŒ…è·¯ç”±åˆ°ç›®çš„åœ°ã€‚å­ç½‘åˆ’åˆ†æœ‰åŠ©äºç»„ç»‡ç½‘ç»œã€æé«˜å®‰å…¨æ€§å’Œç®¡ç†æ€§ã€‚</p></blockquote></li><li><p><code>gateway 192.168.50.2</code>:è¿™ä¸€è¡Œè®¾ç½®äº†é»˜è®¤ç½‘å…³ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†é»˜è®¤ç½‘å…³è®¾ç½®ä¸º<code>192.168.50.2</code>ã€‚é»˜è®¤ç½‘å…³æ˜¯ç”¨äºå°†æ•°æ®åŒ…å‘é€åˆ°å…¶ä»–ç½‘ç»œçš„è·¯ç”±å™¨æˆ–è®¾å¤‡çš„IP åœ°å€ã€‚</p><blockquote><p>ç½‘å…³æ˜¯ä¸€ä¸ªå……å½“ç½‘ç»œä¸­æ•°æ®åŒ…ä¼ è¾“çš„ä¸­ç»§ç‚¹çš„è®¾å¤‡ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªè·¯ç”±å™¨ã€‚å½“ä¸€ä¸ªè®¾å¤‡éœ€è¦å°†æ•°æ®åŒ…å‘é€åˆ°ä¸åŒå­ç½‘çš„å¦ä¸€ä¸ªè®¾å¤‡æ—¶ï¼Œå®ƒä¼šå°†æ•°æ®åŒ…å‘é€åˆ°ç½‘å…³ã€‚ç½‘å…³è´Ÿè´£å°†æ•°æ®åŒ…è·¯ç”±åˆ°æ­£ç¡®çš„ç›®çš„åœ°ã€‚é»˜è®¤ç½‘å…³æ˜¯è®¾å¤‡ç”¨äºå°†æ•°æ®åŒ…å‘é€åˆ°å…¶ä»–ç½‘ç»œçš„é¦–é€‰ç½‘å…³ã€‚</p></blockquote></li><li><p><code>dns-nameservers 8.8.8.8 8.8.4.4</code>: è¿™ä¸€è¡ŒæŒ‡å®šäº† DNSæœåŠ¡å™¨çš„ IP åœ°å€ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†è°·æ­Œçš„å…¬å…± DNS æœåŠ¡å™¨<code>8.8.8.8</code> å’Œ <code>8.8.4.4</code>ã€‚DNSæœåŠ¡å™¨ç”¨äºå°†ä¸»æœºåè§£æä¸º IP åœ°å€ã€‚</p><blockquote><p>åŸŸåç³»ç»Ÿï¼ˆDNSï¼‰æ˜¯å°†äººç±»å¯è¯»çš„åŸŸåï¼ˆä¾‹å¦‚ www.baidu.comï¼‰IPåœ°å€çš„ç³»ç»Ÿã€‚DNSæœåŠ¡å™¨æ˜¯è´Ÿè´£æ‰§è¡Œæ­¤è§£æè¿‡ç¨‹çš„æœåŠ¡å™¨ã€‚å½“æ‚¨åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ä¸€ä¸ªç½‘å€æ—¶ï¼Œè®¡ç®—æœºä¼šå‘DNS æœåŠ¡å™¨æŸ¥è¯¢è¯¥åŸŸåå¯¹åº”çš„ IP åœ°å€ï¼Œç„¶åå°†è¯·æ±‚å‘é€åˆ°è¯¥ IPåœ°å€ä»¥è·å–ç½‘é¡µå†…å®¹ã€‚</p></blockquote></li></ol><p>é…ç½®æ–‡ä»¶ä¸­çš„è¿™äº›è®¾ç½®å°†åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶ç”Ÿæ•ˆã€‚è¦ç«‹å³åº”ç”¨æ›´æ”¹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤é‡å¯ç½‘ç»œæœåŠ¡ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo systemctl restart networking<br></code></pre></td></tr></table></figure>          </div><h2 id="å®‰è£…-jdk">å®‰è£… jdk</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo apt update<br>sudo apt install openjdk-8-jdk<br></code></pre></td></tr></table></figure><p>éªŒè¯ java8 æ˜¯å¦å·²ç»å®‰è£…æˆåŠŸï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">java -version<br></code></pre></td></tr></table></figure><p>æœ‰ä»¥ä¸‹ç±»ä¼¼è¾“å‡ºçš„è¯åˆ™è¡¨æ˜å®‰è£…æˆåŠŸï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">openjdk version <span class="hljs-string">&quot;1.8.0_362&quot;</span><br>OpenJDK Runtime Environment (build 1.8.0_362-8u372-ga~us1-0ubuntu1~18.04-b09)<br>OpenJDK 64-Bit Server VM (build 25.362-b09, mixed mode)<br></code></pre></td></tr></table></figure><h2 id="å®‰è£…-zookeeper">å®‰è£… zookeeper</h2><p>åœ¨ Ubuntu ä¸Šï¼Œæ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ­¥éª¤å®‰è£… Apache Zookeeper 3.5.9ï¼š</p><ol type="1"><li>ä¸‹è½½ Apache Zookeeper 3.5.9 çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ä¸‹è½½å¹¶è§£å‹ç¼©Zookeeperï¼š</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">wget https://archive.apache.org/dist/zookeeper/zookeeper-3.5.9/apache-zookeeper-3.5.9-bin.tar.gz<br>tar -xzf apache-zookeeper-3.5.9-bin.tar.gz<br></code></pre></td></tr></table></figure><ol start="4" type="1"><li>å°†è§£å‹ç¼©åçš„æ–‡ä»¶å¤¹ç§»åŠ¨åˆ° <code>/opt</code> ç›®å½•ä¸­ï¼š</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo <span class="hljs-built_in">mv</span> apache-zookeeper-3.5.9-bin /opt/zookeeper-3.5.9<br></code></pre></td></tr></table></figure><ol start="5" type="1"><li>åœ¨ <code>/opt/zookeeper-3.5.9</code> ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªåä¸º<code>data</code> çš„æ–‡ä»¶å¤¹ï¼Œç”¨äºå­˜å‚¨ Zookeeper çš„æ•°æ®ï¼š</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo <span class="hljs-built_in">mkdir</span> /opt/zookeeper-3.5.9/data<br></code></pre></td></tr></table></figure><ol start="6" type="1"><li>åœ¨ <code>/opt/zookeeper-3.5.9/data</code> ä¸‹åˆ›å»º myidæ–‡ä»¶å¹¶è®¾ç½®å†…å®¹ä¸º <code>1</code>ï¼Œå…¶ä»–ä¸¤å°æœºå™¨åˆ™ä¸º <code>2</code> å’Œ<code>3</code>ï¼š</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">echo</span> 1 | sudo <span class="hljs-built_in">tee</span> /opt/zookeeper-3.5.9/data/myid<br></code></pre></td></tr></table></figure><ol start="7" type="1"><li>å¤åˆ¶ Zookeeper é…ç½®æ–‡ä»¶æ ·æœ¬ï¼Œå¹¶å°†å…¶å‘½åä¸º<code>zoo.cfg</code>ï¼š</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo <span class="hljs-built_in">cp</span> /opt/zookeeper-3.5.9/conf/zoo_sample.cfg /opt/zookeeper-3.5.9/conf/zoo.cfg<br></code></pre></td></tr></table></figure><ol start="8" type="1"><li>ä½¿ç”¨æ–‡æœ¬ç¼–è¾‘å™¨ï¼ˆä¾‹å¦‚ vimï¼‰ç¼–è¾‘ <code>zoo.cfg</code> æ–‡ä»¶ï¼š</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo vim /opt/zookeeper-3.5.9/conf/zoo.cfg<br></code></pre></td></tr></table></figure><ol start="9" type="1"><li>ä¿®æ”¹ <code>zoo.cfg</code> æ–‡ä»¶ï¼š</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># The number of milliseconds of each tick</span><br>tickTime=2000<br><span class="hljs-comment"># The number of ticks that the initial </span><br><span class="hljs-comment"># synchronization phase can take</span><br>initLimit=10<br><span class="hljs-comment"># The number of ticks that can pass between </span><br><span class="hljs-comment"># sending a request and getting an acknowledgement</span><br>syncLimit=5<br><span class="hljs-comment"># the directory where the snapshot is stored.</span><br><span class="hljs-comment"># è®¾ç½®æ•°æ®å­˜å‚¨ç›®å½•</span><br>dataDir=/opt/zookeeper-3.5.9/data<br><span class="hljs-comment"># the port at which the clients will connect</span><br>clientPort=2181<br><span class="hljs-comment"># è®¾ç½®é›†ç¾¤ä¿¡æ¯</span><br>server.1=kafka1.com:2888:3888<br>server.2=kafka2.com:2888:3888<br>server.3=kafka3.com:2888:3888<br></code></pre></td></tr></table></figure><blockquote><p>åœ¨ Zookeeper çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œ<code>server.x=hostname:port1:port2</code>è¿™ç§æ ¼å¼çš„é…ç½®é¡¹æ˜¯ç”¨æ¥è®¾ç½® Zookeeperé›†ç¾¤ï¼ˆé›†ç¾¤æ¨¡å¼ä¸‹ï¼‰çš„ã€‚å…¶ä¸­ï¼Œ<code>x</code> æ˜¯æœåŠ¡å™¨çš„IDï¼Œ<code>hostname</code> æ˜¯æœåŠ¡å™¨çš„ä¸»æœºåæˆ– IP åœ°å€ï¼Œ<code>port1</code>å’Œ <code>port2</code> æ˜¯ç”¨äºé›†ç¾¤é—´é€šä¿¡çš„ç«¯å£ã€‚</p><p>å…·ä½“æ¥è¯´ï¼š</p><ul><li><p><code>port1ï¼ˆ2888ï¼‰</code>ï¼šè¿™æ˜¯æœåŠ¡å™¨ä¹‹é—´ç”¨äºç›¸äº’é€šä¿¡çš„ç«¯å£ã€‚ZookeeperæœåŠ¡å™¨ä½¿ç”¨è¿™ä¸ªç«¯å£è¿›è¡Œ leader é€‰ä¸¾ä»¥åŠåŒæ­¥ follower å’Œ leaderä¹‹é—´çš„çŠ¶æ€ã€‚</p></li><li><p><code>port2ï¼ˆ3888ï¼‰</code>ï¼šè¿™ä¸ªç«¯å£ç”¨äºæœåŠ¡å™¨ä¹‹é—´çš„ leaderé€‰ä¸¾ã€‚åœ¨ Zookeeper é›†ç¾¤å¯åŠ¨æˆ–è€…åœ¨ leader æœåŠ¡å™¨å´©æºƒåï¼ŒfolloweræœåŠ¡å™¨ä¼šé€šè¿‡è¿™ä¸ªç«¯å£è¿›è¡Œæ–°ä¸€è½®çš„ leader é€‰ä¸¾ã€‚</p></li></ul><p>è¿™ä¸¤ä¸ªç«¯å£å¯ä»¥æ ¹æ®ä½ çš„ç½‘ç»œé…ç½®è¿›è¡Œä¿®æ”¹ï¼Œä½†å¿…é¡»åœ¨æ‰€æœ‰çš„ ZookeeperæœåŠ¡å™¨ä¸Šä¿æŒä¸€è‡´ã€‚</p></blockquote><ol start="10" type="1"><li>ä¸‰ä¸ªèŠ‚ç‚¹éƒ½å¯åŠ¨ Zookeeper æœåŠ¡å™¨ï¼š</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">/opt/zookeeper/bin/zkServer.sh start<br></code></pre></td></tr></table></figure><p>å¯ä»¥è¿æ¥åˆ° Zookeeper çš„ç«¯å£ä¸Šï¼ˆé»˜è®¤æ˜¯<code>2181</code>ï¼‰ï¼Œé€šè¿‡å‘é€å››å­—å‘½ä»¤ <code>srvr</code> æ¥éªŒè¯ Zookeeperæ˜¯å¦å®‰è£…æ­£ç¡®ï¼ˆéƒ¨ç½²é›†ç¾¤çš„è¯éœ€è¦æŠŠæ‰€æœ‰ Zookeeper å¯åŠ¨ï¼‰ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs sh">hedon@ubuntu:/opt/zookeeper-3.5.9$ telnet localhost 2181<br>Trying 127.0.0.1...<br>Connected to localhost.<br>Escape character is <span class="hljs-string">&#x27;^]&#x27;</span>.<br>srvr<br>Zookeeper version: 3.5.9-83df9301aa5c2a5d284a9940177808c01bc35cef, built on 01/06/2021 19:49 GMT<br>Latency min/avg/max: 0/0/0<br>Received: 1<br>Sent: 0<br>Connections: 1<br>Outstanding: 0<br>Zxid: 0x0<br>Mode: standalone<br>Node count: 5<br>Connection closed by foreign host.<br></code></pre></td></tr></table></figure><ol start="11" type="1"><li>è¦åœæ­¢ Zookeeper æœåŠ¡å™¨ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">/opt/zookeeper/bin/zkServer.sh stop<br></code></pre></td></tr></table></figure><h2 id="å®‰è£…-kafka">å®‰è£… Kafka</h2><ol type="1"><li><p>ä¸‹è½½å¹¶è§£å‹ Kafka</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">wget https://archive.apache.org/dist/kafka/2.7.0/kafka_2.13-2.7.0.tgz<br>tar -zxvf kafka_2.13-2.7.0.tgz<br></code></pre></td></tr></table></figure></li><li><p>å°†è§£å‹ç¼©åçš„æ–‡ä»¶å¤¹ç§»åŠ¨åˆ° <code>/opt</code> ç›®å½•ä¸­ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo <span class="hljs-built_in">mv</span> kafka_2.13-2.7.0 /opt/kafka-2.7.0<br></code></pre></td></tr></table></figure></li><li><p>åˆ›å»ºæ—¥å¿—ç›®å½•</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo <span class="hljs-built_in">mkdir</span> /opt/kafka-2.7.0/kafka-logs<br></code></pre></td></tr></table></figure></li><li><p>å¤‡ä»½ Kafka é»˜è®¤é…ç½®</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo <span class="hljs-built_in">cp</span> /opt/kafka-2.7.0/config/server.properties /opt/kafka-2.7.0/config/server.properties.bak<br></code></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹ Kafka é…ç½®</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo vim /opt/kafka-2.7.0/config/server.properties<br></code></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯ä¿®æ”¹ä¸‹é¢å‡ ä¸ªé…ç½®ï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># é›†ç¾¤ä¸­æ¯ä¸ª broker çš„ id å¿…é¡»å”¯ä¸€ï¼Œè¿™é‡Œåˆ†åˆ«ä¸º 1ï¼Œ2ï¼Œ3</span><br><span class="hljs-attr">broker.id</span>=<span class="hljs-string">1</span><br><span class="hljs-comment"># æ—¥å¿—ç›®å½•</span><br><span class="hljs-attr">log.dirs</span>=<span class="hljs-string">/opt/kafka-2.7.0/kafka-logs</span><br><span class="hljs-comment"># é…ç½® Zookeeper</span><br><span class="hljs-attr">zookeeper.connect</span>=<span class="hljs-string">kafka1.com:2181,kafka2.com:2181,kafka3.com:2181</span><br><span class="hljs-comment"># å®šä¹‰ Kafka Broker åœ¨å“ªäº›ç½‘ç»œåœ°å€ä¸Šç›‘å¬è¿æ¥ï¼Œä¸‹é¢é…ç½®è¡¨ç¤ºåœ¨æ‰€æœ‰çš„ IP åœ°å€ä¸Šç›‘å¬ 9092 ç«¯å£</span><br><span class="hljs-attr">listeners</span>=<span class="hljs-string">PLAINTEXT://:9092</span><br><span class="hljs-comment"># å®šä¹‰ Kafka Broker å¦‚ä½•å‘å¤–éƒ¨å…¬å¸ƒå®ƒçš„åœ°å€ã€‚è¿™æ˜¯ Kafka Broker é€šçŸ¥ Producer å’Œ Consumer å¦‚ä½•è¿æ¥åˆ°è‡ªå·±çš„æ–¹å¼ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ è®¾ç½® advertised.listeners=PLAINTEXT://my.public.ip:9092ï¼Œé‚£ä¹ˆ Kafka Broker å°†å‘Šè¯‰ Producer å’Œ Consumer å®ƒçš„å…¬å…± IP åœ°å€æ˜¯ my.public.ipï¼Œå¹¶ä¸”å®ƒåœ¨ 9092 ç«¯å£ä¸Šç›‘å¬è¿æ¥ã€‚</span><br><span class="hljs-attr">advertised.listeners</span>=<span class="hljs-string">PLAINTEXT://kafka1.com:9092</span><br></code></pre></td></tr></table></figure></li><li><p>ä¸‰ä¸ªèŠ‚ç‚¹éƒ½å¯åŠ¨ Kafka</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">/opt/kafka-2.7.0/bin/kafka-server-start.sh -daemon /opt/kafka-2.7.0/config/server.properties<br></code></pre></td></tr></table></figure></li><li><p>é€‰æ‹©ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹åˆ›å»ºä¸€ä¸ªæ–° topic</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">/opt/kafka-2.7.0/bin/kafka-topics.sh --bootstrap-server localhost:9092 --create --topic <span class="hljs-built_in">test</span> --replication-factor 1 --partitions=2<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">Created topic <span class="hljs-built_in">test</span>.<br></code></pre></td></tr></table></figure></li><li><p>åœ¨å…¶ä»–èŠ‚ç‚¹è·å– <code>test</code> è¿™ä¸ª <code>topic</code>çš„ä¿¡æ¯</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">/opt/kafka-2.7.0/bin/kafka-topics.sh --bootstrap-server localhost:9092 --describe --topic <span class="hljs-built_in">test</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å…³äº <code>test</code> è¿™ä¸ª <code>topic</code>çš„ä¿¡æ¯æ˜¯å¯ä»¥è·å–åˆ°çš„ï¼Œè¯´æ˜é›†ç¾¤ä¹‹å‰ä¿¡æ¯æ˜¯äº’é€šçš„ï¼Œé›†ç¾¤æ­å»ºå®Œæ¯•ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">Topic: <span class="hljs-built_in">test</span>PartitionCount: 2ReplicationFactor: 1Configs: segment.bytes=1073741824<br>Topic: <span class="hljs-built_in">test</span>Partition: 0Leader: 1Replicas: 1Isr: 1<br>Topic: <span class="hljs-built_in">test</span>Partition: 1Leader: 2Replicas: 2Isr: 2<br></code></pre></td></tr></table></figure></li></ol>]]></content>
    
    
    <categories>
      
      <category>Kafka</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Kafka</tag>
      
      <tag>éƒ¨ç½²</tag>
      
      <tag>ä¸­é—´ä»¶</tag>
      
      <tag>æ¶ˆæ¯é˜Ÿåˆ—</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Raft-Extended è®ºæ–‡ç¿»è¯‘</title>
    <link href="/2023/11/18/raft/"/>
    <url>/2023/11/18/raft/</url>
    
    <content type="html"><![CDATA[<blockquote><p>åŸæ–‡ï¼šhttps://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf</p></blockquote><h2 id="è¾¨æ">è¾¨æ</h2><p><strong>consensus</strong> vs <strong>consistency</strong></p><p>ä¸€è‡´æ€§ï¼ˆconsistencyï¼‰å¾€å¾€æŒ‡åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¤šä¸ªå‰¯æœ¬å¯¹å¤–å‘ˆç°çš„æ•°æ®çš„çŠ¶æ€ã€‚å¦‚é¡ºåºä¸€è‡´æ€§ã€çº¿æ€§ä¸€è‡´æ€§ï¼Œæè¿°äº†å¤šä¸ªèŠ‚ç‚¹å¯¹æ•°æ®çŠ¶æ€çš„ç»´æŠ¤èƒ½åŠ›ã€‚</p><p>å…±è¯†ï¼ˆconsensusï¼‰åˆ™æè¿°äº†åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¤šä¸ªèŠ‚ç‚¹ä¹‹é—´ï¼Œå½¼æ­¤å¯¹æŸä¸ªææ¡ˆè¾¾æˆä¸€è‡´ç»“æœçš„è¿‡ç¨‹ã€‚</p><p>å› æ­¤ï¼Œä¸€è‡´æ€§æè¿°çš„æ˜¯<strong>ç»“æœ</strong>ï¼Œå…±è¯†åˆ™æ˜¯ä¸€ç§<strong>æ‰‹æ®µ</strong>ã€‚</p><p>æœ‰çš„äººä¼šè¯´ä¸€è‡´æ€§å’Œå…±è¯†å®é™…ä¸Šæ˜¯ä¸€ä¸ªé—®é¢˜çš„ä¸€ä½“ä¸¤é¢ï¼ŒæŸç§ç¨‹åº¦ä¸Šæ¥è¯´ï¼Œå…±è¯†æ–¹æ³•ç¡®å®å¯ä»¥çœ‹ä½œæ˜¯å®ç°å¼ºä¸€è‡´æ€§çš„ä¸€ç§æ–¹æ³•ã€‚äº‹å®ä¸Šåœ¨å·¥ä¸šç•Œæœ‰è®¸å¤šä»¥å…±è¯†ç®—æ³•ä½œä¸ºæ ¸å¿ƒç»„ä»¶çš„å¤šå‰¯æœ¬çŠ¶æ€æœºï¼ˆReplicatedStateMachineï¼‰å®ç°ï¼Œæœ¬è´¨ä¸Šåˆ©ç”¨äº†å…±è¯†ç®—æ³•ä¿è¯äº†æ‰€æœ‰å‰¯æœ¬çš„æ“ä½œæ—¥å¿—å…·æœ‰å®Œå…¨ç›¸åŒçš„é¡ºåºï¼Œä»è€Œå®ç°äº†å‰¯æœ¬çš„ä¸€è‡´æ€§ã€‚ä½†æ˜¯ï¼Œå³ä½¿æ˜¯åœ¨è¿™æ ·çš„åœºæ™¯ä¸‹ï¼Œè®¨è®ºä¸€ä¸ªå…±è¯†ç®—æ³•çš„ä¸€è‡´æ€§ä¹Ÿæ˜¯ä¸åˆé€‚çš„ï¼Œå› <strong>ä¸ºæ•´ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿæœ€ç»ˆçš„ä¸€è‡´æ€§å¹¶ä¸å•å•å–å†³äºå…±è¯†ç®—æ³•ï¼Œå…±è¯†ç®—æ³•åªæ˜¯è§£å†³äº†å…¶ä¸­ä¸€ä¸ªé—®é¢˜ã€‚</strong></p><blockquote><p>å‚è€ƒï¼šhttps://zhuanlan.zhihu.com/p/68743917</p></blockquote><h2 id="æ‘˜è¦">0. æ‘˜è¦</h2><p>Raft æ˜¯ç”¨æ¥ç®¡ç†å¤åˆ¶æ—¥å¿—ï¼ˆreplicated logï¼‰çš„ä¸€è‡´æ€§åè®®ã€‚å®ƒè·Ÿmulti-Paxos ä½œç”¨ç›¸åŒï¼Œæ•ˆç‡ä¹Ÿç›¸å½“ã€‚ä½†æ˜¯å®ƒçš„ç»„ç»‡ç»“æ„è·Ÿ Paxosä¸åŒï¼Œä¹Ÿæ˜¯å› ä¸º Raftæ›´ç®€å•çš„æ¶æ„ä½¿å¾—å®ƒæ›´å®¹æ˜“è¢«ç†è§£ï¼Œå¹¶ä¸”æ›´å®¹æ˜“åœ¨å®é™…å·¥ç¨‹ä¸­å¾—ä»¥å®ç°ã€‚</p><p>ä¸ºäº†è®© Raft æ›´å®¹æ˜“è¢«ç†è§£ï¼ŒRaftå°†å…±è¯†ç®—æ³•çš„å…³é”®æ€§å› ç´ åˆ‡åˆ†æˆå‡ ä¸ªéƒ¨åˆ†ï¼Œæ¯”å¦‚ï¼š</p><ul><li>leader electionï¼ˆé¢†å¯¼è€…é€‰ä¸¾ï¼‰</li><li>log replicationï¼ˆæ—¥å¿—å¤åˆ¶ï¼‰</li><li>safetyï¼ˆå®‰å…¨æ€§ï¼‰</li></ul><p>å¹¶ä¸” Raftå®æ–½äº†ä¸€ç§æ›´å¼ºçš„å…±è¯†æ€§ä»¥ä¾¿å‡å°‘å¿…é¡»è¦è€ƒè™‘çš„çŠ¶æ€ï¼ˆstatesï¼‰çš„æ•°é‡ã€‚</p><p>ç”¨æˆ·ç ”ç©¶è¡¨æ˜ï¼Œå¯¹äºå­¦ç”Ÿæ¥è¯´ï¼ŒRaft ç›¸æ¯”äº Paxos æ˜¯æ›´å®¹æ˜“å­¦ä¹ çš„ã€‚</p><p>Raftè¿˜åŒ…æ‹¬ä¸€ä¸ªç”¨äºè§£å†³<strong>å˜æ›´é›†ç¾¤æˆå‘˜é—®é¢˜</strong>çš„æ–°æœºåˆ¶ï¼Œå®ƒä½¿ç”¨é‡å†™å¤šæ•°æ¥ä¿è¯å®‰å…¨æ€§ã€‚</p><h2 id="ä»‹ç»">1. ä»‹ç»</h2><p>å…±è¯†ç®—æ³•å…è®¸å¤šå°æœºå™¨ä½œä¸ºä¸€ä¸ªé›†ç¾¤ååŒå·¥ä½œï¼Œå¹¶ä¸”åœ¨å…¶ä¸­çš„æŸå‡ å°æœºå™¨å‡ºæ•…éšœæ—¶é›†ç¾¤ä»ç„¶èƒ½æ­£å¸¸å·¥ä½œã€‚æ­£å› ä¸ºå¦‚æ­¤ï¼Œå…±è¯†ç®—æ³•åœ¨å»ºç«‹å¯é çš„å¤§è§„æ¨¡è½¯ä»¶ç³»ç»Ÿæ–¹é¢å‘æŒ¥äº†é‡è¦ä½œç”¨ã€‚åœ¨è¿‡å»åå¹´ä¸­ï¼ŒPaxos[15,16] ä¸»å¯¼äº†å…³äºå…±è¯†ç®—æ³•çš„è®¨è®ºï¼šå¤§å¤šæ•°å…±è¯†æ€§çš„å®ç°éƒ½æ˜¯åŸºäº Paxosæˆ–å—å…¶å½±å“ï¼ŒPaxos å·²ç»æˆä¸ºæ•™æˆå­¦ç”Ÿå…³äºå…±è¯†çŸ¥è¯†çš„ä¸»è¦å·¥å…·ã€‚</p><p>æ¯”è¾ƒé—æ†¾çš„æ˜¯ï¼Œå°½ç®¡å¾ˆå¤šäººä¸€ç›´åœ¨åŠªåŠ›å°è¯•ä½¿ Paxos æ›´æ˜“æ‡‚ï¼ŒPaxosè¿˜æ˜¯å¤ªéš¾ç†è§£äº†ã€‚æ­¤å¤–ï¼ŒPaxosçš„æ¶æ„éœ€è¦å¤æ‚çš„æ”¹å˜æ¥æ”¯æŒå®é™…ç³»ç»Ÿã€‚è¿™å¯¼è‡´çš„ç»“æœå°±æ˜¯ç³»ç»Ÿå¼€å‘è€…å’Œå­¦ç”Ÿåœ¨å­¦ç”Ÿå’Œä½¿ç”¨Paxos è¿‡ç¨‹ä¸­éƒ½å¾ˆæŒ£æ‰ã€‚</p><p>åœ¨æˆ‘ä»¬è‡ªå·±ä¸ Paxosæ–—äº‰ä¹‹åï¼Œæˆ‘ä»¬å¼€å§‹ç€æ‰‹å¯»æ‰¾ä¸€ä¸ªæ–°çš„å…±è¯†ç®—æ³•ï¼Œå¸Œæœ›å¯ä»¥ä¸ºç³»ç»Ÿå¼€å‘å’Œæ•™å­¦æä¾›æ›´å¥½çš„åŸºç¡€ã€‚æˆ‘ä»¬çš„æ–¹æ³•æ˜¯ä¸å¯»å¸¸çš„ï¼Œå› ä¸ºæˆ‘ä»¬çš„ä¸»è¦ç›®æ ‡æ˜¯å¯ç†è§£æ€§ï¼šæˆ‘ä»¬å¯ä»¥è®¾è®¡ä¸€ä¸ªæ¯”Paxos æ›´é€‚åˆç”¨äºå®é™…å·¥ç¨‹å®ç°å¹¶ä¸”æ›´æ˜“æ‡‚çš„å…±è¯†ç®—æ³•å—ï¼Ÿ</p><p>åœ¨è¯¥ç®—æ³•çš„è®¾è®¡ä¸­ï¼Œé‡è¦çš„ä¸ä»…æ˜¯å¦‚ä½•è®©ç®—æ³•èµ·ä½œç”¨ï¼Œè¿˜è¦æ¸…æ™°åœ°çŸ¥é“è¯¥ç®—æ³•ä¸ºä»€ä¹ˆä¼šèµ·ä½œç”¨ã€‚</p><p>è¿™é¡¹å·¥ä½œçš„ç»“æœæ˜¯ä¸€ä¸ªç§°ä¸º Raft çš„å…±è¯†æ€§ç®—æ³•ã€‚åœ¨è®¾è®¡ Raftæ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ç‰¹å®šçš„æŠ€æœ¯æ¥æé«˜å®ƒçš„å¯ç†è§£æ€§ï¼ŒåŒ…æ‹¬ï¼š</p><ul><li>åˆ†è§£ï¼ˆRaft åˆ†ç¦»å‡ºä¸‰ä¸ªå…³é”®ç‚¹ï¼šleader electionã€logreplicationã€safetyï¼‰</li><li>å‡å°‘çŠ¶æ€ç©ºé—´ï¼ˆç›¸æ¯”äº Paxosï¼ŒRafté™ä½äº†ä¸ç¡®å®šæ€§çš„ç¨‹åº¦å’ŒæœåŠ¡å™¨ä¹‹é—´çš„ä¸ä¸€è‡´ï¼‰</li></ul><p>ä¸€é¡¹é’ˆå¯¹ 2 æ‰€å¤§å­¦å…± 43 åå­¦ç”Ÿçš„ç”¨æˆ·ç ”ç©¶è¡¨æ˜ï¼ŒRaft æ¯” Paxosæ›´å®¹æ˜“ç†è§£ï¼šåœ¨å­¦ä¹ ä¸¤ç§ç®—æ³•åï¼Œå…¶ä¸­ 33 åå­¦ç”Ÿèƒ½å¤Ÿæ›´å¥½åœ°å›ç­” Raftçš„ç›¸å…³é—®é¢˜ã€‚</p><p>Raft åœ¨è®¸å¤šæ–¹é¢ç±»ä¼¼äºç°æœ‰çš„å…¬å¼ç®—æ³•ï¼ˆå°¤å…¶æ˜¯ Okiã€Liskov çš„Viewstamped Replication [29,22]ï¼‰ï¼Œä½†å®ƒæœ‰å‡ ä¸ªæ–°ç‰¹æ€§ï¼š</p><ul><li><strong>Strong leaderï¼ˆå¼ºé¢†å¯¼æ€§ï¼‰</strong>ï¼šç›¸æ¯”äºå…¶ä»–ç®—æ³•ï¼ŒRaftä½¿ç”¨äº†æ›´å¼ºçš„é¢†å¯¼å½¢å¼ã€‚æ¯”å¦‚ï¼Œæ—¥å¿—æ¡ç›®åªèƒ½ä» leader æµå‘followerï¼ˆé›†ç¾¤ä¸­é™¤ leader å¤–å…¶ä»–çš„æœåŠ¡å™¨ï¼‰ã€‚è¿™åœ¨ä½¿ Raftæ›´æ˜“æ‡‚çš„åŒæ—¶ç®€åŒ–äº†æ—¥å¿—å¤åˆ¶çš„ç®¡ç†æµç¨‹ã€‚</li><li><strong>Leader electionï¼ˆé¢†å¯¼é€‰ä¸¾ï¼‰</strong>ï¼šRaftä½¿ç”¨éšæœºè®¡æ—¶å™¨æ¥è¿›è¡Œé¢†å¯¼é€‰ä¸¾ã€‚ä»»ä½•å…±è¯†ç®—æ³•éƒ½éœ€è¦å¿ƒè·³æœºåˆ¶ï¼ˆheartbeatsï¼‰ï¼ŒRaftåªéœ€è¦åœ¨è¿™ä¸ªåŸºç¡€ä¸Šï¼Œæ·»åŠ å°‘é‡æœºåˆ¶ï¼Œå°±å¯ä»¥ç®€å•å¿«é€Ÿåœ°è§£å†³å†²çªã€‚</li><li><strong>Membership changesï¼ˆæˆå‘˜å˜æ›´ï¼‰</strong>ï¼šRaftåœ¨æ›´æ”¹é›†ç¾¤ä¸­æœåŠ¡å™¨é›†çš„æœºåˆ¶ä¸­ä½¿ç”¨äº†ä¸€ä¸ª <strong>è”åˆå…±è¯†ï¼ˆjointconsensusï¼‰</strong> çš„æ–¹æ³•ã€‚åœ¨è”åˆå…±è¯†ï¼ˆjointconsensusï¼‰ä¸‹ï¼Œåœ¨é›†ç¾¤é…ç½®çš„è½¬æ¢è¿‡ç¨‹ä¸­ï¼Œæ–°æ—§ä¸¤ç§é…ç½®å¤§å¤šæ•°æ˜¯é‡å çš„ï¼Œè¿™ä½¿å¾—é›†ç¾¤åœ¨é…ç½®æ›´æ”¹æœŸé—´å¯ä»¥ç»§ç»­æ­£å¸¸è¿è¡Œã€‚</li></ul><p>æˆ‘ä»¬è®¤ä¸º Raft è·Ÿ Paxosä»¥åŠå…¶ä»–å…±è¯†ç®—æ³•ç›¸æ¯”æ˜¯æ›´ä¼˜çš„ï¼Œè¿™ä¸ä»…ä½“ç°åœ¨æ•™å­¦æ–¹é¢ï¼Œè¿˜ä½“ç°åœ¨å·¥ç¨‹å®ç°æ–¹é¢ã€‚</p><ul><li>å®ƒæ¯”å…¶ä»–ç®—æ³•æ›´ç®€å•ä¸”æ›´æ˜“äºç†è§£</li><li>å®ƒè¢«æè¿°å¾—ååˆ†è¯¦ç»†è¶³ä»¥æ»¡è¶³å®é™…ç³»ç»Ÿçš„éœ€è¦</li><li>å®ƒæœ‰å¤šä¸ªå¼€æºå®ç°ï¼Œå¹¶è¢«å¤šå®¶å…¬å¸ä½¿ç”¨</li><li>å®ƒçš„å®‰å…¨æ€§å·²è¢«æ­£å¼è§„å®šå’ŒéªŒè¯</li><li>å®ƒçš„æ•ˆç‡ä¸å…¶ä»–ç®—æ³•ç›¸å½“</li></ul><p>æœ¬æ–‡å‰©ä½™éƒ¨åˆ†ï¼š</p><table><thead><tr class="header"><th>æ‰€åœ¨èŠ‚</th><th>å†…å®¹</th></tr></thead><tbody><tr class="odd"><td>ç¬¬ 2 èŠ‚</td><td>å¤åˆ¶çŠ¶æ€æœºé—®é¢˜ï¼ˆreplicated state machine problemï¼‰</td></tr><tr class="even"><td>ç¬¬ 3 èŠ‚</td><td>Paxos çš„ä¼˜ç¼ºç‚¹</td></tr><tr class="odd"><td>ç¬¬ 4 èŠ‚</td><td>å®ç° Raft æ˜“ç†è§£æ€§çš„æªæ–½</td></tr><tr class="even"><td>ç¬¬ 5-8 èŠ‚</td><td>Raft å…±è¯†æ€§ç®—æ³•è¯¦ç»†é˜è¿°</td></tr><tr class="odd"><td>ç¬¬ 9 èŠ‚</td><td>è¯„ä¼° Raft</td></tr><tr class="even"><td>ç¬¬ 10 èŠ‚</td><td>å…¶ä»–ç›¸å…³å·¥ä½œ</td></tr></tbody></table><h2 id="å¤åˆ¶çŠ¶æ€æœº">2. å¤åˆ¶çŠ¶æ€æœº</h2><p>å…±è¯†ç®—æ³•ä¸€èˆ¬éƒ½æ˜¯åœ¨å¤åˆ¶çŠ¶æ€æœº [37]çš„èƒŒæ™¯ä¸‹å®ç°çš„ã€‚åœ¨è¿™ç§æ–¹æ³•ä¸‹ï¼Œä¸€ç»„æœåŠ¡å™¨åœ¨çš„çŠ¶æ€æœºè®¡ç®—ç›¸åŒçŠ¶æ€çš„ç›¸åŒå‰¯æœ¬ï¼Œå³ä½¿æŸäº›æœåŠ¡å™¨å´©æºƒï¼Œå®ƒä»¬ä¹Ÿå¯ä»¥ç»§ç»­è¿è¡Œã€‚</p><p>å¤åˆ¶çŠ¶æ€æœºæ˜¯ç”¨æ¥è§£å†³åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å„ç§å®¹é”™é—®é¢˜ã€‚æ¯”å¦‚è¯´ï¼Œå…·æœ‰å•ä¸ªleader çš„å¤§è§„æ¨¡çš„ç³»ç»Ÿï¼Œå¦‚ GFS [8]ï¼ŒHDFS [38] å’Œ RAMCloud [33]ï¼Œä»–ä»¬é€šå¸¸éƒ½ä½¿ç”¨å•ç‹¬çš„å¤åˆ¶çŠ¶æ€æœºæ¥ç®¡ç† leader election å’Œä¿å­˜ leaderå´©æºƒåé‡æ–°é€‰ä¸¾æ‰€éœ€çš„é…ç½®ä¿¡æ¯ã€‚åƒ Chubby [2] å’Œ ZooKeeper [11]éƒ½æ˜¯å¤åˆ¶çŠ¶æ€æœºã€‚</p><p>å¤åˆ¶çŠ¶æ€æœºé€šå¸¸éƒ½æ˜¯ä½¿ç”¨æ—¥å¿—å¤åˆ¶ï¼ˆlogreplicationï¼‰æ¥å®ç°ã€‚å¦‚å›¾1ï¼šæ¯ä¸ªæœåŠ¡å™¨éƒ½ä¿å­˜ç€ä¸€ä»½æ‹¥æœ‰ä¸€ç³»åˆ—å‘½ä»¤çš„æ—¥å¿—ï¼Œç„¶åæœåŠ¡å™¨ä¸Šçš„çŠ¶æ€æœºä¼šæŒ‰é¡ºåºæ‰§è¡Œæ—¥å¿—ä¸­çš„å‘½ä»¤ã€‚æ¯ä¸€ä»½æ—¥å¿—ä¸­å‘½ä»¤ç›¸åŒå¹¶ä¸”é¡ºåºä¹Ÿç›¸åŒï¼Œå› æ­¤æ¯ä¸ªçŠ¶æ€æœºå¯ä»¥å¤„ç†ç›¸åŒçš„å‘½ä»¤åºåˆ—ã€‚æ‰€ä»¥çŠ¶æ€æœºæ˜¯å¯ç¡®å®šçš„ï¼Œæ¯ä¸ªçŠ¶æ€æœºéƒ½æ‰§è¡Œç›¸åŒçš„çŠ¶æ€å’Œç›¸åŒçš„è¾“å‡ºåºåˆ—ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/008i3skNly1gsmihlh9ptj322u0nsgpj.jpg"alt="image-20210719200404010" /><figcaption aria-hidden="true">image-20210719200404010</figcaption></figure><p>å…±è¯†ç®—æ³•çš„ä¸»è¦å·¥ä½œå°±æ˜¯ä¿è¯å¤åˆ¶æ—¥å¿—ï¼ˆreplicatedlogï¼‰çš„ä¸€è‡´æ€§ã€‚æ¯å°æœåŠ¡å™¨ä¸Šçš„å…±è¯†æ¨¡å—æ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯çš„å‘½ä»¤ï¼Œå¹¶å°†è¿™äº›å‘½ä»¤æ·»åŠ åˆ°å…¶æ—¥å¿—å½“ä¸­ã€‚å®ƒï¼ˆæŒ‡å…±è¯†æ¨¡å—ï¼‰ä¸å…¶ä»–æœåŠ¡å™¨ä¸Šçš„å…±è¯†æ¨¡å—è¿›è¡Œé€šä¿¡ï¼Œä»¥ç¡®ä¿æ¯å°æœåŠ¡å™¨ä¸Šæœ€ç»ˆä»¥ç›¸åŒçš„é¡ºåºåŒ…å«ç›¸åŒçš„å‘½ä»¤ï¼Œå³ä½¿éƒ¨åˆ†æœåŠ¡å™¨å´©æºƒäº†ï¼Œè¿™ä¸ªæ¡ä»¶ä¹Ÿå¯ä»¥æ»¡è¶³ã€‚ä¸€æ—¦å‘½ä»¤è¢«æ­£ç¡®å¤åˆ¶ï¼Œæ¯å°æœåŠ¡å™¨ä¸Šçš„çŠ¶æ€æœºå°±ä¼šæŒ‰æ—¥å¿—é¡ºåºå¤„ç†å®ƒä»¬ï¼Œå¹¶å°†è¾“å‡ºè¿”å›ç»™å®¢æˆ·ç«¯ã€‚è¿™æ ·å°±å½¢æˆäº†é«˜å¯ç”¨çš„å¤åˆ¶çŠ¶æ€æœºã€‚</p><p>é€‚ç”¨äºå®é™…ç³»ç»Ÿçš„å…±è¯†ç®—æ³•é€šå¸¸éƒ½åŒ…å«ä»¥ä¸‹å‡ ç‚¹ç‰¹å¾ï¼š</p><ul><li><p>å®ƒä»¬ç¡®ä¿åœ¨æ‰€æœ‰éæ‹œå åº­é”™è¯¯ä¸‹çš„å®‰å…¨æ€§ï¼Œä¹Ÿå°±æ˜¯ä»ä¸è¿”å›ä¸€ä¸ªé”™è¯¯çš„ç»“æœã€‚ï¼ˆå³ä½¿æ˜¯ç½‘ç»œå»¶è¿Ÿã€åˆ†åŒºã€æ•°æ®åŒ…ä¸¢å¤±ã€æ•°æ®åŒ…é‡å¤å’Œæ•°æ®åŒ…ä¹±åºï¼‰</p><blockquote><p><strong><ahref="https://zh.wikipedia.org/wiki/%E6%8B%9C%E5%8D%A0%E5%BA%AD%E5%B0%86%E5%86%9B%E9%97%AE%E9%A2%98">æ‹œå åº­é”™è¯¯</a>ï¼š</strong></p><p>å‡ºç°æ•…éšœï¼ˆcrash æˆ–fail-stopï¼Œå³ä¸å“åº”ï¼‰ä½†ä¸ä¼šä¼ªé€ ä¿¡æ¯çš„æƒ…å†µç§°ä¸ºâ€œéæ‹œå åº­é”™è¯¯â€ã€‚</p><p>ä¼ªé€ ä¿¡æ¯æ¶æ„å“åº”çš„æƒ…å†µç§°ä¸ºâ€œæ‹œå åº­é”™è¯¯â€ï¼Œå¯¹åº”èŠ‚ç‚¹ç§°ä¸ºæ‹œå åº­èŠ‚ç‚¹ã€‚</p></blockquote></li><li><p>åªè¦ä»»ä½•å¤§å¤šæ•°ï¼ˆè¿‡åŠï¼‰æœåŠ¡å™¨æ˜¯å¯è¿è¡Œçš„ï¼Œå¹¶ä¸”å¯ä»¥äº’ç›¸é€šä¿¡å’Œä¸å®¢æˆ·ç«¯é€šä¿¡ï¼Œé‚£ä¹ˆå…±è¯†ç®—æ³•å°±å¯ç”¨ã€‚å‡è®¾æœåŠ¡å™¨å´©æºƒäº†ï¼Œä¸€å°æ®µæ—¶é—´åï¼Œå®ƒä»¬å¾ˆå¯èƒ½ä¼šæ ¹æ®å·²ç»ç¨³å®šå­˜å‚¨çš„çŠ¶æ€æ¥è¿›è¡Œæ¢å¤ï¼Œå¹¶é‡æ–°åŠ å…¥é›†ç¾¤ã€‚</p></li><li><p>å®ƒä»¬åœ¨ä¿è¯æ—¥å¿—ä¸€è‡´æ€§ä¸Šä¸ä¾èµ–äºæ—¶åºï¼šé”™è¯¯çš„æ—¶é’Ÿå’Œæç«¯æ¶ˆæ¯å»¶è¿Ÿåœ¨æœ€åçš„æƒ…å†µä¸‹ä¼šäº§ç”Ÿå½±å“å¯ç”¨æ€§çš„ä¸€ç³»åˆ—é—®é¢˜ã€‚</p></li><li><p>åœ¨é€šå¸¸æƒ…å†µä¸‹ï¼Œåªè¦é›†ç¾¤ä¸­å¤§éƒ¨åˆ†ï¼ˆè¿‡åŠï¼‰æœåŠ¡å™¨å·²ç»å“åº”äº†å•è½®è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆRPCï¼‰ï¼Œå‘½ä»¤å°±å¯ä»¥è¢«è§†ä¸ºå®Œæˆã€‚å°‘æ•°ï¼ˆä¸€åŠä»¥ä¸‹ï¼‰æ…¢æœåŠ¡å™¨ä¸ä¼šå½±å“æ•´ä¸ªç³»ç»Ÿçš„æ€§èƒ½ã€‚</p></li></ul><h2 id="paxos-å­˜åœ¨çš„é—®é¢˜">3. Paxos å­˜åœ¨çš„é—®é¢˜</h2><p>åœ¨è¿‡å»çš„åå¹´é—´ï¼ŒLeslie Lamport çš„ Paxos åè®® [15]å‡ ä¹æˆä¸ºå…±è¯†æ€§ï¼ˆconsensusï¼‰çš„åŒä¹‰è¯ã€‚å®ƒæ˜¯è¯¾å ‚ä¸Šè¢«æ•™æˆæœ€å¤šçš„å…±è¯†åè®®ï¼Œå¤§å¤šæ•°å…±è¯†æ€§çš„å®ç°ä¹Ÿæ˜¯ä»¥å®ƒä¸ºèµ·ç‚¹ã€‚Paxosé¦–å…ˆå®šä¹‰äº†èƒ½åœ¨å•ä¸ªå†³ç­–é—®é¢˜ï¼ˆä¾‹å¦‚å•ä¸ªå¤åˆ¶æ—¥å¿—æ¡ç›®ï¼‰ä¸Šè¾¾æˆå…±è¯†çš„åè®®ã€‚æˆ‘ä»¬å°†è¿™ä¸ªå­é›†ç§°ä¸º<em>signle-degree Paxos</em>ã€‚ç„¶å Paxosç»„åˆè¯¥åè®®çš„å¤šä¸ªå®ä¾‹å»å®ç°ä¸€ç³»åˆ—å†³ç­–ï¼Œæ¯”å¦‚æ—¥å¿—ï¼ˆ<em>mutil-Paxos</em>ï¼‰ã€‚Paxosä¿è¯äº†å®‰å…¨æ€§å’Œæ´»æ€§ï¼Œå®ƒä¹Ÿæ”¯æŒæ”¹å˜é›†ç¾¤ä¸­çš„æˆå‘˜ï¼Œå®ƒçš„å®‰å…¨æ€§ä¹Ÿå·²ç»è¢«è®ºè¯äº†ï¼Œå¹¶ä¸”å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½æ˜¯é«˜æ•ˆçš„ã€‚</p><p>ç¾ä¸­ä¸è¶³çš„æ˜¯ï¼ŒPaxos æœ‰ä¸¤ä¸ªä¸¥é‡çš„ç¼ºç‚¹ï¼š</p><ol type="1"><li><p><strong>Paxos éå¸¸éš¾ç†è§£</strong></p><p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒPaxoséå¸¸æ™¦æ¶©éš¾æ‡‚ï¼Œé™¤éä¸‹äº†å¾ˆå¤§çš„åŠŸå¤«ï¼Œå¾ˆå°‘æœ‰äººèƒ½å¤ŸæˆåŠŸç†è§£å®ƒã€‚å› æ­¤ï¼Œå°½ç®¡ç›®å‰å·²ç»æœ‰å‡ ä¸ªå°è¯•å¸Œæœ›å°†Paxos [16,20,21] è§£é‡Šå¾—é€šä¿—æ˜“æ‡‚ä¸€äº›ï¼Œè€Œä¸”è¿™äº›è§£é‡Šéƒ½é›†ä¸­åœ¨<code>single-decree Paxos</code>ï¼Œä½†æ˜¯å®ƒä»¬è¿˜æ˜¯å¾ˆéš¾æ‡‚ã€‚</p><p>åœ¨å¯¹ NSDI 2012 å‚ä¼šè€…çš„éæ­£å¼è°ƒæŸ¥ä¸­ï¼Œæˆ‘ä»¬å‘ç°å¾ˆå°‘äººä¼šå–œæ¬¢Paxosï¼Œå³ä½¿æ˜¯ç»éªŒä¸°å¯Œçš„ç ”ç©¶äººå‘˜ã€‚æˆ‘ä»¬è‡ªå·±ä¹Ÿä¸€ç›´åœ¨è·Ÿ Paxosä½œæ–—äº‰ï¼Œæˆ‘ä»¬ä¹Ÿæ— æ³•å®Œå…¨ç†è§£æ•´ä¸ª Paxosåè®®ï¼Œç›´åˆ°é˜…è¯»äº†å‡ ä¸ªæ›´ç®€å•çš„æè¿°å’Œè‡ªå·±è®¾è®¡äº†æ›¿ä»£ Paxos çš„åè®®ï¼Œæˆ‘ä»¬æ‰å¯¹Paxos æœ‰äº†æ¯”è¾ƒæ·±åˆ»çš„ç†è§£ã€‚ä½†è¿™ä¸ªè¿‡ç¨‹ï¼ŒèŠ±äº†å°†è¿‘ä¸€å¹´ã€‚</p><p>æˆ‘ä»¬æ¨æµ‹ Paxos è¿™ä¹ˆæ™¦æ¶©éš¾æ‡‚ï¼Œä¸»è¦æ˜¯å› ä¸ºä½œè€…é€‰æ‹©äº†<code>Single-decree Paxos</code>æ¥ä½œä¸ºåŸºç¡€ã€‚<code>Single-decree Paxso</code>éå¸¸æäººï¼šå®ƒåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å¯¹è¿™ä¸¤ä¸ªé˜¶æ®µè¿›è¡Œç®€å•ç›´è§‚çš„è¯´æ˜ï¼Œè€Œä¸”è¿™ä¸¤ä¸ªé˜¶æ®µä¹Ÿä¸èƒ½åˆ†å¼€äº†å•ç‹¬ç†è§£ï¼Œæ‰€ä»¥ä½¿ç”¨è€…å°†å°±å¾ˆéš¾ç†è§£ä¸ºä»€ä¹ˆè¯¥ç®—æ³•èƒ½èµ·ä½œç”¨ã€‚<code>Multi-Paxos</code>çš„åˆæˆè§„åˆ™åˆå¢åŠ äº†è®¸å¤šå¤æ‚æ€§ã€‚æˆ‘ä»¬ç›¸ä¿¡ï¼Œå¯¹å¤šä¸ªå†³å®šï¼ˆæ—¥å¿—ï¼Œå¹¶éå•ä¸ªæ—¥å¿—æ¡ç›®ï¼‰è¾¾æˆå…±è¯†çš„æ€»ä½“é—®é¢˜å¯ä»¥ç”¨å…¶ä»–æ›´ç›´æ¥å’Œæ›´æ˜æ˜¾çš„æ–¹å¼è¿›è¡Œåˆ†è§£ã€‚</p></li><li><p><strong>Paxos æ²¡æœ‰ä¸ºå®é™…å®ç°æä¾›ä¸€ä¸ªè‰¯å¥½çš„åŸºç¡€</strong></p><p>å…¶ä¸­ä¸€ä¸ªåŸå› æ˜¯æ²¡æœ‰å¹¿æ³›è®¤åŒçš„é’ˆå¯¹ <code>Multi-Paxos</code>çš„ç®—æ³•ã€‚Lamport çš„æè¿°ä¸»è¦æ˜¯é’ˆå¯¹ <code>signle-decree Paxos</code>çš„ï¼Œä»–æè¿°äº†é’ˆå¯¹ <code>multi-Paxos</code>çš„å¯èƒ½æ–¹æ³•ï¼Œä½†ç¼ºå°‘äº†å¾ˆå¤šç»†èŠ‚ã€‚</p><p>ç›®å‰å·²ç»æœ‰äººåœ¨å°è¯•å…·ä½“åŒ–å’Œä¼˜åŒ– Paxosï¼Œæ¯”å¦‚ [26]ï¼Œ[39] å’Œ[13]ï¼Œä½†æ˜¯è¿™äº›å°è¯•éƒ½äº’ä¸ç›¸åŒå¹¶ä¸”å®ƒä»¬è·Ÿ Lamport æè¿°çš„ä¹Ÿä¸å°½ç›¸åŒã€‚è™½ç„¶åƒChubby [4] è¿™æ ·çš„ç³»ç»Ÿå·²ç»å®ç°äº†ç±»Paxosï¼ˆPaxos-likeï¼‰ç®—æ³•ï¼Œä½†æ˜¯ä»–ä»¬å¹¶æ²¡æœ‰é€éœ²å‡ºå¾ˆå¤šçš„å®ç°ç»†èŠ‚ã€‚</p></li></ol><p>æ­¤å¤–ï¼ŒPaxos çš„æ¶æ„å¯¹äºæ„å»ºå®é™…ç³»ç»Ÿæ¥è¯´å…¶å®æ˜¯ä¸€ä¸ªç³Ÿç³•çš„è®¾è®¡ï¼Œè¿™æ˜¯<code>single-decree Paxos</code>åˆ†è§£çš„å¦ä¸€ä¸ªç»“æœã€‚ä¸¾ä¸ªä¾‹å­ï¼Œè¿™å¯¹äºç‹¬ç«‹é€‰æ‹©åœ°æ—¥å¿—æ¡ç›®çš„é›†åˆï¼Œç„¶åå†å°†å®ƒä»¬åˆå¹¶åˆ°é¡ºåºæ—¥å¿—å½“ä¸­æ²¡æœ‰ä»»ä½•å¥½å¤„ï¼Œè¿™åªä¼šå¢åŠ å¤æ‚æ€§ã€‚å›´ç»•æ—¥å¿—æ¥è®¾è®¡ç³»ç»Ÿæ˜¯æ›´åŠ ç®€å•å’Œé«˜æ•ˆçš„æ–¹æ³•ï¼Œå…¶ä¸­æ–°æ¡ç›®æŒ‰å—çº¦æŸçš„é¡ºåºä¾æ¬¡é™„åŠ ã€‚å¦å¤–ä¸€ä¸ªé—®é¢˜æ˜¯Paxosåœ¨å…¶æ ¸å¿ƒä½¿ç”¨äº†<strong>å¯¹ç§°å¯¹ç­‰æ–¹æ³•</strong>ï¼ˆå°½ç®¡å®ƒæœ€ç»ˆè¡¨æ˜äº†è¿™ä¼šè¢«ç”¨ä½œä¸€ç§æ€§èƒ½ä¼˜åŒ–çš„å¼±é¢†å¯¼æ¨¡å¼ï¼‰ã€‚è¿™åœ¨åªæœ‰ä¸€ä¸ªå†³ç­–çš„æƒ…å†µä¸‹æ˜¯æœ‰æ„ä¹‰çš„ï¼Œä½†æ˜¯å°½ç®¡å¦‚æ­¤ï¼Œè¿˜æ˜¯å¾ˆå°‘æœ‰å®é™…ç³»ç»Ÿé‡‡ç”¨äº†è¿™ç§æ–¹æ³•ã€‚å¦‚æœæœ‰ä¸€ç³»åˆ—çš„å†³ç­–éœ€è¦åˆ¶å®šï¼Œæ›´ç®€å•å’Œæ›´å¿«é€Ÿçš„æ–¹æ³•åº”è¯¥æ˜¯é¦–å…ˆé€‰æ‹©ä¸€ä¸ªleaderï¼Œç„¶åç”± leader å»åè°ƒè¿™äº›å†³ç­–ã€‚</p><p>å› æ­¤ï¼ŒæŒ‰ç…§ Paxos æ¥å®ç°çš„å®é™…ç³»ç»Ÿå¾€å¾€è·Ÿ Paxosç›¸å·®å¾ˆå¤§ã€‚å‡ ä¹æ‰€æœ‰çš„å®ç°éƒ½æ˜¯ä» Paxoså¼€å§‹ï¼Œç„¶ååœ¨å®ç°çš„è¿‡ç¨‹ä¸­å‘ç°äº†ä¸€ç³»åˆ—çš„éš¾é¢˜ï¼Œåœ¨è§£å†³éš¾é¢˜çš„è¿‡ç¨‹ä¸­ï¼Œå¼€å‘å‡ºäº†è·ŸPaxos å®Œå…¨ä¸ä¸€æ ·çš„æ¶æ„ã€‚è¿™æ ·æ—¢è´¹æ—¶åˆå®¹æ˜“å‡ºé”™ï¼Œè€Œä¸” Paxosæœ¬èº«çš„æ™¦æ¶©éš¾æ‡‚åˆä½¿å¾—é—®é¢˜å˜å¾—æ›´åŠ ä¸¥é‡ã€‚Paxoså…¬å¼å¯èƒ½æ˜¯è¯æ˜å…¶æ­£ç¡®æ€§çš„ä¸€ä¸ªå¾ˆå¥½çš„å…¬å¼ï¼Œä½†çœŸæ­£çš„å®ç°ä¸ Paxosåˆç›¸å·®å¾ˆå¤§ï¼Œè¿™è¯æ˜äº†å®ƒå…¶å®æ²¡æœ‰ä»€ä¹ˆä»·å€¼ã€‚ä¸‹é¢æ¥è‡ª Chubbyä½œè€…çš„è¯„è®ºéå¸¸å…¸å‹ï¼š</p><blockquote><p>åœ¨ Paxos ç®—æ³•æè¿°å’Œç°å®å®ç°ç³»ç»Ÿä¹‹é—´æœ‰ç€å·¨å¤§çš„é¸¿æ²Ÿ... ï¼ˆå¦‚æœä¸€ç›´æŒ‰ç…§Paxos ç®—æ³•èµ°ä¸‹å»ï¼‰ï¼Œæœ€ç»ˆçš„ç³»ç»Ÿå¾€å¾€ä¼šå»ºç«‹åœ¨ä¸€ä¸ªè¿˜æœªè¢«è¯æ˜çš„åè®®ä¹‹ä¸Šã€‚</p></blockquote><p>ç»¼åˆä¸Šè¿°é—®é¢˜ï¼Œæˆ‘ä»¬è§‰å¾— Paxosåœ¨æ•™å­¦ç«¯å’Œç³»ç»Ÿæ„å»ºç«¯éƒ½æ²¡æœ‰æä¾›ä¸€ä¸ªè‰¯å¥½çš„åŸºç¡€ã€‚è€ƒè™‘åˆ°å…±è¯†æ€§åœ¨å¤§è§„æ¨¡è½¯ä»¶ç³»ç»Ÿä¸­çš„é‡è¦æ€§ï¼Œæˆ‘ä»¬å†³å®šå»å°è¯•ä¸€ä¸‹çœ‹çœ‹èƒ½ä¸èƒ½è®¾è®¡ä¸€ä¸ªæ›¿ä»£Paxos å¹¶ä¸”å…·æœ‰æ›´å¥½ç‰¹æ€§çš„å…±è¯†ç®—æ³•ã€‚Raft å°±æ˜¯è¿™æ¬¡å®éªŒçš„ç»“æœã€‚</p><h2 id="ä¸ºå¯ç†è§£æ€§è€Œè®¾è®¡">4. ä¸ºå¯ç†è§£æ€§è€Œè®¾è®¡</h2><p>åœ¨è®¾è®¡ Raft ç®—æ³•è¿‡ç¨‹ä¸­æˆ‘ä»¬æœ‰å‡ ä¸ªç›®æ ‡ï¼š</p><ul><li>å®ƒå¿…é¡»ä¸ºç³»ç»Ÿæ„å»ºæä¾›ä¸€ä¸ªå®Œæ•´ä¸”å®é™…çš„åŸºç¡€ï¼Œè¿™æ ·æ‰èƒ½å¤§å¤§å‡å°‘å¼€å‘è€…çš„å·¥ä½œ</li><li>å®ƒå¿…é¡»åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½æ˜¯å®‰å…¨çš„å¹¶ä¸”åœ¨å…¸å‹çš„åº”ç”¨æ¡ä»¶ä¸‹æ˜¯å¯ç”¨çš„ï¼Œå¹¶ä¸”åœ¨æ­£å¸¸æƒ…å†µä¸‹æ˜¯é«˜æ•ˆçš„</li></ul><p>ä½†æ˜¯æˆ‘ä»¬æœ€é‡è¦çš„ç›®æ ‡ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬é‡åˆ°çš„æœ€å¤§çš„æŒ‘æˆ˜ï¼š</p><ul><li>å®ƒå¿…é¡»å…·æœ‰æ˜“ç†è§£æ€§ï¼Œå®ƒå¿…é¡»ä¿è¯èƒ½å¤Ÿè¢«å¤§å¤šæ•°äººè½»æ¾åœ°ç†è§£ã€‚è€Œä¸”å®ƒå¿…é¡»èƒ½å¤Ÿè®©äººå½¢æˆç›´è§‚çš„è®¤è¯†ï¼Œè¿™æ ·ç³»ç»Ÿæ„å»ºè€…æ‰èƒ½åœ¨å®ç°è¿‡ç¨‹ä¸­å¯¹å®ƒè¿›è¡Œä¸å¯é¿å…çš„æ‹“å±•ã€‚</li></ul><p>åœ¨è®¾è®¡ Raftç®—æ³•çš„è¿‡ç¨‹ä¸­ï¼Œå¾ˆå¤šæƒ…å†µä¸‹æˆ‘ä»¬éœ€è¦åœ¨å¤šä¸ªå¤‡é€‰æ–¹æ¡ˆä¸‹åšå‡ºæŠ‰æ‹©ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¾€å¾€ä¼šåŸºäºå¯ç†è§£æ€§æ¥è¿›è¡ŒæŠ‰æ‹©ï¼š</p><ul><li>è§£é‡Šå„ä¸ªå¤‡é€‰æ–¹æ¡ˆçš„éš¾åº¦æœ‰å¤šå¤§ï¼Ÿä¾‹å¦‚ï¼Œå®ƒçš„çŠ¶æ€ç©ºé—´æœ‰å¤šå¤æ‚ï¼Ÿå®ƒæ˜¯å¦å…·æœ‰éš¾ä»¥ç†è§£çš„å«ä¹‰ï¼Ÿ</li><li>å¯¹äºä¸€ä¸ªè¯»è€…æ¥è¯´ï¼Œå®Œæˆç†è§£è¿™ä¸ªæ–¹æ¡ˆå’Œæ–¹æ¡ˆä¸­çš„å„ç§å«ä¹‰æ˜¯å¦ç®€å•ï¼Ÿ</li></ul><p>æˆ‘ä»¬æ„è¯†åˆ°è¿™ä¸€çš„åˆ†æå…·æœ‰é«˜åº¦çš„ä¸»è§‚æ€§ã€‚æ‰€ä»¥æˆ‘ä»¬é‡‡å–äº†ä¸¤ç§é€šç”¨çš„æªæ–½æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><ol type="1"><li>ç¬¬ä¸€ä¸ªæªæ–½å°±æ˜¯ä¼—æ‰€å‘¨çŸ¥çš„é—®é¢˜åˆ†è§£ï¼šåªè¦æœ‰å¯èƒ½ï¼Œæˆ‘ä»¬å°±å°†é—®é¢˜åˆ’åˆ†æˆå‡ ä¸ªç›¸å¯¹ç‹¬ç«‹åœ°è§£å†³ã€è§£é‡Šå’Œç†è§£çš„å­é—®é¢˜ã€‚ä¾‹å¦‚ï¼ŒRaftç®—æ³•è¢«æˆ‘ä»¬åˆ’åˆ†æˆ leader é€‰ä¸¾ã€æ—¥å¿—å¤åˆ¶ã€å®‰å…¨æ€§å’Œæˆå‘˜å˜æ›´å‡ ä¸ªéƒ¨åˆ†ã€‚</li><li>ç¬¬äºŒä¸ªæªæ–½æ˜¯é€šè¿‡å‡å°‘çŠ¶æ€çš„æ•°é‡æ¥ç®€åŒ–çŠ¶æ€ç©ºé—´ï¼Œå°½å¯èƒ½åœ°ä½¿ç³»ç»Ÿå˜å¾—æ›´åŠ è¿è´¯å’Œå°½å¯èƒ½åœ°æ¶ˆé™¤ä¸ç¡®å®šæ€§ã€‚å¾ˆæ˜æ˜¾çš„ä¸€ä¸ªä¾‹å­å°±æ˜¯ï¼Œæ‰€æœ‰çš„æ—¥å¿—éƒ½æ˜¯ä¸å…è®¸æœ‰ç©ºæŒ¡çš„ï¼Œå¹¶ä¸”Rafté™åˆ¶äº†æ—¥å¿—ä¹‹é—´å¯èƒ½ä¸ä¸€æ ·çš„æ–¹å¼ã€‚å°½ç®¡åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬éƒ½æåŠ›å»æ¶ˆé™¤ä¸ç¡®å®šæ€§ï¼Œä½†æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹ä¸ç¡®å®šæ€§å´å¯ä»¥æé«˜å¯ç†è§£æ€§ã€‚ä¸€ä¸ªé‡è¦çš„ä¾‹å­å°±æ˜¯éšæœºåŒ–æ–¹æ³•ï¼Œå®ƒä»¬è™½ç„¶å¼•å…¥äº†ä¸ç¡®å®šæ€§ï¼Œä½†æ˜¯å®ƒä»¬å¾€å¾€èƒ½å¤Ÿé€šè¿‡ä»¥ç±»ä¼¼çš„æ–¹å¼å¤„ç†æ‰€æœ‰å¯èƒ½çš„é€‰æ‹©æ¥å‡å°‘çŠ¶æ€ç©ºé—´ï¼ˆéšä¾¿é€‰ï¼Œæ²¡å…³ç³»ï¼‰ã€‚æ‰€æœ‰æˆ‘ä»¬ä½¿ç”¨äº†éšæœºåŒ–æ¥ç®€åŒ–Raft ä¸­çš„ leader election ç®—æ³•ã€‚</li></ol><h2 id="raft-å…±è¯†ç®—æ³•">5. Raft å…±è¯†ç®—æ³•</h2><p>Raft æ˜¯ä¸€ç§ç”¨æ¥ç®¡ç†ç¬¬ 2 èŠ‚ä¸­æåˆ°çš„å¤åˆ¶æ—¥å¿—ï¼ˆreplicatedlogï¼‰çš„ç®—æ³•ã€‚å›¾ 2 æ˜¯è¯¥ç®—æ³•çš„æµ“ç¼©ï¼Œå¯ä»¥ä½œä¸ºå‚è€ƒã€‚å›¾ 3åˆ—ä¸¾äº†è¯¥ç®—æ³•çš„ä¸€äº›å…³é”®ç‰¹æ€§ã€‚è¿™ä¸¤å¼ å›¾ä¸­çš„å†…å®¹å°†ä¼šåœ¨åé¢çš„å„ä¸ªç« èŠ‚ä¸­é€ä¸€ä»‹ç»ã€‚</p><p>Raft åœ¨å®ç°å…±è¯†ç®—æ³•çš„è¿‡ç¨‹ä¸­ï¼Œé¦–å…ˆé€‰ä¸¾ä¸€ä¸ª distinguishedleaderï¼Œç„¶åç”±è¯¥ leader å…¨æƒè´Ÿè´£å¤åˆ¶æ—¥å¿—çš„ä¸€è‡´æ€§ã€‚Leaderä»å®¢æˆ·ç«¯æ¥æ”¶æ—¥å¿—æ¡ç›®ï¼Œç„¶åå°†è¿™äº›æ—¥å¿—æ¡ç›®å¤åˆ¶ç»™å…¶ä»–æœåŠ¡å™¨ï¼Œå¹¶ä¸”åœ¨ä¿è¯å®‰å…¨æ€§çš„æƒ…å†µä¸‹é€šçŸ¥å…¶ä»–æœåŠ¡å™¨å°†æ—¥å¿—æ¡ç›®åº”ç”¨åˆ°ä»–ä»¬çš„çŠ¶æ€æœºä¸­ã€‚æ‹¥æœ‰ä¸€ä¸ªleader å¤§å¤§ç®€åŒ–äº†å¯¹å¤åˆ¶æ—¥å¿—çš„ç®¡ç†æµç¨‹ã€‚ä¾‹å¦‚ï¼Œleaderå¯ä»¥åœ¨ä¸è·Ÿå…¶ä»–æœåŠ¡å™¨å•†è®®çš„æƒ…å†µä¸‹å†³å®šæ–°çš„æ—¥å¿—æ¡ç›®åº”è¯¥å­˜æ”¾åœ¨æ—¥å¿—çš„ä»€ä¹ˆä½ç½®ï¼Œå¹¶ä¸”æ•°æ®éƒ½æ˜¯ä»leader æµå‘å…¶ä»–æœåŠ¡å™¨ã€‚å½“ç„¶äº†ï¼Œä¸€ä¸ª leaderå¯èƒ½ä¼šå´©æºƒï¼Œä¹Ÿå¯èƒ½ä¸å…¶ä»–æœåŠ¡å™¨æ–­å¼€è¿æ¥ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼ŒRaftå°±ä¼šé€‰ä¸¾å‡ºä¸€ä¸ªæ–°çš„ leader å‡ºæ¥ã€‚</p><p>é€šè¿‡é€‰ä¸¾ä¸€ä¸ª leader çš„æ–¹å¼ï¼ŒRaftå°†å…±è¯†é—®é¢˜åˆ†è§£æˆä¸‰ä¸ªç‹¬ç«‹çš„å­é—®é¢˜ï¼Œè¿™äº›é—®é¢˜å°†ä¼šåœ¨æ¥ä¸‹æ¥çš„å­ç« èŠ‚ä¸­è¿›è¡Œè®¨è®ºï¼š</p><ul><li><p><strong>Leader electionï¼ˆé¢†å¯¼é€‰ä¸¾ï¼‰</strong></p><p>ä¸€ä¸ª leader å€’ä¸‹ä¹‹åï¼Œä¸€å®šä¼šæœ‰ä¸€ä¸ªæ–°çš„ leader ç«™èµ·æ¥ã€‚</p></li><li><p><strong>Log replicationï¼ˆæ—¥å¿—å¤åˆ¶ï¼‰</strong></p><p>leaderå¿…é¡»æ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯çš„æ—¥å¿—æ¡ç›®ç„¶åå¤åˆ¶åˆ°é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹ï¼Œå¹¶ä¸”å¼ºåˆ¶å…¶ä»–èŠ‚ç‚¹çš„æ—¥å¿—å’Œè‡ªå·±çš„ä¿æŒä¸€è‡´ã€‚</p></li><li><p><strong>Safetyï¼ˆå®‰å…¨æ€§ï¼‰</strong></p><p>Raft ä¸­å®‰å…¨æ€§çš„å…³é”®æ˜¯å›¾ 3ä¸­çŠ¶æ€æœºçš„å®‰å…¨æ€§ï¼šåªè¦æœ‰ä»»ä½•æœåŠ¡å™¨èŠ‚ç‚¹å°†ä¸€ä¸ªç‰¹å®šçš„æ—¥å¿—æ¡ç›®åº”ç”¨åˆ°å®ƒçš„çŠ¶æ€æœºä¸­ï¼Œé‚£ä¹ˆå…¶ä»–æœåŠ¡å™¨èŠ‚ç‚¹å°±ä¸èƒ½åœ¨åŒä¸€ä¸ªæ—¥å¿—ç´¢å¼•ä½ç½®ä¸Šå­˜å‚¨å¦å¤–ä¸€æ¡ä¸åŒçš„æŒ‡ä»¤ã€‚ç¬¬5.4 èŠ‚å°†ä¼šæè¿° Raft å¦‚ä½•ä¿è¯è¿™ç§ç‰¹æ€§ï¼Œè€Œä¸”è¯¥è§£å†³æ–¹æ¡ˆåœ¨ 5.2èŠ‚æè¿°çš„é€‰ä¸¾æœºåˆ¶ä¸Šè¿˜å¢åŠ äº†é¢å¤–çš„é™åˆ¶ã€‚</p></li></ul><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/008i3skNly1gsar1v5rklj32300pc4bj.jpg"alt="image-20210709155333989" /><figcaption aria-hidden="true">image-20210709155333989</figcaption></figure><p>åœ¨å±•ç¤ºäº† Raftå…±è¯†ç®—æ³•åï¼Œæœ¬ç« èŠ‚å°†è®¨è®ºå¯ç”¨æ€§çš„ä¸€äº›é—®é¢˜ä»¥åŠæ—¶åºåœ¨ç³»ç»Ÿä¸­çš„æ‰€ç”¨ã€‚</p><h3 id="raft-åŸºç¡€">5.1 Raft åŸºç¡€</h3><p>ä¸€ä¸ª Raft é›†ç¾¤ä¸­åŒ…å«è‹¥å¹²ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹ï¼Œ<font color="green"><strong>5ä¸ªä¸€ä¸ªæ¯”è¾ƒå…¸å‹çš„æ•°å­—ï¼Œ5 ä¸ªæœåŠ¡å™¨çš„é›†ç¾¤å¯ä»¥å®¹å¿ 2ä¸ªèŠ‚ç‚¹çš„å¤±æ•ˆ</strong></font>ã€‚åœ¨ä»»ä½•ä¸€ä¸ªæ—¶åˆ»ï¼Œé›†ç¾¤ä¸­çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½åªå¯èƒ½æ˜¯ä»¥ä¸‹æ˜¯ä¸‰ç§èº«ä»½ä¹‹ä¸€ï¼š</p><ul><li>leaderï¼šå®ƒä¼šå¤„ç†æ‰€æœ‰æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼ˆå¦‚æœä¸€ä¸ªå®¢æˆ·ç«¯å’Œ followeré€šä¿¡ï¼Œfollower ä¼šå°†è¯·æ±‚é‡å®šå‘åˆ° leader ä¸Šï¼‰</li><li>followerï¼šå®ƒä»¬è¢«åŠ¨çš„ï¼šå®ƒä»¬ä¸ä¼šå‘é€ä»»ä½•è¯·æ±‚ï¼Œåªæ˜¯ç®€å•çš„å“åº”æ¥è‡ªleader å’Œ candidate çš„è¯·æ±‚</li><li>candidateï¼šè¿™æ˜¯ç”¨æ¥é€‰ä¸¾ä¸€ä¸ªæ–°çš„ leaderçš„æ—¶å€™å‡ºç°çš„ä¸€ç§ä¸´æ—¶çŠ¶æ€ï¼Œè¿™å°†åœ¨ç¬¬ 5.2 èŠ‚ä¸­è¯¦ç»†æè¿°</li></ul><p>åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œé›†ç¾¤ä¸­åªæœ‰ä¸€ä¸ª leaderï¼Œç„¶åå‰©ä¸‹çš„èŠ‚ç‚¹éƒ½æ˜¯ followerã€‚å›¾4å±•ç¤ºäº†è¿™äº›çŠ¶æ€å’Œå®ƒä»¬ä¹‹é—´çš„è½¬æ¢å…³ç³»ï¼Œè¿™äº›è½¬æ¢å…³ç³»å°†ä¼šåœ¨æ¥ä¸‹æ¥è¿›è¡Œè®¨è®ºã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/008i3skNly1gsap8d6ijjj322s0l47g5.jpg"alt="image-20210709145034498" /><figcaption aria-hidden="true">image-20210709145034498</figcaption></figure><p>å¦‚å›¾ 5 æ‰€ç¤ºï¼ŒRaftå°†æ—¶é—´åˆ’åˆ†æˆä»»æ„é•¿åº¦çš„ä»»æœŸï¼ˆtermï¼‰ã€‚æ¯ä¸€æ®µä»»æœŸä»ä¸€æ¬¡é€‰ä¸¾å¼€å§‹ï¼Œåœ¨è¿™ä¸ªæ—¶å€™ä¼šæœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªcandidate å°è¯•å»æˆä¸º leaderã€‚å¦‚æœæŸä¸€ä¸ª candidateèµ¢å¾—äº†é€‰ä¸¾ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šåœ¨ä»»æœŸå‰©ä¸‹çš„æ—¶é—´é‡Œæ‰¿æ‹…ä¸€ä¸ª leaderçš„è§’è‰²ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¸€æ¬¡é€‰ä¸¾æ— æ³•é€‰å‡º leaderï¼Œè¿™ä¸ªæ—¶å€™è¿™ä¸ªä»»æœŸä¼šä»¥æ²¡æœ‰leaderè€Œç»“æŸã€‚åŒæ—¶ä¸€ä¸ªæ–°çš„ä»»æœŸï¼ˆåŒ…å«ä¸€æ¬¡æ–°çš„é€‰ä¸¾ï¼‰ä¼šå¾ˆå¿«é‡æ–°å¼€å§‹ã€‚è¿™æ˜¯å› ä¸ºRaft ä¼šä¿è¯åœ¨ä»»æ„ä¸€ä¸ªä»»æœŸå†…ï¼Œè‡³å¤šæœ‰ä¸€ä¸ª leaderã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/008i3skNly1gsapcmhhi4j31ym0ig78s.jpg"alt="image-20210709145441879" /><figcaption aria-hidden="true">image-20210709145441879</figcaption></figure><p>é›†ç¾¤ä¸­ä¸åŒçš„æœåŠ¡å™¨è§‚å¯Ÿåˆ°çš„ä»»æœŸè½¬æ¢çš„æ¬¡æ•°ä¹Ÿè®¸æ˜¯ä¸åŒçš„ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¸€ä¸ªèŠ‚ç‚¹å¯èƒ½æ²¡æœ‰è§‚å¯Ÿåˆ°leader é€‰ä¸¾è¿‡ç¨‹ç”šè‡³æ˜¯æ•´ä¸ªä»»æœŸè¿‡ç¨‹ã€‚</p><p>ä»»æœŸåœ¨ Raft ä¸­è¿˜æ‰®æ¼”ç€ä¸€ä¸ªé€»è¾‘æ—¶é’Ÿï¼ˆlogicalclockï¼‰çš„è§’è‰²ï¼Œè¿™ä½¿å¾—æœåŠ¡å™¨å¯ä»¥å‘ç°ä¸€äº›è¿‡æœŸçš„ä¿¡æ¯ï¼Œæ¯”å¦‚è¿‡æ—¶çš„leaderã€‚</p><p>æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½å­˜å‚¨ç€ä¸€ä¸ªå½“å‰ä»»æœŸå·ï¼ˆcurrent termnumberï¼‰ï¼Œè¯¥ä»»æœŸå·ä¼šéšç€æ—¶é—´<strong>å•è°ƒé€’å¢</strong>ã€‚èŠ‚ç‚¹ä¹‹é—´é€šä¿¡çš„æ—¶å€™ä¼šäº¤æ¢å½“å‰ä»»æœŸå·ï¼Œå¦‚æœä¸€ä¸ªèŠ‚ç‚¹çš„å½“å‰ä»»æœŸå·æ¯”å…¶ä»–èŠ‚ç‚¹å°ï¼Œé‚£ä¹ˆå®ƒå°±å°†è‡ªå·±çš„ä»»æœŸå·æ›´æ–°ä¸ºè¾ƒå¤§çš„é‚£ä¸ªå€¼ã€‚å¦‚æœä¸€ä¸ªcandidate æˆ–è€… leader å‘ç°è‡ªå·±çš„ä»»æœŸå·è¿‡æœŸäº†ï¼Œå®ƒå°±ä¼šç«‹åˆ»å›åˆ° followerçŠ¶æ€ã€‚å¦‚æœä¸€ä¸ªèŠ‚ç‚¹æ¥æ”¶äº†ä¸€ä¸ªå¸¦ç€è¿‡æœŸçš„ä»»æœŸå·çš„è¯·æ±‚ï¼Œé‚£ä¹ˆå®ƒä¼šæ‹’ç»è¿™æ¬¡è¯·æ±‚ã€‚</p><p>Raft ç®—æ³•ä¸­æœåŠ¡å™¨èŠ‚ç‚¹ä¹‹é—´é‡‡ç”¨ RPCè¿›è¡Œé€šä¿¡ï¼Œä¸€èˆ¬çš„å…±è¯†ç®—æ³•éƒ½åªéœ€è¦ä¸¤ç§ç±»å‹çš„ RPCã€‚</p><ul><li><strong>RequestVote RPCsï¼ˆè¯·æ±‚æŠ•ç¥¨ï¼‰</strong>ï¼šç”± candidateåœ¨é€‰ä¸¾è¿‡ç¨‹ä¸­å‘å‡ºï¼ˆ5.2 èŠ‚ä¸­æè¿°ï¼‰</li><li><strong>AppendEntries RPCsï¼ˆè¿½åŠ æ¡ç›®ï¼‰</strong>ï¼šç”± leaderå‘å‡ºï¼Œç”¨æ¥åšæ—¥å¿—å¤åˆ¶å’Œæä¾›å¿ƒè·³æœºåˆ¶ï¼ˆ5.3 èŠ‚ä¸­æè¿°ï¼‰ã€‚</li></ul><p>åœ¨ç¬¬ 7 èŠ‚ä¸­ä¸ºäº†åœ¨èŠ‚ç‚¹ä¹‹é—´ä¼ è¾“å¿«ç…§ï¼ˆsnapshotï¼‰å¢åŠ äº†ç¬¬ä¸‰ç§RPCã€‚å½“èŠ‚ç‚¹æ²¡æœ‰åŠæ—¶çš„æ”¶åˆ° RPCçš„å“åº”æ—¶ï¼Œä¼šè¿›è¡Œé‡è¯•ï¼Œè€Œä¸”èŠ‚ç‚¹ä¹‹é—´éƒ½æ˜¯ä»¥å¹¶è¡Œï¼ˆparallelï¼‰çš„æ–¹å¼å‘é€ RPCè¯·æ±‚ï¼Œä»¥æ­¤æ¥è·å¾—æœ€ä½³çš„æ€§èƒ½ã€‚</p><h3 id="leader-election">5.2 Leader election</h3><p>Raft é‡‡ç”¨ä¸€ç§å¿ƒè·³æœºåˆ¶æ¥è§¦å‘ leaderé€‰ä¸¾ã€‚å½“æœåŠ¡å™¨å¯åŠ¨çš„æ—¶å€™ï¼Œä»–ä»¬éƒ½ä¼šç§°ä¸º followerã€‚ä¸€ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹åªè¦ä»candidate æˆ–è€… leader é‚£æ¥æ”¶åˆ°æœ‰æ•ˆçš„ RPC å°±ä¸€ç›´ä¿æŒ followerçš„çŠ¶æ€ã€‚Leader ä¼šå‘¨æœŸæ€§åœ°å‘æ‰€æœ‰çš„ follower å‘èµ·å¿ƒè·³æ¥ç»´æŒè‡ªå·±çš„ leaderåœ°ä½ï¼Œæ‰€è°“å¿ƒè·³ï¼Œå°±æ˜¯ä¸åŒ…å«æ—¥å¿—æ¡ç›®çš„ AppendEntries RPCã€‚å¦‚æœä¸€ä¸ªfollower åœ¨ä¸€æ®µæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°ä»»ä½•ä¿¡æ¯ï¼ˆè¿™æ®µæ—¶é—´æˆ‘ä»¬ç§°ä¸º<strong>é€‰ä¸¾è¶…æ—¶election timeout</strong>ï¼‰ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šå‡å®šç›®å‰é›†ç¾¤ä¸­æ²¡æœ‰ä¸€ä¸ªå¯ç”¨çš„leaderï¼Œç„¶åå¼€å¯ä¸€æ¬¡é€‰ä¸¾æ¥é€‰æ‹©ä¸€ä¸ªæ–°çš„ leaderã€‚</p><p>å¼€å§‹è¿›è¡Œé€‰ä¸¾çš„æ—¶å€™ï¼Œä¸€ä¸ª follower ä¼šè‡ªå¢å½“å‰ä»»æœŸå·ç„¶ååˆ‡æ¢ä¸ºcandidate çŠ¶æ€ã€‚ç„¶åå®ƒä¼šç»™è‡ªå·±æŠ•ç¥¨ï¼ŒåŒæ—¶ä»¥å¹¶è¡Œçš„æ–¹å¼å‘é€ä¸€ä¸ª RequestVoteRPCs ç»™é›†ç¾¤ä¸­çš„å…¶ä»–æœåŠ¡å™¨èŠ‚ç‚¹ï¼ˆä¼å›¾å¾—åˆ°å®ƒä»¬çš„æŠ•ç¥¨ï¼‰ã€‚ä¸€ä¸ª candidateä¼šä¸€ç›´ä¿æŒå½“å‰çŠ¶æ€ç›´åˆ°ä»¥ä¸‹çš„ä¸‰ä»¶äº‹ä¹‹ä¸€å‘ç”Ÿï¼ˆè¿™äº›æƒ…å†µéƒ½ä¼šåœ¨ä¸‹é¢çš„ç« èŠ‚é‡Œåˆ†åˆ«è®¨è®ºï¼‰ï¼š</p><ul><li>å®ƒèµ¢å¾—é€‰ä¸¾ï¼Œæˆä¸ºäº† leader</li><li>å…¶ä»–èŠ‚ç‚¹èµ¢å¾—äº†é€‰æ‹©ï¼Œé‚£ä¹ˆå®ƒä¼šå˜æˆ follower</li><li>ä¸€æ®µæ—¶é—´ä¹‹åæ²¡æœ‰ä»»ä½•èŠ‚ç‚¹åœ¨é€‰ä¸¾ä¸­èƒœå‡º</li></ul><p>å½“ä¸€ä¸ª candidateè·å–é›†ç¾¤ä¸­è¿‡åŠæœåŠ¡å™¨èŠ‚ç‚¹é’ˆå¯¹åŒä¸€ä»»æœŸçš„æŠ•ç¥¨æ—¶ï¼Œå®ƒå°±èµ¢å¾—äº†è¿™æ¬¡é€‰ä¸¾å¹¶æˆä¸ºæ–°çš„leaderã€‚å¯¹äºåŒä¸€ä¸ªä»»æœŸï¼Œæ¯ä¸€ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹ä¼šæŒ‰ç…§<strong>å…ˆæ¥å…ˆæœåŠ¡åŸåˆ™ï¼ˆfirst-come-first-servedï¼‰</strong> åªæŠ•ç»™ä¸€ä¸ªcandidateï¼ˆåœ¨5.4èŠ‚ä¼šåœ¨æŠ•ç¥¨ä¸Šå¢åŠ é¢å¤–çš„é™åˆ¶ï¼‰ã€‚è¿™ç§è¦æ±‚è·å¾—è¿‡åŠæŠ•ç¥¨æ‰èƒ½æˆä¸º leaderçš„è§„åˆ™ç¡®ä¿äº†æœ€å¤šåªæœ‰ä¸€ä¸ª candidate èµ¢å¾—æ­¤æ¬¡é€‰ä¸¾ï¼ˆå›¾ 3ä¸­çš„é€‰ä¸¾å®‰å…¨æ€§ï¼‰ã€‚åªè¦æœ‰ä¸€ä¸ª candidate èµ¢å¾—é€‰ä¸¾ï¼Œå®ƒå°±ä¼šæˆä¸ºleaderã€‚ç„¶åå®ƒå°±ä¼šå‘é›†ç¾¤ä¸­å…¶ä»–èŠ‚ç‚¹å‘é€å¿ƒè·³æ¶ˆæ¯æ¥ç¡®å®šè‡ªå·±çš„åœ°ä½å¹¶é˜»æ­¢æ–°çš„é€‰ä¸¾ã€‚</p><p>ä¸€ä¸ª candidateåœ¨ç­‰å¾…å…¶ä»–èŠ‚ç‚¹ç»™å®ƒæŠ•ç¥¨çš„æ—¶å€™ï¼Œå®ƒä¹Ÿæœ‰å¯èƒ½æ¥æ”¶åˆ°å¦å¤–ä¸€ä¸ªè‡ªç§°ä¸º leaderçš„èŠ‚ç‚¹ç»™å®ƒå‘è¿‡æ¥çš„ AppendEntries RPCã€‚</p><ul><li>å¦‚æœè¿™ä¸ª leader çš„ä»»æœŸå·ï¼ˆè¿™ä¸ªä»»æœŸå·ä¼šåœ¨è¿™æ¬¡ RPCä¸­æºå¸¦ç€ï¼‰ä¸å°äºè¿™ä¸ª candidate çš„å½“å‰ä»»æœŸå·ï¼Œé‚£ä¹ˆè¿™ä¸ª candidateå°±ä¼šè§‰å¾—è¿™ä¸ª leader æ˜¯åˆæ³•çš„ï¼Œç„¶åå°†è‡ªå·±è½¬å˜ä¸º follower çŠ¶æ€ã€‚</li><li>å¦‚æœè¿™ä¸ª leader çš„ä»»æœŸå·å°äºè¿™ä¸ª candidate çš„å½“å‰ä»»æœŸå·ï¼Œé‚£ä¹ˆè¿™ä¸ªcandidate å°±ä¼šæ‹’ç»è¿™æ¬¡ RPCï¼Œç„¶åç»§ç»­ä¿æŒ candidate çŠ¶æ€ã€‚</li></ul><p>ç¬¬ä¸‰ç§å¯èƒ½çš„ç»“æœæ˜¯ candidateæ—¢æ²¡æœ‰èµ¢å¾—é€‰ä¸¾ä¹Ÿæ²¡æœ‰è¾“ã€‚å¯ä»¥è®¾æƒ³ä¸€ä¸‹è¿™ä¹ˆä¸€ä¸ªæƒ…å†µã€‚æ‰€æœ‰çš„ followeråŒæ—¶å˜æˆ candidateï¼Œç„¶åå®ƒä»¬éƒ½å°†ç¥¨æŠ•ç»™è‡ªå·±ï¼Œé‚£è¿™æ ·å°±æ²¡æœ‰ candidateèƒ½å¾—åˆ°è¶…è¿‡åŠæ•°çš„æŠ•ç¥¨äº†ï¼ŒæŠ•ç¥¨æ— æœã€‚å½“è¿™ç§æƒ…å†µå‘ç”Ÿçš„æ—¶å€™ï¼Œæ¯ä¸ª candidateéƒ½ä¼šè¿›è¡Œä¸€æ¬¡è¶…æ—¶å“åº”ï¼ˆtimeoutï¼‰ï¼Œç„¶åé€šè¿‡è‡ªå¢ä»»æœŸå·æ¥å¼€å¯ä¸€è½®æ–°çš„é€‰ä¸¾ï¼Œå¹¶å¯åŠ¨å¦ä¸€è½®çš„ RequestVoteRPCsã€‚ç„¶è€Œï¼Œå¦‚æœæ²¡æœ‰é¢å¤–çš„æªæ–½ï¼Œè¿™ç§æ— ç»“æœçš„æŠ•ç¥¨å¯èƒ½ä¼šæ— é™é‡å¤ä¸‹å»ã€‚</p><p>ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼ŒRaft é‡‡ç”¨ <strong>éšæœºé€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼ˆrandomizedelection timeoutsï¼‰</strong>æ¥ç¡®ä¿å¾ˆå°‘å‘ç”Ÿæ— æœçš„æŠ•ç¥¨ï¼Œå¹¶ä¸”å°±ç®—å‘ç”Ÿäº†ä¹Ÿèƒ½å¾ˆå¿«åœ°è§£å†³ã€‚<strong>ä¸ºäº†é˜²æ­¢é€‰ç¥¨ä¸€å¼€å§‹å°±è¢«ç“œåˆ†ï¼Œé€‰ä¸¾è¶…æ—¶æ—¶é—´æ˜¯ä»ä¸€ä¸ªå›ºå®šçš„åŒºé—´ï¼ˆæ¯”å¦‚ï¼Œ150-300msï¼‰ä¸­éšæœºé€‰æ‹©ã€‚è¿™æ ·å¯ä»¥æŠŠæœåŠ¡å™¨åˆ†æ•£å¼€æ¥ä»¥ç¡®ä¿åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ä¼šåªæœ‰ä¸€ä¸ªæœåŠ¡å™¨ç‡å…ˆç»“æŸè¶…æ—¶ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼Œå®ƒå°±å¯ä»¥èµ¢å¾—é€‰ä¸¾å¹¶åœ¨å…¶ä»–æœåŠ¡å™¨ç»“æŸè¶…æ—¶ä¹‹å‰å‘é€å¿ƒè·³</strong>ï¼ˆè¯‘è€…æ³¨ï¼šä¹˜è™šè€Œå…¥ï¼Œä¸è®²æ­¦å¾·ï¼‰ã€‚</p><p>åŒæ ·çš„æœºåˆ¶ä¹Ÿå¯ä»¥è¢«ç”¨æ¥è§£å†³é€‰ç¥¨è¢«ç“œåˆ†ï¼ˆsplit votesï¼‰çš„æƒ…å†µã€‚æ¯ä¸ªcandidateåœ¨å¼€å§‹ä¸€è½®é€‰ä¸¾ä¹‹å‰ä¼šé‡ç½®ä¸€ä¸ªéšæœºé€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼Œç„¶åä¸€ç›´ç­‰å¾…ç›´åˆ°ç»“æŸè¶…æ—¶çŠ¶æ€ã€‚è¿™æ ·å‡å°‘äº†åœ¨ä¸€æ¬¡æŠ•ç¥¨æ— æœåå†ä¸€æ¬¡æŠ•ç¥¨æ— æœçš„å¯èƒ½æ€§ã€‚9.3èŠ‚å±•ç¤ºäº†è¯¥æ–¹æ¡ˆèƒ½å¤Ÿå¿«é€Ÿåœ°é€‰å‡ºä¸€ä¸ª leaderã€‚</p><p>é€‰ä¸¾çš„ä¾‹å­å¯ä»¥å¾ˆå¥½åœ°å±•ç°å¯ç†è§£æ€§æ˜¯å¦‚ä½•æŒ‡å¯¼æˆ‘ä»¬åœ¨å¤šç§å¤‡é€‰è®¾è®¡æ–¹æ¡ˆä¸­åšå‡ºæŠ‰æ‹©çš„ã€‚åœ¨ä¸€å¼€å§‹ï¼Œæˆ‘ä»¬æœ¬æ‰“ç®—ä½¿ç”¨ä¸€ç§ç­‰çº§ç³»ç»Ÿï¼ˆranksystemï¼‰ï¼šæ¯ä¸€ä¸ª candidate è¢«èµ‹äºˆä¸€ä¸ªä¸€æ¬¡çš„ç­‰çº§ï¼ˆrankï¼‰ï¼Œå¦‚æœä¸€ä¸ªcandidate å‘ç°å¦å¤–ä¸€ä¸ª candidate æœ‰ç€æ›´é«˜çš„ç™»è®°ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šè¿”å› followerçŠ¶æ€ï¼Œè¿™æ ·å¯ä»¥ä½¿é«˜ç­‰çº§çš„ candidateæ›´åŠ å®¹æ˜“åœ°èµ¢å¾—ä¸‹ä¸€è½®é€‰ä¸¾ã€‚ä½†æ˜¯æˆ‘ä»¬å‘ç°è¿™ç§æ–¹æ³•åœ¨å¯ç”¨æ€§æ–¹é¢ä¼šæœ‰ä¸€äº›å°é—®é¢˜ï¼š<strong>å¦‚æœç­‰çº§è¾ƒé«˜çš„æœåŠ¡å™¨å´©æºƒäº†ï¼Œé‚£ä¹ˆç­‰çº§è¾ƒä½çš„æœåŠ¡å™¨å¯èƒ½éœ€è¦è¿›å…¥è¶…æ—¶çŠ¶æ€ï¼Œç„¶åé‡æ–°æˆä¸ºä¸€ä¸ªcandidateã€‚å¦‚æœè¿™ç§æ“ä½œå‡ºç°å¾—å¤ªå¿«ï¼Œé‚£ä¹ˆå®ƒå¯èƒ½ä¼šé‡å¯è¿›ç¨‹å»å¼€å¯ä¸€è½®æ–°çš„é€‰ä¸¾ã€‚</strong>ç»è¿‡æˆ‘ä»¬å¯¹è¯¥ç®—æ³•åšå‡ºäº†å¤šæ¬¡çš„è°ƒæ•´ï¼Œæˆ‘ä»¬æœ€ç»ˆè¿˜æ˜¯è®¤ä¸ºéšæœºé‡è¯•çš„æ–¹æ³•æ›´åŠ é€šä¿—æ˜“æ‡‚ã€‚</p><h3 id="log-replication">5.3 Log replication</h3><p>Leaderä¸€æ—¦è¢«é€‰ä¸¾å‡ºæ¥ï¼Œå®ƒå°±è¦å¼€å§‹ä¸ºå®¢æˆ·ç«¯çš„è¯·æ±‚æä¾›æœåŠ¡äº†ã€‚æ¯ä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚éƒ½åŒ…å«ä¸€æ¡å°†è¢«å¤åˆ¶çŠ¶æ€æœºæ‰§è¡Œçš„å‘½ä»¤ã€‚leaderä¼šä»¥ä¸€ä¸ªæ–°æ¡ç›®çš„æ–¹å¼å°†è¯¥å‘½ä»¤è¿½åŠ åˆ°è‡ªå·±çš„æ—¥å¿—ä¸­ï¼Œå¹¶ä¸”ä»¥åŒæ­¥çš„æ–¹å¼å‘é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹å‘èµ·AppendEntiresRPCsï¼Œè®©å®ƒä»¬å¤åˆ¶è¯¥æ¡ç›®ã€‚å½“æ¡ç›®è¢«å®‰å…¨åœ°å¤åˆ¶ï¼ˆä½•ä¸ºå®‰å…¨å¤åˆ¶ï¼Œåé¢ä¼šä»‹ç»ï¼‰ä¹‹åï¼Œleaderä¼šå°†è¯¥æ¡ç›®åº”ç”¨åˆ°è‡ªå·±çš„çŠ¶æ€æœºä¸­ï¼ŒçŠ¶æ€æœºæ‰§è¡Œè¯¥æŒ‡ä»¤ï¼Œç„¶åæŠŠæ‰§è¡Œçš„ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚å¦‚æœfollower å´©æºƒäº†æˆ–è€…è¿è¡Œç¼“æ…¢ï¼Œæˆ–è€…ç½‘ç»œä¸¢åŒ…ï¼Œleader ä¼šä¸æ–­åœ°é‡è¯•AppendEntiries RPCsï¼ˆå³ä½¿å·²ç»å¯¹å®¢æˆ·ç«¯ä½œå‡ºäº†å“åº”ï¼‰ç›´åˆ°æ‰€æœ‰çš„ followeréƒ½æˆåŠŸå­˜å‚¨äº†æ‰€æœ‰çš„æ—¥å¿—æ¡ç›®ã€‚</p><p>æ—¥å¿—ä»¥å›¾ 6 å±•ç¤ºçš„æ–¹å¼ç»„ç»‡ç€ã€‚æ¯æ¡æ—¥å¿—æ¡ç›®éƒ½å­˜å‚¨ç€ä¸€æ¡çŠ¶æ€æœºæŒ‡ä»¤å’Œleaderæ”¶åˆ°è¯¥æŒ‡å®šæ—¶çš„ä»»æœŸå·ã€‚æ—¥å¿—æ¡ç›®ä¸­çš„ä»»æœŸå·å¯ä»¥ç”¨æ¥æ£€æµ‹å¤šä¸ªæ—¥å¿—å‰¯æœ¬ä¹‹é—´æ˜¯å¦ä¸ä¸€è‡´ï¼Œä»¥æ­¤æ¥ä¿è¯å›¾3ä¸­çš„æŸäº›æ€§è´¨ã€‚æ¯ä¸ªæ—¥å¿—æ¡ç›®è¿˜æœ‰ä¸€ä¸ªæ•´æ•°ç´¢å¼•å€¼æ¥è¡¨æ˜å®ƒåœ¨æ—¥å¿—ä¸­çš„ä½ç½®ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/008i3skNly1gsasp7ss8gj32220ssjy9.jpg"alt="image-20210709165036190" /><figcaption aria-hidden="true">image-20210709165036190</figcaption></figure><p>é‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼Œ<strong>leaderä»€ä¹ˆæ—¶å€™ä¼šè§‰å¾—æŠŠæ—¥å¿—æ¡ç›®åº”ç”¨åˆ°çŠ¶æ€æœºæ˜¯å®‰å…¨çš„å‘¢ï¼Ÿ</strong>è¿™ç§æ—¥å¿—æ¡ç›®è¢«ç§°ä¸ºå·²æäº¤çš„æ—¥å¿—æ¡ç›®ã€‚Raftä¿è¯è¿™ç§å·²æäº¤çš„æ—¥å¿—æ¡ç›®éƒ½æ˜¯æŒä¹…åŒ–çš„å¹¶ä¸”æœ€ç»ˆéƒ½ä¼šè¢«æ‰€æœ‰å¯ç”¨çš„çŠ¶æ€æœºæ‰§è¡Œã€‚<strong>ä¸€æ—¦åˆ›å»ºè¯¥æ—¥å¿—æ¡ç›®çš„ leader å°†å®ƒå¤åˆ¶åˆ°è¿‡åŠçš„èŠ‚ç‚¹ä¸Šæ—¶ï¼ˆæ¯”å¦‚å›¾ 6ä¸­çš„æ¡ç›® 7ï¼‰ï¼Œè¯¥æ—¥å¿—æ¡ç›®å°±ä¼šè¢«æäº¤ã€‚</strong> åŒæ—¶ï¼Œleaderæ—¥å¿—ä¸­è¯¥æ—¥å¿—æ¡ç›®ä¹‹å‰çš„æ‰€æœ‰æ—¥å¿—æ¡ç›®ä¹Ÿéƒ½ä¼šè¢«æäº¤ï¼ŒåŒ…æ‹¬ç”±ä¹‹å‰çš„å…¶ä»– leaderåˆ›å»ºçš„æ—¥å¿—æ¡ç›®ã€‚5.4 èŠ‚ä¼šè®¨è®ºåœ¨ leaderå˜æ›´ä¹‹ååº”ç”¨è¯¥è§„åˆ™çš„ä¸€äº›ç»†èŠ‚ï¼Œå¹¶è¯æ˜è¿™ç§æäº¤çš„è§„åˆ™æ˜¯å®‰å…¨çš„ã€‚leaderä¼šè¿½è¸ªå®ƒæ‰€çŸ¥é“çš„è¦æäº¤çš„æœ€é«˜ç´¢å¼•ï¼Œå¹¶å°†è¯¥ç´¢å¼•åŒ…å«åœ¨æœªæ¥çš„ AppendEntriesRPC ä¸­ï¼ˆåŒ…æ‹¬å¿ƒè·³ï¼‰ï¼Œä»¥ä¾¿å…¶ä»–çš„èŠ‚ç‚¹å¯ä»¥å‘ç°è¿™ä¸ªç´¢å¼•ã€‚ä¸€æ—¦ä¸€ä¸ª followerçŸ¥é“äº†ä¸€ä¸ªæ—¥å¿—æ¡ç›®è¢«æäº¤äº†ã€‚å®ƒå°±ä¼šå°†è¯¥æ—¥å¿—æ¡ç›®æŒ‰æ—¥å¿—é¡ºåºåº”ç”¨åˆ°è‡ªå·±çš„çŠ¶æ€æœºä¸­ã€‚</p><p>æˆ‘ä»¬è®¾è®¡ Raftæ—¥å¿—æœºåˆ¶æ¥ä½¿å¾—ä¸åŒèŠ‚ç‚¹ä¸Šçš„æ—¥å¿—ä¹‹é—´å¯ä»¥ä¿æŒé«˜æ°´å¹³çš„ä¸€è‡´æ€§ã€‚è¿™ä¹ˆåšä¸ä»…ç®€åŒ–äº†ç³»ç»Ÿçš„è¡Œä¸ºä¹Ÿä½¿å¾—ç³»ç»Ÿæ›´åŠ å¯é¢„æµ‹ï¼ŒåŒæ—¶è¯¥æœºåˆ¶ä¹Ÿæ˜¯ä¿è¯å®‰å…¨æ€§çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚Raftä¼šä¸€ç›´ç»´æŠ¤ç€ä»¥ä¸‹çš„ç‰¹æ€§ï¼Œè¿™äº›ç‰¹æ€§ä¹ŸåŒæ—¶æ„æˆäº†å›¾ 3 ä¸­çš„æ—¥å¿—åŒ¹é…ç‰¹æ€§ï¼ˆLogMatching Propertyï¼‰ï¼š</p><ul><li>å¦‚æœä¸åŒæ—¥å¿—ä¸­çš„ä¸¤ä¸ªæ¡ç›®æœ‰ç€ç›¸åŒçš„ç´¢å¼•å’Œä»»æœŸå€¼ï¼Œé‚£ä¹ˆå®ƒä»¬å°±å­˜å‚¨ç€ç›¸åŒçš„å‘½ä»¤</li><li>å¦‚æœä¸åŒæ—¥å¿—ä¸­çš„ä¸¤ä¸ªæ¡ç›®æœ‰ç€ç›¸åŒçš„ç´¢å¼•å’Œä»»æœŸå€¼ï¼Œé‚£ä¹ˆä»–ä»¬ä¹‹å‰çš„æ‰€æœ‰æ—¥å¿—æ¡ç›®ä¹Ÿéƒ½ç›¸åŒ</li></ul><p>ç¬¬ä¸€æ¡ç‰¹æ€§æºäºè¿™æ ·ä¸€ä¸ªäº‹å®ï¼Œåœ¨ç»™å®šçš„ä¸€ä¸ªä»»æœŸå€¼å’Œç»™å®šçš„ä¸€ä¸ªæ—¥å¿—ç´¢å¼•ä¸­ï¼Œä¸€ä¸ªleaderæœ€å¤šåˆ›å»ºä¸€ä¸ªæ—¥å¿—æ¡ç›®ï¼Œè€Œä¸”æ—¥å¿—æ¡ç›®æ°¸è¿œä¸ä¼šæ”¹å˜å®ƒä»¬åœ¨æ—¥å¿—ä¸­çš„ä½ç½®ã€‚</p><p>ç¬¬äºŒæ¡ç‰¹æ€§æ˜¯ç”± AppendEntries RPCæ‰§è¡Œçš„ä¸€ä¸ªç®€å•çš„ä¸€è‡´æ€§æ£€æŸ¥æ‰€ä¿è¯çš„ã€‚å½“ leader å‘é€ä¸€ä¸ª AppendEntries RPCçš„æ—¶å€™ï¼Œleaderä¼šå°†å‰ä¸€ä¸ªæ—¥å¿—æ¡ç›®çš„ç´¢å¼•ä½ç½®å’Œä»»æœŸå·åŒ…å«åœ¨é‡Œé¢ï¼ˆç´§é‚»æœ€æ–°çš„æ—¥å¿—æ¡ç›®ï¼‰ã€‚å¦‚æœä¸€ä¸ªfolloweråœ¨å®ƒçš„æ—¥å¿—ä¸­æ‰¾ä¸åˆ°åŒ…å«ç›¸åŒç´¢å¼•ä½ç½®å’Œä»»æœŸå·çš„æ¡ç›®ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šæ‹’ç»è¯¥æ–°çš„æ—¥å¿—æ¡ç›®ã€‚ä¸€è‡´æ€§æ£€æŸ¥å°±åƒä¸€ä¸ªå½’çº³æ­¥éª¤ï¼šä¸€å¼€å§‹ç©ºçš„æ—¥å¿—çŠ¶æ€è‚¯å®šæ˜¯æ»¡è¶³æ—¥å¿—åŒ¹é…ç‰¹æ€§ï¼ˆLogMatchingPropertyï¼‰çš„ï¼Œç„¶åä¸€è‡´æ€§æ£€æŸ¥ä¿è¯äº†æ—¥å¿—æ‰©å±•æ—¶çš„æ—¥å¿—åŒ¹é…ç‰¹æ€§ã€‚å› æ­¤ï¼Œå½“AppendEntries RPC è¿”å›æˆåŠŸæ—¶ï¼Œleader å°±çŸ¥é“ followerçš„æ—¥å¿—ä¸€å®šå’Œè‡ªå·±ç›¸åŒï¼ˆä»ç¬¬ä¸€ä¸ªæ—¥å¿—æ¡ç›®åˆ°æœ€æ–°æ¡ç›®ï¼‰ã€‚</p><p>æ­£å¸¸æ“ä½œæœŸé—´ï¼Œleader å’Œ follower çš„æ—¥å¿—éƒ½æ˜¯ä¿æŒä¸€è‡´çš„ï¼Œæ‰€ä»¥AppendEntries çš„ä¸€è‡´æ€§æ£€æŸ¥ä»æ¥ä¸ä¼šå¤±è´¥ã€‚ä½†æ˜¯ï¼Œå¦‚æœ leaderå´©æºƒäº†ï¼Œé‚£ä¹ˆå°±æœ‰å¯èƒ½ä¼šé€ æˆæ—¥å¿—å¤„äºä¸ä¸€è‡´çš„çŠ¶æ€ï¼Œæ¯”å¦‚è¯´è€çš„ leaderå¯èƒ½è¿˜æ²¡æœ‰å®Œå…¨å¤åˆ¶å®ƒæ—¥å¿—ä¸­çš„æ‰€æœ‰æ¡ç›®å®ƒå°±å´©æºƒäº†ã€‚è¿™äº›ä¸ä¸€è‡´çš„æƒ…å†µä¼šåœ¨ä¸€ç³»åˆ—çš„leader å’Œ follower å´©æºƒçš„æƒ…å†µä¸‹åŠ å‰§ã€‚å›¾ 7 è§£é‡Šäº†ä»€ä¹ˆæƒ…å†µä¸‹ followerçš„æ—¥å¿—å¯èƒ½å’Œæ–°çš„ leader çš„æ—¥å¿—ä¸åŒã€‚follower å¯èƒ½ä¼šç¡®å®ä¸€äº›åœ¨æ–° leaderä¸­æœ‰çš„æ—¥å¿—æ¡ç›®ï¼Œä¹Ÿæœ‰å¯èƒ½æ‹¥æœ‰ä¸€äº›æ–°çš„ leaderæ²¡æœ‰çš„æ—¥å¿—æ¡ç›®ï¼Œæˆ–è€…åŒæ—¶å­˜åœ¨ã€‚ç¼ºå¤±æˆ–å¤šå‡ºæ—¥å¿—æ¡ç›®çš„æƒ…å†µæœ‰å¯èƒ½ä¼šæ¶‰åŠåˆ°å¤šä¸ªä»»æœŸã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/008i3skNly1gse5vxj5sfj31se0u017c.jpg"alt="image-20210712144330139" /><figcaption aria-hidden="true">image-20210712144330139</figcaption></figure><p>åœ¨ Raft ç®—æ³•ä¸­ï¼Œleader é€šè¿‡å¼ºåˆ¶ follower å¤åˆ¶ leaderæ—¥å¿—æ¥è§£å†³æ—¥å¿—ä¸ä¸€è‡´çš„é—®é¢˜ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œfollower ä¸­è·Ÿ leaderå†²çªçš„æ—¥å¿—æ¡ç›®ä¼šè¢« leader çš„æ—¥å¿—æ¡ç›®æ‰€è¦†ç›–ã€‚5.4èŠ‚ä¼šè¯æ˜é€šè¿‡å¢åŠ ä¸€ä¸ªé™åˆ¶ï¼Œè¿™ç§æ–¹å¼å°±å¯ä»¥ä¿è¯å®‰å…¨æ€§ã€‚</p><p>ä¸ºäº†ä½¿ follower çš„æ—¥å¿—è·Ÿè‡ªå·±ï¼ˆleaderï¼‰ä¸€è‡´ï¼Œleaderå¿…é¡»æ‰¾åˆ°ä¸¤è€…è¾¾æˆä¸€è‡´çš„æœ€å¤§çš„æ—¥å¿—æ¡ç›®ç´¢å¼•ï¼Œåˆ é™¤ followeræ—¥å¿—ä¸­ä»é‚£ä¸ªç´¢å¼•ä¹‹åçš„æ‰€æœ‰æ—¥å¿—æ¡ç›®ï¼Œå¹¶ä¸”å°†è‡ªå·±é‚£ä¸ªç´¢å¼•ä¹‹åçš„æ‰€æœ‰æ—¥å¿—æ¡ç›®å‘é€ç»™followerã€‚æ‰€æœ‰çš„è¿™äº›æ“ä½œéƒ½å‘ç”Ÿåœ¨ AppendEntries RPCsçš„ä¸€è‡´æ€§æ£€æŸ¥çš„å›å¤ä¸­ã€‚leader ç»´æŠ¤ç€ä¸€ä¸ªé’ˆå¯¹æ¯ä¸€ä¸ª follower çš„<strong>nextIndex</strong>ï¼Œè¿™ä¸ª nextIndex ä»£è¡¨çš„å°±æ˜¯ leader è¦å‘é€ç»™follower çš„ä¸‹ä¸€ä¸ªæ—¥å¿—æ¡ç›®çš„ç´¢å¼•ã€‚<strong>å½“é€‰å‡ºä¸€ä¸ªæ–°çš„ leader æ—¶ï¼Œè¯¥leader å°†æ‰€æœ‰çš„ nextIndex çš„å€¼éƒ½åˆå§‹åŒ–ä¸ºè‡ªå·±æœ€åä¸€ä¸ªæ—¥å¿—æ¡ç›®çš„ index åŠ 1ï¼ˆå›¾7 ä¸­çš„ 11ï¼‰</strong>ã€‚å¦‚æœä¸€ä¸ª follower çš„æ—¥å¿—è·Ÿ leaderçš„æ˜¯ä¸ä¸€è‡´çš„ï¼Œé‚£ä¹ˆä¸‹ä¸€æ¬¡çš„ AppendEntries RPCçš„ä¸€è‡´æ€§æ£€æŸ¥å°±ä¼šå¤±è´¥ã€‚<strong>AppendEntries RPC åœ¨è¢« followeræ‹’ç»ä¹‹åï¼Œleader å¯¹ nextIndex è¿›è¡Œå‡ 1ï¼Œç„¶åé‡è¯• AppendEntries RPCã€‚æœ€ç»ˆnextIndex ä¼šåœ¨æŸä¸ªä½ç½®æ»¡è¶³ leader å’Œ followeråœ¨è¯¥ä½ç½®åŠä¹‹å‰çš„æ—¥å¿—æ˜¯ä¸€è‡´çš„ï¼Œæ­¤æ—¶ï¼ŒAppendEntries RPC å°±ä¼šæˆåŠŸï¼Œå°†follower è·Ÿ leader å†²çªçš„æ—¥å¿—æ¡ç›®å…¨éƒ¨åˆ é™¤ç„¶åè¿½åŠ  leaderä¸­çš„æ—¥å¿—æ¡ç›®ï¼ˆéœ€è¦çš„è¯ï¼‰</strong>ã€‚ä¸€æ—¦ AppendEntries RPC æˆåŠŸï¼Œfollowerçš„æ—¥å¿—å°±å’Œ leader çš„ä¸€è‡´äº†ï¼Œå¹¶ä¸”åœ¨è¯¥ä»»æœŸæ¥ä¸‹æ¥çš„æ—¶é—´é‡Œéƒ½ä¿æŒä¸€è‡´ã€‚</p><blockquote><p>å¦‚æœéœ€è¦çš„è¯ï¼Œä¸‹é¢çš„åè®®å¯ä»¥ç”¨æ¥ä¼˜åŒ–è¢«æ‹’ç»çš„ AppendEntries RPCsçš„ä¸ªæ•°ã€‚</p><p>æ¯”å¦‚è¯´ï¼Œå½“æ‹’ç»ä¸€ä¸ª AppendEntries RPC çš„æ—¶å€™ï¼Œfollowerå¯ä»¥åŒ…å«å†²çªæ¡ç›®çš„ä»»æœŸå·å’Œè‡ªå·±å­˜å‚¨çš„é‚£ä¸ªä»»æœŸçš„ç¬¬ä¸€ä¸ªindexã€‚å€ŸåŠ©è¿™äº›ä¿¡æ¯ï¼Œleader å¯ä»¥è·³è¿‡é‚£ä¸ªä»»æœŸå†…æ‰€æœ‰çš„æ—¥å¿—æ¡ç›®æ¥å‡å°‘indexIndexã€‚è¿™æ ·å°±å˜æˆäº†æ¯ä¸ªæœ‰å†²çªæ—¥å¿—æ¡ç›®çš„ä»»æœŸåªéœ€è¦ä¸€ä¸ª AppendEntriesRPCï¼Œè€Œä¸æ˜¯æ¯ä¸€ä¸ªæ—¥å¿—æ¡ç›®éƒ½éœ€è¦ä¸€æ¬¡ AppendEntires RPCã€‚</p><p>åœ¨å®è·µä¸­ï¼Œæˆ‘ä»¬è®¤ä¸ºè¿™ç§ä¼˜åŒ–æ˜¯æ²¡æœ‰å¿…è¦çš„ï¼Œå› ä¸ºå¤±è´¥ä¸ç»å¸¸å‘ç”Ÿå¹¶ä¸”ä¹Ÿä¸å¯èƒ½æœ‰å¾ˆå¤šä¸ä¸€è‡´çš„æ—¥å¿—æ¡ç›®ã€‚</p></blockquote><p>é€šè¿‡ä¸Šè¿°æœºåˆ¶ï¼Œleaderåœ¨å½“æƒä¹‹åå°±ä¸éœ€è¦ä»»ä½•ç‰¹æ®Šçš„æ“ä½œæ¥ä½¿æ—¥å¿—æ¢å¤åˆ°ä¸€è‡´çŠ¶æ€ã€‚leaderåªéœ€è¿›è¡Œæ­£å¸¸çš„æ“ä½œï¼Œç„¶åæ—¥å¿—å°±èƒ½åœ¨å›å¤ AppendEntries RPCä¸€è‡´æ€§æ£€æŸ¥çš„æ—¶å€™è‡ªåŠ¨è¶‹äºä¸€è‡´ã€‚leaderä»æ¥ä¸ä¼šé‡å†™æˆ–è€…åˆ é™¤è‡ªå·±çš„æ—¥å¿—æ¡ç›®ï¼ˆå›¾3 ä¸­çš„ Leader Append-Onlyå±æ€§ï¼‰ã€‚</p><p>ä¸Šè¿°è¿™ç§æ—¥å¿—å¤åˆ¶æœºåˆ¶å±•ç°äº†ç¬¬ 2 èŠ‚ä¸­æè¿°çš„ Raftç®—æ³•çš„å…±è¯†ç‰¹æ€§ï¼šåªè¦è¿‡åŠçš„èŠ‚ç‚¹èƒ½æ­£å¸¸è¿è¡Œï¼ŒRaftå°±èƒ½æ¥å—ã€å¤åˆ¶å¹¶å¤„ç†æ–°çš„æ—¥å¿—æ¡ç›®ã€‚åœ¨é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªæ–°çš„æ¡ç›®å¯ä»¥åœ¨ä¸€è½®RPC ä¸­è¢«å¤åˆ¶ç»™é›†ç¾¤ä¸­è¿‡åŠçš„èŠ‚ç‚¹ï¼Œå¹¶ä¸”å•ä¸ªè¿è¡Œç¼“æ…¢çš„ followerå¹¶ä¸ä¼šå½±å“æ•´ä¸ªé›†ç¾¤çš„æ€§èƒ½ã€‚</p><blockquote><p>è¯‘è€…æ³¨ï¼š<strong>æ€»ç»“</strong></p><p>Leader æ”¶åˆ° Client çš„å†™è¯·æ±‚ï¼Œå‘æ‰€æœ‰ Followerå‘èµ·ä¸€ä¸ªæ—¥å¿—åŒæ­¥è¯·æ±‚ï¼Œå¾—åˆ°é›†ç¾¤å†…è¿‡åŠèŠ‚ç‚¹ï¼ˆåŒ…æ‹¬ Leaderè‡ªå·±ï¼‰çš„å“åº”ï¼Œå°±æ¨è¿› commitIndexï¼Œç„¶å apply æ—¥å¿—åˆ°çŠ¶æ€æœºï¼Œå†æ¨è¿›applyIndexï¼Œè¿”å› Client æˆåŠŸã€‚</p><p>çŠ¶æ€æœºåŒæ­¥åˆ†ä¸ºä¸¤è½® RPC å¹¿æ’­ï¼š</p><ul><li>ç¬¬ä¸€è½®ï¼šåŒæ­¥æ—¥å¿— AppendEntriesï¼Œå¾—åˆ°è¿‡åŠèŠ‚ç‚¹å›å¤ï¼ŒLeaderçŠ¶æ€æœºæ¨è¿›ï¼Œè¿”å› Client æˆåŠŸã€‚</li><li>ç¬¬äºŒè½®ï¼šåœ¨ä¸‹ä¸€æ¬¡çš„ AppendEntries ä¸­é™„å¸¦ä¸Šä¸€æ¬¡çš„commitIndexï¼ŒFollower æ”¶åˆ°åï¼Œapply æ—¥å¿—æ¡ç›®åˆ°å„è‡ªçš„çŠ¶æ€æœºã€‚</li></ul></blockquote><h3 id="safety">5.4 Safety</h3><p>å‰é¢çš„ç« èŠ‚æè¿°äº† Raft å¦‚ä½•åš Leader Election å’Œ LogReplicationã€‚ç„¶è€Œï¼Œåˆ°ç›®å‰ä¸ºæ­¢æ‰€è®¨è®ºçš„æœºåˆ¶å¹¶ä¸èƒ½å……åˆ†åœ°ä¿è¯æ¯ä¸€ä¸ªçŠ¶æ€æœºä¼šæŒ‰ç›¸åŒçš„é¡ºåºæ‰§è¡Œç›¸åŒçš„æŒ‡ä»¤ã€‚æ¯”å¦‚è¯´ï¼Œä¸€ä¸ªfollower å¯èƒ½ä¼šè¿›å…¥ä¸å¯ç”¨çŠ¶æ€ï¼Œåœ¨æ­¤æœŸé—´ï¼Œleaderå¯èƒ½æäº¤äº†è‹¥å¹²çš„æ—¥å¿—æ¡ç›®ï¼Œç„¶åè¿™ä¸ª follower å¯èƒ½è¢«é€‰ä¸¾ä¸ºæ–°çš„ leaderå¹¶ä¸”ç”¨æ–°çš„æ—¥å¿—æ¡ç›®å»è¦†ç›–è¿™äº›æ—¥å¿—æ¡ç›®ã€‚è¿™æ ·å°±ä¼šé€ æˆä¸åŒçš„çŠ¶æ€æœºæ‰§è¡Œä¸åŒçš„æŒ‡ä»¤çš„æƒ…å†µã€‚</p><p>æœ¬èŠ‚é€šè¿‡å¯¹ Leader Election å¢åŠ ä¸€ä¸ªé™åˆ¶æ¥å®Œå–„ Raftç®—æ³•ã€‚è¿™ä¸ªé™åˆ¶ä¿è¯äº†å¯¹äºç»™å®šçš„ä»»æ„ä»»æœŸå·ï¼Œè¯¥ä»»æœŸå·å¯¹åº”çš„ leaderéƒ½åŒ…å«äº†ä¹‹å‰å„ä¸ªä»»æœŸæ‰€æœ‰è¢«æäº¤çš„æ—¥å¿—æ¡ç›®ï¼ˆå›¾3 ä¸­çš„ Leader Completenessæ€§è´¨ï¼‰ã€‚æœ‰äº†è¿™ä¸ªé™åˆ¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿æ—¥å¿—æäº¤è§„åˆ™æ›´åŠ æ¸…æ™°ã€‚æœ€åï¼Œæˆ‘ä»¬ä¼šå±•ç¤ºå¯¹äºLeader Completenessæ€§è´¨çš„ç®€è¦è¯æ˜å¹¶ä¸”è¯´è¯¥æ€§è´¨æ˜¯å¦‚ä½•ä¿è¯çŠ¶æ€æœºæ‰§è¡Œæ­£ç¡®çš„è¡Œä¸ºçš„ã€‚</p><h4 id="é€‰ä¸¾é™åˆ¶">5.4.1 é€‰ä¸¾é™åˆ¶</h4><p>åœ¨ä»»ä½•åŸºäº leader çš„å…±è¯†ç®—æ³•ä¸­ï¼Œleaderæœ€ç»ˆéƒ½å¿…é¡»å­˜å‚¨æ‰€æœ‰å·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®ã€‚åœ¨æŸäº›å…±è¯†ç®—æ³•ä¸­ï¼Œä¾‹å¦‚ ViewstampedReplication[22]ï¼Œå³ä½¿ä¸€ä¸ªèŠ‚ç‚¹å®ƒä¸€å¼€å§‹å¹¶æ²¡æœ‰åŒ…å«æ‰€æœ‰å·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®ï¼Œå®ƒä¹Ÿæœ‰å¯èƒ½è¢«é€‰ä¸¾ä¸ºleaderã€‚è¿™äº›ç®—æ³•åŒ…å«ä¸€äº›é¢å¤–çš„æœºåˆ¶æ¥è¯†åˆ«ä¸¢å¤±çš„æ—¥å¿—æ¡ç›®å¹¶å°†å®ƒä»¬ä¼ é€ç»™æ–°çš„leaderï¼Œè¿™ä¸ªæœºåˆ¶è¦ä¹ˆå‘ç”Ÿåœ¨é€‰ä¸¾é˜¶æ®µï¼Œè¦ä¹ˆåœ¨é€‰ä¸¾å®Œæˆä¹‹åå¾ˆå¿«è¿›è¡Œã€‚æ¯”è¾ƒé—æ†¾çš„æ˜¯ï¼Œè¿™ç§æ–¹æ³•ä¼šå¢åŠ è®¸å¤šé¢å¤–çš„æœºåˆ¶ï¼Œä½¿å¾—ç®—æ³•å¤æ‚æ€§å¤§å¤§å¢åŠ ã€‚Raftä½¿ç”¨äº†ä¸€ç§æ›´åŠ ç®€å•çš„æ–¹æ³•ï¼Œå®ƒå¯ä»¥ä¿è¯æ–° leaderåœ¨å½“é€‰æ—¶å°±åŒ…å«äº†ä¹‹å‰æ‰€æœ‰ä»»æœŸä¸­å·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®ï¼Œæ ¹æœ¬å°±ä¸éœ€è¦å†ä¼ é€è¿™äº›æ—¥å¿—æ¡ç›®ç»™æ–°çš„leaderã€‚è¿™å°±æ„å‘³ç€<strong>æ—¥å¿—æ¡ç›®çš„ä¼ é€åªæœ‰ä¸€ä¸ªæ–¹å‘ï¼Œé‚£å°±æ˜¯ä» leader åˆ°followerï¼Œleader ä»æ¥ä¸ä¼šè¦†ç›–æœ¬åœ°æ—¥å¿—ä¸­å·²æœ‰çš„æ—¥å¿—ã€‚</strong></p><p>Raft é‡‡ç”¨æŠ•ç¥¨çš„æ–¹å¼æ¥ä¿è¯ä¸€ä¸ª candidateåªæœ‰æ‹¥æœ‰ä¹‹å‰æ‰€æœ‰ä»»æœŸä¸­å·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®ä¹‹åï¼Œæ‰æœ‰å¯èƒ½èµ¢å¾—é€‰ä¸¾ã€‚ä¸€ä¸ªcandidate å¦‚æœæƒ³è¦è¢«é€‰ä¸ºleaderï¼Œé‚£å®ƒå°±å¿…é¡»è·Ÿé›†ç¾¤ä¸­è¶…è¿‡åŠæ•°çš„èŠ‚ç‚¹è¿›è¡Œé€šä¿¡ï¼Œè¿™å°±æ„å‘³è¿™äº›èŠ‚ç‚¹ä¸­è‡³å°‘ä¸€ä¸ªåŒ…å«äº†æ‰€æœ‰å·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®ã€‚å¦‚æœcandidateçš„æ—¥å¿—è‡³å°‘è·Ÿè¿‡åŠçš„æœåŠ¡å™¨èŠ‚ç‚¹ä¸€æ ·æ–°ï¼Œé‚£ä¹ˆå®ƒå°±ä¸€å®šåŒ…å«äº†æ‰€æœ‰ä»¥åŠæäº¤çš„æ—¥å¿—æ¡ç›®ï¼Œä¸€æ—¦æœ‰æŠ•ç¥¨è€…è‡ªå·±çš„æ—¥å¿—æ¯”candidate çš„è¿˜æ–°ï¼Œé‚£ä¹ˆè¿™ä¸ªæŠ•ç¥¨è€…å°±ä¼šæ‹’ç»è¯¥æŠ•ç¥¨ï¼Œè¯¥ candidateä¹Ÿå°±ä¸ä¼šèµ¢å¾—é€‰ä¸¾ã€‚</p><blockquote><p>æ‰€è°“ â€œ<strong>æ–°</strong>â€ ï¼š</p><p>Rafté€šè¿‡æ¯”è¾ƒä¸¤ä»½æ—¥å¿—ä¸­çš„æœ€åä¸€æ¡æ—¥å¿—æ¡ç›®çš„ç´¢å¼•å’Œä»»æœŸå·æ¥å®šä¹‰è°çš„æ—¥å¿—æ›´æ–°ã€‚</p><ul><li>å¦‚æœä¸¤ä»½æ—¥å¿—æœ€åæ¡ç›®çš„ä»»æœŸå·ä¸åŒï¼Œé‚£ä¹ˆä»»æœŸå·å¤§çš„æ—¥å¿—æ›´æ–°</li><li>å¦‚æœä¸¤ä»½æ—¥å¿—æœ€åæ¡ç›®çš„ä»»æœŸå·ç›¸åŒï¼Œé‚£ä¹ˆè°çš„æ—¥å¿—æ›´é•¿ï¼Œè°å°±æ›´æ–°</li></ul></blockquote><h4 id="æäº¤ä¹‹å‰ä»»æœŸå†…çš„æ—¥å¿—æ¡ç›®">5.4.2 æäº¤ä¹‹å‰ä»»æœŸå†…çš„æ—¥å¿—æ¡ç›®</h4><blockquote><p>è¯‘è€…æ³¨ï¼šæ³¨æ„ï¼è¿™ä¸€èŠ‚ã€Œæäº¤ä¹‹å‰ä»»æœŸå†…çš„æ—¥å¿—æ¡ç›®ã€è¿™ç§æ“ä½œ Raftçš„ä¸å…è®¸çš„ï¼æœ¬å°èŠ‚åªæ˜¯ç”¨æ¥ä¸¾ä¸€ç§é”™è¯¯æƒ…å†µï¼</p></blockquote><p>å¦‚ 5.3èŠ‚ä¸­æåˆ°çš„é‚£æ ·ï¼Œä¸€æ—¦å½“å‰ä»»æœŸå†…çš„æŸä¸ªæ—¥å¿—æ¡ç›®ä»¥åŠå­˜å‚¨åˆ°è¿‡åŠçš„æœåŠ¡å™¨èŠ‚ç‚¹ä¸Šï¼Œleaderå°±çŸ¥é“è¯¥æ—¥å¿—å¯ä»¥è¢«æäº¤äº†ã€‚å¦‚æœè¿™ä¸ª leaderåœ¨æäº¤æŸä¸ªæ—¥å¿—æ¡ç›®ä¹‹å‰å´©æºƒäº†ï¼Œä»¥åçš„ leaderä¼šå°è¯•å®Œæˆè¯¥æ—¥å¿—æ¡ç›®çš„å¤åˆ¶ã€‚ç„¶è€Œï¼Œå¦‚æœæ˜¯ä¹‹å‰ä»»æœŸå†…çš„æŸä¸ªæ—¥å¿—æ¡ç›®å·²ç»å­˜å‚¨åˆ°äº†è¿‡åŠçš„æœåŠ¡å™¨èŠ‚ç‚¹ä¸Šäº†ï¼Œæ–°ä»»æœŸå†…çš„leader ä¹Ÿæ— æ³•ç«‹å³æ–­å®šè¯¥æ—¥å¿—æ¡ç›®å·²ç»è¢«æäº¤äº†ã€‚å›¾ 8å±•ç¤ºäº†ä¸€ç§æƒ…å†µï¼šä¸€ä¸ªå·²ç»è¢«å­˜å‚¨åˆ°è¿‡åŠèŠ‚ç‚¹çš„è€æ—¥å¿—æ¡ç›®ï¼Œä»ç„¶æœ‰å¯èƒ½ä¼šè¢«æœªæ¥çš„leader è¦†ç›–æ‰ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/008i3skNly1gse88t4iicj31wc0u0ts1.jpg"alt="image-20210712160506841" /><figcaption aria-hidden="true">image-20210712160506841</figcaption></figure><blockquote><p>è¯‘è€…æ³¨ï¼š<strong>å¯¹å›¾ 8 çš„ç†è§£çš„è¡¥å……</strong>ã€‚</p><p><font color="orange">å‚è€ƒï¼š</font></p><ul><li><a href="https://zhuanlan.zhihu.com/p/369989974">çŸ¥ä¹</a></li></ul><p><font color="orange">æ ¸å¿ƒï¼š</font></p><ul><li><strong>å›¾ 8 ç”¨æ¥è¯´æ˜ä¸ºä»€ä¹ˆ leaderä¸èƒ½æäº¤ä¹‹å‰ä»»æœŸçš„æ—¥å¿—ï¼Œåªèƒ½é€šè¿‡æäº¤è‡ªå·±ä»»æœŸçš„æ—¥å¿—ï¼Œä»è€Œé—´æ¥æäº¤ä¹‹å‰ä»»æœŸçš„æ—¥å¿—ã€‚</strong></li></ul><p><font color="orange">åˆ†æï¼š</font></p><ol type="1"><li>å…ˆæŒ‰é”™è¯¯çš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯ leader æäº¤ä¹‹å‰ä»»æœŸçš„æ—¥å¿—ï¼Œé‚£ä¹ˆä¸Šè¿°çš„æµç¨‹ï¼š<ol type="1"><li><ol type="a"><li>S1 æ˜¯ä»»æœŸ 2 çš„ leaderï¼Œæ—¥å¿—å·²ç»å¤åˆ¶ç»™äº† S2ï¼Œæ­¤æ—¶è¿˜æ²¡è¿‡åŠï¼›</li></ol></li><li><ol start="2" type="a"><li>S1 å´©æºƒï¼ŒS5 è·å¾—äº† S3ã€S4ã€S5 çš„æŠ•ç¥¨æˆä¸ºleaderï¼Œç„¶åå†™äº†ä¸€ä¸ªæ—¥å¿—æ¡ç›®ï¼ˆindex=2ï¼Œterm=3ï¼‰ï¼›</li></ol></li><li><ol start="3" type="a"><li>S5 åˆšå†™å®Œæ—¥å¿—ï¼Œè¿˜æ²¡æ¥å¾—åŠå¤åˆ¶ï¼Œå°±å´©æºƒäº†ï¼Œæ­¤æ—¶ S1 å’Œ S2éƒ½å¯èƒ½å½“é€‰ï¼ŒåŠ å…¥ S1 å½“é€‰ï¼ˆcurrentTerm=4ï¼‰ï¼Œæ­¤åˆ»è¿˜æ²¡æœ‰æ–°çš„è¯·æ±‚è¿›æ¥ï¼ŒS1å°†æ—¥å¿—æ¡ç›®ï¼ˆindex=2ï¼Œterm=2ï¼‰å¤åˆ¶ç»™äº† S3ï¼Œå¤šæ•°æ´¾è¾¾æˆï¼ŒS1æäº¤äº†è¿™ä¸ªæ—¥å¿—æ¡ç›®ï¼ˆindex=2ï¼Œterm=2ï¼‰ï¼Œ<strong>æ³¨æ„ï¼Œè¯¥æ—¥å¿—ä¸æ˜¯å½“å‰ä»»æœŸå†…çš„æ—¥å¿—ï¼Œæˆ‘ä»¬åœ¨è®¨è®ºé”™è¯¯çš„æƒ…å†µï¼</strong>ç„¶åè¯·æ±‚è¿›æ¥ï¼ŒS1 å†™æ—¥å¿—æ¡ç›®ï¼ˆindex=3ï¼Œterm=4ï¼‰ï¼Œç„¶å S1 å´©æºƒã€‚</li></ol></li><li>æƒ…å†µä¸€ï¼š(d) S5 é‡å¯ï¼Œå› ä¸º S5 æœ€åçš„æ—¥å¿—æ¡ç›®çš„ä»»æœŸå·æ¯” S2ã€S3å¤§ï¼Œæ‰€ä»¥ S5 å¯ä»¥èµ¢å¾—é€‰ä¸¾ï¼ˆcurrentTerm=5ï¼‰ï¼ŒS5å°†æ—¥å¿—æ¡ç›®ï¼ˆindex=2ï¼Œitem=3ï¼‰å¤åˆ¶ç»™å…¶ä»–æ‰€æœ‰èŠ‚ç‚¹å¹¶æäº¤ï¼Œ <strong>æ­¤æ—¶index=2 çš„æ—¥å¿—æ¡ç›®è¢«æäº¤äº†ä¸¤æ¬¡ï¼ä¸€æ¬¡term=2ï¼Œä¸€æ¬¡term=3ï¼Œè¿™æ˜¯ä¸è¢«å…è®¸çš„ï¼Œå› ä¸ºå·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®æ˜¯ä¸èƒ½è¢«è¦†ç›–çš„ï¼</strong>âœ–ï¸</li><li>æƒ…å†µäºŒï¼š(e) S1åœ¨å´©æºƒä¹‹å‰å°†è‡ªå·±çš„æ—¥å¿—æ¡ç›®ï¼ˆindex=3ï¼Œterm=4ï¼‰å¤åˆ¶åˆ°äº†è¿‡åŠèŠ‚ç‚¹ä¸Šï¼Œè¿™ç§æƒ…å†µä¸‹ï¼ŒS5ä¸å¯èƒ½é€‰ä¸¾æˆåŠŸã€‚è¿™æ˜¯ S1 ä¸å‘ç”Ÿæ•…éšœï¼Œè¿™æ˜¯æ­£ç¡®å¤åˆ¶çš„æƒ…å†µã€‚âœ”ï¸</li></ol></li></ol><p>æ‰€ä»¥ <strong>ã€Œleader å¯ä»¥æäº¤ä¹‹å‰ä»»æœŸçš„æ—¥å¿—ã€</strong>è¿™ç§æ“ä½œæ˜¯ä¸å…è®¸çš„ï¼Œæˆ‘ä»¬éœ€è¦åŠ ä¸Šçº¦æŸï¼š <strong>ã€Œleaderåªèƒ½æäº¤è‡ªå·±ä»»æœŸçš„æ—¥å¿—ã€</strong> ã€‚</p><ol start="2" type="1"><li><p>åŠ äº†çº¦æŸä¹‹åï¼Œå‰é¢çš„ (a) å’Œ (b) æ²¡æœ‰æ”¹å˜ï¼Œä» (c) å¼€å§‹ï¼š</p><ol type="1"><li><ol start="3" type="a"><li>S1 è¿˜æ˜¯å°†æ—¥å¿—æ¡ç›®ï¼ˆindex=2ï¼Œterm=2ï¼‰å¤åˆ¶ç»™å…¶ä»–èŠ‚ç‚¹ï¼Œå®ƒå¤åˆ¶ç»™äº†S3ï¼Œæ­¤æ—¶å·²ç»å¤åˆ¶ç»™äº†è¿‡åŠçš„èŠ‚ç‚¹äº†ï¼Œä½†æ˜¯<strong>ç”±äº currentTerm=4ï¼Œæ‰€ä»¥S1 è¿˜æ˜¯ä¸èƒ½æäº¤è¯¥æ—¥å¿—æ¡ç›®</strong>ã€‚å¦‚æœ S1å°†æ—¥å¿—æ¡ç›®ï¼ˆindex=3ï¼Œterm=4ï¼‰ä¹Ÿå¤åˆ¶ç»™äº†è¿‡åŠçš„èŠ‚ç‚¹ï¼ŒS1æ˜¯å¯ä»¥æäº¤è¯¥æ—¥å¿—æ¡ç›®çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼Œå‰é¢çš„æ—¥å¿—æ¡ç›®ï¼ˆindex=2ï¼Œterm=2ï¼‰ä¹Ÿä¼šè¢«é—´æ¥æäº¤ï¼Œè¿™å°±æ˜¯(e) æ‰€å±•ç¤ºçš„æƒ…å†µã€‚</li></ol></li><li><ol start="4" type="a"><li>S1 è¿˜æ˜¯å°†æ—¥å¿—æ¡ç›®ï¼ˆindex=2ï¼Œterm=2ï¼‰å¤åˆ¶ç»™å…¶ä»–èŠ‚ç‚¹ï¼Œå®ƒå¤åˆ¶ç»™äº†S3ï¼Œæ­¤æ—¶å·²ç»å¤åˆ¶ç»™äº†è¿‡åŠçš„èŠ‚ç‚¹äº†ï¼Œä½†æ˜¯<strong>ç”±äº currentTerm=4ï¼Œæ‰€ä»¥S1 è¿˜æ˜¯ä¸èƒ½æäº¤è¯¥æ—¥å¿—æ¡ç›®</strong>ã€‚ä½†æ˜¯è¿™ä¸ªæ—¶å€™ï¼ŒS1åªæ˜¯æ—¥å¿—æ¡ç›®ï¼ˆindex=3ï¼Œterm=4ï¼‰å†™å…¥è‡ªå·±çš„æ—¥å¿—ï¼Œè¿˜æ²¡æ¥å¾—åŠå¤åˆ¶å°±å´©æºƒäº†ã€‚ç„¶åS5é‡å¯å¹¶èµ¢å¾—äº†é€‰ä¸¾ï¼ˆcurrentTerm=5ï¼‰ï¼Œç„¶åå°†æ—¥å¿—æ¡ç›®ï¼ˆindex=2ï¼Œterm=3ï¼‰å¤åˆ¶ç»™å…¶ä»–æ‰€æœ‰èŠ‚ç‚¹ï¼Œç°åœ¨index=2 çš„æ—¥å¿—æ¡ç›®æ˜¯æ²¡æœ‰æäº¤è¿‡çš„ï¼ŒS5 èƒ½æäº¤è¯¥æ—¥å¿—å—ï¼Ÿ</li></ol><strong>ä¸èƒ½ï¼å› ä¸º leaderä¸èƒ½æäº¤ä¹‹å‰ä»»æœŸçš„æ—¥å¿—ï¼åªæœ‰ç­‰æ–°çš„è¯·æ±‚è¿›æ¥ï¼Œè¶…è¿‡åŠæ•°èŠ‚ç‚¹å¤åˆ¶äº† 1-3-5ä¹‹åï¼Œterm=3 çš„æ—¥å¿—æ‰èƒ½è·Ÿç€ term=5 çš„æ—¥å¿—ä¸€èµ·è¢«æäº¤ã€‚</strong></li></ol></li></ol><p><font color="orange">å»¶ä¼¸ï¼š</font></p><p>åŠ äº†ä¸Šè¿°çº¦æŸåï¼Œå°±ä¸ä¼šå‡ºç°åŒä¸€ä¸ª indexä¸Šçš„æ—¥å¿—æ¡ç›®è¢«é‡å¤æäº¤çš„æƒ…å†µäº†ï¼Œä½†æ˜¯è¿™åˆå¤šå‡ºäº†å¦å¤–ä¸€ä¸ªé—®é¢˜äº†ï¼š<strong>å¦‚æœä¸€ç›´æ²¡æœ‰æ–°çš„è¯·æ±‚è¿›æ¥ï¼Œé‚£ä¹ˆæ—¥å¿—æ¡ç›®ï¼ˆindex=2ï¼Œterm=3ï¼‰å²‚ä¸æ˜¯å°±ä¸€ç›´ä¸èƒ½æäº¤ï¼Ÿé‚£ä¸å°±é˜»å¡äº†å—ï¼Ÿ</strong></p><p>è¿™é‡Œå¦‚æœæ˜¯ kv æ•°æ®åº“ï¼Œé—®é¢˜å°±å¾ˆæ˜æ˜¾äº†ã€‚å‡è®¾ (c) æˆ– (d)ä¸­çš„æ—¥å¿—æ¡ç›®ï¼ˆindex=2ï¼‰é‡Œçš„ Command æ˜¯ <code>Set("k", "1")</code>ï¼ŒS5å½“é€‰ leader åï¼Œå®¢æˆ·ç«¯æ¥æŸ¥è¯¢ <code>Get("k")</code>ï¼ŒleaderæŸ¥åˆ°æ—¥å¿—æœ‰è®°å½•ä½†åˆä¸èƒ½å›å¤ 1ç»™å®¢æˆ·ç«¯ï¼ˆå› ä¸ºæŒ‰ç…§çº¦æŸè¿™æ¡æ—¥å¿—æœªæäº¤ï¼‰ï¼Œçº¿æ€§ä¸€è‡´æ€§è¦æ±‚ä¸èƒ½è¿”å›é™ˆæ—§çš„æ•°æ®ï¼Œleaderè¿«åˆ‡åœ°éœ€è¦çŸ¥é“è¿™æ¡æ—¥å¿—åˆ°åº•èƒ½ä¸èƒ½æäº¤ã€‚</p><p>æ‰€ä»¥ Raft è®ºæ–‡æé«˜äº†å¼•å…¥ <strong>no-opæ—¥å¿—</strong>æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¿™ä¸ªåœ¨ etcd ä¸­æœ‰å®ç°ã€‚</p><p><font color="orange">no-op æ—¥å¿—ï¼š</font></p><p>no-op æ—¥å¿—å³åªæœ‰ index å’Œ term ä¿¡æ¯ï¼Œcommandä¿¡æ¯ä¸ºç©ºã€‚ä¹Ÿæ˜¯è¦å†™åˆ°ç£ç›˜å­˜å‚¨çš„ã€‚</p><p>å…·ä½“æµç¨‹æ˜¯<strong>åœ¨ leader åˆšé€‰ä¸¾æˆåŠŸçš„æ—¶å€™ï¼Œç«‹å³è¿½åŠ ä¸€æ¡ no-opæ—¥å¿—ï¼Œå¹¶ç«‹å³å¤åˆ¶åˆ°å…¶å®ƒèŠ‚ç‚¹ï¼Œno-op æ—¥å¿—ä¸€ç»æäº¤ï¼Œleaderå‰é¢é‚£äº›æœªæäº¤çš„æ—¥å¿—å…¨éƒ¨é—´æ¥æäº¤ï¼Œé—®é¢˜å°±è§£å†³äº†ã€‚åƒä¸Šé¢çš„ kv æ•°æ®åº“ï¼Œæœ‰äº†no-op æ—¥å¿—ä¹‹åï¼ŒLeader å°±èƒ½å¿«é€Ÿå“åº”å®¢æˆ·ç«¯æŸ¥è¯¢äº†ã€‚</strong></p><p>æœ¬è´¨ä¸Šï¼Œno-op æ—¥å¿—ä½¿ leaderéšå¼åœ°å¿«é€Ÿæäº¤ä¹‹å‰ä»»æœŸæœªæäº¤çš„æ—¥å¿—ï¼Œç¡®è®¤å½“å‰<code>commitIndex</code>ï¼Œè¿™æ ·ç³»ç»Ÿæ‰ä¼šå¿«é€Ÿå¯¹å¤–æ­£å¸¸å·¥ä½œã€‚</p></blockquote><p>ä¸ºäº†è§£å†³å›¾ 8 ä¸­æè¿°çš„é—®é¢˜ï¼ŒRaftæ°¸è¿œä¸ä¼šé€šè¿‡è®¡ç®—å‰¯æœ¬æ•°ç›®çš„æ–¹å¼æ¥æäº¤ä¹‹å‰ä»»æœŸå†…çš„æ—¥å¿—æ¡ç›®ã€‚åªæœ‰ leaderå½“æœŸå†…çš„æ—¥å¿—æ¡ç›®æ‰é€šè¿‡è®¡ç®—å‰¯æœ¬æ•°ç›®çš„æ–¹å¼æ¥æäº¤ã€‚ä¸€æ—¦å½“å‰ä»»æœŸå†…çš„æŸä¸ªæ—¥å¿—æ¡ç›®ä»¥è¿™ç§æ–¹å¼è¢«æäº¤ï¼ˆå¦‚å›¾8 ä¸­çš„ eï¼‰ï¼Œé‚£ä¹ˆç”±äºæ—¥å¿—åŒ¹é…ç‰¹æ€§ï¼ˆLogMatchingï¼‰ï¼Œä¹‹å‰çš„æ‰€æœ‰æ—¥å¿—æ¡ç›®ä¹Ÿä¼šè¢«é—´æ¥åœ°æäº¤ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œleaderå¯ä»¥å®‰å…¨åœ°æ–­å®šä¸€ä¸ªè€çš„æ—¥å¿—æ¡ç›®å·²ç»è¢«æäº¤ï¼ˆä¾‹å¦‚ï¼Œå¦‚æœè¯¥æ¡ç›®å·²ç»è¢«å­˜å‚¨åˆ°æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸Šäº†ï¼‰ã€‚ä½†æ˜¯Raft ä¸ºäº†ç®€åŒ–é—®é¢˜ï¼Œé‡‡å–äº†ä¸Šè¿°æè¿°çš„æ›´åŠ ä¿å®ˆçš„æ–¹æ³•ã€‚</p><p>Raft ä¼šåœ¨æäº¤è§„åˆ™ä¸Šå¢åŠ é¢å¤–çš„å¤æ‚æ€§æ˜¯å› ä¸ºå½“ leaderå¤åˆ¶ä¹‹å‰ä»»æœŸå†…çš„æ—¥å¿—æ¡ç›®æ—¶ï¼Œè¿™äº›æ—¥å¿—æ¡ç›®éƒ½ä¿ç•™åŸæ¥çš„ä»»æœŸå·ã€‚åœ¨å…¶ä»–çš„å…±è¯†ç®—æ³•ä¸­ï¼Œå¦‚æœä¸€ä¸ªæ–°çš„leader è¦é‡æ–°å¤åˆ¶ä¹‹å‰ä»»æœŸé‡Œçš„æ—¥å¿—æ—¶ï¼Œå®ƒå¿…é¡»ä½¿ç”¨å½“å‰æ–°çš„ä»»æœŸå·ã€‚Raftçš„åšæ³•ä½¿å¾—æ›´åŠ å®¹æ˜“æ¨å¯¼å‡ºæ—¥å¿—æ¡ç›®ï¼Œå› ä¸ºå®ƒä»¬è‡ªå§‹è‡³ç»ˆéƒ½ä½¿ç”¨åŒä¸€ä¸ªä»»æœŸå·ã€‚å¦å¤–ï¼Œå’Œå…¶ä»–çš„ç®—æ³•ç›¸æ¯”ï¼ŒRaftä¸­çš„æ–° leaderåªéœ€è¦å‘é€æ›´å°‘çš„æ—¥å¿—æ¡ç›®ï¼ˆå…¶ä»–ç®—æ³•ä¸­å¿…é¡»åœ¨å®ƒä»¬è¢«æäº¤ä¹‹å‰å‘é€æ›´å¤šçš„å†—ä½™æ—¥å¿—æ¡ç›®æ¥ç»™å®ƒä»¬é‡æ–°ç¼–å·ï¼‰ã€‚</p><h4 id="å®‰å…¨æ€§è®ºè¯">5.4.3 å®‰å…¨æ€§è®ºè¯</h4><p>ç»™å‡ºäº†å®Œæ•´çš„ Raft ç®—æ³•åï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥æ›´ä¸¥æ ¼åœ°æ¥è®ºè¯ leaderå®Œæ•´æ€§ç‰¹æ€§ï¼ˆLeader Completeness Propertyï¼‰ï¼ˆè¿™ä¸€è®¨è®ºåŸºäº 9.2èŠ‚çš„å®‰å…¨æ€§è¯æ˜ï¼‰ã€‚æˆ‘ä»¬å…ˆå‡è®¾ Leader Completeness Propertyæ˜¯ä¸æ»¡è¶³çš„ï¼Œç„¶åå†æ¨å‡ºçŸ›ç›¾æ¥ã€‚</p><p><strong>å‡è®¾ï¼š</strong></p><p>å‡è®¾ä»»æœŸ T çš„ leader<sub>T</sub>åœ¨ä»»æœŸå†…æäº¤äº†ä¸€ä¸ªæ—¥å¿—æ¡ç›®ï¼Œä½†æ˜¯è¯¥æ—¥å¿—æ¡ç›®æ²¡æœ‰å­˜åœ¨æœªæ¥æŸäº›ä»»æœŸçš„ leaderä¸­ï¼Œå‡è®¾ U æ˜¯å¤§äº T çš„æ²¡æœ‰å­˜å‚¨è¯¥æ—¥å¿—æ¡ç›®çš„æœ€å°ä»»æœŸå·ï¼Œå¤„åœ¨ä»»æœŸ U çš„leader ç§°ä¸º leader<sub>U</sub>ã€‚</p><p><strong>è®ºè¯ï¼š</strong></p><ol type="1"><li><p>å› ä¸º leaderä»æ¥ä¸åˆ é™¤æˆ–é‡å†™è‡ªå·±çš„æ—¥å¿—æ¡ç›®ï¼Œæ‰€ä»¥å¦‚æœä¸€ä¸ªå·²æäº¤çš„æ—¥å¿—è¦åšåˆ°ä¸å­˜åœ¨æœªæ¥çš„leader<sub>U</sub> ä¸­çš„è¯ï¼Œé‚£ä¹ˆå®ƒåªå¯èƒ½åœ¨ leader<sub>U</sub>é€‰ä¸¾çš„è¿‡ç¨‹ä¸­è¢«ä¸¢å¤±ã€‚</p></li><li><p>leader<sub>T</sub>å°†è¯¥æ—¥å¿—å¤åˆ¶ç»™äº†é›†ç¾¤ä¸­è¿‡åŠçš„èŠ‚ç‚¹ï¼Œleader<sub>U</sub>ä»é›†ç¾¤ä¸­è¿‡åŠçš„èŠ‚ç‚¹å¾—åˆ°äº†æŠ•ç¥¨ã€‚å› æ­¤ï¼Œè‡³å°‘æœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆè¿™é‡Œç§°å®ƒä¸ºvoterï¼‰åŒæ—¶æ¥æ”¶äº†æ¥è‡ª leader<sub>T</sub> çš„æ—¥å¿—æ¡ç›®å¹¶ä¸”ç»™leader<sub>U</sub> æŠ•ç¥¨äº†ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/008i3skNly1gsfipd3u1tj322c0j2wju.jpg"alt="image-20210713185232381" /><figcaption aria-hidden="true">image-20210713185232381</figcaption></figure></li><li><p>voter å¿…ç„¶åœ¨ç»™ leader<sub>U</sub>æŠ•ç¥¨ä¹‹å‰å°±å·²ç»æ¥æ”¶äº†è¿™ä¸ªå·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®äº†ã€‚å¦åˆ™ï¼Œå®ƒå°±ä¼šæ‹’ç»æ¥è‡ªleader<sub>T</sub> çš„ AppendEntries RPC è¯·æ±‚ï¼Œå› ä¸ºå¦‚æœå®ƒåœ¨ç»™leader<sub>U</sub> æŠ•ç¥¨ä¹‹åå†æ¥æ”¶æ¡ç›®çš„è¯ï¼Œé‚£ä¹ˆå®ƒçš„å½“å‰ä»»æœŸå·ä¼šæ¯” Tå¤§ã€‚</p><blockquote><p>è¯‘è€…æ³¨ï¼šå› ä¸ºè¦ä¸¾è¡Œ Leader electionçš„è¯éœ€è¦å¼€ä¸€è½®æ–°çš„ä»»æœŸï¼Œè¿™ä¸ªæ—¶å€™å‰ä¸€è½®ä»»æœŸå·²ç»ç»“æŸäº†ã€‚æˆ‘ä»¬è¿™é‡Œå‡è®¾äº† T&lt; Uï¼Œä¸Šè¿°æ‰€è¯´çš„å·²æäº¤æ—¥å¿—æ¡ç›®æ˜¯åœ¨ä»»æœŸ T ä¸­çš„ï¼Œå¦‚æœ voterå…ˆæŠ•ç¥¨çš„è¯ï¼Œé‚£ä¹ˆå°±è¯´æ˜å®ƒå·²ç»è¿›å…¥äº†ä»»æœŸ U äº†ï¼Œè€Œ U &gt; Tï¼Œvoteræ˜¯ä¸å¯èƒ½æ¥å— leader<sub>T</sub> çš„ AppendEntries è¯·æ±‚çš„ã€‚</p></blockquote></li><li><p>è€Œä¸”ï¼Œvoter åœ¨ç»™ leader<sub>U</sub>æŠ•ç¥¨çš„æ—¶å€™ï¼Œå®ƒä¾æ—§ä¿æœ‰è¯¥æ—¥å¿—æ¡ç›®ï¼Œå› ä¸ºä»»ä½• Uã€T ä¹‹é—´çš„ leaderéƒ½åŒ…å«è¯¥æ—¥å¿—æ¡ç›®ï¼ˆå› ä¸ºæˆ‘ä»¬å‰é¢å‡è®¾äº† U æ˜¯å¤§äº Tçš„æ²¡æœ‰å­˜å‚¨è¯¥æ—¥å¿—æ¡ç›®çš„æœ€å°ä»»æœŸå·ï¼‰ï¼Œè€Œä¸” leader ä»æ¥ä¸ä¼šåˆ é™¤æ¡ç›®ï¼Œå¹¶ä¸”follower åªæœ‰å†è·Ÿ leader å†²çªçš„æ—¶å€™æ‰ä¼šåˆ é™¤æ¡ç›®ã€‚</p></li><li><p>è¯¥æŠ•ç¥¨è€…æŠŠè‡ªå·±çš„é€‰ç¥¨æŠ•ç»™ leader<sub>U</sub>çš„æ—¶å€™ï¼Œleader<sub>U</sub> çš„æ—¥å¿—è‡³å°‘è·Ÿ voterä¸€æ ·æ–°ï¼ˆå¯ä»¥æ›´æ–°ï¼‰ï¼Œè¿™å°±å¯¼è‡´äº†ä»¥ä¸‹çš„ä¸¤ä¸ªçŸ›ç›¾ä¹‹ä¸€äº†ã€‚</p></li><li><p><strong>ç¬¬ä¸€ä¸ªçŸ›ç›¾ï¼š</strong></p><p><strong>å¦‚æœ voter å’Œ leader<sub>U</sub>æœ€åä¸€ä¸ªæ—¥å¿—æ¡ç›®çš„ä»»æœŸå·ç›¸åŒçš„è¯ï¼Œé‚£ä¹ˆ leader<sub>U</sub> çš„æ—¥å¿—è‡³å°‘å’Œvoter çš„ä¸€æ ·é•¿ï¼Œæ‰€ä»¥ leader<sub>U</sub> çš„æ—¥å¿—ä¸€å®šåŒ…å« voteræ—¥å¿—ä¸­çš„æ‰€æœ‰æ—¥å¿—æ¡ç›®ã€‚ è¿™æ˜¯ä¸€ä¸ªçŸ›ç›¾ï¼Œå› ä¸º voteråŒ…å«äº†è¯¥å·²æäº¤çš„æ—¥å¿—æ¡ç›®ï¼Œæ‰€ä»¥ leader<sub>U</sub>å¿…å®šä¹ŸåŒ…å«è¯¥æ—¥å¿—æ¡ç›®ï¼Œè€Œå‰é¢æˆ‘ä»¬å‡è®¾äº† leader<sub>U</sub>æ˜¯ä¸åŒ…å«çš„ï¼Œè¿™å°±äº§ç”Ÿäº†çŸ›ç›¾ã€‚</strong></p></li><li><p><strong>ç¬¬äºŒä¸ªçŸ›ç›¾ï¼š</strong></p><p><strong>å¦‚æœä¸æ˜¯ä¸Šé¢æè¿°çš„æƒ…å†µçš„è¯ï¼Œé‚£ä¹ˆ leader<sub>U</sub>æœ€åä¸€ä¸ªæ—¥å¿—æ¡ç›®çš„ä»»æœŸå·å¿…ç„¶éœ€è¦æ¯” voter çš„æ›´å¤§ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜æ¯” Tè¦å¤§ï¼Œå› ä¸º voter æ‹¥æœ‰åœ¨ä»»æœŸå·ä¸º T æäº¤çš„æ—¥å¿—æ¡ç›®ï¼Œæ‰€ä»¥ voteræœ€åä¸€ä¸ªæ—¥å¿—æ¡ç›®çš„ä»»æœŸå·è‡³å°‘ä¸º Tã€‚åˆ›å»ºäº† leader<sub>U</sub>çš„æœ€åä¸€ä¸ªæ—¥å¿—æ¡ç›®çš„ä¹‹å‰çš„ leaderä¸€å®šå·²ç»åŒ…å«äº†è¯¥å·²è¢«æäº¤çš„æ—¥å¿—æ¡ç›®ï¼ˆå› ä¸ºæˆ‘ä»¬ä¸Šé¢å‡è®¾äº†leader<sub>U</sub> æ˜¯ç¬¬ä¸€ä¸ªæ²¡æœ‰è¯¥æ—¥å¿—æ¡ç›®çš„leaderï¼‰ã€‚æ‰€ä»¥ï¼Œæ ¹æ®æ—¥å¿—åŒ¹é…ç‰¹æ€§ï¼Œleader<sub>U</sub>ä¸€å®šä¹ŸåŒ…å«äº†è¯¥å·²è¢«æäº¤çš„æ—¥å¿—æ¡ç›®ï¼Œè¿™æ ·ä¹Ÿäº§ç”Ÿäº†çŸ›ç›¾</strong>ã€‚</p></li><li><p>ä¸Šè¿°è®¨è®ºå°±è¯æ˜äº†å‡è®¾æ˜¯ä¸æˆç«‹çš„ã€‚å› æ­¤ï¼Œæ‰€æœ‰æ¯” T å¤§çš„ä»»æœŸçš„ leaderä¸€å®šåŒ…å«äº†ä»»æœŸ T ä¸­æäº¤çš„æ‰€æœ‰æ—¥å¿—æ¡ç›®ã€‚</p></li><li><p>æ—¥å¿—åŒ¹é…ç‰¹æ€§ä¿è¯äº†æœªæ¥çš„ leaderä¹Ÿä¼šåŒ…å«è¢«é—´æ¥æäº¤çš„æ—¥å¿—æ¡ç›®ï¼Œå¦‚å›¾ 8 (d) ä¸­çš„ç´¢å¼• 2ã€‚</p></li></ol><p>é€šè¿‡ leader çš„å®Œæ•´æ€§ç‰¹æ€§ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¯æ˜å›¾ 3ä¸­çš„çŠ¶æ€æœºå®‰å…¨ç‰¹æ€§äº†ï¼Œå³å¦‚æœæŸä¸ªèŠ‚ç‚¹å·²ç»å°†æŸä¸ªç»™å®šçš„ç´¢å¼•å¤„çš„æ—¥å¿—æ¡ç›®åº”ç”¨åˆ°è‡ªå·±çš„çŠ¶æ€æœºé‡Œäº†ï¼Œé‚£ä¹ˆå…¶ä»–çš„èŠ‚ç‚¹å°±ä¸ä¼šåœ¨ç›¸åŒçš„ç´¢å¼•å¤„åº”ç”¨ä¸€ä¸ªä¸åŒçš„æ—¥å¿—æ¡ç›®ã€‚åœ¨ä¸€ä¸ªèŠ‚ç‚¹åº”ç”¨ä¸€ä¸ªæ—¥å¿—æ¡ç›®åˆ°è‡ªå·±çš„çŠ¶æ€æœºä¸­æ—¶ï¼Œå®ƒçš„æ—¥å¿—å’Œleaderçš„æ—¥å¿—ä»å¼€å§‹åˆ°è¯¥æ—¥å¿—æ¡ç›®éƒ½æ˜¯ç›¸åŒçš„ï¼Œå¹¶ä¸”è¯¥æ—¥å¿—æ¡ç›®å¿…é¡»è¢«æäº¤ã€‚ç°åœ¨è€ƒè™‘ä¸€ä¸ªæœ€å°çš„ä»»æœŸå·ï¼Œåœ¨è¯¥ä»»æœŸä¸­ä»»æ„èŠ‚ç‚¹åº”ç”¨äº†ä¸€ä¸ªç»™å®šçš„æœ€å°ç´¢å¼•ä¸Šé¢çš„æ—¥å¿—æ¡ç›®ï¼Œé‚£ä¹ˆLog çš„å®Œæ•´æ€§ç‰¹æ€§å°±ä¼šä¿è¯è¯¥ä»»æœŸä¹‹åçš„æ‰€æœ‰ leaderå°†å­˜å‚¨ç›¸åŒçš„æ—¥å¿—æ¡ç›®ï¼Œå› æ­¤åœ¨åé¢çš„ä»»æœŸä¸­åº”ç”¨è¯¥ç´¢å¼•ä¸Šçš„æ—¥å¿—æ¡ç›®çš„èŠ‚ç‚¹ä¼šåº”ç”¨ç›¸åŒçš„å€¼ã€‚æ‰€ä»¥ï¼ŒçŠ¶æ€æœºå®‰å…¨ç‰¹æ€§æ˜¯å¯ä»¥å¾—åˆ°ä¿è¯çš„ã€‚</p><p>æœ€åï¼Œå› ä¸º Raftè¦æ±‚æœåŠ¡å™¨èŠ‚ç‚¹æŒ‰ç…§æ—¥å¿—ç´¢å¼•é¡ºåºåº”ç”¨æ—¥å¿—æ¡ç›®ï¼Œå†åŠ ä¸ŠçŠ¶æ€æœºå®‰å…¨ç‰¹æ€§ï¼Œè¿™æ ·å°±æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä¿è¯æ‰€æœ‰çš„æœåŠ¡å™¨éƒ½ä¼šæŒ‰ç…§ç›¸åŒçš„é¡ºåºåº”ç”¨ç›¸åŒçš„æ—¥å¿—æ¡ç›®åˆ°è‡ªå·±çš„çŠ¶æ€æœºä¸­äº†ã€‚</p><h3 id="follower-å’Œ-candidate-å´©æºƒ">5.5 follower å’Œ candidate å´©æºƒ</h3><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬åªå…³æ³¨äº† leader å´©æºƒçš„æƒ…å†µã€‚follower å’Œ candidateå´©æºƒåçš„å¤„ç†æ–¹å¼è¦æ¯” leaderå´©æºƒç®€å•å¾—å¤šï¼Œè€Œä¸”å®ƒä»¬çš„å¤„ç†æ–¹å¼æ˜¯ç›¸åŒçš„ã€‚å¦‚æœä¸€ä¸ª follower æˆ–è€…candidate å´©æºƒçš„è¯ï¼Œåé¢å‘é€ç»™å®ƒä»¬çš„ RequestVote å’Œ AppendEntries RPCséƒ½ä¼šå¤±è´¥ã€‚Rafté€šè¿‡æ— é™é‡è¯•æ¥å¤„ç†è¿™ç§å¤±è´¥ã€‚å¦‚æœå´©æºƒçš„èŠ‚ç‚¹é‡å¯äº†ï¼Œé‚£ä¹ˆè¿™äº› RPCå°±ä¼šè¢«æˆåŠŸåœ°å®Œæˆã€‚å¦‚æœä¸€ä¸ªèŠ‚ç‚¹åœ¨å®Œæˆäº†ä¸€ä¸ªRPCï¼Œä½†æ˜¯è¿˜æ²¡æ¥å¾—åŠå“åº”å°±å´©æºƒäº†çš„è¯ï¼Œé‚£ä¹ˆåœ¨å®ƒé‡å¯ä¹‹åå®ƒä¼šå†æ¬¡æ”¶åˆ°åŒæ ·çš„è¯·æ±‚ã€‚Raftçš„ RPCs éƒ½æ˜¯å¹‚ç­‰çš„ï¼Œæ‰€ä»¥é‡å¤å‘é€ç›¸åŒçš„ RPCsä¸ä¼šå¯¹ç³»ç»Ÿé€ æˆå±å®³ã€‚å®é™…æƒ…å†µä¸‹ï¼Œä¸€ä¸ª follower å¦‚æœæ¥æ”¶äº†ä¸€ä¸ªAppendEntriesè¯·æ±‚ï¼Œä½†æ˜¯è¿™ä¸ªè¯·æ±‚é‡Œé¢çš„è¿™äº›æ—¥å¿—æ¡ç›®åœ¨å®ƒæ—¥å¿—ä¸­å·²ç»æœ‰äº†ï¼Œå®ƒå°±ä¼šç›´æ¥å¿½ç•¥è¿™ä¸ªæ–°çš„è¯·æ±‚ä¸­çš„è¿™äº›æ—¥å¿—æ¡ç›®ã€‚</p><blockquote><p>è¯‘è€…æ³¨ï¼š<strong>å¹‚ç­‰</strong></p><p>åœ¨ç¼–ç¨‹ä¸­ä¸€ä¸ªå¹‚ç­‰æ“ä½œçš„ç‰¹ç‚¹æ˜¯å…¶ä»»æ„å¤šæ¬¡æ‰§è¡Œæ‰€äº§ç”Ÿçš„å½±å“å‡ä¸ä¸€æ¬¡æ‰§è¡Œçš„å½±å“ç›¸åŒã€‚å¹‚ç­‰å‡½æ•°ï¼Œæˆ–å¹‚ç­‰æ–¹æ³•ï¼Œæ˜¯æŒ‡å¯ä»¥ä½¿ç”¨ç›¸åŒå‚æ•°é‡å¤æ‰§è¡Œï¼Œå¹¶èƒ½è·å¾—ç›¸åŒç»“æœçš„å‡½æ•°ã€‚è¿™äº›å‡½æ•°ä¸ä¼šå½±å“ç³»ç»ŸçŠ¶æ€ï¼Œä¹Ÿä¸ç”¨æ‹…å¿ƒé‡å¤æ‰§è¡Œä¼šå¯¹ç³»ç»Ÿé€ æˆæ”¹å˜ã€‚ä¾‹å¦‚ï¼Œâ€œsetTrue()â€å‡½æ•°å°±æ˜¯ä¸€ä¸ªå¹‚ç­‰å‡½æ•°,æ— è®ºå¤šæ¬¡æ‰§è¡Œï¼Œå…¶ç»“æœéƒ½æ˜¯ä¸€æ ·çš„.æ›´å¤æ‚çš„æ“ä½œå¹‚ç­‰ä¿è¯æ˜¯åˆ©ç”¨å”¯ä¸€äº¤æ˜“å·(æµæ°´å·)å®ç°ã€‚</p></blockquote><h3 id="æ—¶åºå’Œå¯ç”¨æ€§">5.6 æ—¶åºå’Œå¯ç”¨æ€§</h3><p>Raft ä¸­æœ‰ä¸€ä¸ªè¦æ±‚å°±æ˜¯ Raftçš„å®‰å…¨æ€§ä¸èƒ½ä¾èµ–äºæ—¶åºï¼ˆtimingï¼‰ï¼šæ•´ä¸ªç³»ç»Ÿä¸èƒ½å› ä¸ºæŸäº›äº‹ä»¶è¿è¡Œå¾—æ¯”é¢„æœŸå¿«ä¸€ç‚¹æˆ–è€…æ…¢ä¸€ç‚¹å°±äº§ç”Ÿé”™è¯¯çš„ç»“æœã€‚ç„¶è€Œï¼Œå¯ç”¨æ€§ï¼ˆå³ç³»ç»Ÿèƒ½å¤ŸåŠæ—¶å“åº”å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼‰ä¸å¯é¿å…çš„è¦ä¾èµ–äºæ—¶åºã€‚æ¯”å¦‚è¯´ï¼Œå¦‚æœä¿¡æ¯äº¤æ¢çš„æ—¶é—´æ¯”ä¸€èˆ¬æœåŠ¡å™¨å´©æºƒæ‰€æŒç»­çš„æ—¶é—´è¿˜è¦é•¿çš„è¯ï¼Œé‚£ä¹ˆcandidate å¯èƒ½ç­‰ä¸åˆ°èµ¢å¾—é€‰ä¸¾äº†ï¼Œè€Œç¼ºå°‘äº†ä¸€ä¸ªç¨³å®šçš„ leaderï¼ŒRaftå°†æ— æ³•å·¥ä½œã€‚</p><p>Raft ä¸­æ—¶åºæœ€å…³é”®çš„åœ°æ–¹å°±æ˜¯ Leaderelectionã€‚åªè¦æ•´ä¸ªç³»ç»Ÿæ»¡è¶³ä¸‹é¢çš„æ—¶é—´è¦æ±‚ï¼ŒRaftå°±å¯ä»¥é€‰ä¸¾å¹¶ç»´æŒä¸€ä¸ªç¨³å®šçš„ leaderï¼š</p><blockquote><p>å¹¿æ’­æ—¶é—´ï¼ˆbroadcastTimeï¼‰ &lt;&lt; é€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼ˆelectionTimeoutï¼‰&lt;&lt; å¹³å‡æ•…éšœé—´éš”æ—¶é—´ï¼ˆMTBFï¼‰</p></blockquote><p>åœ¨è¿™ä¸ªä¸ç­‰å¼ä¸­ï¼Œå¹¿æ’­æ—¶é—´æŒ‡çš„æ˜¯ä¸€ä¸ªèŠ‚ç‚¹å¹¶è¡Œåœ°å‘é€ RPCsç»™é›†ç¾¤ä¸­å…¶ä»–æ‰€æœ‰çš„èŠ‚ç‚¹å¹¶å¾—åˆ°å“åº”çš„å¹³å‡æ—¶é—´ã€‚é€‰ä¸¾è¶…æ—¶æ—¶é—´å°±æ˜¯åœ¨ 5.2èŠ‚ä¸­ä»‹ç»çš„é€‰ä¸¾è¶…æ—¶æ—¶é—´ã€‚å¹³å‡æ•…éšœé—´éš”æ—¶é—´å°±æ˜¯å¯¹äºä¸€å°æœåŠ¡å™¨è€Œè¨€ï¼Œä¸¤æ¬¡æ•…éšœé—´éš”æ—¶é—´çš„å¹³å‡å€¼ã€‚å¹¿æ’­æ—¶é—´å¿…é¡»é€‰ä¸¾è¶…æ—¶æ—¶é—´å°ä¸€ä¸ªé‡çº§ï¼Œè¿™æ ·leader æ‰èƒ½å¤Ÿæœ‰æ•ˆå‘é€å¿ƒè·³ä¿¡æ¯æ¥ç»„ç»‡ followerè¿›å…¥é€‰ä¸¾çŠ¶æ€ã€‚å†åŠ ä¸ŠéšæœºåŒ–é€‰ä¸¾è¶…æ—¶æ—¶é—´çš„æ–¹æ³•ï¼Œè¿™ä¸ªä¸ç­‰å¼ä¹Ÿä½¿å¾—æ— æœé€‰ç¥¨ï¼ˆsplitvoteï¼‰å˜å¾—å‡ ä¹ä¸å¯èƒ½ã€‚è€Œé€‰ä¸¾è¶…æ—¶æ—¶é—´éœ€è¦æ¯”å¹³å‡æ•…éšœé—´éš”æ—¶é—´å°ä¸Šå‡ ä¸ªæ•°é‡çº§ï¼Œè¿™æ ·æ•´ä¸ªç³»ç»Ÿæ‰å¯ä»¥ç¨³å®šåœ°è¿è¡Œã€‚æœ‰äº†è¿™ä¸ªé™åˆ¶åï¼Œå½“leaderå´©æºƒåï¼Œæ•´ä¸ªç³»ç»Ÿä¼šæœ‰ä¸€æ®µå¤§çº¦é€‰ä¸¾è¶…æ—¶æ—¶é—´çš„æ—¶é•¿ä¸å¯ç”¨ï¼Œæˆ‘ä»¬å¸Œæœ›è¯¥æƒ…å†µåœ¨æ•´ä¸ªç³»ç»Ÿè¿è¡Œæ—¶é—´é‡Œåªå ä¸€å°éƒ¨åˆ†ã€‚</p><p>å¹¿æ’­æ—¶é—´å’Œå¹³å‡æ•…éšœé—´éš”æ—¶é—´æ˜¯ç”±ç³»ç»Ÿå†³å®šçš„ï¼Œä½†æ˜¯é€‰ä¸¾è¶…æ—¶æ—¶é—´æ˜¯æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰çš„ã€‚Raftçš„ RPCs éœ€è¦æ¥æ”¶æ–¹å°†ä¿¡æ¯æŒä¹…åŒ–åœ°ä¿å­˜åˆ°ç¨³å®šå­˜å‚¨ä¸­ï¼Œæ‰€ä»¥å¹¿æ’­æ—¶é—´å¤§çº¦æ˜¯0.5ms ~ 20ms ä¹‹é—´ï¼Œå–å†³äºå­˜å‚¨çš„æŠ€æœ¯ã€‚å› æ­¤ï¼Œé€‰ä¸¾è¶…æ—¶æ—¶é—´å¯èƒ½éœ€è¦åœ¨ 10ms ~500msä¹‹é—´ã€‚è€Œå¤§å¤šæ•°çš„æœåŠ¡å™¨çš„å¹³å‡æ•…éšœé—´éš”æ—¶é—´éƒ½åœ¨å‡ ä¸ªæœˆç”šè‡³æ›´é•¿ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“æ»¡è¶³æ—¶é—´çš„è¦æ±‚ã€‚</p><h2 id="é›†ç¾¤æˆå‘˜å˜æ›´">6. é›†ç¾¤æˆå‘˜å˜æ›´</h2><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬éƒ½å‡è®¾é›†ç¾¤çš„é…ç½®ï¼ˆå‚ä¸å…±è¯†ç®—æ³•çš„æœåŠ¡å™¨èŠ‚ç‚¹é›†åˆï¼‰æ˜¯å›ºå®šä¸å˜çš„ã€‚ä½†æ˜¯åœ¨å®é™…æƒ…å†µä¸­ï¼Œæˆ‘ä»¬æœ‰æ—¶å€™æ˜¯éœ€è¦å»æ”¹å˜é›†ç¾¤é…ç½®çš„ï¼Œæ¯”å¦‚è¯´åœ¨æœåŠ¡å™¨å´©æºƒçš„æ—¶å€™å»æ›´æ¢æœåŠ¡å™¨æˆ–è€…æ˜¯æ›´æ”¹å‰¯æœ¬çš„æ•°é‡ã€‚å°½ç®¡å¯ä»¥é€šè¿‡ä¸‹çº¿æ•´ä¸ªé›†ç¾¤ï¼Œæ›´æ–°æ‰€æœ‰é…ç½®ï¼Œç„¶åé‡å¯æ•´ä¸ªé›†ç¾¤çš„æ–¹å¼æ¥å®ç°è¿™ä¸ªéœ€æ±‚ï¼Œä½†æ˜¯è¿™ä¼šå¯¼è‡´é›†ç¾¤åœ¨æ›´æ”¹è¿‡ç¨‹ä¸­æ˜¯ä¸å¯ç”¨çš„ã€‚å¦å¤–ï¼Œå¦‚æœè¿™ä¸ªè¿‡ç¨‹ä¸­å­˜åœ¨ä¸€äº›æ“ä½œéœ€è¦äººå·¥å¹²é¢„ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰æ“ä½œå¤±è¯¯çš„é£é™©ã€‚ä¸ºäº†é¿å…è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬å†³å®šå°†é…ç½®å˜æ›´è‡ªåŠ¨åŒ–å¹¶å°†å…¶çº³å…¥åˆ°Raft çš„å…±è¯†ç®—æ³•ä¸­æ¥ã€‚</p><p>ä¸ºäº†ä½¿é…ç½®å˜æ›´æœºåˆ¶è¶³å¤Ÿå®‰å…¨ï¼Œåœ¨é…ç½®å˜æ›´è¿‡ç¨‹ä¸­ä¸èƒ½å­˜åœ¨ä»»ä½•ä¸€ä¸ªæ—¶åˆ»ä½¿å¾—åŒä¸€ä»»æœŸä¸­é€‰å‡ºä¸¤ä¸ªleaderã€‚é—æ†¾çš„æ˜¯ï¼Œä»»ä½•æœåŠ¡å™¨ç›´æ¥ä»æ—§çš„é…ç½®è½¬æ¢ä¸ºæ–°çš„é…ç½®çš„æ–¹æ¡ˆéƒ½æ˜¯ä¸å®‰å…¨çš„ã€‚ä¸€æ¬¡æ€§è‡ªåŠ¨åœ°è½¬æ¢æ‰€æœ‰æœåŠ¡å™¨çš„é…ç½®çš„ä¸å¯èƒ½çš„ï¼Œæ‰€ä»¥åœ¨è½¬æ¢æœŸé—´æ•´ä¸ªé›†ç¾¤å¯èƒ½åˆ’åˆ†ä¸ºä¸¤ä¸ªç‹¬ç«‹çš„å¤§å¤šæ•°ï¼ˆå¦‚å›¾10 æ‰€ç¤ºï¼‰ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/008i3skNly1gsgq3skl4gj322c0nwaes.jpg"alt="image-20210714195412552" /><figcaption aria-hidden="true">image-20210714195412552</figcaption></figure><blockquote><p>è¯‘è€…æ³¨ï¼šå›¾ 10 è¡¥å……</p><p>ä¸Šå›¾ä¸­ï¼Œåœ¨ä¸­é—´ä½ç½® Server1 å¯ä»¥é€šè¿‡è‡ªèº«å’Œ Server2 çš„é€‰ç¥¨æˆä¸ºleaderï¼ˆæ»¡è¶³æ—§é…ç½®ä¸‹æ”¶åˆ°å¤§å¤šæ•°é€‰ç¥¨çš„åŸåˆ™ï¼‰ï¼›Server3 å¯ä»¥é€šè¿‡è‡ªèº«å’ŒServer4ã€Server5 çš„é€‰ç¥¨æˆä¸º leaderï¼ˆæ»¡è¶³æ–°é…ç½®çº¿ï¼Œå³é›†ç¾¤æœ‰ 5ä¸ªèŠ‚ç‚¹çš„æƒ…å†µä¸‹çš„æ”¶åˆ°å¤§å¤šæ•°é€‰ç¥¨çš„åŸåˆ™ï¼‰ï¼›æ­¤æ—¶æ•´ä¸ªé›†ç¾¤å¯èƒ½åœ¨åŒä¸€ä»»æœŸä¸­å‡ºç°äº†ä¸¤ä¸ªleaderï¼Œè¿™å’Œ Raft åè®®æ˜¯è¿èƒŒçš„ã€‚</p></blockquote><p>ä¸ºäº†ä¿è¯å®‰å…¨æ€§ï¼Œé…ç½®å˜æ›´å¿…é¡»é‡‡å–ä¸€ç§ä¸¤æ®µå¼æ–¹æ³•ã€‚ç›®å‰æœ‰å¾ˆå¤šç§ä¸¤æ®µå¼çš„å®ç°ã€‚ä¾‹å¦‚ï¼Œæœ‰äº›ç³»ç»Ÿï¼ˆå¦‚[22]ï¼‰åœ¨ç¬¬ä¸€é˜¶æ®µåœæ‰æ—§çš„é…ç½®ï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªé˜¶æ®µä¸èƒ½å¤„ç†ç”¨æˆ·çš„è¯·æ±‚ï¼Œç„¶ååœ¨ç¬¬äºŒé˜¶æ®µå¯ç”¨æ–°çš„é…ç½®ã€‚åœ¨Raft ä¸­ï¼Œé›†ç¾¤å…ˆåˆ‡æ¢åˆ°ä¸€ä¸ªè¿‡æ¸¡çš„é…ç½®ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º <strong>è”åˆå…±è¯†ï¼ˆjointconsensusï¼‰</strong>ã€‚ä¸€æ—¦è”åˆå…±è¯†é…ç½®å·²ç»è¢«æäº¤äº†ï¼Œç³»ç»Ÿå°±å¯ä»¥åˆ‡æ¢åˆ°æ–°çš„é…ç½®ä¸Šäº†ã€‚<strong>è”åˆå…±è¯†é…ç½®æ˜¯æ–°æ—§é…ç½®çš„å¹¶é›†</strong>ï¼š</p><ul><li>æ—¥å¿—æ¡ç›®è¢«å¤åˆ¶ç»™é›†ç¾¤ä¸­å¤„äºæ–°ã€è€é…ç½®çš„æ‰€æœ‰èŠ‚ç‚¹</li><li>æ–°ã€æ—§é…ç½®çš„èŠ‚ç‚¹éƒ½å¯èƒ½æˆä¸º leader</li><li>è¾¾æˆä¸€è‡´ï¼ˆé’ˆå¯¹é€‰ä¸¾å’Œæäº¤ï¼‰éœ€è¦åˆ†åˆ«å¾—åˆ°åœ¨ä¸¤ç§é…ç½®ä¸Šè¿‡åŠçš„æ”¯æŒ</li></ul><p>è”åˆå…±è¯†å…è®¸æ¯ä¸€ä¸ªèŠ‚ç‚¹åœ¨ä¸å¦¥åå®‰å…¨æ€§çš„å‰æä¸‹ï¼Œåœ¨ä¸åŒçš„æ—¶åˆ»è¿›è¡Œé…ç½®è½¬æ¢è¿‡ç¨‹ã€‚æ­¤å¤–ï¼Œè”åˆå…±è¯†è¿˜å…è®¸åœ¨é›†ç¾¤é…ç½®å˜æ›´æœŸé—´å“åº”å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚</p><p>é›†ç¾¤é…ç½®åœ¨å¤åˆ¶æ—¥å¿—ä¸­ä»¥ç‰¹æ®Šçš„æ—¥å¿—æ¡ç›®æ¥å­˜å‚¨å’Œé€šä¿¡ã€‚å›¾ 11å±•ç¤ºäº†é…ç½®å˜æ›´çš„è¿‡ç¨‹ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/008i3skNly1gsgpnv9f98j32060p6agz.jpg"alt="image-20210714193852320" /><figcaption aria-hidden="true">image-20210714193852320</figcaption></figure><p>å½“ leaderæ¥æ”¶åˆ°ä¸€ä¸ªæ›´æ–°é…ç½®çš„è¯·æ±‚çš„æ—¶å€™ï¼Œå®ƒå°±åˆ›å»ºä¸€ä¸ªè”åˆå…±è¯†æ—¥å¿—æ¡ç›®C<sub>old,new</sub>ï¼Œå¹¶ä»¥å‰é¢æè¿°çš„æ–¹å¼å¤åˆ¶è¯¥æ¡ç›®ã€‚<strong>ä¸€æ—¦æŸä¸ªèŠ‚ç‚¹å°†è¯¥é…ç½®æ—¥å¿—æ¡ç›®å¢åŠ åˆ°è‡ªå·±çš„æ—¥å¿—ä¸­ã€‚é‚£ä¹ˆè¿™ä¸ªèŠ‚ç‚¹å°±ä¼šç”¨è¯¥é…ç½®æ¥åšå‡ºæœªæ¥çš„æ‰€æœ‰å†³ç­–ï¼ˆä¸€ä¸ªèŠ‚ç‚¹æ€»æ˜¯ä½¿ç”¨æ—¥å¿—ä¸­æœ€æ–°çš„é…ç½®ï¼Œæ— è®ºè¯¥æ—¥å¿—æ˜¯å¦å·²ç»è¢«æäº¤ï¼‰ã€‚</strong>è¿™å°±æ„å‘³ç€ leader ä¼šä½¿ç”¨ C<sub>old,new</sub> çš„è§„åˆ™æ¥åˆ¤æ–­C<sub>old,new</sub> æ—¥å¿—æ¡ç›®æ˜¯ä»€ä¹ˆæ—¶å€™è¢«æäº¤çš„ã€‚å¦‚æœ leader å´©æºƒäº†ï¼Œæ–°çš„leader æœ‰å¯èƒ½å¤„äº C<sub>old</sub> é…ç½®ï¼Œä¹Ÿå¯èƒ½å¤„äº C<sub>old,new</sub>é…ç½®ï¼Œè¿™å–å†³äºèµ¢å¾—é€‰ä¸¾çš„ candidate æ˜¯å¦å·²ç»æ¥æ”¶åˆ°äº† C<sub>old,new</sub>é…ç½®ã€‚åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œå¤„äº C<sub>new</sub>çŠ¶æ€çš„èŠ‚ç‚¹åœ¨æ­¤æœŸé—´éƒ½æ˜¯ä¸èƒ½å•ç‹¬åšå‡ºå†³å®šçš„ã€‚</p><p>å½“ C<sub>old,new</sub> è¢«æäº¤äº†ï¼Œé‚£ä¹ˆ C<sub>old</sub> å’ŒC<sub>new</sub> éƒ½ä¸èƒ½åœ¨æ²¡æœ‰å¾—åˆ°å¯¹æ–¹è®¤å¯çš„æƒ…å†µä¸‹åšå‡ºå†³å®šï¼Œå¹¶ä¸” Leadeå®Œæ•´ç‰¹æ€§ï¼ˆLeader Completeness Propertyï¼‰ä¿è¯äº†åªæœ‰æ‹¥æœ‰C<sub>old,new</sub> æ—¥å¿—çš„ candidate æœ‰å¯èƒ½è¢«é€‰ä¸º leaderã€‚æ‰€ä»¥ç°åœ¨leader å°±å¯ä»¥å®‰å…¨åœ°åˆ›å»ºä¸€ä¸ªæè¿° C<sub>new</sub>çš„æ—¥å¿—æ¡ç›®å¹¶å°†å…¶å¤åˆ¶ç»™é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹äº†ã€‚ä¸€æ ·çš„ï¼Œæ–°çš„é…ç½®è¢«èŠ‚ç‚¹æ”¶åˆ°åå°±ä¼šç«‹åˆ»ç”Ÿæ•ˆã€‚å½“æ–°çš„é…ç½®åœ¨C<sub>new</sub>çš„è§„åˆ™ä¸‹è¢«æäº¤äº†ä¹‹åï¼Œæ—§é…ç½®å°±å˜å¾—æ— å…³ç´§è¦äº†ï¼Œå¤„äºæ—§é…ç½®çš„èŠ‚ç‚¹ä¹Ÿå¯ä»¥å…³é—­äº†ã€‚å¦‚å›¾11 æ‰€ç¤ºï¼Œæ²¡æœ‰ä»»ä½•ä¸€ä¸ªæ—¶åˆ» C<sub>old</sub> å’Œ C<sub>new</sub>æ˜¯å¯ä»¥å•ç‹¬åšå†³å®šçš„ï¼Œè¿™ä¿è¯äº†å®‰å…¨æ€§ã€‚</p><p>å…³äºé…ç½®å˜æ›´æœ‰ä¸‰ä¸ªé—®é¢˜éœ€è¦è§£å†³ï¼š</p><ul><li><p>ç¬¬ä¸€ä¸ªé—®é¢˜ï¼šæ–°çš„èŠ‚ç‚¹å¯èƒ½åœ¨ä¸€å¼€å§‹å¹¶æ²¡æœ‰å­˜å‚¨ä»»ä½•çš„æ—¥å¿—æ¡ç›®ã€‚å½“è¿™äº›èŠ‚ç‚¹ä»¥è¿™ç§çŠ¶æ€åŠ å…¥åˆ°é›†ç¾¤ä¸­çš„æ—¶å€™ï¼Œå®ƒä»¬éœ€è¦ä¸€æ®µæ—¶é—´æ¥æ›´æ–°è‡ªå·±çš„æ—¥å¿—ï¼Œä»¥ä¾¿èµ¶ä¸Šå…¶ä»–èŠ‚ç‚¹ï¼Œåœ¨è¿™ä¸ªæ—¶é—´æ®µé‡Œé¢å®ƒä»¬æ˜¯ä¸å¯èƒ½æäº¤ä¸€ä¸ªæ–°çš„æ—¥å¿—æ¡ç›®çš„ã€‚<strong>ä¸ºäº†é¿å…å› æ­¤é€ æˆçš„ç³»ç»ŸçŸ­æ—¶é—´çš„ä¸å¯ç”¨ï¼ŒRaftåœ¨é…ç½®å˜æ›´å‰å¼•å…¥äº†ä¸€ä¸ªé¢å¤–çš„é˜¶æ®µã€‚åœ¨è¯¥é˜¶æ®µä¸­ï¼Œæ–°çš„èŠ‚ç‚¹ä»¥æ²¡æœ‰æŠ•ç¥¨æƒèº«ä»½åŠ å…¥åˆ°é›†ç¾¤ä¸­æ¥ï¼ˆleaderä¼šæŠŠæ—¥å¿—å¤åˆ¶ç»™å®ƒä»¬ï¼Œä½†æ˜¯è€ƒè™‘è¿‡åŠçš„æ—¶å€™ä¸éœ€è¦è€ƒè™‘å®ƒä»¬ï¼‰ã€‚</strong>ä¸€æ—¦æ–°èŠ‚ç‚¹çš„æ—¥å¿—å·²ç»èµ¶ä¸Šäº†é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹ï¼Œé‚£ä¹ˆé…ç½®å˜æ›´å°±å¯ä»¥æŒ‰ç…§ä¹‹å‰æè¿°çš„æ–¹å¼è¿›è¡Œäº†ã€‚</p></li><li><p>ç¬¬äºŒä¸ªé—®é¢˜ï¼šleader æœ‰å¯èƒ½ä¸æ˜¯æ–°é…ç½®ä¸­çš„ä¸€å‘˜ï¼ˆè¯‘è€…æ³¨ï¼šä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªleader åé¢æ˜¯éœ€è¦è¢«ä¸‹çº¿çš„ï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œleader ä¸€æ—¦æäº¤äº†C<sub>new</sub> æ—¥å¿—æ¡ç›®ï¼Œå®ƒå°±ä¼šé€€ä½ä¸ºfollowerï¼ˆè¯‘è€…æ³¨ï¼šC<sub>old,new</sub>çŠ¶æ€ä¸‹ä¾æ—§å¯ç”¨ï¼‰ã€‚è¿™å°±æ„å‘³ç€æœ‰è¿™æ ·ä¸€æ®µæ—¶é—´ï¼ˆleader æäº¤ C<sub>new</sub>æœŸé—´ï¼‰ï¼šleaderç®¡ç†ç€ä¸€ä¸ªä¸åŒ…æ‹¬è‡ªå·±çš„é›†ç¾¤ï¼Œå®ƒä¼šå¤åˆ¶æ—¥å¿—ç»™å…¶ä»–èŠ‚ç‚¹ï¼Œä½†æ˜¯ç®—å‰¯æœ¬æ•°é‡çš„æ—¶å€™ä¸ä¼šç®—ä¸Šè‡ªå·±ã€‚leaderè½¬æ¢å‘ç”Ÿåœ¨ C<sub>new</sub>è¢«æäº¤çš„æ—¶å€™ï¼Œå› ä¸ºè¿™æ˜¯æ–°é…ç½®å¯ä»¥ç‹¬ç«‹è¿è¡Œçš„æœ€æ—©æ—¶åˆ»ï¼ˆåœ¨è¿™ä¸ªæ—¶åˆ»ä¹‹åï¼Œä¸€å®šæ˜¯ä»C<sub>new</sub> ä¸­é€‰å‡ºæ–°çš„ leaderï¼‰ã€‚åœ¨è¿™ä¸ªæ—¶é—´ç‚¹ä¹‹å‰ï¼Œæœ‰å¯èƒ½åªèƒ½ä»C<sub>old</sub> ä¸­é€‰å‡º leaderã€‚</p></li><li><p>ç¬¬ä¸‰ä¸ªé—®é¢˜ï¼šé‚£ä¹ˆè¢«ç§»é™¤çš„èŠ‚ç‚¹ï¼ˆä¸å¤„äº C<sub>new</sub>çŠ¶æ€çš„èŠ‚ç‚¹ï¼‰æœ‰å¯èƒ½ä¼šæ‰°ä¹±é›†ç¾¤ã€‚è¿™äº›èŠ‚ç‚¹å°†ä¸ä¼šæ”¶åˆ°å¿ƒè·³ä¿¡æ¯ï¼Œæ‰€ä»¥å½“é€‰ä¸¾è¶…æ—¶æ—¶ï¼Œå®ƒä»¬å°±ä¼šè¿›è¡Œæ–°çš„é€‰ä¸¾è¿‡ç¨‹ã€‚å®ƒä»¬ä¼šå‘é€å¸¦æœ‰æ–°ä»»æœŸå·çš„RequestVote RPCsï¼Œè¿™æ ·ä¼šå¯¼è‡´å½“å‰çš„ leader å›åˆ° followerçŠ¶æ€ï¼Œç„¶åé€‰å‡ºä¸€ä¸ªæ–°çš„leaderã€‚ä½†æ˜¯è¿™äº›è¢«ç§»é™¤çš„èŠ‚ç‚¹è¿˜æ˜¯ä¼šæ”¶ä¸åˆ°å¿ƒè·³ï¼Œç„¶åå†æ¬¡è¶…æ—¶ï¼Œå†æ¬¡å¾ªç¯è¿™ä¸ªè¿‡ç¨‹ï¼Œå¯¼è‡´ç³»ç»Ÿçš„å¯ç”¨æ€§å¾ˆå·®ã€‚</p><p>ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œå½“èŠ‚ç‚¹è®¤ä¸ºå½“å‰æœ‰ leader å­˜åœ¨æ—¶ï¼ŒèŠ‚ç‚¹ä¼šå¿½ç•¥RequestVote RPCsã€‚å…·ä½“æ¥è¯´ï¼Œå½“ä¸€ä¸ªèŠ‚ç‚¹åœ¨æœ€å°é€‰ä¸¾è¶…æ—¶æ—¶é—´å†…æ”¶åˆ°ä¸€ä¸ªRequestVoteRPCï¼Œå®ƒä¸ä¼šæ›´æ–°å®ƒçš„ä»»æœŸæˆ–æˆäºˆå®ƒçš„æŠ•ç¥¨ã€‚è¿™ä¸ä¼šå½±å“æ­£å¸¸çš„é€‰ä¸¾ï¼Œæ¯ä¸ªèŠ‚ç‚¹åœ¨å¼€å¯ä¸€è½®é€‰ä¸¾ä¹‹å‰ï¼Œå®ƒä¼šè‡³å°‘ç­‰å¾…ä¸€æ¬¡æœ€å°é€‰ä¸¾è¶…æ—¶æ—¶é—´ã€‚ç›¸åï¼Œè¿™æœ‰åˆ©äºé¿å…è¢«ç§»é™¤çš„èŠ‚ç‚¹çš„æ‰°ä¹±ï¼šå¦‚æœä¸€ä¸ªleader èƒ½å¤Ÿå‘é€å¿ƒè·³ç»™é›†ç¾¤ï¼Œé‚£å®ƒå°±ä¸ä¼šè¢«æ›´å¤§çš„ä»»æœŸå·åºŸé»œã€‚</p></li></ul><blockquote><p>è¯‘è€…æ³¨ï¼š<strong>å¯¹é…ç½®å˜æ›´çš„å½’çº³</strong></p><ol type="1"><li><p>é…ç½®å˜æ›´è¿‡ç¨‹</p><ol type="1"><li><p>leader åœ¨æœ¬åœ°ç”Ÿæˆä¸€ä¸ªæ–°çš„æ—¥å¿—æ¡ç›®ï¼Œå…¶å†…å®¹æ˜¯ C<sub>old</sub> âˆªC<sub>new</sub>ï¼Œä»£è¡¨å½“å‰æ—¶åˆ»æ–°æ—§æˆå‘˜é…ç½®å…±å­˜ï¼Œå†™å…¥æœ¬åœ°æ—¥å¿—ï¼Œç§°ä¸ºC<sub>old,new</sub>ã€‚åé¢ leaderå°±ä»¥è¯¥æ—¥å¿—ä½œä¸ºè‡ªå·±çš„é…ç½®äº†ã€‚åŒæ—¶å°†è¯¥æ—¥å¿—æ¡ç›®å¤åˆ¶é›†ç¾¤ä¸­æ˜¯æ‰€æœ‰èŠ‚ç‚¹ä¸­ã€‚åœ¨æ­¤ä¹‹åæ–°çš„æ—¥å¿—åŒæ­¥éœ€è¦ä¿è¯å¾—åˆ°C<sub>old</sub> å’Œ C<sub>new</sub> ä¸¤ä¸ªå¤šæ•°æ´¾çš„ç¡®è®¤ã€‚</p><p>follower æ”¶åˆ° C<sub>old.new</sub>çš„æ—¥å¿—åæ›´æ–°æœ¬åœ°æ—¥å¿—ï¼Œå¹¶ä¸”æ­¤æ—¶å°±ä»¥è¯¥é…ç½®ä½œä¸ºè‡ªå·±çš„æˆå‘˜é…ç½®ã€‚</p><p>å¦‚æœ C<sub>old</sub> å’Œ C<sub>new</sub> ä¸­çš„ä¸¤ä¸ªå¤šæ•°æ´¾ç¡®è®¤äº†C<sub>old.new</sub> è¿™ä¸ªæ—¥å¿—æ¡ç›®ï¼Œleader å°±æäº¤å®ƒã€‚</p></li><li><p>æ¥ä¸‹æ¥ leader ç”Ÿæˆä¸€æ¡æ–°çš„æ—¥å¿—æ¡ç›®ï¼Œå…¶å†…å®¹æ˜¯æ–°æˆå‘˜é…ç½®C<sub>new</sub>ï¼ŒåŒæ ·å°†è¯¥æ—¥å¿—æ¡ç›®å†™å…¥æœ¬åœ°æ—¥å¿—ï¼ŒåŒæ—¶å¤åˆ¶ç»™é›†ç¾¤ä¸­å…¶ä»–èŠ‚ç‚¹ã€‚</p><p>follower æ”¶åˆ°æ–°æˆå‘˜é…ç½® C<sub>new</sub>åï¼Œå°†å…¶å†™å…¥æ—¥å¿—ï¼Œå¹¶ä¸”ä»æ­¤åˆ»èµ·ï¼Œå°±ä»¥è¯¥é…ç½®ä½œä¸ºè‡ªå·±çš„æˆå‘˜é…ç½®ï¼Œå¹¶ä¸”å¦‚æœå‘ç°è‡ªå·±ä¸åœ¨C<sub>new</sub> è¿™ä¸ªæˆå‘˜é…ç½®ä¸­ä¼šè‡ªåŠ¨é€€å‡ºã€‚</p><p>leader æ”¶åˆ° C<sub>new</sub>çš„å¤šæ•°æ´¾ç¡®è®¤åï¼Œè¡¨ç¤ºæˆå‘˜å˜æ›´æˆåŠŸï¼Œåç»­çš„æ—¥å¿—åªè¦å¾—åˆ° C<sub>new</sub>å¤šæ•°æ´¾ç¡®è®¤å³å¯ã€‚</p></li></ol><p>å®Œæˆä¸Šè¿°ä¸¤é˜¶æ®µåï¼Œleaderå°±å¯ä»¥ç»™å®¢æˆ·ç«¯å›å¤é…ç½®å˜æ›´æ‰§è¡ŒæˆåŠŸã€‚</p></li><li><p>å¦‚æœå½“å‰çš„ leader ä¸åœ¨ C<sub>new</sub> çš„é…ç½®ä¸­ä¼šæ€ä¹ˆæ ·ï¼Ÿ</p><p>å› ä¸ºå½“å‰ leader ä¸åœ¨ C<sub>new</sub> é…ç½®ä¸­ï¼Œæ‰€ä»¥å½“ C<sub>new</sub>æ—¥å¿—æ¡ç›®è¢«æäº¤çš„æ—¶å€™ï¼Œleader å…¶å®æ˜¯è¦è¢«ä¸‹çº¿çš„ï¼ˆæ¯”å¦‚è¯´é›†ç¾¤èŠ‚ç‚¹æ•°ä» 5ç¼©å®¹ä¸º 3ï¼Œä¸”åˆšå¥½ä¸‹çº¿çš„èŠ‚ç‚¹ä¸­åŒ…å«å½“å‰ leaderï¼‰ã€‚é‚£è¿™æ ·çš„è¯ï¼Œåœ¨C<sub>old,new</sub> çŠ¶æ€ä¸‹ï¼Œleader è¿˜æ˜¯å¯ç”¨çš„ï¼Œä½†æ˜¯ä¸€æ—¦ C<sub>new</sub>æ—¥å¿—æ¡ç›®è¢«æäº¤äº†ï¼Œleader å°±éœ€è¦ä¸‹çº¿äº†ï¼Œè¿™ä¸ªæ—¶å€™ä¸ç”¨å½“å¿ƒï¼Œå› ä¸ºC<sub>new</sub> å·²ç»è¢«å¤åˆ¶è¿‡åŠäº†ï¼Œé‡æ–°é€‰ leader ä¹Ÿä¸€å®šæ˜¯é€‰æœ‰C<sub>new</sub> çš„ã€‚</p></li><li><p>å¦‚æœåœ¨é…ç½®åˆ†å‘è¿‡ç¨‹ä¸­ leader å´©æºƒäº†æ€ä¹ˆåŠï¼Ÿ</p><p>åˆ†ä¸¤ç§æƒ…å†µï¼š</p><ol type="1"><li><p>C<sub>new</sub> å·²ç»åˆ†å‘è¿‡åŠ</p><p>é›†ç¾¤å¼€å§‹é‡æ–°é€‰ä¸¾ï¼Œæ­¤æ—¶åœ¨ C<sub>new</sub>çš„è§„åˆ™ä¸‹ï¼Œä¸å­˜åœ¨æ–°é…ç½®ä¸­çš„èŠ‚ç‚¹ä¸ä¼šèµ¢å¾—é€‰ä¸¾ï¼ˆå› ä¸ºä»–ä»¬è¦åœ¨C<sub>old,new</sub>çš„æƒ…å†µä¸‹å†³å®šï¼Œä½†æ˜¯æ‹¿ä¸åˆ° C<sub>new</sub> çš„é€‰ç¥¨ï¼‰ï¼Œåªæœ‰æ‹¿åˆ°C<sub>new</sub> çš„èŠ‚ç‚¹å¯èƒ½æˆä¸º leader å¹¶ç»§ç»­ä¸‹å‘ C<sub>new</sub>é…ç½®ï¼Œæµç¨‹æ¢å¤ã€‚</p></li><li><p>C<sub>new</sub> æ²¡æœ‰åˆ†å‘è¿‡åŠ</p><p>è¿™ç§æƒ…å†µä¸‹ï¼ŒC<sub>old,new</sub> å’Œ C<sub>new</sub> çš„èŠ‚ç‚¹éƒ½å¯ä»¥æˆä¸ºleaderï¼Œä½†æ˜¯æ— æ‰€è°“ï¼Œå› ä¸ºæ— è®ºè°æˆä¸ºleaderï¼Œéƒ½èƒ½æ ¹æ®å½“å‰çš„é…ç½®ç»§ç»­å®Œæˆåç»­æµç¨‹ï¼ˆå¦‚æœæ˜¯ C<sub>new</sub>é‚£ä¹ˆç›¸å½“ä¸å®Œæˆäº†æœ€ç»ˆçš„é…ç½®ï¼Œä¸åœ¨ C<sub>new</sub>çš„èŠ‚ç‚¹ä¼šå› ä¸ºæ²¡æœ‰å¿ƒè·³æ•°æ®è€Œå¤±æ•ˆï¼‰ã€‚</p></li></ol></li><li><p>æ—§é…ç½®èŠ‚ç‚¹ä¸‹çº¿é€ æˆçš„é—®é¢˜</p><p>Raft çš„å¤„ç†æ–¹å¼ï¼šå½“èŠ‚ç‚¹ç¡®ä¿¡æœ‰ leader å­˜åœ¨æ—¶ï¼Œä¸ä¼šè¿›è¡ŒæŠ•ç¥¨ï¼ˆåœ¨ leaderè¶…æ—¶ä¹‹å‰æ”¶åˆ°æ–°çš„æŠ•ç¥¨è¯·æ±‚æ—¶ä¸ä¼šæå‡ä»»æœŸå·å’Œåšå‡ºæŠ•ç¥¨ï¼‰ã€‚ä¸”å¼€å§‹é€‰ä¸¾ä¹‹å‰ç­‰å¾…ä¸€ä¸ªé€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼Œè¿™æ ·åœ¨æ–°leader æ­£å¸¸å·¥ä½œçš„æƒ…å†µä¸‹ï¼Œä¸ä¼šå—åˆ°æ—§èŠ‚ç‚¹çš„å½±å“ã€‚</p><p>æ—§é…ç½®èŠ‚ç‚¹åœ¨å‘èµ·é€‰ä¸¾å‰éœ€è¦ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œé‚£ä¹ˆè¿™æ®µæ—¶é—´æ–° leaderå¯ä»¥å‘é€å¿ƒè·³ï¼Œè¿™æ ·å°±å‡å°‘äº†å½±å“ã€‚ å¯¹æ­£å¸¸æµç¨‹çš„å½±å“ä¸å¤§ã€‚ï¼ˆleaderå¤±æ•ˆåè¦ç­‰ä¸€æ®µæ—¶é—´ï¼Œæ²¡æœ‰åŠæ—¶è§¦å‘ï¼Œç„¶è€Œæœ¬èº«è¿™é‡Œå°±æœ‰ä¸€ä¸ªåˆ¤æ–­å¤±æ•ˆçš„æ—¶é—´ï¼Œå¥½åƒå½±å“ä¸å¤§ï¼›æ¯”å¦‚åŸå…ˆè¶…æ—¶æ—¶é—´æ˜¯10sï¼Œé‚£ä¹ˆå¦‚æœè®¾ç½®æˆ 5sï¼ŒåŸç­–ç•¥ä¸‹ 10s è¶…æ—¶å°±æ˜¯ 10s åå¼€å§‹é€‰ä¸¾ï¼Œæ–°ç­–ç•¥ä¸‹5s è¶…æ—¶å°±æ˜¯è¶…æ—¶åå†ç­‰ 5s å†å¼€å§‹é€‰ä¸¾ï¼Œå½±å“å°±æ˜¯è¶…æ—¶æ—¶é—´å˜çŸ­ï¼‰</p></li><li><p>æ— æ•°æ®çš„æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ä¸­çš„é—®é¢˜</p><p>æ–°åŠ å…¥çš„èŠ‚ç‚¹éœ€è¦æ—¶é—´å¤åˆ¶æ•°æ®ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹å®Œæˆä¹‹å‰ï¼ŒRafté‡‡ç”¨ä»¥ä¸‹æœºåˆ¶æ¥ä¿è¯å¯ç”¨æ€§ï¼š æ–°åŠ å…¥èŠ‚ç‚¹æ²¡æœ‰æŠ•ç¥¨æƒï¼ˆ leaderå¤åˆ¶æ—¥å¿—ç»™ä»–ä»¬ï¼Œä½†è®¡ç®—å·²å¤åˆ¶æ—¥å¿—æ¡ç›®çš„å‰¯æœ¬æ•°çš„æ—¶å€™ä¸è€ƒè™‘å®ƒä»¬ï¼‰ï¼Œç›´åˆ°è¿™äº›èŠ‚ç‚¹çš„æ—¥å¿—è¿½ä¸Šå…¶ä»–èŠ‚ç‚¹ã€‚</p></li><li><p>å¦‚æœåœ¨é…ç½®å˜æ›´è¿‡ç¨‹ä¸­æ¥æ”¶åˆ°ç”¨æˆ·è¯·æ±‚çš„è¯ï¼Œæ˜¯ç”¨æ—§é…ç½®å“åº”è¿˜æ˜¯ç”¨æ–°é…ç½®å“åº”ï¼Ÿ</p><p><strong>æŒ‰ç…§ç¬”è€…çš„ç†è§£ï¼Œè¿™ä¸ªæ–¹é¢ï¼Œå¯¹ Raftåè®®çš„å…·ä½“å®ç°å¯ä»¥æ ¹æ®è‡ªèº«éœ€æ±‚æ¥è‡ªå®šä¹‰å®ç°ï¼ŒRaftçš„è”åˆå…±è¯†æ˜¯ä¸ºäº†é¿å…åŒä¸€æ—¶åˆ»å‡ºç°äº† 2 ä¸ªleaderï¼Œé¿å…äº†å¯¹å®¢æˆ·ç«¯çš„ä¸€ä¸ªè¯·æ±‚åŒæ—¶æœ‰ä¸¤ä¸ªä¸åŒçš„å“åº”å‡ºç°ã€‚è€Œåœ¨å…·ä½“å®ç°ä¸­ï¼Œåœ¨æŸä¸ªé˜¶æ®µï¼Œç©¶ç«Ÿæ˜¯é‡‡å–æ–°é…ç½®å“åº”è¿˜æ˜¯æ—§é…ç½®å“åº”ï¼Œå¯ä»¥å†æ–Ÿé…Œã€‚</strong></p><p>æ¯”å¦‚è¯´å¯ä»¥è¿™æ ·ï¼š</p><ol type="1"><li>C<sub>old</sub> é˜¶æ®µï¼šä½¿ç”¨æ—§é…ç½®ï¼Œéœ€è¦è¿‡åŠæ—§é…ç½®èŠ‚ç‚¹ç¡®è®¤</li><li>C<sub>new</sub> å·²æäº¤é˜¶æ®µï¼šä½¿ç”¨æ–°é…ç½®ï¼Œéœ€è¦è¿‡åŠæ–°é…ç½®èŠ‚ç‚¹ç¡®è®¤</li><li>C<sub>old,new</sub>é˜¶æ®µï¼šé…ç½®ä¿¡æ¯ä¸­æœ‰èŠ‚ç‚¹æ•°é‡ï¼ˆè¿™æ ·æ‰å¯èƒ½åˆ¤æ–­æ˜¯å¦è¿‡åŠï¼‰ï¼Œè¿™ä¸ªæ—¶å€™æ–°æ—§é…ç½®éƒ½éœ€è¦è¿‡åŠèŠ‚ç‚¹ç¡®è®¤ï¼Œè€Œå“åº”æ–°é…ç½®æ‰§è¡Œçš„ç»“æœè¿˜æ˜¯å“åº”æ—§é…ç½®æ‰§è¡Œçš„ç»“æœï¼Œå°±çœ‹old å¤šè¿˜æ˜¯ new å¤šï¼Œè°å¤šç”¨è°ã€‚</li></ol></li><li><p>å¦‚æœ leader è¦ä¸‹çº¿ï¼Œå®¢æˆ·ç«¯å‘æ¥çš„æ–°çš„è¯·æ±‚å¦‚ä½•å¤„ç†ï¼Ÿ</p><ol type="1"><li>å¦‚æœæ˜¯åœ¨ leader å¤åˆ¶ C<sub>new</sub> ä¹‹åï¼Œæäº¤ C<sub>new</sub>ä¹‹å‰çš„è¯ï¼Œleaderå·¥ä½œåœ¨æ–°çš„é›†ç¾¤é…ç½®ä¸‹ï¼Œæ‰€ä»¥ä¼šå°†æ—¥å¿—å¤åˆ¶åˆ°æ–°é›†ç¾¤çš„èŠ‚ç‚¹ä¸‹ï¼Œå½“æ”¶åˆ°æ–°é›†ç¾¤ï¼ˆä¸åŒ…å«leader æœ¬èº«ï¼‰è¶…è¿‡åŠæ•°èŠ‚ç‚¹ç¡®è®¤åï¼Œå°±å¯ä»¥æäº¤æ—¥å¿—ã€‚</li><li>åœ¨å…¶ä»–é˜¶æ®µï¼Œleader å°±æ˜¯æ­£å¸¸å¯ç”¨çš„ã€‚</li></ol></li><li><p>æ‰€è°“ C<sub>new</sub> å’Œ C<sub>old,new</sub>æ—¥å¿—æ¡ç›®ï¼Œé‡Œé¢æ²¡æœ‰æ•°æ®ï¼Œåªæœ‰æŒ‡ä»¤ï¼Œé‡Œé¢çš„æŒ‡ä»¤å°±æ˜¯è®©èŠ‚ç‚¹æ‰§è¡Œå¯¹åº”çš„é…ç½®é¡¹ã€‚</p></li></ol></blockquote><h2 id="æ—¥å¿—å‹ç¼©">7. æ—¥å¿—å‹ç¼©</h2><p>åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼ŒRaftçš„æ—¥å¿—ä¼šéšç€å®¢æˆ·ç«¯è¯·æ±‚çš„å¢åŠ è€Œä¸æ–­å¢é•¿ã€‚ä½†åœ¨å®é™…ç³»ç»Ÿä¸­ï¼Œæ—¥å¿—ä¸å¯èƒ½æ— é™åˆ¶åœ°å¢é•¿ã€‚éšç€æ—¥å¿—è¶Šæ¥è¶Šé•¿ï¼Œå®ƒä¼šå ç”¨è¶Šæ¥è¶Šå¤šçš„ç©ºé—´ï¼Œå¹¶ä¸”éœ€è¦èŠ±æ›´å¤šçš„æ—¶é—´æ¥é‡æ–°æ‰§è¡Œæ—¥å¿—ä¸­çš„æ—¥å¿—æ¡ç›®ã€‚å¦‚æœæ²¡æœ‰ä¸€å®šçš„æœºåˆ¶æ¥æ¸…é™¤æ—¥å¿—ä¸­ç§¯ç´¯çš„è¿‡æœŸçš„ä¿¡æ¯ï¼Œé‚£ä¹ˆæœ€ç»ˆä¸€å®šä¼šå½±å“ç³»ç»Ÿçš„å¯ç”¨æ€§ã€‚</p><p><strong>å¿«ç…§æŠ€æœ¯ï¼ˆsnapshottingï¼‰</strong>æ˜¯æ—¥å¿—å‹ç¼©æœ€ç®€å•çš„æ–¹æ³•ã€‚åœ¨å¿«ç…§æŠ€æœ¯ä¸­ï¼ŒæŸä¸ªæ—¶é—´ç‚¹ä¸‹çš„å‰æ•´ä¸ªç³»ç»Ÿçš„çŠ¶æ€éƒ½ä¼šä»¥å¿«ç…§çš„å½¢å¼æŒä¹…åŒ–èµ·æ¥ï¼Œç„¶åè¯¥æ—¶é—´ç‚¹ä¹‹å‰çš„æ—¥å¿—ä¼šè¢«å…¨éƒ¨ä¸¢å¼ƒã€‚å¿«ç…§æŠ€æœ¯å‘—ä½¿ç”¨åœ¨Chubby å’Œ ZooKeeper å½“ä¸­ï¼Œæ¥ä¸‹æ¥çš„ç« èŠ‚ä¼šä»‹ç» Raft ä¸­çš„å¿«ç…§æŠ€æœ¯ã€‚</p><p><strong>å¢é‡å‹ç¼©æ–¹æ³•ï¼ˆIncremental approach tocompactionï¼‰</strong>ï¼Œä¾‹å¦‚<strong>æ—¥å¿—æ¸…æ´—ï¼ˆlog cleaningï¼‰</strong>[36]å’Œ<strong>æ—¥å¿—ç»“æ„åˆå¹¶æ ‘ï¼ˆlog-structured merge treesï¼‰</strong>[30,5]ï¼Œéƒ½æ˜¯å¯è¡Œçš„ã€‚è¿™äº›æ–¹æ³•æ¯æ¬¡åªå¯¹ä¸€å°éƒ¨åˆ†æ•°æ®è¿›è¡Œæ“ä½œï¼Œè¿™æ ·å°±åˆ†æ•£äº†å‹ç¼©çš„è´Ÿè½½å‹åŠ›ã€‚é¦–å…ˆï¼Œé€‰æ‹©ä¸€ä¸ªç§¯ç´¯äº†å¤§é‡è¢«åˆ é™¤æˆ–è¢«è¦†ç›–çš„å¯¹è±¡çš„æ•°æ®åŒºåŸŸï¼Œç„¶åé‡å†™è¯¥åŒºåŸŸå†…è¿˜æ´»ç€çš„å¯¹è±¡ï¼Œä¹‹åé‡Šæ”¾è¯¥åŒºåŸŸã€‚å’Œå¿«ç…§æŠ€æœ¯ç›¸æ¯”ï¼Œè¿™éœ€è¦å¤§é‡é¢å¤–çš„æœºåˆ¶ï¼Œå¹¶ä¸”å¢åŠ äº†æ›´å¤šçš„å¤æ‚æ€§ï¼Œå¿«ç…§æŠ€æœ¯é€šè¿‡æ“ä½œæ•´ä¸ªæ•°æ®é›†æ¥ç®€åŒ–é—®é¢˜ã€‚è™½ç„¶æ—¥å¿—æ¸…ç†éœ€è¦å¯¹Raft è¿›è¡Œä¿®æ”¹ï¼Œä½†æ˜¯çŠ¶æ€æœºå¯ä»¥ä½¿ç”¨ä¸å¿«ç…§æŠ€æœ¯ç›¸åŒçš„æ¥å£æ¥å®ç°LSMï¼ˆæ—¥å¿—ç»“æ„åˆå¹¶ï¼‰ æ ‘ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/008i3skNly1gshvublij8j321s0lsadj.jpg"alt="image-20210715195808192" /><figcaption aria-hidden="true">image-20210715195808192</figcaption></figure><p>å›¾ 12 å±•ç¤ºäº† Raftå¿«ç…§æŠ€æœ¯çš„åŸºæœ¬æ€æƒ³ã€‚æ¯ä¸€ä¸ªèŠ‚ç‚¹ç‹¬ç«‹åœ°ç”Ÿæˆå¿«ç…§ï¼Œå¿«ç…§ä¸­åªåŒ…å«è‡ªå·±æ—¥å¿—ä¸­å·²ç»è¢«æäº¤çš„æ¡ç›®ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸»è¦çš„å·¥ä½œæ˜¯çŠ¶æ€æœºå°†è‡ªå·±çš„çŠ¶æ€å†™å…¥å¿«ç…§ä¸­ã€‚Raftåœ¨å¿«ç…§ä¸­è¿˜ä¿ç•™äº†å°‘é‡çš„å…ƒæ•°æ®ï¼š</p><ul><li>last includedindexï¼šæŒ‡çš„æ˜¯æœ€åä¸€ä¸ªè¢«å¿«ç…§å–ä»£çš„æ—¥å¿—æ¡ç›®çš„ç´¢å¼•å€¼ï¼ˆçŠ¶æ€æœºæœ€ååº”ç”¨çš„æ—¥å¿—æ¡ç›®ï¼‰</li><li>last included termï¼šæŒ‡çš„æ˜¯è¯¥æ¡ç›®æ‰€å¤„çš„ä»»æœŸå·</li></ul><p>ä¿ç•™è¿™äº›å…ƒæ•°æ®æ˜¯ä¸ºäº†æ”¯æŒå¿«ç…§åç¬¬ä¸€ä¸ªæ¡ç›®çš„ AppendEntriesä¸€è‡´æ€§æ£€æŸ¥ï¼Œå› ä¸ºè¯¥æ¡ç›®éœ€è¦ä¸€ä¸ªä¹‹å‰çš„æ—¥å¿—ç´¢å¼•å’Œä»»æœŸå·ã€‚ä¸ºäº†æ”¯æŒé›†ç¾¤æˆå‘˜å˜æ›´ï¼ˆç¬¬6 èŠ‚ä¸­è®¨è®ºçš„ï¼‰ï¼Œå¿«ç…§ä¸­è¿˜åŒ…å«æ—¥å¿—ä¸­åˆ° last included indexä¸ºæ­¢çš„æœ€æ–°çš„é…ç½®ã€‚ä¸€æ—¦èŠ‚ç‚¹å®Œæˆäº†å¿«ç…§çš„å†™å…¥ï¼Œå®ƒå¯èƒ½å°±ä¼šåˆ é™¤ last includedindex åŠä¹‹å‰çš„æ‰€æœ‰æ—¥å¿—æ¡ç›®ï¼Œä»¥åŠä¹‹å‰çš„å¿«ç…§ã€‚</p><p>å°½ç®¡é€šå¸¸æƒ…å†µä¸‹ï¼ŒèŠ‚ç‚¹éƒ½æ˜¯ç‹¬ç«‹ç”Ÿæˆå¿«ç…§çš„ï¼Œä½†æ˜¯ leaderä¸å¯é¿å…å¶å°”éœ€è¦å‘é€å¿«ç…§ç»™ä¸€äº›è½åçš„ followerã€‚è¿™é€šå¸¸å‘ç”Ÿåœ¨ leaderå·²ç»ä¸¢å¼ƒäº†éœ€è¦å‘ç»™ followerçš„ä¸‹ä¸€æ¡æ—¥å¿—æ¡ç›®çš„æ—¶å€™ã€‚å¹¸è¿çš„æ˜¯ï¼Œè¿™ç§æƒ…å†µåœ¨æ­£å¸¸æ“ä½œä¸­æ˜¯ä¸ä¼šå‡ºç°çš„ï¼šä¸€ä¸ªä¸leader ä¿æŒåŒæ­¥çš„ follower é€šå¸¸éƒ½ä¼šæ‹¥æœ‰è¯¥æ—¥å¿—æ¡ç›®ã€‚ä¸è¿‡å¦‚æœä¸€ä¸ª followerè¿è¡Œæ¯”è¾ƒç¼“æ…¢ï¼Œæˆ–è€…æ˜¯å®ƒåˆšåŠ å…¥é›†ç¾¤ï¼Œé‚£ä¹ˆå®ƒå°±å¯èƒ½ä¼šæ²¡æœ‰è¯¥æ—¥å¿—æ¡ç›®ã€‚è¿™ä¸ªæ—¶å€™leader ä¼šé€šè¿‡ç½‘ç»œå°†è¯¥å¿«ç…§å‘é€ç»™è¯¥ followerï¼Œä»¥ä½¿å¾—è¯¥ followerå¯ä»¥æ›´æ–°åˆ°æœ€æ–°çš„çŠ¶æ€ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/008i3skNly1gshxf2bjwej31gg0u0k01.jpg"alt="image-20210715205247442" /><figcaption aria-hidden="true">image-20210715205247442</figcaption></figure><p>è¿™ä¸ªæ—¶å€™ leader ä½¿ç”¨äº†ä¸€ç§æ–°çš„ RPC æ¥å‘é€å¿«ç…§ç»™é‚£äº›å¤ªè½åçš„followersï¼Œå¦‚å›¾ 13 æ‰€ç¤ºï¼Œè¿™ç§ RPC å«åš<strong>InstallSnapshot</strong>ã€‚å½“ä¸€ä¸ª follower é€šè¿‡è¿™ç§ RPCæ”¶åˆ°å¿«ç…§çš„æ—¶å€™ï¼Œå®ƒå¿…é¡»å†³å®šå¦‚ä½•å¤„ç†å½“å‰å·²ç»å­˜åœ¨çš„æ—¥å¿—æ¡ç›®ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œè¿™ä»½å¿«ç…§ä¼šåŒ…å«æ¥å—è€…æ—¥å¿—è€…æ²¡æœ‰çš„ä¿¡æ¯ã€‚æ‰€ä»¥è¿™ç§æƒ…å†µä¸‹followerä¼šä¸¢å¼ƒå®ƒçš„æ•´ä¸ªæ—¥å¿—ï¼Œå®ƒçš„æ—¥å¿—ä¼šå…¨éƒ¨è¢«å¿«ç…§å–ä»£ï¼Œå¹¶ä¸”å¯èƒ½æœ‰ä¸å¿«ç…§å†²çªçš„æœªæäº¤çš„æ¡ç›®ã€‚ç›¸åï¼Œå¦‚æœä¸€ä¸ªfolloweræ”¶åˆ°ä¸€ä¸ªæè¿°å…¶æ—¥å¿—å‰ç¼€çš„å¿«ç…§ï¼ˆå¯èƒ½æ˜¯ç”±äºé‡ä¼ æˆ–é”™è¯¯ï¼‰ï¼Œåˆ™è¢«å¿«ç…§è¦†ç›–çš„æ—¥å¿—æ¡ç›®å°†è¢«åˆ é™¤ï¼Œä½†æ˜¯å¿«ç…§ä¹‹åçš„æ¡ç›®ä»ç„¶æœ‰æ•ˆï¼Œä¸”å¿…é¡»è¦ä¿ç•™ã€‚</p><p>è¿™ç§å¿«ç…§çš„æ–¹å¼è¿åäº† Raft çš„ strong leader åŸåˆ™ï¼Œå› ä¸º followerå¯èƒ½åœ¨ä¸çŸ¥é“ leaderçš„æƒ…å†µä¸‹åˆ›å»ºå¿«ç…§ã€‚ä½†æ˜¯æˆ‘ä»¬è®¤ä¸ºè¿™ç§è¿èƒŒæ˜¯åˆä¹æƒ…ç†çš„ã€‚leaderçš„å­˜åœ¨ï¼Œæ˜¯ä¸ºäº†é˜²æ­¢åœ¨è¾¾æˆå…±è¯†çš„æ—¶å€™äº§ç”Ÿå†²çªï¼Œä½†æ˜¯åœ¨åˆ›å»ºå¿«ç…§çš„æ—¶å€™ï¼Œå…±è¯†å·²ç»è¾¾æˆäº†ï¼Œå› æ­¤æ²¡æœ‰å†³ç­–ä¼šå‡ºç°å†²çªã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæ•°æ®è¿˜æ˜¯è·Ÿä¹‹å‰ä¸€æ ·ï¼Œåªèƒ½ä»leader æµå‘ followerï¼Œåªä¸è¿‡ç°åœ¨å…è®¸ followerå¯ä»¥é‡æ–°ç»„ç»‡å®ƒä»¬çš„æ•°ç»„è€Œå·²ã€‚</p><p>æˆ‘ä»¬æ›¾ç»è€ƒè™‘è¿‡ä¸€ç§å¯æ›¿ä»£çš„æ–¹æ¡ˆï¼Œé‚£å°±æ˜¯åªæœ‰ leaderå¯ä»¥åˆ›å»ºå¿«ç…§ï¼Œç„¶åç”± leader å°†è¿™ä»½å¿«ç…§å‘é€ç»™å…¶ä»–æ‰€æœ‰çš„followerã€‚ä½†æ˜¯ï¼Œè¿™ç§æ–¹æ¡ˆæœ‰ä¸¤ä¸ªç¼ºç‚¹ï¼š</p><ol type="1"><li>å‘é€å¿«ç…§ç»™æ¯ä¸ª followerä¼šæµªè´¹ç½‘ç»œå¸¦å®½å’Œå»¶ç¼“äº†å¿«ç…§å¤„ç†è¿‡ç¨‹ã€‚å®é™…ä¸Šæ¯ä¸€ä¸ª followerå·²ç»æ‹¥æœ‰äº†åˆ›å»ºè‡ªå·±å¿«ç…§æ‰€éœ€è¦çš„å…¨éƒ¨ä¿¡æ¯äº†ï¼Œæ‰€ä»¥å¾ˆæ˜¾ç„¶ï¼Œfolloweræ ¹æ®æœ¬åœ°çš„çŠ¶æ€åˆ›å»ºå¿«ç…§è¦æ¯”é€šè¿‡ç½‘ç»œæ¥æ¥æ”¶åˆ«äººå‘è¿‡æ¥çš„è¦æ›´åŠ å®æƒ ã€‚</li><li>è¿™ä¼šé€ æˆ leader çš„å®ç°æ›´åŠ å¤æ‚ã€‚æ¯”å¦‚è¯´ï¼Œleader å‘é€å¿«ç…§ç»™ followerçš„åŒæ—¶è¦èƒ½å¤Ÿåšåˆ°å¹¶è¡Œåœ°å°†æ–°çš„æ—¥å¿—æ¡ç›®å‘é€ç»™å®ƒä»¬ï¼Œè¿™æ ·æ‰ä¸ä¼šé˜»å¡æ–°çš„å®¢æˆ·ç«¯è¯·æ±‚ï¼Œè¿™å°±å¤æ‚å¾—å¤šäº†ã€‚</li></ol><p>è¿˜æœ‰ä¸¤ä¸ªé—®é¢˜ä¼šå½±å“å¿«ç…§çš„æ€§èƒ½ï¼š</p><ol type="1"><li><p>æ¯ä¸€ä¸ªèŠ‚ç‚¹å¿…é¡»åˆ¤æ–­ä½•æ—¶å»ç”Ÿæˆå¿«ç…§ã€‚å¦‚æœä¸€ä¸ªèŠ‚ç‚¹ç”Ÿæˆå¿«ç…§çš„é¢‘ç‡å¤ªé«˜ï¼Œé‚£ä¹ˆå°±ä¼šæµªè´¹å¤§é‡çš„ç£ç›˜å¸¦å®½å’Œå…¶ä»–èµ„æºï¼›å¦‚æœä¸€ä¸ªèŠ‚ç‚¹ç”Ÿæˆå¿«ç…§çš„é¢‘ç‡å¤ªä½ï¼Œé‚£ä¹ˆå°±è¦æ‰¿æ‹…è€—å°½å­˜å‚¨å®¹é‡çš„é£é™©ï¼ŒåŒæ—¶ä¹Ÿå¢åŠ äº†é‡å¯æ—¶é‡æ–°æ‰§è¡Œæ—¥å¿—çš„æ—¶é—´ã€‚</p><p>ä¸€ä¸ªç®€å•çš„ç­–ç•¥å°±æ˜¯å½“æ—¥å¿—å¤§å°è¾¾åˆ°ä¸€ä¸ªå›ºå®šçš„é˜ˆå€¼çš„æ—¶å€™å°±ç”Ÿæˆä¸€ä»½å¿«ç…§ã€‚å¦‚æœè¿™ä¸ªé˜ˆå€¼è®¾ç½®å¾—æ˜¾è‘—å¤§äºæœŸæœ›çš„å¿«ç…§çš„å¤§å°ï¼Œé‚£ä¹ˆå¿«ç…§çš„ç£ç›˜å¸¦å®½å¼€é”€å°†è¾ƒå°ã€‚</p></li><li><p>ç¬¬äºŒä¸ªå½±å“æ€§èƒ½çš„å°±æ˜¯å†™å¿«ç…§éœ€è¦èŠ±è´¹ä¸€å®šçš„æ—¶é—´ï¼Œè€Œæˆ‘ä»¬åˆä¸å¸Œæœ›å®ƒä¼šå½±å“åˆ°æ­£å¸¸çš„æ“ä½œã€‚</p><p>è§£å†³æ–¹æ¡ˆå°±æ˜¯ä½¿ç”¨ <strong>å†™æ—¶å¤åˆ¶çš„æŠ€æœ¯ï¼ˆcopy-on-writeï¼‰</strong>ï¼Œè¿™æ ·æ–°çš„æ›´æ–°å°±å¯ä»¥åœ¨ä¸å½±å“æ­£åœ¨å†™çš„å¿«ç…§çš„æƒ…å†µä¸‹è¢«æ¥æ”¶ã€‚ä¾‹å¦‚ï¼Œå…·æœ‰æ³›å‹å‡½æ•°ç»“æ„çš„çŠ¶æ€æœºå¤©ç„¶æ”¯æŒè¿™æ ·çš„åŠŸèƒ½ã€‚å¦å¤–ï¼Œæ“ä½œç³»ç»Ÿå¯¹å†™æ—¶å¤åˆ¶æŠ€æœ¯çš„æ”¯æŒï¼ˆå¦‚Linux ä¸Šçš„forkï¼‰å¯ä»¥è¢«ç”¨æ¥åˆ›å»ºæ•´ä¸ªçŠ¶æ€æœºçš„å†…å­˜å¿«ç…§ï¼ˆæˆ‘ä»¬çš„å®ç°ç”¨çš„å°±æ˜¯è¿™ç§æ–¹æ³•ï¼‰ã€‚</p></li></ol><h2 id="å®¢æˆ·ç«¯äº¤äº’">8. å®¢æˆ·ç«¯äº¤äº’</h2><p>æœ¬èŠ‚ä»‹ç»å®¢æˆ·ç«¯å¦‚ä½•å’Œ Raft è¿›è¡Œäº¤äº’ï¼ŒåŒ…æ‹¬å®¢æˆ·ç«¯å¦‚ä½•æ‰¾åˆ° leader å’Œ Raftæ˜¯å¦‚ä½•æ”¯æŒçº¿æ€§åŒ–è¯­ä¹‰çš„[10]ã€‚è¿™äº›é—®é¢˜å¯¹äºæ‰€æœ‰çš„åŸºäºå…±è¯†ç®—æ³•çš„ç³»ç»Ÿéƒ½æ˜¯å­˜åœ¨çš„ï¼ŒRaftçš„è§£å†³æ–¹æ¡ˆä¹Ÿè·Ÿå…¶ä»–çš„ç³»ç»Ÿå·®ä¸å¤šã€‚</p><p>Raft çš„å®¢æˆ·ç«¯ä»¬å°†æ‰€æœ‰çš„è¯·æ±‚å‘é€ç»™leaderã€‚å½“å®¢æˆ·ç«¯ç¬¬ä¸€æ¬¡å¯åŠ¨çš„æ—¶å€™ï¼Œå®ƒä¼šéšæœºæŒ‘é€‰ä¸€ä¸ªèŠ‚ç‚¹æ¥è¿›è¡Œé€šä¿¡ã€‚å¦‚æœå®¢æˆ·ç«¯é¦–é€‰çš„ä¸æ˜¯leaderï¼Œé‚£ä¹ˆè¢«å®¢æˆ·ç«¯é€‰ä¸­çš„èŠ‚ç‚¹å°±ä¼šæ‹’ç»å®¢æˆ·ç«¯çš„è¯·æ±‚å¹¶ä¸”æä¾›å…³äºå®ƒæœ€è¿‘æ”¶åˆ°çš„leader çš„ä¿¡æ¯ï¼ˆAppendEntries RPC åŒ…å«äº† leader çš„ç½‘ç»œåœ°å€ï¼‰ã€‚å¦‚æœ leaderå´©æºƒäº†ï¼Œå®¢æˆ·ç«¯è¯·æ±‚å°±ä¼šè¶…æ—¶ï¼Œè¿™ä¸ªæ—¶å€™å®¢æˆ·ç«¯éœ€è¦éšæœºé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹æ¥é‡è¯•å‘é€è¯·æ±‚ã€‚</p><p>æˆ‘ä»¬å¯¹ Raftçš„æœŸè®¸æ˜¯å¸Œæœ›å®ƒå¯ä»¥å®ç°çº¿æ€§åŒ–è¯­ä¹‰ï¼ˆå³æ¯æ¬¡æ“ä½œçœ‹èµ·æ¥ä¼¼ä¹éƒ½æ˜¯åœ¨è°ƒç”¨å’Œå“åº”ä¹‹é—´çš„æŸä¸ªç‚¹ä¸Šå³æ—¶æ‰§è¡Œä¸€æ¬¡ï¼‰ã€‚ä½†æ˜¯ï¼ŒæŒ‰ç…§ä¸Šé¢æè¿°çš„ï¼ŒRaftå¯èƒ½ä¼šå¯¹åŒä¸€æ¡æŒ‡ä»¤æ‰§è¡Œå¤šæ¬¡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ leaderåœ¨æäº¤äº†æŸä¸ªæ—¥å¿—æ¡ç›®åï¼Œåœ¨è¿˜æ²¡æ¥å¾—åŠå“åº”å®¢æˆ·ç«¯çš„æ—¶å€™å°±å´©æºƒäº†ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯ä¼šå’Œæ–°çš„leaderé‡è¯•è¯¥æŒ‡ä»¤ï¼Œè¿™å°±é€ æˆäº†åŒä¸€æŒ‡ä»¤è¢«æ‰§è¡Œäº†ä¸¤æ¬¡ã€‚è§£å†³æ–¹æ¡ˆæ˜¯å®¢æˆ·ç«¯å¯¹äºæ¯ä¸€æ¡æŒ‡ä»¤éƒ½èµ‹äºˆä¸€ä¸ªå”¯ä¸€çš„åºåˆ—å·ã€‚ç„¶åï¼ŒçŠ¶æ€æœºè·Ÿè¸ªæ¯ä¸ªå®¢æˆ·ç«¯å·²ç»å¤„ç†çš„æœ€æ–°çš„åºåˆ—å·ä»¥åŠç›¸å…³è”çš„å“åº”ã€‚å¦‚æœçŠ¶æ€æœºæ¥æ”¶åˆ°äº†ä¸€æ¡å·²ç»æ‰§è¡Œè¿‡çš„æŒ‡ä»¤äº†ï¼Œå°±ç«‹å³ä½œå‡ºå“åº”ï¼Œå¹¶ä¸”ä¸ä¼šé‡å¤æ‰§è¡Œè¯¥æŒ‡ä»¤ã€‚</p><p>åªè¯»æ“ä½œï¼ˆRead-Onlyï¼‰å¯ä»¥ç›´æ¥å¤„ç†è€Œä¸è®°å½•æ—¥å¿—ã€‚ä½†æ˜¯ï¼Œå¦‚æœä¸é‡‡å–ä»»ä½•æªæ–½çš„è¯ï¼Œè¿™å¯èƒ½ä¼šæœ‰è¿”å›è¿‡æœŸæ•°æ®ï¼ˆstaledataï¼‰çš„é£é™©ã€‚<strong>å› ä¸º leader å“åº”å®¢æˆ·ç«¯è¯·æ±‚çš„æ—¶å€™å®ƒå¯èƒ½å·²ç»è¢«æ–°çš„leader ä»£æ›¿äº†ï¼Œä½†æ˜¯å®ƒè¿˜ä¸çŸ¥é“è‡ªå·±å·²ç»ä¸æ˜¯æœ€æ–°çš„ leader äº†ã€‚</strong></p><blockquote><p>è¯‘è€…è¡¥å……ï¼š<strong>ä¸ºä»€ä¹ˆä¸€ä¸ª leader å¥½å¥½çš„ä¼šæœ‰å¦å¤–ä¸€ä¸ª leaderå‡ºç°ï¼Ÿ</strong></p><p>å‚è€ƒï¼šhttps://segmentfault.com/a/1190000039264427</p><p>å®é™…ä¸Šï¼Œè€çš„ leader å¯èƒ½ä¸ä¼šé©¬ä¸Šæ¶ˆå¤±ï¼Œä¾‹å¦‚ï¼šç½‘ç»œåˆ†åŒºå°† leaderä¸é›†ç¾¤çš„å…¶ä½™éƒ¨åˆ†åˆ†éš”ï¼Œå…¶ä½™éƒ¨åˆ†é€‰ä¸¾å‡ºäº†ä¸€ä¸ªæ–°çš„ leaderã€‚ç„¶åè€çš„ leaderå´©æºƒåé‡æ–°è¿æ¥ï¼Œå¯èƒ½ä¼šä¸çŸ¥é“æ–°çš„ leader å·²ç»è¢«é€‰å‡ºæ¥äº†ã€‚</p></blockquote><p>çº¿æ€§åŒ–çš„æ“ä½œè‚¯å®šä¸ä¼šè¿”å›è¿‡æœŸçš„æ•°æ®ã€‚Raftéœ€è¦ä½¿ç”¨ä¸¤ä¸ªé¢å¤–çš„é¢„é˜²æªæ–½æ¥åœ¨ä¸é€‚ç”¨æ—¥å¿—çš„æ—¶å€™ä¿è¯è¿™ä¸€ç‚¹ã€‚</p><ol type="1"><li><p>leader å¿…é¡»æ‹¥æœ‰é‚£äº›å·²æäº¤çš„æ—¥å¿—æ¡ç›®çš„æœ€æ–°ä¿¡æ¯ã€‚Leaderå®Œæ•´æ€§ç‰¹æ€§ï¼ˆLeader Completeness Propertyï¼‰ä¿è¯äº† leaderä¸€å®šæ‹¥æœ‰æ‰€æœ‰å·²è¢«æäº¤çš„æ—¥å¿—æ¡ç›®ï¼Œä½†æ˜¯åœ¨å®ƒä»»æœŸåˆšå¼€å§‹çš„æ—¶å€™ï¼Œå®ƒå¯èƒ½è¿˜ä¸çŸ¥é“å“ªäº›æ˜¯å·²ç»è¢«æäº¤çš„ã€‚ä¸ºäº†çŸ¥é“è¿™äº›ä¿¡æ¯ï¼Œå®ƒéœ€è¦åœ¨å®ƒçš„ä»»æœŸé‡Œæäº¤ä¸€ä¸ªæ—¥å¿—æ¡ç›®ã€‚</p><p><strong>Raft é€šè¿‡è®© leaderåœ¨ä»»æœŸå¼€å§‹çš„æ—¶å€™æäº¤ä¸€ä¸ªç©ºçš„æ—¥å¿—æ¡ç›®åˆ°æ—¥å¿—ä¸­æ¥è§£å†³è¯¥é—®é¢˜</strong>ã€‚ï¼ˆè¯‘è€…æ³¨ï¼šè¿™å°±æ˜¯å‰é¢5.4.2 èŠ‚æåˆ°çš„ no-op æ—¥å¿—ï¼‰</p></li><li><p>leaderåœ¨å¤„ç†åªè¯»è¯·æ±‚çš„æ—¶å€™å¿…é¡»æ£€æŸ¥è‡ªå·±æ˜¯å¦å·²ç»è¢«æ›¿ä»£äº†ï¼ˆå› ä¸ºå¦‚æœä¸€ä¸ªæ–° leaderè¢«é€‰å‡ºæ¥äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—§ leader çš„æ•°æ®å¯èƒ½å°±è¿‡æ—¶äº†ï¼‰ã€‚</p><p>Raft é€šè¿‡è®© leaderåœ¨å“åº”åªè¯»è¯·æ±‚ä¹‹å‰ï¼Œå…ˆå’Œé›†ç¾¤ä¸­è¿‡åŠçš„èŠ‚ç‚¹äº¤æ¢ä¸€æ¬¡å¿ƒè·³ä¿¡æ¯æ¥è§£å†³è¯¥é—®é¢˜ã€‚</p><p>å¦ä¸€ç§å¯é€‰çš„æ–¹æ¡ˆï¼Œleader å¯ä»¥ä¾èµ–å¿ƒè·³æœºåˆ¶æ¥å®ç°ä¸€ç§ç§Ÿçº¦çš„å½¢å¼[9]ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼çš„å®‰å…¨æ€§éœ€è¦ä¾èµ–äºæ—¶åºï¼ˆå‡è®¾æ—¶é—´è¯¯å·®æ˜¯æœ‰ç•Œçš„ï¼‰ã€‚</p></li></ol><h2 id="ç®—æ³•å®ç°ä¸è¯„ä¼°">9. ç®—æ³•å®ç°ä¸è¯„ä¼°</h2><p>æˆ‘ä»¬å·²ç»å®ç°äº† Raft ä½œä¸ºå¤åˆ¶çŠ¶æ€æœºçš„ä¸€éƒ¨åˆ†ï¼Œè¯¥çŠ¶æ€æœºå­˜å‚¨äº† RAMCloud[33] çš„é…ç½®ä¿¡æ¯ï¼Œå¹¶å¸®åŠ© RAMCloud åè°ƒå™¨è¿›è¡Œæ•…éšœè½¬ç§»ã€‚è¿™ä¸ª Raftå®ç°å¤§æ¦‚åŒ…å«äº† 2000+ è¡Œ C++ä»£ç ï¼Œä½†æ˜¯è¿™é‡Œé¢æ²¡æœ‰åŒ…å«æµ‹è¯•ã€æ³¨é‡Šå’Œç©ºè¡Œã€‚è¿™äº›ä»£ç æ˜¯å¼€æºçš„[23]ã€‚åŒæ—¶ä¹Ÿæœ‰å¤§çº¦ 25ä¸ªå…¶ä»–ç‹¬ç«‹çš„ç¬¬ä¸‰æ–¹ã€é’ˆå¯¹ä¸åŒçš„å¼€å‘åœºæ™¯ã€åŸºäºè¿™ç¯‡è®ºæ–‡è‰ç¨¿çš„å¼€æºå®ç°ã€‚åŒæ—¶ï¼Œå¾ˆå¤šå…¬å¸å·²ç»éƒ¨ç½²äº†åŸºäºRaft ç®—æ³•çš„ç³»ç»Ÿäº†ã€‚</p><p>æœ¬èŠ‚å‰©ä¸‹çš„ç¯‡å¹…å°†ä»ä¸‰ä¸ªæ–¹é¢æ¥è¯„ä¼° Raft ç®—æ³•ï¼š</p><ul><li>å¯ç†è§£æ€§</li><li>æ­£ç¡®æ€§</li><li>æ€§èƒ½</li></ul><h3 id="å¯ç†è§£æ€§">9.1 å¯ç†è§£æ€§</h3><p>ä¸ºäº†è¡¡é‡ Raft ç›¸å¯¹äº Paxosçš„å¯ç†è§£æ€§ï¼Œæˆ‘ä»¬é’ˆå¯¹é«˜å±‚æ¬¡çš„æœ¬ç§‘ç”Ÿå’Œç ”ç©¶ç”Ÿï¼Œåœ¨æ–¯å¦ç¦å¤§å­¦çš„é«˜çº§æ“ä½œç³»ç»Ÿè¯¾ç¨‹å’ŒåŠ å·å¤§å­¦ä¼¯å…‹åˆ©åˆ†æ ¡çš„åˆ†å¸ƒå¼è®¡ç®—è¯¾ç¨‹ä¸Šï¼Œè¿›è¡Œäº†ä¸€é¡¹å®éªŒç ”ç©¶ã€‚æˆ‘ä»¬ä¸ºRaft å’Œ Paxos åˆ†åˆ«å½•åˆ¶äº†ä¸€ä¸ªè§†é¢‘æ•™ç¨‹ï¼Œå¹¶ä¸”å‡†å¤‡äº†ç›¸åº”çš„å°æµ‹éªŒã€‚å…¶ä¸­ Raftè¯¾ç¨‹è¦†ç›–äº†æœ¬ç¯‡è®ºæ–‡é™¤äº†æ—¥å¿—å‹ç¼©ä¹‹å¤–çš„å…¨éƒ¨å†…å®¹ï¼Œè€Œ Paxosè¯¾ç¨‹æ¶µç›–äº†åˆ›å»ºä¸€ä¸ªä¸ Raft ç­‰ä»·çš„å¤åˆ¶çŠ¶æ€æœºçš„å…¨éƒ¨èµ„æ–™ï¼ŒåŒ…æ‹¬ signle-decreePaxosã€multi-decree Paxosã€é‡æ–°é…ç½®å’Œä¸€åˆ‡å®é™…ç³»ç»Ÿéœ€è¦çš„æ€§èƒ½ä¼˜åŒ–ï¼ˆæ¯”å¦‚leaderé€‰ä¸¾ï¼‰ã€‚è¿™ä¸ªå°æµ‹éªŒä¸»è¦æ˜¯æµ‹è¯•ä¸€äº›å¯¹ç®—æ³•çš„ç†è§£å’Œè§£é‡Šä¸€äº›è¾¹ç¼˜æƒ…å†µã€‚æ¯ä¸ªå­¦ç”Ÿéƒ½æ˜¯çœ‹å®Œç¬¬ä¸€ä¸ªè§†é¢‘ï¼Œç„¶ååšå¯¹åº”çš„æµ‹éªŒï¼Œç„¶åå†çœ‹ç¬¬äºŒä¸ªè§†é¢‘ï¼Œå†åšç¬¬äºŒä»½æµ‹éªŒã€‚ä¸ºäº†è§£é‡Šä¸ªäººè¡¨ç°ä¸ä»ç¬¬ä¸€éƒ¨åˆ†ç ”ç©¶ä¸­è·å¾—çš„ç»éªŒå·®å¼‚çš„åŸå› ï¼Œå¤§çº¦æœ‰ä¸€åŠçš„å­¦ç”Ÿå…ˆè¿›è¡ŒPaxos çš„éƒ¨åˆ†ï¼Œç„¶åå¦ä¸€åŠå­¦ç”Ÿå…ˆè¿›è¡Œ Raftçš„éƒ¨åˆ†ã€‚æˆ‘ä»¬é€šè¿‡è®¡ç®—å‚ä¸äººå‘˜çš„æ¯ä¸€ä»½æµ‹éªŒçš„å¾—åˆ†æ¥çœ‹å‚ä¸è€…æ˜¯å¦æ›´åŠ å®¹æ˜“ç†è§£Raft ç®—æ³•ã€‚</p><p>æˆ‘ä»¬å°½å¯èƒ½çš„ä½¿å¾—åœ¨æ¯”è¾ƒ Raft å’Œ Paxosè¿‡ç¨‹ä¸­æ˜¯å…¬å¹³çš„ã€‚è¿™ä¸ªå®éªŒä»ä¸¤ä¸ªæ–¹é¢åå‘äº† Paxosï¼š</p><ol type="1"><li>43 ä¸ªå‚ä¸è€…ä¸­æœ‰ 15 ä¸ªäººåœ¨ä¹‹å‰æœ‰ä¸€äº› Paxos çš„ç»éªŒ</li><li>Paxos è§†é¢‘æ•™ç¨‹çš„æ—¶é•¿è¦é•¿ 14%</li></ol><p>å¦‚è¡¨æ ¼ 1æ€»ç»“çš„é‚£æ ·ï¼Œæˆ‘ä»¬é‡‡å–äº†ä¸€äº›æªæ–½æ¥å‡è½»è¿™ç§æ½œåœ¨çš„åå‘ã€‚æˆ‘ä»¬æ‰€æœ‰çš„ææ–™éƒ½å¯ä¾›å®¡æŸ¥[28, 31]ã€‚</p><table style="width:100%;"><thead><tr class="header"><th>å…³æ³¨ç‚¹</th><th>ç¼“å’Œåå‘é‡‡å–çš„æ‰‹æ®µ</th><th>å¯ä¾›æŸ¥çœ‹çš„ææ–™</th></tr></thead><tbody><tr class="odd"><td>ç›¸åŒçš„è®²è¯¾è´¨é‡</td><td>ä¸¤ä»½æ•™ç¨‹é‡‡ç”¨åŒä¸€ä¸ªè®²å¸ˆã€‚Paxosçš„æ•™ç¨‹æ˜¯åœ¨ç°æœ‰çš„ä¸€äº›å¤§å­¦ä½¿ç”¨çš„ææ–™åŸºç¡€ä¸Šæ”¹è¿›çš„ã€‚Paxos çš„æ•™ç¨‹è¦é•¿14%ã€‚</td><td>è§†é¢‘</td></tr><tr class="even"><td>ç›¸åŒçš„æµ‹éªŒéš¾åº¦</td><td>é—®é¢˜ä»¥éš¾åº¦åˆ†ç»„ï¼Œåœ¨ä¸¤ä¸ªæµ‹éªŒé‡Œæˆå¯¹å‡ºç°ã€‚</td><td>å°æµ‹éªŒ</td></tr><tr class="odd"><td>å…¬å¹³è¯„åˆ†</td><td>ä½¿ç”¨è¯„ä»·é‡è§„ã€‚éšæœºé¡ºåºæ‰“åˆ†ï¼Œä¸¤ä¸ªæµ‹éªŒäº¤æ›¿è¿›è¡Œã€‚</td><td>è¯„åˆ†ç»†åˆ™</td></tr></tbody></table><center>è¡¨æ ¼1ï¼šè€ƒè™‘åˆ°æ½œåœ¨çš„å®éªŒåå‘ï¼Œæˆ‘ä»¬å¯¹äºæ¯ç§æƒ…å†µçš„è§£å†³æ–¹æ³•ï¼Œä»¥åŠç›¸åº”çš„ææ–™ã€‚</center><p>å¹³å‡ä¸Šçœ‹ï¼Œå‚ä¸è€…åœ¨ Raft æµ‹éªŒä¸Šçš„å¾—åˆ†è¦æ¯”åœ¨ Paxos æµ‹éªŒä¸Šçš„å¾—åˆ†é«˜å¤„ 4.9åˆ†ï¼ˆåœ¨ 60 åˆ†ä¸­ï¼ŒRaft çš„å¹³å‡å¾—åˆ†æ˜¯ 25.7 åˆ†ï¼ŒPaxos çš„å¹³å‡å¾—åˆ†æ˜¯ 20.8åˆ†ï¼‰ã€‚å›¾ 14 å±•ç¤ºäº†æ¯ä¸ªå‚ä¸è€…çš„å¾—åˆ†ã€‚é…å¯¹ t æ£€éªŒï¼ˆpaired t-testï¼‰è¡¨æ˜ï¼Œåœ¨95% çš„ç½®ä¿¡åº¦ä¸‹ï¼ŒRaft åˆ†æ•°çš„çœŸå®åˆ†å¸ƒçš„å¹³å‡å€¼è‡³å°‘è¦æ¯” Paxos çš„å¤§ 2.5åˆ†ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/008i3skNly1gsixtffkroj32220my76y.jpg"alt="image-20210716175208106" /><figcaption aria-hidden="true">image-20210716175208106</figcaption></figure><p>æˆ‘ä»¬ä¹Ÿå»ºç«‹äº†ä¸€ä¸ªçº¿æ€§å›å½’æ¨¡å‹æ¥é¢„æµ‹ä¸€ä¸ªæ–°çš„å­¦ç”Ÿçš„æµ‹éªŒæˆç»©ï¼Œè¿™ä¸ªæ¨¡å‹åŸºäºä»¥ä¸‹ä¸‰ç‚¹ï¼š</p><ol type="1"><li>ä»–ä»¬ä½¿ç”¨çš„æ˜¯å“ªä¸ªæµ‹éªŒ</li><li>ä¹‹å‰å¯¹äº Paxos çš„ç»éªŒ</li><li>å­¦ä¹ ç®—æ³•çš„é¡ºåº</li></ol><p>è¯¥æ¨¡å‹é¢„æµ‹ï¼Œå¯¹å°æµ‹éªŒçš„é€‰æ‹©ä¼šäº§ç”Ÿ 12.5 åˆ†çš„æœ‰åˆ©äº Raftçš„å·®åˆ«ï¼Œè¿™å¾ˆæ˜æ˜¾é«˜äºè§‚å¯Ÿåˆ°çš„ 4.9åˆ†çš„åˆ†å·®ã€‚è¿™æ˜¯å› ä¸ºå®é™…ä¸Šè®¸å¤šçš„å­¦ç”Ÿä¹‹å‰æœ‰å­¦ä¹ è¿‡ Paxosï¼Œè¿™å¯¹ Paxosçš„æœ‰å¾ˆå¤§å¸®åŠ©çš„ï¼Œä½†æ˜¯å¯¹ Raftçš„å¸®åŠ©å°±è¾ƒå°äº†ã€‚ä½†æ˜¯å¥‡æ€ªçš„æ˜¯ï¼Œæ¨¡å‹é¢„æµ‹å¯¹äºå…ˆè¿›è¡Œ Paxoså°æµ‹éªŒçš„äººè€Œè¨€ï¼ŒRaft çš„å¾—åˆ†ä½äº† 6.3åˆ†ã€‚è™½ç„¶æˆ‘ä»¬ä¸çŸ¥é“è¿™æ˜¯ä¸ºä»€ä¹ˆï¼Œä½†æ˜¯è¿™ä¼¼ä¹åœ¨ç»Ÿè®¡ä¸Šæ˜¯æœ‰æ„ä¹‰çš„ã€‚</p><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/008i3skNly1gsiz66oe4yj323m0jgdj0.jpg"alt="image-20210716183850084" /><figcaption aria-hidden="true">image-20210716183850084</figcaption></figure><p>æˆ‘ä»¬åŒæ—¶ä¹Ÿåœ¨æµ‹éªŒä¹‹åå¯¹å‚ä¸è€…è¿›è¡Œäº†è°ƒæŸ¥ï¼Œè°ƒæŸ¥çš„å†…å®¹æ˜¯ä»–ä»¬è®¤ä¸ºå“ªä¸ªç®—æ³•æ›´å®¹æ˜“å»å®ç°æˆ–è§£é‡Šã€‚è¿™äº›è°ƒæŸ¥ç»“æœå±•ç¤ºåœ¨å›¾15ã€‚è°ƒæŸ¥ç»“æœæ˜¯ç¢¾å‹æ€§çš„ï¼Œç»“æœè¡¨æ˜ Raft ç®—æ³•æ›´åŠ å®¹æ˜“å®ç°å’Œè§£é‡Šï¼ˆ41 äººä¸­çš„33ä¸ªï¼‰ã€‚ç„¶è€Œï¼Œè¿™ç§è‡ªæˆ‘æŠ¥å‘Šçš„æ„Ÿè§‰å¯èƒ½æ²¡æœ‰å‚ä¸è€…çš„æµ‹è¯•åˆ†æ•°æ¥å¾—å¯é ï¼Œè€Œä¸”å‚ä¸è€…å¯èƒ½ç”±äºæˆ‘ä»¬å‡è®¾Raft æ›´å®¹æ˜“ç†è§£è€Œå­˜åœ¨åå‘ã€‚</p><p>åœ¨å‚è€ƒæ–‡çŒ® [33] ä¸­æœ‰ä¸€ä¸ªå…³äº Raft ç”¨æˆ·å­¦ä¹ çš„æ›´åŠ è¯¦ç»†çš„è®¨è®ºã€‚</p><h3 id="æ­£ç¡®æ€§">9.2 æ­£ç¡®æ€§</h3><p>åœ¨ç¬¬ 5èŠ‚ä¸­ï¼Œæˆ‘ä»¬å·²ç»å¯¹å…±è¯†æœºåˆ¶åˆ¶å®šäº†æ­£å¼çš„è§„èŒƒå¹¶ä¸”å¯¹å…¶å®‰å…¨æ€§åšäº†è¯æ˜ã€‚è¿™ä»½æ­£å¼çš„è§„èŒƒä½¿ç”¨TLA+ è§„èŒƒè¯­è¨€ [17] ä½¿å›¾ 2 ä¸­å¯¹ç®—æ³•çš„æ€»ç»“çš„ä¿¡æ¯éå¸¸æ¸…æ™°ã€‚å®ƒå·®ä¸å¤šæœ‰ 400è¡Œå¹¶ä¸”ä½œä¸ºäº†æˆ‘ä»¬è¦è¯æ˜çš„æ ¸å¿ƒã€‚åŒæ—¶è¿™ä»½è§„èŒƒå¯¹äºä»»ä½•æƒ³å®ç° Raftçš„äººéƒ½æ˜¯ååˆ†æœ‰ç”¨çš„ã€‚æˆ‘ä»¬ç”¨ TLA è¯æ˜ç³»ç»Ÿ [7] æœºæ¢°åœ°è¯æ˜äº†æ—¥å¿—å®Œæ•´æ€§ï¼ˆLogCompletenessPropertyï¼‰ã€‚ç„¶è€Œï¼Œè¿™ä¸ªè¯æ˜ä¾èµ–çš„çº¦æŸå‰æè¿˜æ²¡æœ‰è¢«æœºæ¢°è¯æ˜ï¼ˆä¾‹å¦‚ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰è¯æ˜è§„èŒƒä¸­çš„ç±»å‹å®‰å…¨ï¼‰ã€‚è€Œä¸”ï¼Œæˆ‘ä»¬å·²ç»ç¼–å†™äº†çŠ¶æ€æœºå®‰å…¨ç‰¹æ€§çš„éæ­£å¼è¯æ˜[31]ï¼Œå®ƒæ˜¯å®Œæ•´çš„ï¼ˆå®ƒä»…ä¾èµ–äºè§„èŒƒï¼‰å’Œç›¸å¯¹ç²¾ç¡®çš„ï¼ˆå¤§çº¦ 3500 å­—é•¿ï¼‰ã€‚</p><h3 id="æ€§èƒ½">9.3 æ€§èƒ½</h3><p>Raft çš„æ€§èƒ½è·Ÿå…¶ä»–åƒ Paxosçš„å…±è¯†ç®—æ³•å¾ˆæ¥è¿‘ã€‚åœ¨æ€§èƒ½æ–¹é¢ï¼Œæœ€é‡è¦çš„å…³æ³¨ç‚¹å°±æ˜¯ï¼Œå½“ä¸€ä¸ª leaderè¢«é€‰ä¸¾å‡ºæ¥åï¼Œå®ƒè¦åœ¨ä»€ä¹ˆæ—¶å€™å¤åˆ¶æ–°çš„æ—¥å¿—æ¡ç›®ã€‚Rafté€šè¿‡å¾ˆå°‘é‡çš„æ¶ˆæ¯åŒ…ï¼ˆä¸€è½®ä» leaderåˆ°é›†ç¾¤ä¸­è¿‡åŠèŠ‚ç‚¹çš„çš„æ¶ˆæ¯ä¼ é€’ï¼‰å°±è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚åŒæ—¶ï¼Œè¿›ä¸€æ­¥æå‡ Raftçš„æ€§èƒ½ä¹Ÿæ˜¯æœ‰å¯èƒ½çš„ã€‚æ¯”å¦‚è¯´ï¼Œå¾ˆå®¹æ˜“é€šè¿‡æ”¯æŒæ‰¹é‡æ“ä½œå’Œç®¡é“æ“ä½œæ¥æé«˜ååé‡å’Œé™ä½å»¶è¿Ÿã€‚å¯¹äºå…¶ä»–å…±è¯†ç®—æ³•å·²ç»æå‡ºè¿‡å¾ˆå¤šæ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆï¼Œå…¶ä¸­å¾ˆå¤šéƒ½å¯ä»¥åº”ç”¨åˆ°Raft ä¸Šï¼Œä½†æ˜¯æˆ‘ä»¬æš‚æ—¶æŠŠè¿™äº›å·¥ä½œæ”¾åˆ°æœªæ¥çš„å·¥ä½œä¸­ã€‚</p><p>æˆ‘ä»¬ä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„ Raft å®ç°æ¥è¡¡é‡ Raft çš„ leader electionç®—æ³•çš„æ€§èƒ½å¹¶ä¸”å›ç­”ä¸¤ä¸ªé—®é¢˜ï¼š</p><ol type="1"><li>leader é€‰ä¸¾è¿‡ç¨‹æ”¶æ•›æ˜¯å¦è¶³å¤Ÿå¿«ï¼Ÿ</li><li>åœ¨ leader å´©æºƒä¹‹åï¼Œæœ€å°çš„ç³»ç»Ÿå´©æºƒæ—¶é—´æ˜¯å¤šä¹…ï¼Ÿ</li></ol><figure><imgsrc="https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/008i3skNly1gsj0yuh34ej61km0u043r02.jpg"alt="image-20210716194110554" /><figcaption aria-hidden="true">image-20210716194110554</figcaption></figure><p>ä¸ºäº†è¡¡é‡ leader election çš„æ€§èƒ½ï¼Œæˆ‘ä»¬åå¤ä½¿ä¸€ä¸ªæ‹¥æœ‰ 5 ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤çš„leader å®•æœºï¼Œå¹¶è®¡ç®—å®ƒæ£€æµ‹å´©æºƒå’Œé‡æ–°é€‰ä¸€ä¸ªæ–°çš„ leader æ‰€éœ€çš„æ—¶é—´ï¼ˆè§å›¾16ï¼‰ã€‚ä¸ºäº†æ„å»ºä¸€ä¸ªæœ€åçš„æƒ…æ™¯ï¼Œæˆ‘ä»¬ä½¿å„ä¸ªèŠ‚ç‚¹ä¸­çš„æ—¥å¿—é•¿åº¦éƒ½æ˜¯ä¸åŒçš„ï¼Œè¿™æ ·æŸäº›candidate æ˜¯æ— æ³•æˆä¸º leader çš„ã€‚è€Œå·²ï¼Œä¸ºäº†å°½å¯èƒ½å‡ºç°æ— ç»“æœçš„æŠ•ç¥¨ï¼ˆsplitvoteï¼‰æƒ…å†µï¼Œæˆ‘ä»¬çš„æµ‹è¯•è„šæœ¬åœ¨ç»ˆæ­¢ leader çš„è¿›ç¨‹ä¹‹å‰ä» leaderé‚£è§¦å‘äº†ä¸€ä¸ªåŒæ­¥çš„å‘é€äº†ä¸€æ¬¡å¿ƒè·³å¹¿æ’­ï¼ˆç±»ä¼¼äº leaderåœ¨å´©æºƒå‰å¤åˆ¶ä¸€ä¸ªæ—¥å¿—æ¡ç›®ç»™å…¶ä»–èŠ‚ç‚¹ï¼‰ã€‚leaderåœ¨å…¶å¿ƒè·³é—´éš”å†…å‡åŒ€éšæœºåœ°å´©æºƒï¼Œè¿™ä¸ªå¿ƒè·³é—´éš”ä¹Ÿæ˜¯æ‰€æœ‰æµ‹è¯•ä¸­æœ€å°é€‰ä¸¾è¶…æ—¶æ—¶é•¿çš„ä¸€åŠã€‚å› æ­¤ï¼Œ<strong>æœ€å°å®•æœºæ—¶é—´å¤§çº¦å°±æ˜¯æœ€å°é€‰ä¸¾è¶…æ—¶æ—¶é—´çš„ä¸€åŠ</strong>ã€‚</p><p>å›¾ 16ä¸­ä¸Šé¢çš„å›¾è¡¨æ˜ï¼Œåªéœ€è¦åœ¨é€‰ä¸¾è¶…æ—¶æ—¶é—´ä¸Šä½¿ç”¨å¾ˆå°çš„éšæœºåŒ–å°±å¯ä»¥å¤§å¤§é¿å…å‡ºç°æ²¡æœ‰ç»“æœçš„æŠ•ç¥¨çš„æƒ…å†µã€‚åœ¨æ²¡æœ‰éšæœºåŒ–çš„æƒ…å†µä¸‹ï¼ˆè¯‘è€…æ³¨ï¼šè§å›¾16ä¸­ä¸Šé¢çš„å›¾å³è¾¹çš„æ©™è‰²è™šçº¿ï¼‰ï¼Œç”±äºå‡ºç°äº†å¾ˆå¤šæ²¡æœ‰ç»“æœçš„æŠ•ç¥¨çš„æƒ…å†µï¼Œleaderelection å¾€å¾€éƒ½éœ€è¦èŠ±è´¹è¶…è¿‡ 10s çš„æ—¶é—´ã€‚ä»…ä»…åŠ å…¥ 5msçš„éšæœºåŒ–æ—¶é—´ï¼Œå°±å¤§å¤§æ”¹å–„äº†é€‰ä¸¾è¿‡ç¨‹ï¼Œç°åœ¨å¹³å‡çš„å®•æœºæ—¶é—´åªæœ‰287msã€‚ç»§ç»­å¢å¤§éšæœºæ€§å¯ä»¥å¤§å¤§æ”¹å–„æœ€åçš„æƒ…å†µï¼šé€šè¿‡å¢åŠ  50msçš„éšæœºåŒ–æ—¶é—´ï¼Œæœ€åçš„å®Œæˆæƒ…å†µï¼ˆå³å®Œæˆ 1000 æ¬¡å®éªŒï¼‰åªéœ€è¦ 513 msã€‚</p><p>å›¾ 16ä¸­ä¸‹é¢çš„å›¾è¡¨æ˜ï¼Œé€šè¿‡å‡å°‘é€‰ä¸¾è¶…æ—¶æ—¶é—´å¯ä»¥ç¦çƒ§ç³»ç»Ÿçš„å®•æœºæ—¶é—´ã€‚åœ¨é€‰ä¸¾è¶…æ—¶æ—¶é—´ä¸º12~24ms çš„æƒ…å†µä¸‹ï¼Œåªéœ€è¦å¹³å‡ 35ms å°±å¯ä»¥é€‰ä¸¾å‡ºæ–°çš„leaderï¼ˆæœ€é•¿çš„ä¸€æ¬¡èŠ±è´¹äº†152msï¼‰ã€‚ç„¶è€Œï¼Œè¿›ä¸€æ­¥é™ä½é€‰ä¸¾è¶…æ—¶æ—¶é—´å¯èƒ½å°±ä¼šè¿å Raftä¸ç­‰å¼çš„è¦æ±‚ã€‚</p><blockquote><p>å¹¿æ’­æ—¶é—´ï¼ˆbroadcastTimeï¼‰ &lt;&lt; é€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼ˆelectionTimeoutï¼‰&lt;&lt; å¹³å‡æ•…éšœé—´éš”æ—¶é—´ï¼ˆMTBFï¼‰</p></blockquote><p>å› ä¸ºè¿™ä¼šä½¿å¾—åœ¨å…¶ä»–èŠ‚ç‚¹å¼€å¯ä¸€è½®æ–°çš„é€‰ä¸¾ä¹‹å‰ï¼Œå½“å‰çš„ leaderè¦å®Œæˆå‘é€ä¸€æ¬¡å¿ƒè·³å¹¿æ’­å˜å¾—å¾ˆéš¾ã€‚è¿™ä¼šé€ æˆä¸å¿…è¦çš„ leaderæ›´æ¢ï¼Œä»è€Œé™ä½äº†ç³»ç»Ÿçš„å¯ç”¨æ€§ã€‚æˆ‘ä»¬æ¨èä½¿ç”¨ä¸€ä¸ªæ›´ä¸ºä¿å®ˆçš„é€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼Œæ¯”å¦‚150~300msã€‚è¿™æ ·çš„æ—¶é—´ä¸å¤§å¯èƒ½å¯¼è‡´ä¸å¿…è¦çš„ leaderæ›´æ¢ï¼ŒåŒæ—¶è¿˜èƒ½æä¾›ä¸é”™çš„å¯ç”¨æ€§ã€‚</p><h2 id="ç›¸å…³å·¥ä½œ">10. ç›¸å…³å·¥ä½œ</h2><p>ç°åœ¨å·²ç»æœ‰å¾ˆå¤šå…³äºå…±è¯†ç®—æ³•ç›¸å…³çš„äº§ç‰©äº†ï¼Œå…¶ä¸­å¾ˆå¤šéƒ½å±äºä»¥ä¸‹ç±»åˆ«ä¹‹ä¸€ï¼š</p><ul><li>Lamport å¯¹äº Paxos çš„æœ€åˆçš„æè¿° [15]ï¼Œä»¥åŠå°è¯•å°† Paxosè§£é‡Šåœ°æ›´æ¸…æ™°çš„æè¿° [16, 20, 21 ]ã€‚</li><li>å…³äº Paxosçš„æ›´è¯¦å°½çš„æè¿°ï¼Œè¡¥å……é—æ¼çš„ç»†èŠ‚å¹¶ä¿®æ”¹ç®—æ³•ï¼Œä½¿å¾—å¯ä»¥æä¾›æ›´åŠ å®¹æ˜“çš„å®ç°åŸºç¡€[26, 39, 13]ã€‚</li><li>å®ç°å…±è¯†ç®—æ³•çš„ç³»ç»Ÿï¼Œä¾‹å¦‚ Chubby [2, 4]ï¼ŒZooKeeper [11, 12] å’ŒSpanner [6]ã€‚å¯¹äº Chubby å’Œ Spannerçš„ç®—æ³•å¹¶æ²¡æœ‰å…¬å¼€å‘è¡¨å…¶æŠ€æœ¯ç»†èŠ‚ï¼Œå°½ç®¡ä»–ä»¬éƒ½å£°ç§°æ˜¯åŸºäº Paxos çš„ã€‚ZooKeeperçš„ç®—æ³•ç»†èŠ‚å·²ç»å‘è¡¨ï¼Œä½†æ˜¯å’Œ Paxos ç€å®æœ‰ç€å¾ˆå¤§çš„å·®åˆ«ã€‚</li><li>å¯¹äº Paxos çš„æ€§èƒ½ä¼˜åŒ– [18, 19, 3, 25, 1, 27]ã€‚</li><li>Oki å’Œ Liskov çš„ Viewstamped Replicationï¼ˆVRï¼‰ï¼Œä¸€ç§å’Œ Paxoså·®ä¸å¤šçš„æ›¿ä»£ç®—æ³•ã€‚åŸå§‹çš„ç®—æ³•æè¿° [29]å’Œåˆ†å¸ƒå¼ä¼ è¾“åè®®è€¦åˆåœ¨äº†ä¸€èµ·ï¼Œä½†æ˜¯æ ¸å¿ƒçš„å…±è¯†ç®—æ³•åœ¨æœ€è¿‘æ›´æ–°çš„ç‰ˆæœ¬ [22]é‡Œè¢«åˆ†ç¦»äº†å‡ºæ¥ã€‚VR ä½¿ç”¨äº†ä¸€ç§åŸºäº leader çš„æ–¹æ³•ï¼Œå’Œ Raftæœ‰å¾ˆå¤šç›¸ä¼¼ä¹‹å¤„ã€‚</li></ul><p>Raft å’Œ Paxos æœ€å¤§çš„ä¸åŒå°±åœ¨äº Raft çš„<strong>å¼ºé¢†å¯¼æ€§ï¼ˆstrongleadershipï¼‰</strong>ã€‚Raft å°† leader electionä½œä¸ºå…±è¯†åè®®ä¸­éå¸¸é‡è¦çš„ä¸€ç¯ï¼Œå¹¶ä¸”å°†å°½å¯èƒ½å¤šçš„åŠŸèƒ½é›†ä¸­åˆ°äº† leaderèº«ä¸Šã€‚è¿™ç§æ–¹æ³•ä½¿å¾—ç®—æ³•æ›´åŠ ç®€å•å’Œæ›´å®¹æ˜“ç†è§£ã€‚æ¯”å¦‚è¯´ï¼Œåœ¨ Paxos ä¸­ï¼Œleaderelectionå’ŒåŸºæœ¬çš„å…±è¯†åè®®æ˜¯æ­£äº¤çš„ï¼šå®ƒåªæ˜¯ä½œä¸ºä¸€ç§æ€§èƒ½ä¼˜åŒ–ï¼Œè€Œä¸æ˜¯å®ç°å…±è¯†æ‰€å¿…éœ€çš„ã€‚ç„¶è€Œï¼Œè¿™å¸¦æ¥äº†å¾ˆå¤šé¢å¤–çš„æœºåˆ¶ï¼š</p><ul><li>Paxos ä¸­åŒ…å«äº†ä¸€ä¸ªä¸¤æ®µå¼çš„åŸºæœ¬å…±è¯†åè®®</li><li>Paxos ä¸­è¿˜åŒ…å«äº†ä¸€ä¸ªå•ç‹¬çš„ leader election æœºåˆ¶</li></ul><p>ç›¸æ¯”ä¹‹ä¸‹ï¼ŒRaft å°† leader electionç›´æ¥çº³å…¥äº†å…±è¯†ç®—æ³•å¹¶ä¸”å°†å…¶ä½œä¸ºå…±è¯†ä¸¤é˜¶æ®µä¸­çš„ç¬¬ä¸€ä¸ªé˜¶æ®µï¼Œè¿™ä½¿å¾— Raftä½¿ç”¨çš„æœºåˆ¶è¦æ¯” Paxos å°‘å¾—å¤šã€‚</p><p>åƒ Raft ä¸€æ ·ï¼ŒVR å’Œ ZooKeeper ä¹Ÿæ˜¯åŸºäº leader çš„ï¼Œå› æ­¤ä»–ä»¬ä¹Ÿæ‹¥æœ‰ä¸€äº›Raft çš„ä¼˜ç‚¹ã€‚ä½†æ˜¯ï¼ŒRaft æ¯” VR å’Œ ZooKeeper æ‹¥æœ‰æ›´å°‘çš„æœºåˆ¶ã€‚å› ä¸º Raftå°½å¯èƒ½çš„å‡å°‘äº†é leader è€…çš„åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼ŒRaft ä¸­æ—¥å¿—æ¡ç›®éƒ½éµå¾ªç€ä» leaderå‘é€ç»™ follower è¿™ä¸€ä¸ªæ–¹å‘ï¼šAppendEntries RPCs æ˜¯å‘å¤–å‘é€çš„ã€‚åœ¨ VRä¸­ï¼Œæ—¥å¿—æ¡ç›®çš„æµåŠ¨æ˜¯åŒå‘çš„ï¼ˆleaderäººå¯ä»¥åœ¨é€‰ä¸¾è¿‡ç¨‹ä¸­æ¥æ”¶æ—¥å¿—ï¼‰ï¼›è¿™å°±å¯¼è‡´äº†é¢å¤–çš„æœºåˆ¶å’Œå¤æ‚æ€§ã€‚æ ¹æ®ZooKeeper å…¬å¼€çš„èµ„æ–™çœ‹ï¼Œå®ƒçš„æ—¥å¿—æ¡ç›®ä¹Ÿæ˜¯åŒå‘ä¼ è¾“çš„ï¼Œä½†æ˜¯å®ƒçš„å®ç°æ›´åƒRaftã€‚</p><p>è·Ÿæˆ‘ä»¬ä¸Šè¿°æåˆ°çš„å…¶ä»–åŸºäºå…±è¯†æ€§çš„æ—¥å¿—å¤åˆ¶ç®—æ³•ç›¸æ¯”ï¼ŒRaftçš„æ¶ˆæ¯ç±»å‹æ›´å°‘ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬è®¡ç®—äº†ä¸€ä¸‹ VR å’Œ ZooKeeperç”¨æ¥å®ç°åŸºæœ¬åŠŸèƒ½å’Œé›†ç¾¤æˆå‘˜å˜æ›´ï¼ˆä¸åŒ…æ‹¬æ—¥å¿—å‹ç¼©å’Œå®¢æˆ·ç«¯äº¤äº’ï¼Œå› ä¸ºè¿™äº›éƒ½æ¯”è¾ƒç‹¬ç«‹ä¸”å’Œç®—æ³•å…³ç³»ä¸å¤§ï¼‰æ‰€éœ€è¦çš„æ¶ˆæ¯ç±»å‹ã€‚VRå’Œ ZooKeeper éƒ½åˆ†åˆ«å®šä¹‰äº† 10 ç§ä¸åŒçš„æ¶ˆæ¯ç±»å‹ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒRaft åªæœ‰ 4ç§æ¶ˆæ¯ç±»å‹ï¼ˆä¸¤ç§ RPC Request åŠå…¶å¯¹åº”çš„ä¸¤ç§ RPC Responseï¼‰ã€‚Raftçš„æ¶ˆæ¯çš„æ¶ˆæ¯é‡æ¯”å…¶ä»–ç®—æ³•çš„è¦å¤§ä¸€ç‚¹ï¼Œä½†æ€»çš„æ¥è¯´ï¼Œå®ƒä»¬æ›´åŠ ç®€å•ã€‚å¦å¤–ï¼ŒVRå’Œ ZooKeeper éƒ½åœ¨ leaderæ”¹å˜çš„æ—¶å€™ä¼ è¾“äº†æ•´ä¸ªæ—¥å¿—ï¼Œæ‰€ä»¥è¿™äº›ç®—æ³•ä¸ºäº†èƒ½åœ¨å®è·µä¸­ä½¿ç”¨ï¼Œå°±ä¸å¾—ä¸å¢åŠ é¢å¤–çš„æ¶ˆæ¯ç±»å‹äº†ã€‚</p><p>Raft çš„å¼º leaderæ¨¡å‹ç®€åŒ–äº†æ•´ä¸ªç®—æ³•ï¼Œä½†æ˜¯åŒæ—¶ä¹Ÿæ’æ–¥äº†ä¸€äº›æ€§èƒ½ä¼˜åŒ–çš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œå¹³ç­‰ä¸»ä¹‰Paxos ï¼ˆEPaxosï¼‰åœ¨æŸäº›æ²¡æœ‰ leader çš„æƒ…å†µä¸‹å¯ä»¥è¾¾åˆ°å¾ˆé«˜çš„æ€§èƒ½[27]ã€‚å¹³ç­‰ä¸»ä¹‰ Paxoså……åˆ†å‘æŒ¥äº†åœ¨çŠ¶æ€æœºæŒ‡ä»¤ä¸­çš„äº¤æ¢æ€§ã€‚ä»»ä½•æœåŠ¡å™¨éƒ½å¯ä»¥åœ¨ä¸€è½®é€šä¿¡ä¸‹å°±æäº¤æŒ‡ä»¤ï¼Œé™¤éå…¶ä»–æŒ‡ä»¤åŒæ—¶è¢«æå‡ºäº†ã€‚ç„¶è€Œï¼Œå¦‚æœæŒ‡ä»¤éƒ½æ˜¯å¹¶å‘çš„è¢«æå‡ºï¼Œå¹¶ä¸”äº’ç›¸ä¹‹é—´ä¸é€šä¿¡æ²Ÿé€šï¼Œé‚£ä¹ˆEPaxos å°±éœ€è¦é¢å¤–çš„ä¸€è½®é€šä¿¡ã€‚å› ä¸ºä»»ä½•æœåŠ¡å™¨éƒ½å¯ä»¥æäº¤æŒ‡ä»¤ï¼Œæ‰€ä»¥ EPaxosåœ¨æœåŠ¡å™¨ä¹‹é—´çš„è´Ÿè½½å‡è¡¡åšçš„å¾ˆå¥½ï¼Œå¹¶ä¸”å¾ˆå®¹æ˜“åœ¨ WANç½‘ç»œç¯å¢ƒä¸‹è·å¾—å¾ˆä½çš„å»¶è¿Ÿã€‚ä½†æ˜¯ï¼Œä»–åœ¨ Paxosä¸Šå¢åŠ äº†éå¸¸æ˜æ˜¾çš„å¤æ‚æ€§ã€‚</p><p>ä¸€äº›é›†ç¾¤æˆå‘˜å˜æ›´çš„æ–¹æ³•å·²ç»è¢«æå‡ºæˆ–è€…åœ¨å…¶ä»–çš„å·¥ä½œä¸­è¢«å®ç°ï¼ŒåŒ…æ‹¬Lamport çš„åŸå§‹çš„è®¨è®º [15]ï¼ŒVR [22] å’Œ SMART[24]ã€‚æˆ‘ä»¬é€‰æ‹©ä½¿ç”¨è”åˆå…±è¯†çš„æ–¹æ³•æ˜¯å› ä¸ºå®ƒåˆ©ç”¨äº†å…±è¯†åè®®çš„å…¶ä½™éƒ¨åˆ†ï¼Œè¿™æ ·æˆ‘ä»¬åªéœ€è¦å¾ˆå°‘çš„ä¸€äº›æœºåˆ¶å°±å¯ä»¥å®ç°æˆå‘˜å˜æ›´ã€‚Lamportçš„åŸºäº Î± çš„æ–¹æ³•ä¹‹æ‰€ä»¥æ²¡æœ‰è¢« Raft é€‰æ‹©æ˜¯å› ä¸ºå®ƒå‡è®¾åœ¨æ²¡æœ‰ leaderçš„æƒ…å†µä¸‹ä¹Ÿå¯ä»¥è¾¾åˆ°å…±è¯†æ€§ã€‚å’Œ VR å’Œ SMART ç›¸æ¯”è¾ƒï¼ŒRaftçš„é‡æ–°é…ç½®ç®—æ³•å¯ä»¥åœ¨ä¸é™åˆ¶æ­£å¸¸è¯·æ±‚å¤„ç†çš„æƒ…å†µä¸‹è¿›è¡Œã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒVRåœ¨é…ç½®å˜æ›´æœŸé—´éœ€è¦åœæ­¢æ‰€æœ‰æ­£å¸¸çš„å¤„ç†è¿‡ç¨‹ï¼Œè€Œ SMARTå¯¹æœªå®Œæˆè¯·æ±‚çš„æ•°é‡å®æ–½äº†ç±»ä¼¼ Î± æ–¹æ³•çš„é™åˆ¶ã€‚å¦å¤–ï¼Œå’Œ VRã€SMART ç›¸æ¯”ï¼ŒRaftçš„æ–¹æ³•ä¹Ÿåªéœ€è¦å¢åŠ æ›´å°‘çš„é¢å¤–æœºåˆ¶æ¥å®ç°ã€‚</p><h2 id="ç»“è®º">11. ç»“è®º</h2><p>ç®—æ³•çš„è®¾è®¡é€šå¸¸ä»¥æ­£ç¡®æ€§ã€æ•ˆç‡å’Œç®€æ´æ€§ä¸ºä¸»è¦ç›®æ ‡ã€‚è™½ç„¶è¿™äº›éƒ½æ˜¯æœ‰ä»·å€¼çš„ç›®æ ‡ï¼Œä½†æˆ‘ä»¬ç›¸ä¿¡å¯ç†è§£æ€§åŒæ ·é‡è¦ã€‚åœ¨å¼€å‘äººå‘˜å°†ç®—æ³•è½¬åŒ–ä¸ºå®é™…å®ç°ä¹‹å‰ï¼Œå…¶ä»–ä»»ä½•ç›®æ ‡éƒ½ä¸èƒ½å®ç°ï¼Œè€Œå®é™…å®ç°å°†ä¸å¯é¿å…åœ°åç¦»å’Œæ‰©å±•å‘å¸ƒçš„å½¢å¼ã€‚é™¤éå¼€å‘äººå‘˜å¯¹ç®—æ³•æœ‰æ·±åˆ»çš„ç†è§£ï¼Œå¹¶èƒ½å¯¹ç®—æ³•æœ‰ç›´è§‚çš„è®¤è¯†ï¼Œå¦åˆ™ä»–ä»¬å¾ˆéš¾åœ¨å®ç°ä¸­ä¿ç•™ç®—æ³•ç†æƒ³çš„ç‰¹æ€§ã€‚</p><p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬è®¨è®ºäº†åˆ†å¸ƒå¼å…±è¯†çš„é—®é¢˜ï¼Œåœ¨è¿™ä¸ªé—®é¢˜ä¸Šï¼Œä¸€ä¸ªè¢«å¹¿æ³›æ¥å—ä½†éš¾ä»¥ç†è§£çš„ç®—æ³•ï¼šPaxosï¼Œå¤šå¹´æ¥ä¸€ç›´è®©å­¦ç”Ÿå’Œå¼€å‘äººå‘˜éå¸¸æŒ£æ‰ã€‚æˆ‘ä»¬å¼€å‘äº†ä¸€ç§æ–°çš„ç®—æ³•ï¼šRaftï¼Œæˆ‘ä»¬å·²ç»è¯æ˜å®ƒæ¯”Paxos æ›´å®¹æ˜“ç†è§£ã€‚æˆ‘ä»¬ä¹Ÿç›¸ä¿¡ Raftä¼šä¸ºç³»ç»Ÿå»ºè®¾æä¾›æ›´å¥½çš„åŸºç¡€ã€‚å°†å¯ç†è§£æ€§ä½œä¸ºä¸»è¦è®¾è®¡ç›®æ ‡æ”¹å˜äº†æˆ‘ä»¬å¤„ç†Raftè®¾è®¡çš„æ–¹å¼ã€‚éšç€è®¾è®¡çš„è¿›å±•ï¼Œæˆ‘ä»¬å‘ç°è‡ªå·±åå¤ä½¿ç”¨äº†ä¸€äº›æŠ€æœ¯ï¼Œæ¯”å¦‚åˆ†è§£é—®é¢˜å’Œç®€åŒ–çŠ¶æ€ç©ºé—´ã€‚è¿™äº›æŠ€æœ¯ä¸ä»…æé«˜äº†Raft çš„å¯ç†è§£æ€§ï¼Œè€Œä¸”ä½¿æˆ‘ä»¬æ›´å®¹æ˜“è¯å®å®ƒçš„æ­£ç¡®æ€§ã€‚</p><h2 id="è‡´è°¢">12. è‡´è°¢</h2><p>è¿™é¡¹ç ”ç©¶å¿…é¡»æ„Ÿè°¢ä»¥ä¸‹äººå‘˜çš„æ”¯æŒï¼šAli Ghodsiï¼ŒDavid Mazie`resï¼Œå’Œä¼¯å…‹åˆ©CS 294-91 è¯¾ç¨‹ã€æ–¯å¦ç¦ CS 240è¯¾ç¨‹çš„å­¦ç”Ÿï¼Œæ²¡æœ‰ä»–ä»¬çš„å¤§åŠ›æ”¯æŒï¼Œè¿™é¡¹ç ”ç©¶æ˜¯ä¸å¯èƒ½å®Œæˆçš„ã€‚Scott Klemmerå¸®æˆ‘ä»¬è®¾è®¡äº†ç”¨æˆ·è°ƒæŸ¥ï¼ŒNelson Rayå»ºè®®æˆ‘ä»¬è¿›è¡Œç»Ÿè®¡å­¦çš„åˆ†æã€‚åœ¨ç”¨æˆ·è°ƒæŸ¥æ—¶ä½¿ç”¨çš„å…³äº Paxosçš„å¹»ç¯ç‰‡å¾ˆå¤§ä¸€éƒ¨åˆ†æ˜¯ä» Lorenzo Alvisiçš„å¹»ç¯ç‰‡ä¸Šå€Ÿé‰´è¿‡æ¥çš„ã€‚ç‰¹åˆ«çš„ï¼Œéå¸¸æ„Ÿè°¢ DavidMazieres å’Œ EzraHochï¼Œä»–ä»¬æ‰¾åˆ°äº† Raftä¸­ä¸€äº›éš¾ä»¥å‘ç°çš„æ¼æ´ã€‚è®¸å¤šäººæä¾›äº†å…³äºè¿™ç¯‡è®ºæ–‡ååˆ†æœ‰ç”¨çš„åé¦ˆå’Œç”¨æˆ·è°ƒæŸ¥ææ–™ï¼ŒåŒ…æ‹¬Ed Bugnionï¼ŒMichael Chanï¼ŒHugues Evrardï¼ŒDaniel Giffinï¼ŒArjunGopalanï¼ŒJon Howellï¼ŒVimalkumar Jeyakumarï¼ŒAnkita Kejriwalï¼ŒAleksandarKracunï¼ŒAmit Levyï¼ŒJoel Martinï¼ŒSatoshi Matsushitaï¼ŒOleg Pesokï¼ŒDavidRamosï¼ŒRobbert van Renesseï¼ŒMendel Rosenblumï¼ŒNicolas Schiperï¼ŒDeianStefanï¼ŒAndrew Stoneï¼ŒRyan Stutsmanï¼ŒDavid Tereiï¼ŒStephen Yangï¼ŒMateiZaharia ä»¥åŠ 24ä½åŒ¿åçš„ä¼šè®®å®¡æŸ¥äººå‘˜ï¼ˆå¯èƒ½æœ‰é‡å¤ï¼‰ï¼Œå¹¶ä¸”ç‰¹åˆ«æ„Ÿè°¢æˆ‘ä»¬çš„é¢†å¯¼äºº EddieKohlerã€‚Werner Vogels å‘äº†ä¸€æ¡æ—©æœŸè‰ç¨¿é“¾æ¥çš„æ¨ç‰¹ï¼Œç»™ Raftå¸¦æ¥äº†æå¤§çš„å…³æ³¨ã€‚æˆ‘ä»¬çš„å·¥ä½œç”± Gigascale ç³»ç»Ÿç ”ç©¶ä¸­å¿ƒå’Œ Multiscaleç³»ç»Ÿç ”ç©¶ä¸­å¿ƒç»™äºˆæ”¯æŒï¼Œè¿™ä¸¤ä¸ªç ”ç©¶ä¸­å¿ƒç”±å…³æ³¨ä¸­å¿ƒç ”ç©¶ç¨‹åºèµ„é‡‘æ”¯æŒï¼Œä¸€ä¸ªæ˜¯åŠå¯¼ä½“ç ”ç©¶å…¬å¸çš„ç¨‹åºï¼Œç”±STARnet æ”¯æŒï¼Œä¸€ä¸ªåŠå¯¼ä½“ç ”ç©¶å…¬å¸çš„ç¨‹åºç”± MARCO å’Œ DARPAæ”¯æŒï¼Œåœ¨å›½å®¶ç§‘å­¦åŸºé‡‘ä¼šçš„ 0963859 å·æ‰¹å‡†ï¼Œå¹¶ä¸”è·å¾—äº†æ¥è‡ªFacebookï¼ŒGoogleï¼ŒMellanoxï¼ŒNECï¼ŒNetAppï¼ŒSAP å’Œ Samsung çš„æ”¯æŒã€‚DiegoOngaro ç”± Junglee å…¬å¸ï¼Œæ–¯å¦ç¦çš„æ¯•ä¸šå›¢ä½“æ”¯æŒã€‚</p><h2 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h2><p>[1] BOLOSKY, W. J., BRADSHAW, D., HAAGENS, R. B., KUSTERS, N. P., ANDLI, P. Paxos replicated state machines as the basis of ahigh-performance data store. In <em>Proc. NSDIâ€™11, USENIX Conference onNetworked Systems Design and Implementation</em> (2011), USENIX, pp.141â€“154.</p><p>[2] BURROWS, M. The Chubby lock service for loosely- coupleddistributed systems. In <em>Proc. OSDIâ€™06, Sympo- sium on OperatingSystems Design and Implementation</em> (2006), USENIX, pp. 335â€“350.</p><p>[3] CAMARGOS, L. J., SCHMIDT, R. M., AND PEDONE, F. MulticoordinatedPaxos. In <em>Proc. PODCâ€™07, ACM Sym- posium on Principles ofDistributed Computing</em> (2007), ACM, pp. 316â€“317.</p><p>[4] CHANDRA, T. D., GRIESEMER, R., AND REDSTONE, J. Paxos made live:an engineering perspective. In <em>Proc. PODCâ€™07, ACM Symposium onPrinciples of Distributed Computing</em> (2007), ACM, pp. 398â€“407.</p><p>[5] CHANG, F., DEAN, J., GHEMAWAT, S., HSIEH, W. C., WALLACH, D. A.,BURROWS, M., CHANDRA, T., FIKES, A., AND GRUBER, R. E. Bigtable: adistributed storage system for structured data. In <em>Proc. OSDIâ€™06,USENIX Symposium on Operating Systems Design and Implementation</em>(2006), USENIX, pp. 205â€“218.</p><p>[6] CORBETT, J. C., DEAN, J., EPSTEIN, M., FIKES, A., FROST, C.,FURMAN, J. J., GHEMAWAT, S., GUBAREV, A., HEISER, C., HOCHSCHILD, P.,HSIEH, W., KAN- THAK, S., KOGAN, E., LI, H., LLOYD, A., MELNIK, S.,MWAURA, D., NAGLE, D., QUINLAN, S., RAO, R., ROLIG, L., SAITO, Y.,SZYMANIAK, M., TAYLOR, C., WANG, R., AND WOODFORD, D. Spanner: Googleâ€™sglobally-distributed database. In <em>Proc. OSDIâ€™12, USENIX Conferenceon Operating Systems Design and Implemen- tation</em> (2012), USENIX,pp. 251â€“264.</p><p>[7] COUSINEAU, D., DOLIGEZ, D., LAMPORT, L., MERZ, S., RICKETTS, D.,AND VANZETTO, H. TLA+ proofs. In <em>Proc. FMâ€™12, Symposium on FormalMethods</em> (2012), D. Giannakopoulou and D. Me Ìry, Eds., vol. 7436 of<em>Lec- ture Notes in Computer Science</em>, Springer, pp. 147â€“154.</p><p>[8] GHEMAWAT, S., GOBIOFF, H., AND LEUNG, S.-T. The Google filesystem. In <em>Proc. SOSPâ€™03, ACM Symposium on Operating SystemsPrinciples</em> (2003), ACM, pp. 29â€“43.</p><p>[9] GRAY,C.,ANDCHERITON,D.Leases:Anefficientfault- tolerant mechanismfor distributed file cache consistency. In <em>Proceedings of the 12thACM Ssymposium on Operating Systems Principles</em> (1989), pp.202â€“210.</p><p>[10] HERLIHY, M. P., AND WING, J. M. Linearizability: a correctnesscondition for concurrent objects. <em>ACM Trans- actions on ProgrammingLanguages and Systems 12</em> (July 1990), 463â€“492.</p><p>[11] HUNT, P., KONAR, M., JUNQUEIRA, F. P., AND REED, B . ZooKeeper:wait-free coordination for internet-scale systems. In <em>Proc ATCâ€™10,USENIX Annual Technical Con- ference</em> (2010), USENIX, pp.145â€“158.</p><p>[12] JUNQUEIRA, F. P., REED, B. C., AND SERAFINI, M. Zab:High-performance broadcast for primary-backup sys- tems. In <em>Proc.DSNâ€™11, IEEE/IFIP Intâ€™l Conf. on Depend- able Systems &amp;Networks</em> (2011), IEEE Computer Society, pp. 245â€“256.</p><p>[13] KIRSCH, J., AND AMIR, Y. Paxos for system builders. Tech. Rep.CNDS-2008-2, Johns Hopkins University, 2008.</p><p>[14] L A M P O RT, L . Time, clocks, and the ordering of events in adistributed system. <em>Commununications of the ACM 21</em>, 7 (July1978), 558â€“565.</p><p>[15] L A M P O RT, L . The part-time parliament. <em>ACM Transac-tions on Computer Systems 16</em>, 2 (May 1998), 133â€“169.</p><p>[16] LAMPORT, L. Paxos made simple. <em>ACM SIGACT News 32</em>, 4(Dec. 2001), 18â€“25.</p><p>[17] L A M P O RT, L . <em>Specifying Systems, The TLA+ Language andTools for Hardware and Software Engineers</em>. Addison- Wesley,2002.</p><p>[18] LAMPORT, L. Generalized consensus and Paxos. Tech. Rep.MSR-TR-2005-33, Microsoft Research, 2005.</p><p>[19] L A M P O RT, L . Fast paxos. (2006), 79â€“103.</p><p>[20] LAMPSON, B. W. How to build a highly available system usingconsensus. In <em>Distributed Algorithms</em>, O. Baboaglu and K.Marzullo, Eds. Springer-Verlag, 1996, pp. 1â€“17.</p><p>[21] LAMPSON, B. W. The ABCDâ€™s of Paxos. In <em>Proc. PODCâ€™01, ACMSymposium on Principles of Distributed Computing</em> (2001), ACM, pp.13â€“13.</p><p>[22] LISKOV, B., AND COWLING, J. Viewstamped replica- tion revisited.Tech. Rep. MIT-CSAIL-TR-2012-021, MIT, July 2012.</p><p>[23] LogCabin source code. http://github.com/ logcabin/logcabin.</p><p>[24] LORCH, J. R., ADYA, A., BOLOSKY, W. J., CHAIKEN, R., DOUCEUR, J.R., AND HOWELL, J. The SMART way to migrate replicated statefulservices. In <em>Proc. Eu- roSysâ€™06, ACM SIGOPS/EuroSys EuropeanConference on Computer Systems</em> (2006), ACM, pp. 103â€“115.</p><p>[25] MAO, Y., JUNQUEIRA, F. P., AND MARZULLO, K. Mencius: buildingefficient replicated state machines for WANs. In <em>Proc. OSDIâ€™08,USENIX Conference on Operating Systems Design and Implementation</em>(2008), USENIX, pp. 369â€“384.</p><p>[26] MAZIE` RES, D. Paxos made practical.http://www.scs.stanford.edu/ Ìƒdm/home/ papers/paxos.pdf, Jan. 2007.</p><p>[27] MORARU, I., ANDERSEN, D. G., AND KAMINSKY, M. There is moreconsensus in egalitarian parliaments. In <em>Proc. SOSPâ€™13, ACMSymposium on Operating System Principles</em> (2013), ACM.</p><p>[28] Raft user study. http://ramcloud.stanford. edu/Ìƒongaro/userstudy/.</p><p>[29] OKI, B. M., AND LISKOV, B. H. Viewstamped replication: A newprimary copy method to support highly-available distributed systems. In<em>Proc. PODCâ€™88, ACM Symposium on Principles of DistributedComputing</em> (1988), ACM, pp. 8â€“17.</p><p>[30] Oâ€™NEIL, P., CHENG, E., GAWLICK, D., AND ONEIL, E. Thelog-structured merge-tree (LSM-tree). <em>Acta Informat- ica 33</em>, 4(1996), 351â€“385.</p><p>[31] ONGARO, D. <em>Consensus: Bridging Theory and Practice</em>. PhDthesis, Stanford University, 2014 (work in progress).</p><p>[32] ONGARO, D., AND OUSTERHOUT, J. In search of an understandableconsensus algorithm. In <em>Proc ATCâ€™14, USENIX Annual TechnicalConference</em> (2014), USENIX.</p><p>[33] OUSTERHOUT, J., AGRAWAL, P., ERICKSON, D., KOZYRAKIS, C.,LEVERICH, J., MAZIE`RES, D., MI- TRA, S., NARAYANAN, A., ONGARO, D.,PARULKAR, G., ROSENBLUM, M., RUMBLE, S. M., STRATMANN, E., AND STUTSMAN,R. The case for RAMCloud. <em>Com- munications of the ACM 54</em> (July2011), 121â€“130.</p><p>[34] Raft consensus algorithm website.http://raftconsensus.github.io.</p><p>[35] REED, B. Personal communications, May 17, 2013.</p><p>[36] ROSENBLUM, M., AND OUSTERHOUT, J. K. The design andimplementation of a log-structured file system. <em>ACM Trans. Comput.Syst. 10</em> (February 1992), 26â€“52.</p><p>[37] S C H N E I D E R , F. B . Implementing fault-tolerant servicesusing the state machine approach: a tutorial. <em>ACM Com- putingSurveys 22</em>, 4 (Dec. 1990), 299â€“319.</p><p>[38] SHVACHKO, K., KUANG, H., RADIA, S., AND CHANSLER, R. The Hadoopdistributed file system. In <em>Proc. MSSTâ€™10, Symposium on Mass StorageSys- tems and Technologies</em> (2010), IEEE Computer Society, pp.1â€“10.</p><p>[39] VAN RENESSE, R. Paxos made moderately complex. Tech. rep.,Cornell University, 2012.</p>]]></content>
    
    
    <categories>
      
      <category>è®ºæ–‡ç¿»è¯‘</category>
      
    </categories>
    
    
    <tags>
      
      <tag>åˆ†å¸ƒå¼</tag>
      
      <tag>Raft</tag>
      
      <tag>åŸåˆ›</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
