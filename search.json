[{"title":"Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª oneshot channel","path":"/2025/05/29/rust-action-oneshot-channel/","content":"åœ¨ Go è¯­è¨€é‡Œé¢ï¼Œæœ‰ä¸€å¥åè¨€ï¼šâ€œä¸è¦ä½¿ç”¨å…±äº«å†…å­˜æ¥é€šä¿¡ï¼Œè¦é€šè¿‡é€šä¿¡æ¥å…±äº«å†…å­˜â€ã€‚è®²çš„å°±æ˜¯é€šé“ channelã€‚ä½¿ç”¨ channel æ¥é€šä¿¡ï¼Œä¸€æ–¹é¢å¯ä»¥é¿å…ä¸´ç•Œèµ„æºçš„å¹¶å‘é—®é¢˜ï¼Œå¦ä¸€æ–¹é¢å¯ä»¥è§£è€¦ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ã€‚ channel çš„ç§ç±»æœ‰å¾ˆå¤šç§ï¼š å•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…ã€‚ å•ç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…ã€‚ å¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…ã€‚ åœ¨å•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…è¿™ä¸ªåˆ†ç±»ä¸­ï¼Œè¿˜æœ‰ä¸€ç§å¾ˆå¸¸ç”¨çš„ channelï¼Œå«ä¸€æ¬¡æ€§ channelï¼Œä¹Ÿå« oneshot channelã€‚ç†Ÿæ‚‰ Go è¯­è¨€çš„è¯»è€…åº”è¯¥ç»å¸¸ä¼šæœ‰å¦‚ä¸‹è¿™ç±»ä½¿ç”¨åœºæ™¯ï¼Œè¿™å°±æ˜¯å…¸å‹çš„ oneshot channelã€‚ func demo1() done := make(chan struct)\tgo func() // ... do something close(done)\t()\t-done func demo2() oneShot := make(chan string, 1)\tgo func() oneShot - generateText()\t()\ttext := -oneShot\tdoSthWithText(text)func generateText() string // ...func doSthWithText(text string) // ... åœ¨ Rust ç¤¾åŒºé‡Œé¢ï¼Œå°±æœ‰ä¸€ä¸ªéå¸¸ä¼˜ç§€çš„ oneshot å®ç°ï¼Œåœ¨è¯¦ç»†æ·±å…¥å®ƒçš„å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå‚è€ƒ Rust Atomics and Locks ä¸€ä¹¦ï¼Œæ¥å°è¯•å®ç°ä¸€ä¸ª oneshot channel! ä¸‡èƒ½ç‰ˆ v0ï¼šå¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€… æˆ‘ä»¬å…ˆæ¥å®ç°ä¸€ä¸ªä¸‡èƒ½ç‰ˆ channel çƒ­çƒ­èº«ã€‚é¡¾åæ€ä¹‰ï¼Œchannel åˆ†ä¸º 2 ä¸ªåŠŸèƒ½ï¼Œsend å’Œ receiveï¼Œå…¶ä¸­ï¼š send å¾€ channel ä¸€å¤´æ”¾æ•°æ®ã€‚ receive ä» channel å¦å¤–ä¸€å¤´å–æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®ï¼Œåˆ™é˜»å¡ä½ï¼Œç›´åˆ°æœ‰æ•°æ®æ—¶è¿”å›å–å‡ºæ•°æ®å¹¶è¿”å›ã€‚ åœ¨ Rust ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨é˜Ÿåˆ— VecQueue æ¥ä½œä¸ºæ•°æ®çš„æ‰¿è½½ï¼ŒåŒæ—¶ä¸ºäº†å¯¹é˜Ÿåˆ—è®¿é—®çš„å¹¶å‘å®‰å…¨ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨é” Mutex æ¥ä¿æŠ¤å®ƒï¼Œå¦å¤–ï¼Œåœ¨æ¶ˆè´¹è€…å–æ•°æ®æ—¶ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®ï¼Œåˆ™éœ€è¦é˜»å¡å¹¶ç­‰å¾…å”¤é†’ï¼ˆä½¿ç”¨å¾ªç¯ç­‰å¾…å°±å¤ªè€— CPU äº†ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ¡ä»¶å˜é‡ Condvar æ¥å®ç°æŒ‚èµ·å’Œå”¤é†’ã€‚ ç»è¿‡ä»¥ä¸Šåˆ†æï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰å¦‚ä¸‹çš„ç»“æ„ï¼š use std:: collections::VecDeque, sync::Condvar, Mutex,;pub struct ChannelT queue: MutexVecDequeT, item_ready: Condvar, send å’Œ receive æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š implT ChannelT pub fn new() - Self Self queue: Mutex::new(VecDeque::new()), item_ready: Condvar::new(), pub fn send(self, message: T) // ä¸Šé”å¹¶ä»é˜Ÿåˆ—åé¢æ’å…¥æ•°æ® self.queue.lock().unwrap().push_back(message); // å”¤é†’ä¸€ä¸ªç­‰å¾…æ•°æ®çš„çº¿ç¨‹ self.item_ready.notify_one(); pub fn receive(self) - T // æŠ¢å é˜Ÿåˆ— let mut b = self.queue.lock().unwrap(); loop // å°è¯•ä»é˜Ÿåˆ—ä¸­è·å–æ•°æ®ï¼Œå¦‚æœè·å–åˆ°ï¼Œåˆ™ç›´æ¥è¿”å›ï¼ˆå¹¶é‡Šæ”¾é”ï¼‰ if let Some(message) = b.pop_front() return message; // æ²¡æœ‰æ•°æ®ï¼Œåˆ™æŒ‚èµ·å½“å‰çº¿ç¨‹ï¼ˆåŒæ—¶é‡Šæ”¾é”ï¼‰ b = self.item_ready.wait(b).unwrap(); è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œself.queue.lock().unwrap() è¿”å›çš„ b æ˜¯ä¸€ä¸ª MutextGuardï¼Œæ‰€ä»¥å½“æ‰§è¡Œ self.item_ready.wait(b) çš„æ—¶å€™ï¼Œåœ¨æŒ‚èµ·å½“å‰çº¿ç¨‹çš„æ—¶å€™ï¼Œä¼šé‡Šæ”¾ bï¼Œæ‰€ä»¥è¿™é‡Œä¸ä¼šä¸€ç›´å ç”¨é”ï¼Œè€Œå¯¼è‡´å…¶ä»–çº¿ç¨‹æŠ¢ä¸åˆ°é”ã€‚ è¿™ä¸ªç‰ˆæœ¬çš„å®ç°åœ¨åŠŸèƒ½ä¸Šå½“ç„¶æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯åœ¨æ€§èƒ½ä¸Šè¿˜æœ‰éå¸¸å¤šå¯ä»¥ä¼˜åŒ–çš„åœ°æ–¹ï¼Œå°¤å…¶æ˜¯åœ¨é”çš„ä½¿ç”¨ä¸Šï¼Œåœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œé”çš„ç«äº‰ä¼šéå¸¸æ¿€çƒˆã€‚ OKï¼Œçƒ­å®Œèº«åï¼Œæˆ‘ä»¬å¼€å§‹åŸºäºè¿™ä¸ªå®ç°ï¼Œæ¥ä¸€æ­¥æ­¥å®ç°ä¸€ä¸ªé«˜æ€§èƒ½çš„ oneshot channelï¼ åŸºç¡€ç‰ˆ v1ï¼šunsafe æé†’ä½¿ç”¨è€… pub struct ChannelT queue: MutexVecDequeT, item_ready: Condvar, æˆ‘ä»¬å…ˆæ¥åˆ†æä¸€ä¸‹ï¼Œä¸€ä¸ª oneshot channel çš„ç»“æ„ï¼Œéœ€è¦åŒ…å«å“ªäº›å­—æ®µã€‚ é¦–å…ˆå®ƒå¯èƒ½ä¼šæœ‰ 0 æ¡æ•°æ®æˆ– 1 æ¡æ•°æ®ï¼Œæ‰€ä»¥å¾ˆå½“ç„¶ï¼Œæ•°æ®å¯ä»¥ç”¨ä¸€ä¸ª Option æ¥æ‰¿è½½ã€‚ å¦å¤–ï¼Œsend å’Œ receive å¯ä»¥åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­è¢«è°ƒç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½ç”¨å…±äº«åªè¯»å¼•ç”¨ï¼Œè€Œä¸æ˜¯ç”¨ mut ç‹¬äº«å¯å˜å¼•ç”¨ï¼Œä½†æ˜¯ send å’Œ receive éƒ½éœ€è¦å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œå°±éœ€è¦ä¸€ä¸ªæ”¯æŒå†…éƒ¨å¯å˜æ€§çš„æ•°æ®ç»“æ„ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œå°±ç”¨åˆ°äº†ä¸Šç¯‡ Rust å®æˆ˜ä¸¨æ‰‹å†™ä¸€ä¸ª SpinLock ä»‹ç»çš„ UnsafeCellTï¼Œå®ƒæ˜¯ Rust å¹¶å‘åŸè¯­çš„åŸºçŸ³ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚ æœ€åï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå˜é‡æ¥è¡¨æ˜æ˜¯å¦æœ‰æ•°æ®ï¼Œä¸ºäº†å¹¶å‘å®‰å…¨ï¼Œè¿™é‡Œå¯ä»¥ç”¨ AtomicBoolï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬ä¹Ÿå¢åŠ äº†ä¸€ä¸ª is_ready çš„æ–¹æ³•ï¼Œç”¨äºåˆ¤æ–­æ•°æ®æ˜¯å¦å·²å‡†å¤‡å¥½ã€‚ åŸºäºä»¥ä¸Šåˆ†æï¼Œæˆ‘ä»¬å®šå‡ºäº†æ–°çš„ Channel ç»“æ„ï¼š pub struct ChannelT message: UnsafeCellOptionT, ready: AtomicBool, å¯¹åº”çš„ sendã€receive å’Œ is_ready å®ç°å¦‚ä¸‹ï¼š implT ChannelT pub fn new() - Self Self message: UnsafeCell::new(None), ready: AtomicBool::new(false), /// Safety: Only call this once! pub unsafe fn send(self, message: T) unsafe self.message.get().write(Some(message)); self.ready.store(true, Ordering::Release); pub fn is_ready(self) - bool self.ready.load(Ordering::Acquire) /// Safety: Only call this once, /// and only after is_ready() returns true! pub unsafe fn receive(self) - T unsafe self.message.get().read().unwrap() åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼š æˆ‘ä»¬æš‚ä¸”ä½¿ç”¨ unsafe åŠ æ³¨é‡Šçš„æ–¹å¼ï¼Œæ¥ æé†’ ä½¿ç”¨è€…ï¼Œsend å’Œ receive åªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡ï¼ŒåŒæ—¶ï¼Œåœ¨è°ƒç”¨ receive ä¹‹å‰ï¼Œå¿…é¡»å…ˆä½¿ç”¨ is_ready è¿›è¡Œæ•°æ®æ£€æŸ¥ã€‚ å¯¹äºåŸå­å˜é‡ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€å¯¹ Release å’Œ Acquire æ¥ç¡®ä¿åŸå­å˜é‡çš„è·¨çº¿ç¨‹å¯è§æ€§ï¼Œå…·ä½“å¯å‚è€ƒ Rust åŸç†ä¸¨èŠä¸€èŠ Rust çš„ Atomic å’Œå†…å­˜é¡ºåºã€‚ å¦å¤–åˆ«å¿˜äº†ï¼ŒUnsafeCellT æ˜¯ä¸æ”¯æŒ Sync çš„ï¼Œæ‰€ä»¥ä¸ºäº†æˆ‘ä»¬çš„ Channel å¯ä»¥è·¨çº¿ç¨‹ä½¿ç”¨ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºå…¶å®ç° Sync traitï¼š // 1. ChannelT å¯ä»¥åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­è¢«åˆ†åˆ«æ‰§è¡Œ send å’Œ receiveï¼Œæ‰€ä»¥å®ƒçš„å¼•ç”¨å¯ä»¥åœ¨çº¿ç¨‹ä¸­å…±äº«ï¼Œæ‰€ä»¥éœ€è¦å®ç° Syncï¼›// 2. T ç”±çº¿ç¨‹ 1 ç”Ÿæˆå¹¶æ”¾å…¥ Channelï¼Œç„¶åç”±çº¿ç¨‹ 2 ä» Channel ä¸­è·å–ï¼Œæ‰€ä»¥å®ƒéœ€è¦ä»ä¸€ä¸ªçº¿ç¨‹è½¬ç§»åˆ°å¦å¤–ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥éœ€è¦å®ç° Sendã€‚unsafe implT Sync for ChannelT where T: Send ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š #[test]fn one_thread_should_work() let channel = Channel::new(); unsafe channel.send(1); ; if channel.is_ready() let msg = unsafe channel.receive() ; assert_eq!(msg, 1); #[test]fn cross_thread_should_work() let channel = Channel::new(); thread::scope(|s| s.spawn(|| sleep(Duration::from_millis(10)); unsafe channel.send(1); ; ); loop if channel.is_ready() let res = unsafe channel.receive() ; assert_eq!(res, 1); break; ); åŸºç¡€ç‰ˆ v2ï¼šä½¿ç”¨ MaybeUninit æ›¿ä»£ Option æˆ‘ä»¬å…ˆæ¥æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼šOptionT åœ¨ None çš„æ—¶å€™ï¼Œä¼šå ç”¨å†…å­˜å—ï¼Ÿ åœ¨ Rust ä¸­ï¼ŒOptionT ç±»å‹åœ¨å€¼ä¸º None æ—¶æ˜¯å¦å ç”¨å†…å­˜ï¼Œå–å†³äºæ³›å‹å‚æ•° T çš„ç±»å‹ç‰¹æ€§ã€‚å…·ä½“å¯åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š å½“ T æ˜¯éæŒ‡é’ˆç±»å‹ï¼ˆå¦‚åŸºæœ¬ç±»å‹ã€ç»“æ„ä½“ç­‰ï¼‰æ—¶ï¼ŒOptionT éœ€è¦é¢å¤–çš„ç©ºé—´å­˜å‚¨ Some æˆ– None çš„æ ‡ç­¾ï¼Œæ­¤æ—¶ï¼š å†…å­˜å¸ƒå±€ï¼šåŒ…å«ä¸€ä¸ª 1 å­—èŠ‚çš„æ ‡ç­¾ï¼ˆæ ‡è¯† Some æˆ– Noneï¼‰å’Œ T ç±»å‹çš„æ•°æ®ç©ºé—´ï¼ˆå¯èƒ½åŒ…å«å¯¹é½å¡«å……ï¼‰ã€‚ å³ä½¿ä¸º Noneï¼Œä»éœ€ä¿ç•™ T æ‰€éœ€çš„å†…å­˜ç©ºé—´ï¼ˆå«å¡«å……ï¼‰ï¼Œä»¥ä¿éšœæšä¸¾å€¼å¤§å°ç»Ÿä¸€ã€‚å¦‚ Optioni32 å ç”¨ 8 å­—èŠ‚ï¼ˆ1 å­—èŠ‚æ ‡ç­¾ + 4 å­—èŠ‚ i32 + 3 å­—èŠ‚å¡«å……ï¼‰ã€‚ å½“ T æ˜¯ä¸å¯ä¸ºç©ºçš„æŒ‡é’ˆç±»å‹ï¼ˆå¦‚ BoxTã€Tã€mut Tï¼‰æ—¶ï¼ŒRust ç¼–è¯‘å™¨ä¼šå¯ç”¨ç©ºæŒ‡é’ˆä¼˜åŒ–ï¼ˆNiche Optimizationï¼‰ã€‚å³åˆ©ç”¨æŒ‡é’ˆä¸èƒ½ä¸º 0 çš„ç‰¹æ€§ï¼Œå°† None æ ‡è¯†ä¸ºå…¨é›¶ä½æ¨¡å¼ï¼ˆ0x00ï¼‰ï¼Œè€Œ Some(ptr) å­˜å‚¨å®é™…æŒ‡é’ˆåœ°å€ï¼Œæ­¤æ—¶æ— éœ€é¢å¤–æ ‡ç­¾ã€‚è¿™ä¸ªæ—¶å€™ï¼ŒNone å’Œ Some(T) ä¸å ç”¨ä»»ä½•çš„é¢å¤–ç©ºé—´ï¼Œå¤§å°ä¸ T ç›¸åŒã€‚ æˆ‘ä»¬å¯ä»¥å†™ä¸ªç¨‹åºæ¥ç®€å•éªŒè¯ä¸€ä¸‹ï¼š fn test_option() // 1. åŸºæœ¬æ•°æ®ç±»å‹ let i: i32 = 1; let i_none: Optioni32 = None; let i_some: Optioni32 = Some(1); println!(åŸºæœ¬ç±»å‹ï¼š); println!(i32: bytes, ptr: :p, mem::size_of_val(i), i); // 4 bytes println!(Nonei32: bytes, ptr: :p, mem::size_of_val(i_none), i_none); // 8 bytes println!(Somei32: bytes, ptr: :p, mem::size_of_val(i_some), i_some); // 8 bytes // 2. è‡ªå®šä¹‰ç±»å‹ #[repr(C)] struct Data a: u64, b: u32, let data = Data a: 1, b: 1 ; let data_none: OptionData = None; let data_some: OptionData = Some(Data a: 1, b: 1 ); println!( è‡ªå®šä¹‰ç»“æ„ä½“ï¼š); println!(Data: bytes, ptr: :p, mem::size_of_val(data), data); // 16 bytes println!(NoneData: bytes, ptr: :p, mem::size_of_val(data_none), data_none); // 24 bytes println!(SomeData: bytes, ptr: :p, mem::size_of_val(data_some), data_some); // 24 bytes // 3. æŒ‡é’ˆç±»å‹ let b = Box::new(1); let b_none: OptionBoxi32 = None; let b_some: OptionBoxi32 = Some(Box::new(1)); println!( æŒ‡é’ˆç±»å‹ï¼š); println!(Boxi32: bytes, ptr: :p, mem::size_of_val(b), b); // 8 bytes println!(NoneBoxi32: bytes, ptr: :p, mem::size_of_val(b_none), b_none); // 8 bytes println!(SomeBoxi32: bytes, ptr: :p, mem::size_of_val(b_some), b_some); // 8 bytes let none_value = unsafe *(b_none as *const _ as *const i64) ; println!(NoneBoxi32 bit pattern: :#x, none_value); // 0x0 let some_value = unsafe *(b_some as *const _ as *const i64) ; println!(NoneBoxi32 bit pattern: :#x, some_value); // 0x15d0043c0 åœ¨ç¬”è€…çš„ç”µè„‘ä¸‹ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š åŸºæœ¬ç±»å‹ï¼ši32: 4 bytes, ptr: 0x16bef203cNonei32: 8 bytes, ptr: 0x16bef2040Somei32: 8 bytes, ptr: 0x16bef2048è‡ªå®šä¹‰ç»“æ„ä½“ï¼šData: 16 bytes, ptr: 0x16bef2200NoneData: 24 bytes, ptr: 0x16bef2210SomeData: 24 bytes, ptr: 0x16bef2228æŒ‡é’ˆç±»å‹ï¼šBoxi32: 8 bytes, ptr: 0x16bef23f8NoneBoxi32: 8 bytes, ptr: 0x16bef2400SomeBoxi32: 8 bytes, ptr: 0x16bef2408NoneBoxi32 bit pattern: 0x0 é€šè¿‡è¾“å‡ºæˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ°ç»è¿‡ç©ºæŒ‡é’ˆä¼˜åŒ–ï¼ŒOptionBoxi32 çš„ None å’Œ Some éƒ½åªå  8 å­—èŠ‚ï¼ˆä¸ Boxi32 ç›¸åŒï¼‰ï¼ŒåŒæ—¶é€šè¿‡ä¸º None å¤ç”¨ç±»å‹çš„æ— æ•ˆä½æ¨¡å¼ï¼ˆå¦‚ 0x0ï¼‰æ¶ˆé™¤æšä¸¾æ ‡ç­¾ï¼Œå®ç°é›¶æˆæœ¬æŠ½è±¡ã€‚ ç»“åˆä¸Šè¿°åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼šOptionT å¯èƒ½éœ€è¦é¢å¤–æ¶ˆè€—æ ‡è®°ä½å’Œå¡«å……ä½çš„ç©ºé—´ã€‚ å¦å¤–ä¸€ç‚¹æ˜¯ï¼ŒOptionT å…¶å®å·²ç»åŒ…å«äº†æ˜¯å¦å­˜åœ¨å€¼çš„ä¿¡æ¯äº†ï¼Œå®ƒè·Ÿ ready è¿™ä¸ªæ ‡å¿—çš„ä½œç”¨å…¶å®é‡å¤äº†ï¼Œæœ‰ä¸€äº›æµªè´¹ã€‚ åœ¨å½“ä¸‹åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦å¤–ä¸€ä¸ªæ•°æ®ç»“æ„æ¥æ›¿ä»£ OptionT â€”â€” MaybeUninitTï¼Œç›¸æ¯”äº OptionTï¼Œå®ƒæœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š å†…å­˜å ç”¨ä¼˜åŒ–ï¼šåœ¨ OptionT ä¸­ï¼Œå¯¹äºéç©ºæŒ‡é’ˆä¼˜åŒ–ï¼ˆNiche Optimizationï¼‰çš„ç±»å‹ï¼ŒNone ä¼šå ç”¨é¢å¤–çš„ç©ºé—´ï¼ˆä¸€ä¸ªå­—èŠ‚çš„æ ‡ç­¾+å¯èƒ½çš„å¯¹é½å¡«å……ï¼‰ã€‚è€Œ MaybeUninitT æœ¬èº«å°±æ˜¯ä¸€ä¸ªå¤§å°ä¸ T ç›¸åŒçš„æœªåˆå§‹åŒ–å†…å­˜ï¼Œå®ƒæ²¡æœ‰æ ‡ç­¾ï¼Œå› æ­¤ä¸ä¼šå¼•å…¥é¢å¤–çš„å†…å­˜å¼€é”€ã€‚ é¿å…åˆå§‹åŒ–å¼€é”€ï¼šä½¿ç”¨ OptionT æ—¶ï¼Œåœ¨åˆå§‹åŒ–æ—¶è®¾ç½®ä¸º Noneï¼Œå®é™…ä¸Šä¼šå†™å…¥ä¸€ä¸ªè¡¨ç¤º None çš„å€¼ï¼ˆå³è¿›è¡Œåˆå§‹åŒ–ï¼‰ã€‚è€Œ MaybeUninitT çš„ uninit() ä¸ä¼šå¯¹å†…å­˜è¿›è¡Œä»»ä½•åˆå§‹åŒ–ï¼Œè¿™åœ¨æ€§èƒ½æ•æ„Ÿçš„åœºæ™¯ä¸‹å¯ä»¥é¿å…ä¸å¿…è¦çš„åˆå§‹åŒ–å¼€é”€ï¼ˆç‰¹åˆ«æ˜¯å½“ T å¾ˆå¤§æ—¶ï¼‰ã€‚ æ›´çµæ´»åœ°æ§åˆ¶åˆå§‹åŒ–ï¼šåœ¨é€šé“çš„å®ç°ä¸­ï¼Œæ¶ˆæ¯å¯èƒ½ç”±ç”Ÿäº§è€…å†™å…¥ï¼Œç„¶åé€šè¿‡è®¾ç½® ready æ ‡å¿—æ¥é€šçŸ¥æ¶ˆè´¹è€…ã€‚ä½¿ç”¨ MaybeUninit å…è®¸æˆ‘ä»¬å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç›´åˆ°å®é™…éœ€è¦å†™å…¥æ¶ˆæ¯çš„æ—¶å€™ã€‚è¿™æ ·ï¼Œåœ¨é€šé“åˆ›å»ºæ—¶ï¼Œæˆ‘ä»¬ä¸éœ€è¦ä¸º T ç±»å‹çš„å€¼è¿›è¡Œä»»ä½•åˆå§‹åŒ–ï¼ˆå³ä½¿æ˜¯ Noneï¼‰ï¼Œè€Œæ˜¯ç•™å‡ºä¸€å—æœªåˆå§‹åŒ–çš„å†…å­˜ï¼Œåœ¨åç»­ç”±ç”Ÿäº§è€…å†™å…¥å®é™…çš„å€¼ã€‚ ä¸åŸå­æ ‡å¿—é…åˆæ›´é«˜æ•ˆï¼šåœ¨ä¸Šä¸ªç‰ˆæœ¬çš„è§†çº¿ä¸­ï¼Œready æ˜¯ä¸€ä¸ª AtomicBoolï¼Œç”¨äºæŒ‡ç¤ºæ¶ˆæ¯æ˜¯å¦å°±ç»ªã€‚åœ¨ OptionT ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ£€æŸ¥ Option æ˜¯å¦ä¸º Someï¼ŒåŒæ—¶è¿˜è¦æ£€æŸ¥ ready æ ‡å¿—ã€‚è€Œä½¿ç”¨ MaybeUninit åï¼Œæˆ‘ä»¬å®Œå…¨ä¾èµ– ready æ ‡å¿—æ¥åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦å¯ç”¨ï¼Œé¿å…äº†åŒé‡æ£€æŸ¥ï¼ˆå› ä¸º MaybeUninit æœ¬èº«ä¸æºå¸¦çŠ¶æ€ï¼Œæ‰€ä»¥çŠ¶æ€å®Œå…¨ç”± ready æ§åˆ¶ï¼‰ã€‚è¿™æ ·ï¼Œç»“æ„ä½“çš„å†…å­˜å¸ƒå±€æ›´ç´§å‡‘ï¼Œä¸”è®¿é—®æ¨¡å¼æ›´ç›´æ¥ã€‚ æ½œåœ¨çš„æ€§èƒ½æå‡ï¼šç”±äºé¿å…äº†é¢å¤–çš„æ ‡ç­¾å’Œåˆå§‹åŒ–ï¼Œä»¥åŠæ›´ç´§å‡‘çš„å†…å­˜å¸ƒå±€ï¼Œå¯èƒ½ä¼šæé«˜ç¼“å­˜åˆ©ç”¨ç‡ï¼Œä»è€Œæå‡æ€§èƒ½ã€‚ MaybeUninitT æœ‰ä»¥ä¸‹å¸¸ç”¨æ–¹æ³•ï¼š å¸¸ç”¨æ–¹æ³• ä½œç”¨ å®‰å…¨çº§åˆ« MaybeUninit::uninit() åˆ›å»ºä¸€å—å®Œå…¨æœªåˆå§‹åŒ–çš„å†…å­˜ const fnã€safe as_mut_ptr() / as_ptr() å–å‡ºè£¸æŒ‡é’ˆï¼Œä¾›å¤–éƒ¨å†™å…¥æˆ–è¯»å– safe assume_init() / assume_init_read() å‘Šè¯‰ç¼–è¯‘å™¨â€œè¿™é‡Œå·²ç»æ˜¯ä¸€ä¸ªåˆæ³•çš„ T äº†â€ï¼Œå¹¶è¿”å›å®ƒ unsafeï¼ˆå› ä¸ºä½ å¾—ä¿è¯çœŸåˆå§‹åŒ–è¿‡ï¼‰ write(val) æŒ‰ä½æŠŠ val å¤åˆ¶/ç§»åŠ¨ åˆ°è¿™å—æœªåˆå§‹åŒ–å†…å­˜ï¼›æ­¤åè§†ä¸ºå·²åˆå§‹åŒ– unsafe ç»è¿‡ä¸Šé¢ä¸€é¡¿åˆ†æï¼Œæˆ‘ä»¬æ¥ä½¿ç”¨ MaybeUninitT æ¥æ›¿ä»£ OptionTï¼Œè¿›ä¸€æ­¥å‡å°‘å†…å­˜å ç”¨å’Œæå‡æ€§èƒ½ï¼Œæ–°çš„ Channel ç»“æ„å¦‚ä¸‹ï¼š pub struct ChannelT message: UnsafeCellMaybeUninitT, ready: AtomicBool,implT ChannelT pub fn new() - Self Self // åˆ›å»ºä¸€å—å®Œå…¨æœªåˆå§‹åŒ–çš„å†…å­˜ï¼Œå…ˆå ä½ message: UnsafeCell::new(MaybeUninit::uninit()), ready: AtomicBool::new(false), å¯¹åº”çš„ send å’Œ receive å®ç°æ›´æ–°å¦‚ä¸‹ï¼š implT ChannelT /// Safety: Only call this once! pub unsafe fn send(self, message: T) unsafe // ä» UnsafeCellMaybeUninitT ä¸­å–å‡º MaybeUninitT å¹¶å†™å…¥æ•°æ®ã€‚ (*self.message.get()).write(message); self.ready.store(true, Ordering::Release); /// Safety: Only call this once, /// and only after is_ready() returns true! pub unsafe fn receive(self) - T // ä» UnsafeCellMaybeUninitT ä¸­å–å‡º MaybeUninitT å¹¶è¯»å‡ºæ•°æ®ã€‚ unsafe (*self.message.get()).assume_init_read() å…¶ä¸­ send ä¸­ï¼Œ(*self.message.get()) ä» UnsafeCellMaybeUninitT ä¸­å–å‡º MaybeUninitTï¼Œç„¶åè°ƒç”¨ write æ–¹æ³•æŠŠ message å†™å…¥è¿™å—æœªåˆå§‹åŒ–çš„å†…å­˜ä¸­ï¼Œæ­¤åè§†ä¸ºå·²åˆå§‹åŒ–ï¼Œå¹¶å¯ä»¥ä½¿ç”¨ä½¿ç”¨ assume_init_read è¿›è¡Œè¯»å–ã€‚ ä¿®æ”¹åï¼Œæµ‹è¯•ä»£ç æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œæˆ‘ä»¬æ‰§è¡Œä¹‹å‰çš„æµ‹è¯•ä»£ç ï¼Œå‘ç°è¿˜æ˜¯å¯ä»¥é€šè¿‡çš„ï¼ åŸºç¡€ç‰ˆ v3ï¼šå¢åŠ åŠ¨æ€æ£€æŸ¥æé«˜å®‰å…¨æ€§ ä¸Šè¿°ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ unsafe å’Œæ³¨é‡Šå»â€œè¦æ±‚â€è°ƒç”¨è€…ä¸¥æ ¼éµå¾ªä»¥ä¸‹çº¦æŸï¼š send å’Œ receive æœ€å¤šåªè°ƒç”¨ä¸€æ¬¡ã€‚ receive è°ƒç”¨ä¹‹å‰ï¼Œå¿…é¡»å…ˆç»è¿‡ is_ready çš„æ£€æŸ¥ã€‚ åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬åŠ ä¸€ä¸‹åŠ¨æ€æ£€æŸ¥ï¼Œå¦‚æœè°ƒç”¨è€…ä¸æŒ‰è¦æ±‚åšäº‹ï¼Œé‚£å°±ç›´æ¥ panic ç»™å‡ºå‘Šè­¦ã€‚ åœ¨ receive ä¸­ï¼Œæˆ‘ä»¬éœ€è¦åš 2 ç‚¹ä¿è¯ï¼šâ‘  å·²ç»æœ‰æ•°æ®äº†ï¼Œâ‘¡ æ•°æ®åªè¢«æ¶ˆè€—äº†ä¸€æ¬¡ã€‚ pub unsafe fn receive(self) - T if !self.ready.swap(false, Ordering::Acquire) panic!(no message available!) unsafe (*self.message.get()).assume_init_read() è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ swapï¼Œå°† ready ä» false è½¬ä¸º trueï¼Œè¾¾åˆ°äº† 2 ä¸ªç›®çš„ï¼š å¦‚æœè¿”å›äº† falseï¼Œåˆ™è¯´æ˜ä¹‹å‰çš„ ready ä¸º falseï¼Œå³æ•°æ®æ²¡å‡†å¤‡å¥½ã€‚ å¦‚æœè¿”å›äº† trueï¼Œåˆ™è¯´æ˜æ•°æ®å·²ç»å‡†å¤‡å¥½äº†ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œä¹Ÿå·²ç»å°† ready ç½®ä¸º falseï¼Œè¿™æ ·åé¢è°ƒç”¨çš„ receive ä¹Ÿå°†å¤±è´¥ã€‚ å¯¹äº sendï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯åªå†™å…¥ä¸€æ¬¡ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦å¼•å…¥ä¸€ä¸ªæ–°çš„å˜é‡ in_userï¼Œè¡¨ç¤º send æ˜¯å¦å·²ç»ä½¿ç”¨äº†ï¼š pub struct ChannelT message: UnsafeCellMaybeUninitT, in_use: AtomicBool, // æ–°å˜é‡ï¼Œè¡¨ç¤º send æ˜¯å¦å·²ç»ä½¿ç”¨äº†ã€‚ ready: AtomicBool,implT ChannelT pub fn new() - Self Self message: UnsafeCell::new(MaybeUninit::uninit()), in_use: AtomicBool::new(false), ready: AtomicBool::new(false), åœ¨ send ä¸­ï¼Œæˆ‘ä»¬ä¾æ—§ä½¿ç”¨ swapï¼Œæ¥å°† in_use ä»è½¬ä¸º trueï¼Œå¦‚æœè¿”å› trueï¼Œåˆ™è¯´æ˜ä¹‹å‰å·²ç»æ‰§è¡Œè¿‡ send äº†ï¼Œè¿™ä¸ªæ—¶å€™å°†æ‰§è¡Œ panic è¿›è¡Œå‘Šè­¦ã€‚ /// Panics when trying to send more than one message.pub unsafe fn send(self, message: T) if self.in_use.swap(true, Ordering::Relaxed) panic!(cant send more than one message) unsafe (*self.message.get()).write(message); self.ready.store(true, Ordering::Release); é€šè¿‡ä¸Šè¿°çš„ 2 ä¸ªä¼˜åŒ–ï¼Œæˆ‘ä»¬çš„ Channel åˆâ€œå®‰å…¨â€äº†ä¸€ä¸¢ä¸¢ï¼ åŸºç¡€ç‰ˆ v4ï¼šå®ç° Drop é¿å…å†…å­˜æ³„éœ² å› ä¸ºæˆ‘ä»¬ä½¿ç”¨äº† MaybeUninitTï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è‡ªå·±ç®¡ç† T çš„å†…å­˜ç®¡ç†ï¼Œä½†åœ¨ä¸Šè¿°çš„å®ç°ä¸­ï¼Œå¯èƒ½å­˜åœ¨ä¸€ç§æƒ…å†µï¼Œå¯¼è‡´å†…å­˜å¾—ä¸åˆ°é‡Šæ”¾ï¼šæˆ‘ä»¬åªæ‰§è¡Œäº† sendï¼Œä½†ç›´åˆ° Channel è¶…è¿‡ä½œç”¨åŸŸçš„æ—¶å€™ï¼Œéƒ½æ²¡æœ‰è¢« receiveã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä¸º Channel å®ç° Drop traitï¼Œå½“æœ‰æ•°æ®çš„æ—¶å€™ï¼Œå¯¹MaybeUninitT è¿›è¡Œå†…å­˜é‡Šæ”¾ï¼š implT Drop for ChannelT fn drop(mut self) if *self.ready.get_mut() unsafe self.message.get_mut().assume_init_drop(); å®‰å…¨éé˜»å¡ç‰ˆ v5ï¼šæä¾›å®‰å…¨æ–¹æ³•ï¼Œå‡å°‘ä½¿ç”¨è€…è¯¯ç”¨ åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬æ¥è§£å†³å‰é¢å®ç°çš„æœ€å¤§é—®é¢˜ï¼šæ–¹æ³•æ˜¯ä¸å®‰å…¨çš„ï¼Œä¸¥é‡ä¾èµ–è°ƒç”¨è€…çš„è‡ªè§‰æ€§ï¼Œæ²¡æœ‰å……åˆ†å‘æŒ¥ Rust å¼ºå¤§ç¼–è¯‘å™¨çš„æ£€æŸ¥èƒ½åŠ›ã€‚ å›é¡¾æˆ‘ä»¬çš„éœ€æ±‚ï¼šæˆ‘ä»¬è¦å®ç°çš„æ˜¯ä¸€ä¸ª oneshot channelï¼Œå³åªèƒ½è°ƒç”¨ä¸€æ¬¡ send å’Œ receiveã€‚ ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯ï¼šå¦‚ä½•åˆ©ç”¨ Rust å¤©ç„¶çš„ç¼–è¯‘å™¨æ£€æŸ¥èƒ½åŠ›æ¥çº¦æŸè¿™ä¸€ç‚¹å‘¢ï¼Ÿå¾ˆæ˜æ˜¾ï¼Œå°±æ˜¯æ‰€æœ‰æƒæœºåˆ¶ï¼ä»€ä¹ˆä¸œè¥¿åªèƒ½æ‰§è¡Œä¸€æ¬¡å‘¢ï¼Ÿæ¶ˆè€—æ‰€æœ‰æƒçš„ä¸œè¥¿ï¼ // å¯¹äºç¬¬ä¸€ä¸ªå‚æ•°ä¸º self çš„æ–¹æ³•ï¼Œæ‰§è¡Œæ—¶ï¼Œä¼šè½¬ç§»æ‰€æœ‰æƒï¼Œæ‰§è¡Œåï¼ŒåŸå˜é‡å°±ä¸èƒ½å†ç”¨äº†ï¼Œå› ä¸ºæ‰€æœ‰æƒå·²ç»è½¬ç§»äº†ã€‚fn do(self) å¥½ï¼Œé‚£ç¬¬äºŒä¸ªé—®é¢˜å°±æ¥äº†ï¼šself æ–¹æ³•åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œä½†å¾ˆæ˜æ˜¾æˆ‘ä»¬æ€»å…±éœ€è¦ 2 æ¬¡çš„è°ƒç”¨ï¼ˆsend å’Œ receiveï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¯ä»¥å°† Channel è¿›è¡Œæ‹†å¼€ï¼Œåˆ†æˆ Sender å’Œ Receiverã€‚ é‚£ç¬¬ä¸‰ä¸ªé—®é¢˜ä¹Ÿå°±éšä¹‹è€Œæ¥äº†ï¼ŒSender å’Œ Receiver éƒ½éœ€è¦æŒæœ‰ Channelï¼Œå¹¶ä¸”å¯èƒ½å¤„äºä¸åŒçš„çº¿ç¨‹ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥å…ˆç”¨ Arc æ¥å¯¹ Channel è¿›è¡Œå¼•ç”¨ã€‚ è§£å†³äº†ä¸Šè¿° 3 ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥æ¢³ç†æ–°çš„æ•°æ®ç»“æ„ï¼š pub struct SenderT channel: ArcChannelT,pub struct ReceiverT channel: ArcChannelT,struct ChannelT message: UnsafeCellMaybeUninitT, ready: AtomicBool,pub fn channelT() - (SenderT, ReceiverT) let a = Arc::new(Channel message: UnsafeCell::new(MaybeUninit::uninit()), ready: AtomicBool::new(false), ); (Sender channel: a.clone() , Receiver channel: a ) Channel ä¸­ç§»é™¤äº† in_use å±æ€§ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»æœ‰ self åšæ‰€æœ‰æƒæ£€æŸ¥äº†ï¼Œä¸å†éœ€è¦ in_use æ¥é¿å…é‡å¤è°ƒç”¨ send äº†ã€‚ æ–°å¢äº† SenderT å’Œ ReceiverT ä¸¤ä¸ªç»“æ„ï¼Œå®ƒä»¬éƒ½å„è‡ªæŒæœ‰äº†ä¸€ä¸ª ArcChannelã€‚ å¯¹åº”çš„ send å’Œ receive æ–¹æ³•å½“ç„¶ä¹Ÿå°±è½¬ç§»åˆ° SenderT å’Œ ReceiverT èº«ä¸Šäº†ï¼Œå®ç°ä¹Ÿå’Œä¹‹å‰åŸºæœ¬ä¸€è‡´ï¼š implT SenderT pub fn send(self, messgae: T) unsafe (*self.channel.message.get()).write(messgae) ; self.channel.ready.store(true, Ordering::Release); implT ReceiverT pub fn is_ready(self) - bool self.channel.ready.load(Ordering::Relaxed) /// Safety: only after is_ready() returns true! pub fn receive(self) - T if !self.channel.ready.swap(false, Ordering::Acquire) panic!(no message available!); unsafe (*self.channel.message.get()).assume_init_read() // Drop æ²¡å˜ ä¿®æ”¹äº†ç»“æ„äº†ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹å¯¹åº”çš„æµ‹è¯•ä»£ç ï¼š #[test]fn one_thread_should_work() let (sender, receiver) = channel(); sender.send(1); if receiver.is_ready() let msg = receiver.receive(); assert_eq!(msg, 1); #[test]fn cross_thread_should_work() let (sender, reciver) = channel(); thread::scope(|s| s.spawn(|| sleep(Duration::from_millis(10)); sender.send(1); // æ²¡æœ‰ unsafe äº†ï¼ ); loop if reciver.is_ready() let res = reciver.receive(); // æ²¡æœ‰ unsafe äº†ï¼ assert_eq!(res, 1); break; ); åœ¨æœ€æ–°çš„æµ‹è¯•ä»£ç ä¸­ï¼Œæˆ‘ä»¬å·²ç»ä¸å†éœ€è¦ unsafe ä»£ç äº†ï¼è¿™å¯¹äºä½¿ç”¨è€…æ¥è¯´ï¼Œå°±éå¸¸å‹å¥½äº†ï¼ è€Œä¸”è¿™ä¸ªæ—¶å€™ï¼Œä½ å¦‚æœå°è¯•æ‰§è¡Œå¤šæ¬¡ send å’Œ receiver çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨å°±ä¼šæŠ¥é”™äº†ï¼ ä¸è¿‡å®ƒè¿˜æ˜¯æœ‰ 2 ä¸ªç¼ºç‚¹ï¼š Arc çš„å¤åˆ¶è¿˜æ˜¯æœ‰ä¸€äº›å¼€é”€çš„ã€‚ æˆ‘ä»¬ä¾æ—§ä¾èµ–ä½¿ç”¨è€…æå‰ç”¨ is_ready æ¥æ£€æŸ¥ï¼Œå¦åˆ™ç›´æ¥è°ƒç”¨ receive å°±æœ‰å¯èƒ½ä¼š panicã€‚ æˆ‘ä»¬å…ˆæ¥è§£å†³ç¬¬ 1 ä¸ªé—®é¢˜ã€‚ å®‰å…¨éé˜»å¡ç‰ˆ v6ï¼šä½¿ç”¨ç”Ÿå‘½å‘¨æœŸåŠ å¼•ç”¨ï¼Œé¿å… Arc çš„å¤åˆ¶å¼€é”€ ä¸ºäº†é¿å… Arc çš„å¼€é”€ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ SenderT å’Œ ReceiverT ä¸­æŒæœ‰ ChannelT çš„å¼•ç”¨ï¼Œè€Œå¼•ç”¨çš„å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸ç¡®å®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åŠ å…¥ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨ï¼Œæ¥å‘Šè¯‰ç¼–è¯‘å™¨æˆ‘ä»¬çš„å¼•ç”¨æ˜¯é€»è¾‘è‡ªæ´½çš„ã€‚ æ–°çš„ç»“æ„å’Œæ„é€ å‡½æ•°å¦‚ä¸‹ï¼š pub struct Sendera, T channel: a ChannelT, // ä½¿ç”¨å¼•ç”¨æ›¿ä»£ Arcï¼Œå¹¶åŠ å…¥ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨pub struct Receivera, T channel: a ChannelT, // ä½¿ç”¨å¼•ç”¨æ›¿ä»£ Arcï¼Œå¹¶åŠ å…¥ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨pub struct ChannelT message: UnsafeCellMaybeUninitT, ready: AtomicBool,implT ChannelT pub const fn new() - Self Self message: UnsafeCell::new(MaybeUninit::uninit()), ready: AtomicBool::new(false), pub fn splita(a mut self) - (Sendera, T, Receivera, T) *self = Self::new(); (Sender channel: self , Receiver channel: self ) // Drop æ²¡å˜ åœ¨è¿™ä¸ªç‰ˆæœ¬çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬æ–°å¢äº† split æ–¹æ³•ï¼š å…¶ä¸­å‚æ•° 'a mut self è¡¨æ˜å®ƒæ˜¯ä¸€ä¸ªç‹¬å å¼•ç”¨ï¼Œå³ channel.split() ä¸ä¼šæœ‰å¹¶å‘é—®é¢˜ã€‚ ç¬¬ä¸€è¡Œä»£ç  *self = Self::new() æˆ‘ä»¬å¯¹åŸæœ‰çš„ Channel è¿›è¡Œé‡ç½®ï¼Œä¿è¯æ‹†åˆ†ä¹‹å‰é€šé“é‡Œç»å¯¹æ²¡æœ‰æ®‹ç•™æ•°æ®ï¼Œé¿å…æ—§æ¶ˆæ¯è¢«ä¸‹ä¸€å¯¹ Sender/Receiver è¯¯è¯»ã€‚ 'a ç›´æ¥æ¥è‡ªäº 'a mut selfï¼Œä¿è¯ä¸¤ç«¯æŠŠæ‰‹ç»ä¸ä¼šæ¯”åŸå§‹ Channel æ´»å¾—æ›´ä¹…ã€‚ æ–°çš„æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š #[test]fn one_thread_should_work() let mut channel = Channel::new(); let (sender, receiver) = channel.split(); sender.send(1); if receiver.is_ready() let msg = receiver.receive(); assert_eq!(msg, 1); #[test]fn cross_thread_should_work() let mut channel = Channel::new(); let (sender, receiver) = channel.split(); thread::scope(|s| s.spawn(|| sleep(Duration::from_millis(100)); sender.send(1); ); while !receiver.is_ready() assert_eq!(receiver.receive(), 1); ); å®‰å…¨é˜»å¡ç‰ˆ v7ï¼šå»æ‰ is_ready å®Œå…¨é¿å…ä½¿ç”¨è€…è¯¯è°ƒç”¨ æˆªæ­¢ç›®å‰çš„å®ç°ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä¾èµ–ä½¿ç”¨è€…åœ¨æ‰§è¡Œ receive ä¹‹å‰å…ˆæ‰§è¡Œ is_ready è¿›è¡Œæ•°æ®æ£€æŸ¥ï¼Œè¿˜æ˜¯å­˜åœ¨ä¸€å®šçš„è¯¯æ“ä½œæ€§ã€‚ç°åœ¨æˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªå®Œå…¨é˜»å¡çš„ç‰ˆæœ¬ï¼Œæ¥å®Œå…¨é¿å…è¿™ä¸ªæƒ…å†µã€‚ æˆ‘ä»¬éœ€è¦åšå‡ ä»¶äº‹æƒ…ï¼š å»æ‰ is_ready æ–¹æ³•ï¼› åœ¨ receive ä¸­ï¼Œæ ¹æ® ready åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ•°æ®ï¼š å¦‚æœå­˜åœ¨ï¼Œåˆ™ç›´æ¥å–å‡ºæ•°æ®å¹¶è¿”å›ï¼› å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™éœ€è¦å…ˆæŒ‚èµ·å½“å‰çº¿ç¨‹ï¼Œç­‰å¾…å”¤é†’ï¼ˆç›´æ¥ CPU å¾ªç¯æ£€æŸ¥è‚¯å®šå¯ä»¥ï¼Œä½†ä¸å¤Ÿä¼˜é›…ï¼å’±ä¸å¹²ï¼ï¼‰ï¼› åœ¨ send ä¸­ï¼Œæ”¾å…¥æ•°æ®åï¼Œå°è¯•å”¤é†’å¯èƒ½å¤„äºæŒ‚èµ·ä¸­çš„çº¿ç¨‹ã€‚ é‚£ç°åœ¨æœ€é‡è¦çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼šå¦‚ä½•å”¤é†’å¤„äºæŒ‚èµ·ä¸­çš„çº¿ç¨‹ï¼Ÿæ›´è¿›ä¸€æ­¥ï¼Œå”¤é†’å“ªä¸ªçº¿ç¨‹ï¼Ÿ è¿™é‡Œå…¶å®æ˜¯è¯´ä¸å®šçš„ï¼Œå› ä¸º Sender å’Œ Receiver éƒ½å¯èƒ½è¢«æ”¾å…¥ä»»ä½•ä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œä¸è¿‡åœ¨ Rust Atomics and Locks ä¹¦ä¸­ï¼Œä½œè€…å‡å®šäº† Recevier ä¼šå›ºå®šåœ¨è°ƒç”¨ split çš„é‚£ä¸ªçº¿ç¨‹ã€‚ ç¬”è€…è®¤ä¸ºè¿™ä¸ªå‡è®¾æ˜¯ç®€å•ä¸”æœ‰æ•ˆçš„ï¼Œå›é¡¾ä¸€ä¸‹æˆ‘ä»¬å‰é¢ä¸¾çš„ Go è¯­è¨€çš„ 2 ä¸ªä¾‹å­ï¼š func demo1() done := make(chan struct) // ç±»ä¼¼äº split\tgo func() // ... do something close(done)\t()\t-done // receiver func demo2() oneShot := make(chan string, 1) // ç±»ä¼¼äº split\tgo func() oneShot - generateText()\t()\ttext := -oneShot // receiver\tdoSthWithText(text) åœ¨è¿™ä¸¤ä¸ªæœ€å¸¸è§çš„ oneshot channel çš„ä¾‹å­ä¸­ï¼Œrecevier å°±æ˜¯å¤„äºè°ƒç”¨ split çš„çº¿ç¨‹ä¸­ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åŸºäºè¿™ä¸ªå‡è®¾æ¥å®ç°è¿™ä¸ªç‰ˆæœ¬ã€‚ å…ˆå›é¡¾ä¸‹ Thread 2 ä¸ªæœ€æ ¸å¿ƒçš„æ–¹æ³•ï¼š Thread.park(thread): æŒ‚èµ·çº¿ç¨‹ï¼Œç­‰å¾…å”¤é†’ã€‚ thread.unpark(): å”¤é†’çº¿ç¨‹ã€‚ é¦–å…ˆæˆ‘ä»¬éœ€è¦åœ¨ Sender ä¸­ä¿å­˜å¾…å”¤é†’çš„çº¿ç¨‹ï¼š pub struct Sendera, T channel: a ChannelT, receiving_thread: Thread, åœ¨ split() çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦è·å–å½“å‰çº¿ç¨‹å¹¶ä¿å­˜åœ¨ Sender ä¸­ï¼š pub fn splita(a mut self) - (Sendera, T, Receivera, T) *self = Self::new(); ( Sender channel: self, // è·å–å½“å‰çº¿ç¨‹ã€‚è®°ä½ï¼è¿™é‡Œæˆ‘ä»¬å‡è®¾äº† receiver ä¼šå›ºå®šåœ¨ split çš„çº¿ç¨‹ä¸­ï¼ receiving_thread: thread::current(), , Receiver channel: self , ) åœ¨ recevier çš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŒ‚èµ·å½“å‰çº¿ç¨‹ï¼Œç­‰å¾…å”¤é†’ï¼š implT Receiver_, T pub fn receive(self) - T while !self.channel.ready.swap(false, Ordering::Acquire) thread::park(); // æŒ‚èµ·å½“å‰çº¿ç¨‹ï¼Œå³ thread::current() çº¿ç¨‹ unsafe (*self.channel.message.get()).assume_init_read() åœ¨ send å®Œæ•°æ®åï¼Œå”¤é†’å¯èƒ½æŒ‚èµ·çš„çº¿ç¨‹ï¼š implT Sender_, T pub fn send(self, messgae: T) unsafe (*self.channel.message.get()).write(messgae) ; self.channel.ready.store(true, Ordering::Release); Thread::unpark(self.receiving_thread); // å”¤é†’ receiver çº¿ç¨‹ æœ€ååˆ é™¤ä¹‹å‰çš„ is_ready æ–¹æ³•ï¼Œç„¶åæ›´æ–°æˆ‘ä»¬çš„æµ‹è¯•ä»£ç ï¼š #[test]fn one_thread_should_work() let mut channel = Channel::new(); let (sender, receiver) = channel.split(); sender.send(1); let msg = receiver.receive(); assert_eq!(msg, 1);#[test]fn cross_thread_should_work() let mut channel = Channel::new(); let (sender, receiver) = channel.split(); thread::scope(|s| s.spawn(|| sleep(Duration::from_millis(100)); sender.send(1); ); assert_eq!(receiver.receive(), 1); // ä¸å†éœ€è¦æ£€æŸ¥ is_readyï¼Œè¿™é‡Œä¼šé˜»å¡ä¸€ç›´ç›´åˆ°æœ‰æ•°æ®åˆ°æ¥ ); æœ€ç»ˆç‰ˆ v8ï¼šä½¿ç”¨ PhantomData æ¥ä¿è¯ Receiver å¤„äº split() çº¿ç¨‹ æ˜¯ä¸æ˜¯è§‰å¾—ï¼Œä¸Šè¿°å®ç°å·²ç»å®Œç¾æ— ç‘•äº†ï¼å…¶å®ä¸ç„¶ï¼Œæˆ‘ä»¬è™½ç„¶å‡è®¾äº† Recevier å¤„äºè°ƒç”¨ split() çš„çº¿ç¨‹ä¸­ï¼Œä½†æ˜¯è¿˜æ˜¯æ— æ³•é˜»æ­¢ä½¿ç”¨è€…å°† Recevier è½¬ç§»åˆ°å…¶ä»–çº¿ç¨‹ã€‚ å†æ¬¡å›é¡¾ä¸‹æˆ‘ä»¬ç°åœ¨çš„ Channel å’Œ Recevierï¼š pub struct Receivera, T channel: a ChannelT,pub struct ChannelT message: UnsafeCellMaybeUninitT, ready: AtomicBool,unsafe implT Sync for ChannelT where T: Send æˆ‘ä»¬ä¸º ChannelT å®ç°äº† Sync traitï¼Œè€Œæ ‡å‡†åº“ä¸­æœ‰è¿™ 2 è¡Œä»£ç ï¼š implT: ?Sized + Sync Sync for T implT: ?Sized + Sync Send for T æ‰€ä»¥ ChannelT å®ç°äº† Sync/Send traitï¼Œè€Œ Receiver åªæŒæœ‰äº†ä¸€ä¸ª 'a ChannelTï¼Œæ‰€ä»¥å®ƒä¹Ÿæ˜¯ Send çš„ï¼ æ‰€ä»¥ Receiver æ˜¯å¯ä»¥è¢«è½¬ç§»åˆ°å…¶ä»–çº¿ç¨‹çš„ï¼Œå³ä¸‹è¿°çš„æµ‹è¯•ä»£ç åœ¨ç¼–è¯‘ä¸Šä¹Ÿæ˜¯é€šè¿‡çš„ï¼š #[test]fn cross_thread_should_work() let mut channel = Channel::new(); let (sender, receiver) = channel.split(); // æ‰§è¡Œ split() çš„çº¿ç¨‹ thread::scope(|s| s.spawn(|| sleep(Duration::from_millis(100)); sender.send(1); ); // è¿™é‡Œåœ¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œæ‰§è¡Œäº† `receiver.receive()` s.spawn(|| assert_eq!(receiver.receive(), 1); ); ); ä½†æ˜¯æˆ‘ä»¬æ‰§è¡Œåä¼šå‘ç°ï¼Œreceiver.receive() ä¼šè¢«æ°¸ä¹…é˜»å¡ä½ï¼Œè¿™æ˜¯å› ä¸º sender.send(1) åªä¼šå”¤é†’æ‰§è¡Œ split() çš„çº¿ç¨‹ã€‚ ä¸ºäº†é¿å…è¿™ç§æƒ…å†µçš„å‘ç”Ÿï¼Œæˆ‘ä»¬éœ€è¦å¼ºè¡Œé˜²æ­¢ Receiver å®ç° Send traitï¼ æ€ä¹ˆåŠå‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦åšåˆ° 2 ä»¶äº‹æƒ…ï¼š è®© Recevier æŒæœ‰ä¸€ä¸ªé Sync çš„å±æ€§ï¼› è¿™ä¸ªå±æ€§é™¤äº†æ ‡è®°æ²¡æœ‰å…¶ä»–ä½œç”¨ï¼Œæœ€å¥½ä¸è¦å ç”¨ä»»ä½•çš„èµ„æºã€‚ è¿™é‡Œæˆ‘ä»¬ä»‹ç»ä¸€ä½æ–°æœ‹å‹ï¼šPhantomDataã€‚ Rust ä¸­çš„ PhantomData æ˜¯ä¸€ä¸ªé›¶å¤§å°ç±»å‹ï¼ˆZero-Sized Type, ZSTï¼‰ï¼Œç”¨äºåœ¨ç¼–è¯‘æœŸå‘ç±»å‹ç³»ç»Ÿä¼ é€’é¢å¤–ä¿¡æ¯ï¼Œè€Œä¸å ç”¨è¿è¡Œæ—¶å†…å­˜ã€‚å®ƒåœ¨æ³›å‹ç¼–ç¨‹ã€ç”Ÿå‘½å‘¨æœŸç®¡ç†å’Œæ‰€æœ‰æƒæ ‡è®°ä¸­æ‰®æ¼”å…³é”®è§’è‰²ã€‚ å®ƒæœ‰ä»¥ä¸‹çš„æ ¸å¿ƒç‰¹æ€§å’Œä½œç”¨ï¼š é›¶å†…å­˜å¼€é”€ï¼šPhantomDataT æœ¬èº«ä¸å­˜å‚¨ä»»ä½•æ•°æ®ï¼Œç¼–è¯‘åä¼šè¢«ä¼˜åŒ–æ‰ï¼Œå› æ­¤ä¸ä¼šå¢åŠ ç»“æ„ä½“çš„å®é™…å†…å­˜å ç”¨ã€‚ use std::marker::PhantomData;struct WrapperT data: u32, _marker: PhantomDataT, // ä¸å ç©ºé—´ æ ‡è®°æœªä½¿ç”¨çš„æ³›å‹å‚æ•°ï¼šRust è¦æ±‚æ³›å‹å‚æ•°å¿…é¡»åœ¨ç»“æ„ä½“ä¸­è¢«æ˜¾å¼ä½¿ç”¨ã€‚è‹¥æ³›å‹å‚æ•°æœªç›´æ¥å‡ºç°åœ¨å­—æ®µä¸­ï¼Œå¯é€šè¿‡ PhantomData æ ‡è®°å…¶å­˜åœ¨æ€§ï¼Œé¿å…ç¼–è¯‘é”™è¯¯ã€‚ struct ResourceT handle: *mut (), _phantom: PhantomDataT, // æ ‡è®°ç±»å‹ T å£°æ˜ç”Ÿå‘½å‘¨æœŸä¾èµ–ï¼šå½“ç»“æ„ä½“åŒ…å«åŸå§‹æŒ‡é’ˆï¼ˆå¦‚ *const Tï¼‰æ—¶ï¼ŒPhantomData å¯ç»‘å®šç”Ÿå‘½å‘¨æœŸï¼Œç¡®ä¿å¼•ç”¨çš„æ•°æ®æœ‰æ•ˆæ€§ã€‚ struct Slicea, T start: *const T, end: *const T, _phantom: PhantomDataa T, // ç»‘å®šç”Ÿå‘½å‘¨æœŸ a åå˜ä¸é€†å˜æ§åˆ¶ï¼šé€šè¿‡ PhantomData'a T æˆ– PhantomData*mut T ç­‰ä¸åŒå½¢å¼ï¼Œè°ƒæ•´ç±»å‹çš„åå˜/é€†å˜è¡Œä¸ºã€‚ use std::marker::PhantomData;use std::rc::Rc;// æ ‡è®°ç±»å‹ä¸º !Send ä¸” !Syncstruct NotThreadSafe _marker: PhantomDataRc(), // Rc() æœ¬èº«æ˜¯ !Send + !Sync åœ¨ä»‹ç»å®Œ PhantomData åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨å®ƒæ¥é˜²æ­¢ Receiver å®ç° Send trait äº†ï¼š pub struct Receivera, T channel: a ChannelT, _no_send: PhantomData*const (), å…¶ä¸­ *const() æ˜¯ !Send çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ Receiver å†ä¹Ÿä¸ä¼šè¢«è½¬ç§»åˆ°å…¶ä»–çº¿ç¨‹äº†ï¼Œè€Œ send æ˜¯è¦æ±‚ selfï¼Œæ‰€ä»¥å³ä¾¿æ˜¯ Sync çš„ä¹Ÿæ— æ‰€è°“äº†ï¼Œå› ä¸ºæ— æ³•é€šè¿‡å¼•ç”¨æ¥æ‰§è¡Œ receive() æ–¹æ³•ã€‚ ç°åœ¨æˆ‘ä»¬å¯ä»¥å†æ¬¡æ‰§è¡Œä¸Šé¢çš„æµ‹è¯•ä»£ç ï¼ˆå¼ºè¡Œå°† Receiver ç§»åŠ¨åˆ°å…¶ä»–çº¿ç¨‹ä¸­ï¼‰ï¼Œå°†ä¼šå¾—åˆ°ä»¥ä¸‹çš„æŠ¥é”™ï¼š error[E0277]: `*const ()` cannot be sent between threads safely -- src/oneshotchannel.rs:103:21 |103 | s.spawn(|| | ----- ^- | | | | _______________|_____within this `closure@oneshotchannel.rs:103:21` | | | | | required by a bound introduced by this call104 | | assert_eq!(receiver.receive(), 1);105 | | ); | |_____________^ `*const ()` cannot be sent between threads safely åˆ°è¿™é‡Œï¼Œé€šè¿‡ 8 ä¸ªç‰ˆæœ¬ï¼Œæˆ‘ä»¬ä¸€æ­¥æ­¥å®ç°äº†ä¸€ä¸ªé«˜æ€§èƒ½ã€ä½å†…å­˜å ç”¨ä¸”å®‰å…¨å¯ç”¨çš„ oneshot channel äº†ï¼ å®Œæ•´çš„ä»£ç å¯ä»¥å‚è€ƒï¼šconutils-oneshotã€‚ oneshot crate æµ…æ¢","tags":["Rust","å¹¶å‘ç¼–ç¨‹"],"categories":["Rust","Rust å®æˆ˜"]},{"title":"Rust å®æˆ˜ä¸¨å®ç°ä¸€ä¸ª SpinLock","path":"/2025/05/13/rust-action-spinlock/","content":"è‡ªæ—‹é”ï¼Œå°±æ˜¯åœ¨å°è¯•è·å–é”å¤±è´¥æ—¶ï¼Œä¸ç›´æ¥æŒ‚èµ·ï¼Œè€Œæ˜¯ä¸€ç›´å¾ªç¯å°è¯•è·å–é”ã€‚è¿™åœ¨ä¸€äº›é”å†²çªè¾ƒå°ä¸”å ç”¨é”æ—¶é—´éå¸¸çŸ­çš„åœºæ™¯ä¸‹éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºå®ƒå¯ä»¥å‡å°‘ç›¸åº”çš„ç³»ç»Ÿè°ƒç”¨ã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬å°±ä½¿ç”¨ Rust æ¥å®ç°ä¸€ä¸ªè‡ªå·±çš„è‡ªæ—‹é”ã€‚ åŸºç¡€ç‰ˆ v0 é¦–å…ˆæ˜¯æœ€åŸºç¡€çš„ç‰ˆæœ¬ï¼Œæˆ‘ä»¬åœ¨ lock çš„æ—¶å€™ï¼Œå¦‚æœå¤±è´¥äº†ï¼Œå°±ä¸€ç›´å¾ªç¯å°è¯•ï¼Œç›´åˆ°æˆåŠŸè·å–é”ï¼š pub struct SpinLock locked: AtomicBool,impl SpinLock pub const fn new() - Self Self locked: AtomicBool::new(false), pub fn lock(self) while self.locked.swap(true, Ordering::Acquire) std::hint::spin_loop(); pub fn unlock(self) self.locked.store(false, Ordering::Release); åœ¨ä¸Šè¿°å®ç°ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ç»“æœ SpinLockï¼Œå®ƒåŒ…å«ä¸€ä¸ªåŸå­å˜é‡ lockedã€‚ åœ¨ lock æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å°è¯•å¯¹ locked åŸå­å˜é‡è¿›è¡Œ swap ä¸º true çš„æ“ä½œï¼Œswap ä¼šè¿”å›äº¤æ¢ä¹‹å‰çš„å€¼ï¼Œå¦‚æœæ˜¯ falseï¼Œé‚£å°±è¯´æ˜æŠ¢é”æˆåŠŸäº†ï¼Œè¿™ä¸ªæ—¶å€™ lock å°±æˆåŠŸè¿”å›ï¼Œå¦åˆ™ï¼Œåˆ™è°ƒç”¨ std::hint::spin_loop() è¿›è¡Œè‡ªæ—‹ï¼Œåœ¨ä¸‹ä¸€æ¬¡ while å¾ªç¯ä¸­å†å°è¯•è·å–é”ã€‚ åœ¨ unlock æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦å°† locked è®¾ç½®ä¸º false å³å¯ã€‚ ç¤ºä¾‹å›¾å¦‚ä¸‹ï¼š è¿™é‡Œæœ‰ 2 ä¸ªéœ€è¦å…³æ³¨çš„ç‚¹ï¼š std::hint::spin_loop() ä¼šå‘ CPU å‘é€ç‰¹å®šæŒ‡ä»¤ï¼ˆå¦‚ x86 çš„ pause æˆ– ARM çš„ yieldï¼‰ï¼Œæç¤ºå½“å‰å¤„äºå¿™ç­‰å¾…çŠ¶æ€ã€‚è¿™å…è®¸ CPU ä¼˜åŒ–æ‰§è¡Œè¡Œä¸ºï¼Œä¾‹å¦‚ï¼š é™ä½åŠŸè€—ï¼šå‡å°‘è‡ªæ—‹æœŸé—´çš„è®¡ç®—èµ„æºæ¶ˆè€—ã€‚ æå‡å¤šçº¿ç¨‹æ•ˆç‡ï¼šåœ¨è¶…çº¿ç¨‹æ¶æ„ä¸­ï¼Œé¿å…å•ä¸ªæ ¸å¿ƒçš„å¿™ç­‰å¾…é˜»å¡å…¶ä»–çº¿ç¨‹çš„æ‰§è¡Œã€‚ è¿™é‡Œæˆ‘ä»¬å†…å­˜é¡ºåºä½¿ç”¨äº†ä¸€å¯¹ Acquire å’Œ Releaseã€‚å…¶ä¸­ï¼š Acquire æ˜¯ä¸ºäº†å½“å‰çº¿ç¨‹å¯ä»¥çœ‹åˆ°å…¶ä»–çº¿ç¨‹å¯¹ locked çš„å†™ç»“æœï¼Œå³çœ‹åˆ°å½“å‰ locked çœŸæ­£çš„å€¼ã€‚ Release æ˜¯ä¸ºäº†å½“å‰çº¿ç¨‹å¯¹ lockedå†™çš„ç»“æœå¯¹å…¶ä»–çº¿ç¨‹å¯è§ï¼Œå³é‡Šæ”¾å½“å‰ locked çœŸæ­£çš„å€¼ç»™å…¶ä»–çº¿ç¨‹ã€‚ æˆ‘ä»¬æ¥æ’°å†™å•å…ƒæµ‹è¯•ï¼š #[cfg(test)]mod tests #[test] fn one_thread_should_work() let lock = SpinLock::new(); let mut data = vec![]; lock.lock(); data.push(1); lock.unlock(); lock.lock(); print!(:?, data); lock.unlock(); #[test] fn cross_thread_should_work() let data = vec![]; let lock = SpinLock::new(); thread::scope(|s| s.spawn(|| lock.lock(); unsafe let data_ptr = data as *const Veci32 as *mut Veci32; (*data_ptr).push(1); lock.unlock(); ); sleep(Duration::from_millis(100)); lock.lock(); unsafe let data_ptr = data as *const Veci32 as *mut Veci32; (*data_ptr).push(2); lock.unlock(); ); lock.lock(); print!(:?, data); lock.unlock(); åœ¨è·¨çº¿ç¨‹çš„æµ‹è¯•ç”¨ä¾‹ cross_thread_should_work ä¸­ï¼Œä¸ºäº†å¯¹ data è¿›è¡Œä¿®æ”¹ï¼Œæˆ‘ä»¬åªèƒ½åœ¨ unsafe é‡Œé¢å¼ºè¡Œä½¿ç”¨è£¸æŒ‡é’ˆæ¥è¿›è¡Œæ“ä½œï¼Œå¦åˆ™ç¼–è¯‘å°±ä¼šå¤±è´¥ã€‚ å‡çº§ç‰ˆ v1 åœ¨ä¸Šä¸€ä¸ªåŸºç¡€ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬ä¼šå‘ç°æ“ä½œä¸´ç•Œèµ„æºéå¸¸éº»çƒ¦ï¼Œå› ä¸ºä¸´ç•Œèµ„æºçš„ç±»å‹ï¼Œå¯èƒ½æ˜¯ä¸æ»¡è¶³ Sync å’Œ Send çš„ï¼Œæ‰€ä»¥å®ƒä»¬æ— æ³•åœ¨è·¨çº¿ç¨‹ä¸­è¿›è¡Œä¼ é€’æˆ–è½¬ç§»ï¼Œæ‰€ä»¥å³ä¾¿æˆ‘ä»¬èƒ½ä»é€»è¾‘ä¸Šæ–­å®šå®ƒä»¬æ˜¯å¹¶å‘å®‰å…¨çš„ï¼Œä½†æ˜¯ç¼–è¯‘å™¨å¯æ²¡é‚£ä¹ˆèªæ˜ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½é€šè¿‡ unsafe å¼ºè¡Œç»•è¿‡ç¼–è¯‘æœŸçš„æ£€æŸ¥ã€‚ å½“ç„¶è¿™ä¹Ÿä¸ç¬¦åˆ Rust çš„ä¸€èˆ¬å®ç°ï¼Œæˆ‘ä»¬çœ‹çœ‹æ ‡å‡†åº“çš„ Mutex æ˜¯æ€ä¹ˆå®ç°çš„ï¼š pub fn lock(self) - LockResultMutexGuard_, T unsafe self.inner.lock(); MutexGuard::new(self) pub struct MutexGuarda, T: ?Sized + a lock: a MutexT, poison: poison::Guard, å¯ä»¥å‘ç°ï¼Œæ ‡å‡†çš„é”æ˜¯å°†è¦ä¿æŠ¤çš„ä¸´ç•Œèµ„æºæ”¾åœ¨äº†é”é‡Œï¼Œåœ¨è·å–é”çš„æ—¶å€™ï¼Œå°±è¿”å›è¿™ä¸ªä¸´ç•Œèµ„æºçš„ Guardã€‚ OKï¼Œæˆ‘ä»¬å…ˆä¸ç€æ€¥å¼•å…¥è¿™ä¸ª Guardï¼Œæˆ‘ä»¬å°±ç›´æ¥åœ¨è·å–é”çš„æ—¶å€™è¿”å›ä¸´ç•Œèµ„æºçš„å¯å˜å¼•ç”¨å³å¯ã€‚ æ›´æ–°åçš„ç‰ˆæœ¬å¦‚ä¸‹æ‰€ç¤ºï¼› pub struct SpinLockT locked: AtomicBool, value: UnsafeCellT,implT SpinLockT pub fn new(value: T) - Self Self locked: AtomicBool::new(false), value: UnsafeCell::new(value), pub fn lock(self) - mut T while self.locked.swap(true, Ordering::Acquire) std::hint::spin_loop(); unsafe self.value.get().as_mut().unwrap() pub fn unlock(self) self.locked.store(false, Ordering::Release); unsafe implT Send for SpinLockT where T: Send unsafe implT Sync for SpinLockT where T: Send å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åœ¨ SpinLock ä¸­åŠ å…¥äº†ç±»å‹ä¸º UnsafeCellT çš„å­—æ®µ valueï¼Œç„¶ååœ¨ lock() æŠ¢åˆ°é”çš„æ—¶å€™ï¼Œé€šè¿‡ self.value.get().as_mut().unwrap() è·å– value çš„å¯å˜å¼•ç”¨ï¼Œæˆ‘ä»¬çŸ¥é“è¿™é‡Œæ˜¯å®‰å…¨çš„ï¼Œæ‰€ä»¥ unsafe æ˜¯å®‰å…¨çš„ã€‚ åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬è§åˆ°äº†ä¸€ä¸ªæ–°æœ‹å‹ UnsafeCellï¼Œäº‹å®ä¸Šå®ƒæ˜¯ Rust æ ‡å‡†åº“ä¸­æ‰€æœ‰çš„å¹¶å‘å·¥å…·çš„åŸºçŸ³ï¼Œå®ƒæ¶‰åŠåˆ°äº†ä¸€ä¸ªæ¦‚å¿µï¼šå†…éƒ¨å¯å˜æ€§ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ Rust çš„å€Ÿç”¨è§„åˆ™ä¸­ï¼Œåªå…è®¸é€šè¿‡å¯å˜å¼•ç”¨ä¿®æ”¹æ•°æ®ï¼Œé‚£å¦‚æœæˆ‘ä»¬æƒ³é€šè¿‡ä¸€ä¸ªå…±äº«å¼•ç”¨å»ä¿®æ”¹æ•°æ®å‘¢ï¼Ÿ Rust æä¾›äº† UnsafeCellT è¿™ä¸ªå·¥å…·ï¼Œå®ƒå‘Šè¯‰ç¼–è¯‘å™¨ï¼š\"è¿™å—å†…å­˜å¯èƒ½ä¼šè¢«ä¿®æ”¹ï¼Œå³ä½¿ä½ åªæœ‰å…±äº«å¼•ç”¨\"ã€‚ä½†æ˜¯éœ€è¦ç”±ç¨‹åºå‘˜è‡ªå·±æ¥ä¿è¯é€»è¾‘çš„æ­£ç¡®æ€§ï¼Œæ‰€ä»¥å¯¹å®ƒçš„æ“ä½œï¼Œä¹Ÿå°±éœ€è¦ä½¿ç”¨ unsafe äº†ã€‚ æ ‡å‡†åº“ä¸­ï¼ŒåŸºäº UnsafeCellTï¼Œå°è£…äº†ä¸€äº›æ»¡è¶³å†…éƒ¨å¯å˜æ€§çš„ç±»å‹ï¼š CellT: åªå…è®¸ Copy ç±»å‹ï¼Œé€šè¿‡ get()/set() æ“ä½œã€‚ RefCellT: è¿è¡Œæ—¶å€Ÿç”¨æ£€æŸ¥ï¼Œä½†ä¸æ˜¯ Syncã€‚ MutexT: çº¿ç¨‹å®‰å…¨ï¼Œä½†æ€§èƒ½å¼€é”€å¤§ã€‚ åŒæ—¶ä¹Ÿå› ä¸º UnsafeCellT å¹¶ä¸æ»¡è¶³ Send å’Œ Sync traitï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨ä¸ºå…¶å®ç°ï¼š unsafe implT Send for SpinLockT where T: Send unsafe implT Sync for SpinLockT where T: Send æˆ‘ä»¬ä¿®æ”¹æˆ‘ä»¬çš„æµ‹è¯•ç”¨ä¾‹ï¼š #[cfg(test)]mod tests #[test] fn one_thread_should_work() let lock = SpinLock::new(vec![]); let data = lock.lock(); data.push(1); lock.unlock(); let data = lock.lock(); print!(:?, data); lock.unlock(); #[test] fn cross_thread_should_work() let lock = SpinLock::new(vec![]); thread::scope(|s| s.spawn(|| let data1 = lock.lock(); data1.push(1); lock.unlock(); ); sleep(Duration::from_millis(100)); let data2 = lock.lock(); data2.push(2); lock.unlock(); ); let data = lock.lock(); print!(:?, data); lock.unlock(); è¿™ä¸ªç‰ˆæœ¬çš„æµ‹è¯•ç”¨ä¾‹ä¸­ï¼Œå¯¹äºä½¿ç”¨è€…æ¥è¯´ï¼Œå¾ˆæ˜æ˜¾å°±ç®€æ´å¾ˆå¤šäº†ï¼Œå†ä¹Ÿä¸éœ€è¦ä½¿ç”¨ unsafe è¿™ç§å±é™©å·¥å…·äº†ã€‚ æœ€ç»ˆç‰ˆ v2 ä¸Šä¸ªç‰ˆæœ¬è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨å»è¿›è¡Œ unlockï¼Œå¦‚æœä½ å¿˜äº†å‘¢ï¼Ÿé‚£å…¶ä»–çº¿ç¨‹å°±ä¼šè¢«æ°¸ä¹…é˜»å¡ä½äº†ã€‚å½“ç„¶è¿™ä¹Ÿä¸ç¬¦åˆ Rust çš„ç¼–ç¨‹æ–¹å¼ã€‚ç†æƒ³æƒ…å†µä¸‹æ˜¯ï¼Œåœ¨ä½œç”¨åŸŸç»“æŸçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªåŠ¨è¿›è¡Œ unlockã€‚é‚£è¿™ä¸ªæ—¶å€™å°±éœ€è¦ç”¨åˆ° drop çš„åŠŸèƒ½äº†ã€‚ è¿™ä¸ªæ—¶å€™ï¼ŒGuard å°±å¯ä»¥ç™»åœºäº†ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒæ ‡å‡†åº“ä¸€æ ·ï¼Œåœ¨ lock çš„æ—¶å€™è¿”å›ä¸€ä¸ª Guardï¼Œå½“è¿™ä¸ª Guard ç¦»å¼€ä½œç”¨åŸŸçš„æ—¶å€™ï¼Œå®ƒçš„ drop å°±ä¼šè¢«è°ƒç”¨ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨é‡Œé¢ï¼Œæ‰§è¡Œ unlock æ“ä½œï¼Œä»è€Œè¿›ä¸€æ­¥é™ä½ä½¿ç”¨è€…çš„å¿ƒæ™ºè´Ÿæ‹…ã€‚ æ›´æ–°åçš„ç‰ˆæœ¬å¦‚ä¸‹æ‰€ç¤ºï¼š pub struct SpinLockT locked: AtomicBool, value: UnsafeCellT,pub struct SpinLockGuarda, T lock: a SpinLockT,unsafe implT Send for SpinLockT where T: Send unsafe implT Sync for SpinLockT where T: Send implT SpinLockT pub fn new(value: T) - Self Self locked: AtomicBool::new(false), value: UnsafeCell::new(value), pub fn lock(self) - SpinLockGuardT while self.locked.swap(true, Ordering::Acquire) std::hint::spin_loop(); SpinLockGuard::new(self) fn unlock(self) self.locked.store(false, Ordering::Release); impla, T SpinLockGuarda, T pub fn new(lock: a SpinLockT) - SpinLockGuarda, T Self lock implT Drop for SpinLockGuard_, T fn drop(mut self) self.lock.unlock(); implT Deref for SpinLockGuard_, T type Target = T; fn deref(self) - Self::Target // # Safety // // The very existence of this Guard // guarantees weve exclusively locked the lock. unsafe *self.lock.value.get() implT DerefMut for SpinLockGuard_, T fn deref_mut(mut self) - mut Self::Target // # Safety // // The very existence of this Guard // guarantees weve exclusively locked the lock. unsafe mut *self.lock.value.get() æˆ‘ä»¬å¼•å…¥äº†ç±»å‹ SpinLockGuardï¼Œå®ƒåŒ…å«äº†ä¸€ä¸ª SpinLock çš„å¼•ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç”¨ç”Ÿå‘½å‘¨æœŸ 'a è¿›è¡Œæ ‡æ³¨ã€‚ SpinLock åœ¨ lock() æˆåŠŸæ—¶ï¼Œè¿”å›ä¸€ä¸ª SpinLockGuardã€‚ æˆ‘ä»¬ä¸º SpinLockGuard å®ç° drop traitï¼Œè®©å…¶åœ¨è¢« drop æ—¶è‡ªåŠ¨æ‰§è¡Œ unlockï¼Œè¿™æ ·å°±å®ç°äº†ç¦»å¼€ä½œç”¨åŸŸè‡ªåŠ¨ unlock çš„åŠŸèƒ½ã€‚ åŒæ—¶ä¸ºäº†æ“ä½œæ•°æ®çš„ç®€å•æ€§ï¼Œæˆ‘ä»¬ä¸º SpinLockGuard å®ç°äº† Deref å’Œ DerefMut è¿™ 2 ä¸ª traitã€‚ ä¿®æ”¹ä¸€ä¸‹æˆ‘ä»¬çš„æµ‹è¯•ä»£ç ï¼Œå¯ä»¥å‘ç°æ›´åŠ ç®€æ´äº†ï¼š #[cfg(test)]mod tests #[test] fn one_thread_should_work() let lock = SpinLock::new(vec![]); let mut data = lock.lock(); data.push(1); drop(data); // unlock let data = lock.lock(); print!(:?, *data); #[test] fn cross_thread_should_work() let lock = SpinLock::new(vec![]); thread::scope(|s| s.spawn(|| let mut data1 = lock.lock(); data1.push(1); ); sleep(Duration::from_millis(100)); let mut data2 = lock.lock(); data2.push(2); ); let data = lock.lock(); print!(:?, *data); æ€»ç»“ æ€»ç»“ä¸€ä¸‹ï¼Œåœ¨æœ¬å®æˆ˜ç¯‡ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ 3 ä¸ªç‰ˆæœ¬ï¼Œå®ç°äº†ä¸€ä¸ªéå¸¸ä¼˜é›…ä¸”å¯ç”¨çš„è‡ªæ—‹é”ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬é™¤äº†æ›´è¿›ä¸€æ­¥åœ°ç†è§£åŸå­å˜é‡å’Œå†…å­˜é¡ºåºçš„åº”ç”¨ï¼Œä¹Ÿç»“è¯†äº†ä¸€ä¸ªæ–°çš„æœ‹å‹ UnsafeCellï¼Œå®ƒæ˜¯ Rust ä¸­åŒæ­¥åŸè¯­çš„åŸºç¡€ï¼Œåé¢æˆ‘ä»¬è¿˜ä¼šç»å¸¸è§åˆ°ã€‚ ä¸‹ç¯‡æˆ‘ä»¬å°†å°è¯•å®ç°ä¸€ä¸ªéå¸¸å®ç”¨çš„å·¥å…·ï¼šone-shot-channelï¼Œæ•¬è¯·æœŸå¾…ï¼ Happy Coding! Peace~","tags":["Rust","å¹¶å‘ç¼–ç¨‹"],"categories":["Rust","Rust å®æˆ˜"]},{"title":"è¯»ä¹¦ç¬”è®°ä¸¨ã€ŠRust Atomics and Locksã€‹","path":"/2025/04/25/note-rust-atomics-and-locks/","content":"Rust å¹¶å‘åŸºç¡€ å¤šçº¿ç¨‹ å¼€å¯çº¿ç¨‹ï¼š // å¼€å¯çº¿ç¨‹let t = thread::spawn(|| // do something)// ç­‰å¾…çº¿ç¨‹é€€å‡ºt.join().unwrap() æ§åˆ¶çº¿ç¨‹å‘¨æœŸï¼š thread::scope(|s| s.spawn(|| // do something ) s.spawn(|| // do something ));// è¿™é‡Œä¼šç¡®ä¿ scope é‡Œé¢çš„çº¿ç¨‹éƒ½æ‰§è¡Œå®Œæ¯•å¹¶é€€å‡º å†…éƒ¨å¯å˜æ€§ï¼ˆInterior Mutabilityï¼‰ Rust å†…å­˜å®‰å…¨é»˜è®¤åŸºäºä»¥ä¸‹è§„åˆ™ï¼šåŒä¸€æ—¶é—´ï¼Œä¸€ä¸ªæ•°æ®åªèƒ½è¢«å¤šä¸ªä¸å¯å˜å¼•ç”¨ï¼ˆTï¼‰å…±äº«ï¼Œæˆ–ä»…è¢«ä¸€ä¸ªå¯å˜å¼•ç”¨ï¼ˆmut Tï¼‰ç‹¬å ã€‚è¿™ç§ç¼–è¯‘æ—¶æ£€æŸ¥é¿å…äº†æ•°æ®ç«äº‰ï¼Œä½†ä¸å¤Ÿçµæ´»ï¼Œä¾‹å¦‚å¤šä¸ªçº¿ç¨‹åŒæ—¶æŒæœ‰äº†åŒä¸€ä¸ªå¼•ç”¨ï¼Œé‚£å®ƒå¿…ç„¶åªèƒ½æ˜¯ä¸å¯å˜å¼•ç”¨ï¼Œä¹Ÿå°±æ— æ³•å®ç°å¤šçº¿ç¨‹å¹¶å‘ä¿®æ”¹åŒä¸€æ•°æ®çš„åŠŸèƒ½äº†ã€‚ å†…éƒ¨å¯å˜æ€§å…è®¸é€šè¿‡ä¸å¯å˜å¼•ç”¨ï¼ˆTï¼‰ä¿®æ”¹æ•°æ®ï¼Œå³ä½¿æ•°æ®æœ¬èº«æœªè¢«å£°æ˜ä¸º mutã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šâ€œçœ‹ä¼¼ä¸å¯å˜çš„å¤–éƒ¨æ¥å£ï¼Œå†…éƒ¨å¯å˜â€ã€‚ä¾‹å¦‚ï¼ŒRefCell å…è®¸åœ¨è¿è¡Œæ—¶åŠ¨æ€å€Ÿç”¨å¯å˜å¼•ç”¨ï¼Œè€Œéä¾èµ–ç¼–è¯‘æ—¶çš„é™æ€æ£€æŸ¥ã€‚ UnsafeCell UnsafeCellT æ˜¯ Rust å†…éƒ¨å¯å˜æ€§çš„åŸºçŸ³ï¼Œæ‰€æœ‰æä¾›å†…éƒ¨å¯å˜æ€§çš„ç±»å‹ï¼ˆå¦‚ Cellã€RefCellï¼‰å‡åŸºäºå®ƒå®ç°ã€‚ ç±»å‹ çº¿ç¨‹å®‰å…¨ è¿è¡Œæ—¶æ£€æŸ¥ é€‚ç”¨æ•°æ®ç±»å‹ å…¸å‹åœºæ™¯ CellT âŒ âŒ Copy ç±»å‹ ç®€å•å€¼çš„å¿«é€Ÿä¿®æ”¹ RefCellT âŒ âœ”ï¸ ä»»æ„ç±»å‹ å•çº¿ç¨‹å¤æ‚æ•°æ®ç»“æ„ RwLockT âœ”ï¸ âœ”ï¸ï¼ˆé˜»å¡ï¼‰ ä»»æ„ç±»å‹ å¤šçº¿ç¨‹å…±äº«æ•°æ® UnsafeCell âŒ âŒ ä»»æ„ç±»å‹ åº•å±‚å®‰å…¨æŠ½è±¡çš„å®ç° UnsafeCellT çš„å®šä¹‰å¦‚ä¸‹ï¼š /// The core primitive for interior mutability in Rust.////// If you have a reference `T`, then normally in Rust the compiler performs optimizations based on/// the knowledge that `T` points to immutable data. Mutating that data, for example through an/// alias or by transmuting a `T` into a `mut T`, is considered undefined behavior./// `UnsafeCellT` opts-out of the immutability guarantee for `T`: a shared reference/// `UnsafeCellT` may point to data that is being mutated. This is called interior mutability.#[repr(transparent)]pub struct UnsafeCellT: ?Sized value: T, å…¶ä¸­ #[repr(transparent)] ä¿è¯äº† UnsafeCellT å’Œ T ç±»å‹å†…å­˜å¸ƒå±€çš„ä¸€è‡´æ€§ï¼Œè¿™æ˜¯åé¢å„ç§æŒ‡é’ˆå¯ä»¥ç›´æ¥å®‰å…¨å¼ºè½¬çš„åŸºç¡€ã€‚ å®ƒæœ‰ 2 ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼Œåˆ†åˆ«ä¸º get_mut å’Œ getï¼Œå…¶ä¸­ get_mut æ¯”è¾ƒç®€å•ï¼Œå¦‚ä¸‹ï¼š /// Returns a mutable reference to the underlying data.////// This call borrows the `UnsafeCell` mutably (at compile-time) which/// guarantees that we possess the only reference.pub const fn get_mut(mut self) - mut T mut self.value å‚æ•°æœ¬æ¥å°±æ˜¯ mut çš„ï¼Œæ‰€ä»¥ç›´æ¥è¿”å› mut self.value å°±å¯ä»¥äº†ï¼Œå¤©ç„¶æ»¡è¶³ç¼–è¯‘å™¨æ£€æŸ¥è¦æ±‚ï¼Œä¸éœ€è¦å…¶ä»–é¢å¤–çš„éªšæ“ä½œã€‚ get å°±ä¸ä¸€èˆ¬äº†ï¼Œå› ä¸º get çš„ä½œç”¨æ˜¯ï¼Œä»ä¸€ä¸ªä¸å¯å˜å¼•ç”¨ä¸­è·å–å¯å˜å¼•ç”¨ï¼ è¿™æ˜æ˜¾æ˜¯è¦æ‰“ç ´ç¼–è¯‘å™¨çš„å¼•ç”¨æ£€æŸ¥æœºåˆ¶ï¼Œæ‰€ä»¥éœ€è¦ä¸€äº›éªšæ“ä½œã€‚å®ƒçš„å®ç°å¦‚ä¸‹ï¼š /// Gets a mutable pointer to the wrapped value.pub const fn get(self) - *mut T self as *const UnsafeCellT as *const T as *mut T å‘æ˜ Rust çš„ç»å¯¹æ˜¯ä¸ªå¥—å¨ƒå¤§ä½¬... self as *const UnsafeCellT as *const T as *mut T çš„ä¸‰æ­¥è½¬æ¢è¿‡ç¨‹å¯åˆ†è§£ä¸ºï¼š åŸå§‹æŒ‡é’ˆè·å– self as *const Selfï¼šå°†å½“å‰å¯¹è±¡çš„ä¸å¯å˜å¼•ç”¨ï¼ˆselfï¼‰è½¬æ¢ä¸ºä¸å¯å˜çš„åŸç”ŸæŒ‡é’ˆï¼ˆ*const Selfï¼‰ï¼Œè¿™ä¸€æ­¥ä»…è·å–åœ°å€ï¼Œä¸æ¶‰åŠå†…å­˜æ“ä½œï¼Œæ˜¯å®‰å…¨çš„ã€‚ ç±»å‹å¼ºåˆ¶è½¬æ¢ *const Self as *const Tï¼šå°†æŒ‡é’ˆç±»å‹ä»æŒ‡å‘ Selfï¼ˆå³ UnsafeCellT ç±»å‹ï¼‰è½¬æ¢ä¸ºæŒ‡å‘å†…éƒ¨å­˜å‚¨çš„ T ç±»å‹ã€‚ç”±äº UnsafeCell çš„å†…å­˜å¸ƒå±€ä¸ T å®Œå…¨ä¸€è‡´ï¼ˆ#[repr(transparent)]ï¼‰ï¼Œæ­¤è½¬æ¢åœ¨å†…å­˜å¯¹é½ä¸Šæ— é£é™©ã€‚ å¯å˜æ€§é‡è§£é‡Š *const T as *mut Tï¼šå°†ä¸å¯å˜æŒ‡é’ˆå¼ºåˆ¶è½¬æ¢ä¸ºå¯å˜æŒ‡é’ˆã€‚è¿™ä¸€æ­¥æ˜¯ â€‹ç»•è¿‡ Rust é»˜è®¤ä¸å¯å˜å¼•ç”¨è§„åˆ™çš„å…³é”®ï¼Œå…è®¸é€šè¿‡å…±äº«å¼•ç”¨ä¿®æ”¹å†…éƒ¨æ•°æ®ï¼Œä½†éœ€å¼€å‘è€…è‡ªè¡Œä¿è¯å®‰å…¨æ€§ã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡å›ç­” 2 ä¸ªé—®é¢˜æ¥è¿›ä¸€æ­¥æ„Ÿå— Rust çš„è®¾è®¡å“²å­¦ä¸å®‰å…¨è¾¹ç•Œï¼š â‘  ä¸ºä»€ä¹ˆéœ€è¦å¤šæ­¥è½¬æ¢ï¼Ÿ å®‰å…¨éš”ç¦»ï¼šRusté»˜è®¤ç¦æ­¢é€šè¿‡ä¸å¯å˜å¼•ç”¨ï¼ˆTï¼‰ä¿®æ”¹æ•°æ®ï¼Œä½†UnsafeCellæ˜¯å†…éƒ¨å¯å˜æ€§çš„åº•å±‚åŸè¯­ï¼Œéœ€é€šè¿‡æŒ‡é’ˆè½¬æ¢ç»•è¿‡ç¼–è¯‘å™¨æ£€æŸ¥ã€‚å¤šæ­¥è½¬æ¢å°†â€œå±é™©æ“ä½œâ€é™åˆ¶åœ¨å¯æ§èŒƒå›´å†…ã€‚ç±»å‹ç³»ç»Ÿçº¦æŸï¼šUnsafeCell çš„get() æ–¹æ³•è¿”å› *mut Tï¼Œä½†æ–¹æ³•å‚æ•°æ˜¯selfï¼ˆä¸å¯å˜å¼•ç”¨ï¼‰ã€‚é€šè¿‡é€æ­¥è½¬æ¢ï¼Œæ—¢æ»¡è¶³æ–¹æ³•ç­¾åè¦æ±‚ï¼Œåˆå®ç°å†…éƒ¨å¯å˜æ€§ã€‚â‘¡ ä¸ºä»€ä¹ˆä¸ç›´æ¥è½¬æ¢ ä¸å˜æ€§ï¼ˆInvarianceï¼‰ï¼šUnsafeCellçš„æ³›å‹å‚æ•° T çš„ç”Ÿå‘½å‘¨æœŸæ ‡è®°ä¸ºä¸å˜ï¼ˆinvariantï¼‰ï¼Œé˜²æ­¢åå˜ï¼ˆcovarianceï¼‰å¯¼è‡´æ‚¬å‚æŒ‡é’ˆã€‚ç›´æ¥è½¬æ¢å¯èƒ½ç ´åç”Ÿå‘½å‘¨æœŸçº¦æŸã€‚è£¸æŒ‡é’ˆçš„è¯­ä¹‰ï¼š*const T å’Œ*mut T åœ¨ Rustä¸­ä»£è¡¨ä¸åŒçš„å†…å­˜è®¿é—®æƒé™ã€‚å¼ºåˆ¶è½¬æ¢éœ€æ˜¾å¼æ ‡è®°ï¼Œæé†’å¼€å‘è€…æ³¨æ„æ½œåœ¨çš„æ•°æ®ç«äº‰é£é™©ã€‚ Cell CellT å…è®¸åœ¨ä¸å¯å˜å¼•ç”¨çš„å‰æä¸‹ä¿®æ”¹æ•°æ®ã€‚å…¶è®¾è®¡æ ¸å¿ƒæ˜¯åœ¨ UnsafeCell çš„åŸºç¡€ä¸Šï¼Œé€šè¿‡é™åˆ¶æ•°æ®è®¿é—®æ–¹å¼å’Œç±»å‹çº¦æŸï¼Œåœ¨ä¿è¯å†…å­˜å®‰å…¨çš„åŒæ—¶çªç ´ Rust é»˜è®¤çš„å€Ÿç”¨è§„åˆ™ã€‚ å®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š /// A mutable memory location.////// # Memory layout////// `CellT` has the same [memory layout and caveats as/// `UnsafeCellT`](UnsafeCell#memory-layout). In particular, this means that/// `CellT` has the same in-memory representation as its inner type `T`.#[repr(transparent)]pub struct CellT: ?Sized value: UnsafeCellT,unsafe implT: ?Sized Send for CellT where T: Send implT: ?Sized !Sync for CellT æˆ‘ä»¬é‡ç‚¹æ¥çœ‹ä¸€ä¸‹ä¸‹é¢ 2 è¡Œè·Ÿ Send å’Œ Sync ç›¸å…³çš„å®ç°ï¼Œæˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹å‡ ä¸ªå…³é”®çš„ traitï¼š Send: è¡¨ç¤ºç±»å‹çš„æ‰€æœ‰æƒå¯ä»¥å®‰å…¨åœ°è·¨çº¿ç¨‹è½¬ç§»ã€‚ Sync: è¡¨ç¤ºç±»å‹çš„ä¸å¯å˜å¼•ç”¨ï¼ˆTï¼‰å¯ä»¥å®‰å…¨åœ°è·¨çº¿ç¨‹å…±äº«ã€‚!Sync è¡¨ç¤ºæ˜ç¡®ç¦æ­¢è¿™ä¸€è¡Œä¸ºã€‚ Sized: è¡¨ç¤ºç±»å‹çš„å¤§å°æ˜¯å›ºå®šçš„ã€‚!Sized è¡¨ç¤ºç±»å‹çš„å¤§å°æ˜¯å›ºå®šçš„ã€‚æ³›å‹ç±»å‹å‚æ•°é»˜è®¤éšå¼åŒ…å« T: Sized çº¦æŸï¼Œ?Sized è¡¨ç¤ºæ”¯æŒåŠ¨æ€å¤§å°çš„ç±»å‹ æ‰€ä»¥ï¼š unsafe implT: ?Sized Send for CellT where T: Send è¡¨ç¤ºåœ¨ T æ˜¯ Send çš„å‰æä¸‹ï¼Œå…è®¸å°† CellT çš„æ‰€æœ‰æƒç§»åŠ¨åˆ°å…¶ä»–çº¿ç¨‹ã€‚ implT: ?Sized !Sync for CellT è¡¨ç¤ºğŸˆ²æ­¢è·¨çº¿ç¨‹å…±äº« CellTã€‚","tags":["Rust","è¯»ä¹¦ç¬”è®°","å¹¶å‘ç¼–ç¨‹"],"categories":["è¯»ä¹¦ç¬”è®°"]},{"title":"RAG æŠ€æœ¯æ¦‚è§ˆ","path":"/2025/04/13/ai-rag-tech-overview/","content":"RAG çš„æ•´ä¸ªæµç¨‹å¯æ¦‚æ‹¬ä¸ºå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸»è¦åˆ†æˆç´¢å¼•ã€æ£€ç´¢å’Œç”Ÿæˆä¸‰ä¸ªéƒ¨åˆ†ã€‚ æœ¬æ–‡æä¾›é…å¥—çš„å®Œæ•´æ¡ˆä¾‹ï¼Œæºç å¯å‚è€ƒï¼šhedon-ai-road/rag-demoï¼Œæ¯ä¸ª commit éƒ½å¼•å…¥äº†ä¸€ä¸ªæ–°çš„æŠ€æœ¯ç‚¹ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯æ ¹æ® commit è®°å½•ä¸€ä¸€æŸ¥æ¢ã€‚ æ–‡æ¡£è§£ææŠ€æœ¯ ä»£ç ç¤ºä¾‹ PDF åŸºäºè§„åˆ™çš„å¼€æºåº“ pyPDF2 PyMuPDF pdfminer pdfplumber papermage åŸºäºæ·±åº¦å­¦ä¹ çš„å¼€æºåº“ Layout-parser PP-StructureV2 PDF-Extract-Kit pix2text MinerU marker Gptpdfï¼ˆåŸºäº LLM APIï¼‰ å•†ä¸šé—­æºåº“ Textln.com Doc2x mathpix åº–ä¸ PDFlux è…¾è®¯äº‘æ–‡æ¡£è¯†åˆ« åˆ†å—ç­–ç•¥ ä»£ç ç¤ºä¾‹ åˆ†å—æ¼”ç¤ºå·¥å…· 3 ä¸ªå…³é”®éƒ¨åˆ†ç»„æˆï¼š å¤§å° é‡å  æ‹†åˆ† å›ºå®šå¤§å°åˆ†å—ï¼ˆFixed Size Chunkingï¼‰ é€‚ç”¨åœºæ™¯ï¼š ä½œä¸ºåˆ†å—ç­–ç•¥çš„åŸºå‡†çº¿ï¼› å¯¹å¤§å‹æ•°æ®é›†è¿›è¡Œåˆæ­¥åˆ†æï¼› å®ç°ç®€å•ä¸”å¯è§‚æµ‹æ€§é«˜ï¼Œåˆ†å—ä¾¿äºç®¡ç†ï¼› é€‚ç”¨äºæ ¼å¼å’Œå¤§å°ç›¸ä¼¼çš„åŒè´¨æ•°æ®é›†ï¼Œå¦‚æ–°é—»æ–‡ç« æˆ–åšå®¢æ–‡ç« ã€‚ é—®é¢˜ï¼š ä¸è€ƒè™‘å†…å®¹ä¸Šä¸‹æ–‡ï¼Œå®¹æ˜“å¯¼è‡´æ— æ„ä¹‰çš„æ–‡æœ¬å—ï¼› ç¼ºä¹çµæ´»æ€§ï¼Œæ— æ³•é€‚åº”æ–‡æœ¬çš„è‡ªç„¶ç»“æ„ é‡å åˆ†å—ï¼ˆOverlap Chunkingï¼‰ ä½¿ç”¨åœºæ™¯ï¼š éœ€è¦æ·±å…¥ç†è§£è¯­ä¹‰å¹¶ä¿æŒä¸Šä¸‹æ–‡å®Œæ•´æ€§çš„æ–‡æ¡£ï¼Œå¦‚æ³•å¾‹æ–‡æ¡£ã€æŠ€æœ¯æ‰‹å†Œæˆ–ç§‘ç ”è®ºæ–‡ï¼› æå‡åˆ†å—å†…å®¹çš„è¿è´¯æ€§ï¼Œä»¥æé«˜åˆ†æè´¨é‡ã€‚ é—®é¢˜ï¼š è®¡ç®—å¤æ‚åº¦å¢åŠ ï¼Œå¤„ç†æ•ˆç‡é™ä½ï¼› å†—ä½™ä¿¡æ¯çš„å­˜å‚¨å’Œç®¡ç†æˆä¸ºè´Ÿæ‹…ã€‚ é€’å½’åˆ†å—ï¼ˆRecursive Chunkingï¼‰ é€šè¿‡é¢„å®šä¹‰çš„æ–‡æœ¬åˆ†éš”ç¬¦ï¼ˆå¦‚æ¢è¡Œç¬¦ ã€ã€å¥å·ã€é€—å·ã€æ„Ÿå¹å·ã€ç©ºæ ¼ç­‰ï¼‰è¿­ä»£åœ°å°†æ–‡æœ¬åˆ†è§£ä¸ºæ›´å°çš„å—ï¼Œä»¥å®ç°æ®µå¤§å°çš„å‡åŒ€æ€§å’Œè¯­ä¹‰å®Œæ•´æ€§ã€‚ å…ˆæŒ‰è¾ƒå¤§çš„é€»è¾‘å•å…ƒåˆ†å‰²ï¼Œå†é€æ­¥é€’å½’åˆ°è¾ƒå°å•å…ƒï¼Œç¡®ä¿åœ¨åˆ†å—å¤§å°é™åˆ¶å†…ä¿ç•™æœ€å¼ºçš„è¯­ä¹‰ç‰‡æ®µã€‚ ä½¿ç”¨åœºæ™¯ï¼š éœ€è¦é€å±‚åˆ†æçš„æ–‡æœ¬æ–‡æ¡£æˆ–éœ€è¦åˆ†è§£æˆé•¿ç‰‡æ®µã€é•¿æ®µè½çš„é•¿æ–‡æ¡£ï¼Œå¦‚ç ”ç©¶æŠ¥å‘Šã€æ³•å¾‹æ–‡æ¡£ç­‰ã€‚ é—®é¢˜ï¼š åœ¨å—è¾¹ç•Œå¤„æ¨¡ç³Šè¯­ä¹‰ï¼Œå®¹æ˜“å°†å®Œæ•´çš„è¯­ä¹‰å•å…ƒåˆ‡åˆ†å¼€ã€‚ æ–‡æ¡£ç‰¹å®šåˆ†å—ï¼ˆDocument Specific Chunkingï¼‰ æ ¹æ®æ–‡æ¡£çš„æ ¼å¼ï¼ˆå¦‚ Markdownã€Latexã€æˆ–ç¼–ç¨‹è¯­è¨€å¦‚ Python ç­‰ï¼‰è¿›è¡Œå®šåˆ¶åŒ–åˆ†å‰²çš„æŠ€æœ¯ã€‚æ­¤æ–¹æ³•ä¾æ®æ–‡æ¡£çš„ç‰¹å®šæ ¼å¼å’Œç»“æ„è§„åˆ™ï¼Œä¾‹å¦‚ Markdown çš„æ ‡é¢˜ã€åˆ—è¡¨é¡¹ï¼Œæˆ– Python ä»£ç ä¸­çš„å‡½æ•°å’Œç±»å®šä¹‰ç­‰ï¼Œæ¥ç¡®å®šåˆ†å—è¾¹ç•Œã€‚ é€‚ç”¨åœºæ™¯ï¼š æœ‰ç‰¹å®šçš„æ–‡æ¡£ç»“æ„ï¼Œå¦‚ç¼–ç¨‹è¯­è¨€ã€Markdownã€Latex ç­‰ç»“æ„æ–‡æ¡£ã€‚ é—®é¢˜ï¼š æ ¼å¼ä¾èµ–æ€§å¼ºï¼Œä¸åŒæ ¼å¼ä¹‹é—´çš„åˆ†å—ç­–ç•¥ä¸é€šç”¨ï¼› æ— æ³•å¤„ç†æ ¼å¼ä¸è§„èŒƒåŠæ··åˆå¤šç§æ ¼å¼çš„æƒ…å†µã€‚ è¯­ä¹‰åˆ†å—ï¼ˆSemantic Chunkingï¼‰ åŸºäºæ–‡æœ¬çš„è‡ªç„¶è¯­è¨€è¾¹ç•Œï¼ˆå¦‚å¥å­ã€æ®µè½æˆ–ä¸»é¢˜ä¸­æ–­ï¼‰è¿›è¡Œåˆ†æ®µçš„æŠ€æœ¯ï¼Œéœ€è¦ä½¿ç”¨ NLP æŠ€æœ¯æ ¹æ®è¯­ä¹‰åˆ†è¯åˆ†å¥ï¼Œæ—¨åœ¨ç¡®ä¿æ¯ä¸ªåˆ†å—éƒ½åŒ…å«è¯­ä¹‰è¿è´¯çš„ä¿¡æ¯å•å…ƒã€‚ é€‚ç”¨åœºæ™¯ï¼š ç¡®ä¿æ¯ä¸ªæ–‡æ¡£å—çš„ä¿¡æ¯å®Œæ•´æ€§ä¸”è¯­ä¹‰è¿è´¯ï¼› æé«˜æ£€ç´¢ç»“æœçš„ç›¸å…³æ€§å’Œå‡†ç¡®æ€§ï¼› é€‚ç”¨äºå¤æ‚æ–‡æ¡£å’Œä¸Šä¸‹æ–‡æ•æ„Ÿçš„ç²¾ç»†åŒ–åˆ†æã€‚ é—®é¢˜ï¼š éœ€è¦é¢å¤–çš„é«˜è®¡ç®—èµ„æºï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤§å‹æˆ–åŠ¨æ€å˜åŒ–çš„æ–‡æ¡£æ•°æ®æ—¶ï¼› å¤„ç†æ•ˆç‡é™ä½ã€‚ æ··åˆåˆ†å—ï¼ˆMix Chunkingï¼‰ åœ¨åˆå§‹é˜¶æ®µä½¿ç”¨å›ºå®šé•¿åº¦åˆ†å—å¿«é€Ÿæ•´ç†å¤§é‡æ–‡æ¡£ï¼Œè€Œåœ¨åç»­é˜¶æ®µä½¿ç”¨è¯­ä¹‰åˆ†å—è¿›è¡Œæ›´ç²¾ç»†çš„åˆ†ç±»å’Œä¸»é¢˜æå–ã€‚æ ¹æ®å®é™…ä¸šåŠ¡åœºæ™¯ï¼Œè®¾è®¡å¤šç§åˆ†å—ç­–ç•¥çš„æ··åˆï¼Œèƒ½å¤Ÿçµæ´»é€‚åº”å„ç§éœ€æ±‚ï¼Œæä¾›æ›´å¼ºå¤§çš„åˆ†å—æ–¹æ¡ˆã€‚ é€‚ç”¨åœºæ™¯ï¼š é€‚ç”¨äºå¤šå±‚æ¬¡çš„ç²¾ç»†åŒ–åˆ†å—åœºæ™¯ï¼› æ•°æ®é›†åŠ¨æ€å˜åŒ–ï¼ŒåŒ…å«å¤šç§æ–‡æ¡£æ ¼å¼ä¸ç»“æ„ï¼› å¹³è¡¡å¤„ç†é€Ÿåº¦ä¸å‡†ç¡®æ€§çš„åœºæ™¯ã€‚ é—®é¢˜ï¼š å®ç°å¤æ‚åº¦é«˜ï¼› ç­–ç•¥è°ƒä¼˜éš¾åº¦é«˜ï¼› èµ„æºæ¶ˆè€—å¢åŠ ã€‚ Embedding æŠ€æœ¯ Embedding åµŒå…¥æ˜¯æŒ‡å°†æ–‡æœ¬ã€å›¾åƒã€éŸ³é¢‘ã€è§†é¢‘ç­‰å½¢å¼çš„ä¿¡æ¯æ˜ å°„ä¸ºé«˜ç»´ç©ºé—´ä¸­çš„å¯†é›†å‘é‡è¡¨ç¤ºã€‚è¿™äº›å‘é‡åœ¨è¯­ä¹‰ç©ºé—´ä¸­èµ·åˆ°åæ ‡çš„ä½œç”¨ï¼Œæ•æ‰å¯¹è±¡ä¹‹é—´çš„è¯­ä¹‰å…³ç³»å’Œéšå«çš„æ„ä¹‰ã€‚é€šè¿‡åœ¨å‘é‡ç©ºé—´ä¸­è¿›è¡Œè®¡ç®—ï¼ˆä¾‹å¦‚ä½™å¼¦ç›¸ä¼¼åº¦ï¼‰ï¼Œå¯ä»¥é‡åŒ–å’Œè¡¡é‡è¿™äº›å¯¹è±¡ä¹‹é—´çš„è¯­ä¹‰ç›¸ä¼¼æ€§ã€‚ å‘é‡æ£€ç´¢ï¼ˆVector Retrievalï¼‰æ˜¯ä¸€ç§åŸºäºå‘é‡è¡¨ç¤ºçš„æœç´¢æŠ€æœ¯ï¼Œé€šè¿‡è®¡ç®—æŸ¥è¯¢å‘é‡ä¸å·²çŸ¥æ–‡æœ¬å‘é‡çš„ç›¸ä¼¼åº¦æ¥è¯†åˆ«æœ€ç›¸å…³çš„æ–‡æœ¬æ•°æ®ã€‚å‘é‡æ£€ç´¢çš„é«˜æ•ˆæ€§åœ¨äºï¼Œå®ƒèƒ½åœ¨å¤§è§„æ¨¡æ•°æ®é›†ä¸­å¿«é€Ÿã€å‡†ç¡®åœ°æ‰¾åˆ°ä¸æŸ¥è¯¢æœ€ç›¸å…³çš„å†…å®¹ï¼Œè¿™å¾—ç›Šäºå‘é‡è¡¨ç¤ºä¸­è•´å«çš„ä¸°å¯Œè¯­ä¹‰ä¿¡æ¯ã€‚ è¯„ä¼°æŒ‡æ ‡ï¼šï¼ˆMTEBã€C-MTEBï¼‰ ç‰¹å®šé¢†åŸŸçš„é€‚ç”¨æ€§ æ£€ç´¢ç²¾åº¦ æ”¯æŒçš„è¯­è¨€ æ–‡æœ¬å—é•¿åº¦ æ¨¡å‹å¤§å° æ£€ç´¢æ•ˆç‡ å‘é‡æ•°æ®åº“ ä»£ç ç¤ºä¾‹ å‘é‡æ•°æ®åº“æ˜¯ä¸€ç§ä¸“é—¨ç”¨äºå­˜å‚¨å’Œæ£€ç´¢å¤šç»´å‘é‡çš„æ•°æ®åº“ç±»å‹ï¼Œä¸ä¼ ç»Ÿçš„åŸºäºè¡Œåˆ—ç»“æ„çš„æ•°æ®åº“ä¸åŒï¼Œå®ƒä¸»è¦å¤„ç†é«˜ç»´ç©ºé—´ä¸­çš„æ•°æ®ç‚¹ã€‚ å‘é‡æ•°æ®åº“çš„æ“ä½œé€»è¾‘æ˜¯åŸºäºç›¸ä¼¼æ€§æœç´¢ï¼Œå³åœ¨æŸ¥è¯¢æ—¶ï¼Œåº”ç”¨ç‰¹å®šçš„ç›¸ä¼¼æ€§åº¦é‡ï¼ˆå¦‚ä½™å¼¦ç›¸ä¼¼åº¦ã€æ¬§å‡ é‡Œå¾—è·ç¦»ç­‰ï¼‰æ¥æŸ¥æ‰¾ä¸æŸ¥è¯¢å‘é‡æœ€ç›¸ä¼¼çš„å‘é‡ã€‚ å‘é‡æ•°æ®åº“çš„æ ¸å¿ƒåœ¨äºå…¶é«˜æ•ˆçš„ç´¢å¼•å’Œæœç´¢æœºåˆ¶ã€‚ä¸ºäº†ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ï¼Œå®ƒé‡‡ç”¨äº†å¦‚å“ˆå¸Œã€é‡åŒ–å’ŒåŸºäºå›¾å½¢çš„å¤šç§ç®—æ³•ã€‚ å±‚æ¬¡åŒ–å¯å¯¼èˆªå°ä¸–ç•Œï¼ˆHNSWï¼‰ï¼šé€šè¿‡åœ¨å¤šå±‚ç»“æ„ä¸­å°†ç›¸ä¼¼å‘é‡è¿æ¥åœ¨ä¸€èµ·ï¼Œå¿«é€Ÿç¼©å°æœç´¢èŒƒå›´ã€‚ äº§å“é‡åŒ–ï¼ˆPQï¼‰ï¼šé€šè¿‡å‹ç¼©é«˜ç»´å‘é‡ï¼Œå‡å°‘å†…å­˜å ç”¨å¹¶åŠ é€Ÿæ£€ç´¢ã€‚ ä½ç½®æ•æ„Ÿå“ˆå¸Œï¼ˆLSHï¼‰ï¼šé€šè¿‡å“ˆå¸Œå‡½æ•°å°†ç›¸ä¼¼å‘é‡èšé›†åœ¨ä¸€èµ·ï¼Œä¾¿äºå¿«é€Ÿå®šä½ã€‚ å‘é‡æ•°æ®åº“çš„å·¥ä½œæµç¨‹ï¼š æ•°æ®å¤„ç†ä¸å‘é‡åŒ– å‘é‡å­˜å‚¨ å‘é‡ç´¢å¼• å‘é‡æœç´¢ ä½™å¼¦ç›¸ä¼¼åº¦ï¼šä¸»è¦ç”¨äºæ–‡æœ¬å¤„ç†å’Œä¿¡æ¯æ£€ç´¢ï¼Œå…³æ³¨å‘é‡ä¹‹é—´çš„è§’åº¦ï¼Œä»¥æ•æ‰è¯­ä¹‰ç›¸ä¼¼æ€§ã€‚ æ¬§å‡ é‡Œå¾—è·ç¦»ï¼šæµ‹é‡å‘é‡ä¹‹é—´çš„å®é™…è·ç¦»ï¼Œé€‚ç”¨äºå¯†é›†ç‰¹å¾é›†çš„èšç±»æˆ–åˆ†ç±»ã€‚ æ›¼å“ˆé¡¿è·ç¦»ï¼šé€šè¿‡è®¡ç®—ç¬›å¡å°”åæ ‡ä¸­çš„ç»å¯¹å·®å€¼ä¹‹å’Œï¼Œé€‚ç”¨äºç¨€ç–æ•°æ®çš„å¤„ç†ã€‚ æ•°æ®æ£€ç´¢ æ··åˆæ£€ç´¢ ä»£ç ç¤ºä¾‹ æ··åˆæ£€ç´¢ï¼ˆHybrid Searchï¼‰é€šè¿‡ç»“åˆå…³é”®è¯æ£€ç´¢å’Œè¯­ä¹‰åŒ¹é…çš„ä¼˜åŠ¿ï¼Œå¯ä»¥é¦–å…ˆåˆ©ç”¨å…³é”®è¯æ£€ç´¢ç²¾ç¡®å®šä½åˆ°â€œè®¢å• 12345â€çš„ä¿¡æ¯ï¼Œç„¶åé€šè¿‡è¯­ä¹‰åŒ¹é…æ‰©å±•ä¸è¯¥è®¢å•ç›¸å…³çš„å…¶ä»–ä¸Šä¸‹æ–‡æˆ–å®¢æˆ·æ“ä½œçš„ä¿¡æ¯ï¼Œä¾‹å¦‚â€œ12 å¼€å¤´çš„è®¢å•ã€åŒ…è£…ç ´æŸä¸¥é‡â€ç­‰ã€‚è¿™æ ·ä¸ä»…èƒ½å¤Ÿè·å–ç²¾ç¡®çš„è®¢å•è¯¦æƒ…ï¼Œè¿˜èƒ½è·å¾—ä¸ä¹‹ç›¸å…³çš„é¢å¤–æœ‰ç”¨ä¿¡æ¯ã€‚ é‡æ’åºæŠ€æœ¯ ä»£ç ç¤ºä¾‹ é‡æ’åºæŠ€æœ¯ï¼ˆRerankingï¼‰é€šè¿‡å¯¹åˆå§‹æ£€ç´¢ç»“æœè¿›è¡Œé‡æ–°æ’åºï¼Œæ”¹å–„æ£€ç´¢ç»“æœçš„ç›¸å…³æ€§ï¼Œä¸ºç”Ÿæˆæ¨¡å‹æä¾›æ›´ä¼˜è´¨çš„ä¸Šä¸‹æ–‡ï¼Œä»è€Œæå‡æ•´ä½“ RAG ç³»ç»Ÿçš„æ•ˆæœã€‚ é‡æ’åºæ¨¡å‹å¤§å¤šæ˜¯åŸºäºåŒå¡”æˆ–äº¤å‰ç¼–ç æ¶æ„çš„æ¨¡å‹ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šè¿›ä¸€æ­¥è®¡ç®—æ›´ç²¾ç¡®çš„ç›¸å…³æ€§åˆ†æ•°ï¼Œèƒ½å¤Ÿæ•æ‰æŸ¥è¯¢è¯ä¸æ–‡æ¡£å—ä¹‹é—´æ›´ç»†è‡´çš„ç›¸å…³æ€§ï¼Œä»è€Œåœ¨ç»†èŠ‚å±‚é¢ä¸Šæé«˜æ£€ç´¢ç²¾åº¦ã€‚ æç¤ºå·¥ç¨‹ ä¸€ä¸ªæç¤ºï¼ˆpromptï¼‰é€šå¸¸åŒ…å«ä»¥ä¸‹å‡ ä¸ªå…ƒç´ ï¼š æŒ‡ä»¤ï¼ˆInstructionï¼‰ï¼šæŒ‡æ˜æ¨¡å‹è¦æ‰§è¡Œçš„ç‰¹å®šä»»åŠ¡æˆ–æ“ä½œã€‚ ä¸Šä¸‹æ–‡ï¼ˆContextï¼‰ï¼šä¸ºæ¨¡å‹æä¾›é¢å¤–ä¿¡æ¯æˆ–èƒŒæ™¯ï¼Œå¯ä»¥å¸®åŠ©å¼•å¯¼æ¨¡å‹ç”Ÿæˆæ›´å‡†ç¡®çš„å“åº”ã€‚ è¾“å…¥æ•°æ®ï¼ˆInput Dataï¼‰ï¼šæˆ‘ä»¬å¸Œæœ›æ¨¡å‹å›ç­”çš„é—®é¢˜æˆ–æ„Ÿå…´è¶£çš„è¾“å…¥å†…å®¹ã€‚ è¾“å‡ºæŒ‡ç¤ºç¬¦ï¼ˆOutput Indicatorï¼‰ï¼šæŒ‡å®šæ¨¡å‹çš„è¾“å‡ºç±»å‹æˆ–æ ¼å¼ï¼Œä¾‹å¦‚æ ¼å¼ã€æ˜¯å¦è¦ç”Ÿæˆä»£ç ã€æ€»ç»“æ–‡æœ¬æˆ–å›ç­”å…·ä½“é—®é¢˜ã€‚ æ ¸å¿ƒæŠ€å·§ï¼š å…·ä½“æŒ‡ä»¤æ³•ï¼šå…·ä½“ã€ç»†è‡´åœ°å‘Šè¯‰å¤§æ¨¡å‹è¦åšä»€ä¹ˆã€‚ ç¤ºä¾‹å­¦ä¹ ï¼šç»™å‡ºå…·ä½“è¯¦å°½çš„æœŸæœ›ç¤ºä¾‹ã€‚ é»˜è®¤å›å¤ç­–ç•¥ï¼šè®¾å®šé»˜è®¤å›å¤ç­–ç•¥ï¼Œé¿å…æ¨¡å‹äº§ç”Ÿâ€œå¹»è§‰â€ï¼Œè®©å®ƒä¸çŸ¥é“å°±è¯´ä¸çŸ¥é“ã€‚ ä»»åŠ¡è§’è‰²è®¾å®šï¼šè®¾å®šèº«ä»½ï¼Œå¯ä»¥å¸®åŠ©æ¨¡å‹æ›´å¥½åœ°ç†è§£ä»»åŠ¡è¦æ±‚å’Œè§’è‰²è´£ä»»ï¼Œä»è€Œè¾“å‡ºæ›´åŠ ä¸€è‡´ã€ä¸“ä¸šçš„å†…å®¹ã€‚ è§£é‡Šç†ç”±æ³•ï¼šå‘æ¨¡å‹è§£é‡Šä¸ºä»€ä¹ˆæŸäº›ä»»åŠ¡éœ€è¦ç‰¹å®šçš„å¤„ç†æ–¹å¼ï¼Œå¸®åŠ©å…¶ç†è§£ä»»åŠ¡èƒŒæ™¯ã€‚ æ–‡æ¡£åŸºç¡€è¯´æ˜ï¼šæä¾›æ–‡æ¡£çš„èƒŒæ™¯ä¿¡æ¯å’Œæ–‡æœ¬æ¥æºã€‚ ä¼˜åŒ–æŠ€æœ¯ æ•°æ®æ¸…æ´—å’Œé¢„å¤„ç† åœ¨ RAG ç´¢å¼•æµç¨‹ä¸­ï¼Œæ–‡æ¡£è§£æä¹‹åã€æ–‡æœ¬å—åˆ‡åˆ†ä¹‹å‰ï¼Œè¿›è¡Œæ•°æ®æ¸…æ´—å’Œé¢„å¤„ç†èƒ½å¤Ÿæœ‰æ•ˆå‡å°‘è„æ•°æ®å’Œå™ªå£°ï¼Œæå‡æ–‡æœ¬çš„æ•´ä½“è´¨é‡å’Œä¿¡æ¯å¯†åº¦ã€‚ é€šè¿‡æ¸…é™¤å†—ä½™ä¿¡æ¯ã€ç»Ÿä¸€æ ¼å¼ã€å¤„ç†å¼‚å¸¸å­—ç¬¦ç­‰æ‰‹æ®µï¼Œæ•°æ®æ¸…æ´—å’Œé¢„å¤„ç†è¿‡ç¨‹ç¡®ä¿æ–‡æ¡£æ›´åŠ è§„èŒƒå’Œé«˜è´¨é‡ï¼Œä»è€Œæé«˜ RAG ç³»ç»Ÿçš„æ£€ç´¢æ•ˆæœå’Œä¿¡æ¯å‡†ç¡®æ€§ã€‚ å¤„ç†å†—ä½™çš„æ¨¡å‹å†…å®¹ã€‚ æ¶ˆé™¤æ–‡æ¡£ä¸­çš„é¢å¤–ç©ºç™½å’Œæ ¼å¼ä¸ä¸€è‡´ã€‚ å»é™¤æ— ç”¨çš„æ–‡æ¡£è„šæ³¨ã€é¡µçœ‰é¡µè„šã€ç‰ˆæƒä¿¡æ¯ã€‚ æŸ¥è¯¢æ‰©å±• æŸ¥è¯¢æ‰©å±•ç­–ç•¥é€šè¿‡å¤§æ¨¡å‹ä»åŸå§‹æŸ¥è¯¢è¯­å¥ç”Ÿæˆå¤šä¸ªè¯­ä¹‰ç›¸å…³çš„æŸ¥è¯¢ï¼Œå¯ä»¥è¦†ç›–å‘é‡ç©ºé—´ä¸­çš„ä¸åŒåŒºåŸŸï¼Œä»è€Œæé«˜æ£€ç´¢çš„å…¨é¢æ€§å’Œå‡†ç¡®æ€§ã€‚ æŸ¥è¯¢æ‰©å±•çš„æŒ‡ä»¤æ¨¡ç‰ˆï¼š ä½ æ˜¯ä¸€ä¸ªAIè¯­è¨€æ¨¡å‹åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯ç”Ÿæˆäº”ä¸ªä¸åŒç‰ˆæœ¬çš„ç”¨æˆ·é—®é¢˜ï¼Œä»¥ä¾¿ä»å‘é‡æ•°æ®åº“ä¸­æ£€ç´¢ç›¸å…³æ–‡æ¡£ã€‚é€šè¿‡ä»å¤šä¸ªè§’åº¦ç”Ÿæˆç”¨æˆ·é—®é¢˜ï¼Œä½ çš„ç›®æ ‡æ˜¯å¸®åŠ©ç”¨æˆ·å…‹æœåŸºäºè·ç¦»çš„ç›¸ä¼¼æ€§æœç´¢çš„ä¸€äº›å±€é™æ€§ã€‚è¯·å°†è¿™äº›æ›¿ä»£é—®é¢˜ç”¨æ¢è¡Œç¬¦åˆ†éš”ã€‚åŸå§‹é—®é¢˜ï¼šæŸ¥è¯¢åŸæ–‡ å‡è®¾é—®é¢˜ï¼š ä¸‹é¢æŠ¥å‘Šä¸­æ¶‰åŠäº†å“ªå‡ ä¸ªè¡Œä¸šçš„æ¡ˆä¾‹ä»¥åŠæ€»ç»“å„è‡ªé¢ä¸´çš„æŒ‘æˆ˜ï¼Ÿ ç»“æœç¤ºä¾‹ï¼š è¯·é—®æŠ¥å‘Šä¸­æåˆ°çš„æ¡ˆä¾‹æ¶‰åŠäº†å“ªäº›è¡Œä¸šï¼Ÿè¿™äº›è¡Œä¸šå„è‡ªé¢ä¸´çš„æŒ‘æˆ˜æœ‰å“ªäº›ï¼ŸæŠ¥å‘Šä¸­æœ‰å“ªäº›è¡Œä¸šçš„æ¡ˆä¾‹è¢«è®¨è®ºï¼Ÿæ¯ä¸ªè¡Œä¸šåœ¨æŠ¥å‘Šä¸­æè¿°çš„æŒ‘æˆ˜æ˜¯ä»€ä¹ˆï¼Ÿè¿™ä¸ªæŠ¥å‘Šä¸­å…·ä½“æåˆ°äº†å“ªäº›è¡Œä¸šçš„æ¡ˆä¾‹ï¼Ÿèƒ½å¦æ€»ç»“ä¸€ä¸‹è¿™äº›è¡Œä¸šå½“å‰é¢ä¸´çš„ä¸»è¦æŒ‘æˆ˜ï¼Ÿè¯¥æŠ¥å‘Šä¸­æ¶µç›–äº†å“ªäº›è¡Œä¸šæ¡ˆä¾‹ï¼Œå¹¶å¯¹å„è¡Œä¸šçš„æŒ‘æˆ˜è¿›è¡Œäº†å“ªäº›è®¨è®ºï¼Ÿåœ¨æŠ¥å‘Šä¸­æåˆ°çš„è¡Œä¸šæ¡ˆä¾‹æœ‰å“ªäº›ï¼Ÿè¿™äº›è¡Œä¸šåˆ†åˆ«é‡åˆ°çš„ä¸»è¦é—®é¢˜å’ŒæŒ‘æˆ˜æ˜¯ä»€ä¹ˆï¼Ÿ é€šè¿‡è¿™ç§æŸ¥è¯¢æ‰©å±•ç­–ç•¥ï¼ŒåŸå§‹é—®é¢˜è¢«åˆ†è§£ä¸ºå¤šä¸ªå­æŸ¥è¯¢ï¼Œæ¯ä¸ªå­æŸ¥è¯¢ç‹¬ç«‹æ£€ç´¢ç›¸å…³æ–‡æ¡£å¹¶ç”Ÿæˆç›¸åº”çš„ç»“æœã€‚éšåï¼Œç³»ç»Ÿå°†æ‰€æœ‰å­æŸ¥è¯¢çš„æ£€ç´¢ç»“æœè¿›è¡Œåˆå¹¶å’Œé‡æ–°æ’åºï¼Œæ•ˆæœä¼šæ›´å…¨é¢æ›´å‡†ç¡®ã€‚ è‡ªæŸ¥è¯¢ è‡ªæŸ¥è¯¢ç­–ç•¥é€šè¿‡å¤§è¯­è¨€æ¨¡å‹è‡ªåŠ¨æå–æŸ¥è¯¢ä¸­å¯¹ä¸šåŠ¡åœºæ™¯è‡³å…³é‡è¦çš„å…ƒæ•°æ®å­—æ®µï¼ˆå¦‚æ ‡ç­¾ã€ä½œè€… IDã€è¯„è®ºæ•°é‡ç­‰å…³é”®ä¿¡æ¯ï¼‰ï¼Œå¹¶å°†è¿™äº›ä¿¡æ¯ç»“åˆåˆ°åµŒå…¥æ£€ç´¢è¿‡ç¨‹ä¸­ã€‚ è‡ªæŸ¥è¯¢çš„æŒ‡ä»¤æ¨¡ç‰ˆï¼š ä½ æ˜¯ä¸€ä¸ªAIè¯­è¨€æ¨¡å‹åŠ©æ‰‹ã€‚ ä½ çš„ä»»åŠ¡æ˜¯ä»ç”¨æˆ·é—®é¢˜ä¸­æå–å…³é”®ä¿¡æ¯ï¼Œä½ çš„å›å¤åº”ä»…åŒ…å«æå–çš„å…³é”®ä¿¡æ¯ã€‚ ç”¨æˆ·é—®é¢˜ï¼šæŸ¥è¯¢åŸæ–‡ å‡è®¾é—®é¢˜ï¼š ä¸‹é¢æŠ¥å‘Šä¸­æ¶‰åŠäº†å“ªå‡ ä¸ªè¡Œä¸šçš„æ¡ˆä¾‹ä»¥åŠæ€»ç»“å„è‡ªé¢ä¸´çš„æŒ‘æˆ˜ï¼Ÿ ç»“æœç¤ºä¾‹ï¼š è¡Œä¸šï¼Œæ¡ˆä¾‹ï¼ŒæŒ‘æˆ˜ æç¤ºå‹ç¼© æç¤ºå‹ç¼©é€šè¿‡ç²¾ç®€ä¸Šä¸‹æ–‡ã€è¿‡æ»¤æ‰ä¸ç›¸å…³çš„ä¿¡æ¯ï¼Œç¡®ä¿ç³»ç»Ÿåªå¤„ç†ä¸æŸ¥è¯¢æœ€ç›¸å…³ã€æœ€é‡è¦çš„å†…å®¹ã€‚ æç¤ºå‹ç¼©çš„æŒ‡ä»¤æ¨¡ç‰ˆï¼š ä½ æ˜¯ä¸€ä¸ªAIè¯­è¨€æ¨¡å‹åŠ©æ‰‹ï¼Œè´Ÿè´£å¯¹æ£€ç´¢åˆ°çš„æ–‡æ¡£è¿›è¡Œä¸Šä¸‹æ–‡å‹ç¼©ã€‚ä½ çš„ç›®æ ‡æ˜¯ä»æ–‡æ¡£ä¸­æå–ä¸ç”¨æˆ·æŸ¥è¯¢é«˜åº¦ç›¸å…³çš„æ®µè½ï¼Œå¹¶åˆ é™¤ä¸æŸ¥è¯¢æ— å…³æˆ–å™ªå£°è¾ƒå¤§çš„éƒ¨åˆ†ã€‚ä½ åº”ç¡®ä¿ä¿ç•™æ‰€æœ‰èƒ½å¤Ÿç›´æ¥å›ç­”ç”¨æˆ·æŸ¥è¯¢çš„é—®é¢˜æ ¸å¿ƒä¿¡æ¯ã€‚è¾“å…¥ï¼šç”¨æˆ·æŸ¥è¯¢ï¼šç”¨æˆ·çš„åŸå§‹æŸ¥è¯¢æ£€ç´¢åˆ°çš„æ–‡æ¡£ï¼šæ£€ç´¢åˆ°çš„æ–‡æ¡£å†…å®¹è¾“å‡ºè¦æ±‚ï¼šæå–ä¸ç”¨æˆ·æŸ¥è¯¢æœ€ç›¸å…³çš„æ®µè½å’Œä¿¡æ¯ã€‚åˆ é™¤æ‰€æœ‰ä¸æŸ¥è¯¢æ— å…³çš„å†…å®¹ï¼ŒåŒ…æ‹¬å™ªå£°ã€èƒŒæ™¯ä¿¡æ¯æˆ–æ‰©å±•è®¨è®ºã€‚å‹ç¼©åçš„å†…å®¹åº”ç®€æ´æ¸…æ™°ï¼Œç›´æŒ‡ç”¨æˆ·çš„æ ¸å¿ƒé—®é¢˜ã€‚è¾“å‡ºæ ¼å¼ï¼šå‹ç¼©æ®µè½1å‹ç¼©æ®µè½2å‹ç¼©æ®µè½3 RAG æ•ˆæœè¯„ä¼° å¤§æ¨¡å‹æ‰“åˆ†ï¼šé€šè¿‡ LLM å¯¹ RAG çš„è¾“å‡ºè¿›è¡Œè‡ªåŠ¨è¯„åˆ†ã€‚æ•ˆç‡é«˜ï¼Œä½†æ˜¯å‡†ç¡®æ€§ä¸€èˆ¬ã€‚ äººå·¥æ‰“åˆ†ï¼šæ‰‹å·¥é’ˆå¯¹ RAG çš„è¾“å‡ºè¿›è¡Œé€ä¸€æ‰“åˆ†ã€‚æ›´ç²¾ç¡®ã€ç»†è‡´çš„åé¦ˆï¼Œæˆæœ¬é«˜ã€‚ è¯„ä¼°æŒ‡æ ‡ï¼š CRï¼ˆContext Relevancyï¼‰æ£€ç´¢ç›¸å…³æ€§ï¼šæ£€ç´¢åˆ°çš„ä¿¡æ¯æ˜¯å¦åç¦»äº†åŸå§‹æŸ¥è¯¢ã€‚ ARï¼ˆAnswer Relevancyï¼‰ç­”æ¡ˆç›¸å…³æ€§ï¼šæ˜¯å¦èƒ½è§£å†³ç”¨æˆ·çš„é—®é¢˜ï¼Œä¸”å†…å®¹æ˜¯å¦é€»è¾‘è¿è´¯ã€‚ Fï¼ˆFaithfulnessï¼‰å¯ä¿¡åº¦ï¼šæ˜¯å¦å­˜åœ¨å¹»è§‰æˆ–ä¸å‡†ç¡®ä¹‹å¤„ã€‚ æ‰“åˆ†æ ‡å‡†ï¼š å®Œç¾ï¼ˆPerfectï¼‰1.0 åˆ† å¯æ¥å—ï¼ˆAcceptableï¼‰0.75 åˆ† ç¼ºå¤±ï¼ˆMissingï¼‰0.5 åˆ† é”™è¯¯ï¼ˆIncorrectï¼‰0.25 åˆ† æ›´é«˜çº§çš„ RAG GraphRAG GraphRAG é€šè¿‡æ„å»ºçŸ¥è¯†å›¾è°±ï¼Œå°†å®ä½“å’Œå®ä½“ä¹‹é—´çš„å…³ç³»ç»“æ„åŒ–åœ°è¡¨ç¤ºå‡ºæ¥ï¼Œå…‹æœäº†ä¼ ç»Ÿ RAG çš„å¤æ‚æ¨ç†å±€é™æ€§ã€‚ æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š æé«˜ç­”æ¡ˆçš„å‡†ç¡®æ€§å’Œå®Œæ•´æ€§ æé«˜æ•°æ®ç†è§£å’Œè¿­ä»£æ•ˆç‡ æå‡å¯è§£é‡Šæ€§å’Œå¯è¿½æº¯æ€§ çŸ¥è¯†å›¾è°±çš„æ„å»ºæ­¥éª¤ï¼š å®ä½“è¯†åˆ«ï¼šä»æ–‡æœ¬æˆ–æ•°æ®æºä¸­è¯†åˆ«å‡ºå…³é”®å®ä½“ã€‚ å…³ç³»æŠ½å–ï¼šç¡®å®šå®ä½“ä¹‹é—´çš„å…³ç³»ï¼Œå¯èƒ½é€šè¿‡è‡ªç„¶è¯­è¨€å¤„ç†æŠ€æœ¯å®ç°ã€‚ ä¸‰å…ƒç»„ç”Ÿæˆï¼šå°†å®ä½“å’Œå…³ç³»è¡¨ç¤ºä¸º (ä¸»ä½“ï¼Œå…³ç³»ï¼Œå®¢ä½“) çš„å½¢å¼ã€‚ å›¾è°±å­˜å‚¨ï¼šä½¿ç”¨å›¾æ•°æ®åº“æˆ–ä¸“é—¨çš„å­˜å‚¨ç³»ç»Ÿä¿å­˜çŸ¥è¯†å›¾è°±ã€‚ çŸ¥è¯†å›¾è°±çš„ä¸»è¦æˆæœ¬æŒ‘æˆ˜ï¼š æ•°æ®æ”¶é›†ä¸æ¸…æ´—æˆæœ¬ çŸ¥è¯†å›¾è°±æ„å»ºæˆæœ¬ å›¾è°±çš„ç»´æŠ¤ä¸æ›´æ–°","tags":["AI","RAG"],"categories":["AI","RAG"]},{"title":"è¯»ä¹¦ç¬”è®°ä¸¨ã€ŠUnit Testing Principles, Practices, and Patternsã€‹","path":"/2025/04/09/note-unit-testing/","content":"æœ¬ç¯‡åœ¨ä¸Šä¸€ç¯‡çš„åŸºç¡€ä¸Šï¼Œæ¢³ç†ä¸‹ç¬”è€…çš„ä¸ªäººè§è§£ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯å‚è€ƒåŸæ–‡å¯¹æ¯”é˜…è¯»ï¼š https://hedon.top/2025/04/09/note-unit-testing-excerpt/https://hedon.top/2025/04/09/note-unit-testing-excerpt/ æªå¿ƒç–‘æƒ‘ åœ¨æ’°å†™å•å…ƒæµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œä½ æ˜¯å¦æ›¾ç»è¢«ä»¥ä¸‹é—®é¢˜å›°æ‰°è¿‡ï¼Ÿ ä¸ºä»€ä¹ˆè¦å†™å•å…ƒæµ‹è¯•ï¼Ÿå•å…ƒæµ‹è¯•çš„ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ å•å…ƒæµ‹è¯•çš„ç²’åº¦æ˜¯æ€æ ·çš„ï¼Ÿä»€ä¹ˆå«å•å…ƒï¼Ÿa class, a function, or a behavior, or an observable behavior? å•æµ‹è¦†ç›–ç‡çœŸçš„æœ‰ç”¨å—ï¼Ÿæœ‰ä»€ä¹ˆç”¨ï¼Ÿåˆæœ‰å“ªäº›é™åˆ¶ï¼Ÿ æ€æ ·æ‰èƒ½å†™å¥½å•å…ƒæµ‹è¯•ï¼Ÿæ€æ ·æ‰èƒ½å†™å‡ºæ€§ä»·æ¯”æœ€é«˜çš„å•å…ƒæµ‹è¯•ï¼Ÿ å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå•å…ƒæµ‹è¯•çš„å¥½åï¼Ÿæœ‰æ²¡æœ‰å…·ä½“å¯ä¾›å‚é˜…çš„ç»´åº¦ï¼Ÿ å“ªäº›ä»£ç éœ€è¦å†™å•å…ƒæµ‹è¯•ï¼Œå“ªäº›ä»£ç æ²¡å¿…è¦å†™å•å…ƒæµ‹è¯•ï¼Ÿ å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•çš„è¾¹ç•Œæ˜¯ä»€ä¹ˆï¼Ÿ ï¼ˆå•å…ƒä¸¨é›†æˆï¼‰æµ‹è¯•åˆ°åº•æ˜¯è¦æµ‹ä»€ä¹ˆä¸œè¥¿ï¼Ÿ å•å…ƒæµ‹è¯•çš„ä¾§é‡ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿé›†æˆæµ‹è¯•çš„ä¾§é‡ç‚¹æ˜¯ä»€ä¹ˆï¼ŸäºŒè€…çš„æ¯”ä¾‹è¯¥æ˜¯æ€æ ·çš„ï¼Ÿ å¦‚ä½•ä½¿ç”¨ Mockï¼Ÿå“ªäº›ä¸œè¥¿æ˜¯éœ€è¦ Mock çš„ï¼Ÿå“ªäº›ä¸œè¥¿æ˜¯ä¸åº”è¯¥ Mock çš„ï¼Ÿéœ€è¦ Mock çš„ä¸œè¥¿ï¼Œåº”è¯¥åœ¨å“ªä¸ªå±‚æ¬¡è¿›è¡Œ Mockï¼Ÿï¼ˆä½ çš„ repository å±‚éœ€è¦ Mock å—ï¼Ÿï¼‰ ä¸ºä»€ä¹ˆä½ çš„æµ‹è¯•ä»£ç å¾ˆè„†å¼±ï¼Œæ€»æ˜¯éœ€è¦é¢‘ç¹ä¿®æ”¹ï¼Œç»´æŠ¤èµ·æ¥éš¾åº¦å¾ˆå¤§ï¼Ÿ å¦‚ä½•å‡å°‘æµ‹è¯•ç»“æœçš„å‡é˜³æ€§å’Œå‡é˜´æ€§ï¼Ÿ å››æ ¹æŸ±å­ å¯¹äºç¬¬ 5 ä¸ªé—®é¢˜ï¼Œä½œè€…æå‡ºäº† 4 ä¸ªç»´åº¦ï¼š Protection against regressionsï¼šé˜²æ­¢å›å½’ï¼Œé€šè¿‡è‡ªåŠ¨åŒ–éªŒè¯ä»£ç ä¿®æ”¹ååŸæœ‰åŠŸèƒ½ä¸å—ç ´åã€‚ The amount of code that is executed during the test. The complexity of that code. The codeâ€™s domain significance. Resistance to refactoringï¼šæŠ—é‡æ„æ€§ï¼Œé‡æ„ä¸šåŠ¡ä»£ç æ—¶ï¼Œæµ‹è¯•ä»£ç æ— éœ€è¿‡å¤šå˜åŠ¨ä¾¿å¯é€šè¿‡ç”¨ä¾‹ï¼Œè¯æ˜é‡æ„æ— è¯¯ã€‚ Tests provide an early warning when you break existing functionality. You become confident that your code changes wonâ€™t lead to regressions. Fast feedbackï¼šå¿«é€Ÿåé¦ˆã€‚ Maintainabilityï¼šå¯ç»´æŠ¤æ€§ã€‚ How hard it is to understand the test. How hard it is to run the test. å¯¹äºè¿™ 4 ä¸ªé—®é¢˜ï¼Œä½ æ˜¯å¦åˆæœ‰ä»¥ä¸‹ç–‘é—®ï¼š å“ªä¸ªç»´åº¦æ˜¯æœ€é‡è¦çš„ï¼Ÿ æ€æ ·æ‰èƒ½å†™å‡ºæ»¡è¶³å„ä¸ªç»´åº¦çš„æµ‹è¯•ä»£ç ï¼Ÿ å¦‚æœç»´åº¦ä¹‹é—´å­˜åœ¨çŸ›ç›¾ï¼Œå¦‚ä½• trade offï¼Ÿ ä¸ºä»€ä¹ˆè¦å†™å•å…ƒæµ‹è¯•ï¼Ÿ ä¸‰ä¸ªæœ€é‡è¦çš„åŸå› ï¼š éªŒè¯ä½ çš„ç¨‹åºé€»è¾‘æ­£ç¡®æ€§ã€‚ å¸¦æ¥æ›´å¥½çš„ä»£ç è®¾è®¡ã€‚ å› ä¸ºå•å…ƒæµ‹è¯•èƒ½å¤Ÿè®©ä½ ç«™åœ¨ä½¿ç”¨è€…çš„è§’åº¦å»ä½¿ç”¨æš´éœ²çš„æ¥å£ï¼Œå¦‚æœæ¥å£ä¸å¥½ç”¨ï¼Œé€»è¾‘ä¸å¥½æµ‹ï¼Œæµ‹è¯•æ¡ä»¶ä¸å¥½æ„å»ºï¼Œå¤§æ¦‚ç‡è¯´æ˜ä»£ç çš„è®¾è®¡æœ¬èº«æ˜¯æœ‰ç¼ºé™·çš„ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼šæŠ½è±¡ä¸åˆç†ã€é€»è¾‘åˆ’åˆ†ä¸æ¸…æ™°ã€ä¸å…¶ä»–æ¨¡å—è€¦åˆä¸¥é‡ç­‰ã€‚ ä½¿è½¯ä»¶é¡¹ç›®æ›´å¯æŒç»­å‘å±•ã€‚ å¦‚æœä½ çš„éœ€æ±‚æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œé‚£åŸæœ¬èƒ½è¿è¡Œé€šè¿‡çš„å•æµ‹åº”è¯¥ä¸€ç›´éƒ½èƒ½è¿è¡Œï¼Œè¿™æœ‰åŠ©äºé¿å…åœ¨å›¢é˜Ÿåä½œä¸­ä¸å°å¿ƒæ”¹åä½ ä¸çŸ¥é“çš„ä»£ç ï¼Œä¹Ÿæœ‰åŠ©äºä½ æ‰§è¡Œå„ç§é‡æ„æªæ–½ã€‚ è¿™ä¸‰ä¸ªåŸå› çš„é‡è¦æ€§æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œä½†ç¬”è€…ä¸ªäººè§‰å¾—è¿˜æœ‰ä¸€ä¸ªæ›´æ·±å±‚æ¬¡çš„æœ€é‡è¦çš„åŸå› ï¼š ä½ è¦å¯¹ä½ åšçš„äº‹æƒ…è´Ÿè´£ï¼Œå¥½çš„ä»£ç ä¸€å®šè¦å…ˆè¿‡è‡ªå·±è¿™å…³ã€‚ å•å…ƒæµ‹è¯•çš„ç²’åº¦æ˜¯ä»€ä¹ˆï¼Ÿ è¿™æ˜¯ä¸€ä¸ªå¾ˆæœ‰äº‰è®®çš„è¯é¢˜ï¼Œå•å…ƒæµ‹è¯•çš„ã€Œå•å…ƒã€åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ ä¸€ä¸ªç±»ï¼Ÿ ä¸€ä¸ªå‡½æ•°ï¼Ÿ è¿˜æ˜¯å¤šä¸ªç±»ç»„æˆçš„ä¸€ä¸ªæ¨¡å—ï¼Ÿ è¿˜æ˜¯å¤šä¸ªå‡½æ•°ç»„æˆçš„ä¸€ä¸ªå¤§é€»è¾‘ï¼Ÿ åœ¨ã€ŠUnit Testingã€‹ä¹¦ä¸­ï¼Œä½œè€…æŒ‡å‡ºï¼šã€Œå•å…ƒã€æŒ‡çš„æ˜¯ an observable behaviorï¼Œå³ä¸€ä¸ªå¤–éƒ¨ç³»ç»Ÿå¯è§‚æµ‹åˆ°çš„è¡Œä¸ºã€‚ ä¸ºä»€ä¹ˆæ˜¯å¯è§‚æµ‹è¡Œä¸ºï¼š ä¸€ä¸ªå¸®åŠ©å®¢æˆ·ç«¯å®ç°ç›®æ ‡çš„æ“ä½œï¼ˆoperationï¼‰ã€‚ ä¸€ä¸ªå¸®åŠ©å®¢æˆ·ç«¯å®ç°ç›®æ ‡çš„çŠ¶æ€ï¼ˆstateï¼‰ã€‚ æ¢è¨€ä¹‹ï¼Œä¹Ÿå°±æ˜¯æˆ‘åœ¨æ’°å†™å•å…ƒæµ‹è¯•çš„æ—¶å€™ï¼Œæˆ‘å°±æ˜¯åœ¨ä½¿ç”¨ç³»ç»Ÿæä¾›çš„èƒ½åŠ›ï¼Œæˆ‘å°±æ˜¯ä¸ªä½¿ç”¨è€…ï¼Œ æˆ‘åªè¦éªŒè¯ä½ èƒ½æä¾›æˆ‘è¦çš„åŠŸèƒ½ï¼Œå°± OK äº†ï¼Œä½ èƒŒåæ€ä¹ˆåšï¼Œä¸ºäº†è¿™ä¸ªåŠŸèƒ½æ‰€æ‹†åˆ†çš„ç±»ä¹Ÿå¥½ï¼Œå°çš„è¾…åŠ©å‡½æ•°ä¹Ÿå¥½ï¼Œéƒ½ä¸é‡è¦ï¼Œéƒ½ä¸å±äºæˆ‘è¦éªŒè¯çš„èŒƒç•´ã€‚ æ‰€ä»¥è¿™æ›´åƒæ˜¯é»‘ç›’æµ‹è¯•ï¼ˆblack-box testï¼‰ã€‚ å½“ç„¶ï¼Œä¼šæœ‰ä¾‹å¤–ï¼Œå¦‚æœä½ åº•å±‚æœ‰ä¸€ä¸ªç‰¹åˆ«ç‰¹åˆ«å¤æ‚çš„é€»è¾‘ï¼Œä½ æœ‰å¿…è¦ä¸“é—¨èŠ±ç²¾åŠ›å»éªŒè¯å®ƒçš„é€»è¾‘æ­£ç¡®æ€§ï¼Œé‚£æ˜¯å¯ä»¥é’ˆå¯¹å®ƒæ’°å†™ä¸“é—¨çš„ç™½ç›’æµ‹è¯•ï¼ˆwhite-box testï¼‰çš„ã€‚é’ˆå¯¹è¿™ä¸ªæƒ…å†µï¼Œä½œè€…å…¶å®ä¹Ÿæå‡ºäº†ä¸€ä¸ªè§‚ç‚¹ï¼Œå¯¹äºè¿™ä¸ªå¤æ‚çš„é€»è¾‘ï¼Œä¹Ÿå¯ä»¥æŠ½æˆä¸€ä¸ªå•ç‹¬çš„æ¨¡å—ï¼Œç”±å®ƒæ¥æä¾›èƒ½åŠ›ç»™ä½ å½“å‰æ¨¡å—ä½¿ç”¨ã€‚ æ€»ç»“ï¼š ä¼˜å…ˆé€‰æ‹©é»‘ç›’æµ‹è¯•ã€‚ å¯¹äºæ¶‰åŠå¤æ‚ç®—æ³•çš„é€»è¾‘ï¼Œå•ç‹¬æ’°å†™ç™½ç›’æµ‹è¯•ã€‚ ç»“åˆè¦†ç›–ç‡å·¥å…·å»çœ‹å“ªäº›ä»£ç æ²¡è¢«è¦†ç›–ï¼Œç„¶åå†ç«™åœ¨ä½¿ç”¨è€…çš„è§’åº¦å»æ€è€ƒä¸ºä»€ä¹ˆæ²¡è¢«è¦†ç›–ï¼Œæ˜¯è¿™ä¸ªåˆ†æ”¯å‹æ ¹æ²¡å¿…è¦å­˜åœ¨ï¼Œè¿˜æ˜¯è¿˜æœ‰æœªè€ƒè™‘åˆ°çš„ä½¿ç”¨åœºæ™¯ã€‚ å¦‚ä½•ç»„ç»‡å•å…ƒæµ‹è¯•ï¼Ÿ ä¸¤ç§ç»“æ„ï¼š AAA: Arrange-Act-Assert GWT: Given-When-Then å…¶å®éƒ½æ˜¯ä¸€ä¸ªæ€è·¯ï¼šå‡†å¤‡å‰ç½®æ¡ä»¶â†’æ‰§è¡Œå¾…éªŒè¯ä»£ç â†’éªŒè¯é€»è¾‘æ­£ç¡®æ€§ã€‚ å‡ ä¸ªå»ºè®®ï¼š å°½é‡é¿å…ä¸€ä¸ªå•å…ƒæµ‹è¯•ä¸­åŒ…å«å¤šä¸ª AAA/GWTã€‚ é¿å…åœ¨å•å…ƒæµ‹è¯•ä¸­ä½¿ç”¨ if ç­‰åˆ†æ”¯è¯­å¥ã€‚ å‘½åçš„æ—¶å€™ï¼Œå°½å¯èƒ½è®©éç¨‹åºå‘˜ä¹Ÿèƒ½çœ‹æ‡‚ï¼Œå³è¿™ä¸ªå‘½åéœ€è¦æè¿°ä¸€ä¸ªé¢†åŸŸé—®é¢˜ã€‚ å¦‚ä½•å‘æŒ¥å•æµ‹çš„æœ€å¤§ä»·å€¼ï¼Ÿ å•å…ƒæµ‹è¯•ç”¨ä¾‹å¿…é¡»æŒç»­ä¸æ–­åå¤æ‰§è¡ŒéªŒè¯ã€‚ ç”¨æœ€å°çš„ç»´æŠ¤ä»£ä»·æä¾›æœ€å¤§ä»·å€¼çš„å•å…ƒæµ‹è¯•ã€‚ è¯†åˆ«ä¸€ä¸ªæœ‰ä»·å€¼çš„æµ‹è¯• æ’°å†™ä¸€ä¸ªæœ‰ä»·å€¼çš„æµ‹è¯• éªŒè¯ä»£ç ä¸­æœ€é‡è¦çš„éƒ¨åˆ†ï¼ˆé¢†åŸŸæ¨¡å‹ï¼‰ã€‚ 1. å•å…ƒæµ‹è¯•ç”¨ä¾‹å¿…é¡»æŒç»­ä¸æ–­åå¤æ‰§è¡ŒéªŒè¯ è¿™é‡Œæ¨èç¬”è€…çš„ä¸ªäººå®è·µï¼š åœ¨ pre-commit æ‰§è¡Œå¢é‡å•å…ƒæµ‹è¯•ï¼Œç¡®ä¿æœ¬æ¬¡ä¿®æ”¹çš„ä»£ç æ¶‰åŠçš„å•æµ‹å¯æ­£ç¡®é€šè¿‡ã€‚ åœ¨ gitlab-ci/github-action æµç¨‹ä¸­æ‰§è¡Œå…¨é‡å•å…ƒæµ‹è¯•ï¼Œå…¨é¢è¦†ç›–ï¼Œé¿å…æœ¬æ¬¡ä¿®æ”¹çš„ä»£ç å½±å“åˆ°å…¶ä»–æ¨¡å—çš„æ­£å¸¸åŠŸèƒ½ã€‚åŒæ—¶å¦‚æœæ˜¯åˆå¹¶åˆ°ä¸»åˆ†æ”¯çš„è¯·æ±‚ï¼ŒåŠ å…¥å¢é‡è¦†ç›–ç‡é˜ˆå€¼æ£€æµ‹ï¼Œä¸æ»¡è¶³é˜ˆå€¼çš„ï¼Œå‘é€é£ä¹¦æ¶ˆæ¯å¡ç‰‡è¿›è¡Œå‘Šè­¦é€šçŸ¥ã€‚ pre-commit å¢é‡å•æµ‹ .pre-commit-config.yaml é…ç½®å¦‚ä¸‹ï¼š repos: - repo: local hooks: - id: go-unit-tests name: go-unit-tests description: run go tests with race detector entry: bash -c ./script/run_diff_go_test.sh language: golang files: \\.*$ pass_filenames: false run_diff_go_test.sh è„šæœ¬å¦‚ä¸‹ï¼š #!/bin/bashexport GOTOOLCHAIN=auto# è·å–å½“å‰æ”¹åŠ¨çš„ Go æ–‡ä»¶changed_files=$(git diff --name-only --cached --diff-filter=d | grep \\.go$)# å¦‚æœæ²¡æœ‰æ”¹åŠ¨çš„ Go æ–‡ä»¶ï¼Œé€€å‡ºif [ -z $changed_files ]; then echo No Go files changed. exit 0fi# æå–æ”¹åŠ¨æ–‡ä»¶æ‰€åœ¨çš„åŒ…è·¯å¾„ï¼ˆä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼‰ï¼Œå¹¶æ’é™¤ vendor ç›®å½•test_dirs=$(echo $changed_files | xargs -n1 dirname | grep -v ^vendor | sort -u)# å¯¹æ¯ä¸ªæ”¹åŠ¨çš„åŒ…è·¯å¾„è¿è¡Œ go testfor dir in $test_dirs; do # æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨ if [ ! -d $dir ]; then echo Directory $dir does not exist. Skipping... continue fi # æ£€æŸ¥æ˜¯å¦å­˜åœ¨ go.mod æ–‡ä»¶ï¼Œç¡®ä¿åœ¨ Go æ¨¡å—è·¯å¾„ä¸­ if [ -f $dir/go.mod ] || [ -f ./go.mod ]; then echo Running tests in $dir... (cd $dir go test -mod=vendor -gcflags=all=-l -short ./...) if [ $? -ne 0 ]; then echo Tests failed in $dir exit 1 fi else echo Skipping $dir (no go.mod found) fidoneecho All tests passed. gitlab-ci å…¨é‡å•æµ‹ gitlab-ci.yml é…ç½®å¦‚ä¸‹ï¼š go-unit-test: stage: go-unit-test script: - sh script/unittest.sh $CI_MERGE_REQUEST_TITLE $GITLAB_USER_EMAIL $CI_PIPELINE_ID $CI_MERGE_REQUEST_TARGET_BRANCH_NAME $CI_JOB_ID rules: - if: $CI_PIPELINE_SOURCE == merge_request_event $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == dev - if: $CI_PIPELINE_SOURCE == merge_request_event $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == release coverage: /coverage: \\d+.\\d+% of statements/ unittest.sh å•æµ‹æ‰§è¡Œè„šæœ¬å¦‚ä¸‹ï¼š #!/bin/bashexport GOPROXY=https://goproxy.cn,directfunction generate_coverage_report gocover-cobertura coverage.out coverage.xml# ä½¿ç”¨ gotestsum æ‰§è¡Œå•å…ƒæµ‹è¯•# å¦‚æœå•æµ‹æ‰§è¡Œå¤±è´¥ï¼Œä¼šå‘é€é£ä¹¦æ¶ˆæ¯å¡ç‰‡åˆ°å‘Šè­¦ç¾¤ä¸­if ! gotestsum --junitfile report.xml --post-run-command=./script/send_fs_card.sh \\$1\\ \\$2\\ \\$3\\ \\$5\\ -- ./... -timeout 3s -short -mod=vendor -gcflags=all=-l -coverpkg=./... -coverprofile=coverage.out ; then generate_coverage_report sh script/cal_diff_coverage.sh $4 exit 1fi# ç”Ÿæˆå•å…ƒæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Šgenerate_coverage_report# å¦‚æœå¢é‡è¦†ç›–ç‡ä¸æ»¡è¶³é˜ˆå€¼ï¼Œä¼šå‘é€é£ä¹¦æ¶ˆæ¯å¡ç‰‡åˆ°å‘Šè­¦ç¾¤ä¸­source script/cal_diff_coverage.sh $4if [[ $4 == release ]]; then source script/check_test_coverage.sh $1 $2 $3fi å…¶ä¸­ cal_diff_coverage.sh ç”¨äºè®¡ç®—å¢é‡è¦†ç›–ç‡ï¼š #!/bin/bashexport COVERAGE_PERCENT=0.0# ç¡®ä¿ coverage.xml æ–‡ä»¶å­˜åœ¨if [ ! -f coverage.xml ]; then echo coverage: 0.0% of statements exit 0fi# ä½¿ç”¨ diff-cover ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Šdiff-cover coverage.xml --exclude **/docs.go --html-report report.html --compare-branch $1 diff_detail.txt# æ£€æŸ¥æ˜¯å¦æˆåŠŸç”ŸæˆæŠ¥å‘Šif [ ! -f report.html ]; then echo coverage: 0.0% of statements exit 0fi# ä½¿ç”¨ grep å’Œ awk æå–è¦†ç›–ç‡ä¿¡æ¯COVERAGE=$(grep Coverage: diff_detail.txt | awk print $2)# å¦‚æœæ‰¾åˆ°äº†è¦†ç›–ç‡æ•°æ®ï¼Œæ£€æŸ¥æ˜¯å¦åŒ…å«å°æ•°ç‚¹if [ -n $COVERAGE ]; then if [[ $COVERAGE != *.* ]]; then # å¦‚æœæ²¡æœ‰å°æ•°ç‚¹ï¼Œåœ¨ç™¾åˆ†å·å‰é¢åŠ ä¸Š .0 # è¿™é‡Œè¿™ä¹ˆåšçš„ç›®çš„æ˜¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆ gitlab ci æ— æ³•æ­£ç¡®è§£æä¸‹é¢è¿™ä¸ªæ­£åˆ™ # /coverage: \\d+(.\\d+)?% of statements/ # åªèƒ½è§£æè¿™ä¸ª # /coverage: \\d+.\\d+% of statements/ COVERAGE=$COVERAGE/\\%/.0% fi echo coverage: $COVERAGE of statementselse COVERAGE=0.0% echo coverage: 0.0% of statementsfi# å°† COVERAGE çš„ç™¾åˆ†å·å»æ‰ï¼Œåªä¿ç•™æ•°å­—export COVERAGE_PERCENT=$(echo $COVERAGE | sed s/%//) 2. ç”¨æœ€å°çš„ç»´æŠ¤ä»£ä»·æä¾›æœ€å¤§ä»·å€¼çš„å•å…ƒæµ‹è¯• å¦‚ä½•è¯„ä»·ä¸€ä¸ªå•å…ƒæµ‹è¯•ä»·å€¼æ˜¯å¦è¶³å¤Ÿå¤§å‘¢ï¼Ÿæˆ–è€…ï¼Œæ›´ç®€å•çš„è¯´æ³•æ˜¯ï¼Œå¦‚ä½•è¯„ä»·ä¸€ä¸ªå•å…ƒæµ‹è¯•å†™å¾—å¥½ä¸å¥½ï¼Ÿ å¯ä»¥ä» 4 ä¸ªè§’åº¦è¿›è¡Œè¯„ä¼°ï¼š protection against regressions resistance to refactoring fast feedback maintainability æ›´å…·ä½“åœ°è¯´ï¼š 2.1 é˜²æ­¢å›å½’ ä»£ç ä¿®æ”¹åï¼ŒåŸæœ‰åŠŸèƒ½ä¸å—å½±å“ã€‚ è¯„ä»·æŒ‡æ ‡ï¼š è¢«æµ‹è¯•ä»£ç æ‰§è¡Œåˆ°çš„ä¸šåŠ¡ä»£ç æ•°é‡ï¼ˆæµ‹è¯•è¦†ç›–ç‡ï¼‰ã€‚ ä¸šåŠ¡ä»£ç çš„å¤æ‚åº¦ã€‚ ä¸šåŠ¡ä»£ç çš„é¢†åŸŸé‡è¦æ€§ã€‚ 2.2 æŠµæŠ—é‡æ„ éåŠŸèƒ½æ€§é‡æ„ï¼Œæµ‹è¯•ä»èƒ½é€šè¿‡ï¼Œç¡®ä¿åŠŸèƒ½ä¸€è‡´æ€§ã€‚ è¯„ä»·æŒ‡æ ‡ï¼š è¶Šå°‘çš„â€œå‡é˜³æ€§â€è¶Šå¥½ã€‚ åœ¨é‡æ„ä»£ç æ—¶ï¼Œå¼•å…¥äº†ç ´åæ€§å˜æ›´ï¼Œæµ‹è¯•ä»£ç èƒ½å¦å¿«é€Ÿåé¦ˆï¼Œå³è¶Šå°‘çš„â€œå‡é˜´æ€§â€è¶Šå¥½ã€‚ æµ‹è¯•ä»£ç æ˜¯å¦ä¸ºä½ é‡æ„ä»£ç æä¾›äº†è¶³å¤Ÿçš„ä¿¡å¿ƒã€‚ æµ‹è¯•ä»£ç æµ‹è¯•çš„æ˜¯ä¸šåŠ¡ä»£ç çš„ observable behaviorï¼Œè€Œä¸æ˜¯å…¶èƒŒåçš„æ¯ä¸€ä¸ªæ­¥éª¤ã€‚ 2.3 å¿«é€Ÿåé¦ˆ æµ‹è¯•ä»£ç æ‰§è¡Œæ—¶é—´è¶Šå¿«ï¼Œåˆ™åé¦ˆé—´éš”è¶ŠçŸ­ï¼Œç¼ºé™·ä¿®å¤æ•ˆç‡å’Œè´¨é‡å°±è¶Šé«˜ã€‚ è¯„ä»·æŒ‡æ ‡ï¼š ä»£ç æ‰§è¡Œé€Ÿåº¦ 2.4 å¯ç»´æŠ¤æ€§ æµ‹è¯•ä»£ç çš„ä¿®æ”¹æˆæœ¬ï¼Œå¯ç»´æŠ¤çš„æµ‹è¯•ä»£ç æ›´æœ‰åˆ©äºé€‚åº”éœ€æ±‚å˜æ›´ã€‚ è¯„ä»·æŒ‡æ ‡ï¼š æµ‹è¯•ä»£ç æœ‰å¤šéš¾ç†è§£ï¼Ÿ æµ‹è¯•ä»£ç çš„ä»£ç è¡Œæ•°æœ‰å¤šå°‘ï¼Ÿ æµ‹è¯•ä»£ç çš„æ‰§è¡Œéš¾åº¦æœ‰å¤šé«˜ï¼Ÿå³æœ‰å¤šå°‘çš„å¤–éƒ¨ä¾èµ–ï¼Ÿ 2.5 å¦‚ä½•æƒè¡¡ å•å…ƒæµ‹è¯•çš„ä»·å€¼å¯ä»¥é€šè¿‡ä¸Šè¿° 4 ä¸ªæŒ‡æ ‡çš„ä¹˜ç§¯æ¥è¿›è¡Œä¼°ç®—ï¼Œä½†ç°å®æ˜¯ï¼Œè¿™ 4 è€…ï¼Œå¾€å¾€æ— æ³•å…¼å¾—ã€‚é‚£æˆ‘ä»¬å¦‚ä½•åšæƒè¡¡å‘¢ï¼Ÿ é¦–å…ˆå›é¡¾ã€Œä¸ºä»€ä¹ˆè¦å†™å•å…ƒæµ‹è¯•ã€ï¼Œæ ¸å¿ƒç›®çš„æ˜¯ä¸ºäº†ç¨‹åºé€»è¾‘æ­£ç¡®æ€§ã€ä½¿è½¯ä»¶é¡¹ç›®æ›´å¯æŒç»­å‘å±•ã€‚æ‰€ä»¥ï¼š å¯ç»´æŠ¤æ€§ï¼ˆmaintainabilityï¼‰æ˜¯ä¸å¯å•†é‡çš„ï¼Œå¿…é¡»è¦æ’°å†™å¯ç»´æŠ¤çš„æµ‹è¯•ä»£ç ã€‚ æŠµæŠ—é‡æ„ï¼ˆresistance to refactoringï¼‰æ˜¯ä¸å¯å•†é‡çš„ï¼Œæˆ‘ä»¬çš„æµ‹è¯•ä»£ç åº”å°½å¯èƒ½å¯¹é”™è¯¯çš„é€»è¾‘è¿›è¡Œå‘Šè­¦ï¼Œä¹Ÿåº”é¿å…å¯¹æ­£ç¡®çš„é€»è¾‘è¿›è¡Œè¯¯å‘Šè­¦ã€‚ æ‰€ä»¥æˆ‘ä»¬èƒ½æƒè¡¡çš„å…¶å®å°±æ˜¯ protection againts regressions å’Œ fast feedbackï¼ŒäºŒè€…çš„çŸ›ç›¾å¾ˆæ¸…æ™°ï¼š å¦‚æœæ‰§è¡Œçš„ä»£ç è¶Šå¤šï¼Œç›¸åº”çš„æ•ˆç‡å°±è¶Šä½ã€‚ å¦‚æœæ‰§è¡Œçš„ä»£ç å¤ªå°‘ï¼Œé‚£éªŒè¯çš„é€»è¾‘èŒƒå›´å°±è¶Šå°ã€‚ ä¸ºäº†æƒè¡¡è¿™äºŒè€…ï¼Œä¸šç•Œæå‡ºäº†â€œæµ‹è¯•é‡‘å­—å¡”â€çš„æ¦‚å¿µã€‚ å•å…ƒæµ‹è¯•çš„å•ä½æ›´å°ï¼Œæ¶‰åŠçš„å¤–éƒ¨ä¾èµ–ä¹Ÿæ›´å°‘ï¼Œæ›´åŠ  fast feedbackï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªå±‚æ¬¡æˆ‘ä»¬è¦æ’°å†™æ›´å¤šçš„æµ‹è¯•ï¼Œå»å°½å¯èƒ½è¦†ç›–æ›´å¤šçš„å•å…ƒé€»è¾‘ã€‚ é›†æˆæµ‹è¯•ã€ç«¯åˆ°ç«¯æµ‹è¯•çš„é€»è¾‘è¦†ç›–èŒƒå›´æ›´å¤§ï¼Œæ›´åŠ  resistance to refactoringï¼Œä½†æ˜¯å¾€å¾€ä¼šä¾èµ–æ›´å¤šçš„ç»„ä»¶ï¼Œæ‰§è¡Œçš„æ•ˆç‡ä¹Ÿæ›´ä½ï¼Œæ‰€ä»¥åœ¨è¿™ 2 ä¸ªå±‚æ¬¡ï¼Œæˆ‘ä»¬å¯ä»¥åªæ’°å†™è¦†ç›–æœ€é‡è¦ï¼ˆä¹è§‚ï¼‰çš„ä¸šåŠ¡è·¯å¾„çš„æµ‹è¯•ä»£ç ï¼Œåœ¨ç‰ºç‰²æœ‰é™çš„æ‰§è¡Œæ•ˆç‡çš„æƒ…å†µä¸‹ï¼Œå°è¯•æ›´å¤§çš„é˜²æ­¢å›å½’æ•ˆæœã€‚ 3. éªŒè¯ä»£ç ä¸­æœ€é‡è¦çš„éƒ¨åˆ† ä»€ä¹ˆæ˜¯ä»£ç ä¸­æœ€é‡è¦çš„éƒ¨åˆ†å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å°†ä»£ç åˆ†æˆä»¥ä¸‹ 4 ä¸ªç§ç±»ï¼š é¢†åŸŸæ¨¡å‹å’Œç®—æ³•ï¼ˆDomain Model and Algorithmsï¼‰ï¼šé¢†åŸŸæ¨¡å‹æ˜¯å¯¹ä¸šåŠ¡é¢†åŸŸæ ¸å¿ƒæ¦‚å¿µå’Œé€»è¾‘çš„æŠ½è±¡ï¼Œç®—æ³•åˆ™æ˜¯è§£å†³ç‰¹å®šé—®é¢˜çš„è®¡ç®—æ­¥éª¤ã€‚ä¸¤è€…å…±åŒæ„æˆç³»ç»Ÿçš„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ã€‚ çç¢ä»£ç ï¼ˆTrivial Codeï¼‰ï¼šå®ç°ç®€å•åŠŸèƒ½ã€æ— å¤æ‚é€»è¾‘çš„ä»£ç ç‰‡æ®µï¼Œé€šå¸¸ä¸ºå·¥å…·æ–¹æ³•æˆ–æ•°æ®è½¬æ¢å±‚ã€‚ æ§åˆ¶å™¨ï¼ˆControllersï¼‰ï¼šåè°ƒä¸šåŠ¡é€»è¾‘ä¸å¤–éƒ¨äº¤äº’çš„ä¸­é—´å±‚ï¼Œå¸¸è§äº MVC æˆ–åˆ†å±‚æ¶æ„ä¸­ã€‚ è¿‡åº¦å¤æ‚ä»£ç ï¼ˆOvercomplicated Codeï¼‰ï¼šæ—¢åŒ…å«æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ŒåˆåŒ…å«æ§åˆ¶å™¨é€»è¾‘ã€‚ ä½œè€…å»ºè®®ï¼š æ°¸è¿œä¸º Domain Model and Algorithms æ’°å†™å…¨é¢ç»†è‡´çš„å•å…ƒæµ‹è¯•ã€‚ æ°¸è¿œä¸ä¸º Trivial Code æ’°å†™å•å…ƒæµ‹è¯•ã€‚ ä¸º Controllers æ’°å†™é›†æˆæµ‹è¯•ï¼Œè€Œä¸æ˜¯å•å…ƒæµ‹è¯•ã€‚ é¿å…å†™ Overcomplicated Codeï¼Œå°†å…¶æ‹†åˆ†æˆ Domain Model and Algorithms å’Œ Controllers ã€‚ å¦‚ä½•è®©ä»£ç æ›´å®¹æ˜“æµ‹è¯•ï¼Ÿ æ ¹æ®ä¸åŒå¤„ç†æ¶æ„çš„ä¸šåŠ¡ä»£ç ï¼Œå¯ä»¥å°†æµ‹è¯•ä»£ç åˆ†æˆä»¥ä¸‹ 3 ä¸ªç§ç±»ï¼š output-basedï¼šä¸šåŠ¡ä»£ç åªäº§ç”Ÿè¾“å‡ºç»“æœï¼Œæ‰€ä»¥åªéœ€è¦éªŒè¯è¾“å‡ºã€‚ state-basedï¼šä¸šåŠ¡ä»£ç ä¼šä¿®æ”¹å†…éƒ¨çŠ¶æ€æˆ–ä¾èµ–çŠ¶æ€ï¼Œæ‰€ä»¥éœ€è¦éªŒè¯çŠ¶æ€å˜åŒ–ã€‚ communication-basedï¼šä¸šåŠ¡ä»£ç ä¼šè·Ÿåä½œæ–¹è¿›è¡Œäº¤äº’ï¼Œæ‰€ä»¥éœ€è¦éªŒè¯äº¤äº’æƒ…å†µã€‚å¯¹äºè¿™ç§åœºæ™¯ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ mock å·¥å…·æ¥è¿›è¡ŒéªŒè¯ã€‚å…³äº mock è¿™ä¸ªè¯é¢˜ï¼Œæ–‡ç« åç»­ä¼šè¿›è¡Œè¯¦ç»†è®¨è®ºã€‚ æˆ‘ä»¬æŒ‰ç…§ä¸Šè¿° 4 ä¸ªåˆ†æç»´åº¦ï¼Œå¯¹è¿™ 3 ç§æµ‹è¯•ä»£ç è¿›è¡Œæ¯”è¾ƒï¼š protection againts regressions resistance to refactoring fast feedback maintainability output-based â­ï¸â­ï¸â­ï¸ â­ï¸â­ï¸â­ï¸ â­ï¸â­ï¸â­ï¸ â­ï¸â­ï¸â­ï¸ æœ€å¥½ï¼Œä¸éœ€è¦å¤–éƒ¨ä¾èµ–ã€‚ state-based â­ï¸â­ï¸â­ï¸ â­ï¸â­ï¸ â­ï¸â­ï¸â­ï¸ â­ï¸â­ï¸ æ¯”è¾ƒå·®ï¼Œéœ€è¦å¤–éƒ¨ä¾èµ–ã€‚ communication-based â­ï¸â­ï¸ è¿‡åº¦ä½¿ç”¨ä¼šå¯¼è‡´éœ€è¦åˆ°å¤„ mockï¼Œè€ŒçœŸæ­£æ‰§è¡Œçš„ä¸šåŠ¡ä»£ç æ•°é‡å¾ˆå°‘ã€‚ â­ï¸ æœ€å·®ï¼Œå› ä¸ºéªŒè¯äº¤äº’æƒ…å†µï¼Œå¾€å¾€ä¼šé™·å…¥å®ç°ç»†èŠ‚ï¼Œå¾ˆå®¹æ˜“åœ¨é‡æ„è¿‡ç¨‹ä¸­å‡ºç°è¯¯è­¦å‘Šã€‚ â­ï¸â­ï¸ å¤§å·®ä¸å·®ï¼Œä½†æ˜¯ mock å·¥å…·æ•ˆç‡å¯èƒ½ä¼šç›¸å¯¹ä½ä¸€ç‚¹ç‚¹ã€‚ â­ï¸ æœ€å·®ï¼Œéœ€è¦å¼•å…¥å¤§é‡çš„ mock å·¥å…·å’Œ mock ä»£ç ã€‚ æ‰€ä»¥æˆ‘ä»¬åº”è¯¥å°½å¯èƒ½å†™ output-based æµ‹è¯•ï¼Œå‡å°‘ communication-based æµ‹è¯•ã€‚ å¯ä»¥é‡‡å– functional architectureï¼Œå°†ä»£ç åˆ†æˆ 2 ä¸ªé˜¶æ®µï¼š æ ¹æ®ä¸šåŠ¡è§„åˆ™åšå‡ºå†³å®š æ ¹æ®å†³å®šåšå‡ºè¡Œä¸º ä¸ºæ­¤ï¼Œåœ¨å¯èƒ½çš„åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•é€šè¿‡ 2 ä¸ªæ­¥éª¤æ¥ä¼˜åŒ–æˆ‘ä»¬çš„æµ‹è¯•ä»£ç ï¼š ä½¿ç”¨ mock æ¥æ›¿ä»£å¤–éƒ¨ä¾èµ– out-of-process dependencyã€‚ ä½¿ç”¨ functional architecture æ¥æ›¿ä»£ mockã€‚ èŠä¸€ä¸‹ Mock åœ¨æ’°å†™å•å…ƒæµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœä¸šåŠ¡é€»è¾‘ä¾èµ–çš„ç»„ä»¶ä¸å¥½å®ä¾‹åŒ–çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¸¸å¸¸ä¼šå€ŸåŠ©å„ç§ Mock å·¥å…·æ¥å®ç°â€œæ¨¡æ‹Ÿâ€åŠŸèƒ½ï¼Œä½¿å•æµ‹æ›´æ˜“æ’°å†™ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªæ›´å‡†ç¡®çš„è¯å« test doublesï¼ˆæµ‹è¯•æ›¿èº«ï¼‰ã€‚ test double çš„ç§ç±» ä»å¤§çš„æ–¹é¢å¯ä»¥åˆ†ä¸º 2 ç§ï¼š ç”¨äºæ¨¡æ‹Ÿå’ŒéªŒè¯å¯¹è±¡é—´çš„è¾“å‡ºäº¤äº’ï¼ˆå¦‚æ–¹æ³•è°ƒç”¨æ¬¡æ•°ã€å‚æ•°åŒ¹é…ï¼‰ï¼Œåˆ™ä¸º mockã€‚ ç”¨äºæ¨¡æ‹Ÿè¾“å…¥äº¤äº’ï¼Œæä¾›é¢„å®šä¹‰çš„æ•°æ®ï¼Œåˆ™ä¸º stubã€‚ æ›´è¿›ä¸€æ­¥å¯ä»¥åˆ†ä¸ºï¼š mock mock: ç”± mock å·¥å…·ç”Ÿæˆã€‚ spy: æ‰‹å·¥æ’°å†™ã€‚ stub stub: å¯ä»¥é€šè¿‡é…ç½®åœ¨ä¸åŒçš„åœºæ™¯ä¸‹è¿”å›ä¸åŒçš„æ•°æ®ã€‚ dummy: å ä½ç¬¦ï¼Œä»…ç”¨äºå¡«å……å‚æ•°ï¼Œä¸å‚ä¸å®é™…é€»è¾‘ã€‚ fake: è·Ÿ stub å‡ ä¹ä¸€æ ·ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯ fake ç»å¸¸ç”¨äºæ›¿ä»£å°šæœªå¼€å‘æˆ–å¤æ‚çš„ä¾èµ–ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼šæ°¸è¿œä¸è¦å»éªŒè¯ï¼ˆassertï¼‰è·Ÿ stub çš„äº¤äº’ï¼Œæ²¡å¿…è¦ï¼ å“ªäº›ä¸œè¥¿éœ€è¦ Mockï¼Ÿ åœ¨å›ç­”è¿™ä¸ªé—®é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆåšä¸‹é“ºå«ï¼ŒèŠä¸€ä¸‹æ¥å£çš„è¯¯è§£ã€ä¾èµ–çš„ç§ç±»å’Œä¸¤ç§äº¤äº’çš„æ¦‚å¿µã€‚ æ¥å£çš„è¯¯è§£ åœ¨è°ˆå¦‚ä½•æ›´å¥½åœ°åˆ©ç”¨ mock ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥èŠä¸€ä¸‹æ¥å£ï¼ˆinterfaceï¼‰çš„è¯¯è§£ã€‚ åœ¨ä¸šåŠ¡å¼€å‘å½“ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸èƒ½çœ‹åˆ°ä¸€äº›ä¼å›¾è¿›è¡Œâ€œä¼˜é›…â€æ¶æ„è®¾è®¡çš„ä»£ç ï¼Œä¸Šæ¥æ¯ä¸€å±‚éƒ½å®šä¹‰æ¥å£ï¼Œæ¯ä¸€å±‚éƒ½ä½¿ç”¨æ¥å£è¿›è¡Œäº¤äº’ï¼Œåæ­£é‡åˆ°é—®é¢˜å…ˆå®šä¹‰æ¥å£å†è¯´ã€‚ ç›®çš„æœ‰äºŒï¼š æŠ½è±¡å¤–éƒ¨ä¾èµ–ï¼Œè¿›è¡Œè§£è€¦ã€‚ å¯ä»¥åœ¨ä¸ä¿®æ”¹æ—¢æœ‰ä»£ç çš„æƒ…å†µä¸‹æ‰©å±•åŠŸèƒ½ï¼Œå³æ‰€è°“çš„å¼€é—­åŸåˆ™ï¼ˆOpen-Closed principleï¼‰ã€‚ ä½†è¿™å…¶å®å­˜åœ¨ä¸€äº›è¯¯åŒºï¼Œä½œè€…åœ¨ä¹¦ä¸­æŒ‡å‡ºï¼š åªæœ‰ä¸€ä¸ªå®ç°çš„æ¥å£ï¼Œå¹¶ä¸æ˜¯æŠ½è±¡ï¼Œä¹Ÿå¹¶æ²¡æœ‰æ¯”å…·ä½“çš„å¯¹è±¡èµ·åˆ°å¤ªå¤šæ‰€è°“çš„è§£è€¦ä½œç”¨ã€‚ ä¸Šè¿°ç¬¬ 2 ç‚¹è¿åäº†ä¸€ä¸ªæ›´é‡è¦çš„åŸåˆ™ YAGNIï¼ˆYou are not gonna need itï¼‰ï¼Œä¹Ÿå°±æ˜¯ä½ æ‰€è°“çš„åŠŸèƒ½æ‰©å±•å¤§æ¦‚ç‡æ˜¯ä¸éœ€è¦çš„ã€‚ ä¸Šè¿°åšæ³•çš„å”¯ä¸€å¥½å¤„æ˜¯ä»€ä¹ˆï¼šä½¿æµ‹è¯•æˆä¸ºå¯èƒ½ï¼å› ä¸ºä½ ä¸éš”ç¦»æ‰å¤–éƒ¨ä¾èµ–çš„è¯ï¼Œä½ çš„å•å…ƒæµ‹è¯•æ’°å†™ä¼šéå¸¸å›°éš¾ï¼Œä¹Ÿæ— æ³•åšåˆ° fast feedbackã€‚ ğŸ™‹ğŸ»â€â™€ï¸æŠ½è±¡æ˜¯å‘ç°å‡ºæ¥çš„ï¼Œè€Œä¸æ˜¯å‘æ˜å‡ºæ¥çš„ï¼ ä¾èµ–çš„ç§ç±» shared dependency: ä¸€ä¸ªåœ¨æµ‹è¯•ä»£ç ä¸­çš„å…±äº«å¯¹è±¡ã€‚ out-of-process dependency: ç‹¬ç«‹äºå½“å‰åº”ç”¨ç¨‹åºçš„å¦å¤–ä¸€ä¸ªè¿›ç¨‹å¯¹è±¡ï¼Œå¦‚æ•°æ®åº“ã€STMP æœåŠ¡å™¨ç­‰ã€‚ managed dependency: ä»…å½“å‰åº”ç”¨ç¨‹åºå¯è®¿é—®çš„ä¾èµ–ï¼ˆå¯¹å…¶ä»–ç¨‹åºã€æœåŠ¡æ˜¯ä¸å¯è§çš„ï¼‰ã€‚ unmanaged dependency: é™¤äº†å½“å‰åº”ç”¨ï¼Œå…¶ä»–åº”ç”¨ä¹Ÿå¯è§ã€‚ private dependency: ä¸€ä¸ªç§æœ‰å¯¹è±¡ã€‚ ä¸¤ç§äº¤äº’ intra-system communication: åº”ç”¨ç¨‹åºå†…éƒ¨çš„äº¤äº’ã€‚ inter-system communication: åº”ç”¨ç¨‹åºä¹‹é—´çš„äº¤äº’ã€‚ å“ªäº›ä¸œè¥¿éœ€è¦ Mockï¼Ÿ é“ºå«å®Œæ¥å£çš„è¯¯è§£ã€ä¾èµ–çš„ç§ç±»å’Œä¸¤ç§äº¤äº’çš„æ¦‚å¿µä¹‹åï¼Œæˆ‘ä»¬æ¥èŠä¸€ä¸‹å“ªäº›ä¸œè¥¿éœ€è¦ Mockï¼Ÿ åœ¨æŠ‰æ‹©çš„æ—¶å€™ï¼Œéœ€è¦ç‰¢è®°æˆ‘ä»¬æµ‹è¯•ç²’åº¦å’Œè¯„ä»·æŒ‡æ ‡ã€‚ æµ‹è¯•ç²’åº¦ï¼šan observable behavior â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸ è¯„ä»·æŒ‡æ ‡ï¼š é˜²æ­¢å›å½’ï¼šprotection against regressions æŠµæŠ—é‡æ„ï¼šresistance to refactoring å¿«é€Ÿåé¦ˆï¼šfast feedback å¯ç»´æŠ¤æ€§ï¼šmaintainability é›†åˆæµ‹è¯•ç²’åº¦å’Œè¯„ä»·æŒ‡æ ‡ï¼ŒMock å“ªäº›ä¸œè¥¿å¯ä»¥ç”¨ä¸€å¥è¯æ¥æ¦‚æ‹¬ï¼š âœ…Mock é‚£äº›å¤–éƒ¨å¯è§‚æµ‹åˆ°çš„äº¤äº’ï¼Œè€Œå°½é‡é¿å… Mock å†…éƒ¨çš„å®ç°ç»†èŠ‚ã€‚ æ›´å…·ä½“æ¥è¯´ï¼š ä»…å¯¹ unmanaged dependency åº”ç”¨ mock å¯¹è±¡ã€‚å› ä¸ºæˆ‘ä»¬æ— æ³•é¢„çŸ¥å…¶ä»–åº”ç”¨ä¼šå¯¹è¿™äº›ä¾èµ–è¿›è¡Œä»€ä¹ˆæ“ä½œï¼Œæ‰€ä»¥åªèƒ½éš”ç¦»å¼€ã€‚ å¯¹ç³»ç»Ÿæœ€å¤–å›´çš„è¾¹ç•Œè¿›è¡Œ mockã€‚åªæœ‰ç³»ç»Ÿè¾¹ç•Œï¼Œæ‰æ˜¯å¯è§‚æµ‹è¡Œä¸ºï¼Œå†…éƒ¨éƒ½æ˜¯å®ç°ç»†èŠ‚ï¼Œå¯¹å®ç°ç»†èŠ‚è¿‡å¤š Mockï¼Œæ„å‘³ç€ç ´åäº† resistance to refactoringã€‚ å°½é‡åªåœ¨é›†æˆæµ‹è¯•ä¸­ä½¿ç”¨ mockï¼Œé¿å…åœ¨å•å…ƒæµ‹è¯•ä¸­ä½¿ç”¨ mockã€‚ åª mock å±äºä½ çš„å¯¹è±¡ï¼Œä¸å» mock ä¾èµ–åº“ä¸­çš„å¯¹è±¡ã€‚ å§‹ç»ˆåœ¨ç¬¬ä¸‰æ–¹åº“ä¹‹ä¸Šç¼–å†™è‡ªå·±çš„é€‚é…å™¨ï¼Œå¹¶å¯¹è¿™äº›é€‚é…å™¨è¿›è¡Œ mockï¼Œè€Œä¸æ˜¯ mockåº•å±‚ç±»å‹ã€‚ ä»…ä»åº“ä¸­æš´éœ²ä½ æ‰€éœ€è¦çš„åŠŸèƒ½ã€‚ ä½¿ç”¨é¡¹ç›®çš„é¢†åŸŸè¯­è¨€ï¼ˆdomain languageï¼‰æ¥å®Œæˆä¸Šè¿°æ“ä½œã€‚ ä¸¾ä¸ªä¾‹å­ï¼š åœ¨ä¸Šå›¾ä¸­ï¼Œå³ä¾§æ˜¯æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼Œå®ƒä¾èµ–äº†å·¦ä¸‹è§’çš„ Message bus è¿™ä¸ªå¤–éƒ¨ä¾èµ–ï¼Œå‡†ç¡®è¯´æ˜¯ unmanaged dependencyã€‚å¯¹æ­¤ï¼Œæˆ‘ä»¬ä¸ºå…¶åˆ›å»ºäº†é€‚é…å™¨æ¥å£ IBusï¼Œåœ¨è¿™ä¸ªé€šç”¨æ¥å£ä¹‹ä¸Šï¼Œæˆ‘ä»¬åˆæ ¹æ®å…·ä½“ä¸šåŠ¡åˆ›å»ºäº† IMessageBusã€‚ é’ˆå¯¹è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬åœ¨è¿›è¡Œ mock çš„æ—¶å€™ï¼Œåªéœ€è¦ mock IBus å¯¹è±¡ï¼Œè€Œä¸æ˜¯å» mock Message bus å’Œ IMessageBusã€‚ æ•°æ®åº“è¦ä¸è¦ Mockï¼Ÿ è¿™ä¸ªè¯é¢˜æ¯”è¾ƒæœ‰æ„æ€ï¼Œä½œè€…çš„å»ºè®®æ˜¯ï¼š å¦‚æœè¿™ä¸ªæ•°æ®åº“åªæœ‰ä½ è¿™ä¸ªåº”ç”¨å¯ä»¥è®¿é—®ï¼Œé‚£å°±ä¸è¦ mockã€‚ å¦‚æœè¿™ä¸ªæ•°æ®åº“å­˜åœ¨å¯ä»¥è¢«å…¶ä»–åº”ç”¨è®¿é—®çš„éƒ¨åˆ†ï¼Œé‚£å°±åª mock è¿™ä¸€éƒ¨åˆ†ï¼Œä¸å» mock ç‹¬å±äºä½ åº”ç”¨çš„é‚£éƒ¨åˆ†ã€‚ è¦è·µè¡Œä¸Šè¿°æ ‡å‡†ï¼Œéœ€è¦åšåˆ°ä»¥ä¸‹å‰æï¼š å°†æ•°æ®åº“çš„ä¿¡æ¯ä¹Ÿæ”¾åœ¨æºç æ§åˆ¶ç³»ç»Ÿä¸­ï¼ˆgitï¼‰ï¼ŒåŒ…æ‹¬ï¼š schema reference dataï¼ˆé¡¹ç›®å¯åŠ¨å¿…é¡»è¦çš„åˆå§‹æ•°æ®ï¼‰ migrationï¼ˆæ•°æ®å˜æ›´è®°å½•ï¼‰ æ¯ä¸ªå¼€å‘è€…æœ‰ä¸€ä¸ªå•ç‹¬çš„æ•°æ®åº“ï¼ˆæµ‹è¯•ç¯å¢ƒä¸‹ï¼‰ ä½†æ•°æ®åº“å˜æ›´çš„æ—¶å€™ï¼Œä¸è¦ç›´æ¥ä¿®æ”¹ï¼Œè€Œæ˜¯è¦å†™ä¸€æ¡å¯¹åº” sql å»è¿›è¡Œä¿®æ”¹ï¼ŒåŒæ—¶å°†è¿™æ¡ sql ä¹Ÿçº³å…¥æºç æ§åˆ¶ç³»ç»Ÿä¸­ã€‚ ä½œè€…ä¸å»ºè®® mock æ•°æ®åº“ï¼ŒåŒ…æ‹¬ä½¿ç”¨å†…å­˜æ•°æ®åº“æ›¿ä»£ï¼Œå¦‚ sqlite æ›¿ä»£ MySQLï¼Œæ ¸å¿ƒåŸå› æ˜¯ï¼šä½ æ— æ³•ä¿è¯è¿™äº›æ•°æ®åº“èƒ½è·Ÿçº¿ä¸Šç¯å¢ƒçš„è¡Œä¸ºä¸€è‡´ï¼Œå¯èƒ½ä¼šå¯¼è‡´ä¸€äº›æ— æ•ˆæµ‹è¯•ç”¨ä¾‹ï¼Œå³å‡é˜´æ€§ã€‚ ç¬”è€…å¹¶ä¸å®Œå…¨é‡‡çº³è¿™ä¸ªå»ºè®®ï¼Œè¯šç„¶ï¼Œå¦‚æœèƒ½åšåˆ°ä»¥ä¸Šå‰æï¼Œæ˜¯å¯ä»¥è€ƒè™‘è·µè¡Œçš„ã€‚ç„¶è€Œï¼Œå®ƒçš„è¦æ±‚å¾ˆé«˜ï¼Œæ”¶ç›Šå´ç›¸å¯¹è¾ƒå°ï¼Œåœ¨å•å…ƒæµ‹è¯•ç¯å¢ƒä¸‹ï¼Œä½¿ç”¨å†…å­˜æ•°æ®åº“è¿›è¡Œ mockï¼Œåœ¨ä¿è¯äº† fast feedback å’Œ maintainability çš„æƒ…å†µä¸‹ï¼Œä¹Ÿèƒ½å¤Ÿé¿å…ç»å¤§å¤šæ•°çš„é€»è¾‘æ¼æ´äº†ï¼Œå‡é˜´æ€§çš„æƒ…å†µä¼šéå¸¸å°‘ï¼Œå³ä¾¿æœ‰ï¼Œä¹Ÿå¯ä»¥äº¤ç»™é›†æˆæµ‹è¯•å’Œç«¯åˆ°ç«¯æµ‹è¯•å»è§£å†³ã€‚ åé¢æ¡ˆä¾‹ æµ‹è¯•ç§æœ‰æ–¹æ³•ã€‚ æš´éœ²ç§æœ‰çŠ¶æ€ã€‚ æ³„éœ²é¢†åŸŸçŸ¥è¯†åˆ°æµ‹è¯•ä¸­ã€‚ åœ¨ä¸šåŠ¡ä»£ç ä¸­æ’°å†™åªç”¨äºæµ‹è¯•çš„ä»£ç ã€‚ mock å…·ä½“çš„ç±»ã€‚ ç¬¬ 3 ç‚¹æ¯”è¾ƒæœ‰æ„æ€ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š public class CalculatorTests [Fact] public void Adding_two_numbers() int value1 = 1; int value2 = 3; int expected = value1 + value2; // -----The leakage // int expected = 4 // the better one int actual = Calculator.Add(value1, value2); Assert.Equal(expected, actual); ä»€ä¹ˆå«åšæ³„éœ²é¢†åŸŸçŸ¥è¯†å‘¢ï¼Ÿ æ¯”å¦‚ä½ è¦éªŒè¯ä¸€ä¸ªåŠ æ³• Add å¯¹ä¸å¯¹ï¼Œä½†æ˜¯åœ¨æµ‹è¯•ä»£ç ä¸­ï¼Œä½ çš„æœŸæœ›å€¼ä¹Ÿæ˜¯ç”¨åŠ æ³•æ¥è·å¾—çš„ï¼Œè¿™ä¸ªâ€œåŠ æ³•â€å°±æ˜¯é¢†åŸŸçŸ¥è¯†ï¼Œå› ä¸ºè¿™æ ·æµ‹çš„è¯ï¼Œå°±å¾ˆæœ‰å¯èƒ½ä¼šå‡ºç°â€œè´Ÿè´Ÿå¾—æ­£â€çš„æƒ…å†µã€‚ æ­£ç¡®çš„åšæ³•æ˜¯ç›´æ¥æ–­è¨€ä½ é¢„æœŸçš„æœ€ç»ˆç»“æœï¼Œä»¥ç¡®ä¿é€»è¾‘ç¬¦åˆé¢„æœŸã€‚ Go å®è·µæ¡ˆä¾‹ æœ¬ç« å°†åˆ†äº«ä¸€äº›ç¬”è€…åœ¨ Go é¡¹ç›®å®æˆ˜è¿‡ç¨‹ä¸­çš„ä¸€äº›å®è·µæ¡ˆä¾‹ï¼Œå¸Œæœ›å¯¹è¯»è€…æ’°å†™å•å…ƒæµ‹è¯•èƒ½æä¾›ä¸€äº›å¸®åŠ©ã€‚ ä¾èµ– Redis çš„é€»è¾‘æ€ä¹ˆæµ‹ å¯ä»¥ä½¿ç”¨ miniredisï¼Œè¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ Go è¯­è¨€å®ç°çš„å†…å­˜ç‰ˆ Redisã€‚ https://github.com/alicebob/miniredishttps://github.com/alicebob/miniredis å¯ä»¥å°è£…ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºå¿«é€Ÿå¯åŠ¨ miniredis å¹¶è¿”å›å®¢æˆ·ç«¯å¯¹è±¡ï¼š func NewMiniRedis() *redis.Client var redisClient *redis.Client var miniRedisClient *miniredis.Miniredis var err error miniRedisClient, err = miniredis.Run() if err != nil panic(err) redisClient = redis.NewClient(redis.Options Addr: miniRedisClient.Addr(), ) return redisClient è¿™é‡Œå¯èƒ½ä¼šå‡ºç°ä½œè€…æåˆ°çš„ä¸è¦ä½¿ç”¨å†…å­˜æ•°æ®åº“æ›¿ä»£çœŸå®çš„æ•°æ®åº“ï¼Œå› ä¸ºä½ æ— æ³•ä¿è¯å®ƒä»¬çš„è¡Œä¸ºä¸€è‡´ã€‚ æ¯”å¦‚è¿™é‡Œæ˜¯å•æœºçš„ï¼Œè€Œç”Ÿäº§ç¯å¢ƒå¯èƒ½æ˜¯é›†ç¾¤çš„ï¼Œåœ¨ Redis Cluster ä¸­ï¼Œæ¶‰åŠåˆ° lua è„šæœ¬å’Œäº‹åŠ¡çš„æ‰€æœ‰ keyï¼Œéƒ½å¿…é¡»ä¿è¯åœ¨åŒä¸€ä¸ª slot ä¸Šï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½¿ç”¨ miniredis æ˜¯æµ‹ä¸å‡ºé—®é¢˜çš„ã€‚ ä¾èµ– MySQL çš„é€»è¾‘æ€ä¹ˆæµ‹ æ ¸å¿ƒæŒ‘æˆ˜ï¼š ä¾èµ–çœŸå® MySQL åˆ™å®¹æ˜“å› ä¸ºç½‘ç»œåŸå› è€Œå¯¼è‡´æµ‹è¯•å¤±è´¥ï¼ˆä¸å¯é‡å¤æ€§ï¼‰ ä¾èµ–çœŸå® MySQL ä¼šä¸¥é‡å½±å“å•ä¾§æ‰§è¡Œæ•ˆç‡ æ•°æ®é¢„å¤‡ æ•°æ®æ¸…æ´— å•æµ‹ä¹‹é—´çš„æ•°æ®éš”ç¦»ï¼Œäº’ä¸å½±å“ å¹¶å‘å®‰å…¨ ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œæä¾›æ›´ä¼˜é›…çš„ MySQL å•æµ‹è§£å†³æ–¹æ¡ˆï¼Œç¬”è€…å€ŸåŠ© dolthub/go-mysql-server å’Œ gorm çš„èƒ½åŠ›ï¼Œå®ç°äº†ä¸€ä¸ª go-mysql-mockerï¼Œç®€ç§° gmmã€‚ å…¶ä¸­ï¼š dolthub/go-mysql-server æä¾›äº†å†…å­˜ MySQL å¼•æ“ã€‚ gorm æä¾›äº†å¿«é€Ÿå»ºè¡¨å’Œæ’å…¥æ•°æ®çš„èƒ½åŠ›ã€‚ https://github.com/hedon954/go-mysql-mockerhttps://github.com/hedon954/go-mysql-mocker æ ¸å¿ƒåŠŸèƒ½ï¼š å†…å­˜ç‰ˆæ•°æ®åº“ï¼Œæ— ç½‘ç»œä¾èµ–ï¼› æ¯ä¸ªå•æµ‹å¯å•ç‹¬å¯åŠ¨ä¸€ä¸ªæ•°æ®åº“ï¼Œå¤©ç„¶åšåˆ°æ•°æ®éš”ç¦»å’Œæ¸…æ´—ï¼› æ”¯æŒ structã€sliceã€sql stmtã€sql file å¤šç§æ–¹å¼è¿›è¡Œæ•°æ®åˆå§‹åŒ–ï¼Œæ”¯æŒéœ€è¦å‰ç½®æ•°æ®çš„ä¸šåŠ¡é€»è¾‘æµ‹è¯•ã€‚ éšæœºæ¦‚ç‡é€»è¾‘æ€ä¹ˆæµ‹ åœºæ™¯ï¼šéšæœºæŠ½å¥– éš¾ç‚¹ï¼šéšæœºæ¦‚ç‡çš„ç»“æœæ˜¯ä¸ç¡®å®šçš„ï¼Œç›´æ¥é€šè¿‡ assert.Equal æ˜¯æ— æ³•å†™å‡ºå¯ç¨³å®šé‡å¤è¿è¡Œçš„å•æµ‹çš„ã€‚ // AssertMapRatioEqual æ£€æŸ¥å®é™…è®¡æ•°çš„æ¯”ä¾‹æ˜¯å¦ç¬¦åˆé¢„æœŸæƒé‡çš„æ¯”ä¾‹// actual: å®é™…è·å¾—çš„è®¡æ•° map[id]count// expected: é¢„æœŸçš„æƒé‡ map[id]weight// tolerance: å…è®¸çš„è¯¯å·®èŒƒå›´ï¼ˆå¦‚ 0.05 è¡¨ç¤ºå…è®¸ 5% çš„è¯¯å·®ï¼‰func AssertMapRatioEqual(t *testing.T, actual map[int64]int64, expected map[int64]int64, tolerance float64) t.Helper() // è®¡ç®—æ€»æ•° var actualTotal, expectedTotal int64 for _, count := range actual actualTotal += count for _, weight := range expected expectedTotal += weight // æ£€æŸ¥æ¯ä¸ª ID çš„æ¯”ä¾‹ for id, expectedWeight := range expected actualCount, exists := actual[id] if !exists t.Errorf(ID %d åœ¨å®é™…ç»“æœä¸­ä¸å­˜åœ¨, id) continue expectedRatio := float64(expectedWeight) / float64(expectedTotal) actualRatio := float64(actualCount) / float64(actualTotal) if diff := math.Abs(expectedRatio - actualRatio); diff tolerance t.Errorf(ID %d çš„æ¯”ä¾‹ä¸ç¬¦åˆé¢„æœŸ: æœŸæœ› %.3f, å®é™… %.3f, å·®å¼‚ %.3f, è¶…å‡ºå…è®¸è¯¯å·® %.3f, id, expectedRatio, actualRatio, diff, tolerance) // æ£€æŸ¥æ˜¯å¦æœ‰å¤šä½™çš„ ID for id := range actual if _, exists := expected[id]; !exists t.Errorf(å®é™…ç»“æœä¸­å­˜åœ¨æœªé¢„æœŸçš„ ID: %d, id) æ¡ˆä¾‹ï¼š func TestLottery_randOnce(t *testing.T) t.Run(å¤§é‡æŠ½å–åº”ç¬¦åˆæƒé‡é…ç½®æ¯”ä¾‹, func(t *testing.T) gotCount := make(map[int64]int64) totalCount := int64(10000) for i := int64(0); i totalCount; i++ reward, err := lotteryOnce(0, 0, nil) assert.Nil(t, err) assert.NotNil(t, reward) gotCount[reward.Id] += 1 expectedRatio := map[int64]int64 1: 10, 2: 20, 3: 30, 4: 40, 5: 40, testutil.AssertMapRatioEqual(t, gotCount, expectedRatio, 0.05) ) HTTP æ¥å£æ€ä¹ˆæµ‹ æŒ‘æˆ˜ï¼š å¦‚ä½•å¿«é€Ÿæ„å»ºè¯·æ±‚ä½“å¹¶å‘é€è¯·æ±‚ï¼Ÿ å¦‚ä½•å¿«é€Ÿæ–­è¨€å¼‚å¸¸æƒ…å†µï¼Ÿ å¦‚ä½•å¿«é€Ÿæ–­è¨€æˆåŠŸæƒ…å†µï¼Œå¹¶è§£æå‡ºæœŸæœ›çš„è¿”å›å€¼ï¼Ÿ 1. æ„é€ è¯·æ±‚ // å¿«é€Ÿåˆ›å»ºè¯·æ±‚ä½“ form è¡¨å•æ ¼å¼func NewHTTPPostRequest(path string, data any) *http.Request req := httptest.NewRequest(POST, path, NewHTTPBody(data)) req.Header.Set(Content-Type, application/x-www-form-urlencoded) return reqfunc NewHTTPBody(data any) io.Reader values := url.Values v := reflect.ValueOf(data) t := v.Type() if v.Kind() == reflect.Ptr v = v.Elem() t = v.Type() if v.Kind() != reflect.Struct return strings.NewReader(values.Encode()) for i := 0; i t.NumField(); i++ field := t.Field(i) value := v.Field(i) tag := field.Tag.Get(form) if tag == continue // å¤„ç†å¤æ‚ç±»å‹ï¼ˆç»“æ„ä½“ã€åˆ‡ç‰‡ã€mapï¼‰ switch value.Kind() case reflect.Struct, reflect.Slice, reflect.Map: jsonBytes, err := json.Marshal(value.Interface()) if err == nil values.Set(tag, string(jsonBytes)) continue else log.Printf(Error marshaling %v: %v, value.Kind(), err) default: // å¤„ç†å…¶ä»–ç±»å‹ values.Set(tag, fmt.Sprintf(%v, value.Interface())) return strings.NewReader(values.Encode()) 2. å‘é€è¯·æ±‚ w := httptest.NewRecorder()sfRouterTest.ServeHTTP(w, request) 3. æ–­è¨€å¼‚å¸¸ // AssertRspErr æ–­è¨€ http å“åº”å¼‚å¸¸ï¼ŒexpectedErr ä¸ºæœŸæœ›çš„é”™è¯¯ä¿¡æ¯func AssertRspErr(w *httptest.ResponseRecorder, t *testing.T, expectedErr string) assert.Equal(t, http.StatusOK, w.Code) body := w.Result().Body defer body.Close() rsp, err := FromHTTPResp[any](body) assert.Nil(t, rsp) assert.Equal(t, expectedErr, err.Error()) 4. æ–­è¨€æ­£ç¡®ä¸”è¿”å›å“åº”å€¼ // FromHTTPResp ä» http å“åº”ä¸­è§£æå‡ºæ•°æ®func FromHTTPResp[T any](resp io.ReadCloser) (*T, error) body, err := io.ReadAll(resp) if err != nil return nil, err defer func() _ = resp.Close() () var t httpResp[T] err = json.Unmarshal(body, t) if err != nil return nil, err if t.Code != 200 return nil, errors.New(t.Message) return t.Data, nil// AssertRspOk æ–­è¨€ http å“åº”æˆåŠŸï¼Œå¹¶è¿”å›å“åº”ä½“ Tfunc AssertRspOk[T any](w *httptest.ResponseRecorder, t *testing.T) *T assert.Equal(t, http.StatusOK, w.Code) body := w.Result().Body defer body.Close() rsp, err := FromHTTPResp[T](body) assert.Nil(t, err) assert.NotNil(t, rsp) return rsp è¿™é‡Œå…¶å®å°±è¿åäº†ä¸Šä¸€å¼ åé¢æ¡ˆä¾‹ä¸­çš„ç¬¬ 3 ç‚¹â€æ³„éœ²é¢†åŸŸçŸ¥è¯†åˆ°æµ‹è¯•ä¸­â€œï¼Œå› ä¸ºè¿™é‡Œæ¥å—å“åº”çš„æ—¶å€™ï¼Œè¿˜æ˜¯ä½¿ç”¨çš„é¢†åŸŸå¯¹è±¡ç»“æ„ï¼Œæ‰€ä»¥å¯èƒ½ä¼šå‡ºç°è´Ÿè´Ÿå¾—æ­£çš„æƒ…å†µï¼Œæ¯”å¦‚ä½ çš„å¯¹è±¡å­—æ®µåå°±æ˜¯æ‹¼å†™é”™è¯¯äº†ï¼Œä½†æ˜¯å› ä¸ºä½ ä¸šåŠ¡é€»è¾‘å’Œæ–­è¨€å¤„éƒ½æ˜¯ç”¨çš„ä¸€ä¸ªç»“æ„ï¼Œæ‰€ä»¥å†…éƒ¨å½¢æˆäº†å¾ªç¯ï¼Œå°±è´Ÿè´Ÿå¾—æ­£äº†ï¼Œä½†æ˜¯çœŸæ­£åˆ°äº†å®¢æˆ·ç«¯é‚£ï¼Œå°±è§£æå¤±è´¥äº†ã€‚ ä¸è¿‡åœ¨è¿™ä¸ªæƒ…å†µä¸‹ï¼Œç¬”è€…è®¤ä¸ºè¿™ä¸ªæƒ…å†µä¸‹çš„è¿™ç§é£é™©æ˜¯å¯ä»¥æ¥å—çš„ï¼Œè¿œç›–ä¸ä½å…¶å¸¦æ¥çš„æ•ˆç‡æå‡ã€‚ 5. ç»„åˆèµ·æ¥ func SendHTTPRequest[Rsp any](t *testing.T, server HTTPServer, path string, data any, errMsg ...string) *Rsp req := NewHTTPPostRequest(path, data) w := httptest.NewRecorder() server.ServeHTTP(w, req) if len(errMsg) 0 AssertRspErr(w, t, errMsg[0]) return nil else return AssertRspOk[Rsp](w, t) 6. æ¡ˆä¾‹ func Test_GetCollectReward(t *testing.T) t.Run(é‡å¤é¢†å–, func(t *testing.T) uid := buildUserInfo(UserInfo Got: map[int][]int 1: 1, , , apiTest.svc) _ = testutil.SendHTTPRequest[GetCollectRewardResp](t, routerTest, /get_collect_reward, GetCollectRewardReq UID: uid, CollectID: 1, , é‡å¤é¢†å–) // é”™è¯¯ä¿¡æ¯ ) t.Run(é¢†å–æˆåŠŸ, func(t *testing.T) uid := uuid.NewString() rsp := testutil.SendHTTPRequest[GetCollectRewardResp](t, routerTest, /get_collect_reward, GetCollectRewardReq UID: uid, CollectID: 1, , ) assert.NotNil(t, rsp.Reward) // æ­£ç¡®ç»“æœ ) ä¾èµ–æ—¶é—´çš„é€»è¾‘æ€ä¹ˆæµ‹ å°½é‡ä¸è¦ä¾èµ–æ—¶é—´ã€‚ è€ƒè™‘å°†æ—¶é—´ä½œä¸ºå‚æ•°ï¼Œé¿å… time.Now()ã€‚ ä¹Ÿå¯ä»¥å‚è€ƒï¼š https://hedon.top/2025/03/06/go-lib-synctest/https://hedon.top/2025/03/06/go-lib-synctest/ å¹¶å‘é€»è¾‘æ€ä¹ˆæµ‹ go test æ¨èå¼€å¯ -race ç”¨äºæ£€æµ‹å¹¶å‘å†²çªã€‚ æ›´å¤šå¯å‚è€ƒï¼š https://hedon.top/2025/03/06/go-lib-synctest/https://hedon.top/2025/03/06/go-lib-synctest/","tags":["å•å…ƒæµ‹è¯•","è¯»ä¹¦ç¬”è®°"],"categories":["è¯»ä¹¦ç¬”è®°"]},{"title":"è¯»ä¹¦ç¬”è®°ä¸¨ã€ŠUnit Testing Principles, Practices, and Patternsã€‹","path":"/2025/04/09/note-unit-testing-excerpt/","content":"Learning unit testing doesnâ€™t stop at mastering the technical bits of it, such as your favorite test framework, mocking library, and so on. Thereâ€™s much more to unit testing than the act of writing tests. You always have to achieve the best return on the time you invest in unit testing, minimizing the effort you put into tests and maximizing the benefits they provide. Achieving both things isnâ€™t an easy task. They grow effortlessly, donâ€™t require much maintenance, and can quickly adapt to their customersâ€™ ever-changing needs. The ratio between the production code and the test code could be anywhere between 1:1 and 1:3. Coverage limitations You canâ€™t guarantee that the test verifies all the possible outcomes of the system under test. No coverage metric can take into account code paths in external libraries. The goal of unit testing lead to a better code design enable sustainable(å¯æŒç»­çš„) growth of the software project the cost components of writing unit tests: refactoring the test when you refactor the underlying code running the test on each code change dealing with false alarms raised by the test spending time reading the test when youâ€™re trying to understanding how the underlying code behaves a successful test suite must: integrated into the development cycle targets only the most important parts of the code base ğŸ‘‰ğŸ»Â domain logic infrastructure code external services and dependencies code that glues everything together provides maximum value with minimum maintenance costs recognize a valuable test (and, by extension, a test of low value) write a valuable test What is a unit test? verifies a single unit of behavior dose it quickly dost it in isolation from other tests An integration test, then, is a test that doesnâ€™t meet one of these criteria. End-to-end tests are a subset of integration tests. How to structure a unit test? Type Components AAA Arrange - Act - Assert GWT Given - When - Then avoid multiple arrange, act, and assert sections. avoid if statements in tests. name the test as if you were describing the scenario to a non-programmer who is familiar with the problem domain. separate words with underscores. structure a test is to make it tell a story about the problem domain Four pillars of a good unit test code is not an asset, itâ€™s a liability. protection against regressions the amount of code that is executed during the test the complexity of that code the codeâ€™s domain significance resistance to refactoring the fewer false positives the test generates, the better tests provides an early warning when you break exisiting functionality you become confident that your code changes wonâ€™t lead to regressions the more the test is coupled to the implementation details of the system under set(SUT), the more false alarms it generates you need to make sure the test verifies the end result the SUT delivers: its observable behavior, not the steps it takes to do that. the best way to structure a test is to make it tell a story about the problem domain fast feedback maintainability how hard it is to understand the test, which is a function of the testâ€™s size how hard it is to run the test, which is a function of how many out-of-process dependencies the test works with directly The intrinsic connection between the first two attributes Type II Error: if functionality is broken, the test should fail, but if the test also passed, means it is not a good unit test, should if it fails, means it offers protection against regressions. Type I Error: if functionality is correct but the test fails, means that the test dose not test the nature of behavior. The good unit test should always pass when the functionality is correct. This would help us a lot when we try to do refactor. If we refactor the code correctly, but the unit tests always failed, means that the unit tests are not good enough, we need to optimize them. An ideal test value = [0..1] * [0..1] * [0..1] * [0..1](corresponding to the four pillars) black-box and white-box testing choose black-box testing over white-box testing by default. the only exception is when the test covers utility code with high algorithmic complexity use code coverage tools to see which code branches are not exercised, but then turn around and test them as if you know nothing about the codeâ€™s internal structure. Mock types of test doubles mock: help to emulate and examine outcoming interactions â€”â€” change state mock: generated by tools spy: written manually stub: help to emulate incoming interactions â€”â€” get input data stub: can configure to return different values for different scenarios. dummy: a simple, hardcoded value such as a null value or a made-up string. fake: the same as a stub for most purposes, only except for its creation, it is usually implemented to replace a dependency that dose not yet exist never asserting interactions with stubs. Observable behavior expose an operation that helps the client achieve one of its goals. An operation is a method that performs a calculation or incurs a side effect or both. expose a state that helps the client achieve one of its goals. State is the current condition of the system. Whether the code is observable behavior depends on who its client is and what the goals of that client are. Ideally, the systemâ€™s public API surface should coincide with its observable behavior, and all its implementation details should be hidden from the eyes of the clients. Mocks and test fragility Intra-system communications are communications between classes inside your application. Inter-system communications are when your application talks to other applications. The use of mocks is beneficial when verifying the communication pattern between your system and external applications. Using mocks to verify communications between classes inside your system results in tests that couple to implementation details and therefore fall short of the resistance-to-refactoring metric. Types of dependencies shared dependency: a dependency shared by test (not production code) out-of-process dependency: a dependency hosted by a process other than the programâ€™s execution process (database, stmp server) private dependency: any dependency that is not shared Styles of unit testing output-based: only need to verify the output. state-based: the underlying code changes its own state, the state of its collaborators, or the state of an out-of-process dependency. communication-based: use mocks to verify communications between the SUT and its collaborators, to verify the communication situations. compare protection against regressions for the most part, they are not very different but overusing the communication-based style can result in shallow tests that verify only a thin slice of code and mock out everything else. fast feedback for the most part, they are not very different communication-based testing can be slightly worse because the cost of mocks. resistance to refactoring state-based is the best one. communication-based is the worse one, because it is the most vulnerable to false alarms. maintainability output-based is the best one, because they do not deal with out-of-process dependencies. state-based is less maintainable because state verification takes up more space than output verification. communication-based is the worst one, it requires setting up test doubles and interaction assertions, and that takes up a lot of space. functional architecture *Functional architecture* maximizes the amount of code written in a purely functional (immutable) way, while minimizing code that deals with side effects. Immutable means unchangeable: once an object is created, its state canâ€™t be modified. This is in contrast to a *mutable* object (changeable object), which can be modified after it is created. Separate two kinds of code: code that make a decision code that acts upon that decision Tips Moving from using an out-of-process dependency to using mocks. Moving from using mocks to using functional architecture Four kinds of code Domain model and algorithms Trivial code Controllers Overcomplicated code Tips always write completed unit tests for domain model the algorithms code never test trivial code write integration test for controllers do not write overcomplicated code, try to separate it into domain model and algorithms and controllers Trade-off domain model testability controller simplicity performance push all external reads and writes to the edges anyway inject the out-of-process dependencies into the domain model split the decision-making process into more granular steps ğŸ‘ˆ CanExecute/Execute pattern domain events CanExecute/Execute pattern You can use CanExecute/Execute pattern to balance the performance and testability , but concedes controller simplicity, but it is manageable in most cases. Domain events Domain events help track important changes in the domain model, and then convert those changes to calls to out-of-process dependencies. This pattern removes the tracking responsibility from the controller. extract a DomainEvent base class and introduce a base class for all domain classes, which would contain a collection of such events: ListDomainEvent events Integration tests check as many of the business scenarioâ€™s edge cases as possible with unit tests use integration tests to cover one happy path, as well as any edge cases that canâ€™t be covered by unit tests if thereâ€™s no one path that goes through all happy paths, write additional integration testsâ€”as many as needed to capture communications with every external system attempt to apply the fail-fast principle as a viable alternative to integration test. two types of out-of-process dependencies managed dependencies: only accessible through your application. it is implement details and should not be mock. unmanaged dependencies: you donâ€™t have full control over it. It is observable behavior and you should mock it. interface misunderstand ğŸ™‹ğŸ»â€â™€ï¸ Genuine abstractions are discovered, not invented. ğŸ‘‰ğŸ»Â For an interface to be a genuine abstraction, it must have at lease two implemtations. The common reasoning behind the use of interfaces is that they help to: Abstract out-of-process dependencies, thus achieving loose coupling. Add new functionality without changing the existing code, thus adhering to the Open-Closed principle Misconceptions: Interfaces with a single implementation are not abstractions and donâ€™t provide loose coupling any more than concrete classes that implement those interfaces. The second reason violates a more foundational principle: YAGNI (You are not gonna need it). The only reason to use interfaces for out-of-process dependencies it is to enable testing! Do not introduce interfaces for out-of-process dependencies unless you need to mock out those dependencies. integration test best practices making domain model boundaries explicit reducing the number of layers in the application eliminating circular dependencies maximozing mockâ€™s value when mocking, always try to verify interactions with unmanaged dependencies at the very edges of your system. Mocking IBus instead of IMessageBus maximizes the mockâ€™s protection against regressions. A call to an unmanaged dependency goes through several stages before it leaves your application. Pick the last such stage. It is the best way to ensure backward compatibility with external systems, which is the goal that mocks help you achieve. In some cases, you can use spy instead of mock for more succinct and expressive. [Fact]public void Changing_email_from_corporate_to_non_corporate() var busSpy = new BusSpy(); var messageBus = new MessageBus(busSpy); var loggerMock = new MockIDomainLogger(); var sut = new UserController(db, messageBus, loggerMock.Object); /* ... */ busSpy.ShouldSendNumberOfMessages(1) .WithEmailChangedMessage(user.UserId, new@gmail.com); mocking best practices applying mocks to unmanaged dependencies only verifying the interactions with those dependencies at the very edges of your system using mocks in integration tests only, not in unit test always verifying the number of calls made to the mock do not rely on production code when making assertions. Use a separate set of literals and constants in tests. mocking only types that you own always write your own adapters on top of third-party libraries and mock those adapters instead of the underlying types. only expose features you need from the library do that using your projectâ€™s domain language this guideline dose not apply to in-process dependencies. There is no need to abstract in-memory or managed dependencies. Similarly, thereâ€™s no need to abstract an ORM as long as itâ€™s used for accessing a database that isnâ€™t visible to external applications. Testing the database prerequisites keeping the database in the source control system database schemas reference data using a separate database instance for every developer applying the migration-based approach to database delivery applying every modification to the database schema (including reference data) through migrations. Do not modify migrations once they are committed to the source control. If a migration is incorrect, create a new migration instead of fixing the old one. Make exceptions to this rule only when the incorrect migration can lead to data loss. transaction split the Database class into repositories and a transaction: repositories are classes that enable access to and modification of the data in the database. transaction is a class that either commits or rolls back data updates in full. This will be a custom class relying on the underlying databaseâ€™s transactions to provide atomicity of data modification. tips use at least three transactions or units of work in an integrations test: one per each arrange, act and assert section. your tests should not depend on the state of the database. Your tests should bring that state to the required condition on their own. create two collections for unit and integrations, and then disable test parallelization in the collection with the integration test. clean up data at the beginning of a test write the SQL script manually. Itâ€™s simpler and gives you more granular control over the deletion process. the best way to shorten integration is by extracting technical, non-business-related bits into private methods or helper classes. only the most complex or important read operations should be test, disregard the rest. do not test repositories directly, only as part of the overarching integration test suite. Unit testing anti-patterns âš ï¸ Do not do the things like below! unit testing private methods Private methods are implementation details! Just test observable behaviors! If the private method is too complex to be tested as part of the public API that uses it, thatâ€™s an indication of a missing abstraction. Extract this abstraction into a separate class instead of making the private method public. expose private state leaking domain knowledges to tests public class CalculatorTests [Fact] public void Adding_two_numbers() int value1 = 1; int value2 = 3; int expected = value1 + value2; // -----The leakage // int expected = 4 // the better one int actual = Calculator.Add(value1, value2); Assert.Equal(expected, actual); code pollution Code pollution is adding production code thatâ€™s only needed for testing. mocking concrete classes working with time","tags":["å•å…ƒæµ‹è¯•","è¯»ä¹¦ç¬”è®°"],"categories":["è¯»ä¹¦ç¬”è®°","å•å…ƒæµ‹è¯•"]},{"title":"ä¸€æ­¥æ­¥æ¨å¯¼å‡º MySQL æ•°æ®çš„åº•å±‚å­˜å‚¨ç»“æ„","path":"/2025/04/08/mysql-ibd/","content":"ä»¥ä¸‹å‡ä»¥ InnoDB å¼•æ“ä¸ºåŸºç¡€è¿›è¡Œåˆ†æã€‚å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰ 3 è¡Œæ•°æ®ï¼Œå¦‚ä¸‹ï¼š å…¶ä¸­ï¼š id æ˜¯ä¸»é”®ç´¢å¼•ã€‚ a å’Œ b éƒ½æ˜¯æ•°æ®å­—æ®µã€‚ tx_id æ˜¯éšè—å­—æ®µï¼Œè¡¨ç¤ºäº‹åŠ¡ idï¼Œç”¨äºå®ç° MVCCã€‚ rollback_ptr æ˜¯å›æŒ‡é’ˆï¼Œç”¨äº undo logã€‚ åœ¨å°†æ•°æ®å­˜å‚¨åˆ°æ–‡ä»¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šå°†è¿™ä¸‰è¡Œæ•°æ®è¿›è¡Œåºåˆ—åŒ–ï¼Œç„¶åä»¥äºŒè¿›åˆ¶æµçš„å½¢å¼å­˜å‚¨åˆ°æ–‡ä»¶ä¸­ã€‚ ç°åœ¨æˆ‘ä»¬è¦è§£å†³ç¬¬ä¸€ä¸ªé—®é¢˜ï¼š å¦‚ä½•æŒ‰ç…§ä¸»é”®ï¼ˆidï¼‰æ’åºï¼Ÿ åœ¨ InnoDB ä¸­ï¼Œä¼šåœ¨æ¯ä¸€è¡Œçš„å‰é¢ï¼ŒåŠ ä¸€ä¸ª next_record å­—æ®µï¼Œç”¨äºæŒ‡å‘æ¯”å½“å‰æ•°æ® id å¤§çš„ä¸‹ä¸€æ¡æ•°æ®ï¼Œæˆ‘ä»¬å‡è®¾ä¸€è¡Œæ•°æ®å  20 ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆå°±å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å¦å¤–ï¼Œä¸ºäº†ä¾¿äºå®šä½æ¯ä¸€è¡Œï¼ŒInnoDB ä¼šåœ¨æ¯ä¸€è¡Œå‰é¢å†åŠ ä¸€ä¸ªå­—æ®µ heap_noï¼Œå®ƒçš„è§„åˆ™å¾ˆç®€å•ï¼Œå°±æ˜¯è‡ªå¢ï¼Œåœ¨å†…éƒ¨ä¼šç”¨äºå®šä½ä¸€è¡Œè®°å½•ï¼Œæ–¹ä¾¿ä¸Šé”ç­‰å„ç§æ“ä½œã€‚ æ‰€ä»¥ç°åœ¨çš„å­˜å‚¨ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ç°åœ¨æˆ‘ä»¬æ¥è§£å†³è§£å†³ç¬¬äºŒä¸ªé—®é¢˜ï¼š å¦‚ä½•å¿«é€Ÿå®šä½åˆ°èµ·ç‚¹ï¼ˆæœ€å°ï¼‰å’Œç»ˆç‚¹ï¼ˆæœ€å¤§ï¼‰ï¼Ÿ åœ¨æœ€å‰é¢åŠ  2 æ¡ç‰¹æ®Šçš„è®°å½•ï¼š PAGE_NEW_INFIMUMï¼šæŒ‡å‘æœ€å°è®°å½•ã€‚ PAGE_NEW_SUPERMUMï¼šæœ€å¤§è®°å½•ï¼Œæœ€å¤§çš„ä¸€ä¸ª id ä¼šæŒ‡å‘å®ƒã€‚ ç¬¬ä¸‰ä¸ªé—®é¢˜ï¼š æ¯æ¬¡ select * from t where id = ? éƒ½è¦è¿›è¡Œ I/O æ“ä½œå—ï¼Ÿ å¾ˆæ˜¾ç„¶æ˜¯ä¸è¡Œçš„ï¼Œæ•ˆç‡å¤ªä½äº†ã€‚è¿™ä¸ªç›¸ä¿¡ç»å¤§å¤šæ•°è¯»è€…éƒ½çŸ¥é“ ï¼ŒInnoDB ä¼šä»¥ Pageï¼ˆé»˜è®¤ 16KBï¼‰ä¸ºæœ€å°å•ä½ï¼Œä¸€æ¬¡æ€§å°†æ•°æ®ä»ç£ç›˜åŠ è½½åˆ°å†…å­˜ä¸­ã€‚ä¸ºæ­¤ï¼Œéœ€è¦åœ¨æœ€å‰é¢å†åŠ ä¸€æ¡è®°å½•ï¼Œä¸”è¯¥è®°å½•çš„å‰ä¸‰è¡Œåˆ†åˆ«ä¸ºï¼š page_noï¼šé¡µå·ï¼Œè‡ªå¢ï¼ŒInnoDB æœ€å¤šæ”¯æŒ 32 ä½é¡µå·ï¼Œæ‰€ä»¥å­˜å‚¨ä¸Šé™æ˜¯ 16KB * 232 = 64Tã€‚ prev_pageï¼šæŒ‡å‘ä¸Šä¸€é¡µã€‚ next_pageï¼šæŒ‡å‘ä¸‹ä¸€é¡µã€‚ å¦‚æœä¸€ä¸ª Page æ”¾ä¸ä¸‹å‘¢ï¼Ÿ å¾ˆæ˜¾ç„¶ï¼Œé‚£å°±è¦è¿›è¡Œåˆ†é¡µï¼Œå³æŒ‰ç…§ ID çš„é¡ºåºè¿›è¡Œä¸€åˆ†ä¸ºäºŒï¼Œå‰è€…å–èŒƒå›´ [a, b)ï¼Œåè€…å–èŒƒå›´ [b, c)ã€‚ å¦‚ä½•å¿«é€Ÿå®šä½åˆ°æ•°æ®åœ¨å“ªä¸ª Page ä¸Šå‘¢ï¼Ÿ è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æ–°åˆ›å»ºä¸€ä¸ª Pageï¼Œä¸“é—¨ç”¨äºç®¡ç†è¿™äº›æ•°æ® Page çš„ï¼Œè¿™ä¸ª Page æˆ‘ä»¬è¿™é‡Œæš‚ä¸”ç§°ä¸ºç´¢å¼• Pageã€‚ å…¶ä¸­æ ¸å¿ƒæ•°æ®å°±æ˜¯ 2 ä¸ªï¼š min_idï¼šå³å½“å‰é¡µå­˜å‚¨çš„æœ€å°ä¸»é”® IDã€‚ page_noï¼šé¡µå·ï¼Œç”¨äºå®šä½åˆ° Pageã€‚ è¿™æ˜¯ä»€ä¹ˆå‘€ï¼Ÿè¿™å…¶å®å°±æ˜¯ B+ æ ‘ï¼åœ¨æ–‡ä»¶å±‚é¢çš„å­˜å‚¨ï¼Œæ˜¯è¿ç»­å­˜å‚¨çš„ï¼Œä½†æ˜¯ä¸ºäº†ä¾¿äºç†è§£ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨é€»è¾‘å±‚é¢å°†å…¶ç»˜åˆ¶æˆ B+ æ ‘çš„å½¢æ€ã€‚å¦‚ä¸‹å›¾å¯ä»¥çœ‹åˆ°è¿™å…¶å®å°±æ˜¯ä¸€é¢— B+ æ ‘ã€‚ åœ¨ä¸»é”®ç´¢å¼•æ ‘ä¸Šï¼š å¶å­èŠ‚ç‚¹å­˜å‚¨çš„å°±æ˜¯å…·ä½“æŸä¸€è¡Œçš„æ•°æ®ï¼ˆèšç°‡ç´¢å¼•ï¼‰ã€‚ éå¶å­èŠ‚ç‚¹å­˜å‚¨çš„æ˜¯ç´¢å¼•ã€‚ æ¯ä¸€å±‚çš„èŠ‚ç‚¹ï¼Œéƒ½æ˜¯ä¸€æ¡æœ‰åºçš„åŒå‘é“¾è¡¨ã€‚ å¦‚æœå¯¹éä¸»é”®ç´¢å¼• a åˆ›å»ºç´¢å¼•å‘¢ï¼Ÿ å› ä¸ºè¦å»ºç´¢å¼•ï¼Œæ‰€ä»¥éœ€è¦å…ˆå¯¹ a è¿›è¡Œæ’åºï¼Œç„¶åé’ˆå¯¹ a å»ºç«‹ä¸€é¢— b+ æ ‘ã€‚è€Œä¸”ç”±äº a æ˜¯éä¸»é”®ç´¢å¼•ï¼Œå³è¾…åŠ©ç´¢å¼•ï¼Œæ‰€ä»¥å¶å­èŠ‚ç‚¹å­˜å‚¨çš„æ˜¯ä¸»é”®çš„å€¼ï¼Œç”¨äºå›è¡¨ã€‚ å‡è®¾ a =15 çš„æ•°æ®éå¸¸å¤šï¼Œä¸€ä¸ª page æ”¾ä¸ä¸‹å‘¢ï¼Ÿ ä¼šåŠ å…¥ä¸»é”® ID ä½œä¸ºäºŒç»´æ’åºæ¥è¿›è¡Œåˆ†è£‚ï¼š ä¼°ç®—ä¸€ä¸‹ä¸€ä¸ªä¸‰å±‚çš„ B+ æ ‘å¯ä»¥å­˜å‚¨å¤šå°‘æ¡æ•°æ®ï¼Ÿ ä¸€ä¸ª Page æ˜¯ 16KB å‡è®¾ 1 ä¸ª Page å¯ä»¥å­˜æ”¾ 1000 ä¸ª key å‡è®¾ 1 ä¸ª Page å¯ä»¥å­˜æ”¾ 200 æ¡è®°å½• åŸºäºè¿™ç§ä¼°ç®—ï¼š ç¬¬ 1 å±‚ï¼š1 ä¸ªèŠ‚ç‚¹æ˜¯ 1 ä¸ª Pageï¼Œå­˜æ”¾ 1000 ä¸ª keyï¼Œå¯¹åº” 1000 ä¸ªåˆ†å‰ ç¬¬ 2 å±‚ï¼š1000 ä¸ªèŠ‚ç‚¹ 1000 ä¸ª Pageï¼Œå­˜æ”¾ 1000*1000 ä¸ª Keyï¼Œå¯¹åº” 1000*1000 ä¸ªåˆ†å‰ ç¬¬ 3 å±‚ï¼š1000*1000 ä¸ª Pageï¼Œæ¯ä¸ª Page 200 æ¡æ•°æ®ï¼Œå…± 1000*1000*200=2 äº¿æ¡æ•°æ® = 16KB*1000*1000=16GB ğŸ‚ğŸ‚ğŸ‚","tags":["mysql"],"categories":["æ•°æ®åº“","mysql"]},{"title":"Python çŸ¥è¯†å›¾è°±","path":"/2025/04/05/python-mindmap/","content":"python-mindmap","tags":["python","mindmap"],"categories":["python","mindmap"]},{"title":"åç«¯å¼€å‘ä¹‹è·¯","path":"/2025/03/17/backend-road/","content":"svg.markmap { width: 100%; height: 100vh; } - åç«¯å¼€å‘ä¹‹è·¯ - åŸºç¡€çŸ¥è¯† - è®¡ç®—æœºåŸºç¡€ - ç½‘ç»œåŸºç¡€ - æ•°æ®åº“åŸºç¡€ - æ“ä½œç³»ç»ŸåŸºç¡€ - ç¼–ç¨‹è¯­è¨€åŸºç¡€ - ç¼–ç¨‹è¯­è¨€ - Java - Python - Node.js - Go - PHP - Ruby - C# - C++ - C - JavaScript - TypeScript - Kotlin - Swift - æ¡†æ¶ - Spring Boot - Django - Flask - Express - Koa - Nest.js - æ•°æ®åº“ - MySQL - PostgreSQL - MongoDB - Redis - SQLite - Oracle - ä¸­é—´ä»¶ - Nginx - Apache - Tomcat - Jetty - Undertow - è®¾è®¡æ¨¡å¼ - å•ä¾‹æ¨¡å¼ - å·¥å‚æ¨¡å¼ - è§‚å¯Ÿè€…æ¨¡å¼ - ç­–ç•¥æ¨¡å¼ - è£…é¥°å™¨æ¨¡å¼ - é€‚é…å™¨æ¨¡å¼ - é—¨é¢æ¨¡å¼ - æ¶æ„æ¨¡å¼ - å¾®æœåŠ¡æ¶æ„ - äº‹ä»¶é©±åŠ¨æ¶æ„ - å‘å¸ƒè®¢é˜…æ¶æ„ - æµå¼å¤„ç†æ¶æ„ - æœåŠ¡ç½‘æ ¼æ¶æ„ - æ€§èƒ½ä¼˜åŒ– - ä»£ç ä¼˜åŒ– - æ•°æ®åº“ä¼˜åŒ– - ç¼“å­˜ä¼˜åŒ– - å¼‚æ­¥ç¼–ç¨‹ - å¹¶å‘ç¼–ç¨‹ - å¤šçº¿ç¨‹ç¼–ç¨‹ - åˆ†å¸ƒå¼ç¼–ç¨‹ - é«˜å¯ç”¨æ€§è®¾è®¡","tags":["roadmap"],"categories":["roadmap"]},{"title":"åœ¨ Hexo åšå®¢ä¸­ä¼˜é›…åœ°é›†æˆ Markmap æ€ç»´å¯¼å›¾","path":"/2025/03/17/mindmap-for-hexo/","content":"åœ¨æŠ€æœ¯åšå®¢å†™ä½œä¸­ï¼Œæ€ç»´å¯¼å›¾æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„å·¥å…·ï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´æ¸…æ™°åœ°å±•ç¤ºçŸ¥è¯†ç»“æ„å’Œæ¦‚å¿µå…³ç³»ã€‚æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•åœ¨ Hexo åšå®¢ä¸­é›†æˆ Markmapï¼Œè®©ä½ èƒ½å¤Ÿç›´æ¥åœ¨ Markdown æ–‡ä»¶ä¸­åˆ›å»ºäº¤äº’å¼æ€ç»´å¯¼å›¾ã€‚ ä»€ä¹ˆæ˜¯ Markmapï¼Ÿ Markmap æ˜¯ä¸€ä¸ªå°† Markdown æ ¼å¼çš„æ–‡æœ¬è½¬æ¢ä¸ºæ€ç»´å¯¼å›¾çš„å¼€æºå·¥å…·ã€‚å®ƒå…è®¸æˆ‘ä»¬ä½¿ç”¨ç†Ÿæ‚‰çš„ Markdown è¯­æ³•æ¥åˆ›å»ºæ¼‚äº®çš„ã€äº¤äº’å¼çš„æ€ç»´å¯¼å›¾ã€‚ https://markmap.js.org/https://markmap.js.org/ å®ç°æ–¹æ¡ˆ 1. å®‰è£…å¿…è¦ä¾èµ– é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®‰è£… uuid åŒ…ï¼Œè¿™æ˜¯ç”¨æ¥ç»™æˆ‘ä»¬æ¯ä¸€ä¸ªæ€ç»´å¯¼å›¾ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ IDï¼š npm install uuid --save 2. åˆ›å»ºè‡ªå®šä¹‰æ ‡ç­¾æ’ä»¶ åœ¨ scripts/markmap_tag.js ä¸­åˆ›å»ºè‡ªå®šä¹‰æ ‡ç­¾ï¼š /** * Markmap Tag Plugin for Hexo */use strict;const v4: uuidv4 = require(uuid);hexo.extend.tag.register( markmap, function (args, content) const id = uuidv4(); return `div class=markmap id=markmap-$id script type=text/template$content /script/divscriptdocument.addEventListener(DOMContentLoaded, () = const template = document.querySelector(#markmap-$id script[type=text/template]); if (template) const content = template.textContent; window.markmap.autoLoader.renderString(content, null, document.querySelector(#markmap-$id)); );/script `; , ends: true ); 3. æ·»åŠ æ ·å¼ åˆ›å»º source/css/markmap.cssï¼š /* Markmap Styles */.markmap width: 100%; height: 500px; margin: 20px 0; border: 1px solid #eaeaea; border-radius: 5px; overflow: hidden;.markmap svg width: 100%; height: 100%;/* å“åº”å¼è®¾è®¡ */@media (max-width: 768px) .markmap height: 400px; @media (max-width: 480px) .markmap height: 300px; 4. æ›´æ–°ä¸»é¢˜é…ç½® åœ¨ä¸»é¢˜é…ç½®æ–‡ä»¶ä¸­æ·»åŠ å¿…è¦çš„èµ„æºå¼•ç”¨ï¼š inject: head: - link rel=stylesheet href=/css/markmap.css - script src=https://cdn.jsdelivr.net/npm/markmap-autoloader@0.18/script ä½¿ç”¨æ–¹æ³• ä»£ç å—æ•ˆæœ% markmap %- æŠ€æœ¯æ ˆ - å‰ç«¯ - Vue.js - React - Angular - åç«¯ - Node.js - Python - Go - æ•°æ®åº“ - MySQL - MongoDB - Redis% endmarkmap % svg.markmap { width: 100%; height: 500px; } - æŠ€æœ¯æ ˆ - å‰ç«¯ - Vue.js - React - Angular - åç«¯ - Node.js - Python - Go - æ•°æ®åº“ - MySQL - MongoDB - Redis å·¥ä½œåŸç† 1. Hexo æ’ä»¶ç³»ç»Ÿ Hexo æä¾›äº†å¼ºå¤§çš„æ’ä»¶ç³»ç»Ÿï¼Œå…è®¸æˆ‘ä»¬é€šè¿‡ hexo.extend API æ¥æ‰©å±•åŠŸèƒ½ æˆ‘ä»¬ä½¿ç”¨äº† hexo.extend.tag æ¥æ³¨å†Œè‡ªå®šä¹‰æ ‡ç­¾ï¼Œè¿™æ˜¯ Hexo æä¾›çš„æ ‡å‡†æ‰©å±•ç‚¹ä¹‹ä¸€ 2. æ ‡ç­¾æ’ä»¶çš„å·¥ä½œåŸç† hexo.extend.tag.register( markmap, function (args, content) const id = uuidv4(); // ç”Ÿæˆå”¯ä¸€ID return ` div class=markmap id=markmap-$id script type=text/template $content /script /div ... `; , ends: true ); å½“ Hexo è§£æåˆ° markmap æ ‡ç­¾æ—¶ï¼Œä¼šè°ƒç”¨è¿™ä¸ªæ³¨å†Œçš„å‡½æ•° content å‚æ•°åŒ…å«äº†æ ‡ç­¾ä¹‹é—´çš„æ‰€æœ‰å†…å®¹ï¼ˆä½ çš„ markdown ç»“æ„ï¼‰ ends: true è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªé—­åˆæ ‡ç­¾ï¼ˆéœ€è¦ endmarkmap ç»“æŸï¼‰ 3. Markmap åº“çš„æ¸²æŸ“è¿‡ç¨‹ Markmap åº“ä½¿ç”¨ markmap-autoloader è‡ªåŠ¨å¤„ç† markdown åˆ°æ€ç»´å¯¼å›¾çš„è½¬æ¢ è½¬æ¢è¿‡ç¨‹ï¼š Markdown æ–‡æœ¬è¢«è§£ææˆå±‚çº§ç»“æ„ å±‚çº§ç»“æ„è¢«è½¬æ¢ä¸º SVG è·¯å¾„ SVG è¢«æ¸²æŸ“åˆ°é¡µé¢ä¸Šï¼Œå¹¶æ·»åŠ äº¤äº’åŠŸèƒ½ 4. HTML ç»“æ„è®¾è®¡ div class=markmap id=markmap-$id script type=text/template $content /script/div ä½¿ç”¨ script type=\"text/template\" æ¥å­˜å‚¨åŸå§‹ markdown æ¯ä¸ªæ€ç»´å¯¼å›¾éƒ½æœ‰å”¯ä¸€ IDï¼Œé¿å…é¡µé¢ä¸Šå¤šä¸ªå›¾è¡¨äº’ç›¸å¹²æ‰° 5. JavaScript åˆå§‹åŒ– document.addEventListener(DOMContentLoaded, () = const template = document.querySelector( #markmap-$id script[type=text/template] ); if (template) const content = template.textContent; window.markmap.autoLoader.renderString( content, null, document.querySelector(#markmap-$id) ); ); ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ è·å–æ¨¡æ¿ä¸­çš„ markdown å†…å®¹ ä½¿ç”¨ markmap åº“æ¸²æŸ“æ€ç»´å¯¼å›¾ 6. æ ·å¼æ§åˆ¶ .markmap width: 100%; height: 500px; margin: 20px 0; border: 1px solid #eaeaea; border-radius: 5px; overflow: hidden; æä¾›å“åº”å¼å¸ƒå±€ ç¡®ä¿æ€ç»´å¯¼å›¾åœ¨å„ç§å±å¹•å°ºå¯¸ä¸‹éƒ½èƒ½æ­£å¸¸æ˜¾ç¤º 7. ä¸»é¢˜é›†æˆ åœ¨ä¸»é¢˜é…ç½®ä¸­æ³¨å…¥å¿…è¦çš„ CSS å’Œ JavaScript ç¡®ä¿èµ„æºåœ¨æ­£ç¡®çš„æ—¶æœºåŠ è½½","tags":["hexo","markmap"],"categories":["å°æŠ€æœ¯"]},{"title":"ä¸ºä»€ä¹ˆ OpenTelemetry çš„ SDK ä¸­ä¸æ”¯æŒå°¾é‡‡æ · Hookï¼Ÿ","path":"/2025/03/13/opentelemetry-tail-sampler/","content":"åœ¨åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿä¸­ï¼Œé‡‡æ ·ç­–ç•¥ç›´æ¥å½±å“ç€ç³»ç»Ÿçš„æ€§èƒ½å’Œå¯è§‚æµ‹æ€§ã€‚OpenTelemetry ä½œä¸ºå½“å‰æœ€æµè¡Œçš„å¯è§‚æµ‹æ€§æ¡†æ¶ï¼Œå…¶é‡‡æ ·æœºåˆ¶è®¾è®¡æœ‰ç€æ·±åˆ»çš„è€ƒé‡ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨ OpenTelemetry çš„é‡‡æ ·æœºåˆ¶ï¼Œç‰¹åˆ«æ˜¯ä¸ºä»€ä¹ˆå®ƒåœ¨ SDK å±‚é¢ä¸æ”¯æŒå°¾é‡‡æ ·ã€‚ å‰ç½®é‡‡æ · vs å°¾é‡‡æ · åœ¨è®¨è®º OpenTelemetry çš„é‡‡æ ·æœºåˆ¶å‰ï¼Œæˆ‘ä»¬éœ€è¦ç†è§£ä¸¤ç§ä¸»è¦çš„é‡‡æ ·ç­–ç•¥ï¼š å‰ç½®é‡‡æ ·ï¼ˆHead-based Samplingï¼‰ï¼š åœ¨é“¾è·¯å¼€å§‹æ—¶å°±å†³å®šæ˜¯å¦é‡‡æ · å†³ç­–ä¸€æ—¦åšå‡ºï¼Œæ•´ä¸ªé“¾è·¯éƒ½éµå¾ªè¿™ä¸ªå†³ç­– ä¸éœ€è¦ç¼“å­˜å®Œæ•´çš„é“¾è·¯æ•°æ® å°¾é‡‡æ ·ï¼ˆTail-based Samplingï¼‰ï¼š åœ¨é“¾è·¯ç»“æŸåå†³å®šæ˜¯å¦ä¿ç•™ å¯ä»¥åŸºäºå®Œæ•´é“¾è·¯ä¿¡æ¯ï¼ˆå¦‚æ€»è€—æ—¶ã€æ˜¯å¦æœ‰é”™è¯¯ï¼‰åšå†³ç­– éœ€è¦ä¸´æ—¶ç¼“å­˜æ‰€æœ‰é“¾è·¯æ•°æ® OpenTelemetry çš„é‡‡æ ·å®ç° é€šè¿‡åˆ†æ OpenTelemetry Go SDK çš„æºç ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°å®ƒé‡‡ç”¨çš„æ˜¯å‰ç½®é‡‡æ ·ç­–ç•¥ã€‚å…³é”®ä»£ç å¦‚ä¸‹ï¼š func (tr *tracer) newSpan(ctx context.Context, name string, config *trace.SpanConfig) trace.Span // ... å‰é¢çš„ä»£ç  ... // æ‰§è¡Œé‡‡æ ·å†³ç­– samplingResult := tr.provider.sampler.ShouldSample(SamplingParameters ParentContext: ctx, TraceID: tid, Name: name, Kind: config.SpanKind(), Attributes: config.Attributes(), Links: config.Links(), ) // è®¾ç½®é‡‡æ ·æ ‡å¿— if isSampled(samplingResult) scc.TraceFlags = psc.TraceFlags() | trace.FlagsSampled else scc.TraceFlags = psc.TraceFlags() ^ trace.FlagsSampled // ... åé¢çš„ä»£ç  ... è¿™æ®µä»£ç æ­ç¤ºäº†å‡ ä¸ªå…³é”®ç‚¹ï¼š é‡‡æ ·å†³ç­–åœ¨ span åˆ›å»ºæ—¶å°±å·²ç»åšå‡º é‡‡æ ·æ ‡å¿—é€šè¿‡ä½æ“ä½œè®¾ç½®åœ¨ TraceFlags ä¸­ è¿™ä¸ªæ ‡å¿—ä¼šéšç€ SpanContext ä¼ æ’­åˆ°æ•´ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿ é‡‡æ ·æ ‡å¿—çš„ä¼ æ’­æœºåˆ¶ ç‰¹åˆ«å€¼å¾—æ³¨æ„çš„æ˜¯è®¾ç½®é‡‡æ ·æ ‡å¿—çš„ä»£ç ï¼š if isSampled(samplingResult) scc.TraceFlags = psc.TraceFlags() | trace.FlagsSampled else scc.TraceFlags = psc.TraceFlags() ^ trace.FlagsSampled è¿™æ®µä»£ç ä½¿ç”¨ä½æ“ä½œæ¥è®¾ç½®æˆ–æ¸…é™¤é‡‡æ ·æ ‡å¿—ï¼š | æ“ä½œç”¨äºè®¾ç½®é‡‡æ ·æ ‡å¿—ï¼Œä¿ç•™å…¶ä»–æ ‡å¿—ä½ä¸å˜ ^ æ“ä½œç”¨äºæ¸…é™¤é‡‡æ ·æ ‡å¿—ï¼ŒåŒæ ·ä¿ç•™å…¶ä»–æ ‡å¿—ä½ä¸å˜ è¿™ç¡®ä¿äº†é‡‡æ ·å†³ç­–èƒ½å¤Ÿä¸€è‡´åœ°ä¼ æ’­åˆ°æ•´ä¸ªåˆ†å¸ƒå¼é“¾è·¯ä¸­ã€‚ ä¸ºä»€ä¹ˆ OpenTelemetry ä¸æ”¯æŒå°¾é‡‡æ ·ï¼Ÿ æœ€é‡è¦çš„åŸå› æ˜¯ï¼šåœ¨ SDK ä¸­æ‰¾ä¸åˆ°å°¾å·´ï¼å› ä¸ºä¸çŸ¥é“é“¾è·¯ä»€ä¹ˆæ—¶å€™ç»“æŸï¼ åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¸€æ¡é“¾è·¯å¯èƒ½è·¨è¶Šå¤šä¸ªæœåŠ¡ï¼Œæ‰€ä»¥ä½ åœ¨æŸä¸€ä¸ªæœåŠ¡ä¸­ï¼Œæ˜¯ä¸çŸ¥é“é“¾è·¯æ˜¯å¦ç»“æŸçš„ï¼Œè€Œ OpenTelemetry ä¹Ÿä¸æ˜¯ä¸€æ¬¡æ€§ä¸ŠæŠ¥ä¸€æ•´æ¡é“¾è·¯ï¼Œè€Œæ˜¯æ¯ä¸ª span ç‹¬ç«‹ä¸ŠæŠ¥ï¼Œæœ€åå†æ‹¼æ¥åˆ°ä¸€èµ·ã€‚ OpenTelemetry ä¸ŠæŠ¥åŸç† ç‹¬ç«‹ä¸ŠæŠ¥ æ¯ä¸ª span åœ¨ç»“æŸæ—¶ï¼ˆè°ƒç”¨ span.End()ï¼‰ä¼šè¢«ä¼ é€’ç»™ SpanProcessor SpanProcessor å†³å®šå¦‚ä½•å¤„ç†è¿™ä¸ª spanï¼ˆç«‹å³å¯¼å‡ºæˆ–æ‰¹é‡å¯¼å‡ºï¼‰ å¯¼å‡ºæ˜¯ç‹¬ç«‹çš„ï¼Œä¸ä¼šç­‰å¾…æ•´ä¸ª trace å®Œæˆ æ‰¹å¤„ç†æœºåˆ¶ é»˜è®¤ä½¿ç”¨ BatchSpanProcessorï¼Œå®ƒä¼šæ”¶é›†ä¸€å®šæ•°é‡çš„ spans æˆ–ç­‰å¾…ä¸€å®šæ—¶é—´ç„¶åæ‰¹é‡å¯¼å‡º ä½†è¿™ä¸ªæ‰¹å¤„ç†ä¸ trace å®Œæ•´æ€§æ— å…³ï¼Œåªæ˜¯ä¸ºäº†æ•ˆç‡ Collector å¦‚ä½•å®ç°å°¾é‡‡æ · Collector é€šè¿‡ä»¥ä¸‹æ–¹å¼è§£å†³è¿™äº›é—®é¢˜ï¼š è®¾ç½®ç­‰å¾…æ—¶é—´çª—å£ ä¸ºæ¯ä¸ª trace è®¾ç½®ä¸€ä¸ªç­‰å¾…æœŸï¼ˆå¦‚ 10 ç§’ï¼‰ åœ¨æ­¤æœŸé—´æ”¶é›†è¯¥ trace çš„æ‰€æœ‰ spans è¶…è¿‡ç­‰å¾…æœŸåï¼ŒåŸºäºå·²æ”¶é›†çš„ spans åšå†³ç­– é›†ä¸­å¼æ”¶é›† æ‰€æœ‰æœåŠ¡çš„ spans éƒ½å‘é€åˆ° Collector Collector æœ‰æ›´å…¨é¢çš„è§†å›¾æ¥å…³è” spans ä¸“é—¨çš„èµ„æºåˆ†é…ï¼šCollector ä½œä¸ºç‹¬ç«‹ç»„ä»¶ï¼Œæœ‰ä¸“é—¨çš„èµ„æºå¤„ç†è¿™ç§å¤æ‚é€»è¾‘ï¼Œä¸ä¼šå½±å“åº”ç”¨æ€§èƒ½ã€‚ å¦‚ä½•åœ¨ OpenTelemetry ç”Ÿæ€ä¸­å®ç°å°¾é‡‡æ ·ï¼Ÿ è™½ç„¶ SDK ä¸ç›´æ¥æ”¯æŒå°¾é‡‡æ ·ï¼Œä½† OpenTelemetry ç”Ÿæ€æä¾›äº†å…¶ä»–æ–¹å¼å®ç°ç±»ä¼¼åŠŸèƒ½ï¼š 1. ä½¿ç”¨ OpenTelemetry Collector Collector æä¾›äº† Tail Sampling Processorï¼Œå¯ä»¥åœ¨æ•°æ®èšåˆå±‚å®ç°å°¾é‡‡æ ·ï¼š processors: tail_sampling: decision_wait: 10s num_traces: 100 expected_new_traces_per_sec: 10 policies: - name: error-policy type: status_code status_code: ERROR 2. ç»“åˆå‰ç½®é‡‡æ ·å’Œé”™è¯¯æ•è· å¯ä»¥å®ç°ä¸€ä¸ªæ™ºèƒ½çš„å‰ç½®é‡‡æ ·å™¨ï¼Œå¯¹ç‰¹å®šåœºæ™¯ï¼ˆå¦‚åŒ…å«é”™è¯¯å±æ€§ï¼‰å¼ºåˆ¶é‡‡æ ·ï¼š type SmartSampler struct baseSamplingRate float64func (s *SmartSampler) ShouldSample(p trace.SamplingParameters) trace.SamplingResult // é”™è¯¯è¯·æ±‚å¿…é‡‡æ · for _, attr := range p.Attributes if attr.Key == error return trace.SamplingResultDecision: trace.RecordAndSample // å…¶ä»–è¯·æ±‚ä½¿ç”¨åŸºç¡€é‡‡æ ·ç‡ if float64(p.TraceID[0])/255.0 s.baseSamplingRate return trace.SamplingResultDecision: trace.RecordAndSample return trace.SamplingResultDecision: trace.Drop 3. ä½¿ç”¨ä¸“é—¨çš„åç«¯ç³»ç»Ÿ ä¸€äº›ä¸“é—¨çš„å¯è§‚æµ‹æ€§åç«¯ç³»ç»Ÿæä¾›äº†å°¾é‡‡æ ·åŠŸèƒ½ï¼š Jaeger çš„ Adaptive Sampling SkyWalking çš„ Trace Sampling Grafana Tempo çš„ Trace Sampling ç»“è®º OpenTelemetry SDK é‡‡ç”¨å‰ç½®é‡‡æ ·è€Œéå°¾é‡‡æ ·ï¼Œæ˜¯åŸºäºåˆ†å¸ƒå¼ç³»ç»Ÿä¸€è‡´æ€§ã€æ€§èƒ½ä¼˜åŒ–å’Œæ¶æ„åˆ†å±‚ç­‰å¤šæ–¹é¢è€ƒè™‘çš„ç»“æœã€‚è™½ç„¶è¿™æ„å‘³ç€æ— æ³•åŸºäºå®Œæ•´é“¾è·¯ä¿¡æ¯åšé‡‡æ ·å†³ç­–ï¼Œä½† OpenTelemetry ç”Ÿæ€æä¾›äº†å¤šç§æ–¹å¼æ¥å¼¥è¡¥è¿™ä¸€é™åˆ¶ã€‚ åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š åœ¨ SDK å±‚ä½¿ç”¨æ™ºèƒ½å‰ç½®é‡‡æ ·ç­–ç•¥ï¼Œç¡®ä¿å…³é”®é“¾è·¯è¢«é‡‡æ · åœ¨ Collector å±‚å®ç°å°¾é‡‡æ ·ï¼Œè¿›ä¸€æ­¥ç­›é€‰æœ‰ä»·å€¼çš„é“¾è·¯ ç»“åˆä½¿ç”¨å¤šç§é‡‡æ ·ç­–ç•¥ï¼Œå¹³è¡¡æ€§èƒ½å’Œå¯è§‚æµ‹æ€§ é€šè¿‡è¿™ç§åˆ†å±‚è®¾è®¡ï¼ŒOpenTelemetry æ—¢ä¿è¯äº†é«˜æ•ˆçš„æ•°æ®æ”¶é›†ï¼Œåˆä¸ºé«˜çº§é‡‡æ ·ç­–ç•¥æä¾›äº†å¯èƒ½æ€§ï¼Œæ»¡è¶³äº†ä¸åŒåœºæ™¯çš„éœ€æ±‚ã€‚ å®æˆ˜æ¡ˆä¾‹ ç¬”è€…å®ç°ä¸€ä¸ª Go è¯­è¨€çš„å¼€æºé¡¹ç›® goapmï¼Œå¯¹å¤šä¸ª Go è¯­è¨€ä¸­å¸¸ç”¨çš„ç»„ä»¶è¿›è¡Œäº† traceã€log å’Œ metrics çš„é›†æˆå°è£…ï¼Œç”¨äºå¿«é€Ÿåœ¨ Go è¯­è¨€é¡¹ç›®ä¸­å®ç°å¯è§‚æµ‹æ€§ï¼ŒåŒæ—¶è¿˜æä¾›äº† goapm-example å®æˆ˜æ¡ˆä¾‹ï¼Œå¯ä¾›å‚è€ƒã€‚ https://github.com/hedon954/goapmhttps://github.com/hedon954/goapm https://github.com/hedon954/goapm-examplehttps://github.com/hedon954/goapm-example","tags":["opentelemetry","æœåŠ¡ç›‘æ§"],"categories":["æœåŠ¡ç›‘æ§"]},{"title":"è¯»ä¹¦ç¬”è®°ä¸¨ã€Šæ‚Ÿé“é¢†åŸŸé©±åŠ¨è®¾è®¡ã€‹","path":"/2025/03/11/note-ddd-awareness/","content":"æ€ç»´è½¬å˜ é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDomain-Driven Designï¼Œä»¥ä¸‹ç®€ç§° DDDï¼‰çš„æ ¸å¿ƒä»·å€¼åœ¨äºå…¶å¯¹ã€Œä¸šåŠ¡é¢†åŸŸã€çš„æ·±åº¦èšç„¦ã€‚è¿™é‡Œçš„ã€Œé¢†åŸŸã€å¹¶éå•çº¯çš„æŠ€æœ¯èŒƒç•´ï¼Œè€Œæ˜¯æŒ‡ä»£è½¯ä»¶ç³»ç»Ÿæ‰€è¦æ˜ å°„çš„ç°å®ä¸šåŠ¡åœºæ™¯åŠå…¶æ ¸å¿ƒä»·å€¼ä¸»å¼ ã€‚DDD é€šè¿‡å»ºç«‹ä¸ä¸šåŠ¡é«˜åº¦å¥‘åˆçš„é¢†åŸŸæ¨¡å‹ï¼Œä½¿å¾—æŠ€æœ¯å®ç°ä¸ä¸šåŠ¡æœ¬è´¨å½¢æˆåŒé¢‘å…±æŒ¯ï¼Œä»è€Œæœ‰æ•ˆè§£å†³å¤æ‚ä¸šåŠ¡åœºæ™¯ä¸‹çš„è®¤çŸ¥é¸¿æ²Ÿé—®é¢˜ã€‚ åœ¨ VUCAï¼ˆVolatile æ˜“å˜æ€§ã€Uncertain ä¸ç¡®å®šæ€§ã€Complex å¤æ‚æ€§ã€Ambiguous æ¨¡ç³Šæ€§ï¼‰ç‰¹å¾æ„ˆå‘æ˜¾è‘—çš„ç°ä»£å•†ä¸šç¯å¢ƒä¸­ï¼Œä»»ä½•æ¶æ„è®¾è®¡éƒ½é¢ä¸´å›ºæœ‰å±€é™ã€‚è¿™ç§å±€é™æ€§æ—¢æºäºä¸šåŠ¡éœ€æ±‚æœ¬èº«çš„åŠ¨æ€æ¼”è¿›ï¼Œä¹Ÿå—åˆ¶äºäººç±»è®¤çŸ¥çš„æœ‰é™æ€§â€”â€”æ­£å¦‚ Eric Evans åœ¨å¼€å±±ä¹‹ä½œä¸­å¼ºè°ƒçš„â€œæ¨¡å‹æ°¸è¿œæ˜¯å¯¹ç°å®çš„è¿‘ä¼¼æŠ½è±¡â€ã€‚ä½†æ­£æ˜¯è¿™ç§å±€é™æ€§ï¼Œå‡¸æ˜¾äº† DDD æ–¹æ³•è®ºçš„æˆ˜ç•¥æ„ä¹‰ï¼š å®ƒé€šè¿‡\"æˆ˜ç•¥è®¾è®¡\"æ„å»ºä¸šåŠ¡å…¨æ™¯å›¾ï¼Œè¿ç”¨é™ç•Œä¸Šä¸‹æ–‡åˆ’å®šé¢†åŸŸè¾¹ç•Œï¼Œé€šè¿‡\"æˆ˜æœ¯è®¾è®¡\"è½åœ°èšåˆæ ¹ã€å®ä½“/å€¼å¯¹è±¡ç­‰æ¨¡å¼ï¼Œå½¢æˆåº”å¯¹å¤æ‚æ€§çš„ç»“æ„åŒ–è§£å†³æ–¹æ¡ˆã€‚ éœ€è¦ç‰¹åˆ«æŒ‡å‡ºçš„æ˜¯ï¼ŒDDD çš„å¤æ‚æ€§å¹¶éæ–¹æ³•è®ºæœ¬èº«çš„ç¼ºé™·ï¼Œè€Œæ˜¯å…¶åº”å¯¹ç°å®ä¸šåŠ¡å¤æ‚åº¦çš„å¿…è¦ä»£ä»·ã€‚è¿™ç§å¤æ‚æ€§ä½“ç°åœ¨ä¸‰ä¸ªç»´åº¦ï¼š è®¤çŸ¥å¤æ‚æ€§ï¼šè¦æ±‚å¼€å‘å›¢é˜Ÿä¸é¢†åŸŸä¸“å®¶å…±å»º\"é€šç”¨è¯­è¨€\"ï¼Œå®ç°ä¸šåŠ¡æ¦‚å¿µä¸ä»£ç æ¨¡å‹çš„ç²¾å‡†æ˜ å°„ã€‚ æ¶æ„å¤æ‚æ€§ï¼šé€šè¿‡åˆ†å±‚æ¶æ„å®ç°ä¸šåŠ¡é€»è¾‘ä¸æŠ€æœ¯å®ç°çš„è§£è€¦ï¼Œé‡‡ç”¨é˜²è…å±‚å¤„ç†ç³»ç»Ÿé›†æˆé—®é¢˜ã€‚ æ¼”è¿›å¤æ‚æ€§ï¼šå€ŸåŠ©å­åŸŸåˆ’åˆ†å’Œä¸Šä¸‹æ–‡æ˜ å°„ï¼Œä¸ºæŒç»­æ¼”è¿›çš„ä¸šåŠ¡æä¾›å¯æ‰©å±•çš„æ¶æ„åŸºç¡€ã€‚ å¯¹äºå®è·µè€…è€Œè¨€ï¼ŒDDD çš„ä»·å€¼ä¸åœ¨äºæä¾›å®Œç¾æ— ç¼ºçš„ç»ˆææ–¹æ¡ˆï¼Œè€Œæ˜¯ä¸º VUCA ç¯å¢ƒä¸‹çš„ç³»ç»Ÿå»ºè®¾æä¾›åŸºç¡€æ€§æŒ‡å¼•ã€‚å…¶æ ¸å¿ƒæ€æƒ³â€”â€”æ— è®ºæ˜¯é€šè¿‡é™ç•Œä¸Šä¸‹æ–‡å®ç°çš„é¢†åŸŸè‡ªæ²»ï¼Œè¿˜æ˜¯é€šè¿‡èšåˆæ ¹ç»´æŠ¤çš„ä¸šåŠ¡ä¸€è‡´æ€§â€”â€”éƒ½ä¸ºæ§åˆ¶è½¯ä»¶ç†µå¢æä¾›äº†å¯è½åœ°çš„æ¨¡å¼åº“ã€‚å³ä¾¿ä¸å®Œå…¨é‡‡ç”¨DDD å®Œæ•´ä½“ç³»ï¼Œå…¶é¢†åŸŸå»ºæ¨¡æ€æƒ³ã€åˆ†å±‚æ¶æ„ç†å¿µç­‰æ ¸å¿ƒè¦ç´ ï¼Œä»èƒ½æ˜¾è‘—æå‡å¤æ‚ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§å’Œæ¼”è¿›èƒ½åŠ›ã€‚è¿™ç§å¼€æ”¾åŒ…å®¹çš„å“²å­¦ï¼Œæ°æ˜¯ DDD å†ç»äºŒåå¹´ä»ä¿æŒç”Ÿå‘½åŠ›çš„å…³é”®æ‰€åœ¨ã€‚ è´«è¡€æ¨¡å‹ vs. å……è¡€æ¨¡å‹ è´«è¡€æ¨¡å‹ï¼šæŒ‡çš„æ˜¯åªæœ‰å±æ€§è€Œæ²¡æœ‰è¡Œä¸ºçš„æ¨¡å‹ã€‚ å……è¡€æ¨¡å‹ï¼šæŒ‡çš„æ˜¯æ—¢æœ‰å±æ€§åˆæœ‰è¡Œä¸ºçš„æ¨¡å‹ã€‚ ç¬”è€…è¿‡å¾€çš„å®è·µä¸­ï¼ŒåŸºæœ¬ä¸Šéƒ½ä½¿ç”¨ç±»ä¼¼äº controllerâ†’serviceâ†’repository[model] çš„ä¸‰å±‚æ¶æ„ï¼š conrtoller è´Ÿè´£æš´éœ²å¯¹å¤–æ¥å£ã€‚ service è´Ÿè´£æ‰§è¡Œæ‰€æœ‰çš„ä¸šåŠ¡é€»è¾‘ã€‚ repository å¤æ‚æ•°æ®çš„å­˜å‚¨å’Œç¼“å­˜ï¼ŒåŒ…å«æ•°æ®å¯¹è±¡ model çš„å®šä¹‰ã€‚ åœ¨è¿™ä¸ªæ¨¡å¼ä¸‹ï¼ŒåŸºæœ¬ä¸Šæ‰€æœ‰çš„æ ¸å¿ƒé€»è¾‘éƒ½å……æ–¥åœ¨ service å±‚ä¸­ï¼Œæ‰€ä»¥ service å±‚ä¸€èˆ¬éƒ½ä¼šéå¸¸å¤§ï¼Œå®ƒè¦æ‰®æ¼”å¤šé¢æ‰‹ï¼Œå³è¦è´Ÿè´£è·Ÿå„ä¸ªæ¨¡å—åä½œï¼Œè¿˜è¦è´Ÿè´£å¤„ç†å…·ä½“çš„ä¸šåŠ¡è§„åˆ™ï¼Œæœ€ç»ˆå®Œæˆä¸€ä¸ªä¸šåŠ¡è¡Œä¸ºã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œmodel å³ä¸ºè´«è¡€æ¨¡å‹ï¼Œå› ä¸ºé€»è¾‘éƒ½ç»™ service å¤„ç†äº†ï¼Œè¿™ç§æ¶æ„ä¹Ÿç§°ä¸ºè´«è¡€ä¸‰å±‚æ¶æ„ã€‚ åœ¨ DDD çš„ç†å¿µä¸‹ï¼Œå¾ˆå¤šçš„æ ¸å¿ƒä¸šåŠ¡æ¦‚å¿µéƒ½ä¼šè¢«å»ºæ¨¡ä¸ºã€Œé¢†åŸŸå¯¹è±¡ã€ï¼Œè¿™äº›ã€Œé¢†åŸŸå¯¹è±¡ã€æœ¬èº«å°±æ˜¯ä¸€ç§ä¸šåŠ¡è§„åˆ™çš„ä½“ç°ï¼Œæ‰€ä»¥æŠŠä¸šåŠ¡çš„å¤„ç†é€»è¾‘ï¼Œéƒ½å½’å±åˆ°è¿™äº›ã€Œé¢†åŸŸå¯¹è±¡ã€çš„è¡Œä¸ºå½“ä¸­äº†ï¼Œå³æ‰€è°“çš„å……è¡€æ¨¡å‹ã€‚ åœ¨è¿™ä¸ªç†å¿µä¸‹ï¼Œä¸€ä¸ªä¼˜åŒ–åçš„å……è¡€å››å±‚æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å……è¡€å››å±‚æ¶æ„ è´«è¡€æ¨¡å‹æ¨èåœºæ™¯ï¼šä¸šåŠ¡ç®€å•ã€è¿­ä»£å¿«é€Ÿã€å›¢é˜ŸæŠ€æœ¯æ ˆåä¼ ç»Ÿï¼ˆå¦‚ Spring Boot+MyBatisï¼‰æ—¶ï¼Œé¿å…è¿‡åº¦è®¾è®¡ã€‚ å……è¡€æ¨¡å‹æ¨èåœºæ™¯ï¼šä¸šåŠ¡å¤æ‚ã€éœ€é•¿æœŸæ¼”è¿›ï¼ˆå¦‚æ ¸å¿ƒäº¤æ˜“ç³»ç»Ÿï¼‰ã€å›¢é˜Ÿå…·å¤‡ DDD ç»éªŒæ—¶ï¼Œé€šè¿‡å®ä½“ã€å€¼å¯¹è±¡ã€é¢†åŸŸæœåŠ¡ç­‰æˆ˜æœ¯è®¾è®¡ç†å¿µé™ä½ç³»ç»Ÿç†µå¢ã€‚ æ··åˆä½¿ç”¨çš„åœºæ™¯ï¼šéƒ¨åˆ†æ ¸å¿ƒé¢†åŸŸç”¨å……è¡€æ¨¡å‹ï¼ˆå¦‚è®¢å•ã€æ”¯ä»˜ï¼‰ï¼Œéæ ¸å¿ƒæ¨¡å—ç”¨è´«è¡€æ¨¡å‹ï¼ˆå¦‚æ—¥å¿—ã€é…ç½®ï¼‰ï¼Œå¹³è¡¡æ•ˆç‡ä¸è´¨é‡ã€‚ å®é™…ä¸Šï¼Œå……è¡€æ¨¡å‹å› å…¶çŠ¶æ€å®Œæ•´ï¼Œé€‚åˆè¿›è¡ŒçŠ¶æ€å˜æ›´ç±»çš„æ“ä½œï¼Œä»¥ç¡®ä¿ä¸šåŠ¡æ“ä½œç¬¦åˆé¢†åŸŸè§„åˆ™ï¼›è´«è¡€æ¨¡å‹ç”±äºå…¶è½»é‡çº§ï¼Œæ›´é€‚åˆä½œä¸ºä¸ä¼šæ¶‰åŠçŠ¶æ€å˜æ›´çš„æ“ä½œçš„æ•°æ®å®¹å™¨ã€‚è¿™å…¶å®å°±æ˜¯ CQRS çš„ç†å¿µã€‚ æ¦‚å¿µæ¸…å• æˆ˜æœ¯è®¾è®¡ å®ä½“ å®šä¹‰ï¼šä¼šéšç€ä¸šåŠ¡å˜åŒ–å‘ç”Ÿå˜åŒ–çš„ä¸šåŠ¡æ¦‚å¿µå«ä½œå®ä½“å¯¹è±¡ã€‚å…³é”®ç‚¹ï¼šå®ä½“éœ€è¦å”¯ä¸€è¡¨ç¤º å€¼å¯¹è±¡ å®šä¹‰ï¼šä¸€äº›å¯¹è±¡åœ¨è¡¨è¾¾ä¸šåŠ¡æ¦‚å¿µæ—¶æ˜¯å¿…é¡»çš„ï¼Œå¯ä¸šåŠ¡å¹¶ä¸å›´ç»•ç€å®ƒä»¬è¿›è¡Œï¼Œå®ƒä»¬ä»…æ˜¯å¯¹è¿™äº›é‡è¦ä¸šåŠ¡æ¦‚å¿µçš„æè¿°ï¼Œè¿™ä¸€ç±»å¯¹è±¡å«ä½œå€¼å¯¹è±¡ã€‚å…³é”®ç‚¹ï¼šå€¼å¯¹è±¡çš„æ„ä¹‰å–å†³äºå±æ€§ï¼Œåªè¦å¯¹è±¡çš„å±æ€§ä¸€æ¨¡ä¸€æ ·ï¼Œé‚£ä¹ˆå¯¹è±¡å°±æ˜¯ç›¸åŒçš„ã€‚å°½é‡æŠŠå€¼å¯¹è±¡å®ç°ä¸ºä¸å¯å˜å¯¹è±¡ã€‚ é¢†åŸŸæœåŠ¡ å®šä¹‰ï¼šé¢†åŸŸæœåŠ¡è‡ªèº«æ˜¯æ²¡æœ‰æ•°æ®çš„ï¼Œåªæ˜¯è¡¨è¾¾äº†æŸç§ä¸šåŠ¡è®¡ç®—é€»è¾‘ï¼Œæˆ–è€…ä¸šåŠ¡çš„æŸç§ç­–ç•¥ã€‚å…³é”®ç‚¹ï¼šé¢†åŸŸæœåŠ¡æ˜¯æ— çŠ¶æ€çš„ã€‚åªæœ‰åœ¨ç¡®å®è¡¨è¾¾äº†ä¸€ä¸ªç›¸å¯¹ç‹¬ç«‹çš„ä¸šåŠ¡æ¦‚å¿µæˆ–è€…ä¸šåŠ¡ç­–ç•¥ï¼Œå¹¶ä¸”ä¸èƒ½ç®€å•åœ°æŠŠå®ƒå½’ç»“åˆ°æŸä¸ªæ—¢æœ‰çš„ä¸šåŠ¡å¯¹è±¡ä¸Šæ—¶ï¼Œæ‰æ˜¯ä¸€ä¸ªçœŸæ­£çš„é¢†åŸŸæœåŠ¡ã€‚ é¢†åŸŸäº‹ä»¶ å®šä¹‰ï¼šé¢†åŸŸäº‹ä»¶ä»£è¡¨ä»ä¸šåŠ¡ä¸“å®¶è§†è§’çœ‹åˆ°çš„æŸç§é‡è¦çš„äº‹æƒ…å‘ç”Ÿäº†ã€‚å…³é”®ç‚¹ï¼šé¢†åŸŸäº‹ä»¶æ˜¯ä¸€ç§ç‰¹æ®Šçš„å€¼å¯¹è±¡ã€‚åº”è¯¥æ ¹æ®é™ç•Œä¸Šä¸‹æ–‡ä¸­çš„é€šç”¨è¯­è¨€æ¥å‘½åäº‹ä»¶ï¼šAccountActivitedã€‚åº”è¯¥å°†äº‹ä»¶å»ºæ¨¡æˆå€¼å¯¹è±¡æˆ–è´«è¡€å¯¹è±¡ã€‚ èšåˆ å®šä¹‰ï¼šèšåˆä»æœ¬è´¨ä¸Šè®²æ˜¯åœ¨åŸºç¡€çš„æ„é€ å—ä¸Šå¢åŠ äº†ä¸€å±‚è¾¹ç•Œï¼Œç”¨è¾¹ç•ŒæŠŠé‚£äº›ç´§å¯†ç›¸å…³çš„å¯¹è±¡æ”¾åˆ°äº†ä¸€èµ·ã€‚å…³é”®ç‚¹ï¼šç´§å¯†ç›¸å…³çš„å¯¹è±¡å­˜åœ¨æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼›ç¼ºä¹è¾¹ç•Œæ—¶ï¼Œç»´æŠ¤æ•°æ®ä¸€è‡´æ€§æ˜¯å›°éš¾çš„ï¼›åˆ’åˆ†è¾¹ç•Œçš„å…³é”®åœ¨äºæ—¢ä¸è¦è®©æ•´ä¸ªç³»ç»Ÿæˆä¸ºä¸€ä¸ªæ•´ä½“ï¼Œåˆè®©æ¯ä¸ªå•ç‹¬åˆ’åˆ†å‡ºçš„èšåˆå…·æœ‰æ˜ç¡®çš„ä¸šåŠ¡æ„ä¹‰ï¼›èšåˆéœ€è¦å…³æ³¨ä¸‰æ¡æ³•åˆ™ï¼šç”Ÿå‘½å‘¨æœŸä¸€è‡´æ€§ï¼šå¦‚æœä¸€ä¸ªå¯¹è±¡åœ¨èšåˆæ ¹æ¶ˆå¤±ä¹‹åä»ç„¶æœ‰æ„ä¹‰ï¼Œé‚£ä¹ˆè¯´æ˜æ­¤æ—¶åœ¨ç³»ç»Ÿä¸­å¿…ç„¶å­˜åœ¨èƒ½å¤Ÿè®¿é—®è¯¥å¯¹è±¡çš„æ–¹æ³•ã€‚è¿™å’Œèšåˆçš„å®šä¹‰çŸ›ç›¾ï¼Œæ‰€ä»¥èšåˆå†…çš„å…¶ä»–å…ƒç´ å¿…ç„¶åœ¨èšåˆæ ¹æ¶ˆå¤±åå¤±æ•ˆã€‚é—®é¢˜åŸŸä¸€è‡´æ€§ï¼šä¸å±äºåŒä¸€ä¸ªé—®é¢˜åŸŸçš„å¯¹è±¡ï¼Œä¸åº”è¯¥å‡ºç°åœ¨åŒä¸€ä¸ªèšåˆä¸­ã€‚å°½é‡å°çš„èšåˆï¼šèšåˆçš„æœ¬è´¨ä½œç”¨æ˜¯æå‡å¯¹è±¡ç³»ç»Ÿçš„ç²’åº¦ï¼Œç¡®ä¿ä¸€è‡´æ€§ã€é™ä½å¤æ‚åº¦ã€‚ä¸è¿‡ï¼Œç²’åº¦ç»ä¸æ˜¯è¶Šå¤§è¶Šå¥½ã€‚å¦‚æœèšåˆçš„ç²’åº¦å¤ªå¤§ï¼Œé‚£å†…éƒ¨çš„é€»è¾‘å¤æ‚åº¦ä¹Ÿä¼šå¤§å¤§å¢åŠ è¿˜ä¼šå½±å“åˆ°å¤ç”¨åº¦ã€‚å› æ­¤ï¼Œè¦èƒ½å¤Ÿæ¯”è¾ƒå®¹æ˜“åœ°æ–­å¼€èšåˆã€‚ èµ„æºåº“ å®šä¹‰ï¼šå¯¹äºæŸ¥è¯¢ã€åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤æ•°æ®çš„æ“ä½œï¼Œé¢†åŸŸæ¨¡å‹ä½¿ç”¨â€œèµ„æºåº“(Repository)â€è¿™ä¸ªæ¦‚å¿µæ¥æ‰¿è½½å®ƒä»¬ã€‚å…³é”®ç‚¹ï¼šä¸€ä¸ªèšåˆå¯¹åº”ä¸€ä¸ªèµ„æºåº“ï¼Œåº”ä»¥èšåˆæ ¹å‘½åèµ„æºåº“ï¼Œé™¤äº†èšåˆæ ¹ä¹‹å¤–çš„å…¶ä»–å¯¹è±¡ï¼Œéƒ½ä¸åº”è¯¥æä¾›èµ„æºåº“å¯¹è±¡ã€‚ å·¥å‚ å®šä¹‰ï¼šå·¥å‚ç”¨äºæ„å»ºèšåˆã€‚å…³é”®ç‚¹ï¼šä¸€ä¸ªèšåˆå¾€å¾€åŒ…å«å¤šä¸ªå¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡çš„æ•°æ®ä¹‹é—´åˆå¯èƒ½å­˜åœ¨è”ç³»ï¼Œå¦‚æœå…è®¸åˆ†åˆ«åˆ›å»ºè¿™äº›å¯¹è±¡ï¼Œå°±ä¼šè®©èšåˆæ˜¯ä¸šåŠ¡å®Œæ•´æ€§çš„å•å…ƒè¿™ä¸ªå®šä¹‰é¢ä¸´å¤±è´¥ã€‚ æˆ˜ç•¥è®¾è®¡ ç»Ÿä¸€è¯­è¨€ å®šä¹‰ï¼šä¸ä¸šåŠ¡ä¸“å®¶åä½œå®šä¹‰å…¨å›¢é˜Ÿé€šç”¨çš„æœ¯è¯­è¡¨ï¼Œæ¶ˆé™¤æ²Ÿé€šæ­§ä¹‰ã€‚å…³é”®ç‚¹ï¼šåŒä¸€ä¸ªæ¦‚å¿µåœ¨ä¸åŒçš„ä¸Šä¸‹æ–‡ä¸­å¯èƒ½å­˜åœ¨ä¸åŒçš„å«ä¹‰ï¼›åŒä¸€ä¸ªæ¦‚å¿µåœ¨åŒä¸€ä¸Šä¸‹æ–‡ä¸­çš„ä¸åŒç¯èŠ‚ï¼Œä¹Ÿå¯èƒ½å­˜åœ¨ä¸åŒçš„å«ä¹‰ï¼Œéœ€è¦éå¸¸æ˜ç¡®æ¸…æ™°çš„ç•Œå®šï¼Œé™ä½æ²Ÿé€šæˆæœ¬ã€‚ å­åŸŸ å®šä¹‰ï¼šå­åŸŸæ˜¯å¯¹ä¸šåŠ¡é¢†åŸŸçš„é€»è¾‘åˆ’åˆ†ï¼Œç”¨äºåˆ†è§£å¤æ‚é—®é¢˜ã€‚é€šå¸¸åˆ†ä¸ºæ ¸å¿ƒå­åŸŸï¼ˆä¸šåŠ¡æ ¸å¿ƒç«äº‰åŠ›ï¼‰ã€æ”¯æ’‘å­åŸŸï¼ˆè¾…åŠ©æ ¸å¿ƒä¸šåŠ¡ï¼‰å’Œé€šç”¨å­åŸŸï¼ˆå¯å¤ç”¨çš„æ ‡å‡†åŒ–èƒ½åŠ›ï¼‰ã€‚å…³é”®ç‚¹ï¼šå› ä¸šåŠ¡ç›®æ ‡ã€å›¢é˜Ÿå®šä½å’Œç»„ç»‡å‘å±•é˜¶æ®µç­‰æ–¹é¢çš„ä¸åŒï¼Œè¿™ä¸‰ä¸ªå­åŸŸçš„åˆ’åˆ†å¹¶éä¸€æˆä¸å˜ï¼Œè€Œæ˜¯ä¼šäº’ç›¸è½¬æ¢ã€‚ é™ç•Œä¸Šä¸‹æ–‡ å®šä¹‰ï¼šé™ç•Œä¸Šä¸‹æ–‡æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªè‡ªæ²»çš„å°ä¸–ç•Œï¼Œå®ƒæœ‰å®Œå¤‡çš„èŒè´£ï¼Œè¿˜æœ‰æ¸…æ™°çš„è¾¹ç•Œã€‚å…³é”®ç‚¹ï¼šä¸€ä¸ªå­åŸŸçš„ä¸€åˆ‡èµ„äº§ï¼ŒåŒ…æ‹¬é¢†åŸŸæ¨¡å‹ã€æ•°æ®åº“ã€åŒ…ã€å¯æ‰§è¡Œç¨‹åºã€æ¥å£å£°æ˜ç­‰ï¼Œéƒ½åº”è¯¥å°è£…åœ¨é™ç•Œä¸Šä¸‹æ–‡ä¸­ï¼Œé¿å…è·¨è¶Šè¾¹ç•Œã€‚å¦‚ä½•å¹³è¡¡è¾¹ç•Œçš„ä»·å€¼å’Œä¸åˆ©å½±å“ï¼Œæ˜¯åˆ’åˆ†è¾¹ç•Œæ—¶è¦åšçš„ä¸€ç§é‡è¦å–èˆã€‚ä¸€ä¸ªè¾ƒä¸ºç¨³å¦¥çš„ç­–ç•¥æ˜¯è€ƒè™‘è®¤çŸ¥çš„æ¸è¿›ç‰¹å¾ï¼Œä¸è¦è¿‡æ—©éš”ç¦»ã€‚åœ¨å·²ç»ç¡®å®šçš„è¾¹ç•Œä¸Šè¿›è¡Œåˆ’åˆ†ï¼Œå»¶ç¼“åˆ’åˆ†é‚£äº›å°šå…·æ¨¡ç³Šæ€§çš„è¾¹ç•Œï¼Œåœ¨è¿™äº›è¾¹ç•Œé€æ¸å˜å¾—æ¸…æ™°æ—¶å†åˆ†ç¦»å®ƒä»¬ã€‚ ä¸Šä¸‹æ–‡æ˜ å°„ å®šä¹‰ï¼šé™ç•Œä¸Šä¸‹æ–‡çº¦å®šäº†åŸºäºé¢†åŸŸæ¨¡å‹çš„æ¶æ„å±‚æ¬¡çš„è®¾è®¡åˆ†è§£ï¼Œè€Œåˆ†è§£å¿…ç„¶æ„å‘³ç€é›†æˆå’Œåä½œã€‚ä¸Šä¸‹æ–‡æ˜ å°„å°±æ˜¯å¯¹é™ç•Œä¸Šä¸‹æ–‡ä¹‹é—´çš„åä½œå…³ç³»çš„æ¨¡å¼æ€»ç»“ã€‚å…³é”®ç‚¹ï¼šåœ¨è¾¹ç•Œä¸Šå®Œæˆæ¦‚å¿µæ˜ å°„æ˜¯ä¸€ç§åŸºæœ¬æ¨¡å¼ã€‚é€šè¿‡åœ¨åº”ç”¨å±‚ç»„è£…æˆ–è€…ä½¿ç”¨é€‚é…å™¨å®Œæˆæ¦‚å¿µæ˜ å°„ï¼Œå¯ä»¥ä¿æŒé¢†åŸŸæ¦‚å¿µçš„æ¸…æ™°ï¼Œé¿å…é¢†åŸŸæ¨¡å‹é­åˆ°ä¸å¿…è¦çš„æ±¡æŸ“ã€‚é˜²è…å±‚æ¨¡å¼ã€æ ‡å‡†å¼€æ”¾æœåŠ¡æ¨¡å¼ã€å®¢æˆ·-ä¾›åº”å•†æ¨¡å¼ã€è¿½éšè€…æ¨¡å¼ã€‚ ä¸²è®² åœ¨åº”å¯¹å¤æ‚ä¸šåŠ¡ç³»ç»Ÿæ—¶ï¼ŒDDD é€šè¿‡åˆ†æ²»ç­–ç•¥å°†ä¸šåŠ¡é¢†åŸŸæ‹†åˆ†ä¸ºå¤šä¸ªå­åŸŸï¼ˆå¦‚ç”µå•†ç³»ç»Ÿçš„è®¢å•ã€æ”¯ä»˜å­åŸŸï¼‰ï¼Œæ¯ä¸ªå­åŸŸå¯¹åº”ä¸€ä¸ªé™ç•Œä¸Šä¸‹æ–‡â€”â€”è¿™æ˜¯æŠ€æœ¯ä¸ä¸šåŠ¡å¯¹é½çš„å…³é”®è¾¹ç•Œï¼Œæ—¢æ‰¿è½½é¢†åŸŸæ¨¡å‹çš„å®ç°ï¼Œä¹Ÿé€šè¿‡ä¸Šä¸‹æ–‡æ˜ å°„ï¼ˆå¦‚é˜²è…å±‚ã€å…±äº«å†…æ ¸ç­‰æ¨¡å¼ï¼‰å®ç°è·¨å­åŸŸåä½œï¼Œé¿å…æ¨¡å‹æ±¡æŸ“ã€‚ é™ç•Œä¸Šä¸‹æ–‡å†…çš„é¢†åŸŸå¯¹è±¡æ˜¯ä¸šåŠ¡é€»è¾‘çš„è½½ä½“ï¼šå…·å¤‡å”¯ä¸€æ ‡è¯†å’Œç”Ÿå‘½å‘¨æœŸçš„å®ä½“ï¼ˆå¦‚è®¢å•å®ä½“é€šè¿‡ ID è·Ÿè¸ªçŠ¶æ€å˜åŒ–ï¼‰ã€æè¿°ç‰¹å¾ä¸”ä¸å¯å˜çš„å€¼å¯¹è±¡ï¼ˆå¦‚åœ°å€ç”±çœå¸‚æ„æˆï¼Œä¿®æ”¹éœ€æ•´ä½“æ›¿æ¢ï¼‰ï¼Œä»¥åŠé€šè¿‡èšåˆæ ¹ç»Ÿä¸€æ“ä½œä¿è¯ä¸€è‡´æ€§çš„èšåˆï¼ˆå¦‚è®¢å•èšåˆæ ¹ç®¡ç†è®¢å•é¡¹å’Œé…é€ä¿¡æ¯ï¼‰ã€‚å½“ä¸šåŠ¡é€»è¾‘è·¨è¶Šå¤šä¸ªèšåˆæ—¶ï¼Œç”±æ— çŠ¶æ€çš„é¢†åŸŸæœåŠ¡åè°ƒï¼ˆå¦‚æ”¯ä»˜è®¡ç®—éœ€æ•´åˆè®¢å•ã€è´¦æˆ·èšåˆï¼‰ã€‚ å¯¹è±¡çš„åˆ›å»ºä¸æŒä¹…åŒ–åˆ†åˆ«ç”±å·¥å‚ï¼ˆå°è£…å¤æ‚åˆå§‹åŒ–é€»è¾‘ï¼‰å’Œèµ„æºåº“ï¼ˆéš”ç¦»å­˜å‚¨ç»†èŠ‚ï¼‰è´Ÿè´£ï¼Œè€Œé¢†åŸŸäº‹ä»¶ï¼ˆå¦‚è®¢å•æ”¯ä»˜æˆåŠŸäº‹ä»¶ï¼‰åˆ™é©±åŠ¨è·¨ä¸Šä¸‹æ–‡çš„å¼‚æ­¥åä½œã€‚ æˆ˜æœ¯è®¾è®¡ factory factory ç”¨äºæ„å»ºå¤æ‚çš„é¢†åŸŸå¯¹è±¡ã€‚ repository åªæœ‰èšåˆæ ¹æœ‰ repositoryã€‚ repository å°±åªæä¾› load å’Œ save åŠŸèƒ½ï¼Œä¸”è¦ä¿è¯äº‹åŠ¡ä¸€è‡´æ€§ã€‚ å°½å¯èƒ½æä¾›è¡Œçº§çš„ repositoryï¼Œè€Œä¸æ˜¯è¡¨çº§çš„ repositoryï¼Œå¯¹äºè¡¨çº§çš„ repositoryï¼Œå¯ä»¥æŠ½æˆä¸€ä¸ªé¢†åŸŸæœåŠ¡ã€‚ è®¾è®¡æ¨¡å¼ è´£ä»»é“¾æ¨¡å¼ å°†è¯·æ±‚çš„å‘é€è€…å’Œæ¥å—è€…è§£è€¦ï¼Œä½¿å¤šä¸ªå¯¹è±¡éƒ½æœ‰æœºä¼šå¤„ç†è¯·æ±‚ã€‚ è´£ä»»é“¾æ¨¡å¼çš„ä½¿ç”¨è¦ç‚¹åœ¨äºè¦å°†ç»´æŠ¤è´£ä»»é“¾çš„ä»£ç å’Œä¸šåŠ¡ä»£ç åˆ†å¼€ã€‚ åœ¨ DDD ä¸­ä½¿ç”¨è´£ä»»é“¾æ¨¡å¼æ—¶ï¼Œåº”åˆ›å»ºä¸€ä¸ªé¢†åŸŸæœåŠ¡ï¼Œåœ¨é¢†åŸŸæœåŠ¡ä¸­å®Œæˆè´£ä»»é“¾çš„åˆ›å»ºå’Œæ‰§è¡Œã€‚ å°½é‡ä¸è¦åœ¨è´£ä»»é“¾çš„å¤„ç†å™¨ä¸­é€šè¿‡ set ä¿®æ”¹é¢†åŸŸå¯¹è±¡ï¼ˆèšåˆæ ¹ï¼‰çš„çŠ¶æ€ï¼Œè´£ä»»é“¾åº”ä»…ç”¨äºæŸäº›å€¼çš„è®¡ç®—ï¼Œæœ€ç»ˆå°†è®¡ç®—ç»“æœäº¤ç»™èšåˆæ ¹å®Œæˆä¸šåŠ¡æ“ä½œã€‚ ç¬”è€…å®ç°äº†ä¸€ä¸ªå¿«é€Ÿæ„å»ºè´£ä»»é“¾çš„å·¥å…·ï¼š https://github.com/hedon954/devkit-go/blob/main/designmode/responsibility/builder.gohttps://github.com/hedon954/devkit-go/blob/main/designmode/responsibility/builder.go ç­–ç•¥æ¨¡å¼ å…è®¸åœ¨è¿è¡Œæ—¶æ ¹æ®éœ€è¦é€‰æ‹©ä¸åŒçš„å®ç°ã€‚ åœ¨ DDD ä¸­ä½¿ç”¨ç­–ç•¥æ¨¡å¼æ—¶ï¼Œé€šå¸¸å…ˆå®šä¹‰ä¸€ä¸ªé¢†åŸŸæœåŠ¡æ¥å£ï¼Œå†åœ¨å…¶å®ç°ç±»ä¸­å®Œæˆç­–ç•¥çš„åŠ è½½ã€é€‰æ‹©å’Œæ‰§è¡Œã€‚ æ³¨æ„å±è”½ç­–ç•¥æ¨¡å¼çš„å®ç°ç»†èŠ‚ï¼Œé¿å…ä¸Šå±‚å…³æ³¨é¢†åŸŸæœåŠ¡å†…çš„è®¾è®¡æ¨¡å¼ç»†èŠ‚ã€‚ æ¡¥æ¥æ¨¡å¼ æ—¨åœ¨é€šè¿‡è§£è€¦æŠ½è±¡å’Œå®ç°ï¼Œä½¿ä¸¤è€…èƒ½å¤Ÿç‹¬ç«‹æ‰©å±•å’Œå˜åŒ–ã€‚ å¤šç»´è§£è€¦æœºåˆ¶ï¼šæ¡¥æ¥æ¨¡å¼é€šè¿‡ç»„åˆ/èšåˆå…³ç³»æ›¿ä»£ç»§æ‰¿å…³ç³»ï¼Œå°†åŸæœ¬ç´§å¯†è€¦åˆçš„æŠ½è±¡å±‚ï¼ˆåŠŸèƒ½å®šä¹‰ï¼‰ä¸å®ç°å±‚ï¼ˆå…·ä½“æ“ä½œï¼‰åˆ†ç¦»ä¾‹å¦‚é¥æ§å™¨ï¼ˆæŠ½è±¡ï¼‰ä¸ç”µè§†ï¼ˆå®ç°ï¼‰çš„åä½œï¼Œé¥æ§å™¨é€šè¿‡æ¥å£æ§åˆ¶ç”µè§†ï¼Œæ— éœ€å…³æ³¨å…·ä½“å“ç‰Œã€‚ æ­£äº¤æ‰©å±•èƒ½åŠ›ï¼šæ”¯æŒä¸¤ä¸ªç‹¬ç«‹å˜åŒ–ç»´åº¦ï¼ˆå¦‚æ¶ˆæ¯ç±»å‹ä¸é€šçŸ¥æ¸ é“ã€å›¾å½¢ä¸æ¸²æŸ“æ–¹å¼ï¼‰ï¼Œé¿å…ç±»æ•°é‡å‘ˆæŒ‡æ•°çº§å¢é•¿ï¼ˆMÃ—N ç»„åˆé—®é¢˜ï¼‰ã€‚ç”µå•†ç‰©æµç³»ç»Ÿä¸­ï¼Œæ–°å¢å¾®ä¿¡é€šçŸ¥æ¸ é“æ—¶ï¼Œæ— éœ€ä¿®æ”¹æ‰€æœ‰æ¶ˆæ¯ç±»å³å¯å®ç°æ‰©å±•ã€‚ è§„çº¦æ¨¡å¼ è§„çº¦æ¨¡å¼æ˜¯ä¸€ç§ç”¨äºå®šä¹‰ä¸šåŠ¡é¢†åŸŸä¸­è§„åˆ™å’Œçº¦æŸçš„æ¨¡å¼ï¼Œé€šå¸¸ç”±è§„çº¦æ¥å£ï¼ˆSpecificationï¼‰å’ŒéªŒè¯å™¨ï¼ˆValidatorï¼‰ä¸¤ä¸ªéƒ¨åˆ†ç»„æˆã€‚ åœ¨ DDD ä¸­ï¼Œè§„çº¦æ¨¡å¼å¹¶ä¸æ˜¯åœ¨èšåˆæ ¹è¿›è¡Œä¸šåŠ¡æ“ä½œä¹‹å‰åšå‰ç½®æ ¡éªŒï¼Œè€Œæ˜¯åœ¨èšåˆæ ¹å®Œæˆä¸šåŠ¡æ“ä½œä¹‹ååšåç½®æ ¡éªŒï¼Œç¡®ä¿ Repository ä¿å­˜çš„èšåˆæ ¹ç¬¦åˆä¸šåŠ¡è§„åˆ™ã€‚ é€‚é…å™¨æ¨¡å¼ å°†è¢«é€‚é…è€…ï¼ˆAdapteeï¼‰çš„æ¥å£è½¬æ¢ä¸ºç›®æ ‡æ¥å£ï¼ˆTargetï¼‰ï¼Œä½¿åŸæœ¬å› æ¥å£ä¸å…¼å®¹è€Œæ— æ³•ååŒå·¥ä½œçš„ç±»èƒ½å¤ŸååŒã€‚ åœ¨ DDD ä¸­ï¼Œå¯ä»¥ä½¿ç”¨é€‚é…å™¨æ¨¡å¼æ¥å®ç°é˜²è…å±‚ï¼Œä»¥å°†å¤–éƒ¨ä¸Šä¸‹æ–‡æ¥å£ï¼ˆå¦‚å¼€æ”¾ä¸»æœºæœåŠ¡ï¼‰è¿”å›çš„æ¨¡å‹è½¬æ¢ä¸ºæœ¬åœ°ä¸Šä¸‹æ–‡å®šä¹‰çš„é¢†åŸŸæ¨¡å‹ï¼Œå¹¶å°†æœ¬åœ°ä¸Šä¸‹æ–‡çš„æ“ä½œè½¬æ¢ä¸ºå¯¹å¤–éƒ¨ä¸Šä¸‹æ–‡çš„æ“ä½œã€‚å¯ä»¥æœ‰æ•ˆéš”ç¦»å¤–éƒ¨ä¸Šä¸‹æ–‡çš„é¢†åŸŸæ¨¡å‹ï¼Œé¿å…äº’ç›¸æ±¡æŸ“ã€‚ é¢†åŸŸäº‹ä»¶ å¹‚ç­‰æ€§ é¢†åŸŸäº‹ä»¶çš„å®šä¹‰ é¢†åŸŸäº‹ä»¶æ˜¯é¢†åŸŸæ¨¡å‹çš„ç»„æˆéƒ¨åˆ†ï¼Œå®ƒé€šå¸¸ç”±èšåˆæ ¹äº§ç”Ÿï¼Œå¹¶è¢«å…¶ä»–èšåˆæˆ–è€…é™ç•Œä¸Šä¸‹æ–‡è®¢é˜…å’Œå¤„ç†ï¼Œè§¦å‘ç›¸åº”çš„ä¸šåŠ¡é€»è¾‘ã€‚ æ³¨æ„ç‚¹ï¼š åº”è¯¥æ ¹æ®é™ç•Œä¸Šä¸‹æ–‡ä¸­çš„é€šç”¨è¯­è¨€æ¥å‘½åäº‹ä»¶ï¼šAccountActivitedã€‚ åº”è¯¥å°†äº‹ä»¶å»ºæ¨¡æˆå€¼å¯¹è±¡æˆ–è´«è¡€å¯¹è±¡ã€‚ åº”ç”¨ï¼š è§£è€¦é¢†åŸŸå¯¹è±¡ä¹‹é—´çš„å…³ç³»ï¼› è§¦å‘å…¶ä»–é¢†åŸŸå¯¹è±¡çš„è¡Œä¸ºï¼› è®°å½•é¢†åŸŸå†…å·²å‘ç”Ÿçš„çŠ¶æ€å˜åŒ–ï¼› å®ç°è·¨èšåˆçš„æœ€ç»ˆä¸€è‡´æ€§ï¼› è¿›è¡Œé™ç•Œä¸Šä¸‹æ–‡é›†æˆã€‚ æ¶ˆæ¯ä½“ï¼š event_id: , event_type: , entity_id: , event_time: 0, extra_data: é¢†åŸŸäº‹ä»¶çš„ç”Ÿæˆ åº”ç”¨å±‚åˆ›å»ºé¢†åŸŸäº‹ä»¶ã€‚ èšåˆæ ¹åˆ›å»ºé¢†åŸŸäº‹ä»¶ã€‚ è¦é¿å…åœ¨èšåˆæ ¹å†…éƒ¨è°ƒç”¨åŸºç¡€å®æ–½å‘å¸ƒé¢†åŸŸäº‹ä»¶ï¼Œè€Œæ˜¯ç”Ÿæˆåè¿”å›ç»™åº”ç”¨å±‚ï¼Œç”±åº”ç”¨å±‚å»å‘å¸ƒã€‚ type Entity struct Events []Eventfunc(e *Entity)ResgisterEvent(event Event) e.Events = append(e.Events. event)func(e *Entity) GetEvents() []Event res := e.Events() e.Events = []Event return res é¢†åŸŸäº‹ä»¶çš„å‘å¸ƒ ç›´æ¥å‘å¸ƒå¹¶è½®è¯¢è¡¥å¿ï¼šä¸ºäº‹ä»¶å­˜å‚¨ä¸€ä¸ªå‘å¸ƒçŠ¶æ€æ ‡è¯†ï¼Œç”¨äºè®°å½•æ˜¯å¦è¡¥å‘æˆåŠŸã€‚å¹¶æä¾›å®šæ—¶ä»»åŠ¡æ£€ç´¢è¶…æ—¶æœªå‘å¸ƒæˆåŠŸçš„äº‹ä»¶è¿›è¡Œé‡æ–°å‘å¸ƒã€‚ é‡‡ç”¨äº‹åŠ¡æ—¥å¿—æ‹–å°¾ï¼šå¼•å…¥å˜æ›´æ•°æ®æ•è·ç»„ä»¶ï¼ˆChange Data Captureï¼Œç®€ç§° CDCï¼‰ï¼Œæ•è·æ•°æ®çš„å˜æ›´æ—¥å¿—ï¼Œè§£æåè·å¾—é¢†åŸŸäº‹ä»¶å¹¶å‘å¸ƒã€‚ é¢†åŸŸäº‹ä»¶çš„è®¢é˜… å°†é¢†åŸŸäº‹ä»¶è®¢é˜…è€…æ”¾ç½®åœ¨ç”¨æˆ·æ¥å£å±‚ user-interface-subscriberï¼Œæ”¶åˆ°äº‹ä»¶åè°ƒç”¨åº”ç”¨æœåŠ¡æ‰§è¡Œä¸šåŠ¡é€»è¾‘ã€‚ äº‹ä»¶æº¯æº äº‹ä»¶æº¯æºï¼ˆEvent Sourcingï¼‰æ˜¯ä¸€ç§å°†æ‰€æœ‰çš„é¢†åŸŸäº‹ä»¶ï¼ˆDomain Eventï¼‰å­˜å‚¨åˆ°äº‹ä»¶å­˜å‚¨ï¼ˆEvent Storeï¼‰ä¸­ï¼Œå¹¶é€šè¿‡é‡æ”¾å†å²äº‹ä»¶æ¥è¿˜åŸé¢†åŸŸå¯¹è±¡çŠ¶æ€çš„æ¨¡å¼ã€‚ æ ¸å¿ƒæ€æƒ³æ˜¯å°†ç³»ç»Ÿä¸­æ‰€æœ‰çš„çŠ¶æ€å˜æ›´éƒ½è§†ä¸ºäº‹ä»¶ï¼Œå°†è¿™äº›äº‹ä»¶ä»¥äº‹ä»¶é¡ºåºè®°å½•ä¸‹æ¥ï¼Œå¹¶å­˜å‚¨åˆ°äº‹ä»¶å­˜å‚¨ä¸­ã€‚è¿™æ ·ï¼Œå¯ä»¥é€šè¿‡é‡æ”¾è¿™äº›äº‹ä»¶ï¼Œæ¥è¿˜åŸä»»æ„æ—¶åˆ»çš„ç³»ç»ŸçŠ¶æ€ã€‚ ä¸‰ç§æ–¹æ¡ˆï¼š é€šè¿‡å›æ”¾æ‰€æœ‰çš„å†å²äº‹ä»¶é‡å»ºèšåˆæ ¹ã€‚ é€šè¿‡å¿«ç…§æé«˜é‡å»ºèšåˆæ ¹çš„æ•ˆç‡ã€‚ é€šè¿‡æ‹‰é“¾è¡¨ç”Ÿæˆæ‰€æœ‰äº‹ä»¶å¯¹åº”çš„å¿«ç…§ã€‚ æ‹‰é“¾è¡¨æ˜¯ä¸€ç§ç”¨äºå¤„ç†ç¼“æ…¢å˜åŒ–ç»´åº¦é—®é¢˜çš„æ•°æ®ç»“æ„ï¼Œå®ƒå¯ä»¥æœ‰æ•ˆåœ°å¤„ç†ç»´åº¦æ•°æ®çš„å†å²å˜åŒ–ã€‚åœ¨æ‹‰é“¾è¡¨ä¸­ï¼Œæ¯ä¸ªè®°å½•éƒ½æœ‰ä¸€ä¸ªå¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´ï¼Œç”¨äºæè¿°è¯¥è®°å½•çš„å­˜æ´»æ—¶é—´ï¼Œå³è¯¥è®°å½•çš„æœ‰æ•ˆæœŸã€‚ æ‹‰é“¾æ³•ç¤ºæ„å›¾ CQRS CQRS å°†ç³»ç»Ÿçš„æ“ä½œåˆ†ä¸ºä¸¤ç±»ï¼š å‘½ä»¤ï¼ˆCommandï¼‰ï¼šè´Ÿè´£æ•°æ®çš„å†™æ“ä½œï¼ˆå¢ã€åˆ ã€æ”¹ï¼‰ï¼Œä¸è¿”å›æ•°æ®ã€‚ æŸ¥è¯¢ï¼ˆQueryï¼‰ï¼šè´Ÿè´£æ•°æ®çš„è¯»æ“ä½œï¼Œä»…è¿”å›ç»“æœä¸”ä¸ä¿®æ”¹æ•°æ®ã€‚ ä¸¤è€…çš„æ•°æ®æ¨¡å‹å¯ç‹¬ç«‹è®¾è®¡ï¼Œç”šè‡³ä½¿ç”¨ä¸åŒçš„æ•°æ®åº“æˆ–å­˜å‚¨æŠ€æœ¯ã€‚ é€‚ç”¨åœºæ™¯ åº”å¯¹é«˜å¹¶å‘è¯»å†™åœºæ™¯æ¡ˆä¾‹ 1ï¼šB ç«™ç‚¹èµç³»ç»Ÿåœ¨æ—¥å‡æ´»è·ƒç”¨æˆ·è¿‘äº¿çš„ B ç«™ï¼Œç‚¹èµåŠŸèƒ½é€šè¿‡ CQRSåˆ†ç¦»è¯»å†™æ“ä½œã€‚å†™å…¥ç«¯é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¦‚Kafkaï¼‰å¼‚æ­¥å¤„ç†è¯·æ±‚ï¼Œé¿å…æ•°æ®åº“é”ç«äº‰ï¼›æŸ¥è¯¢ç«¯é€šè¿‡ç¼“å­˜ä¼˜åŒ–è¯»å–æ€§èƒ½ï¼Œæ˜¾è‘—æå‡ç³»ç»Ÿååé‡å’Œç¨³å®šæ€§ã€‚æ¡ˆä¾‹ 2ï¼šå®æ—¶ç­”é¢˜ PK æ¸¸æˆé«˜å¹¶å‘çš„ç­”é¢˜å¾—åˆ†è®¡ç®—åœºæ™¯ä¸­ï¼ŒCQRS ç»“åˆäº‹ä»¶æº¯æºï¼ˆEventSourcingï¼‰è®°å½•æ¯ä¸ªæ“ä½œäº‹ä»¶ï¼Œç¡®ä¿è¯»å†™æ¨¡å‹çš„æœ€ç»ˆä¸€è‡´æ€§ï¼ŒåŒæ—¶æ”¯æŒå¤æ‚æˆ˜å†µæ•°æ®çš„å®æ—¶å±•ç¤ºã€‚è§£å†³å¤æ‚æŸ¥è¯¢éœ€æ±‚æ¡ˆä¾‹ 3ï¼šç”µå•†è®¢å•æŸ¥è¯¢éšç€è®¢å•æŸ¥è¯¢éœ€æ±‚å¤šæ ·åŒ–ï¼ˆå¦‚æŒ‰æ—¶é—´ç­›é€‰ã€è·¨å®ä½“èšåˆæ•°æ®ï¼‰ï¼ŒCQRSé€šè¿‡ç‹¬ç«‹è¯»æ¨¡å‹ç®€åŒ–æŸ¥è¯¢é€»è¾‘ï¼Œé¿å…é¢†åŸŸæ¨¡å‹è¢«å¤æ‚æŸ¥è¯¢é€»è¾‘æ±¡æŸ“ã€‚æ¡ˆä¾‹ 4ï¼šå¾®æœåŠ¡æ•°æ®èšåˆåœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒCQRSå…è®¸é€šè¿‡äº‹ä»¶åŒæ­¥è·¨æœåŠ¡æ•°æ®åˆ°ä¸“ç”¨è¯»åº“ï¼Œé¿å…è·¨æœåŠ¡è”è¡¨æŸ¥è¯¢çš„æ€§èƒ½ç“¶é¢ˆï¼ˆå¦‚è¡Œç¨‹ç®¡ç†æœåŠ¡ä¸ç”¨æˆ·ä¿¡æ¯æœåŠ¡çš„èšåˆæŸ¥è¯¢ï¼‰ã€‚æå‡æ•°æ®æ¨¡å‹çµæ´»æ€§æ¡ˆä¾‹ 5ï¼šæ–‡æœ¬å¢é‡æ›´æ–°é’ˆå¯¹å¤§å‹æ–‡æœ¬ç¼–è¾‘åœºæ™¯ï¼ŒCQRSæ‹†åˆ†è¯»å†™æ¨¡å‹ï¼Œå¢é‡ä¿å­˜ä¿®æ”¹è®°å½•å¹¶é€šè¿‡äº‹ä»¶åˆå¹¶ï¼Œå‡å°‘ç½‘ç»œä¼ è¾“æ•°æ®é‡ï¼ŒåŒæ—¶æ”¯æŒä»»æ„ç‰ˆæœ¬çš„å†å²æ•°æ®æ¢å¤ã€‚ ä¸é€‚ç”¨åœºæ™¯ ç®€å• CRUD ç³»ç»Ÿï¼ˆå¦‚å°å‹ç®¡ç†åå°ï¼‰å¼ºä¸€è‡´æ€§è¦æ±‚çš„é‡‘èäº¤æ˜“åœºæ™¯ï¼ˆå¦‚å®æ—¶æ‰£æ¬¾ï¼‰å›¢é˜Ÿç¼ºä¹äº‹ä»¶é©±åŠ¨æ¶æ„ç»éªŒæ—¶ ä¸€è‡´æ€§ èšåˆå†…äº‹åŠ¡å®ç° èšåˆå†…äº‹åŠ¡æ§åˆ¶ä¸è¦æ”¾åœ¨åº”ç”¨å±‚ï¼Œä¼šä½¿åº”ç”¨å±‚æ‰¿æ‹…è¿‡å¤šçš„è´£ä»»ã€‚åº”ç”¨å±‚åº”ä¸“æ³¨äºåè°ƒé¢†åŸŸå¯¹è±¡å’ŒåŸºç¡€è®¾æ–½ä»¥å®Œæˆä¸šåŠ¡æ“ä½œï¼Œä¸åº”è¿‡å¤šæ¶‰åŠæ•°æ®è®¿é—®å’Œäº‹åŠ¡æ§åˆ¶çš„ç»†èŠ‚ã€‚ èšåˆå†…äº‹åŠ¡æ§åˆ¶å¯ä»¥äº¤ç»™ Repository æ¥å®ç°ï¼Œé‡‡ç”¨ä¹è§‚é”è§£å†³å¹¶å‘é—®é¢˜ï¼Œå¯ä»¥åŸºäºç‰ˆæœ¬å·å’Œæ—¶é—´æˆ³ï¼Œä¸€èˆ¬é‡è¯• 1-3 æ¬¡å³å¯ã€‚ èšåˆé—´äº‹åŠ¡å®ç° èšåˆé—´æ§åˆ¶å¯ä»¥å•ç‹¬å»ºç«‹ä¸€ä¸ªé¢†åŸŸæœåŠ¡ Domain Service æ¥å®Œæˆã€‚ å¯¹äºå®æ—¶æ€§è¦æ±‚ä¸é«˜ï¼Œä»…éœ€æœ€ç»ˆä¸€è‡´æ€§ï¼Œå¯ä»¥ä½¿ç”¨æœ¬åœ°æ¶ˆæ¯è¡¨æˆ–è€…æœ€å¤§åŠªåŠ›é€šçŸ¥çš„æ–¹æ¡ˆã€‚ å¯¹äºå®æ—¶æ€§ä¸€è‡´æ€§è¦æ±‚æ¯”è¾ƒé«˜ï¼Œå¯ä»¥é‡‡ç”¨ TCCï¼ˆTry-Confirm-Cancelï¼‰ äº‹åŠ¡æ–¹æ¡ˆã€‚ å¯¹äºé•¿äº‹åŠ¡åœºæ™¯ï¼Œæˆ–è€…æ¶‰åŠå¤–éƒ¨ç³»ç»Ÿã€é—ç•™ç³»ç»Ÿï¼Œå¯ä»¥è€ƒè™‘ Saga äº‹åŠ¡æ–¹æ¡ˆã€‚ Saga å°†äº‹åŠ¡åˆ†ä¸ºå¤šä¸ªäº‹åŠ¡ï¼Œè¿™äº›åˆ†æ”¯äº‹åŠ¡æŒ‰ç…§ä¸€å®šçš„é¡ºåºæ‰§è¡Œã€‚å½“æŸä¸ªåˆ†æ”¯äº‹åŠ¡æ‰§è¡ŒæˆåŠŸåï¼Œä¼šé€šè¿‡æ¶ˆæ¯é€šçŸ¥ä¸‹ä¸€ä¸ªåˆ†æ”¯æ‰§è¡Œï¼›å½“æŸä¸ªåˆ†æ”¯äº‹åŠ¡æ‰§è¡Œå¤±è´¥æ—¶ï¼Œä¼šæŒ‰ç…§æ­£å¸¸äº‹åŠ¡æ‰§è¡Œé¡ºåºçš„ç›¸åæ–¹å‘è¿›è¡Œä¸€ç³»åˆ—çš„è¡¥å¿æ“ä½œï¼Œä»¥ç¡®ä¿å…¨å±€äº‹åŠ¡çš„ä¸€è‡´æ€§ã€‚ æˆ˜ç•¥è®¾è®¡ äº‹ä»¶é£æš´ æ ¸å¿ƒæ¦‚å¿µä¸å…ƒç´  å…ƒç´ åç§° é¢œè‰²æ ‡è¯† è¯´æ˜ é¢†åŸŸäº‹ä»¶ï¼ˆDomain Eventï¼‰ æ©™è‰² è¡¨ç¤ºå·²å‘ç”Ÿçš„ä¸šåŠ¡äº‹å®ï¼Œä»¥â€œåŠ¨è¯è¿‡å»å¼â€å‘½åï¼ˆå¦‚â€œè®¢å•å·²æäº¤â€ï¼‰ï¼Œæ˜¯äº‹ä»¶é£æš´çš„æ ¸å¿ƒèµ·ç‚¹ã€‚ å‘½ä»¤ï¼ˆCommandï¼‰ æ·±è“è‰² è§¦å‘é¢†åŸŸäº‹ä»¶çš„æ“ä½œæˆ–æ„å›¾ï¼ˆå¦‚â€œæäº¤è®¢å•â€ï¼‰ï¼Œé€šå¸¸ç”±ç”¨æˆ·æˆ–ç³»ç»Ÿè§¦å‘ã€‚ å‚ä¸è€…ï¼ˆActorï¼‰ é»„è‰² æ‰§è¡Œå‘½ä»¤çš„è§’è‰²ï¼ŒåŒ…æ‹¬ç”¨æˆ·ã€éƒ¨é—¨æˆ–å¤–éƒ¨ç³»ç»Ÿï¼ˆå¦‚â€œå®¢æˆ·â€è§¦å‘æ”¯ä»˜å‘½ä»¤ï¼‰ã€‚ å¤–éƒ¨ç³»ç»Ÿï¼ˆExternal Systemï¼‰ ç²‰è‰² ä¸å½“å‰ç³»ç»Ÿäº¤äº’çš„ç¬¬ä¸‰æ–¹æœåŠ¡ï¼ˆå¦‚æ”¯ä»˜ç½‘å…³å›è°ƒç”Ÿæˆäº‹ä»¶ï¼‰ã€‚ ç­–ç•¥ï¼ˆPolicyï¼‰ ç´«è‰² ä¸šåŠ¡è§„åˆ™æˆ–çº¦æŸæ¡ä»¶ï¼ˆå¦‚â€œåº“å­˜ä¸è¶³æ—¶å–æ¶ˆè®¢å•â€ï¼‰ï¼Œå†³å®šäº‹ä»¶è§¦å‘çš„é€»è¾‘ã€‚ è¯»æ¨¡å‹ï¼ˆRead Modelï¼‰ ç»¿è‰² ä¸ºæŸ¥è¯¢ä¼˜åŒ–çš„æ•°æ®è§†å›¾ï¼ˆå¦‚â€œç”¨æˆ·è®¢å•åˆ—è¡¨â€ï¼‰ï¼Œæ”¯æŒå†³ç­–å±•ç¤ºã€‚ èšåˆï¼ˆAggregateï¼‰ å¤§é»„è‰² ä¸šåŠ¡å¯¹è±¡é›†åˆï¼ˆå¦‚â€œè®¢å•èšåˆâ€åŒ…å«è®¢å•é¡¹å’ŒçŠ¶æ€ï¼‰ï¼Œç»´æŠ¤ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ã€‚ é—®é¢˜ï¼ˆQuestionï¼‰ çº¢è‰² æœªè¾¾æˆå…±è¯†çš„äº‰è®®ç‚¹ï¼ˆå¦‚äº‹ä»¶å®šä¹‰åˆ†æ­§ï¼‰ï¼Œéœ€åç»­ä¸“é¡¹è®¨è®ºã€‚ å®æ–½æµç¨‹ä¸æ­¥éª¤ å‡†å¤‡å·¥ä½œ å‚ä¸äººå‘˜ï¼šä¸šåŠ¡ä¸“å®¶ã€å¼€å‘ã€äº§å“ã€æµ‹è¯•ç­‰è·¨èŒèƒ½è§’è‰²ï¼Œéœ€é¢†åŸŸä¸“å®¶ä¸»å¯¼ã€‚ ç‰©æ–™ï¼šå¤šè‰²ä¾¿ç­¾ã€ç™½æ¿ã€é©¬å…‹ç¬”ï¼Œçº¿ä¸Šå·¥å…·è¾…åŠ©è¿œç¨‹åä½œã€‚ è¯†åˆ«é¢†åŸŸäº‹ä»¶ å›¢é˜Ÿé€šè¿‡å¤´è„‘é£æš´ç½—åˆ—æ‰€æœ‰å¯èƒ½äº‹ä»¶ï¼ˆå¦‚ç”µå•†åœºæ™¯çš„â€œè®¢å•å·²åˆ›å»ºâ€â€œåº“å­˜å·²æ‰£å‡â€ï¼‰ï¼ŒæŒ‰æ—¶é—´è½´æ’åˆ—ï¼Œäº‰è®®äº‹ä»¶ç”¨çº¢è‰²ä¾¿ç­¾æ ‡è®°å¹¶æš‚å­˜ã€‚ è¡¥å……å‘½ä»¤ä¸è§’è‰² ä¸ºæ¯ä¸ªäº‹ä»¶å…³è”è§¦å‘å‘½ä»¤åŠæ‰§è¡Œè€…ï¼ˆå¦‚â€œå®¢æˆ·â€æ‰§è¡Œâ€œæ”¯ä»˜è®¢å•â€å‘½ä»¤ç”Ÿæˆâ€œæ”¯ä»˜å®Œæˆâ€äº‹ä»¶ï¼‰ï¼ŒåŒºåˆ†å†…éƒ¨æ“ä½œä¸å¤–éƒ¨ç³»ç»Ÿè°ƒç”¨ã€‚ å®šä¹‰ç­–ç•¥ä¸è¯»æ¨¡å‹ æ·»åŠ ä¸šåŠ¡è§„åˆ™ï¼ˆå¦‚â€œè®¢å•é‡‘é¢â‰¥1000å…ƒéœ€å®¡æ ¸â€ï¼‰å’Œæ•°æ®å±•ç¤ºéœ€æ±‚ï¼ˆå¦‚â€œå®æ—¶åº“å­˜çœ‹æ¿â€ï¼‰ã€‚ æ„å»ºèšåˆä¸åˆ’åˆ†å­åŸŸ å°†ç›¸å…³äº‹ä»¶ã€å‘½ä»¤å½’ç±»ä¸ºèšåˆï¼ˆå¦‚â€œæ”¯ä»˜èšåˆâ€ï¼‰ï¼Œåˆ’åˆ†é™ç•Œä¸Šä¸‹æ–‡ï¼ˆå¦‚â€œè®¢å•æœåŠ¡â€â€œåº“å­˜æœåŠ¡â€ï¼‰ï¼Œæ˜ç¡®å¾®æœåŠ¡è¾¹ç•Œã€‚ æ³¨æ„äº‹é¡¹ äº‹ä»¶ç²’åº¦çš„æŠŠæ§ï¼šé¿å…è¿‡åº¦ç»†åŒ–ï¼ˆå¦‚â€œç”¨æˆ·å·²ççœ¼\"ï¼‰æˆ–è¿‡äºå®½æ³›ï¼ˆå¦‚â€œè®¢å•å·²ä¿®æ”¹â€ï¼‰ï¼Œéœ€èšç„¦ä¸šåŠ¡å…³é”®èŠ‚ç‚¹ã€‚ äº‰è®®å¤„ç†ä¸è¿­ä»£ï¼šå¯¹æœªè¾¾æˆå…±è¯†çš„äº‹ä»¶æ ‡è®°ä¸ºâ€œé—®é¢˜â€ï¼ˆçº¢è‰²ä¾¿ç­¾ï¼‰ï¼Œåç»­ä¸“é¢˜è®¨è®ºï¼›å®šæœŸå›é¡¾æ¨¡å‹ï¼Œä¿®æ­£é”™è¯¯æˆ–è¡¥å……é—æ¼ã€‚ æŠ€æœ¯å®ç°è¡”æ¥ ï¼šäº‹ä»¶é£æš´çš„è¾“å‡ºéœ€è½¬åŒ–ä¸ºä»£ç æ¨¡å‹ï¼Œä¾‹å¦‚é€šè¿‡äº‹ä»¶æº¯æºï¼ˆEvent Sourcingï¼‰æŒä¹…åŒ–äº‹ä»¶æµï¼Œæˆ–ç»“åˆ CQRS åˆ†ç¦»è¯»å†™é€»è¾‘ã€‚ C4 æ¶æ„æ¨¡å‹ https://c4model.com/https://c4model.com/ å±‚çº§ æ ¸å¿ƒç›®æ ‡ å—ä¼— å…³é”®å…ƒç´  Contextï¼ˆä¸Šä¸‹æ–‡ï¼‰ æè¿°ç³»ç»Ÿä¸å¤–éƒ¨å®ä½“ï¼ˆç”¨æˆ·ã€ç¬¬ä¸‰æ–¹ç³»ç»Ÿï¼‰çš„äº¤äº’å…³ç³» éæŠ€æœ¯äººå‘˜ï¼ˆå¦‚ä¸šåŠ¡æ–¹ã€å®¢æˆ·ï¼‰ ç³»ç»Ÿè¾¹ç•Œã€ç”¨æˆ·è§’è‰²ã€å¤–éƒ¨ä¾èµ–ï¼ˆå¦‚æ”¯ä»˜ç½‘å…³ï¼‰ Containerï¼ˆå®¹å™¨ï¼‰ å±•ç¤ºç³»ç»Ÿå†…éƒ¨çš„é«˜é˜¶æŠ€æœ¯ç»„ä»¶ï¼ˆè¿›ç¨‹çº§å•å…ƒï¼‰ æŠ€æœ¯ç®¡ç†è€…ã€æ¶æ„å¸ˆ Web åº”ç”¨ã€æ•°æ®åº“ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰ç‹¬ç«‹è¿›ç¨‹å•å…ƒï¼Œå…³æ³¨æŠ€æœ¯é€‰å‹ä¸é€šä¿¡åè®®ï¼ˆå¦‚ REST APIã€gRPCï¼‰ Componentï¼ˆç»„ä»¶ï¼‰ ç»†åŒ–å®¹å™¨å†…éƒ¨çš„ä¸šåŠ¡æ¨¡å—ä¸äº¤äº’é€»è¾‘ å¼€å‘å›¢é˜Ÿ æœåŠ¡ã€æ¨¡å—ã€æ¥å£ï¼ˆå¦‚è®¢å•æœåŠ¡ã€åº“å­˜æœåŠ¡ï¼‰ï¼Œå¼ºè°ƒèŒè´£åˆ’åˆ†ä¸ä¾èµ–å…³ç³» Codeï¼ˆä»£ç ï¼‰ å±•ç¤ºç»„ä»¶å®ç°çš„ä»£ç ç»“æ„ å¼€å‘è€… ç±»ã€æ–¹æ³•ã€æ•°æ®åº“è¡¨ï¼ˆå¦‚ UML ç±»å›¾ã€ER å›¾ï¼‰ï¼Œé€šå¸¸ç”± IDE å·¥å…·è‡ªåŠ¨ç”Ÿæˆ é™¤äº†å››å±‚æ ¸å¿ƒè§†å›¾ï¼ŒC4 æ¨¡å‹è¿˜æä¾›ï¼š éƒ¨ç½²å›¾ï¼šå±•ç¤ºå®¹å™¨åœ¨ç‰©ç†ç¯å¢ƒä¸­çš„åˆ†å¸ƒï¼ˆå¦‚ Kubernetes é›†ç¾¤éƒ¨ç½²ï¼‰ã€‚ åŠ¨æ€å›¾ï¼šæè¿°ä¸šåŠ¡æµç¨‹ï¼ˆå¦‚ç”¨æˆ·ä¸‹å•åˆ°æ”¯ä»˜å®Œæˆçš„æ—¶åºäº¤äº’ï¼‰ã€‚ ç³»ç»Ÿæ™¯è§‚å›¾ï¼šå¤šç³»ç»ŸååŒçš„å…¨å±€è§†å›¾ï¼ˆå¦‚ä¼ä¸šçº§ä¸­å°æ¶æ„ï¼‰ã€‚ ContextContainerComponentCode å®è·µæ¡ˆä¾‹ å‚è€ƒä½œè€…çš„ ddd-archetype ï¼Œç¬”è€…å®ç°äº†ä¸€ä¸ª Go ç‰ˆæœ¬çš„ ddd-archetype-goï¼š https://github.com/hedon-go-road/ddd-archetype-gohttps://github.com/hedon-go-road/ddd-archetype-go æ•´ä½“æ¶æ„å¦‚ä¸‹ï¼š","tags":["è¯»ä¹¦ç¬”è®°","DDD"],"categories":["è¯»ä¹¦ç¬”è®°"]},{"title":"Go 1.24 æ–°ç‰¹æ€§è§£è¯»ï¼šä½¿ç”¨ testing/synctest ä¼˜é›…åœ°æµ‹è¯•å¹¶å‘ä»£ç ","path":"/2025/03/06/go-lib-synctest/","content":"åœ¨ Go è¯­è¨€å¼€å‘ä¸­ï¼Œå¹¶å‘ç¼–ç¨‹ä¸€ç›´æ˜¯å…¶æœ€å¼•äººæ³¨ç›®çš„ç‰¹æ€§ä¹‹ä¸€ã€‚ç„¶è€Œï¼Œå¦‚ä½•æœ‰æ•ˆåœ°æµ‹è¯•å¹¶å‘ä»£ç å´å¸¸å¸¸è®©å¼€å‘è€…æ„Ÿåˆ°å¤´ç–¼ã€‚Go 1.24 ç‰ˆæœ¬å¼•å…¥çš„å®éªŒæ€§åŒ… testing/synctest ä¸ºè¿™ä¸ªé—®é¢˜å¸¦æ¥äº†ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆã€‚ä»Šå¤©ï¼Œè®©æˆ‘ä»¬æ·±å…¥äº†è§£è¿™ä¸ªæ–°ç‰¹æ€§ã€‚ å¹¶å‘æµ‹è¯•çš„ä¼ ç»Ÿå›°å¢ƒ åœ¨ä»‹ç»æ–°æ–¹æ¡ˆä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹ä¼ ç»Ÿçš„å¹¶å‘æµ‹è¯•é¢ä¸´å“ªäº›é—®é¢˜ï¼š func TestTraditional(t *testing.T) done := false go func() // æ‰§è¡ŒæŸäº›æ“ä½œ time.Sleep(100 * time.Millisecond) done = true () // ç­‰å¾…æ“ä½œå®Œæˆ time.Sleep(200 * time.Millisecond) if !done t.Fatal(æ“ä½œæœªå®Œæˆ) è¿™ç§æ–¹å¼å­˜åœ¨æ˜æ˜¾çš„é—®é¢˜ï¼š æ—¶é—´ä¾èµ–ï¼šéœ€è¦é€šè¿‡ Sleep ç­‰å¾…ï¼Œå¯¼è‡´æµ‹è¯•è¿è¡Œç¼“æ…¢ ä¸ç¨³å®šæ€§ï¼šåœ¨ä¸åŒç¯å¢ƒä¸‹å¯èƒ½äº§ç”Ÿä¸åŒç»“æœ ç²¾ç¡®æ€§å·®ï¼šéš¾ä»¥å‡†ç¡®æŠŠæ¡æ£€æŸ¥æ—¶æœº synctestï¼šä¼˜é›…çš„è§£å†³æ–¹æ¡ˆ testing/synctest åŒ…é€šè¿‡ä¸¤ä¸ªæ ¸å¿ƒå‡½æ•°æ”¹å˜äº†è¿™ä¸€åˆ‡ï¼š Run(): åˆ›å»ºéš”ç¦»çš„æµ‹è¯•ç¯å¢ƒï¼ˆbubbleï¼‰ Wait(): ç­‰å¾…æ‰€æœ‰ goroutine è¿›å…¥ç¨³å®šçŠ¶æ€ è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•æ”¹å†™ä¸Šé¢çš„æµ‹è¯•ï¼š func TestWithSynctest(t *testing.T) synctest.Run(func() done := false go func() // æ‰§è¡ŒæŸäº›æ“ä½œ time.Sleep(100 * time.Millisecond) done = true () synctest.Wait() // ç­‰å¾…æ‰€æœ‰ goroutine è¿›å…¥ç¨³å®šçŠ¶æ€ if !done t.Fatal(æ“ä½œæœªå®Œæˆ) ) æ·±å…¥ç†è§£ Wait æœºåˆ¶ Wait çš„æœ¬è´¨ å¾ˆå¤šå¼€å‘è€…åˆæ¬¡æ¥è§¦ Wait() æ—¶å¯èƒ½ä¼šæ„Ÿåˆ°å›°æƒ‘ï¼šå®ƒåˆ°åº•åœ¨ç­‰å¾…ä»€ä¹ˆï¼Ÿä»€ä¹ˆæ—¶å€™ä¼šè¿”å›ï¼Ÿ æƒ³è±¡ä¸€ä¸ªåœºæ™¯ï¼šä½ åœ¨æ‹æ‘„ä¸€å¼ å…¨å®¶ç¦ï¼Œéœ€è¦ç­‰å¾…æ‰€æœ‰äººéƒ½æ‰¾åˆ°è‡ªå·±çš„ä½ç½®ï¼Œç«™å¥½ä¸åŠ¨ï¼Œæ‰èƒ½æŒ‰ä¸‹å¿«é—¨ã€‚Wait() å°±åƒè¿™ä¸ªæ‘„å½±å¸ˆï¼Œå®ƒåœ¨ç­‰å¾…æ‰€æœ‰ goroutineï¼ˆå°±åƒç…§ç‰‡ä¸­çš„äººï¼‰éƒ½è¿›å…¥ä¸€ä¸ªç¨³å®šçš„çŠ¶æ€ï¼ˆç«™å¥½ä¸åŠ¨ï¼‰ã€‚ synctest.Run(func() // ç±»æ¯”ï¼šä¸‰ä¸ªäººè¦æ‹å…¨å®¶ç¦ go person1() // ç¬¬ä¸€ä¸ªäººæ‰¾ä½ç½® go person2() // ç¬¬äºŒä¸ªäººæ‰¾ä½ç½® go person3() // ç¬¬ä¸‰ä¸ªäººæ‰¾ä½ç½® synctest.Wait() // ç­‰å¾…æ‰€æœ‰äººéƒ½ç«™å¥½ä¸åŠ¨ // è¿™æ—¶å¯ä»¥å®‰å…¨åœ°æŒ‰ä¸‹å¿«é—¨ï¼ˆæ£€æŸ¥ç¨‹åºçŠ¶æ€ï¼‰) ä¸ºä»€ä¹ˆéœ€è¦ Waitï¼Ÿ åœ¨å¹¶å‘ç¨‹åºä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦åœ¨ç‰¹å®šæ—¶åˆ»æ£€æŸ¥ç¨‹åºçŠ¶æ€ã€‚ä½†æ˜¯ï¼Œå¦‚æœæŸäº› goroutine è¿˜åœ¨è¿è¡Œï¼Œè¿™ä¸ªçŠ¶æ€å¯èƒ½éšæ—¶å‘ç”Ÿå˜åŒ–ã€‚Wait() é€šè¿‡ç¡®ä¿æ‰€æœ‰ goroutine éƒ½è¿›å…¥ç¨³å®šçŠ¶æ€ï¼Œä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ª\"å¿«ç…§\"æ—¶åˆ»ã€‚ synctest.Run(func() result := false go func() // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ time.Sleep(1 * time.Second) result = true () synctest.Wait() // ç­‰å¾… goroutine è¿›å…¥ç¨³å®šçŠ¶æ€ // æ­¤æ—¶ result çš„å€¼æ˜¯ç¡®å®šçš„ï¼Œä¸ä¼šçªç„¶æ”¹å˜ fmt.Println(result)) æŒä¹…é˜»å¡çš„æ¦‚å¿µ å“ªäº›æ“ä½œä¼šå¯¼è‡´æŒä¹…é˜»å¡ï¼Ÿ channel æ“ä½œï¼ˆåŒä¸€ bubble å†…ï¼‰ time.Sleep sync.WaitGroup.Wait sync.Cond.Wait å“ªäº›æ“ä½œä¸ç®—æŒä¹…é˜»å¡ï¼Ÿ äº’æ–¥é”æ“ä½œ å¤–éƒ¨ I/O å¤–éƒ¨ channel æ“ä½œ è™šæ‹Ÿæ—¶é’Ÿï¼šæµ‹è¯•çš„ç¥å™¨ synctest çš„å¦ä¸€ä¸ªå¼ºå¤§ç‰¹æ€§æ˜¯è™šæ‹Ÿæ—¶é’Ÿæœºåˆ¶ã€‚åœ¨ bubble å†…éƒ¨ï¼Œæ‰€æœ‰æ—¶é—´ç›¸å…³çš„æ“ä½œéƒ½ä½¿ç”¨è™šæ‹Ÿæ—¶é’Ÿï¼Œè¿™æ„å‘³ç€ï¼š synctest.Run(func() // çœ‹ä¼¼ç­‰å¾…24å°æ—¶ time.Sleep(24 * time.Hour) // å®é™…ä¸Šç«‹å³æ‰§è¡Œå®Œæˆï¼) è¿™ä¸ªç‰¹æ€§è®©æˆ‘ä»¬èƒ½å¤Ÿï¼š å¿«é€Ÿæµ‹è¯•é•¿æ—¶é—´æ“ä½œ ç²¾ç¡®æ§åˆ¶æ—¶é—´æµé€ é¿å…æµ‹è¯•çš„ä¸ç¡®å®šæ€§ å®æˆ˜æ¡ˆä¾‹ï¼šæ·±å…¥ç†è§£ HTTP 100 Continue æµ‹è¯• èƒŒæ™¯çŸ¥è¯† HTTP çš„ 100 Continue æœºåˆ¶æ˜¯ä¸€ä¸ªä¼˜åŒ–å¤§æ–‡ä»¶ä¸Šä¼ çš„åè®®ç‰¹æ€§ï¼š å®¢æˆ·ç«¯æƒ³ä¸Šä¼ å¤§æ–‡ä»¶æ—¶ï¼Œå…ˆå‘é€å¸¦æœ‰ \"Expect: 100-continue\" å¤´çš„è¯·æ±‚ æœåŠ¡å™¨å¯ä»¥å†³å®šæ˜¯å¦æ¥å—è¿™ä¸ªä¸Šä¼ ï¼š å¦‚æœæ¥å—ï¼Œè¿”å› \"100 Continue\" å¦‚æœæ‹’ç»ï¼Œå¯ä»¥ç›´æ¥è¿”å›é”™è¯¯çŠ¶æ€ç  å®¢æˆ·ç«¯æ ¹æ®æœåŠ¡å™¨çš„å“åº”å†³å®šæ˜¯å¦å‘é€æ–‡ä»¶å†…å®¹ è¯¦ç»†æµ‹è¯•å®ç° func TestHTTPContinue(t *testing.T) synctest.Run(func() // ç¬¬ä¸€æ­¥ï¼šå»ºç«‹æµ‹è¯•ç¯å¢ƒ srvConn, cliConn := net.Pipe() defer srvConn.Close() defer cliConn.Close() // ç¬¬äºŒæ­¥ï¼šé…ç½® HTTP å®¢æˆ·ç«¯ tr := http.Transport DialContext: func(ctx context.Context, network, address string) (net.Conn, error) return cliConn, nil , ExpectContinueTimeout: 5 * time.Second, // ç¬¬ä¸‰æ­¥ï¼šå‡†å¤‡æµ‹è¯•æ•°æ® body := request body // ç¬¬å››æ­¥ï¼šå‘é€è¯·æ±‚ go func() req, _ := http.NewRequest(PUT, http://test.tld/, strings.NewReader(body)) req.Header.Set(Expect, 100-continue) resp, err := tr.RoundTrip(req) if err != nil t.Errorf(è¯·æ±‚å¤±è´¥: %v, err) else resp.Body.Close() () // ç¬¬äº”æ­¥ï¼šéªŒè¯è¯·æ±‚å¤´ req, err := http.ReadRequest(bufio.NewReader(srvConn)) if err != nil t.Fatalf(è¯»å–è¯·æ±‚å¤±è´¥: %v, err) // ç¬¬å…­æ­¥ï¼šéªŒè¯è¯·æ±‚ä½“æœªå‘é€ var gotBody strings.Builder go io.Copy(gotBody, req.Body) synctest.Wait() if got := gotBody.String(); got != t.Fatalf(åœ¨å‘é€ 100 Continue ä¹‹å‰ï¼Œæ„å¤–æ”¶åˆ°è¯·æ±‚ä½“: %q, got) // ç¬¬ä¸ƒæ­¥ï¼šå‘é€ 100 Continue srvConn.Write([]byte(HTTP/1.1 100 Continue\\r \\r )) // ç¬¬å…«æ­¥ï¼šéªŒè¯è¯·æ±‚ä½“ synctest.Wait() if got := gotBody.String(); got != body t.Fatalf(æ”¶åˆ°çš„è¯·æ±‚ä½“ %qï¼ŒæœŸæœ› %q, got, body) // ç¬¬ä¹æ­¥ï¼šå®Œæˆè¯·æ±‚ srvConn.Write([]byte(HTTP/1.1 200 OK\\r \\r )) ) æµ‹è¯•çš„å…³é”®ç‚¹è§£æ ä½¿ç”¨ net.Pipe() åˆ›å»ºå†…å­˜ä¸­çš„ç½‘ç»œè¿æ¥ é¿å…ä¾èµ–çœŸå®ç½‘ç»œ ä¿è¯æµ‹è¯•çš„å¯é‡å¤æ€§ è¯·æ±‚å‘é€è¿‡ç¨‹ åœ¨ç‹¬ç«‹çš„ goroutine ä¸­å‘é€è¯·æ±‚ è®¾ç½® \"Expect: 100-continue\" å¤´ å‡†å¤‡è¦å‘é€çš„è¯·æ±‚ä½“ éªŒè¯å…³é”®è¡Œä¸º ç¡®è®¤è¯·æ±‚å¤´æ­£ç¡®å‘é€ éªŒè¯è¯·æ±‚ä½“åœ¨æ”¶åˆ° 100 Continue ä¹‹å‰æœªå‘é€ éªŒè¯è¯·æ±‚ä½“åœ¨æ”¶åˆ° 100 Continue åæ­£ç¡®å‘é€ ä½¿ç”¨ Wait çš„æ—¶æœº åœ¨æ£€æŸ¥è¯·æ±‚ä½“ä¹‹å‰è°ƒç”¨ Wait ç¡®ä¿æ‰€æœ‰æ•°æ®ä¼ è¾“æ“ä½œéƒ½å·²å®Œæˆæˆ–é˜»å¡ è·å¾—ç¨³å®šçš„ç¨‹åºçŠ¶æ€è¿›è¡ŒéªŒè¯ ä½¿ç”¨å»ºè®® æ˜ç¡®è¾¹ç•Œï¼šç†è§£ä»€ä¹ˆæ“ä½œä¼šå¯¼è‡´æŒä¹…é˜»å¡ï¼Œä»€ä¹ˆä¸ä¼š æ¸…ç†èµ„æºï¼šç¡®ä¿æ‰€æœ‰ goroutine åœ¨æµ‹è¯•ç»“æŸå‰é€€å‡º æ¨¡æ‹Ÿ I/Oï¼šä½¿ç”¨å†…å­˜ç®¡é“æ›¿ä»£çœŸå®ç½‘ç»œè¿æ¥ åˆç†ä½¿ç”¨ Waitï¼šåœ¨éœ€è¦æ£€æŸ¥çŠ¶æ€çš„å…³é”®ç‚¹è°ƒç”¨ æ³¨æ„äº‹é¡¹ ç›®å‰æ˜¯å®éªŒæ€§åŠŸèƒ½ï¼Œéœ€è¦è®¾ç½® GOEXPERIMENT=synctest ä¸æ”¯æŒæµ‹è¯•çœŸå®çš„å¤–éƒ¨ I/O æ“ä½œ äº’æ–¥é”æ“ä½œä¸è¢«è§†ä¸ºæŒä¹…é˜»å¡","tags":["Go","å•å…ƒæµ‹è¯•"],"categories":["Go"]},{"title":"ç›´æ’­ç³»ç»Ÿæ¨æ‹‰æµåŸç†","path":"/2025/03/04/live-stream-push-pull/","content":"ç›´æ’­ç³»ç»Ÿæ¨æ‹‰æµåŸç†æ¦‚è¿° ç›´æ’­ç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½æ˜¯å®ç°ä¸»æ’­ç«¯è§†é¢‘é‡‡é›†åçš„å®æ—¶ä¼ è¾“ï¼Œä»¥åŠè§‚ä¼—ç«¯çš„å®æ—¶è§‚çœ‹ã€‚æ•´ä¸ªè¿‡ç¨‹ä¸»è¦åŒ…å«ï¼šæ¨æµã€æœåŠ¡å™¨å¤„ç†ã€æ‹‰æµä¸‰ä¸ªç¯èŠ‚ã€‚ ç›´æ’­ç³»ç»Ÿæ¶æ„ æ ¸å¿ƒæ¦‚å¿µè§£æ 1. æ¨æµï¼ˆPushï¼‰ æ¨æµæ˜¯æŒ‡ä¸»æ’­ç«¯å°†è§†é¢‘æ•°æ®ä¼ è¾“åˆ°æœåŠ¡å™¨çš„è¿‡ç¨‹ã€‚ä¸»è¦ä½¿ç”¨ RTMP åè®®ï¼ˆReal Time Messaging Protocolï¼‰ã€‚ æ¯”å¦‚å¯èƒ½æœ‰å¦‚ä¸‹æ¨æµ URL çš„ç”Ÿæˆé€»è¾‘ï¼š public static String generatePushUrl(String pushDomain, String pushKey, String appName, String streamName, long expireTime) String pushUrl = ; // æ¨æµåŸŸåæœªå¼€å¯é‰´æƒåŠŸèƒ½çš„æƒ…å†µä¸‹ if (StringUtils.isBlank(pushKey)) pushUrl = rtmp:// + pushDomain + / + appName + / + streamName; else long timeStamp = System.currentTimeMillis() / 1000L + expireTime; String stringToMd5 = / + appName + / + streamName + - + Long.toString(timeStamp) + -0-0- + pushKey; String authKey = md5(stringToMd5); pushUrl = rtmp:// + pushDomain + / + appName + / + streamName + ?auth_key= + Long.toString(timeStamp) + -0-0- + authKey; return pushUrl; æ¨æµåœ°å€çš„ç»„æˆéƒ¨åˆ†ï¼š - rtmp:// - åè®® - pushDomain - æ¨æµåŸŸå - appName - åº”ç”¨åç§° - streamName - æµåç§° - auth_key - é‰´æƒå‚æ•°ï¼ˆå¯é€‰ï¼‰ 2. æ‹‰æµï¼ˆPullï¼‰ æ‹‰æµæ˜¯è§‚ä¼—è§‚çœ‹ç›´æ’­çš„è¿‡ç¨‹ã€‚æ”¯æŒå¤šç§åè®®ï¼š - RTMPï¼šå»¶è¿Ÿä½ï¼ˆ1-3ç§’ï¼‰ - HTTP-FLVï¼šå»¶è¿Ÿé€‚ä¸­ï¼ˆ2-5ç§’ï¼‰ - HLS(m3u8)ï¼šå»¶è¿Ÿè¾ƒé«˜ï¼ˆ5-30ç§’ï¼‰ // FLV æ ¼å¼public static String generalPullUrlFlv(String pullDomain, String pullKey, String appName, String streamName, long expireTime) if (StringUtils.isBlank(pullKey)) return http:// + pullDomain + / + appName + / + streamName + .flv; // ... é‰´æƒé€»è¾‘// HLS æ ¼å¼public static String generalPullUrlHls(String pullDomain, String pullKey, String appName, String streamName, long expireTime) if (StringUtils.isBlank(pullKey)) return http:// + pullDomain + / + appName + / + streamName + .m3u8; // ... é‰´æƒé€»è¾‘ ç›´æ’­æµç¨‹ ä¸»æ’­å¼€æ’­ï¼š ç³»ç»Ÿç”Ÿæˆå”¯ä¸€çš„ streamId ç”Ÿæˆå¸¦é‰´æƒçš„æ¨æµåœ°å€ ä¸»æ’­ç«¯æ¨æµè½¯ä»¶ï¼ˆå¦‚ OBSï¼‰å¼€å§‹æ¨æµ æœåŠ¡å™¨å¤„ç†ï¼š æµåª’ä½“æœåŠ¡å™¨æ¥æ”¶æ¨æµ è¿›è¡Œè½¬ç ã€å½•åˆ¶ç­‰å¤„ç† å°†æµåˆ†å‘åˆ° CDN èŠ‚ç‚¹ è§‚ä¼—è§‚çœ‹ï¼š è·å–å¯¹åº”æ ¼å¼çš„æ‹‰æµåœ°å€ é€šè¿‡æ’­æ”¾å™¨æ‹‰å–ç›´æ’­æµ å®ç°å®æ—¶è§‚çœ‹ å®ç°å»ºè®® é€‰æ‹©åˆé€‚çš„æµåª’ä½“æœåŠ¡å™¨ï¼š å•†ä¸šäº‘æœåŠ¡ï¼šé˜¿é‡Œäº‘ç›´æ’­ã€è…¾è®¯äº‘ç›´æ’­ å¼€æºæ–¹æ¡ˆï¼šSRSã€Nginx-RTMP æ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©åè®®ï¼š æ™®é€šç›´æ’­ï¼šHTTP-FLV ä½å»¶è¿Ÿåœºæ™¯ï¼šRTMP ç§»åŠ¨ç«¯å…¼å®¹æ€§è¦æ±‚é«˜ï¼šHLS å…³æ³¨å…³é”®æŒ‡æ ‡ï¼š å»¶è¿Ÿæ§åˆ¶ å¡é¡¿ç‡ é¦–å±æ—¶é—´ å¸¦å®½æˆæœ¬ å®‰å…¨é‰´æƒï¼š é˜²ç›—é“¾æœºåˆ¶","tags":["ç›´æ’­ç³»ç»Ÿ"],"categories":["è§£å†³æ–¹æ¡ˆ","ç›´æ’­ç³»ç»Ÿ"]},{"title":"ç½‘ç»œæ•°æ®åŒ…çš„å®Œæ•´æ—…ç¨‹ï¼šä»å‘é€åˆ°æ¥æ”¶çš„å…¨è¿‡ç¨‹","path":"/2025/03/01/net-data-journey/","content":"ä¸çŸ¥é“ä½ æ˜¯å¦æ›¾ç»å¥½å¥‡ä½ å‘å‡ºçš„ä¸€ä¸ªç½‘ç»œè¯·æ±‚ï¼Œæœ€ç»ˆæ˜¯æ€ä¹ˆåˆ°è¾¾å¯¹ç«¯ï¼Œå¹¶å°†ä½ æƒ³è¦çš„ä¿¡æ¯è¿”å›ç»™ä½ çš„ã€‚æœ¬æ–‡å°†é€šè¿‡ä¸€ä¸ª HTTP è¯·æ±‚ä¸å“åº”ï¼Œä»ä¸€ä¸ªæ¯”è¾ƒå®è§‚çš„è§’åº¦æ¥æ¢³ç†ä¸‹ä¸€ä¸ªæ•°æ®åŒ…åœ¨ç½‘ç»œä¸­çš„æ—…é€”ï¼Œæ—¨åœ¨å¸®åŠ©ç¬”è€…å’Œå„ä½è¯»è€…å»ºç«‹èµ·å¯¹è®¡ç®—æœºç½‘ç»œæ¨¡å‹ä¸€ä¸ªæ¯”è¾ƒå…¨é¢çš„è®¤çŸ¥ã€‚ æœ¬æ–‡å‚è€ƒæå®¢æ—¶é—´ã€Šç½‘ç»œæ¶æ„å®æˆ˜è¯¾ï¼ˆè°¢å‹é¹ï¼‰ã€‹ï¼Œå†æ ¹æ®ç¬”è€…çš„çŸ¥è¯†é¢ã€æŒ‰ç…§ä¸ªäººç†è§£ï¼Œè¡¥å……æ›´å¤šä¸°å¯Œå…·ä½“çš„å†…å®¹ã€‚ å®æˆ˜ å¥½ï¼Œé‚£æˆ‘ä»¬ç›´æ¥å¼€å§‹ï¼Œæˆ‘ä»¬å…ˆä½¿ç”¨ curl æ¥å‘èµ·ä¸€ä¸ª HTTP è¯·æ±‚ï¼Œçœ‹çœ‹è¿™è¿‡ç¨‹ä¸­å‘ç”Ÿäº†ä»€ä¹ˆï¼š curl -o /dev/null -v https://example.com åœ¨ç¬”è€…çš„ mac æœºå™¨ä¸Šï¼Œè¿™è¡Œå‘½ä»¤çš„è¾“å‡ºå¦‚ä¸‹ï¼š å½“æˆ‘ä»¬å‘èµ·è¯·æ±‚æ—¶ï¼Œé¦–å…ˆä¼šå¯¹ example.com è¿›è¡ŒåŸŸåè§£æï¼Œåˆ†åˆ«å°è¯•è§£æåˆ°å®ƒçš„ IPv6 å’Œ IPv4ã€‚ * IPv6: (none)* IPv4: 23.215.0.138, 96.7.128.198, 23.192.228.80, 23.192.228.84, 23.215.0.136, 96.7.128.175 å› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ https åè®®ï¼Œæ‰€ä»¥ä¼šå°è¯•è·Ÿè¿™äº›åœ°å€çš„ 443 ç«¯å£å»ºç«‹ TCP è¿æ¥ï¼Œï¼ˆå¦‚æœæ˜¯ https åˆ™è·Ÿ 80 ç«¯å£ï¼‰ï¼Œå¹¶è¿›è¡Œ TLS æ¡æ‰‹éªŒè¯ï¼Œå¦‚æœæˆåŠŸäº†ï¼Œåˆ™ä¼šå»ºç«‹ TCP è¿æ¥ã€‚ * Trying 23.215.0.138:443......[TLS handshake]* Connected to example.com (23.215.0.138) port 443 å»ºç«‹è¿æ¥åï¼Œå°±å¼€å§‹å‘é€ HTTP è¯·æ±‚ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ HTTP2 åè®®ã€‚ * using HTTP/2 0 0 0 0 0 0 0 0 --:--:-- --:--:-- --:--:-- 0* [HTTP/2] [1] OPENED stream for https://example.com/* [HTTP/2] [1] [:method: GET]* [HTTP/2] [1] [:scheme: https]* [HTTP/2] [1] [:authority: example.com]* [HTTP/2] [1] [:path: /]* [HTTP/2] [1] [user-agent: curl/8.10.1]* [HTTP/2] [1] [accept: */*] [5 bytes data] GET / HTTP/2 Host: example.com User-Agent: curl/8.10.1 Accept: */** Request completely sent off æœ€åï¼ŒæœåŠ¡å™¨è¿”å›äº† HTTP 200 OK çš„å“åº”ã€‚ [5 bytes data]* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4): [265 bytes data]* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4): [265 bytes data] HTTP/2 200 content-type: text/html etag: 84238dfc8092e5d9c0dac8ef93371a07:1736799080.121134 last-modified: Mon, 13 Jan 2025 20:11:20 GMT cache-control: max-age=1374 date: Sat, 01 Mar 2025 05:01:03 GMT alt-svc: h3=:443; ma=93600,h3-29=:443; ma=93600,quic=:443; ma=93600; v=43 content-length: 1256 [5 bytes data]100 1256 100 1256 0 0 1172 0 0:00:01 0:00:01 --:--:-- 1172* Connection #0 to host example.com left intact è¦è¿›ä¸€æ­¥äº†è§£ç½‘ç»œæ•°æ®åŒ…çš„ç»†èŠ‚ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŠ“åŒ…å·¥å…·è¿›è¡Œåˆ†æã€‚ä½ å¯ä»¥ä½¿ç”¨ tcpdump æŠ“å–ä¸ example.com çš„é€šä¿¡æ•°æ®åŒ…ã€‚ è¿è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š sudo tcpdump host example.com -w example.com.pcap ç„¶åå†å¦å¤–ä¸€ä¸ªå‘½ä»¤è¡Œçª—å£å†æ¬¡å‘é€è¯·æ±‚ï¼š curl -o /dev/null -v https://example.com å›åˆ° tcpdump çš„çª—å£å¹¶ç»“æŸç›‘å¬ï¼Œæˆ‘ä»¬å°±ä¼šå¾—åˆ° example.com.pcap çš„æŠ“åŒ…æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡ Wireshark è½¯ä»¶æ‰“å¼€è¯¥æ–‡ä»¶ï¼š tcpdump åˆ†æç»“æœ ç½‘ç»œåˆ†å±‚ é€šè¿‡ä¸Šè¿°å®éªŒï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ™°çœ‹åˆ°ç½‘ç»œæ˜¯åˆ†å±‚çš„ï¼Œä¸»æµçš„åˆ†å±‚æ¨¡å‹æœ‰ OSI ä¸ƒå±‚æ¨¡å‹å’Œ TCP/IP å››å±‚æ¨¡å‹ï¼Œå®ƒä»¬çš„å¯¹åº”å…³ç³»åŠå¸¸è§çš„åè®®å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š OSI-vs-TCP/IP æˆ‘ä»¬åœ¨ Wireshark ä¸Šæ–¹éšä¾¿é€‰æ‹©ä¸€ä¸ªæ•°æ®åŒ…ï¼Œä½¿ç”¨é¼ æ ‡ç‚¹å‡»ä¸‹æ–¹å·¦ä¾§çš„æ¯ä¸€å±‚ï¼Œå¯ä»¥åœ¨å³ä¾§çœ‹åˆ°å¯¹åº”çš„å±‚çº§æ•°æ®ã€‚ä»é“¾è·¯å±‚åˆ°åº”ç”¨å±‚ï¼Œæ¯ä¸€å±‚çš„æ•°æ®éƒ½æ˜¯å¯¹ä¸‹ä¸€å±‚çš„è¿›ä¸€æ­¥å°è£…ã€‚ æ•°æ®åŒ…å°è£… åœ¨å‘é€æ–¹ï¼Œç”¨æˆ·ç¨‹åºéœ€è¦ä¼ è¾“çš„æ•°æ®ä¼šç»è¿‡é€å±‚å°è£…ã€‚é¦–å…ˆæ·»åŠ åº”ç”¨å±‚çš„ HTTP Headerï¼Œç„¶åæ˜¯ä¼ è¾“å±‚çš„ TCP Headerï¼Œæ¥ç€æ˜¯ç½‘ç»œå±‚çš„ IP Headerï¼Œæœ€ååœ¨é“¾è·¯å±‚æ·»åŠ ä»¥å¤ªç½‘å¸§çš„å¸§å¤´å’Œå¸§å°¾ï¼ŒåŒ…æ‹¬æº MAC åœ°å€ã€ç›®çš„ MAC åœ°å€ç­‰é“¾è·¯å±‚ä¿¡æ¯ï¼Œæœ€ç»ˆå½¢æˆç½‘ç»œä¸­ä¼ è¾“çš„å®Œæ•´æ•°æ®åŒ…ã€‚ åœ¨æ¥æ”¶æ–¹ï¼Œæ•°æ®åŒ…ä¼šæŒ‰ç›¸åçš„é¡ºåºé€å±‚è§£å°è£…ã€‚æ¥æ”¶è®¾å¤‡ä»é“¾è·¯å±‚å¼€å§‹è§£ææ•°æ®ï¼Œä¾æ¬¡è§£è¯»ç½‘ç»œå±‚ã€ä¼ è¾“å±‚å’Œåº”ç”¨å±‚çš„ä¿¡æ¯ï¼Œæœ€åå°†æ•°æ®ä¼ é€’ç»™æ¥æ”¶æ–¹çš„åº”ç”¨ç¨‹åºã€‚ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š æ•°æ®åŒ…å°è£… è§£æ æˆ‘ä»¬åœ¨ Wireshark ä¸­ç‚¹å¼€ä¸‹é¢çš„æ¯ä¸€å±‚ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼Œæˆ‘åœ¨å›¾æ ‡æ³¨äº†æœ€é‡è¦çš„å‡ ä¸ªä¿¡æ¯ï¼š ç½‘ç»œä¹‹æ—… ç»è¿‡ä¸Šè¿°å®éªŒï¼Œæˆ‘ä»¬å¯ä»¥åšä¸ªå°æ€»ç»“ï¼š é€šè¿‡ä¸Šè¿°å®éªŒï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ™°ç†è§£æ•°æ®åŒ…çš„ä¼ è¾“è¿‡ç¨‹ï¼š HTTP è¯·æ±‚æ˜¯ç½‘ç»œé€šä¿¡çš„åº”ç”¨å±‚å†…å®¹ï¼Œå®ƒéœ€è¦é€šè¿‡å„å±‚ç½‘ç»œåè®®çš„å°è£…æ‰èƒ½å®ç°ç«¯åˆ°ç«¯ä¼ è¾“ã€‚ ä»å‘é€æ–¹è§’åº¦ï¼Œæ•°æ®ä¼ è¾“éµå¾ªä¸€ä¸ªæ˜ç¡®çš„é€»è¾‘é¡ºåºï¼šé¦–å…ˆå°†åŸŸåï¼ˆexample.comï¼‰è§£æä¸º IP åœ°å€ï¼Œç„¶ååŸºäºè¯¥ IP åœ°å€å’Œç›®æ ‡ç«¯å£ï¼ˆ443ï¼‰å»ºç«‹ TCP è¿æ¥ï¼Œæ¥ç€æ‰¾åˆ°ç›®æ ‡ IP çš„ MAC åœ°å€ï¼Œæœ€ç»ˆç”±ç½‘å¡å°†å®Œæ•´å°è£…çš„æ•°æ®åŒ…å‘é€åˆ°ç½‘ç»œä¸­ã€‚ ä»æ¥æ”¶æ–¹è§’åº¦ï¼ŒæœåŠ¡å™¨å¤„ç†æ•°æ®åŒ…çš„è¿‡ç¨‹æ˜¯ä¸€ä¸ªè‡ªä¸‹è€Œä¸Šçš„è§£å°è£…è¿‡ç¨‹ï¼šæ•°æ®é“¾è·¯å±‚æ¥æ”¶åˆ°çš„å¸§åŒ…å«æº MAC åœ°å€ï¼Œç½‘ç»œå±‚è§£æå‡º IPv4 åœ°å€å’Œåè®®ç±»å‹ï¼Œä¼ è¾“å±‚è¯†åˆ«å‡º TCP åè®®å’Œæºç«¯å£å·ï¼Œæœ€ç»ˆåœ¨åº”ç”¨å±‚è·å–å¹¶å¤„ç† HTTP è¯·æ±‚æ•°æ®ã€‚æœåŠ¡å™¨æ ¹æ®è¿™äº›ä¿¡æ¯æ„å»ºå“åº”ï¼Œå¹¶æŒ‰ç›¸åé¡ºåºå°è£…è¿”å›ç»™å®¢æˆ·ç«¯ã€‚ è¿™ç§åˆ†å±‚å¤„ç†æœºåˆ¶ç¡®ä¿äº†ç½‘ç»œé€šä¿¡çš„çµæ´»æ€§å’Œå¯é æ€§ï¼Œæ¯å±‚åªéœ€å…³æ³¨è‡ªå·±çš„èŒè´£ï¼Œå…±åŒå®Œæˆç«¯åˆ°ç«¯çš„æ•°æ®ä¼ è¾“ä»»åŠ¡ã€‚ å¥½ï¼Œé‚£ä¹ˆè¿™é‡Œå°±æœ‰ 2 ä¸ªæœ€å…³é”®çš„é—®é¢˜ï¼š å¦‚ä½•é€šè¿‡åŸŸåè·å¾— IP åœ°å€ï¼Ÿ å¦‚ä½•é€šè¿‡ IP åœ°å€è·å– MAC åœ°å€ï¼Ÿ DNS è§£æ DNSï¼ˆDomain Name Systemï¼ŒåŸŸåç³»ç»Ÿï¼‰æ˜¯äº’è”ç½‘çš„ä¸€é¡¹æ ¸å¿ƒæœåŠ¡ï¼Œå®ƒå…è®¸æˆ‘ä»¬ä½¿ç”¨æ˜“è®°çš„åŸŸåï¼ˆå¦‚ example.comï¼‰è€Œä¸æ˜¯æ•°å­— IP åœ°å€ï¼ˆå¦‚ 93.184.216.34ï¼‰æ¥è®¿é—®ç½‘ç«™ã€‚ å½“ä½ åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ä¸€ä¸ªåŸŸåæ—¶ï¼ŒDNS è§£ææŒ‰ä»¥ä¸‹æ­¥éª¤è¿›è¡Œï¼š æµè§ˆå™¨ç¼“å­˜æ£€æŸ¥ï¼šæµè§ˆå™¨é¦–å…ˆæ£€æŸ¥è‡ªå·±çš„ç¼“å­˜ï¼Œçœ‹æ˜¯å¦å·²ç»å­˜å‚¨äº†è¯¥åŸŸåå¯¹åº”çš„ IP åœ°å€ã€‚ æ“ä½œç³»ç»Ÿç¼“å­˜æ£€æŸ¥ï¼šå¦‚æœæµè§ˆå™¨ç¼“å­˜ä¸­æ²¡æœ‰ï¼Œç³»ç»Ÿä¼šæ£€æŸ¥æ“ä½œç³»ç»Ÿçš„ DNS ç¼“å­˜ï¼ˆå¦‚ Windows çš„ DNS Client æœåŠ¡ï¼‰ã€‚ è·¯ç”±å™¨ç¼“å­˜æ£€æŸ¥ï¼šè‹¥ç³»ç»Ÿç¼“å­˜ä¸­ä¹Ÿæ²¡æœ‰ï¼Œè¯·æ±‚ä¼šè¢«å‘é€åˆ°ä½ çš„è·¯ç”±å™¨ï¼Œå®ƒä¹Ÿç»´æŠ¤ç€ä¸€ä¸ª DNS ç¼“å­˜ã€‚ ISP DNS æœåŠ¡å™¨æŸ¥è¯¢ï¼šå¦‚æœä»¥ä¸Šç¼“å­˜éƒ½æœªå‘½ä¸­ï¼Œè¯·æ±‚ä¼šè¢«å‘é€åˆ°ä½ çš„ ISPï¼ˆäº’è”ç½‘æœåŠ¡æä¾›å•†ï¼‰çš„ DNS æœåŠ¡å™¨ã€‚ é€’å½’æŸ¥è¯¢ï¼šISP çš„ DNS æœåŠ¡å™¨ä¼šæ‰§è¡Œé€’å½’æŸ¥è¯¢ï¼š é¦–å…ˆæŸ¥è¯¢æ ¹åŸŸåæœåŠ¡å™¨ï¼ˆRoot DNS Serverï¼‰ æ ¹æœåŠ¡å™¨ä¼šå¼•å¯¼åˆ°é¡¶çº§åŸŸåæœåŠ¡å™¨ï¼ˆTLD DNS Serverï¼Œå¦‚ .com, .net, .org ç­‰ï¼‰ é¡¶çº§åŸŸåæœåŠ¡å™¨ä¼šå¼•å¯¼åˆ°æƒå¨åŸŸåæœåŠ¡å™¨ï¼ˆAuthoritative DNS Serverï¼‰ æƒå¨æœåŠ¡å™¨ä¼šè¿”å›è¯¥åŸŸåçš„ IP åœ°å€ ç»“æœè¿”å›ä¸ç¼“å­˜ï¼šä¸€æ—¦è·å–åˆ° IP åœ°å€ï¼Œå®ƒä¼šè¢«æ²¿ç€æŸ¥è¯¢è·¯å¾„è¿”å›ï¼Œå¹¶åœ¨å„ä¸ªå±‚çº§ä¸Šç¼“å­˜ä¸€æ®µæ—¶é—´ï¼ˆç”± TTL å€¼å†³å®šï¼‰ã€‚ ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å·¥å…·æŸ¥è¯¢ DNS ä¿¡æ¯ï¼š nslookupï¼šnslookup example.com digï¼šdig example.com hostï¼šhost example.com è¿™äº›å·¥å…·å¯ä»¥å¸®åŠ©ä½ äº†è§£åŸŸåçš„è§£æè¿‡ç¨‹å’Œç»“æœã€‚ âœ ~ host example.comexample.com has address 23.215.0.138example.com has address 23.192.228.84example.com has address 23.215.0.136example.com has address 23.192.228.80example.com has address 96.7.128.175example.com has address 96.7.128.198example.com has IPv6 address 2600:1408:ec00:36::1736:7f31example.com has IPv6 address 2600:1406:3a00:21::173e:2e65example.com has IPv6 address 2600:1406:3a00:21::173e:2e66example.com has IPv6 address 2600:1406:bc00:53::b81e:94c8example.com has IPv6 address 2600:1406:bc00:53::b81e:94ceexample.com has IPv6 address 2600:1408:ec00:36::1736:7f24example.com mail is handled by 0 . é€šè¿‡ DNS è§£æå°†åŸŸåè½¬æ¢ä¸º IP åœ°å€åï¼Œç½‘ç»œé€šä¿¡çš„ä¸‹ä¸€æ­¥å°±æ˜¯ç¡®å®šå¦‚ä½•å°†æ•°æ®åŒ…å‘é€åˆ°ç›®æ ‡ IP åœ°å€ï¼Œè¿™å°±éœ€è¦ç”¨åˆ° ARP åè®®æ¥è·å–ç›®æ ‡è®¾å¤‡çš„ MAC åœ°å€ã€‚ ç©¿è¶Šå®¢æˆ·ç«¯å±€åŸŸç½‘ å½“æˆ‘ä»¬å‘é€ä¸€ä¸ªç½‘ç»œè¯·æ±‚æ—¶ï¼Œæ•°æ®åŒ…å¦‚ä½•æ‰¾åˆ°ç¦»å¼€å®¶åº­/åŠå…¬ç½‘ç»œçš„\"å‡ºå£\"ï¼Ÿ æ•°æ®åŒ…é¦–å…ˆéœ€è¦è§£å†³çš„æ˜¯\"è¯¥å¾€å“ªèµ°\"çš„é—®é¢˜ï¼š é—®é¢˜ï¼šæˆ‘éœ€è¦ç›´æ¥è”ç³»ç›®æ ‡è®¾å¤‡è¿˜æ˜¯æ‰¾ä¸ª\"ä¸­ä»‹\"ï¼Ÿ è§£å†³æ–¹æ¡ˆï¼šå­ç½‘åˆ¤æ–­ è®¾å¤‡ä¼šæ¯”è¾ƒç›®æ ‡ IP ä¸è‡ªå·±çš„ IP å’Œå­ç½‘æ©ç  å°±åƒåˆ¤æ–­æ”¶ä»¶äººæ˜¯ä¸æ˜¯ä½åœ¨åŒä¸€ä¸ªå°åŒº é—®é¢˜ï¼šå¦‚ä½•æ‰¾åˆ°åŒä¸€ç½‘ç»œä¸­çš„è®¾å¤‡ï¼Ÿ è§£å†³æ–¹æ¡ˆï¼šARP åè®® ç±»ä¼¼äºå°åŒºå¹¿æ’­ï¼š\"è°æ˜¯ 202 å·æˆ¿çš„ï¼Ÿè¯·å‘Šè¯‰æˆ‘ä½ çš„é—¨ç‰Œå·ï¼\" ç›®æ ‡è®¾å¤‡å›åº”è‡ªå·±çš„ MAC åœ°å€ï¼ˆè®¾å¤‡çš„\"èº«ä»½è¯å·\"ï¼‰ é—®é¢˜ï¼šç›®æ ‡åœ¨è¿œæ–¹ï¼Œå¦‚ä½•ç¦»å¼€æœ¬åœ°ç½‘ç»œï¼Ÿ è§£å†³æ–¹æ¡ˆï¼šé»˜è®¤ç½‘å…³ å°±åƒä¸è®¤è¯†è¿œæ–¹æ”¶ä»¶äººçš„åœ°å€ï¼Œå…ˆäº¤ç»™å°åŒºé—¨å«ï¼ˆè·¯ç”±å™¨ï¼‰ æ•°æ®åŒ…å¤´ä¸Šæ ‡æ³¨æœ€ç»ˆç›®çš„åœ° IPï¼Œä½†å…ˆé€åˆ°ç½‘å…³çš„ MAC åœ°å€ é—®é¢˜ï¼šæ•°æ®å¦‚ä½•åœ¨æœ¬åœ°ç½‘ç»œä¸­è½¬å‘ï¼Ÿ è§£å†³æ–¹æ¡ˆï¼šäº¤æ¢æœºçš„ MAC åœ°å€è¡¨ äº¤æ¢æœºå°±åƒå°åŒºå†…çš„å¿«é€’å‘˜ï¼Œè®°ä½äº†æ¯å®¶æ¯æˆ·çš„é—¨ç‰Œå· å®ƒæŸ¥è¡¨åå°†åŒ…è£¹ç²¾ç¡®é€åˆ°å¯¹åº”çš„é—¨å£ï¼Œä¸ä¼šæ‰“æ‰°å…¶ä»–ä½æˆ· ç®€å•æ¥è¯´ï¼Œæ•°æ®åŒ…åœ¨æœ¬åœ°ç½‘ç»œä¸­çš„æ—…ç¨‹å°±åƒæ˜¯å¿«é€’å…ˆç¡®è®¤æ”¶ä»¶äººæ˜¯å¦åœ¨åŒä¸€å°åŒºï¼Œå¦‚æœæ˜¯ï¼Œç›´æ¥é€è¾¾ï¼›å¦‚æœä¸æ˜¯ï¼Œåˆ™äº¤ç»™å°åŒºå‡ºå£çš„ä¿å®‰ï¼Œç”±ä»–è´Ÿè´£è¿›ä¸€æ­¥è½¬å‘ã€‚ ç©¿è¶Šå…¬ç½‘ æ•°æ®åŒ…ç¦»å¼€äº†æœ¬åœ°ç½‘ç»œï¼Œå¦‚ä½•åœ¨èŒ«èŒ«äº’è”ç½‘ä¸­æ‰¾åˆ°é¥è¿œçš„ç›®æ ‡æœåŠ¡å™¨ï¼Ÿ æ•°æ®åŒ…åœ¨äº’è”ç½‘ä¸Šçš„æ—…ç¨‹å°±åƒä¸€æ¬¡è·¨å›½æ—…è¡Œï¼š é—®é¢˜ï¼šå¦‚ä½•ä»ç§äººåŒºåŸŸè¿›å…¥å…¬å…±ä¸–ç•Œï¼Ÿ è§£å†³æ–¹æ¡ˆï¼šNATï¼ˆç½‘ç»œåœ°å€è½¬æ¢ï¼‰ å°±åƒå¤šäººå…±ç”¨ä¸€ä¸ªæŠ¤ç…§å‡ºå›½ï¼Œæœ¬åœ°è®¾å¤‡å…±äº«ä¸€ä¸ªå…¬ç½‘ IP è·¯ç”±å™¨ä¼šè®°ä½è°å‘äº†ä»€ä¹ˆè¯·æ±‚ï¼Œå›ç¨‹æ—¶èƒ½é€å›æ­£ç¡®çš„è®¾å¤‡ é—®é¢˜ï¼šäº’è”ç½‘å¦‚æ­¤åºå¤§å¤æ‚ï¼Œè°æ¥ç®¡ç†è¿™äº›ç½‘ç»œï¼Ÿ è§£å†³æ–¹æ¡ˆï¼šè‡ªæ²»ç³»ç»Ÿï¼ˆAutonomous System, ASï¼‰ AS å°±åƒäº’è”ç½‘ä¸–ç•Œçš„\"å›½å®¶\"æˆ–\"ç‹¬ç«‹ç‹å›½\" æ¯ä¸ª AS ç”±å•ä¸€æŠ€æœ¯ç®¡ç†æœºæ„æ§åˆ¶ï¼ˆå¦‚ ISPã€å¤§ä¼ä¸šæˆ–æ•™è‚²æœºæ„ï¼‰ ä½ çš„æ•°æ®åŒ…é¦–å…ˆè¿›å…¥ä½ çš„ ISP æ‰€åœ¨çš„ ASï¼Œç„¶åå¯èƒ½ç©¿è¶Šå¤šä¸ª AS æ¯ä¸ª AS æœ‰å”¯ä¸€çš„ AS å·ï¼ˆASNï¼‰ï¼Œå¦‚ AS7018(ATT) æˆ– AS8075(Microsoft) é—®é¢˜ï¼šè¿™äº›\"ç½‘ç»œç‹å›½\"å¦‚ä½•ç›¸äº’é€šä¿¡å’Œåˆä½œï¼Ÿ è§£å†³æ–¹æ¡ˆï¼šBGP åè®®(è¾¹ç•Œç½‘å…³åè®®) BGP æ˜¯ AS ä¹‹é—´çš„\"å¤–äº¤è¯­è¨€\"ï¼Œç”¨äºå®£å‘Šè·¯ç”±ä¿¡æ¯ å®ƒå‘Šè¯‰å…¶ä»– ASï¼š\"é€šè¿‡æˆ‘å¯ä»¥åˆ°è¾¾è¿™äº›ç½‘ç»œ\" è·¯ç”±å™¨æ ¹æ® BGP ä¿¡æ¯ï¼Œå†³å®šæ•°æ®åŒ…åº”è¯¥ç»è¿‡å“ªäº› AS é—®é¢˜ï¼šå¦‚ä½•å†³å®šæ•°æ®åŒ…åœ¨ AS å†…éƒ¨è¯¥èµ°å“ªæ¡è·¯ï¼Ÿ è§£å†³æ–¹æ¡ˆï¼šå†…éƒ¨è·¯ç”±åè®® AS å†…éƒ¨ä½¿ç”¨ OSPF æˆ– IS-IS ç­‰åè®®æ¥æ‰¾åˆ°æœ€ä½³è·¯å¾„ è·¯ç”±å™¨åƒåŸå¸‚ä¸­çš„äº¤é€šæŒ‡æŒ¥ï¼Œæ ¹æ®\"è·¯å†µ\"å†³å®šä¸‹ä¸€ä¸ªæ–¹å‘ é—®é¢˜ï¼šä¸åŒè¿è¥å•†ä¹‹é—´å¦‚ä½•è¿æ¥ï¼Ÿ è§£å†³æ–¹æ¡ˆï¼šäº’è”ç½‘äº¤æ¢ä¸­å¿ƒï¼ˆIXPï¼‰ å°±åƒä¸åŒèˆªç©ºå…¬å¸åœ¨å¤§å‹æ¢çº½æœºåœºäº¤æ¢ä¹˜å®¢ æ•°æ®åŒ…åœ¨ IXP ä»ä¸€ä¸ª AS â€œè½¬æœºâ€åˆ°å¦ä¸€ä¸ª AS è¿™å‡å°‘äº†è·¯å¾„é•¿åº¦ï¼Œæé«˜äº†ä¼ è¾“æ•ˆç‡ é—®é¢˜ï¼šæˆ‘èƒ½çŸ¥é“æˆ‘çš„æ•°æ®ç»è¿‡äº†å“ªäº›åœ°æ–¹å—ï¼Ÿ è§£å†³æ–¹æ¡ˆï¼šè·¯å¾„è¿½è¸ªå·¥å…· traceroute/tracert å°±åƒç»™æ•°æ®åŒ…è£…ä¸Š GPS ä½ å¯ä»¥çœ‹åˆ°æ•°æ®åŒ…ç©¿è¶Šçš„ä¸åŒ AS å’Œè·¯ç”±å™¨ äº’è”ç½‘å°±åƒä¸€ä¸ªå·¨å¤§çš„å…¨çƒå¿«é€’ç½‘ç»œï¼Œä½ çš„æ•°æ®åŒ…å¯èƒ½ç©¿è¶Šå¤šä¸ªå›½å®¶ã€ç»è¿‡æµ·åº•ç”µç¼†ï¼Œç”±ä¸åŒçš„è¿è¥å•†æ¥åŠ›ä¼ é€’ï¼Œæœ€ç»ˆåˆ°è¾¾ç›®çš„åœ°çš„ç½‘ç»œã€‚ ç©¿è¶ŠæœåŠ¡ç«¯å±€åŸŸç½‘ æ•°æ®åŒ…åˆ°è¾¾ç›®æ ‡æ‰€åœ¨ç½‘ç»œåï¼Œå¦‚ä½•æ‰¾åˆ°å¹¶åˆ°è¾¾æœ€ç»ˆçš„æœåŠ¡å™¨ï¼Ÿ æ•°æ®åŒ…æŠµè¾¾ç›®çš„åœ°ç½‘ç»œï¼Œå°±åƒå›½é™…å¿«é€’åˆ°è¾¾ç›®æ ‡åŸå¸‚ï¼Œè¿˜éœ€è¦æœ€åä¸€æ®µ\"æœ¬åœ°é…é€\"ï¼š é—®é¢˜ï¼šå¦‚ä½•ç¡®ä¿åªæœ‰åˆæ³•è¯·æ±‚èƒ½è¿›å…¥ç½‘ç»œï¼Ÿ è§£å†³æ–¹æ¡ˆï¼šé˜²ç«å¢™å’Œå®‰å…¨ç­–ç•¥ å°±åƒæœºåœºæµ·å…³ï¼Œæ£€æŸ¥å…¥å¢ƒè€…æ˜¯å¦ç¬¦åˆå…¥å¢ƒæ¡ä»¶ åªæœ‰åˆæ³•çš„æ•°æ®åŒ…æ‰èƒ½é€šè¿‡å®‰å…¨æ£€æŸ¥ é—®é¢˜ï¼šå¤§å‹ç½‘ç«™å¦‚ä½•å¤„ç†æµ·é‡è¯·æ±‚ï¼Ÿ è§£å†³æ–¹æ¡ˆï¼šè´Ÿè½½å‡è¡¡ åƒå¤§å‹åŒ»é™¢çš„åˆ†è¯Šå°ï¼Œå°†ç—…äººåˆ†é…åˆ°ä¸åŒçš„åŒ»ç”Ÿå¤„ æ ¹æ®æœåŠ¡å™¨è´Ÿè½½ã€ç”¨æˆ·ä½ç½®ç­‰å› ç´ æ™ºèƒ½åˆ†å‘è¯·æ±‚ é—®é¢˜ï¼šå¦‚ä½•åœ¨æ•°æ®ä¸­å¿ƒå¤æ‚ç¯å¢ƒä¸­æ‰¾åˆ°ç›®æ ‡æœåŠ¡å™¨ï¼Ÿ è§£å†³æ–¹æ¡ˆï¼šå†…éƒ¨è·¯ç”±ä¸æœ€åä¸€è·³ ARP æ•°æ®ä¸­å¿ƒå†…éƒ¨æœ‰è‡ªå·±çš„\"åœ°å›¾\"å’Œ\"é“è·¯ç³»ç»Ÿ\" æœ€åä¸€ä¸ªè·¯ç”±å™¨ä¼šé€šè¿‡ ARP æ‰¾åˆ°æœåŠ¡å™¨çš„å…·ä½“ä½ç½® é—®é¢˜ï¼šç°ä»£äº‘ç¯å¢ƒä¸­ï¼ŒæœåŠ¡å™¨å¯èƒ½æ˜¯è™šæ‹Ÿçš„ï¼Œæ€ä¹ˆå¤„ç†ï¼Ÿ è§£å†³æ–¹æ¡ˆï¼šè™šæ‹Ÿç½‘ç»œ ç‰©ç†æœåŠ¡å™¨ä¸Šå¯èƒ½è¿è¡Œå¤šä¸ªè™šæ‹Ÿæœºæˆ–å®¹å™¨ è™šæ‹Ÿäº¤æ¢æœºå°†æ•°æ®åŒ…å‡†ç¡®é€è¾¾è™šæ‹Ÿç¯å¢ƒä¸­çš„ç›®æ ‡åº”ç”¨ è¿™å°±åƒå›½é™…å¿«é€’æœ€åçš„â€œæœ€åä¸€å…¬é‡Œâ€é…é€ - ä»ç›®çš„åœ°åŸå¸‚çš„åˆ†æ‹£ä¸­å¿ƒï¼Œç»è¿‡å±‚å±‚ç­›é€‰ï¼Œæœ€ç»ˆé€åˆ°æ”¶ä»¶äººæ‰‹ä¸­ã€‚ æ€»ç»“ ç½‘ç»œè¯·æ±‚å°±åƒä¸€å°å›½é™…ä¿¡ä»¶çš„æ—…ç¨‹ï¼š æœ¬åœ°æŠ•é€’ï¼šä»ä½ å®¶å‡ºå‘ï¼Œåˆ¤æ–­æ”¶ä»¶äººæ˜¯å¦åœ¨åŒå°åŒºã€‚å¦‚ä¸åœ¨ï¼Œäº¤ç»™å°åŒºå‡ºå£çš„é—¨å«ï¼ˆç½‘å…³ï¼‰ã€‚ å›½é™…è¿è¾“ï¼š å…ˆç»è¿‡ä½ æ‰€åœ¨â€œå›½å®¶â€ï¼ˆä½  ISP çš„ ASï¼‰çš„æµ·å…³ï¼ˆNATï¼‰ ç„¶åå¯èƒ½ç©¿è¶Šå¤šä¸ªâ€œå›½å®¶â€ï¼ˆä¸åŒçš„ ASï¼‰ å„å›½æµ·å…³ï¼ˆè·¯ç”±å™¨ï¼‰é€šè¿‡â€œå›½é™…æ¡çº¦â€ï¼ˆBGPï¼‰å†³å®šåŒ…è£¹èµ°å‘ æœ‰æ—¶é€šè¿‡â€œå›½é™…ä¸­è½¬ç«™â€ï¼ˆIXPï¼‰å¿«é€Ÿè½¬è¿åˆ°å…¶ä»–â€œå›½å®¶â€ ç›®çš„åœ°é…é€ï¼š é€šè¿‡ç›®çš„åœ°â€œæµ·å…³â€ï¼ˆé˜²ç«å¢™ï¼‰å…¥å¢ƒæ£€æŸ¥ ç»è¿‡â€œåˆ†æ‹£ä¸­å¿ƒâ€ï¼ˆè´Ÿè½½å‡è¡¡å™¨ï¼‰åˆ†é…å¤„ç†äººå‘˜ æœ€ç»ˆé€šè¿‡â€œæœ¬åœ°å¿«é€’å‘˜â€ï¼ˆå†…éƒ¨è·¯ç”±å’Œäº¤æ¢ï¼‰é€è¾¾æ”¶ä»¶äººæ‰‹ä¸­ æ•°æ®åŒ…å°±è¿™æ ·å®Œæˆäº†å®¢æˆ·ç«¯è®¾å¤‡åˆ°æœåŠ¡å™¨çš„å…¨ç¨‹æ—…è¡Œï¼Œç„¶åæœåŠ¡å™¨çš„å“åº”å†æ²¿ç€ç±»ä¼¼çš„è·¯å¾„è¿”å›åˆ°å®¢æˆ·ç«¯è®¾å¤‡ï¼Œå®Œæˆæ•´ä¸ªè¯·æ±‚-å“åº”å¾ªç¯ã€‚ å‚è€ƒ æå®¢æ—¶é—´ã€Šç½‘ç»œæ¶æ„å®æˆ˜è¯¾ã€‹ Difference Between OSI Model and TCP/IP Model","tags":["è®¡ç®—æœºç½‘ç»œ"],"categories":["è®¡ç®—æœºåŸºç¡€","è®¡ç®—æœºç½‘ç»œ"]},{"title":"è§£å†³æ–¹æ¡ˆä¸¨æ¸¸æˆåç«¯ä¸­çš„ Push-ACK æœºåˆ¶è®¾è®¡ä¸å†…å­˜ä¼˜åŒ–","path":"/2025/02/27/solution-push-ack/","content":"å¼•è¨€ åœ¨ç°ä»£åœ¨çº¿æ¸¸æˆå¼€å‘ä¸­ï¼ŒæœåŠ¡å™¨ä¸å®¢æˆ·ç«¯ä¹‹é—´å®æ—¶ã€å¯é çš„é€šä¿¡æœºåˆ¶æ˜¯æ¸¸æˆä½“éªŒçš„åŸºçŸ³ã€‚ä½œä¸ºä¸€åæ¸¸æˆåç«¯å¼€å‘è€…ï¼Œæˆ‘æ›¾ç»é‡åˆ°è¿‡è¿™æ ·çš„åœºæ™¯ï¼šæ›´æ–°äº†ä¸€ä¸ªå…¬ä¼šç³»ç»Ÿçš„æ–°åŠŸèƒ½ï¼ŒæœåŠ¡å™¨éœ€è¦å‘æˆåƒä¸Šä¸‡ä¸ªåœ¨çº¿ç©å®¶æ¨é€å…¬ä¼šçŠ¶æ€å˜æ›´ã€‚çŸ­çŸ­å‡ å°æ—¶åï¼ŒæœåŠ¡å™¨å†…å­˜ä½¿ç”¨ç‡é£™å‡è‡³ 90%ï¼Œç³»ç»Ÿå‘Šè­¦ä¸æ–­ã€‚é—®é¢˜å‡ºåœ¨å“ªé‡Œï¼ŸPush æ¶ˆæ¯çš„å¯é æ€§æœºåˆ¶å®ç°ä¸å½“å¯¼è‡´äº†å†…å­˜æ³„æ¼ã€‚ æœ¬æ–‡å°†æ·±å…¥æ¢è®¨æ¸¸æˆåç«¯ä¸­ Push-ACK æœºåˆ¶çš„è®¾è®¡ä¸å®ç°ï¼Œç‰¹åˆ«å…³æ³¨å¦‚ä½•é¿å…å†…å­˜æš´æ¶¨é—®é¢˜ï¼Œåˆ†äº«æˆ‘åœ¨å¤šä¸ªå¤§å‹æ¸¸æˆé¡¹ç›®ä¸­ç§¯ç´¯çš„ç»éªŒä¸æ•™è®­ã€‚ èƒŒæ™¯ï¼šä¸ºä»€ä¹ˆéœ€è¦åº”ç”¨å±‚çš„ ACK æœºåˆ¶ï¼Ÿ TCP åè®®ç¡®å®æä¾›äº†å¯é çš„æ•°æ®ä¼ è¾“ä¿è¯ï¼ŒåŒ…æ‹¬æ•°æ®åŒ…çš„åºåˆ—å·ã€æ ¡éªŒå’Œã€è¶…æ—¶é‡ä¼ ç­‰æœºåˆ¶ã€‚é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬è¿˜éœ€è¦åœ¨åº”ç”¨å±‚å®ç°é¢å¤–çš„ ACK æœºåˆ¶å‘¢ï¼Ÿ TCP å¯é æ€§çš„è¾¹ç•Œ TCP åªèƒ½ä¿è¯æ•°æ®è¢«é€è¾¾åˆ°å®¢æˆ·ç«¯çš„ç½‘ç»œæ ˆï¼Œä½†æ— æ³•ä¿è¯ï¼š æ•°æ®è¢«å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºæ­£ç¡®å¤„ç† å¤„ç†è¿‡ç¨‹ä¸­æ²¡æœ‰å‡ºç°å¼‚å¸¸ å®¢æˆ·ç«¯çš„ä¸šåŠ¡é€»è¾‘æ­£ç¡®æ‰§è¡Œ æƒ³è±¡è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼šæœåŠ¡å™¨å‘ç©å®¶æ¨é€äº†ä¸€æ¡\"è·å¾—ç¨€æœ‰è£…å¤‡\"çš„æ¶ˆæ¯ï¼ŒTCP ç¡®ä¿äº†æ•°æ®é€è¾¾å®¢æˆ·ç«¯ï¼Œä½†å¦‚æœå®¢æˆ·ç«¯åœ¨å¤„ç†è¿™ä¸ªæ¶ˆæ¯æ—¶å´©æºƒäº†å‘¢ï¼Ÿå¯¹äºæ¸¸æˆè¿™ç±»çŠ¶æ€æ•æ„Ÿçš„åº”ç”¨ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“æ¶ˆæ¯æ˜¯å¦è¢«æˆåŠŸå¤„ç†ï¼Œè€Œä¸ä»…ä»…æ˜¯æˆåŠŸä¼ è¾“ã€‚ ä¸šåŠ¡å¯é æ€§éœ€æ±‚ å®é™…æ¸¸æˆå¼€å‘ä¸­ï¼Œä¸åŒç±»å‹çš„æ¶ˆæ¯æœ‰ä¸åŒçš„å¯é æ€§éœ€æ±‚ï¼š æ¶ˆæ¯ç±»å‹ ç¤ºä¾‹ å¯é æ€§éœ€æ±‚ å…³é”®çŠ¶æ€å˜æ›´ é“å…·è·å–ã€è´§å¸å˜åŒ– æé«˜ï¼ˆå¿…é¡»ç¡®è®¤å¤„ç†ï¼‰ æ¸¸æˆè¿›ç¨‹é€šçŸ¥ ä»»åŠ¡æ›´æ–°ã€æˆå°±è§£é” é«˜ï¼ˆéœ€è¦ç¡®è®¤ï¼‰ å®æ—¶ä½ç½®åŒæ­¥ ç©å®¶ä½ç½®ã€NPC ç§»åŠ¨ ä¸­ï¼ˆæ–°æ•°æ®å¯è¦†ç›–æ—§æ•°æ®ï¼‰ ç¯å¢ƒä¿¡æ¯ å¤©æ°”å˜åŒ–ã€èƒŒæ™¯éŸ³ä¹ ä½ï¼ˆå¯æ¥å—å¶å°”ä¸¢å¤±ï¼‰ è®¾è®¡é€šç”¨çš„ Push-ACK æœºåˆ¶ ä¸€ä¸ªå®Œå–„çš„ Push-ACK æœºåˆ¶éœ€è¦è€ƒè™‘ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼šæ¶ˆæ¯å”¯ä¸€æ ‡è¯†ã€ä¼˜å…ˆçº§åˆ†çº§ã€è¶…æ—¶é‡è¯•ã€æ‰¹é‡ç¡®è®¤å’Œå¤±è´¥å¤„ç†ã€‚ä¸‹é¢æ˜¯åŸºäº Go è¯­è¨€çš„è®¾è®¡å®ç°ï¼š æ ¸å¿ƒæ•°æ®ç»“æ„ // Message è¡¨ç¤ºæœåŠ¡å™¨æ¨é€çš„æ¶ˆæ¯type Message struct MsgID string `json:msg_id` // å”¯ä¸€æ¶ˆæ¯æ ‡è¯† MsgType string `json:msg_type` // æ¶ˆæ¯ç±»å‹ Timestamp int64 `json:timestamp` // å‘é€æ—¶é—´æˆ³ Priority int `json:priority` // ä¼˜å…ˆçº§ï¼š1-é«˜ï¼Œ2-ä¸­ï¼Œ3-ä½ Payload interface `json:payload` // æ¶ˆæ¯å†…å®¹ RequiresAck bool `json:requires_ack` // æ˜¯å¦éœ€è¦ç¡®è®¤ Expiration int64 `json:expiration` // è¿‡æœŸæ—¶é—´æˆ³// AckMessage è¡¨ç¤ºå®¢æˆ·ç«¯çš„ç¡®è®¤æ¶ˆæ¯type AckMessage struct AckID string `json:ack_id` // å¯¹åº”åŸæ¶ˆæ¯ID Status string `json:status` // çŠ¶æ€ï¼šsuccess/failed/partial ClientTimestamp int64 `json:client_timestamp` // å®¢æˆ·ç«¯å¤„ç†æ—¶é—´ ErrorCode int `json:error_code` // é”™è¯¯ç  ErrorMessage string `json:error_message` // é”™è¯¯ä¿¡æ¯// BatchAckMessage è¡¨ç¤ºæ‰¹é‡ç¡®è®¤æ¶ˆæ¯type BatchAckMessage struct BatchAck bool `json:batch_ack` // æ‰¹é‡ç¡®è®¤æ ‡å¿— AckIDs []string `json:ack_ids` // æ¶ˆæ¯IDåˆ—è¡¨ Status string `json:status` // çŠ¶æ€ ClientTimestamp int64 `json:client_timestamp`// ç¡®è®¤æ—¶é—´// PendingMessageInfo è¡¨ç¤ºç­‰å¾…ç¡®è®¤çš„æ¶ˆæ¯ä¿¡æ¯type PendingMessageInfo struct ClientID string // å®¢æˆ·ç«¯ID Message *Message // åŸå§‹æ¶ˆæ¯ SentTime int64 // å‘é€æ—¶é—´ RetryCount int // é‡è¯•æ¬¡æ•° æœåŠ¡å™¨ç«¯ Push ç®¡ç†å™¨å®ç° // PushManager è´Ÿè´£ç®¡ç†æ¨é€æ¶ˆæ¯å’Œç¡®è®¤type PushManager struct pendingMessages map[string]*PendingMessageInfo // ç­‰å¾…ç¡®è®¤çš„æ¶ˆæ¯ clientMessageCount map[string]int // æ¯ä¸ªå®¢æˆ·ç«¯çš„æ¶ˆæ¯æ•°é‡ ackTimeout int64 // ç¡®è®¤è¶…æ—¶æ—¶é—´(ç§’) maxRetries int // æœ€å¤§é‡è¯•æ¬¡æ•° maxPendingPerClient int // æ¯å®¢æˆ·ç«¯æœ€å¤§æ¶ˆæ¯æ•° maxMessageAge int64 // æ¶ˆæ¯æœ€å¤§ç”Ÿå­˜æ—¶é—´(ç§’) // å†…å­˜ç›‘æ§ç›¸å…³ memoryThresholdMB int64 // å†…å­˜é˜ˆå€¼(MB) criticalThresholdMB int64 // å±é™©å†…å­˜é˜ˆå€¼(MB) mutex sync.RWMutex // ä¿æŠ¤å¹¶å‘è®¿é—® // ç½‘ç»œæ¥å£ï¼ˆä¾èµ–å¤–éƒ¨å®ç°ï¼‰ networkLayer NetworkInterface// NewPushManager åˆ›å»ºä¸€ä¸ªæ–°çš„æ¨é€ç®¡ç†å™¨func NewPushManager(networkLayer NetworkInterface) *PushManager pm := PushManager pendingMessages: make(map[string]*PendingMessageInfo), clientMessageCount: make(map[string]int), ackTimeout: 10, maxRetries: 3, maxPendingPerClient: 1000, maxMessageAge: 300, memoryThresholdMB: 1000, // 1GB criticalThresholdMB: 1500, // 1.5GB networkLayer: networkLayer, // å¯åŠ¨åå°ä»»åŠ¡ go pm.checkTimeoutsLoop() go pm.cleanupLoop() go pm.memoryMonitorLoop() return pm// PushMessage å‘å®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯func (pm *PushManager) PushMessage(clientID string, message *Message) bool // å¦‚æœä¸éœ€è¦ç¡®è®¤ï¼Œç›´æ¥å‘é€ if !message.RequiresAck return pm.networkLayer.SendToClient(clientID, message) pm.mutex.Lock() defer pm.mutex.Unlock() // æ£€æŸ¥å®¢æˆ·ç«¯æ¶ˆæ¯æ•°æ˜¯å¦è¶…é™ if pm.clientMessageCount[clientID] = pm.maxPendingPerClient pm.handleQueueOverflow(clientID, message) return false // å­˜å‚¨å¾…ç¡®è®¤æ¶ˆæ¯ pm.pendingMessages[message.MsgID] = PendingMessageInfo ClientID: clientID, Message: message, SentTime: time.Now().Unix(), RetryCount: 0, // æ›´æ–°å®¢æˆ·ç«¯æ¶ˆæ¯è®¡æ•° pm.clientMessageCount[clientID]++ // å‘é€æ¶ˆæ¯ return pm.networkLayer.SendToClient(clientID, message)// ProcessAck å¤„ç†å®¢æˆ·ç«¯çš„ç¡®è®¤æ¶ˆæ¯func (pm *PushManager) ProcessAck(clientID string, ack *AckMessage) bool pm.mutex.Lock() defer pm.mutex.Unlock() info, exists := pm.pendingMessages[ack.AckID] if !exists || info.ClientID != clientID return false // ç¡®è®¤æˆåŠŸï¼Œåˆ é™¤æ¶ˆæ¯ delete(pm.pendingMessages, ack.AckID) pm.clientMessageCount[clientID]-- // å¦‚æœå®¢æˆ·ç«¯æ²¡æœ‰å¾…ç¡®è®¤æ¶ˆæ¯äº†ï¼Œæ¸…ç†è®¡æ•°å™¨ if pm.clientMessageCount[clientID] = 0 delete(pm.clientMessageCount, clientID) return true// ProcessBatchAck å¤„ç†æ‰¹é‡ç¡®è®¤func (pm *PushManager) ProcessBatchAck(clientID string, batchAck *BatchAckMessage) int pm.mutex.Lock() defer pm.mutex.Unlock() confirmedCount := 0 for _, ackID := range batchAck.AckIDs info, exists := pm.pendingMessages[ackID] if exists info.ClientID == clientID delete(pm.pendingMessages, ackID) pm.clientMessageCount[clientID]-- confirmedCount++ // å¦‚æœå®¢æˆ·ç«¯æ²¡æœ‰å¾…ç¡®è®¤æ¶ˆæ¯äº†ï¼Œæ¸…ç†è®¡æ•°å™¨ if pm.clientMessageCount[clientID] = 0 delete(pm.clientMessageCount, clientID) return confirmedCount// åå°ä»»åŠ¡ï¼šè¶…æ—¶æ£€æŸ¥ä¸é‡è¯•func (pm *PushManager) checkTimeoutsLoop() ticker := time.NewTicker(5 * time.Second) defer ticker.Stop() for range ticker.C pm.checkTimeouts() // è¶…æ—¶æ£€æŸ¥ä¸é‡è¯•func (pm *PushManager) checkTimeouts() pm.mutex.Lock() defer pm.mutex.Unlock() now := time.Now().Unix() for msgID, info := range pm.pendingMessages // æ£€æŸ¥æ˜¯å¦è¶…æ—¶ if now - info.SentTime pm.ackTimeout if info.RetryCount pm.maxRetries // å¢åŠ é‡è¯•æ¬¡æ•° info.RetryCount++ info.SentTime = now // é‡æ–°å‘é€ pm.networkLayer.SendToClient(info.ClientID, info.Message) log.Printf(Retrying message %s to client %s, attempt %d, msgID, info.ClientID, info.RetryCount) else // è¶…å‡ºæœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ”¾å¼ƒå¹¶è®°å½• log.Printf(Message %s to client %s failed after %d attempts, msgID, info.ClientID, pm.maxRetries) delete(pm.pendingMessages, msgID) pm.clientMessageCount[info.ClientID]-- // é€šçŸ¥ä¸šåŠ¡å±‚å¤„ç†å¤±è´¥ go pm.notifyMessageFailed(info.ClientID, info.Message) è§£å†³å†…å­˜æš´æ¶¨é—®é¢˜ åœ¨å¤§å‹æ¸¸æˆä¸­ï¼ŒæœåŠ¡å™¨å¯èƒ½åŒæ—¶ç»´æŠ¤æ•°åä¸‡ç”šè‡³ä¸Šç™¾ä¸‡ä¸ªè¿æ¥ï¼Œå¦‚æœæ¯ä¸ªè¿æ¥éƒ½æœ‰æ•°ç™¾æ¡å¾…ç¡®è®¤æ¶ˆæ¯ï¼ŒæœåŠ¡å™¨å†…å­˜å¾ˆå¿«å°±ä¼šçˆ†æ»¡ã€‚ä»¥ä¸‹æ˜¯æˆ‘åœ¨å®è·µä¸­æ€»ç»“çš„å‡ ç§é«˜æ•ˆå†…å­˜ç®¡ç†ç­–ç•¥ï¼š 1. å‘¨æœŸæ€§è¿‡æœŸæ¶ˆæ¯æ¸…ç† // æ¸…ç†è¿‡æœŸæ¶ˆæ¯çš„åå°å¾ªç¯func (pm *PushManager) cleanupLoop() ticker := time.NewTicker(1 * time.Minute) defer ticker.Stop() for range ticker.C pm.cleanExpiredMessages() // æ¸…ç†è¿‡æœŸæ¶ˆæ¯func (pm *PushManager) cleanExpiredMessages() pm.mutex.Lock() defer pm.mutex.Unlock() now := time.Now().Unix() expiredCount := 0 for msgID, info := range pm.pendingMessages // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦è¿‡æœŸ if now - info.SentTime pm.maxMessageAge delete(pm.pendingMessages, msgID) pm.clientMessageCount[info.ClientID]-- expiredCount++ // è®°å½•æ—¥å¿— log.Printf(Cleaned expired message %s to client %s (age: %d seconds), msgID, info.ClientID, now - info.SentTime) if expiredCount 0 log.Printf(Cleanup: Removed %d expired messages, expiredCount) 2. æ¶ˆæ¯å‹ç¼©ä¸åˆå¹¶ // CompressMessage å‹ç¼©æ¶ˆæ¯ä»¥å‡å°‘å†…å­˜å ç”¨func CompressMessage(message *Message) []byte // å°†æ¶ˆæ¯è½¬ä¸ºJSON jsonData, err := json.Marshal(message) if err != nil log.Printf(Error marshaling message: %v, err) return nil // ä½¿ç”¨gzipå‹ç¼© var buf bytes.Buffer writer := gzip.NewWriter(buf) _, err = writer.Write(jsonData) if err != nil log.Printf(Error compressing message: %v, err) return nil if err := writer.Close(); err != nil log.Printf(Error closing gzip writer: %v, err) return nil return buf.Bytes()// DecompressMessage è§£å‹ç¼©æ¶ˆæ¯func DecompressMessage(compressed []byte) (*Message, error) reader, err := gzip.NewReader(bytes.NewReader(compressed)) if err != nil return nil, fmt.Errorf(create gzip reader: %w, err) defer reader.Close() var buf bytes.Buffer if _, err := io.Copy(buf, reader); err != nil return nil, fmt.Errorf(decompress data: %w, err) var message Message if err := json.Unmarshal(buf.Bytes(), message); err != nil return nil, fmt.Errorf(unmarshal json: %w, err) return message, nil 3. åˆ†çº§å­˜å‚¨ç­–ç•¥ // PushManager å¢åŠ åˆ†çº§å­˜å‚¨åŠŸèƒ½type PushManager struct // ... ä¹‹å‰çš„å­—æ®µ ... // å†…å­˜ä¸­å­˜å‚¨é«˜ä¼˜å…ˆçº§æ¶ˆæ¯ memoryPending map[string]*PendingMessageInfo // Rediså®¢æˆ·ç«¯ï¼Œç”¨äºå­˜å‚¨ä½ä¼˜å…ˆçº§æ¶ˆæ¯ redisClient *redis.Client redisKeyPrefix string redisExpiry time.Duration// PushMessage åˆ†çº§å­˜å‚¨ç‰ˆæœ¬func (pm *PushManager) PushMessage(clientID string, message *Message) bool // å¦‚æœä¸éœ€è¦ç¡®è®¤ï¼Œç›´æ¥å‘é€ if !message.RequiresAck return pm.networkLayer.SendToClient(clientID, message) pm.mutex.Lock() defer pm.mutex.Unlock() // æ£€æŸ¥å®¢æˆ·ç«¯æ¶ˆæ¯æ•°é‡é™åˆ¶ if pm.clientMessageCount[clientID] = pm.maxPendingPerClient pm.handleQueueOverflow(clientID, message) return false pm.clientMessageCount[clientID]++ // æ ¹æ®ä¼˜å…ˆçº§é€‰æ‹©å­˜å‚¨ä½ç½® if message.Priority = 2 // é«˜ä¼˜å…ˆçº§å’Œä¸­ä¼˜å…ˆçº§ // å­˜å…¥å†…å­˜ pm.memoryPending[message.MsgID] = PendingMessageInfo ClientID: clientID, Message: message, SentTime: time.Now().Unix(), RetryCount: 0, else // ä½ä¼˜å…ˆçº§ // å­˜å…¥Redis messageInfo := PendingMessageInfo ClientID: clientID, Message: message, SentTime: time.Now().Unix(), RetryCount: 0, jsonData, err := json.Marshal(messageInfo) if err != nil log.Printf(Error marshaling message: %v, err) pm.clientMessageCount[clientID]-- return false redisKey := pm.redisKeyPrefix + message.MsgID err = pm.redisClient.Set(context.Background(), redisKey, jsonData, pm.redisExpiry).Err() if err != nil log.Printf(Error storing message in Redis: %v, err) pm.clientMessageCount[clientID]-- return false // å‘é€æ¶ˆæ¯ return pm.networkLayer.SendToClient(clientID, message)// ProcessAck åˆ†çº§å­˜å‚¨ç‰ˆæœ¬func (pm *PushManager) ProcessAck(clientID string, ack *AckMessage) bool pm.mutex.Lock() defer pm.mutex.Unlock() // å…ˆæ£€æŸ¥å†…å­˜ä¸­çš„æ¶ˆæ¯ info, existsInMemory := pm.memoryPending[ack.AckID] if existsInMemory info.ClientID == clientID delete(pm.memoryPending, ack.AckID) pm.clientMessageCount[clientID]-- if pm.clientMessageCount[clientID] = 0 delete(pm.clientMessageCount, clientID) return true // å†æ£€æŸ¥Redisä¸­çš„æ¶ˆæ¯ redisKey := pm.redisKeyPrefix + ack.AckID exists, err := pm.redisClient.Exists(context.Background(), redisKey).Result() if err != nil log.Printf(Error checking message in Redis: %v, err) return false if exists == 1 // è·å–æ¶ˆæ¯ä»¥éªŒè¯å®¢æˆ·ç«¯ID jsonData, err := pm.redisClient.Get(context.Background(), redisKey).Bytes() if err != nil log.Printf(Error getting message from Redis: %v, err) return false var messageInfo PendingMessageInfo if err := json.Unmarshal(jsonData, messageInfo); err != nil log.Printf(Error unmarshaling message from Redis: %v, err) return false if messageInfo.ClientID == clientID // ä»Redisåˆ é™¤å¹¶æ›´æ–°è®¡æ•° pm.redisClient.Del(context.Background(), redisKey) pm.clientMessageCount[clientID]-- if pm.clientMessageCount[clientID] = 0 delete(pm.clientMessageCount, clientID) return true return false 4. å†…å­˜è‡ªé€‚åº”è°ƒæ•´ å†…å­˜è‡ªé€‚åº”è°ƒæ•´æ˜¯æˆ‘åœ¨å®é™…é¡¹ç›®ä¸­è§£å†³çªå‘æµé‡é—®é¢˜çš„å…³é”®ç­–ç•¥ã€‚å®ƒèƒ½å¤Ÿæ ¹æ®å½“å‰ç³»ç»Ÿè´Ÿè½½åŠ¨æ€è°ƒæ•´æ¶ˆæ¯å¤„ç†å‚æ•°ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§ã€‚ // å†…å­˜ç›‘æ§å¾ªç¯func (pm *PushManager) memoryMonitorLoop() ticker := time.NewTicker(10 * time.Second) defer ticker.Stop() for range ticker.C memoryMB := pm.getMemoryUsageMB() if memoryMB pm.criticalThresholdMB // ç´§æ€¥æƒ…å†µï¼Œè¿›è¡Œåº”æ€¥æ¸…ç† pm.emergencyCleanup(memoryMB) else if memoryMB pm.memoryThresholdMB // è¶…è¿‡è­¦æˆ’çº¿ï¼Œè°ƒæ•´å‚æ•° pm.adjustParameters(memoryMB) // è·å–å½“å‰è¿›ç¨‹å†…å­˜ä½¿ç”¨é‡ï¼ˆMBï¼‰func (pm *PushManager) getMemoryUsageMB() int64 var memStats runtime.MemStats runtime.ReadMemStats(memStats) return int64(memStats.Alloc / 1024 / 1024)// æ ¹æ®å†…å­˜ä½¿ç”¨æƒ…å†µè°ƒæ•´å‚æ•°func (pm *PushManager) adjustParameters(currentMemoryMB int64) pm.mutex.Lock() defer pm.mutex.Unlock() // è®¡ç®—å†…å­˜è¶…å‡ºæ¯”ä¾‹ excessRatio := float64(currentMemoryMB - pm.memoryThresholdMB) / float64(pm.memoryThresholdMB) // è°ƒæ•´æ¯å®¢æˆ·ç«¯æœ€å¤§æ¶ˆæ¯æ•° newMaxPerClient := int(float64(pm.maxPendingPerClient) * (1 - excessRatio*0.5)) if newMaxPerClient 100 newMaxPerClient = 100 // ç¡®ä¿è‡³å°‘ä¿ç•™100æ¡ // è°ƒæ•´æ¶ˆæ¯æœ€å¤§ç”Ÿå­˜æ—¶é—´ newMaxAge := int64(float64(pm.maxMessageAge) * (1 - excessRatio*0.5)) if newMaxAge 60 newMaxAge = 60 // è‡³å°‘60ç§’ // æ›´æ–°å‚æ•° pm.maxPendingPerClient = newMaxPerClient pm.maxMessageAge = newMaxAge log.Printf(Memory usage: %d MB, adjusted parameters: maxPending=%d, maxAge=%ds, currentMemoryMB, pm.maxPendingPerClient, pm.maxMessageAge) // æ‰§è¡Œä¸€æ¬¡æ¸…ç† pm.cleanExpiredMessages()// ç´§æ€¥æ¸…ç†func (pm *PushManager) emergencyCleanup(currentMemoryMB int64) pm.mutex.Lock() defer pm.mutex.Unlock() log.Printf(CRITICAL: Memory usage at %d MB, performing emergency cleanup, currentMemoryMB) // å¤§å¹…é™ä½å‚æ•° pm.maxPendingPerClient = 100 pm.maxMessageAge = 60 // æ¸…ç†ä½ä¼˜å…ˆçº§æ¶ˆæ¯ for msgID, info := range pm.memoryPending if info.Message.Priority 1 // åªä¿ç•™æœ€é«˜ä¼˜å…ˆçº§ delete(pm.memoryPending, msgID) pm.clientMessageCount[info.ClientID]-- log.Printf(Emergency cleanup completed) 5. é˜Ÿåˆ—æº¢å‡ºå¤„ç†ç­–ç•¥ // å¤„ç†é˜Ÿåˆ—æº¢å‡ºfunc (pm *PushManager) handleQueueOverflow(clientID string, newMessage *Message) log.Printf(Queue overflow for client %s, clientID) // ç­–ç•¥1: æ ¹æ®æ¶ˆæ¯ä¼˜å…ˆçº§å†³å®šæ˜¯å¦æ›¿æ¢ç°æœ‰æ¶ˆæ¯ if newMessage.Priority == 1 // é«˜ä¼˜å…ˆçº§æ¶ˆæ¯ // æŸ¥æ‰¾å¹¶æ›¿æ¢è¯¥å®¢æˆ·ç«¯çš„ä¸€æ¡ä½ä¼˜å…ˆçº§æ¶ˆæ¯ for msgID, info := range pm.memoryPending if info.ClientID == clientID info.Message.Priority 1 // è®°å½• log.Printf(Replacing low priority message %s with high priority message, msgID) // åˆ é™¤æ—§æ¶ˆæ¯ delete(pm.memoryPending, msgID) // æ·»åŠ æ–°æ¶ˆæ¯ pm.memoryPending[newMessage.MsgID] = PendingMessageInfo ClientID: clientID, Message: newMessage, SentTime: time.Now().Unix(), RetryCount: 0, // å‘é€æ–°æ¶ˆæ¯ pm.networkLayer.SendToClient(clientID, newMessage) return // ç­–ç•¥2: ä¸¢å¼ƒæ—§æ¶ˆæ¯ä»¥è…¾å‡ºç©ºé—´ // æŸ¥æ‰¾è¯¥å®¢æˆ·ç«¯æœ€æ—§çš„æ¶ˆæ¯ var oldestMsgID string var oldestTime int64 = math.MaxInt64 for msgID, info := range pm.memoryPending if info.ClientID == clientID info.SentTime oldestTime oldestMsgID = msgID oldestTime = info.SentTime if oldestMsgID != log.Printf(Dropping oldest message %s for client %s, oldestMsgID, clientID) delete(pm.memoryPending, oldestMsgID) // æ·»åŠ æ–°æ¶ˆæ¯ pm.memoryPending[newMessage.MsgID] = PendingMessageInfo ClientID: clientID, Message: newMessage, SentTime: time.Now().Unix(), RetryCount: 0, // å‘é€æ–°æ¶ˆæ¯ pm.networkLayer.SendToClient(clientID, newMessage) else // æç«¯æƒ…å†µï¼Œæ— æ³•æ‰¾åˆ°å¯æ›¿æ¢çš„æ¶ˆæ¯ log.Printf(Cannot find message to replace for client %s, clientID) å®¢æˆ·ç«¯å®ç° å®¢æˆ·ç«¯å®ç°åŒæ ·å…³é”®ï¼Œç‰¹åˆ«æ˜¯æ‰¹é‡ç¡®è®¤æœºåˆ¶èƒ½æ˜¾è‘—å‡å°‘ç½‘ç»œæµé‡ï¼š // PushReceiver å®¢æˆ·ç«¯æ¨é€æ¥æ”¶å¤„ç†å™¨type PushReceiver struct connection Connection // ç½‘ç»œè¿æ¥æ¥å£ processedMsgIDs map[string]int64 // å·²å¤„ç†æ¶ˆæ¯IDåŠå¤„ç†æ—¶é—´ pendingAcks []string // å¾…ç¡®è®¤çš„æ¶ˆæ¯ID ackBatchSize int // æ‰¹é‡ç¡®è®¤å¤§å° ackInterval time.Duration // æ‰¹é‡ç¡®è®¤é—´éš” messageHandlers map[string]MessageHandler // æ¶ˆæ¯å¤„ç†å‡½æ•° mutex sync.Mutex // ä¿æŠ¤å¹¶å‘è®¿é—® stopChan chan struct // åœæ­¢ä¿¡å·// MessageHandler æ¶ˆæ¯å¤„ç†å‡½æ•°ç±»å‹type MessageHandler func(payload interface) error// NewPushReceiver åˆ›å»ºæ¨é€æ¥æ”¶å™¨func NewPushReceiver(conn Connection) *PushReceiver receiver := PushReceiver connection: conn, processedMsgIDs: make(map[string]int64), pendingAcks: make([]string, 0, 100), ackBatchSize: 50, ackInterval: time.Second, messageHandlers: make(map[string]MessageHandler), stopChan: make(chan struct), // å¯åŠ¨æ‰¹é‡ç¡®è®¤ä»»åŠ¡ go receiver.ackLoop() // å¯åŠ¨è¿‡æœŸæ¶ˆæ¯IDæ¸…ç†ä»»åŠ¡ go receiver.cleanupLoop() return receiver// RegisterHandler æ³¨å†Œæ¶ˆæ¯å¤„ç†å‡½æ•°func (r *PushReceiver) RegisterHandler(msgType string, handler MessageHandler) r.mutex.Lock() defer r.mutex.Unlock() r.messageHandlers[msgType] = handler// HandleMessage å¤„ç†æ”¶åˆ°çš„æ¶ˆæ¯func (r *PushReceiver) HandleMessage(message *Message) r.mutex.Lock() defer r.mutex.Unlock() msgID := message.MsgID // æ£€æŸ¥æ˜¯å¦å·²å¤„ç†è¿‡è¯¥æ¶ˆæ¯ if _, exists := r.processedMsgIDs[msgID]; exists // å·²å¤„ç†è¿‡ï¼Œå†æ¬¡å‘é€ç¡®è®¤ if message.RequiresAck r.pendingAcks = append(r.pendingAcks, msgID) // å¦‚æœç§¯ç´¯çš„ç¡®è®¤æ•°é‡è¶…è¿‡æ‰¹é‡å¤§å°ï¼Œç«‹å³å‘é€ if len(r.pendingAcks) = r.ackBatchSize go r.sendBatchAcks() return // æŸ¥æ‰¾å¤„ç†å‡½æ•° handler, exists := r.messageHandlers[message.MsgType] if !exists log.Printf(No handler for message type: %s, message.MsgType) // æœªçŸ¥æ¶ˆæ¯ç±»å‹ä¹Ÿéœ€è¦ç¡®è®¤ if message.RequiresAck r.sendErrorAck(msgID, Unknown message type) return // å¤„ç†æ¶ˆæ¯ err := handler(message.Payload) if err != nil log.Printf(Error processing message %s: %v, msgID, err) if message.RequiresAck r.sendErrorAck(msgID, err.Error()) return // è®°å½•å·²å¤„ç†çš„æ¶ˆæ¯ r.processedMsgIDs[msgID] = time.Now().Unix() // å¦‚æœéœ€è¦ç¡®è®¤ï¼ŒåŠ å…¥å¾…ç¡®è®¤é˜Ÿåˆ— if message.RequiresAck r.pendingAcks = append(r.pendingAcks, msgID) // å¦‚æœç§¯ç´¯çš„ç¡®è®¤æ•°é‡è¶…è¿‡æ‰¹é‡å¤§å°ï¼Œç«‹å³å‘é€ if len(r.pendingAcks) = r.ackBatchSize go r.sendBatchAcks() // å‘é€æ‰¹é‡ç¡®è®¤func (r *PushReceiver) sendBatchAcks() r.mutex.Lock() // å¦‚æœæ²¡æœ‰å¾…ç¡®è®¤æ¶ˆæ¯ï¼Œç›´æ¥è¿”å› if len(r.pendingAcks) == 0 r.mutex.Unlock() return // å¤åˆ¶å½“å‰çš„å¾…ç¡®è®¤IDåˆ—è¡¨ ackIDs := make([]string, len(r.pendingAcks)) copy(ackIDs, r.pendingAcks) // æ¸…ç©ºå¾…ç¡®è®¤åˆ—è¡¨ r.pendingAcks = r.pendingAcks[:0] r.mutex.Unlock() // åˆ›å»ºæ‰¹é‡ç¡®è®¤æ¶ˆæ¯ batchAck := BatchAckMessage BatchAck: true, AckIDs: ackIDs, Status: success, ClientTimestamp: time.Now().Unix(), // å‘é€ç¡®è®¤ r.connection.Send(batchAck)// å‘é€é”™è¯¯ç¡®è®¤func (r *PushReceiver) sendErrorAck(msgID string, errorMessage string) ack := AckMessage AckID: msgID, Status: failed, ClientTimestamp: time.Now().Unix(), ErrorCode: 1001, ErrorMessage: errorMessage, r.connection.Send(ack)// æ‰¹é‡ç¡®è®¤å®šæ—¶å™¨func (r *PushReceiver) ackLoop() ticker := time.NewTicker(r.ackInterval) defer ticker.Stop() for select case -ticker.C: r.sendBatchAcks() case -r.stopChan: return // æ¸…ç†è¿‡æœŸçš„å·²å¤„ç†æ¶ˆæ¯IDfunc (r *PushReceiver) cleanupLoop() // æ¯å°æ—¶æ¸…ç†ä¸€æ¬¡ ticker := time.NewTicker(1 * time.Hour) defer ticker.Stop() for select case -ticker.C: r.cleanupProcessedIDs() case -r.stopChan: return // æ¸…ç†è¿‡æœŸçš„å·²å¤„ç†æ¶ˆæ¯IDfunc (r *PushReceiver) cleanupProcessedIDs() r.mutex.Lock() defer r.mutex.Unlock() now := time.Now().Unix() expireTime := int64(86400) // 24å°æ—¶è¿‡æœŸ for msgID, processTime := range r.processedMsgIDs if now - processTime expireTime delete(r.processedMsgIDs, msgID) // Close å…³é—­æ¨é€æ¥æ”¶å™¨func (r *PushReceiver) Close() // å‘é€æ‰€æœ‰å¾…ç¡®è®¤æ¶ˆæ¯ r.sendBatchAcks() // åœæ­¢æ‰€æœ‰åå°ä»»åŠ¡ close(r.stopChan) å®æˆ˜ç»éªŒä¸æœ€ä½³å®è·µ åœ¨å¤šä¸ªåƒä¸‡ç”¨æˆ·çº§åˆ«çš„æ¸¸æˆé¡¹ç›®å®è·µä¸­ï¼Œæˆ‘æ€»ç»“äº†ä»¥ä¸‹å‡ ç‚¹ Push-ACK æœºåˆ¶çš„æœ€ä½³å®è·µï¼š 1. æ¶ˆæ¯åˆ†çº§æ˜¯å…³é”® ä¸æ˜¯æ‰€æœ‰æ¶ˆæ¯éƒ½éœ€è¦ç›¸åŒçº§åˆ«çš„å¯é æ€§ä¿è¯ã€‚åœ¨ä¸€ä¸ª MMORPG é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å°†æ¶ˆæ¯åˆ†ä¸ºå››çº§ï¼š å…³é”®çº§ï¼šç›´æ¥å½±å“æ¸¸æˆå¹³è¡¡å’Œç»æµçš„æ¶ˆæ¯ï¼Œå¦‚é“å…·è·å–ã€è´§å¸å˜åŒ– é‡è¦çº§ï¼šå½±å“æ¸¸æˆè¿›ç¨‹çš„æ¶ˆæ¯ï¼Œå¦‚ä»»åŠ¡æ›´æ–°ã€æ’è¡Œæ¦œå˜åŠ¨ æ™®é€šçº§ï¼šä¸€èˆ¬æ¸¸æˆçŠ¶æ€ä¿¡æ¯ï¼Œå¦‚å…¶ä»–ç©å®¶åŠ¨ä½œã€ç¯å¢ƒå˜åŒ– ä½ä¼˜å…ˆçº§ï¼šå¯ä»¥å®¹å¿ä¸¢å¤±çš„èƒŒæ™¯ä¿¡æ¯ï¼Œå¦‚èŠå¤©ã€å¤©æ°”æ•ˆæœ é«˜çº§åˆ«æ¶ˆæ¯ä½¿ç”¨å®Œæ•´çš„ ACK æœºåˆ¶ï¼Œä½çº§åˆ«æ¶ˆæ¯å¯ä»¥ç®€åŒ–ç”šè‡³å–æ¶ˆ ACK éœ€æ±‚ï¼Œè¿™æ ·å¤§å¤§å‡è½»äº†æœåŠ¡å™¨å†…å­˜å‹åŠ›ã€‚ 2. åˆ©ç”¨ç»Ÿè®¡æŒ‡æ ‡è¿›è¡Œè°ƒä¼˜ ç›‘æ§ä»¥ä¸‹å…³é”®æŒ‡æ ‡ï¼š ACK å“åº”æ—¶é—´åˆ†å¸ƒ æ¶ˆæ¯é‡è¯•ç‡ æ¯å®¢æˆ·ç«¯å¹³å‡å¾…ç¡®è®¤æ¶ˆæ¯æ•° å†…å­˜ä½¿ç”¨å¢é•¿æ›²çº¿ åœ¨ä¸€ä¸ªè¶³çƒç»ç†ç±»æ¸¸æˆä¸­ï¼Œé€šè¿‡è¿™äº›æŒ‡æ ‡æˆ‘ä»¬å‘ç°ï¼Œå°† ACK è¶…æ—¶æ—¶é—´ä» 10 ç§’è°ƒæ•´åˆ° 5 ç§’ï¼Œå¹¶å°†æœ€å¤§é‡è¯•æ¬¡æ•°ä» 3 æ¬¡å¢åŠ åˆ° 5 æ¬¡ï¼Œå¯ä»¥å°†æ¶ˆæ¯æœ€ç»ˆç¡®è®¤ç‡ä» 99.2%æé«˜åˆ° 99.8%ï¼ŒåŒæ—¶å‡å°‘äº† 25%çš„å†…å­˜ä½¿ç”¨ã€‚ 3. é’ˆå¯¹ä¸åŒç½‘ç»œç¯å¢ƒä¼˜åŒ– ç§»åŠ¨ç½‘ç»œç¯å¢ƒå·®å¼‚å¾ˆå¤§ï¼Œé’ˆå¯¹ä¸åŒç½‘ç»œæ¡ä»¶åŠ¨æ€è°ƒæ•´ç­–ç•¥ï¼š // æ ¹æ®ç½‘ç»œæ¡ä»¶è°ƒæ•´å‚æ•°func (pm *PushManager) adjustForNetworkCondition(clientID string, rtt time.Duration) // ç½‘ç»œæ¡ä»¶è‰¯å¥½ if rtt 100*time.Millisecond pm.clientTimeouts[clientID] = 3 // 3ç§’è¶…æ—¶ pm.clientRetries[clientID] = 2 // 2æ¬¡é‡è¯• else if rtt 300*time.Millisecond pm.clientTimeouts[clientID] = 5 // 5ç§’è¶…æ—¶ pm.clientRetries[clientID] = 3 // 3æ¬¡é‡è¯• else pm.clientTimeouts[clientID] = 10 // 10ç§’è¶…æ—¶ pm.clientRetries[clientID] = 5 // 5æ¬¡é‡è¯• 4. å®šæœŸå‹åŠ›æµ‹è¯• åœ¨ä¸€ä¸ªå¤§å‹å¼€æ”¾ä¸–ç•Œæ¸¸æˆä¸­ï¼Œæˆ‘ä»¬æ¯æœˆè¿›è¡Œä¸€æ¬¡\"æ··æ²Œæµ‹è¯•\"ï¼Œæ¨¡æ‹Ÿæç«¯æƒ…å†µï¼š çªå‘ 50%å®¢æˆ·ç«¯åŒæ—¶æ‰çº¿ç„¶åé‡è¿ æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿçªç„¶ä» 50ms å¢åŠ åˆ° 500ms æ¨¡æ‹Ÿ 10%çš„ç¡®è®¤æ¶ˆæ¯ä¸¢å¤± è¿™ç§æµ‹è¯•è®©æˆ‘ä»¬å‘ç°äº†å¾ˆå¤šè¾¹ç¼˜æƒ…å†µï¼Œå¹¶å»ºç«‹äº†æ›´å¥å£®çš„é˜²å¾¡æœºåˆ¶ã€‚ ç»“è®º ä¸€ä¸ªè®¾è®¡è‰¯å¥½çš„ Push-ACK æœºåˆ¶æ˜¯ç°ä»£æ¸¸æˆæœåŠ¡å™¨æ¶æ„çš„æ ¸å¿ƒç»„ä»¶ã€‚å®ƒç¡®ä¿äº†æ¸¸æˆçŠ¶æ€çš„ä¸€è‡´æ€§ï¼Œæå‡äº†ç©å®¶ä½“éªŒï¼ŒåŒæ—¶ä¹Ÿä¸ºè¿è¥å›¢é˜Ÿæä¾›äº†å¯é çš„æ•°æ®åŸºç¡€ã€‚æœ€é‡è¦çš„æ˜¯ï¼Œå®ƒå¿…é¡»æ˜¯é«˜æ€§èƒ½ä¸”èµ„æºå‹å¥½çš„ã€‚ é€šè¿‡é‡‡ç”¨æœ¬æ–‡ä»‹ç»çš„å¤šçº§å­˜å‚¨ã€è‡ªé€‚åº”å‚æ•°è°ƒæ•´ã€æ¶ˆæ¯ä¼˜å…ˆçº§å’Œè¿‡æœŸç­–ç•¥ç­‰æŠ€æœ¯ï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºä¸€ä¸ªæ—¢å¯é åˆé«˜æ•ˆçš„æ¨é€ç¡®è®¤ç³»ç»Ÿï¼Œå³ä½¿åœ¨é¢å¯¹æ•°åä¸‡å¹¶å‘","tags":["è§£å†³æ–¹æ¡ˆ","æ¸¸æˆåç«¯","Push-Ack"],"categories":["è§£å†³æ–¹æ¡ˆ","æ¸¸æˆåç«¯"]},{"title":"æœåŠ¡ç›‘æ§ä¸¨Prometheus å››å¤§æ•°æ®ç±»å‹è¯¦è§£","path":"/2025/02/26/prometheus-data-type/","content":"å‰è¨€ åœ¨å¾®æœåŠ¡å’Œäº‘åŸç”Ÿæ¶æ„çš„ä¸–ç•Œä¸­ï¼Œä¸€å¥—å¼ºå¤§çš„ç›‘æ§ç³»ç»Ÿæ˜¯ä¿éšœæœåŠ¡ç¨³å®šæ€§çš„åŸºçŸ³ã€‚Prometheus ä½œä¸º CNCF çš„æ˜æ˜Ÿé¡¹ç›®ï¼Œå‡­å€Ÿå…¶ç®€å•é«˜æ•ˆçš„ç‰¹æ€§ï¼Œå·²æˆä¸ºäº‹å®ä¸Šçš„äº‘åŸç”Ÿç›‘æ§æ ‡å‡†ã€‚æœ¬æ–‡å°†æ·±å…¥å‰–æ Prometheus çš„å››å¤§æ•°æ®ç±»å‹åŠå…¶ PromQL æŸ¥è¯¢è¯­è¨€ï¼Œå¸®åŠ©å¼€å‘å›¢é˜Ÿæ„å»ºå¼ºå¤§çš„å¯è§‚æµ‹æ€§ç³»ç»Ÿã€‚ ç»“è®ºå…ˆè¡Œï¼šPrometheus å››å¤§æ•°æ®ç±»å‹é€Ÿè§ˆ ç‰¹æ€§ Counter Gauge Histogram Summary å®šä¹‰ åªå¢ä¸å‡çš„ç´¯ç§¯è®¡æ•°å™¨ å¯å¢å¯å‡çš„ç¬æ—¶å€¼ è§‚æµ‹å€¼åˆ†å¸ƒçš„åˆ†æ¡¶ç»Ÿè®¡ å®¢æˆ·ç«¯è®¡ç®—çš„åˆ†ä½æ•°ç»Ÿè®¡ é‡ç½®è¡Œä¸º æœåŠ¡é‡å¯æ—¶å½’é›¶ ä¿æŒå½“å‰å€¼ æ¡¶è®¡æ•°å½’é›¶ è®¡æ•°å½’é›¶ å…¸å‹åº”ç”¨ è¯·æ±‚è®¡æ•°ã€é”™è¯¯æ•°ã€æµé‡ç»Ÿè®¡ æ¸©åº¦ã€å†…å­˜ä½¿ç”¨ã€è¿æ¥æ•° è¯·æ±‚å»¶è¿Ÿã€å“åº”å¤§å° è¯·æ±‚å»¶è¿Ÿã€é˜Ÿåˆ—ç­‰å¾…æ—¶é—´ æ•°æ®ç‚¹ å•ä¸€å€¼ å•ä¸€å€¼ _bucketã€_sumã€count {quantile=\"x\"}ã€_sumã€_count æŸ¥è¯¢é‡ç‚¹ rate()ã€increase() ç›´æ¥ä½¿ç”¨ã€é¢„æµ‹å‡½æ•° histogram_quantile() ç›´æ¥è¯»å–åˆ†ä½æ•° åˆ†å¸ƒå¼èšåˆ å¯ä»¥ï¼ˆsumã€rateï¼‰ å¯ä»¥ï¼ˆavgã€maxã€minï¼‰ å¯ä»¥ï¼ˆç™¾åˆ†ä½ä¹Ÿå¯èšåˆï¼‰ æœ‰é™ï¼ˆåˆ†ä½æ•°ä¸å¯èšåˆï¼‰ èµ„æºæ¶ˆè€— ä½ ä½ ä¸­ï¼ˆä¾èµ–æ¡¶æ•°é‡ï¼‰ ä¸­ï¼ˆå®¢æˆ·ç«¯è®¡ç®—ï¼‰ ä¸€ã€Prometheus æ ¸å¿ƒæ•°æ®ç±»å‹è¯¦è§£ 1. Counterï¼ˆè®¡æ•°å™¨ï¼‰ï¼šæŒç»­å¢é•¿çš„ç´¯ç§¯å€¼ Counter æ˜¯æœ€ç®€å•ä½†ä¹Ÿæœ€å¸¸ç”¨çš„æŒ‡æ ‡ç±»å‹ï¼Œä»£è¡¨ä¸€ä¸ªåªå¢ä¸å‡çš„ç´¯ç§¯æ•°å€¼ã€‚æ¯å½“äº‹ä»¶å‘ç”Ÿï¼Œè®¡æ•°å™¨å¢åŠ ï¼›å½“ç›‘æ§ç›®æ ‡é‡å¯æ—¶ï¼Œè®¡æ•°å™¨å½’é›¶ã€‚ é€‚ç”¨åœºæ™¯ï¼š API è¯·æ±‚æ€»æ•° é”™è¯¯å‘ç”Ÿæ¬¡æ•° å¤„ç†ä»»åŠ¡çš„æ•°é‡ ç½‘ç»œæµé‡å­—èŠ‚æ•° æ­£ç¡®çš„ä»£ç å®ç°ï¼š // å£°æ˜å¸¦æ ‡ç­¾çš„è®¡æ•°å™¨requestCounter := prometheus.NewCounterVec( prometheus.CounterOpts Name: http_requests_total, Help: Total number of HTTP requests, , []stringmethod, path, status, // å®šä¹‰æ ‡ç­¾ç»´åº¦)prometheus.MustRegister(requestCounter)// ä½¿ç”¨æ ‡ç­¾è®°å½•è¯·æ±‚requestCounter.WithLabelValues(GET, /api/users, 200).Inc() PromQL æŸ¥è¯¢æŠ€å·§ï¼š # æ¯ç§’è¯·æ±‚ç‡ï¼ˆ5åˆ†é’Ÿçª—å£ï¼‰rate(http_requests_totalstatus=200[5m])# é”™è¯¯ç‡è®¡ç®—sum(rate(http_requests_totalstatus=~5..[5m])) / sum(rate(http_requests_total[5m]))# 1å°æ—¶å†…çš„è¯·æ±‚å¢é‡increase(http_requests_total[1h]) æœ€ä½³å®è·µï¼š æ°¸è¿œä¸è¦ç›´æ¥ä½¿ç”¨ Counter çš„åŸå§‹å€¼ï¼Œæ€»æ˜¯ä½¿ç”¨ rate() æˆ– increase() ä½¿ç”¨æœ‰æ„ä¹‰çš„æ ‡ç­¾è¿›è¡Œå¤šç»´åº¦åˆ†æï¼Œä½†é¿å…é«˜åŸºæ•°æ ‡ç­¾ Counter é‡ç½®ï¼ˆå¦‚æœåŠ¡é‡å¯ï¼‰ä¼šè¢« rate() å‡½æ•°è‡ªåŠ¨å¤„ç† 2. Gaugeï¼ˆä»ªè¡¨ç›˜ï¼‰ï¼šå¯å˜çš„ç¬æ—¶å€¼ Gauge è¡¨ç¤ºä¸€ä¸ªå¯å¢å¯å‡çš„ç¬æ—¶æµ‹é‡å€¼ï¼Œåæ˜ ç³»ç»Ÿçš„å½“å‰çŠ¶æ€ã€‚ é€‚ç”¨åœºæ™¯ï¼š å†…å­˜ä½¿ç”¨é‡ CPU ä½¿ç”¨ç‡ å½“å‰æ´»è·ƒè¿æ¥æ•° é˜Ÿåˆ—æ·±åº¦ æ¸©åº¦ç­‰ç‰©ç†é‡ æ­£ç¡®çš„ä»£ç å®ç°ï¼š // å£°æ˜å¸¦æ ‡ç­¾çš„ä»ªè¡¨ç›˜memoryGauge := prometheus.NewGaugeVec( prometheus.GaugeOpts Name: app_memory_usage_bytes, Help: Current memory usage in bytes, , []stringcomponent, instance,)prometheus.MustRegister(memoryGauge)// è®¾ç½®å½“å‰å€¼memoryGauge.WithLabelValues(api-server, instance-1).Set(float64(getCurrentMemoryUsage())) PromQL æŸ¥è¯¢æŠ€å·§ï¼š # ç›´æ¥ä½¿ç”¨å½“å‰å€¼app_memory_usage_bytescomponent=api-server# ç»Ÿè®¡èšåˆavg_over_time(app_memory_usage_bytes[1h])max_over_time(app_memory_usage_bytes[24h])# è¶‹åŠ¿é¢„æµ‹ï¼ˆçº¿æ€§å›å½’ï¼‰predict_linear(app_memory_usage_bytes[6h], 4 * 3600)# è®¡ç®—å˜åŒ–ç‡(app_memory_usage_bytes - app_memory_usage_bytes offset 1h) / app_memory_usage_bytes offset 1h æœ€ä½³å®è·µï¼š Gauge å¯ä»¥ç›´æ¥ä½¿ç”¨å…¶ç¬æ—¶å€¼ï¼Œä¸éœ€è¦åƒ Counter é‚£æ ·ä½¿ç”¨ rate å¯¹äºå®¹æ˜“æ³¢åŠ¨çš„æŒ‡æ ‡ï¼Œè€ƒè™‘ä½¿ç”¨ avg_over_time å¹³æ»‘æ•°æ® åˆ©ç”¨ predict_linear è¿›è¡Œå®¹é‡è§„åˆ’å’Œè¶‹åŠ¿é¢„æµ‹ 3. Histogramï¼ˆç›´æ–¹å›¾ï¼‰ï¼šè§‚æµ‹å€¼åˆ†å¸ƒçš„åˆ†æ¡¶ç»Ÿè®¡ Histogram å…è®¸å¯¹è§‚æµ‹å€¼ï¼ˆå¦‚è¯·æ±‚å»¶è¿Ÿï¼‰è¿›è¡Œåˆ†å¸ƒå¼ç»Ÿè®¡ï¼Œå°†æ•°æ®åˆ†æ•£åˆ°é¢„å®šä¹‰çš„æ¡¶ä¸­ï¼Œæ˜¯åˆ†ææ€§èƒ½åˆ†å¸ƒçš„ç†æƒ³å·¥å…·ã€‚ è‡ªåŠ¨ç”Ÿæˆçš„æŒ‡æ ‡ï¼š metric_bucketle=\"upper bound\": å°äºç­‰äºç‰¹å®šé˜ˆå€¼çš„è§‚æµ‹å€¼è®¡æ•° metric_sum: æ‰€æœ‰è§‚æµ‹å€¼çš„æ€»å’Œ metric_count: è§‚æµ‹å€¼æ€»æ•° é€‚ç”¨åœºæ™¯ï¼š è¯·æ±‚å»¶è¿Ÿåˆ†å¸ƒ å“åº”å¤§å°åˆ†å¸ƒ æ‰¹å¤„ç†ä»»åŠ¡æ‰§è¡Œæ—¶é—´ ä»»ä½•éœ€è¦ç™¾åˆ†ä½æ•°åˆ†æçš„åœºæ™¯ æ­£ç¡®çš„ä»£ç å®ç°ï¼š // å£°æ˜å¸¦æ ‡ç­¾çš„ç›´æ–¹å›¾durationHistogram := prometheus.NewHistogramVec( prometheus.HistogramOpts Name: http_request_duration_seconds, Help: HTTP request duration in seconds, Buckets: prometheus.ExponentialBuckets(0.001, 2, 10), // ä»1mså¼€å§‹æŒ‡æ•°å¢é•¿ , []stringmethod, path,)prometheus.MustRegister(durationHistogram)// è®°å½•è¯·æ±‚å»¶è¿ŸdurationHistogram.WithLabelValues(GET, /api/users).Observe(responseTime) PromQL æŸ¥è¯¢æŠ€å·§ï¼š # è®¡ç®—å¹³å‡å“åº”æ—¶é—´rate(http_request_duration_seconds_sum[5m]) / rate(http_request_duration_seconds_count[5m])# è®¡ç®—P90å»¶è¿Ÿhistogram_quantile(0.9, rate(http_request_duration_seconds_bucket[5m]))# æŒ‰APIè·¯å¾„åˆ†æP95å»¶è¿Ÿhistogram_quantile(0.95, sum by(path, le) (rate(http_request_duration_seconds_bucket[5m])))# è®¡ç®—SLOï¼šå»¶è¿Ÿå°äº100msçš„è¯·æ±‚æ¯”ä¾‹sum(rate(http_request_duration_seconds_bucketle=0.1[5m])) / sum(rate(http_request_duration_seconds_count[5m])) æœ€ä½³å®è·µï¼š ä»”ç»†è®¾è®¡æ¡¶è¾¹ç•Œï¼Œè¦†ç›–å…³é”®åˆ†ä½æ•°åŒºåŸŸ å¯¹äºå»¶è¿ŸæŒ‡æ ‡ï¼Œé€šå¸¸ä½¿ç”¨æŒ‡æ•°æ¡¶æ¯”çº¿æ€§æ¡¶æ›´åˆç† åˆ©ç”¨ histogram_quantile è®¡ç®—ä»»æ„åˆ†ä½æ•° æ¡¶çš„æ•°é‡ä¼šå½±å“å­˜å‚¨å’Œæ€§èƒ½ï¼Œæƒè¡¡ç²¾åº¦å’Œå¼€é”€ 4. Summaryï¼ˆæ‘˜è¦ï¼‰ï¼šå®¢æˆ·ç«¯è®¡ç®—çš„åˆ†ä½æ•°ç»Ÿè®¡ Summary ä¸ Histogram ç±»ä¼¼ï¼Œä½†åœ¨å®¢æˆ·ç«¯ç›´æ¥è®¡ç®—å¹¶å­˜å‚¨åˆ†ä½æ•°ï¼Œæ— éœ€æœåŠ¡å™¨ç«¯è®¡ç®—ã€‚ è‡ªåŠ¨ç”Ÿæˆçš„æŒ‡æ ‡ï¼š metricquantile=\"Ï†\": Ï† åˆ†ä½æ•°çš„å€¼ metric_sum: æ‰€æœ‰è§‚æµ‹å€¼çš„æ€»å’Œ metric_count: è§‚æµ‹å€¼æ€»æ•° é€‚ç”¨åœºæ™¯ï¼š éœ€è¦é«˜ç²¾åº¦åˆ†ä½æ•°çš„åœºæ™¯ å®¢æˆ·ç«¯è®¡ç®—åˆ†ä½æ•°æ›´é«˜æ•ˆçš„æƒ…å†µ å¯¹æœåŠ¡å™¨ç«¯èšåˆè¦æ±‚ä¸é«˜çš„åœºæ™¯ æ­£ç¡®çš„ä»£ç å®ç°ï¼š // å£°æ˜å¸¦æ ‡ç­¾çš„æ‘˜è¦durationSummary := prometheus.NewSummaryVec( prometheus.SummaryOpts Name: http_request_duration_seconds_summary, Help: HTTP request duration in seconds, Objectives: map[float64]float640.5: 0.05, 0.9: 0.01, 0.99: 0.001, , []stringmethod, path,)prometheus.MustRegister(durationSummary)// è®°å½•è¯·æ±‚å»¶è¿ŸdurationSummary.WithLabelValues(POST, /api/login).Observe(responseTime) PromQL æŸ¥è¯¢æŠ€å·§ï¼š # ç›´æ¥è¯»å–P99å»¶è¿Ÿhttp_request_duration_seconds_summaryquantile=0.99, method=GET, path=/api/users# è®¡ç®—å¹³å‡å“åº”æ—¶é—´rate(http_request_duration_seconds_summary_sum[5m]) / rate(http_request_duration_seconds_summary_count[5m])# æ¯ä¸ªæœåŠ¡çš„ä¸­ä½æ•°å»¶è¿Ÿmax by(service) (http_request_duration_seconds_summaryquantile=0.5) æœ€ä½³å®è·µä¸é™åˆ¶ï¼š Summary é¢„è®¡ç®—çš„åˆ†ä½æ•°ä¸èƒ½è·¨å®ä¾‹èšåˆï¼ˆè¿™æ˜¯å…³é”®é™åˆ¶ï¼‰ é€‚ç”¨äºåˆ†ä½æ•°ç²¾åº¦è¦æ±‚é«˜ä¸”å®ä¾‹ç›¸å¯¹ç‹¬ç«‹çš„åœºæ™¯ å®¢æˆ·ç«¯è®¡ç®—åˆ†ä½æ•°ä¼šå¢åŠ åº”ç”¨èµ„æºæ¶ˆè€— åˆ†ä½æ•°è®¾ç½®åä¸å¯æ›´æ”¹ï¼Œéœ€æå‰è§„åˆ’å¥½ç›‘æ§éœ€æ±‚ äºŒã€PromQL æŸ¥è¯¢è¯­è¨€ç²¾é€š PromQL æ˜¯ Prometheus çš„å¼ºå¤§æ­¦å™¨ï¼ŒæŒæ¡å®ƒèƒ½è®©æˆ‘ä»¬ç²¾ç¡®æå–æ‰€éœ€çš„ç›‘æ§æ•°æ®ã€‚ 1. åŸºç¡€æŸ¥è¯¢ä¸æ ‡ç­¾é€‰æ‹© # åŸºæœ¬æŸ¥è¯¢ä¸ç²¾ç¡®åŒ¹é…http_requests_totalstatus=200, method=GET# æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…http_requests_totalpath=~/api/v1/.+, method!=OPTIONS# èŒƒå›´æŸ¥è¯¢ï¼ˆè¿”å›æ—¶é—´åºåˆ—ï¼‰http_requests_totalstatus=500[5m] 2. æ“ä½œç¬¦ä¸å‡½æ•° ç®—æœ¯è¿ç®—ç¬¦ï¼š # è®¡ç®—å†…å­˜ä½¿ç”¨ç‡ç™¾åˆ†æ¯”100 * (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes èšåˆå‡½æ•°ï¼š # æŒ‰æœåŠ¡å’Œè·¯å¾„åˆ†ç»„æ±‚å’Œsum by(service, path) (rate(http_requests_total[5m]))# ä¸¢å¼ƒinstanceæ ‡ç­¾æ±‚æœ€å¤§å€¼max without(instance) (node_cpu_seconds_total) ç¬æ—¶å‘é‡å‡½æ•°ï¼š # æ ‡ç­¾æ›¿æ¢label_replace(up, host, $1, instance, (.*):.*)# æŒ‰æ ‡ç­¾åˆ†ç»„å–topktopk by(path) (5, http_request_duration_seconds_sum / http_request_duration_seconds_count) 3. å¤æ‚æŸ¥è¯¢æ¨¡å¼ SLI/SLO ç›‘æ§ï¼š # æœåŠ¡å¯ç”¨æ€§SLIsum(rate(http_requests_totalstatus=~2..|3..[5m])) / sum(rate(http_requests_total[5m]))# å»¶è¿ŸSLOhistogram_quantile(0.99, sum by(le) (rate(http_request_duration_seconds_bucket[5m]))) 0.3 å¼‚å¸¸æ£€æµ‹ï¼š # ç›¸å¯¹äºå†å²åŒæœŸçš„å¼‚å¸¸å¢é•¿rate(http_requests_total[5m]) 2 * avg_over_time(rate(http_requests_total[5m])[1d:5m] offset 1d) é¢„æµ‹åˆ†æï¼š # ç£ç›˜ç©ºé—´é¢„æµ‹predict_linear(node_filesystem_free_bytesmountpoint=/[6h], 7 * 24 * 3600) 10 * 1024 * 1024 * 1024 ä¸‰ã€å®æˆ˜åº”ç”¨åœºæ™¯ 1. æœåŠ¡å¥åº·åº¦ç›‘æ§ RED æ–¹æ³•å®ç°ï¼š # Rate - è¯·æ±‚ç‡sum by(service) (rate(http_requests_total[5m]))# Error - é”™è¯¯ç‡sum by(service) (rate(http_requests_totalstatus=~5..[5m])) / sum by(service) (rate(http_requests_total[5m]))# Duration - P95å»¶è¿Ÿhistogram_quantile(0.95, sum by(service, le) (rate(http_request_duration_seconds_bucket[5m]))) æœåŠ¡ä¾èµ–å¥åº·åº¦ï¼š # æ•°æ®åº“æŸ¥è¯¢é”™è¯¯ç‡sum(rate(database_query_errors_total[5m])) / sum(rate(database_queries_total[5m]))# ç¬¬ä¸‰æ–¹APIè°ƒç”¨å»¶è¿Ÿhistogram_quantile(0.99, sum by(api_name, le) (rate(api_request_duration_seconds_bucket[5m]))) 2. æ€§èƒ½ç“¶é¢ˆåˆ†æ çƒ­ç‚¹ API å‘ç°ï¼š # å»¶è¿Ÿæœ€é«˜çš„10ä¸ªæ¥å£topk(10, histogram_quantile(0.95, sum by(method, path, le) (rate(http_request_duration_seconds_bucket[5m]))))# è¯·æ±‚é‡æœ€å¤§çš„æ¥å£topk(10, sum by(method, path) (rate(http_requests_total[5m]))) æ•°æ®åº“æ€§èƒ½åˆ†æï¼š # å¹³å‡æŸ¥è¯¢æ—¶é—´è¶‹åŠ¿rate(db_query_duration_seconds_sum[5m]) / rate(db_query_duration_seconds_count[5m])# æ…¢æŸ¥è¯¢æ¯”ä¾‹sum(rate(db_query_duration_seconds_bucketle=+Inf[5m])) - sum(rate(db_query_duration_seconds_bucketle=0.1[5m])) / sum(rate(db_query_duration_seconds_bucketle=+Inf[5m])) 3. å®¹é‡è§„åˆ’ä¸å‘Šè­¦ èµ„æºé¢„æµ‹ï¼š # CPUä½¿ç”¨ç‡é¢„æµ‹predict_linear(avg by(instance) (rate(node_cpu_seconds_totalmode!=idle[6h])) [3d:], 7 * 24 * 3600) 0.85# å†…å­˜å‹åŠ›å‘Šè­¦(node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes 0.9 æµé‡å®¹é‡è§„åˆ’ï¼š # å¸¦å®½ä½¿ç”¨é¢„æµ‹predict_linear(rate(node_network_transmit_bytes_total[12h])[7d:], 30 * 24 * 3600) å››ã€æœ€ä½³å®è·µä¸æ€§èƒ½ä¼˜åŒ– 1. æŒ‡æ ‡å‘½åä¸æ ‡ç­¾è®¾è®¡ å‘½åè§„èŒƒï¼š ä½¿ç”¨ snake_case åŒ…å«å•ä½åç¼€ï¼ˆ_bytes, _seconds, _totalï¼‰ ä¿æŒé£æ ¼ä¸€è‡´æ€§ æ ‡ç­¾æœ€ä½³å®è·µï¼š // åˆç†è®¾è®¡æ ‡ç­¾ç»´åº¦apiLatency := prometheus.NewHistogramVec( prometheus.HistogramOpts Name: api_request_duration_seconds, Help: API request duration in seconds, Buckets: prometheus.ExponentialBuckets(0.001, 2, 10), , []stringservice, endpoint, status_code, // åˆç†çš„ä½åŸºæ•°æ ‡ç­¾)// ä¸å¯å˜æ ‡ç­¾ä½¿ç”¨ConstLabelsprometheus.NewGaugeVec( prometheus.GaugeOpts Name: service_info, Help: Service information, ConstLabels: prometheus.Labelsversion: v2.1.3, environment: production, , []stringinstance,) 2. å®¢æˆ·ç«¯æ€§èƒ½ä¼˜åŒ– // ç¼“å­˜å¸¸ç”¨æ ‡ç­¾ç»„åˆä»¥æé«˜æ€§èƒ½getCounter := requestCounter.WithLabelValues(GET, /api/users, 200)for i := 0; i 100; i++ getCounter.Inc() // é‡ç”¨æ ‡ç­¾ç»„åˆï¼Œé¿å…é‡å¤åˆ›å»º// æ‰¹é‡æ›´æ–°æ–¹å¼var rpcDurations = prometheus.NewSummaryVec( prometheus.SummaryOpts Name: rpc_durations_seconds, Help: RPC latency distributions., Objectives: map[float64]float640.5: 0.05, 0.9: 0.01, 0.99: 0.001, , []stringservice,)func ObserveBatch(durations map[string]float64) for service, duration := range durations rpcDurations.WithLabelValues(service).Observe(duration) 3. æŸ¥è¯¢ä¼˜åŒ– # ä¼˜åŒ–å‰ï¼šé«˜åŸºæ•°æŸ¥è¯¢sum(rate(http_requests_totalpath=~/api/.*[5m])) by (path, method, status)# ä¼˜åŒ–åï¼šé™ä½åŸºæ•°ï¼ŒæŒ‰éœ€èšåˆsum(rate(http_requests_totalpath=~/api/.*[5m])) by (method, status)# ä¼˜åŒ–èšåˆé¡ºåºï¼ˆå…ˆèšåˆå†æ±‚å’Œï¼‰sum( avg by(instance) (rate(node_cpu_seconds_totalmode!=idle[5m]))) äº”ã€å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ 1. é«˜åŸºæ•°é—®é¢˜ é—®é¢˜ï¼šæ ‡ç­¾ç»„åˆè¿‡å¤šå¯¼è‡´æ—¶é—´åºåˆ—çˆ†ç‚¸ è§£å†³æ–¹æ¡ˆï¼š é™åˆ¶æ ‡ç­¾åŸºæ•°ï¼Œé¿å…ä½¿ç”¨ UserIDã€SessionID ç­‰ä½œä¸ºæ ‡ç­¾ ä½¿ç”¨label_replaceå’Œæ­£åˆ™è¡¨è¾¾å¼è½¬æ¢é«˜åŸºæ•°æ ‡ç­¾ è€ƒè™‘ä½¿ç”¨ Exemplars è€Œéæ ‡ç­¾å­˜å‚¨é«˜åŸºæ•°æ•°æ® 2. æ•°æ®ç±»å‹é€‰æ‹©è¯¯åŒº Counter vs Gaugeï¼šè¯·æ±‚æ•°åº”ä½¿ç”¨ Counter è€Œé Gauge Histogram vs Summaryï¼šéœ€è¦èšåˆåˆ†æè¯·ä½¿ç”¨ Histogramï¼Œç²¾ç¡®åˆ†ä½æ•°å¯é€‰ Summary 3. æŸ¥è¯¢æ€§èƒ½é—®é¢˜ é—®é¢˜ï¼šå¤æ‚æŸ¥è¯¢å¯¼è‡´ Prometheus é«˜è´Ÿè½½ è§£å†³æ–¹æ¡ˆï¼š ä½¿ç”¨è®°å½•è§„åˆ™é¢„è®¡ç®—å¸¸ç”¨æŸ¥è¯¢ åˆç†è®¾ç½® scrape é—´éš”ï¼Œé¿å…è¿‡åº¦é‡‡é›† å¯¹é«˜è¯·æ±‚é‡æ¥å£ä½¿ç”¨å®¢æˆ·ç«¯èšåˆ æ€»ç»“ä¸å±•æœ› Prometheus çš„å››ç§æ•°æ®ç±»å‹å„æœ‰æ‰€é•¿ï¼šCounter é€‚åˆç´¯ç§¯äº‹ä»¶è®¡æ•°ï¼ŒGauge é€‚åˆç¬æ—¶çŠ¶æ€æµ‹é‡ï¼ŒHistogram é€‚åˆåˆ†å¸ƒç»Ÿè®¡å’Œç™¾åˆ†ä½åˆ†æï¼ŒSummary é€‚åˆå®¢æˆ·ç«¯ç²¾ç¡®åˆ†ä½æ•°è®¡ç®—ã€‚ä¸ä¹‹é…åˆçš„ PromQL æä¾›äº†å¼ºå¤§çš„æ•°æ®æŸ¥è¯¢å’Œåˆ†æèƒ½åŠ›ï¼Œå…±åŒæ„æˆäº†å®Œæ•´çš„ç›‘æ§è§£å†³æ–¹æ¡ˆã€‚ éšç€äº‘åŸç”ŸæŠ€æœ¯çš„å‘å±•ï¼ŒPrometheus ç”Ÿæ€ä¹Ÿåœ¨ä¸æ–­å£®å¤§ï¼Œä¸ Grafanaã€Alertmanagerã€Thanos ç­‰å·¥å…·é›†æˆï¼Œèƒ½å¤Ÿæ„å»ºæ›´å®Œå–„çš„ç›‘æ§å‘Šè­¦å¹³å°ã€‚åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œç»“åˆ REDï¼ˆRateã€Errorã€Durationï¼‰å’Œ USEï¼ˆUtilizationã€Saturationã€Errorsï¼‰æ–¹æ³•è®ºï¼Œå¯ä»¥æ„å»ºå…¨é¢çš„å¯è§‚æµ‹æ€§ç³»ç»Ÿã€‚ æ— è®ºä½ æ˜¯åˆšå¼€å§‹ä½¿ç”¨ Prometheus çš„æ–°æ‰‹ï¼Œè¿˜æ˜¯å¯»æ±‚ä¼˜åŒ–ç›‘æ§ç³»ç»Ÿçš„èµ„æ·±å·¥ç¨‹å¸ˆï¼Œå¸Œæœ›æœ¬æ–‡å¯¹ä½ ç†è§£å’Œåº”ç”¨ Prometheus æœ‰æ‰€å¸®åŠ©ã€‚è®°ä½ï¼Œå¥½çš„ç›‘æ§ä¸ä»…èƒ½åŠæ—¶å‘ç°é—®é¢˜ï¼Œæ›´èƒ½é¢„æµ‹å’Œé˜²èŒƒé—®é¢˜ï¼Œæœ€ç»ˆæœåŠ¡äºä¸šåŠ¡å¯é æ€§å’Œç”¨æˆ·ä½“éªŒçš„æå‡ã€‚ å‚è€ƒèµ„æº: Prometheus å®˜æ–¹æ–‡æ¡£: https://prometheus.io/docs/ Google SRE ä¹¦ç±: https://sre.google/sre-book/monitoring-distributed-systems/ Prometheus å®æˆ˜: https://prometheusbook.com/","tags":["æœåŠ¡ç›‘æ§","prometheus"],"categories":["æœåŠ¡ç›‘æ§"]},{"title":"åœ¨ Go é¡¹ç›®ä¸­å®ç° JWT ç”¨æˆ·è®¤è¯ä¸ç»­æœŸæœºåˆ¶","path":"/2025/02/15/go-action-jwt/","content":"JWT (JSON Web Token) æ˜¯ä¸€ç§å¹¿æ³›ä½¿ç”¨çš„ç”¨æˆ·è®¤è¯æ–¹æ¡ˆï¼Œå› å…¶æ— çŠ¶æ€ã€è·¨åŸŸæ”¯æŒå’Œçµæ´»æ€§è€Œå—åˆ°æ¬¢è¿ã€‚æœ¬æ–‡å°†ç»“åˆå®é™…ä»£ç ï¼Œè¯¦ç»†è®²è§£å¦‚ä½•åœ¨ Go é¡¹ç›®ä¸­å®ç° JWT è®¤è¯æœºåˆ¶ï¼Œå¹¶æ¢è®¨ä¸¤ç§å¸¸è§çš„ Token ç»­æœŸç­–ç•¥ï¼šè‡ªåŠ¨ç»­æœŸå’Œ Refresh Tokenã€‚ 1. JWT åŸºç¡€æ¦‚å¿µ JWT ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šHeaderã€Payload å’Œ Signatureã€‚ä½¿ç”¨ JWT è¿›è¡Œç™»å½•è®¤è¯çš„åŸºæœ¬å·¥ä½œæµç¨‹æ˜¯ï¼š ç”¨æˆ·ç™»å½•æˆåŠŸåï¼ŒæœåŠ¡å™¨ç”Ÿæˆ JWTã€‚ æœåŠ¡å™¨å°† token è¿”å›ç»™å®¢æˆ·ç«¯ã€‚ å®¢æˆ·ç«¯åç»­è¯·æ±‚æºå¸¦ tokenã€‚ æœåŠ¡å™¨éªŒè¯ token çš„æœ‰æ•ˆæ€§ã€‚ æˆ‘ä»¬å¯ä»¥åœ¨ https://jwt.io/ ç½‘ç«™å¯¹ JWT è¿›è¡Œåˆ†æï¼ŒæŸ¥çœ‹å…¶å…·ä½“çš„ç»„æˆæˆåˆ†ã€‚ 2. åŸºæœ¬å‡†å¤‡ åœ¨æœ¬ç¯‡ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Go è¯­è¨€ï¼Œé€šè¿‡ä¸€ä¸ªå®Œæ•´çš„æ¡ˆä¾‹å®ç°åœ¨ HTTP æ¥å£ä¸­ï¼Œä½¿ç”¨ JWT è¿›è¡Œç”¨æˆ·ç™»å½•å’Œè®¤è¯æµç¨‹ã€‚æœ¬æ–‡å‡è®¾è¯»è€…å·²æŒæ¡åŸºæœ¬çš„ Go è¯­è¨€è¯­æ³•å’Œç½‘ç»œç¼–ç¨‹ç»éªŒï¼Œå¹¶å¯¹ Gin æ¡†æ¶æœ‰åŸºæœ¬çš„äº†è§£ã€‚ ä¸ºäº†å¿«é€Ÿå“åº”å¤±è´¥ï¼Œæœ¬æ–‡æ¡ˆä¾‹ä¸­ä½¿ç”¨äº†å°è£…å¥½çš„å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼š package utilsvar (\tErrUser = errors.New()\tErrSys = errors.New())// å®šä¹‰ç”¨æˆ·ä¾§é”™è¯¯ï¼Œä¼šç›´æ¥å°†é”™è¯¯å†…å®¹è¿”å›ç»™ç”¨æˆ·ï¼Œä¸æ‰“å°æ—¥å¿—ã€‚func UserErr(msg string) error return fmt.Errorf(%w%v, ErrUser, msg)func UserErrf(format string, a ...any) error return fmt.Errorf(%w%v, ErrUser, fmt.Sprintf(format, a...))// å®šä¹‰ç³»ç»Ÿå†…éƒ¨é”™è¯¯ï¼Œä¼šå›ºå®šè¿”å› internal server error ç»™ç”¨æˆ·ï¼Œä½†æ˜¯ä¼šå°†åŸå§‹é”™è¯¯ä¿¡æ¯è¾“å‡ºåˆ°æ—¥å¿—ä¸­ï¼Œä¾¿äºå†…éƒ¨æ’æŸ¥ã€‚func SystemErr(err error) error return fmt.Errorf(%w%v, ErrSys, err)func SystemErrf(format string, a ...any) error return fmt.Errorf(%w%v, ErrSys, fmt.Sprintf(format, a...))func GinErr(c *gin.Context, req any, err error, msgs ...string) if errors.Is(err, ErrUser) c.JSON(http.StatusOK, err.Error()) return msg := internal server error\tif len(msgs) 0 msg = msgs[0] slog.Error(msg, slog.Any(req, req), slog.String(err, err.Error()),\t)\tc.JSON(http.StatusOK, internal server error) 3. å®ç°ç”¨æˆ·è®¤è¯ åœ¨è¿›è¡Œå®é™…ä»£ç ç¼–å†™ä¹‹å‰ï¼Œä½ éœ€è¦å…ˆåˆå§‹åŒ–å¥½é¡¹ç›®å¹¶å¼•å…¥ jwt ä¾èµ–ï¼š go get -u github.com/golang-jwt/jwt/v5 åœ¨ä»£ç ä¸­ä½¿ç”¨çš„æ—¶å€™ï¼Œå¯ä»¥ï¼š import github.com/golang-jwt/jwt/v5 é‚£æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ­£å¼å¼€å§‹æˆ‘ä»¬çš„åŠŸèƒ½å®ç°ã€‚ 3.1 å®šä¹‰ Claims ç»“æ„ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ JWT çš„è½½è·ï¼ˆPayloadï¼‰ç»“æ„ï¼Œå³å†³å®šå°†ä»€ä¹ˆä¿¡æ¯å­˜å‚¨åœ¨ token å½“ä¸­ã€‚ type UserClaims struct jwt.RegisteredClaims UserID uint64 `json:user_id` // ç”¨æˆ·ID UserAgent string `json:user_agent` // ç”¨æˆ·è®¾å¤‡ä¿¡æ¯ è¿™é‡Œæˆ‘ä»¬ï¼š ç»„åˆäº† jwt.RegisteredClaimsï¼Œå®ƒåŒ…å«äº†æ ‡å‡†çš„ JWT å­—æ®µï¼ˆå¦‚è¿‡æœŸæ—¶é—´ï¼‰ï¼Œå¸®åŠ©æˆ‘ä»¬å®ç°äº† jwt.Clamis æ¥å£ï¼š type Claims interface GetExpirationTime() (*NumericDate, error)\tGetIssuedAt() (*NumericDate, error)\tGetNotBefore() (*NumericDate, error)\tGetIssuer() (string, error)\tGetSubject() (string, error)\tGetAudience() (ClaimStrings, error) jwt.RegisteredClaims çš„å®ç°å¦‚ä¸‹ï¼š type RegisteredClaims struct Issuer string `json:iss,omitempty`\tSubject string `json:sub,omitempty`\tAudience ClaimStrings `json:aud,omitempty`\tExpiresAt *NumericDate `json:exp,omitempty`\tNotBefore *NumericDate `json:nbf,omitempty`\tIssuedAt *NumericDate `json:iat,omitempty`\tID string `json:jti,omitempty`func (c RegisteredClaims) GetExpirationTime() (*NumericDate, error) return c.ExpiresAt, nilfunc (c RegisteredClaims) GetNotBefore() (*NumericDate, error) return c.NotBefore, nilfunc (c RegisteredClaims) GetIssuedAt() (*NumericDate, error) return c.IssuedAt, nilfunc (c RegisteredClaims) GetAudience() (ClaimStrings, error) return c.Audience, nilfunc (c RegisteredClaims) GetIssuer() (string, error) return c.Issuer, nilfunc (c RegisteredClaims) GetSubject() (string, error) return c.Subject, nil æ·»åŠ äº†è‡ªå®šä¹‰å­—æ®µ UserID å’Œ UserAgent ç”¨äºå®‰å…¨æ§åˆ¶ã€‚ä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„ä¸šåŠ¡éœ€æ±‚ï¼Œæ·»åŠ ä»»æ„éæ•æ„Ÿä¿¡æ¯åˆ°è¿™ä¸ªç»“æ„ä¸­ã€‚ 3.2 ç™»å½•æ¥å£å®ç° const ( AccessTokenDuration = time.Minute * 15 RefreshTokenDuration = time.Hour * 24 * 7)func (u *UserHandler) LoginJWT(ctx *gin.Context) // 1. æ ¡éªŒç”¨æˆ·ä¿¡æ¯ï¼Œåœ¨æœ¬æ¡ˆä¾‹ä¸­ï¼Œä½¿ç”¨é‚®ç®±åŠ å¯†ç è¿›è¡Œç™»å½• user, err := u.svc.Login(ctx.Request.Context(), req.Email, req.Password) if err != nil utils.GinErr(ctx, req, utils.UserErr(err), login failed) return // 2. åˆ›å»º JWT Claims accessClaims := UserClaims UserID: user.ID, UserAgent: ctx.Request.UserAgent(), RegisteredClaims: jwt.RegisteredClaims ExpiresAt: jwt.NewNumericDate(time.Now().Add(AccessTokenDuration)), // 15åˆ†é’Ÿè¿‡æœŸ , // 3. ç”Ÿæˆ Access Token accessToken := jwt.NewWithClaims(jwt.SigningMethodHS512, accessClaims) accessTokenStr, err := accessToken.SignedString(AccessTokenKey) if err != nil utils.GinErr(ctx, req, utils.SystemErr(err), generate access token failed) return // 4. ç”Ÿæˆ Refresh Tokenï¼Œç”¨äº Token ç»­æœŸ refreshClaims := RefreshClaims UserID: user.ID, UserAgent: ctx.Request.UserAgent(), RegisteredClaims: jwt.RegisteredClaims ExpiresAt: jwt.NewNumericDate(time.Now().Add(RefreshTokenDuration)), // 7å¤©è¿‡æœŸ , refreshToken := jwt.NewWithClaims(jwt.SigningMethodHS512, refreshClaims) refreshTokenStr, err := refreshToken.SignedString(RefreshTokenKey) if err != nil utils.GinErr(ctx, req, utils.SystemErr(err), generate refresh token failed) return // 5. è¿”å›ä¸¤ä¸ª token ctx.Header(x-jwt-token, accessTokenStr) ctx.Header(x-refresh-token, refreshTokenStr) ctx.JSON(http.StatusOK, login success) 3.3 JWT ä¸­é—´ä»¶å®ç° type LoginJWTMiddlewareBuilder struct whiteList []stringfunc NewLoginJWTMiddlewareBuilder() *LoginJWTMiddlewareBuilder return LoginJWTMiddlewareBuilder whiteList: []string,\tfunc (b *LoginJWTMiddlewareBuilder) IgnorePaths(paths ...string) *LoginJWTMiddlewareBuilder b.whiteList = append(b.whiteList, paths...)\treturn bfunc (b *LoginJWTMiddlewareBuilder) Build() gin.HandlerFunc return func(ctx *gin.Context) // 1. æå– token authCode := ctx.GetHeader(Authorization) tokenStr := strings.TrimPrefix(authCode, Bearer ) // 2. è§£æå’ŒéªŒè¯ token uc := web.UserClaims token, err := jwt.ParseWithClaims(tokenStr, uc, func(token *jwt.Token) (interface, error) return web.AccessTokenKey, nil ) // 3. éªŒè¯ token æœ‰æ•ˆæ€§ if token == nil || !token.Valid ctx.AbortWithStatus(http.StatusUnauthorized) return // 4. éªŒè¯ UserAgent if uc.UserAgent != ctx.Request.UserAgent() ctx.AbortWithStatus(http.StatusUnauthorized) return // 5. è®¾ç½®ç”¨æˆ·ä¿¡æ¯åˆ°ä¸Šä¸‹æ–‡ ctx.Set(user_id, uc.UserID) ctx.Set(claims, uc) 3.4 æ³¨å†Œä¸­é—´ä»¶ func initWebServer() *gin.Engine server := gin.Default()\tserver.Use( middleware.CORS(), middleware.NewLoginJWTMiddlewareBuilder(). IgnorePaths(/users/signup). IgnorePaths(/users/login). Build(),\t)\tweb.RegisterRoutes(server)\treturn serverfunc RegisterRoutes(server *gin.Engine) // ...\tuserHandler.RegisterRoutes(server)func (u *UserHandler) RegisterRoutes(server *gin.Engine) ur := server.Group(/users) ur.POST(/login, u.LoginJWT) // ... 4. åœ¨å…¶ä»–æ¥å£ä¸­ä½¿ç”¨ Token çš„ç›¸å…³ä¿¡æ¯ func (u *UserHandler) Profile(ctx *gin.Context) // å¯ä»¥è·å– user_id\tuserID := ctx.GetUint64(user_id) // ä¹Ÿå¯ä»¥ç›´æ¥è·å–æ•´ä¸ª claimsã€‚ // è¿™é‡Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ä¸è¿›è¡Œæ–­è¨€ï¼Œå› ä¸ºç†è®ºä¸Šæˆ‘ä»¬çš„å¯ä»¥ä¿è¯è¿™é‡Œé€šè¿‡æ–­è¨€ã€‚ // å¦‚æœè¿™é‡Œå‘ç”Ÿ panic äº†ï¼Œåˆ™è¯´æ˜æˆ‘ä»¬çš„å†…éƒ¨é€»è¾‘æ²¡æœ‰å½¢æˆé—­ç¯ï¼Œå­˜åœ¨é—®é¢˜ã€‚ // panic å¯ä»¥ç¬¬ä¸€æ—¶é—´æš´éœ²é—®é¢˜ï¼Œç„¶åè¢«è§£å†³æ‰ã€‚ // ä¸è¿‡è¿™ä¸ªæ—¶å€™å»ºè®®ä½ ä½¿ç”¨ gin çš„ recover ä¸­é—´ä»¶è¿›è¡Œå…¨å±€ä¿æŠ¤ï¼Œé¿å…æ•´ä¸ªæœåŠ¡å› ä¸º panic è€Œå®•æœºã€‚ uc, _ := ctx.Get(claims)\tuserClaims := uc.(*UserClaims) // ... 5. Refresh Token æœºåˆ¶ 5.1 æ·»åŠ åˆ·æ–° Token æ¥å£ func (u *UserHandler) RefreshToken(ctx *gin.Context) // ä»è¯·æ±‚å¤´è·å– Refresh Token refreshTokenStr := ctx.GetHeader(x-refresh-token) if refreshTokenStr == ctx.AbortWithStatus(http.StatusUnauthorized) return // è§£æå’ŒéªŒè¯ Refresh Token var refreshClaims RefreshClaims refreshToken, err := jwt.ParseWithClaims(refreshTokenStr, refreshClaims, func(token *jwt.Token) (interface, error) return RefreshTokenKey, nil ) if err != nil || !refreshToken.Valid ctx.AbortWithStatus(http.StatusUnauthorized) return // éªŒè¯ User Agent if refreshClaims.UserAgent != ctx.Request.UserAgent() ctx.AbortWithStatus(http.StatusUnauthorized) return // ç”Ÿæˆæ–°çš„ Access Token accessClaims := UserClaims UserID: refreshClaims.UserID, UserAgent: ctx.Request.UserAgent(), RegisteredClaims: jwt.RegisteredClaims ExpiresAt: jwt.NewNumericDate(time.Now().Add(AccessTokenDuration)), , newAccessToken := jwt.NewWithClaims(jwt.SigningMethodHS512, accessClaims) newAccessTokenStr, err := newAccessToken.SignedString(AccessTokenKey) if err != nil utils.GinErr(ctx, nil, utils.SystemErr(err), generate new access token failed) return // å¯¹ Refresh Token è¿›è¡Œç»­æœŸ refreshClaims := RefreshClaims UserID: user.ID, UserAgent: ctx.Request.UserAgent(), RegisteredClaims: jwt.RegisteredClaims ExpiresAt: jwt.NewNumericDate(time.Now().Add(RefreshTokenDuration)), // 7å¤©è¿‡æœŸ , newRefreshToken := jwt.NewWithClaims(jwt.SigningMethodHS512, refreshClaims) newRefreshTokenStr, err := newRefreshToken.SignedString(RefreshTokenKey) if err != nil utils.GinErr(ctx, req, utils.SystemErr(err), generate new refresh token failed) return // è¿”å›æ–°çš„ Access Token å’Œç»­æœŸåçš„ Refresh Token ctx.Header(x-jwt-token, newAccessTokenStr) ctx.Header(x-refresh-token, newRefreshTokenStr) ctx.JSON(http.StatusOK, token refreshed) 5.2 æ³¨å†Œè·¯ç”± åœ¨ RegisterRoutes æ–¹æ³•ä¸­æ·»åŠ æ–°è·¯ç”±ï¼š func (u *UserHandler) RegisterRoutes(server *gin.Engine) ur := server.Group(/users) ur.POST(/login, u.LoginJWT) ur.GET(/profile, u.Profile) ur.POST(/refresh, u.RefreshToken) 6. å®¢æˆ·ç«¯ä½¿ç”¨æµç¨‹ ç™»å½•åè·å– Access Token å’Œ Refresh Token ä½¿ç”¨ Access Token è®¿é—®å—ä¿æŠ¤èµ„æº å½“ Access Token è¿‡æœŸæ—¶è°ƒç”¨ /refresh æ¥å£è·å–æ–°çš„ Access Token ä½¿ç”¨æ–°çš„ Access Token ç»§ç»­è®¿é—® åˆ·æ–° token çš„å®¢æˆ·ç«¯ç¤ºä¾‹ä»£ç ï¼ˆç¬”è€…å¹¶ä¸æ“…é•¿å†™å‰ç«¯ä»£ç  hhhï¼Œæ‰€ä»¥è¿™æ˜¯è®© ChatGPT å¸®å¿™å†™çš„ ğŸ˜„ï¼‰ï¼š async function refreshAccessToken() const response = await fetch(/users/refresh, method: POST, headers: x-refresh-token: localStorage.getItem(refreshToken) ); if (response.ok) const newAccessToken = response.headers.get(x-jwt-token); localStorage.setItem(accessToken, newAccessToken); const newRefreshToken = response.headers.get(x-refresh-token); localStorage.setItem(refreshToken, newRefreshToken); return newAccessToken; // å¦‚æœåˆ·æ–°å¤±è´¥ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ window.location.href = /login; 7. Token ç»­æœŸç­–ç•¥å¯¹æ¯” åœ¨å‰é¢æ¡ˆä¾‹ä¸­ï¼Œç»†å¿ƒçš„è¯»è€…å¯ä»¥è§‚å¯Ÿåˆ°æˆ‘ä»¬å¯¹ AccessToken å’Œ RefreshToken åˆ†åˆ«é‡‡ç”¨äº† 2 ç§ä¸åŒçš„ç»­æœŸç­–ç•¥ã€‚ è‡ªåŠ¨ç»­æœŸ ä¼˜ç‚¹ï¼š ç®€å•æ˜“ç”¨ï¼šåœ¨æ¯æ¬¡è¯·æ±‚æ—¶è‡ªåŠ¨æ£€æŸ¥å¹¶ç»­æœŸ Tokenï¼Œç”¨æˆ·ä½“éªŒæµç•…ã€‚ æ— é¢å¤–å­˜å‚¨éœ€æ±‚ï¼šä¸éœ€è¦å­˜å‚¨ Refresh Tokenï¼Œå‡å°‘äº†å­˜å‚¨å’Œç®¡ç†çš„å¤æ‚æ€§ ç¼ºç‚¹ï¼š å®‰å…¨æ€§è¾ƒä½ï¼šå¦‚æœ Token è¢«ç›—ç”¨ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡è‡ªåŠ¨ç»­æœŸä¿æŒé•¿æ—¶é—´çš„è®¿é—®ã€‚ Token è¿‡æœŸæ—¶é—´ä¸å›ºå®šï¼šToken çš„æœ‰æ•ˆæœŸä¼šä¸æ–­å»¶é•¿ï¼Œéš¾ä»¥æ§åˆ¶ã€‚ Refresh Token ä¼˜ç‚¹ï¼š æ›´é«˜çš„å®‰å…¨æ€§ï¼šå³ä½¿ Access Token è¢«ç›—ç”¨ï¼Œæ”»å‡»è€…ä¹Ÿæ— æ³•ç»­æœŸï¼Œé™¤éåŒæ—¶è·å– Refresh Tokenã€‚ å¯æ§çš„ Token ç”Ÿå‘½å‘¨æœŸï¼šAccess Token æœ‰å›ºå®šçš„çŸ­æœŸæœ‰æ•ˆæœŸï¼ŒRefresh Token æœ‰è¾ƒé•¿çš„æœ‰æ•ˆæœŸã€‚ æ”¯æŒ Token æ’¤é”€ï¼šå¯ä»¥å®ç° Refresh Token çš„é»‘åå•æœºåˆ¶ï¼Œæ”¯æŒæ‰‹åŠ¨æ’¤é”€ã€‚ ç¼ºç‚¹ï¼š å®ç°å¤æ‚åº¦è¾ƒé«˜ï¼šéœ€è¦é¢å¤–çš„æ¥å£å’Œé€»è¾‘æ¥å¤„ç† Refresh Tokenã€‚ å­˜å‚¨éœ€æ±‚ï¼šéœ€è¦å®‰å…¨å­˜å‚¨ Refresh Tokenï¼Œå¯èƒ½éœ€è¦æ•°æ®åº“æ”¯æŒã€‚ 8. æ€»ç»“ JWT å®ç°ç”¨æˆ·è®¤è¯çš„ä¼˜åŠ¿åœ¨äºæ— çŠ¶æ€ã€è·¨åŸŸæ”¯æŒå’Œçµæ´»æ€§ã€‚é€šè¿‡åˆç†ä½¿ç”¨ JWT å’Œé€‰æ‹©åˆé€‚çš„ Token ç»­æœŸç­–ç•¥ï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºå®‰å…¨ã€å¯é çš„ç”¨æˆ·è®¤è¯ç³»ç»Ÿã€‚å¸Œæœ›æœ¬æ–‡èƒ½å¸®åŠ©æ‚¨åœ¨ Go é¡¹ç›®ä¸­æ›´å¥½åœ°å®ç° JWT è®¤è¯ã€‚","tags":["Go","JWT","Go å®æˆ˜"],"categories":["Go","Go å®æˆ˜"]},{"title":"æ·±å…¥ Go è¯­è¨€æ ¸å¿ƒï¼šmap å’Œ slice çš„ä¼ å‚æœ‰ä»€ä¹ˆä¸åŒ","path":"/2025/02/14/go-slice-vs-map/","content":"åœ¨ Go å¼€å‘ä¸­ï¼Œç»å¸¸ä¼šé‡åˆ°éœ€è¦åœ¨å‡½æ•°ä¸­ä¿®æ”¹ map æˆ– slice çš„åœºæ™¯ã€‚è™½ç„¶å®ƒä»¬éƒ½æ”¯æŒåŠ¨æ€æ‰©å®¹ï¼Œä½†åœ¨å‡½æ•°ä¼ å‚æ—¶çš„è¡Œä¸ºå´å¤§ä¸ç›¸åŒã€‚ä»Šå¤©ï¼Œè®©æˆ‘ä»¬é€šè¿‡å®ä¾‹æ·±å…¥ç†è§£è¿™ä¸ªé—®é¢˜ã€‚ ä¸€ä¸ªå›°æƒ‘çš„å¼€å§‹ çœ‹è¿™æ ·ä¸€ä¸ªä¾‹å­ï¼š func main() // Map ç¤ºä¾‹ m := map[string]intold: 1 modifyMap(m) fmt.Println(m) // è¾“å‡º: map[new:1] // Slice ç¤ºä¾‹ s := []int1, 2, 3 modifySlice(s) fmt.Println(s) // è¾“å‡º: [100 2 3]ï¼Œè€Œä¸æ˜¯ [100 2 3 200]func modifyMap(m map[string]int) m[new] = 1 // ä¼šå½±å“åŸå§‹ map delete(m, old) // ä¹Ÿä¼šå½±å“åŸå§‹ mapfunc modifySlice(s []int) s[0] = 100 // ä¼šå½±å“åŸå§‹ slice s = append(s, 200) // ä¸ä¼šå½±å“åŸå§‹ slice æœ‰è¶£çš„æ˜¯ï¼š map çš„æ‰€æœ‰æ“ä½œéƒ½ä¼šå½±å“åŸå§‹æ•°æ® slice çš„ç®€å•ç´¢å¼•ä¿®æ”¹ä¼šå½±å“åŸå§‹æ•°æ®ï¼Œä½† append å¯èƒ½ä¸ä¼š ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿè®©æˆ‘ä»¬ä»å†…éƒ¨ç»“æ„å¼€å§‹åˆ†æã€‚ å†…éƒ¨ç»“æ„è§£æ Map çš„å†…éƒ¨ç»“æ„ type hmap struct count int // å…ƒç´ ä¸ªæ•° flags uint8 // çŠ¶æ€æ ‡å¿— B uint8 // æ¡¶çš„å¯¹æ•° B buckets unsafe.Pointer // æŒ‡å‘æ¡¶æ•°ç»„çš„æŒ‡é’ˆ // ... å…¶ä»–å­—æ®µ å½“æˆ‘ä»¬å£°æ˜ä¸€ä¸ª map å˜é‡æ—¶ï¼š m := make(map[string]int)// å®é™…ä¸Š m æ˜¯ *hmapï¼Œå³æŒ‡å‘ hmap ç»“æ„çš„æŒ‡é’ˆ Slice çš„å†…éƒ¨ç»“æ„ type slice struct array unsafe.Pointer // æŒ‡å‘åº•å±‚æ•°ç»„çš„æŒ‡é’ˆ len int // å½“å‰é•¿åº¦ cap int // å½“å‰å®¹é‡ å½“æˆ‘ä»¬å£°æ˜ä¸€ä¸ª slice å˜é‡æ—¶ï¼š s := make([]int, 0, 10)// s æ˜¯ä¸€ä¸ªå®Œæ•´çš„ slice ç»“æ„ä½“ï¼Œè€Œä¸æ˜¯æŒ‡é’ˆ æ·±å…¥ç†è§£ä¼ å‚è¡Œä¸º åœºæ™¯ä¸€ï¼šç®€å•ä¿®æ”¹ï¼ˆä¸æ¶‰åŠæ‰©å®¹ï¼‰ func modifyBoth(m map[string]int, s []int) m[key] = 1 // é€šè¿‡æŒ‡é’ˆä¿®æ”¹åŸå§‹ map s[0] = 100 // é€šè¿‡æŒ‡å‘ç›¸åŒåº•å±‚æ•°ç»„çš„æŒ‡é’ˆä¿®æ”¹ å›¾è§£ï¼š Map:main()ä¸­çš„ m ----- hmap... ----- modifyBoth()ä¸­çš„ m(åŒä¸€ä¸ªåº•å±‚ç»“æ„)Slice:main()ä¸­çš„ s = slicearray: æŒ‡å‘æ•°ç»„1, len: 3, cap: 3 | v [1 2 3] ^modifyBoth()ä¸­çš„ s = slicearray: æŒ‡å‘æ•°ç»„1, len: 3, cap: 3 åœºæ™¯äºŒï¼šæ¶‰åŠæ‰©å®¹çš„æ“ä½œ func expandBoth(m map[string]int, s []int) // map æ‰©å®¹ for i := 0; i 100; i++ m[fmt.Sprintf(key%d, i)] = i // slice æ‰©å®¹ s = append(s, 200) å›¾è§£ï¼š Map æ‰©å®¹è¿‡ç¨‹ï¼šBefore:main()ä¸­çš„ m ----- hmapbuckets: æŒ‡å‘å­˜å‚¨A ^expandBoth()ä¸­çš„ m ---------|After:main()ä¸­çš„ m ----- hmapbuckets: æŒ‡å‘æ›´å¤§çš„å­˜å‚¨B // åŒä¸€ä¸ª hmapï¼Œåªæ˜¯æ›´æ–°äº†å†…éƒ¨æŒ‡é’ˆ ^expandBoth()ä¸­çš„ m ---------|Slice æ‰©å®¹è¿‡ç¨‹ï¼šBefore:main()ä¸­çš„ s = slicearray: æŒ‡å‘æ•°ç»„A, len: 3, cap: 3 | v [1 2 3] ^expandBoth()ä¸­çš„ s = slicearray: æŒ‡å‘æ•°ç»„A, len: 3, cap: 3After append:main()ä¸­çš„ s = slicearray: æŒ‡å‘æ•°ç»„A, len: 3, cap: 3 // ä¿æŒä¸å˜ | v [1 2 3]expandBoth()ä¸­çš„ s = slicearray: æŒ‡å‘æ•°ç»„B, len: 4, cap: 6 // æ–°çš„ç»“æ„ä½“ï¼ŒæŒ‡å‘æ–°æ•°ç»„ | v [1 2 3 200] å…³é”®åŒºåˆ«è§£æ ä¼ é€’æ–¹å¼ä¸åŒï¼š map ä¼ é€’çš„æ˜¯æŒ‡é’ˆï¼Œå‡½æ•°å†…å¤–ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ª hmap ç»“æ„ slice ä¼ é€’çš„æ˜¯ç»“æ„ä½“å‰¯æœ¬ï¼Œå‡½æ•°å†…çš„ä¿®æ”¹å‘ç”Ÿåœ¨å‰¯æœ¬ä¸Š æ‰©å®¹è¡Œä¸ºä¸åŒï¼š map æ‰©å®¹æ—¶ï¼ŒåŸæœ‰çš„ hmap ç»“æ„ä¿æŒä¸å˜ï¼Œåªæ›´æ–°å†…éƒ¨çš„ buckets æŒ‡é’ˆ slice æ‰©å®¹æ—¶ï¼Œä¼šåˆ›å»ºæ–°çš„åº•å±‚æ•°ç»„ï¼Œå¹¶è¿”å›ä¸€ä¸ªæŒ‡å‘æ–°æ•°ç»„çš„æ–° slice ç»“æ„ä½“ ä¿®æ”¹æ•ˆæœä¸åŒï¼š map çš„æ‰€æœ‰æ“ä½œï¼ˆåŒ…æ‹¬æ‰©å®¹ï¼‰éƒ½ä¼šåæ˜ åˆ°åŸå§‹æ•°æ® slice çš„è¡Œä¸ºåˆ†ä¸¤ç§æƒ…å†µï¼š ä¸æ¶‰åŠæ‰©å®¹çš„ä¿®æ”¹ä¼šå½±å“åŸå§‹æ•°æ®ï¼ˆå› ä¸ºæŒ‡å‘åŒä¸€ä¸ªåº•å±‚æ•°ç»„ï¼‰ æ¶‰åŠæ‰©å®¹çš„æ“ä½œï¼ˆå¦‚ appendï¼‰ä¼šåˆ›å»ºæ–°çš„åº•å±‚æ•°ç»„ï¼Œä¿®æ”¹ä¸ä¼šå½±å“åŸå§‹æ•°æ® æœ€ä½³å®è·µ åŸºäºä»¥ä¸ŠåŸç†ï¼Œåœ¨ç¼–ç æ—¶åº”æ³¨æ„ï¼š å¯¹äº mapï¼š func modifyMap(m map[string]int) m[key] = 1 // ç›´æ¥ä¿®æ”¹å³å¯ï¼Œä¸éœ€è¦è¿”å› å¯¹äº sliceï¼š func modifySlice(s []int) []int // å¦‚æœéœ€è¦ append æˆ–å…¶ä»–å¯èƒ½å¯¼è‡´æ‰©å®¹çš„æ“ä½œ return append(s, 1)// ä½¿ç”¨æ—¶s = modifySlice(s) æ€»ç»“ ç†è§£ map å’Œ slice çš„è¿™äº›å·®å¼‚ï¼Œå…³é”®åœ¨äºï¼š map æ˜¯æŒ‡é’ˆç±»å‹ï¼Œå§‹ç»ˆæŒ‡å‘åŒä¸€ä¸ª hmap ç»“æ„ slice æ˜¯ç»“æ„ä½“ï¼ŒåŒ…å«äº†æŒ‡å‘åº•å±‚æ•°ç»„çš„æŒ‡é’ˆ æ‰©å®¹æ—¶ map åªæ›´æ–°å†…éƒ¨æŒ‡é’ˆï¼Œè€Œ slice éœ€è¦åˆ›å»ºæ–°çš„åº•å±‚æ•°ç»„ è¿™ç§è®¾è®¡å„æœ‰ä¼˜åŠ¿ï¼š map çš„è¡Œä¸ºæ›´åŠ ç»Ÿä¸€å’Œç›´è§‚ slice çš„è®¾è®¡æä¾›äº†æ›´å¤šçš„çµæ´»æ€§å’Œæ§åˆ¶æƒ åœ¨å®é™…ç¼–ç¨‹ä¸­ï¼Œæ­£ç¡®ç†è§£å’Œå¤„ç†è¿™äº›å·®å¼‚ï¼Œæ˜¯å†™å‡ºå¥å£® Go ä»£ç çš„å…³é”®ã€‚","tags":["Go"],"categories":["Go"]},{"title":"è¯»ä¹¦ç¬”è®°ä¸¨è§£å¯† QUIC/HTTP3ï¼šæœªæ¥äº’è”ç½‘çš„åŸºçŸ³","path":"/2025/01/15/book-quic-http3/","content":"1. QUIC äº§ç”ŸèƒŒæ™¯ å¸¸è§ç½‘ç»œåè®® UDP TCP SCTPï¼ˆStream Control Transmission Protocolï¼‰ï¼šç”¨äºç”µè¯ç½‘ç»œã€‚ KCPï¼šåŸºäº UDP åœ¨åº”ç”¨å±‚å®ç°å¯é æ€§ä¼ è¾“ï¼Œç‰ºç‰²å¸¦å®½æ¢å–æ•ˆç‡ã€‚ RTPï¼ˆReal-time Transport Protocolï¼‰ï¼šä¸ RTCP é…åˆä¼ è¾“å®æ—¶æ•°æ®ï¼Œå¦‚äº¤äº’å¼éŸ³é¢‘å’Œè§†é¢‘æ•°æ®ã€‚ RTCPï¼šä¼ è¾“æ§åˆ¶ä¿¡æ¯ RTPï¼šä¼ è¾“å®æ—¶æ•°æ® TSL ç‰ˆæœ¬æ¼”åŒ– SSLv2ï¼šå®‰å…¨æ€§ä½ SSLv3ï¼šåˆ†ä¸ºæ¡æ‰‹é˜¶æ®µå’Œæ•°æ®ä¼ è¾“é˜¶æ®µã€‚ æ¡æ‰‹é˜¶æ®µå®Œæˆå¯¹ç«¯ç‚¹çš„è®¤è¯å’Œç¡®å®šä¿æŠ¤æ•°æ®ä¼ è¾“çš„å¯†é’¥ã€‚ ä¸€æ—¦ç¡®å®šäº†å¯†é’¥ï¼Œåé¢çš„æ•°æ®ä¼ è¾“å’ŒSSLåè®®è¿‡ç¨‹éƒ½å—åˆ°åŠ å¯†å’Œå®Œæ•´æ€§ä¿æŠ¤ã€‚ TSL1.0ï¼šåŸºäº SSLv3ï¼Œå­˜åœ¨ CBCï¼ˆCipher Block Chainingï¼Œå¯†æ–‡åˆ†ç»„é“¾æ¥ï¼‰åŠ å¯†å’Œè§£å¯†æ¨¡å¼æ¼æ´ï¼Œä½¿å¾—ä¸»åŠ¨æ”»å‡»è€…å¯ä»¥è§‚å¯Ÿåˆ°å½“å‰è®°å½•çš„ IVï¼ˆIntiallization Vectorï¼Œåˆå§‹åŒ–å‘é‡ï¼‰ï¼ŒçŒœæµ‹ä¸€ä¸ªæ•°æ®åº“ï¼Œè¿›è¡Œæ•°æ®æ³¨å…¥ã€‚ TSL1.1ï¼šä¿®å¤äº† TSL1.0 çš„ä¸€äº›å…³é”®å®‰å…¨é—®é¢˜ï¼š BC åŠ å¯†ä½¿ç”¨æ¯æ¡è®°å½•ä¸€ä¸ªçš„æ˜¾å¼IVï¼› ä¸ºäº†é˜²æ­¢ CBC å¡«å……æ”»å‡»ï¼Œä½¿ç”¨ bad_record_mac é”™è¯¯ç ä»£æ›¿ decryption_failed å›å¤å¡«å……é”™è¯¯ï¼› æ”¯æŒä¼ è¾“å‚æ•°çš„IANAï¼ˆInternet Assigned Numbers Authorityï¼Œäº’è”ç½‘æ•°å­—åˆ†é…æœºæ„ï¼‰æ³¨å†Œï¼Œå¢åŠ äº†ä¼ è¾“å‚æ•°çš„çµæ´»æ€§ï¼› æ”¹è¿›äº†è¿æ¥å…³é—­è¿‡æ—©æƒ…å†µä¸‹çš„è¿æ¥æ¢å¤é—®é¢˜ã€‚ æœ‰äº›åŠ å¯†ç®—æ³•è¿˜æ˜¯å­˜åœ¨å®‰å…¨æ¼æ´ï¼Œä½¿ç”¨çš„ MD5 ä¹Ÿä¸å®‰å…¨ã€‚ TSL1.2ï¼šä¸»è¦å…³æ³¨äº†æ¶æ„çµæ´»æ€§å’Œå®‰å…¨é—®é¢˜ã€‚ æ¶æ„ï¼š å®¢æˆ·ç«¯å¯ä»¥æŒ‡å®šè‡ªå·±æ”¯æŒçš„ç­¾åå’Œ hash ç®—æ³•åˆ—è¡¨ï¼› æ”¯æŒéåè®®å›ºå®šçš„ç®—æ³•ï¼› å®‰å…¨ï¼š å¢åŠ äº†å¯¹ AEADï¼ˆAuthenticated Encryption with Associated Data å…³è”æ•°æ®è®¤è¯åŠ å¯†ï¼‰çš„æ”¯æŒï¼Œå¯ä»¥åœ¨åŠ å¯†ä¸­è®¤è¯æ²¡æœ‰åŠ å¯†éƒ¨åˆ†çš„å…³é”®æ•°æ®ï¼Œç”šè‡³æ˜¯ä¸åœ¨æŠ¥æ–‡ä¸­çš„å…³é”®æ•°æ®ï¼Œå¯ä»¥ä¿æŠ¤æ›´å¤§çš„èŒƒå›´ã€‚ è§„å®šå¿…é¡»å®ç°å¯†ç å¥—ä»¶ TLS_RSA_WITH_AES_128_CBC_SHAã€‚ å¢åŠ äº† HMAC-SHA256 å¯†ç å¥—ä»¶ã€‚ åˆ é™¤äº†åŒ…å«å·²åºŸå¼ƒç®—æ³•çš„ IDEA å’Œ DES å¯†ç å¥—ä»¶ã€‚ å¯¹ EncryptedPreMasterSecret ç‰ˆæœ¬å·è¿›è¡Œäº†æ›´ä¸¥æ ¼çš„æ£€æŸ¥ã€‚ TSL1.3ï¼šé™¤äº†å¢åŠ å®‰å…¨æ€§ï¼Œé‡ç‚¹æ”¹è¿›äº†è¿æ¥é€Ÿåº¦ï¼Œé¦–æ¬¡è¿æ¥å‘é€æ•°æ®æœ€ä½å¯ä»¥ 1-RTTï¼Œæ¢å¤è¿æ¥å‘é€æ•°æ®æœ€ä½å¯ä»¥ 0-RTTã€‚ å®‰å…¨ï¼š åˆ é™¤äº†æ‰€æœ‰è¢«è¯æ˜æœ‰é—®é¢˜çš„å¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œåªä¿ç•™äº† AEAD çš„åŠ å¯†å¥—ä»¶ã€‚å¯†ç å¥—ä»¶çš„æ¦‚å¿µä¹Ÿå·²ç»æ”¹å˜ï¼Œå°†è®¤è¯å’Œå¯†é’¥äº¤æ¢æœºåˆ¶ä¸åŠ å¯†ç®—æ³•å’Œæ•£åˆ—ï¼ˆç”¨äºå¯†é’¥å¯¼å‡ºå‡½æ•°å’Œæ¡æ‰‹æ¶ˆæ¯è®¤è¯ç ï¼‰åˆ†ç¦»ã€‚ åˆ é™¤ RSA å’Œé™æ€ DH å¯†ç å¥—ä»¶ï¼Œå› ä¸ºé™æ€ RSA åŠ å¯†é¢„ä¸»å¯†é’¥çš„æ–¹å¼å’Œä½¿ç”¨é™æ€ DH ç§é’¥éƒ½ä¸èƒ½ä¿è¯å‰å‘å®‰å…¨æ€§ï¼Œå¾ˆå®¹æ˜“æ³„éœ²å¯†é’¥ã€‚åªä¿ç•™èƒ½ä¿è¯å‰å‘å®‰å…¨çš„å¯†é’¥äº¤æ¢ç®—æ³•ï¼Œå¦‚ä½¿ç”¨ä¸´æ—¶ç§é’¥çš„ ECDHEï¼ˆElliptic Curve Diffie-Hellman Ephemeralï¼Œæ¤­åœ†æ›²çº¿ DH ä¸´æ—¶å¯†é’¥äº¤æ¢ç®—æ³•ï¼‰å’Œ DHEï¼ˆDiffie-Hellman Ephemeral, DH ä¸´æ—¶å¯†é’¥äº¤æ¢ç®—æ³•ï¼‰ã€‚ ServerHello ä¹‹åçš„æ¶ˆæ¯éƒ½åŠ å¯†ä¼ è¾“ã€‚ åˆ é™¤äº†å‹ç¼©åŠŸèƒ½ã€‚ä¹‹å‰ç‰ˆæœ¬çš„å‹ç¼©åŠŸèƒ½ç”±äºå­˜åœ¨è¢«æ”»å‡»çš„é£é™©å®é™…ä¸Šå¾ˆå°‘ä½¿ç”¨ï¼Œè€Œä¸”ç°ä»£çš„å‹ç¼©åŸºæœ¬éƒ½åœ¨åº”ç”¨å±‚å®ç°ï¼Œæ¯”å¦‚HTTP å°±è‡ªå·±å®ç°çš„å‹ç¼©ã€‚ HTTP ç‰ˆæœ¬æ¼”åŒ– HTTP0.9ï¼šä»…æ”¯æŒç®€å•çš„è¯·æ±‚å“åº”ï¼Œåªèƒ½è®¿é—®ç®€å•çš„æ–‡æœ¬æ–‡æ¡£ã€‚ HTTP1.0ï¼šHTTP1 ä¸­å¼•å…¥äº†è¯·æ±‚å¤´å’Œå“åº”å¤´ï¼Œè¯·æ±‚æ—¶å¯ä»¥æŒ‡å®š HTTP ç‰ˆæœ¬å·ã€ç”¨æˆ·ä»£ç†ã€æ¥æ”¶ç±»å‹ç­‰ï¼Œå“åº”å¯ä»¥æŒ‡æ˜å“åº”çŠ¶æ€ã€å†…å®¹é•¿åº¦ã€å†…å®¹ç±»å‹ç­‰ã€‚ HTTP1.1ï¼šå¢åŠ äº†é‡ç”¨ TCP è¿æ¥ï¼ˆkeep-aliveï¼‰çš„æ–¹æ³•ï¼Œé»˜è®¤ä¿æŒè¿æ¥ï¼Œé™¤éæ˜¾å¼é€šçŸ¥å…³é—­è¿æ¥[æ’å›¾]ã€‚è¿™æ ·å¯ä»¥åœ¨ä¸€ä¸ª TCP è¿æ¥ä¸Šå®Œæˆå¤šä¸ªè¯·æ±‚-å“åº”ï¼Œæ¶ˆé™¤äº† TCP å»ºç«‹çš„å»¶è¿Ÿï¼Œä¹Ÿé¿å…äº†æ–°å»ºç«‹çš„ TCP è¿æ¥çš„æ…¢å¯åŠ¨è¿‡ç¨‹ã€‚ HTTP1.1 åœ¨ HTTP è¯·æ±‚é¦–éƒ¨ä¸­å¢åŠ äº† Host å­—æ®µï¼Œç”¨æ¥æ”¯æŒå…±äº« IP åœ°å€çš„è™šæ‹Ÿä¸»æœºæœåŠ¡å™¨ã€‚ åŒæ—¶æ”¯æŒäº†æ›´å¤šçš„æ–¹æ³•ï¼Œå¦‚ PUTã€PATCHã€DELETEã€OPTIONSã€‚ å¼•å…¥åˆ†å—ä¼ è¾“æ”¯æŒåŠ¨æ€å†…å®¹ã€‚ å¼•å…¥äº†æ›´å¤šçš„ç¼“å­˜æ§åˆ¶ç­–ç•¥ã€‚ æ”¯æŒè¯·æ±‚éƒ¨åˆ†å†…å®¹ã€‚ HTTP2ï¼šä¿®æ”¹äº† HTTP1.1 çš„å°è£…æ ¼å¼ï¼Œå¢åŠ äº†ä¸€ä¸ªäºŒè¿›åˆ¶åˆ†å¸§å±‚ã€‚åŸºäºäºŒè¿›åˆ¶åˆ†å±‚ï¼ŒHTTP2 å®ç°äº† HTTP çš„å¤šè·¯å¤ç”¨ã€‚HTTP2 ä¸ºæ¯ä¸ªè¯·æ±‚åˆ†é…äº†ä¸€ä¸ªæµæ ‡è¯†ï¼ŒæœåŠ¡å™¨å“åº”æ—¶å¸¦ä¸Šç›¸åŒçš„æµæ ‡è¯†ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥æ–¹ä¾¿åœ°å°†å“åº”ä¸è¯·æ±‚å…³è”èµ·æ¥ï¼Œè€Œä¸ç”¨ä¾èµ–é¡ºåºï¼Œä»è€Œå¯ä»¥é™ä½å»¶è¿Ÿå’Œæé«˜ååé‡ã€‚ HTTP2 è¿˜å¢åŠ äº†é¦–éƒ¨å‹ç¼© HPACKï¼ˆHeader Compression for HTTP2ï¼ŒHTTP2 é¦–éƒ¨å‹ç¼©ç®—æ³•ï¼‰ã€‚ æ”¯æŒè¯·æ±‚ä¼˜å…ˆçº§ã€‚ æ”¯æŒæœåŠ¡å™¨ä¸»åŠ¨æ¨é€ã€‚ å¢åŠ äº† ALPNï¼ˆApplication-Layer Protocol Negotiationï¼Œåº”ç”¨å±‚åè®®åå•†ï¼‰ã€‚ æ”¯æŒè®¤è¯ã€åŠ å¯†å’Œå®Œæ•´æ€§ä¿æŠ¤ï¼Œå³ HTTPSã€‚ ä½†å¤šä¸ªè¯·æ±‚æˆ–å“åº”åœ¨åŒä¸€ä¸ª TCP ä¸Šå‘é€æ—¶ï¼Œä»ç„¶å—åˆ¶äº TCP çš„é˜Ÿé¦–é˜»å¡é—®é¢˜ã€‚ HTTP3ï¼šåŸºäº QUIC åè®®ï¼Œåº•å±‚ä½¿ç”¨ UDP å®ç°ï¼Œæ‘†è„±äº† TCP çš„é˜Ÿé¦–é˜»å¡é—®é¢˜ã€‚åŒæ—¶æ”¹è¿›äº† TCP ä¸­å­˜åœ¨çš„ä¸€äº›å…¶ä»–é—®é¢˜ï¼Œæ¯”å¦‚æ‹¥å¡æ§åˆ¶ã€åè®®åƒµåŒ–ã€å¯åŠ¨æ…¢ã€é‡è¿æ…¢ã€å®‰å…¨å¼±ç­‰ã€‚ å®ç°äº†æ²¡æœ‰é˜Ÿé¦–é˜»å¡çš„å¹¶å‘ã€‚å¦‚æœ QUIC ä¸¢äº†ä¸€ä¸ªæŠ¥æ–‡ï¼Œä»…ä»…å½±å“å¯¹åº”æµçš„äº¤ä»˜ï¼Œä¸ä¼šé˜»å¡å…¶ä»–æµã€‚ ä¸ TLS1.3 ç´§å¯†åˆä½œï¼Œå°½å¯èƒ½çš„åŠ å¯†ã€‚è¿˜å¢åŠ äº† QUIC æŠ¥æ–‡çš„é¦–éƒ¨åŠ å¯†ï¼Œé™¤ä¿è¯äº†æŠ¥æ–‡å®‰å…¨æ€§ï¼Œæé«˜äº†æ”»å‡»é—¨æ§›ï¼Œè¿˜é¿å…äº†åè®®åƒµåŒ–ã€‚ é€‰æ‹© UDP ä½œä¸ºåº•å±‚å®ç°ã€‚ä¸€æ–¹é¢é¿å…äº† TCP çš„é¦–éƒ¨é˜»å¡ï¼Œå¦ä¸€æ–¹é¢äº’è”ç½‘ä¸­ç»å¤§éƒ¨åˆ†çš„ä¸»æœºå’Œä¸­é—´ä»¶éƒ½æ˜¯ TCP å’Œ UDP çš„å¤©ä¸‹ï¼Œæ‰€ä»¥å¤©ç„¶æ”¯æŒã€‚ ç”¨æˆ·æ€å®ç°ã€‚ä¸ä¾èµ–äºå†…æ ¸ï¼Œå®¹æ˜“å•ç‹¬å‡çº§ã€‚ ä½å»¶è¿Ÿçš„å»ºç«‹ã€‚å®ç°äº†é¦–æ¬¡æœ€ä½ 1-RTT å‘é€åº”ç”¨æ•°æ®ï¼Œæ¢å¤è¿æ¥æ—¶å‘é€åº”ç”¨æ•°æ®æœ€ä½åªéœ€ 0-RTTã€‚ æ— ç¼çš„è¿æ¥è¿ç§»ã€‚QUIC çš„è¿æ¥åŸºäºè¿æ¥æ ‡è¯†ï¼Œæ”¹å˜ IP æˆ–è€… UDP ç«¯å£å·å¹¶ä¸å½±å“è¿æ¥çš„è¯†åˆ«ï¼Œå› æ­¤å¯ä»¥å®ç°æ— ç¼çš„è¿æ¥è¿ç§»ã€‚ä½†æ˜¯è´Ÿè½½å‡è¡¡å°±éº»çƒ¦äº†ã€‚ æ”¹è¿›çš„æµé‡æ§åˆ¶ã€‚ åè®®è¡Œä¸ºä½œä¸ºè´Ÿè½½ã€‚ 2. QUIC æŠ¥æ–‡ é•¿é¦–éƒ¨æŠ¥æ–‡ï¼šç”¨äºå»ºç«‹ QUIC è¿æ¥å’Œå»ºç«‹è¿æ¥å‰å‘é€åº”ç”¨æ•°æ®ã€‚ çŸ­é¦–éƒ¨æŠ¥æ–‡ï¼šç”¨äºåœ¨ QUIC è¿æ¥å»ºç«‹åå‘é€åº”ç”¨æ•°æ®å’Œ QUIC åè®®å†…å®¹ã€‚ æ— çŠ¶æ€é‡ç½®æŠ¥æ–‡ï¼šå½“æœåŠ¡å™¨ä¸¢å¤±äº†è¿æ¥çŠ¶æ€ä½†ä»ç„¶æ”¶åˆ°è¯¥è¿æ¥çš„æ•°æ®åŒ…æ—¶ï¼Œå¯ä»¥å‘é€æ— çŠ¶æ€é‡ç½®æŠ¥æ–‡é€šçŸ¥å®¢æˆ·ç«¯ç«‹å³ç»ˆæ­¢è¿æ¥ã€‚ QUIC æŠ¥æ–‡ç±»å‹ åˆå§‹æŠ¥æ–‡ï¼šå®¢æˆ·ç«¯ä½¿ç”¨åˆå§‹æŠ¥æ–‡æ¥å‘èµ·è¿æ¥ï¼ŒæœåŠ¡å™¨ä½¿ç”¨åˆå§‹æŠ¥æ–‡å’Œæ¡æ‰‹æŠ¥æ–‡å›åº”å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚ 0-RTT æŠ¥æ–‡ï¼šç”¨äºæ‰¿è½½ QUIC è¿æ¥ä¹‹å‰æƒ³è¦å‘é€çš„æ•°æ®ï¼Œä¸€èˆ¬ç”¨äºæ¢å¤è¿æ¥åç«‹å³å‘é€æ•°æ®ã€‚ æ¡æ‰‹æŠ¥æ–‡ï¼šç”¨æ¥æºå¸¦æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çš„ TLS åŠ å¯†æ¡æ‰‹ä¿¡æ¯å’Œç¡®è®¤ï¼Œè½½è·ä¸€èˆ¬æ˜¯ CRYPTO å¸§å’Œ ACK å¸§ã€‚ é‡è¯•æŠ¥æ–‡ï¼šæ˜¯æœåŠ¡å™¨ç”¨æ¥éªŒè¯å®¢æˆ·ç«¯åœ°å€çš„æŠ¥æ–‡ï¼Œå¯ä»¥é˜²æ­¢æºåœ°å€æ¬ºéª—ã€‚ æœåŠ¡å™¨ä½¿ç”¨é‡è¯•æŠ¥æ–‡é€šçŸ¥å®¢æˆ·ç«¯æŒ‰ç…§è¦æ±‚é‡æ–°å‘é€åˆå§‹æŠ¥æ–‡ï¼Œåœ¨é‡è¯•æŠ¥æ–‡ä¸­æºå¸¦é‡è¯•ä»¤ç‰Œç»™å®¢æˆ·ç«¯ï¼Œå¹¶ä½¿ç”¨æœåŠ¡å™¨é€‰æ‹©çš„è¿æ¥æ ‡è¯†ä½œä¸ºé‡è¯•æŠ¥æ–‡çš„æºè¿æ¥æ ‡è¯†ï¼›å®¢æˆ·ç«¯éœ€è¦ä½¿ç”¨æœåŠ¡å™¨æŒ‡å®šçš„è¿æ¥æ ‡è¯†ä½œä¸ºç›®çš„è¿æ¥æ ‡è¯†ï¼Œæºå¸¦æœåŠ¡å™¨æŒ‡å®šçš„é‡è¯•ä»¤ç‰Œï¼Œæ„å»ºæ–°çš„åˆå§‹æŠ¥æ–‡ï¼Œé‡æ–°å‘é€ç»™æœåŠ¡å™¨ã€‚ ç‰ˆæœ¬åå•†æŠ¥æ–‡ï¼šå½“æœåŠ¡å™¨æ”¶åˆ°åŒ…å«è‡ªå·±ä¸æ”¯æŒçš„ç‰ˆæœ¬å·çš„åˆå§‹æŠ¥æ–‡æ—¶ï¼Œå°±ä¼šå‘é€ç‰ˆæœ¬åå•†æŠ¥æ–‡ã€‚å®¢æˆ·ç«¯æ”¶åˆ°ç‰ˆæœ¬åå•†æŠ¥æ–‡åéœ€è¦åœ¨å…¶ä¸­é€‰æ‹©ä¸€ä¸ªè‡ªå·±æ”¯æŒçš„ç‰ˆæœ¬å·ï¼Œé‡æ–°ä»¥æ–°ç‰ˆæœ¬å·å‘é€åˆå§‹æŠ¥æ–‡ã€‚ çŸ­é¦–éƒ¨æŠ¥æ–‡ï¼šä¸€èˆ¬ä¹Ÿå«ä½œ 1-RTT æŠ¥æ–‡ï¼Œè¿æ¥åœ¨åå•†å‡º 1-RTT å¯†é’¥åå°±å¯ä»¥å‘é€çŸ­é¦–éƒ¨æŠ¥æ–‡ï¼Œç”¨äºæºå¸¦åº”ç”¨æ•°æ®ã€‚","tags":["QUIC","HTTP3","è®¡ç®—æœºç½‘ç»œ"],"categories":["è®¡ç®—æœºåŸºç¡€","è®¡ç®—æœºç½‘ç»œ"]},{"title":"åŒ å¿ƒç é“ä¸¨01 ç¼–å†™ä¼˜è´¨ä»£ç çš„åå¤§é»„é‡‘æ³•åˆ™","path":"/2024/12/12/clean-code-10-rules/","content":"ä»£ç è´¨é‡çš„ä¼˜åŠ£ç›´æ¥å½±å“ç€é¡¹ç›®çš„å¯ç»´æŠ¤æ€§å’Œå›¢é˜Ÿçš„å¼€å‘æ•ˆç‡ã€‚ä¸€ä¸ªç»éªŒä¸°å¯Œçš„å¼€å‘è€…ä¸ä»…è¦èƒ½å®ç°åŠŸèƒ½ï¼Œæ›´è¦å–„äºç¼–å†™æ¸…æ™°æ˜“æ‡‚ã€ç»“æ„åˆç†çš„ä»£ç ã€‚æœ¬æ–‡å°†ä»‹ç» 10 æ¡å¸®åŠ©ä½ ç¼–å†™æ¸…æ™°ã€æ˜“ç»´æŠ¤ä¸”å¯æ‰©å±•ä»£ç çš„é‡è¦è§„åˆ™ã€‚ è§„åˆ™ 1. ä½¿ç”¨æœ‰æ„ä¹‰çš„å˜é‡å’Œå‡½æ•°åç§° å˜é‡ã€å‡½æ•°å’Œç±»çš„å‘½ååº”è¯¥å…·æœ‰æè¿°æ€§å’Œæ„ä¹‰ã€‚ä½ çš„ä»£ç åº”è¯¥èƒ½å¤Ÿæ¸…æ™°åœ°è¡¨è¾¾å…¶æ„å›¾ï¼Œè€Œæ— éœ€é¢å¤–çš„æ³¨é‡Šæ¥è§£é‡Šã€‚ åé¢ç¤ºä¾‹ï¼š let a = 10;const d = new Date();const res = await api.get();const arr = users.filter(u = u.a === true); æ­£é¢ç¤ºä¾‹ï¼š let maxRetries = 10;const currentDate = new Date();const userResponse = await api.getUserProfile();const activeUsers = users.filter(user = user.isActive === true); æœ‰æ„ä¹‰çš„å‘½åèƒ½è®²è¿°ä»£ç çš„æ•…äº‹ã€‚è¯»è€…åº”è¯¥èƒ½å¤Ÿä»…é€šè¿‡åç§°å°±ç†è§£å˜é‡æˆ–å‡½æ•°çš„ç”¨é€”ã€‚ ğŸ’¡å®è·µå»ºè®®ï¼š ä½¿ç”¨åŠ¨è¯å‰ç¼€å‘½åå‡½æ•°ï¼šgetUserProfile()ã€validateInput()ã€calculateTotal() ä½¿ç”¨åè¯å‘½åå˜é‡ï¼šuserCountã€activeUsersã€orderStatus å¸ƒå°”å€¼ä½¿ç”¨ is/has/should ç­‰å‰ç¼€ï¼šisValidã€hasPermissionã€shouldUpdate 2. ä¿æŒå‡½æ•°ç®€çŸ­ä¸”ä¸“æ³¨ å‡½æ•°åº”è¯¥ä¿æŒç®€çŸ­ï¼Œå¹¶ä¸”åªåšä¸€ä»¶äº‹ã€‚å‡½æ•°æ‰¿æ‹…çš„è´£ä»»è¶Šå¤šï¼Œæµ‹è¯•ã€è°ƒè¯•å’Œç†è§£èµ·æ¥å°±è¶Šå›°éš¾ã€‚ åé¢ç¤ºä¾‹ï¼š def process_order(order): # å¤šä¸ªè´£ä»»ï¼šéªŒè¯ã€å®šä»·ã€æŠ˜æ‰£ã€é…é€ç­‰ pass æ­£é¢ç¤ºä¾‹ï¼š def validate_order(order): passdef calculate_total(order): passdef apply_discount(order): pass æ¯ä¸ªå‡½æ•°åº”è¯¥åªæœ‰ä¸€ä¸ªè´£ä»»ã€‚å¦‚æœä½ éœ€è¦ç”¨\"å’Œ\"æ¥æè¿°å‡½æ•°çš„åŠŸèƒ½ï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°å¯èƒ½åšå¾—å¤ªå¤šäº†ã€‚ ğŸ’¡ æœ€ä½³å®è·µï¼š å‡½æ•°å»ºè®®ä¿æŒåœ¨ 20-30 è¡Œä»¥å†… å¦‚æœè¶…è¿‡ 50 è¡Œï¼Œåº”è¯¥è€ƒè™‘æ‹†åˆ† ä¸€ä¸ªå‡½æ•°æœ€å¥½ä¸è¦è¶…è¿‡ 3 ä¸ªå‚æ•° 3. é¿å…æ·±å±‚åµŒå¥— æ·±å±‚åµŒå¥—çš„å¾ªç¯å’Œæ¡ä»¶è¯­å¥ä¼šä½¿ä»£ç éš¾ä»¥ç†è§£ã€‚é€šè¿‡ä½¿ç”¨æå‰è¿”å›ã€å‡½æ•°æ‹†åˆ†æˆ–å°†å¤§é—®é¢˜åˆ†è§£ä¸ºå°é—®é¢˜æ¥ä½¿ä»£ç æ‰å¹³åŒ–ã€‚ åé¢ç¤ºä¾‹ï¼š if (user != null) if (user.isActive()) if (order != null) processOrder(order); æ­£é¢ç¤ºä¾‹ï¼š if (user == null || !user.isActive()) return;if (order == null) return;processOrder(order); æå‰è¿”å›å¯ä»¥å‡å°‘è¯»è€…çš„è®¤çŸ¥è´Ÿæ‹…ï¼Œä½¿ä»£ç æ›´ç®€å•ã€æ›´å®¹æ˜“ç†è§£ã€‚ 4. æ˜æ™ºåœ°ä½¿ç”¨æ³¨é‡Š æ³¨é‡Šä¸åº”è¯¥è§£é‡Šä»£ç åšäº†ä»€ä¹ˆï¼›ä»£ç æœ¬èº«åº”è¯¥æ˜¯è‡ªè§£é‡Šçš„ã€‚åªåœ¨å¿…è¦æ—¶ä½¿ç”¨æ³¨é‡Šæ¥è§£é‡Šå¤æ‚é€»è¾‘èƒŒåçš„\"åŸå› \"ï¼Œè€Œä¸æ˜¯\"æ˜¯ä»€ä¹ˆ\"ã€‚ åé¢ç¤ºä¾‹ï¼š // è®¾ç½®ç”¨æˆ·çŠ¶æ€ä¸ºæ¿€æ´»$user-isActive = true; æ­£é¢ç¤ºä¾‹ï¼š // ç™»å½•æˆåŠŸåå°†ç”¨æˆ·æ ‡è®°ä¸ºæ¿€æ´»çŠ¶æ€$user-isActive = true; æ³¨é‡Šåº”è¯¥å¢åŠ ä»·å€¼ï¼Œè§£é‡Šç‰¹å®šå®ç°èƒŒåçš„åŸå› æˆ–è§£é‡Šå¤æ‚çš„ä¸šåŠ¡é€»è¾‘ã€‚ 5. ä¿æŒä¸€è‡´çš„æ ¼å¼ ä¸€è‡´çš„ä»£ç æ ¼å¼ä½¿ä»£ç æ›´å®¹æ˜“é˜…è¯»å’Œå¯¼èˆªã€‚åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ç»Ÿä¸€çš„ç¼©è¿›ã€é—´è·å’Œå¯¹é½æ–¹å¼ã€‚ åé¢ç¤ºä¾‹ï¼š function calculate(a,b)return a+b; æ­£é¢ç¤ºä¾‹ï¼š function calculate(a, b) return a + b; è®¸å¤šå›¢é˜Ÿä½¿ç”¨ Prettier æˆ– ESLint ç­‰å·¥å…·æ¥è‡ªåŠ¨æ ¼å¼åŒ–å¹¶å¼ºåˆ¶æ‰§è¡Œä»£ç é£æ ¼è§„åˆ™ã€‚ 6. ä¸è¦é‡å¤è‡ªå·±ï¼ˆDRY åŸåˆ™ï¼‰ ä»£ç é‡å¤ä¼šå¯¼è‡´ä¸ä¸€è‡´ã€bug å’Œä¸å¿…è¦çš„å¤æ‚æ€§ã€‚åº”ç”¨ DRY åŸåˆ™å¯ä»¥ä¿æŒä»£ç åº“ç²¾ç®€ï¼Œæ›´æ˜“äºç»´æŠ¤ã€‚ åé¢ç¤ºä¾‹ï¼š if ($userType == admin) // å¤æ‚é€»è¾‘if ($userType == superadmin) // ç›¸åŒçš„å¤æ‚é€»è¾‘ æ­£é¢ç¤ºä¾‹ï¼š if (userIsAdmin($userType)) // å¤æ‚é€»è¾‘ é€šè¿‡å°†å…±åŒé€»è¾‘æŠ½è±¡åˆ°å‡½æ•°ã€ç±»æˆ–å·¥å…·ä¸­æ¥é¿å…ä»£ç é‡å¤ã€‚ 7. å•ä¸€è´£ä»»åŸåˆ™ï¼ˆSRPï¼‰ æ¯ä¸ªç±»å’Œå‡½æ•°åº”è¯¥åªæœ‰ä¸€ä¸ªæ”¹å˜çš„ç†ç”±ã€‚éµå¾ªå•ä¸€è´£ä»»åŸåˆ™ä½¿ä»£ç æ¨¡å—åŒ–ï¼Œæ›´å®¹æ˜“é‡æ„ã€‚ åé¢ç¤ºä¾‹ï¼š class User void register(); void login(); void sendEmail(); æ­£é¢ç¤ºä¾‹ï¼š class User void register(); void login();class EmailService void sendEmail(); æ‰¿æ‹…å¤ªå¤šè´£ä»»çš„ç±»æ›´éš¾ç»´æŠ¤ã€‚SRP ä½¿ä»£ç æ›´æ¨¡å—åŒ–ï¼Œæ›´å®¹æ˜“æµ‹è¯•ã€‚ 8. é¿å…é­”æ³•æ•°å­—å’Œå­—ç¬¦ä¸² é­”æ³•æ•°å­—ï¼ˆæˆ–å­—ç¬¦ä¸²ï¼‰æ˜¯æ²¡æœ‰ä¸Šä¸‹æ–‡æˆ–è§£é‡Šçš„ç¡¬ç¼–ç å€¼ã€‚ä½¿ç”¨å¸¸é‡æˆ–æšä¸¾ä»£æ›¿ï¼Œè¿™æ ·å¯ä»¥å¢åŠ ä»£ç çš„æ¸…æ™°åº¦ã€‚ åé¢ç¤ºä¾‹ï¼š discount = 0.05if user.role == admin: æ­£é¢ç¤ºä¾‹ï¼š DISCOUNT_RATE = 0.05ADMIN_ROLE = admindiscount = DISCOUNT_RATEif user.role == ADMIN_ROLE: å¸¸é‡ä¸ºæ•°å­—æˆ–å­—ç¬¦ä¸²æä¾›äº†å«ä¹‰ï¼Œä½¿ä»£ç æ›´å®¹æ˜“ç†è§£ã€‚ 9. ç¼–å†™æµ‹è¯• å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•ç¡®ä¿ä½ çš„ä»£ç æŒ‰é¢„æœŸå·¥ä½œï¼Œå¹¶ä¸”åœ¨è¿›è¡Œæ›´æ”¹æ—¶ä¸ä¼šå‡ºé”™ã€‚ç¼–å†™æµ‹è¯•ä½¿ä»£ç æ›´å¯é ï¼Œé•¿æœŸæ›´æ˜“äºç»´æŠ¤ã€‚ åé¢ç¤ºä¾‹ï¼š // è¿™ä¸ªæ–¹æ³•æ²¡æœ‰æµ‹è¯•public void processOrder(Order order) // é€»è¾‘ æ­£é¢ç¤ºä¾‹ï¼š @Testpublic void testProcessOrder() Order order = new Order(); // æ–­è¨€ æµ‹è¯•åº”è¯¥æˆä¸ºä½ å·¥ä½œæµç¨‹çš„ä¸€éƒ¨åˆ†ï¼Œç¡®ä¿ä»£ç æ—  BUG ä¸”ç¨³å®šã€‚ 10. ä¿æŒç®€å•ï¼ˆKISS åŸåˆ™ï¼‰ KISSï¼ˆKeep It Simple, Stupidï¼‰åŸåˆ™æé†’æˆ‘ä»¬ç®€å•æ˜¯å…³é”®ã€‚å¤æ‚çš„è§£å†³æ–¹æ¡ˆä¼šå¯¼è‡´æ··æ·†ï¼Œæ›´éš¾ç»´æŠ¤ã€‚åœ¨é¢å¯¹å†³ç­–æ—¶ï¼Œé€‰æ‹©æœ€ç®€å•ã€æœ€ç›´æ¥çš„æ–¹æ¡ˆæ¥æ»¡è¶³éœ€æ±‚ã€‚ åé¢ç¤ºä¾‹ï¼š // è¿‡åº¦å¤æ‚çš„è´­ç‰©è½¦å•†å“æ€»ä»·è®¡ç®—function calculateTotal(items) let total = 0; let discount = 0; // å¤æ‚çš„æŠ˜æ‰£è®¡ç®—é€»è¾‘ items.forEach(item = if (item.category === electronics) if (item.price 1000) discount += item.price * 0.1; else if (item.price 500) discount += item.price * 0.05; else if (item.category === books) if (item.quantity 3) discount += item.price * item.quantity * 0.15; total += item.price * item.quantity; ); return total - discount; æ­£é¢ç¤ºä¾‹ï¼š // å°†å¤æ‚é€»è¾‘æ‹†åˆ†æˆå°å‡½æ•°function calculateDiscount(item) if (item.category === electronics) return item.price 1000 ? 0.1 : (item.price 500 ? 0.05 : 0); if (item.category === books item.quantity 3) return 0.15; return 0;function calculateTotal(items) return items.reduce((total, item) = const discount = calculateDiscount(item); const itemTotal = item.price * item.quantity; return total + itemTotal * (1 - discount); , 0); ğŸ’¡ æœ€ä½³å®è·µï¼š å°†å¤æ‚é€»è¾‘æ‹†åˆ†æˆå°çš„ã€å®¹æ˜“ç†è§£çš„å‡½æ•° é¿å…åœ¨ä¸€ä¸ªå‡½æ•°ä¸­å¤„ç†è¿‡å¤šçš„æ¡ä»¶åˆ¤æ–­ ä½¿ç”¨æ¸…æ™°çš„å‘½åæ¥è¡¨è¾¾æ„å›¾ ä¿æŒå‡½æ•°çš„å•ä¸€èŒè´£ æ€»ç»“ å¹²å‡€çš„ä»£ç å¯¹äºå¯ç»´æŠ¤æ€§ã€å¯è¯»æ€§å’Œåä½œè‡³å…³é‡è¦ã€‚éµå¾ªè¿™ 10 æ¡è§„åˆ™â€”â€”ä½¿ç”¨æœ‰æ„ä¹‰çš„å‘½åã€ä¿æŒå‡½æ•°ç®€çŸ­ã€é¿å…é­”æ³•æ•°å­—ã€ç¼–å†™æµ‹è¯•ç­‰ï¼Œå°†ä¼šå¸¦æ¥æ›´å¥å£®ã€æ›´æ˜“ç†è§£å’Œæ›´æ˜“æ‰©å±•çš„ä»£ç åº“ã€‚ç¼–å†™ä»£ç ä¸ä»…ä»…æ˜¯è¦è®©å®ƒèƒ½å·¥ä½œï¼Œæ›´è¦è®©å…¶ä»–äººï¼ˆåŒ…æ‹¬æœªæ¥çš„ä½ ï¼‰èƒ½å¤Ÿè½»æ¾ç†è§£å’Œæ‰©å±•ã€‚ ä»£ç å®¡æŸ¥æ¸…å• åœ¨æäº¤ä»£ç å‰ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ¸…å•è¿›è¡Œè‡ªæŸ¥ï¼š å˜é‡å’Œå‡½æ•°åç§°æ˜¯å¦å…·æœ‰æè¿°æ€§ å‡½æ•°æ˜¯å¦åªåšä¸€ä»¶äº‹ æ˜¯å¦å­˜åœ¨é‡å¤ä»£ç  æ˜¯å¦æœ‰æœªä½¿ç”¨çš„é­”æ³•æ•°å­— æ˜¯å¦ç¼–å†™äº†ç›¸åº”çš„æµ‹è¯• ä»£ç æ ¼å¼æ˜¯å¦ç»Ÿä¸€ æ³¨é‡Šæ˜¯å¦æœ‰ä»·å€¼ åµŒå¥—æ˜¯å¦è¿‡æ·± å‚è€ƒ top-10-clean-code-rules-every-developer-should-follow","tags":["ç¼–ç¨‹è§„èŒƒ","ä»£ç è´¨é‡","æœ€ä½³å®è·µ"],"categories":["åŒ å¿ƒç é“"]},{"title":"KCP æºç åˆ†æä¸åŸç†æ€»ç»“","path":"/2024/12/01/kcp/","content":"åºè¨€ æœ¬æ–‡å¾ˆå¤§éƒ¨åˆ†å‚è€ƒäº† è¯¦è§£ KCP åè®®çš„åŸç†å’Œå®ç°ï¼Œéå¸¸æ„Ÿè°¢è¯¥æ–‡ä½œè€…çš„è®²è§£ã€‚æœ¬æ–‡å†æ­¤åŸºç¡€ä¸Šï¼ŒåŠ å…¥äº†ä¸€äº›ç¬”è€…çš„æ€è€ƒå’Œåˆ†æå›¾ç¤ºï¼Œä»¥æœŸæ›´å¥½åœ°ç†è§£ KCP çš„åº•å±‚åŸç†ã€‚ ç»“è®ºå…ˆè¡Œ KCP æ˜¯ä¸€ä¸ªå¿«é€Ÿå¯é åè®®ï¼Œèƒ½ä»¥æ¯” TCP æµªè´¹ 10%-20% çš„å¸¦å®½çš„ä»£ä»·ï¼Œæ¢å–å¹³å‡å»¶è¿Ÿé™ä½ 30%-40%ï¼Œä¸”æœ€å¤§å»¶è¿Ÿé™ä½ä¸‰å€çš„ä¼ è¾“æ•ˆæœã€‚ TCP æ˜¯ä¸ºæµé‡è®¾è®¡çš„ï¼ˆæ¯ç§’å†…å¯ä»¥ä¼ è¾“å¤šå°‘ KB çš„æ•°æ®ï¼‰ï¼Œè®²ç©¶çš„æ˜¯å……åˆ†åˆ©ç”¨å¸¦å®½ã€‚è€Œ KCP æ˜¯ä¸ºæµé€Ÿè®¾è®¡çš„ï¼ˆå•ä¸ªæ•°æ®åŒ…ä»ä¸€ç«¯å‘é€åˆ°ä¸€ç«¯éœ€è¦å¤šå°‘æ—¶é—´ï¼‰ï¼Œä»¥ 10%-20% å¸¦å®½æµªè´¹çš„ä»£ä»·æ¢å–äº†æ¯” TCP å¿« 30%-40% çš„ä¼ è¾“é€Ÿåº¦ã€‚TCP ä¿¡é“æ˜¯ä¸€æ¡æµé€Ÿå¾ˆæ…¢ï¼Œä½†æ¯ç§’æµé‡å¾ˆå¤§çš„å¤§è¿æ²³ï¼Œè€Œ KCP æ˜¯æ°´æµæ¹æ€¥çš„å°æ¿€æµã€‚ KCP å¢åŠ çš„å¸¦å®½åœ¨å“ªé‡Œï¼Ÿå¢åŠ çš„é€Ÿåº¦åˆåœ¨å“ªé‡Œï¼Ÿ ä¸ºä»€ä¹ˆ KCP èƒ½ä»¥æ¯” TCP æµªè´¹ 10%-20% çš„å¸¦å®½çš„ä»£ä»·ï¼Œæ¢å–å¹³å‡å»¶è¿Ÿé™ä½ 30%-40%ï¼Ÿ KCP æ ¸å¿ƒç‰¹æ€§ å¿«é€Ÿé‡ä¼ ï¼š KCP æ”¯æŒå¿«é€Ÿé‡ä¼ æœºåˆ¶ï¼Œä¸åƒ TCP é‚£æ ·ä¾èµ–è¶…æ—¶é‡ä¼ ã€‚KCP å¯ä»¥æ ¹æ®æ¥æ”¶æ–¹è¿”å›çš„ç¡®è®¤ä¿¡æ¯å¿«é€Ÿåˆ¤æ–­å“ªäº›æ•°æ®åŒ…å·²ç»ä¸¢å¤±ï¼Œå¹¶è¿…é€Ÿè¿›è¡Œé‡ä¼ ã€‚ é€‰æ‹©æ€§ç¡®è®¤ï¼ˆSelective Acknowledgment, SACKï¼‰ï¼š KCP æ”¯æŒ SACKï¼Œè¿™å…è®¸æ¥æ”¶ç«¯å‘ŠçŸ¥å‘é€ç«¯å“ªäº›åŒ…å·²ç»æ”¶åˆ°ï¼Œä»è€Œä»…é‡ä¼ æœªè¢«ç¡®è®¤æ¥æ”¶çš„æ•°æ®åŒ…ï¼Œå‡å°‘ä¸å¿…è¦çš„é‡ä¼ ã€‚ æ— è¿æ¥æ“ä½œï¼š åŸºäº UDP çš„å®ç°ä½¿å¾— KCP åœ¨ä¼ è¾“æ•°æ®å‰ä¸éœ€è¦åƒ TCP é‚£æ ·è¿›è¡Œä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥ï¼Œè¿™å‡å°‘äº†åˆå§‹çš„å»¶è¿Ÿï¼Œå¹¶ä½¿å…¶èƒ½åœ¨è¿æ¥æ€§è¾ƒå·®çš„ç½‘ç»œç¯å¢ƒä¸‹æ›´åŠ çµæ´»å’Œå¿«é€Ÿã€‚ æ‹¥å¡æ§åˆ¶ï¼š KCP å®ç°äº†ç±»ä¼¼ TCP çš„æ‹¥å¡æ§åˆ¶ç®—æ³•ï¼Œä½†æ›´ä¸ºç®€åŒ–ï¼Œèƒ½å¤Ÿå¿«é€Ÿé€‚åº”ç½‘ç»œæ¡ä»¶çš„å˜åŒ–ï¼Œå¦‚å¸¦å®½æ³¢åŠ¨å’Œä¸¢åŒ…ã€‚ æµé‡æ§åˆ¶ï¼š KCP å…è®¸è°ƒæ•´å‘é€å’Œæ¥æ”¶çš„çª—å£å¤§å°ï¼Œä½¿å¾—å‘é€æ–¹å¯ä»¥æ ¹æ®æ¥æ”¶æ–¹çš„å¤„ç†èƒ½åŠ›å’Œç½‘ç»œæ¡ä»¶è°ƒæ•´æ•°æ®å‘é€é€Ÿç‡ï¼Œä¼˜åŒ–ç½‘ç»œåˆ©ç”¨ç‡å’Œå‡å°‘æ‹¥å¡ã€‚ å¯é…ç½®çš„ä¼ è¾“ç­–ç•¥ï¼š KCP å…è®¸ç”¨æˆ·æ ¹æ®åº”ç”¨éœ€æ±‚è°ƒæ•´å†…éƒ¨å‚æ•°ï¼Œå¦‚ä¼ è¾“é—´éš”ã€çª—å£å¤§å°ç­‰ï¼Œä»¥è¾¾åˆ°æœ€ä¼˜çš„ä¼ è¾“æ•ˆç‡å’Œå»¶è¿Ÿã€‚ å‰å‘é”™è¯¯æ ¡æ­£ï¼ˆForward Error Correction, FECï¼‰ï¼š KCP è¿˜å¯ä»¥ç»“åˆä½¿ç”¨ FEC æŠ€æœ¯ï¼Œé€šè¿‡å‘é€é¢å¤–çš„å†—ä½™æ•°æ®æ¥æ¢å¤ä¸¢å¤±çš„åŒ…ï¼Œè¿›ä¸€æ­¥æé«˜åœ¨é«˜ä¸¢åŒ…ç¯å¢ƒä¸‹çš„æ•°æ®ä¼ è¾“å¯é æ€§ã€‚ ä¸ºä»€ä¹ˆ TCP åšä¸åˆ° KCP è¿™æ ·ï¼Ÿ TCP ä½œä¸ºä¸€ç§æˆç†Ÿä¸”å¹¿æ³›ä½¿ç”¨çš„ä¼ è¾“åè®®ï¼Œåœ¨è®¾è®¡ä¸Šæ³¨é‡å¯é æ€§å’Œé€šç”¨æ€§ï¼Œå› æ­¤åœ¨æ‹¥å¡æ§åˆ¶å’Œæµé‡æ§åˆ¶æ–¹é¢ç›¸å¯¹ä¿å®ˆï¼Œä»¥ç¡®ä¿åœ¨å„ç§ç½‘ç»œæ¡ä»¶ä¸‹éƒ½èƒ½ç¨³å®šè¿è¡Œã€‚ç„¶è€Œï¼Œè¿™äº›è®¾è®¡ä¸Šçš„ä¿å®ˆæ€§ä¹Ÿå¯¼è‡´äº† TCP åœ¨æŸäº›æƒ…å†µä¸‹çš„çµæ´»æ€§å’Œè‡ªé€‚åº”æ€§ä¸å¦‚ KCPã€‚ ç‰¹æ€§ç±»åˆ« åè®® æè¿° æ‹¥å¡æ§åˆ¶æœºåˆ¶ TCP å›ºå®šç®—æ³•ï¼ˆæ…¢å¯åŠ¨ã€æ‹¥å¡é¿å…ç­‰ï¼‰ï¼Œä¿å®ˆçš„è°ƒæ•´ç­–ç•¥ï¼ˆæŒ‡æ•°å’Œçº¿æ€§å¢é•¿ï¼‰ KCP çµæ´»ç®—æ³•ï¼ŒåŠ¨æ€è°ƒæ•´ç­–ç•¥ï¼Œå¿«é€Ÿè°ƒæ•´çª—å£å¤§å° é‡ä¼ æœºåˆ¶çš„å»¶è¿Ÿ TCP å›ºå®šé‡ä¼ é—´éš”ï¼ˆRTOï¼‰ï¼Œå¤šæ¬¡ç¡®è®¤è§¦å‘é‡ä¼ ï¼Œéœ€è¦ä¸»åŠ¨å¼€å¯é€‰æ‹©æ€§é‡ä¼ ï¼ˆSACKï¼‰ KCP å¿«é€Ÿé‡ä¼ ï¼Œé€‰æ‹©æ€§é‡ä¼ ï¼Œå‡å°‘é‡ä¼ å»¶è¿Ÿ æµé‡æ§åˆ¶ TCP å›ºå®šæµé‡æ§åˆ¶ï¼ˆä¾èµ–æ¥æ”¶çª—å£å’Œå‘é€çª—å£ï¼‰ï¼Œé€šç”¨æ€§è®¾è®¡ KCP è‡ªé€‚åº”æµé‡æ§åˆ¶ï¼Œåº”ç”¨å±‚åé¦ˆè°ƒæ•´å‘é€çª—å£å’Œé‡ä¼ ç­–ç•¥ åº”ç”¨åœºæ™¯ TCP å¹¿æ³›åº”ç”¨äºå„ç§ç½‘ç»œç¯å¢ƒï¼Œæ ‡å‡†åŒ–è¦æ±‚é«˜ KCP ä¼˜åŒ–ç‰¹å®šåœºæ™¯ï¼ˆå¦‚é«˜ä¸¢åŒ…ç‡å’Œé«˜å»¶è¿Ÿç½‘ç»œï¼‰ï¼Œçµæ´»å®ç° 1. æ‹¥å¡æ§åˆ¶æœºåˆ¶çš„å›ºå®šæ€§ TCPï¼š å›ºå®šç®—æ³•ï¼šTCP çš„æ‹¥å¡æ§åˆ¶ç®—æ³•ï¼Œå¦‚æ…¢å¯åŠ¨ï¼ˆSlow Startï¼‰ã€æ‹¥å¡é¿å…ï¼ˆCongestion Avoidanceï¼‰ã€å¿«é€Ÿé‡ä¼ ï¼ˆFast Retransmitï¼‰å’Œå¿«é€Ÿæ¢å¤ï¼ˆFast Recoveryï¼‰ï¼Œåœ¨è®¾è®¡æ—¶è€ƒè™‘äº†å¹¿æ³›çš„å…¼å®¹æ€§å’Œå¯é æ€§ã€‚è¿™äº›ç®—æ³•è™½ç„¶æœ‰æ•ˆï¼Œä½†å…¶è°ƒæ•´æœºåˆ¶ç›¸å¯¹å›ºå®šï¼Œå“åº”é€Ÿåº¦è¾ƒæ…¢ã€‚ ä¿å®ˆçš„è°ƒæ•´ç­–ç•¥ï¼šTCP çš„æ‹¥å¡æ§åˆ¶ç®—æ³•é‡‡ç”¨äº†ä¿å®ˆçš„è°ƒæ•´ç­–ç•¥ï¼Œä¾‹å¦‚æŒ‡æ•°å¢é•¿å’Œçº¿æ€§å¢é•¿ï¼Œè¿™åœ¨é«˜ä¸¢åŒ…ç‡æˆ–é«˜å»¶è¿Ÿç½‘ç»œä¸­ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ‹¥å¡çª—å£ï¼ˆcwndï¼‰å¢é•¿é€Ÿåº¦è¾ƒæ…¢ï¼Œå½±å“ä¼ è¾“æ•ˆç‡ã€‚ KCPï¼š çµæ´»ç®—æ³•ï¼šKCP çš„æ‹¥å¡æ§åˆ¶æœºåˆ¶æ›´ä¸ºçµæ´»ï¼Œå¯ä»¥æ ¹æ®å®æ—¶ç½‘ç»œçŠ¶å†µè¿›è¡Œå¿«é€Ÿè°ƒæ•´ã€‚ä¾‹å¦‚ï¼ŒKCP çš„å¿«é€Ÿé‡ä¼ å’Œé€‰æ‹©æ€§é‡ä¼ æœºåˆ¶ï¼Œä½¿å…¶èƒ½æ›´å¿«é€Ÿåœ°å“åº”ç½‘ç»œä¸¢åŒ…æƒ…å†µã€‚ åŠ¨æ€è°ƒæ•´ç­–ç•¥ï¼šKCP çš„æ‹¥å¡çª—å£è°ƒæ•´æ›´ä¸ºçµæ´»ï¼Œå¯ä»¥æ ¹æ®ç½‘ç»œçŠ¶å†µå¿«é€Ÿå¢åŠ æˆ–å‡å°‘çª—å£å¤§å°ï¼Œæé«˜ä¼ è¾“æ•ˆç‡ã€‚ 2. é‡ä¼ æœºåˆ¶çš„å»¶è¿Ÿ TCPï¼š å›ºå®šé‡ä¼ é—´éš”ï¼šTCP ä½¿ç”¨å›ºå®šçš„é‡ä¼ è¶…æ—¶ï¼ˆRTOï¼‰ï¼Œå¹¶éšç€æ¯æ¬¡é‡ä¼ é€æ¸å¢åŠ ï¼ˆæŒ‡æ•°å›é€€ï¼‰ï¼Œè¿™ç§ä¿å®ˆçš„é‡ä¼ æœºåˆ¶åœ¨é«˜å»¶è¿Ÿå’Œé«˜ä¸¢åŒ…ç‡ç½‘ç»œä¸­å¯èƒ½å¯¼è‡´é‡ä¼ å»¶è¿Ÿè¾ƒé•¿ã€‚ å¤šæ¬¡ç¡®è®¤è§¦å‘é‡ä¼ ï¼šTCP çš„å¿«é€Ÿé‡ä¼ éœ€è¦ç­‰å¾…ä¸‰ä¸ªé‡å¤çš„ ACK æ‰èƒ½è§¦å‘ï¼Œè¿™åœ¨ä¸¢åŒ…ç‡è¾ƒé«˜çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šå¯¼è‡´è¾ƒé•¿çš„å»¶è¿Ÿã€‚ KCPï¼š å¿«é€Ÿé‡ä¼ ï¼šKCP åœ¨æ£€æµ‹åˆ°ä¸¢åŒ…åç«‹å³è¿›è¡Œé‡ä¼ ï¼Œè€Œä¸éœ€è¦ç­‰å¾…å¤šä¸ªé‡å¤çš„ ACKï¼Œè¿™æ˜¾è‘—å‡å°‘äº†é‡ä¼ å»¶è¿Ÿã€‚ é€‰æ‹©æ€§é‡ä¼ ï¼šKCP åªé‡ä¼ ä¸¢å¤±çš„æ•°æ®åŒ…ï¼Œè€Œä¸æ˜¯æ‰€æœ‰æœªç¡®è®¤çš„æ•°æ®åŒ…ï¼Œå‡å°‘äº†ä¸å¿…è¦çš„é‡ä¼ å¼€é”€ã€‚ï¼ˆTCP å…¶å®ä¹Ÿæ”¯æŒé€‰æ‹©æ€§é‡ä¼  SACKï¼‰ 3. æµé‡æ§åˆ¶çš„çµæ´»æ€§ TCPï¼š å›ºå®šæµé‡æ§åˆ¶ï¼šTCP çš„æµé‡æ§åˆ¶ä¸»è¦ä¾èµ–äºæ¥æ”¶çª—å£ï¼ˆrwndï¼‰å’Œå‘é€çª—å£ï¼ˆswndï¼‰ï¼Œåœ¨å¤„ç†çªå‘æµé‡æˆ–å˜åŒ–è¾ƒå¤§çš„ç½‘ç»œæ¡ä»¶æ—¶ï¼Œè°ƒæ•´é€Ÿåº¦è¾ƒæ…¢ã€‚ é€šç”¨æ€§è®¾è®¡ï¼šTCP ä½œä¸ºä¸€ç§é€šç”¨åè®®ï¼Œå…¶è®¾è®¡å¿…é¡»å…¼é¡¾å„ç§ç½‘ç»œç¯å¢ƒï¼Œå› æ­¤åœ¨æµé‡æ§åˆ¶ä¸Šç›¸å¯¹ä¿å®ˆï¼Œä»¥ç¡®ä¿åœ¨ä»»ä½•ç¯å¢ƒä¸‹éƒ½èƒ½ç¨³å®šè¿è¡Œã€‚ KCPï¼š è‡ªé€‚åº”æµé‡æ§åˆ¶ï¼šKCP çš„æµé‡æ§åˆ¶æœºåˆ¶å¯ä»¥æ ¹æ®å®é™…åº”ç”¨éœ€æ±‚è¿›è¡Œæ›´ç»†ç²’åº¦çš„è°ƒæ•´ã€‚ä¾‹å¦‚ï¼ŒKCP å¯ä»¥æ ¹æ®å»¶è¿ŸæŠ–åŠ¨ã€ä¸¢åŒ…ç‡ç­‰åŠ¨æ€å‚æ•°è°ƒæ•´å‘é€é€Ÿç‡ï¼Œç¡®ä¿åœ¨ä¸åŒç½‘ç»œæ¡ä»¶ä¸‹éƒ½èƒ½ä¿æŒé«˜æ•ˆä¼ è¾“ã€‚ åº”ç”¨å±‚åé¦ˆï¼šKCP å¯ä»¥æ ¹æ®åº”ç”¨å±‚çš„å®æ—¶åé¦ˆï¼ŒåŠ¨æ€è°ƒæ•´å‘é€çª—å£å’Œé‡ä¼ ç­–ç•¥ï¼Œè¿›ä¸€æ­¥ä¼˜åŒ–ä¼ è¾“æ•ˆç‡ã€‚ 4. åº”ç”¨åœºæ™¯çš„å·®å¼‚ TCPï¼š å¹¿æ³›åº”ç”¨ï¼šTCP è®¾è®¡ç”¨äºå¹¿æ³›çš„ç½‘ç»œç¯å¢ƒï¼ŒåŒ…æ‹¬ç¨³å®šçš„æœ‰çº¿ç½‘ç»œå’Œä¸ç¨³å®šçš„æ— çº¿ç½‘ç»œï¼Œå› æ­¤å…¶æœºåˆ¶å¿…é¡»è¶³å¤Ÿé€šç”¨å’Œä¿å®ˆï¼Œä¿è¯åœ¨å„ç§æƒ…å†µä¸‹çš„å¯é æ€§ã€‚ æ ‡å‡†åŒ–è¦æ±‚ï¼šä½œä¸ºäº’è”ç½‘çš„åŸºç¡€åè®®ï¼ŒTCP çš„å„é¡¹æœºåˆ¶ç»è¿‡ä¸¥æ ¼æ ‡å‡†åŒ–ï¼Œä»»ä½•ä¿®æ”¹éƒ½éœ€è¦å¹¿æ³›æµ‹è¯•å’ŒéªŒè¯ï¼Œä»¥ç¡®ä¿ä¸ä¼šå½±å“ç°æœ‰ç½‘ç»œçš„ç¨³å®šæ€§ã€‚ KCPï¼š ç‰¹å®šä¼˜åŒ–ï¼šKCP è®¾è®¡åˆè¡·æ˜¯ä¼˜åŒ–ç‰¹å®šåœºæ™¯ä¸‹çš„ä¼ è¾“æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯é«˜ä¸¢åŒ…ç‡å’Œé«˜å»¶è¿Ÿç½‘ç»œï¼Œå› æ­¤åœ¨è®¾è®¡ä¸Šæ›´åŠ çµæ´»ï¼Œèƒ½å¤Ÿæ ¹æ®å®æ—¶ç½‘ç»œçŠ¶å†µè¿›è¡Œè°ƒæ•´ã€‚ çµæ´»å®ç°ï¼šKCP å¯ä»¥æ ¹æ®å…·ä½“åº”ç”¨éœ€æ±‚è¿›è¡Œä¼˜åŒ–ï¼Œä¾‹å¦‚åœ¨å®æ—¶é€šä¿¡å’Œåœ¨çº¿æ¸¸æˆç­‰åœºæ™¯ä¸­ï¼Œçµæ´»çš„æµé‡æ§åˆ¶å’Œå¿«é€Ÿé‡ä¼ æœºåˆ¶æ˜¾è‘—æå‡äº†ä¼ è¾“æ•ˆç‡ã€‚ ç»“è®º è™½ç„¶ TCP åœ¨æ‹¥å¡æ§åˆ¶å’Œæµé‡æ§åˆ¶æ–¹é¢å…·å¤‡åŸºæœ¬çš„åŠ¨æ€è°ƒæ•´èƒ½åŠ›ï¼Œä½†å…¶ä¿å®ˆçš„è®¾è®¡å’Œæ ‡å‡†åŒ–è¦æ±‚ä½¿å¾—å…¶åœ¨é«˜ä¸¢åŒ…ç‡å’Œé«˜å»¶è¿Ÿç½‘ç»œä¸­çš„é€‚åº”æ€§å’Œçµæ´»æ€§ä¸å¦‚ KCPã€‚KCP é€šè¿‡çµæ´»çš„æ‹¥å¡æ§åˆ¶ã€å¿«é€Ÿé‡ä¼ å’Œè‡ªé€‚åº”æµé‡æ§åˆ¶æœºåˆ¶ï¼Œèƒ½å¤Ÿæ›´æœ‰æ•ˆåœ°åº”å¯¹ä¸åŒç½‘ç»œæ¡ä»¶ä¸‹çš„ä¼ è¾“éœ€æ±‚ï¼Œæä¾›æ›´é«˜æ•ˆçš„ä¼ è¾“æ€§èƒ½ã€‚ KCP ä¸€å®šæ¯” TCP å¿«å—ï¼Ÿ ä¸ä¸€å®šã€‚KCP å¹¶ä¸ä¸€å®šåœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½æ¯” TCP å¿«ã€‚è™½ç„¶ KCP åœ¨æŸäº›ç‰¹å®šç½‘ç»œç¯å¢ƒï¼ˆå¦‚é«˜ä¸¢åŒ…ç‡å’Œé«˜å»¶è¿Ÿçš„ç½‘ç»œï¼‰ä¸­è¡¨ç°æ›´ä¼˜å¼‚ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒTCP å¯èƒ½æ›´åˆé€‚ã€‚ 1. ç½‘ç»œç¯å¢ƒ é«˜ä¸¢åŒ…ç‡å’Œé«˜å»¶è¿Ÿç½‘ç»œï¼š KCPï¼šKCP é€šè¿‡å¿«é€Ÿé‡ä¼ å’Œé€‰æ‹©æ€§é‡ä¼ æœºåˆ¶ï¼Œä»¥åŠåŠ¨æ€è°ƒæ•´çš„çª—å£å’Œé‡ä¼ é—´éš”ï¼Œèƒ½å¤Ÿæ›´å¥½åœ°åº”å¯¹é«˜ä¸¢åŒ…ç‡å’Œé«˜å»¶è¿Ÿç½‘ç»œï¼Œå‡å°‘ä¼ è¾“å»¶è¿Ÿï¼Œæé«˜ä¼ è¾“æ•ˆç‡ã€‚ TCPï¼šTCP çš„é‡ä¼ æœºåˆ¶å’Œä¿å®ˆçš„æ‹¥å¡æ§åˆ¶åœ¨è¿™ç§ç¯å¢ƒä¸­å¯èƒ½å¯¼è‡´è¾ƒé«˜çš„å»¶è¿Ÿå’Œè¾ƒä½çš„å¸¦å®½åˆ©ç”¨ç‡ã€‚ ä½ä¸¢åŒ…ç‡å’Œä½å»¶è¿Ÿç½‘ç»œï¼š KCPï¼šåœ¨ç¨³å®šçš„ä½ä¸¢åŒ…ç‡å’Œä½å»¶è¿Ÿç½‘ç»œä¸­ï¼ŒKCP çš„é¢‘ç¹é‡ä¼ å’Œæ§åˆ¶æŠ¥æ–‡å¯èƒ½ä¼šå¯¼è‡´é¢å¤–çš„å¸¦å®½å¼€é”€ï¼Œæœªå¿…æœ‰æ˜æ˜¾çš„æ€§èƒ½ä¼˜åŠ¿ã€‚ TCPï¼šTCP åœ¨è¿™ç§ç¯å¢ƒä¸­è¡¨ç°ç¨³å®šï¼Œä¸”ç”±äºå…¶å¸¦å®½å¼€é”€è¾ƒå°ï¼Œå¯èƒ½æ¯” KCP æ›´é«˜æ•ˆã€‚ 2. å¸¦å®½åˆ©ç”¨ç‡ å¸¦å®½å……è¶³çš„ç½‘ç»œï¼š KCPï¼šKCP ç”±äºå…¶é¢‘ç¹çš„é‡ä¼ å’Œæ§åˆ¶æŠ¥æ–‡ï¼Œå¯èƒ½ä¼šå ç”¨æ›´å¤šçš„å¸¦å®½ï¼Œä½†å¦‚æœå¸¦å®½å……è¶³ï¼Œè¿™ç§å¼€é”€å¯¹æ•´ä½“æ€§èƒ½å½±å“è¾ƒå°ï¼Œä¸”å…¶ä½å»¶è¿Ÿä¼˜åŠ¿å¯èƒ½æ›´æ˜æ˜¾ã€‚ TCPï¼šTCP çš„å¸¦å®½åˆ©ç”¨ç‡è¾ƒé«˜ï¼Œé€‚åˆå¸¦å®½å……è¶³çš„ç¯å¢ƒã€‚ å¸¦å®½å—é™çš„ç½‘ç»œï¼š KCPï¼šKCP çš„é¢å¤–å¸¦å®½å¼€é”€åœ¨å¸¦å®½å—é™çš„ç½‘ç»œä¸­å¯èƒ½ä¼šæ˜¾è‘—å½±å“æ•´ä½“ä¼ è¾“æ•ˆç‡ã€‚ TCPï¼šTCP çš„è¾ƒä½å¸¦å®½å¼€é”€ä½¿å…¶åœ¨å¸¦å®½å—é™çš„ç¯å¢ƒä¸­æ›´æœ‰ä¼˜åŠ¿ã€‚ 3. åº”ç”¨åœºæ™¯ å®æ—¶åº”ç”¨ï¼ˆå¦‚åœ¨çº¿æ¸¸æˆã€è§†é¢‘ä¼šè®®ï¼‰ï¼š KCPï¼šKCP çš„ä½å»¶è¿Ÿå’Œå¿«é€Ÿå“åº”èƒ½åŠ›ä½¿å…¶éå¸¸é€‚åˆå®æ—¶åº”ç”¨ï¼Œåœ¨è¿™äº›åœºæ™¯ä¸­ï¼Œä¼ è¾“çš„åŠæ—¶æ€§æ¯”å¸¦å®½åˆ©ç”¨ç‡æ›´é‡è¦ã€‚ TCPï¼šTCP åœ¨è¿™äº›åœºæ™¯ä¸­çš„è¡¨ç°å¯èƒ½ä¸å¦‚ KCPï¼Œç‰¹åˆ«æ˜¯åœ¨é«˜ä¸¢åŒ…ç‡å’Œé«˜å»¶è¿Ÿçš„ç½‘ç»œä¸­ã€‚ éå®æ—¶åº”ç”¨ï¼ˆå¦‚æ–‡ä»¶ä¼ è¾“ã€ç½‘é¡µæµè§ˆï¼‰ï¼š KCPï¼šKCP åœ¨è¿™äº›åœºæ™¯ä¸­å¯èƒ½ä¸å¦‚ TCP é«˜æ•ˆï¼Œç‰¹åˆ«æ˜¯åœ¨ç½‘ç»œç¨³å®šä¸”å¸¦å®½æœ‰é™çš„æƒ…å†µä¸‹ã€‚ TCPï¼šTCP çš„å¯é æ€§å’Œé«˜å¸¦å®½åˆ©ç”¨ç‡ä½¿å…¶éå¸¸é€‚åˆéå®æ—¶åº”ç”¨ã€‚ 4. å®ç°å’Œé…ç½® å®ç°å¤æ‚æ€§ï¼š KCPï¼šå®ç°å’Œé…ç½® KCP å¯èƒ½æ¯” TCP æ›´å¤æ‚ï¼Œéœ€è¦æ ¹æ®å…·ä½“åº”ç”¨å’Œç½‘ç»œç¯å¢ƒè¿›è¡Œä¼˜åŒ–å’Œè°ƒæ•´ã€‚ TCPï¼šTCP æ˜¯ä¸€ä¸ªæˆç†Ÿçš„åè®®ï¼Œç³»ç»Ÿå’Œåº“çš„æ”¯æŒè¾ƒå¥½ï¼Œé…ç½®å’Œä½¿ç”¨ç›¸å¯¹ç®€å•ã€‚ æ€»ç»“ KCP åœ¨æŸäº›ç‰¹å®šç¯å¢ƒå’Œåº”ç”¨åœºæ™¯ä¸­ç¡®å®æ¯” TCP æ›´å¿«ï¼Œå°¤å…¶æ˜¯é«˜ä¸¢åŒ…ç‡å’Œé«˜å»¶è¿Ÿçš„ç½‘ç»œç¯å¢ƒï¼Œä»¥åŠå¯¹ä½å»¶è¿Ÿè¦æ±‚è¾ƒé«˜çš„å®æ—¶åº”ç”¨ã€‚ä½†åœ¨ç½‘ç»œç¨³å®šã€å¸¦å®½æœ‰é™æˆ–éå®æ—¶åº”ç”¨åœºæ™¯ä¸­ï¼ŒTCP å¯èƒ½è¡¨ç°æ›´å¥½ã€‚å› æ­¤ï¼Œé€‰æ‹©ä½¿ç”¨ KCP è¿˜æ˜¯ TCP åº”æ ¹æ®å…·ä½“çš„ç½‘ç»œæ¡ä»¶å’Œåº”ç”¨éœ€æ±‚è¿›è¡Œæƒè¡¡ã€‚ å‰ç½®å‡†å¤‡ ç¬”è€…ä¸æƒ³é‚£ä¹ˆå¿«å°±è´´å‡ºå¤§æ®µå¤§æ®µçš„ä»£ç è¿›è¡Œåˆ†æï¼Œè¿™å¯èƒ½ä¼šä½¿è¯»è€…ä¸çŸ¥æ‰€äº‘ã€‚ä¸ºäº†æ›´å¥½åœ°é˜è¿° KCP çš„åº•å±‚åŸç†ï¼Œç¬”è€…çš„è®¾æƒ³æ˜¯å…ˆå¯¹åŸç†éƒ¨åˆ†è¿›è¡Œæ¦‚è¦æ€»ç»“ï¼Œç„¶åå†å¸¦ç€è¿™äº›ç»“è®ºå»åˆ†ææºç ï¼Œè¿›ä¸€æ­¥å¡«å……é‡Œé¢çš„è¾¹è§’ç»†èŠ‚ã€‚ ä½†æ˜¯å‘¢ï¼Œä¸ºäº†æ›´å¥½åœ°ç†è§£ KCP çš„åŸç†ï¼Œåˆä¸å¾—ä¸å¯¹æ¶‰åŠæºç çš„ä¸€äº›é‡è¦è®¾è®¡ï¼Œä¸ºäº†é¿å…åœ¨åŸç†åˆ†æé˜¶æ®µï¼Œå¯¹æºç è¿›è¡Œè¿‡å¤šçš„æ¶‰åŠï¼Œç¬”è€…å†³å®šæ·»åŠ è¿™å•ç‹¬çš„ä¸€ç« å†…å®¹ï¼Œå¯¹ KCP çš„â€œæ¥å£è®¾è®¡â€ã€â€œæŠ¥æ–‡æ®µâ€ã€â€œKCP æ§åˆ¶å—â€ä»¥åŠâ€œé˜Ÿåˆ—å’Œç¼“å†²åŒºâ€å…ˆè¿›è¡Œç®€è¦æ¦‚è¿°ï¼Œä»¥è¾…åŠ©è¯»è€…æ›´å¥½åœ°ç†è§£åç»­çš„å†…å®¹ã€‚ æ¥å£è®¾è®¡ KCP å·¥ä½œç®€çº¦å›¾ åœ¨ kcp.h æ–‡ä»¶ä¸­ï¼Œå®šä¹‰äº† KCP æœ€æ ¸å¿ƒçš„å‡ ä¸ªæ¥å£ï¼š // åˆ›å»ºä¸€ä¸ªæ–°çš„ KCP æ§åˆ¶å¯¹è±¡ikcpcb* ikcp_create(IUINT32 conv, void *user);// é‡Šæ”¾ä¸€ä¸ª KCP æ§åˆ¶å¯¹è±¡ã€‚void ikcp_release(ikcpcb *kcp);// è®¾ç½® KCP çš„è¾“å‡ºå›è°ƒå‡½æ•°ï¼Œè¿™ä¸ªå›è°ƒå‡½æ•°åœ¨ KCP éœ€è¦å‘é€æ•°æ®æ—¶è¢«è°ƒç”¨ã€‚void ikcp_setoutput(ikcpcb *kcp, int (*output)(const char *buf, int len,\tikcpcb *kcp, void *user));// ä» KCP çš„æ¥æ”¶é˜Ÿåˆ—ä¸­æ¥æ”¶æ•°æ®ï¼Œç”¨äºä¸Šå±‚ä» KCP ä¸­è¯»å–æ•°æ®ã€‚int ikcp_recv(ikcpcb *kcp, char *buffer, int len);// å‘ KCP çš„å‘é€é˜Ÿåˆ—ä¸­æ·»åŠ æ•°æ®ï¼Œç”¨äºä¸Šå±‚å‘ KCP å‘é€æ•°æ®ï¼ŒKCP ä¼šç®¡ç†è¿™äº›æ•°æ®å¹¶è´Ÿè´£å…¶å¯é ä¼ è¾“ã€‚int ikcp_send(ikcpcb *kcp, const char *buffer, int len);// æ›´æ–° KCP çš„å†…éƒ¨çŠ¶æ€ï¼Œé€šå¸¸éœ€è¦å®šæœŸè°ƒç”¨ã€‚// è¿™ä¸ªå‡½æ•°è´Ÿè´£å¤„ç† KCP çš„è¶…æ—¶ã€é‡ä¼ ç­‰æ“ä½œï¼Œéœ€è¦åœ¨ä¸€å®šçš„æ—¶é—´é—´éš”å†…åå¤è°ƒç”¨ï¼ˆé€šå¸¸æ¯ 10-100 æ¯«ç§’ï¼‰ã€‚void ikcp_update(ikcpcb *kcp, IUINT32 current);// åˆ¤æ–­æ˜¯å¦è¦è°ƒç”¨ ikcp_updateIUINT32 ikcp_check(const ikcpcb *kcp, IUINT32 current);// å¤„ç†æ¥æ”¶åˆ°çš„ä½å±‚æ•°æ®åŒ…ï¼ˆä¾‹å¦‚ UDP åŒ…ï¼‰ã€‚int ikcp_input(ikcpcb *kcp, const char *data, long size);// å°†ç¼“å†²åŒºå¯ä»¥å‘é€çš„åŒ…å‘é€å‡ºå»ï¼Œä¼šåœ¨ ikcp_update ä¸­è¢«è°ƒç”¨ã€‚void ikcp_flush(ikcpcb *kcp); ikcp_create: conv: ä¼šè¯æ ‡è¯†ç¬¦ï¼Œç”¨äºæ ‡è¯†ä¸¤ä¸ªç«¯ç‚¹ä¹‹é—´çš„è¿æ¥ã€‚è¿™ä¸ªæ ‡è¯†ç¬¦åœ¨ä¸¤ä¸ªé€šä¿¡ç«¯ç‚¹ä¹‹é—´å¿…é¡»ä¸€è‡´ã€‚ user: ç”¨æˆ·æ•°æ®æŒ‡é’ˆï¼Œå¯ä»¥ä¼ é€’ä»»æ„ç”¨æˆ·æ•°æ®ï¼Œè¿™ä¸ªæ•°æ®åœ¨ KCP çš„ output å›è°ƒä¸­ä¼šè¢«ä¼ é€’å›å»ã€‚ è¿”å›å€¼: ä¸€ä¸ªæŒ‡å‘æ–°åˆ›å»ºçš„ KCP æ§åˆ¶å—ï¼ˆikcpcbï¼‰çš„æŒ‡é’ˆã€‚ ikcp_release: é‡Šæ”¾ä¸€ä¸ª KCP æ§åˆ¶å¯¹è±¡ã€‚ ikcp_setoutput: è®¾ç½® KCP çš„è¾“å‡ºå›è°ƒå‡½æ•°ã€‚ output: è¾“å‡ºå›è°ƒå‡½æ•°æŒ‡é’ˆã€‚è¿™ä¸ªå›è°ƒå‡½æ•°åœ¨ KCP éœ€è¦å‘é€æ•°æ®æ—¶è¢«è°ƒç”¨ã€‚ buf: è¦å‘é€çš„æ•°æ®ç¼“å†²åŒºã€‚ len: æ•°æ®é•¿åº¦ã€‚ kcp: å½“å‰çš„ KCP å¯¹è±¡ã€‚ user: ç”¨æˆ·æ•°æ®ã€‚ é€šè¿‡è¿™ä¸ªå›è°ƒï¼ŒKCP å¯ä»¥å°†è¦å‘é€çš„æ•°æ®ä¼ é€’ç»™ä¸‹å±‚çš„ç½‘ç»œå±‚ï¼Œæ¯”å¦‚ UDP å¥—æ¥å­—ã€‚ ikcp_recv: ä» KCP çš„æ¥æ”¶é˜Ÿåˆ—ä¸­æ¥æ”¶æ•°æ®ã€‚ kcp: KCP æ§åˆ¶å¯¹è±¡çš„æŒ‡é’ˆã€‚ buffer: ç”¨æˆ·æä¾›çš„ç¼“å†²åŒºï¼Œç”¨äºå­˜å‚¨æ¥æ”¶åˆ°çš„æ•°æ®ã€‚ len: ç¼“å†²åŒºçš„é•¿åº¦ã€‚ è¿”å›å€¼: æˆåŠŸæ¥æ”¶çš„æ•°æ®å¤§å°ï¼›å¦‚æœæ²¡æœ‰æ•°æ®å¯æ¥æ”¶ï¼Œè¿”å›è´Ÿå€¼ï¼ˆä¾‹å¦‚ï¼ŒEAGAINï¼‰ã€‚ è¿™ä¸ªå‡½æ•°ç”¨äºä¸Šå±‚ä» KCP ä¸­è¯»å–æ•°æ®ã€‚ ikcp_send: å‘ KCP çš„å‘é€é˜Ÿåˆ—ä¸­æ·»åŠ æ•°æ®ã€‚ kcp: KCP æ§åˆ¶å¯¹è±¡çš„æŒ‡é’ˆã€‚ buffer: è¦å‘é€çš„æ•°æ®ç¼“å†²åŒºã€‚ len: æ•°æ®çš„é•¿åº¦ã€‚ è¿”å›å€¼: æˆåŠŸå‘é€çš„æ•°æ®å¤§å°ï¼›å¦‚æœå‘é€å¤±è´¥ï¼Œè¿”å›è´Ÿå€¼ã€‚ è¿™ä¸ªå‡½æ•°ç”¨äºä¸Šå±‚å‘ KCP å‘é€æ•°æ®ï¼ŒKCP ä¼šç®¡ç†è¿™äº›æ•°æ®å¹¶è´Ÿè´£å…¶å¯é ä¼ è¾“ã€‚ ikcp_update: æ›´æ–° KCP çš„å†…éƒ¨çŠ¶æ€ï¼Œé€šå¸¸éœ€è¦å®šæœŸè°ƒç”¨ã€‚ kcp: KCP æ§åˆ¶å¯¹è±¡çš„æŒ‡é’ˆã€‚ current: å½“å‰çš„æ—¶é—´æˆ³ï¼ˆä»¥æ¯«ç§’ä¸ºå•ä½ï¼‰ã€‚ è¿™ä¸ªå‡½æ•°è´Ÿè´£å¤„ç† KCP çš„è¶…æ—¶ã€é‡ä¼ ç­‰æ“ä½œï¼Œéœ€è¦åœ¨ä¸€å®šçš„æ—¶é—´é—´éš”å†…åå¤è°ƒç”¨ï¼ˆé€šå¸¸æ¯ 10-100 æ¯«ç§’ï¼‰ã€‚ ikcp_input: å¤„ç†æ¥æ”¶åˆ°çš„ä½å±‚æ•°æ®åŒ…ï¼ˆä¾‹å¦‚ UDP åŒ…ï¼‰ã€‚ kcp: KCP æ§åˆ¶å¯¹è±¡çš„æŒ‡é’ˆã€‚ data: æ”¶åˆ°çš„æ•°æ®ç¼“å†²åŒºã€‚ size: æ•°æ®çš„é•¿åº¦ã€‚ è¿”å›å€¼: æˆåŠŸå¤„ç†çš„æ•°æ®å¤§å°ï¼›å¦‚æœå¤„ç†å¤±è´¥ï¼Œè¿”å›è´Ÿå€¼ã€‚ ikcp_flush: åˆ·æ–°å¾…å‘é€çš„æ•°æ®ã€‚ å…¶ä¸­æœ€é‡è¦çš„æ˜¯è¿™ 4 ä¸ªï¼š ikcp_send: å°†æ•°æ®æ”¾åœ¨å‘é€é˜Ÿåˆ—ä¸­ç­‰å¾…å‘é€ã€‚ ikcp_recv: ä»æ¥æ”¶é˜Ÿåˆ—ä¸­è¯»å–æ•°æ®ã€‚ ikcp_input: è¯»å–ä¸‹å±‚åè®®è¾“å…¥æ•°æ®ï¼Œè§£ææŠ¥æ–‡æ®µï¼Œå¦‚æœæ˜¯æ•°æ®ï¼Œå°±å°†æ•°æ®æ”¾å…¥æ¥æ”¶ç¼“å†²åŒºï¼Œå¦‚æœæ˜¯ ACKï¼Œå°±åœ¨å‘é€ç¼“å†²åŒºä¸­æ ‡è®°å¯¹åº”çš„æŠ¥æ–‡æ®µå·²é€è¾¾ã€‚ ikcp_flush: è°ƒç”¨è¾“å‡ºå›è°ƒå°†å‘é€ç¼“å†²åŒºçš„æ•°æ®å‘é€å‡ºå»ã€‚ è¿™é‡Œå°±å…ˆç®€è¦ä»‹ç»åˆ°è¿™é‡Œï¼Œåé¢åœ¨æºç åˆ†æç¯‡ç« å†å¯¹è¿™äº›æ¥å£è¿›è¡Œè¯¦ç»†åˆ†æã€‚ æŠ¥æ–‡æ®µ KCP çš„æŠ¥æ–‡æ®µå¤§å°ä¸º 24 å­—èŠ‚ï¼Œç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š æ¯ä¸ªå­—æ®µçš„å«ä¹‰å¦‚ä¸‹ï¼š conv: è¿æ¥æ ‡è¯† cmdï¼šæŠ¥æ–‡ç±»å‹ frgï¼šåˆ†ç‰‡æ•°é‡ï¼Œè¡¨ç¤ºéšåè¿˜æœ‰å¤šå°‘ä¸ªæŠ¥æ–‡å±äºåŒä¸€ä¸ªåŒ… wndï¼šå‘é€æ–¹å‰©ä½™æ¥æ”¶çª—å£çš„å¤§å° tsï¼šæ—¶é—´æˆ³ snï¼šæŠ¥æ–‡ç¼–å· unaï¼šå‘é€æ–¹çš„æ¥æ”¶ç¼“å†²åŒºä¸­æœ€å°è¿˜æœªæ”¶åˆ°çš„æŠ¥æ–‡æ®µçš„ç¼–å·ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯”å®ƒå°çš„æŠ¥æ–‡æ®µéƒ½å·²å…¨éƒ¨æ¥æ”¶ lenï¼šæ•°æ®æ®µé•¿åº¦ dataï¼šæ•°æ®æ®µï¼Œåªæœ‰æ•°æ®æŠ¥æ–‡ä¼šæœ‰è¿™ä¸ªå­—æ®µ å…¶ä¸­ cmd å…±æœ‰ 4 ç§æŠ¥æ–‡ç±»å‹ï¼š æ•°æ®æŠ¥æ–‡ï¼šIKCP_CMD_PUSH ç¡®è®¤æŠ¥æ–‡ï¼šIKCP_CMD_ACK çª—å£æ¢æµ‹æŠ¥æ–‡ï¼šIKCP_CMD_WASK è¯¢é—®å¯¹ç«¯å‰©ä½™æ¥æ”¶çª—å£çš„å¤§å° çª—å£é€šçŸ¥æŠ¥æ–‡ï¼šIKCP_CMD_WINS é€šçŸ¥å¯¹ç«¯å‰©ä½™æ¥æ”¶çª—å£çš„å¤§å° åœ¨ KCP ä¸­ï¼ŒæŠ¥æ–‡æ®µç»“æ„å®šä¹‰åœ¨ kcp.h æ–‡ä»¶ä¸­ï¼Œå¦‚ä¸‹ï¼š struct IKCPSEG\tstruct IQUEUEHEAD node;\tIUINT32 conv;\tIUINT32 cmd;\tIUINT32 frg;\tIUINT32 wnd;\tIUINT32 ts;\tIUINT32 sn;\tIUINT32 una;\tIUINT32 len;\tIUINT32 resendts;\tIUINT32 rto;\tIUINT32 fastack;\tIUINT32 xmit;\tchar data[1];; IKCPSEG ç»“æ„è¿˜å¤šå‡ºäº†å‡ ä¸ªå­—æ®µï¼Œè¿™æ˜¯ä¸ºäº†æ”¯æŒ KCP åè®®çš„å¯é æ€§å’Œæ•ˆç‡ï¼š resendts: è®°å½•æŠ¥æ–‡çš„ä¸‹æ¬¡é‡ä¼ æ—¶é—´ï¼Œç”¨äºå®ç°é‡ä¼ æœºåˆ¶ã€‚å¦‚æœæŠ¥æ–‡åœ¨ä¸€å®šæ—¶é—´å†…æ²¡æœ‰è¢«ç¡®è®¤æ”¶åˆ°ï¼Œå°±ä¼šåœ¨è¿™ä¸ªæ—¶é—´æˆ³ä¹‹åè¢«é‡æ–°å‘é€ã€‚ rto: è¡¨ç¤ºå½“å‰æŠ¥æ–‡çš„é‡ä¼ è¶…æ—¶æ—¶é—´ï¼ˆRTT çš„ä¼°è®¡å€¼ï¼‰ã€‚ç”¨äºè®¡ç®—æ¯ä¸ªæŠ¥æ–‡çš„é‡ä¼ æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡ rto æ—¶é—´æ²¡æœ‰æ”¶åˆ° ACKï¼Œä¼šè§¦å‘é‡ä¼ ã€‚ fastack: å¿«é€Ÿé‡ä¼ è®¡æ•°ï¼Œè®°å½•è¯¥æŠ¥æ–‡è¢«è·³è¿‡çš„æ¬¡æ•°ã€‚å¦‚æœä¸€ä¸ªæŠ¥æ–‡çš„ ACK è¿ç»­æ¥æ”¶åˆ°å¤šä¸ªå¯¹åŒä¸€æŠ¥æ–‡çš„ç¡®è®¤ï¼Œè€Œä¸æ˜¯æ–°çš„æŠ¥æ–‡ï¼Œä¼šå¢åŠ è¿™ä¸ªè®¡æ•°ï¼Œç”¨äºå®ç°å¿«é€Ÿé‡ä¼ æœºåˆ¶ã€‚ xmit: è®°å½•æŠ¥æ–‡å·²ç»è¢«å‘é€çš„æ¬¡æ•°ã€‚ç”¨äºç»Ÿè®¡ä¸€ä¸ªæŠ¥æ–‡çš„é‡ä¼ æ¬¡æ•°ï¼Œå¸®åŠ©åˆ¤æ–­ä¼ è¾“çš„å¯é æ€§ã€‚å¦‚æœæ“ä½œ dead_link æ¬¡ï¼Œåˆ™ä¼šåˆ¤æ–­ä¸ºè¿æ¥å¤±æ•ˆï¼ŒKCP ä¼šæ–­å¼€è¿æ¥ã€‚ node: é“¾è¡¨èŠ‚ç‚¹ï¼Œç”¨äºå°†å¤šä¸ª IKCPSEG ç»“æ„ä½“é“¾æ¥åœ¨ä¸€èµ·ã€‚KCP çš„é˜Ÿåˆ—å’Œç¼“å†²åŒºéƒ½æ˜¯å¾ªç¯åŒé“¾è¡¨ç»“æ„ã€‚ è¿™äº›å­—æ®µå…±åŒä½œç”¨ï¼Œå¸®åŠ© KCP å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š å¯é æ€§ï¼šé€šè¿‡ snã€una å’Œ ack ç¡®ä¿æ•°æ®åŒ…æŒ‰é¡ºåºæ¥æ”¶å’Œé‡ä¼ ã€‚ æµé‡æ§åˆ¶ï¼šé€šè¿‡ wnd æ§åˆ¶æ•°æ®æµé‡ï¼Œé¿å…æ¥æ”¶æ–¹è¿‡è½½ã€‚ é«˜æ•ˆä¼ è¾“ï¼šé€šè¿‡ resendts å’Œ rto è¿›è¡Œè¶…æ—¶å’Œé‡ä¼ æ§åˆ¶ï¼Œfastack æä¾›å¿«é€Ÿé‡ä¼ æœºåˆ¶ã€‚ çµæ´»ç®¡ç†ï¼šä½¿ç”¨é“¾è¡¨èŠ‚ç‚¹ node ç»„ç»‡æ•°æ®ï¼Œä¾¿äºå†…éƒ¨ç®¡ç†ã€‚ KCP æ§åˆ¶å— ikcpcb ä¸Šé¢æˆ‘ä»¬æåˆ°çš„ ikcp_create å’Œ ikcp_release å°±æ˜¯å¯¹ KCP æ§åˆ¶å— ikcpcb çš„åˆ›å»ºå’Œé‡Šæ”¾ï¼Œæ¯ä¸ª KCP è¿æ¥éƒ½å¯¹åº”ä¸€ä¸ª KCP æ§åˆ¶å—ã€‚å®ƒå®šä¹‰åœ¨ kcp.h ä¸­ï¼š struct IKCPCB\tIUINT32 conv, mtu, mss, state;\tIUINT32 snd_una, snd_nxt, rcv_nxt;\tIUINT32 ts_recent, ts_lastack, ssthresh;\tIINT32 rx_rttval, rx_srtt, rx_rto, rx_minrto;\tIUINT32 snd_wnd, rcv_wnd, rmt_wnd, cwnd, probe;\tIUINT32 current, interval, ts_flush, xmit;\tIUINT32 nrcv_buf, nsnd_buf;\tIUINT32 nrcv_que, nsnd_que;\tIUINT32 nodelay, updated;\tIUINT32 ts_probe, probe_wait;\tIUINT32 dead_link, incr;\tstruct IQUEUEHEAD snd_queue;\tstruct IQUEUEHEAD rcv_queue;\tstruct IQUEUEHEAD snd_buf;\tstruct IQUEUEHEAD rcv_buf;\tIUINT32 *acklist;\tIUINT32 ackcount;\tIUINT32 ackblock;\tvoid *user;\tchar *buffer;\tint fastresend;\tint fastlimit;\tint nocwnd, stream;\tint logmask;\tint (*output)(const char *buf, int len, struct IKCPCB *kcp, void *user);\tvoid (*writelog)(const char *log, struct IKCPCB *kcp, void *user);; å­—æ®µçš„å«ä¹‰å¦‚ä¸‹ï¼Œè¯»è€…å¯åœ¨åç»­åˆ†æè¿‡ç¨‹å›è¿‡æ¥æŸ¥é˜…ï¼š å­—æ®µå å«ä¹‰ conv è¿æ¥æ ‡è¯†ç¬¦ï¼Œç”¨äºè¯†åˆ«ä¸€ä¸ªç‰¹å®šçš„ä¼šè¯ã€‚ mtu æœ€å¤§ä¼ è¾“å•å…ƒï¼ˆMaximum Transmission Unitï¼‰ï¼Œè¡¨ç¤ºç½‘ç»œå±‚ä¼ è¾“æ•°æ®åŒ…çš„æœ€å¤§å­—èŠ‚æ•°ã€‚ mss æœ€å¤§æŠ¥æ–‡æ®µé•¿åº¦ï¼ˆMaximum Segment Sizeï¼‰ï¼Œè¡¨ç¤ºåº”ç”¨å±‚ä¼ è¾“æ•°æ®çš„æœ€å¤§å­—èŠ‚æ•°ã€‚ state è¿æ¥çŠ¶æ€ï¼Œæ ‡è¯†å½“å‰çš„ä¼ è¾“çŠ¶æ€ã€‚ snd_una æœªç¡®è®¤çš„å‘é€åºå·ï¼Œè¡¨ç¤ºæœ€æ—©æœªç¡®è®¤çš„åŒ…çš„åºå·ã€‚ snd_nxt ä¸‹ä¸€ä¸ªå‘é€åºå·ï¼Œè¡¨ç¤ºå³å°†å‘é€çš„åŒ…çš„åºå·ã€‚ rcv_nxt ä¸‹ä¸€ä¸ªæ¥æ”¶åºå·ï¼Œè¡¨ç¤ºæœŸæœ›æ¥æ”¶çš„ä¸‹ä¸€ä¸ªåŒ…çš„åºå·ã€‚ ts_recent æœ€è¿‘çš„æ—¶é—´æˆ³ï¼Œç”¨äºå»¶è¿Ÿæµ‹é‡ã€‚ ts_lastack æœ€è¿‘çš„ç¡®è®¤æ—¶é—´æˆ³ï¼Œç”¨äº RTT è®¡ç®—ã€‚ ssthresh æ‹¥å¡é¿å…çš„æ…¢å¯åŠ¨é˜ˆå€¼ã€‚ rx_rttval RTT çš„åå·®ï¼Œç”¨äºè®¡ç®— RTT çš„æ³¢åŠ¨ã€‚ rx_srtt å¹³æ»‘çš„ RTT å€¼ï¼Œç”¨äºè®¡ç®—å¹³å‡ RTTã€‚ rx_rto é‡æ–°ä¼ è¾“è¶…æ—¶æ—¶é—´ï¼Œæ ¹æ® RTT åŠ¨æ€è°ƒæ•´ã€‚ rx_minrto æœ€å°çš„é‡æ–°ä¼ è¾“è¶…æ—¶æ—¶é—´ã€‚ snd_wnd å‘é€çª—å£å¤§å°ï¼Œæ§åˆ¶å‘é€æµé‡çš„çª—å£ã€‚ rcv_wnd æ¥æ”¶çª—å£å¤§å°ï¼Œæ§åˆ¶æ¥æ”¶æµé‡çš„çª—å£ã€‚ rmt_wnd è¿œç«¯çª—å£å¤§å°ï¼Œè¡¨ç¤ºå¯¹æ–¹æ¥æ”¶çª—å£çš„å¤§å°ã€‚ cwnd æ‹¥å¡çª—å£å¤§å°ï¼Œæ§åˆ¶å‘é€æµé‡çš„çª—å£ï¼Œç”¨äºæ‹¥å¡æ§åˆ¶ã€‚ probe æ¢æµ‹æ ‡å¿—ï¼Œè¡¨ç¤ºæ˜¯å¦éœ€è¦è¿›è¡Œçª—å£æ¢æµ‹ã€‚ current å½“å‰çš„æ—¶é—´æˆ³ã€‚ interval åˆ·æ–°é—´éš”æ—¶é—´ï¼Œè¡¨ç¤ºå®šæœŸåˆ·æ–° KCP çŠ¶æ€çš„é—´éš”ã€‚ ts_flush ä¸‹æ¬¡åˆ·æ–°æ—¶é—´æˆ³ï¼Œç”¨äºç¡®å®šä½•æ—¶æ‰§è¡Œä¸‹ä¸€æ¬¡çŠ¶æ€åˆ·æ–°ã€‚ xmit å‘é€æ¬¡æ•°ï¼Œè¡¨ç¤ºæ•°æ®åŒ…é‡ä¼ çš„æ¬¡æ•°ã€‚ nrcv_buf æ¥æ”¶ç¼“å†²åŒºçš„æ•°æ®åŒ…æ•°é‡ã€‚ nsnd_buf å‘é€ç¼“å†²åŒºçš„æ•°æ®åŒ…æ•°é‡ã€‚ nrcv_que æ¥æ”¶é˜Ÿåˆ—ä¸­çš„æ•°æ®åŒ…æ•°é‡ã€‚ nsnd_que å‘é€é˜Ÿåˆ—ä¸­çš„æ•°æ®åŒ…æ•°é‡ã€‚ nodelay å»¶è¿Ÿæ¨¡å¼æ ‡å¿—ï¼Œè¡¨ç¤ºæ˜¯å¦å¯ç”¨æ— å»¶è¿Ÿæ¨¡å¼ã€‚ updated æ›´æ–°æ ‡å¿—ï¼Œè¡¨ç¤ºæ˜¯å¦éœ€è¦æ›´æ–° KCP çŠ¶æ€ã€‚ ts_probe ä¸‹æ¬¡æ¢æµ‹æ—¶é—´æˆ³ï¼Œç”¨äºçª—å£æ¢æµ‹ã€‚ probe_wait æ¢æµ‹ç­‰å¾…æ—¶é—´ï¼Œè¡¨ç¤ºç­‰å¾…å¤šé•¿æ—¶é—´åè¿›è¡Œä¸‹ä¸€æ¬¡çª—å£æ¢æµ‹ã€‚ dead_link æ­»é“¾æ ‡å¿—ï¼Œè¡¨ç¤ºè¿æ¥æ˜¯å¦å·²ç»å¤±æ•ˆã€‚ incr å¢é‡ï¼Œç”¨äºæ§åˆ¶æµé‡çš„å¢åŠ é€Ÿç‡ã€‚ snd_queue å‘é€é˜Ÿåˆ—ï¼Œç”¨äºå­˜å‚¨å¾…å‘é€çš„æ•°æ®åŒ…ã€‚ rcv_queue æ¥æ”¶é˜Ÿåˆ—ï¼Œç”¨äºå­˜å‚¨å¾…å¤„ç†çš„æ•°æ®åŒ…ã€‚ snd_buf å‘é€ç¼“å†²åŒºï¼Œç”¨äºå­˜å‚¨å·²ç»å‘é€ä½†æœªç¡®è®¤çš„æ•°æ®åŒ…ã€‚ rcv_buf æ¥æ”¶ç¼“å†²åŒºï¼Œç”¨äºå­˜å‚¨å·²ç»æ¥æ”¶åˆ°ä½†æœªå¤„ç†çš„æ•°æ®åŒ…ã€‚ acklist ç¡®è®¤åˆ—è¡¨ï¼Œç”¨äºå­˜å‚¨å¾…å‘é€çš„ç¡®è®¤åºå·ã€‚ ackcount ç¡®è®¤è®¡æ•°ï¼Œè¡¨ç¤ºç¡®è®¤åˆ—è¡¨ä¸­çš„æ¡ç›®æ•°é‡ã€‚ ackblock ç¡®è®¤å—å¤§å°ï¼Œè¡¨ç¤ºç¡®è®¤åˆ—è¡¨çš„å†…å­˜åˆ†é…å¤§å°ã€‚ user ç”¨æˆ·æ•°æ®æŒ‡é’ˆï¼Œç”¨äºå­˜å‚¨ç”¨æˆ·è‡ªå®šä¹‰çš„æ•°æ®ã€‚ buffer ç¼“å†²åŒºï¼Œç”¨äºä¸´æ—¶å­˜å‚¨å‘é€çš„æ•°æ®ã€‚ fastresend å¿«é€Ÿé‡ä¼ æ ‡å¿—ï¼Œè¡¨ç¤ºå¯ç”¨å¿«é€Ÿé‡ä¼ åŠŸèƒ½ã€‚ fastlimit å¿«é€Ÿé‡ä¼ é™åˆ¶ï¼Œè¡¨ç¤ºåœ¨ä¸€ä¸ª RTT å†…å…è®¸çš„æœ€å¤§é‡ä¼ æ¬¡æ•°ã€‚ nocwnd æ— æ‹¥å¡çª—å£æ§åˆ¶æ ‡å¿—ï¼Œè¡¨ç¤ºæ˜¯å¦ç¦ç”¨æ‹¥å¡çª—å£æ§åˆ¶ã€‚ stream æµæ¨¡å¼æ ‡å¿—ï¼Œè¡¨ç¤ºæ˜¯å¦å¯ç”¨æµæ¨¡å¼ã€‚ logmask æ—¥å¿—æ©ç ï¼Œç”¨äºæ§åˆ¶æ—¥å¿—è¾“å‡ºçš„çº§åˆ«ã€‚ output å‘é€æ•°æ®å›è°ƒå‡½æ•°ï¼Œç”¨äºå‘é€æ•°æ®ã€‚ writelog æ—¥å¿—å›è°ƒå‡½æ•°ï¼Œç”¨äºè¾“å‡ºæ—¥å¿—ã€‚ é˜Ÿåˆ—å’Œç¼“å†²åŒº struct IKCPCB ...\tstruct IQUEUEHEAD snd_queue;\tstruct IQUEUEHEAD rcv_queue;\tstruct IQUEUEHEAD snd_buf;\tstruct IQUEUEHEAD rcv_buf; ...;struct IQUEUEHEAD struct IQUEUEHEAD *next, *prev;; KCP ä¸­é˜Ÿåˆ—å’Œç¼“å†²åŒºéƒ½æ˜¯å¾ªç¯åŒé“¾è¡¨ï¼Œé“¾è¡¨ç”±å®å®ç°ï¼Œç¬”è€…å¹¶ä¸æ“…é•¿ï¼Œæ‰€ä»¥æœ¬æ–‡å°±ä¸æ¢è®¨è¯¥é“¾è¡¨çš„å®ç°äº†ï¼Œæœ‰æ•°æ®ç»“æ„åŸºç¡€çš„ç¬”è€…åº”è¯¥å¾ˆå¥½ç†è§£è¿™ä¸€å—ã€‚ é˜Ÿåˆ—å’Œç¼“å†²åŒºçš„å®ç°ï¼šå¾ªç¯åŒé“¾è¡¨ é˜Ÿåˆ—å’Œç¼“å†²åŒºæ˜¯ KCP æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œå®ƒä»¬çš„ä½œç”¨æµç¨‹å¤§æ¦‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¯»è€…å¯ä»¥è‡ªè¡Œé˜…è¯»å°è¯•ç†è§£ï¼Œåç»­æˆ‘ä»¬ä¼šè¿›è¡Œè¯¦ç»†çš„åˆ†æã€‚ KCP é˜Ÿåˆ—å’Œç¼“å†²åŒºä½œç”¨æµç¨‹ åŸç†åˆ†æ è¿™ä¸€èŠ‚æˆ‘ä»¬è¯¦ç»†è®¨è®º KCP çš„æ•´ä¸ª ARQ æµç¨‹ã€‚é¦–å…ˆæˆ‘ä»¬ä¼šå¯¹æ•´ä½“æµç¨‹è¿›è¡Œç®€è¦æ¦‚è¿°ï¼Œç„¶åè¯¦ç»†è®¨è®ºæ»‘åŠ¨çª—å£ä¸­çš„å‘é€å’Œæ¥æ”¶è¿‡ç¨‹ï¼Œæ¥ç€è®¨è®ºè¶…æ—¶é‡ä¼ å’Œå¿«é€Ÿé‡ä¼ ï¼Œåœ¨è¿™ä¹‹åæˆ‘ä»¬ä¼šå°† KCP å’Œ TCP çš„é‡ä¼ ç­–ç•¥è¿›è¡Œç®€å•å¯¹æ¯”ï¼Œæœ€åä»‹ç»ä¸€ä¸‹æ‹¥å¡æ§åˆ¶ç­–ç•¥ã€‚ 1. æ•´ä½“æµç¨‹ KCP å…¨æµç¨‹ KCP çš„å…¨æµç¨‹å¦‚ä¸Šå›¾æ‰€ç¤ºï¼š å‘é€æ–¹è°ƒç”¨ ikcp_send å°†å‘é€æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™ä¼šåˆ›å»ºæŠ¥æ–‡æ®µå®ä¾‹ï¼Œå¹¶æ”¾å…¥ snd_queue å‘é€é˜Ÿåˆ—ä¸­ã€‚ KCP ä¼šå®šæ—¶è°ƒç”¨ ikcp_update åˆ¤æ–­æ˜¯å¦è¦è°ƒç”¨ ikcp_flushã€‚ è°ƒç”¨ ikcp_flush æ—¶ä¼šå°†åˆé€‚çš„æŠ¥æ–‡æ®µæ”¾å…¥ snd_buf ç¼“å†²åŒºä¸­ï¼Œå…·ä½“åŒ…æ‹¬ï¼š å‘é€ ACK åˆ—è¡¨ä¸­æ‰€æœ‰ ACKï¼› æ ¹æ®æ˜¯å¦éœ€è¦å‘é€çª—å£æ¢æµ‹å’Œé€šçŸ¥æŠ¥æ–‡ï¼Œéœ€è¦åˆ™å‘ï¼› æ ¹æ®å‘é€çª—å£å¤§å°ï¼Œå°†é€‚é‡çš„æŠ¥æ–‡æ®µä» snd_queue ç§»å…¥ snd_buf ä¸­ï¼› å‘é€ snd_buf ä¸­çš„æŠ¥æ–‡ï¼ŒåŒ…æ‹¬æ–°åŠ å…¥çš„ã€RTO å†…æœªæ”¶åˆ° ACK çš„å’Œ ACK å¤±åºè‹¥å¹²æ¬¡çš„ï¼› æ ¹æ®ä¸¢åŒ…æƒ…å†µè®¡ç®— ssthresh å’Œ cwndã€‚ å‘é€çš„æ—¶å€™ä¼šè°ƒç”¨ç”± ikcp_setoutput è®¾ç½®çš„å›è°ƒå‡½æ•°ï¼Œå°†æ•°æ®å‘é€åˆ°å¯¹ç«¯ã€‚ æ¥æ”¶æ–¹æ”¶åˆ°æ•°æ®åï¼Œä¼šè°ƒç”¨ ikcp_inputï¼Œå°†æ•°æ®æ”¾å…¥ rcv_buf ç¼“å†²åŒºï¼Œå…·ä½“åŒ…æ‹¬ï¼š æ ¹æ®æ‰€æœ‰æŠ¥æ–‡çš„ una å°†ç›¸åº”çš„æŠ¥æ–‡æ ‡è®°ä¸ºå·²é€è¾¾ï¼› å¦‚æœæ˜¯ ACKï¼Œå°±å°†ç›¸åº”çš„æŠ¥æ–‡æ ‡è®°ä¸ºå·²é€è¾¾ï¼› å¦‚æœæ˜¯æ•°æ®æŠ¥æ–‡ï¼Œå°±å°†å®ƒæ”¾å…¥ rcv_bufï¼Œç„¶åå°† rcv_buf ä¸­é¡ºåºæ­£ç¡®çš„æŠ¥æ–‡ç§»å…¥ rcv_queue æ¥æ”¶é˜Ÿåˆ—ä¸­ï¼Œæ¥ç€å°†ç›¸å…³ä¿¡æ¯æ’å…¥ ACK åˆ—è¡¨ï¼Œåœ¨ç¨åçš„ ikcp_flush ä¸­ä¼šå‘é€ç›¸åº”çš„ ACKï¼› å¦‚æœæ˜¯çª—å£æ¢æµ‹æŠ¥æ–‡ï¼Œå°±æ ‡è®°â€œéœ€è¦å‘é€çª—å£é€šçŸ¥â€ï¼Œåœ¨ç¨åçš„ ikcp_flush ä¸­ä¼šå‘é€çª—å£é€šçŸ¥æŠ¥æ–‡ï¼› åŒ…æ‹¬çª—å£é€šçŸ¥æŠ¥æ–‡åœ¨å†…çš„æ‰€æœ‰æŠ¥æ–‡éƒ½æœ‰ wnd å­—æ®µï¼Œæ®æ­¤æ›´æ–° rmt_wndï¼› æ ¹æ® ACK å¤±åºæƒ…å†µå†³å®šæ˜¯å¦è¿›è¡Œå¿«é€Ÿé‡ä¼ ï¼› è®¡ç®— cwndã€‚ è°ƒç”¨ ikcp_recv ä» rcv_queue ä¸­æ¥æ”¶æ•°æ®ã€‚ 2. æ»‘åŠ¨çª—å£ å‘é€ç¼“å†²åŒº snd_buf å’Œæ¥æ”¶ç¼“å†²åŒº rcv_buf ä¸­æ´»åŠ¨çš„æŠ¥æ–‡éƒ½æ˜¯åœ¨æ»‘åŠ¨çª—å£ä¹‹ä¸­çš„ã€‚è¿™å¯¹äºæˆ‘ä»¬ç†è§£ KCP çš„å‘é€å’Œæ¥æ”¶æµç¨‹éå¸¸é‡è¦ï¼Œæ‰€æœ‰æˆ‘ä»¬å…ˆä»æ»‘åŠ¨çª—å£å¼€å§‹ä»‹ç»ã€‚ æ»‘åŠ¨çª—å£å®é™…æ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µ, ä¸èƒ½ç®€å•åœ°è®¤ä¸ºå®ƒæ˜¯ç¼“å†²åŒºçš„ä¸€éƒ¨åˆ†ï¼Œå‡†ç¡®çš„è¯´ï¼Œæ»‘åŠ¨çª—å£æ˜¯ç”±é˜Ÿåˆ—åŠ ç¼“å†²åŒºå…±åŒç»„æˆçš„ã€‚ 2.1 å‘é€ å‘é€çª—å£ snd_una å’Œ snd_nxt ä¼šåŠªåŠ›å¾€å³ç§»åŠ¨ï¼š ikcp_flush æ—¶ï¼Œä¼šä» snd_queue ä¸­å–å‡ºæŠ¥æ–‡æ’å…¥åˆ° snd_nxt çš„ä½ç½®ä¸Šï¼› å¦‚æœ snd_nxt - snd_una = cwndï¼Œåˆ™ä¸å…è®¸æ–°çš„æŠ¥æ–‡æ’å…¥ï¼› å½“ snd_una çš„ ACK æŠ¥æ–‡åˆ°è¾¾æ—¶ï¼Œsnd_una å°±ä¼šå³ç§»åˆ°ç¬¬ä¸€ä¸ªæ²¡æœ‰æ”¶åˆ° ACK æŠ¥æ–‡çš„ä½ç½®ï¼› å‘é€çª—å£ä¸­æœªç¡®è®¤åˆ°è¾¾çš„æŠ¥æ–‡ä½•æ—¶é‡ä¼ ï¼Ÿ æŠ¥æ–‡åœ¨ä¸€ä¸ª RTO æ—¶é—´å†…ä»æœªç¡®è®¤åˆ°è¾¾ï¼Œå°±ä¼šé‡ä¼ ã€‚æŠ¥æ–‡ RTO åˆå§‹å€¼æ˜¯ rx_rto ï¼Œä¼šæŒç»­å¢é•¿ï¼Œé€Ÿç‡æ”¯æŒé…ç½®ã€‚ 2.2 æ¥æ”¶ æ¥æ”¶çª—å£ æ¯æ”¶åˆ°ä¸€ä¸ªæ•°æ®æŠ¥æ–‡, éƒ½ä¼šæ ¹æ®å®ƒçš„ç¼–å·å°†å®ƒæ’å…¥åˆ° rcv_buf å¯¹åº”çš„ä½ç½®ä¸­ï¼› æ¥ç€æ£€æŸ¥ rcv_nxt èƒ½å¦å‘å³ç§»åŠ¨, åªæœ‰å½“æŠ¥æ–‡çš„é¡ºåºæ­£ç¡®ä¸”è¿ç»­æ‰èƒ½ç§»åŠ¨ï¼› åœ¨ä¸Šå›¾çš„ä¾‹å­ä¸­ç”±äº 4 å·æŠ¥æ–‡çš„ç¼ºå¤±, rcv_nxt åªèƒ½å¤„äº 4 å·ä½ç½®ç­‰å¾…ï¼Œ5, 6 å·æŠ¥æ–‡ä¹Ÿä¸èƒ½ç§»åŠ¨åˆ° rcv_queue ä¸­ï¼› ç­‰åˆ° 4 å·æŠ¥æ–‡åˆ°è¾¾åï¼Œæ‰èƒ½å°† 4, 5, 6 å·æŠ¥æ–‡ä¸€å¹¶ç§»åŠ¨åˆ° rcv_queue ä¸­ï¼ŒåŒæ—¶ rcv_nxt ä¼šå³ç§»åˆ° 7 å·ä½ç½®ã€‚ 2.3 æ¡ˆä¾‹åˆ†æ æˆ‘ä»¬ä¸¾ä¸ªç®€å•çš„ä¾‹å­æ¼”ç¤ºæ•´ä¸ª ARQ çš„æµç¨‹ã€‚ä¸‹å›¾ä¸­å®çº¿ç®­å¤´è¡¨ç¤ºæ•°æ®æŠ¥æ–‡ï¼Œè™šçº¿ç®­å¤´è¡¨ç¤º ACKã€‚ KCP ARQ æµç¨‹ â‘  t1 æ—¶åˆ»å‘é€æ–¹å‘é€ 1 å·æŠ¥æ–‡, 1 å·æŠ¥æ–‡æ”¾å…¥å‘é€ç¼“å†²åŒºä¸­, snd_una æŒ‡å‘ 1, snd_nxt æŒ‡å‘ 2. â‘¡ t2 è‡³ t3 æ—¶åˆ»å‘é€æ–¹ä¾æ¬¡å‘é€ 2 è‡³ 3 å·æŠ¥æ–‡, snd_nxt ä¾æ¬¡åç§». â‘¢ 1 å·æŠ¥æ–‡ä¸¢åŒ…. â‘£ t4, t5 æ—¶åˆ»æ¥æ”¶æ–¹æ”¶åˆ° 3 å·å’Œ 2 å·æŠ¥æ–‡, æ”¾å…¥ rcv_buf ä¸­; éšåå›å¤ 3 å·å’Œ 2 å· ACK. æ­¤æ—¶ç”±äº 1 å·æŠ¥æ–‡ç¼ºå¤±, rcv_nxt å§‹ç»ˆæŒ‡å‘ 1. â‘¤ 3 å· ACK ä¸¢åŒ…. â‘¥ t7 æ—¶åˆ»å‘é€æ–¹æ”¶åˆ° 2 å· ACK, å°† 2 å·æŠ¥æ–‡æ ‡è®°ä¸ºå·²é€è¾¾. æ­¤æ—¶ç”±äº 3 å· ACK ä¸¢åŒ…, 3 å·æŠ¥æ–‡æœªæ ‡è®°ä¸ºå·²é€è¾¾. ç”±äº 1 å·æŠ¥æ–‡æœªç¡®è®¤é€è¾¾, snd_una äº¦æŒ‡å‘ 1. â‘¦ t8 æ—¶åˆ» 1 å·æŠ¥æ–‡è¶…æ—¶, é‡ä¼ . â‘§ t9 æ—¶åˆ»æ¥æ”¶æ–¹æ”¶åˆ° 1 å·æŠ¥æ–‡, æ”¾å…¥ rcv_buf ä¸­; è¿™æ—¶ 1, 2, 3 å·æŠ¥æ–‡é¡ºåºæ­£ç¡®, rcv_nxt å³ç§»åˆ° 4 å·ä½ç½®. æ¥æ”¶æ–¹å›å¤ 1 å· ACK, åŒæ—¶å¸¦ä¸Š una = 4. â‘¨ t10 æ—¶åˆ»å‘é€æ–¹æ”¶åˆ° 1 å· ACK, å°† 1 å·æŠ¥æ–‡æ ‡è®°ä¸ºå·²é€è¾¾. åŒæ—¶ una è¡¨æ˜ 1, 2, 3 å·æŠ¥æ–‡å‡å·²é€è¾¾, å› æ­¤ä¹Ÿå°† 3 å·æŠ¥æ–‡æ ‡è®°ä¸ºå·²é€è¾¾. snd_una ç§»åŠ¨åˆ° 4. 3. è¶…æ—¶é‡ä¼  è¶…æ—¶é‡ä¼ æ˜¯å½“å‘é€çš„æ•°æ®åŒ…åœ¨é¢„å®šæ—¶é—´å†…æœªè¢«ç¡®è®¤æ—¶ï¼Œé‡æ–°å‘é€è¯¥æ•°æ®åŒ…çš„æœºåˆ¶ã€‚åœ¨ KCP ä¸­ï¼Œè¿™ä¸ªæ—¶é—´ç”±é‡æ–°ä¼ è¾“è¶…æ—¶ï¼ˆRTOï¼‰å†³å®šã€‚KCP è®¡ç®— RTO åˆå§‹å€¼çš„æ–¹æ³•æ˜¯ TCP çš„æ ‡å‡†æ–¹æ³•, è§„å®šåœ¨ RFC 6298 ä¸­ã€‚ è¿™é‡Œè¿˜æ˜¯è´´å‡ºæºç è®²æ¯”è¾ƒç›´è§‚ï¼š static void ikcp_update_ack(ikcpcb *kcp, IINT32 rtt)\tIINT32 rto = 0;\tif (kcp-rx_srtt == 0) kcp-rx_srtt = rtt; kcp-rx_rttval = rtt / 2; else long delta = rtt - kcp-rx_srtt; if (delta 0) delta = -delta; kcp-rx_rttval = (3 * kcp-rx_rttval + delta) / 4; kcp-rx_srtt = (7 * kcp-rx_srtt + rtt) / 8; if (kcp-rx_srtt 1) kcp-rx_srtt = 1; rto = kcp-rx_srtt + _imax_(kcp-interval, 4 * kcp-rx_rttval);\tkcp-rx_rto = _ibound_(kcp-rx_minrto, rto, IKCP_RTO_MAX); è¿™ä¸ªè®¡ç®—è¿‡ç¨‹ç¬”è€…å°±ä¸åšè¯¦ç»†ä»‹ç»äº†ï¼Œä»£ç é‡Œé¢çš„å…¬å¼è¯»è€…å¯ä»¥å°è¯•è‡ªè¡Œç”»å›¾è¿›è¡Œç†è§£ï¼Œè¿™é‡Œå°±ä¸èŠ±å¤§ç¯‡å¹…ç”»å…¬å¼äº†ï¼Œä¸‹é¢æˆ‘å°è¯•ä»¥æ›´é€šä¿—æ˜“æ‡‚çš„è¯è¯­è§£é‡Š RTOï¼Œåªéœ€è¦ç†è§£å®ƒåœ¨åšä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆåšï¼Œå°±å¯ä»¥äº†ï¼Œä¸ªäººè§‰å¾—å¯¹å…¬å¼çš„ç»†èŠ‚å¯ä»¥æš‚ä¸”å¿½ç•¥ã€‚ 3.1 RTO è®¡ç®—ç›®çš„ KCP çš„ RTO è®¡ç®—æ˜¯ä¸ºäº†ç¡®å®šåœ¨å¤šé•¿æ—¶é—´å†…æœªæ”¶åˆ°ç¡®è®¤ï¼ˆACKï¼‰æ—¶ï¼Œåº”è¯¥é‡æ–°å‘é€æ•°æ®åŒ…ã€‚è¿™æ®µæ—¶é—´è¢«ç§°ä¸ºé‡ä¼ è¶…æ—¶æ—¶é—´ï¼ˆRTOï¼‰ã€‚è®¡ç®— RTO çš„ç›®çš„æ˜¯åœ¨ç½‘ç»œæ¡ä»¶å˜åŒ–çš„æƒ…å†µä¸‹ï¼Œæ—¢èƒ½å¿«é€Ÿå“åº”æ•°æ®ä¸¢å¤±ï¼Œä¹Ÿèƒ½é¿å…ä¸å¿…è¦çš„é‡ä¼ ï¼Œä»è€Œä¿æŒé«˜æ•ˆçš„ä¼ è¾“ã€‚ 3.2 RTO è®¡ç®—æ¶‰åŠçš„å˜é‡è§£é‡Š RTT å’Œ SRTT çš„æ¦‚å¿µ: RTTï¼ˆRound-Trip Timeï¼‰: æ˜¯ä»å‘é€ä¸€ä¸ªæ•°æ®åŒ…åˆ°æ”¶åˆ°å…¶ç¡®è®¤ï¼ˆACKï¼‰æ‰€èŠ±çš„æ—¶é—´ã€‚ SRTTï¼ˆSmoothed RTTï¼‰: æ˜¯ RTT çš„åŠ æƒå¹³å‡å€¼ï¼Œå®ƒä»£è¡¨äº† RTT çš„ä¸€ä¸ªæ›´ç¨³å®šçš„ä¼°è®¡å€¼ã€‚SRTT çš„ç›®çš„æ˜¯å‡å°‘ RTT çš„çŸ­æœŸæ³¢åŠ¨å¯¹ RTO çš„å½±å“ã€‚ RTT å˜åŒ–å€¼ï¼ˆRTT varianceï¼‰ï¼šç½‘ç»œä¼ è¾“æ—¶é—´å¹¶ä¸æ€»æ˜¯å›ºå®šçš„ï¼Œæœ‰æ—¶ä¼šå› ä¸ºç½‘ç»œæ‹¥å¡æˆ–å…¶ä»–åŸå› å‡ºç°æ³¢åŠ¨ã€‚æˆ‘ä»¬é€šè¿‡è®¡ç®— RTT å˜åŒ–å€¼ï¼ˆRTT varianceï¼‰æ¥ä¼°è®¡è¿™ç§æ³¢åŠ¨çš„å¤§å°ã€‚ ä¸ºä»€ä¹ˆéœ€è¦ SRTT å’Œ RTT å˜åŒ–å€¼ï¼š SRTT ç»™æˆ‘ä»¬ä¸€ä¸ªå¹³å‡çš„ RTT ä¼°è®¡å€¼ã€‚ RTT å˜åŒ–å€¼å‘Šè¯‰æˆ‘ä»¬ç½‘ç»œçš„æ³¢åŠ¨æ€§ã€‚å¦‚æœæ³¢åŠ¨å¾ˆå¤§ï¼Œæˆ‘ä»¬å¸Œæœ› RTO æ›´å¤§ï¼Œä»¥å…å› ä¸ºçŸ­æš‚çš„ç½‘ç»œå»¶è¿Ÿå°±è§¦å‘ä¸å¿…è¦çš„é‡ä¼ ã€‚ 3.3 RTO è®¡ç®—æ­¥éª¤ 1. åˆå§‹åŒ–ï¼šåˆæ¬¡è®¡ç®—æ—¶ï¼Œæˆ‘ä»¬æ²¡æœ‰å†å² RTT å€¼ï¼Œæ‰€ä»¥ç›´æ¥ç”¨ç¬¬ä¸€æ¬¡æµ‹é‡çš„ RTT æ¥åˆå§‹åŒ– SRTTï¼Œå¹¶å°† RTT å˜åŒ–å€¼è®¾ä¸º RTT çš„ä¸€åŠã€‚ 2. æ›´æ–° SRTT å’Œ RTT å˜åŒ–å€¼: æ¯æ¬¡æˆ‘ä»¬æµ‹é‡æ–°çš„ RTTï¼Œå°±ç”¨å®ƒæ¥æ›´æ–° SRTT å’Œ RTT å˜åŒ–å€¼ã€‚ æ›´æ–° SRTTï¼šæˆ‘ä»¬ä¸ç›´æ¥æ›¿æ¢æ—§çš„ SRTTï¼Œè€Œæ˜¯ç”¨ä¸€ä¸ªå¹³æ»‘çš„æ–¹å¼ï¼ˆå³åŠ æƒå¹³å‡ï¼‰ï¼Œä½¿å¾— SRTT é€æ¸é è¿‘æ–° RTTï¼Œä½†åˆä¸ä¼šå‰§çƒˆå˜åŒ–ã€‚ æ›´æ–° RTT å˜åŒ–å€¼ï¼šè®¡ç®—æ–°çš„ RTT ä¸ SRTT çš„å·®å€¼ï¼Œç”¨è¿™ä¸ªå·®å€¼æ¥æ›´æ–° RTT å˜åŒ–å€¼ï¼Œä½¿å…¶åæ˜ å½“å‰ç½‘ç»œæ³¢åŠ¨çš„å¤§å°ã€‚ 3. è®¡ç®— RTO: ç”¨ SRTT åŠ ä¸Šå››å€çš„ RTT å˜åŒ–å€¼æ¥è®¡ç®— RTOï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿ RTO è¶³å¤Ÿé•¿ï¼Œèƒ½æ¶µç›–å¤§éƒ¨åˆ†çš„ç½‘ç»œæ³¢åŠ¨ã€‚ æˆ‘ä»¬è¿˜è¦ç¡®ä¿ RTO ä¸å°äºä¸€ä¸ªæœ€å°å€¼ï¼ˆrx_minrtoï¼‰ï¼Œä»¥é˜²æ­¢ RTO è¿‡å°å¯¼è‡´é¢‘ç¹é‡ä¼ ï¼›ä¹Ÿä¸èƒ½å¤§äºä¸€ä¸ªæœ€å¤§å€¼ï¼ˆIKCP_RTO_MAXï¼‰ï¼Œä»¥é˜²æ­¢ RTO è¿‡å¤§å½±å“å“åº”é€Ÿåº¦ã€‚ 4. RTO è®¡ç®—æ•ˆæœ ç¨³å®šçš„ä¼ è¾“: SRTT æä¾›äº†ä¸€ä¸ªç¨³å®šçš„å¹³å‡ RTT ä¼°è®¡ï¼Œä½¿å¾— RTO èƒ½é€‚åº”ç½‘ç»œçš„é•¿æœŸå˜åŒ–ã€‚ é€‚åº”ç½‘ç»œæ³¢åŠ¨: RTT å˜åŒ–å€¼ä½¿å¾— RTO èƒ½å¤Ÿåº”å¯¹ç½‘ç»œçš„çŸ­æœŸæ³¢åŠ¨ï¼Œå‡å°‘å› çŸ­æš‚å»¶è¿Ÿè€Œå¯¼è‡´çš„é‡ä¼ ã€‚ å¿«é€Ÿå“åº”: RTO è®¾ç½®åˆç†åï¼Œèƒ½å¤Ÿåœ¨æ•°æ®ä¸¢å¤±æ—¶å¿«é€Ÿé‡ä¼ ï¼Œä¿æŒä¼ è¾“çš„é«˜æ•ˆå’ŒåŠæ—¶æ€§ã€‚ é€šè¿‡è¿™æ ·çš„è®¡ç®—æ–¹å¼ï¼ŒKCP èƒ½å¤Ÿåœ¨ä¸åŒçš„ç½‘ç»œæ¡ä»¶ä¸‹ï¼Œè‡ªåŠ¨è°ƒæ•´é‡ä¼ ç­–ç•¥ï¼Œä»è€Œåœ¨ä¿è¯æ•°æ®å¯é æ€§çš„åŒæ—¶ï¼Œä¿æŒè¾ƒé«˜çš„ä¼ è¾“æ•ˆç‡ã€‚ 4. å¿«é€Ÿé‡ä¼  åœ¨ç½‘ç»œä¼ è¾“ä¸­ï¼Œæ•°æ®åŒ…å¯èƒ½ä¼šç”±äºç½‘ç»œæ‹¥å¡ã€ä¸¢åŒ…ç­‰åŸå› è€Œä¸¢å¤±ã€‚è¶…æ—¶é‡ä¼ ä¾èµ–äºé‡ä¼ è¶…æ—¶æ—¶é—´ï¼ˆRTOï¼‰æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦é‡ä¼ ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´å“åº”å»¶è¿Ÿã€‚è€Œå¿«é€Ÿé‡ä¼ é€šè¿‡æ£€æµ‹é‡å¤çš„ç¡®è®¤åŒ…ï¼ˆACKï¼‰æ¥å¿«é€Ÿåˆ¤æ–­æ•°æ®åŒ…çš„ä¸¢å¤±ï¼Œå¹¶ç«‹å³è§¦å‘é‡ä¼ ï¼Œæ˜¾è‘—ç¼©çŸ­äº†æ•°æ®ä¸¢å¤±çš„æ¢å¤æ—¶é—´ã€‚ KCP å¿«é€Ÿé‡ä¼  4.1 ä½•æ—¶å¿«é€Ÿé‡ä¼ ï¼Ÿ æ¯ä¸ªæŠ¥æ–‡çš„ fastack è®°å½•äº†å®ƒæ£€æµ‹åˆ° ACK å¤±åºçš„æ¬¡æ•°ï¼Œæ¯å½“ KCP æ”¶åˆ°ä¸€ä¸ªç¼–å·ä¸º sn çš„ ACK æ—¶ï¼Œå°±ä¼šæ£€æŸ¥ snd_buf ä¸­ç¼–å·å°äº sn ä¸”æœªç¡®è®¤é€è¾¾çš„æŠ¥æ–‡ï¼Œå¹¶å°†å…¶ fastack åŠ  1ã€‚ å¯ä»¥é€šè¿‡é…ç½® fastresend æŒ‡å®šå¤±åºå¤šå°‘æ¬¡å°±æ‰§è¡Œå¿«é€Ÿé‡ä¼ ã€‚ æ¯æ¬¡è°ƒç”¨ ikcp_flush éƒ½ä¼šé‡ä¼  snd_buf ä¸­ fastask = fastresend çš„æŠ¥æ–‡ã€‚ 4.2 æ— é™å¿«é€Ÿé‡ä¼ å—ï¼Ÿ æ¯ä¸ªæŠ¥æ–‡çš„ xmit è®°å½•å®ƒè¢«ä¼ è¾“çš„æ¬¡æ•°ï¼Œå¯ä»¥é…ç½® fastlimit è§„å®šä¼ è¾“æ¬¡æ•°å°äº fastlimit çš„æŠ¥æ–‡æ‰èƒ½æ‰§è¡Œå¿«é€Ÿé‡ä¼ ã€‚ 5. æ¯”è¾ƒ TCP çš„è¶…æ—¶é‡ä¼ å’Œå¿«é€Ÿé‡ä¼  TCP ä¹Ÿå®ç°äº†ç±»ä¼¼çš„æœºåˆ¶ï¼Œä½†åœ¨å¤æ‚æ€§å’Œåº”ç”¨åœºæ™¯ä¸Šæœ‰æ‰€ä¸åŒã€‚ 5.1 TCP çš„è¶…æ—¶é‡ä¼  1. RTT ä¼°ç®—: TCP é€šè¿‡æ¥æ”¶ç¡®è®¤åŒ…æ¥ä¼°ç®— RTTï¼Œå¹¶ä½¿ç”¨ RTT çš„å˜åŒ–èŒƒå›´æ¥è®¡ç®— RTOã€‚ TCP ä½¿ç”¨ Jacobson/Karels ç®—æ³•è¿›è¡Œ RTT ä¼°ç®—å’Œ RTO è®¡ç®—ï¼š // SRTT and RTTVAR calculationRTTVAR = (1 - Î²) * RTTVAR + Î² * |RTTsample - SRTT|SRTT = (1 - Î±) * SRTT + Î± * RTTsampleRTO = SRTT + 4 * RTTVAR å…¶ä¸­ï¼ŒSRTT æ˜¯å¹³æ»‘çš„ RTTï¼ŒRTTVAR æ˜¯ RTT çš„å˜åŒ–èŒƒå›´ï¼ŒÎ± å’Œ Î² æ˜¯æƒé‡å› å­ã€‚ 2. é‡ä¼ ç­–ç•¥: å¦‚æœåœ¨ RTO æ—¶é—´å†…æœªæ”¶åˆ° ACKï¼ŒTCP ä¼šé‡ä¼ æœªç¡®è®¤çš„æ•°æ®åŒ…ã€‚ æ¯æ¬¡é‡ä¼ ï¼ŒRTO å€¼ä¼šæŒ‰ç…§æŒ‡æ•°å¢é•¿ï¼ˆæŒ‡æ•°é€€é¿ç®—æ³•ï¼‰ã€‚ 3. æ‹¥å¡æ§åˆ¶: TCP ä½¿ç”¨å¤æ‚çš„æ‹¥å¡æ§åˆ¶æœºåˆ¶ï¼Œå¦‚æ…¢å¯åŠ¨ã€æ‹¥å¡é¿å…ç­‰ï¼Œæ¥è°ƒæ•´å‘é€çª—å£å’Œä¼ è¾“é€Ÿç‡ã€‚ 5.2 TCP çš„å¿«é€Ÿé‡ä¼  å½“æ¥æ”¶åˆ°ä¸‰ä¸ªé‡å¤çš„ ACK æ—¶ï¼ŒTCP ä¼šç«‹å³é‡ä¼ ä¸¢å¤±çš„æ•°æ®åŒ…ï¼Œè€Œä¸ç­‰å¾… RTO è¶…æ—¶ã€‚ å¿«é€Ÿé‡ä¼ åï¼ŒTCP è¿›å…¥å¿«é€Ÿæ¢å¤çŠ¶æ€ï¼Œè°ƒæ•´æ‹¥å¡çª—å£ï¼Œé¿å…æ‹¥å¡çª—å£è¿‡åº¦æ”¶ç¼©ã€‚ 5.3 æ¯”è¾ƒåˆ†æ ç‰¹æ€§ KCP TCP RTT ä¼°ç®— åŸºäºåŠ æƒç§»åŠ¨å¹³å‡ï¼Œè¾ƒä¸ºç®€å• ä½¿ç”¨ Jacobson/Karels ç®—æ³•ï¼Œå¤æ‚ä½†ç²¾ç¡® RTO è®¡ç®— ç®€åŒ–çš„è®¡ç®—å…¬å¼ åŸºäº RTT çš„å¤æ‚è®¡ç®— é‡ä¼ æœºåˆ¶ è¶…æ—¶é‡ä¼ å’Œå¿«é€Ÿé‡ä¼  è¶…æ—¶é‡ä¼ å’Œå¿«é€Ÿé‡ä¼  æ‹¥å¡æ§åˆ¶ ç®€å•çš„æ‹¥å¡æ§åˆ¶ï¼Œé€‚åˆä½å»¶è¿Ÿåº”ç”¨ å¤æ‚çš„æ‹¥å¡æ§åˆ¶ï¼Œé€‚åˆå¹¿æ³›çš„ä¼ è¾“åœºæ™¯ é€‚ç”¨åœºæ™¯ å®æ—¶åº”ç”¨ï¼Œå¦‚æ¸¸æˆã€è§†é¢‘ä¼šè®® é€šç”¨åº”ç”¨ï¼Œå¦‚æ–‡ä»¶ä¼ è¾“ã€HTTP å®ç°å¤æ‚åº¦ è¾ƒä¸ºç®€å•ï¼Œæ˜“äºç†è§£å’Œå®ç° å¤æ‚ï¼Œéœ€å¤„ç†æ›´å¤šçš„ç½‘ç»œçŠ¶æ€å’Œæ§åˆ¶ å¯é æ€§ ä¾èµ–äºç”¨æˆ·è‡ªå®šä¹‰çš„é‡ä¼ å’Œæ§åˆ¶ç­–ç•¥ å†…ç½®å¯é æ€§å’Œæµæ§åˆ¶æœºåˆ¶ å“åº”é€Ÿåº¦ é«˜æ•ˆå¿«é€Ÿï¼Œé€‚ç”¨äºä½å»¶è¿Ÿå’Œé«˜ååé‡åœºæ™¯ å¯é ä½†å“åº”é€Ÿåº¦è¾ƒæ…¢ï¼Œé€‚åˆç¨³å®šä¼ è¾“åœºæ™¯ KCP å’Œ TCP éƒ½æä¾›äº†å¯é çš„ä¼ è¾“æœºåˆ¶ï¼Œä½†å®ƒä»¬é€‚ç”¨äºä¸åŒçš„åº”ç”¨åœºæ™¯ã€‚KCP è®¾è®¡ç®€å•ï¼Œé€‚åˆå¯¹å»¶è¿Ÿæ•æ„Ÿçš„å®æ—¶åº”ç”¨ï¼Œè€Œ TCP æ‹¥æœ‰å®Œå–„çš„æ‹¥å¡æ§åˆ¶å’Œå¯é æ€§æœºåˆ¶ï¼Œé€‚åˆå¹¿æ³›çš„ç½‘ç»œåº”ç”¨ã€‚ 6. æ‹¥å¡æ§åˆ¶ æ‹¥å¡æ§åˆ¶æ˜¯ç½‘ç»œä¼ è¾“åè®®ä¸­çš„ä¸€ä¸ªé‡è¦æœºåˆ¶ï¼Œç”¨äºé˜²æ­¢å‘é€è¿‡å¤šçš„æ•°æ®åŒ…å¯¼è‡´ç½‘ç»œæ‹¥å¡ã€‚åœ¨ KCP ä¸­ï¼Œæ‹¥å¡æ§åˆ¶ç›¸å¯¹ç®€å•ï¼Œä¸»è¦é€šè¿‡å‘é€çª—å£ï¼ˆsnd_wndï¼‰å’Œæ‹¥å¡çª—å£ï¼ˆcwndï¼‰æ¥ç®¡ç†æ•°æ®å‘é€é€Ÿç‡ã€‚ 6.1 ä¸‰ç§ç­–ç•¥ KCP æœ‰ 3 ç§æ‹¥å¡æ§åˆ¶çš„ç­–ç•¥ï¼š æ…¢å¯åŠ¨ï¼ˆslow startï¼‰ æ‹¥å¡é¿å…ï¼ˆcongestion avoidanceï¼‰ å¿«é€Ÿæ¢å¤ï¼ˆfast recoveryï¼‰ æ…¢å¯åŠ¨ï¼šå…ˆå°† cwnd è®¾ç½®ä¸º 1ï¼Œéšåå¹³å‡æ¯ç»è¿‡ä¸€ä¸ª RTT æ—¶é—´ï¼Œcwnd = cwnd * 2ï¼Œç›´åˆ°é˜ˆå€¼ ssthreshã€‚ æ‹¥å¡é¿å…ï¼šcwnd åˆ° ssthresh åï¼Œcwnd å‘ˆçº¿æ€§å¢é•¿ã€‚ å½“æ…¢å¯åŠ¨æˆ–è€…æ‹¥å¡é¿å…é€ æˆ ä¸¢åŒ… åï¼Œå°±é‡‡å–ç›¸åº”çš„é€€è®©ç­–ç•¥ï¼š fastack = fastresend - å‘ç”Ÿå¿«é€Ÿé‡ä¼ ï¼šå°† ssthresh = cwnd / 2ï¼Œcwnd = ssthresh + fastresend è¿›å…¥å¿«æ¢å¤ã€‚ current = resentts - è¶…æ—¶é‡ä¼ ï¼šssthresh = ssthresh / 2ï¼Œcwnd = 1ï¼Œè¿›å…¥æ…¢å¯åŠ¨ã€‚ æ‹¥å¡æ§åˆ¶ä¸­ cwnd å’Œ ssthresh çš„å˜åŒ–æƒ…å†µ 6.2 æ ¸å¿ƒæ¦‚å¿µ KCP çš„æ‹¥å¡æ§åˆ¶åŸºäºä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š å‘é€çª—å£ (snd_wnd)ï¼šè¡¨ç¤ºå‘é€ç«¯åœ¨æœªæ”¶åˆ°æ¥æ”¶ç«¯ç¡®è®¤ä¹‹å‰ï¼Œå…è®¸å‘é€çš„æ•°æ®åŒ…çš„æ•°é‡ã€‚å®ƒç±»ä¼¼äº TCP ä¸­çš„å‘é€çª—å£ï¼Œæ§åˆ¶äº†æ•°æ®æµçš„é€Ÿç‡ã€‚ æ¥æ”¶çª—å£ (rcv_wnd)ï¼šè¡¨ç¤ºæ¥æ”¶ç«¯èƒ½å¤Ÿå¤„ç†çš„æœ€å¤§æ•°æ®åŒ…æ•°é‡ã€‚å‘é€ç«¯é€šè¿‡æ¥æ”¶ç«¯çš„çª—å£å¤§å°æ¥è°ƒæ•´è‡ªå·±çš„å‘é€é€Ÿç‡ã€‚ è¿œç«¯çª—å£ (rmt_wnd)ï¼šè¡¨ç¤ºæ¥æ”¶ç«¯çš„çª—å£å¤§å°ï¼Œå‘é€ç«¯ä¼šæ ¹æ®è¿™ä¸ªå€¼è°ƒæ•´è‡ªå·±çš„å‘é€çª—å£ï¼Œä»¥é¿å…å‘é€çš„æ•°æ®è¶…å‡ºæ¥æ”¶ç«¯çš„å¤„ç†èƒ½åŠ›ã€‚ æ‹¥å¡çª—å£ (cwnd)ï¼šç”¨äºæ§åˆ¶ä¼ è¾“ä¸­çš„æ•°æ®åŒ…æ•°é‡ã€‚å®ƒåŸºäºç½‘ç»œçš„æ‹¥å¡æƒ…å†µåŠ¨æ€è°ƒæ•´ï¼Œä»¥é¿å…ç½‘ç»œæ‹¥å¡ã€‚ æ…¢å¯åŠ¨é˜ˆå€¼ (ssthresh)ï¼šç”¨äºç¡®å®šæ‹¥å¡æ§åˆ¶çš„æ¨¡å¼ã€‚å½“ cwnd å°äº ssthresh æ—¶ï¼ŒKCP å¤„äºæ…¢å¯åŠ¨æ¨¡å¼ï¼Œå¦åˆ™è¿›å…¥æ‹¥å¡é¿å…æ¨¡å¼ã€‚ 6.3 çª—å£æ¢æµ‹ï¼ˆWindow Probingï¼‰ åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ¥æ”¶ç«¯çš„çª—å£å¯èƒ½ä¼šè¢«å…³é—­ï¼ˆå³ rmt_wnd ä¸º 0ï¼‰ï¼Œè¿™æ„å‘³ç€æ¥æ”¶ç«¯æ— æ³•æ¥æ”¶ä»»ä½•æ–°çš„æ•°æ®ã€‚ä¸ºäº†åº”å¯¹è¿™ç§æƒ…å†µï¼ŒKCP å®ç°äº†çª—å£æ¢æµ‹æœºåˆ¶ï¼š å½“ rmt_wnd ä¸º 0 æ—¶ï¼ŒKCP ä¸ä¼šç«‹å³åœæ­¢å‘é€æ•°æ®ï¼Œè€Œæ˜¯ä¼šå®šæœŸå‘é€ä¸€ä¸ªæ¢æµ‹åŒ…ï¼Œä»¥æ£€æµ‹æ¥æ”¶ç«¯çª—å£æ˜¯å¦å·²ç»æ‰“å¼€ã€‚ è¿™ä¸ªæ¢æµ‹åŒ…ä¼šè§¦å‘æ¥æ”¶ç«¯è¿”å›ä¸€ä¸ª ACKï¼Œå…¶ä¸­åŒ…å«æœ€æ–°çš„æ¥æ”¶çª—å£å¤§å°ä¿¡æ¯ã€‚ 6.4 è°ƒèŠ‚å’Œé…ç½® KCP çš„æ‹¥å¡æ§åˆ¶æœºåˆ¶æä¾›äº†ä¸€äº›é…ç½®å‚æ•°ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡è°ƒæ•´è¿™äº›å‚æ•°æ¥ä¼˜åŒ–ä¼ è¾“æ€§èƒ½ï¼š snd_wnd: å‘é€çª—å£å¤§å°ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®åº”ç”¨çš„éœ€æ±‚è°ƒæ•´è¯¥å€¼ï¼Œä»¥æ§åˆ¶æ•°æ®å‘é€çš„æœ€å¤§é‡ã€‚ rcv_wnd: æ¥æ”¶çª—å£å¤§å°ï¼Œè¡¨ç¤ºæ¥æ”¶ç«¯èƒ½å¤Ÿå¤„ç†çš„æœ€å¤§æ•°æ®åŒ…æ•°é‡ã€‚ ssthresh: æ…¢å¯åŠ¨é˜ˆå€¼ï¼Œåˆå§‹å€¼é€šå¸¸è®¾ç½®ä¸ºè¾ƒå¤§çš„ä¸€ä¸ªå¸¸é‡ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®ç½‘ç»œæƒ…å†µè°ƒæ•´ã€‚ cwnd: æ‹¥å¡çª—å£å¤§å°ï¼Œåˆå§‹å€¼é€šå¸¸è®¾ç½®ä¸º 1ï¼Œéšä¼ è¾“æƒ…å†µåŠ¨æ€è°ƒæ•´ã€‚ 7. æ¯”è¾ƒ TCP çš„æ‹¥å¡æ§åˆ¶ 7.1 å››ä¸ªé˜¶æ®µ TCP æ‹¥å¡æ§åˆ¶æœ‰å››ä¸ªå…³é”®é˜¶æ®µ æ…¢å¯åŠ¨ï¼ˆSlow Startï¼‰ï¼š ç›®çš„ï¼šå¿«é€Ÿæ¢æµ‹ç½‘ç»œçš„å¯ç”¨å¸¦å®½ã€‚ æœºåˆ¶ï¼šå½“ä¸€ä¸ªè¿æ¥åˆšå»ºç«‹æˆ–è€…ä»ä¸¢åŒ…æ¢å¤æ—¶ï¼Œcwndï¼ˆæ‹¥å¡çª—å£ï¼‰ä»ä¸€ä¸ªè¾ƒå°çš„å€¼ï¼ˆé€šå¸¸æ˜¯ 1 ä¸ª MSSï¼Œå³æœ€å¤§æŠ¥æ–‡æ®µå¤§å°ï¼‰å¼€å§‹ï¼Œå¹¶ä»¥æŒ‡æ•°å¢é•¿çš„æ–¹å¼å¢åŠ ã€‚ è¿‡ç¨‹ï¼šæ¯æ¬¡æ”¶åˆ°ä¸€ä¸ª ACKï¼Œcwnd å¢åŠ ä¸€ä¸ª MSSï¼Œä½¿å¾— cwnd æ¯ RTT å¢åŠ ä¸€å€ï¼Œç›´åˆ° cwnd è¾¾åˆ°æ…¢å¯åŠ¨é˜ˆå€¼ï¼ˆssthreshï¼‰ã€‚ æ‹¥å¡é¿å…ï¼ˆCongestion Avoidanceï¼‰: ç›®çš„ï¼šé€æ­¥æ¢æµ‹ç½‘ç»œçš„æœ€å¤§å®¹é‡ï¼Œå¹¶é¿å…æ‹¥å¡ã€‚ æœºåˆ¶ï¼šå½“ cwnd è¾¾åˆ°æˆ–è¶…è¿‡ ssthresh æ—¶ï¼ŒTCP è¿›å…¥æ‹¥å¡é¿å…é˜¶æ®µï¼Œæ­¤æ—¶ cwnd ä»¥çº¿æ€§å¢é•¿çš„æ–¹å¼å¢åŠ ã€‚ è¿‡ç¨‹ï¼šæ¯ä¸ª RTTï¼Œcwnd å¢åŠ  1/cwnd ä¸ª MSSï¼Œè¿™ç§å¢é•¿æ–¹å¼è¾ƒä¸ºä¿å®ˆï¼Œæ—¨åœ¨é˜²æ­¢è¿‡åº¦å‘é€å¯¼è‡´çš„æ‹¥å¡ã€‚ å¿«é€Ÿé‡ä¼ ï¼ˆFast Retransmitï¼‰: ç›®çš„ï¼šå¿«é€Ÿå“åº”ä¸¢åŒ…ï¼Œæé«˜ä¼ è¾“æ•ˆç‡ã€‚ æœºåˆ¶ï¼šå½“å‘é€ç«¯æ”¶åˆ°ä¸‰ä¸ªé‡å¤çš„ ACK æ—¶ï¼Œç«‹å³é‡ä¼ è¢«ç¡®è®¤ä¸¢å¤±çš„æ•°æ®åŒ…ï¼Œè€Œä¸ç­‰å¾… RTO è¶…æ—¶ã€‚ è¿‡ç¨‹ï¼šå¿«é€Ÿé‡ä¼ çš„ç›®çš„æ˜¯è¿…é€Ÿæ¢å¤ä¸¢å¤±çš„æ•°æ®åŒ…ï¼Œä»è€Œå‡å°‘å› ä¸¢åŒ…å¯¼è‡´çš„ç­‰å¾…æ—¶é—´ã€‚ å¿«é€Ÿæ¢å¤ï¼ˆFast Recoveryï¼‰: ç›®çš„ï¼šåœ¨æ‹¥å¡åå¿«é€Ÿæ¢å¤åˆ°é€‚å½“çš„ä¼ è¾“é€Ÿç‡ã€‚ æœºåˆ¶ï¼šåœ¨å¿«é€Ÿé‡ä¼ åï¼ŒTCP ä¸ä¼šç›´æ¥è¿›å…¥æ…¢å¯åŠ¨ï¼Œè€Œæ˜¯ä¿æŒ cwnd çš„ä¸€éƒ¨åˆ†ï¼Œä»¥è¾ƒå¿«çš„é€Ÿåº¦æ¢å¤åˆ°æ‹¥å¡é¿å…çŠ¶æ€ã€‚ è¿‡ç¨‹ï¼šå°† ssthresh è®¾ç½®ä¸ºå½“å‰ cwnd çš„ä¸€åŠï¼Œcwnd è¢«ä¸´æ—¶å‡å°ï¼Œç„¶ååœ¨æ¥æ”¶æ–° ACK æ—¶å¿«é€Ÿå¢åŠ  cwndï¼Œç›´åˆ°æ¢å¤åˆ° ssthresh ä¸ºæ­¢ã€‚ 7.2 æ¯”è¾ƒåˆ†æ ç‰¹æ€§ TCP KCP å®ç°å¤æ‚åº¦ å¤æ‚ï¼ŒåŒ…å«å¤šä¸ªé˜¶æ®µå’Œç®—æ³• ç®€å•ï¼Œä¸»è¦é€šè¿‡çª—å£å¤§å°æ§åˆ¶ æ‹¥å¡æ£€æµ‹ é€šè¿‡ RTT ä¼°ç®—å’Œ ACK æ£€æµ‹ä¸¢åŒ… ä¸»è¦é€šè¿‡ ACK å’Œçª—å£å¤§å°æ£€æµ‹ä¸¢åŒ… å“åº”é€Ÿåº¦ å“åº”ç›¸å¯¹è¾ƒæ…¢ï¼Œé€‚åˆç¨³å®šä¼ è¾“ å“åº”è¾ƒå¿«ï¼Œé€‚åˆå®æ—¶æ€§é«˜çš„ä¼ è¾“ é€‚åº”æ€§ èƒ½é€‚åº”å¹¿æ³›çš„ç½‘ç»œæ¡ä»¶ é€‚åº”æ€§è¾ƒå¥½ï¼Œä½†æ›´é€‚åˆä½å»¶è¿Ÿç½‘ç»œ é…ç½®çµæ´»æ€§ è¾ƒä¸ºå›ºå®šï¼Œä¾èµ–äºç³»ç»Ÿé…ç½®å’Œä¼˜åŒ– æä¾›æ›´å¤šçš„é…ç½®é€‰é¡¹ï¼Œç”¨æˆ·å¯æ ¹æ®éœ€æ±‚è°ƒæ•´ åº”ç”¨åœºæ™¯ é€‚ç”¨äºå„ç§éœ€è¦å¯é ä¼ è¾“çš„åº”ç”¨ é€‚ç”¨äºå®æ—¶æ€§è¦æ±‚é«˜çš„åº”ç”¨ï¼Œå¦‚æ¸¸æˆå’Œè§†é¢‘ä¼šè®® çª—å£è°ƒæ•´ æ…¢å¯åŠ¨ã€æ‹¥å¡é¿å…ã€å¿«é€Ÿé‡ä¼ ã€å¿«é€Ÿæ¢å¤ç­‰æœºåˆ¶ ä¸»è¦é€šè¿‡å‘é€çª—å£å’Œæ‹¥å¡çª—å£è°ƒæ•´ ä¸¢åŒ…å“åº” ä¸¢åŒ…æ—¶é€šè¿‡å‡å° cwnd å’Œ ssthresh æ¥è°ƒæ•´ ä¸¢åŒ…æ—¶è¿…é€Ÿè°ƒæ•´ cwnd å’Œé‡ä¼  æ‹¥å¡æ§åˆ¶ç­–ç•¥ æ…¢å¯åŠ¨ã€æ‹¥å¡é¿å…ã€å¿«é€Ÿé‡ä¼ ã€å¿«é€Ÿæ¢å¤ç­‰å¤šç§ç­–ç•¥ ä¸»è¦é€šè¿‡è°ƒæ•´ cwnd å’Œ ssthresh è¿›è¡Œç®€å•æ§åˆ¶ ä¼˜ç‚¹ ç¨³å®šå¯é ã€æœºåˆ¶å…¨é¢ã€åº”ç”¨å¹¿æ³› å®ç°ç®€å•ã€å“åº”å¿«ã€çµæ´»æ€§é«˜ã€é€‚åˆå®æ—¶åº”ç”¨ ç¼ºç‚¹ å¤æ‚ã€å“åº”æ…¢ã€åˆå§‹é˜¶æ®µä¿å®ˆ æ— æ³•åº”å¯¹æ›´åŠ å¤æ‚çš„ç½‘ç»œçŠ¶å†µã€åº”ç”¨åœºæ™¯æœ‰é™ TCP å’Œ KCP éƒ½æœ‰å„è‡ªçš„æ‹¥å¡æ§åˆ¶æœºåˆ¶ï¼Œé€‚ç”¨äºä¸åŒçš„åº”ç”¨åœºæ™¯ã€‚TCP æä¾›äº†å¤æ‚è€Œå…¨é¢çš„æ‹¥å¡æ§åˆ¶ï¼Œé€‚åˆäºå„ç§ç½‘ç»œæ¡ä»¶ä¸‹çš„å¯é ä¼ è¾“ï¼Œè€Œ KCP æä¾›äº†ç®€å•é«˜æ•ˆçš„æ§åˆ¶æœºåˆ¶ï¼Œé€‚åˆäºä½å»¶è¿Ÿå’Œé«˜å“åº”é€Ÿåº¦çš„å®æ—¶åº”ç”¨ã€‚é€‰æ‹©ä½¿ç”¨å“ªç§åè®®å–å†³äºå…·ä½“çš„åº”ç”¨éœ€æ±‚å’Œç½‘ç»œç¯å¢ƒã€‚ æºç åˆ†æ 1. æ ¸å¿ƒæ•°æ®ç»“æ„ 1.1 IKCPSEG æŠ¥æ–‡æ®µç»“æ„ struct IKCPSEG struct IQUEUEHEAD node; // é“¾è¡¨èŠ‚ç‚¹ IUINT32 conv; // ä¼šè¯ID IUINT32 cmd; // å‘½ä»¤ç±»å‹ IUINT32 frg; // åˆ†ç‰‡åºå· IUINT32 wnd; // çª—å£å¤§å° IUINT32 ts; // æ—¶é—´æˆ³ IUINT32 sn; // åºåˆ—å· IUINT32 una; // å¾…æ¥æ”¶çš„ä¸‹ä¸€ä¸ªåŒ…åºå· IUINT32 len; // æ•°æ®é•¿åº¦ IUINT32 resendts; // é‡ä¼ æ—¶é—´æˆ³ IUINT32 rto; // è¶…æ—¶é‡ä¼ æ—¶é—´ IUINT32 fastack; // å¿«é€Ÿé‡ä¼ è®¡æ•°å™¨ IUINT32 xmit; // ä¼ è¾“æ¬¡æ•° char data[1]; // æ•°æ®; 1.2 IKCPCB æ§åˆ¶å— struct IKCPCB // === åŸºç¡€é…ç½® === IUINT32 conv; // ä¼šè¯IDï¼Œç”¨äºæ ‡è¯†ä¸€ä¸ªä¼šè¯ IUINT32 mtu; // æœ€å¤§ä¼ è¾“å•å…ƒï¼Œé»˜è®¤1400å­—èŠ‚ IUINT32 mss; // æœ€å¤§æŠ¥æ–‡æ®µå¤§å°ï¼Œé»˜è®¤mtu-24å­—èŠ‚ IUINT32 state; // è¿æ¥çŠ¶æ€ï¼Œ0=æ­£å¸¸ï¼Œ-1=æ–­å¼€ // === å‘é€å’Œæ¥æ”¶åºå· === IUINT32 snd_una; // ç¬¬ä¸€ä¸ªæœªç¡®è®¤çš„åŒ…åºå· IUINT32 snd_nxt; // ä¸‹ä¸€ä¸ªå¾…å‘é€çš„åŒ…åºå· IUINT32 rcv_nxt; // å¾…æ¥æ”¶çš„ä¸‹ä¸€ä¸ªåŒ…åºå· // === æ—¶é—´æˆ³ç›¸å…³ === IUINT32 ts_recent; // æœ€è¿‘ä¸€æ¬¡æ”¶åˆ°åŒ…çš„æ—¶é—´æˆ³ IUINT32 ts_lastack; // æœ€è¿‘ä¸€æ¬¡æ”¶åˆ°ACKçš„æ—¶é—´æˆ³ IUINT32 ssthresh; // æ…¢å¯åŠ¨é˜ˆå€¼ï¼Œé»˜è®¤ä¸ºIKCP_THRESH_INIT(2) // === RTTç›¸å…³ === IINT32 rx_rttval; // RTTçš„å˜åŒ–é‡ IINT32 rx_srtt; // å¹³æ»‘åçš„RTT IINT32 rx_rto; // è¶…æ—¶é‡ä¼ æ—¶é—´ï¼Œåˆå§‹ä¸ºIKCP_RTO_DEF(200ms) IINT32 rx_minrto; // æœ€å°é‡ä¼ è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸ºIKCP_RTO_MIN(100ms) // === çª—å£ç›¸å…³ === IUINT32 snd_wnd; // å‘é€çª—å£å¤§å°ï¼Œé»˜è®¤32 IUINT32 rcv_wnd; // æ¥æ”¶çª—å£å¤§å°ï¼Œé»˜è®¤128 IUINT32 rmt_wnd; // è¿œç«¯çª—å£å¤§å°ï¼Œé»˜è®¤128 IUINT32 cwnd; // æ‹¥å¡çª—å£å¤§å°ï¼Œåˆå§‹ä¸º0 IUINT32 probe; // æ¢æµ‹æ ‡å¿—ï¼Œç”¨äºçª—å£æ¢æµ‹ // === æ—¶é—´ç›¸å…³ === IUINT32 current; // å½“å‰æ—¶é—´ IUINT32 interval; // å†…éƒ¨æ›´æ–°æ—¶é—´é—´éš”ï¼Œé»˜è®¤100ms IUINT32 ts_flush; // ä¸‹æ¬¡åˆ·æ–°æ—¶é—´ IUINT32 xmit; // æ€»é‡ä¼ æ¬¡æ•° // === é˜Ÿåˆ—è®¡æ•°å™¨ === IUINT32 nrcv_buf; // æ¥æ”¶ç¼“å­˜ä¸­çš„åŒ…æ•°é‡ IUINT32 nsnd_buf; // å‘é€ç¼“å­˜ä¸­çš„åŒ…æ•°é‡ IUINT32 nrcv_que; // æ¥æ”¶é˜Ÿåˆ—ä¸­çš„åŒ…æ•°é‡ IUINT32 nsnd_que; // å‘é€é˜Ÿåˆ—ä¸­çš„åŒ…æ•°é‡ // === é…ç½®æ ‡å¿— === IUINT32 nodelay; // æ˜¯å¦å¯ç”¨nodelayæ¨¡å¼ï¼Œ0=ä¸å¯ç”¨ IUINT32 updated; // æ˜¯å¦è°ƒç”¨è¿‡update // === æ¢æµ‹ç›¸å…³ === IUINT32 ts_probe; // ä¸‹æ¬¡æ¢æµ‹æ—¶é—´ IUINT32 probe_wait; // æ¢æµ‹ç­‰å¾…æ—¶é—´ // === é“¾è·¯æ§åˆ¶ === IUINT32 dead_link; // æœ€å¤§é‡ä¼ æ¬¡æ•°ï¼Œé»˜è®¤ä¸ºIKCP_DEADLINK(20) IUINT32 incr; // å¯å‘é€çš„æœ€å¤§æ•°æ®é‡ // === æ•°æ®é˜Ÿåˆ— === struct IQUEUEHEAD snd_queue; // å‘é€é˜Ÿåˆ— struct IQUEUEHEAD rcv_queue; // æ¥æ”¶é˜Ÿåˆ— struct IQUEUEHEAD snd_buf; // å‘é€ç¼“å­˜ struct IQUEUEHEAD rcv_buf; // æ¥æ”¶ç¼“å­˜ // === ACKç›¸å…³ === IUINT32 *acklist; // ACKåˆ—è¡¨ IUINT32 ackcount; // ACKæ•°é‡ IUINT32 ackblock; // ACKåˆ—è¡¨å¤§å° // === ç”¨æˆ·ç›¸å…³ === void *user; // ç”¨æˆ·æ•°æ®æŒ‡é’ˆ char *buffer; // ä¸´æ—¶ç¼“å­˜ // === å¿«é€Ÿé‡ä¼ ç›¸å…³ === int fastresend; // è§¦å‘å¿«é€Ÿé‡ä¼ çš„é‡å¤ACKä¸ªæ•° int fastlimit; // å¿«é€Ÿé‡ä¼ æ¬¡æ•°é™åˆ¶ï¼Œé»˜è®¤IKCP_FASTACK_LIMIT(5) // === å…¶ä»–é…ç½® === int nocwnd; // æ˜¯å¦å…³é—­æ‹¥å¡æ§åˆ¶ï¼Œ0=ä¸å…³é—­ int stream; // æ˜¯å¦ä¸ºæµæ¨¡å¼ï¼Œ0=æ¶ˆæ¯æ¨¡å¼(é»˜è®¤)ï¼Œ1=æµæ¨¡å¼ int logmask; // æ—¥å¿—æ©ç ï¼Œæ§åˆ¶æ—¥å¿—è¾“å‡ºçº§åˆ« // === å›è°ƒå‡½æ•° === // æ•°æ®è¾“å‡ºå›è°ƒï¼Œç”¨äºå‘é€æ•°æ® int (*output)(const char *buf, int len, struct IKCPCB *kcp, void *user); // æ—¥å¿—è¾“å‡ºå›è°ƒ void (*writelog)(const char *log, struct IKCPCB *kcp, void *user);; è¿™ä¸ªç»“æ„ä½“å¯ä»¥å¤§è‡´åˆ†ä¸ºå‡ ä¸ªä¸»è¦éƒ¨åˆ†ï¼š åŸºç¡€é…ç½®ï¼šåŒ…å«åŸºæœ¬çš„ä¼šè¯æ ‡è¯†å’Œä¼ è¾“å•å…ƒå¤§å°è®¾ç½® åºå·è¿½è¸ªï¼šç”¨äºè¿½è¸ªå‘é€å’Œæ¥æ”¶çš„åŒ…åºå· æ—¶é—´ç®¡ç†ï¼šåŒ…å«å„ç§æ—¶é—´æˆ³å’Œå®šæ—¶å™¨ çª—å£æ§åˆ¶ï¼šå®ç°æµé‡æ§åˆ¶å’Œæ‹¥å¡æ§åˆ¶ é˜Ÿåˆ—ç®¡ç†ï¼šç®¡ç†æ•°æ®çš„å‘é€å’Œæ¥æ”¶ ACK å¤„ç†ï¼šå¤„ç†ç¡®è®¤åŒ… é…ç½®é€‰é¡¹ï¼šå„ç§åŠŸèƒ½å¼€å…³å’Œå‚æ•°è®¾ç½® å›è°ƒå‡½æ•°ï¼šç”¨äºæ•°æ®è¾“å‡ºå’Œæ—¥å¿—è®°å½• 2. æ ¸å¿ƒå‡½æ•° åœ¨è¿›å…¥å…·ä½“çš„æ ¸å¿ƒå‡½æ•°åˆ†æä¹‹å‰ï¼Œéœ€è¦å…ˆç‚¹æ˜ 2 ç‚¹ï¼Œkcp çš„å®ç°è€…æœŸæœ›å…¶å°½å¯èƒ½åœ°ç®€å•å’Œå‡å°‘ä¾èµ–ï¼Œæ‰€ä»¥æ•°æ®çš„è¾“å‡ºç”šè‡³æ˜¯å½“å‰æ—¶é—´éƒ½æ˜¯ç”±ä½¿ç”¨è€…æ¥è®¾ç½®çš„ï¼Œå³ kcp æœ¬èº«æ˜¯ä¸ä¾èµ–äºæœºå™¨æ—¶é’Ÿçš„ã€‚å…·ä½“ä½“ç°åœ¨ä¸‹é¢ 2 ä¸ªå‡½æ•°ï¼š //---------------------------------------------------------------------// set output callback, which will be invoked by kcp//---------------------------------------------------------------------void ikcp_setoutput(ikcpcb *kcp, int (*output)(const char *buf, int len,\tikcpcb *kcp, void *user))\tkcp-output = output;//---------------------------------------------------------------------// update state (call it repeatedly, every 10ms-100ms), or you can ask// ikcp_check when to call it again (without ikcp_input/_send calling).// current - current timestamp in millisec.//---------------------------------------------------------------------void ikcp_update(ikcpcb *kcp, IUINT32 current) ... 2.1 ikcp_send å‘é€æ•°æ® ikcp_send æ˜¯åº”ç”¨å±‚æ¥å£ï¼Œè´Ÿè´£å°†ç”¨æˆ·æ•°æ®åˆ†ç‰‡å¹¶åŠ å…¥åˆ°å‘é€é˜Ÿåˆ—ï¼ˆsnd_queueï¼‰ã€‚ ikcp_send //---------------------------------------------------------------------// user/upper level send, returns below zero for error//---------------------------------------------------------------------int ikcp_send(ikcpcb *kcp, const char *buffer, int len)\tIKCPSEG *seg;\tint count, i;\tint sent = 0;\t// mtu: æœ€å¤§ä¼ è¾“å•å…ƒ\t// mss: æœ€å¤§æŠ¥æ–‡æ®µå¤§å°\t// mss = mtu - åŒ…å¤´é•¿åº¦(24)\tassert(kcp-mss 0);\tif (len 0) return -1;\t// append to previous segment in streaming mode (if possible)\t// å¦‚æœæ˜¯æµæ¨¡å¼ï¼Œåˆ™å°†æ•°æ®è¿½åŠ åˆ°å‰ä¸€ä¸ªåˆ†æ®µä¸­ï¼ˆå¦‚æœå¯èƒ½ï¼‰\tif (kcp-stream != 0) // å¦‚æœå½“å‰å‘é€é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œä¸”å‰ä¸€ä¸ªåˆ†æ®µæœªæ»¡ï¼Œåˆ™å°†æ•°æ®è¿½åŠ åˆ°å‰ä¸€ä¸ªåˆ†æ®µä¸­ if (!iqueue_is_empty(kcp-snd_queue)) IKCPSEG *old = iqueue_entry(kcp-snd_queue.prev, IKCPSEG, node); if (old-len kcp-mss) int capacity = kcp-mss - old-len; int extend = (len capacity)? len : capacity; seg = ikcp_segment_new(kcp, old-len + extend); assert(seg); if (seg == NULL) return -2; // å°†æ–°çš„ seg-node æ”¾å…¥ snd_queue ä¸­ç­‰å¾…å‘é€ iqueue_add_tail(seg-node, kcp-snd_queue); // æŠŠä¸Šä¸€ä¸ªæŠ¥æ–‡çš„æ•°æ®æ‹·è´è¿‡æ¥ memcpy(seg-data, old-data, old-len); if (buffer) memcpy(seg-data + old-len, buffer, extend); buffer += extend; seg-len = old-len + extend; seg-frg = 0; len -= extend; iqueue_del_init(old-node); // é‡Šæ”¾ä¹‹å‰è€æ•°æ®çš„ kcp node ikcp_segment_delete(kcp, old); sent = extend; if (len = 0) return sent; // 1. éæµæ¨¡å¼ï¼Œä¸è¿½åŠ åˆ°ä¸Šä¸€ä¸ªæŠ¥æ–‡åé¢\t// 2. æµæ¨¡å¼ï¼Œä½†æ˜¯ä¸Šä¸€ä¸ªæŠ¥æ–‡å·²æ»¡ï¼Œåˆ™åˆ›å»ºæ–°çš„æŠ¥æ–‡\t// è®¡ç®—éœ€è¦çš„æŠ¥æ–‡æ•°é‡ï¼Œkcp ä¼šå¯¹æ•°æ®è¿›è¡Œåˆ†æ®µä¼ è¾“\tif (len = (int)kcp-mss) count = 1;\telse count = (len + kcp-mss - 1) / kcp-mss;\t// æ¥æ”¶çª—å£ä½ç½®ä¸å¤Ÿï¼Œåˆ™æš‚åœå‘é€\tif (count = (int)IKCP_WND_RCV) if (kcp-stream != 0 sent 0) return sent; return -2; if (count == 0) count = 1;\t// å‘é€æ‰€æœ‰çš„æŠ¥æ–‡æ®µ\tfor (i = 0; i count; i++) int size = len (int)kcp-mss ? (int)kcp-mss : len; seg = ikcp_segment_new(kcp, size); assert(seg); if (seg == NULL) return -2; if (buffer len 0) memcpy(seg-data, buffer, size); seg-len = size; seg-frg = (kcp-stream == 0)? (count - i - 1) : 0; iqueue_init(seg-node); // å°†æŠ¥æ–‡æ®µæ”¾å…¥ snd_queue ä¸­ iqueue_add_tail(seg-node, kcp-snd_queue); kcp-nsnd_que++; if (buffer) buffer += size; len -= size; sent += size; return sent; 2.2 ikcp_input æ¥æ”¶æ•°æ® ikcp_input è´Ÿè´£å¤„ç†ä»ç½‘ç»œæ¥æ”¶åˆ°çš„åŸå§‹ KCP æ•°æ®åŒ…ï¼Œå®ƒä¼šå¤„ç†åè®®å±‚é¢çš„æ•°æ®ï¼ŒåŒ…æ‹¬ ACKã€çª—å£æ§åˆ¶ç­‰åè®®ä¿¡æ¯ï¼Œå¹¶å°†æ¥æ”¶åˆ°çš„æ•°æ®æ”¾å…¥ KCP çš„å†…éƒ¨æ¥æ”¶ç¼“å†²åŒºï¼ˆrcv_buf å’Œ rcv_queueï¼‰ã€‚ 2.3 ikcp_recv è·å–æ•°æ® ikcp_recv æ˜¯åº”ç”¨å±‚å‡½æ•°ï¼Œä¾›ä¸Šå±‚åº”ç”¨è°ƒç”¨ä»¥è·å–å®Œæ•´çš„æ¶ˆæ¯æ•°æ®ï¼Œå®ƒä» KCP çš„æ¥æ”¶é˜Ÿåˆ—(rcv_queue)ä¸­è¯»å–å·²ç»æ’åºå¥½çš„æ•°æ®ï¼Œå¤„ç†åˆ†ç‰‡é‡ç»„ï¼Œç¡®ä¿è¿”å›å®Œæ•´çš„æ¶ˆæ¯ã€‚ ikcp_recv //---------------------------------------------------------------------// user/upper level recv: returns size, returns below zero for EAGAIN// ä» rcv_queue ä¸­è·å–æ•°æ®//---------------------------------------------------------------------int ikcp_recv(ikcpcb *kcp, char *buffer, int len)\tstruct IQUEUEHEAD *p;\tint ispeek = (len 0)? 1 : 0;\tint peeksize;\tint recover = 0;\tIKCPSEG *seg;\tassert(kcp);\t// å¦‚æœ rcv_queue ä¸ºç©ºï¼Œåˆ™ç›´æ¥è¿”å›\tif (iqueue_is_empty(kcp-rcv_queue)) return -1;\t// å¦‚æœ len 0ï¼Œåˆ™è¯´æ˜æ˜¯ peek æ“ä½œï¼Œå‡†å¤‡åªæŸ¥çœ‹æ•°æ®\tif (len 0) len = -len;\t// è®¡ç®— rcv_queue ä¸­æ•°æ®çš„å¤§å°\tpeeksize = ikcp_peeksize(kcp);\t// æ— æ³•è·å¾—å¤§å°ï¼Œè¿”å› -2\tif (peeksize 0) return -2;\t// æ•°æ®è¿‡å¤§ï¼Œè¿”å› -3\tif (peeksize len) return -3;\t// nrcv_que: rcv_queue çš„é•¿åº¦\t// rcv_wnd: æ¥æ”¶çª—å£çš„å¤§å°\t// å¦‚æœ nrcv_que = rcv_wndï¼Œåˆ™éœ€è¦è¿›è¡Œå¿«æ¢å¤\t// å› ä¸º nrcv_que = rcv_wndï¼Œè¯´æ˜æ¥æ”¶çª—å£å·²ç»æ»¡äº†ï¼Œ\t// è¿™ä¸ªæ—¶å€™éœ€è¦å‘é€ IKCP_CMD_WINS å‘Šè¯‰å‘é€æ–¹çª—å£å¤§å°ï¼Œ\t// è¿™ä¸ªæ—¶å€™å‘é€æ–¹éœ€è¦è¿›è¡Œå¿«æ¢å¤ï¼Œå‡å°æ•°æ®ä¼ è¾“ï¼Œä»¥å°½å¿«é‡Šæ”¾æ¥æ”¶çª—å£\tif (kcp-nrcv_que = kcp-rcv_wnd) recover = 1;\t// merge fragment\t// å°†å¤šä¸ªç‰‡æ®µåˆå¹¶æˆä¸€ä¸ªå®Œæ•´çš„ç‰‡æ®µ\t// åˆå¹¶åï¼Œå°†åˆå¹¶åçš„ç‰‡æ®µä» rcv_queue ä¸­åˆ é™¤\tfor (len = 0, p = kcp-rcv_queue.next; p != kcp-rcv_queue; ) int fragment; seg = iqueue_entry(p, IKCPSEG, node); p = p-next; if (buffer) memcpy(buffer, seg-data, seg-len); buffer += seg-len; len += seg-len; fragment = seg-frg; if (ikcp_canlog(kcp, IKCP_LOG_RECV)) ikcp_log(kcp, IKCP_LOG_RECV, recv sn=%lu, (unsigned long)seg-sn); if (ispeek == 0) iqueue_del(seg-node); ikcp_segment_delete(kcp, seg); kcp-nrcv_que--; if (fragment == 0) break; assert(len == peeksize);\t// move available data from rcv_buf - rcv_queue\t// å°è¯•å°† rcv_buf ä¸­ç¼–å·è¿ç»­çš„æ•°æ®ï¼Œç§»åŠ¨åˆ° rcv_queue ä¸­\t// ç§»åŠ¨åï¼Œå°†ç§»åŠ¨çš„æ•°æ®ä» rcv_buf ä¸­åˆ é™¤\twhile (! iqueue_is_empty(kcp-rcv_buf)) seg = iqueue_entry(kcp-rcv_buf.next, IKCPSEG, node); if (seg-sn == kcp-rcv_nxt kcp-nrcv_que kcp-rcv_wnd) iqueue_del(seg-node); kcp-nrcv_buf--; iqueue_add_tail(seg-node, kcp-rcv_queue); kcp-nrcv_que++; kcp-rcv_nxt++; else break; // å¿«æ¢å¤\tif (kcp-nrcv_que kcp-rcv_wnd recover) // åœ¨ikcp_flush ä¸­è¿”å› IKCP_CMD_WINS // é€šçŸ¥æœ¬æ®µçª—å£å¤§å°ç»™å¯¹ç«¯ kcp-probe |= IKCP_ASK_TELL; return len; 2.4 ikcp_update å®šæ—¶æ—¶é’Ÿ å‰é¢æˆ‘ä»¬çœ‹äº† ikcp_send ã€ikcp_input å’Œ ikcp_recv ä¸‰ä¸ªæ ¸å¿ƒæµç¨‹çš„å‡½æ•°ï¼Œå…¶ä¸­çš„ä¸€äº›ç»†èŠ‚ï¼Œä½ å¯ä»¥å›åˆ°æœ¬æ–‡å‰é¢çš„ã€ŒåŸç†åˆ†æã€å†å¯¹ç…§æºç ä»”ç»†é˜…è¯»ã€‚ åœ¨å‰é¢çš„åŸç†åˆ†æä¸­ï¼Œæˆ‘ä»¬æåˆ°ï¼Œä¸ºäº†æé«˜ä¼ è¾“å’Œå¤„ç†æ•°æ®çš„æ•ˆç‡ï¼Œkcp è®¾è®¡äº†é˜Ÿåˆ—å’Œç¼“å†²åŒºï¼ŒåŒæ—¶ä¸ºäº†å®ç°å¯é æ€§ï¼Œkcp ä¹Ÿæä¾›äº† ACK å’Œé‡è¯•ã€æ‹¥å¡æ§åˆ¶ç­‰æœºåˆ¶ï¼Œè¿™äº›äº‹æƒ…éƒ½æ˜¯å‘¨æœŸå®šæ—¶å»å¤„ç†çš„ã€‚è¿™é‡Œæ˜¯ç”± ikcp_update å‡½æ•°å»å¤„ç†çš„ã€‚ ikcp_update æ˜¯ KCP çš„å®šæ—¶å™¨å‡½æ•°ï¼Œè´Ÿè´£ä»¥å›ºå®šé—´éš”è°ƒç”¨ ikcp_flush å¤„ç†æ•°æ®å‘é€å’Œåè®®æ›´æ–°ï¼Œæ˜¯ KCP çš„\"å¿ƒè·³\"æœºåˆ¶ã€‚ //---------------------------------------------------------------------// update state (call it repeatedly, every 10ms-100ms), or you can ask// ikcp_check when to call it again (without ikcp_input/_send calling).// current - current timestamp in millisec.//---------------------------------------------------------------------void ikcp_update(ikcpcb *kcp, IUINT32 current)\tIINT32 slap;\tkcp-current = current;\tif (kcp-updated == 0) kcp-updated = 1; kcp-ts_flush = kcp-current; // è®¡ç®—é—´éš”\tslap = _itimediff(kcp-current, kcp-ts_flush);\tif (slap = 10000 || slap -10000) kcp-ts_flush = kcp-current; slap = 0; // è¾¾åˆ°è°ƒç”¨é—´éš”ï¼Œåˆ™æ‰§è¡Œ ikcp_flush è¿›è¡Œæ¥æ”¶æ•°æ®æˆ–å‘é€æ•°æ®\tif (slap = 0) kcp-ts_flush += kcp-interval; if (_itimediff(kcp-current, kcp-ts_flush) = 0) kcp-ts_flush = kcp-current + kcp-interval; ikcp_flush(kcp); è¿™ä¸ªå‡½æ•°å¾ˆç®€å•ï¼Œæ ¹æ®æ³¨é‡Šæ‰€è¯´ï¼Œé€šå¸¸æƒ…å†µä¸‹ä¼šæ¯ 10ms~100ms æ‰§è¡Œä¸€æ¬¡ï¼Œç„¶åæ ¸å¿ƒæ˜¯å»è°ƒç”¨ ikcp_flush å‡½æ•°ï¼Œæ‰€æœ‰çš„é€»è¾‘éƒ½åœ¨é‡Œé¢ã€‚ 2.5 ikcp_flush å®šæ—¶å¤„ç† å¦‚ä¸Šæ‰€è¿°ï¼Œikcp_flush æ˜¯ KCP çš„æ ¸å¿ƒå‘é€å‡½æ•°ï¼Œè´Ÿè´£å°†å‘é€é˜Ÿåˆ— snd_queue ä¸­çš„æ•°æ®ç§»å…¥å‘é€ç¼“å­˜ snd_buf å¹¶é€šè¿‡ output å›è°ƒå‘é€å‡ºå»ï¼ŒåŒæ—¶å¤„ç† ACK å‘é€ã€å¿«é€Ÿé‡ä¼ ã€è¶…æ—¶é‡ä¼ å’Œçª—å£æ¢æµ‹ç­‰åè®®ç»†èŠ‚ã€‚ ikcp_flush void ikcp_flush(ikcpcb *kcp)\tIUINT32 current = kcp-current;\t// å½“å‰æ—¶é—´\tchar *buffer = kcp-buffer; // ä¸´æ—¶ç¼“å†²åŒº\tchar *ptr = buffer;\tint count, size, i;\tIUINT32 resent, cwnd;\tIUINT32 rtomin;\tstruct IQUEUEHEAD *p;\tint change = 0; // æ˜¯å¦æ‰§è¡Œè¿‡å¿«é€Ÿé‡ä¼ \tint lost = 0; // æ˜¯å¦æ‰§è¡Œè¿‡è¶…æ—¶é‡ä¼ \tIKCPSEG seg;\t// æ£€æŸ¥æ˜¯å¦å·²è°ƒç”¨ ikcp_update\tif (kcp-updated == 0) return;\t// åˆå§‹åŒ–ä¸€ä¸ªæ®µç”¨äºæ„å»ºå„ç§æ§åˆ¶åŒ…\tseg.conv = kcp-conv; // è¿æ¥æ ‡è¯†\tseg.cmd = IKCP_CMD_ACK; // æŠ¥æ–‡ç±»å‹ï¼šIKCP_CMD_ACK è¡¨ç¤ºç¡®è®¤æŠ¥æ–‡\tseg.frg = 0; // åˆ†ç‰‡æ•°é‡ï¼Œè¡¨ç¤ºéšåè¿˜æœ‰å¤šå°‘ä¸ªæŠ¥æ–‡å±äºåŒä¸€ä¸ªåŒ…\tseg.wnd = ikcp_wnd_unused(kcp); // å‘é€æ–¹å‰©ä½™æ¥æ”¶çª—å£çš„å¤§å°\tseg.una = kcp-rcv_nxt; // å‘é€æ–¹çš„æ¥æ”¶ç¼“å†²åŒºä¸­æœ€å°è¿˜æœªæ”¶åˆ°çš„æŠ¥æ–‡æ®µçš„ç¼–å·ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç¼–å·æ¯”å®ƒå°çš„æŠ¥æ–‡æ®µéƒ½å·²å…¨éƒ¨æ¥æ”¶\tseg.len = 0; // æ•°æ®æ®µé•¿åº¦\tseg.sn = 0; // æŠ¥æ–‡ç¼–å·\tseg.ts = 0; // æ—¶é—´æˆ³\t// flush acknowledges\t// â‘  å‘é€ ACK é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ ACK\tcount = kcp-ackcount;\tfor (i = 0; i count; i++) size = (int)(ptr - buffer); // buffer ä¸­ç´¯è®¡çš„æ•°æ®å°†è¦è¶…è¿‡ mtu çš„æ—¶å€™ // å°±è°ƒç”¨ ikcp_output å°†æ•°æ®å‘é€å‡ºå» if (size + (int)IKCP_OVERHEAD (int)kcp-mtu) ikcp_output(kcp, buffer, size); ptr = buffer; // ä» ACK åˆ—è¡¨ä¸­å–å‡º sn(æŠ¥æ–‡ç¼–å·)å’Œ ts(æ—¶é—´æˆ³) ikcp_ack_get(kcp, i, seg.sn, seg.ts); // å°† ACK æŠ¥æ–‡å†™å…¥ buffer ptr = ikcp_encode_seg(ptr, seg); // â‘¡ ACK é˜Ÿåˆ—å·²æ¸…ç©º\tkcp-ackcount = 0;\t// probe window size (if remote window size equals zero)\t// å¯¹ç«¯å‰©ä½™æ¥æ”¶çª—å£å¤§å°ä¸º 0ï¼Œåˆ™æ„å‘³ç€å¯èƒ½éœ€è¦å‘é€çª—å£æ¢æµ‹æŠ¥æ–‡ï¼šIKCP_CMD_WASK\tif (kcp-rmt_wnd == 0) // æ ¹æ® ts_probe å’Œ probe_wait ç¡®å®šå½“å‰æ—¶åˆ»æ˜¯å¦éœ€è¦å‘é€æ¢æµ‹æŠ¥æ–‡ // probe_wait: ç­‰å¾…å‘é€æ¢æµ‹æŠ¥æ–‡çš„æ—¶é—´ï¼ŒIKCP_PROBE_INIT=7s, IKCP_PROBE_LIMIT= if (kcp-probe_wait == 0) kcp-probe_wait = IKCP_PROBE_INIT; // 7s åå»å‘æ¢æµ‹æŠ¥æ–‡ kcp-ts_probe = kcp-current + kcp-probe_wait; else if (_itimediff(kcp-current, kcp-ts_probe) = 0) if (kcp-probe_wait IKCP_PROBE_INIT) kcp-probe_wait = IKCP_PROBE_INIT; kcp-probe_wait += kcp-probe_wait / 2; if (kcp-probe_wait IKCP_PROBE_LIMIT) kcp-probe_wait = IKCP_PROBE_LIMIT; kcp-ts_probe = kcp-current + kcp-probe_wait; kcp-probe |= IKCP_ASK_SEND; // è®¾ç½®æ˜¯å¦éœ€è¦å»å‘é€ IKCP_ASK_SEND else kcp-ts_probe = 0; kcp-probe_wait = 0; // flush window probing commands\t// â‘¢ å¦‚æœéœ€è¦ï¼Œåˆ™å‘é€çª—å£æ¢æµ‹æŠ¥æ–‡ï¼šIKCP_CMD_WASK\tif (kcp-probe IKCP_ASK_SEND) seg.cmd = IKCP_CMD_WASK; size = (int)(ptr - buffer); if (size + (int)IKCP_OVERHEAD (int)kcp-mtu) ikcp_output(kcp, buffer, size); ptr = buffer; ptr = ikcp_encode_seg(ptr, seg); // flush window probing commands\t// â‘£ å¦‚æœéœ€è¦ï¼Œåˆ™å‘é€çª—å£é€šçŸ¥æŠ¥æ–‡ï¼šIKCP_CMD_WINS\tif (kcp-probe IKCP_ASK_TELL) seg.cmd = IKCP_CMD_WINS; size = (int)(ptr - buffer); if (size + (int)IKCP_OVERHEAD (int)kcp-mtu) ikcp_output(kcp, buffer, size); ptr = buffer; ptr = ikcp_encode_seg(ptr, seg); kcp-probe = 0;\t// calculate window size\t// â‘¤ è®¡ç®—å½“å‰çª—å£å¤§å°\tcwnd = _imin_(kcp-snd_wnd, kcp-rmt_wnd);\tif (kcp-nocwnd == 0) cwnd = _imin_(kcp-cwnd, cwnd);\t// move data from snd_queue to snd_buf\t// 5.1 å¦‚æœç¬¦åˆå‘é€çš„æ¡ä»¶ï¼Œåˆ™åˆ›å»ºæ–°çš„ newseg å¹¶æ”¾å…¥ snd_buf çš„å°¾éƒ¨\twhile (_itimediff(kcp-snd_nxt, kcp-snd_una + cwnd) 0) IKCPSEG *newseg; if (iqueue_is_empty(kcp-snd_queue)) break; newseg = iqueue_entry(kcp-snd_queue.next, IKCPSEG, node); iqueue_del(newseg-node); iqueue_add_tail(newseg-node, kcp-snd_buf); kcp-nsnd_que--; kcp-nsnd_buf++; newseg-conv = kcp-conv; newseg-cmd = IKCP_CMD_PUSH; newseg-wnd = seg.wnd; newseg-ts = current; newseg-sn = kcp-snd_nxt++; newseg-una = kcp-rcv_nxt; newseg-resendts = current; newseg-rto = kcp-rx_rto; newseg-fastack = 0; newseg-xmit = 0; // calculate resent\t// å¤±åºå¤šå°‘æ¬¡å°±å¿«é€Ÿé‡ä¼ ã€‚å¦‚æœ fastresend å¤§äº 0ï¼Œåˆ™å–å…¶å€¼ï¼›å¦åˆ™ï¼Œè®¾ä¸ºæœ€å¤§å€¼ 0xffffffffã€‚\tresent = (kcp-fastresend 0)? (IUINT32)kcp-fastresend : 0xffffffff;\t// æœ€å°è¶…æ—¶é‡ä¼ æ—¶é—´ã€‚å¦‚æœ nodelay ä¸º 0ï¼Œåˆ™ä¸º rx_rto çš„å…«åˆ†ä¹‹ä¸€ï¼Œå¦åˆ™ä¸º 0ã€‚\trtomin = (kcp-nodelay == 0)? (kcp-rx_rto 3) : 0;\t// flush data segments\tfor (p = kcp-snd_buf.next; p != kcp-snd_buf; p = p-next) // ä» snd_buf å–å‡ºä¸€ä¸ªæŠ¥æ–‡ IKCPSEG *segment = iqueue_entry(p, IKCPSEG, node); int needsend = 0; // æ¡ä»¶1ï¼šç¬¬ä¸€æ¬¡å‘é€çš„æŠ¥æ–‡ï¼Œç›´æ¥å‘é€ if (segment-xmit == 0) // è¯¥æŠ¥æ–‡çš„ xmit ä¼ è¾“æ¬¡æ•° needsend = 1; segment-xmit++; segment-rto = kcp-rx_rto; segment-resendts = current + segment-rto + rtomin; else if (_itimediff(current, segment-resendts) = 0) // æ¡ä»¶2ï¼šä¸”é‡ä¼ æ—¶é—´åˆ°äº†ï¼Œåˆ™é‡ä¼  needsend = 1; segment-xmit++; kcp-xmit++; if (kcp-nodelay == 0) segment-rto += _imax_(segment-rto, (IUINT32)kcp-rx_rto); else IINT32 step = (kcp-nodelay 2)? ((IINT32)(segment-rto)) : kcp-rx_rto; segment-rto += step / 2; segment-resendts = current + segment-rto; lost = 1; else if (segment-fastack = resent) // æ¡ä»¶3ï¼šè¾¾åˆ°å¿«é€Ÿé‡ä¼ æ¬¡æ•°ï¼Œåˆ™é‡ä¼  if ((int)segment-xmit = kcp-fastlimit || kcp-fastlimit = 0) needsend = 1; segment-xmit++; segment-fastack = 0; segment-resendts = current + segment-rto; change++; if (needsend) int need; segment-ts = current; segment-wnd = seg.wnd; segment-una = kcp-rcv_nxt; size = (int)(ptr - buffer); need = IKCP_OVERHEAD + segment-len; if (size + need (int)kcp-mtu) ikcp_output(kcp, buffer, size); ptr = buffer; ptr = ikcp_encode_seg(ptr, segment); if (segment-len 0) memcpy(ptr, segment-data, segment-len); ptr += segment-len; // å¦‚æœæŸä¸ªæ•°æ®åŒ…çš„é‡ä¼ æ¬¡æ•°è¶…è¿‡é˜ˆå€¼ï¼Œåˆ™æ ‡è®°è¿æ¥æ–­å¼€ã€‚ if (segment-xmit = kcp-dead_link) kcp-state = (IUINT32)-1; // flash remain segments\tsize = (int)(ptr - buffer);\tif (size 0) ikcp_output(kcp, buffer, size); // update ssthresh\t// 1. å¦‚æœå‘ç”Ÿäº†å¿«é€Ÿé‡ä¼ ï¼Œè®© ssthresh å‡åŠï¼Œè¿›å…¥å¿«æ¢å¤\tif (change) IUINT32 inflight = kcp-snd_nxt - kcp-snd_una; kcp-ssthresh = inflight / 2; if (kcp-ssthresh IKCP_THRESH_MIN) kcp-ssthresh = IKCP_THRESH_MIN; kcp-cwnd = kcp-ssthresh + resent; kcp-incr = kcp-cwnd * kcp-mss; // 2. å¦‚æœå‘ç”Ÿäº†è¶…æ—¶é‡ä¼ ï¼Œåˆ™è®© ssthresh å‡åŠï¼Œç„¶å cwnd = 1ï¼Œè¿›å…¥æ…¢å¯åŠ¨\tif (lost) kcp-ssthresh = cwnd / 2; if (kcp-ssthresh IKCP_THRESH_MIN) kcp-ssthresh = IKCP_THRESH_MIN; kcp-cwnd = 1; kcp-incr = kcp-mss; // å…œåº•ï¼Œcwnd è‡³å°‘ä¸º 1\tif (kcp-cwnd 1) kcp-cwnd = 1; kcp-incr = kcp-mss; å‚è€ƒ KCP repo è¯¦è§£ KCP åè®®çš„åŸç†å’Œå®ç°","tags":["KCP","TCP","ç½‘ç»œ"],"categories":["è®¡ç®—æœºåŸºç¡€","è®¡ç®—æœºç½‘ç»œ"]},{"title":"Rust å…¥é—¨ä¸¨01 ç±»å‹ç³»ç»Ÿæ¦‚è¿°","path":"/2024/11/28/rust-01-type-system/","content":"åœ¨ Rust ç¼–ç¨‹ä¸–ç•Œä¸­ï¼Œç»å¤§éƒ¨åˆ†çš„ç‰¹æ€§å’Œèƒ½åŠ›éƒ½ç¦»ä¸å¼€ Rust å¼ºå¤§çš„ç±»å‹ç³»ç»Ÿï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªç³»åˆ—çš„ç¬¬ 1 ç¯‡æˆ‘ä»¬å…ˆæ¥å¯¹ Rust çš„ç±»å‹ç³»ç»Ÿåšä¸€ä¸ªå…¨å±€æ¦‚è¿°ï¼Œå¸Œæœ›å¯ä»¥å¸®åŠ©ä½ å»ºç«‹èµ·å¯¹ Rust çš„åŸºæœ¬å°è±¡ã€‚åœ¨åç»­çš„å®è·µè¿‡ç¨‹ä¸­ï¼Œæˆ‘æ¨èä½ å¯ä»¥ç»å¸¸å›æ¥æ€è€ƒä¸‹ä¸ºä»€ä¹ˆ Rust è¦æ„å»ºè¿™æ ·çš„ç±»å‹ç³»ç»Ÿï¼Œåœ¨æ¯ä¸€ä¸ªåˆ†æ”¯ç‚¹æ˜¯å¦‚ä½•åšå‡ºå†³ç­–çš„ï¼Œè¿™äº›å†³ç­–åˆä½“ç°åœ¨ä»£ç çš„å“ªäº›åœ°æ–¹ã€‚ç›¸ä¿¡è¿™æ ·å¯ä»¥å¸®åŠ©ä½ æ›´å¥½åœ°å…¥é—¨ Rustã€‚ åºŸè¯ä¸å¤šè¯´ï¼Œè¿›å…¥æ­£æ–‡ã€‚ ä»€ä¹ˆæ˜¯ç±»å‹ç³»ç»Ÿï¼Ÿ åœ¨è¿›å…¥ Rust ç±»å‹ç³»ç»Ÿè®¨è®ºä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå°è¯•å åœ¨æ›´é«˜çš„è§’åº¦ï¼Œå³æ•´ä¸ªç¼–ç¨‹è¯­è¨€ç•Œçš„è§’åº¦å»æ€è€ƒï¼Œä»€ä¹ˆæ˜¯ç±»å‹ç³»ç»Ÿï¼Ÿ ç¼–ç¨‹è¯­è¨€çš„ç±»å‹ç³»ç»Ÿæ˜¯æŒ‡ä¸€å¥—è§„åˆ™ï¼Œç”¨äºå®šä¹‰å’Œç®¡ç†ç¨‹åºä¸­æ•°æ®çš„ç±»å‹ã€‚ç±»å‹ç³»ç»Ÿçš„ä¸»è¦ç›®çš„æ˜¯å¸®åŠ©æ•è·ç¨‹åºä¸­çš„é”™è¯¯ï¼Œæé«˜ä»£ç çš„å¯é æ€§å’Œå¯è¯»æ€§ã€‚ ç±»å‹ç³»ç»Ÿå¯ä»¥æ ¹æ®å¤šç§ç‰¹æ€§è¿›è¡Œåˆ†ç±»ï¼Œä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š é™æ€ç±»å‹å’ŒåŠ¨æ€ç±»å‹ï¼š é™æ€ç±»å‹ï¼šåœ¨ç¼–è¯‘æ—¶æ£€æŸ¥å˜é‡ç±»å‹ã€‚ä¾‹å¦‚ï¼ŒJavaã€C++ å’Œ Haskell éƒ½æ˜¯é™æ€ç±»å‹è¯­è¨€ã€‚åœ¨è¿™äº›è¯­è¨€ä¸­ï¼Œå˜é‡çš„ç±»å‹å¿…é¡»åœ¨ç¼–è¯‘æ—¶ç¡®å®šï¼Œè¿™æ ·å¯ä»¥åœ¨ç¼–è¯‘é˜¶æ®µæ•è·è®¸å¤šç±»å‹é”™è¯¯ã€‚ åŠ¨æ€ç±»å‹ï¼šåœ¨è¿è¡Œæ—¶æ£€æŸ¥å˜é‡ç±»å‹ã€‚ä¾‹å¦‚ï¼ŒPythonã€Ruby å’Œ JavaScript æ˜¯åŠ¨æ€ç±»å‹è¯­è¨€ã€‚åœ¨è¿™äº›è¯­è¨€ä¸­ï¼Œå˜é‡çš„ç±»å‹æ˜¯åœ¨ç¨‹åºè¿è¡Œæ—¶ç¡®å®šçš„ï¼Œè¿™æä¾›äº†æ›´å¤§çš„çµæ´»æ€§ï¼Œä½†ä¹Ÿå¯èƒ½å¯¼è‡´è¿è¡Œæ—¶é”™è¯¯ã€‚ å¼ºç±»å‹å’Œå¼±ç±»å‹ï¼š å¼ºç±»å‹ï¼šä¸¥æ ¼é™åˆ¶ä¸åŒç±»å‹ä¹‹é—´çš„æ“ä½œã€‚ä¾‹å¦‚ï¼ŒPython å’Œ Java æ˜¯å¼ºç±»å‹è¯­è¨€ã€‚å¼ºç±»å‹ç³»ç»Ÿé€šå¸¸ä¸å…è®¸éšå¼ç±»å‹è½¬æ¢ï¼Œè¿™æ„å‘³ç€åœ¨è¿›è¡Œä¸åŒç±»å‹ä¹‹é—´çš„æ“ä½œæ—¶ï¼Œå¿…é¡»æ˜¾å¼åœ°è¿›è¡Œç±»å‹è½¬æ¢ã€‚ å¼±ç±»å‹ï¼šå…è®¸æ›´å¤šéšå¼ç±»å‹è½¬æ¢ã€‚ä¾‹å¦‚ï¼ŒJavaScript å’Œ Perl æ˜¯å¼±ç±»å‹è¯­è¨€ã€‚åœ¨è¿™äº›è¯­è¨€ä¸­ï¼Œç¼–è¯‘å™¨æˆ–è§£é‡Šå™¨ä¼šåœ¨éœ€è¦æ—¶è‡ªåŠ¨è¿›è¡Œç±»å‹è½¬æ¢ï¼Œè¿™å¯èƒ½å¯¼è‡´éš¾ä»¥é¢„æ–™çš„è¡Œä¸ºã€‚ æ˜¾å¼ç±»å‹å’Œéšå¼ç±»å‹ï¼š æ˜¾å¼ç±»å‹ï¼šç¨‹åºå‘˜å¿…é¡»æ˜ç¡®å£°æ˜æ¯ä¸ªå˜é‡çš„ç±»å‹ã€‚ä¾‹å¦‚ï¼ŒJava å’Œ C++ è¦æ±‚åœ¨å£°æ˜å˜é‡æ—¶æŒ‡å®šå…¶ç±»å‹ã€‚ éšå¼ç±»å‹ï¼šç¼–è¯‘å™¨æˆ–è§£é‡Šå™¨ä¼šæ ¹æ®ä¸Šä¸‹æ–‡è‡ªåŠ¨æ¨æ–­å˜é‡çš„ç±»å‹ã€‚ä¾‹å¦‚ï¼ŒPython å’Œ JavaScript ä½¿ç”¨éšå¼ç±»å‹ï¼Œç¨‹åºå‘˜ä¸éœ€è¦æ˜¾å¼å£°æ˜å˜é‡ç±»å‹ã€‚ å­ç±»å‹å’Œå¤šæ€ï¼š å­ç±»å‹ï¼šä¸€ç§ç±»å‹ç³»ç»Ÿå…è®¸ä¸€ç§ç±»å‹ä½œä¸ºå¦ä¸€ç§ç±»å‹çš„å­é›†ã€‚ä¾‹å¦‚ï¼Œåœ¨é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­ï¼Œå­ç±»æ˜¯çˆ¶ç±»çš„å­ç±»å‹ã€‚ å¤šæ€ï¼šå…è®¸ä¸€ä¸ªæ¥å£è¢«å¤šç§ä¸åŒç±»å‹å®ç°ã€‚å¤šæ€æ€§æœ‰å¤šç§å½¢å¼ï¼ŒåŒ…æ‹¬å‚æ•°å¤šæ€ï¼ˆå¦‚æ³›å‹ï¼‰å’Œå­ç±»å‹å¤šæ€ï¼ˆå¦‚ç»§æ‰¿ï¼‰ã€‚ ç±»å‹æ¨æ–­ï¼š ç±»å‹æ¨æ–­æ˜¯æŒ‡ç¼–è¯‘å™¨è‡ªåŠ¨ç¡®å®šè¡¨è¾¾å¼çš„ç±»å‹ï¼Œè€Œæ— éœ€æ˜ç¡®çš„ç±»å‹æ³¨é‡Šã€‚ä¾‹å¦‚ï¼ŒHaskell å’Œ Scala ä½¿ç”¨ç±»å‹æ¨æ–­æ¥å‡å°‘ç¨‹åºå‘˜çš„è´Ÿæ‹…ï¼ŒåŒæ—¶ä¿æŒé™æ€ç±»å‹çš„å®‰å…¨æ€§ã€‚ ä»£æ•°æ•°æ®ç±»å‹å’Œç±»å‹æ„é€ ï¼š ä»£æ•°æ•°æ®ç±»å‹ï¼ˆADTï¼‰æ˜¯é€šè¿‡ç»„åˆå…¶ä»–ç±»å‹æ¥æ„é€ æ–°ç±»å‹çš„æœºåˆ¶ï¼Œå¸¸è§äºå‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ï¼Œå¦‚ Haskell å’Œ OCamlã€‚ADT åŒ…æ‹¬äº§å“ç±»å‹ï¼ˆå¦‚å…ƒç»„ï¼‰å’Œå’Œç±»å‹ï¼ˆå¦‚æšä¸¾ï¼‰ã€‚ ç»“æ„ç±»å‹å’Œåä¹‰ç±»å‹ï¼š ç»“æ„ç±»å‹ï¼šåŸºäºå¯¹è±¡çš„ç»“æ„æ¥ç¡®å®šç±»å‹çš„å…¼å®¹æ€§ã€‚ä¾‹å¦‚ï¼ŒTypeScript å’Œ Go ä½¿ç”¨ç»“æ„ç±»å‹ç³»ç»Ÿã€‚ åä¹‰ç±»å‹ï¼šåŸºäºåç§°æ¥ç¡®å®šç±»å‹çš„å…¼å®¹æ€§ã€‚ä¾‹å¦‚ï¼ŒJava å’Œ C++ ä½¿ç”¨åä¹‰ç±»å‹ç³»ç»Ÿã€‚ è¿™é‡Œæˆ‘æ¢³ç†äº†ä¸€å¼ å›¾ï¼Œä¾›ä½ å‚è€ƒï¼š ç¼–ç¨‹è¯­è¨€ç±»å‹ç³»ç»Ÿ æ³¨ï¼šæœ¬å›¾å‚è€ƒäº†é™ˆå¤©è€å¸ˆåœ¨ Rust è®­ç»ƒè¥è¯¾ç¨‹ä¸Šæä¾›çš„æ•™æ¡ˆå¹¶è¿›è¡Œäº†å¢æ”¹ã€‚ Rust ç±»å‹ç³»ç»Ÿ Rust ä¸ºäº†åœ¨æä¾›é«˜æ€§èƒ½çš„åŒæ—¶ä¿è¯å†…å­˜å®‰å…¨å’Œçº¿ç¨‹å®‰å…¨ï¼ŒèŠ±äº†å¤§é‡åŠ›æ°”æ„å»ºäº†ä¸€ä¸ªå¼ºå¤§çš„ç±»å‹ç³»ç»Ÿã€‚ åŸºäºä¹‹å‰æåˆ°çš„ä¸ƒä¸ªæ–¹é¢ï¼Œæˆ‘ä»¬æ¥æ¢³ç†ä¸‹ Rust çš„ç±»å‹ç³»ç»Ÿï¼š é™æ€ç±»å‹ï¼šRust æ˜¯é™æ€ç±»å‹è¯­è¨€ï¼Œè¿™æ„å‘³ç€å˜é‡çš„ç±»å‹åœ¨ç¼–è¯‘æ—¶å°±è¢«ç¡®å®šã€‚è¿™ç§è®¾è®¡ä½¿å¾— Rust åœ¨ç¼–è¯‘é˜¶æ®µå°±å¯ä»¥æ•è·è®¸å¤šç±»å‹é”™è¯¯ï¼Œä»è€Œæé«˜ä»£ç çš„å®‰å…¨æ€§å’Œæ€§èƒ½ã€‚ fn main() let x: i32 = 10; // æ˜ç¡®æŒ‡å®šç±»å‹ å¼ºç±»å‹ï¼šRust æ˜¯å¼ºç±»å‹è¯­è¨€ï¼Œå®ƒä¸¥æ ¼é™åˆ¶ä¸åŒç±»å‹ä¹‹é—´çš„æ“ä½œã€‚Rust ä¸å…è®¸éšå¼ç±»å‹è½¬æ¢ï¼ˆä¾‹å¦‚ï¼Œä¸èƒ½è‡ªåŠ¨å°†æ•´æ•°è½¬æ¢ä¸ºæµ®ç‚¹æ•°ï¼‰ï¼Œéœ€è¦æ˜¾å¼åœ°ä½¿ç”¨ as è¿›è¡Œç±»å‹è½¬æ¢ã€‚è¿™ç§ä¸¥æ ¼æ€§æœ‰åŠ©äºé¿å…è®¸å¤šå¸¸è§çš„ç¼–ç¨‹é”™è¯¯ã€‚ fn main() let x: i32 = 5; let y: f64 = 10.0; // é”™è¯¯ï¼šä¸èƒ½å°† i32 éšå¼è½¬æ¢ä¸º f64 // let sum = x + y; // æ­£ç¡®ï¼šéœ€è¦æ˜¾å¼è½¬æ¢ let sum = x as f64 + y; println!(Sum = , sum); æ˜¾å¼ç±»å‹å’Œç±»å‹æ¨æ–­ï¼šè™½ç„¶ Rust æ˜¯æ˜¾å¼ç±»å‹è¯­è¨€ï¼Œè¦æ±‚åœ¨æŸäº›æƒ…å†µä¸‹å£°æ˜å˜é‡ç±»å‹ï¼Œä½†å®ƒä¹Ÿå…·æœ‰å¼ºå¤§çš„ç±»å‹æ¨æ–­èƒ½åŠ›ã€‚ç¼–è¯‘å™¨å¯ä»¥æ ¹æ®ä¸Šä¸‹æ–‡æ¨æ–­å‡ºå¤§å¤šæ•°å˜é‡çš„ç±»å‹ï¼Œå‡å°‘äº†ç¨‹åºå‘˜çš„è´Ÿæ‹…ã€‚ä¾‹å¦‚ï¼š let mut v = vec![];v.push(5u8); // ç»“åˆè¿™é‡Œï¼ŒRust ç¼–è¯‘å™¨å¯ä»¥æ¨æ–­å‡º v çš„ç±»å‹æ˜¯ Vecu8 å­ç±»å‹å’Œå¤šæ€ï¼šRust æ”¯æŒæ³›å‹å’Œ traitï¼Œè¿™æ˜¯ä¸€ç§å¤šæ€æ€§çš„å®ç°æ–¹å¼ã€‚trait ç±»ä¼¼äºæ¥å£ï¼Œå…è®¸å®šä¹‰ç±»å‹å¯ä»¥å®ç°çš„ä¸€ç»„æ–¹æ³•ã€‚æ³›å‹å…è®¸å®šä¹‰å‡½æ•°ã€ç»“æ„ä½“å’Œæšä¸¾æ—¶ä½¿ç”¨å ä½ç±»å‹ï¼Œä»è€Œå®ç°ä»£ç çš„é‡ç”¨å’Œçµæ´»æ€§ã€‚ // è¿™é‡Œ std::fmt::Display å°±æ˜¯ä¸€ä¸ª traitï¼Œç›®å‰ï¼Œä½ å¯ä»¥å…ˆç®€å•ç†è§£ä¸º trait å°±æ˜¯æ¥å£fn print_valueT: std::fmt::Display(value: T) println!(, value);fn main() print_value(42); // 42 é»˜è®¤ä¸º i32ï¼Œæ ‡å‡†åº“ä¸ºå…¶æ˜¯å®ç°äº† Display trait print_value(Hello, world!); // str ä¹Ÿå®ç°äº† Display trait ç±»å‹æ¨æ–­ï¼šRust çš„ç±»å‹æ¨æ–­ç³»ç»Ÿéå¸¸å¼ºå¤§ï¼Œèƒ½å¤Ÿæ ¹æ®ä»£ç ä¸Šä¸‹æ–‡è‡ªåŠ¨æ¨æ–­å˜é‡å’Œè¡¨è¾¾å¼çš„ç±»å‹ã€‚è¿™ä½¿å¾—ä»£ç æ›´ç®€æ´ï¼ŒåŒæ—¶ä¿æŒäº†ç±»å‹å®‰å…¨æ€§ã€‚ ä»£æ•°æ•°æ®ç±»å‹å’Œç±»å‹æ„é€ ï¼šRust æ”¯æŒä»£æ•°æ•°æ®ç±»å‹ï¼Œé€šè¿‡æšä¸¾ï¼ˆenumï¼‰å’Œç»“æ„ä½“ï¼ˆstructï¼‰æ¥å®ç°ã€‚æšä¸¾å…è®¸å®šä¹‰ä¸€ä¸ªç±»å‹ï¼Œè¯¥ç±»å‹å¯ä»¥æ˜¯å‡ ç§ä¸åŒçš„å˜ä½“ä¹‹ä¸€ï¼Œæ¯ä¸ªå˜ä½“å¯ä»¥æºå¸¦ä¸åŒçš„æ•°æ®ã€‚ enum OptionT Some(T), None, ç»“æ„ç±»å‹å’Œåä¹‰ç±»å‹ï¼šRust ä½¿ç”¨åä¹‰ç±»å‹ç³»ç»Ÿã€‚æ¯ä¸ªç±»å‹éƒ½æœ‰ä¸€ä¸ªæ˜¾å¼çš„åç§°ï¼Œç±»å‹çš„å…¼å®¹æ€§åŸºäºåç§°è€Œä¸æ˜¯ç»“æ„ã€‚è¿™æ„å‘³ç€å³ä½¿ä¸¤ä¸ªç»“æ„ä½“æœ‰ç›¸åŒçš„å­—æ®µï¼Œå®ƒä»¬ä¹Ÿè¢«è§†ä¸ºä¸åŒçš„ç±»å‹ï¼Œé™¤éé€šè¿‡ç‰¹å¾æˆ–æ˜¾å¼è½¬æ¢æ¥å®ç°å…¼å®¹æ€§ã€‚ é™¤æ­¤ä¹‹å¤–ï¼ŒRust çš„ç±»å‹ç³»ç»Ÿè¿˜æä¾›äº†å…¶ä»–éå¸¸å¼ºå¤§ä¸”æœ‰ç”¨çš„ç‰¹æ•ˆï¼Œå¦‚æ‰€æœ‰æƒå’Œå€Ÿç”¨ã€ç”Ÿå‘½å‘¨æœŸä»¥åŠæ¨¡å¼åŒ¹é…ã€‚ æ‰€æœ‰æƒå’Œå€Ÿç”¨ï¼ˆOwnership and Borrowingï¼‰ï¼š Rust çš„ç±»å‹ç³»ç»Ÿä¸å…¶æ‰€æœ‰æƒæ¨¡å‹ç´§å¯†ç»“åˆã€‚æ‰€æœ‰æƒæ¨¡å‹é€šè¿‡æ‰€æœ‰æƒã€å€Ÿç”¨å’Œç”Ÿå‘½å‘¨æœŸçš„æ¦‚å¿µæ¥ç®¡ç†å†…å­˜ï¼Œä»è€Œåœ¨æ— åƒåœ¾å›æ”¶å™¨çš„æƒ…å†µä¸‹ç¡®ä¿å†…å­˜å®‰å…¨ã€‚ fn main() let s = String::from(Hello); let len = calculate_length(s); // å€Ÿç”¨ println!(The length of is ., s, len);fn calculate_length(s: String) - usize s.len() ç”Ÿå‘½å‘¨æœŸï¼ˆLifetimesï¼‰ï¼š Rust ä½¿ç”¨ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨æ¥è·Ÿè¸ªå¼•ç”¨çš„æœ‰æ•ˆèŒƒå›´ï¼Œç¡®ä¿å¼•ç”¨åœ¨ä½¿ç”¨æ—¶å§‹ç»ˆæœ‰æ•ˆã€‚è¿™æ˜¯ Rust ç±»å‹ç³»ç»Ÿä¸­ä¸€ä¸ªç‹¬ç‰¹çš„ç‰¹æ€§ï¼Œå¸®åŠ©é˜²æ­¢æ‚¬ç©ºå¼•ç”¨å’Œæ•°æ®ç«äº‰ã€‚ fn longesta(x: a str, y: a str) - a str if x.len() y.len() x else y fn main() let string1 = String::from(long string is long); let string2 = xyz; let result = longest(string1.as_str(), string2); println!(The longest string is , result); æ¨¡å¼åŒ¹é…ï¼š Rust æä¾›å¼ºå¤§çš„æ¨¡å¼åŒ¹é…åŠŸèƒ½ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†æšä¸¾å’Œå¤æ‚æ•°æ®ç»“æ„æ—¶ï¼Œä½¿å¾—ä»£ç æ›´å…·è¡¨è¾¾åŠ›å’Œå®‰å…¨æ€§ã€‚ enum Message Quit, Move x: i32, y: i32 , Write(String), ChangeColor(i32, i32, i32),fn process_message(msg: Message) match msg Message::Quit = println!(Quit the application); Message::Move x, y = // æ¨¡å¼åŒ¹é…èƒ½æ ¹æ®æ•°æ®ç±»å‹ç›´æ¥æ‹†è§£å‡ºæ¥ï¼Œä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ println!(Move to coordinates: (, ), x, y); Message::Write(text) = println!(Text message: , text); Message::ChangeColor(r, g, b) = println!(Change color to RGB(, , ), r, g, b); Rust çš„ç±»å‹ç³»ç»Ÿé€šè¿‡ä¸Šè¿°ç‰¹æ€§å®ç°äº†é«˜æ•ˆã€å®‰å…¨å’Œçµæ´»çš„ç¼–ç¨‹æ¨¡å‹ï¼Œé€‚åˆç³»ç»Ÿç¼–ç¨‹å’Œé«˜æ€§èƒ½åº”ç”¨ã€‚å®ƒåœ¨ç¼–è¯‘æœŸæ•è·è®¸å¤šæ½œåœ¨é”™è¯¯ï¼Œä½¿å¾—è¿è¡Œæ—¶æ›´ä¸ºå®‰å…¨å¯é ã€‚ å½“ç„¶ï¼Œå¦‚æœä½ ä¹‹å‰æ²¡æœ‰å­¦ä¹ è¿‡ Rustï¼Œé‚£è¿™äº›æ¦‚å¿µå’Œä»£ç å¯¹ä½ æ¥è¯´å¤§æ¦‚ç‡æ˜¯äº‘é‡Œé›¾é‡Œï¼Œä¸è¦ç€æ€¥ï¼Œæˆ‘ä»¬å…ˆå»ºç«‹èµ·ä¸€ä¸ªå¤§æ¦‚çš„å°è±¡å°±è¡Œäº†ã€‚è¿™é‡Œæˆ‘é’ˆå¯¹ Rust ç±»å‹ç³»ç»Ÿæ¢³ç†äº†ä¸€å¼ å›¾ï¼Œä½ å¯ä»¥åœ¨ä»¥åçš„å­¦ä¹ ä¸­æ—¶å¸¸å›æ¥çœ‹çœ‹ï¼š Rust ç±»å‹ç³»ç»Ÿ æ³¨ï¼šæœ¬å›¾å‚è€ƒäº†é™ˆå¤©è€å¸ˆåœ¨ Rust è®­ç»ƒè¥è¯¾ç¨‹ä¸Šæä¾›çš„æ•™æ¡ˆå¹¶è¿›è¡Œäº†å¢æ”¹ã€‚ æœ¬ç¯‡å°±åˆ°è¿™é‡Œï¼Œä¸‹ç¯‡æˆ‘ä»¬å°†ä»‹ç» Rust çš„æ•°æ®ç±»å‹ï¼Œenjoy coding~","tags":["Rust"],"categories":["Rust","Rust å…¥é—¨"]},{"title":"Rust å…¥é—¨ä¸¨02 æ•°æ®ç±»å‹","path":"/2024/11/28/rust-02-data-type/","content":"ä¸Šæ–‡ä¸­ï¼Œæˆ‘ä»¬ç®€å•æ¢è®¨äº† Rust çš„ç±»å‹ç³»ç»Ÿï¼Œè¿™ä¸€ç¯‡æˆ‘ä»¬ç»§ç»­æ¥äº†è§£ Rust çš„æ•°æ®ç±»å‹ã€‚æˆ‘ç”»äº†ä¸€å¼  Rust åŸºç¡€çŸ¥è¯†å›¾è°±ï¼Œå¸Œæœ›å¯ä»¥å¸®åŠ©ä½ æ›´å¥½åœ°å®šä½å½“å‰æ‰€åœ¨çš„ä½ç½®ã€‚ mindmap root((Rust æ•°æ®ç±»å‹)) æ•°å€¼ç±»å‹ æ•´æ•° æœ‰ç¬¦å· i8/i16/i32/i64/i128/isize æ— ç¬¦å· u8/u16/u32/u64/u128/usize æµ®ç‚¹æ•° f32 f64 å¸ƒå°”å‹ bool å­—ç¬¦å‹ char å¤åˆç±»å‹ å…ƒç»„ Tuple æ•°ç»„ Array åˆ‡ç‰‡ Slice å­—ç¬¦ä¸² String str ç»“æ„ä½“ Struct æšä¸¾ Enum ç‰¹æ®Šç±»å‹ å•å…ƒç±»å‹ unit Neverç±»å‹ ! æŒ‡é’ˆç±»å‹ å¼•ç”¨ T åŸå§‹æŒ‡é’ˆ *const/*mut æ™ºèƒ½æŒ‡é’ˆ","tags":["Rust"],"categories":["Rust"]},{"title":"Rust è®­ç»ƒè¥æ€»ç»“ä¸¨ç¬¬ä¸‰æ¬¡å…¥é—¨ Rust","path":"/2024/11/26/rust-bootcamp/","content":"ç¼˜èµ· 2023 å¹´æˆ‘ç»™è‡ªå·±å®šäº†å¾ˆå¤šä¸ªç›®æ ‡ï¼Œæœ€ç»ˆçš„ç»“æœæ˜¯æ¯ä¸ªéƒ½åšäº†ä¸€äº›äº‹æƒ…ï¼Œä½†æ˜¯æ²¡æœ‰ä¸€ä¸ªæ˜¯åšå¾—æ¯”è¾ƒå½»åº•çš„ï¼Œå°è¯äº†ã€Šå­™å­å…µæ³•ã€‹çš„é‚£å¥ï¼šâ€œæ— æ‰€ä¸å¤‡ï¼Œåˆ™æ— æ‰€ä¸å¯¡â€ã€‚ åœ¨ 2023.10.23 å‡ºäºå¥½å¥‡ï¼Œæˆ‘è®¢é˜…äº†ã€ŠRust è¯­è¨€ä»å…¥é—¨åˆ°å®æˆ˜ã€‹çš„ä¸“æ ï¼Œè·Ÿç€è¯¾ç¨‹çš„æ›´æ–°èŠ‚å¥å­¦ä¹ å®Œäº†æ•´ä¸ªä¸“æ ã€‚ è™½ç„¶æˆ‘ç¬¬ä¸€æ¬¡å…¥é—¨ Rust å¤±è´¥äº†ï¼Œä½†ä¹Ÿè¢« Rust çš„ç§ç§ç‰¹æ€§æ‰€å¸å¼•ã€‚æˆ‘æ˜¯ä¸ªç‰¹åˆ«å–œæ¬¢â€œç—›è‹¦å‰ç½®â€çš„äººï¼Œè€Œ Rust ç¼–è¯‘å™¨\"çšçœ¦å¿…æŠ¥\"çš„ç¼–è¯‘å™¨æ£€æŸ¥æ­£ç»™äºˆäº†æˆ‘è¢«è™çš„çˆ½æ„Ÿï¼Œç¼–è¯‘é€šè¿‡åç¨‹åºçš„ç¨³å®šè¿è¡Œä¹Ÿç¬¦åˆæˆ‘è¿½æ±‚æˆä¸ºä¸€ä½â€œé è°±â€å·¥ç¨‹å¸ˆçš„æ„¿æ™¯ã€‚ åŠ ä¹‹æˆ‘çš„ä¸»åŠ›è¯­è¨€æ˜¯ Goï¼Œä¸€é—¨åº”ç”¨ç¼–ç¨‹è¯­è¨€ï¼Œæ‰€ä»¥æˆ‘ä¸€ç›´å¸Œæœ›å­¦ä¹ ä¸€é—¨ç³»ç»Ÿç¼–ç¨‹è¯­è¨€ï¼Œä»¥æœŸå°†æ¥æœ‰èƒ½åŠ›çª¥æ¢ä¸€äº›åº•å±‚çš„ç»†èŠ‚åŸç†ã€‚C/C++ å¤ªå¤è€äº†ï¼Œç‰¹æ€§å¤ªå¤šäº†ï¼Œå¤§ç¥å¤ªå¤šäº†ï¼Œæˆ‘æ€ä¹ˆå­¦éƒ½ä¸å¯èƒ½èµ¶å¾—ä¸Šåˆ«äººï¼Œå˜¿å˜¿ï¼Œå­¦ä¸ªæ–°çš„ï¼Œå¤§å®¶éƒ½æ²¡å­¦è¿‡ï¼Œè¿™ä¸å°±èˆ’æœäº†ä¹ˆã€‚ åæ¥æå®¢æ—¶é—´å†³å®šå¼€è®¾ã€ŠRust è®­ç»ƒè¥ã€‹ï¼Œè®²å¸ˆæ˜¯é™ˆå¤©è€å¸ˆï¼Œæˆ‘å»æœäº†å…³äºé™ˆå¤©è€å¸ˆçš„ä¸€äº›èµ„æ–™ï¼Œçœ‹äº†ä¸€äº›ä»–å†™çš„æ–‡ç« å’ŒæŠ€æœ¯åˆ†äº«è§†é¢‘ï¼Œç”šè‡³æ²¹ç®¡ä¸Šè¿˜æœ‰ä»–ä¹‹å‰é¢è¯•çš„è§†é¢‘ã€‚OKï¼Œè¿™ä¸ªäººå¾—åˆ°äº†æˆ‘çš„è®¤å¯ï¼Œæˆ‘æƒ³è·Ÿè¿™æ ·çš„äººäº¤ä¸ªæœ‹å‹ï¼Œå“ªæ€•åªæ˜¯åŠ ä¸ªå¾®ä¿¡ï¼Œè‡³å°‘æˆ‘å¤šäº†ä¸ªå£å­ï¼Œå¾—ä»¥çª¥æ¢ç²¾è‹±é˜¶å±‚äººå£«çš„ç”Ÿæ´»ä¸€è§’ã€‚ ç»“åˆ 2023 å¹´çš„æ•™è®­ï¼Œ2024 å¹´å¹´åˆæˆ‘å°±ç»™è‡ªå·±åˆ¶å®šäº†ä¸€å¹´çš„ç›®æ ‡ï¼Œåªæœ‰ä¸€ä¸ªï¼Œå°±æ˜¯è¸è¸å®å®ã€å®Œå®Œæ•´æ•´å­¦ä¹ å®Œæ•´ä¸ª Rust è®­ç»ƒè¥ï¼Œå…¶ä»–æ‰€æœ‰äº‹æƒ…å’Œç›®æ ‡ï¼Œéƒ½è¦ä¸ºå…¶è®©æ­¥ã€‚ å…¶å®æ˜¯ 2 ä¸ªç›®æ ‡ hhhï¼Œå¦å¤–ä¸€ä¸ªç›®æ ‡æ˜¯ï¼šå®Œæˆäººç”Ÿçš„ç¬¬ä¸€åœºåŠç¨‹é©¬æ‹‰æ¾ã€‚ ç­‘åŸº ä¸ºäº†æ›´å¥½æœåŠ¡äºã€ŠRust è®­ç»ƒè¥ã€‹ï¼Œåœ¨ 1-4 æœˆä»½ï¼Œæˆ‘èŠ±äº†å·®ä¸å¤š 3 ä¸ªå¤šæœˆçš„æ—¶é—´å•ƒä¸‹äº†ã€ŠRust ç¨‹åºè®¾è®¡ï¼ˆç¬¬äºŒç‰ˆï¼‰ã€‹ï¼Œå¯¹æ•´ä¸ª Rust çš„è¯­è¨€ç‰¹æ€§å»ºç«‹äº†æ›´åŠ å®Œå–„çš„ä½“ç³»åŸºç¡€ï¼Œä¹Ÿå¤šå¥ å®šäº†ä¸€äº›åŸºç¡€ï¼Œå½“ç„¶ï¼Œè¿™æ˜¯æˆ‘ç¬¬äºŒæ¬¡å…¥é—¨ Rust å¤±è´¥ã€‚ ä¿®ç‚¼ 4 æœˆ 18 å·å¼€è¥ï¼Œæœ¬æ¥æ˜¯é¢„è®¡ 7 æœˆä»½ç»“è¥çš„ï¼Œä¸è¿‡é™ˆå¤©è€å¸ˆåˆ†äº«çš„æ¬²æœ›åˆ¹ä¸ä½è½¦ï¼Œç¡¬æ˜¯â€œæ‹–å ‚â€åˆ°äº† 11 æœˆ 22 å·ã€‚äº‹å®ä¸Šï¼Œè¿™æ˜¯æœ‰ç‚¹éš¾å—çš„ï¼Œä¸€ä¸ªäº‹æƒ…æ‹–å¤ªä¹…ï¼Œæ€ç»´ä¸Šå¾ˆå®¹æ˜“ç–²æƒ«ï¼Œæ‡’æƒ°ä¹Ÿæ„ˆéš¾å…‹æœã€‚ä¸è¿‡ä»æ¶ˆè´¹è€…çš„è§’åº¦ï¼Œè¿™æ˜¯èµšç¿»äº†ï¼Œæ¯•ç«Ÿï¼Œå­¦ç€å­¦ç€ï¼ŒèŠ±å‘—çš„ 12 æœŸæ— æ¯åˆ†æœŸä¹Ÿå·®ä¸å¤šè¦è¿˜å®Œäº†ã€‚ æ‰€ä»¥ï¼Œå…¶å®ä¸€ä¸ª 1095 çš„ç¨‹åºå‘˜ï¼Œåœ¨ 4.20 åˆ° 11.22 æ˜¯å¯ä»¥èŠ± 279 å°æ—¶ 54 åˆ†é’Ÿå­¦å®Œ 202 è®²è¯¾ç¨‹çš„ã€‚ å³ä½¿ä½ å°†æ¥ä¸ä½¿ç”¨ Rustï¼Œç›¸ä¿¡ä½ å­¦å®Œè¿™é—¨è¯¾ç¨‹åä¹Ÿèƒ½æˆä¸ºä¸€ä½æ›´å¥½çš„è½¯ä»¶å·¥ç¨‹å¸ˆã€‚ â€”â€” é™ˆå¤© æ˜¯çš„ï¼Œåœ¨å­¦ä¹ ä¸­ï¼Œæ›´å¤šæ—¶å€™æ„Ÿå—åˆ°çš„ä¸ä»…ä»…æ˜¯åœ¨å­¦ä¹  Rustï¼Œè€Œæ˜¯åœ¨é‡å­¦è½¯ä»¶å·¥ç¨‹ï¼Œæˆ‘å¼€å§‹åˆ‡èº«æ¥è§¦ä¼˜ç§€çš„è½¯ä»¶å¼€å‘å…·å¤‡äº†å“ªäº›ä¸å¯æˆ–ç¼ºçš„æµç¨‹ã€‚ä¸ºäº†æ•ˆä»¿è¿™äº›ä¼˜ç§€çš„æ€æƒ³å’Œå®è·µï¼Œåœ¨å®é™…å·¥ä½œä¸­ï¼Œä»Šå¹´æˆ‘åšäº†ä¸€äº›å°è¯•ï¼š å¼•å…¥æ›´ä¸°å¯Œçš„ CI/CD æµç¨‹ï¼Œå°½å¯èƒ½å‘æŒ¥æœºå™¨çš„èƒ½åŠ›ï¼Œè®©æœºå™¨ä¸åŒå…¶çƒ¦åœ°åšé‚£äº›çš„é‡å¤åŠ³åŠ¨ï¼Œè€Œè¿™äº›ä¸èµ·çœ¼çš„é‡å¤åŠ³åŠ¨ï¼Œå´èƒ½ä»¥æœ€å°ä»£ç ä¸ºæˆ‘ä»¬æ’æŸ¥å‡ºæœ€å¤šéš¾ä»¥å‘ç°çš„â€œå¤±è¯¯â€ BUGã€‚ å¼€å§‹å­¦ä¹ å†™å•æµ‹ï¼Œå¼€å§‹å­¦ä¹ å¦‚ä½•å°†ä»£ç å†™å¾—èƒ½å•æµ‹ã€æ˜“å•æµ‹ï¼Œå­¦ä¹ ç€å¦‚ä½•å°†é‚£äº›ä¸èƒ½å•æµ‹çš„ğŸ’©ä»£ç æ”¹é€ æˆå¯å•æµ‹çš„ä»£ç ï¼Œä¹Ÿå°†å•æµ‹è¿è¡ŒåŠ å…¥äº† CI/CD çš„æµç¨‹ä¸­ã€‚åœ¨å•æµ‹å¤šæ¬¡å¸®æˆ‘æªå‡ºé‚£äº›æˆ‘æ„è¯†ä¸åˆ°çš„ä¸å°å¿ƒæ”¹é”™çš„é€»è¾‘çš„æ—¶å€™ï¼Œæˆ‘æ‰åˆ‡èº«æ„Ÿå—åˆ°å•æµ‹çš„ä½œç”¨ï¼Œä¹ŸçœŸæ­£ç†è§£äº†â€œå†™å•æµ‹å¹¶ä¸ä¼šå½±å“å¼€å‘æ•ˆç‡ï¼Œå¦‚æœå½±å“äº†ï¼Œé‚£ä¹Ÿæ˜¯æé«˜äº†å¼€å‘æ•ˆç‡â€ã€‚å¹¸è¿çš„æ˜¯ï¼Œæˆªè‡³ç›®å‰ï¼ˆ11.27ï¼‰ï¼Œæˆ‘å·²ç»è¿ç»­ 2 æ¬¡ï¼Œåœ¨ä¸Šåƒè¡Œä»£ç çš„éœ€æ±‚å¼€å‘ä¸­ï¼Œææµ‹é˜¶æ®µå’Œçº¿ä¸Šå‘å¸ƒé˜¶æ®µï¼Œéƒ½æ˜¯ 0 Bugï¼Œè¿æ°”ä¸é”™ã€‚ å¼•å…¥ç›‘æ§ç³»ç»Ÿï¼Œåœ¨æŒ‡æ ‡ä¸Šï¼Œå­˜å‚¨å±‚ã€åº”ç”¨å±‚ã€ä¸šåŠ¡å±‚å’Œç½‘å…³å±‚è¿›è¡Œåˆ†å±‚ç›‘æ§ï¼Œåœ¨å¼€å‘æ—¶ï¼Œä»ä¸šåŠ¡æ— å…³ç»„ä»¶ï¼ˆgoapmï¼‰ï¼Œåˆ°ä¸šåŠ¡ç›¸å…³é€šç”¨ç»„ä»¶ï¼Œæœ€åå†åˆ°åº”ç”¨ç¨‹åºç‰¹å®šç»„ä»¶çš„åˆ†é˜¶æ®µåˆ†å±‚æ¬¡å¼€å‘ï¼Œå¼€å§‹å­¦ä¹ ç€â€œå…ˆè§£å†³ä¸šåŠ¡èƒŒåçš„é¢†åŸŸé—®é¢˜ï¼Œé¡ºå¸¦è§£å†³ä¸šåŠ¡é—®é¢˜â€ã€‚ å¼€å§‹æ€è€ƒä¸€äº›æ¶æ„å±‚é¢çš„ä¸œè¥¿ï¼Œå¼€å§‹æ€è€ƒä¸€äº›ä»£ç ç»„ç»‡ã€æ¥å£å¥‘çº¦ã€é¢†åŸŸæ¨¡å—åˆ’åˆ†çš„é—®é¢˜ï¼Œä»¥æœŸå†™å‡ºè´¨é‡æ›´å¥½çš„ä»£ç ã€‚ ä¸ºäº†æ”¯æ’‘ä¸Šé¢è¿™äº›äº‹æƒ…ï¼Œä»Šå¹´æˆ‘åˆé¡ºå¸¦è¯»äº†ä¸€äº›ä¹¦ï¼Œæˆ‘æ˜¯ä¸ªå¾ˆå°‘è¯»ä¹¦çš„äººï¼Œå› ä¸ºæˆ‘æ€»è§‰å¾—ï¼šâ€œè¯»ä¹¦å¥½æ…¢â€ã€‚è€Œä¸”æˆ‘è¯»ä¹¦ä¹Ÿç¡®å®å¾ˆæ…¢ï¼Œä¸»è¦æ˜¯ï¼Œå¾ˆå›° ğŸ˜…ã€‚ç„¶è€Œï¼Œå½“æˆ‘å›æœ›æ¥æ—¶è·¯ï¼Œä¸€åˆ‡å´éƒ½åœ¨æˆ‘çš„æ„æ–™ä¹‹å¤–ã€‚ hedon 2024 çš„ä¹¦å• è¿™ä¸ªæ—¶å€™æˆ‘æ‰çŸ¥é“ï¼š æ…¢å°±æ˜¯å¿« å°‘å°±æ˜¯å¤š å†åŠ« rust-road è¿™äº›ä¹¦å…¶å®éƒ½ä¸åœ¨æˆ‘çš„è®¡åˆ’ä¹‹å†…ï¼Œå› ä¸º 2024 æˆ‘åªæœ‰ä¸€ä¸ªç›®æ ‡ï¼šå®Œæˆ Rust è®­ç»ƒè¥çš„å­¦ä¹ ã€‚å®ƒä»¬åªä¸è¿‡æ˜¯æˆ‘å®Œæˆæ—¢å®šè®¡åˆ’ä¹‹ä½™çš„åŠ é¤ç½¢äº†ã€‚ è€Œå¹¸å¥½æˆ‘åªæœ‰ä¸€ä¸ªç›®æ ‡ï¼Œæ‰€ä»¥æ‰èƒ½æœ‰æ›´å¤šæ—¶é—´å’Œç²¾åŠ›å»åº”å¯¹è·Ÿéšè®­ç»ƒè¥å­¦ä¹ ä¸­çš„ä¸€äº›å›°éš¾ï¼š æ™šä¸Š 9 ç‚¹ä¸‹ç­ï¼ŒçœŸç´¯å•Šï¼Œä¼‘æ¯ä¸‹å§ï¼ŒçœŸä¸æƒ³å­¦äº†ã€‚ å·¥ä½œäº†ä¸€å‘¨ï¼ŒçœŸç´¯å•Šï¼Œå‘¨æœ«è¦ä¸å°±ä¼‘æ¯å§ï¼ŒçœŸä¸æƒ³å­¦äº†ã€‚ ç¼–è¯‘å™¨æŠ¥é”™å¥½å¤šå•Šï¼Œç®—äº†ï¼Œè¦ä¸ç›´æ¥ copy ç°æˆçš„ä»£ç å§ã€‚ è¿™çŸ¥è¯†ç‚¹åœ¨è®²å•¥å•Šï¼Œç®—äº†ï¼Œå…ˆä¸æ‡‚è£…æ‡‚å§ï¼Œåé¢è¿˜é‚£ä¹ˆå¤šè¯¾ï¼Œå…ˆèµ¶è¿›åº¦å†è¯´ã€‚ å‰ç«¯å’Œå®¢æˆ·ç«¯çš„çŸ¥è¯†ï¼Œå¥½åƒè·Ÿæˆ‘æ²¡å•¥å…³ç³»ï¼Œç®—äº†ï¼Œä¸å¬äº†ï¼Œè¿‡è¿‡è¿‡ã€‚ å•æµ‹æˆ‘å°±ä¸å†™äº†ï¼Œæµªè´¹æ—¶é—´ã€‚ å­¦å®Œå’¯ï¼Œæ„Ÿè§‰æ²¡å•¥å¥½æ€»ç»“çš„ï¼Œç®—äº†ï¼Œä¸‹ä¸€ä¸ªå§ã€‚ .... è¿æ°”ä¸é”™ï¼Œä¸Šè¿°çš„ n å¤šç§æƒ…å†µï¼Œè‡³å°‘åœ¨ 50-70% çš„æ—¶å€™ï¼Œæˆ‘èƒ½åšåˆ°ï¼š å­¦ä¸€ä¸‹å†è¯´ï¼Œç´¯äº†å†åœã€‚ ä¸‹åˆå‡ºå»ç©ï¼Œæ—©ä¸Šå…ˆå­¦äº†å†è¯´ã€‚ ç®—äº†ï¼Œç‹ ç‚¹ï¼Œç›²å†™ï¼Œè‡ªå·±å°è¯•è§£å†³ä¸€ä¸‹ï¼Œå’¦ï¼Œä¹Ÿå°±é‚£ä¹ˆå›äº‹ã€‚å†™å®Œåå†å¯¹æ¯”ä¸‹ï¼Œå“¦ï¼Œå…¶å®è¿™å—æ²¡å¬æ‡‚ã€‚ å¼„æ‡‚å†è¯´ï¼Œå¤šå¬å‡ éè¯¾ï¼Œé‡æ–°çœ‹å‡ éä¹¦ï¼Œå†æœä¸€äº›ç›¸å…³åšå®¢ï¼Œå“¦ï¼Œè¿™ä¸ªçŸ¥è¯†ç‚¹æ˜¯è¿™ä¸ªæ„æ€ï¼Œè¯»ä¹¦ç™¾éå…¶ä¹‰è‡ªè§åŸæ¥æ˜¯è¿™å‘³ï¼Ÿ ç®—äº†ï¼Œè¯•è¯•ç°åœ¨ LLM æ˜¯å¦å¦‚å¹çš„é‚£ä¹ˆç‰›ï¼Œå—¯ï¼Œå¥½åƒç”¨ LLM æ¥å®ç°å‰ç«¯å’Œå®¢æˆ·ç«¯çš„åŸºç¡€åŠŸèƒ½è¿˜çœŸå¯ä»¥ï¼Œä¹Ÿæ²¡é‚£ä¹ˆæ— èŠå˜›ã€‚ ç®—äº†ï¼Œå…ˆè¯•ç€å†™ä¸‹å•æµ‹å§ã€‚å“¦ï¼Œæˆ‘çš„ä»£ç è¿™ä¹ˆéš¾æµ‹å•Šï¼Œå“¦ï¼Œè¿™è¡Œä»£ç æ€ä¹ˆå°±çŠ¯è ¢äº†å‘¢ï¼Œå“¦ï¼ŒèŠ±ä¸äº†å¤šå°‘æ—¶é—´å˜›ã€‚ è¦ä¸è¿˜æ˜¯æ€»ç»“ä¸‹å§ï¼Œå“¦ï¼ŒåŸæ¥è¿™ä¸ªåœ°æ–¹æ˜¯è¿™ä¸ªæ„æ€ï¼Œå“¦ï¼ŒåŸæ¥è¿˜è®²åˆ°äº†è¿™ä¸ªç‚¹ã€‚ æ‰€ä»¥è¿™ä¸ªæ—¶å€™æˆ‘åˆçŸ¥é“äº†ï¼š æ…¢å°±æ˜¯å¿« å°‘å°±æ˜¯å¤š å°æˆ âœ hedon-rust-road lltotal 0drwxr-xr-x 21 wangjiahan staff 672B Nov 27 18:26 aicommdrwxr-xr-x 23 wangjiahan staff 736B Sep 11 13:55 chatdrwxr-xr-x 17 wangjiahan staff 544B Sep 11 18:31 chatappdrwxr-xr-x 26 wangjiahan staff 832B Nov 27 18:26 crmdrwxr-xr-x 22 wangjiahan staff 704B Nov 27 18:26 dinodrwxr-xr-x 16 wangjiahan staff 512B Nov 27 18:29 error-infodrwxr-xr-x 18 wangjiahan staff 576B Sep 4 19:00 hackernewsdrwxr-xr-x 22 wangjiahan staff 704B Sep 12 15:54 hedon-botdrwxr-xr-x 9 wangjiahan staff 288B Nov 27 18:29 httpiedrwxr-xr-x 13 wangjiahan staff 416B Aug 22 10:40 inverted-index-concurrencydrwxr-xr-x 7 wangjiahan staff 224B Nov 27 18:28 json-macrodrwxr-xr-x 26 wangjiahan staff 832B Sep 3 19:30 learn-ffidrwxr-xr-x 8 wangjiahan staff 256B Nov 27 18:29 learn-proc-macrodrwxr-xr-x 7 wangjiahan staff 224B Nov 27 18:30 mandelbrotdrwxr-xr-x 10 wangjiahan staff 320B Aug 22 10:40 matrix-multidrwxr-xr-x 7 wangjiahan staff 224B Nov 27 18:29 pest-parser-collectiondrwxr-xr-x 19 wangjiahan staff 608B Nov 27 18:27 r-redisdrwxr-xr-x 21 wangjiahan staff 672B Aug 22 10:40 rclidrwxr-xr-x 17 wangjiahan staff 544B Aug 22 10:40 simple-chatdrwxr-xr-x 17 wangjiahan staff 544B Aug 22 10:40 simple-shortenerdrwxr-xr-x 21 wangjiahan staff 672B Aug 22 10:40 taotiedrwxr-xr-x@ 18 wangjiahan staff 576B Nov 27 15:38 thumbordrwxr-xr-x 19 wangjiahan staff 608B Aug 29 10:56 winnow-parser-collectionâœ hedon-rust-road tokei -t rust=============================================================================== Language Files Lines Code Comments Blanks=============================================================================== Rust 336 25451 21615 644 3192 |- Markdown 53 546 0 476 70 (Total) 25997 21615 1120 3262=============================================================================== Total 336 25451 21615 644 3192=============================================================================== çœ‹è€å¸ˆç”»äº†é‚£ä¹ˆå¤šç‰›é€¼çš„å›¾ï¼Œè¦ä¸â€œé‚¯éƒ¸å­¦æ­¥â€æ¨¡ä»¿ä¸€ä¸‹å§ã€‚æ•…è€Œåˆå¿ç€â€œä¸‹ä¸€ä¸ªå§â€çš„å¿µå¤´ï¼Œæ¢³ç†äº†ä¸‹è¿™å‡ ä¸ªæœˆåˆ°åº•åšäº†äº›ä»€ä¹ˆã€‚ rcli r-redis macro-json macro-error-info rust-ecosystem crm taotie dino aicomm å½’å…ƒ çŸ¥æ˜¯è¡Œä¹‹å§‹ï¼Œè¡Œæ˜¯çŸ¥ä¹‹æˆã€‚ é‡äº‹ä¸å†³ï¼Œå¯é—®æ˜¥é£ã€‚æ˜¥é£ä¸è¯­ï¼Œæ—¢éšæœ¬å¿ƒã€‚ 2025 è§ï¼","tags":["Rust"],"categories":["Rust","æ€»ç»“","2024"]},{"title":"Rust åŸç†ä¸¨èŠä¸€èŠ Rust çš„ Atomic å’Œå†…å­˜é¡ºåº","path":"/2024/11/11/rust-memory-order/","content":"Atomic åœ¨ Rust çš„ std::sync::atomic æ¨¡å—ä¸­åŒ…å«äº†æ— é”å¹¶å‘ç¼–ç¨‹çš„åŸå­åŒ–ç±»å‹ï¼Œä¸é€šå¸¸çš„ç®—æœ¯è¿ç®—ç¬¦å’Œé€»è¾‘è¿ç®—ç¬¦ä¸åŒï¼ŒåŸå­åŒ–ç±»å‹ä¼šæš´éœ²æ‰§è¡ŒåŸå­åŒ–æ“ä½œçš„æ–¹æ³•ï¼Œå•ç‹¬çš„åŠ è½½ã€å­˜å‚¨ã€äº¤æ¢å’Œç®—æœ¯è¿ç®—éƒ½ä¼šä½œä¸ºä¸€ä¸ªå•å…ƒå®‰å…¨åœ°è¿›è¡Œï¼Œå“ªæ€•å…¶ä»–çº¿ç¨‹ä¹Ÿåœ¨æ‰§è¡Œæ“ä½œåŒä¸€å†…å­˜çš„åŸå­åŒ–æ“ä½œä¹Ÿæ²¡é—®é¢˜ã€‚ Rust æä¾›äº†ä»¥ä¸‹å‡ ç§åŸå­åŒ–ç±»å‹ï¼š AtomicIsize å’Œ AtomicUsize æ˜¯ä¸å•çº¿ç¨‹ isize ç±»å‹å’Œ usize ç±»å‹å¯¹åº”çš„å…±äº«æ•´æ•°ç±»å‹ã€‚ AtomicI8ã€AtomicI16ã€AtomicI32ã€AtomicI64 åŠå…¶æ— ç¬¦å·å˜ä½“ï¼ˆå¦‚ AtomicU8ï¼‰æ˜¯å…±äº«æ•´æ•°ç±»å‹ï¼Œå¯¹åº”äºå•çº¿ç¨‹ä¸­çš„ç±»å‹ i8ã€i16 ç­‰ã€‚ AtomicBool æ˜¯ä¸€ä¸ªå…±äº«çš„ bool å€¼ã€‚ AtomicPtr æ˜¯ä¸å®‰å…¨æŒ‡é’ˆç±»å‹ *mut T çš„å…±äº«å€¼ã€‚ è¿™äº›ç±»å‹éƒ½ä¼šä»¥ä¸‹å‡ ç±»æ ¸å¿ƒåŠŸèƒ½ï¼š Load ã€Store: å­˜å–å€¼ Fetch-and-Modify: è·å–å¹¶ä¿®æ”¹ Compare-and-Exchange: æ¯”è¾ƒå¹¶äº¤æ¢ ä¸‹é¢æˆ‘ä»¬å¯¹ä¸Šè¿°æåˆ°çš„å‡ ç§æ ¸å¿ƒåŠŸèƒ½è¿›è¡Œä¸¾ä¾‹ã€‚ Load Store load: ä»åŸå­åŒ–ç±»å‹ä¸­è·å–èµ·å¯¹åº”çš„åŸºæœ¬æ•°æ®ç±»å‹çš„å€¼ã€‚ store: å°†ä¸€ä¸ªåŸºæœ¬æ•°æ®ç±»å‹çš„å€¼å­˜å‚¨åˆ°å…¶å¯¹åº”çš„åŸå­åŒ–ç±»å‹ä¸­ã€‚ åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ AtomicUsize::new(0) åˆå§‹åŒ–äº†ä¸€ä¸ªåŸå­ç±»å‹ï¼Œå®ƒå¯¹åº”çš„åŸºæœ¬æ•°æ®ç±»å‹æ˜¯ usizeã€‚ æˆ‘ä»¬èµ·äº†ä¸€ä¸ªå­çº¿ç¨‹ï¼Œåœ¨ for å¾ªç¯ä¸­ä¸æ–­åœ°ä½¿ç”¨ store å‡½æ•°ä¿®æ”¹ num_done çš„å€¼ï¼Œç„¶ååœ¨ä¸»çº¿ç¨‹ä¸­ä½¿ç”¨ load è·å–èµ·å¯¹åº”çš„å€¼ï¼Œå½“å‘ç°å€¼ä¸º 100 æ—¶ï¼Œå°±é€€å‡ºå¾ªç¯ï¼Œè¿›ç¨‹ç»“æŸã€‚ å¾—ç›ŠäºåŸå­åŒ–ç±»å‹çš„å¹¶å‘å®‰å…¨ç‰¹æ€§ï¼Œæ‰€ä»¥è¿™é‡Œä¸¤ä¸ªçº¿ç¨‹å¯¹ num_done è¿›è¡Œå¹¶å‘è¯»å†™éƒ½æ˜¯å®‰å…¨çš„ã€‚ fn main() let num_done = AtomicUsize::new(0); let main_thread = thread::current(); thread::scope(|s| s.spawn(|| for i in 0..100 sleep(Duration::from_millis(10)); num_done.store(i + 1, std::sync::atomic::Ordering::Relaxed); // store å­˜å‚¨ main_thread.unpark(); ); loop let n = num_done.load(std::sync::atomic::Ordering::Relaxed); // load è·å– if n == 100 break; println!(Working... n/100 done); thread::park_timeout(Duration::from_millis(1)); ); println!(Done!); è¿™é‡Œæˆ‘ä»¬æš‚ä¸”å¿½ç•¥ std::sync::atomic::Ordering::Relaxed è¿™ä¸ªå‚æ•°çš„å«ä¹‰ï¼Œåœ¨åç»­çš„ã€Œå†…å­˜é¡ºåºã€ç« èŠ‚ä¼šè¿›è¡Œè¯¦ç»†é˜è¿°ã€‚ Fetch-and-Modify Fetch-and-Modify æ“ä½œç”¨äºåœ¨è·å–å½“å‰å€¼çš„åŒæ—¶å¯¹å…¶è¿›è¡Œä¿®æ”¹ã€‚è¿™ç±»æ“ä½œåŒ…æ‹¬ fetch_addã€fetch_subã€fetch_andã€fetch_orã€fetch_xor ç­‰ã€‚ æˆ‘ä»¬å°†ä¸Šé¢çš„ä¾‹å­ä¿®æ”¹ä¸€ä¸‹ï¼Œä¸å†æ˜¯ç›´æ¥ store ä¸€ä¸ªå€¼ï¼Œè€Œæ˜¯ä¸æ–­è¿›è¡ŒåŠ  1 æ“ä½œï¼š fn main() let num_done = AtomicUsize::new(0); thread::scope(|s| s.spawn(|| for _ in 0..100 num_done.fetch_add(1, std::sync::atomic::Ordering::Relaxed); // ä½¿ç”¨ fetch_add è¿›è¡ŒåŠ  1 ); loop let n = num_done.load(std::sync::atomic::Ordering::Relaxed); if n == 100 break; println!(Working... n/100 done); ); println!(Done!); Compare-and-Exchange Compare-and-Exchange æ˜¯ä¸€ç§æ¡ä»¶æ›´æ–°æ“ä½œï¼Œåªæœ‰åœ¨å½“å‰å€¼ç­‰äºé¢„æœŸå€¼æ—¶æ‰ä¼šæ›´æ–°ã€‚ ä¸‹é¢çš„ä¾‹å­ä¸­æˆ‘ä»¬å®ç°äº†ä¸€ä¸ªå‡½æ•° allocate_new_idï¼Œå®ƒæ”¯æŒåœ¨å¹¶å‘ç¯å¢ƒä¸‹åˆ†é…æ–°çš„ idï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº† compare_exchange(id, id+1) è¿›è¡Œæ¡ä»¶æ›´æ–°ï¼Œåªæœ‰å½“ id æ²¡æœ‰å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œæ‰è¿è¡Œå¯¹å…¶è¿›è¡ŒåŠ  1ï¼Œè¿™å°±ä¿è¯äº†åœ¨å¹¶å‘ä¸‹ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æˆåŠŸæ‰§è¡Œè¯¥è¯­å¥ï¼Œä»è€Œä¿è¯ id çš„é€’å¢æ€§å’Œå”¯ä¸€æ€§ã€‚ fn allocate_new_id() - u32 static NEXT_ID: AtomicU32 = AtomicU32::new(0); let mut id = NEXT_ID.load(std::sync::atomic::Ordering::Relaxed); loop assert!(id 1000, Too many IDs!); match NEXT_ID.compare_exchange( // åªæœ‰ id æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œæ‰å…è®¸è¿›è¡ŒåŠ  1 id, id + 1, std::sync::atomic::Ordering::Relaxed, std::sync::atomic::Ordering::Relaxed, ) Ok(_) = return id, Err(v) = id = v, åœ¨ Rust ä¸­ï¼ŒåŸå­åŒ–ç±»å‹è¿˜æä¾›äº†å¦å¤–ä¸€ä¸ªå‡½æ•°ï¼šcompare_exchange_weakï¼Œå®ƒä¸ compare_exchange çš„ä¸»è¦åŒºåˆ«åœ¨äºå®ƒä»¬åœ¨å¤±è´¥æ—¶çš„è¡Œä¸ºï¼š compare_exchange:åªä¼šåœ¨å®é™…å€¼ä¸ç­‰äºæœŸæœ›å€¼æ—¶å¤±è´¥ã€‚æä¾›æ›´å¼ºçš„ä¿è¯ï¼Œä½†å¯èƒ½æ€§èƒ½è¾ƒä½ã€‚é€‚ç”¨äºä¸åœ¨å¾ªç¯ä¸­çš„å•æ¬¡æ¯”è¾ƒäº¤æ¢æ“ä½œã€‚compare_exchange_weak:å³ä½¿å®é™…å€¼ç­‰äºæœŸæœ›å€¼æ—¶ä¹Ÿå¯èƒ½å¤±è´¥ï¼ˆç§°ä¸ºâ€œè™šå‡å¤±è´¥â€æˆ–â€œspuriousfailureâ€ï¼‰ã€‚æ€§èƒ½å¯èƒ½æ›´å¥½ï¼Œå› ä¸ºå…è®¸åœ¨æŸäº›æ¶æ„ä¸Šç”Ÿæˆæ›´é«˜æ•ˆçš„ä»£ç ã€‚æœ€é€‚åˆåœ¨å¾ªç¯ä¸­ä½¿ç”¨ï¼Œå› ä¸ºéœ€è¦å¤„ç†å¯èƒ½çš„è™šå‡å¤±è´¥ã€‚åœ¨å®é™…åº”ç”¨ä¸­:å¦‚æœæ“ä½œåœ¨å¾ªç¯ä¸­,ä½¿ç”¨ compare_exchange_weaké€šå¸¸æ›´å¥½ã€‚å¦‚æœæ˜¯å•æ¬¡æ“ä½œ,ä½¿ç”¨ compare_exchange æ›´åˆé€‚ã€‚åœ¨æŸäº›å¹³å°ä¸Šï¼Œè¿™ä¸¤ä¸ªæ“ä½œå¯èƒ½æ²¡æœ‰æ€§èƒ½å·®å¼‚,ä½†compare_exchange_weak çš„è¡Œä¸ºä»ç„¶å¯èƒ½ä¸åŒã€‚è¿™ç§åŒºåˆ«çš„å­˜åœ¨æ˜¯å› ä¸ºåœ¨æŸäº› CPUæ¶æ„ä¸Š,å…è®¸è™šå‡å¤±è´¥å¯ä»¥ç”Ÿæˆæ›´é«˜æ•ˆçš„æœºå™¨ç ã€‚æ¯”å¦‚åœ¨ ARMæ¶æ„ä¸Šï¼Œcompare_exchange_weak å¯ä»¥ç›´æ¥æ˜ å°„åˆ°å•ä¸ªLL/SCï¼ˆLoad-Link/Store-Conditionalï¼‰æŒ‡ä»¤ã€‚ ç¡¬ä»¶åŸç† åœ¨ä¸€äº›å¤„ç†å™¨æ¶æ„ä¸­ï¼Œå½“ä¸€ä¸ª CPU æ‰§è¡Œéœ€è¦åŸå­æ€§çš„æ“ä½œæ—¶ï¼Œå®ƒå¯ä»¥é€šè¿‡é”å®šå†…å­˜æ€»çº¿æ¥ç¡®ä¿åœ¨æ“ä½œå®Œæˆä¹‹å‰ï¼Œå…¶ä»– CPU æ— æ³•è®¿é—®ç›¸å…³çš„å†…å­˜åœ°å€ã€‚ åŸºæœ¬å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š CPU å‘å‡º LOCK ä¿¡å· â””â”€â”€ æ¿€æ´»å¤„ç†å™¨çš„ LOCK# å¼•è„š â””â”€â”€ è·å¾—æ€»çº¿çš„ç‹¬å è®¿é—®æƒ â””â”€â”€ æ‰§è¡ŒåŸå­æ“ä½œ â””â”€â”€ é‡Šæ”¾ LOCK ä¿¡å· â””â”€â”€ å…¶ä»–å¤„ç†å™¨å¯ä»¥è®¿é—®å†…å­˜ ä¸»æµçš„æœ‰ 2 ç§é”å®šæœºåˆ¶ï¼š æ€»çº¿é”å®šï¼ˆBus Lockingï¼‰ï¼šæ€»çº¿é”å®šæ˜¯ä¸€ç§æœºåˆ¶ï¼Œå®ƒé€šè¿‡é”å®šå†…å­˜æ€»çº¿æ¥ç¡®ä¿åœ¨æ‰§è¡ŒåŸå­æ“ä½œæ—¶ï¼Œå…¶ä»–å¤„ç†å™¨æ— æ³•è®¿é—®å†…å­˜ã€‚è¿™ç§æ–¹æ³•è™½ç„¶ç®€å•ï¼Œä½†ä¼šå¯¼è‡´æ€»çº¿çš„å…¶ä»–æ“ä½œè¢«é˜»å¡ï¼Œä»è€Œå½±å“ç³»ç»Ÿæ€§èƒ½ã€‚ ä¼˜ç‚¹ï¼š- ç»å¯¹çš„åŸå­æ€§ä¿è¯- é€‚ç”¨äºæ‰€æœ‰å†…å­˜ä½ç½®ç¼ºç‚¹ï¼š- æ€§èƒ½å¼€é”€å¤§- ä¼šé˜»å¡å…¶ä»– CPU å¯¹å†…å­˜çš„è®¿é—® ç¼“å­˜é”å®šï¼ˆCache Lockingï¼‰ï¼šç°ä»£å¤„ç†å™¨é€šå¸¸ä½¿ç”¨ç¼“å­˜é”å®šæ¥å®ç°åŸå­æ“ä½œã€‚ç¼“å­˜é”å®šé€šè¿‡é”å®šå¤„ç†å™¨çš„ç¼“å­˜è¡Œæ¥å®ç°ï¼Œè€Œä¸æ˜¯é”å®šæ•´ä¸ªæ€»çº¿ã€‚è¿™ç§æ–¹æ³•å¯ä»¥å‡å°‘å¯¹æ€»çº¿çš„å½±å“ï¼Œæé«˜ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½ã€‚ ä¼˜ç‚¹ï¼š- æ€§èƒ½æ›´å¥½- ä¸ä¼šå®Œå…¨é˜»å¡å†…å­˜è®¿é—®æ¡ä»¶ï¼š- æ•°æ®å¿…é¡»åœ¨ç¼“å­˜è¡Œä¸­- ç¼“å­˜è¡Œå¿…é¡»æ˜¯ç‹¬å çŠ¶æ€ ç¼“å­˜é”å®šé€šå¸¸ä¾èµ–äºç¼“å­˜ä¸€è‡´æ€§åè®®ï¼ˆå¦‚ MESI åè®®ï¼‰æ¥ç¡®ä¿åœ¨å¤šä¸ªå¤„ç†å™¨ä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§ã€‚é€šè¿‡è¿™äº›åè®®ï¼Œå¤„ç†å™¨å¯ä»¥åœ¨æœ¬åœ°ç¼“å­˜ä¸­æ‰§è¡ŒåŸå­æ“ä½œï¼Œå¹¶åœ¨å¿…è¦æ—¶ä¸å…¶ä»–å¤„ç†å™¨åŒæ­¥ã€‚ MESI åè®®å³ï¼š M (Modified)ï¼šå·²ä¿®æ”¹E (Exclusive)ï¼šç‹¬å S (Shared)ï¼šå…±äº«I (Invalid)ï¼šæ— æ•ˆæ“ä½œæµç¨‹ï¼š1. æ£€æŸ¥æ•°æ®æ˜¯å¦åœ¨ç¼“å­˜ä¸­2. å¦‚æœåœ¨ï¼Œå°†çŠ¶æ€æ”¹ä¸º Exclusive3. æ‰§è¡ŒåŸå­æ“ä½œ4. é€šçŸ¥å…¶ä»– CPU ä½¿å…¶ç¼“å­˜å¤±æ•ˆ ä¸åŒçš„æ¶æ„æœ‰ä¸åŒçš„é”å®šæ–¹å¼ï¼š x86/x64ï¼šä½¿ç”¨ LOCK å‰ç¼€ ARMï¼šä½¿ç”¨ exclusive load/store æŒ‡ä»¤ PowerPCï¼šä½¿ç”¨ load-linked/store-conditional ä»¥ä¸‹æ˜¯ x86 æ±‡ç¼–çš„ä¸€ä¸ªç¤ºä¾‹ï¼š ; åŸå­åŠ æ³•æ“ä½œlock add dword ptr [memory], 1; æ¯”è¾ƒå¹¶äº¤æ¢lock cmpxchg dword ptr [memory], eax ä¸ºäº†å……åˆ†åˆ©ç”¨ç¼“å­˜é”å®šçš„ä¼˜åŠ¿ï¼Œæˆ‘ä»¬åœ¨ç¼–å†™ä»£ç æ—¶ï¼Œå¯ä»¥æœ‰ä»¥ä¸‹çš„æ€§èƒ½è€ƒè™‘ï¼š ç¼“å­˜è¡Œå¯¹é½ï¼Œé¿å…ä¼ªå…±äº« use std::sync::atomic::AtomicI32, Ordering;// åœ¨ Rust ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ #[repr(align(N))] å±æ€§æ¥ç¡®ä¿ç»“æ„ä½“æˆ–å˜é‡çš„å¯¹é½æ–¹å¼ï¼Œä»¥é¿å…ä¼ªå…±äº«ã€‚// ä¼ªå…±äº«æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹è®¿é—®ä¸åŒçš„å˜é‡ï¼Œä½†è¿™äº›å˜é‡å…±äº«åŒä¸€ä¸ªç¼“å­˜è¡Œï¼Œä»è€Œå¯¼è‡´ä¸å¿…è¦çš„ç¼“å­˜ä¸€è‡´æ€§æµé‡ã€‚#[repr(align(64))]struct AlignedCounter counter: AtomicI32,fn main() let counter = AlignedCounter counter: AtomicI32::new(0), ; // ä½¿ç”¨ counter.counter.fetch_add(...) è¿›è¡Œæ“ä½œ é¿å…é¢‘ç¹çš„æ€»çº¿é”å®š use std::sync::atomic::AtomicI32, Ordering;fn main() let counter = AtomicI32::new(0); // ä¸å¥½çš„åšæ³•ï¼šé¢‘ç¹çš„åŸå­æ“ä½œ for _ in 0..1000 counter.fetch_add(1, Ordering::SeqCst); // æ›´å¥½çš„åšæ³•ï¼šæœ¬åœ°ç´¯åŠ åä¸€æ¬¡æ€§æ›´æ–° let mut local_sum = 0; for _ in 0..1000 local_sum += 1; counter.fetch_add(local_sum, Ordering::SeqCst); Rust å®æˆ˜æŸ¥çœ‹æ±‡ç¼– ç¬”è€…ä½¿ç”¨çš„æ˜¯ ARM64 æ¶æ„çš„ macbookã€‚ use std::sync::atomic::AtomicI64, Ordering;use std::thread;static ATOMIC: AtomicI64 = AtomicI64::new(0);fn main() let t1 = thread::spawn(|| ATOMIC.store(10086, Ordering::Release); ); let t2 = thread::spawn(|| let val = ATOMIC.load(Ordering::Acquire); println!(val); ); t1.join().unwrap(); t2.join().unwrap(); ä½¿ç”¨ rustc ç¼–è¯‘å¹¶è¾“å‡ºæ±‡ç¼–ä»£ç ï¼š rustc -O --emit asm src/main.rs ä»£ç ä¸­æˆ‘ç‰¹åœ°è®¾ç½®äº† 10086 è¿™ä¸ªç‰¹æ®Šçš„å€¼ï¼Œè¿™æ˜¯ä¸ºäº†å¯ä»¥åœ¨è¾“å‡ºçš„ main.s æ–‡ä»¶ä¸­å¿«é€Ÿæ‰¾åˆ° store å¯¹åº”çš„ä½ç½®ï¼š __ZN3std3sys9backtrace28__rust_begin_short_backtrace17h750d7a3a9c81fc67E:\t.cfi_startprocLloh8:\tadrp\tx8, __ZN4main6ATOMIC17hd0b0dbf92e477148E.0@PAGELloh9:\tadd\tx8, x8, __ZN4main6ATOMIC17hd0b0dbf92e477148E.0@PAGEOFF\tmov\tw9, #10086 ; å°†å€¼ 10086 ç§»å…¥å¯„å­˜å™¨\tstlr\tx9, [x8] ; Store-Release æŒ‡ä»¤ï¼ŒåŸå­åœ°å­˜å‚¨å€¼\t; InlineAsm Start\t; InlineAsm End\tret\t.loh AdrpAdd\tLloh8, Lloh9\t.cfi_endproc åœ¨è¿™ä¸ªä»£ç ä¸­ï¼Œstlr å°±æ˜¯ Store Release çš„æ„æ€ï¼Œå¦å¤–ä¸€ä¸ªå…³é”®å­—æ˜¯ ladprï¼Œè¡¨ç¤º Load Acquire çš„æ„æ€ï¼Œé€šè¿‡è¿™ä¸ªå…³é”®å­—ï¼Œä½ å¯ä»¥æ‰¾åˆ° load å¯¹åº”çš„æ±‡ç¼–ä»£ç ï¼š Lloh11:\tadd\tx8, x8, __ZN4main6ATOMIC17hd0b0dbf92e477148E.0@PAGEOFF\tldapr\tx8, [x8] ; ; Load-Acquire æŒ‡ä»¤ï¼ŒåŸå­åœ°åŠ è½½å€¼\tstr\tx8, [sp, #8] Go å®æˆ˜æŸ¥çœ‹æ±‡ç¼– ç¬”è€…ä½¿ç”¨çš„æ˜¯ ARM64 æ¶æ„çš„ macbookã€‚ package mainimport (\tsync/atomic)func main() data := atomic.Int64\tgo func() data.Store(10086)\t()\tgo func() a := data.Load() println(a)\t() ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼Œå¯ä»¥è¾“å‡ºä¼˜åŒ–åçš„æ±‡ç¼–ä»£ç ï¼š go build -gcflags=-S -ldflags=-w main.go 2 assembly.txt æŸ¥çœ‹è¾“å‡ºçš„æ–‡ä»¶ï¼Œæˆ‘ä»¬åŒæ ·æœç´¢ 10086ï¼Œå¯ä»¥å¿«é€Ÿæ‰¾åˆ° store çš„ä½ç½®ï¼š 0x0008 00008 (/Users/wangjiahan/go/go1.23.2/src/sync/atomic/type.go:109)\tMOVD\t$10086, R10x000c 00012 (/Users/wangjiahan/go/go1.23.2/src/sync/atomic/type.go:109)\tSTLR\tR1, (R0) å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡ŒåŒæ ·ä¹Ÿæ˜¯ä½¿ç”¨äº† STLR æŒ‡ä»¤ã€‚æ¥ç€æˆ‘ä»¬çœ‹ç¬¬ 14 è¡Œä»£ç çš„ä½ç½®å¯¹åº”çš„æ±‡ç¼–ï¼šå¯ä»¥å‘ç°è¿™é‡Œä½¿ç”¨çš„ LDAR æŒ‡ä»¤ï¼Œä¹Ÿå°±æ˜¯ Load Acuqireã€‚ 0x001c 00028 (/Users/wangjiahan/goStudy/go-atomic/main.go:14)\tHINT\t$00x0020 00032 (/Users/wangjiahan/go/go1.23.2/src/sync/atomic/type.go:106)\tLDAR\t(R0), R00x0024 00036 (/Users/wangjiahan/go/go1.23.2/src/sync/atomic/type.go:106)\tMOVD\tR0, main..autotmp_6-8(SP) å†…å­˜é¡ºåº åœ¨äº†è§£äº† Rust Atomic çš„åŸºæœ¬ç”¨æ³•å’ŒåŸºæœ¬åŸç†ä¹‹åï¼Œæˆ‘ä»¬å›è¿‡å¤´æ¥è°ˆä¸€è°ˆåŸå­æ“ä½œå‚æ•°ä¸­çš„ std::sync::atomic::Ordering::Relaxedï¼Œè¿™ä¸ªå°±æ˜¯æœ¬ç¯‡çš„ä¸»é¢˜ï¼šå†…å­˜é¡ºåºã€‚å†…å­˜é¡ºåºè¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜æ˜¯å¦‚ä½•åˆç†åœ°é™åˆ¶å•ä¸€çº¿ç¨‹ä¸­çš„ä»£ç æ‰§è¡Œé¡ºåºï¼Œä½¿å¾—åœ¨ä¸ä½¿ç”¨é”çš„æƒ…å†µä¸‹ï¼Œæ—¢èƒ½æœ€å¤§åŒ–åˆ©ç”¨ CPU çš„è®¡ç®—èƒ½åŠ›ï¼Œåˆèƒ½ä¿è¯å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¸ä¼šå‡ºç°é€»è¾‘é”™è¯¯ã€‚ æŒ‡ä»¤ä¹±åº CPU å’Œç¼–è¯‘å™¨éƒ½ä¼šåœ¨ä¿è¯ç¨‹åºè¿è¡Œç»“æœä¸å‘ç”Ÿæ”¹å˜çš„å‰æä¸‹ï¼Œå°½ä¸€åˆ‡å¯èƒ½è®©æˆ‘ä»¬çš„ç¨‹åºè¿è¡Œå¾—å°½å¯èƒ½å¿«ã€‚ fn f(a: mut i32, b: mut i32) *a += 1; *b += 1; *a += 1; åƒä¸Šè¿°ä»£ç ï¼Œç¼–è¯‘å™¨å®Œå…¨å¯ä»¥ä¼˜åŒ–æˆä¸‹é¢çš„ä»£ç ï¼Œä»è€Œæé«˜ç¨‹åºçš„è¿è¡Œæ•ˆç‡ï¼š fn f(a: mut i32, b: mut i32) *a += 2; *b += 1; åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå°±å¯èƒ½ä¼šå‡ºç°æŒ‡ä»¤é‡æ’ï¼Œç”šè‡³æ˜¯ä»£ç é‡å†™ï¼Œä¸è¿‡è¿™å¸¦æ¥äº†æŒ‡ä»¤ä¹±åºçš„é—®é¢˜ï¼Œå³ç¨‹åºçš„å®é™…æ‰§è¡Œé¡ºåºè·Ÿæˆ‘ä»¬çš„ä»£ç é¡ºåºæ˜¯ä¸ä¸€è‡´çš„ã€‚ ä¸è¿‡ï¼Œç¼–è¯‘å™¨ä¿è¯çš„æ˜¯åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œæ‰§è¡Œçš„ç»“æœæœ€ç»ˆä¸€è‡´ï¼Œæ‰€ä»¥ï¼ŒæŒ‡ä»¤ä¹±åºåœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹å®Œå…¨æ˜¯å…è®¸çš„ã€‚å¯¹äºç¼–è¯‘å™¨æ¥è¯´ï¼Œå®ƒåªçŸ¥é“ï¼šåœ¨å½“å‰çº¿ç¨‹ä¸­ï¼Œæ•°æ®çš„è¯»å†™ä»¥åŠæ•°æ®ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚ä½†æ˜¯ï¼Œç¼–è¯‘å™¨å¹¶ä¸çŸ¥é“å“ªäº›æ•°æ®æ˜¯åœ¨çº¿ç¨‹é—´å…±äº«ï¼Œè€Œä¸”æ˜¯æœ‰å¯èƒ½ä¼šè¢«ä¿®æ”¹çš„ã€‚è€Œè¿™äº›æ˜¯éœ€è¦å¼€å‘äººå‘˜å»ä¿è¯çš„ã€‚ å†…å­˜æ¨¡å‹ ä¸ºäº†è§£å†³æŒ‡ä»¤ä¹±åºå¸¦æ¥çš„å¹¶å‘é—®é¢˜ï¼ŒRust é‡‡ç”¨äº†å†…å­˜æ¨¡å‹ï¼ˆMemory Modelï¼‰è¿™ä¸€æ¦‚å¿µã€‚è¿™ä¸ªæ¦‚å¿µä¸»è¦å€Ÿé‰´è‡ª C++11 ä¸­å¼•å…¥çš„å†…å­˜æ¨¡å‹ï¼Œå®ƒå®šä¹‰äº†åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å†…å­˜è®¿é—®çš„è¡Œä¸ºè§„èŒƒã€‚ å†…å­˜æ¨¡å‹çš„æ ¸å¿ƒç›®æ ‡æ˜¯åœ¨ä»¥ä¸‹ä¸‰æ–¹é¢ä¹‹é—´å–å¾—å¹³è¡¡ï¼š æ­£ç¡®æ€§ä¿è¯ï¼šç¡®ä¿å¤šçº¿ç¨‹ç¨‹åºçš„è¡Œä¸ºæ˜¯å¯é¢„æµ‹å’Œä¸€è‡´çš„ã€‚ æ€§èƒ½ä¼˜åŒ–ï¼šå…è®¸ç¼–è¯‘å™¨å’Œ CPU åœ¨ä¸è¿åæ­£ç¡®æ€§çš„å‰æä¸‹è¿›è¡Œä¼˜åŒ–ã€‚ è·¨å¹³å°å…¼å®¹ï¼šæä¾›ä¸€ä¸ªç»Ÿä¸€çš„æŠ½è±¡å±‚ï¼Œä½¿ä»£ç å¯ä»¥åœ¨ä¸åŒçš„ç¡¬ä»¶æ¶æ„ä¸Šæ­£ç¡®è¿è¡Œã€‚ å…·ä½“æ¥è¯´ï¼Œå†…å­˜æ¨¡å‹ï¼š ä¸ºå¼€å‘è€…æä¾›äº†æ¸…æ™°çš„è§„åˆ™ï¼Œè¯´æ˜åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä»€ä¹ˆæ ·çš„å†…å­˜è®¿é—®è¡Œä¸ºæ˜¯åˆæ³•çš„ï¼Œä»€ä¹ˆæ ·çš„è¡Œä¸ºä¼šå¯¼è‡´æœªå®šä¹‰è¡Œä¸ºã€‚ ä¸ºç¼–è¯‘å™¨å¼€å‘è€…æä¾›äº†æ˜ç¡®çš„æ ‡å‡†ï¼ŒæŒ‡å¯¼ä»–ä»¬åœ¨ä¸åŒå¹³å°ä¸Šå®ç°å¿…è¦çš„å†…å­˜åŒæ­¥åŸè¯­ã€‚ é€šè¿‡å®šä¹‰ä¸åŒçš„å†…å­˜é¡ºåºçº§åˆ«ï¼ˆå¦‚ Relaxedã€Release/Acquireã€SeqCst ç­‰ï¼‰ï¼Œè®©å¼€å‘è€…å¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©åˆé€‚çš„åŒæ­¥å¼ºåº¦ã€‚ è¿™ç§æŠ½è±¡è®©å¼€å‘è€…å¯ä»¥ä¸“æ³¨äºå¹¶å‘é€»è¾‘æœ¬èº«ï¼Œè€Œä¸å¿…è¿‡åˆ†å…³ æ³¨åº•å±‚ç¡¬ä»¶çš„å…·ä½“å®ç°ç»†èŠ‚ã€‚ Sequenced-Before åœ¨è®¨è®ºå†…å­˜é¡ºåºä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå¯¹ 2 ä¸ªé‡è¦å…³ç³»æœ¯è¯­è¿›è¡Œç®€å•é˜è¿°ï¼Œåˆ†åˆ«æ˜¯ Sequenced-Before å’Œ Happens-Beforeã€‚ Sequenced-Before æè¿°çš„æ˜¯å•ä¸ªçº¿ç¨‹å†…çš„æ“ä½œé¡ºåºã€‚å®ƒåŸºäºç¨‹åºçš„æºä»£ç é¡ºåºï¼Œè¡¨ç¤ºåœ¨åŒä¸€çº¿ç¨‹ä¸­ï¼Œä¸€ä¸ªæ“ä½œåœ¨ç¨‹åºä¸­å‡ºç°åœ¨å¦ä¸€ä¸ªæ“ä½œä¹‹å‰ã€‚ å…·ä½“æ¥è¯´ï¼Œå¦‚æœæ“ä½œ A sequenced-before æ“ä½œ Bï¼Œé‚£ä¹ˆï¼š æ•°æ®ä¾èµ–å…³ç³»ï¼šå¦‚æœ B ä¾èµ–äº A çš„ç»“æœï¼Œé‚£ä¹ˆ A ä¸€å®šä¼šåœ¨ B ä¹‹å‰æ‰§è¡Œã€‚ä¾‹å¦‚ï¼š let x = 1; // æ“ä½œ Alet y = x + 1; // æ“ä½œ B - ä¾èµ–äº A çš„ç»“æœ åŸå­æ“ä½œçš„é¡ºåºï¼šå¯¹åŒä¸€ä¸ªåŸå­å˜é‡çš„æ“ä½œä¼šä¿æŒç¨‹åºé¡ºåºã€‚ä¾‹å¦‚ï¼š X.fetch_add(5, Relaxed); // ä¸€å®šå…ˆæ‰§è¡ŒX.fetch_add(10, Relaxed); // ä¸€å®šåæ‰§è¡Œ ç‹¬ç«‹æ“ä½œçš„å¯é‡æ’æ€§ï¼šå¦‚æœä¸¤ä¸ªæ“ä½œä¹‹é—´æ²¡æœ‰æ•°æ®ä¾èµ–å…³ç³»ï¼Œä¸”æ“ä½œçš„æ˜¯ä¸åŒçš„å˜é‡ï¼Œé‚£ä¹ˆå®ƒä»¬å¯èƒ½ä¼šè¢«é‡æ’åºã€‚ä¾‹å¦‚ï¼š X.store(1, Relaxed); // è¿™ä¸¤ä¸ªæ“ä½œå¯èƒ½ä¼šè¢«é‡æ’åºY.store(2, Relaxed); // å› ä¸ºå®ƒä»¬æ“ä½œçš„æ˜¯ä¸åŒçš„å˜é‡ Happens-Before Happens-Before åˆ™æè¿°äº†è·¨çº¿ç¨‹çš„æ“ä½œé¡ºåºã€‚å®ƒå®šä¹‰äº†ä¸åŒçº¿ç¨‹ä¸­çš„æ“ä½œä¹‹é—´çš„å¯è§æ€§å’Œé¡ºåºå…³ç³»ã€‚å¦‚æœæ“ä½œ A Happens-Before æ“ä½œ Bï¼Œé‚£ä¹ˆ A çš„å†…å­˜å†™å…¥å¯¹ B æ˜¯å¯è§çš„ã€‚ å…¸å‹çš„ Happens-Before æœ‰ï¼š åŒä¸€çº¿ç¨‹å†…ï¼Œå¦‚æœå…ˆè°ƒç”¨ f()ï¼Œå†è°ƒä½£ g()ï¼Œåˆ™ f() happens-before g()ï¼Œå…¶å®è¿™å°±æ˜¯ sequenced-beforeã€‚ spawing happens-before joiningã€‚ lock happens-before unlockã€‚ ä¸¾ä¸ªä¾‹å­ï¼š static X: AtomicI32 = AtomicI32::new(0);fn main() X.store(1, Relaxed); let t = thread::spawn(f); X.store(2, Relaxed); t.join().unwrap(); X.store(3, Relaxed);fn f() let x = X.load(Relaxed); assert!(x == 1 || x == 2); ä¸Šé¢è¿™ä¸ªä¾‹å­çš„æ‰§è¡Œé¡ºåºå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå› ä¸º spawn happens-before joinï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç¡®å®šçš„æ‰§è¡Œé¡ºåºæ˜¯ï¼šâ€œstore 1 to Xâ€â†’â€œstore 2 to Xâ€â†’â€œstore 3 to Xâ€ã€‚è€Œ load from X ä»‹äº spawn å’Œ join ä¹‹é—´ï¼Œä¸”æ²¡æœ‰è¿›è¡Œä»»ä½•å…¶ä»–çš„å†…å­˜é¡ºåºé™åˆ¶ï¼Œæ‰€ä»¥å®ƒå’Œ store 2 to X ä¹‹é—´çš„é¡ºåºæ˜¯ä¸ç¡®å®šçš„ï¼Œä½†æ˜¯å¯ä»¥è‚¯å®šçš„æ˜¯ï¼Œå®ƒä¸€å®šåœ¨ store 3 to X ä¹‹å‰ï¼Œæ‰€ä»¥ assert!(x == 1 || x == 2); æ˜¯æ°¸è¿œæˆç«‹çš„ã€‚ åˆ°è¿™é‡Œï¼Œç›¸ä¿¡ä¸å°‘è¯»è€…å·²ç»èƒ½å¤Ÿç†è§£ä¸ºä»€ä¹ˆéœ€è¦å†…å­˜é¡ºåºè¿™ä¸ªä¸œè¥¿äº†ï¼Œæ ¸å¿ƒé—®é¢˜å°±æ˜¯åœ¨äº store 2 to X å’Œ load from X çš„æ‰§è¡Œé¡ºåºæ˜¯å¦ä¼šå½±å“æˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘ï¼Œå¦‚æœä¸ä¼šï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æŒ‡å®šæœ€æ¾æ•£çš„å†…å­˜é¡ºåºè¦æ±‚ï¼Œå¦‚æœä¼šï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¦åˆ©ç”¨æŒ‡å®šåˆé€‚çš„å†…å­˜é¡ºåºæ¥ä½¿å¾—å…¶æŒ‰ç…§æˆ‘ä»¬çš„é¢„æœŸé¡ºåºè¿›è¡Œæ‰§è¡Œï¼Œä»è€Œä¿è¯ä¸šåŠ¡é€»çš„æ­£ç¡®ã€‚ Rust å†…å­˜é¡ºåº Rust æ”¯æŒäº”ç§å†…å­˜é¡ºåºï¼ˆOrderingï¼‰ï¼Œä»æœ€æ¾æ•£åˆ°æœ€ä¸¥æ ¼ä¾æ¬¡ä¸ºï¼š å†…å­˜é¡ºåº è¯´æ˜ ä¿è¯ é€‚ç”¨åœºæ™¯ ç¤ºä¾‹ Relaxed æœ€å®½æ¾çš„å†…å­˜é¡ºåº - ä»…ä¿è¯æ“ä½œçš„åŸå­æ€§- ä¸æä¾›ä»»ä½•åŒæ­¥ä¿è¯- ä¸å»ºç«‹ happens-before å…³ç³» - ç®€å•è®¡æ•°å™¨- æ€§èƒ½è¦æ±‚æé«˜ä¸”ç¡®å®šä¸éœ€è¦åŒæ­¥- å·²é€šè¿‡å…¶ä»–æ–¹å¼ç¡®ä¿åŒæ­¥ counter.fetch_add(1, Ordering::Relaxed) Release ç”¨äºå­˜å‚¨æ“ä½œ - ä¹‹å‰çš„å†…å­˜è®¿é—®ä¸ä¼šè¢«é‡æ’åˆ°æ­¤æ“ä½œä¹‹å- ä¸ Acquire é…å¯¹ä½¿ç”¨å¯å»ºç«‹ happens-before å…³ç³» - ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼- å‘å¸ƒå…±äº«æ•°æ®- åˆå§‹åŒ–å®Œæˆæ ‡å¿— data.store(42, Ordering::Release) Acquire ç”¨äºåŠ è½½æ“ä½œ - ä¹‹åçš„å†…å­˜è®¿é—®ä¸ä¼šè¢«é‡æ’åˆ°æ­¤æ“ä½œä¹‹å‰- ä¸ Release é…å¯¹ä½¿ç”¨å¯å»ºç«‹ happens-before å…³ç³» - ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼- è·å–å…±äº«æ•°æ®- æ£€æŸ¥åˆå§‹åŒ–æ ‡å¿— data.load(Ordering::Acquire) AcqRel åŒæ—¶åŒ…å« Acquire å’Œ Release è¯­ä¹‰ - ç»“åˆäº† Acquire å’Œ Release çš„æ‰€æœ‰ä¿è¯- ç”¨äºè¯»æ”¹å†™æ“ä½œ - éœ€è¦åŒå‘åŒæ­¥çš„åŸå­æ“ä½œ- é”çš„å®ç°- å¤æ‚çš„åŒæ­¥åŸè¯­ value.fetch_add(1, Ordering::AcqRel) SeqCst æœ€ä¸¥æ ¼çš„å†…å­˜é¡ºåº - åŒ…å« AcqRel çš„æ‰€æœ‰ä¿è¯- æ‰€æœ‰çº¿ç¨‹çœ‹åˆ°çš„æ‰€æœ‰ SeqCst æ“ä½œé¡ºåºä¸€è‡´- æä¾›å…¨å±€çš„é¡ºåºä¸€è‡´æ€§ - éœ€è¦ä¸¥æ ¼çš„å…¨å±€é¡ºåº- ä¸ç¡®å®šä½¿ç”¨å“ªç§é¡ºåºæ—¶- å¯¹æ€§èƒ½è¦æ±‚ä¸é«˜çš„åœºæ™¯ flag.store(true, Ordering::SeqCst) åœ¨ C++ ä¸­ï¼Œå…¶å®è¿˜æœ‰å¦å¤–ä¸€ç§å†…å­˜é¡ºåº Consumeï¼Œå®ƒæ˜¯ Acquire çš„ä¸€ä¸ªæ›´å¼±çš„ç‰ˆæœ¬ï¼š Acquire: ä¿è¯åç»­çš„æ‰€æœ‰è¯»å†™æ“ä½œä¸ä¼šé‡æ’åˆ°è¿™ä¸ªæ“ä½œå‰é¢ Consume: åªä¿è¯åç»­ä¸è¿™ä¸ªæ“ä½œç»“æœç›¸å…³çš„è¯»å†™æ“ä½œä¸ä¼šé‡æ’åˆ°è¿™ä¸ªæ“ä½œå‰é¢ ç†è®ºä¸Šï¼ŒConsume åœ¨æŸäº›æ¶æ„ä¸Šå¯ä»¥æä¾›æ¯” Acquire æ›´å¥½çš„æ€§èƒ½ï¼Œå› ä¸ºå®ƒåªéœ€è¦å¯¹æ•°æ®ä¾èµ–çš„æ“ä½œè¿›è¡ŒåŒæ­¥ã€‚ ç„¶è€Œï¼Œç”±äºä»¥ä¸‹åŸå› ï¼ŒRust é€‰æ‹©ä¸æ”¯æŒ Consume é¡ºåºï¼š å®ç°å¤æ‚æ€§ï¼šå¾ˆå¤šç¼–è¯‘å™¨å®ç°è€…å‘ç°æ­£ç¡®å®ç° Consume è¯­ä¹‰éå¸¸å›°éš¾ã€‚ æ€§èƒ½æ”¶ç›Šä¸ç¡®å®šï¼šåœ¨å®è·µä¸­ï¼Œå¤§å¤šæ•°ç¼–è¯‘å™¨éƒ½å°† Consume è§†ä¸º Acquire æ¥å¤„ç†ã€‚ æ ‡å‡†å›°æƒ‘ï¼šC++ æ ‡å‡†å§”å‘˜ä¼šä¹Ÿæ‰¿è®¤å½“å‰çš„ Consume è¯­ä¹‰å®šä¹‰å­˜åœ¨é—®é¢˜ï¼Œæ­£åœ¨è€ƒè™‘é‡æ–°è®¾è®¡ã€‚ é€‰æ‹©å»ºè®®ï¼š ä¸ç¡®å®šé€‰æ‹©å“ªç§é¡ºåºæ—¶ï¼šä½¿ç”¨ SeqCstï¼ˆæœ€å®‰å…¨ä½†æ€§èƒ½æœ€ä½ï¼‰æˆ–å’¨è¯¢æœ‰ç»éªŒçš„å¼€å‘è€…æ€§èƒ½ä¼˜åŒ–æ—¶ï¼šå…ˆä½¿ç”¨ SeqCst å¼€å‘åœ¨æ€§èƒ½æµ‹è¯•åï¼Œæ ¹æ®éœ€è¦é™ä½åˆ° Release/Acquireåªæœ‰åœ¨ç¡®å®éœ€è¦æ—¶æ‰ä½¿ç”¨ Relaxedå¸¸è§ç»„åˆï¼šRelease å†™ + Acquire è¯»ï¼šæœ€å¸¸è§çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼AcqRelï¼šç”¨äºåŸå­çš„è¯»æ”¹å†™æ“ä½œRelaxedï¼šç”¨äºç®€å•çš„è®¡æ•°å™¨åœºæ™¯ ä¸‹é¢æˆ‘ä»¬æ¥å¯¹æ¯ç§å†…å­˜é¡ºåºè¿›è¡Œä¸¾ä¾‹é˜è¿°ã€‚ Relaxed Relaxed æ˜¯æœ€å®½æ¾çš„å†…å­˜é¡ºåºï¼Œå®ƒåªä¿è¯äº†åŸå­æ“ä½œåœ¨å¹¶å‘ä¸‹çš„å®‰å…¨æ€§ï¼Œä½†ä¸ä¿è¯æ‰§è¡Œé¡ºåºã€‚ è€ƒè™‘å¦‚ä¸‹ä»£ç ï¼š static X: AtomicI32 = AtomicI32::new(0);fn a() X.fetch_add(5, Relaxed); X.fetch_add(10, Relaxed); fn b() let a = X.load(Relaxed); let b = X.load(Relaxed); let c = X.load(Relaxed); let d = X.load(Relaxed); println!(a b c d); // è¿™ä¸ªè¾“å‡ºä¸ä¸€å®šfn main() thread::scope(|s| s.spawn(a); s.spawn(b); ); println!(:?, X.load(Relaxed)); // æœ€ç»ˆç»“æœä¸€å®šæ˜¯ 15 åŸºäºæˆ‘ä»¬ä¸Šé¢æåˆ°çš„ sequenced-before è§„åˆ™ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®å®š a å’Œ b ä¸¤ä¸ªçº¿ç¨‹å†…çš„ happens-before è§„åˆ™ï¼Œä½†æ˜¯äºŒè€…ä¹‹é—´çš„ happens-before æ˜¯æ— æ³•ç¡®å®šçš„ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ç¡®å®šæœ€åçš„ç»“æœæ˜¯ 15ã€‚ä¸‹å›¾å±•ç¤ºäº†ä¸Šè¿°ä»£ç çš„æ‰§è¡Œé¡ºåºç¤ºæ„å›¾ï¼š è™½ç„¶ä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´çš„ happens-before æ˜¯æ— æ³•ç¡®å®šçš„ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ç¡®å®š X çš„å˜åŒ–é¡ºåºï¼š0â†’5â†’15ã€‚æ‰€ä»¥çº¿ç¨‹ b è¾“å‡º 0 0 0 0ã€0 0 5 15 å’Œ 0 15 15 15 éƒ½æ˜¯å¯èƒ½çš„ï¼Œè€Œæ°¸è¿œä¸å¯èƒ½è¾“å‡º 0 5 0 15 æˆ– 0 0 10 15 ç±»ä¼¼çš„ç»“æœã€‚ ä½†æ˜¯å¦‚æœæ˜¯è¿™æ ·å­çš„è¯ï¼Œå°±ä¸ä¸€å®šäº†ï¼š static X: AtomicI32 = AtomicI32::new(0);fn a1() X.fetch_add(5, Relaxed);fn a2() X.fetch_add(10, Relaxed); fn b() let a = X.load(Relaxed); let b = X.load(Relaxed); let c = X.load(Relaxed); let d = X.load(Relaxed); println!(a b c d); // è¿™ä¸ªè¾“å‡ºä¸ä¸€å®šfn main() thread::scope(|s| s.spawn(a1); s.apawn(a2); s.spawn(b); ); println!(:?, X.load(Relaxed)); // æœ€ç»ˆç»“æœä¸€å®šæ˜¯ 15 ä¸Šé¢è¿™ä¸ªä¾‹å­ï¼ŒX çš„å˜åŒ–é¡ºåºå¯ä»¥æ˜¯ 0â†’5â†’15ï¼Œä¹Ÿå¯ä»¥æ˜¯ 0â†’10â†’15ï¼Œè¿™å–å†³äºå“ªä¸ª fetch_add å…ˆè¢«æ‰§è¡Œã€‚ å†ä¸¾ä¸ªä¾‹å­ï¼š static DATA: AtomicI32 = AtomicI32::new(0);static READY: AtomicBool = AtomicBool::new(false);fn main() thread::scope(|s| // çº¿ç¨‹ A - å†™å…¥è€… s.spawn(|| DATA.store(123, Ordering::Relaxed); // â‘  å‡†å¤‡æ•°æ® READY.store(true, Ordering::Relaxed); // â‘¡ å‘å‡ºæ•°æ®å°±ç»ªä¿¡å· ); // çº¿ç¨‹ B - è¯»å–è€… s.spawn(|| while !READY.load(Ordering::Relaxed) // â‘¢ ç­‰å¾…æ•°æ®å°±ç»ªä¿¡å· thread::yield_now(); assert_eq!(DATA.load(Ordering::Relaxed), 123); // â‘£ è·å–æ•°æ®ï¼Œè¿™é‡Œæ–­è¨€ä¸€å®šæˆåŠŸå—ï¼Ÿ ); ); ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œçº¿ç¨‹ A æ‰§è¡Œäº†ï¼š DATA.store(123, Ordering::Relaxed); // å‡†å¤‡æ•°æ®READY.store(true, Ordering::Relaxed); // å‘å‡ºæ•°æ®å°±ç»ªä¿¡å· è¿™æ˜¯ 2 ä¸ªæ²¡æœ‰ä¾èµ–å…³ç³»çš„åŸå­æ“ä½œï¼Œä¸”ä½¿ç”¨çš„æ˜¯ Relaxed å†…å­˜é¡ºåºï¼Œæ‰€ä»¥å¯¹äºçº¿ç¨‹ B æ¥è¯´ï¼Œè¿™ 2 ä¸ªæ“ä½œçš„é¡ºåºæ˜¯ä¸ç¡®å®šçš„ã€‚æ‰€ä»¥æ˜¯å¾ˆå¯èƒ½åœ¨ READY.load(Ordering::Relaxed) è¿”å› true çš„æ—¶å€™ï¼ŒDATA.load(Ordering::Relaxed) ä¾æ—§è¿˜æ˜¯ 0ã€‚ é‚£å¦‚ä½•ç¡®ä¿è¿™ä¸ªæ–­è¨€ä¸€å®šæˆåŠŸå‘¢ï¼Ÿé‚£å°±éœ€è¦â€œå‡çº§â€ä¸€ä¸‹äº†~ è¿™ä¸ªæ—¶å€™å°±è½®åˆ° Release å’Œ Acquire çš„å‡ºåœºäº†ã€‚ Release Acquire Release å’Œ Acquire ä¸€èˆ¬æˆå¯¹å‡ºç°ï¼Œå®ƒä»¬å…±åŒå»ºç«‹äº†çº¿ç¨‹é—´çš„åŒæ­¥å…³ç³»ï¼š Release: ä½œç”¨äºå†™æ“ä½œï¼ˆstoreï¼‰ï¼Œç¡®ä¿è¯¥æ“ä½œä¹‹å‰çš„æ‰€æœ‰å†…å­˜è®¿é—®ä¸ä¼šè¢«é‡æ’åˆ°è¿™ä¸ª Release æ“ä½œä¹‹åã€‚ Acquire: ä½œç”¨äºè¯»æ“ä½œï¼ˆloadï¼‰ï¼Œç¡®ä¿è¯¥æ“ä½œä¹‹åçš„æ‰€æœ‰å†…å­˜è®¿é—®ä¸ä¼šè¢«é‡æ’åˆ°è¿™ä¸ª Acquire æ“ä½œä¹‹å‰ã€‚ å½“ä¸€ä¸ªçº¿ç¨‹é€šè¿‡ Acquire è¯»å–åˆ°å¦ä¸€ä¸ªçº¿ç¨‹é€šè¿‡ Release å†™å…¥çš„å€¼æ—¶ï¼Œä¼šå»ºç«‹ä¸€ä¸ª happens-before å…³ç³»ï¼šçº¿ç¨‹ A ä¸­ Release å†™å…¥ä¹‹å‰çš„æ‰€æœ‰å†…å­˜å†™æ“ä½œï¼Œå¯¹äºçº¿ç¨‹ B ä¸­ Acquire è¯»å–ä¹‹åçš„æ‰€æœ‰å†…å­˜è¯»æ“ä½œéƒ½æ˜¯å¯è§çš„ã€‚ ä¿®æ”¹ä¸€ä¸‹ä¸Šé¢çš„ä¾‹å­ï¼š static DATA: AtomicI32 = AtomicI32::new(0);static READY: AtomicBool = AtomicBool::new(false);fn main() thread::scope(|s| s.spawn(|| DATA.store(123, Ordering::Relaxed); READY.store(true, Ordering::Release); // è¿™é‡Œæ”¹ä¸º release ); s.spawn(|| while !READY.load(Ordering::Acquire) // è¿™é‡Œæ”¹ä¸º acquire thread::yield_now(); assert_eq!(DATA.load(Ordering::Relaxed), 123); // å¿…å®šæˆåŠŸ ); ); å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼š Release-Acquire åŒæ­¥ç¡®ä¿äº† READY çš„å†™å…¥å’Œè¯»å–ä¹‹é—´å»ºç«‹äº† happens-before å…³ç³» ç”±äº DATA çš„å†™å…¥åœ¨ READY çš„ Release å†™å…¥ä¹‹å‰ï¼Œè€Œ DATA çš„è¯»å–åœ¨ READY çš„ Acquire è¯»å–ä¹‹å å› æ­¤å¯ä»¥ä¿è¯çº¿ç¨‹ B ä¸€å®šèƒ½çœ‹åˆ°çº¿ç¨‹ A å†™å…¥çš„å€¼ 123 æ›´è¿›ä¸€æ­¥ï¼Œæˆ‘ä»¬é€šè¿‡è§‚å¯Ÿï¼Œå¯ä»¥å‘ç° DATA éƒ½æ²¡å¿…è¦ä½¿ç”¨ Atomic ç±»å‹ï¼Œå› ä¸ºç”± READY å»ºè®®çš„ happens-before è§„åˆ™å·²ç»èƒ½ä¿è¯å¯¹ DATA çš„è¯»å†™ä¸å¯èƒ½å¹¶å‘æ‰§è¡Œäº†ã€‚ä¸è¿‡å› ä¸º Rust çš„ç±»å‹ç³»ç»Ÿå¹¶ä¸å…è®¸è·¨çº¿ç¨‹è¿›è¡ŒéåŸå­ç±»å‹çš„è¯»å†™æ“ä½œï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ unsafe æ‰èƒ½ä½¿ç¼–è¯‘é€šè¿‡ï¼Œä½†é€šè¿‡æˆ‘ä»¬ä¹‹å‰çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿ä¸‹é¢è¿™æ®µä»£ç æ˜¯å®‰å…¨çš„ï¼š static mut DATA: u64 = 0;static READY: AtomicBool = AtomicBool::new(false);fn main() thread::spawn(|| // Safety: æ­¤æ—¶æ²¡æœ‰å…¶ä»–çº¿ç¨‹è®¿é—® DATAï¼Œ // å› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰è®¾ç½® READY æ ‡å¿— unsafe DATA = 123 ; READY.store(true, Release); // åœ¨è¿™ä¸ªå­˜å‚¨æ“ä½œä¹‹å‰çš„æ‰€æœ‰å†…å­˜æ“ä½œ .. ); while !READY.load(Acquire) // .. åœ¨è¿™ä¸ªåŠ è½½æ“ä½œè¿”å› true åéƒ½æ˜¯å¯è§çš„ thread::sleep(Duration::from_millis(100)); println!(waiting...); // Safety: æ²¡æœ‰çº¿ç¨‹ä¼šä¿®æ”¹ DATAï¼Œå› ä¸º READY å·²ç»è¢«è®¾ç½® println!(, unsafe DATA ); é‡Šæ”¾åºåˆ—ï¼ˆRelease Sequenceï¼‰ æˆ‘ä»¬å†æ¥çœ‹ä¸€æ®µä»£ç ç¤ºä¾‹ï¼šuse std::sync::atomic::AtomicU8, thread;static mut DATA: Veci64 = vec![];static FLAG: AtomicU8 = AtomicU8::new(0);fn thread_1() unsafe DATA.push(42); FLAG.store(1, std::sync::atomic::Ordering::Release);fn thread_2() let mut expected = 1; // memory_order_relaxed is okay because this is an RMW, // and RMWs (with any ordering) following a release form a release sequence while FLAG .compare_exchange( expected, 2, std::sync::atomic::Ordering::Relaxed, std::sync::atomic::Ordering::Relaxed, ) .is_err() expected = 1 fn thread_3() while FLAG.load(std::sync::atomic::Ordering::Acquire) 2 // if we read the value 2 from the atomic flag, we see 42 in the vector unsafe assert_eq!(DATA[0], 42); // will never fire fn main() thread::scope(|s| s.spawn(thread_1); s.spawn(thread_2); s.spawn(thread_3); );è¿™æ®µä»£ç æ˜¯å‚è€ƒ cppreferenceè€Œç¿»è¯‘æˆ Rust ä»£ç çš„ï¼Œåœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œå³ä½¿ thread_2ä¸­æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ Relaxedï¼Œ è¿™æ®µä»£ç ä¸­çš„assert_eq!(DATA[0], 42)ä¹Ÿæ˜¯ä¸€å®šæˆåŠŸçš„ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿè¿™æ¶‰åŠåˆ°ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µâ€”â€”é‡Šæ”¾åºåˆ—ï¼ˆReleaseSequenceï¼‰ï¼šå½“ä¸€ä¸ª releaseæ“ä½œåé¢è·Ÿç€ä¸€ç³»åˆ—çš„åŸå­\"è¯»-ä¿®æ”¹-å†™\"(RMW)æ“ä½œæ—¶ï¼Œè¿™äº›æ“ä½œä¼šå½¢æˆä¸€ä¸ªé‡Šæ”¾åºåˆ—ã€‚åœ¨è¿™ä¸ªåºåˆ—ä¸­ï¼Œåç»­çš„ RMW æ“ä½œä¸éœ€è¦ä½¿ç”¨ release æˆ–acquire è¯­ä¹‰ä¹Ÿèƒ½ä¿è¯åŒæ­¥ã€‚åœ¨è¿™æ®µä»£ç ä¸­ï¼šå½“ thread_2 çš„ RMWæ“ä½œæˆåŠŸçš„æ—¶å€™ï¼Œè¯´æ˜ FLAG æ˜¯ 1ï¼Œå³thread_1 å·²ç»æ‰§è¡Œäº† releaseæ“ä½œï¼Œè¿™ä¸ªæ—¶å€™ï¼šthread_1 çš„ release æ“ä½œå»ºç«‹äº†åŒæ­¥ç‚¹thread_2 çš„ RMWæ“ä½œè‡ªåŠ¨æˆä¸ºé‡Šæ”¾åºåˆ—çš„ä¸€éƒ¨åˆ†å½“ thread_3 é€šè¿‡ acquire çœ‹åˆ°å€¼ 2æ—¶ï¼Œå®ƒèƒ½çœ‹åˆ°æ•´ä¸ªé‡Šæ”¾åºåˆ—çš„æ‰€æœ‰ä¿®æ”¹ã€‚å› æ­¤èƒ½ä¿è¯çœ‹åˆ° DATA ä¸­çš„ 42ã€‚æ‰€ä»¥åœ¨è¿™ç§åœºæ™¯ä¸‹ä½¿ç”¨ relaxed æ—¢å®‰å…¨åˆé«˜æ•ˆï¼Œå› ä¸ºï¼šå®ƒæ˜¯é‡Šæ”¾åºåˆ—çš„ä¸€éƒ¨åˆ†ä¸éœ€è¦é¢å¤–çš„åŒæ­¥å¼€é”€ä»ç„¶èƒ½ä¿è¯æ­£ç¡®çš„å†…å­˜é¡ºåºä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡å‘¢ï¼ŸåŸå­æ€§ä¿è¯ï¼šRMWæ“ä½œæœ¬èº«å°±æ˜¯åŸå­çš„ï¼Œä¸ä¼šäº§ç”Ÿæ•°æ®ç«äº‰è¿ç»­æ€§ï¼šæ¯ä¸ª RMWæ“ä½œéƒ½ç›´æ¥æˆ–é—´æ¥åœ°åŸºäºå‰ä¸€ä¸ªæ“ä½œçš„ç»“æœå› æœå…³ç³»ï¼šå½¢æˆäº†ä¸€ä¸ªæ¸…æ™°çš„ä¿®æ”¹é“¾æ¡æ€§èƒ½è€ƒè™‘ï¼šä¸­é—´çš„ RMW æ“ä½œä¸éœ€è¦é¢å¤–çš„åŒæ­¥å¼€é”€ Sequentially Consistent SeqCst æ˜¯æœ€ä¸¥æ ¼çš„å†…å­˜é¡ºåºï¼Œå®ƒåŒ…æ‹¬è·å– release å’Œ acquire çš„æ‰€æœ‰ä¿è¯ï¼Œè¿˜ä¿è¯äº†å…¨å±€ä¸€è‡´çš„æ“ä½œé¡ºåºã€‚ç®€å•ç†è§£å°±æ˜¯ï¼Œä½ ä»£ç çš„é¡ºåºæ˜¯æ€ä¹ˆæ ·ï¼Œå®é™…çš„æ‰§è¡Œé¡ºåºå°±æ˜¯ä»€ä¹ˆæ ·ã€‚ æˆ‘ä»¬æ¥çœ‹ä¸€æ®µä»£ç ï¼š use std::sync::atomic::Ordering::SeqCst;static A: AtomicBool = AtomicBool::new(false);static B: AtomicBool = AtomicBool::new(false);static mut S: String = String::new();fn main() let a = thread::spawn(|| A.store(true, SeqCst); if !B.load(SeqCst) unsafe S.push(!) ; ); let b = thread::spawn(|| B.store(true, SeqCst); if !A.load(SeqCst) unsafe S.push(!) ; ); a.join().unwrap(); b.join().unwrap(); åœ¨è¿™æ®µä»£ç ä¸­ï¼Œä¸¤ä¸ªçº¿ç¨‹éƒ½æ˜¯å¸Œæœ›å°†è‡ªå·±çš„åŸå­å˜é‡è®¾ç½®ä¸º trueï¼Œä»è€Œé˜»æ­¢å¦å¤–ä¸€ä¸ªçº¿ç¨‹å¯¹ S è¿›è¡Œ push æ“ä½œï¼Œå…¶å®å°±ç±»ä¼¼äºé”ã€‚å› ä¸ºè¿™é‡Œä½¿ç”¨äº† SeqCstï¼Œæ‰€ä»¥ä»£ç çš„æ‰§è¡Œé¡ºåºæ˜¯è·Ÿä»£ç ç¼–å†™é¡ºåºæ˜¯ä¸€è‡´çš„ï¼Œé‚£ä¹ˆå°±å¯èƒ½å‡ºç°ä»¥ä¸‹ 3 ç§æ‰§è¡Œæƒ…å†µï¼š seqcst-memory-order å³ï¼šåŒä¸€æ—¶åˆ»ï¼Œæœ€å¤šåªå¯èƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šå¯¹ S è¿›è¡Œæ“ä½œã€‚ å†…å­˜å±éšœ é™¤äº†å†…å­˜é¡ºåºï¼ˆMemory Orderï¼‰ï¼Œè¿˜æœ‰å¦å¤–ä¸€ç§æ–¹å¼å¯ä»¥æ§åˆ¶ç¨‹åºçš„æ‰§è¡Œé¡ºåºï¼Œå°±æ˜¯å†…å­˜å±éšœï¼ˆMemory Barrierï¼‰ã€‚å†…å­˜å±éšœæ˜¯ä¸€ç§åº•å±‚çš„åŒæ­¥åŸè¯­ï¼Œå®ƒèƒ½å¼ºåˆ¶å¤„ç†å™¨æŒ‰ç…§ç‰¹å®šçš„é¡ºåºæ‰§è¡Œå†…å­˜æ“ä½œã€‚å†…å­˜å±éšœé€šè¿‡é˜»æ­¢æˆ–é™åˆ¶æŒ‡ä»¤é‡æ’åºï¼Œæ¥ç¡®ä¿å†…å­˜æ“ä½œçš„å¯è§æ€§å’Œé¡ºåºæ€§ã€‚ åŸºæœ¬æ¦‚å¿µ å†…å­˜å±éšœä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ç§ç±»å‹ï¼š Load Barrierï¼ˆè¯»å±éšœï¼‰ ç¡®ä¿åœ¨å±éšœä¹‹å‰çš„æ‰€æœ‰è¯»æ“ä½œéƒ½æ‰§è¡Œå®Œæˆ é˜²æ­¢åç»­è¯»æ“ä½œè¢«é‡æ’åˆ°å±éšœä¹‹å‰ å¯¹åº” Acquire è¯­ä¹‰ Store Barrierï¼ˆå†™å±éšœï¼‰ ç¡®ä¿åœ¨å±éšœä¹‹å‰çš„æ‰€æœ‰å†™æ“ä½œéƒ½æ‰§è¡Œå®Œæˆ é˜²æ­¢åç»­å†™æ“ä½œè¢«é‡æ’åˆ°å±éšœä¹‹å‰ å¯¹åº” Release è¯­ä¹‰ Full Barrierï¼ˆå…¨å±éšœï¼‰ åŒæ—¶åŒ…å«è¯»å±éšœå’Œå†™å±éšœçš„åŠŸèƒ½ é˜²æ­¢ä»»ä½•å†…å­˜æ“ä½œçš„é‡æ’åº å¯¹åº” SeqCst è¯­ä¹‰ å³ä¸‹é¢è¿™ 2 ç§å®ç°æ–¹å¼æ˜¯ç­‰ä»·çš„ï¼š æ‰€ä»¥åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥æ›´å¥½åœ°ç†è§£ä¸ºä»€ä¹ˆ release æ˜¯é˜»æ­¢å…¶å‰é¢çš„å†…å­˜è®¿é—®è¶Šè¿‡å®ƒï¼Œè€Œ acquire æ˜¯é˜»æ­¢å…¶åé¢çš„å†…å­˜è®¿é—®è¶Šè¿‡å®ƒäº†ã€‚å› ä¸ºæœ‰ä¸ª fence åœ¨å‰é¢æˆ–åé¢æ‹¦ç€ï¼ ä½†æ˜¯ä¸€èˆ¬æ¥è¯´ï¼Œä¸‹é¢çš„å†™æ³•ç›¸æ¯”ä¸Šé¢çš„å†™æ³•ä¼šæœ‰ä¸€ä¸¢ä¸¢çš„æ€§èƒ½æŸå¤±ï¼Œå› ä¸ºè¿™ä¼šå¢åŠ ä¸€äº›é¢å¤–çš„å¤„ç†æŒ‡ä»¤ã€‚é‚£ fence çš„ç”¨æ­¦ä¹‹åœ°æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ å¯ä»¥åŒæ—¶å¯¹å¤šä¸ªåŸå­æ“ä½œè¿›è¡Œ fenchï¼› å¯ä»¥æ ¹æ®æ¡ä»¶åˆ¤æ–­ï¼Œé€‰æ‹©æ˜¯å¦è¿›è¡Œ fenchã€‚ ä¸¾ä¸ªä¾‹å­ï¼š è¿™ä¸ªä¾‹å­çš„å…³é”®ç‚¹æ˜¯ï¼š å¦‚æœçº¿ç¨‹ 2 ä¸­çš„ä»»ä½•ä¸€ä¸ª load æ“ä½œè§‚å¯Ÿåˆ°äº†çº¿ç¨‹ 1 ä¸­å¯¹åº”çš„ store æ“ä½œçš„å€¼ï¼š æ¯”å¦‚ A.load() è¯»åˆ°äº†å€¼ 1ï¼Œæˆ– B.load() è¯»åˆ°äº†å€¼ 2ï¼Œæˆ– C.load() è¯»åˆ°äº†å€¼ 3 é‚£ä¹ˆï¼šçº¿ç¨‹ 1 ä¸­çš„ release fence å°±ä¼š happens-before çº¿ç¨‹ 2 ä¸­çš„ acquire fenceã€‚è¿™æ„å‘³ç€çº¿ç¨‹ 1 ä¸­ release fence ä¹‹å‰çš„æ‰€æœ‰å†…å­˜æ“ä½œå¯¹çº¿ç¨‹ 2 ä¸­ acquire fence ä¹‹åçš„æ“ä½œéƒ½æ˜¯å¯è§çš„ã€‚ è¿™å±•ç¤ºäº†å†…å­˜å±éšœçš„ä¸€ä¸ªé‡è¦ä¼˜åŠ¿ï¼šä¸€ä¸ªå±éšœå¯ä»¥åŒæ—¶ä¸ºå¤šä¸ªåŸå­æ“ä½œå»ºç«‹åŒæ­¥å…³ç³»ï¼Œè€Œä¸éœ€è¦åœ¨æ¯ä¸ªåŸå­æ“ä½œä¸Šéƒ½ä½¿ç”¨ Release/Acquire å†…å­˜åºã€‚è¿™åœ¨æŸäº›åœºæ™¯ä¸‹å¯èƒ½ä¼šæ›´é«˜æ•ˆã€‚ ç”¨æ›´é€šä¿—çš„è¯è¯´ï¼šè¿™å°±åƒåœ¨çº¿ç¨‹ 1 è®¾ç½®äº†ä¸€ä¸ª\"æ£€æŸ¥ç‚¹\"ï¼ˆrelease fenceï¼‰ï¼Œåœ¨çº¿ç¨‹ 2 ä¹Ÿè®¾ç½®äº†ä¸€ä¸ª\"æ£€æŸ¥ç‚¹\"ï¼ˆacquire fenceï¼‰ï¼Œåªè¦çº¿ç¨‹ 2 çœ‹åˆ°äº†çº¿ç¨‹ 1 åœ¨å…¶æ£€æŸ¥ç‚¹ä¹‹ååšçš„ä»»ä½•ä¸€ä¸ªæ”¹åŠ¨ï¼Œé‚£ä¹ˆçº¿ç¨‹ 1 æ£€æŸ¥ç‚¹ä¹‹å‰çš„æ‰€æœ‰æ“ä½œå¯¹çº¿ç¨‹ 2 çš„æ£€æŸ¥ç‚¹ä¹‹åéƒ½æ˜¯å¯è§çš„ã€‚ ç¡¬ä»¶å®ç° ä¸åŒçš„å¤„ç†å™¨æ¶æ„å®ç°å†…å­˜å±éšœçš„æ–¹å¼ä¸åŒï¼š ; x86/x64MFENCE ; å…¨å±éšœLFENCE ; è¯»å±éšœSFENCE ; å†™å±éšœ; ARMDMB ; æ•°æ®å†…å­˜å±éšœDSB ; æ•°æ®åŒæ­¥å±éšœISB ; æŒ‡ä»¤åŒæ­¥å±éšœ ä¸å†…å­˜é¡ºåºçš„å…³ç³» Rust çš„å†…å­˜é¡ºåºå®é™…ä¸Šæ˜¯é€šè¿‡å†…å­˜å±éšœæ¥å®ç°çš„ï¼š // Release å†™å…¥ä¼šæ’å…¥ Store Barrieratomic.store(42, Ordering::Release); // ç¼–è¯‘å™¨ä¼šåœ¨æ­¤å¤„æ’å…¥ Store Barrier// Acquire è¯»å–ä¼šæ’å…¥ Load Barrierlet x = atomic.load(Ordering::Acquire); // ç¼–è¯‘å™¨ä¼šåœ¨æ­¤å¤„æ’å…¥ Load Barrier// SeqCst æ“ä½œä¼šæ’å…¥ Full Barrieratomic.store(42, Ordering::SeqCst); // ç¼–è¯‘å™¨ä¼šåœ¨æ­¤å¤„æ’å…¥ Full Barrier æ³¨æ„ï¼šç›´æ¥ä½¿ç”¨å†…å­˜å±éšœæ˜¯éå¸¸åº•å±‚çš„æ“ä½œï¼Œé€šå¸¸æˆ‘ä»¬åº”è¯¥ä½¿ç”¨ Rustæä¾›çš„é«˜çº§æŠ½è±¡ï¼ˆå¦‚åŸå­ç±»å‹å’Œå®ƒä»¬çš„å†…å­˜é¡ºåºï¼‰æ¥å®ç°åŒæ­¥ã€‚å†…å­˜å±éšœçš„çŸ¥è¯†ä¸»è¦ç”¨äºç†è§£è¿™äº›é«˜çº§æŠ½è±¡çš„å·¥ä½œåŸç†ã€‚ Go Atomic ç†Ÿæ‚‰ Go è¯­è¨€çš„è¯»è€…åº”è¯¥ä¼šæ„è¯†åˆ°åœ¨ä½¿ç”¨ Go è¯­è¨€çš„åŸå­ç±»å‹çš„æ—¶å€™ï¼Œå¥½åƒéƒ½æ²¡è§è¿‡ Memory Order è¿™ä¸ªä¸œè¥¿ï¼Œå¦‚ä¸‹ï¼š package mainimport (\tsync/atomic)func main() data := atomic.Int64\tdata.Add(1)\tdata.And(2)\tdata.Or(3)\tdata.Swap(4)\tdata.Store(5)\tdata.Load()\tdata.CompareAndSwap(6, 7) åœ¨ atomic/doc.go æºç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™æ®µè¯ï¼š // The load and store operations, implemented by the LoadT and StoreT// functions, are the atomic equivalents of return *addr and// *addr = val.//// In the terminology of [the Go memory model], if the effect of// an atomic operation A is observed by atomic operation B,// then A â€œsynchronizes beforeâ€ B.// Additionally, all the atomic operations executed in a program// behave as though executed in some sequentially consistent order.// This definition provides the same semantics as// C++s sequentially consistent atomics and Javas volatile variables.//// [the Go memory model]: https://go.dev/ref/mem Go è¯­è¨€è®¾è®¡è€…è®¤ä¸ºè®©ç¨‹åºå‘˜é€‰æ‹©å†…å­˜åºä¼šå¢åŠ å¤æ‚æ€§å’Œå‡ºé”™çš„å¯èƒ½ï¼Œæ‰€ä»¥ä¸ºäº†ç¨‹åºçš„ç®€å•æ€§å’Œå¯é¢„æµ‹æ€§ï¼Œç›´æ¥å°±ä½¿ç”¨äº†æœ€å®‰å…¨çš„ Seq-Cst å†…å­˜é¡ºåºäº†ã€‚ the Go memory model ä¸­è¿˜æäº†ä¸€å¥ï¼š If you must read the rest of this document to understand the behavior of your program, you are being too clever.Dont be clever. è¿™ä¹Ÿå‘¼åº”äº† Go çš„è®¾è®¡ç†å¿µï¼š Share memory by communicating; dont communicate by sharing memory. æ‰€ä»¥æ€»ç»“ä¸€ä¸‹ï¼š Go çš„åŸå­æ“ä½œé‡‡ç”¨äº†æœ€å¼ºçš„é¡ºåºä¸€è‡´æ€§å†…å­˜åºï¼› è¿™æ˜¯ä¸€ä¸ªæœ‰æ„è¯†çš„è®¾è®¡é€‰æ‹©ï¼Œä¸ºäº†ç®€å•æ€§å’Œå¯é¢„æµ‹æ€§ï¼› å¦‚æœä½ éœ€è¦æ›´ç»†ç²’åº¦çš„å†…å­˜åºæ§åˆ¶ï¼Œé‚£ä¹ˆ Go å¯èƒ½ä¸æ˜¯æœ€ä½³é€‰æ‹©ï¼› Go æ›´æ¨èä½¿ç”¨ channels å’Œå…¶ä»–åŒæ­¥åŸè¯­æ¥è¿›è¡Œå¹¶å‘æ§åˆ¶ã€‚ å‚è€ƒ Rust Atomics And Lock èŠä¸€èŠå†…å­˜æ¨¡å‹ä¸å†…å­˜åº cppreference the Go memory model","tags":["Rust","Go","å†…å­˜é¡ºåº","å†…å­˜å±éšœ","å¹¶å‘æ§åˆ¶","Atomic","Happens-Before"],"categories":["Rust","Rust åº•å±‚åŸç†"]},{"title":"Rust å®æˆ˜ä¸¨SSE(Server-Sent Events)","path":"/2024/06/06/rust-action-sse/","content":"ğŸ“Œ SSEï¼ˆServer-Sent Eventsï¼‰æ˜¯ä¸€ç§å…è®¸æœåŠ¡å™¨å‘å®¢æˆ·ç«¯æµè§ˆå™¨æ¨é€ä¿¡æ¯çš„æŠ€æœ¯ã€‚å®ƒæ˜¯ HTML5 çš„ä¸€éƒ¨åˆ†ï¼Œä¸“é—¨ç”¨äºå»ºç«‹ä¸€ä¸ªå•å‘çš„ä»æœåŠ¡å™¨åˆ°å®¢æˆ·ç«¯çš„é€šä¿¡è¿æ¥ã€‚SSEçš„ä½¿ç”¨åœºæ™¯éå¸¸å¹¿æ³›ï¼ŒåŒ…æ‹¬å®æ—¶æ¶ˆæ¯æ¨é€ã€å®æ—¶é€šçŸ¥æ›´æ–°ç­‰ã€‚ SSE çš„æœ¬è´¨ ä¸¥æ ¼åœ°è¯´ï¼ŒHTTPæ— æ³•åšåˆ°æœåŠ¡å™¨ä¸»åŠ¨æ¨é€ä¿¡æ¯ã€‚ä½†æ˜¯ï¼Œæœ‰ä¸€ç§å˜é€šæ–¹æ³•ï¼Œå°±æ˜¯æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å£°æ˜ï¼Œæ¥ä¸‹æ¥è¦å‘é€çš„æ˜¯æµä¿¡æ¯ï¼ˆstreamingï¼‰ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œå‘é€çš„ä¸æ˜¯ä¸€æ¬¡æ€§çš„æ•°æ®åŒ…ï¼Œè€Œæ˜¯ä¸€ä¸ªæ•°æ®æµï¼Œä¼šè¿ç»­ä¸æ–­åœ°å‘é€è¿‡æ¥ã€‚è¿™æ—¶ï¼Œå®¢æˆ·ç«¯ä¸ä¼šå…³é—­è¿æ¥ï¼Œä¼šä¸€ç›´ç­‰ç€æœåŠ¡å™¨å‘è¿‡æ¥çš„æ–°çš„æ•°æ®æµï¼Œè§†é¢‘æ’­æ”¾å°±æ˜¯è¿™æ ·çš„ä¾‹å­ã€‚æœ¬è´¨ä¸Šï¼Œè¿™ç§é€šä¿¡å°±æ˜¯ä»¥æµä¿¡æ¯çš„æ–¹å¼ï¼Œå®Œæˆä¸€æ¬¡ç”¨æ—¶å¾ˆé•¿çš„ä¸‹è½½ã€‚ SSE å°±æ˜¯åˆ©ç”¨è¿™ç§æœºåˆ¶ï¼Œä½¿ç”¨æµä¿¡æ¯å‘æµè§ˆå™¨æ¨é€ä¿¡æ¯ã€‚å®ƒåŸºäº HTTP åè®®ï¼Œç›®å‰é™¤äº† IE/Edgeï¼Œå…¶ä»–æµè§ˆå™¨éƒ½æ”¯æŒã€‚ ç‰¹ç‚¹ æŒç»­è¿æ¥ï¼šä¸ä¼ ç»Ÿçš„ HTTP è¯·æ±‚ä¸åŒï¼ŒSSE ä¿æŒè¿æ¥å¼€æ”¾ï¼ŒæœåŠ¡å™¨å¯ä»¥éšæ—¶å‘é€æ¶ˆæ¯ã€‚ æ–‡æœ¬æ•°æ®æµï¼šSSE ä¸»è¦ä¼ è¾“æ–‡æœ¬æ•°æ®ï¼Œè¿™äº›æ•°æ®ä»¥ç‰¹å®šçš„æ ¼å¼æµå¼ä¼ è¾“ï¼Œä½¿å¾—æ¯æ¡æ¶ˆæ¯éƒ½æ˜¯ç®€å•çš„æ–‡æœ¬æ ¼å¼ã€‚ å†…ç½®é‡è¿æœºåˆ¶ï¼šæµè§ˆå™¨ä¼šè‡ªåŠ¨å¤„ç†è¿æ¥ä¸­æ–­å’Œé‡è¿ï¼ŒåŒ…æ‹¬åœ¨é‡è¿è¯·æ±‚ä¸­å‘é€æœ€åæ¥æ”¶çš„äº‹ä»¶ IDï¼Œä»¥ä¾¿æœåŠ¡å™¨ä»æ­£ç¡®çš„ä½ç½®æ¢å¤å‘é€äº‹ä»¶ã€‚ ç®€å•çš„å®¢æˆ·ç«¯å¤„ç†ï¼šåœ¨æµè§ˆå™¨ä¸­ï¼Œä½¿ç”¨ JavaScript çš„ EventSource æ¥å£å¤„ç† SSE éå¸¸ç®€å•ï¼Œåªéœ€å‡ è¡Œä»£ç å³å¯ç›‘å¬æœåŠ¡å™¨å‘æ¥çš„äº‹ä»¶ã€‚ å·¥ä½œåŸç† å»ºç«‹è¿æ¥ï¼šå®¢æˆ·ç«¯é€šè¿‡åˆ›å»ºä¸€ä¸ª EventSource å¯¹è±¡è¯·æ±‚ç‰¹å®šçš„ URL æ¥å¯åŠ¨ SSE è¿æ¥ã€‚è¿™ä¸ªè¯·æ±‚æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ HTTP è¯·æ±‚ï¼Œä½†ä¼šè¦æ±‚æœåŠ¡å™¨ä»¥ç‰¹å®šæ–¹å¼å“åº”ã€‚ æœåŠ¡å™¨å“åº”ï¼šæœåŠ¡å™¨å“åº”å¿…é¡»è®¾ç½® Content-Type ä¸º text/event-streamï¼Œç„¶åä¿æŒè¿æ¥æ‰“å¼€ã€‚ å‘é€æ¶ˆæ¯ï¼šæœåŠ¡å™¨å¯ä»¥é€šè¿‡æŒç»­å‘é€æ•°æ®æ ¼å¼ä¸ºç‰¹å®šäº‹ä»¶æµçš„æ¶ˆæ¯æ¥æ¨é€æ›´æ–°ã€‚æ¯ä¸ªæ¶ˆæ¯åŒ…æ‹¬ä¸€ä¸ªå¯é€‰çš„äº‹ä»¶ç±»å‹ã€æ•°æ®å’Œä¸€ä¸ªå¯é€‰çš„ IDã€‚ æ•°æ®ï¼šå®é™…çš„æ¶ˆæ¯å†…å®¹ï¼Œä»¥ data: å¼€å¤´ï¼Œå¤šè¡Œæ•°æ®ä»¥åŒæ¢è¡Œç¬¦ ç»“æŸã€‚ äº‹ä»¶ç±»å‹ï¼šå…è®¸å®¢æˆ·ç«¯æ ¹æ®äº‹ä»¶ç±»å‹æ¥ç›‘å¬ï¼Œä»¥ event: å¼€å¤´ã€‚ IDï¼šå¦‚æœè¿æ¥ä¸­æ–­ï¼Œå®¢æˆ·ç«¯å°†å‘é€åŒ…å«ä¸Šæ¬¡æ¥æ”¶çš„æœ€åä¸€ä¸ªIDçš„ Last-Event-ID å¤´ï¼Œä»¥ä¾¿æœåŠ¡å™¨ä»æ–­ç‚¹ç»§ç»­å‘é€æ•°æ®ã€‚ å®æˆ˜ å®¢æˆ·ç«¯ !DOCTYPE htmlhtmlhead titleSSE Test/title/headbodyh1Server-Sent Events Test/h1div id=events/divscript // ç¡®ä¿è¿™é‡Œçš„URLåŒ¹é…ä½ çš„æœåŠ¡å™¨åœ°å€å’Œç«¯å£ var eventSource = new EventSource(http://localhost:8000/events); eventSource.onmessage = function(event) console.log(New event:, event.data); document.getElementById(events).innerHTML += event.data + br; ;/script/body/html Rust æœåŠ¡ç«¯ Rust å®ç°æ¼”ç¤º ä¾èµ–ï¼š anyhow = 1.0.86axum = version = 0.7.5 chrono = 0.4.38futures-core = 0.3.30tokio = version = 1.38.0, features = [macros, rt-multi-thread, ] tokio-stream = 0.1.15tower-http = version = 0.5.2, features = [cors] ä»£ç ï¼š use std::time::Duration;use axum:: response::sse::Event, Sse, routing::get, Router,;use tokio::net::TcpListener, time::interval;use tokio_stream::wrappers::IntervalStream, StreamExt;use tower_http::cors::Any, CorsLayer;#[tokio::main]async fn main() - anyhow::Result() let cors = CorsLayer::new() .allow_headers(Any) .allow_origin(Any) .allow_headers(Any) .allow_credentials(false); let listener = TcpListener::bind(0.0.0.0:8000).await?; let app = Router::new().route(/events, get(sse_handler)).layer(cors); axum::serve(listener, app).await?; Ok(())async fn sse_handler() - Sseimpl futures_core::StreamItem = ResultEvent, axum::Error let interval = interval(Duration::from_secs(1)); let stream = IntervalStream::new(interval).map(|_| let data = format!( , chrono::Local::now().to_rfc2822()); Ok(Event::default().data(data)) ); Sse::new(stream) Go æœåŠ¡ç«¯ Go å®ç°æ¼”ç¤º package mainimport (\tfmt\tlog\tnet/http\ttime)func sseHandler(w http.ResponseWriter, r *http.Request) // è®¾ç½®å¤´éƒ¨ä¿¡æ¯ï¼Œç¡®ä¿å…è®¸è·¨åŸŸï¼Œå¹¶ä¸”å‘Šè¯‰æµè§ˆå™¨è¿™æ˜¯ä¸€ä¸ªäº‹ä»¶æµ\tw.Header().Set(Content-Type, text/event-stream)\tw.Header().Set(Cache-Control, no-cache)\tw.Header().Set(Connection, keep-alive)\tw.Header().Set(Access-Control-Allow-Origin, *)\t// ä¸æ–­å‘é€æ¶ˆæ¯\tfor // ç”ŸæˆæœåŠ¡å™¨æ—¶é—´ï¼Œå¹¶å‘é€ç»™å®¢æˆ·ç«¯ now := time.Now() // ç”Ÿæˆæ¶ˆæ¯ï¼Œæ ¼å¼ä¸º data: content msg := fmt.Sprintf(data: %s , now.Format(time.DateTime)) // å‘é€æ¶ˆæ¯ if _, err := fmt.Fprintf(w, msg); err != nil log.Println(write error:, err) break // åˆ·æ–°å“åº”ç¼“å†²ï¼Œç¡®ä¿å³æ—¶å‘é€ flusher, ok := w.(http.Flusher) if !ok log.Println(Streaming unsupported!) break flusher.Flush() // æ¯ç§’å‘é€ä¸€æ¬¡ time.Sleep(1 * time.Second)\tfunc main() http.HandleFunc(/events, sseHandler)\tlog.Println(Server started on port 8000...)\tlog.Fatal(http.ListenAndServe(:8000, nil))","tags":["Rust","Go","SSE"],"categories":["Rust","Rust å®æˆ˜"]},{"title":"Rust å®æˆ˜ä¸¨é€šè¿‡å®ç° json! æŒæ¡å£°æ˜å®","path":"/2024/05/28/rust-action-macro-json/","content":"åœ¨ Rust ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œå®æ˜¯ä¸€ç§å¼ºå¤§çš„å·¥å…·ï¼Œå¯ä»¥ç”¨äºåœ¨ç¼–è¯‘æ—¶ç”Ÿæˆä»£ç ã€‚json! æ˜¯ä¸€ä¸ªåœ¨ Rust ä¸­å¹¿æ³›ä½¿ç”¨çš„å®ï¼Œå®ƒå…è®¸æˆ‘ä»¬åœ¨ Rust ä»£ç ä¸­æ–¹ä¾¿åœ°åˆ›å»º JSON æ•°æ®ã€‚ å£°æ˜å®ï¼ˆdeclarative macrosï¼‰æ˜¯ Rust ä¸­çš„ä¸€ç§å®ï¼Œå®ƒä»¬ä½¿ç”¨ macro_rules! å…³é”®å­—å®šä¹‰ã€‚ æœ¬æ–‡å°†å‚è€ƒã€ŠRust ç¨‹åºè®¾è®¡ï¼ˆç¬¬äºŒç‰ˆï¼‰ã€‹ï¼Œé€šè¿‡å®ç° json! å®ï¼Œæ·±å…¥ç†è§£å£°æ˜å®çš„å·¥ä½œåŸç†ã€‚ ç»“è®ºå…ˆè¡Œ æœ¬æ–‡æˆ‘ä»¬å°†æ„å»ºä¸€ä¸ª json! å®ï¼Œå®ƒæ”¯æŒæˆ‘ä»¬ä»¥å­—ç¬¦ä¸² JSON é£æ ¼çš„è¯­æ³•æ¥ç¼–å†™ Json å€¼ã€‚å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š let students = json![ name: Hedon Wang, class_of: 2022, major: Software engineering\t, name: Jun Lei, class_of: 1991, major: Computor science\t] å®Œæ•´ä»£ç  å®ç° json! å®šä¹‰ Json enum é¦–å…ˆæˆ‘ä»¬éœ€è¦æ€è€ƒä¸€ä¸‹ Json ç»“æ„æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿä¸»è¦æ˜¯ä»¥ä¸‹ 3 ç§æ¨¡å¼ï¼š name: hedon, age: 18, school: name: Wuhan University, address: Hubwi Wuhan [ name: hedon\t, name: john\t] null ä¸ºæ­¤æˆ‘ä»¬å®šä¹‰ä¸€ä¸ª Json ç»“æ„çš„æšä¸¾ï¼š #[derive(Clone, PartialEq, Debug)]pub enum Json Null, Boolean(bool), Number(f64), String(String), Array(VecJson), Object(HashMapString, Json), ä½ åº”è¯¥å¯ä»¥æ„Ÿåˆ°éå¸¸å¥‡å¦™ï¼Œä½¿ç”¨ä¸€ä¸ªè¿™ä¹ˆç®€å•çš„æšä¸¾ï¼Œå±…ç„¶å°±å¯ä»¥è¡¨ç¤ºæ‰€æœ‰çš„ Json ç»“æ„äº†ã€‚é—æ†¾çš„æ˜¯ï¼Œç°åœ¨è¿™ä¸ªç»“æ„ç¼–å†™ Json å€¼çš„è¯­æ³•ç›¸å½“å†—é•¿ã€‚ let people = Json::Object(HashMap::from([ (name.to_string(), Json::String(hedon.to_string())), (age.to_string(), Json::Number(10.0)), (is_student.to_string(), Json::Boolean(true)), ( detail.to_string(), Json::Object(HashMap::from([ (address.to_string(), Json::String(beijing.to_string())), (phone.to_string(), Json::String(1234567890.to_string())) ])) )])) æˆ‘ä»¬æœŸæœ›å¯ä»¥ä»¥ä¸‹é¢è¿™ç§æ–¹å¼æ¥å£°æ˜ Json å˜é‡ï¼Œè¿™çœ‹èµ·æ¥å°±æ¸…çˆ½è®¸å¤šäº†ã€‚ let students = json!([ name: Jim Blandy, class_of: 1926, major: Tibetan throat singing , name: Jason Orendorff, class_of: 1702, major: Knots ]); çŒœæƒ³ json! æˆ‘ä»¬å¯ä»¥é¢„è§ Json å®å†…éƒ¨å°†ä¼šæœ‰å¤šæ¡è§„åˆ™ï¼Œå› ä¸º JSON æ•°æ®æœ‰å¤šç§ç±»å‹ï¼šå¯¹è±¡ã€æ•°ç»„ã€æ•°å€¼ç­‰ã€‚äº‹å®ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥åˆç†åœ°çŒœæµ‹æ¯ç§ JSON ç±»å‹éƒ½å°†æœ‰ä¸€æ¡è§„åˆ™ï¼š macro_rules! json (null) = Json::Null ; ([ ... ]) = Json::Array(...) ; ( ... ) = Json::Object(...) ; (???) = Json::Boolean(...) ; (???) = Json::Number(...) ; (???) = Json::String(...) ; ç„¶è€Œè¿™ä¸å¤ªæ­£ç¡®ï¼Œå› ä¸ºå®æ¨¡å¼æ— æ³•åŒºåˆ†æœ€å 3 ç§æƒ…å†µï¼Œç¨åæˆ‘ä»¬ä¼šè®¨è®ºå¦‚ä½•å¤„ç†ã€‚è‡³äºå‰ 3 ç§æƒ…å†µï¼Œæ˜¾ç„¶å®ƒä»¬æ˜¯ä»¥ä¸åŒçš„è¯­æ³•æ ‡è®°å¼€å§‹çš„ï¼Œæ‰€ä»¥è¿™å‡ ç§æƒ…å†µæ¯”è¾ƒå¥½å¤„ç†ã€‚ å®ç° Null æˆ‘ä»¬å…ˆä»æœ€ç®€å•çš„ Null åˆ†æ”¯å¼€å§‹ï¼Œå…ˆç¼–å†™å¦‚ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼š #[cfg(test)]mod tests use super::*; #[test] fn test_null_json() let json = json!(null); assert_eq!(json, Json::Null); æƒ³è¦é€šè¿‡ä¸Šè¿°æµ‹è¯•ç”¨ä¾‹éå¸¸ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ macro_rules! æ”¯æŒä¸­åŒ¹é…è¿™ç§æƒ…å†µå³å¯ï¼š #[macro_export]macro_rules! json (null) = Json::Null ; #[macro_export] æ³¨è§£æ˜¯ Rust ä¸­çš„ä¸€ä¸ªå±æ€§ï¼Œç”¨äºæŒ‡ç¤ºè¿™ä¸ªå®åº”è¯¥è¢«å¯¼å‡ºåˆ°è°ƒç”¨è€…çš„ä½œç”¨åŸŸä¸­ï¼Œè¿™æ ·å…¶ä»–æ¨¡å—ä¹Ÿå¯ä»¥ä½¿ç”¨å®ƒã€‚ macro_rules! å®å®šä¹‰äº†ä¸€ä¸ªè‡ªå®šä¹‰çš„å®ã€‚åœ¨è¿™é‡Œï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªåä¸º json çš„å®ï¼Œç”¨äºç”Ÿæˆ JSON æ•°æ®ã€‚ å®å®šä¹‰ä¸­ (null) æ˜¯åŒ¹é…æ¨¡å¼ã€‚è¿™æ„å‘³ç€å½“ä½ è°ƒç”¨ json! å®å¹¶ä¼ é€’ null ä½œä¸ºå‚æ•°æ—¶ï¼Œå°†ä¼šè§¦å‘è¿™ä¸ªè§„åˆ™ã€‚ = ç¬¦å·ç”¨äºæŒ‡ç¤ºåŒ¹é…æ¨¡å¼åçš„ä»£ç å—ã€‚åœ¨è¿™é‡Œï¼Œå®ƒæŒ‡å®šäº†å½“åŒ¹é… (null) æ—¶åº”è¯¥ç”Ÿæˆçš„ä»£ç å—ã€‚ Json::Null æ˜¯ä¸€ä¸ª JSON ç±»å‹çš„æšä¸¾å€¼ï¼Œè¡¨ç¤º JSON ä¸­çš„ null å€¼ã€‚è¿™ä¸ªå®çš„ç›®çš„æ˜¯å°†ä¼ å…¥çš„ null è½¬æ¢ä¸º Json::Nullã€‚ å®ç° Boolean/Number/String æˆ‘ä»¬å…ˆå‡†å¤‡å¦‚ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼š #[test]fn test_boolean_number_string_json() let json = json!(true); assert_eq!(json, Json::Boolean(true)); let json = json!(1.0); assert_eq!(json, Json::Number(1.0)); let json = json!(hello); assert_eq!(json, Json::String(hello.to_string())); é€šè¿‡è§‚å¯Ÿåˆ†æï¼Œå®ƒä»¬å…¶å®éƒ½æ˜¯åŒä¸€ç§æ¨¡å¼ï¼š Boolean/Number/String åˆ†æ ç°åœ¨éœ€è¦è§£å†³çš„é—®é¢˜å°±æ˜¯ï¼Œå¦‚ä½•å°†è¿™ 3 ç§æ¨¡å¼è¿›è¡Œç»Ÿä¸€ï¼Œè¿™æ ·åœ¨ macro_rules! ä¸­æ‰å¯ä»¥ç»Ÿä¸€åŒ¹é…æ¨¡å¼å¹¶è¿›è¡Œä»£ç ç”Ÿæˆã€‚ è¿™é‡Œæˆ‘ä»¬å…¶å®éœ€è¦åšçš„å°±æ˜¯å°† boolã€f64 å’Œ str è½¬ä¸ºå¯¹åº”çš„ Json ç±»å‹ã€‚é‚£å°±éœ€è¦ç”¨åˆ°æ ‡å‡†åº“ä¸­çš„ From trait äº†ã€‚ åšæ³•å¾ˆç®€å•ï¼Œæˆ‘ä»¬å®ç°å¦‚ä¸‹ä»£ç ï¼š impl Frombool for Json fn from(value: bool) - Self Json::Boolean(value) impl Fromstr for Json fn from(value: str) - Self Json::String(value.to_string()) impl Fromf64 for Json fn from(value: f64) - Self Json::Number(value) ç„¶åå®Œå–„æˆ‘ä»¬çš„ json!ï¼Œç›®å‰çš„å®ç°å¦‚ä¸‹ï¼š #[macro_export]macro_rules! json (null) = Json::Null ; ($value: tt) = Json::from($value) ; è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ $valueä½œ ä¸ºå˜é‡æ¥æ‰¿æ¥åŒ¹é…åˆ°çš„å…ƒç´ ï¼Œå…¶ç±»å‹ä¸º tt ï¼Œè¡¨ç¤ºä»»æ„çš„è¯­æ³•æ ‡è®°æ ‘ã€‚å…·ä½“å¯ä»¥å‚è€ƒï¼šç‰‡æ®µç±»å‹ã€‚ è¿™æ—¶è¿è¡Œä¸Šè¿°æµ‹è¯•ç”¨ä¾‹ï¼Œæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼š PASS [ 0.004s] json-macro tests::test_boolean_number_string_jsonPASS [ 0.004s] json-macro tests::test_null_json ç¾ä¸­ä¸è¶³çš„æ˜¯ï¼ŒJSON ç»“æ„ä¸­çš„æ•°å­—ç±»å‹ï¼Œå…¶å®ä¸ä¸€å®šæ˜¯ f64ï¼Œä¹Ÿå¯ä»¥æ˜¯ i32ã€u32ã€f32 æˆ–å…¶ä»–çš„æ•°å­—ç±»å‹ï¼Œå¦‚æœæˆ‘ä»¬è¦ä¸ºè¿™å…¨éƒ¨çš„æ•°å­—ç±»å‹éƒ½å®ç°åˆ° Json çš„ From traitï¼Œé‚£å°±å¤šå†—ä½™ã€‚ è¿™ä¸ªæ—¶å€™æˆ‘ä»¬åˆå¯ä»¥å®ç°ä¸€ä¸ªå®ï¼Œç”¨äºå¿«é€Ÿç”Ÿæˆ impl FromT for Json ã€‚è¿™ä¸ªå®ç°æ¯”è¾ƒç®€å•ï¼Œæœ¬æ–‡å°±ä¸èµ˜è¿°äº†ï¼Œä»£ç å¦‚ä¸‹ï¼š #[macro_export]macro_rules! impl_from_for_primitives ( $( $type: ty ) * ) = $( impl From$type for Json fn from(value: $type) - Self Json::Number(value as f64) )* ç„¶åæˆ‘ä»¬åªéœ€è¦ç”¨ä¸‹é¢è¿™ä¸€è¡Œä»£ç ï¼Œå°±å¯ä»¥ä¸ºæ‰€æœ‰çš„æ•°å­—ç±»å‹å®ç° From trait äº†ï¼š impl_from_for_primitives!(u8 u16 u32 u64 i8 i16 i32 i64 f32 f64 isize usize); è®°å¾—è¿™ä¸ªæ—¶å€™ä½ è¦åˆ é™¤ä¸Šé¢æ‰‹åŠ¨å®ç°çš„ impl Fromf64 for Jsonï¼Œä¸ç„¶ä¼šæœ‰ impl å†²çªé”™è¯¯ã€‚ å†æ¬¡è¿è¡Œæµ‹è¯•ï¼Œä¹Ÿæ˜¯å¯ä»¥é€šè¿‡çš„ã€‚ å®ç° Array å‡†å¤‡å¦‚ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼š #[test]fn test_array_json() let json = json!([1, null, string, true]); assert_eq!( json, Json::Array(vec![ Json::Number(1.0), Json::Null, Json::String(string.to_string()), Json::Boolean(true) ]) ) è¦åŒ¹é… [1, null, \"string\", true]è¿™ä¸ªæ¨¡å¼ï¼Œç¬”è€…çš„åˆ†æè¿‡ç¨‹å¦‚ä¸‹ï¼š é¦–å…ˆæ˜¯å¤–é¢çš„ä¸¤ä¸ªä¸­æ‹¬å· [ å’Œ ] ï¼› å†å¾€é‡Œï¼Œæ˜¯ä¸€ä¸ªé‡å¤åŒ¹é…çš„æ¨¡å¼ï¼Œä»¥ , åˆ†å‰²ï¼Œå¯ä»¥åŒ¹é… 0 åˆ°ä»»æ„å¤šä¸ªå…ƒç´ ï¼Œæ‰€ä»¥æ˜¯ $( ,*) ï¼Œå…·ä½“å¯ä»¥å‚è€ƒï¼šé‡å¤æ¨¡å¼ï¼› æœ€é‡Œé¢å°±æ˜¯ç¬¬ 2 æ­¥è¦åŒ¹é…çš„å…ƒç´ äº†ï¼Œæˆ‘ä»¬å…ˆç”¨ $element ä½œä¸ºå˜é‡æ¥æ‰¿æ¥æ¯ä¸€ä¸ªå…ƒç´ ï¼Œå…¶ç±»å‹ä¸º tt ï¼Œè¡¨ç¤ºä»»æ„çš„è¯­æ³•æ ‡è®°æ ‘ã€‚ åˆ†æå®ŒåŒ¹é…çš„è¡¨è¾¾å¼åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°ï¼š ([ $( $element:tt ), * ]) = /* TODO */ æˆ‘ä»¬è¦ç”Ÿæˆçš„ä»£ç é•¿è¿™ä¸ªæ ·å­ï¼š Json::Array(vec![ Json::Number(1.0), Json::Null, Json::String(string.to_string()), Json::Boolean(true)]) å…¶å®å°±æ˜¯ä¸€ä¸ª vec!ï¼Œç„¶åé‡Œé¢æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ª Jsonï¼Œå¦‚æ­¤é€’å½’ä¸‹å»ã€‚ å³å¯ä»¥å¾—åˆ°ä»£ç ç”Ÿæˆéƒ¨åˆ†çš„é€»è¾‘ä¸ºï¼š Json::Array(vec![$(json!($element)),* ]) Json::Array å®åˆ†æ ç»¼ä¸Šï¼Œæˆ‘ä»¬å®ç°çš„ä»£ç å¦‚ä¸‹ï¼š #[macro_export]macro_rules! json (null) = Json::Null ; ([ $( $element: tt),* ]) = Json::Array(vec![ $( json!($element)), * ]) ; ($value: tt) = Json::from($value) ; è¿è¡Œæµ‹è¯•ç”¨ä¾‹ï¼š PASS [ 0.003s] json-macro tests::test_null_jsonPASS [ 0.003s] json-macro tests::test_boolean_number_string_jsonPASS [ 0.004s] json-macro tests::test_array_json å®ç° Object å†™å¥½å¦‚ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼Œè¿™æ¬¡æˆ‘ä»¬é¡ºå¸¦æŠŠ Nullã€Booleanã€Number å’Œ String å¸¦ä¸Šäº†ï¼š #[test]fn test_object_json() let json = json!( null: null, name: hedon, age: 10, is_student: true, detail: address: beijing, phone: 1234567890 ); assert_eq!( json, Json::Object(HashMap::from([ (name.to_string(), Json::String(hedon.to_string())), (age.to_string(), Json::Number(10.0)), (is_student.to_string(), Json::Boolean(true)), ( detail.to_string(), Json::Object(HashMap::from([ (address.to_string(), Json::String(beijing.to_string())), (phone.to_string(), Json::String(1234567890.to_string())) ])) ) ])) ) å¯¹æ¯”é¢„æœŸçš„ json! å®å†…å®¹å’Œå±•å¼€åçš„ä»£ç ï¼š Json::Object å®åˆ†æ å®Œå–„æˆ‘ä»¬çš„ macro_rules! json ï¼š #[macro_export]macro_rules! json (null) = Json::Null ; ([ $( $element: tt),* ]) = Json::Array(vec![ $( json!($element)), * ]) ; ( $( $key:tt : $value:tt ),* ) = Json::Object(HashMap::from([ $( ( $key.to_string(), json!($value) ) ), * ])) ; ($value: tt) = Json::from($value) ; è¿è¡Œæµ‹è¯•ç”¨ä¾‹ï¼š PASS [ 0.004s] json-macro tests::test_object_jsonPASS [ 0.005s] json-macro tests::test_array_jsonPASS [ 0.004s] json-macro tests::test_null_jsonPASS [ 0.005s] json-macro tests::test_boolean_number_string_json è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®Œæˆäº† json! å®çš„æ„å»ºäº†ï¼å®Œæ•´æºç å¯è§ï¼šå®Œæ•´ä»£ç  Peace! Enjoy coding~ é™„å½• é‡å¤æ¨¡å¼ åœ¨ å®ç° Array ä¸­ï¼Œæˆ‘ä»¬åŒ¹é…äº†è¿™æ ·ä¸€ä¸ªæ¨¡å¼ï¼š ([ $( $element:tt ), * ]) = /* TODO */ å…¶ä¸­ $($element:tt), *) å°±æ˜¯ä¸€ä¸ªé‡å¤æ¨¡å¼ï¼Œå…¶å¯ä»¥è¿›ä¸€æ­¥æŠ½è±¡ä¸º $( ... ),* ï¼Œè¡¨ç¤ºåŒ¹é… 0 æ¬¡æˆ–å¤šæ¬¡ï¼Œä»¥ , åˆ†éš”ã€‚ Rust æ”¯æŒä»¥ä¸‹å…¨éƒ¨é‡å¤æ¨¡å¼ï¼š æ¨¡å¼ å«ä¹‰ $( â€¦ ) * åŒ¹é… 0 æ¬¡æˆ–å¤šæ¬¡ï¼Œæ²¡æœ‰åˆ†éš”ç¬¦ $( â€¦ ), * åŒ¹é… 0 æ¬¡æˆ–å¤šæ¬¡ï¼Œä»¥é€—å·åˆ†éš” $( â€¦ ); * åŒ¹é… 0 æ¬¡æˆ–å¤šæ¬¡ï¼Œä»¥åˆ†å·åˆ†éš” $( â€¦ ) + åŒ¹é… 1 æ¬¡æˆ–å¤šæ¬¡ï¼Œæ²¡æœ‰åˆ†éš”ç¬¦ $( â€¦ ), + åŒ¹é… 1 æ¬¡æˆ–å¤šæ¬¡ï¼Œä»¥é€—å·åˆ†éš” $( â€¦ ); + åŒ¹é… 1 æ¬¡æˆ–å¤šæ¬¡ï¼Œä»¥åˆ†å·åˆ†éš” $( â€¦ ) ? åŒ¹é… 0 æ¬¡æˆ– 1 æ¬¡ï¼Œæ²¡æœ‰åˆ†éš”ç¬¦ å³ï¼š * è¡¨ç¤º 0 æ¬¡æˆ–å¤šæ¬¡ + è¡¨ç¤º 1 æ¬¡æˆ–å¤šæ¬¡ ? è¡¨ç¤º 0 æ¬¡æˆ– 1 æ¬¡ å¯åœ¨ä¸Šè¿° 3 è€…ä¹‹å‰åŠ å…¥åˆ†éš”ç¬¦ ç‰‡æ®µç±»å‹ åœ¨ å®ç° Array ä¸­ï¼Œæˆ‘ä»¬åŒ¹é…äº†è¿™æ ·ä¸€ä¸ªæ¨¡å¼ï¼š ([ $( $element:tt ), * ]) = /* TODO */ è¿™é‡Œæˆ‘ä»¬å°† $element æŒ‡å®šä¸º ttï¼Œè¿™ä¸ª tt å°±æ˜¯å®ä¸­çš„ä¸€ç§ç‰‡æ®µç±»å‹ã€‚ tt èƒ½åŒ¹é…å•ä¸ªè¯­æ³•æ ‡è®°æ ‘ï¼ŒåŒ…å«ï¼š ä¸€å¯¹æ‹¬å·ï¼Œå¦‚ (..)ã€[..]ã€æˆ– .. ï¼Œä»¥åŠä½äºå…¶ä¸­çš„æ‰€æœ‰å†…å®¹ï¼ŒåŒ…æ‹¬åµŒå¥—çš„è¯­æ³•æ ‡è®°æ ‘ã€‚ å•ç‹¬çš„éæ‹¬å·è¯­æ³•æ ‡è®°ï¼Œæ¯”å¦‚ 1926 æˆ– Knots ã€‚ æ‰€ä»¥ä¸ºäº†åŒ¹é…ä»»æ„ç±»å‹çš„ Json ï¼Œæˆ‘ä»¬é€‰æ‹©äº† tt ä½œä¸º $element çš„ç‰‡æ®µç±»å‹ã€‚ macro_rules! æ”¯æŒçš„ç‰‡æ®µç±»å‹å¦‚ä¸‹æ‰€ç¤ºï¼š ç‰‡æ®µç±»å‹ åŒ¹é…ï¼ˆå¸¦ä¾‹å­ï¼‰ åé¢å¯ä»¥è·Ÿ Â·Â·Â·Â·Â·Â· expr è¡¨è¾¾å¼ï¼š2 + 2, \"udon\", x.len() =,; stmt è¡¨è¾¾å¼æˆ–å£°æ˜ï¼Œä¸åŒ…æ‹¬ä»»ä½•å°¾éšåˆ†å·ï¼ˆå¾ˆéš¾ç”¨ï¼Œè¯·å°è¯•ä½¿ç”¨ expr æˆ– blockï¼‰ =,; ty ç±»å‹ï¼šString, Vec, (str, bool), dyn Read + Send =,; = path è·¯å¾„ï¼šferns, ::std::sync::mpsc =,; = pat æ¨¡å¼ï¼š_, Some(ref x) =,= item è¯­æ³•é¡¹ï¼šstruct Point { x: f64, y: f64 }, mod ferns; ä»»æ„ block å—ï¼š{ s += \"ok\"; true } ä»»æ„ meta å±æ€§çš„ä¸»ä½“ï¼šinline, derive(Copy, Clone), doc=\"3D models.\" ä»»æ„ literal å­—é¢é‡å€¼ï¼š1024, \"Hello, world!\", 1_000_000f64 ä»»æ„ lifetime ç”Ÿå‘½å‘¨æœŸï¼š'a, 'item, 'static ä»»æ„ vis å¯è§æ€§è¯´æ˜ç¬¦ï¼špub, pub(crate), pub(in module::submodule) ä»»æ„ ident æ ‡è¯†ç¬¦ï¼šstd, Json, longish_variable_name ä»»æ„ tt è¯­æ³•æ ‡è®°æ ‘ï¼š;, =, {}, [0 1 (+ 0 1)] ä»»æ„ å®Œæ•´ä»£ç  use std::collections::HashMap;#[derive(Debug, Clone, PartialEq)]#[allow(unused)]enum Json Null, Boolean(bool), String(String), Number(f64), Array(VecJson), Object(HashMapString, Json),impl Frombool for Json fn from(value: bool) - Self Json::Boolean(value) impl Fromstr for Json fn from(value: str) - Self Json::String(value.to_string()) impl FromString for Json fn from(value: String) - Self Json::String(value) #[macro_export]macro_rules! impl_from_for_primitives ( $( $type: ty ) * ) = $( impl From$type for Json fn from(value: $type) - Self Json::Number(value as f64) )* impl_from_for_primitives!(u8 u16 u32 u64 i8 i16 i32 i64 f32 f64 isize usize);#[macro_export]macro_rules! json (null) = Json::Null ; ([ $( $element: tt),* ]) = Json::Array(vec![ $( json!($element)), * ]) ; ( $( $key:tt : $value:tt ),* ) = Json::Object(HashMap::from([ $( ( $key.to_string(), json!($value) ) ), * ])) ; ($value: tt) = Json::from($value) ;#[cfg(test)]mod tests use super::*; #[test] fn test_null_json() let json = json!(null); assert_eq!(json, Json::Null); #[test] fn test_boolean_number_string_json() let json = json!(true); assert_eq!(json, Json::Boolean(true)); let json = json!(1.0); assert_eq!(json, Json::Number(1.0)); let json = json!(hello); assert_eq!(json, Json::String(hello.to_string())); #[test] fn test_object_json() let json = json!( null: null, name: hedon, age: 10, is_student: true, detail: address: beijing, phone: 1234567890 ); assert_eq!( json, Json::Object(HashMap::from([ (null.to_string(), Json::Null), (name.to_string(), Json::String(hedon.to_string())), (age.to_string(), Json::Number(10.0)), (is_student.to_string(), Json::Boolean(true)), ( detail.to_string(), Json::Object(HashMap::from([ (address.to_string(), Json::String(beijing.to_string())), (phone.to_string(), Json::String(1234567890.to_string())) ])) ) ])) ) #[test] fn test_array_json() let json = json!([1, null, string, true]); assert_eq!( json, Json::Array(vec![ Json::Number(1.0), Json::Null, Json::String(string.to_string()), Json::Boolean(true) ]) )","tags":["Rust","å®","å…ƒç¼–ç¨‹"],"categories":["Rust","Rust å®æˆ˜"]},{"title":"xgo åŸç†æ¢ç´¢","path":"/2024/05/23/go-xgo-explore/","content":"Go å•æµ‹ mock æ–¹æ¡ˆ Mock æ–¹æ³• åŸç† ä¾èµ– ä¼˜ç‚¹ ç¼ºç‚¹ æ¥å£ Mock ä¸ºä¾èµ–é¡¹å®šä¹‰æ¥å£ï¼Œå¹¶æä¾›æ¥å£çš„ Mock å®ç°ã€‚ éœ€è¦å®šä¹‰æ¥å£å’Œ Mock å®ç°ã€‚ çµæ´»ï¼Œéµå¾ª Go çš„ç±»å‹ç³»ç»Ÿï¼›æ˜“äºæ›¿æ¢å®ç°ã€‚ éœ€è¦æ›´å¤šçš„æ ·æ¿ä»£ç æ¥å®šä¹‰æ¥å£å’Œ Mock å®ç°ã€‚ Monkey Patchingï¼ˆbouk/monekyï¼‰ ç›´æ¥ä¿®æ”¹å‡½æ•°æŒ‡é’ˆçš„å†…å­˜åœ°å€æ¥å®ç°å¯¹å‡½æ•°çš„æ›¿æ¢ã€‚ å†…å­˜ä¿æŠ¤ï¼›æ±‡ç¼–ä»£ç ã€‚ å¼ºå¤§ï¼Œå¯ä»¥ Mock ä»»ä½•å‡½æ•°ï¼Œç”šè‡³ç¬¬ä¸‰æ–¹åº“çš„å‡½æ•°ã€‚ å¤æ‚ï¼Œå®¹æ˜“å‡ºé”™ï¼›çº¿ç¨‹ä¸å®‰å…¨ï¼›ä¾èµ–ç³»ç»ŸæŒ‡ä»¤é›†ã€‚ bouk/monkey å¼Šç«¯ bouk/monkey ğŸ’ monkey çš„æ ¸å¿ƒåŠŸèƒ½æ˜¯èƒ½å¤Ÿåœ¨è¿è¡Œæ—¶æ›¿æ¢æŸä¸ªå‡½æ•°çš„å®ç°ã€‚ åŸç†ï¼š å‡½æ•°æŒ‡é’ˆæ›¿æ¢ï¼šåœ¨ Go è¯­è¨€ä¸­ï¼Œå‡½æ•°çš„åœ°å€å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚bouk/monkey é€šè¿‡ç›´æ¥ä¿®æ”¹å‡½æ•°æŒ‡é’ˆçš„å†…å­˜åœ°å€æ¥å®ç°å¯¹å‡½æ•°çš„æ›¿æ¢ã€‚ æ±‡ç¼–ä»£ç ï¼šä½¿ç”¨äº†æ±‡ç¼–ä»£ç æ¥å®ç°å¯¹å‡½æ•°å…¥å£çš„è·³è½¬ã€‚è¿™äº›æ±‡ç¼–ä»£ç ä¼šåœ¨å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œå°†æ‰§è¡Œæµé‡å®šå‘åˆ°æ–°çš„å‡½æ•°å®ç°ã€‚ å†…å­˜ä¿æŠ¤ï¼šä¸ºäº†ä¿®æ”¹å†…å­˜ä¸­çš„å‡½æ•°æŒ‡é’ˆï¼Œbouk/monkey éœ€è¦ä¸´æ—¶ä¿®æ”¹å†…å­˜é¡µé¢çš„ä¿æŠ¤å±æ€§ï¼ˆä¾‹å¦‚ï¼Œå°†é¡µé¢è®¾ä¸ºå¯å†™ï¼‰ã€‚åœ¨ä¿®æ”¹å®Œæ¯•åï¼Œå®ƒä¼šæ¢å¤åŸæ¥çš„ä¿æŠ¤å±æ€§ã€‚ åå°„ä¸ unsafe åŒ…ï¼šåˆ©ç”¨ Go çš„åå°„æœºåˆ¶å’Œ unsafe åŒ…ï¼Œbouk/monkey å¯ä»¥è·å–å¹¶æ“ä½œå‡½æ•°çš„åº•å±‚å®ç°ç»†èŠ‚ã€‚ å®ç°æ­¥éª¤ï¼š ä¿å­˜åŸå‡½æ•°ï¼šåœ¨æ›¿æ¢å‡½æ•°ä¹‹å‰ï¼Œbouk/monkey ä¼šä¿å­˜åŸå§‹å‡½æ•°çš„æŒ‡é’ˆï¼Œä»¥ä¾¿åœ¨éœ€è¦æ—¶æ¢å¤æˆ–è°ƒç”¨åŸå§‹å‡½æ•°ã€‚ ç”Ÿæˆè·³è½¬ä»£ç ï¼šbouk/monkey ç”Ÿæˆä¸€æ®µæ±‡ç¼–è·³è½¬ä»£ç ï¼Œè¿™æ®µä»£ç ä¼šåœ¨å‡½æ•°è°ƒç”¨æ—¶ï¼Œå°†æ‰§è¡Œæµè·³è½¬åˆ°æ–°çš„å‡½æ•°å®ç°ã€‚ ä¿®æ”¹å‡½æ•°æŒ‡é’ˆï¼šä½¿ç”¨ unsafe åŒ…ï¼Œbouk/monkey ä¿®æ”¹ç›®æ ‡å‡½æ•°çš„å…¥å£åœ°å€ï¼ŒæŒ‡å‘ç”Ÿæˆçš„è·³è½¬ä»£ç ã€‚ æ¢å¤å†…å­˜ä¿æŠ¤ï¼šåœ¨å®Œæˆä¸Šè¿°ä¿®æ”¹åï¼Œæ¢å¤å†…å­˜é¡µé¢çš„ä¿æŠ¤å±æ€§ã€‚ æœ‰ä»¥ä¸‹å‡ ä¸ªå¼Šç«¯ï¼š å¦‚æœå¯ç”¨äº†å†…è”ï¼ŒMonkey æœ‰æ—¶æ— æ³•ä¿®è¡¥å‡½æ•°ã€‚å°è¯•åœ¨ç¦ç”¨å†…è”çš„æƒ…å†µä¸‹è¿è¡Œæµ‹è¯•ï¼Œä¾‹å¦‚: go test -gcflags=-lã€‚åŒæ ·çš„å‘½ä»¤è¡Œå‚æ•°ä¹Ÿå¯ä»¥ç”¨äºæ„å»ºã€‚ Monkey ä¸èƒ½åœ¨ä¸€äº›é¢å‘å®‰å…¨çš„æ“ä½œç³»ç»Ÿä¸Šå·¥ä½œï¼Œè¿™äº›æ“ä½œç³»ç»Ÿä¸å…è®¸åŒæ—¶å†™å…¥å’Œæ‰§è¡Œå†…å­˜é¡µã€‚ç›®å‰çš„æ–¹æ³•å¹¶æ²¡æœ‰çœŸæ­£å¯é çš„è§£å†³æ–¹æ¡ˆã€‚ çº¿ç¨‹ä¸å®‰å…¨çš„ã€‚ ä¾èµ–æŒ‡ä»¤é›†ã€‚ å…ˆçœ‹ xgo æ€ä¹ˆç”¨ xgo ğŸ˜ˆ ä»£ç ç»“æ„å¦‚ä¸‹ï¼š .â”œâ”€â”€ greet.goâ””â”€â”€ greet_test.go ç°åœ¨åœ¨ greet.go ä¸­æœ‰ä¸€ä¸ªå‡½æ•° greetï¼š func greet(s string) string return hello + s åœ¨çœŸå®çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œgreet å¯èƒ½è¦å¤æ‚å¾—å¤šï¼Œå®ƒå¯èƒ½ä¼šä¾èµ–å„ç§ç¬¬ä¸‰æ–¹ APIï¼Œä¹Ÿå¯èƒ½ä¼šä¾èµ–æ•°æ®åº“ç­‰å¤šç§å¤–éƒ¨ç»„ä»¶ã€‚æ‰€ä»¥åœ¨æµ‹è¯•çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¸Œæœ›å¯¹å…¶è¿›è¡Œ mockï¼Œä½¿å…¶è¿”å›ä¸€ä¸ªå›ºå®šçš„å€¼ï¼Œä¾¿äºæˆ‘ä»¬æ’°å†™å•å…ƒæµ‹è¯•ã€‚ xgo å‚è€ƒäº† go-monkey çš„æ€æƒ³ï¼Œä½†æ˜¯ä¸ä» ä¿®æ”¹æŒ‡ä»¤ è¿™ä¸ªé€”å¾„å…¥æ‰‹ï¼Œè€Œæ˜¯å¦è¾Ÿè¹Šå¾„ï¼Œä» ä»£ç é‡å†™ çš„è§’åº¦å®ç°äº† mock çš„èƒ½åŠ›ã€‚ ä¸ºäº†ä½¿ç”¨ xgoï¼Œæˆ‘ä»¬éœ€è¦å…ˆå®‰è£… xgo è¿™ä¸ªå‘½ä»¤ï¼š go install github.com/xhd2015/xgo/cmd/xgo@latest åŒæ—¶åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­éœ€è¦å¼•å…¥ xgo ä¾èµ–ï¼š go get github.com/xhd2015/xgo/runtime/mock æˆ‘ä»¬ç¼–å†™çš„ greet_test.go å¦‚ä¸‹ï¼š package xgo_useimport (\ttesting\tgithub.com/xhd2015/xgo/runtime/mock)func TestOriginGreet(t *testing.T) res := greet(world)\tif res != hello world t.Fatalf(greet() = %q; want %q, res, hello world)\tfunc TestMockGreet(t *testing.T) mock.Patch(greet, func(s string) string return mock + s\t)\tres := greet(world)\tif res != mock world t.Fatalf(greet() = %q; want %q, res, mock world) å¯ä»¥çœ‹åˆ°åœ¨ TestMockGreet è¿™ä¸ªå•å…ƒæµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬å°† greet è¿›è¡Œäº† mockï¼Œè¿”å› \"mock \" + sã€‚ mock.Patch(greet, func(s string) string return mock + s) ä¸ºäº†ä½¿ç”¨ xgo çš„èƒ½åŠ›ï¼Œæˆ‘ä»¬åœ¨æ‰§è¡Œå•å…ƒæµ‹è¯•çš„æ—¶å€™ï¼Œéœ€è¦è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š xgo test -v ./ è¾“å‡ºå¤§è‡´å¦‚ä¸‹ï¼š âœ xgo-use git:(master) xgo test -v ./xgo is taking a while to setup, please wait...=== RUN TestOriginGreet--- PASS: TestOriginGreet (0.00s)=== RUN TestMockGreet--- PASS: TestMockGreet (0.00s)PASSok xgo-explore/xgo-use (cached) xgo çš„æ ¸å¿ƒåŸç† xgo çš„æ ¸å¿ƒåŸç†æ˜¯åˆ©ç”¨ go build -toolexec çš„èƒ½åŠ›ã€‚ è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š go help build æ‰¾åˆ° toolexec çš„ç›¸å…³è¯´æ˜ï¼š -toolexec cmd args a program to use to invoke toolchain programs like vet and asm. For example, instead of running asm, the go command will run cmd args /path/to/asm arguments for asm. The TOOLEXEC_IMPORTPATH environment variable will be set, matching go list -f .ImportPath for the package being built. ä¸€è¨€ä»¥è”½ä¹‹ï¼š-toolexec å…è®¸å¯¹ go å·¥å…·é“¾è¿›è¡Œæ‹¦æˆªï¼ŒåŒ…æ‹¬ vetã€asmã€compile å’Œ linkã€‚ è¿™ç§æŠ€æœ¯ä¹Ÿè¢«ç§°ä¸ºï¼šæ’æ¡©ï¼ˆstubbingï¼‰ã€å¢å¼ºï¼ˆinstrumentationï¼‰å’Œä»£ç é‡å†™ï¼ˆrewritingï¼‰ã€‚ -toolexec ç¤ºæ„å›¾ï¼ˆæ¥æºï¼šhttps://blog.xhd2015.xyz/zh/posts/xgo-monkey-patching-in-go-using-toolexec/ï¼‰ åŸºäºä¸Šè¿°åˆ†æï¼Œxgo æå‡ºäº† ä»£ç é‡å†™ çš„æ€è·¯ï¼Œå®ç°äº† åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­æ’å…¥æ‹¦æˆªå™¨ä»£ç  çš„åŠŸèƒ½ï¼š xgo åœ¨ go build ä¸­çš„ä½œç”¨ä½ç½®ï¼ˆæ¥æºï¼šhttps://blog.xhd2015.xyz/zh/posts/xgo-monkey-patching-in-go-using-toolexec/ï¼‰ æ‰€ä»¥ä¸Šè¿°æˆ‘ä»¬çš„ greet.go æ–‡ä»¶ä¸­çš„æºä»£ç ï¼š func greet(s string) string return hello + s ç»è¿‡ xgo ç¼–è¯‘åæœ€ç»ˆå®é™…ç¼–è¯‘çš„ä»£ç å¦‚ä¸‹ï¼š import runtimefunc greet(s string) (r0 string) stop, post := runtime.__xgo_trap(Greet, s, r0) if stop return defer post() return hello + s greet å‡½æ•°é‡å†™å˜åŒ–ç¤ºæ„å›¾ï¼ˆæ¥æºï¼šhttps://blog.xhd2015.xyz/zh/posts/xgo-monkey-patching-in-go-using-toolexec/ï¼‰ å¦‚å›¾æ‰€ç¤ºï¼Œä¸€æ—¦å‡½æ•°è¢«è°ƒç”¨ï¼Œå®ƒçš„æ§åˆ¶æµé¦–å…ˆè½¬ç§»åˆ° Trapï¼Œç„¶åä¸€ç³»åˆ—æ‹¦æˆªå™¨å°†æ ¹æ®å…¶ç›®çš„æ£€æŸ¥å½“å‰è°ƒç”¨æ˜¯å¦åº”è¯¥è¢« Mockã€ä¿®æ”¹ã€è®°å½•æˆ–åœæ­¢ã€‚ å¦‚æœ greet æ³¨å†Œäº† mock å‡½æ•°ï¼Œé‚£ä¹ˆå°±ä¼šåœ¨ __xgo_trap ä¸­è°ƒç”¨ mock çš„å‡½æ•°ï¼Œå¹¶å°†è¿”å›å€¼è®¾ç½®åˆ° r0 ä¸Šè¿›è¡Œè¿”å›ï¼Œè€Œè·³è¿‡åŸå§‹çš„æ‰§è¡Œé€»è¾‘ã€‚ ç¬¬ 1 æ­¥ï¼šæ­»ä»£ç å®ç° âœ 01-deadcode git:(master) tree.â”œâ”€â”€ greet.goâ”œâ”€â”€ greet_test.goâ””â”€â”€ mock.go æˆ‘ä»¬å…ˆä»æœ€ç®€å•çš„å®ç°å¼€å§‹ï¼Œé‡‡ç”¨ä¾µå…¥æ€§ä»£ç å®ç° xgo çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œè¿™é‡Œæˆ‘ä»¬è¿˜ç”¨ä¸åˆ° -toolexecã€‚ ä»£ç ç»“æ„å¦‚ä¸Šæ‰€ç¤ºï¼Œåœ¨ mock.go ä¸­ï¼Œæˆ‘ä»¬æœ‰å¦‚ä¸‹ä»£ç ï¼š var mockFuncs = sync.Mapfunc RegisterMockFunc(funcName string, fun interface) mockFuncs.Store(funcName, fun) mockFuncs: ç”¨äºæ‰¿è½½å‡½æ•°ä¸ mock å‡½æ•°çš„å¯¹åº”å…³ç³»ï¼Œå…¶ä¸­ key ä¸ºå‡½æ•°åç§°ï¼Œvalue ä¸º mock å‡½æ•°ã€‚æˆ‘ä»¬ä½¿ç”¨ sync.Map æ¥ä¿è¯å¹¶å‘å®‰å…¨ã€‚ RegisterMockFunc ç”¨äºä¸ºæŒ‡å®šçš„ funcName æ³¨å†Œ mock å‡½æ•°ã€‚ åœ¨ greet.go ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ª Greet å‡½æ•°ï¼š func Greet(s string) string return hello + s å¦‚æœæˆ‘ä»¬è¦å¯¹å…¶æ”¯æŒ mockï¼Œé‚£ä¹ˆéœ€è¦ä¿®æ”¹å…¶å®ç°ä¸ºï¼š func Greet(s string) string fun, ok := mockFuncs.Load(Greet)\tif ok f, ok := fun.(func(s string) string) if ok return f(s) return hello + s åœ¨ä¿®æ”¹åçš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å…ˆåˆ¤æ–­æ˜¯å¦å­˜åœ¨ mock å‡½æ•°ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™æ‰§è¡Œ mock å‡½æ•°ï¼Œå¦åˆ™æ‰§è¡ŒåŸå§‹é€»è¾‘ã€‚ ç°åœ¨æˆ‘ä»¬åœ¨ greet_test.go ä¸­ç¼–å†™æµ‹è¯•ä»£ç ï¼š func TestMockGreet(t *testing.T) RegisterMockFunc(Greet, func(s string) string return mock + s\t)\tres := Greet(world)\tif res != mock world t.Fatalf(Greet() = %q; want %q, res, mock world)\tfunc TestOriginGreet(t *testing.T) res := Greet(world)\tif res != hello world t.Fatalf(Greet() = %q; want %q, res, hello world) æ‰§è¡Œæµ‹è¯•ï¼š # å•ç‹¬æ‰§è¡Œ TestMockGreetâœ 01-deadcode git:(master) âœ— go test -v -run TestMockGreet=== RUN TestMockGreet--- PASS: TestMockGreet (0.00s)PASSok xgo-explore/01-deadcode 0.103s# å•ç‹¬æ‰§è¡Œ TestOriginGreetâœ 01-deadcode git:(master) âœ— go test -v -run TestOriginGreet=== RUN TestOriginGreet--- PASS: TestOriginGreet (0.00s)PASSok xgo-explore/01-deadcode 0.102s# ä¸€èµ·æ‰§è¡Œâœ 01-deadcode git:(master) âœ— go test -v -run $Test$=== RUN TestMockGreet--- PASS: TestMockGreet (0.00s)=== RUN TestOriginGreet greet_test.go:20: Greet() = mock world; want hello world--- FAIL: TestOriginGreet (0.00s)FAILexit status 1FAIL xgo-explore/01-deadcode 0.102s æˆ‘ä»¬ä¼šå‘ç°å•ç‹¬æ‰§è¡Œéƒ½æ˜¯ ok çš„ï¼Œä¸è¿‡ä¸€èµ·æ‰§è¡Œçš„è¯ TestOriginGreet å°±å¤±è´¥äº†ï¼Œè¿™æ˜¯å› ä¸ºå…ˆæ‰§è¡Œäº† TestMockGreetï¼Œè¿™ä¸ªæ—¶å€™å·²ç»å¾€ mockFunc ä¸­æ³¨å†Œäº† mock å‡½æ•°äº†ï¼Œæ‰€ä»¥ TessOriginGreet å°±æ‰§è¡Œå¤±è´¥äº†ã€‚ è¿™é‡Œéœ€è¦åœ¨åç¨‹å±‚é¢ä¸Šåš mock éš”ç¦»ï¼Œxgo çš„æ€è·¯æ˜¯åœ¨ç¼–è¯‘æ—¶æ³¨å…¥ getg() å‡½æ•°æ¥è·å–å½“å‰åç¨‹ä¿¡æ¯ä»è€Œå®ç°åœ¨æ³¨å†Œ mock å‡½æ•°æ—¶è¿›è¡Œåç¨‹éš”ç¦»ã€‚æœ¬æ–‡å°†èšç„¦åœ¨ xgo çš„æ ¸å¿ƒåŸç† ä»£ç é‡å†™ ä¸Šï¼Œæ•…æš‚æ—¶ä¸è€ƒè™‘è¿™ä¸€å—ã€‚ Okï¼Œé‚£ä¹ˆçŸ­çŸ­å‡ è¡Œä»£ç ï¼Œæˆ‘ä»¬å°±å°† xgo çš„æœ€æ ¸å¿ƒæ€æƒ³ç»™å±•ç¤ºå‡ºæ¥äº†ã€‚å¯ä»¥çœ‹åˆ°ï¼Œxgo çš„æ ¸å¿ƒæ€æƒ³æ˜¯å¾€æºä»£ç ä¸­åŠ å…¥ åˆæ³•çš„ Go ä»£ç ï¼Œæ‰€ä»¥ä¸æ¶‰åŠæŒ‡ä»¤é‡å†™ï¼Œæ•…è€Œåªè¦ä½ çš„æœºå™¨èƒ½æ‰§è¡Œ Go ç¨‹åºï¼Œå¤©ç„¶å°±æ”¯æŒ mock åŠŸèƒ½ï¼Œè¿™å°±å¤©ç„¶è¾¾åˆ°äº†æ¶æ„æ— å…³çš„å…¼å®¹æ€§äº†ã€‚åŒæ—¶æˆ‘ä»¬ä¹Ÿä½¿ç”¨äº† sync.Map æ¥ä¿è¯äº†å¹¶å‘å®‰å…¨ã€‚ ç¬¬ 2 æ­¥ï¼šæ­»ä»£ç æ‹¦æˆªå™¨ âœ 02-deadcode-interceptor git:(master) tree.â”œâ”€â”€ greet.goâ”œâ”€â”€ greet_test.goâ””â”€â”€ mock.go åœ¨ç¬¬ 1 æ­¥ä¸­ï¼Œè¿™æ®µä»£ç æˆ‘è§‰å¾—æœ‰ç‚¹å†—é•¿äº†ï¼š fun, ok := mockFuncs.Load(Greet)if ok f, ok := fun.(func(s string) string) if ok return f(s) å‚è€ƒ xgo çš„å‡½æ•°ç­¾åï¼Œæˆ‘ä»¬å¯¹å…¶è¿›è¡Œä¼˜åŒ–ï¼Œåœ¨ mock.go ä¸­åŠ å…¥ä¸€ä¸ª ä¸ç‰ˆæ‹¦æˆªå™¨ï¼š // mock.gofunc InterceptMock(funcName string, arg string, result *string) bool fn, ok := mockFuncs.Load(funcName)\tif ok f, ok := fn.(func(s string) string) if ok *result = f(arg) return true return false å¯¹åº” greet.go ä¸­ Greet å‡½æ•°å°±ä¿®æ”¹ä¸ºï¼š func Greet(s string) (res string) if InterceptMock(Greet, s, res) return res return hello + s è¿™çœ‹èµ·æ¥å°±æ¸…çˆ½å¤šäº†ã€‚å†æ¬¡æ‰§è¡Œæµ‹è¯•ä»£ç ï¼Œä¸€æ ·æ˜¯å¯ä»¥é€šè¿‡çš„ã€‚ âœ 02-deadcode-interceptor git:(master) go test -v -run TestOriginGreet=== RUN TestOriginGreet--- PASS: TestOriginGreet (0.00s)PASSok xgo-explore/02-deadcode-interceptor 0.331sâœ 02-deadcode-interceptor git:(master) go test -v -run TestMockGreet=== RUN TestMockGreet--- PASS: TestMockGreet (0.00s)PASSok xgo-explore/02-deadcode-interceptor 0.103s ç¬¬ 3 æ­¥ï¼štoolexec åˆæ¢ âœ 03-toolexec-static git:(master) tree.â”œâ”€â”€ cmdâ”‚ â””â”€â”€ mytoolâ”‚ â””â”€â”€ mytool.goâ”œâ”€â”€ greet.goâ”œâ”€â”€ main.goâ”œâ”€â”€ mock.goâ””â”€â”€ script.sh è¿™é‡Œ mock.go æ²¡æœ‰ä»»ä½•å˜åŒ–ã€‚æˆ‘ä»¬æœŸæœ›ä½¿ç”¨ -toolexec æ¥ä¿®æ”¹æºä»£ç ï¼Œä»¥å®ç° mock æ— æºä»£ç ä¾µå…¥çš„ç‰¹æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ greet.to ä¸­å°† Greet å‡½æ•°æ¢å¤ä¸ºåªå…³æ³¨å®é™…åŠŸèƒ½çš„æ ·å­ï¼š func Greet(s string) (res string) return hello + s åŒæ—¶ä¸ºäº†æ›´å¥½åœ°æµ‹è¯•ä½¿ç”¨ -toolexec ç¼–è¯‘åçš„è¿è¡Œç»“æœï¼Œè¿™é‡Œå°† greet_test.go åˆ é™¤äº†å¹¶æ–°å¢äº† main.go æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š func main() res := Greet(world)\tif res != hello world log.Fatalf(Greet() = %q; want %q, res, hello world) RegisterMockFunc(Greet, func(s string) string return mock + s\t)\tres = Greet(world)\tif res != mock world log.Fatalf(Greet() = %q; want %q, res, mock world) log.Println(run successfully) é‚£ä¹ˆ -toolexec è¦æ‰§è¡Œçš„å‘½ä»¤æ€ä¹ˆå®ç°å‘¢ï¼Ÿåœ¨ Google æœç´¢ go toolexec ä½ ä¼šçœ‹åˆ°å®˜æ–¹ç»™å‡ºçš„ä¸€ä¸ªæ¡ˆä¾‹ï¼štoolexec.txtã€‚ æ ¸å¿ƒéƒ¨åˆ†åœ¨æœ€ä¸‹é¢ï¼Œå‚è€ƒè¿™ä¸ªç¤ºä¾‹ï¼Œæˆ‘ä»¬æ¥å®ç°è‡ªå·±çš„ toolexecï¼š mkdir -p cmd/mytooltouch cmd/mytool/mytool.go åœ¨mytool.go ä¸­ï¼Œæˆ‘ä»¬å…ˆå†™è¿™ä¹ˆç‚¹ä»£ç ï¼Œçœ‹ä¸€ä¸‹ä¼šè¾“å‡ºä»€ä¹ˆã€‚ func main() tool, args := os.Args[1], os.Args[2:]\tif len(args) 0 args[0] == -V=full // dont do anything to infuence the version full output. else if len(args) 0 fmt.Printf(tool: %s , tool) fmt.Printf(args: %v , args) // ç»§ç»­æ‰§è¡Œä¹‹å‰çš„å‘½ä»¤\tcmd := exec.Command(tool, args...)\tcmd.Stdout = os.Stdout\tcmd.Stderr = os.Stderr\tif err := cmd.Run(); err != nil log.Fatalf(run command error: %v , err) è¿™é‡Œæˆ‘ä»¬ä¼å›¾è¾“å‡ºæ‰§è¡Œçš„å·¥å…· tool åŠä¼ ç»™å®ƒçš„å‚æ•° argsã€‚ç”±äº -V=full çš„ä½œç”¨æ˜¯åœ¨ç»ˆç«¯è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦è·³è¿‡å®ƒï¼Œé¿å…äº§ç”Ÿå¹²æ‰°ã€‚è¾“å‡ºæ—¥å¿—åï¼Œæˆ‘ä»¬æš‚ä¸”å…ˆç»§ç»­æ‰§è¡ŒåŸå§‹çš„å‘½ä»¤ï¼Œä¸å¯¹ç¼–è¯‘è¿‡ç¨‹åšå…¶ä»–çš„å¹²æ‰°ã€‚ Okï¼Œç°åœ¨å°±æ¥çœ‹çœ‹è¿™ä¸ª -toolexec åˆ°åº•åšäº†ä»€ä¹ˆï¼Œåœ¨ 03-toolexec-static ç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š # æ¸…é™¤ç¼“å­˜ï¼Œä¸€ç›´ä½¿ç”¨æœ€æ–°çš„ç¼–è¯‘ç»“æœgo clean -cache -modcache -i -r# ç¼–è¯‘ mytoolgo build ./cmd/mytool# ç¼–è¯‘ä¸šåŠ¡ç¨‹åºgo build -toolexec=./mytool -o main å› ä¸ºè¿™å‡ ä¸ªå‘½ä»¤ç»å¸¸ä¼šç”¨åˆ°ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†å…¶å°è£…åˆ° script.sh æ–‡ä»¶ä¸­ï¼š touch script.shchmod +x script.sh å†…å®¹å¦‚ä¸‹ï¼š #!/bin/bashgo clean -cache -modcache -i -rgo build ./cmd/mytoolgo build -toolexec=./mytool -o main æ‰§è¡Œä¸Šè¿°å‘½ä»¤åï¼Œå¯ä»¥çœ‹åˆ°ä»¥ä¸‹è¾“å‡ºï¼š âœ 03-toolexec-static git:(master) ./script.sh# xgo-explore/03-toolexec-statictool: /opt/homebrew/Cellar/go/1.22.3/libexec/pkg/tool/darwin_arm64/compileargs: [-o $WORK/b001/_pkg_.a -trimpath $WORK/b001= -p main -lang=go1.22 -complete -buildid PcS9clqF_ny_Ds5N0i_s/PcS9clqF_ny_Ds5N0i_s -goversion go1.22.3 -c=4 -shared -nolocalimports -importcfg $WORK/b001/importcfg -pack ./greet.go ./main.go ./mock.go]# xgo-explore/03-toolexec-statictool: /opt/homebrew/Cellar/go/1.22.3/libexec/pkg/tool/darwin_arm64/linkargs: [-o $WORK/b001/exe/a.out -importcfg $WORK/b001/importcfg.link -buildmode=pie -buildid=KgnnCoU_6enHkOm-T62Z/PcS9clqF_ny_Ds5N0i_s/H80dtgGZw1L8mTtVqJBf/KgnnCoU_6enHkOm-T62Z -extld=cc $WORK/b001/_pkg_.a] å¯ä»¥çœ‹åˆ°æ‰§è¡Œäº† compile å’Œ link ä¸¤ä¸ªå·¥å…·ï¼Œcompile æ˜¯ç¼–è¯‘è¿‡ç¨‹ï¼Œå°†ç”Ÿæˆ .out æ–‡ä»¶ï¼Œè€Œ link æ˜¯å°†å¤šä¸ª .out æ–‡ä»¶é“¾æ¥æˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ã€‚è¿™æ˜¯å¾ˆç»å…¸çš„ç¼–è¯‘è¿‡ç¨‹ï¼Œå¦‚æœå¯¹ Go è¯­è¨€çš„ç¼–è¯‘è¿‡ç¨‹æ„Ÿå…´è¶£ï¼Œä¹Ÿå¯ä»¥å‚è€ƒå®˜æ–¹çš„ Go Compile Readmeï¼Œæˆ–è€…ç¬”è€…æ’°å†™çš„ Go1.21.0 ç¨‹åºç¼–è¯‘è¿‡ç¨‹ã€‚ è¿™é‡Œæˆ‘ä»¬éœ€è¦é‡ç‚¹å…³æ³¨çš„æ˜¯ compile å‘½ä»¤ï¼Œå®ƒæ˜¯è´Ÿè´£ç¼–è¯‘æºä»£ç çš„ï¼Œæ¶‰åŠåˆ°çš„æºä»£ç æ–‡ä»¶ä¼šé€šè¿‡ -pack ./greet.go ./main.go ./mock.go ä¼ é€’ç»™ compile å‘½ä»¤ã€‚ ç»“åˆ -toolexec çš„å¸®åŠ©ä¿¡æ¯ï¼š -toolexec cmd args a program to use to invoke toolchain programs like vet and asm. For example, instead of running asm, the go command will run cmd args /path/to/asm arguments for asm. The TOOLEXEC_IMPORTPATH environment variable will be set, matching go list -f .ImportPath for the package being built. æˆ‘ä»¬åªéœ€è¦åœ¨æ‰§è¡Œ compile å‘½ä»¤ä¹‹å‰ï¼Œåœ¨ cmd args è¿™ä¸ªç¯èŠ‚ï¼Œè¿›è¡Œ ä»£ç é‡å†™ å°±å¯ä»¥å®ç°æˆ‘ä»¬æƒ³è¦çš„åŠŸèƒ½äº†ã€‚ æˆ‘ä»¬ç°åœ¨æ˜¯è¦å¯¹ greet.go é‡Œé¢çš„ Greet å‡½æ•°è¿›è¡Œé‡å†™ï¼Œå…ˆçœ‹çœ‹ä¹‹å‰çš„ä»£ç ï¼š package mainfunc Greet(s string) (res string) return hello + s é‡å†™åçš„ä»£ç åº”è¯¥è·Ÿæˆ‘ä»¬ä¹‹å‰ ç¬¬ 2 æ­¥ æ˜¯ä¸€æ ·çš„ï¼š package mainfunc Greet(s string) (res string) if InterceptMock(Greet, s, res) return res return hello + s è¿™é‡Œæœ‰ n å¤šç§æ–¹å¼å¯ä»¥åšåˆ°ï¼Œç°åœ¨ç¬”è€…å†³å®šä½¿ç”¨æœ€æš´åŠ›çš„æ–¹å¼ï¼Œç›´æ¥ä¸´æ—¶åˆ›å»ºä¸€ä¸ªåŒ…å«è¿™æ®µä»£ç çš„æ–‡ä»¶ tmp.goï¼Œå¹¶æ›¿æ¢æ‰ä¼ ç»™ compile çš„å‚æ•°ï¼Œå³å°† -pack ./greet.go ./main.go ./mock.go æ›¿æ¢ä¸º -pack tmp.go ./main.go ./mock.go ç»¼ä¸Šï¼Œcmd/mytool/mytool/go å®ç°çš„ä»£ç å¦‚ä¸‹ï¼š func main() tool, args := os.Args[1], os.Args[2:]\tif len(args) 0 args[0] == -V=full // dont do anything to infuence the version full output. else if len(args) 0 if filepath.Base(tool) == compile index := findGreetFile(args) if index -1 f, err := os.Create(tmp.go) if err != nil log.Fatalf(create tmp.go error: %v , err) defer f.Close() defer os.Remove(tmp.go) _, _ = f.WriteString(newCode) args[index] = tmp.go fmt.Printf(tool: %s , tool) fmt.Printf(args: %v , args) // ç»§ç»­æ‰§è¡Œä¹‹å‰çš„å‘½ä»¤\tcmd := exec.Command(tool, args...)\tcmd.Stdout = os.Stdout\tcmd.Stderr = os.Stderr\tif err := cmd.Run(); err != nil log.Fatalf(run command error: %v , err)\tfunc findGreetFile(args []string) int for i, arg := range args if strings.Contains(arg, greet.go) return i return -1var newCode = `package mainfunc Greet(s string) (res string) if InterceptMock(Greet, s, res) return res return hello + s` è¿™é‡Œæˆ‘å…ˆä½¿ç”¨ findGreetFile æ¥æŸ¥æ‰¾ greet.go æ–‡ä»¶æ‰€å¤„çš„å‚æ•°ä½ç½®ï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œåˆ™ç”Ÿæˆæ–°çš„ tmp.go æ–‡ä»¶ï¼Œå¹¶æ›¿æ¢å‚æ•°ï¼Œæœ€ååœ¨ æœ¬æ¬¡ compile å‘½ä»¤æ‰§è¡Œå®Œæ¯•åï¼Œåˆ é™¤ tmp.goï¼Œâ€œæ¯å°¸ç­è¿¹â€ã€‚ æ‰§è¡Œ ./script.sh é‡æ–°ç¼–è¯‘ï¼š âœ 03-toolexec-static git:(master) âœ— ./script.sh# xgo-explore/03-toolexec-statictool: /opt/homebrew/Cellar/go/1.22.3/libexec/pkg/tool/darwin_arm64/compileargs: [-o $WORK/b001/_pkg_.a -trimpath $WORK/b001= -p main -lang=go1.22 -complete -buildid PcS9clqF_ny_Ds5N0i_s/PcS9clqF_ny_Ds5N0i_s -goversion go1.22.3 -c=4 -shared -nolocalimports -importcfg $WORK/b001/importcfg -pack tmp.go ./main.go ./mock.go]# xgo-explore/03-toolexec-statictool: /opt/homebrew/Cellar/go/1.22.3/libexec/pkg/tool/darwin_arm64/linkargs: [-o $WORK/b001/exe/a.out -importcfg $WORK/b001/importcfg.link -buildmode=pie -buildid=KgnnCoU_6enHkOm-T62Z/PcS9clqF_ny_Ds5N0i_s/H80dtgGZw1L8mTtVqJBf/KgnnCoU_6enHkOm-T62Z -extld=cc $WORK/b001/_pkg_.a] è¾“å‡ºçš„ç»“æœä¸­å¯ä»¥çœ‹åˆ°å·²ç»å°† compile çš„å‚æ•°æ›¿æ¢ä¸º -pack tmp.go ./main.go ./mock.go äº†ã€‚ ç°åœ¨æˆ‘ä»¬æ¥æ‰§è¡Œç”Ÿæˆçš„ç¨‹åºæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯æ‰§è¡ŒæˆåŠŸçš„ã€‚ âœ 03-toolexec-static git:(master) âœ— ./main2024/05/23 17:53:52 run successfully å¦‚æœæˆ‘ä»¬ä¸ä½¿ç”¨ -toolexecï¼Œæ˜¯æ‰§è¡Œä¸æˆåŠŸçš„ï¼š âœ 03-toolexec-static git:(master) âœ— go clean -cache -modcache -i -râœ 03-toolexec-static git:(master) âœ— go build -o mainâœ 03-toolexec-static git:(master) âœ— ./main2024/05/23 17:54:33 Greet() = hello world; want mock world ç¬¬ 4 æ­¥ï¼šä½¿ç”¨ AST åœ¨å‡½æ•°å‰æ’å…¥ä»£ç  âœ 04-toolexec-ast git:(master) âœ— tree.â”œâ”€â”€ cmdâ”‚ â””â”€â”€ mytoolâ”‚ â””â”€â”€ mytool.goâ”œâ”€â”€ greet.goâ”œâ”€â”€ main.goâ”œâ”€â”€ mock.goâ””â”€â”€ script.sh æš´åŠ›æ›¿æ¢æºä»£ç æ–‡ä»¶çš„æ–¹å¼å¯èƒ½æ˜¯ä¸å¤ªä¼˜é›…å“ˆï¼Œå‡å¦‚æˆ‘ä»¬çš„ greet.go å†…å®¹æ”¹æˆä¸‹é¢è¿™æ ·ï¼š package mainfunc Greet(s string) (res string) return hello + sfunc Greet2(s string) (res string) return hello 2 + s å¦‚æœæˆ‘ä»¬æƒ³å¯¹ Greet2 ä¹Ÿè¿›è¡Œ ä»£ç é‡å†™ï¼Œé‚£å°±éœ€è¦ä¿®æ”¹å‰é¢ newCode å­—æ®µçš„å†…å®¹ï¼Œè€Œä¸”å®ƒæ˜¯å†™æ­»çš„ï¼Œç¡®å®ä¸å¤ªä¼˜é›…ã€‚ç°åœ¨æˆ‘ä»¬æ­£å¼æ¥é¢å¯¹è¿™ä»¶äº‹ï¼Œå¯¹æ¯”ä¿®æ”¹åçš„å‡½æ•°ï¼š func Greet(s string) (res string) if InterceptMock(Greet, s, res) return res return hello + s å…¶å®å°±æ˜¯åœ¨æ¯ä¸ªå‡½æ•°å‰åŠ ä¸Šè¿™ä¹ˆä¸€æ®µï¼š if InterceptMock(Greet, s, res) return res äº†è§£è¿‡ç¼–è¯‘åŸç†çš„è¯»è€…åº”è¯¥å¯ä»¥æƒ³åˆ°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ“ä½œæºä»£ç çš„ AST ç»“æ„ï¼Œå¾€å‡½æ•°çš„å¼€å¤´æ’å…¥è¿™æ®µä»£ç å³å¯ã€‚å¦‚æœæˆ‘ä»¬å…ˆä¸è€ƒè™‘å‚æ•°å’Œè¿”å›å€¼çš„è¯ï¼Œé‚£è¿™æ®µä»£ç æˆ‘ä»¬éœ€è¦æ›¿æ¢çš„åœ°æ–¹å°±æ˜¯å‡½æ•°åç§°äº†ï¼Œæ‰€ä»¥å®ƒçš„ç»“æ„å¦‚ä¸‹ï¼š if InterceptMock($funcName, s, res) return res è¿™é‡Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°å‡ ä¸ªæ ‡å‡†åº“å·¥å…·ï¼š go/ast: åŒ…å®šä¹‰äº† Go ç¼–ç¨‹è¯­è¨€çš„æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰ï¼Œæ ¸å¿ƒæœ‰ä»¥ä¸‹å‡ ç§ç±»å‹ï¼š File: è¡¨ç¤ºä¸€ä¸ª Go æºæ–‡ä»¶ã€‚ Decl: è¡¨ç¤ºä¸€ä¸ªå£°æ˜ï¼ŒåŒ…æ‹¬å‡½æ•°å£°æ˜ã€å˜é‡å£°æ˜ã€ç±»å‹å£°æ˜ç­‰ã€‚ Stmt: è¡¨ç¤ºä¸€ä¸ªè¯­å¥ã€‚ Expr: è¡¨ç¤ºä¸€ä¸ªè¡¨è¾¾å¼ã€‚ go/token: å®šä¹‰äº†å¤„ç† Go æºä»£ç çš„è¯æ³•å…ƒç´ çš„åŸºç¡€è®¾æ–½ï¼ŒåŒ…æ‹¬ä½ç½®ã€æ ‡è®°å’Œæ ‡è¯†ç¬¦ç­‰ã€‚è¿™ä¸ªåŒ…æä¾›äº†ç”¨äºç®¡ç†æºä»£ç ä½ç½®çš„ä¿¡æ¯ï¼Œå¯ä»¥å¸®åŠ©å®šä½ä»£ç ä¸­çš„ç‰¹å®šéƒ¨åˆ†ã€‚ go/parser: å°†ä¸€ä¸ª .go æ–‡ä»¶ä»¥è§£ææˆ AST ç»“æ„ã€‚ go/printer: æä¾›äº†å°† AST æ ¼å¼åŒ–å¹¶è¾“å‡ºä¸º Go æºç çš„åŠŸèƒ½ ä¿®æ”¹åçš„ cmd/mytool/mytool.go ä»£ç å¦‚ä¸‹ï¼š func main() tool, args := os.Args[1], os.Args[2:]\tif len(args) 0 args[0] == -V=full // dont do anything to infuence the version full output. else if len(args) 0 if filepath.Base(tool) == compile index := findGreetFile(args) if index -1 filename := args[index] f, err := os.Create(tmp.go) defer f.Close() defer os.Remove(tmp.go) if err != nil log.Fatalf(create tmp.go error: %v , err) _, _ = f.WriteString(insertCode(filename)) args[index] = tmp.go fmt.Printf(tool: %s , tool) fmt.Printf(args: %v , args) // ç»§ç»­æ‰§è¡Œä¹‹å‰çš„å‘½ä»¤\tcmd := exec.Command(tool, args...)\tcmd.Stdout = os.Stdout\tcmd.Stderr = os.Stderr\tif err := cmd.Run(); err != nil log.Fatalf(run command error: %v , err)\tfunc findGreetFile(args []string) int for i, arg := range args if strings.Contains(arg, greet.go) return i return -1func insertCode(filename string) string fset := token.NewFileSet()\tfast, err := parser.ParseFile(fset, filename, nil, parser.AllErrors)\tif err != nil log.Fatalf(parse file error: %v , err) for _, decl := range fast.Decls fun, ok := decl.(*ast.FuncDecl) if !ok continue f, err := os.Create(tmp2.go) if err != nil log.Fatalf(create tmp2.go error: %v , err) _, _ = f.WriteString(fmt.Sprintf(newCodeFormat, fun.Name.Name)) f.Close() tmpFset := token.NewFileSet() tmpF, err := parser.ParseFile(tmpFset, tmp2.go, nil, parser.AllErrors) if err != nil log.Fatalf(parse tmp2.go error: %v , err) fun.Body.List = append(tmpF.Decls[0].(*ast.FuncDecl).Body.List, fun.Body.List...) os.Remove(tmp2.go) var buf bytes.Buffer\tprinter.Fprint(buf, fset, fast)\tfmt.Println(buf.String())\treturn buf.String()var newCodeFormat = `package mainfunc TmpFunc() if InterceptMock(%s, s, res) return res ` æ ¸å¿ƒçš„ä¿®æ”¹åœ¨äº insertCode å‡½æ•°ï¼š ä½¿ç”¨ parser.ParseFile å°†æºä»£ç æ–‡ä»¶è§£ææˆ AST ç»“æ„ï¼› éå† AST ç»“æ„ï¼Œæ‰¾åˆ°æ‰€æœ‰çš„å£°æ˜ï¼ˆDeclï¼‰ç»“æ„ï¼Œå¹¶ä½¿ç”¨ decl(.ast.FuncDecl) æ‰¾åˆ°æ‰€æœ‰çš„å‡½æ•°ï¼› FuncDecl struct Doc *CommentGroup // associated documentation; or nil Recv *FieldList // receiver (methods); or nil (functions) Name *Ident // function/method name Type *FuncType // function signature: type and value parameters, results, and position of func keyword Body *BlockStmt // function body; or nil for external (non-Go) functionBlockStmt struct Lbrace token.Pos // position of List []Stmt Rbrace token.Pos // position of , if any (may be absent due to syntax error) æŸ¥çœ‹ ast.FuncDecl çš„ç»“æ„åï¼Œå¯ä»¥å¾—å‡ºä¸‹ä¸€æ­¥å°±æ˜¯å¾€ FuncDecl.Body.List åˆ—è¡¨å‰é¢æ’å…¥ä¸€äº› Stmtï¼› ç¬”è€…æ²¡æ‰¾åˆ°ç±»ä¼¼ parseStmt æ–¹æ³•ï¼Œæ‰€ä»¥å–äº†ä¸ªå·§ï¼Œæˆ‘å®šä¹‰äº†ä¸€æ®µä»£ç çš„ formatï¼Œé‡Œé¢çš„ %s ä¼šä½¿ç”¨ fun.Name.Name è·å–å‡½æ•°åå¹¶è¿›è¡Œæ›¿æ¢ã€‚ var newCodeFormat = `package mainfunc TmpFunc() if InterceptMock(%s, s, res) return res ` åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ tmp2.go å¹¶å†™å…¥æ ¼å¼åŒ–åçš„ä»£ç ï¼Œç„¶åå†æ¬¡è°ƒç”¨ parser.ParseFile å¾—åˆ°è§£æè¿™æ®µä»£ç çš„æŠ½è±¡è¯­æ³•æ ‘ç»“æ„ tmpF äº†ï¼› ç„¶åé€šè¿‡ tmpF.Decls[0].(*ast.FuncDecl).Body.List å°±å¯ä»¥å¾—åˆ° TmpFunc ä¸­çš„è¯­å¥ Stmt äº†ï¼› å°†å…¶åŠ åœ¨æºä»£ç å‡½æ•°çš„å‰é¢å³å¯ï¼šfun.Body.List = append(tmpF.Decls[0].(*ast.FuncDecl).Body.List, fun.Body.List...)ï¼› ç„¶åå†ä½¿ç”¨ go/printer å°†ä¿®æ”¹åçš„ AST è¾“å‡ºä¸ºæ–°æ–‡ä»¶å†…å®¹ã€‚ é€šè¿‡ä¸Šè¿°æ­¥éª¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¸º greet.go ä¸­çš„æ¯ä¸ªå‡½æ•°å‰é¢éƒ½æ’å…¥æ‰“æ¡©ä»£ç äº†ã€‚ ä¿®æ”¹ main.go é‡Œé¢çš„å†…å®¹ï¼ŒåŠ å…¥å¯¹ Greet2 çš„æµ‹è¯•ï¼š func main() res := Greet(world)\tif res != hello world log.Fatalf(Greet() = %q; want %q, res, hello world) RegisterMockFunc(Greet, func(s string) string return mock + s\t)\tres = Greet(world)\tif res != mock world log.Fatalf(Greet() = %q; want %q, res, mock world) log.Println(run greet 1 successfully)\tRegisterMockFunc(Greet2, func(s string) string return mock 2 + s\t)\tres = Greet2(world)\tif res != mock 2 world log.Fatalf(Greet2() = %q; want %q, res, mock 2 world) log.Println(run greet 2 successfully) æ‰§è¡Œè„šæœ¬ï¼š ./script.sh è¾“å‡ºåº”è¯¥è¿˜æ˜¯è·Ÿä¹‹å‰æ˜¯ä¸€æ ·çš„ï¼Œæˆ‘ä»¬è¿è¡Œç”Ÿæˆçš„å¯æ‰§è¡Œå‡½æ•°ï¼Œå¾—åˆ°å¦‚ä¸‹ç»“æœé‚£å°±è¯´æ˜æˆ‘ä»¬åˆæˆåŠŸè¿›äº†ä¸€æ­¥äº†~ âœ 04-toolexec-ast git:(master) âœ— ./main2024/05/23 20:03:22 run greet 1 successfully2024/05/23 20:03:22 run greet 2 successfully ç¬¬ 5 æ­¥ï¼šä½¿ç”¨ reflect åå°„åŠ¨æ€è·å–å‚æ•°å’Œè¿”å›å€¼åç§° âœ 05-toolexec-general git:(master) âœ— tree.â”œâ”€â”€ cmdâ”‚ â””â”€â”€ mytoolâ”‚ â””â”€â”€ mytool.goâ”œâ”€â”€ greet.goâ”œâ”€â”€ main.goâ”œâ”€â”€ mock.goâ””â”€â”€ script.sh æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å¤„ç†å‡½æ•°ç­¾åä¸­çš„å‚æ•°å’Œè¿”å›å€¼éƒ¨åˆ†ï¼Œæˆ‘ä»¬çš„æ ·æ¿ä»£ç ä¸­ï¼Œå†™æ­»äº†å‚æ•°çš„åç§°å’Œè¿”å›å€¼çš„åç§°ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦æ¥åŠ¨æ€è·å–å‡½æ•°å‚æ•°çš„åç§°å’Œè¿”å›å€¼çš„åç§°ï¼Œå¦‚æœè¿”å›å€¼æ²¡æœ‰åç§°ï¼Œé‚£æˆ‘ä»¬è¿˜éœ€è¦æ‰‹åŠ¨è®¾ç½®åç§°ã€‚ æˆ‘ä»¬å°† greet.to ä¿®æ”¹ä¸ºä»¥ä¸‹å†…å®¹ï¼š func Greet(s string) (res string) return hello + sfunc Greet2(s2 string) (res2 string) return hello 2 + s2func Greet3(s3 string) string return hello 3 + s3 å‡½æ•°çš„ä¿¡æ¯å½“ç„¶éƒ½åœ¨å‰é¢è·å¾—çš„ ast.FuncDecl ç»“æ„ä¸­ï¼Œå†æ¬¡è§‚å¯Ÿå…¶ç»“æ„ï¼š FuncDecl struct Doc *CommentGroup // associated documentation; or nil Recv *FieldList // receiver (methods); or nil (functions) Name *Ident // function/method name Type *FuncType // function signature: type and value parameters, results, and position of func keyword Body *BlockStmt // function body; or nil for external (non-Go) function é€šè¿‡æ³¨é‡Šå°±å¯ä»¥çŸ¥é“ Type å­—æ®µå°±åŒ…å«äº†å‚æ•°å’Œè¿”å›å€¼çš„ç›¸å…³ä¿¡æ¯ï¼ŒæŸ¥çœ‹ FuncType ç»“æ„ï¼Œå¦‚ä¸‹ï¼š FuncType struct Func token.Pos // position of func keyword (token.NoPos if there is no func) TypeParams *FieldList // type parameters; or nil Params *FieldList // (incoming) parameters; non-nil Results *FieldList // (outgoing) results; or nil Paramsï¼šå‡½æ•°å‚æ•° Resultsï¼šå‡½æ•°è¿”å›å€¼ æŸ¥çœ‹ FieldList ç»“æ„ï¼Œå¯çŸ¥å‚æ•°åˆ—è¡¨å’Œè¿”å›å€¼åˆ—è¡¨éƒ½åœ¨ç›¸åº”çš„ List å­—æ®µä¸­ï¼Œè€Œå…¶ä¸­çš„ Names å­—æ®µå°±æ˜¯å‚æ•°çš„åç§°äº†ã€‚ type FieldList struct Opening token.Pos // position of opening parenthesis/brace/bracket, if any\tList []*Field // field list; or nil\tClosing token.Pos // position of closing parenthesis/brace/bracket, if anytype Field struct Doc *CommentGroup // associated documentation; or nil\tNames []*Ident // field/method/(type) parameter names; or nil\tType Expr // field/method/parameter type; or nil\tTag *BasicLit // field tag; or nil\tComment *CommentGroup // line comments; or nil è¡¥å……ä¸€ä¸‹ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆ Names ç±»å‹æ˜¯ []*Ident å‘¢ï¼Ÿå› ä¸ºå‡½æ•°æœ‰ä»¥ä¸‹çš„å‘½åæ–¹å¼ï¼š func hello(s1, s2 string) (r1, r1 string) é‚£ä¹ˆåœ¨å½“ä¸‹ï¼Œåªæœ‰ 1 ä¸ªå‚æ•°å’Œåªæœ‰ 1 ä¸ªè¿”å›å€¼çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ fun.Type.Params.List[0].Names[0].Name æ¥è·å–å‚æ•°åç§°ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ fun.Type.Results.List[0].Names æ¥è·å–è¿”å›å€¼åç§°ï¼Œå¦‚æœè¿”å›å€¼æ²¡æœ‰åç§°ï¼Œé‚£æˆ‘ä»¬å°±ä¸ºå…¶è®¾ç½®åç§° __xgo_res_1 å¹¶å†™å›æº AST ç»“æ„ã€‚è¿™æ ·å°±éƒ½æœ‰åç§°ï¼Œå°±å¾ˆå¥½å¤„ç†äº†ã€‚ ç»ä¸Šåˆ†æï¼Œ cmd/mytool/mytool.go ä¸­æˆ‘ä»¬åªéœ€è¦ä¿®æ”¹ insertCode éƒ¨åˆ†ï¼Œä¿®æ”¹çš„ç»“æœå¦‚ä¸‹ï¼š func insertCode(filename string) string fset := token.NewFileSet()\tfast, err := parser.ParseFile(fset, filename, nil, parser.AllErrors)\tif err != nil log.Fatalf(parse file error: %v , err) for _, decl := range fast.Decls fun, ok := decl.(*ast.FuncDecl) if !ok continue f, err := os.Create(tmp.go) if err != nil log.Fatalf(create tmp.go error: %v , err) _, _ = f.WriteString(newCode(fun)) f.Close() tmpFset := token.NewFileSet() tmpF, err := parser.ParseFile(tmpFset, tmp.go, nil, parser.AllErrors) if err != nil log.Fatalf(parse tmp.go error: %v , err) fun.Body.List = append(tmpF.Decls[0].(*ast.FuncDecl).Body.List, fun.Body.List...) os.Remove(tmp.go) var buf bytes.Buffer\tprinter.Fprint(buf, fset, fast)\tfmt.Println(buf.String())\treturn buf.String()func newCode(fun *ast.FuncDecl) string /* Doc:nil Names:[s] Type:string Tag:nil Comment:nil Doc:nil Names:[res] Type:string Tag:nil Comment:nil Doc:nil Names:[s2] Type:string Tag:nil Comment:nil Doc:nil Names:[res2] Type:string Tag:nil Comment:nil Doc:nil Names:[s3] Type:string Tag:nil Comment:nil Doc:nil Names:[] Type:string Tag:nil Comment:nil\t*/\t// å‡½æ•°åç§°\tfuncName := fun.Name.Name\t// å‚æ•°åˆ—è¡¨\targName := fun.Type.Params.List[0].Names[0].Name\t// è¿”å›å€¼åˆ—è¡¨\tresNames := fun.Type.Results.List[0].Names\tif len(resNames) == 0 resNames = append(resNames, ast.IdentName: _xgo_res_1) fun.Type.Results.List[0].Names = resNames resName := resNames[0].Name\treturn fmt.Sprintf(newCodeFormat, funcName, argName, resName, resName)var newCodeFormat = `package mainfunc TmpFunc() if InterceptMock(%s, %s, %s) return %s ` ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥åŠ¨æ€è·å–å‚æ•°åç§°å’Œè¿”å›å€¼åç§°äº†ã€‚ ä¿®æ”¹æˆ‘ä»¬çš„ main.goï¼Œä»¥æµ‹è¯•æ‰€æœ‰çš„æƒ…å†µï¼š func main() res := Greet(world)\tif res != hello world log.Fatalf(Greet() = %q; want %q, res, hello world) RegisterMockFunc(Greet, func(s string) string return mock + s\t)\tres = Greet(world)\tif res != mock world log.Fatalf(Greet() = %q; want %q, res, mock world) log.Println(run greet 1 successfully)\tRegisterMockFunc(Greet2, func(s string) string return mock 2 + s\t)\tres = Greet2(world)\tif res != mock 2 world log.Fatalf(Greet2() = %q; want %q, res, mock 2 world) log.Println(run greet 2 successfully)\tRegisterMockFunc(Greet3, func(s string) string return mock 3 + s\t)\tres = Greet3(world)\tif res != mock 3 world log.Fatalf(Greet3() = %q; want %q, res, mock 3 world) log.Println(run greet 3 successfully) æ‰§è¡Œç¼–è¯‘è„šæœ¬ï¼š ./script.sh æ‰§è¡Œç¼–è¯‘äº§ç”Ÿçš„å¯æ‰§è¡Œç¨‹åºï¼Œè¾“å‡ºå¦‚ä¸‹å°±è¯´æ˜æˆ‘ä»¬åˆæˆåŠŸè¿›äº†ä¸€å¤§æ­¥~ âœ 05-toolexec-general git:(master) âœ— ./main2024/05/23 20:15:08 run greet 1 successfully2024/05/23 20:15:08 run greet 2 successfully2024/05/23 20:15:08 run greet 3 successfully ç¬¬ 6 æ­¥ï¼šæ”¯æŒå¤šå‚æ•°å’Œå¤šè¿”å›å€¼ âœ 06-toolexec-multi git:(master) âœ— tree.â”œâ”€â”€ cmdâ”‚ â””â”€â”€ mytoolâ”‚ â””â”€â”€ mytool.goâ”œâ”€â”€ greet.goâ”œâ”€â”€ main.goâ”œâ”€â”€ mock.goâ””â”€â”€ script.sh æœ¬æ–‡çš„æœ€åä¸€æ­¥ï¼Œæˆ‘ä»¬æ¥é¢å¯¹ä¸€ä¸‹å¤šå‚æ•°å’Œå¤šè¿”å›å€¼çš„é—®é¢˜ã€‚å‡è®¾æˆ‘ä»¬åˆå¦‚ä¸‹å‡½æ•°ï¼š func Pair1(s1, s2 string) (res string) return pair 1 + s1 + + s2 è¿™ä¸ªæ—¶å€™æˆ‘ä»¬ ä»£ç é‡å†™ ååº”è¯¥é•¿ä»€ä¹ˆæ ·å­å‘¢ï¼Ÿå¯ä»¥æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š func Pair1(s1, s2 string) (res string) if InterceptMock(Pair1, s1, s2, res) return res return pair 1 + s1 + + s2 æŒ‰ç…§è¿™ä¸ªæ€è·¯ï¼Œä¸‹é¢è¿™ä¸ªå‡½æ•°å‘¢ï¼Ÿ func Pair2(s1, s2 string) (res1, res2 string) return pair 1 + s1, pair 2 + s2 é‚£å°±æ˜¯è¿™æ ·çš„ï¼Ÿ func Pair2(s1, s2 string) (res1, res2 string) if InterceptMock(Pair2, s1, s2, res1, res2) return res1, res2 return pair 1 + s1, pair 2 + s2 è¿™ç§æ€è·¯å½“ç„¶ä¹Ÿèƒ½å®ç°ï¼Œæ¢ä¸€ç§æ›´ä¼˜é›…çš„æ€è·¯å‘¢ï¼Ÿæ—¢ç„¶æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç”¨åˆ‡ç‰‡æ¥æ‰¿è½½ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥æ˜¯è¿™æ ·çš„ï¼š func Pair2(s1, s2 string) (res1, res2 string) if InterceptMock(Pair2, []interfaces1, s2, []interfaceres1, res2) return res1, res2 return pair 1 + s1, pair 2 + s2 é‚£æˆ‘ä»¬å°±å¯ä»¥æŠ½è±¡å‡ºæ’å…¥ä»£ç çš„æ¨¡æ¿äº†ï¼š if InterceptMock($funcName, []interface$paramList, []interface$returnListWith) return $returnListWithout ä¸ºäº†å®ç°è¿™ä¸ªï¼Œæˆ‘ä»¬éœ€è¦å…ˆä¿®æ”¹ä¸€ä¸‹ mock.go ä¸­çš„ InterceptMock å‡½æ•°ï¼š func InterceptMock(funcName string, args []interface, results []interface) bool mockFn, ok := mockFuncs.Load(funcName)\tif !ok return false in := make([]reflect.Value, len(args))\tfor i, arg := range args in[i] = reflect.ValueOf(arg) mockFnValue := reflect.ValueOf(mockFn)\tout := mockFnValue.Call(in)\tif len(out) != len(results) panic(mock function return value number is not equal to results number) for i, result := range results reflect.ValueOf(result).Elem().Set(out[i]) return true æ‹¦æˆªå™¨çš„å…·ä½“å®ç°å¦‚ä¸‹ï¼š åˆ¤æ–­æ˜¯å¦æ³¨å†Œäº† mock å‡½æ•°ï¼Œæ²¡æœ‰åˆ™ç›´æ¥è¿”å›ï¼› å°†æ‰€æœ‰å‚æ•°éƒ½æ”¾åˆ° []refect.Value ä¸­ï¼› é€šè¿‡åå°„ refect.ValueOf è·å– mockFn çš„å€¼ï¼› è°ƒç”¨ mockFnValue.Call() æ¥æ‰§è¡Œå‡½æ•°ï¼Œå¹¶è¿”å›ç»“æœåˆ—è¡¨ï¼› éå†ä¼ è¿›æ¥çš„è¿”å›å€¼å¼•ç”¨åˆ—è¡¨ï¼Œè°ƒç”¨ reflect.ValueOf(result).Elem().Set(out[i]) å°†è¿”å›å€¼è®¾ç½®å›å»ã€‚ ç°åœ¨æˆ‘ä»¬æ¥ä¿®æ”¹æˆ‘ä»¬çš„ -toolexec å·¥å…·ï¼Œæ¥æ ¹æ®å‡½æ•°çš„ AST ç»“æ„ï¼Œè·å–å‚æ•°åˆ—è¡¨å’Œè¿”å›å€¼åˆ—è¡¨ï¼Œç”Ÿæˆä»£æ’å…¥çš„æ¨¡æ¿ä»£ç ï¼Œå¹¶å°†å…¶æ’å…¥åˆ°æ¯ä¸ªå‡½æ•°çš„å¼€å¤´ã€‚è¿™æ¬¡åœ¨ cmd/mytool/mytool.go ä¸­ï¼Œæˆ‘ä»¬åªéœ€ä¿®æ”¹ newCode å‡½æ•°ï¼š func insertCode(filename string) string fset := token.NewFileSet()\tfast, err := parser.ParseFile(fset, filename, nil, parser.AllErrors)\tif err != nil log.Fatalf(parse file error: %v , err) for _, decl := range fast.Decls fun, ok := decl.(*ast.FuncDecl) if !ok continue f, err := os.Create(tmp.go) if err != nil log.Fatalf(create tmp.go error: %v , err) _, _ = f.WriteString(newCode(fun)) f.Close() tmpFset := token.NewFileSet() tmpF, err := parser.ParseFile(tmpFset, tmp.go, nil, parser.AllErrors) if err != nil log.Fatalf(parse tmp.go error: %v , err) fun.Body.List = append(tmpF.Decls[0].(*ast.FuncDecl).Body.List, fun.Body.List...) os.Remove(tmp.go) var buf bytes.Buffer\tprinter.Fprint(buf, fset, fast)\tfmt.Println(buf.String())\treturn buf.String()func newCode(fun *ast.FuncDecl) string // å‡½æ•°åç§°\tfuncName := fun.Name.Name\t// å‚æ•°åˆ—è¡¨\targs := make([]string, 0)\tfor _, arg := range fun.Type.Params.List for _, name := range arg.Names args = append(args, name.Name) // è¿”å›å€¼åˆ—è¡¨\treturns := make([]string, 0)\treturnRefs := make([]string, 0)\treturnNames := fun.Type.Results.List[0].Names\tif len(returnNames) == 0 for i := 0; i fun.Type.Results.NumFields(); i++ fun.Type.Results.List[0].Names = append(fun.Type.Results.List[0].Names, ast.IdentName: fmt.Sprintf(_xgo_res_%d, i+1)) for _, re := range fun.Type.Results.List[0].Names returns = append(returns, re.Name) returnRefs = append(returnRefs, +re.Name) return fmt.Sprintf(newCodeFormat, funcName, strings.Join(args, ,), strings.Join(returnRefs, ,), strings.Join(returns, ,))var newCodeFormat = `package mainfunc TmpFunc() if InterceptMock(%s, []interface%s, []interface%s) return %s\t` æ€è·¯è·Ÿä¹‹å‰ç¬¬ 5 æ­¥å¤§åŒå°å¼‚ï¼Œä¸è¿‡æ˜¯ç”¨éå†çš„æ–¹å¼æ¥æ”¯æŒå¤šä¸ªå‚æ•°å’Œå¤šä¸ªè¿”å›å€¼ç½¢äº†ã€‚ ç°åœ¨æˆ‘ä»¬ä¸º greet.go æ·»åŠ æ›´å¤šçš„æµ‹è¯•å‡½æ•°ï¼Œä»£ç å¦‚ä¸‹ï¼š func Greet(s string) (res string) return hello + sfunc Greet2(s2 string) (res2 string) return hello 2 + s2func Greet3(s3 string) string return hello 3 + s3func Pair1(s1, s2 string) (res string) return pair 1 + s1 + + s2func Pair2(s1, s2 string) (res1, res2 string) return pair 1 + s1, pair 2 + s2func Other(i int, s string, f float64) string return fmt.Sprintf(int: %d, string: %s, float: %f, i, s, f) ä¸ºäº†æµ‹è¯•ï¼Œæˆ‘ä»¬å†æ¬¡ä¿®æ”¹ main.goï¼Œä½¿å…¶è¦†ç›–æ‰€æœ‰çš„æƒ…å†µï¼š func main() RegisterMockFunc(Other, func(i int, s string, f float64) string return fmt.Sprintf(mock %d %s %.2f, i, s, f)\t)\tres := Other(1, hello, 3.14)\tif res != mock 1 hello 3.14 log.Fatalf(Other() = %q; want %q, res, mock 1 hello 3.14) log.Println(run other successfully)\tRegisterMockFunc(Pair1, func(s1, s2 string) string return mock 1 + s1 + + s2\t)\tres = Pair1(hello, world)\tif res != mock 1 hello world log.Fatalf(Pair1() = %q; want %q, res, mock 1 hello world) log.Println(run pair1 successfully)\tRegisterMockFunc(Pair2, func(s1, s2 string) (string, string) return mock 2 + s1, mock 2 + s2\t)\tres1, res2 := Pair2(hello, world)\tif res1 != mock 2 hello || res2 != mock 2 world log.Fatalf(Pair2() = %q, %q; want %q, %q, res1, res2, mock 2 hello, mock 2 world) log.Println(run pair2 successfully)\tres = Greet(world)\tif res != hello world log.Fatalf(Greet() = %q; want %q, res, hello world) RegisterMockFunc(Greet, func(s string) string return mock + s\t)\tres = Greet(world)\tif res != mock world log.Fatalf(Greet() = %q; want %q, res, mock world) log.Println(run greet 1 successfully)\tRegisterMockFunc(Greet2, func(s string) string return mock 2 + s\t)\tres = Greet2(world)\tif res != mock 2 world log.Fatalf(Greet2() = %q; want %q, res, mock 2 world) log.Println(run greet 2 successfully)\tRegisterMockFunc(Greet3, func(s string) string return mock 3 + s\t)\tres = Greet3(world)\tif res != mock 3 world log.Fatalf(Greet3() = %q; want %q, res, mock 3 world) log.Println(run greet 3 successfully) ç¼–è¯‘ä»£ç ï¼š ./script.sh æ‰§è¡Œç”Ÿæˆçš„å¯æ‰§è¡Œç¨‹åºï¼Œå¦‚æœæœ‰ä»¥ä¸‹è¾“å‡ºï¼Œé‚£æˆ‘ä»¬å°±åˆæˆåŠŸè¿›äº†ä¸€å¤§å¤§æ­¥äº†~ âœ 06-toolexec-multi git:(master) âœ— ./main2024/05/23 20:31:10 run other successfully2024/05/23 20:31:10 run pair1 successfully2024/05/23 20:31:10 run pair2 successfully2024/05/23 20:31:10 run greet 1 successfully2024/05/23 20:31:10 run greet 2 successfully2024/05/23 20:31:10 run greet 3 successfully æ›´è¿›ä¸€æ­¥ é€šè¿‡ä¸Šé¢ 6 ä¸ªç®€å•çš„å°é˜¶æ®µï¼Œæˆ‘ä»¬å°±å·²ç»æŠŠ xgo æœ€æœ€æ ¸å¿ƒçš„åŠŸèƒ½ç»™å®ç°äº†ï¼Œåœ¨ä¸€äº›å°åœºæ™¯ä¸‹è¿˜å‹‰å¼ºèƒ½ç”¨ï¼ŸğŸ¤¡ æˆ‘ä»¬æ¥çœ‹çœ‹åŒ…å«æµ‹è¯•ä»£ç å’Œæ ·ä¾‹å‡½æ•°ï¼Œæ€»å…±ç”¨äº†å¤šå°‘ä»£ç ï¼š âœ 06-toolexec-multi git:(master) âœ— tokei .=============================================================================== Language Files Lines Code Comments Blanks=============================================================================== Go 4 281 224 11 46 Shell 1 5 3 1 1=============================================================================== Total 5 286 227 12 47=============================================================================== çŸ­çŸ­ 224 è¡Œä»£ç ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸äº†ä¸èµ·çš„æˆå°±ï¼ å½“ç„¶ï¼Œä¼˜ç§€çš„è¯»è€…è‚¯å®šå¯ä»¥å‘ç°æˆ‘ä»¬è¿™ä¸ª ä¸ç‰ˆ xgo æœ‰å¤ªå¤šçš„ä¸è¶³å’Œç¼ºé™·äº†ã€‚è¿™æ˜¯å¿…ç„¶çš„ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ xgo æˆªæ­¢ 1.0.37 ç‰ˆæœ¬ï¼Œæ€»å…±æœ‰å¤šå°‘è¡Œä»£ç ï¼š âœ xgo git:(master) tokei .=============================================================================== Language Files Lines Code Comments Blanks=============================================================================== BASH 1 104 81 11 12 CSS 1 153 118 5 30 Go 369 33232 26836 2588 3808 JavaScript 1 170 146 10 14 JSON 2 435 435 0 0 PowerShell 1 28 16 3 9 Shell 3 288 251 4 33 SVG 1 41 41 0 0 Plain Text 7 192 0 174 18------------------------------------------------------------------------------- HTML 1 19 16 3 0 |- JavaScript 1 6 6 0 0 (Total) 25 22 3 0------------------------------------------------------------------------------- Markdown 17 1455 0 1083 372 |- Go 8 820 635 72 113 |- JSON 1 80 80 0 0 (Total) 2355 715 1155 485=============================================================================== Total 404 36117 27940 3881 4296=============================================================================== å…‰ Go ä»£ç å°±æœ‰ 26836 è¡Œäº†ã€‚æ‰€ä»¥å¯çŸ¥ xgo çš„ä½œè€…æ˜¯åšäº†å¾ˆå¤šçš„ä»˜å‡ºå’ŒåŠªåŠ›çš„ã€‚ä¸è¿‡æˆ‘ä»¬ç”¨äº†ä¸åˆ°ç™¾åˆ†ä¹‹ä¸€çš„ä»£ç é‡ï¼Œå°±å°† xgo æœ€æ ¸å¿ƒçš„åŸç†å±•ç¤ºå¾—æ·‹æ¼“å°½è‡´äº†ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è¿›ä¸€æ­¥é˜…è¯» xgo çš„æºç ï¼Œå¯ä»¥è¿›ä¸€æ­¥æ¢ç´¢å¦‚ä½•æŠ½è±¡å‡ºæ›´é€šç”¨æ›´ç®€æ´æ›´æ˜“æ‰©å±•çš„ interceptorï¼Œå¦‚ä½•æ”¯æŒåç¨‹éš”ç¦»ï¼Œå¦‚ä½•ä¼˜åŒ–ä¾èµ–ç®¡ç†ï¼Œä»¥åŠå¦‚ä½•å®ç°å…¶ä»–çš„ traceã€coverage åŠŸèƒ½ã€‚å†æ¬¡ä¸º xgo æ‰“ call ğŸ‘ï¼ å‚è€ƒ xgo repo xgo: åŸºäºä»£ç é‡å†™å®ç° Monkey Patch å’Œ Trace go compile README xgo: åœ¨ go ä¸­ä½¿ç”¨-toolexec å®ç°çŒ´å­è¡¥ä¸","tags":["Go","å•å…ƒæµ‹è¯•","å¼€æºé¡¹ç›®"],"categories":["Go","å¼€æºé¡¹ç›®"]},{"title":"Kafka è´Ÿè½½å‡è¡¡æŒ‘æˆ˜åŠè§£å†³æ€è·¯","path":"/2024/05/20/kafka-load-balance/","content":"æœ¬æ–‡è½¬è½½è‡ª Agoda Engineeringï¼Œä»‹ç»äº†åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¦‚ä½•åº”å¯¹ Kafka è´Ÿè½½å‡è¡¡æ‰€é‡åˆ°çš„å„ç§æŒ‘æˆ˜ï¼Œå¹¶æå‡ºç›¸åº”çš„è§£å†³æ€è·¯ã€‚æœ¬æ–‡ç®€è¦é˜è¿°äº† Kafka çš„å¹¶è¡Œæ€§æœºåˆ¶ã€å¸¸ç”¨çš„åˆ†åŒºç­–ç•¥ä»¥åŠåœ¨å®é™…æ“ä½œä¸­é‡åˆ°çš„å¼‚æ„ç¡¬ä»¶ã€ä¸å‡åŒ€å·¥ä½œè´Ÿè½½ç­‰é—®é¢˜ã€‚é€šè¿‡æ·±å…¥åˆ†æè¿™äº›æŒ‘æˆ˜ï¼Œå¹¶æä¾›å…·ä½“çš„è§£å†³æ–¹æ¡ˆï¼Œæœ¬æ–‡æ—¨åœ¨å¸®åŠ©è¯»è€…æ›´å¥½åœ°ç†è§£å’Œåº”ç”¨ Kafka çš„è´Ÿè½½å‡è¡¡æŠ€æœ¯ï¼Œä»è€Œæé«˜ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½å’Œç¨³å®šæ€§ã€‚ ä»¥ä¸‹å¤§éƒ¨åˆ†å†…å®¹ç¿»è¯‘è‡ªåŸæ–‡ how-we-solve-load-balancing-challenges-in-apache-kafkaï¼Œå¹¶å·²è·å¾—åŸä½œè€…åŒæ„ã€‚ æ€ç»´å¯¼å›¾ Kafka è´Ÿè½½å‡è¡¡è§£å†³æ–¹æ¡ˆ Kafka å¹¶è¡Œæ€§ Kafka é€šè¿‡åˆ†åŒºæ¥å®ç°å¹¶è¡Œæ€§ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç”Ÿäº§è€…ï¼ˆProducerï¼‰äº§ç”Ÿçš„æ¶ˆæ¯ä¼šæŒ‰ç…§ä¸€å®šçš„åˆ†åŒºç­–ç•¥åˆ†é…åˆ°å¤šä¸ªåˆ†åŒºï¼ˆPartitionï¼‰ä¸­ï¼Œæ¶ˆè´¹ç»„ä¸­çš„æ¯ä¸ªæ¶ˆè´¹è€…ä¼šåˆ†åˆ«è´Ÿè´£æ¶ˆè´¹å…¶ä¸­çš„è‹¥å¹²ä¸ªåˆ†åŒºã€‚ Kafka åˆ†åŒºæ¼”ç¤º åˆ†åŒºç­–ç•¥ï¼š è½®è¯¢ï¼ˆRound Robinï¼‰ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼ŒKafka ä½¿ç”¨è½®è¯¢ç­–ç•¥å°†æ¶ˆæ¯å‡åŒ€åœ°åˆ†é…åˆ°æ‰€æœ‰åˆ†åŒºã€‚ å“ˆå¸Œï¼ˆKey Hashingï¼‰ï¼šå¦‚æœæ¶ˆæ¯æœ‰åˆ†åŒºé”®ï¼ŒKafka ä¼šå¯¹é”®è¿›è¡Œå“ˆå¸Œè®¡ç®—ï¼Œå°†æ¶ˆæ¯åˆ†é…åˆ°ç‰¹å®šçš„åˆ†åŒºã€‚ è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥ï¼šå¼€å‘è€…å¯ä»¥å®ç°è‡ªå®šä¹‰çš„åˆ†åŒºå™¨ï¼ˆPartitionerï¼‰é€»è¾‘ï¼Œä»¥æ»¡è¶³ç‰¹å®šéœ€æ±‚ã€‚ å¦‚æœè¦ä½¿ç”¨è½®è¯¢æˆ–è€…å“ˆå¸Œç­–ç•¥æ¥è¾¾åˆ°â€œè´Ÿè½½å‡è¡¡â€çš„ç›®çš„ï¼Œé‚£ä¹ˆéœ€è¦æ»¡è¶³ä»¥ä¸‹ 2 ä¸ªå‡è®¾ï¼š æ¶ˆè´¹è€…æ‹¥æœ‰ç›¸åŒçš„å¤„ç†èƒ½åŠ›ï¼Œ æ¶ˆæ¯çš„å·¥ä½œé‡ç›¸ç­‰ã€‚ ç„¶è€Œï¼Œåœ¨å®è·µä¸­ï¼Œè¿™äº›å‡è®¾å¾€å¾€ä¸æˆç«‹ã€‚ ç°å®æŒ‘æˆ˜ 1. å¼‚æ„ç¡¬ä»¶ ä¸åŒä»£çš„æœåŠ¡å™¨ç¡¬ä»¶æ€§èƒ½ä¸åŒï¼Œå¯¼è‡´å¤„ç†é€Ÿç‡å­˜åœ¨å·®å¼‚ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ä¸åŒä»£ç¡¬ä»¶è¿›è¡Œå¤„ç†çš„åŸºå‡†æ˜¾ç¤ºæ€§èƒ½å­˜åœ¨æ˜¾ç€å·®å¼‚ï¼š ä¸åŒæœåŠ¡å™¨å¤„ç†é€Ÿç‡å·®å¼‚ä¸¾ä¾‹ 2. æ¯æ¡ Kafka æ¶ˆæ¯çš„å·¥ä½œè´Ÿè½½ä¸å‡åŒ€ ä¸‹å›¾æ˜¾ç¤ºäº†åœ¨ä¸€ä¸ªæ—¶é—´çª—å£å†…åˆ°è¾¾çš„ 12 æ¡æ¶ˆæ¯ã€‚åœ¨è¿™é‡Œï¼Œç”Ÿäº§è€…å‘è¯¥ä¸»é¢˜ä¸­çš„å…­ä¸ªåˆ†åŒºä¸­çš„æ¯ä¸€ä¸ªå‘å¸ƒä¸¤æ¡æ¶ˆæ¯ã€‚å› æ­¤ï¼Œæ¯ä¸ª worker æ¶ˆè€—æ¥è‡ª 2 ä¸ªåˆ†åŒºçš„æ•°æ®ï¼Œè¿™æ„å‘³ç€æ¯ä¸ª worker éœ€è¦å¤„ç† 4 æ¡æ¶ˆæ¯ã€‚ ä½¿ç”¨å¾ªç¯åˆ†åŒºå™¨å’Œå¾ªç¯åˆ†é…å™¨æ¥åˆ†å‘æ¶ˆæ¯çš„å…ˆå‰ä¾›åº”ç³»ç»Ÿçš„æ¼”ç¤ºã€‚æ¯ä¸ª worker éƒ½åˆ†é…æœ‰ç›¸åŒæ•°é‡çš„æ¶ˆæ¯ã€‚ ä¸åŒçš„æ¶ˆæ¯å¯èƒ½éœ€è¦ä¸åŒçš„å¤„ç†æ­¥éª¤é›†ã€‚ä¾‹å¦‚ï¼Œå¤„ç†æ¶ˆæ¯å¯èƒ½æ¶‰åŠè°ƒç”¨ç¬¬ä¸‰æ–¹ HTTP ç«¯ç‚¹ï¼Œå¹¶ä¸”ä¸åŒçš„å“åº”å¤§å°æˆ–å»¶è¿Ÿå¯èƒ½ä¼šå½±å“å¤„ç†é€Ÿç‡ã€‚æ­¤å¤–ï¼Œå¯¹äºæ¶‰åŠæ•°æ®åº“æ“ä½œçš„åº”ç”¨ç¨‹åºï¼Œå…¶æ•°æ®åº“æŸ¥è¯¢çš„å»¶è¿Ÿå¯èƒ½ä¼šæ ¹æ®æŸ¥è¯¢å‚æ•°è€Œæ³¢åŠ¨ï¼Œä»è€Œå¯¼è‡´å¤„ç†é€Ÿç‡å‘ç”Ÿå˜åŒ–ã€‚ 3. è¿‡åº¦é…ç½®é—®é¢˜ ç”±äºå·¥ä½œè´Ÿè½½å’Œå¤„ç†æ•ˆç‡ä¸åŒï¼Œä¸ºäº†è¾¾åˆ°ç³»ç»Ÿååé‡çš„éœ€æ±‚ï¼Œå¯èƒ½ä¼šå‡ºç°è¿‡åº¦é…ç½®é—®é¢˜ï¼Œä»è€Œå¯¼è‡´èµ„æºæµªè´¹ã€‚ å‡è®¾æˆ‘ä»¬çš„é«˜ååé‡å’Œä½ååé‡çš„å¤„ç†é€Ÿç‡åˆ†åˆ«ä¸º 20 msg/s å’Œ 10 msg/sï¼ˆæ ¹æ®è¡¨ 1 ä¸­çš„æ•°æ®è¿›è¡Œç®€åŒ–ï¼‰ã€‚ä½¿ç”¨ä¸¤ä¸ªè¾ƒå¿«çš„å¤„ç†å™¨å’Œä¸€ä¸ªè¾ƒæ…¢çš„å¤„ç†å™¨ï¼Œæˆ‘ä»¬é¢„è®¡æ€»å®¹é‡ä¸º 20+20+10 = 50 æ¡æ¶ˆæ¯/ç§’ã€‚ä½†æ˜¯ï¼Œå½“ä¿æŒæ¶ˆæ¯çš„å¾ªç¯åˆ†é…æ—¶ï¼Œæˆ‘ä»¬æ— æ³•è¾¾åˆ°æ­¤å®¹é‡ã€‚ä¸‹å›¾æ˜¾ç¤ºäº†å¦‚æœæµé‡æŒç»­è¾¾åˆ°æ¯ç§’ 50 æ¡æ¶ˆæ¯æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µã€‚ å¦‚æœä¼ å…¥æµé‡ä¿æŒåœ¨ 50 æ¡æ¶ˆæ¯/ç§’ï¼Œåˆ™æ…¢é€Ÿå¤„ç†å™¨æ— æ³•å¤„ç†æ€»ä½“æ¶ˆæ¯ 1/3 çš„è´Ÿè½½ï¼Œä»è€Œå¯¼è‡´ç´¯ç§¯å»¶è¿Ÿã€‚ä¸ºäº†é¿å…é«˜å»¶è¿Ÿï¼Œå‘è¯¥ç³»ç»Ÿæ·»åŠ äº†é¢å¤–çš„èµ„æºä»¥ç»´æŒå¤„ç†ã€‚ ä»è¿™ä¸ªä¾‹å­ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬çš„å¤„ç†å™¨æœåŠ¡ä¸€æ¬¡æœ€å¤šåªèƒ½æ¥å— 30 æ¡æ¶ˆæ¯ï¼Œä»¥é˜²æ­¢æ»åå¹¶ç¡®ä¿åŠæ—¶ä¼ é€’æ›´æ–°ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¦å®é™…æ¯ç§’å¤„ç† 50 æ¡æ¶ˆæ¯ï¼Œæˆ‘ä»¬å¿…é¡»æ€»å…±æ‰©å±•åˆ° 5 å°æœºå™¨ï¼Œä»¥ä¿è¯åŠæ—¶å¤„ç†æ‰€æœ‰æ¶ˆæ¯ã€‚ç”±äºè¿™ç§ä¸é€‚å½“çš„åˆ†é…é€»è¾‘ï¼ˆ66.7ï¼…çš„è¿‡åº¦é…ç½®ï¼‰ï¼Œæˆ‘ä»¬ä¼šå‘è¯¥ç³»ç»Ÿè¿‡åº¦é…ç½®é¢å¤–çš„ä¸¤å°æœºå™¨ã€‚ ä¸ºäº†æ¯ç§’å¤„ç† 50 æ¡æ¶ˆæ¯ï¼Œæˆ‘ä»¬éœ€è¦æ‰©å±•åˆ°äº”å°æœºå™¨ä»¥ç¡®ä¿åŠæ—¶å¤„ç†æ‰€æœ‰æ¶ˆæ¯ã€‚ç”±äºè¿™ç§ä¸é€‚å½“çš„åˆ†é…é€»è¾‘ï¼ˆ66.7% çš„è¿‡åº¦é…ç½®ï¼‰ï¼Œè¿™ä¼šå¯¼è‡´å‘è¯¥ç³»ç»Ÿè¿‡åº¦é…ç½®ä¸¤å°é¢å¤–çš„æœºå™¨ã€‚ é™æ€è§£å†³æ–¹æ¡ˆ 1. åœ¨ç›¸åŒçš„ Podï¼ˆæœºå™¨ï¼‰ä¸Šéƒ¨ç½² è€ƒè™‘æ§åˆ¶æœåŠ¡éƒ¨ç½²ä¸­ä½¿ç”¨çš„ç¡¬ä»¶ç±»å‹ä»¥ç¼“è§£é—®é¢˜ã€‚å¦‚æœæ‚¨åœ¨è™šæ‹Ÿæœºä¸Šéƒ¨ç½²æœåŠ¡å¹¶æ‹¥æœ‰å……è¶³çš„èµ„æºå’Œæ€§èƒ½ç›¸åŒçš„ç¡¬ä»¶ï¼Œåˆ™æ­¤æ–¹æ³•æ˜¯å¯è¡Œçš„ã€‚ ç„¶è€Œï¼Œç”±äºæˆæœ¬æ•ˆç›Šå’Œçµæ´»æ€§ä¸‹é™ï¼Œåœ¨ç§æœ‰äº‘ç¯å¢ƒä¸­é€šå¸¸ä¸å»ºè®®é‡‡ç”¨è¿™ç§ç­–ç•¥ï¼Œä¸»è¦æ˜¯å› ä¸ºåŒæ—¶å‡çº§æ‰€æœ‰ç°æœ‰ç¡¬ä»¶å¯èƒ½å…·æœ‰æŒ‘æˆ˜æ€§ã€‚å¦‚æœå®ƒéå¸¸é€‚åˆæ‚¨çš„æƒ…å†µï¼Œåˆ™å¯ä»¥ä½¿ç”¨Kubernetes å…³è”æ€§å°† Pod åˆ†é…ç»™æŸäº›ç±»å‹çš„èŠ‚ç‚¹ã€‚ 2. åŠ æƒè´Ÿè½½å‡è¡¡ å¦‚æœå®¹é‡æ˜¯å¯é¢„æµ‹çš„å¹¶ä¸”å¤§éƒ¨åˆ†æ—¶é—´ä¿æŒé™æ€ï¼Œåˆ™ä¸ºä¸åŒçš„æ¶ˆè´¹è€…åˆ†é…ä¸åŒçš„æƒé‡å¯ä»¥å¸®åŠ©æœ€å¤§é™åº¦åœ°åˆ©ç”¨å¯ç”¨èµ„æºã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸ºè¡¨ç°è¾ƒå¥½çš„æ¶ˆè´¹è€…èµ‹äºˆæ›´é«˜çš„æƒé‡åï¼Œæˆ‘ä»¬å¯ä»¥å°†æ›´å¤šæµé‡è·¯ç”±ç»™è¿™äº›æ¶ˆè´¹è€…ã€‚ åŠ¨æ€è§£å†³æ–¹æ¡ˆ è™½ç„¶æˆ‘ä»¬å¯ä»¥ä¼°è®¡æ¶ˆæ¯çš„å®¹é‡å’Œå·¥ä½œè´Ÿè½½æ¥è®¾è®¡é™æ€è§„åˆ™æ¥ç¡®å®šåŠ æƒè´Ÿè½½å¹³è¡¡ç­–ç•¥ï¼Œä½†ç”±äºä»¥ä¸‹å‡ ä¸ªå› ç´ ï¼Œè¿™ç§æ–¹æ³•åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­å¯èƒ½å¹¶ä¸æ€»æ˜¯å¯è¡Œï¼š æ¶ˆæ¯çš„å·¥ä½œè´Ÿè½½å¹¶ä¸ç»Ÿä¸€ï¼Œè¿™ä½¿å¾—ä¼°è®¡æœºå™¨å®¹é‡å˜å¾—å›°éš¾ã€‚ ä¾èµ–å…³ç³»ï¼ˆä¾‹å¦‚ç½‘ç»œå’Œç¬¬ä¸‰æ–¹è¿æ¥ï¼‰ä¸ç¨³å®šï¼Œæœ‰æ—¶ä¼šå¯¼è‡´å®é™…å¤„ç†ä¸­çš„å®¹é‡å‘ç”Ÿå˜åŒ–ã€‚ è¯¥ç³»ç»Ÿç»å¸¸æ·»åŠ æ–°åŠŸèƒ½ï¼Œå¢åŠ é¢å¤–çš„ç»´æŠ¤å·¥ä½œä»¥ä¿æŒæƒé‡æ›´æ–°ã€‚ ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥åŠ¨æ€ç›‘æ§æ¯ä¸ªåˆ†åŒºä¸­çš„å½“å‰æ»åå¹¶æ ¹æ®å½“å‰æµé‡çŠ¶å†µåšå‡ºç›¸åº”å“åº”ã€‚ æœ‰ 2 ç§æ€è·¯ï¼š ç”Ÿäº§è€…è§’åº¦ï¼šä½¿ç”¨è‡ªå®šä¹‰ç®—æ³•æ ¹æ®æ»åçš„æ¶ˆæ¯æ•°é‡æ¥ç¡®å®šæ¯ä¸ªåˆ†åŒºçš„æµé‡ï¼Œè¿™ç§ç”Ÿäº§è€…ç§°ä¸ºæ»åæ„ŸçŸ¥ç”Ÿäº§è€…ï¼ˆLag-aware Producerï¼‰ã€‚ æ¶ˆè´¹è€…è§’åº¦ï¼šè¿™äº›æ¶ˆè´¹è€…æ—¨åœ¨ç›‘æ§å½“å‰æ»åçš„æ¶ˆæ¯æ•°é‡ï¼Œå¹¶å¯ä»¥åœ¨å¿…è¦æ—¶å–æ¶ˆè®¢é˜…ä»¥è§¦å‘è´Ÿè½½é‡æ–°å¹³è¡¡ã€‚é€šå¸¸ï¼Œå¯ä»¥é‡‡ç”¨è‡ªå®šä¹‰çš„é‡æ–°å¹³è¡¡ç­–ç•¥æ¥è°ƒæ•´åˆ†åŒºåˆ†é…ã€‚è¿™ç§æ¶ˆè´¹è€…ç§°ä¸ºæ»åæ„ŸçŸ¥æ¶ˆè´¹è€…ï¼ˆLag-aware Comsumerï¼‰ã€‚ 1. ä»ç”Ÿäº§è€…è§’åº¦å‡ºå‘ å¦‚æ­¤å›¾æ‰€ç¤ºï¼Œç”Ÿäº§è€…å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰ç®—æ³•æ ¹æ®æ»åç¡®å®šæ¯ä¸ªåˆ†åŒºçš„æµé‡ã€‚ä¸ºäº†å‡å°‘å¯¹ Kafka ä»£ç†çš„è°ƒç”¨æ¬¡æ•°ï¼Œç³»ç»Ÿå¯ä»¥ç»´æŠ¤ä¸€ä¸ªå†…éƒ¨å»¶è¿Ÿç¼“å­˜ï¼Œè€Œä¸æ˜¯åœ¨å‘å¸ƒæ¯æ¡æ¶ˆæ¯ä¹‹å‰è°ƒç”¨ Kafka ä»£ç†ã€‚ åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œåˆ†åŒº 4 å’Œ 6 çš„å»¶è¿Ÿæ¯”å…¶ä»–åˆ†åŒºé«˜å¾—å¤šã€‚åº”å‡å°‘ä»å†…éƒ¨ç”Ÿäº§è€…å‘é€åˆ°è¿™äº›åˆ†åŒºçš„æµé‡ã€‚ ä½¿ç”¨æ»åæ•°æ®ï¼Œå®šåˆ¶çš„ç®—æ³•è¢«è®¾è®¡ä¸ºå‘ç»å†é«˜æ»åçš„åˆ†åŒºå‘å¸ƒæ›´å°‘çš„æµé‡ï¼Œå‘ä½æ»åçš„åˆ†åŒºå‘å¸ƒæ›´å¤šæµé‡ï¼Œä»¥å¹³è¡¡æ¯ä¸ªåˆ†åŒºä¸Šçš„å·¥ä½œè´Ÿè½½ã€‚å½“æ»åå¹³è¡¡ä¸”ç¨³å®šæ—¶ï¼Œæ­¤æ–¹æ³•åº”ç¡®ä¿æ¶ˆæ¯çš„å‡åŒ€åˆ†å¸ƒã€‚ ä¸é€‚ç”¨æƒ…å†µï¼š çº¯æ¶ˆè´¹è€…åº”ç”¨ç¨‹åºï¼šæ‚¨çš„åº”ç”¨ç¨‹åºä¸æ§åˆ¶æ¶ˆæ¯ç”Ÿæˆã€‚ å¤šä¸ªæ¶ˆè´¹è€…ç»„ï¼šå½“ç”Ÿæˆçš„æ¶ˆæ¯è¢«å¤šä¸ªæ¶ˆè´¹è€…ç»„æ¶ˆè´¹æ—¶ï¼Œç”Ÿäº§è€…å¯èƒ½ä¼šä¸ºå…¶ä»–æ¶ˆè´¹è€…ç»„äº§ç”Ÿä¸å¿…è¦çš„å€¾æ–œè´Ÿè½½ï¼Œå› ä¸ºæ»ååªæ˜¯ç‰¹å®šäºä¸€ä¸ªæ¶ˆè´¹è€…ç»„çš„ä¿¡æ¯ã€‚ ç›¸åŒé˜Ÿåˆ—é•¿åº¦ç®—æ³• è¯¥ç®—æ³•å°†æ¯ä¸ªåˆ†åŒºæ»åè§†ä¸ºå¤„ç†çš„é˜Ÿåˆ—å¤§å°ã€‚è·å–æ»åä¿¡æ¯åï¼Œå®ƒä¼šå‘å¸ƒé€‚å½“æ•°é‡çš„æ¶ˆæ¯ä»¥å¡«å……çŸ­é˜Ÿåˆ—ã€‚æ­¤æ–¹æ³•æ›´é€‚åˆç”±äºå¼‚æ„ç¡¬ä»¶è€Œå¯¼è‡´çš„å€¾æ–œæ»ååˆ†å¸ƒï¼Œå…¶ä¸­é«˜æ€§èƒ½ Podï¼ˆæœºå™¨ï¼‰åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹èƒ½å¤Ÿæ›´å¿«åœ°å¤„ç†ã€‚ ç›¸åŒé˜Ÿåˆ—é•¿åº¦ç®—æ³•çš„æ¼”ç¤ºã€‚æœ€åˆï¼Œä¸åŒé˜Ÿåˆ—çš„é•¿åº¦ä¸åŒã€‚è¯¥ç®—æ³•å°è¯•ç”Ÿæˆä¸åŒæ•°é‡çš„æ¶ˆæ¯ï¼Œä»¥åœ¨æ‰€æœ‰é˜Ÿåˆ—ä¸­å®ç°ç›¸åŒçš„é˜Ÿåˆ—é•¿åº¦ã€‚è¿™é‡Œï¼Œé˜Ÿåˆ—é•¿åº¦å’Œ Kafka lag æ˜¯åŒä¸€ä¸ªæ¦‚å¿µï¼Œä»£è¡¨å°šæœªå¤„ç†çš„æ¶ˆæ¯æ•°é‡ å¼‚å¸¸å€¼æ£€æµ‹ç®—æ³• è¯¥ç®—æ³•åˆ©ç”¨ç»Ÿè®¡æ–¹æ³•æ¥ç¡®å®šæ‰€æœ‰åˆ†åŒºçš„ä¸Šç¦»ç¾¤å€¼ï¼Œå¹¶æš‚æ—¶åœæ­¢é‚£äº›æ…¢é€Ÿç¦»ç¾¤å€¼çš„å‘å¸ƒè¿‡ç¨‹ã€‚åœ¨åŸæ–‡ç« ä¸­ï¼Œé’ˆå¯¹ Agoda çš„ç‰¹å®šéœ€æ±‚ï¼Œä»–ä»¬æå‡ºäº† IQRï¼ˆå››åˆ†ä½è·ï¼‰å’Œ STDï¼ˆæ ‡å‡†å·®ï¼‰å¼‚å¸¸å€¼æ£€æµ‹ç®—æ³•ã€‚ç®—æ³•æµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤ºã€‚ å¼‚å¸¸å€¼æ£€æŸ¥ç®—æ³•æµç¨‹ æ…¢é€Ÿåˆ†åŒºï¼šï¼ˆå·²å…³é—­ï¼‰ç”±äºå­˜åœ¨å»¶è¿Ÿï¼Œè¿™äº›åˆ†åŒºçš„æ¶ˆæ¯ç”Ÿæˆå·²åœæ­¢ã€‚ å¥½çš„åˆ†åŒºï¼šï¼ˆæ‰“å¼€ï¼‰ç…§å¸¸å‘å¸ƒå¹¶å‡åŒ€åˆ†å‘åˆ°æ‰€æœ‰å¥½çš„åˆ†åŒºã€‚ OK åˆ†åŒºï¼šï¼ˆè§‚å¯Ÿ/åŠå¼€æ”¾ï¼‰ä¸ºäº†æé«˜æ€§èƒ½ä¸ä½³çš„æœºå™¨çš„æ€§èƒ½ï¼Œå½“ç³»ç»Ÿå°è¯•å°†æ…¢é€Ÿåˆ†åŒºæå‡ä¸ºè‰¯å¥½åˆ†åŒºæ—¶ï¼Œä¼šæ·»åŠ ä¸€ä¸ªè§‚å¯ŸæœŸã€‚é€šè¿‡ä»…ç”Ÿæˆä¸€å°éƒ¨åˆ†æ¶ˆæ¯å¹¶è¿›è¡Œè§‚å¯Ÿï¼Œå¯ä»¥å°†è¯¥è§‚å¯Ÿé˜¶æ®µä¼˜åŒ–ä¸ºâ€œåŠå¼€æ”¾â€çŠ¶æ€ã€‚å½“æ»åè·å–é—´éš”ç›¸å¯¹è¾ƒé•¿æ—¶ï¼ŒåŠå¼€æ”¾æ˜¯æœ‰ç›Šçš„ï¼Œå› ä¸ºå®ƒå¯ä»¥é˜²æ­¢æ¶ˆè´¹è€…å»¶è¿Ÿç­‰å¾…ä¼ å…¥æ¶ˆæ¯è€Œæ›´æ–°çš„æ»åæ•°æ®å°šæœªæŸ¥è¯¢çš„æƒ…å†µã€‚ 2. ä»æ¶ˆè´¹è€…è§’åº¦å‡ºå‘ è¿™é‡Œ Adoga æå‡ºçš„æ€è·¯æ˜¯ï¼šé‡åˆ°é«˜å»¶è¿Ÿçš„å®ä¾‹å¯ä»¥ä¸»åŠ¨å–æ¶ˆè®¢é˜…ä¸»é¢˜ä»¥è§¦å‘é‡æ–°å¹³è¡¡ã€‚åœ¨é‡æ–°å¹³è¡¡æœŸé—´ï¼Œå¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰çš„åˆ†é…å™¨æ¥å¹³è¡¡æ‰€æœ‰æ¶ˆè´¹è€…å®ä¾‹ä¹‹é—´çš„åˆ†åŒºã€‚ è§¦å‘é‡æ–°å¹³è¡¡çš„æˆæœ¬éå¸¸æ˜‚è´µï¼Œå› ä¸ºæ€¥åˆ‡çš„é‡æ–°å¹³è¡¡ä¼šåœæ­¢æ¶ˆè´¹è€…ç»„ä¸­çš„æ‰€æœ‰å¤„ç†ã€‚Kafka 2.4ä¸­å¼•å…¥çš„å¢é‡åä½œå†å¹³è¡¡åè®®å·²ç»æœ€å¤§é™åº¦åœ°å‡å°‘äº†æ€§èƒ½å½±å“ï¼Œå…è®¸æ›´é¢‘ç¹çš„å†å¹³è¡¡ä»¥æ›´å¥½åœ°åˆ†é…æ¯ä¸ªåˆ†åŒºä¸Šçš„è´Ÿè½½ã€‚ ä¸ºäº†å¢å¼ºé‡æ–°åˆ†é…çš„çµæ´»æ€§ï¼Œåˆ†åŒºçš„æ•°é‡åº”è¯¥å¤§äº worker çš„æ•°é‡ã€‚è¿™ä¸€æ¯”ç‡åº”æ ¹æ®åº”ç”¨ç¨‹åºè€Œæœ‰æ‰€ä¸åŒï¼Œå¹¶å‡è®¾ä¸€ä¸ªå·¥ä½œçº¿ç¨‹è‡³å°‘å¯ä»¥å¤„ç†æ¥è‡ªä¸€ä¸ªåˆ†åŒºçš„è´Ÿè½½ä»¥é¿å…é¥¥é¥¿ã€‚ åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œå·¥ä½œç¨‹åº 3 åœ¨é€Ÿåº¦è¾ƒæ…¢çš„ç¡¬ä»¶ä¸Šè¿è¡Œï¼Œå¯¼è‡´åˆ†åŒº 5 å’Œ 6 å‡ºç°æ›´é«˜çš„å»¶è¿Ÿã€‚å› æ­¤ï¼Œå·¥ä½œç¨‹åº 3 å¯èƒ½ä¼šä¸»åŠ¨å–æ¶ˆè®¢é˜…ä¸»é¢˜ä»¥è§¦å‘é‡æ–°å¹³è¡¡å¹¶æ›´æœ‰æ•ˆåœ°é‡æ–°åˆ†é…åˆ†åŒºã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œåº”å®ç°è‡ªå®šä¹‰åˆ†é…å™¨ä»¥æ ¹æ®æœºå™¨æŒ‡æ ‡å’Œæ»åä¿¡æ¯é‡æ–°åˆ†é…åˆ†åŒºã€‚ æ€»ç»“ æœ¬æ–‡ä» Kafka å¹¶è¡Œæ€§çš„ä¸€èˆ¬å®ç°å‡ºå‘ï¼Œæ¢è®¨äº† Kafka å®ç°è´Ÿè½½å‡è¡¡åœ¨ç°å®å®è·µä¸­å¯èƒ½é‡åˆ°çš„å„ç§æŒ‘æˆ˜ï¼Œå¹¶ä»é™æ€è°ƒæ•´å’ŒåŠ¨æ€è°ƒæ•´ä¸¤ä¸ªæ–¹é¢ç»™å‡ºäº†è§£å†³æ€è·¯ï¼Œç‰¹åˆ«æ³¨é‡è®¨è®ºäº†åŠ¨æ€è°ƒæ•´ç­–ç•¥ï¼Œå¹¶åˆ†åˆ«ä»ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„è§’åº¦æå‡ºäº†è§£å†³æ–¹æ¡ˆã€‚ æ€»ä¹‹ï¼Œé€šè¿‡åœ¨ Kafka ä¸­å®ç°è´Ÿè½½å‡è¡¡ï¼Œå¯ä»¥æœ‰æ•ˆåœ°å°†å·¥ä½œè´Ÿè½½åˆ†é…åˆ°å¯ç”¨èµ„æºä¹‹é—´ï¼Œä»è€Œæ˜¾è‘—æé«˜æœåŠ¡æ€§èƒ½ã€‚å…·ä½“çš„ç®—æ³•å’Œç­–ç•¥éœ€è¦æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œé€‰æ‹©å’Œè°ƒæ•´ã€‚","tags":["Kafka","ä¸­é—´ä»¶","æ¶ˆæ¯é˜Ÿåˆ—"],"categories":["Kafka"]},{"title":"å­¦ä¹ è®°å½•ï¼šç”¨ Go è‡ªåˆ¶è§£é‡Šå™¨ Monkey","path":"/2024/05/12/monkey-language/","content":"è¯æ³•åˆ†æ TDDï¼šæµ‹è¯•é©±åŠ¨å¼€å‘ å…ˆå†™æµ‹è¯•ç”¨ä¾‹ï¼Œå†è¿›è¡Œè¯æ³•åˆ†æé€»è¾‘çš„å®Œå–„ã€‚ è¯­æ³•åˆ†æ é€’å½’ä¸‹é™è¯­æ³•åˆ†æä¼ªä»£ç  function parseProgram() program = newProgramASTNode() advanceTokens() for (currentToken() != EOF_TOKEN) statement = null if (currentToken() == LET_TOKEN) statement = parseLetStatement() else if (currentToken() == RETURN_TOKEN) statement = parseReturnStatement() else if (currentToken() == IF_TOKEN) statement = parseIfStatement() if (statement != null) program.Statements.push(statement) advanceTokens() return programfunction parseLetStatement() advanceTokens() identifier = parseIdentifier() advanceTokens() if currentToken() != EQUAL_TOKEN parseError(no equal sign!) return null advanceTokens() value = parseExpression() variableStatement = newVariableStatementASTNode() variableStatement.identifier = identifier variableStatement.value = value return variableStatementfunction parseIdentifier() identifier = newIdentifierASTNode() identifier.token = currentToken() return identifierfunction parseExpression() if (currentToken() == INTEGER_TOKEN) if (nextToken() == PLUS_TOKEN) return parseOperatorExpression() else if (nextToken() == SEMICOLON_TOKEN) return parseIntegerLiteral() else if (currentToken() == LEFT_PAREN) return parseGroupedExpression() // [...]function parseOperatorExpression() operatorExpression = newOperatorExpression() operatorExpression.left = parseIntegerLiteral() operatorExpression.operator = currentToken() operatorExpression.right = parseExpression() return operatorExpression() é€’å½’ä¸‹é™åˆ†ææ³• let x=5 let stmt AST structure return 5 return stmt AST structue æ™®æ‹‰ç‰¹è§£æ","tags":["Go","ç¼–è¯‘åŸç†"],"categories":["Go","Go å®æˆ˜"]},{"title":"æ—¶é—´å¤„ç†åŸºç¡€ï¼šRust çš„ chrono åº“æ•™ç¨‹","path":"/2024/05/11/rust-crate-chrono/","content":"åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸æœ‰å¯¹æ—¶é—´å’Œæ—¥æœŸå¤„ç†çš„éœ€æ±‚ã€‚ä¸è®ºæ˜¯æ—¥å†åº”ç”¨ã€æ—¥ç¨‹å®‰æ’ã€è¿˜æ˜¯æ—¶é—´æˆ³è®°å½•ï¼Œå‡†ç¡®çš„æ—¶é—´æ•°æ®å¤„ç†éƒ½æ˜¯å¿…ä¸å¯å°‘çš„ã€‚Rust ç¤¾åŒºæä¾›çš„ chrono åº“ä»¥å…¶å¼ºå¤§çš„åŠŸèƒ½å’Œçµæ´»çš„æ¥å£ï¼Œåœ¨ Rust å¼€å‘è€…ä¸­å¹¿å—æ¬¢è¿ã€‚æœ¬æ–‡å°†ç®€å•ä»‹ç» chrono åº“ï¼Œå±•ç¤ºå¦‚ä½•åˆ©ç”¨å®ƒæ¥ç²¾ç¡®å¤„ç†å’Œè½¬æ¢æ—¶é—´å’Œæ—¥æœŸï¼Œå¸®åŠ©ä½ åœ¨ä»»ä½• Rust é¡¹ç›®ä¸­éƒ½èƒ½é«˜æ•ˆåœ°ç®¡ç†æ—¶é—´ã€‚ ç‰ˆæœ¬ chrono: 0.4.38 ç»“è®ºå…ˆè¡Œ chrono å„ç§æ—¶é—´ç±»å‹è½¬æ¢å›¾ æ—¶é—´ç›¸å…³æ¦‚å¿µ æ¦‚å¿µ ç†è§£ UNIX æ—¶é—´æˆ³ï¼ˆUNIX Timestampï¼‰ ä¹Ÿç§°ä¸º POSIX æ—¶é—´æˆ– Epoch æ—¶é—´ï¼Œæ˜¯è‡ª 1970 å¹´ 1 æœˆ 1 æ—¥ï¼ˆUTC æ—¶åŒºï¼‰ä»¥æ¥ç»è¿‡çš„ç§’æ•°ï¼Œä¸è®¡å…¥é—°ç§’ã€‚è¿™æ˜¯ä¸€ç§éå¸¸é€šç”¨çš„æ—¶é—´è¡¨ç¤ºæ–¹æ³•ï¼Œåœ¨ç¼–ç¨‹ä¸­å¹¿æ³›ä½¿ç”¨ï¼Œå› ä¸ºå®ƒå¯ä»¥ç®€åŒ–æ—¶é—´å·®çš„è®¡ç®—ã€‚ UTCï¼ˆåè°ƒä¸–ç•Œæ—¶ï¼‰ å…¨ç§°ä¸ºåè°ƒä¸–ç•Œæ—¶ï¼ˆCoordinated Universal Timeï¼‰ï¼Œæ˜¯ç›®å‰å›½é™…ä¸Šå¹¿æ³›é‡‡ç”¨çš„æ—¶é—´æ ‡å‡†ã€‚å®ƒåŸºæœ¬ä¸Šä¸æ ¼æ—å¨æ²»å¹³å‡æ—¶ï¼ˆGMTï¼‰ç›¸åŒï¼Œä½†åœ¨æŠ€æœ¯ä¸Šæ›´åŠ ç²¾ç¡®ï¼Œå› ä¸ºå®ƒä½¿ç”¨åŸå­é’Ÿæ¥ä¿æŒæ—¶é—´å‡†ç¡®ã€‚ä¸–ç•Œå„åœ°çš„æ—¶é—´éƒ½æ˜¯ä»¥ UTC ä¸ºåŸºç¡€ï¼ŒåŠ ä¸Šæˆ–å‡å»ä¸€å®šçš„å°æ—¶æ•°æ¥å®šä¹‰çš„ã€‚ æ—¶åŒºï¼ˆTime Zoneï¼‰ æ—¶åŒºæ˜¯åœ°çƒä¸Šåˆ’åˆ†çš„æ ‡å‡†æ—¶é—´åŒºåŸŸã€‚ç”±äºåœ°çƒè‡ªè¥¿å‘ä¸œæ—‹è½¬ï¼Œæ¯å‘ä¸œç§»åŠ¨ä¸€å®šè§’åº¦ï¼Œå½“åœ°çš„å¤ªé˜³æ—¶é—´å°±ä¼šç›¸åº”åœ°æå‰ã€‚ä¸–ç•Œè¢«åˆ†æˆäº† 24 ä¸ªæ—¶åŒºï¼Œæ¯ä¸ªæ—¶åŒºé€šå¸¸ç›¸å·®ä¸€å°æ—¶ã€‚æ—¶åŒºå…è®¸åœ°åŒºå†…çš„äººä»¬èƒ½åœ¨å¤§è‡´ç›¸åŒçš„æ—¶é—´å†…ï¼Œç»å†ç±»ä¼¼çš„æ—¥å¤œæ›´æ›¿æ¨¡å¼ã€‚ UTC+8 UTC+8 æ˜¯ UTC æ—¶é—´åŠ ä¸Š 8 å°æ—¶çš„æ—¶é—´åŒºã€‚ä¸­å›½å¤§é™†å°±æ˜¯ä½äºè¿™ä¸ªæ—¶åŒºã€‚ä¾‹å¦‚ï¼Œå½“ UTC æ—¶é—´ä¸º 00:00 æ—¶ï¼ŒUTC+8 çš„æ—¶é—´å°±æ˜¯ 08:00ã€‚ chrono å…³é”®ç±»å‹ ç±»å‹ å«ä¹‰ é€‚ç”¨åœºæ™¯ DateTimeTz ä¸€ä¸ªå¸¦æœ‰æ—¶åŒºçš„æ—¥æœŸå’Œæ—¶é—´ç±»å‹ï¼Œå…¶ä¸­ Tz æ˜¯å®ç°äº† TimeZone ç‰¹è´¨çš„ç±»å‹ï¼Œå¦‚ Utc å’Œ Local ã€‚è¿™æ„å‘³ç€ DateTime è€ƒè™‘äº†æ—¶åŒºçš„å½±å“ï¼Œå¯ä»¥è¡¨ç¤ºå…¨çƒä»»æ„åœ°ç‚¹çš„ç²¾ç¡®æ—¶é—´ã€‚ å¹¿æ³›ç”¨äºéœ€è¦è€ƒè™‘æ—¶åŒºè½¬æ¢çš„åœºæ™¯ï¼Œå¦‚å­˜å‚¨ç”¨æˆ·çš„æœ¬åœ°æ—¶é—´æˆ–åœ¨ä¸åŒåœ°åŒºä¹‹é—´è½¬æ¢æ—¶é—´ã€‚ NaiveDateTime ä¸€ä¸ªâ€œå¤©çœŸçš„â€æ—¥æœŸå’Œæ—¶é—´ï¼Œå³ä¸åŒ…å«ä»»ä½•æ—¶åŒºä¿¡æ¯çš„æ—¥æœŸå’Œæ—¶é—´ã€‚è¿™ç§ç±»å‹ä»…ä»…è¡¨ç¤ºä¸€ä¸ªæ—¥å†æ—¥æœŸå’Œä¸€å¤©ä¸­çš„æ—¶é—´ï¼Œè€Œæ²¡æœ‰ä»»ä½•å…³äºåœ°ç†æˆ–æ”¿æ²»æ—¶åŒºçš„æ•°æ®ã€‚ å¯¹äºä¸€äº›æ—¶åŒºä¸é‡è¦çš„åœºæ™¯éå¸¸æœ‰ç”¨ï¼Œæ¯”å¦‚è®°å½•ç”µå½±çš„å‘è¡Œæ—¥æœŸæˆ–å†å²äº‹ä»¶çš„æ—¥æœŸã€‚ NaiveDate ä»…è¡¨ç¤ºä¸€ä¸ªæ—¥å†æ—¥æœŸï¼Œä¸åŒ…æ‹¬æ—¶é—´æˆ–æ—¶åŒºä¿¡æ¯ã€‚ å®ƒç”¨äºå¤„ç†åªéœ€è¦æ—¥æœŸè€Œä¸å…³å¿ƒå…·ä½“æ—¶é—´çš„åœºæ™¯ï¼Œå¦‚ç”Ÿæ—¥ã€èŠ‚æ—¥ç­‰ã€‚ NaiveTime æ˜¯ä¸€ä¸ªåªè¡¨ç¤ºä¸€å¤©ä¸­æ—¶é—´çš„ç±»å‹ï¼Œå®ƒä¸åŒ…å«æ—¥æœŸæˆ–æ—¶åŒºä¿¡æ¯ã€‚ è¿™ä¸ªç±»å‹é€‚ç”¨äºéœ€è¦å¤„ç†å…·ä½“æŸä¸ªæ—¶é—´ç‚¹ï¼ˆå¦‚å¼€ä¼šæ—¶é—´ã€æ—¥å¸¸æ´»åŠ¨çš„å¼€å§‹æ—¶é—´ï¼‰ä½†ä¸éœ€è¦æ—¥æœŸæ•°æ®çš„æƒ…æ™¯ã€‚ chrono æ—¶åŒºç±»å‹ chrono æ”¯æŒå¤šç§æ—¶åŒºç±»å‹ï¼Œæ–¹ä¾¿è¿›è¡Œå…¨çƒæ—¶é—´çš„è½¬æ¢å’Œè®¡ç®—ï¼š Utc: ç”¨äºå¤„ç†åè°ƒä¸–ç•Œæ—¶ã€‚ Local: ä»£è¡¨æœåŠ¡å™¨æˆ–ç”¨æˆ·çš„æœ¬åœ°æ—¶åŒºã€‚ FixedOffset: å…è®¸å®šä¹‰ä»»æ„çš„å°æ—¶å’Œåˆ†é’Ÿåç§»é‡ï¼Œé€‚åˆå›ºå®šåç§»çš„æ—¶é—´è®¡ç®—ã€‚ å¸¸ç”¨åŠŸèƒ½ è·å–å½“å‰æ—¶é—´ let local_datetime: DateTimeLocal = Local::now();let utc_datetime: DateTimeUtc = Utc::now(); DateTime è½¬ String println!(, local_datetime.to_rfc2822()); // Sun, 12 May 2024 00:15:55 +0800println!(, local_datetime.to_rfc3339()); // 2024-05-12T00:15:55.325058+08:00println!(, local_datetime.to_string()); // 2024-05-12 00:15:55.325058 +08:00println!(, local_datetime.format(%Y-%m-%d %H:%M:%S)) // 2024-05-12 00:15:55 String è½¬ DateTime å­—ç¬¦ä¸²å¸¦æ—¶åŒºä¿¡æ¯ï¼Œä½¿ç”¨ DateTime::parse_from_str(s, f)ã€‚ let format_withzone = %Y-%m-%d %H:%M:%S %z;let datetime_withzone_str = 2024-01-01 00:00:00 +08:00;let local_datetime = DateTime::parse_from_str(datetime_withzone_str, format_withzone).unwrap(); å­—ç¬¦ä¸²æ— æ—¶åŒºä¿¡æ¯ï¼Œä½¿ç”¨ NaiveDateTime::parse_from_str(s, f)ã€‚ let format = %Y-%m-%d %H:%M:%S;let datetime_str = 2024-01-01 00:00:00;let local_datetime = NaiveDateTime::parse_from_str(datetime_str, format) .unwrap() .and_local_timezone(Local) // è½¬ä¸ºå¸¦æ—¶åŒºçš„ DateTime .unwrap(); DateTime è½¬ timestamp let local_datetime = Local::now();println!(seconds: , local_datetime.timestamp()); // 1715444324println!(millis: , local_datetime.timestamp_millis()); // 1715444338610println!(micros: , local_datetime.timestamp_micros()); // 1715444338610873println!(nacos: , local_datetime.timestamp_nanos_opt().unwrap()); // 1715444338610873000 timestamp è½¬ DateTime let utc_datetime: DateTimeUtc = DateTime::from_timestamp(1704139200, 0).unwrap(); // é»˜è®¤æ˜¯ Utclet local_datetime: DateTimeLocal = DateTime::from_timestamp(1704139200, 0).unwrap().into(); // ä½¿ç”¨ into() è½¬ä¸º Local æ—¶åŒºè½¬æ¢ use chrono::DateTime, FixedOffset, Utc;fn main() let utc_date_time: DateTimeUtc = Utc::now(); let fixed_offset = FixedOffset::east(8 * 3600); // è½¬ä¸º utc+8 ä¸œå…«åŒº let local_date_time = utc_date_time.with_timezone(fixed_offset); println!(Local time in UTC+8: , local_date_time); æ—¶é—´è®¡ç®— æ—¶é—´åŠ å‡ï¼š use chrono::Duration, Local;let now = Local::now();let yesterday = now - Duration::hours(24); chrono time duration methods æ—¶é—´é—´éš”ï¼š use chrono::Duration, Local;let now = Local::now();let yesterday = now - Duration::hours(24);let hour_interval = (now - yesterday).num_hours(); chrono time interval methods æ€»ç»“ é€šè¿‡æœ¬æ–‡çš„è¯¦ç»†ä»‹ç»å’Œå®ç”¨ç¤ºä¾‹ï¼Œæˆ‘ä»¬äº†è§£äº†å¦‚ä½•ä½¿ç”¨ Rust çš„ chrono åº“æ¥ç²¾ç¡®å¤„ç†æ—¶é—´å’Œæ—¥æœŸã€‚chrono ä¸ä»…æ”¯æŒå¤æ‚çš„æ—¶åŒºè®¡ç®—å’Œå…¨çƒæ—¶é—´ç®¡ç†ï¼Œè¿˜æä¾›äº†æ–¹ä¾¿çš„æ—¥æœŸæ—¶é—´è§£æå’Œæ ¼å¼åŒ–å·¥å…·ï¼Œä»¥åŠçµæ´»çš„æ—¶é—´è¿ç®—åŠŸèƒ½ã€‚æŒæ¡äº†è¿™äº›æŠ€èƒ½åï¼Œä½ å°†èƒ½å¤Ÿåœ¨ä»»ä½•éœ€è¦ç²¾ç¡®æ—¶é—´æ•°æ®å¤„ç†çš„ Rust åº”ç”¨ä¸­ï¼Œæä¾›ç¨³å®šå’Œé«˜æ•ˆçš„è§£å†³æ–¹æ¡ˆã€‚ æ—¶é—´æ˜¯æ¯ä¸ªç¨‹åºçš„åŸºçŸ³ï¼Œè€Œ chrono å°±æ˜¯é‚£æŠŠèƒ½å¤Ÿæ“çºµæ—¶é—´çš„é­”æ–ã€‚ å¸Œæœ›æœ¬æ–‡èƒ½å¯¹ä½ æœ‰å¸®åŠ©ï¼Œpeace! enjoy coding~ å‚è€ƒï¼š chrono crate rust-working-with-date-and-time ä½œå›¾ï¼š https://excalidraw.com/","tags":["Rust"],"categories":["Rust","Rust å¸¸ç”¨åº“"]},{"title":"epoll","path":"/2024/04/28/epoll/","content":"å‰è¨€ epoll æ˜¯ä¸€ç§ I/O å¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œä¸»è¦ç”¨äºé«˜æ€§èƒ½çš„ç½‘ç»œæœåŠ¡å™¨ä¸­ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤§é‡å¹¶å‘è¿æ¥æ—¶ã€‚å®ƒæ˜¯ Linux ç‰¹æœ‰çš„ï¼Œè‡ª Linux å†…æ ¸ 2.5.44 ç‰ˆæœ¬å¼•å…¥ï¼Œå¹¶åœ¨åç»­ç‰ˆæœ¬ä¸­ä¸æ–­ä¼˜åŒ–ã€‚epoll èƒ½å¤Ÿå¸®åŠ©æœåŠ¡å™¨é«˜æ•ˆåœ°ç®¡ç†æ•°ä»¥åƒè®¡çš„å®¢æˆ·ç«¯è¿æ¥ï¼Œæ˜¯ select å’Œ poll æ–¹æ³•çš„ç°ä»£æ›¿ä»£å“ã€‚ æœ¬æ–‡ä¸å¯¹ epoll çš„æºç è¿›è¡Œåˆ†æï¼Œä»…åšåŸç†ä¸Šçš„æ€»ç»“ï¼Œæ–¹ä¾¿å¿«é€ŸæŸ¥é˜…å›é¡¾ã€‚å„å¤§è®ºå›å¾ˆå¤šå¤§ä½¬éƒ½å¯¹ epoll çš„æºç è¿›è¡Œäº†è¯¦å°½çš„åˆ†æï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥çœ‹ã€Œå‚è€ƒã€ç¯‡ç« ã€‚ ä¸»è¦ç‰¹ç‚¹ æ•ˆç‡é«˜: ç›¸è¾ƒäº select å’Œ pollï¼Œepoll å¯ä»¥æ›´é«˜æ•ˆåœ°å¤„ç†å¤§é‡çš„å¹¶å‘è¿æ¥ã€‚select å’Œ poll çš„æ•ˆç‡éšç€ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡å¢åŠ è€Œçº¿æ€§ä¸‹é™ï¼Œè€Œ epoll åˆ™ä¸ä¼šå› ä¸ºç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡å¢åŠ è€Œæ˜¾è‘—é™ä½æ•ˆç‡ã€‚ æ‰©å±•æ€§å¥½: epoll ä½¿ç”¨ä¸€ç§ç§°ä¸ºäº‹ä»¶é€šçŸ¥çš„æœºåˆ¶ï¼Œåªä¼šå¤„ç†é‚£äº›çœŸæ­£å‘ç”Ÿäº†äº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ã€‚è¿™æ„å‘³ç€ç³»ç»Ÿä¸å¿…é‡æ–°æ£€æŸ¥æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ï¼Œä»è€Œå¤§å¤§å‡å°‘äº†ä¸å¿…è¦çš„ CPU å¼€é”€ã€‚ æ”¯æŒè¾¹ç¼˜è§¦å‘å’Œæ°´å¹³è§¦å‘: epoll æ”¯æŒ Edge Triggered å’Œæ°´å¹³è§¦å‘ Level Triggered ä¸¤ç§æ¨¡å¼ã€‚è¾¹ç¼˜è§¦å‘æ¨¡å¼åªåœ¨æ–‡ä»¶æè¿°ç¬¦çŠ¶æ€æ”¹å˜æ—¶æ‰é€šçŸ¥åº”ç”¨ç¨‹åºï¼Œé€‚ç”¨äºéé˜»å¡ I/Oï¼›è€Œæ°´å¹³è§¦å‘æ¨¡å¼åˆ™åœ¨æœ‰äº‹ä»¶å¯è¯»æˆ–å¯å†™æ—¶éƒ½ä¼šé€šçŸ¥åº”ç”¨ç¨‹åºï¼Œæ›´å®¹æ˜“ä½¿ç”¨ä½†æ•ˆç‡ç•¥ä½ã€‚ ç»“è®ºå…ˆè¡Œ epoll flow chart å·¥ä½œåŸç† epoll çš„å·¥ä½œå¯ä»¥åˆ†ä¸ºä¸‰ä¸ªä¸»è¦æ­¥éª¤ï¼š åˆ›å»º epoll å®ä¾‹: ä½¿ç”¨ epoll_create å‡½æ•°åˆ›å»ºä¸€ä¸ª epoll å®ä¾‹ã€‚ æ·»åŠ /ä¿®æ”¹/åˆ é™¤æ–‡ä»¶æè¿°ç¬¦: ä½¿ç”¨ epoll_ctl å‡½æ•°å°†æ–°çš„æ–‡ä»¶æè¿°ç¬¦æ·»åŠ åˆ° epoll å®ä¾‹ä¸­ï¼Œæˆ–è€…ä¿®æ”¹ã€åˆ é™¤å·²å­˜åœ¨çš„æ–‡ä»¶æè¿°ç¬¦ã€‚è¿™äº›æ“ä½œä¸æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡æ— å…³ï¼Œå› æ­¤æ‰§è¡Œé€Ÿåº¦éå¸¸å¿«ã€‚ ç­‰å¾…äº‹ä»¶å‘ç”Ÿ: ä½¿ç”¨ epoll_wait å‡½æ•°ç­‰å¾…äº‹ä»¶çš„å‘ç”Ÿã€‚è¿™ä¸ªå‡½æ•°å¯ä»¥åŒæ—¶ç›‘æ§å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå½“æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦ä¸Šå‘ç”Ÿäº†æ³¨å†Œçš„äº‹ä»¶æ—¶ï¼Œå‡½æ•°è¿”å›ï¼Œå¹¶å‘ŠçŸ¥å“ªäº›æ–‡ä»¶æè¿°ç¬¦ä¸Šå‘ç”Ÿäº†äº‹ä»¶ã€‚ ET LT åœ¨ epoll ä¸­ï¼Œè¾¹ç¼˜è§¦å‘ï¼ˆET, Edge Triggeredï¼‰å’Œæ°´å¹³è§¦å‘ï¼ˆLT, Level Triggeredï¼‰æ˜¯ä¸¤ç§ä¸åŒçš„äº‹ä»¶é€šçŸ¥æ–¹å¼ï¼Œå®ƒä»¬å®šä¹‰äº†æ“ä½œç³»ç»Ÿå¦‚ä½•é€šçŸ¥åº”ç”¨ç¨‹åºæ–‡ä»¶æè¿°ç¬¦ä¸Šçš„ I/O äº‹ä»¶ã€‚ è¿™ä¸¤ç§æ¨¡å¼çš„ä¸»è¦åŒºåˆ«åœ¨äºä½•æ—¶ä»¥åŠå¦‚ä½•å¤šæ¬¡é€šçŸ¥åº”ç”¨ç¨‹åºå…³äºæŸä¸ªæ–‡ä»¶æè¿°ç¬¦çš„äº‹ä»¶ã€‚ æ°´å¹³è§¦å‘ï¼ˆLevel Triggeredï¼‰ å®šä¹‰: åœ¨æ°´å¹³è§¦å‘æ¨¡å¼ä¸‹ï¼Œåªè¦æ–‡ä»¶æè¿°ç¬¦ä¸Šæœ‰æœªå¤„ç†çš„ I/O äº‹ä»¶å­˜åœ¨ï¼Œepoll_wait å°±ä¼šé€šçŸ¥åº”ç”¨ç¨‹åºã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœæ•°æ®å¯è¯»å–ä½†æœªè¢«å®Œå…¨è¯»å–ï¼Œepoll_wait ä¼šåœ¨ä¸‹æ¬¡è°ƒç”¨æ—¶å†æ¬¡è¿”å›è¯¥æ–‡ä»¶æè¿°ç¬¦ã€‚ è¡Œä¸º: è¿™ç§æ¨¡å¼æ›´å®¹æ˜“ç¼–ç¨‹ï¼Œå› ä¸ºåº”ç”¨ç¨‹åºå¯ä»¥ä¸ç”¨æ‹…å¿ƒåœ¨ä¸€ä¸ªæ“ä½œä¸­å¤„ç†æ‰€æœ‰æ•°æ®ã€‚å¦‚æœæ•°æ®è¿˜åœ¨ï¼Œepoll_wait ä¼šç»§ç»­é€šçŸ¥ä½ ã€‚ é€‚ç”¨åœºæ™¯: æ›´é€‚åˆé‚£äº›ç®€å•çš„åº”ç”¨æˆ–è€…å¯¹å®æ—¶æ€§è¦æ±‚ä¸æ˜¯éå¸¸é«˜çš„åº”ç”¨ï¼Œå› ä¸ºå®ƒç®€åŒ–äº†å¤„ç†é€»è¾‘ã€‚ è¾¹ç¼˜è§¦å‘ï¼ˆEdge Triggeredï¼‰ å®šä¹‰: åœ¨è¾¹ç¼˜è§¦å‘æ¨¡å¼ä¸‹ï¼Œåªæœ‰çŠ¶æ€å˜åŒ–æ—¶ï¼ˆä¾‹å¦‚ä»æ— æ•°æ®åˆ°æœ‰æ•°æ®ï¼‰ï¼Œepoll_wait æ‰ä¼šé€šçŸ¥åº”ç”¨ç¨‹åºã€‚ä¸€æ—¦é€šçŸ¥äº†åº”ç”¨ç¨‹åºæŸäº‹ä»¶å‘ç”Ÿï¼Œé™¤éæœ‰æ–°çš„æ•°æ®åˆ°è¾¾æˆ–çŠ¶æ€å†æ¬¡å‘ç”Ÿå˜åŒ–ï¼Œå¦åˆ™ä¸ä¼šå†æ¬¡é€šçŸ¥åº”ç”¨ç¨‹åºè¯¥äº‹ä»¶ã€‚ è¡Œä¸º: è¿™è¦æ±‚åº”ç”¨ç¨‹åºå¿…é¡»ç«‹å³å¤„ç†æ‰€æœ‰äº‹ä»¶ï¼Œå› ä¸ºä¹‹åä¸ä¼šå†æ”¶åˆ°å…³äºè¿™äº›äº‹ä»¶çš„é€šçŸ¥ã€‚è¿™æ„å‘³ç€åº”ç”¨ç¨‹åºå¿…é¡»å¾ªç¯è¯»å–æˆ–å†™å…¥ï¼Œç›´åˆ°æ•°æ®è¢«å®Œå…¨å¤„ç†å®Œï¼Œä»¥ç¡®ä¿ä¸é—æ¼ä»»ä½•äº‹ä»¶ã€‚ é€‚ç”¨åœºæ™¯: é€‚åˆéœ€è¦é«˜æ€§èƒ½çš„åœºæ™¯ï¼Œå› ä¸ºå®ƒå‡å°‘äº†äº‹ä»¶å¤„ç†çš„æ¬¡æ•°ï¼Œä½†è¦æ±‚ç¨‹åºå¿…é¡»æ›´åŠ å°å¿ƒåœ°ç®¡ç† I/O æ“ä½œã€‚ æ¯”è¾ƒå’Œé€‰æ‹© æ€§èƒ½: è¾¹ç¼˜è§¦å‘é€šå¸¸æä¾›æ›´é«˜çš„æ€§èƒ½ï¼Œå› ä¸ºå®ƒå‡å°‘äº†ç³»ç»Ÿè°ƒç”¨çš„æ¬¡æ•°å’Œä¸å¿…è¦çš„äº‹ä»¶å¤„ç†ã€‚ ç¼–ç¨‹å¤æ‚æ€§: è¾¹ç¼˜è§¦å‘æ¨¡å¼ç¼–ç¨‹æ¯”æ°´å¹³è§¦å‘å¤æ‚ï¼Œå› ä¸ºéœ€è¦ç¡®ä¿æ¯æ¬¡äº‹ä»¶è¢«å½»åº•å¤„ç†ï¼Œå¹¶ä¸”æ›´å®¹æ˜“é‡åˆ°å¦‚â€œæƒŠç¾¤æ•ˆåº”â€ï¼ˆå¤šä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹è¢«åŒä¸€ä¸ªäº‹ä»¶å”¤é†’ï¼‰ç­‰é—®é¢˜ã€‚ å¯é æ€§: æ°´å¹³è§¦å‘å› ä¸ºå…¶ç®€å•çš„è¡Œä¸ºæ¨¡å¼ï¼Œåœ¨å¯é æ€§å¤„ç†ä¸Šæ›´ä¸ºç›´æ¥å’Œå®¹æ˜“ã€‚ é€šå¸¸ï¼Œé€‰æ‹©å“ªç§æ¨¡å¼å–å†³äºåº”ç”¨çš„å…·ä½“éœ€æ±‚ã€é¢„æœŸçš„è´Ÿè½½ä»¥åŠå¼€å‘è€…å¯¹äº‹ä»¶å¤„ç†é€»è¾‘çš„æ§åˆ¶ç¨‹åº¦ã€‚é«˜æ€§èƒ½æœåŠ¡å™¨é€šå¸¸é€‰æ‹©è¾¹ç¼˜è§¦å‘æ¨¡å¼ï¼Œä»¥æœ€å¤§åŒ–å…¶æ•ˆç‡ï¼Œè€Œç®€å•çš„æˆ–è€…ä½è´Ÿè½½åº”ç”¨å¯èƒ½ä¼šæ›´å€¾å‘äºä½¿ç”¨æ°´å¹³è§¦å‘ï¼Œä»¥ç®€åŒ–å¼€å‘å’Œè°ƒè¯•è¿‡ç¨‹ã€‚ æ•°æ®ç»“æ„ epoll ä½¿ç”¨ 2 ç§å…³é”®çš„æ•°æ®ç»“æ„æ¥ç»´æŠ¤å’Œè·Ÿè¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆFDï¼‰å’Œäº‹ä»¶ï¼š çº¢é»‘æ ‘ï¼ˆRed-Black Treeï¼‰: ç”¨äºå­˜å‚¨æ‰€æœ‰æ³¨å†Œçš„æ–‡ä»¶æè¿°ç¬¦åŠå…¶äº‹ä»¶ã€‚çº¢é»‘æ ‘æ˜¯ä¸€ç§è‡ªå¹³è¡¡äºŒå‰æœç´¢æ ‘ï¼Œèƒ½å¤Ÿåœ¨å¯¹æ•°æ—¶é—´å†…å®Œæˆæ’å…¥ã€åˆ é™¤å’ŒæŸ¥æ‰¾æ“ä½œï¼Œè¿™ä½¿å¾—ç®¡ç†å¤§é‡æ–‡ä»¶æè¿°ç¬¦å˜å¾—é«˜æ•ˆã€‚ å°±ç»ªåˆ—è¡¨ï¼ˆReady Listï¼‰: å½“äº‹ä»¶å‘ç”Ÿï¼ˆå¦‚å¯è¯»ã€å¯å†™ç­‰ï¼‰å¹¶è¢«å†…æ ¸æ£€æµ‹åˆ°æ—¶ï¼Œç›¸åº”çš„ FD ä¼šè¢«æ·»åŠ åˆ°ä¸€ä¸ªå°±ç»ªåˆ—è¡¨ä¸­ã€‚è¿™ä¸ªåˆ—è¡¨ä»…åŒ…å«å®é™…æœ‰äº‹ä»¶å‘ç”Ÿçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä»è€Œå‡å°‘äº† epoll_wait è°ƒç”¨çš„å¤„ç†æ—¶é—´ã€‚ å·¥ä½œç»†èŠ‚ epoll data structure é€šè¿‡è°ƒç”¨ epoll_create() å‡½æ•°åˆ›å»ºå¹¶åˆå§‹åŒ–ä¸€ä¸ª eventpoll å¯¹è±¡ã€‚ é€šè¿‡è°ƒç”¨ epoll_ctl() å‡½æ•°æŠŠè¢«ç›‘å¬çš„æ–‡ä»¶å¥æŸ„ (å¦‚ socket å¥æŸ„) å°è£…æˆ epitem å¯¹è±¡å¹¶ä¸”æ·»åŠ åˆ° eventpoll å¯¹è±¡çš„çº¢é»‘æ ‘ä¸­è¿›è¡Œç®¡ç†ã€‚ é€šè¿‡è°ƒç”¨ epoll_wait() å‡½æ•°ç­‰å¾…è¢«ç›‘å¬çš„æ–‡ä»¶çŠ¶æ€å‘ç”Ÿæ”¹å˜ã€‚ å½“è¢«ç›‘å¬çš„æ–‡ä»¶çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼ˆå¦‚ socket æ¥æ”¶åˆ°æ•°æ®ï¼‰ï¼Œä¼šæŠŠæ–‡ä»¶å¥æŸ„å¯¹åº” epitem å¯¹è±¡æ·»åŠ åˆ° eventpoll å¯¹è±¡çš„å°±ç»ªé˜Ÿåˆ— rdllist ä¸­ã€‚å¹¶ä¸”æŠŠå°±ç»ªé˜Ÿåˆ—çš„æ–‡ä»¶åˆ—è¡¨å¤åˆ¶åˆ° epoll_wait() å‡½æ•°çš„ events å‚æ•°ä¸­ã€‚ å”¤é†’è°ƒç”¨ epoll_wait() å‡½æ•°è¢«é˜»å¡ï¼ˆç¡çœ ï¼‰çš„è¿›ç¨‹ã€‚ äº‹ä»¶ç›‘å¬ å†…æ ¸ä¸­çš„äº‹ä»¶ç›‘å¬å’Œå›è°ƒæœºåˆ¶æ˜¯é€šè¿‡é«˜æ•ˆçš„äº‹ä»¶é©±åŠ¨æ¨¡å‹å®ç°çš„ï¼Œè€Œä¸æ˜¯ç®€å•çš„å¾ªç¯æ£€æŸ¥ï¼ˆå¦‚åœ¨ç”¨æˆ·ç©ºé—´ä¸­çš„è½®è¯¢ï¼‰ã€‚è¿™ç§æœºåˆ¶åˆ©ç”¨äº†ç°ä»£æ“ä½œç³»ç»Ÿçš„ä¸­æ–­å’Œå›è°ƒç³»ç»Ÿï¼Œä»¥åŠé’ˆå¯¹å¼‚æ­¥äº‹ä»¶çš„ä¼˜åŒ–å¤„ç†ç­–ç•¥ã€‚ ä»¥ä¸‹æ˜¯è¿™ä¸ªè¿‡ç¨‹çš„è¯¦ç»†è§£é‡Šï¼š 1. ä¸­æ–­å’Œä¸­æ–­å¤„ç† åœ¨ç¡¬ä»¶å±‚é¢ï¼Œå¤§å¤šæ•° I/O æ“ä½œï¼ˆå¦‚ç½‘ç»œé€šä¿¡ã€ç£ç›˜ I/Oï¼‰éƒ½æ˜¯é€šè¿‡ä¸­æ–­é©±åŠ¨çš„ã€‚å½“ä¸€ä¸ª I/O è®¾å¤‡å‡†å¤‡å¥½æ•°æ®æˆ–éœ€è¦æœåŠ¡æ—¶ï¼Œå®ƒä¼šäº§ç”Ÿä¸€ä¸ªä¸­æ–­ä¿¡å·ï¼Œè¿™ä¸ªä¿¡å·è¢«å‘é€åˆ° CPUã€‚CPU å“åº”ä¸­æ–­ï¼Œå¹¶æ‰§è¡Œä¸€ä¸ªé¢„å®šçš„ä¸­æ–­å¤„ç†ç¨‹åºï¼ˆInterrupt Service Routine, ISRï¼‰ï¼Œè¯¥ç¨‹åºæ˜¯ç”±è®¾å¤‡çš„é©±åŠ¨ç¨‹åºæä¾›çš„ã€‚ 2. äº‹ä»¶å’Œå›è°ƒ åœ¨ ISR ä¸­ï¼Œä¸è®¾å¤‡ç›¸å…³çš„äº‹ä»¶ï¼ˆä¾‹å¦‚ç½‘ç»œåŒ…çš„æ¥æ”¶ã€ç¡¬ç›˜è¯»å–å®Œæˆï¼‰ä¼šè¢«æ£€æµ‹åˆ°ï¼Œå¹¶ä¸”å¯ä»¥åœ¨æ­¤é˜¶æ®µè°ƒç”¨ç‰¹å®šçš„å›è°ƒå‡½æ•°ã€‚è¿™äº›å›è°ƒå‡½æ•°æ˜¯åœ¨è®¾å¤‡é©±åŠ¨æˆ–ç›¸å…³çš„å†…æ ¸æ¨¡å—ä¸­å®šä¹‰çš„ï¼Œç”¨æ¥é€šçŸ¥å†…æ ¸å…¶ä»–éƒ¨åˆ†æˆ–è€…ç›¸å…³çš„è¿›ç¨‹æœ‰å…³äº‹ä»¶çš„å‘ç”Ÿã€‚ 3. æ–‡ä»¶æè¿°ç¬¦çš„å›è°ƒæœºåˆ¶ å¯¹äº epoll ç­‰ I/O å¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œå†…æ ¸ä¸ºæ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦ç»´æŠ¤äº†ä¸€ä¸ªäº‹ä»¶å¤„ç†æœºåˆ¶ã€‚å½“æ–‡ä»¶æè¿°ç¬¦è¢«åˆ›å»ºæ—¶ï¼Œç›¸å…³çš„è®¾å¤‡æˆ–èµ„æºä¼šæ³¨å†Œä¸€ç»„å›è°ƒå‡½æ•°ï¼Œè¿™äº›å‡½æ•°ä¼šåœ¨ç‰¹å®šçš„æ“ä½œï¼ˆå¦‚è¯»ã€å†™ã€é”™è¯¯ï¼‰ä¸Šè¢«è§¦å‘ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªç½‘ç»œå¥—æ¥å­—å¯èƒ½ä¼šåœ¨æ•°æ®åˆ°è¾¾æ—¶è§¦å‘ä¸€ä¸ªâ€œå¯è¯»â€äº‹ä»¶çš„å›è°ƒã€‚ 4. epoll çš„äº‹ä»¶ç»‘å®š å½“ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦è¢«åŠ å…¥åˆ° epoll ç›‘å¬é˜Ÿåˆ—ä¸­ï¼Œepoll ä¼šåˆ©ç”¨è¿™äº›å›è°ƒæ¥è·å¾—äº‹ä»¶é€šçŸ¥ã€‚epoll æ“ä½œç›¸å…³çš„ä»£ç ä¼šå°†ä¸€ä¸ªé¢å¤–çš„å›è°ƒå‡½æ•°ç»‘å®šåˆ°è¿™äº›æ–‡ä»¶æè¿°ç¬¦ä¸Šã€‚å½“æ–‡ä»¶æè¿°ç¬¦çš„çŠ¶æ€æ”¹å˜æ—¶ï¼ˆå¦‚æ•°æ®å¯è¯»ï¼‰ï¼Œè¿™ä¸ªå›è°ƒå‡½æ•°å°†è¢«è§¦å‘ï¼Œç„¶åå®ƒä¼šå°†ç›¸åº”çš„æ–‡ä»¶æè¿°ç¬¦æ ‡è®°ä¸ºâ€œå°±ç»ªâ€ï¼Œå¹¶æ”¾å…¥ epoll çš„å°±ç»ªé˜Ÿåˆ—ã€‚ 5. äº‹ä»¶é€šçŸ¥å’Œå”¤é†’ å½“ epoll_wait è¢«è°ƒç”¨ä¸”æœ‰äº‹ä»¶å°±ç»ªæ—¶ï¼Œå†…æ ¸ä¼šæ£€æŸ¥å°±ç»ªé˜Ÿåˆ—ï¼Œå¹¶å°†è¿™äº›äº‹ä»¶ä¼ é€’ç»™ç­‰å¾…çš„è¿›ç¨‹ã€‚å¦‚æœæ²¡æœ‰äº‹ä»¶å°±ç»ªï¼Œè¿›ç¨‹å°†è¢«æŒ‚èµ·ç›´åˆ°æœ‰äº‹ä»¶å‘ç”Ÿã€‚äº‹ä»¶çš„å‘ç”Ÿä¼šè§¦å‘å†…æ ¸è°ƒåº¦ç¨‹åºå”¤é†’ç›¸åº”çš„è¿›ç¨‹ã€‚ 6. æ•ˆç‡å’Œæ€§èƒ½ è¿™ç§åŸºäºä¸­æ–­çš„äº‹ä»¶é€šçŸ¥æœºåˆ¶æ„å‘³ç€å†…æ ¸ä¸éœ€è¦ä¸æ–­å¾ªç¯æ£€æŸ¥æ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„çŠ¶æ€ï¼Œä»è€Œæå¤§åœ°æé«˜äº†æ•ˆç‡ã€‚äº‹ä»¶åªæœ‰åœ¨å®é™…å‘ç”Ÿæ—¶æ‰è¢«å¤„ç†ï¼Œä¸”å¤„ç†é€šå¸¸æ˜¯ç”±ç¡¬ä»¶ä¸­æ–­ç›´æ¥è§¦å‘çš„ï¼Œè¿™ä½¿å¾—æ•´ä¸ªç³»ç»Ÿæ›´åŠ å“åº”å¿«é€Ÿï¼Œå‡å°‘äº†æ— æ•ˆçš„ CPU ä½¿ç”¨ã€‚ è¿™ç§è®¾è®¡ä½¿å¾— Linux å†…æ ¸åœ¨å¤„ç†å¤§é‡å¹¶å‘ I/O æ“ä½œæ—¶èƒ½å¤Ÿä¿æŒé«˜æ•ˆå’Œç¨³å®šï¼Œé€‚åˆæ„å»ºé«˜æ€§èƒ½çš„ç½‘ç»œæœåŠ¡å’Œåº”ç”¨ã€‚ ä¸­æ–­ ä¸­æ–­æœºåˆ¶æ˜¯è®¡ç®—æœºç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿæ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œå®ƒå…è®¸å¤–è®¾æˆ–ç¡¬ä»¶å¼‚æ­¥åœ°é€šçŸ¥ CPU éœ€è¦å¤„ç†æŸäº›äº‹ä»¶ã€‚ä¸­æ–­æœºåˆ¶çš„å®ç°å¹¶ä¸ä¾èµ–äºç±»ä¼¼äº for å¾ªç¯çš„è½®è¯¢æ£€æŸ¥ï¼Œè€Œæ˜¯å»ºç«‹åœ¨æ›´ä¸ºç›´æ¥å’Œé«˜æ•ˆçš„ç¡¬ä»¶å’Œå¤„ç†å™¨æ¶æ„æ”¯æŒä¹‹ä¸Šã€‚ å½“ CPU æ¥æ”¶åˆ°ä¸­æ–­ä¿¡å·æ—¶ï¼Œå®ƒæ˜¯é€šè¿‡ä¸€å¥—å†…å»ºäºç¡¬ä»¶çš„åè°ƒæœºåˆ¶æ¥è¯†åˆ«å’Œå“åº”ä¸­æ–­çš„ã€‚è¿™ä¸ªè¿‡ç¨‹æ¶‰åŠç¡¬ä»¶ç”µè·¯è®¾è®¡ã€å¤„ç†å™¨æ¶æ„å’Œæ“ä½œç³»ç»Ÿçš„ä¸­æ–­ç®¡ç†åŠŸèƒ½ã€‚ ä»¥ä¸‹æ˜¯ CPU å¦‚ä½•çŸ¥é“æœ‰ä¸­æ–­å‘ç”Ÿï¼Œå¹¶ä¸”å¦‚ä½•å¤„ç†è¿™ä¸€ä¸­æ–­çš„è¯¦ç»†æ­¥éª¤ï¼š ä¸­æ–­ä¿¡å·çš„æ£€æµ‹å’Œå“åº” ä¸­æ–­è¯·æ±‚çº¿ï¼ˆIRQï¼‰ï¼šå¤–éƒ¨è®¾å¤‡é€šè¿‡è¿æ¥åˆ°å¤„ç†å™¨çš„ä¸€ä¸ªç‰¹å®šçš„ç¡¬ä»¶çº¿è·¯ï¼ˆIRQï¼‰å‘é€ä¸­æ–­ä¿¡å·ã€‚è¿™ä¸ªçº¿è·¯ç›´æ¥ä¸å¤„ç†å™¨å†…çš„ä¸­æ–­æ§åˆ¶å•å…ƒï¼ˆInterrupt Controllerï¼‰ç›¸è¿ã€‚ ä¸­æ–­æ§åˆ¶å™¨ï¼šå¤§å¤šæ•°ç°ä»£è®¡ç®—æœºç³»ç»Ÿä½¿ç”¨ä¸€ä¸ªæˆ–å¤šä¸ªä¸­æ–­æ§åˆ¶å™¨æ¥ç®¡ç†ä¸­æ–­ä¿¡å·ã€‚ä¸­æ–­æ§åˆ¶å™¨çš„ä»»åŠ¡æ˜¯æ¥æ”¶æ¥è‡ªå„ç§å¤–éƒ¨è®¾å¤‡çš„ä¸­æ–­è¯·æ±‚ï¼Œå¹¶å°†è¿™äº›è¯·æ±‚ä¼˜å…ˆçº§æ’åºåå‘é€ç»™ CPUã€‚ ä¸­æ–­å‘é‡ï¼šå½“ä¸­æ–­æ§åˆ¶å™¨æ¥æ”¶åˆ°ä¸€ä¸ªä¸­æ–­ä¿¡å·åï¼Œå®ƒä¼šæ ¹æ®ä¸­æ–­æºç¡®å®šä¸€ä¸ªä¸­æ–­å‘é‡ã€‚è¿™ä¸ªå‘é‡æ˜¯ä¸€ä¸ªæ•°å­—ï¼ŒæŒ‡å‘ä¸­æ–­å‘é‡è¡¨ä¸­å¯¹åº”çš„å…¥å£ï¼Œè¯¥å…¥å£åŒ…å«äº†å¤„ç†è¯¥ä¸­æ–­çš„ä¸­æ–­æœåŠ¡ä¾‹ç¨‹ï¼ˆISRï¼‰çš„åœ°å€ã€‚ CPU å¦‚ä½•å¤„ç†ä¸­æ–­ å½“å‰æŒ‡ä»¤çš„å®Œæˆï¼šå½“ CPU æ¥æ”¶åˆ°ä¸­æ–­æ§åˆ¶å™¨å‘å‡ºçš„ä¸­æ–­ä¿¡å·æ—¶ï¼Œå®ƒé¦–å…ˆä¼šå®Œæˆå½“å‰æ‰§è¡Œçš„æŒ‡ä»¤ã€‚è¿™æ˜¯ä¸ºäº†ä¿è¯ç¨‹åºçš„çŠ¶æ€èƒ½å¤Ÿæ­£ç¡®ä¿å­˜ï¼Œä»è€Œåœ¨ä¸­æ–­å¤„ç†å®Œæ¯•åå¯ä»¥æ— ç¼åœ°æ¢å¤æ‰§è¡Œã€‚ ä¿å­˜ä¸Šä¸‹æ–‡ï¼šä¸€æ—¦å½“å‰æŒ‡ä»¤æ‰§è¡Œå®Œæ¯•ï¼ŒCPU ä¼šè‡ªåŠ¨ä¿å­˜å½“å‰çš„ç¨‹åºçŠ¶æ€ï¼ŒåŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰ã€å¯„å­˜å™¨å’Œå…¶ä»–å¿…è¦çš„çŠ¶æ€ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯é€šå¸¸è¢«æ¨é€åˆ°å½“å‰çš„æ ˆä¸Šã€‚ è·³è½¬åˆ° ISRï¼šCPU ä½¿ç”¨ä¸­æ–­å‘é‡æ¥è®¿é—®ä¸­æ–­å‘é‡è¡¨ï¼Œæ‰¾åˆ°ä¸ä¸­æ–­å·å¯¹åº”çš„ä¸­æ–­æœåŠ¡ä¾‹ç¨‹ï¼ˆISRï¼‰çš„åœ°å€ï¼Œå¹¶è·³è½¬åˆ°è¯¥åœ°å€å¼€å§‹æ‰§è¡Œ ISRã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯è‡ªåŠ¨çš„ï¼Œç”±å¤„ç†å™¨çš„å†…éƒ¨æœºåˆ¶æ§åˆ¶ã€‚ æ‰§è¡Œ ISRï¼šä¸­æ–­æœåŠ¡ä¾‹ç¨‹ä¼šæ‰§è¡Œå¿…è¦çš„æ“ä½œæ¥å¤„ç†ä¸­æ–­ï¼Œæ¯”å¦‚è¯»å–æ•°æ®ç¼“å†²åŒºã€æ¸…é™¤è®¾å¤‡çŠ¶æ€æˆ–å‘é€ä¿¡å·ç­‰ã€‚ æ¢å¤ä¸Šä¸‹æ–‡å¹¶è¿”å›ï¼šä¸€æ—¦ ISR æ‰§è¡Œå®Œæˆï¼Œå¤„ç†å™¨ä¼šä»æ ˆä¸Šæ¢å¤ä¹‹å‰ä¿å­˜çš„ç¨‹åºçŠ¶æ€ï¼Œå¹¶å°†æ§åˆ¶æƒè¿”å›åˆ°è¢«ä¸­æ–­çš„ç¨‹åºï¼Œç»§ç»­æ‰§è¡Œã€‚ ç¡¬ä»¶æ”¯æŒ è¿™ä¸€è¿‡ç¨‹å¤§é‡ä¾èµ–äºå¤„ç†å™¨çš„ç¡¬ä»¶æ”¯æŒï¼Œå¦‚ä¸­æ–­å‘é‡è¡¨é€šå¸¸æ˜¯å›ºå®šåœ¨å¤„ç†å™¨çš„ç‰¹å®šå†…å­˜åœ°å€ä¸Šçš„ã€‚æ­¤å¤–ï¼Œç°ä»£å¤„ç†å™¨å¦‚ x86 æ¶æ„è¿˜æä¾›äº†æ›´é«˜çº§çš„åŠŸèƒ½ï¼Œæ¯”å¦‚æ”¯æŒå¤šé‡ä¸­æ–­æ§åˆ¶å™¨å’Œé«˜çº§å¯ç¼–ç¨‹ä¸­æ–­æ§åˆ¶å™¨ï¼ˆAPICï¼‰ç­‰ã€‚ è¿™ç§åŸºäºç¡¬ä»¶çš„ä¸­æ–­å“åº”æœºåˆ¶å…è®¸ CPU å¿«é€Ÿæœ‰æ•ˆåœ°å¤„ç†å„ç§å¤–éƒ¨äº‹ä»¶ï¼Œç¡®ä¿ç³»ç»Ÿçš„å“åº”æ€§å’Œç¨³å®šæ€§ã€‚ å‚è€ƒ å›¾è§£ | æ·±å…¥æ­ç§˜ epoll æ˜¯å¦‚ä½•å®ç° IO å¤šè·¯å¤ç”¨çš„ï¼ ä¸€å›¾æ€»ç»“ epoll çš„æ€»ä½“å·¥ä½œæµç¨‹ scalable-io-events-vs-multithreading-based Epoll å®ç°åŸç† ç½‘ç»œç¼–ç¨‹ä¹‹ epoll æºç æ·±åº¦å‰–æ","tags":["epoll","ç½‘ç»œç¼–ç¨‹","éé˜»å¡ I/0"],"categories":["è®¡ç®—æœºåŸºç¡€","è®¡ç®—æœºç½‘ç»œ"]},{"title":"Rust å®æˆ˜ä¸¨å¹¶å‘æ„å»ºå€’æ’ç´¢å¼•","path":"/2024/04/23/rust-action-inverted-index-concurrency/","content":"å¼•è¨€ ç»§ä¸Šç¯‡ Rust å®æˆ˜ä¸¨å€’æ’ç´¢å¼•ï¼Œæœ¬ç¯‡æˆ‘ä»¬å°†å‚è€ƒã€ŠRust ç¨‹åºè®¾è®¡ï¼ˆç¬¬äºŒç‰ˆï¼‰ã€‹ä¸­å¹¶å‘ç¼–ç¨‹ç¯‡ç« æ¥å®ç°é«˜å¹¶å‘æ„å»ºå€’æ’ç´¢å¼•ã€‚ æœ¬ç¯‡ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š åŠŸèƒ½å±•ç¤ºï¼šå±•ç¤ºæˆ‘ä»¬æœ€ç»ˆå®ç°çš„ 2 ä¸ªå·¥å…·çš„æ•ˆæœï¼ˆæ„å»ºç´¢å¼•ã€æœç´¢åŠŸèƒ½ï¼‰ é˜…è¯»æºç ï¼šé˜…è¯»ä¹¦ä¸­æºç çš„å®ç°ï¼Œç†æ¸…å¤§ä½“æ€è·¯ã€‚ æ„å»ºç´¢å¼•ï¼šå®æˆ˜æ„å»ºç´¢å¼•çš„æ¯ä¸ªå…·ä½“ç¯èŠ‚ï¼Œå¹¶å¯¹æ ¸å¿ƒé€»è¾‘è¿›è¡Œè§£é‡Šå’Œé˜è¿°ç¼˜ç”±ã€‚ æœç´¢åŠŸèƒ½ï¼šè¿™æ˜¯ä¹¦ä¸­æœªæ›¾æä¾›çš„åŠŸèƒ½ï¼Œç¬”è€…æ ¹æ®è‡ªèº«ç†è§£ï¼Œå¯¹é½ä¸Šç¯‡æä¾›çš„åŠŸèƒ½ï¼Œå®ç°äº†ä¸€ä¸ªæœç´¢åŠŸèƒ½ã€‚ èƒ½å­¦åˆ°ï¼š Rust å„ç§è¿­ä»£å™¨çš„ä½¿ç”¨ Rust æ–‡ä»¶å¸¸ç”¨æ“ä½œ Rust å­—ç¬¦ä¸²å¸¸ç”¨æ“ä½œ Rust channel å®æˆ˜ Rust å¹¶å‘ç¼–ç¨‹ å¤šè·¯åˆå¹¶æ–‡ä»¶å®é™…åº”ç”¨ ä½¿ç”¨ byteorder è¿›è¡Œä½æ“ä½œ ä½¿ç”¨ clap è¿›è¡Œ CLI å¼€å‘ ç»ˆç«¯é«˜äº®è¾“å‡º æ·±å…¥ç†è§£å€’æ’ç´¢å¼•é«˜æ€§èƒ½çš„æ ¸å¿ƒç»†èŠ‚ é˜…è¯»å»ºè®® æœ¬ç¯‡å†…å®¹è¾ƒä¸ºå†—é•¿ï¼Œæ¶‰åŠåˆ°çš„ç»†èŠ‚è®²è§£å¯èƒ½æ¯”è¾ƒå•°å—¦ï¼Œæ¨èç›´æ¥é˜…è¯»æºç ï¼Œç„¶åå¯¹ä¸ç†è§£çš„åœ°æ–¹å†æ¥æœ¬ç¯‡å¯¹åº”çš„ç« èŠ‚è¿›è¡Œé˜…è¯»ã€‚ å®Œæˆæºç ä½äºï¼šhttps://github.com/hedon-rust-road/inverted-index-concurrency ç‰ˆæœ¬å£°æ˜ Rust: 1.76 byteordrr: 1.5.0 clap: 4.5.0 è¿è¡Œç¯å¢ƒï¼šmacbookPro Apple M2 Max åŠŸèƒ½å±•ç¤º create.rs Usage: create [OPTIONS] FILENAMES...Arguments: FILENAMES...Options: -s, --single-threaded Default false -h, --help Print help æŒ‡å®šæ–‡ä»¶ç›®å½•ï¼Œæ„å»ºç´¢å¼•ï¼Œå¯ä»¥ä½¿ç”¨ -s ä½¿ç”¨å•çº¿ç¨‹æ„å»ºï¼Œé»˜è®¤ä½¿ç”¨å¹¶å‘æ„å»ºã€‚ æ‰§è¡Œç¤ºä¾‹å¦‚ä¸‹ï¼š âœ inverted-index-concurrency git:(master) âœ— cargo run --bin create ./texts Finished dev [unoptimized + debuginfo] target(s) in 0.08s Running `/Users/wangjiahan/rust-target/debug/create ./texts`indexed document 0:./texts/text1.txt, 22 bytes, 5 wordsindexed document 1:./texts/text3.txt, 27 bytes, 5 wordsindexed document 2:./texts/text2.txt, 39 bytes, 6 wordsword count: 16351 bytes main, 736 bytes totalwrote file ./tmp00000001.dat search.rs Usage: search --index-file INDEX_FILE --term TERMOptions: -i, --index-file INDEX_FILE Specify index file path -t, --term TERM Specify search term -h, --help Print help æŒ‡å®šç´¢å¼•æ–‡ä»¶å’Œæœç´¢è¯æ¥è¿›è¡Œæœç´¢ã€‚ æ‰§è¡Œç¤ºä¾‹å¦‚ä¸‹ï¼š search.rs æ‰§è¡Œç¤ºä¾‹ é˜…è¯»æºç  ä¹¦ä¸­çš„æºç ä½äºï¼šfingertips ç¬¬ä¸€éƒ¨åˆ†æˆ‘ä»¬å…ˆæ¥é˜…è¯»æºç ï¼Œä¹¦ä¸­å±•ç¤ºäº†è¿™æ ·ä¸€å¼ å›¾ï¼š ç´¢å¼•æ„å»ºå™¨ç®¡é“ï¼Œå…¶ä¸­ç®­å¤´è¡¨ç¤ºé€šè¿‡é€šé“å°†å€¼ä»ä¸€ä¸ªçº¿ç¨‹å‘é€åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼ˆæœªå±•ç¤ºç£ç›˜ I/Oï¼‰ ä»è¿™å¼ å›¾æˆ‘ä»¬å¤§æ¦‚å¯ä»¥çŒœæƒ³æœ¬æ¡ˆä¾‹ä¸­æ„å»ºå¹¶å‘ç´¢å¼•çš„è¿‡ç¨‹å¯èƒ½æ˜¯ï¼š è¯»å–æ–‡ä»¶å†…å®¹ï¼› æ ¹æ®æ–‡ä»¶å†…å®¹æ„å»ºç´¢å¼•ï¼› å¤šä¸ªç´¢å¼•è¿›è¡Œåˆå¹¶ï¼› å°†ç´¢å¼•å†™å…¥æ–‡ä»¶ï¼› å¤šä¸ªç´¢å¼•æ–‡ä»¶è¿›è¡Œåˆå¹¶ã€‚ æŒ‰ç…§è¿™ä¸ªæ€è·¯çš„æŒ‡å¼•ï¼Œæˆ‘ä»¬æ‰“å¼€æºç ï¼Œä» main.rs çš„ main() å‡ºå‘ï¼š fn main() let mut single_threaded = false; let mut filenames = vec![]; // å‘½ä»¤è¡Œå‚æ•°è§£æ let mut ap = ArgumentParser::new(); ap.set_description(Make an inverted index for searching documents.); ap.refer(mut single_threaded).add_option( [-1, --single-threaded], StoreTrue, Do all the work on a single thread., ); ap.refer(mut filenames).add_argument( filenames, Collect, Names of files/directories to index. \\ For directories, all .txt files immediately \\ under the directory are indexed., ); ap.parse_args_or_exit(); // æ„å»ºç´¢å¼• match run(filenames, single_threaded) Ok(()) = Err(err) = println!(error: , err), è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Œè¿™é‡Œä½¿ç”¨ argparse è¿™ä¸ªæ¯”è¾ƒå¤è€çš„ crate æ¥è§£æï¼Œç°åœ¨ä¸€èˆ¬æ˜¯ä½¿ç”¨ clapã€‚ single_threaded: æ˜¯å¦ä½¿ç”¨å•çº¿ç¨‹ï¼Œé»˜è®¤æ˜¯å¤šçº¿ç¨‹ã€‚ filenames: æŒ‡å®šçš„æ–‡æœ¬æ–‡ä»¶æˆ–ç›®å½•ã€‚ run å‡½æ•°æ‰§è¡Œæ„å»ºç´¢å¼•ã€‚ çœ‹ä¸€ä¸‹ runï¼š /// Generate an index for a bunch of text files.fn run(filenames: VecString, single_threaded: bool) - io::Result() let output_dir = PathBuf::from(.); let documents = expand_filename_arguments(filenames)?; if single_threaded run_single_threaded(documents, output_dir) else run_pipeline(documents, output_dir) å•çº¿ç¨‹ï¼šrun_single_threaded å¤šçº¿ç¨‹ï¼šrun_pipeline å…ˆä»ç®€å•çœ‹ï¼Œå•çº¿ç¨‹ï¼Œå¿½ç•¥æ‰æºç ä¸­å®šä¹‰çš„ç‰¹æ®Šæ•°æ®ç»“æ„ï¼Œå¯ä»¥å‘ç°è·Ÿæˆ‘ä»¬ä¸Šç¯‡ä»‹ç»çš„ç®€å•ç‰ˆå€’æ’ç´¢å¼•æ€è·¯åŸºæœ¬æ˜¯ä¸€è‡´çš„ï¼Œåªä¸è¿‡æœ¬æ¡ˆä¾‹ä¸­æ•°æ®æ˜¯ä»æ–‡ä»¶ä¸­è¯»ï¼Œæœ€ååˆä¼šå°†ç´¢å¼•å†™å…¥åˆ°æ–‡ä»¶ä¸­ã€‚ fn run_single_threaded(documents: VecPathBuf, output_dir: PathBuf) - io::Result() let mut accumulated_index = InMemoryIndex::new(); let mut merge = FileMerge::new(output_dir); let mut tmp_dir = TmpDir::new(output_dir); // è¿­ä»£æ¯ä¸ªæ–‡æœ¬æ–‡ä»¶ for (doc_id, filename) in documents.into_iter().enumerate() // æ‰“å¼€æ–‡ä»¶ï¼Œå¹¶å°†å†…å®¹è¯»å–åˆ° `text` ä¸Š let mut f = File::open(filename)?; let mut text = String::new(); f.read_to_string(mut text)?; // æ„å»ºç´¢å¼• let index = InMemoryIndex::from_single_document(doc_id, text); accumulated_index.merge(index); if accumulated_index.is_large() // å½“ç´¢å¼•è¶³å¤Ÿå¤§çš„æ—¶å€™ï¼Œå°†å…¶å†™åˆ°æ–‡ä»¶ä¸­ let file = write_index_to_tmp_file(accumulated_index, mut tmp_dir)?; merge.add_file(file)?; accumulated_index = InMemoryIndex::new(); // å°†æœ€åä¸€ä¸ªç´¢å¼•å†™å…¥åˆ°æ–‡ä»¶ä¸­ if !accumulated_index.is_empty() let file = write_index_to_tmp_file(accumulated_index, mut tmp_dir)?; merge.add_file(file)?; merge.finish() å†æ¥çœ‹æœ¬æ–‡çš„é‡å¤´æˆï¼Œå¤šçº¿ç¨‹ï¼š fn run_pipeline(documents: VecPathBuf, output_dir: PathBuf) - io::Result() // å°†æ„å»ºç´¢å¼•åˆ†ä¸º 5 ä¸ªè¿‡ç¨‹ let (texts, h1) = start_file_reader_thread(documents); let (pints, h2) = start_file_indexing_thread(texts); let (gallons, h3) = start_in_memory_merge_thread(pints); let (files, h4) = start_index_writer_thread(gallons, output_dir); let result = merge_index_files(files, output_dir); // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œå®Œæ¯• let r1 = h1.join().unwrap(); h2.join().unwrap(); h3.join().unwrap(); let r4 = h4.join().unwrap(); r1?; r4?; result é¦–å…ˆå°†ç´¢å¼•æ„å»ºåˆ†æˆ 5 ä¸ªé˜¶æ®µï¼š 1. start_file_reader_thread å°±æ˜¯ä»æ–‡ä»¶ä¸­è¯»å–æ–‡æœ¬ä¿¡æ¯ï¼Œå¹¶å°†å…¶æ‰”è¿› ReceiverString channel ä¸­ï¼Œä¼ åˆ°ä¸‹ä¸€ä¸ªé˜¶æ®µã€‚ fn start_file_reader_thread( documents: VecPathBuf,) - (ReceiverString, JoinHandleio::Result()) let (sender, receiver) = channel(); let handle = spawn(move || for filename in documents let mut f = File::open(filename)?; let mut text = String::new(); // è¯»å–æ–‡ä»¶å†…å®¹ f.read_to_string(mut text)?; if sender.send(text).is_err() break; Ok(()) ); (receiver, handle) 2. start_file_indexing_thread ä»ç¬¬ 1 æ­¥ä¼ è¿‡æ¥çš„æ–‡æœ¬ä¿¡æ¯ä¸­è°ƒç”¨ InMemoryIndex::from_single_document æ„å»ºç´¢å¼•ã€‚ fn start_file_indexing_thread( texts: ReceiverString,) - (ReceiverInMemoryIndex, JoinHandle()) let (sender, receiver) = channel(); let handle = spawn(move || for (doc_id, text) in texts.into_iter().enumerate() // æ„å»ºç´¢å¼• let index = InMemoryIndex::from_single_document(doc_id, text); if sender.send(index).is_err() break; ); (receiver, handle) 3. start_in_memory_merge_thread å°†ç¬¬ 2 æ­¥æ„å»ºçš„å•ä¸€ç´¢å¼•è¿›è¡Œåˆå¹¶ï¼Œå¹¶å°†åˆå¹¶åçš„ç´¢å¼•ä¼ åˆ°ä¸‹ä¸€ä¸ªé˜¶æ®µã€‚ fn start_in_memory_merge_thread( file_indexes: ReceiverInMemoryIndex,) - (ReceiverInMemoryIndex, JoinHandle()) let (sender, receiver) = channel(); let handle = spawn(move || let mut accumulated_index = InMemoryIndex::new(); for fi in file_indexes // å°†ç´¢å¼•è¿›è¡Œåˆå¹¶ accumulated_index.merge(fi); if accumulated_index.is_large() // å¦‚æœç´¢å¼•å¤§å°åˆ°è¾¾é˜ˆå€¼ï¼Œåˆ™ä¼ åˆ°ä¸‹ä¸€é˜¶æ®µ if sender.send(accumulated_index).is_err() return; accumulated_index = InMemoryIndex::new(); if !accumulated_index.is_empty() let _ = sender.send(accumulated_index); ); (receiver, handle) 4. start_index_writer_thread å°†ç¬¬ 3 æ­¥ä¼ æ¥çš„å†…å­˜ç´¢å¼•å†™å…¥åˆ°ä¸´æ—¶æ–‡ä»¶ä¸­ã€‚ fn start_index_writer_thread( big_indexes: ReceiverInMemoryIndex, output_dir: Path,) - (ReceiverPathBuf, JoinHandleio::Result()) let (sender, receiver) = channel(); let mut tmp_dir = TmpDir::new(output_dir); let handle = spawn(move || for index in big_indexes // å°†ç´¢å¼•å†™å…¥ä¸´æ—¶æ–‡ä»¶ä¸­ let file = write_index_to_tmp_file(index, mut tmp_dir)?; if sender.send(file).is_err() break; Ok(()) ); (receiver, handle) 5. merge_index_files å°†ä¸´æ—¶æ–‡ä»¶è¿›è¡Œåˆå¹¶ï¼Œç”Ÿæˆæœ€ç»ˆçš„ç´¢å¼•æ–‡ä»¶ã€‚ fn merge_index_files(files: ReceiverPathBuf, output_dir: Path) - io::Result() let mut merge = FileMerge::new(output_dir); for file in files merge.add_file(file)?; merge.finish() è¿™ 5 ä¸ªæ­¥éª¤è·Ÿä¹¦ä¸­ç»™å‡ºçš„ç¤ºæ„å›¾åŸºæœ¬ä¸€è‡´ï¼Œæˆ‘ä»¬å†æ¥çœ‹ run_pipeline æ˜¯å¦‚ä½•åˆå¹¶å¹¶è¡Œçš„ï¼š // ä½¿ç”¨ join() ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆlet r1 = h1.join().unwrap();h2.join().unwrap();h3.join().unwrap();let r4 = h4.join().unwrap();// é˜¶æ®µ 2 å’Œé˜¶æ®µ 3 éƒ½æ˜¯çº¯å†…å­˜æ“ä½œï¼Œä¸ä¼šæœ‰é”™è¯¯// é˜¶æ®µ 1 æ˜¯è¯»æ–‡ä»¶ï¼Œé˜¶æ®µ 4 æ˜¯å†™æ–‡ä»¶ï¼Œæ‰€ä»¥æœ‰å¯èƒ½ä¼šæŠ¥é”™r1?;r4?; run_pipeline ç¤ºæ„å›¾ æºç é˜…è¯»éƒ¨åˆ†å·®ä¸å¤šå°±åˆ°è¿™äº†ï¼Œå¤§çš„æ€æƒ³æ¶æ„ä½ åº”è¯¥éƒ½èƒ½ Get åˆ°äº†ï¼Œå…¶ä¸­æ¯ä¸ªæ•°æ®ç»“æ„çš„å…·ä½“å®ç°ç»†èŠ‚ï¼Œæˆ‘ä»¬åœ¨åé¢çš„å®æˆ˜ä¸­è¿›è¡Œæ‹†è§£ã€‚ æ„å»ºç´¢å¼• ä»£ç ç»“æ„ ä¹¦ä¸­æºç ä»£ç ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š âœ fingertips git:(master) âœ— tree.â”œâ”€â”€ Cargo.lockâ”œâ”€â”€ Cargo.tomlâ”œâ”€â”€ LICENSE-MITâ”œâ”€â”€ README.mdâ”œâ”€â”€ srcâ”‚ â”œâ”€â”€ index.rsâ”‚ â”œâ”€â”€ main.rsâ”‚ â”œâ”€â”€ merge.rsâ”‚ â”œâ”€â”€ read.rsâ”‚ â”œâ”€â”€ tmp.rsâ”‚ â””â”€â”€ write.rs ä¹¦ä¸­ç»™å‡ºçš„æºç å¹¶æ²¡æœ‰å®ç°ä½¿ç”¨æ„å»ºå¥½çš„ç´¢å¼•æ–‡ä»¶è¿›è¡Œæœç´¢çš„åŠŸèƒ½ï¼Œç¬”è€…å°†åœ¨æ­¤åŸºç¡€ä¸Šå®ç°è¯¥åŠŸèƒ½ï¼Œæ‰€ä»¥å¯¹ä»£ç ç»“æ„è¿›è¡Œäº†ç®€å•çš„è°ƒæ•´ï¼š âœ inverted_index git:(master) âœ— tree.â”œâ”€â”€ Cargo.lockâ”œâ”€â”€ Cargo.tomlâ”œâ”€â”€ index.batâ”œâ”€â”€ srcâ”‚ â”œâ”€â”€ binâ”‚ â”‚ â”œâ”€â”€ create.rsâ”‚ â”‚ â””â”€â”€ search.rsâ”‚ â”œâ”€â”€ index.rsâ”‚ â”œâ”€â”€ lib.rsâ”‚ â”œâ”€â”€ merge.rsâ”‚ â”œâ”€â”€ read.rsâ”‚ â”œâ”€â”€ tmp.rsâ”‚ â””â”€â”€ write.rsâ””â”€â”€ texts â”œâ”€â”€ text1.txt â”œâ”€â”€ text2.txt â””â”€â”€ text3.txt å¯ä»¥çœ‹åˆ°æˆ‘å°†æ ¸å¿ƒä»£ç ä» bin æ”¹æˆäº† lib ï¼Œè¿™æ˜¯ä¸ºäº†æ”¯æŒæˆ‘åé¢è¦å®ç°çš„ä¸¤ä¸ª bin: create: æ„å»ºç´¢å¼•ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯æºä»£ç ä¸­çš„ main.rs search: åŸºäºç”Ÿæˆçš„ç´¢å¼•æ–‡ä»¶å®ç°æœç´¢åŠŸèƒ½ texts æ˜¯æˆ‘æä¾›çš„æ–‡æœ¬æ–‡ä»¶æ ·ä¾‹ã€‚ src ç›®å½•ä¸­çš„ä»£ç é˜…è¯»é¡ºåºåŠåŠŸèƒ½åˆ’åˆ†å¦‚ä¸‹ï¼š index: å®šä¹‰äº†å†…å­˜ç´¢å¼•æ•°æ®ç»“æ„ InMemoryIndexï¼Œå®ç°äº†ä»æ–‡ä»¶å†…å®¹ä¸­æ„å»ºå†…å­˜ç´¢å¼•çš„åŸºæœ¬é€»è¾‘ï¼Œä¹Ÿå®ç°äº†ä»ç´¢å¼•æ–‡ä»¶é‡å»ºå†…å­˜ç´¢å¼•çš„åŠŸèƒ½ã€‚ tmp: å®šä¹‰äº†ä¸´æ—¶ç›®å½•æ•°æ®ç»“æ„ TmpDirï¼Œç”¨äºå­˜æ”¾ä¸´æ—¶ç´¢å¼•æ–‡ä»¶ã€‚ write: å®šä¹‰äº†ç´¢å¼•æ–‡ä»¶å†™å…¥å™¨ IndexFileWriterï¼Œå®ç°äº†å°† InMemoryIndex å†™å…¥æ–‡ä»¶ä¸­çš„é€»è¾‘ã€‚ merge: å®šä¹‰äº†æ–‡ä»¶åˆå¹¶å™¨ FileMergeï¼Œç”¨äºåˆå¹¶ TmpDir çš„æ‰€æœ‰ç´¢å¼•æ–‡ä»¶ã€‚ read: å®šä¹‰äº†ç´¢å¼•æ–‡ä»¶è¯»å–å™¨ IndexFileWriteï¼Œå®ç°äº†è§£æç´¢å¼•æ–‡ä»¶çš„é€»è¾‘ã€‚ é¡¹ç›®å‡†å¤‡ cargo new --lib inverted_index_concurrency Cargo.toml [package]name = inverted-index-concurrencyversion = 0.1.0edition = 2021license = mitauthors = [hedon]description = a tool to concurrently build an inverted index.[[bin]]name=createpath=src/bin/create.rs[[bin]]name=searchpath=src/bin/search.rs[dependencies]byteorder = 1.5.0clap = version = 4.5.4, features = [derive] lib.rs pub mod index;pub mod merge;pub mod read;pub mod tmp;pub mod write; åœ¨ lib.rs ä¸­æˆ‘ä»¬å°†è¿™ 5 ä¸ª mod å…¬å¼€å‡ºå»ï¼Œè¿™æ ·å°±å¯ä»¥ç»™ bin ç›®å½•ä¸­çš„ crate.rs å’Œ search.rs ä½¿ç”¨äº†ã€‚ index.rs å®Œæ•´æºç ï¼šindex.rs ç¬¬ä¸€éƒ¨åˆ†æ˜¯å†…å­˜ç´¢å¼•çš„æ„å»ºã€‚ tokenize æˆ‘ä»¬å…ˆå®šä¹‰ä¸€ä¸ªåˆ†è¯å‡½æ•°ï¼š fn tokenize(text: str) - Vec(str, usize, usize) let mut res = Vec::new(); let mut token_start = None; for (idx, ch) in text.char_indices() match (ch.is_alphanumeric(), token_start) (true, None) = token_start = Some(idx), // æ¯ä¸ªå•è¯çš„å¼€å§‹ (false, Some(start)) = // æ¯ä¸ªå•è¯çš„ç»“å°¾ res.push((text[start..idx], start, idx - 1)); token_start = None _ = if let Some(start) = token_start res.push((text[start..], start, text.len() - 1)) res è¿™ä¸ªåˆ†è¯å‡½æ•°è·Ÿä¹¦ä¸­æºç æä¾›çš„ä¸ä¸€æ ·ï¼Œä¸ºäº†å®ç°æ–‡æœ¬é«˜äº®ï¼Œæˆ‘ä»¬éœ€è¦è®°å½•æ¯ä¸ªåˆ†è¯åœ¨åŸæ–‡æœ¬ä¸­çš„èµ·å§‹ä½ç½®å’Œç»“æŸä½ç½®ã€‚å®ƒçš„æ ¸å¿ƒé€»è¾‘å¦‚ä¸‹ï¼š é€šè¿‡ char_indices() è·å– text çš„å­—ç¬¦è¿­ä»£å™¨ï¼Œè¿™æ˜¯ä¸€ç§æ‡’åŠ è½½çš„æ–¹æ³•ï¼Œé¿å…ä¸€æ¬¡æ€§å°†æ‰€æœ‰ char åŠ è½½åˆ°å†…å­˜ä¸­ã€‚ åŒ¹é… (ch.is_alphanumeric(), token_start)ï¼š å¦‚æœæ˜¯ (true, None) åˆ™è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå•è¯çš„å¼€å§‹ï¼Œæˆ‘ä»¬çºªå½•å…¶å¼€å§‹çš„ä½ç½® Some(idx)ï¼› å¦‚æœæ˜¯ (false, Some(idx)) åˆ™è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå•è¯çš„ç»“æŸï¼Œæˆ‘ä»¬å°†å…¶åŠ å…¥åˆ° res ä¸­ï¼Œå¹¶è®°å½•èµ·å§‹ä½ç½®å’Œç»“æŸä½ç½®ã€‚ å…¶ä»–æƒ…å†µï¼Œä¸åšå¤„ç†ï¼Œè¦ä¹ˆæ˜¯éæ³•å­—ç¬¦ï¼Œè¦ä¹ˆæ˜¯å¤„äºå•è¯ä¸­é—´ã€‚ ä»è¿™ä¸ªç®€å•çš„ç†è§£ä¸­ï¼Œä½ åº”è¯¥å¯ä»¥æ„Ÿå—åˆ° Rust ä¸­ match pattern çš„å¼ºå¤§å’Œä¾¿æ·äº†ï¼Œ666 ğŸ‘ğŸ» struct: InMemoryIndex åœ¨ index.rs ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸‰ä¸ªæ•°æ®ç»“æ„ï¼š pub struct InMemoryIndex pub word_count: usize, pub terms: HashMapString, VecHit, pub docs: HashMapusize, Document,pub struct Document pub id: u32, pub path: PathBuf,pub type Hit = Vecu8; Document: æ–‡æ¡£å°è£…ã€‚ id: æ–‡æ¡£ idï¼Œå”¯ä¸€æ ‡è¯†ç¬¦ã€‚ path: æºæ–‡ä»¶è·¯å¾„ã€‚ Hit: å®ƒæ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„ï¼Œæˆ‘ä»¬æŒ‰ç…§å°ç«¯åºè¿›è¡Œå­˜å‚¨ï¼Œå®ƒçš„å­˜å‚¨ç»“æ„å¦‚ä¸‹ï¼š [0..3] å­˜å‚¨ä¸€ä¸ª HITS_SEPERATOR = -1ï¼Œè¡¨ç¤ºä¸€ä¸ª Hit çš„å¼€å§‹ã€‚ [4..7] å­˜å‚¨ä¸€ä¸ª u32 çš„ document_idã€‚ åé¢æ¯ 8 ä¸ª u8 ä¼šå­˜åœ¨ä¸€ä¸ª u32 çš„ start_pos å’Œä¸€ä¸ª u32 çš„ end_posã€‚ InMemoryIndex: å†…å­˜ç´¢å¼•ã€‚ word_count: åŒ…å«çš„å•è¯ï¼ˆword/termï¼‰ä¸ªæ•°ï¼Œè®°å½•å®ƒæ˜¯ä¸ºäº†åˆ¤æ–­ç´¢å¼•æ˜¯å¦è¿‡å¤§ï¼Œä»¥ä¾¿å¯¹ç´¢å¼•è¿›è¡Œåˆ†ç‰‡å­˜å‚¨ã€‚ terms: å­˜å‚¨ word åˆ° Hits çš„æ˜ å°„ï¼Œæ¯ä¸ª word æ˜¯ä¸€ä¸ªæœç´¢é¡¹ã€‚ docs: å­˜å‚¨äº† document_id åˆ°æ–‡æ¡£çš„æ˜ å°„ï¼Œç”¨äºæŸ¥è¯¢åŸå§‹æ–‡æ¡£ä¿¡æ¯ã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä¸º InMemoryIndex å®ç°ä¸€ç³»åˆ—æ–¹æ³•ï¼Œå› ä¸ºæˆ‘ä»¬æœŸæœ›ä½¿ç”¨å°ç«¯åºå­˜å‚¨ Hit ä¸­çš„æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¼•å…¥ byteorder è¿™ä¸ª crate: cargo add byteorder å…·ä½“å®ç°å¯å‚è€ƒæºç ï¼Œæ ¸å¿ƒé€»è¾‘æ˜¯ from_single_document å’Œ mergeã€‚ from_single_document from_single_document çš„æ ¸å¿ƒé€»è¾‘åœ¨è¿™ä¸€æ®µï¼Œå®ƒå…¶å®è·Ÿæˆ‘ä»¬ä¹‹å‰å®ç°çš„ç®€æ˜“ç‰ˆå€’æ’ç´¢å¼•å¾ˆç›¸ä¼¼ï¼š for (token, start_pos, end_pos) in tokens.iter() let hits = index.terms.entry(token.to_string()).or_insert_with(|| let mut hits = Vec::with_capacity(4 + 4 + 4 + 4); hits.write_i32::LittleEndian(Self::HITS_SEPERATOR) .unwrap(); hits.write_u32::LittleEndian(document_id).unwrap(); vec![hits] ); hits[0].write_u32::LittleEndian(*start_pos as u32).unwrap(); hits[0].write_u32::LittleEndian(*end_pos as u32).unwrap(); index.word_count += 1; éå†æ¯ä¸ª token å’Œå®ƒåœ¨æ–‡æœ¬ä¸­çš„ä½ç½®ã€‚ å¯¹äºæ¯ä¸ª tokenï¼Œå°è¯•åœ¨ç´¢å¼•çš„ map ä¸­æŸ¥æ‰¾ä¸€ä¸ªç°æœ‰çš„æ¡ç›®ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„ Hit è®°å½•ï¼Œå¹¶åˆå§‹åŒ–å®ƒï¼š åˆ›å»ºä¸€ä¸ªæ–°çš„ Hit å‘é‡ï¼Œé¢„ç•™ 24 å­—èŠ‚çš„å®¹é‡ï¼Œè¿™æ˜¯å› ä¸ºè‡³å°‘è¦å­˜å‚¨ 1 ä¸ªåˆ†éš”ç¬¦ã€1 ä¸ª document_idã€1 ä¸ª start_pos å’Œ 1 ä¸ª end_posã€‚ é¦–å…ˆå†™å…¥ HITS_SEPERATOR å’Œ document_idï¼ˆä½¿ç”¨å°ç«¯åºï¼‰ã€‚ å‘å¯¹åº”çš„ Hit å‘é‡ä¸­æ·»åŠ å½“å‰å•è¯çš„ä½ç½®ã€‚ ç´¯åŠ å¤„ç†çš„å•è¯æ€»æ•°åˆ° index.word_countã€‚ è¿™é‡Œç»™ä¸ªç¤ºä¾‹ï¼Œå¸Œæœ›å¯ä»¥å¸®åŠ©ä½ ç†è§£ InMemoryIndex çš„å†…å­˜ç»“æ„ï¼š InMemoryIndexâ”‚â”œâ”€â”€ word_count: usizeâ”‚â”œâ”€â”€ terms: HashMapString, VecHitâ”‚ â”‚â”‚ â”œâ”€â”€ Key: example (String)â”‚ â”‚ â””â”€â”€ Value: VecHitâ”‚ â”‚ â”œâ”€â”€ [HITS_SEPERATOR, Document ID: 1, Positions: [10, 19, 30, 39]] (Hit)â”‚ â”‚ â””â”€â”€ [HITS_SEPERATOR, Document ID: 2, Positions: [15, 25]] (Hit)â”‚ â”‚â”‚ â””â”€â”€ Key: testâ”‚ â””â”€â”€ Value: VecHitâ”‚ â””â”€â”€ [HITS_SEPERATOR, Document ID: 1, Positions: [20, 24, 50, 69]] (Hit)â”‚â””â”€â”€ docs: HashMapu32, Document â”œâ”€â”€ Key: 1 (u32) â”‚ â””â”€â”€ Value: Document id: 1, path: path/to/file1.txt â””â”€â”€ Key: 2 â””â”€â”€ Value: Document id: 2, path: path/to/file2.txt merge merge æ˜¯ç”¨äºåˆå¹¶å¤šä¸ª InMemoryIndexï¼Œèµ·åˆ°æ‰¹å¤„ç†çš„ç›®çš„ã€‚ pub fn merge(mut self, other: InMemoryIndex) for (term, hits) in other.terms self.terms.entry(term).or_default().extend(hits) self.word_count += other.word_count; self.docs.extend(other.docs); å®ç°å®Œäº† InMemoryIndex åï¼Œæˆ‘ä»¬å°±å¯ä»¥å…ˆæ¥å®Œæˆ create.rs çš„ run_pipeline çš„å‰ 3 ä¸ªé˜¶æ®µäº†ã€‚ step1: start_file_reader_thread è¯»å–æ–‡ä»¶ä¿¡æ¯ï¼šæˆ‘ä»¬éœ€è¦åœ¨ç‹¬ç«‹çš„çº¿ç¨‹ä¸­ä¾æ¬¡æ‰“å¼€ç»™å®šçš„æ–‡ä»¶åˆ—è¡¨ï¼Œå¹¶å°†æ–‡ä»¶å†…å®¹è¯»å–åˆ°ä¸€ä¸ª String ä¸­ï¼Œå¹¶åˆ©ç”¨ channel ä¼ é€å‡ºå»ã€‚ fn start_file_reader_thread( documents: VecPathBuf,) - (Receiver(PathBuf, String), JoinHandleio::Result()) let (sender, receiver) = channel(); let handler = spawn(move || for filename in documents let mut f = File::open(filename.clone())?; let mut text = String::new(); f.read_to_string(mut text)?; if sender.send((filename, text)).is_err() break; Ok(()) ); (receiver, handler) step2: start_file_indexing_thread æ„å»ºç´¢å¼•ï¼šé€šè¿‡ channel ä»ç¬¬ 1 é˜¶æ®µä¸­è·å–æ–‡æ¡£æ–‡æœ¬ä¿¡æ¯ï¼Œé€šè¿‡ from_single_document æ„å»ºç´¢å¼• InMemoryIndex åï¼Œå°†ç´¢å¼•é€šè¿‡ channel ä¼ é€å‡ºå»ã€‚ fn start_file_indexing_thread( docs: Receiver(PathBuf, String),) - (ReceiverInMemoryIndex, JoinHandle()) let (sender, receiver) = channel(); let handler = spawn(move || for (doc_id, (path, text)) in docs.into_iter().enumerate() let index = InMemoryIndex::from_single_document(doc_id as u32, path, text); if sender.send(index).is_err() break; ); (receiver, handler) step3: start_in_memory_merge_thread åˆå¹¶ç´¢å¼•ï¼šé€šè¿‡ channel ä»ç¬¬ 2 é˜¶æ®µä¸­è·å¾—æ„å»ºçš„ InMemoryIndex å¹¶å°†å…¶åˆå¹¶æˆå¤§ç´¢å¼•ï¼Œç„¶åé€šè¿‡ channel ä¼ é€å‡ºå»ã€‚ fn start_in_memory_merge_thread( indexes: ReceiverInMemoryIndex,) - (ReceiverInMemoryIndex, JoinHandle()) let (sender, receiver) = channel(); let handle = spawn(move || let mut accumulated_index = InMemoryIndex::new(); for i in indexes accumulated_index.merge(i); if accumulated_index.is_large() if sender.send(accumulated_index).is_err() return; accumulated_index = InMemoryIndex::new(); if !accumulated_index.is_empty() let _ = sender.send(accumulated_index); ); (receiver, handle) è¡¥å……ï¼šä¸ºä»€ä¹ˆé‡‡ç”¨è¿™ç§â€œå¤æ‚â€çš„æ–¹å¼æ¥å­˜å‚¨æ•°æ®å‘¢ï¼Ÿå¯å¦ä½¿ç”¨ JSON æˆ–è€… Protobuf å‘¢ï¼Ÿ é€‰æ‹©å¦‚ä½•ç»„ç»‡å’Œå­˜å‚¨æ•°æ®ï¼Œç‰¹åˆ«æ˜¯åœ¨å®ç°ä¸€ä¸ªæœç´¢å¼•æ“æˆ–æ•°æ®åº“ç´¢å¼•æ—¶ï¼Œæ˜¯ä¸€ä¸ªå…³é”®å†³ç­–ï¼Œè¿™ä¼šç›´æ¥å½±å“åˆ°ç¨‹åºçš„æ€§èƒ½ã€å¯ç»´æŠ¤æ€§ä»¥åŠæ‰©å±•æ€§ã€‚åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œä½¿ç”¨åƒbyteorder è¿™æ ·çš„ä½çº§æ•°æ®æ ¼å¼å­˜å‚¨ç´¢å¼•ä¿¡æ¯å¯èƒ½æ¯”ä½¿ç”¨ JSON æˆ–Protobuf ç­‰é«˜çº§æ ¼å¼æ›´æœ‰ä¼˜åŠ¿ã€‚è¯»å†™é€Ÿåº¦ï¼šäºŒè¿›åˆ¶æ ¼å¼ï¼šç›´æ¥æ“ä½œäºŒè¿›åˆ¶æ ¼å¼é€šå¸¸æ¯”è§£ææ–‡æœ¬æˆ–åŠç»“æ„åŒ–çš„æ•°æ®æ ¼å¼ï¼ˆå¦‚JSONï¼‰è¦å¿«ï¼Œå› ä¸ºå®ƒå‡å°‘äº†è§£ææ—¶é—´å’Œå†…å­˜ä½¿ç”¨ã€‚åœ¨äºŒè¿›åˆ¶æ ¼å¼ä¸­ï¼Œæ•°æ®é€šå¸¸æ˜¯ç´§å¯†æ‰“åŒ…çš„ï¼Œæ²¡æœ‰é¢å¤–çš„æ ¼å¼æ ‡è®°ï¼ˆå¦‚JSON ä¸­çš„èŠ±æ‹¬å·å’Œé€—å·ï¼‰ï¼Œè¿™å‡å°‘äº†ç£ç›˜ I/O éœ€æ±‚ã€‚æ–‡æœ¬/åŠç»“æ„åŒ–æ ¼å¼ï¼šä¾‹å¦‚JSONï¼Œæ¯æ¬¡è¯»å–æ—¶éƒ½éœ€è¦è§£ææ–‡æœ¬ï¼Œè½¬æ¢æ•°æ®ç±»å‹ï¼Œè¿™ä¼šå¢åŠ  CPUçš„è´Ÿæ‹…ï¼Œå°¤å…¶æ˜¯åœ¨å¤§è§„æ¨¡æ•°æ®å¤„ç†æ—¶ã€‚ç©ºé—´æ•ˆç‡ï¼šäºŒè¿›åˆ¶æ ¼å¼ï¼šä½¿ç”¨æœ€å°‘çš„å­—èŠ‚è¡¨ç¤ºæ•°æ®ï¼Œä¾‹å¦‚ä½¿ç”¨å®šé•¿çš„æ•´æ•°å­˜å‚¨æ–‡æ¡£ID å’Œä½ç½®ç´¢å¼•ï¼Œä¸ä»…èŠ‚çœç©ºé—´ï¼Œè¿˜èƒ½æé«˜ç¼“å­˜åˆ©ç”¨ç‡ã€‚æ–‡æœ¬/åŠç»“æ„åŒ–æ ¼å¼ï¼šæ–‡æœ¬æ ¼å¼éœ€è¦å­˜å‚¨é¢å¤–çš„å­—ç¬¦æ¥æ ‡è¯†æ•°æ®ï¼ˆä¾‹å¦‚å¼•å·å’Œé”®åï¼‰ï¼Œè¿™å¢åŠ äº†å­˜å‚¨éœ€æ±‚ã€‚é€‚ç”¨åœºæ™¯ï¼šäºŒè¿›åˆ¶æ ¼å¼ï¼šéå¸¸é€‚åˆéœ€è¦é«˜æ€§èƒ½å’Œå¤§æ•°æ®å¤„ç†çš„åç«¯ç³»ç»Ÿï¼Œå¦‚æœç´¢å¼•æ“å’Œæ•°æ®åº“ç´¢å¼•ã€‚è¿™ç§æ ¼å¼å¯ä»¥æœ‰æ•ˆåœ°æ”¯æŒå¿«é€Ÿçš„æ•°æ®è¯»å–å’Œå†™å…¥ï¼Œç‰¹åˆ«æ˜¯åœ¨èµ„æºå—é™çš„ç¯å¢ƒä¸­ï¼ˆå¦‚åµŒå…¥å¼ç³»ç»Ÿæˆ–ä½å»¶è¿Ÿåº”ç”¨ï¼‰ã€‚JSON/Protobufï¼šæ›´é€‚åˆéœ€è¦è·¨å¹³å°å…¼å®¹æ€§å’Œæ˜“äºè°ƒè¯•çš„åº”ç”¨åœºæ™¯ã€‚ä¾‹å¦‚ï¼Œåœ¨Web åº”ç”¨ä¸­ä½¿ç”¨ JSON ä½œä¸ºæ•°æ®äº¤æ¢æ ¼å¼ï¼Œå¯ä»¥ç®€åŒ–å‰åç«¯çš„é›†æˆå’Œæµ‹è¯•ã€‚ tmp.rs å®Œæˆå†…å­˜ç´¢å¼•çš„æ„å»ºåï¼Œæˆ‘ä»¬éœ€è¦å°†æ„å»ºè¿‡ç¨‹ä¸­äº§ç”Ÿçš„å¤§ç´¢å¼•å…ˆä¸´æ—¶è½ç›˜ï¼Œåé¢å†è¿›è¡Œåˆå¹¶ã€‚ä¸ºäº†ä¸´æ—¶å­˜å‚¨è¿™äº›æ•°æ®æ–‡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦å°†ä»–ä»¬æ”¾åœ¨ä¸€ä¸ªä¸´æ—¶ç›®å½•ä¸­ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬å®šä¹‰äº† TmpDir æ•°æ®ç»“æ„ï¼š #[derive(Clone)]pub struct TmpDir dir: PathBuf, n: usize, dir: ç›®å½• n: è‡ªå¢å™¨ï¼Œç”¨äºåŒºåˆ†ä¸´æ—¶æ–‡ä»¶å‘½å æ¥ä¸‹æ¥ä¸º TmpDir å®ç° 2 ä¸ªæ–¹æ³•ï¼š impl TmpDir pub fn newP: AsRefPath(dir: P) - TmpDir TmpDir dir: dir.as_ref().to_owned(), n: 1, pub fn create(mut self) - io::Result(PathBuf, BufWriterFile) let mut r#try = 1; loop let filename = self .dir .join(PathBuf::from(format!(tmp:08x.dat, self.n))); self.n += 1; match fs::OpenOptions::new() .write(true) .create_new(true) .open(filename) Ok(f) = return Ok((filename, BufWriter::new(f))), Err(exc) = if r#try 999 exc.kind() == io::ErrorKind::AlreadyExists // keep going else return Err(exc); r#try += 1; new æ–¹æ³•æ˜¯ TmpDir çš„æ„é€ å‡½æ•°ï¼Œå…¶ä¸­æˆ‘ä»¬å°† n è®¾ç½®ä¸º 1ï¼Œå³æ–‡ä»¶åä» 1 å¼€å§‹ç”Ÿæˆã€‚dir.as_ref().to_owned() æ¥å—ä¸€ä¸ªå¯èƒ½æ˜¯ä»»ä½•ç±»å‹çš„è·¯å¾„ï¼Œå°†å…¶æ ‡å‡†åŒ–ä¸ºä¸€ä¸ª Path ç±»å‹çš„å¼•ç”¨ï¼Œç„¶åå†å¤åˆ¶è¿™ä¸ªå¼•ç”¨ï¼Œåˆ›å»ºä¸€ä¸ªå®Œå…¨ç‹¬ç«‹çš„ã€æ‹¥æœ‰æ‰€æœ‰æƒçš„ PathBuf å¯¹è±¡ï¼Œ create æ–¹æ³•æ˜¯åœ¨ TmpDir ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ã€‚ write.rs å®Œæ•´æºç ï¼šwrite.rs å‡†å¤‡å¥½å†…å­˜ç´¢å¼•å’Œä¸´æ—¶æ–‡ä»¶ï¼Œé‚£æˆ‘ä»¬å°±éœ€è¦å®ç°å°†å†…å­˜ç´¢å¼•å†™å…¥åˆ°æ–‡ä»¶ä¸­çš„åŠŸèƒ½äº†ã€‚ struct: InMemoryIndex æˆ‘ä»¬å…ˆæ¥åˆ†æä¸€ä¸‹å¦‚ä½•å°† InMemoryIndex è½ç›˜ã€‚é¦–å…ˆ InMemoryIndex çš„ç»“æ„å¦‚ä¸‹ï¼š pub struct InMemoryIndex pub word_count: usize, pub terms: HashMapString, VecHit, pub docs: HashMapu32, Document,pub struct Document pub id: u32, pub path: PathBuf, å…¶ä¸­ word_count ä¸éœ€è¦å­˜å‚¨ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—å‡ºæ¥ã€‚é‚£æˆ‘ä»¬å°±éœ€è¦å­˜å‚¨ç´¢å¼• map å’Œæ–‡æ¡£åŸæ•°æ® docsã€‚ä¸ºäº†èƒ½ç²¾ç¡®å®šä½åˆ°å„ä¸ªæ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦ï¼š terms: å†™å…¥ VecHit docs: å†™å…¥ docs ä¸­çš„æ¯ä¸ª Document å†™å…¥ id å†™å…¥ path å¤§å° å†™å…¥ path è€Œä¸ºäº†å¿«é€Ÿå®šä½åˆ°æ¯ä¸ª term å’Œ doc çš„ä½ç½®ï¼Œæˆ‘ä»¬éœ€è¦ä¸‹é¢å‡ ä¸ªå€¼ï¼Œè¿™å‡ ä¸ªå€¼å°†ç»„åˆèµ·æ¥è¾…åŠ©æˆ‘ä»¬å¿«é€Ÿå®šä½ terms æˆ– docsï¼Œæˆ‘ä»¬åé¢ä¼šå°†å…¶ç§°ä¸º Entryï¼Œå®ƒåŒ…å«ä»¥ä¸‹å‡ ä¸ªå€¼ï¼š term: ç´¢å¼•å•è¯ã€‚ä¸ºäº†ç»Ÿä¸€ï¼Œå¦‚æœ term ä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºå½“å‰è¡¨ç¤ºçš„æ˜¯ docï¼Œå¦åˆ™ä¸º termsã€‚ df: term çš„å‡ºç°æ¬¡æ•°ã€‚ä¸ºäº†ç»Ÿä¸€ï¼Œå¦‚æœ df ä¸º 0ï¼Œåˆ™è¡¨ç¤ºå½“å‰è¡¨ç¤ºçš„æ˜¯ docï¼Œå¦åˆ™ä¸º termsã€‚ offset: å¯¹åº”çš„ terms æˆ– docs åœ¨æ–‡ä»¶ä¸­çš„åç§»ã€‚ nbytes: å¯¹åº”çš„ terms æˆ– docs çš„æ€»é•¿åº¦ã€‚ æ‰€ä»¥æ–‡ä»¶çš„å†…å­˜ç»“æ„å¤§æ¦‚å¦‚ä¸‹ï¼š æ–‡ä»¶åŒºåŸŸ æè¿° æŒ‡å‘å†…å®¹ å¤´éƒ¨ ï¼ˆ8 å­—èŠ‚ï¼‰ åŒ…å«ä¸€ä¸ªæŒ‡å‘ç›®å½•è¡¨å¼€å§‹ä½ç½®çš„åç§»é‡ã€‚ header ä¸»æ¡ç›® è¿™äº›æ¡ç›®æŒ‰é¡ºåºç´§å¯†å­˜å‚¨ï¼Œæ²¡æœ‰é¢å¤–çš„å…ƒæ•°æ®ã€‚è¿™éƒ¨åˆ†åŒ…å«å®é™…çš„æ•°æ®æ¡ç›®ã€‚ terms + docs ç›®å½•è¡¨ å­˜å‚¨åœ¨æ–‡ä»¶çš„æœ€åï¼ŒåŒ…æ‹¬æ¯ä¸ªæ¡ç›®çš„æœ¯è¯­ä¿¡æ¯ã€æ–‡æ¡£é¢‘ç‡ã€åç§»å’Œå¤§å°ã€‚ entries ç¤ºæ„å›¾å¦‚ä¸‹ï¼š ç´¢å¼•æ–‡ä»¶å†…å­˜ç»“æ„ç¤ºæ„å›¾ ä¸ºæ­¤æˆ‘ä»¬å®šä¹‰äº† IndexFileWriterï¼Œå®ƒä¸“é—¨ç”¨äºå°† InMemoryIndex å†™å…¥åˆ°ä¸´æ—¶æ–‡ä»¶ä¸­ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š /// A structure to manage writing to an index file efficiently.pub struct IndexFileWriter offset: u64, writer: BufWriterFile, contents_buf: Vecu8, offset: ç”¨äºè¿½è¸ªæ–‡ä»¶ä¸­å½“å‰çš„å†™å…¥ä½ç½®ã€‚ writer: ä¸€ä¸ªç¼“å†²å†™å…¥å™¨ï¼Œå®ƒåŒ…è£…äº†ä¸€ä¸ªæ–‡ä»¶ï¼Œç”¨äºè¾“å‡ºæ“ä½œã€‚ contents_buf: ä¸€ä¸ªå‘é‡ï¼Œç”¨æ¥å­˜å‚¨å†…å®¹æ¡ç›®ï¼Œåœ¨å…¨éƒ¨å†™å…¥æ–‡ä»¶ä¹‹å‰æš‚å­˜åœ¨è¿™ä¸ªç¼“å†²åŒºã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬ä¸º IndexFileWriter å®ç°å‡ ä¸ªæ–¹æ³•ï¼š new: è¿™æ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œå®ƒåˆå§‹åŒ–æ–‡ä»¶å¹¶è®¾ç½®åˆå§‹åç§»é‡ã€‚åœ¨æ–‡ä»¶çš„å¼€å§‹å¤„å†™å…¥ä¸€ä¸ªå ä½ç¬¦ä½œä¸ºå¤´éƒ¨ï¼Œè¿™ä¸ªå¤´éƒ¨æœ€ç»ˆä¼šå­˜å‚¨ä¸»æ•°æ®åŒºçš„å¤§å°ã€‚ write_document: ç”¨äºå°†ä¸€ä¸ªæ–‡æ¡£ä»¥äºŒè¿›åˆ¶æ ¼å¼å†™å…¥åˆ°æ–‡ä»¶ä¸­ï¼ŒåŒæ—¶æ›´æ–°åç§»é‡ã€‚ write_main: è¿™ä¸ªæ–¹æ³•æ¥å—ä¸€æ®µæ•°æ®ï¼Œå¹¶å°†å®ƒå†™å…¥æ–‡ä»¶ä¸­ï¼ŒåŒæ—¶æ›´æ–°åç§»é‡ã€‚ write_contents_entry: å°†ä¸€ä¸ªå†…å®¹ Entry è¿½åŠ åˆ°å†…éƒ¨çš„ç¼“å†²åŒºä¸­ã€‚Entry åŒ…æ‹¬ä¸€ä¸ªæœ¯è¯­ã€æ–‡æ¡£é¢‘ç‡ã€æœ¯è¯­æ•°æ®çš„èµ·å§‹åç§»å’Œå¤§å°ï¼Œå®ƒç”¨äºå¿«é€Ÿå®šä½ terms æˆ– docsã€‚ finish: å®Œæˆæ–‡ä»¶å†™å…¥è¿‡ç¨‹ï¼Œå°†å†…éƒ¨ç¼“å†²åŒºçš„å†…å®¹å†™å…¥æ–‡ä»¶ï¼Œå¹¶æ›´æ–°æ–‡ä»¶å¤´éƒ¨çš„ä¸»æ•°æ®å¤§å°ã€‚ new æˆ‘ä»¬å…ˆæ¥çœ‹æ„é€ æ–¹æ³•ï¼š pub fn new(mut f: BufWriterFile) - io::ResultIndexFileWriter const HEADER_SIZE: u64 = 8; f.write_u64::LittleEndian(0)?; // content start Ok(IndexFileWriter offset: HEADER_SIZE, writer: f, contents_buf: vec![], ) new åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š å®šä¹‰å¤´éƒ¨å¤§å°ï¼šconst HEADER_SIZE: u64 = 8;ï¼šå®šä¹‰ä¸€ä¸ªå¸¸é‡ HEADER_SIZEï¼Œå…¶å€¼ä¸º 8 å­—èŠ‚ï¼Œè¿™è¡¨ç¤ºæ–‡ä»¶å¤´éƒ¨çš„å¤§å°ã€‚è¿™ä¸ªå¤´éƒ¨å°†ç”¨äºåç»­åœ¨æ–‡ä»¶çš„å¼€å§‹å¤„å†™å…¥ä¸»æ•°æ®åŒºçš„èµ·å§‹ä½ç½®ã€‚ å†™å…¥å¤´éƒ¨å ä½ç¬¦ï¼šf.write_u64::LittleEndian(0)?;ï¼šåœ¨æ–‡ä»¶çš„å¼€å§‹å¤„å†™å…¥ä¸€ä¸ª 8 å­—èŠ‚çš„å ä½ç¬¦ï¼Œè¿™ä¸ªå€¼æ˜¯ä»¥å°ç«¯å­—èŠ‚åºï¼ˆLittleEndianï¼‰å­˜å‚¨çš„ã€‚åˆå§‹æ—¶è¿™é‡Œå†™å…¥çš„æ˜¯ 0ï¼Œæ„å‘³ç€â€œä¸»æ•°æ®åŒºçš„èµ·å§‹ä½ç½®æœªçŸ¥â€ï¼Œè¿™ä¸ªå€¼åœ¨åç»­çš„ finish å‡½æ•°ä¸­ä¼šè¢«æ›´æ–°ã€‚ è¿”å›ä¸€ä¸ªæ–°çš„ IndexFileWriter å®ä¾‹ï¼šOk(IndexFileWriter offset: HEADER_SIZE, writer: f, contents_buf: vec![], )ï¼šæ„é€ å¹¶è¿”å›ä¸€ä¸ª IndexFileWriter å®ä¾‹ã€‚è¿™ä¸ªå®ä¾‹çš„ offset å­—æ®µè¢«åˆå§‹åŒ–ä¸º HEADER_SIZEï¼ˆ8 å­—èŠ‚ï¼‰ï¼Œè¡¨ç¤ºå®é™…æ•°æ®å°†ä»æ–‡ä»¶çš„ç¬¬ 17 ä¸ªå­—èŠ‚å¼€å§‹å†™å…¥ã€‚writer å­—æ®µå°±æ˜¯ä¼ å…¥çš„æ–‡ä»¶å†™å…¥å™¨ï¼Œcontents_buf æ˜¯ä¸€ä¸ªæ–°çš„ç©ºå‘é‡ï¼Œç”¨äºä¸´æ—¶å­˜å‚¨å†…å®¹æ¡ç›®æ•°æ®ã€‚ ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ è¿™ä¸ªå®ç°æ–¹å¼æœ‰å‡ ä¸ªè®¾è®¡ä¸Šçš„è€ƒè™‘ï¼šé¢„ç•™å¤´éƒ¨ç©ºé—´ï¼šé€šè¿‡åœ¨æ–‡ä»¶å¼€å§‹å¤„é¢„ç•™ 8å­—èŠ‚ç©ºé—´æ¥å­˜å‚¨ä¸»æ•°æ®åŒºçš„å¤§å°ï¼Œè¿™æ ·åšå¯ä»¥åœ¨æ•°æ®å†™å…¥å®Œæˆåï¼Œæ–¹ä¾¿åœ°å›å¡«è¿™ä¸ªä¿¡æ¯ã€‚è¿™æ˜¯æ–‡ä»¶æ ¼å¼è®¾è®¡ä¸­å¸¸è§çš„åšæ³•ï¼Œå…è®¸è¯»å–è€…å¿«é€Ÿå®šä½ä¸»æ•°æ®åŒºå’Œå†…å®¹ç´¢å¼•åŒºã€‚ä½¿ç”¨å°ç«¯å­—èŠ‚åºï¼šå°ç«¯å­—èŠ‚åºæ˜¯ä¸€ç§åœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­å¸¸ç”¨çš„å­—èŠ‚åºï¼Œå°¤å…¶æ˜¯åœ¨Windowså¹³å°ä¸‹ã€‚ä½¿ç”¨å°ç«¯å­—èŠ‚åºå¯ä»¥æé«˜æ–‡ä»¶çš„å…¼å®¹æ€§ï¼Œå¹¶ä¸”å¯¹äºå¤šæ•°å¤„ç†å™¨æ¶æ„æ¥è¯´ï¼Œå°ç«¯å­—èŠ‚åºçš„è¯»å†™æ“ä½œæ›´ä¸ºé«˜æ•ˆã€‚çµæ´»çš„æ•°æ®å†™å…¥ï¼šé€šè¿‡å°† writer å’Œcontents_bufç»„åˆä½¿ç”¨ï¼Œè¿™ä¸ªç»“æ„ä½“å¯ä»¥çµæ´»åœ°å¤„ç†ä¸åŒçš„æ•°æ®å†™å…¥éœ€æ±‚ã€‚writerç›´æ¥å†™å…¥æ–‡ä»¶ï¼Œé€‚åˆè¿ç»­å¤§å—æ•°æ®çš„å†™å…¥ï¼›è€Œ contents_bufç”¨äºèšé›†å¤šä¸ªå°ç‰‡æ®µçš„æ•°æ®ï¼Œå¯ä»¥åœ¨æœ€åç»Ÿä¸€å†™å…¥ï¼Œå‡å°‘ç£ç›˜æ“ä½œæ¬¡æ•°ã€‚æ€»çš„æ¥è¯´ï¼Œè¿™ä¸ªæ„é€ å‡½æ•°çš„å®ç°ä¸ºé«˜æ•ˆå’Œçµæ´»çš„æ–‡ä»¶å†™æ“ä½œæä¾›äº†è‰¯å¥½çš„åŸºç¡€ï¼ŒåŒæ—¶é€šè¿‡åˆç†çš„é”™è¯¯å¤„ç†å’Œæ•°æ®ç»„ç»‡æ–¹å¼ï¼Œç¡®ä¿äº†ç¨‹åºçš„å¥å£®æ€§å’Œé«˜æ€§èƒ½ã€‚ write_main Hit æœ¬èº«å°±æ˜¯ä¸€ä¸ª Vecu8ï¼Œ å°†å…¶å†™å…¥æ–‡ä»¶å¾ˆç®€å•ï¼Œè°ƒç”¨ write_allï¼Œå³å¯ï¼Œæˆ‘ä»¬ä¸ºå…¶å°è£… write_main æ–¹æ³•ï¼š pub fn write_main(mut self, buf: [u8]) - io::Result() self.writer.write_all(buf)?; self.offset += buf.len() as u64; Ok(()) write_document ä¸ºäº†å°† Docuemnt æœ¬ä»¥äºŒè¿›åˆ¶ç»“æ„å†™å…¥åˆ°æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ‹†åˆ†æˆå‡ ä¸ªéƒ¨åˆ†ï¼š æ–‡ä»¶ id æ–‡ä»¶è·¯å¾„å¤§å° æ–‡ä»¶è·¯å¾„ ä¸ºæ­¤æˆ‘ä»¬ä¸º IndexFileWriter å°è£…äº† write_documentï¼š pub fn write_document(mut self, doc: Document) - io::Result() self.writer.write_u32::LittleEndian(doc.id)?; self.writer .write_u64::LittleEndian(doc.path.as_os_str().len() as u64)?; self.writer.write_all(doc.path.as_os_str().as_bytes())?; self.offset += 4 + 8 + doc.path.as_os_str().len() as u64; Ok(()) write_contents_entry Entry çš„æ•°æ®é‡ä¸€èˆ¬è¾ƒå°ï¼Œæˆ‘ä»¬ä¼šå…ˆå†™å…¥ç¼“å†²ä¸­ï¼Œåé¢å†ä¸€æ¬¡æ€§åˆ·ç›˜ï¼Œä¸ºæ­¤æˆ‘ä»¬ä¸º IndexFileWriter å°è£…äº† write_contents_entryï¼š /// Appends a content entry to the internal buffer.////// # Arguments/// * `term` - The term associated with the entry/// * `df` - Document frequency for the term/// * `offset` - Offset where the term data starts in the file/// * `nbytes` - Number of bytes of the term datapub fn write_contents_entry(mut self, term: String, df: u32, offset: u64, nbytes: u64) self.contents_buf.write_u64::LittleEndian(offset).unwrap(); self.contents_buf.write_u64::LittleEndian(nbytes).unwrap(); self.contents_buf.write_u32::LittleEndian(df).unwrap(); let bytes = term.bytes(); self.contents_buf .write_u32::LittleEndian(bytes.len() as u32) .unwrap(); self.contents_buf.extend(bytes); finish åˆ·ç›˜çš„è¿‡ç¨‹æˆ‘ä»¬å°è£…åœ¨ finish ä¸­ï¼š pub fn finish(mut self) - io::Result() let contents_start = self.offset; self.writer.write_all(self.contents_buf)?; self.writer.seek(SeekFrom::Start(0))?; self.writer.write_u64::LittleEndian(contents_start)?; Ok(()) write_index_to_tmp_file ç»¼åˆä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®ç°æœ€æ ¸å¿ƒçš„å‡½æ•° write_index_to_tmp_file äº†ï¼š pub fn write_index_to_tmp_file(index: InMemoryIndex, tmp_dir: mut TmpDir) - io::ResultPathBuf let (filename, f) = tmp_dir.create()?; let mut writer = IndexFileWriter::new(f)?; let mut index_as_vec: Vec_ = index.terms.into_iter().collect(); index_as_vec.sort_by(|(a, _), (b, _)| a.cmp(b)); for (term, hits) in index_as_vec let df = hits.len() as u32; let start = writer.offset; for buffer in hits writer.write_main(buffer)?; let stop = writer.offset; writer.write_contents_entry(term, df, start, stop - start); // if term == df == 0 type = document for (_, doc) in index.docs let start = writer.offset; writer.write_document(doc)?; let stop = writer.offset; writer.write_contents_entry(.to_string(), 0, start, stop - start) writer.finish()?; println!(wrote file :?, filename); Ok(filename) æˆ‘ä»¬åœ¨ä¸´æ—¶ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ï¼Œå¹¶åˆå§‹åŒ– IndexFileWriterï¼› å°†ç´¢å¼•çš„ terms è½¬æ¢æˆä¸€ä¸ªå‘é‡å¹¶æŒ‰ç…§é”®æ’åºï¼› å¯¹äºæ¯ä¸ª termï¼Œè®¡ç®—æ–‡æ¡£é¢‘ç‡ï¼ˆdfï¼‰ï¼Œè®°å½•å¼€å§‹å’Œç»“æŸä½ç½®ï¼Œç„¶åè°ƒç”¨ write_main æ–¹æ³•å°†æ•°æ®å†™å…¥æ–‡ä»¶ï¼Œç„¶åä½¿ç”¨ write_contents_entry æ–¹æ³•å†™å…¥ Entry çš„å…ƒæ•°æ®åˆ°ç›®å½•è¡¨ï¼› å¯¹äº index.docs ä¸­çš„æ¯ä¸ªæ–‡æ¡£ï¼Œè®¡ç®—èµ·æ­¢ä½ç½®ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ªç‰¹æ®Šçš„æ¡ç›®ï¼ˆç©ºå­—ç¬¦ä¸²ä½œä¸ºæ¡ç›®åå’Œ 0 ä½œä¸ºæ–‡æ¡£é¢‘ç‡ï¼‰æ ‡è®°åœ¨æ–‡ä»¶ä¸­ï¼› æœ€åæˆ‘ä»¬ä½¿ç”¨ finish å°†ç¼“å­˜ä¸­æ‰€æœ‰çš„ Entry åˆ·ç›˜ï¼Œå¹¶è®¾ç½® entries çš„èµ·å§‹ä½ç½®ã€‚ æ–‡ä»¶çš„å†…å­˜ç»“æ„å¦‚ä¸Šé¢ç»™å‡ºçš„å›¾ä¸€æ ·ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥å†çœ‹ä¸€æ¬¡ï¼š ç´¢å¼•æ–‡ä»¶å†…å­˜ç»“æ„ç¤ºæ„å›¾ step4: start_index_writer_thread å®ç°äº†å°†å†…å­˜ç´¢å¼•å†™å…¥åˆ°æ–‡ä»¶çš„åŠŸèƒ½åï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»§ç»­åœ¨ create.rs ä¸­å®ç°ä¸‹ä¸€ä¸ªæµç¨‹äº†ï¼š fn start_index_writer_thread( big_indexes: ReceiverInMemoryIndex, output_dir: Path,) - (ReceiverPathBuf, JoinHandleio::Result()) let (sender, receiver) = channel(); let mut tmp_dir = TmpDir::new(output_dir); let handle = spawn(move || for i in big_indexes println!(word count: , i.word_count); let file = write_index_to_tmp_file(i, mut tmp_dir)?; if sender.send(file).is_err() break; Ok(()) ); (receiver, handle) åœ¨ start_index_writer_thread æµç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†æ„å»ºå¥½çš„å†…å­˜ç´¢å¼•ä¸€ä¸ªä¸ªå†™å…¥åˆ°æ–‡ä»¶ä¸­ï¼Œå¹¶å°†ç”Ÿæˆçš„æ–‡ä»¶å¥æŸ„ä¼ å…¥ä¸‹ä¸€ä¸ªæµç¨‹ã€‚ merge.rs å®Œæ•´æºç ï¼šmerge.rs å‰é¢ start_index_writer_thread æ˜¯å°†ä¸€ä¸ªä¸ª InMemoryIndex å†™å…¥åˆ° TmpDir ä¸´æ—¶ç›®å½•ä¸­ã€‚ç°åœ¨æˆ‘ä»¬è¦å°†è¿™äº›ä¸´æ—¶æ–‡ä»¶åˆå¹¶æˆä¸€ä¸ªæœ€ç»ˆçš„ç´¢å¼•æ–‡ä»¶ï¼Œä»¥ä¼˜åŒ–æŸ¥è¯¢æ•ˆç‡å’ŒèŠ‚çœå­˜å‚¨ç©ºé—´ã€‚ srtuct: FileMerge æˆ‘ä»¬å®šä¹‰ä¸€ä¸‹ç»“æ„ï¼š pub struct FileMerge output_dir: PathBuf, tmp_dir: TmpDir, stacks: VecVecPathBuf, output_dir: ç”¨äºå­˜å‚¨æœ€ç»ˆåˆå¹¶æ–‡ä»¶çš„è¾“å‡ºç›®å½•ã€‚ tmp_dir: å‰é¢ tmp.rs å®šä¹‰çš„ç»“æ„ï¼Œç”¨äºç®¡ç†åˆå¹¶è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸´æ—¶æ–‡ä»¶ã€‚ stacks: è¿™æ˜¯ä¸€ä¸ªäºŒç»´å‘é‡ï¼Œæ¯ä¸ªå†…éƒ¨å‘é‡ä»£è¡¨ä¸€ä¸ªåˆå¹¶â€œå±‚â€ï¼Œå­˜å‚¨äº†è¯¥å±‚å¾…åˆå¹¶çš„æ–‡ä»¶è·¯å¾„ã€‚ å…³äº stacksï¼Œå†å¤šè¯´ä¸¤ç‚¹ï¼š å¤šçº§åˆå¹¶ç­–ç•¥: FileMerge ä½¿ç”¨ä¸€ä¸ªå¤šå±‚åˆå¹¶ç­–ç•¥ï¼Œè¿™ç§ç­–ç•¥åœ¨å¤„ç†å¤§é‡æ–‡ä»¶æ—¶å°¤ä¸ºæœ‰æ•ˆã€‚åŸºæœ¬æ€æƒ³æ˜¯ï¼Œå½“ä¸€å±‚çš„æ–‡ä»¶æ•°é‡è¾¾åˆ°ä¸€ä¸ªé¢„è®¾çš„é˜ˆå€¼ï¼ˆNSTREAMSï¼‰æ—¶ï¼Œè¿™äº›æ–‡ä»¶ä¼šè¢«åˆå¹¶æˆä¸€ä¸ªæ–°çš„æ–‡ä»¶ï¼Œæ–°æ–‡ä»¶åˆ™è¢«æ¨é€åˆ°ä¸Šä¸€å±‚ã€‚è¿™ç§å±‚çº§å¼çš„å¤„ç†æ–¹å¼å¯ä»¥æ˜¾è‘—å‡å°‘æœ€ç»ˆåˆå¹¶æ­¥éª¤éœ€è¦å¤„ç†çš„æ–‡ä»¶æ•°é‡ï¼Œä»è€Œä¼˜åŒ–æ€§èƒ½ã€‚ åŠ¨æ€æ‰©å±•ï¼šä½¿ç”¨ VecVecPathBuf å…è®¸åŠ¨æ€åœ°æ·»åŠ æ–°çš„åˆå¹¶å±‚ï¼Œè¿™åœ¨å¤„ç†ä¸ç¡®å®šæ•°é‡çš„æ–‡ä»¶æ—¶éå¸¸æœ‰ç”¨ã€‚å‘é‡çš„çµæ´»æ€§æ„å‘³ç€æ— éœ€é¢„å…ˆçŸ¥é“å°†å¤„ç†å¤šå°‘æ–‡ä»¶ï¼Œå®ƒå¯ä»¥æ ¹æ®å®é™…éœ€è¦è¿›è¡Œæ‰©å±•ã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šä¸º FileMerge å®ç° 2 ä¸ªæ–¹æ³•ï¼š add_file: æ·»åŠ ä¸€ä¸ªæ–‡ä»¶åˆ°åˆå¹¶æ ˆä¸­ï¼Œå¹¶ä½¿ç”¨å¤šçº§åˆå¹¶ç­–ç•¥è¿›è¡Œåˆå¹¶ã€‚ finish: æ‰§è¡Œæœ€åçš„åˆå¹¶æ“ä½œï¼Œç”Ÿæˆæœ€ç»ˆçš„ç´¢å¼•æ–‡ä»¶ï¼Œè¾“å‡ºåˆ° output_dir ä¸­ã€‚ add_file é¦–å…ˆæˆ‘ä»¬æ¥çœ‹add_fileï¼Œå®ƒçš„å®ç°å¦‚ä¸‹ï¼š pub fn add_file(mut self, mut file: PathBuf) - io::Result() // ä»ç¬¬ä¸€å±‚å¼€å§‹æ£€æŸ¥ let mut level = 0; // ä½¿ç”¨å¾ªç¯æ¥å¤„ç†æ–‡ä»¶çš„æ·»åŠ å’Œå¯èƒ½çš„åˆå¹¶ã€‚ loop // å¦‚æœå½“å‰çš„ level ï¼ˆå±‚çº§ï¼‰ä¸å­˜åœ¨äº stacks ä¸­ï¼Œ // å°±åœ¨ stacks ä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„ç©ºå‘é‡ã€‚ // è¿™æ˜¯ä¸ºäº†å­˜æ”¾è¯¥å±‚çº§çš„æ–‡ä»¶ã€‚ if level == self.stacks.len() self.stacks.push(vec![]); // å°†å½“å‰çš„æ–‡ä»¶æ·»åŠ åˆ°å¯¹åº”å±‚çº§çš„å‘é‡ä¸­ã€‚ self.stacks[level].push(file); // å¦‚æœè¿™ä¸ªçº§åˆ«çš„å †æ ˆå·²æ»¡ï¼Œå°±åˆå¹¶è¿™ä¸ªçº§åˆ«çš„æ–‡ä»¶ã€‚ // å¦‚æœæ²¡æ»¡ï¼Œåˆ™ä¸è¿›è¡Œåˆå¹¶ï¼Œç›´æ¥é€€å‡ºã€‚ if self.stacks[level].len() NSTREAMS break; // åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶æ¥å­˜å‚¨åˆå¹¶ç»“æœï¼Œå¹¶æ›´æ–°å †æ ˆã€‚ let (filename, out) = self.tmp_dir.create()?; // åˆå§‹åŒ–ä¸€ä¸ªç©ºçš„ to_merge å‘é‡ï¼Œ // ç„¶åä½¿ç”¨ mem::swap äº¤æ¢å½“å‰å±‚çº§çš„æ–‡ä»¶åˆ—è¡¨å’Œè¿™ä¸ªç©ºå‘é‡ï¼Œ // è¿™æ · to_merge å‘é‡å°±åŒ…å«äº†éœ€è¦åˆå¹¶çš„æ–‡ä»¶ï¼Œ // è€Œå½“å‰å±‚çº§å˜ä¸ºç©ºï¼Œå¯ä»¥ç”¨æ¥å­˜æ”¾æ–°çš„åˆå¹¶æ–‡ä»¶ã€‚ let mut to_merge = vec![]; mem::swap(mut self.stacks[level], mut to_merge); // è°ƒç”¨ merge_streams å‡½æ•°å°† to_merge ä¸­çš„æ–‡ä»¶åˆå¹¶åˆ°æ–°åˆ›å»ºçš„æ–‡ä»¶ä¸­ã€‚ merge_streams(to_merge, out)?; // å°†åˆå¹¶åå¾—åˆ°çš„æ–°æ–‡ä»¶è·¯å¾„èµ‹å€¼ç»™ file å˜é‡ï¼Œç”¨äºä¸‹ä¸€è½®å¾ªç¯ã€‚ file = filename; // level åŠ ä¸€ï¼Œè¡¨ç¤ºç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå±‚çº§ã€‚ level += 1; Ok(()) è¿™ä¸ªæ–¹æ³•é€šè¿‡å±‚çº§çš„æ–¹å¼ç®¡ç†æ–‡ä»¶åˆå¹¶ï¼Œæ¯ä¸ªå±‚çº§å¯ä»¥æœ‰å¤šä¸ªæ–‡ä»¶ï¼Œä½†æ•°é‡ä¸Šé™ä¸º NSTREAMSã€‚å¦‚æœæŸå±‚æ»¡äº†ï¼Œå°±å°†è¯¥å±‚çš„æ–‡ä»¶åˆå¹¶æˆä¸€ä¸ªæ–°æ–‡ä»¶ï¼Œå¹¶å°†è¿™ä¸ªæ–°æ–‡ä»¶ç§»åŠ¨åˆ°ä¸Šä¸€å±‚ç»§ç»­å‚ä¸åˆå¹¶ã€‚è¿™ç§è®¾è®¡æœ‰æ•ˆåœ°å°†å¤šä¸ªæ–‡ä»¶é€æ­¥åˆå¹¶æˆä¸€ä¸ªæ–‡ä»¶ï¼ŒåŒæ—¶æ§åˆ¶å†…å­˜å’Œ I/O èµ„æºçš„ä½¿ç”¨ã€‚ å…¶ä¸­ merge_streams å°±æ˜¯å…·ä½“çš„åˆå¹¶è¿‡ç¨‹ï¼Œå®ƒçš„å®ç°å¦‚ä¸‹ï¼š fn merge_streams(files: VecPathBuf, out: BufWriterFile) - io::Result() // ä»ç´¢å¼•æ–‡ä»¶ä¸­æ„å»º IndexFileReader åˆ—è¡¨ let mut streams: VecIndexFileReader = files .into_iter() .map(|p| IndexFileReader::open_and_delete(p, true)) .collect::io::Result_()?; // é’ˆå¯¹è¾“å‡ºæ–‡ä»¶ç”Ÿæˆä¸€ä¸ª IndexFileWriter ç”¨äºå†™å…¥ç´¢å¼•ä¿¡æ¯ let mut output = IndexFileWriter::new(out)?; // ç”¨äºè®°å½•å½“å‰å†™å…¥çš„ä½ç½®ï¼ˆæˆ–è€…æ•°æ®åç§»é‡ï¼‰ã€‚ let mut point: u64 = 0; // è®°å½•è¿˜æœ‰æ•°æ®æœªå¤„ç†çš„æ–‡ä»¶æµæ•°é‡ï¼Œç”¨ peek() æ–¹æ³•æ£€æŸ¥ã€‚ let mut count = streams.iter().filter(|s| s.peek().is_some()).count(); // åªè¦ count å¤§äº0ï¼Œè¡¨ç¤ºè¿˜æœ‰æ–‡ä»¶æœªå®Œå…¨å¤„ç†ï¼Œå°±ç»§ç»­å¾ªç¯ã€‚ while count 0 let mut term = None; let mut nbytes = 0; let mut df = 0; // è¿™æ®µä»£ç é€šè¿‡éå†æ¯ä¸ªæ–‡ä»¶æµï¼Œä½¿ç”¨ peek() æ–¹æ³•é¢„è§ˆæ¯ä¸ªæ–‡ä»¶çš„å½“å‰æ•°æ®æ¡ç›® for s in streams match s.peek() None = Some(entry) = // term æ˜¯ç©ºçš„ï¼Œåˆ™è¯´æ˜è¿™æ˜¯è¡¨ç¤º doc çš„ entryã€‚ // ç›´æ¥é€€å‡º for å¾ªç¯ï¼Œå› ä¸º doc çš„ entry æ²¡æœ‰é¡ºåºä¸”å”¯ä¸€ï¼Œä¸ä¼šè¿›è¡Œç´¯åŠ ã€‚ if entry.term.is_empty() term = Some(entry.term.clone()); nbytes = entry.nbytes; df = entry.df; break; // term ä¸æ˜¯ç©ºçš„ï¼Œåˆ™è¯´æ˜è¿™æ˜¯è¡¨ç¤º terms çš„ entryã€‚ // é€‰æ‹©è¯æ¡æœ€å°çš„ä¸€ä¸ªï¼ˆå­—å…¸åºï¼‰ï¼Œå¹¶ä¸”ç´¯åŠ å…¶å‡ºç°çš„é¢‘æ¬¡å’Œå­—èŠ‚å¤§å°ã€‚ // è¿™æ˜¯å¤šè·¯å½’å¹¶çš„æ ¸å¿ƒï¼Œç¡®ä¿è¾“å‡ºæ–‡ä»¶æ˜¯æœ‰åºçš„ã€‚ if term.is_none() || entry.term *term.as_ref().unwrap() term = Some(entry.term.clone()); nbytes = entry.nbytes; df = entry.df else if entry.term == *term.as_ref().unwrap() nbytes += entry.nbytes; df += entry.df let term = term.expect(bug in algorithm); // å¯¹äºæ¯ä¸ªæ–‡ä»¶æµï¼Œå¦‚æœå½“å‰æ•°æ®æ¡ç›®ä¸é€‰æ‹©çš„ term ç›¸åŒï¼Œ // åˆ™å°†è¯¥æ¡ç›®å†™å…¥è¾“å‡ºæ–‡ä»¶ï¼Œå¹¶æ›´æ–°è¯¥æµçš„è¯»å–ä½ç½®ã€‚ for s in mut streams if s.is_at(term) s.move_entry_to(mut output)?; if s.peek().is_none() count -= 1; if term.is_empty() break; output.write_contents_entry(term, df, point, nbytes); point += nbytes Ok(()) è¿™é‡Œæ¶‰åŠåˆ°äº†ä¸€ä¸ªæ–°çš„ç»“æ„ IndexFileReaderï¼Œå®ƒæ˜¯ç´¢å¼•æ–‡ä»¶çš„è¯»å–å™¨ï¼Œæˆ‘ä»¬å°†åœ¨ read.rs ä¸­å®ç°å®ƒã€‚è¿™é‡Œå…ˆä¸å±•å¼€ï¼Œä½ åªéœ€è¦çŸ¥é“ï¼š IndexFileReader::open_and_delete(p, true): æ‰“å¼€ä¸€ä¸ªç´¢å¼•æ–‡ä»¶ï¼Œå¹¶æ ¹æ®ä¼ å…¥çš„å‚æ•°åˆ¤æ–­æ˜¯å¦è¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶ï¼Œåœ¨åˆå¹¶è¿‡ç¨‹ä¸­ï¼Œå› ä¸ºéƒ½æ˜¯ä¸´æ—¶æ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šæŒ‡å®šä¸ºåˆ é™¤æ–‡ä»¶ã€‚ä½†æ˜¯åœ¨åé¢ä»ç´¢å¼•æ–‡ä»¶ä¸­é‡å»º InMemoryIndex çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›åˆ é™¤åŸå§‹çš„ç´¢å¼•æ–‡ä»¶ã€‚ s.peek(): æŸ¥çœ‹ä¸‹ä¸€ä¸ª Entryï¼Œå®ƒçš„è¿”å›å€¼æ˜¯ OptionEntryã€‚ s.move_entry_to(mut output): å°† s.peek() æŒ‡å‘çš„ Entry å†™å…¥åˆ° output æ–‡ä»¶ä¸­ï¼Œå¹¶ç§»åŠ¨åˆ°ä¸€ä¸‹ Entryã€‚ æ€»ç»“ä¸‹æ¥ï¼Œè¿™ä¸ªå‡½æ•°å®ç°å¤šè·¯å½’å¹¶çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œå®ƒå°†å¤šä¸ªç´¢å¼•æ–‡ä»¶åˆå¹¶æˆä¸€ä¸ªå•ä¸€çš„æœ‰åºæ–‡ä»¶ã€‚ finish æˆ‘ä»¬å†æ¥çœ‹ FileMerge çš„å¦å¤–ä¸€ä¸ªæ–¹æ³• finishï¼š pub fn finish(mut self) - io::Result() // åˆå§‹åŒ–ä¸€ä¸ªä¸´æ—¶å‘é‡ tmpï¼Œç”¨æ¥æš‚å­˜éœ€è¦åˆå¹¶çš„æ–‡ä»¶è·¯å¾„ã€‚ // è¿™ä¸ªå‘é‡çš„å®¹é‡è®¾ç½®ä¸º NSTREAMSï¼Œè¿™æ˜¯é¢„å…ˆå®šä¹‰çš„å¸¸é‡ï¼Œè¡¨ç¤ºä¸€æ¬¡å¯ä»¥åˆå¹¶çš„æœ€å¤§æ–‡ä»¶æ•°ã€‚ let mut tmp = Vec::with_capacity(NSTREAMS); // æ–¹æ³•éå† self.stacks ä¸­çš„æ¯ä¸ªå †æ ˆã€‚æ¯ä¸ªå †æ ˆä»£è¡¨ä¸€ä¸ªåˆå¹¶å±‚çº§ï¼ŒåŒ…å«è‹¥å¹²å¾…åˆå¹¶çš„æ–‡ä»¶ã€‚ for stack in self.stacks // å¯¹äºæ¯ä¸ªå †æ ˆï¼Œæ–¹æ³•ä½¿ç”¨ .into_iter().rev() è¿­ä»£å™¨åå‘éå†æ–‡ä»¶ï¼Œ // ä»¥ç¡®ä¿æŒ‰æ­£ç¡®çš„é¡ºåºå¤„ç†ï¼ˆå…ˆè¿›åå‡ºï¼‰ã€‚ for file in stack.into_iter().rev() // å°†æ–‡ä»¶é€ä¸ªæ·»åŠ åˆ° tmp å‘é‡ä¸­ã€‚ tmp.push(file); // å½“ tmp çš„é•¿åº¦è¾¾åˆ° NSTREAMS æ—¶ï¼Œ // è°ƒç”¨ merge_reversed å‡½æ•°è¿›è¡Œåˆå¹¶ã€‚ if tmp.len() == NSTREAMS merge_reversed(mut tmp, mut self.tmp_dir)?; // å¯¹äºå‰©ä½™æ–‡ä»¶è¿›è¡Œæœ€ç»ˆçš„åˆå¹¶ã€‚ if tmp.len() 1 merge_reversed(mut tmp, mut self.tmp_dir)?; // æœ€ååº”è¯¥åªæœ‰ä¸€ä¸ªæœ€ç»ˆæ–‡ä»¶ assert!(tmp.len() == 1); match tmp.pop() // å¯¹æ–‡ä»¶è¿›è¡Œé‡å‘½å Some(last_file) = fs::rename(last_file, self.output_dir.join(MERGED_FILENAME)), None = Err(io::Error::new( io::ErrorKind::Other, no ducuments were parsed or none contained any words, )), è¿™é‡Œæ¶‰åŠåˆ°äº†å¦å¤–ä¸€ä¸ªå‡½æ•° merge_reversedï¼š fn merge_reversed(filenames: mut VecPathBuf, tmp_dir: mut TmpDir) - io::Result() filenames.reverse(); let (merge_filename, out) = tmp_dir.create()?; let mut to_merge = Vec::with_capacity(NSTREAMS); mem::swap(filenames, mut to_merge); merge_streams(to_merge, out)?; filenames.push(merge_filename); Ok(()) å®ƒå…¶å®å°±æ˜¯å°† filenames ç¿»è½¬ï¼Œæ¸…ç©ºå¹¶å°†å†…å®¹è½¬ç§»åˆ° to_mergeï¼Œç„¶åè°ƒç”¨ merge_streams åˆå¹¶ï¼Œå¹¶å°†åˆå¹¶åçš„æ–‡ä»¶é‡æ–°æ”¾å›è¢«æ¸…ç©ºçš„ filenamesï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨ finish ä¸­å£°æ˜çš„ tmp å˜é‡ã€‚ ä¸ºä»€ä¹ˆè¿™é‡Œéœ€è¦ç¿»è½¬ filenamesï¼Ÿ å‡è®¾ NSTREAMS = 3ï¼Œæˆ‘ä»¬æ‰§è¡Œ add_fileï¼Œä»file1 åˆ° file8ï¼Œé‚£ä¹ˆè¿‡ç¨‹å¦‚ä¸‹ï¼šActionStack 0Stack 1NotesAdd file1file1Add file2file1, file2Add file3file1, file2, file3Merge S1(empty)merge1merge1 is the result of merging file1-file3Add file4file4merge1Add file5file4, file5merge1Add file6file4, file5, file6merge1Merge S2(empty)merge1, merge2merge2 is the result of merging file4-file6Add file7file7merge1, merge2Add file8file7, file8merge1, merge2Trigger merge because 8 files are reachedæœ€åæˆ‘ä»¬è·å¾—çš„ç»“æœæ˜¯ï¼šstack0stack1file7, file8merge1, merge2æŒ‰ç…§æ–‡ä»¶çš„æ·»åŠ é¡ºåºï¼Œæˆ‘ä»¬æœŸæœ›åœ¨ finishä¸­åˆå¹¶çš„é¡ºåºåº”è¯¥æ˜¯ï¼šmerge1, merge2, file7, file8ã€‚æ‰€ä»¥æˆ‘ä»¬éå†stacks çš„æ—¶å€™ï¼Œä»ç¬¬ 1 å±‚å¼€å§‹éå†çš„è¯ï¼Œæˆ‘ä»¬å°±éœ€è¦åå‘éå†rev()ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬ç»„æˆçš„ tmp å°±æ˜¯ï¼šfile8,file7, merge2, merge1ã€‚æœ€åæˆ‘ä»¬ä¼ å…¥ merge_reversedçš„æ—¶å€™ï¼Œå†è¿›è¡Œ reverse()ï¼Œå°±å¯ä»¥è·å¾—æˆ‘ä»¬æœŸæœ›çš„é¡ºåº merge1,merge2, file7, file8ã€‚ å›è¿‡å¤´æ¥ï¼Œæˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ finishï¼šè¿™ä¸ªæ–¹æ³•é€šè¿‡å¤šçº§åˆå¹¶çš„æ–¹å¼ï¼Œé€å±‚å¤„ç†å¹¶æœ€ç»ˆåˆå¹¶æ‰€æœ‰æ–‡ä»¶åˆ°ä¸€ä¸ªæ–‡ä»¶ã€‚è¿™ä¸ªæ–¹æ³•ç¡®ä¿åœ¨å¤šä¸ªæ–‡ä»¶é¢‘ç¹åˆå¹¶çš„ç¯å¢ƒä¸­ï¼Œèƒ½æœ‰æ•ˆåœ°ç®¡ç†å’Œå‡å°‘ä¸´æ—¶å­˜å‚¨ä½¿ç”¨ï¼Œå¹¶ä¿æŒåˆå¹¶æ“ä½œçš„æ•ˆç‡ã€‚é€šè¿‡æœ€åçš„é‡å‘½åæ“ä½œï¼Œå®ƒè¿˜å¤„ç†äº†æ–‡ä»¶çš„æœ€ç»ˆå­˜æ”¾ï¼Œç¡®ä¿åˆå¹¶ç»“æœçš„æ­£ç¡®æ€§å’Œå¯ç”¨æ€§ã€‚ å®ç°äº† merge.rs çš„ç›¸å…³å†…å®¹ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¥å®ç° create.rs ä¸­çš„æœ€åä¸€æ­¥äº†ã€‚ step5: merge_index_files æˆ‘ä»¬å°†ç¬¬ 4 é˜¶æ®µæ„å»ºçš„ä¸´æ—¶æ–‡ä»¶åˆå¹¶æˆä¸€ä¸ªæœ€ç»ˆçš„ç´¢å¼•æ–‡ä»¶å¹¶è¾“å‡ºåˆ° output_dir ç›®å½•ä¸­ã€‚ fn merge_index_files(files: ReceiverPathBuf, output_dir: Path) - io::Result() let mut merge = FileMerge::new(output_dir); for file in files merge.add_file(file)?; merge.finish() run_pipeline è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†å¹¶å‘æ„å»ºå€’æ’ç´¢å¼•çš„ 5 ä¸ªæ­¥éª¤äº†ï¼Œå¯¹å…¶è¿›è¡Œç»„ç»‡ï¼Œå°±å¯ä»¥å®ç°æˆ‘ä»¬çš„å¹¶å‘æ„å»ºå‡½æ•° run_pipelineï¼š fn run_pipeline(documents: VecPathBuf, output_dir: PathBuf) - io::Result() // Launch all five stages of the pipeline. let (texts, h1) = start_file_reader_thread(documents); let (pints, h2) = start_file_indexing_thread(texts); let (gallons, h3) = start_in_memory_merge_thread(pints); let (files, h4) = start_index_writer_thread(gallons, output_dir); let result = merge_index_files(files, output_dir); // Wait for threads to finish, holding on to any errors that they encounter. let r1 = h1.join().unwrap(); h2.join().unwrap(); h3.join().unwrap(); let r4 = h4.join().unwrap(); // Return the first error encountered, if any. // (As it happens, h2 and h3 cant fail: those threads // are pure in-memory data processing.) r1?; r4?; result read.rs å®Œæ•´æºç ï¼šread.rs åœ¨ merge.rs ä¸­ï¼Œæˆ‘ä»¬è¿˜å‰©æœ€åä¸€ä¸ªç»“æ„æ²¡æœ‰è§£æï¼Œé‚£å°±æ˜¯ IndexFileReaderï¼Œå®ƒæ˜¯ç´¢å¼•æ–‡ä»¶çš„è¯»å–å™¨ã€‚ struct: IndexFileReader pub struct IndexFileReader pub terms_docs: BufReaderFile, entries: BufReaderFile, next: OptionEntry,pub struct Entry pub term: String, pub df: u32, pub offset: u64, pub nbytes: u64, æˆ‘ä»¬åœ¨ IndexFileReader ç»“æ„ä½“ä¸­å®šä¹‰ä¸¤ä¸ª BufReaderFile ï¼Œè¿™æ˜¯ä¸ºäº†æœ‰æ•ˆç®¡ç†å’Œæ“ä½œç´¢å¼•æ–‡ä»¶ä¸­çš„ä¸åŒæ•°æ®æ®µã€‚å…·ä½“æ¥è¯´ï¼Œè¿™ç§è®¾è®¡ä½¿å¾—ä»£ç èƒ½å¤Ÿæ›´åŠ çµæ´»å’Œé«˜æ•ˆåœ°å¤„ç†ç´¢å¼•æ–‡ä»¶ä¸­çš„â€œä¸»æ•°æ®åŒºâ€å’Œâ€œå†…å®¹è¡¨åŒºâ€ã€‚ å³ç”¨æ¥åˆ†åˆ«å¤„ç†ä¸‹å›¾çš„ termsdoc å’Œ entries ä¸¤ä¸ªåŒºåŸŸï¼š ç´¢å¼•æ–‡ä»¶å†…å­˜ç»“æ„ç¤ºæ„å›¾ è¿™æœ‰å‡ ä¸ªå¥½å¤„ï¼š ç‹¬ç«‹çš„æ–‡ä»¶æŒ‡é’ˆï¼šæ¯ä¸ª BufReaderFile ç»´æŠ¤è‡ªå·±çš„æ–‡ä»¶è¯»å–ä½ç½®ï¼ˆæ–‡ä»¶æŒ‡é’ˆï¼‰ã€‚è¿™æ„å‘³ç€è¯»å–æˆ–æœç´¢å†…å®¹è¡¨æ—¶ï¼Œä¸ä¼šå½±å“ä¸»æ•°æ®åŒºçš„æ–‡ä»¶æŒ‡é’ˆï¼Œåä¹‹äº¦ç„¶ã€‚è¿™æ ·å¯ä»¥é¿å…é¢‘ç¹åœ°é‡æ–°å®šä½æ–‡ä»¶æŒ‡é’ˆï¼Œæé«˜æ–‡ä»¶æ“ä½œçš„æ•ˆç‡ã€‚ ç¼“å†²è¯»å–ï¼šBufReader æä¾›äº†ç¼“å†²è¯»å–åŠŸèƒ½ï¼Œå¯ä»¥å‡å°‘ç›´æ¥å¯¹ç¡¬ç›˜çš„è¯»å–æ¬¡æ•°ï¼Œä»è€Œä¼˜åŒ–è¯»å–æ€§èƒ½ã€‚å¯¹äºéœ€è¦é¢‘ç¹è¯»å–å°å—æ•°æ®çš„ç´¢å¼•æ“ä½œï¼Œä½¿ç”¨ç¼“å†²è¯»å–å¯ä»¥æ˜¾è‘—æé«˜æ•ˆç‡ã€‚ å¹¶è¡Œæ“ä½œï¼šåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œå¯èƒ½éœ€è¦åŒæ—¶è¯»å–ä¸»æ•°æ®åŒºå’Œå†…å®¹è¡¨åŒºã€‚ä½¿ç”¨ä¸¤ä¸ªç‹¬ç«‹çš„ BufReader å®ä¾‹å¯ä»¥ç®€åŒ–å¹¶è¡Œè¯»å–çš„ç®¡ç†ï¼Œæ¯ä¸ªè¯»å–æ“ä½œéƒ½å¯ä»¥åœ¨ä¸å¹²æ‰°å¦ä¸€ä¸ªæ“ä½œçš„æƒ…å†µä¸‹ç‹¬ç«‹è¿›è¡Œã€‚ Entry å°±æ˜¯æˆ‘ä»¬åœ¨ write.rs ä¸­ write_contents_entry æ—¶ä¼ å…¥çš„å‚æ•°ï¼Œè¿™é‡Œæˆ‘ä»¬å°†å…¶å°è£…æˆä¸€ä¸ª structï¼Œå†æ¬¡å›é¡¾ä¸‹è¿™å‡ ä¸ªå­—æ®µçš„å«ä¹‰ï¼š term: ç´¢å¼•å•è¯ã€‚ä¸ºäº†ç»Ÿä¸€ï¼Œå¦‚æœ term ä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºå½“å‰è¡¨ç¤ºçš„æ˜¯ docï¼Œå¦åˆ™ä¸º termsã€‚ df: term çš„å‡ºç°æ¬¡æ•°ã€‚ä¸ºäº†ç»Ÿä¸€ï¼Œå¦‚æœ df ä¸º 0ï¼Œåˆ™è¡¨ç¤ºå½“å‰è¡¨ç¤ºçš„æ˜¯ docï¼Œå¦åˆ™ä¸º termsã€‚ offset: å¯¹åº”çš„ terms æˆ– docs åœ¨æ–‡ä»¶ä¸­çš„åç§»ã€‚ nbytes: å¯¹åº”çš„ terms æˆ– docs çš„æ€»é•¿åº¦ã€‚ read_entry è¿™é‡Œæˆ‘ä»¬é‡ç‚¹è§£é‡Šä¸€ä¸‹ read_entry æ–¹æ³•ï¼Œå…¶ä»–çš„éƒ½æ¯”è¾ƒç®€å•ï¼Œè¯·åœ¨æºç ä¸­æŸ¥æ‰¾ã€‚ fn read_entry(f: mut BufReaderFile) - io::ResultOptionEntry // è·å–åç§»å€¼ let offset = match f.read_u64::LittleEndian() Ok(value) = value, Err(err) = if err.kind() == io::ErrorKind::UnexpectedEof return Ok(None); else return Err(err); ; // è¯»å– nbytes let nbytes = f.read_u64::LittleEndian()?; // è¯»å– df let df = f.read_u32::LittleEndian()?; // è¯»å– term_lenï¼Œå¹¶åˆå§‹åŒ–ä¸€å—å†…å­˜ bytes ç”¨æ¥è¯»å–å®Œæ•´çš„ term let term_len = f.read_u32::LittleEndian()? as usize; let mut bytes = vec![0; term_len]; f.read_exact(mut bytes)?; let term = match String::from_utf8(bytes) Ok(s) = s, Err(_) = return Err(io::Error::new(io::ErrorKind::Other, unicode fail)), ; // è¿”å›æ„å»ºçš„ Entry Ok(Some(Entry term, df, offset, nbytes, )) ç»“åˆä¸‹é¢è¿™å¼ å›¾ï¼Œå¾ˆå®¹æ˜“ç†è§£ read_entry å°±æ˜¯å‰é¢ write_contents_entry çš„é€†å‘è¿‡ç¨‹ã€‚ entries åŒºåŸŸå¸ƒå±€ï¼Œæ¯ä¸ª entry ç´§è´´æ’å¸ƒ create.rs å®Œæ•´æºç ï¼šcreate.rs è‡³æ­¤ï¼Œæˆ‘ä»¬å°±åˆ†æå®Œå¹¶å‘æ„å»ºç´¢å¼•çš„æ•´ä¸ªè¿‡ç¨‹äº†ï¼Œåœ¨ create.rs ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ clap å‘½ä»¤è§£ææ¡†æ¶æ¥æ„å»ºä¸€ä¸ª CLI å·¥å…·ç”¨ä»¥æ”¯æŒæ„å»ºç´¢å¼•ï¼Œæˆ‘ä»¬åŒæ—¶æ”¯æŒå•çº¿ç¨‹æ„å»ºå’Œå¹¶å‘æ„å»ºï¼Œå…·ä½“å¯çœ‹å®Œæ•´æºç ã€‚ å¦‚æœå¯¹ clap ä¸ç†Ÿæ‚‰çš„è¯»è€…ï¼Œå¯å‚è€ƒï¼šæ·±å…¥æ¢ç´¢ Rust çš„ clap åº“ï¼šå‘½ä»¤è¡Œè§£æçš„è‰ºæœ¯ #[derive(Parser)]struct Opts #[arg(short, long, default_value_t = false, help = Default false)] single_threaded: bool, #[arg(required = true)] filenames: VecString,fn main() let opts = Opts::parse(); match run(opts.filenames, opts.single_threaded) Ok(()) = Err(err) = println!(error: , err), æœç´¢åŠŸèƒ½ åœ¨ã€ŠRust ç¨‹åºè®¾è®¡ï¼ˆç¬¬äºŒç‰ˆï¼‰ã€‹ä¸­ï¼Œä½œè€…å¹¶æ²¡æœ‰å®ç°æœç´¢åŠŸèƒ½ï¼Œç¬”è€…å¯¹å…¶è¿›è¡Œæ‰©å±•ï¼Œç›®æ ‡æ˜¯å¯¹æ ‡æˆ‘ä»¬å‰ç¯‡æ‰€æ„å»ºçš„ Rust å®æˆ˜ä¸¨å€’æ’ç´¢å¼•ã€‚è¿™ä¸ªæœç´¢åŠŸèƒ½ï¼Œä¼šæ ¹æ®ç°æœ‰çš„ç´¢å¼•æ–‡ä»¶é‡å»ºå†…å­˜ç´¢å¼• InMemoryIndexï¼Œæ”¯æŒæŒ‡å®š term è¿›è¡Œæœç´¢ï¼Œå¹¶å°†åŒ…å«è¿™ä¸ª term çš„æ–‡ä»¶åœ¨å“åº”çš„ä½ç½®ä¸­è¿›è¡Œé«˜äº®æ˜¾ç¤ºå¹¶è¾“å‡ºåˆ°ç»ˆç«¯ã€‚ search.rs å®Œæ•´æºç ï¼šsearch.rs ç¨‹åºå…¥å£å¦‚ä¸‹æ‰€ç¤ºï¼Œæ¯”è¾ƒç®€å•ï¼Œå°±ä¸èµ˜è¿°äº†ã€‚ #[derive(Parser)]struct Opts #[arg(short, long, required = true, help = Specify index file path)] index_file: String, #[arg(short, long, required = true, help = Specify search term)] term: String,fn main() - io::Result() let opts = Opts::parse(); let index = InMemoryIndex::from_index_file(opts.index_file)?; index.search(opts.term)?; Ok(()) è¿™é‡Œæœ‰ 2 ä¸ªæ ¸å¿ƒé€»è¾‘ï¼š InMemoryIndex::from_index_file: æ ¹æ®ç´¢å¼•æ–‡ä»¶é‡å»ºå†…å­˜ç´¢å¼•ã€‚ index.search(term): æœç´¢ã€‚ index.rs æˆ‘ä»¬åœ¨ index.rs ä¸­ä¸º InMemoryIndex å®ç°ä¸Šè¿° 2 ä¸ªæ–¹æ³•ã€‚ from_index_file pub fn from_index_fileP: AsRefPath(filename: P) - io::ResultInMemoryIndex let mut index = InMemoryIndex::new(); // è·å– IndexFileReader let mut reader = IndexFileReader::open_and_delete(filename, false)?; // ä¾æ¬¡è§£ææ¯ä¸ª Entry while let Some(entry) = reader.iter_next_entry() if entry.term.is_empty() entry.df == 0 // å½“å‰ Entry æŒ‡å‘çš„æ˜¯ä¸€ä¸ª Documentã€‚ // é€šè¿‡ terms_docs è¯»å– Document æ‰€åœ¨ä½ç½®å¹¶è¿›è¡Œè§£æã€‚ reader.terms_docs.seek(io::SeekFrom::Start(entry.offset))?; let doc_id = reader.terms_docs.read_u32::LittleEndian()?; let path_len = reader.terms_docs.read_u64::LittleEndian()?; let mut path = vec![0u8; path_len as usize]; reader.terms_docs.read_exact(mut path)?; index.docs.insert( doc_id, Document id: doc_id, path: vec_to_pathbuf(path), , ); else // å½“å‰ Entry æŒ‡å‘çš„æ˜¯ä¸€ä¸ª termsã€‚ // é€šè¿‡ terms_docs è¯»å– terms æ‰€åœ¨ä½ç½®å¹¶è¿›è¡Œè§£æã€‚ let mut hits = vec![]; reader.terms_docs.seek(io::SeekFrom::Start(entry.offset))?; let mut data = vec![0u8; entry.nbytes as usize]; reader.terms_docs.read_exact(mut data)?; let mut cursor = Cursor::new(data); let mut i = entry.df; let mut has_hit = false; let mut quit = false; while i 0 !quit let mut hit = Vec::with_capacity(4 + 4 + 4); // cannot use vec![0;12] loop if let Ok(item) = cursor.read_i32::LittleEndian() // the start of next hit if item == Self::HITS_SEPERATOR has_hit hits.push(hit); i -= 1; index.word_count -= 2; hit = Vec::with_capacity(4 + 4 + 4); has_hit = true; hit.write_u32::LittleEndian(item as u32).unwrap(); index.word_count += 1; else quit = true; if !hit.is_empty() hits.push(hit); index.word_count -= 2; break; index.terms.insert(entry.term, hits); index.word_count /= 2; Ok(index) search pub fn search(self, term: str) - io::Result() // è·å– term å‡ºç°çš„ä½ç½® let m: OptionVecVecu8 = self.terms.get(term); if m.is_none() println!(can not found in all documents, term); return Ok(()); let hits = m.unwrap(); // éå†æ¯ä¸ªå‡ºç°çš„ä½ç½® for hit in hits let mut cursor = Cursor::new(hit); let _ = cursor.read_i32::LittleEndian().unwrap(); // è·å–æ–‡æ¡£åŸå§‹ä¿¡æ¯ let document_id = cursor.read_u32::LittleEndian().unwrap(); let doc = self.docs.get(document_id); if doc.is_none() println!(cannot found document , document_id); continue; let doc = doc.unwrap(); // hits å­˜å‚¨çš„å†…å®¹ï¼š[HITS_SEPERATOR, document_id, start_pos1, end_pos1, ...] // è§£æ term å‡ºç°åœ¨ doc ä¸­çš„æ¯ä¸ªä½ç½® let mut poss = Vec::with_capacity(hits.len() / 4); let mut pos = TokenPos::default(); let mut has_pos = false; while let Ok(p) = cursor.read_u32::LittleEndian() if !has_pos pos.start_pos = p; has_pos = true; else pos.end_pos = p; poss.push(pos); pos = TokenPos::default(); has_pos = false; // å¯¹æ¯ä¸ªå‡ºç°çš„ä½ç½®è¿›è¡Œé«˜äº®å¤„ç† let result = highlight_file(doc.path.clone(), mut poss)?; // è¾“å‡ºé«˜äº®åçš„ç»“æœ println!( :?: , doc.path, result); Ok(()) è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®ç°äº†é«˜å¹¶å‘æ„å»ºç´¢å¼•å’Œæ ¹æ®ç´¢å¼•è¿›è¡Œæœç´¢çš„åŠŸèƒ½ï¼Œæœ¬ç¯‡æŸäº›éƒ¨åˆ†å¯èƒ½æ¯”è¾ƒå¤æ‚ï¼Œç¯‡å¹…ä¹Ÿæ¯”è¾ƒå†—é•¿ï¼Œç¬”è€…åœ¨é˜…è¯»ä¹¦ä¸­åŸå®ç°çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯è·ç›Šé¢‡ä¸°ï¼Œæƒ³ä¸åˆ°ä¸€ä¸ªç®€å•çš„å€’æ’ç´¢å¼•ç«Ÿæ¶‰åŠè¿™ä¹ˆå¤šçš„å¤„ç†ç»†èŠ‚ã€‚ä¹Ÿå¸Œæœ›æœ¬ç¯‡æ–‡ç« èƒ½å¯¹æ„Ÿå…´è¶£çš„è¯»è€…æœ‰äº›è®¸å¸®åŠ©ã€‚ peace! enjoy coding~ ç»˜å›¾å·¥å…· https://excalidraw.com/ å‚è€ƒèµ„æ–™ ç»´åŸºç™¾ç§‘Â·å€’æ’ç´¢å¼• Rust ç¨‹åºè®¾è®¡ï¼ˆç¬¬äºŒç‰ˆï¼‰","tags":["Rust","å¹¶å‘ç¼–ç¨‹","å€’æ’ç´¢å¼•","é€šé“"],"categories":["Rust","Rust å®æˆ˜"]},{"title":"Rust å®æˆ˜ä¸¨å€’æ’ç´¢å¼•","path":"/2024/04/15/rust-action-inverted-index-demo/","content":"å¼•è¨€ å€’æ’ç´¢å¼•ï¼ˆInverted Indexï¼‰æ˜¯ä¸€ç§ç´¢å¼•æ•°æ®ç»“æ„ï¼Œç”¨äºå­˜å‚¨æŸä¸ªå•è¯ï¼ˆè¯é¡¹ï¼‰åœ¨ä¸€ç»„æ–‡æ¡£ä¸­çš„æ‰€æœ‰å‡ºç°æƒ…å†µçš„æ˜ å°„ã€‚å®ƒæ˜¯æœç´¢å¼•æ“æ‰§è¡Œå¿«é€Ÿå…¨æ–‡æœç´¢çš„æ ¸å¿ƒæŠ€æœ¯ï¼Œä¹Ÿå¹¿æ³›ç”¨äºæ•°æ®åº“ä¸­è¿›è¡Œæ–‡æœ¬æœç´¢ã€‚æˆ‘ä»¬ç†ŸçŸ¥çš„ ElasticSearch æœ€æ ¸å¿ƒåº•å±‚åŸç†ä¾¿å°±æ˜¯å€’æ’ç´¢å¼•ã€‚ å€’æ’ç´¢å¼•çš„åŸºæœ¬åŸç†æ˜¯å°†æ–‡æ¡£ä¸­çš„è¯æ±‡è¿›è¡Œåè½¬ï¼Œå½¢æˆå€’æ’åˆ—è¡¨ã€‚ åœ¨å€’æ’åˆ—è¡¨ä¸­ï¼Œæ¯ä¸ªè¯æ±‡éƒ½å¯¹åº”ä¸€ä¸ªæ–‡æ¡£æ ‡è¯†ç¬¦çš„åˆ—è¡¨ï¼Œè¿™äº›æ ‡è¯†ç¬¦æŒ‡æ˜äº†è¯¥è¯æ±‡å‡ºç°åœ¨å“ªäº›æ–‡æ¡£ä¸­ã€‚ é€šè¿‡æŸ¥è¯¢å€’æ’åˆ—è¡¨ï¼Œå¯ä»¥å¿«é€Ÿåœ°æ‰¾åˆ°åŒ…å«ç‰¹å®šè¯æ±‡çš„æ–‡æ¡£ã€‚ æœ¬æ–‡å°†ä½¿ç”¨ Rust è¯­è¨€æ¥å®ç°ä¸€ä¸ªç®€å•çš„å€’æ’ç´¢å¼•ï¼ŒåŒ…æ‹¬å€’æ’ç´¢å¼•çš„æ„å»ºå’Œæœç´¢è¿‡ç¨‹ã€‚åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œç¬”è€…ä¼šåŸºäºã€ŠRust ç¨‹åºè®¾è®¡ï¼ˆç¬¬äºŒç‰ˆï¼‰ã€‹å¹¶å‘ç¼–ç¨‹ç¯‡ç« ï¼Œè§£è¯»è¯¥ä¹¦ä½œè€…æ˜¯å¦‚ä½•åŸºäº Rust é€šé“å®ç°æ›´ä¼˜ç§€ã€æ›´é«˜æ€§èƒ½çš„å€’æ’ç´¢å¼•ã€‚ å¯ä»¥å­¦åˆ° å€’æ’ç´¢å¼•çš„åŸç†ã€ä¼˜åŠ¿å’Œä½¿ç”¨ å¸¸ç”¨ crateï¼šcoloredã€regex Rust HashMap Rust è¿­ä»£å™¨ å¼€å‘æ€è·¯ å€’æ’ç´¢å¼•æ„å»ºè¿‡ç¨‹ ä¸€ä¸ªç®€å•çš„å€’æ’ç´¢å¼•å¼€å‘æ€è·¯å¤§æ¦‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼š è¯»å–æ–‡æ¡£ åˆ†è¯ æ„å»ºæ¯ä¸ªè¯åˆ°æ¯ä¸ªæ–‡æ¡£çš„æ˜ å°„ å¼€å‘è¿‡ç¨‹ å®Œæ•´æºç ä½äºï¼šinverted_indexã€‚ æœ€ç»ˆæ•ˆæœ fn main() let mut index = InvertedIndex::new(); index.add(1, Rust is safe and fast.); index.add(2, Rust is a systems programming language.); index.add(3, Programming in Rust is fun.); // query Rust let results = index.query(Rust); for result in results println!(, result); println!(); // query Programming let results = index.query(Programming); for result in results println!(, result); æ‰§è¡Œï¼š cargo run è¾“å‡ºï¼š inverted index è¾“å‡ºç¤ºä¾‹ ç‰ˆæœ¬å£°æ˜ [package]name = inverted_indexversion = 0.1.0edition = 2021[dependencies]colored = 2.1.0regex = 1.10.4 é¡¹ç›®å‡†å¤‡ é¦–å…ˆæˆ‘ä»¬åˆ›å»ºé¡¹ç›®ï¼š cargo new inverted_index å‡†å¤‡ä¾èµ–ï¼š cargo add regexcargo add colored colored: ç»ˆç«¯é«˜äº®ï¼Œåé¢æˆ‘ä»¬å°†å®ç°æœç´¢è¯çš„é«˜äº®æ˜¾ç¤ºï¼Œä½¿ç»“æœæ›´ç¾è§‚ã€‚ regex: æ­£åˆ™åº“ï¼Œç”¨äºå®ç°ä¸åŒºåˆ†å¤§å°å†™æ›¿æ¢åŒ¹é…åˆ°çš„æœç´¢è¯ã€‚ å®ç°è¿‡ç¨‹ é¦–å…ˆæˆ‘ä»¬å®šä¹‰ä¸¤ä¸ªæ•°æ®ç»“æ„ï¼š struct Document id: usize, content: String,struct InvertedIndex indexes: HashMapString, Vecusize, documents: HashMapusize, Document,impl InvertedIndex fn new() - InvertedIndex InvertedIndex indexes: HashMap::new(), documents: HashMap::new(), Document: å°è£…åŸå§‹æ–‡æ¡£ IndexedIndex: æˆ‘ä»¬å°†æ„å»ºçš„å€’æ’ç´¢å¼• æ¥ä¸‹æ¥æˆ‘ä»¬è¦å®ç° 2 ä¸ªè¾…åŠ©å‡½æ•°ï¼Œä¸€ä¸ªæ˜¯ tokenizeï¼Œç”¨äºå°†åŸå§‹çš„æ–‡æ¡£ä¿¡æ¯æ‹†åˆ†æˆç‹¬ç«‹çš„è¯ï¼ˆword/termï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯ hightlightï¼Œç”¨äºå°†åŒ¹é…åˆ°çš„æ–‡æœ¬è¿›è¡Œæ›¿æ¢ï¼Œä½¿å…¶åœ¨ä¸­æ–­å¯ä»¥ä»¥ç´«è‰²è¾“å‡ºã€‚ tokenize å®ç°å¦‚ä¸‹ï¼š fn tokenize(text: str) - Vecstr text.split(|ch: char| !ch.is_alphanumeric()) .filter(|c| !c.is_empty()) .collect()#[test]fn tokenize_test() assert_eq!( tokenize(This is hedons tokenize function.), vec![This, is, hedon, s, tokenize, function] ) highlight å®ç°å¦‚ä¸‹ï¼š fn highlight(term: str, content: str) - String let regex = Regex::new(format!(r(?i), term)).unwrap(); let highlighted_content = regex .replace_all(content, |caps: regex::Captures| caps[0].to_string().purple().to_string() ) .to_string(); highlighted_content#[test]fn highlight_test() assert_eq!( highlight(programming, I like programming with Rust Programming), I like \\u1b[35mprogramming\\u1b[0m with Rust \\u1b[35mProgramming\\u1b[0m ); ç°åœ¨æˆ‘ä»¬å¯ä»¥ä¸º InvertedIndex å®ç°æ„å»ºç´¢å¼•çš„æ–¹æ³• add äº†ï¼Œå®ƒä¼šæ¥æ”¶åŸå§‹æ–‡æ¡£ï¼Œå¯¹å…¶è¿›è¡Œåˆ†è¯ï¼Œå¹¶å°†è®°å½•æ¯ä¸ªåˆ†è¯å’Œæ–‡æ¡£ id çš„æ˜ å°„ã€‚ impl InvertedIndex fn add(mut self, doc_id: usize, content: str) let content_lowercase = content.to_lowercase(); let words = tokenize(content_lowercase); for word in words self.indexes .entry(word.to_string()) .or_insert(vec![]) .push(doc_id) self.documents.insert( doc_id, Document id: doc_id, content: content.to_string(), , ); ç„¶åæˆ‘ä»¬å†å®ç°å¯¹åº”çš„æ ¹æ®åˆ†è¯ term æœç´¢åŸå§‹æ–‡æ¡£çš„æ–¹æ³•ï¼š impl InvertedIndex fn query(self, term: str) - VecString let term_lowercase = term.to_lowercase(); if let Some(doc_ids) = self.indexes.get(term_lowercase) doc_ids .iter() .filter_map(|doc_id| self.documents .get(doc_id) .map(|doc| highlight(term_lowercase, doc.content)) ) .collect() else Vec::new() è¿™æ ·ä¸€ä¸ªç®€å•çš„å€’æ’ç´¢å¼•æ„å»ºå’Œæœç´¢åŠŸèƒ½å°±å®Œæˆäº†ï¼Œå…·ä½“çš„æ‰§è¡Œæ•ˆæœä½ å¯ä»¥å›åˆ°å‰é¢çš„ã€Œæœ€ç»ˆæ•ˆæœã€è¿›è¡ŒæŸ¥é˜…ã€‚ æ€»ç»“é¢„å‘Š æœ¬æ–‡å®ç°çš„å€’æ’ç´¢å¼•è™½ç„¶éå¸¸ç®€å•ï¼Œä½†æ˜¯ä¹ŸåŸºæœ¬ä½“ç°äº†å€’æ’ç´¢å¼•çš„æœ€æ ¸å¿ƒæ€æƒ³å’Œåº”ç”¨æ–¹å¼äº†ã€‚åœ¨ã€ŠRust ç¨‹åºè®¾è®¡ï¼ˆç¬¬äºŒç‰ˆï¼‰ã€‹çš„å¹¶å‘ç¼–ç¨‹ç¯‡ç« ä¸­ï¼Œè¯¥ä¹¦æå‡ºäº†ä½¿ç”¨é€šé“ channel æ¥å¹¶å‘æ„å»ºå€’æ’ç´¢å¼•ï¼ŒåŒæ—¶ç»™å‡ºäº†æ›´åŠ ä¸°å¯Œå’Œä¼˜é›…çš„å®ç°ã€‚åœ¨ä¸‹ç¯‡æ–‡ç« ä¸­ï¼Œç¬”è€…å°†é˜…è¯»è¿™éƒ¨åˆ†çš„æºç ï¼Œè§£æå¹¶é‡ç°å½“ä¸­çš„å®æˆ˜è¿‡ç¨‹ï¼Œå¹¶è¿›è¡Œé€‚å½“æ‰©å±•ã€‚ peace! enjoy coding~ ç»˜å›¾å·¥å…· https://excalidraw.com/ å‚è€ƒèµ„æ–™ ç»´åŸºç™¾ç§‘Â·å€’æ’ç´¢å¼• Rust ç¨‹åºè®¾è®¡ï¼ˆç¬¬äºŒç‰ˆï¼‰","tags":["Rust","å€’æ’ç´¢å¼•"],"categories":["Rust","Rust å®æˆ˜"]},{"title":"æ·±å…¥æµ…å‡º Go è¯­è¨€çš„ defer æœºåˆ¶","path":"/2024/03/28/go-defer/","content":"Go è¯­è¨€ä»¥å…¶ç®€æ´çš„è¯­æ³•å’Œå¼ºå¤§çš„å¹¶å‘æ”¯æŒè€Œé—»åã€‚åœ¨è¿™äº›ç‰¹æ€§ä¸­ï¼Œdefer è¯­å¥æ˜¯ Go è¯­è¨€æä¾›çš„ä¸€é¡¹ç‹¬ç‰¹åŠŸèƒ½ï¼Œå®ƒå…è®¸æˆ‘ä»¬æ¨è¿Ÿå‡½æ•°çš„æ‰§è¡Œç›´åˆ°åŒ…å«å®ƒçš„å‡½æ•°å³å°†è¿”å›ã€‚è¿™ä¸ªç®€å•è€Œå¼ºå¤§çš„æœºåˆ¶ä¸ä»…å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¤„ç†èµ„æºé‡Šæ”¾å’Œé”™è¯¯å¤„ç†ï¼Œè¿˜èƒ½è®©ä»£ç æ›´åŠ ç®€æ´å’Œå®‰å…¨ã€‚æœ¬æ–‡å°†æ·±å…¥æµ…å‡ºåœ°ä»‹ç» defer çš„å·¥ä½œåŸç†ï¼Œæ¢ç©¶å…¶èƒŒåçš„æœºåˆ¶ï¼Œå¹¶é€šè¿‡ä¸°å¯Œçš„æ¡ˆä¾‹æ¥å±•ç¤ºå®ƒçš„å®é™…åº”ç”¨ã€‚ ç¬”è€…æœ¬æ¥ä»¥ä¸º Go è¯­è¨€çš„ defer å…¶å®ä¸œè¥¿ä¸å¤šï¼Œå°±æ˜¯ç±»ä¼¼äºâ€œæ ˆâ€çš„æ“ä½œç½¢äº†ï¼Œæ— éå°±æ˜¯ç”¨äºé‡Šæ”¾èµ„æºã€åè¿›å…ˆå‡ºè€Œå·²ã€‚ä½†æ˜¯æœ€è¿‘åœ¨é˜…è¯»å®Œã€Šæ·±å…¥ç†è§£ Go è¯­è¨€ã€‹ã€ã€ŠGo åº•å±‚åŸç†å‰–æã€‹å’Œã€ŠGo è¯­è¨€è®¾è®¡ä¸å®ç°ã€‹ä¸­å…³äº defer çš„ç¯‡ç« ã€‚å‘ç°å…¶ä¸­éšå«çš„é“é“å’Œå‘è¿˜æ˜¯æ¯”è¾ƒæœ‰æ„æ€çš„ï¼Œç‰¹æ­¤æ•´ç†è¿™ç¯‡æ–‡ç« ï¼Œå¸Œæœ›èƒ½å¯¹ Go defer åŸç†æ„Ÿå…´è¶£çš„è¯»è€…å¸¦æ¥ä¸€äº›å¸®åŠ©ã€‚ æœ¬æ–‡å…·ä½“ä¼šåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š defer æœºåˆ¶ç®€ä»‹ï¼šä»‹ç» defer å…³é”®å­—çš„åŸºæœ¬æ¦‚å¿µå’Œå®ƒåœ¨ Go è¯­è¨€ä¸­çš„ä½œç”¨ã€‚ defer çš„å·¥ä½œåŸç†ï¼šæ·±å…¥æ¢è®¨ defer åœ¨å‡½æ•°æ‰§è¡Œç»“æŸæ—¶å¦‚ä½•å·¥ä½œçš„ç»†èŠ‚ã€‚ defer çš„æ‰§è¡Œé¡ºåºï¼šè§£é‡Š defer è¯­å¥æ˜¯å¦‚ä½•æŒ‰ç…§åè¿›å…ˆå‡ºï¼ˆLIFOï¼‰çš„é¡ºåºæ‰§è¡Œçš„ã€‚ å‚æ•°é¢„è®¡ç®—å’Œå€¼ä¼ é€’ï¼šè®¨è®º defer è¯­å¥ä¸­å‚æ•°æ˜¯å¦‚ä½•è¢«é¢„å…ˆè®¡ç®—å’Œä¼ é€’çš„ã€‚ ç¯å¢ƒå˜é‡å’Œé—­åŒ…ï¼šæ¢è®¨ defer å¦‚ä½•ä¸é—­åŒ…ä¸€èµ·å·¥ä½œï¼Œä»¥åŠå¦‚ä½•æ•è·å’Œå½±å“ç¯å¢ƒå˜é‡ã€‚ defer ä¸é”™è¯¯å¤„ç†ï¼šè¯´æ˜å¦‚ä½•åˆ©ç”¨ defer å’Œ recover è¿›è¡Œé”™è¯¯å¤„ç†å’Œå¼‚å¸¸æ•è·ã€‚ defer çš„å®ç°ç»†èŠ‚ï¼šæ·±å…¥åˆ†æ defer çš„ä¸åŒå®ç°ç­–ç•¥ï¼ŒåŒ…æ‹¬å †ä¸Šåˆ†é…ã€æ ˆä¸Šåˆ†é…å’Œå¼€æ”¾ç¼–ç ã€‚ ç‰ˆæœ¬å£°æ˜ Go1.22 æ€ç»´å¯¼å›¾ Go defer æ ¸å¿ƒè¦ç‚¹ å¯¹äºåé¢å°†è¦åˆ†æçš„å„ç§å„æ ·çš„æƒ…å†µï¼Œåœ¨åˆ†æçš„æ—¶å€™åªè¦éµå¾ªä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒç‚¹ï¼ŒåŸºæœ¬ä¸Šå°±ä¸ä¼šè·‘åï¼š å»¶è¿Ÿæ‰§è¡Œï¼šåœ¨å‡½æ•°ç»“æŸæ—¶æ‰§è¡Œï¼ŒåŒ…æ‹¬æ­£å¸¸è¿”å›æˆ–é­é‡ panicã€‚ æ ˆå¼æ‰§è¡Œé¡ºåºï¼šåå®šä¹‰çš„ defer å…ˆæ‰§è¡Œï¼ˆLIFOï¼‰ã€‚ å‚æ•°é¢„è®¡ç®—ï¼šdefer è¯­å¥å®šä¹‰æ—¶å³è®¡ç®—å¹¶å›ºå®šå‚æ•°å€¼ã€‚ å€¼ä¼ é€’åŸåˆ™ï¼šdefer æ‹·è´å‚æ•°ï¼Œä½¿ç”¨å®šä¹‰æ—¶çš„å€¼ã€‚ ç¯å¢ƒå˜é‡æ•è·ï¼šåœ¨ defer ä¸­å¯ä»¥è·Ÿä¸€ä¸ªé—­åŒ…ï¼Œé—­åŒ…å¯ä»¥æ•è·ç¯å¢ƒå˜é‡ï¼Œå½“ç„¶è¿™åŒ…æ‹¬å…·åè¿”å›å€¼ã€‚ ç‰¹åˆ«è¯´æ˜çš„æ˜¯ï¼Œè™½ç„¶æˆ‘ä»¬é€šå¸¸å°† defer æƒ³è±¡ä¸ºä½¿ç”¨æ ˆè¿›è¡Œç®¡ç†ï¼Œä½†æ˜¯å®é™…å®ç°ä¸Šï¼Œdefer å¹¶ä¸éƒ½æ˜¯å­˜æ”¾åœ¨æ ˆä¸Šçš„ï¼Œæˆ‘ä»¬åé¢ä¼šå…·ä½“åˆ†æåˆ°ã€‚è¿™ç§å®ç°ç»†èŠ‚é€šå¸¸å¯¹äºç¼–å†™æ­£ç¡®çš„ Go ä»£ç å¹¶ä¸é‡è¦ï¼Œä½†äº†è§£è¿™ä¸€ç‚¹å¯¹äºæ·±å…¥ç†è§£è¯­è¨€å†…éƒ¨æœºåˆ¶å¯èƒ½æ˜¯æœ‰å¸®åŠ©çš„ã€‚ åŸºæœ¬ç”¨æ³• åœ¨ Go è¯­è¨€ä¸­ï¼Œdefer è¯­å¥é€šå¸¸ç”¨äºç¡®ä¿ä¸€ä¸ªå‡½æ•°è°ƒç”¨åœ¨ç¨‹åºæ‰§è¡Œç»“æŸæ—¶å‘ç”Ÿï¼Œå¸¸è§çš„ç”¨ä¾‹åŒ…æ‹¬æ–‡ä»¶å…³é—­ã€é”é‡Šæ”¾ã€èµ„æºå›æ”¶ç­‰ã€‚ func readFile(filename string) error f, err := os.Open(filename) if err != nil return err // ç¡®ä¿æ–‡ä»¶åœ¨å‡½æ•°è¿”å›æ—¶å…³é—­ defer f.Close() // ... å¤„ç†æ–‡ä»¶ ... return nil åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œdefer f.Close() ä¿è¯äº†æ— è®º readFile å‡½æ•°å¦‚ä½•è¿”å›ï¼ˆæ­£å¸¸è¿”å›æˆ–å‘ç”Ÿé”™è¯¯ï¼‰ï¼Œf.Close() éƒ½ä¼šè¢«è°ƒç”¨ï¼Œä»è€Œé¿å…äº†èµ„æºæ³„éœ²ã€‚ æ‰§è¡Œé¡ºåº defer çš„æ‰§è¡Œé¡ºåºæ˜¯å…ˆè¿›åå‡ºï¼Œå³â€œæ ˆâ€æ“ä½œã€‚è¿™é‡Œå€Ÿç”¨åˆ˜ä¸¹å†°è€å¸ˆçš„ä¸€å¼ å›¾æ¥æ¼”ç¤ºè¿™ä¸ªè¿‡ç¨‹ï¼š Go defer æ‰§è¡Œé¡ºåº æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹ä»£ç è¿›è¡ŒéªŒè¯ï¼š func func1() fmt.Println(func1...)func func2() fmt.Println(func2...)func func3() fmt.Println(func3...)func main() defer func1()\tdefer func2()\tdefer func3() è¾“å‡ºå¦‚ä¸‹ï¼š func3...func2...func1... å‚æ•°æ±‚å€¼ä¸é™·é˜± å…³äº defer å‚æ•°è¿™ä¸€å—ï¼Œæ˜¯ä¸€ä¸ªæ¯”è¾ƒå®¹æ˜“å‡ºé”™çš„åœ°æ–¹ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼Œä½ å¯ä»¥åˆ†æä¸‹å®ƒçš„è¾“å‡ºä¼šæ˜¯ä»€ä¹ˆï¼Ÿ func printI(i int) fmt.Println(printI i:, i)func main() i := 10\tdefer printI(i * 10)\ti = i + 1\tfmt.Println(main i:, i) æŒ‰ç…§æˆ‘ä»¬ä¹‹å‰æ€»ç»“çš„æ ¸å¿ƒç‚¹ï¼šå‚æ•°é¢„è®¡ç®—ï¼šdefer è¯­å¥å®šä¹‰æ—¶å³è®¡ç®—å¹¶å›ºå®šå‚æ•°å€¼ã€‚å…·ä½“æ¥è¯´ï¼Œåœ¨æŠŠ defer å‹å…¥â€œæ ˆâ€æ—¶ï¼Œä¼šåŒæ—¶å‹å…¥å‡½æ•°åœ°å€å’Œå‡½æ•°å½¢å‚ï¼Œä¹Ÿå°±æ˜¯ä¼šåœ¨è¿™ä¸ªæ—¶å€™å°±æŠŠå‚æ•°å…ˆç®—å¥½ã€‚æ‰€ä»¥åœ¨æ‰§è¡Œåˆ°ç¬¬ 7 è¡Œä»£ç çš„æ—¶å€™ï¼Œå°±ä¼šæŠŠ i*10 ç®—å¥½ï¼Œç„¶ååŒ printI ä¸€åŒå‹å…¥åˆ°å»¶è¿Ÿæ‰§è¡Œæ ˆä¸­ã€‚ æ‰€ä»¥æœ€åçš„ç»“æœå°±æ˜¯ï¼š main i: 11printI i: 100 å…³äºå‚æ•°å€¼ä¼ é€’ï¼Œç¬”è€…è¿™é‡Œå†ä¸¾ä¸¤ä¸ªä¾‹å­è¿›è¡Œæ¯”è¾ƒï¼Œä½“ä¼šåä½ åº”è¯¥å°±ç†è§£äº†ã€‚ ç¬¬ä¸€ä¸ªä¾‹å­ä¸­ï¼Œdefer åé¢å‚æ•°æ˜¯æŒ‡é’ˆï¼Œæœ¬è´¨ä¸Šå€¼ä¼ é€’ï¼Œä½†æ˜¯æ‹·è´çš„æ˜¯æŒ‡é’ˆï¼Œæ‰€ä»¥åœ¨ defer ä¸­ä¿®æ”¹çš„ä¸œè¥¿ï¼Œæœ€åä¼šåé¦ˆåˆ°æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡ï¼Œæ‰€ä»¥å¯¹ testUser çš„è¿”å›å€¼æ˜¯æœ‰å½±å“çš„ã€‚ type User struct\tname stringfunc testUser() *User user := User\tuser.name = name-1\tdefer func(u *User) u.name = name-defer\t(user)\tuser.name = name-2\treturn userfunc main() user := testUser()\tfmt.Println(user)// name-defer ç¬¬äºŒä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä¼ å…¥çš„å°±æ˜¯ç»“æ„ä½“ç¤ºä¾‹æœ¬èº«äº†ï¼Œå› ä¸ºå€¼ä¼ é€’ï¼Œå³æ‹·è´äº†ä¸€ä»½æ–°çš„ userï¼Œæ‰€ä»¥é—­åŒ…å†…çš„ä¿®æ”¹å¯¹å¤–é¢æ˜¯ä¸äº§ç”Ÿå½±å“çš„ã€‚ type User struct name stringfunc testUser() User user := User\tuser.name = name-1\tdefer func(u User) u.name = name-defer\t(user)\tuser.name = name-2\treturn userfunc main() user := testUser()\tfmt.Println(user)// name-2 ç¯å¢ƒå˜é‡æ•è· å°†ä¸Šé¢çš„ä¸€ä¸ªä¾‹å­è¿›è¡Œç®€å•ä¿®æ”¹ï¼Œä¼šè¾“å‡ºä»€ä¹ˆå‘¢ï¼Ÿ func printI(i int) fmt.Println(printI i:, i)func main() i := 10\tdefer func() printI(i * 10)\t()\ti = i + 1\tfmt.Println(main i:, i) è¿™ä¸ªæ—¶å€™å…¶å®æ²¡æœ‰å‚æ•°ï¼Œæ‰€ä»¥ä¼šç›´æ¥å°†ä¸‹é¢é—­åŒ…å‹å…¥å»¶è¿Ÿæ ˆä¸­ã€‚ func() printI(i * 10) è€Œé—­åŒ…æ˜¯å¯ä»¥æ•è·ç¯å¢ƒå˜é‡çš„ï¼Œæ‰€ä»¥åœ¨ main return åï¼Œdefer å¯ä»¥æ•è·åˆ° i çš„å€¼ï¼Œä¸ºæ›´æ–°åçš„ i+1ï¼Œæœ€åå†è¿›è¡Œ printI(i * 10)ã€‚ æ‰€ä»¥è¾“å‡ºç»“æœæ˜¯ï¼š main i: 11printI i: 110 æ‰€ä»¥è¯´ï¼Œdefer åé¢çš„é—­åŒ…ï¼Œæ˜¯å¯ä»¥æ•è·ç¯å¢ƒå˜é‡çš„ï¼Œå¦‚æœè¿™ä¸ªå˜é‡æ˜¯è¿”å›å€¼çš„è¯ï¼Œé‚£ä¹ˆç†æ‰€åº”å½“ä¹Ÿæ˜¯å¯ä»¥å¯¹å…¶äº§ç”Ÿä½œç”¨çš„ï¼Œå¦‚ï¼š func getI() (i int) i = 1\tdefer func() i *= 10\t()\treturn 20func main() fmt.Println(getI()) è¿™æ®µä»£ç ä¸­ï¼ŒgetI çš„è¿”å›å€¼æ˜¯æœ‰åå­—çš„ iï¼ŒgetI æ‰§è¡Œäº† return 20ï¼Œå…¶å®å°±æ˜¯å°† i è®¾ç½®ä¸º 20ï¼Œæ‰€ä»¥åœ¨æ‰§è¡Œåˆ° defer é—­åŒ…çš„æ—¶å€™ï¼Œæ•è·åˆ°äº† i=20ï¼Œå¹¶å°†å…¶è¿›è¡Œäº†ä¿®æ”¹ã€‚æ‰€ä»¥æœ€ç»ˆè¾“å‡ºï¼š 200 é”™è¯¯å¤„ç†ä¸ defer æˆ‘ä»¬éƒ½çŸ¥é“ Go ç¨‹åºä¸­é‡åˆ° panic å°±ä¼šä¸­æ–­åé¢çš„æ‰§è¡Œæµç¨‹ç›´æ¥è¿”å›ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥åœ¨ defer ä¸­ç»“åˆ recover æ¥æ•è·è¿™ä¸ª panicï¼Œä»è€Œä¿æŠ¤ç¨‹åºä¸å´©æºƒã€‚ å¦‚ï¼š func panicAndRecover() defer func() if err := recover(); err != nil fmt.Println(err) ()\tfmt.Println(å‡½æ•°ä¸­æ­£å¸¸æµç¨‹)\tpanic(å‡ºç°å¼‚å¸¸)\tfmt.Println(panic åçš„è¯­å¥æ°¸è¿œæ‰§è¡Œä¸åˆ°)func main() panicAndRecover()\tfmt.Println(æ­£å¸¸å›åˆ° main)// å‡½æ•°ä¸­æ­£å¸¸æµç¨‹// å‡ºç°å¼‚å¸¸// æ­£å¸¸å›åˆ° main æ›´è¿›ä¸€æ­¥ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ defer ä¸­ä¹Ÿæœ‰ panic å‘¢ï¼Ÿè¯·æ€è€ƒä¸‹åˆ—ä»£ç ï¼š func panicAndRecover() defer func() fmt.Println(ç¬¬ 1 ä¸ªå…¥æ ˆçš„ defer) if err := recover(); err != nil fmt.Println(æœ€ç»ˆæ•è·çš„ panic:, err) ()\tdefer func() fmt.Println(ç¬¬ 2 ä¸ªå…¥æ ˆçš„ defer) panic(ç¬¬ 2 ä¸ªå…¥æ ˆçš„ defer å‘ç”Ÿ panic)\t()\tfmt.Println(panicAndRecover å‡½æ•°ä¸­æ­£å¸¸æµç¨‹)\tpanic(panicAndRecover å‡ºç°å¼‚å¸¸)\tfmt.Println(panic åçš„è¯­å¥æ°¸è¿œæ‰§è¡Œä¸åˆ°)func main() panicAndRecover()\tfmt.Println(æ­£å¸¸å›åˆ° main) ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬åœ¨ panicAndRecover å¼ºè¡ŒæŠ›å‡º panicï¼Œç”±äº defer å…ˆè¿›åå‡ºï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šå…ˆæ‰§è¡Œç¬¬ 2 ä¸ª deferï¼Œå…¶ä¸­ä¹Ÿå‘ç”Ÿäº† panicï¼Œæˆ‘ä»¬åœ¨ç¬¬ 1 ä¸ª defer ä¸­å¯¹ panic è¿›è¡Œ recoverï¼Œæœ€ç»ˆçš„ç°è±¡æ˜¯åªæ•è·åˆ°äº†åé¢æŠ›å‡ºçš„ panicï¼š panicAndRecover å‡½æ•°ä¸­æ­£å¸¸æµç¨‹ç¬¬ 2 ä¸ªå…¥æ ˆçš„ deferç¬¬ 1 ä¸ªå…¥æ ˆçš„ deferæœ€ç»ˆæ•è·çš„ panic: ç¬¬ 2 ä¸ªå…¥æ ˆçš„ defer å‘ç”Ÿ panicæ­£å¸¸å›åˆ° main è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ åœ¨ Go è¯­è¨€ä¸­ï¼Œpanic å‡½æ•°å®é™…ä¸Šæ˜¯åˆ›å»ºäº†ä¸€ä¸ª panic å¯¹è±¡ï¼Œå¹¶æŠ›å‡ºè¿™ä¸ªå¯¹è±¡ã€‚ å½“ä¸€ä¸ª panic å‘ç”Ÿå¹¶å¼€å§‹å‘ä¸Šä¼ æ’­æ—¶ï¼ŒGo è¿è¡Œæ—¶ä¼šæ£€æŸ¥æ¯ä¸ª deferã€‚å¦‚æœ defer ä¸­åŒ…å« recover è°ƒç”¨ï¼Œå¹¶ä¸”å®ƒè¢«æ‰§è¡Œï¼Œé‚£ä¹ˆ recover ä¼šæ•è·å½“å‰çš„ panicï¼Œå¹¶ä¸”é˜²æ­¢å®ƒç»§ç»­å‘ä¸Šä¼ æ’­ã€‚å¦‚æœ defer ä¸­å†æ¬¡å‘ç”Ÿ panicï¼Œé‚£ä¹ˆåŸæ¥çš„ panic å°±ä¸ä¼šè¢« recover æ•è·ï¼Œå› ä¸º defer å‡½æ•°å·²ç»é€€å‡ºäº†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ–°çš„ panic ä¼šå¯¼è‡´ç¨‹åºå´©æºƒï¼Œå› ä¸ºæ²¡æœ‰æ›´å¤šçš„ defer å‡½æ•°å» recover è¿™ä¸ªæ–°çš„ panicã€‚ è¿™è¯´æ˜äº† Go ç¨‹åºä¸­ä¸å…è®¸åŒæ—¶æœ‰å¤šä¸ªæ´»è·ƒçš„ panic å­˜åœ¨ï¼Œè¿™ä¸ªè®¾è®¡ç¡®ä¿äº†åœ¨ä»»ä½•ç»™å®šçš„æ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ª panic èƒ½å¤Ÿè¢«å¤„ç†ã€‚è¿™æ ·åšæœ‰å‡ ä¸ªåŸå› ï¼š ç®€åŒ–é”™è¯¯å¤„ç†ï¼š å¦‚æœåŒæ—¶å­˜åœ¨å¤šä¸ª panicï¼Œå°±ä¼šå˜å¾—éå¸¸å¤æ‚å»ç¡®å®šå¦‚ä½•å¤„ç†å®ƒä»¬ï¼Œå°¤å…¶æ˜¯åœ¨å®ƒä»¬ä¹‹é—´å­˜åœ¨ä¾èµ–å…³ç³»çš„æ—¶å€™ã€‚ä¸€ä¸ª panic åº”è¯¥è¡¨ç¤ºä¸€ä¸ªä¸å¯æ¢å¤çš„é”™è¯¯ï¼Œå¦‚æœæœ‰å¤šä¸ªè¿™æ ·çš„é”™è¯¯åŒæ—¶å­˜åœ¨ï¼Œç¨‹åºçš„çŠ¶æ€å¯èƒ½ä¼šå˜å¾—éå¸¸ä¸ç¡®å®šã€‚ ä¿æŒä¸€è‡´æ€§ï¼š panic é€šå¸¸è¡¨ç¤ºç¨‹åºä¸­å‡ºç°äº†ä¸¥é‡é”™è¯¯ï¼Œå¯èƒ½ä¼šç ´åç¨‹åºçš„ä¸€è‡´æ€§æˆ–å®‰å…¨æ€§ã€‚å¦‚æœå…è®¸å¤šä¸ª panic åŒæ—¶å­˜åœ¨ï¼Œå°±å¾ˆéš¾ä¿è¯ç¨‹åºçŠ¶æ€çš„ä¸€è‡´æ€§ï¼Œå› ä¸ºä¸åŒçš„ panic å¯èƒ½éœ€è¦å›é€€ä¸åŒçš„æ“ä½œã€‚ é¿å…èµ„æºæ³„æ¼ï¼š defer è¯­å¥ç”¨äºç¡®ä¿èµ„æºè¢«é‡Šæ”¾ï¼Œä¾‹å¦‚æ–‡ä»¶å’Œé”ã€‚å¦‚æœåœ¨å¤„ç†ä¸€ä¸ª panic çš„è¿‡ç¨‹ä¸­ï¼Œåˆå‘ç”Ÿäº†å¦ä¸€ä¸ª panicï¼Œå¯èƒ½ä¼šå¯¼è‡´ defer è¯­å¥ä¸­å‰©ä½™çš„æ¸…ç†ä»£ç æ— æ³•æ‰§è¡Œï¼Œä»è€Œå¼•èµ·èµ„æºæ³„æ¼ã€‚ æ§åˆ¶æµç¨‹æ¸…æ™°ï¼š panic å’Œ recover çš„è®¾è®¡ä½¿å¾—é”™è¯¯çš„æ§åˆ¶æµç¨‹æ¸…æ™°ä¸”å¯é¢„æµ‹ã€‚ä¸€æ—¦ä¸€ä¸ª panic è¢« recover æ•è·ï¼Œç¨‹åºå¯ä»¥é€‰æ‹©æ˜¯å¦ç»§ç»­æ‰§è¡Œï¼Œæˆ–è€…æ˜¯é€šè¿‡é‡æ–° panic æ¥ç»ˆæ­¢ç¨‹åºã€‚è¿™ç§å†³ç­–è¿‡ç¨‹åœ¨å¤šä¸ª panic æƒ…å†µä¸‹ä¼šå˜å¾—å¤æ‚ä¸”éš¾ä»¥ç®¡ç†ã€‚ å› æ­¤ï¼Œåœ¨ Go çš„è®¾è®¡ä¸­ï¼Œä¸å…è®¸åŒæ—¶å­˜åœ¨å¤šä¸ªæ´»è·ƒçš„ panicã€‚ä¸€æ—¦å‘ç”Ÿ panicï¼Œå®ƒå¿…é¡»è¢« recover å¤„ç†ï¼Œå¦åˆ™ç¨‹åºå°†ä¼šç»ˆæ­¢ã€‚è¿™ç¡®ä¿äº†é”™è¯¯å¤„ç†çš„æ¸…æ™°æ€§å’Œç¨‹åºçš„ç¨³å®šæ€§ã€‚ defer æ”¾åœ¨å“ª defer å®é™…ä¸Šä¸ä¸€å®šæ˜¯æ”¾åœ¨æ ˆä¸Šçš„ï¼Œæˆªæ­¢ Go1.22ï¼Œdefer å…¶å®ç”¨ 3 ç§åˆ†é…ç­–ç•¥ï¼š å †ä¸Šåˆ†é… æ ˆä¸Šåˆ†é… å¼€æ”¾ç¼–ç  æ‰§è¡Œæœºåˆ¶ åœ¨ ssa.go æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ° state.stmt()ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯è´Ÿè´£åœ¨ Go ç¨‹åºç¼–è¯‘è¿‡ç¨‹ä¸­ä¸­é—´ä»£ç ç”Ÿæˆé˜¶æ®µæ—¶å¯¹ä¸åŒè¯­å¥çš„å¤„ç†è¿‡ç¨‹ï¼Œå…¶ä¸­å¯¹äº ODEFER å³ defer è¯­å¥çš„å¤„ç†é€»è¾‘å¦‚ä¸‹ï¼š // stmt converts the statement n to SSA and adds it to s.func (s *state) stmt(n ir.Node) s.stmtList(n.Init())\tswitch n.Op() case ir.ODEFER: n := n.(*ir.GoDeferStmt) if base.Debug.Defer 0 var defertype string if s.hasOpenDefers defertype = open-coded else if n.Esc() == ir.EscNever defertype = stack-allocated else defertype = heap-allocated base.WarnfAt(n.Pos(), %s defer, defertype) ... å¯ä»¥çœ‹åˆ°ï¼Œæ€»å…±æœ‰ 3 ç§åˆ†é…ç­–ç•¥ï¼š open-coded: s.hasOpenDefers == true stack-allocated: n.Esc() == ir.EscNever heap-allocated: é»˜è®¤ é»˜è®¤æ˜¯å †åˆ†é…ï¼Œåœ¨ Go1.13 ä»¥å‰ï¼Œä¹Ÿåªæœ‰å †åˆ†é…è¿™ä¸€ç§ç­–ç•¥ï¼Œä¸è¿‡è¯¥å®ç°çš„æ€§èƒ½è¾ƒå·®ã€‚Go è¯­è¨€åœ¨ 1.13 ä¸­å¼•å…¥æ ˆä¸Šåˆ†é…çš„ç»“æ„ä½“ï¼Œå‡å°‘äº† 30% çš„é¢å¤–å¼€é”€ï¼Œå¹¶åœ¨ 1.14 ä¸­å¼•å…¥äº†åŸºäºå¼€æ”¾ç¼–ç çš„ deferï¼Œä½¿å¾—è¯¥å…³é”®å­—çš„é¢å¤–å¼€é”€å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚ æœ¬æ–‡ä¸­ä¸å¯¹å…·ä½“çš„åˆ†é…æœºåˆ¶è¿›è¡Œåˆ†æï¼Œè¿™ä¸€å—ä¼šæ¯”è¾ƒå¤æ‚ï¼Œç¬”è€…æœ¬èº«ä¹Ÿä¸æ˜¯å¾ˆæ„Ÿå…´è¶£ï¼Œä¾¿å†³å®šå¯¹æ­¤ä¸è¿‡åˆ†æ·±ç©¶ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…æ¨èè¯¦ç»†é˜…è¯»ã€ŠGo è¯­è¨€è®¾è®¡ä¸å®ç°ã€‹ä¸­å…³äº defer å…³é”®å­—çš„åˆ†æï¼šhttps://draveness.me/golang/docs/part2-foundation/ch05-keyword/golang-defer/ã€‚ æœ¬æ–‡åªè®¨è®ºä»€ä¹ˆæƒ…å†µä¸‹ä¼šä½¿ç”¨ä»€ä¹ˆåˆ†é…ç­–ç•¥ã€‚ç”±äºå †åˆ†é…æ˜¯é»˜è®¤çš„ï¼Œæˆ‘ä»¬å°±ä¸ä½œåˆ†æäº†ï¼Œå…·ä½“æ¥çœ‹çœ‹ s.hasOpenDefers == true å’Œ n.Esc() == ir.EscNever ä»€ä¹ˆæ—¶å€™ä¼šæˆç«‹ã€‚ æ ˆä¸Šåˆ†é… æˆ‘ä»¬å…ˆæ¥çœ‹æ ˆä¸Šåˆ†é…ï¼Œè¦æ»¡è¶³æ ˆä¸Šåˆ†é…ï¼Œåˆ™éœ€è¦æ»¡è¶³ n.Esc() == ir.EscNeverã€‚ const (\tEscUnknown = iota\tEscNone // Does not escape to heap, result, or parameters.\tEscHeap // Reachable from the heap\tEscNever // By construction will not escape.) å½“ n çš„é€ƒé€¸åˆ†æç»“æœæ˜¯ ir.EscNeverï¼Œåˆ™è¡¨æ˜è¯¥ defer è¯­å¥ä»ä¸é€ƒé€¸ï¼ˆä¸ä¼šåœ¨å‡½æ•°è°ƒç”¨ç»“æŸåä»ç„¶è¢«å¼•ç”¨ï¼‰ï¼Œè¿™ç§æƒ…å†µä¸‹ defer å°†è¢«åˆ†é…åˆ°æ ˆä¸Šï¼ˆstack-allocatedï¼‰ã€‚å¦åˆ™ï¼Œå¦‚æœ defer é€ƒé€¸äº†ï¼Œå°±ä¼šè¢«åˆ†é…åˆ°å †ä¸Šï¼ˆheap-allocatedï¼‰ã€‚ é‚£ defer è¯­å¥ä»€ä¹ˆæ—¶å€™ä¼šé€ƒé€¸å‘¢ï¼Ÿ åœ¨ Go ä¸­ï¼Œä¸€ä¸ªå˜é‡çš„é€ƒé€¸æ„å‘³ç€å®ƒçš„ç”Ÿå‘½å‘¨æœŸè¶…å‡ºäº†å½“å‰å‡½æ•°çš„èŒƒå›´ã€‚åœ¨å‡½æ•°å†…å®šä¹‰çš„å˜é‡é€šå¸¸åˆ†é…åœ¨æ ˆä¸Šï¼Œè€Œåœ¨å †ä¸Šåˆ†é…å†…å­˜éœ€è¦æ›´å¤æ‚çš„ç®¡ç†ã€‚åœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨å¯èƒ½ä¼šé€‰æ‹©å°†å˜é‡åˆ†é…åœ¨å †ä¸Šï¼Œè¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬ç§°ä¹‹ä¸ºé€ƒé€¸ã€‚ å¯¹äº defer è¯­å¥ï¼Œå¦‚æœå®ƒå¼•ç”¨äº†å‡½æ•°å¤–çš„å˜é‡ï¼Œè¿™ä¸ª defer å°±ä¼šé€ƒé€¸ã€‚ä¾‹å¦‚ï¼š var x = 10func someFunction() defer func() fmt.Println(x) // è¿™é‡Œå¼•ç”¨äº†å¤–éƒ¨å˜é‡ x () åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œdefer å‡½æ•°å†…éƒ¨å¼•ç”¨äº† x è¿™ä¸ªå¤–éƒ¨å˜é‡ï¼Œå› æ­¤ defer è¯­å¥éœ€è¦ç¡®ä¿ x åœ¨ defer å‡½æ•°æ‰§è¡Œæ—¶ä»ç„¶æœ‰æ•ˆã€‚ä¸ºäº†æ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼Œç¼–è¯‘å™¨å¯èƒ½ä¼šå°† x åˆ†é…åœ¨å †ä¸Šï¼Œè€Œä¸æ˜¯æ ˆä¸Šã€‚ å¼€æ”¾ç¼–ç  å…ˆç»™ç»“è®ºï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œè¦ä½¿ç”¨å¼€æ”¾ç¼–ç ç­–ç•¥ï¼Œä½ åªéœ€è¦å…³æ³¨ä»¥ä¸‹ 4 ç‚¹å³å¯ï¼š å‡½æ•°çš„ defer æ•°é‡ä¸èƒ½è¶…è¿‡ 8 ä¸ªï¼› å‡½æ•°çš„ defer å…³é”®å­—ä¸èƒ½åœ¨å¾ªç¯ä¸­æ‰§è¡Œï¼› å‡½æ•°çš„ defer ä¸­ä¸èƒ½å‘ç”Ÿé€ƒé€¸ï¼› å‡½æ•°çš„ return è¯­å¥ä¸ defer è¯­å¥çš„ä¹˜ç§¯å°äºæˆ–è€…ç­‰äº 15 ä¸ªï¼› Okï¼Œä¸‹é¢æ˜¯å…·ä½“çš„åˆ†æè¿‡ç¨‹ã€‚ å€ŸåŠ© Goland çš„èƒ½åŠ›ï¼Œå°†é¼ æ ‡å…‰æ ‡æ”¾åœ¨ s.hasOpenDefers ä¸Šï¼ŒæŒ‰ä½ Command åŠ ç‚¹å‡»é¼ æ ‡ï¼Œå¯ä»¥çœ‹åˆ°è¯¥å±æ€§çš„ä½¿ç”¨æƒ…å†µï¼š s.hasOpenDefers å¯ä»¥çœ‹åˆ°è¯¥å±æ€§çš„åˆ¤æ–­é€»è¾‘éƒ½åœ¨ ssa.go æ–‡ä»¶ä¸­çš„ buildssa() å‡½æ•°ä¸­ã€‚å»æ‰ä¸€äº›æ— å…³çš„ä»£ç ï¼Œæ ¸å¿ƒé€»è¾‘å¦‚ä¸‹ï¼š // buildssa builds an SSA function for fn.// worker indicates which of the backend workers is doing the processing.func buildssa(fn *ir.Func, worker int) *ssa.Func ... // â‘ \ts.hasOpenDefers = base.Flag.N == 0 s.hasdefer !s.curfn.OpenCodedDeferDisallowed()\tswitch // â‘¡\tcase base.Debug.NoOpenDefer != 0: s.hasOpenDefers = false\tcase s.hasOpenDefers (base.Ctxt.Flag_shared || base.Ctxt.Flag_dynlink) base.Ctxt.Arch.Name == 386: // â‘¢ // Dont support open-coded defers for 386 ONLY when using shared // libraries, because there is extra code (added by rewriteToUseGot()) // preceding the deferreturn/ret code that we dont track correctly. s.hasOpenDefers = false // â‘£\tif s.hasOpenDefers len(s.curfn.Exit) 0 // Skip doing open defers if there is any extra exit code (likely // race detection), since we will not generate that code in the // case of the extra deferreturn/ret segment. s.hasOpenDefers = false // â‘¤\tif s.hasOpenDefers // Similarly, skip if there are any heap-allocated result // parameters that need to be copied back to their stack slots. for _, f := range s.curfn.Type().Results().FieldSlice() if !f.Nname.(*ir.Name).OnStack() s.hasOpenDefers = false break // â‘¥\tif s.hasOpenDefers s.curfn.NumReturns*s.curfn.NumDefers 15 // Since we are generating defer calls at every exit for // open-coded defers, skip doing open-coded defers if there are // too many returns (especially if there are multiple defers). // Open-coded defers are most important for improving performance // for smaller functions (which dont have many returns). s.hasOpenDefers = false ...\treturn s.f å¯ä»¥çœ‹åˆ°æ€»å…±æœ‰ 6 ä¸ªæ¡ä»¶ï¼Œæˆ‘å·²åœ¨æ³¨é‡Šä¸­è¿›è¡Œæ ‡æ³¨ï¼Œæˆ‘ä»¬æ¥è¿›è¡Œé€ä¸€åˆ†æï¼š â‘  base.Flag.N == 0 s.hasdefer !s.curfn.OpenCodedDeferDisallowed() å¦‚æœbase.Flag.N ç­‰äº 0 ä¸”å½“å‰å‡½æ•°æœ‰å»¶è¿Ÿè°ƒç”¨ä¸”æ²¡æœ‰ç¦æ­¢å¼€æ”¾å¼å»¶è¿Ÿï¼Œé‚£ä¹ˆè®¾ç½®s.hasOpenDefersä¸ºtrueã€‚ åœ¨ Go ç¼–è¯‘å™¨ä¸­ï¼Œ-Næ ‡å¿—é€šå¸¸ç”¨äºç¦ç”¨ä¼˜åŒ–ã€‚åœ¨è¿™æ®µä»£ç ä¸­ï¼Œå¦‚æœbase.Flag.Nç­‰äº 0ï¼Œæ„å‘³ç€æ²¡æœ‰ç¦ç”¨ä¼˜åŒ–ï¼Œå› æ­¤ç¼–è¯‘å™¨å¯èƒ½ä¼šå°è¯•ä½¿ç”¨æ›´é«˜çº§çš„ä¼˜åŒ–æŠ€æœ¯ï¼Œæ¯”å¦‚å¼€æ”¾å¼å»¶è¿Ÿï¼ˆopen-coded defersï¼‰ã€‚ OpenCodedDeferDisallowed() å³ç¦ç”¨å¼€æ”¾ç¼–ç ï¼Œå®ƒçš„å®ç°å¦‚ä¸‹ï¼š const funcOpenCodedDeferDisallowed // cant do open-coded defersfunc (f *Func) OpenCodedDeferDisallowed() bool return f.flagsfuncOpenCodedDeferDisallowed != 0 æŒ‰ä½ Command åç‚¹å‡» funcOpenCodedDeferDisallowed å¯ä»¥çœ‹åˆ°åªæœ‰ funcOpenCodedDeferDisallowed(b) å¯ä»¥ä¿®æ”¹å®ƒçš„å€¼ã€‚ funcOpenCodedDeferDisallowed æˆ‘ä»¬æ¥çœ‹çœ‹å“ªä¸ªåœ°æ–¹ä¼šè°ƒç”¨ funcOpenCodedDeferDisallowed()ï¼Œå¹¶å°† funcOpenCodedDeferDisallowed è®¾ç½®ä¸º trueï¼š å°† funcOpenCodedDeferDisallowed è®¾ç½®ä¸º true çš„åœ°æ–¹ è°ƒç”¨å®ƒçš„åœ°æ–¹åœ¨ stmt.go æ–‡ä»¶ä¸­çš„ walkStmt() å‡½æ•°ï¼Œå…·ä½“å¦‚ä¸‹ï¼š // The max number of defers in a function using open-coded defers. We enforce this// limit because the deferBits bitmask is currently a single byte (to minimize code size)const maxOpenDefers = 8// The result of walkStmt MUST be assigned back to n, e.g.////\tn.Left = walkStmt(n.Left)func walkStmt(n ir.Node) ir.Node ...\tswitch n.Op() ... case ir.ODEFER: n := n.(*ir.GoDeferStmt) ir.CurFunc.SetHasDefer(true) ir.CurFunc.NumDefers++ if ir.CurFunc.NumDefers maxOpenDefers // Dont allow open-coded defers if there are more than // 8 defers in the function, since we use a single // byte to record active defers. ir.CurFunc.SetOpenCodedDeferDisallowed(true) if n.Esc() != ir.EscNever // If n.Esc is not EscNever, then this defer occurs in a loop, // so open-coded defers cannot be used in this function. ir.CurFunc.SetOpenCodedDeferDisallowed(true) fallthrough ... ... ç¬¬ä¸€ç‚¹æ˜¯ï¼šå½“å‰å‡½æ•°ä¸­ defer ä¸ªæ•°è¶…è¿‡ 8 çš„è¯ï¼Œåˆ™ç¦ç”¨å¼€æ”¾ç¼–ç ã€‚ ç¬¬äºŒç‚¹æ˜¯å½“ n.Esc() != ir.EscNever ä½¿ï¼Œå°±ç¦ç”¨å¼€æ”¾ç¼–ç ã€‚è¿™ä¸ªè¦æ±‚è·Ÿå‰é¢åˆ†æçš„â€œæ ˆä¸Šåˆ†é…â€è¦æ±‚æ˜¯ä¸€æ ·çš„ã€‚ è¿™é‡Œå†è¡¥å……ä¸€ç‚¹ï¼šä»€ä¹ˆæ—¶å€™ n.Esc() ä¼šè¢«è®¾ç½®ä¸º ir.EscNever å‘¢ï¼Ÿ n.SetEsc(ir.EscNever) è¿™é‡Œé¢æ ¸å¿ƒç‚¹æ˜¯ç¬¬ä¸€ä¸ªï¼Œå®ƒå¯¹åº”çš„ä»£ç å¦‚ä¸‹ï¼š func (e *escape) goDeferStmt(n *ir.GoDeferStmt) k := e.heapHole()\tif n.Op() == ir.ODEFER e.loopDepth == 1 ... n.SetEsc(ir.EscNever) ... e.loopDepth == 1 æ—¶å°±è®¾ç½®ï¼Œæ¢è¨€ä¹‹ï¼Œdefer ä¸åœ¨å¾ªç¯ä¸­çš„æ—¶å€™ï¼Œæ‰å…è®¸å¼€æ”¾ç¼–ç ã€‚ æ€»è€Œè¨€ä¹‹ï¼Œç¬¬ â‘  ä¸ªæ¡ä»¶çº¦æŸäº†è¦é‡‡ç”¨ open-coded å¼€æ”¾ç¼–ç ç­–ç•¥çš„ 3 ä¸ªæ¡ä»¶ï¼š å‡½æ•°ä¸­ defer ä¸ªæ•°ä¸èƒ½è¶…è¿‡ 8ï¼› defer ä¸èƒ½åœ¨å¾ªç¯ä¸­ï¼› defer ä¸èƒ½å‘ç”Ÿé€ƒé€¸ã€‚ â‘¡ base.Debug.NoOpenDefer != 0 å¦‚æœbase.Debug.NoOpenDeferä¸ä¸º 0ï¼Œé‚£ä¹ˆç¦ç”¨å¼€æ”¾å¼å»¶è¿Ÿã€‚ NoOpenDefer int `help:disable open-coded defers concurrent:ok` â‘¢ (base.Ctxt.Flag_shared || base.Ctxt.Flag_dynlink) base.Ctxt.Arch.Name == \"386\" å¦‚æœå½“å‰æ¶æ„æ˜¯386ï¼Œå¹¶ä¸”ä½¿ç”¨å…±äº«åº“æˆ–åŠ¨æ€é“¾æ¥ï¼Œé‚£ä¹ˆä¸æ”¯æŒå¼€æ”¾å¼å»¶è¿Ÿï¼Œå› ä¸ºå­˜åœ¨ä¸€äº›é¢å¤–çš„ä»£ç ï¼ˆç”±rewriteToUseGot()æ·»åŠ ï¼‰å¯èƒ½æ— æ³•æ­£ç¡®è¿½è¸ªã€‚ â‘£ len(s.curfn.Exit) å¦‚æœå­˜åœ¨ä»»ä½•é¢å¤–çš„é€€å‡ºä»£ç ï¼ˆæ¯”å¦‚å¯èƒ½æ˜¯ç«æ€æ£€æµ‹ç›¸å…³çš„ä»£ç ï¼‰ï¼Œåˆ™è·³è¿‡å¼€æ”¾å¼å»¶è¿Ÿã€‚ â‘¤ !f.Nname.(*ir.Name).OnStack() å¦‚æœæœ‰ä»»ä½•å †åˆ†é…çš„ç»“æœå‚æ•°éœ€è¦å¤åˆ¶å›å®ƒä»¬çš„æ ˆæ§½ï¼Œä¹Ÿè·³è¿‡å¼€æ”¾å¼å»¶è¿Ÿã€‚ â‘¥ s.curfn.NumReturns*s.curfn.NumDefers 15 å¦‚æœå‡½æ•°çš„è¿”å›æ•°ä¹˜ä»¥å»¶è¿Ÿè°ƒç”¨æ•°å¤§äº 15ï¼Œè€ƒè™‘åˆ°æ¯ä¸ªé€€å‡ºç‚¹éƒ½è¦ç”Ÿæˆå»¶è¿Ÿè°ƒç”¨ï¼Œå¹¶ä¸”å¼€æ”¾å¼å»¶è¿Ÿå¯¹äºå°å‡½æ•°ï¼ˆæ²¡æœ‰å¤šä¸ªè¿”å›ï¼‰çš„æ€§èƒ½æå‡æœ€ä¸ºé‡è¦ï¼Œæ‰€ä»¥åœ¨è¿™ç§æƒ…å†µä¸‹ä¹Ÿä¸ä½¿ç”¨å¼€æ”¾å¼å»¶è¿Ÿã€‚ å †ä¸Šåˆ†é… å½“ä¸æ»¡è¶³å¼€æ”¾ç¼–ç å’Œæ ˆä¸Šåˆ†é…çš„æ—¶å€™ï¼Œé»˜è®¤å°±æ˜¯å †ä¸Šåˆ†é…ï¼ˆheap-allocatedï¼‰ï¼Œæ€§èƒ½æœ€å·®ï¼Œè¿™é‡Œä¸åšåˆ†æã€‚ ä»¥ä¸Šå°±æ˜¯æœ¬æ–‡å…³äº Go è¯­è¨€ä¸­ defer å…³é”®å­—çš„å…·ä½“åˆ†æï¼ŒHappy Coding! Peace~ å‚è€ƒ æ·±å…¥ç†è§£ Go è¯­è¨€ Go è¯­è¨€åº•å±‚åŸç†å‰–æ Go è¯­è¨€è®¾è®¡ä¸å®ç° ChatGPT4","tags":["Go"],"categories":["Go"]},{"title":"æ·±å…¥ Go è¯­è¨€æ ¸å¿ƒï¼šç»“æ„ä½“çš„å…¨æ–¹ä½è§£æ","path":"/2024/03/09/go-struct/","content":"Go è¯­è¨€ï¼Œä½œä¸ºä¸€ç§é«˜æ•ˆã€é™æ€ç±»å‹çš„ç¼–ç¨‹è¯­è¨€ï¼Œè‡ªå…¶é—®ä¸–ä»¥æ¥ä¾¿ä»¥å…¶å¹¶å‘å¤„ç†èƒ½åŠ›å’Œç®€æ´çš„è¯­æ³•ç»“æ„å¹¿å—å¼€å‘è€…æ¬¢è¿ã€‚è™½ç„¶ Go ä¸æ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„é¢å‘å¯¹è±¡è¯­è¨€ï¼Œå®ƒå´ä»¥ç‹¬ç‰¹çš„æ–¹å¼æ”¯æŒé¢å‘å¯¹è±¡ç¼–ç¨‹çš„æ ¸å¿ƒæ¦‚å¿µï¼Œå…¶ä¸­ç»“æ„ä½“æ‰®æ¼”äº†éå¸¸å…³é”®çš„è§’è‰²ã€‚ ç»“æ„ä½“åœ¨ Go è¯­è¨€ä¸­æ˜¯ä¸€ç§å¤åˆæ•°æ®ç±»å‹ï¼Œå…è®¸æˆ‘ä»¬å°†ä¸åŒç±»å‹çš„æ•°æ®èšåˆåˆ°ä¸€èµ·ã€‚å®ƒä¸ä»…æé«˜äº†æ•°æ®ç®¡ç†çš„æ•ˆç‡å’Œé€»è¾‘æ¸…æ™°åº¦ï¼Œè¿˜æ˜¯ Go è¯­è¨€ä¸­å®ç°é¢å‘å¯¹è±¡ç¼–ç¨‹æ€æƒ³å¦‚å°è£…ã€ç»„åˆç­‰æ¦‚å¿µçš„åŸºçŸ³ã€‚äº†è§£å’ŒæŒæ¡ç»“æ„ä½“çš„ä½¿ç”¨ï¼Œå¯¹äºæ·±å…¥ç†è§£ Go è¯­è¨€çš„ç‰¹æ€§å’Œç¼–å†™é«˜æ•ˆã€å¯ç»´æŠ¤çš„ Go ä»£ç è‡³å…³é‡è¦ã€‚ æœ¬æ–‡å°†å¸¦æ‚¨å…¨é¢æ·±å…¥åœ°æ¢ç´¢ Go è¯­è¨€ä¸­ç»“æ„ä½“çš„å„ä¸ªæ–¹é¢ï¼Œä»åŸºæœ¬å®šä¹‰ã€åˆå§‹åŒ–å’Œä½¿ç”¨ï¼Œåˆ°é«˜çº§ç‰¹æ€§å¦‚ç»“æ„ä½“çš„ç»„åˆã€æ–¹æ³•å®šä¹‰ã€å†…å­˜å¯¹é½ç­‰ï¼Œæ¯ä¸€ä¸ªç»†èŠ‚éƒ½å°†ä¸€ä¸€å±•å¼€ã€‚æ— è®ºæ‚¨æ˜¯ Go è¯­è¨€çš„æ–°æ‰‹ï¼Œè¿˜æ˜¯æœ‰ä¸€å®šç»éªŒçš„å¼€å‘è€…ï¼Œç›¸ä¿¡æœ¬æ–‡éƒ½èƒ½ä¸ºæ‚¨æä¾›æœ‰ä»·å€¼çš„è§è§£å’Œå¸®åŠ©ã€‚è®©æˆ‘ä»¬ä¸€èµ·æ¢ç´¢ Go ç»“æ„ä½“çš„å¥¥ç§˜ï¼Œæ­å¼€å…¶èƒŒåçš„åŸç†ï¼Œä¼˜åŒ–æˆ‘ä»¬çš„ä»£ç ç»“æ„ï¼Œæå‡ç¼–ç¨‹æ•ˆç‡ã€‚ ç‰ˆæœ¬å£°æ˜ Go 1.22.1 gopkg.in/yaml.v3 v3.0.1 os: m2max å…¨æ–‡æ¦‚è§ˆ Go è¯­è¨€ç»“æ„ä½“ 1. ç»“æ„ä½“çš„åŸºæœ¬ä½¿ç”¨ 1.1 å®šä¹‰ç»“æ„ä½“ ç»“æ„ä½“ç±»å‹çš„å®šä¹‰å½¢å¼å¦‚ä¸‹ï¼š type T struct Field T1, Field T2, .... FieldN Tn, æ¯”å¦‚ï¼š type Person struct Name string Age int ExtraInfo map[string]interface ç»“æ„ä½“å†…éƒ¨ï¼Œä¹Ÿå¯ä»¥å†…åµŒåŒ¿åç»“æ„ä½“ï¼Œå¦‚ï¼š type Person struct Name string Age int School struct Name string Address string Phone string ä½†æ˜¯ï¼æ³¨æ„ï¼Œå¦‚æœ Person ä¸­åŒ…å«äº† Person å‘¢ï¼Ÿ type Person struct person Person è¿™é‡Œä¼šæŠ¥é”™ï¼šä¸å…è®¸å¼•ç”¨è‡ªèº«ã€‚ ./main.go:5:6: invalid recursive type: Person refers to itself è¿™æ˜¯å› ä¸º Go è¯­è¨€åœ¨ç¼–è¯‘æ—¶éœ€è¦çŸ¥é“æ¯ä¸ªç±»å‹çš„ç¡®åˆ‡å¤§å°ï¼Œä»¥ä¾¿æ­£ç¡®åœ°åˆ†é…å†…å­˜ã€‚ä½†åœ¨è¿™ä¸ªå®šä¹‰ä¸­ï¼Œå› ä¸º Person åŒ…å«è‡ªèº«ï¼Œç¼–è¯‘å™¨æ— æ³•ç¡®å®š Person çš„å¤§å°ï¼Œå› æ­¤ä¼šæŠ¥é”™ã€‚ å¦‚æœä½ éœ€è¦åœ¨ä¸€ä¸ªç»“æ„ä½“ä¸­å¼•ç”¨ç›¸åŒç±»å‹çš„æ•°æ®ï¼Œä½ åº”è¯¥ä½¿ç”¨æŒ‡é’ˆã€‚æŒ‡é’ˆçš„å¤§å°æ˜¯å›ºå®šçš„ï¼Œå› æ­¤ç¼–è¯‘å™¨å¯ä»¥ç¡®å®šç»“æ„ä½“çš„å¤§å°ã€‚ type Person struct person *Person 1.2 åˆå§‹åŒ–ç»“æ„ä½“ å‡è®¾æˆ‘ä»¬æœ‰ä»¥ä¸‹ç»“æ„ä½“ï¼š type Person struct Name string\tAge int\tExtraInfo map[string]interface å¯ä»¥æœ‰ä»¥ä¸‹å‡ ç§åˆå§‹åŒ–ï¼š // é€ä¸ªå­—æ®µèµ‹å€¼ï¼Œé¡ºåºä¸é‡è¦ï¼Œä¹Ÿå¯ä»¥åªèµ‹å€¼éƒ¨åˆ†å­—æ®µperson1 := Person Age: 18, Name: hedon, ExtraInfo: make(map[string]interface),fmt.Println(person1) // hedon 18 map[]// å¯ä»¥ä¸æŒ‡å®šå­—æ®µï¼Œä¸¥æ ¼æŒ‰ç…§é¡ºåºperson2 := Personhedon2, 19, make(map[string]interface)fmt.Println(person2) // hedon2 19 map[]// é»˜è®¤åˆå§‹åŒ–ï¼Œåˆ™ç»“æ„ä½“ä¸­çš„æ¯ä¸ªå­—æ®µéƒ½ä¼šè¢«é»˜è®¤èµ‹äºˆå…¶å¯¹åº”ç±»å‹çš„â€œé›¶å€¼â€var person3 Personfmt.Println(person3) // 0 map[]fmt.Println(person3.ExtraInfo == nil) // true// ä¹Ÿå¯ä»¥ä½¿ç”¨ new() æˆ– æ¥åˆå§‹åŒ–å¹¶è¿”å›æŒ‡é’ˆperson3 := new(Person)fmt.Println(person3) // 0 map[] 1.3 ç©ºç»“æ„ä½“ æœ‰ä¸€ç§ç‰¹æ®Šçš„ç»“æ„ä½“ï¼Œå®ƒä¸€ä¸ªå­—æ®µéƒ½æ²¡æœ‰ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œç©ºç»“æ„ä½“â€ï¼š type Empty struct ç©ºç»“æ„ä½“éå¸¸ç‰¹æ®Šï¼Œå®ƒä¸å æ®ä»»ä½•ç©ºé—´ï¼ä½ å¯ä»¥è‡ªå·±éªŒè¯ä¸€ä¸‹ï¼š type Empty structfunc main() fmt.Println(the size of empty:, unsafe.Sizeof(Empty)) // the size of empty: 0 è€Œä¸”ï¼Œæ‰€æœ‰ç©ºç»“æ„ä½“çš„åœ°å€éƒ½ä¸€æ ·ï¼š type Empty structtype Empty1 structfunc main() e := Empty\te1 := Empty1\tfmt.Printf(the address of empty: %p , e) // the address of empty: 0x10460f520\tfmt.Printf(the address of empty1: %p , e1) // the address of empty1: 0x10460f520 è¿™æ˜¯å› ä¸º Go è¯­è¨€ä¸ºæ‰€æœ‰å¤§å°ä¸º 0 çš„å˜é‡éƒ½æŒ‡å‘äº†åŒä¸€ä¸ªå€¼ï¼š // base address for all 0-byte allocationsvar zerobase uintptr å¥½å¤„å°±æ˜¯å‡å°‘äº†å†…å­˜çš„æµªè´¹ã€‚å…¸å‹çš„ç”¨æ³•å°±æ˜¯æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ map æ¥å®ç° Setï¼Œè¿™æ ·å°±åªèŠ±è´¹äº†å­˜å‚¨é”®çš„ç©ºé—´ï¼Œè€Œå€¼ä¸å ç”¨ä»»ä½•ç©ºé—´ã€‚ type Set = map[string]struct 1.4 è®¿é—®å’Œä¿®æ”¹ç»“æ„ä½“ ç»“æ„ä½“å±æ€§çš„å¯è§æ€§è·Ÿ Go åŒ…çš„å¯è§æ€§è§„åˆ™ä¸€æ ·ï¼šå¤§å†™å¯¹åŒ…å¤–å¯è§ï¼Œå°å†™ä»…åŒ…å†…å¯è§ã€‚ ä½¿ç”¨ . è®¿é—®å’Œä¿®æ”¹ç»“æ„ä½“ä¸­çš„å±æ€§ã€‚ Go è¯­è¨€ä¸­åªæœ‰â€œå€¼ä¼ é€’â€ï¼Œæ‰€ä»¥å¦‚æœä½ è¦å°†ç»“æ„ä½“ç¤ºä¾‹ä¼ å…¥ä¸€ä¸ª func è¿›è¡Œä¿®æ”¹ï¼Œåˆ™éœ€è¦ä¼ å…¥å…¶å¼•ç”¨ã€‚ type Person struct Name string\tAge intfunc main() p := PersonName: hedon, Age: 18\tUpdatePersonName(p)\tfmt.Println(1:, p)\tUpdatePersonNameWithRef(p)\tfmt.Println(2:, p)func UpdatePersonName(p Person) p.Name = hedon-1func UpdatePersonNameWithRef(p *Person) p.Name = hedon-2 è¾“å‡ºï¼š 1: hedon 182: hedon-2 18 2. ç»“æ„ä½“çš„é«˜çº§ç‰¹æ€§ 2.1 ç»“æ„ä½“ç»„åˆ åœ¨ Go è¯­è¨€ä¸­ï¼Œå€¡å¯¼çš„æ˜¯â€œç»„åˆä¼˜äºç»§æ‰¿â€çš„å“²å­¦ï¼Œå³å€¡å¯¼ä½¿ç”¨ç»„åˆè€Œä¸æ˜¯ç»§æ‰¿æ¥å®ç°ä»£ç çš„å¤ç”¨ã€‚è¯¥ç†å¿µé¼“åŠ±å¼€å‘è€…é€šè¿‡ç»„åˆå’Œæ¥å£æ¥æ„å»ºçµæ´»ã€å¯ç»´æŠ¤çš„ä»£ç ï¼Œè€Œä¸æ˜¯ä¾èµ–äºæ›´ä¸¥æ ¼ã€æ›´æ˜“å‡ºé”™çš„ç»§æ‰¿å…³ç³»ã€‚è¿™ç§æ–¹å¼ä¿ƒè¿›äº†ä»£ç çš„è§£è€¦ï¼Œå¢å¼ºäº†ä»£ç çš„çµæ´»æ€§å’Œå¯é‡ç”¨æ€§ï¼ŒåŒæ—¶ä¹Ÿä½¿å¾—ä»£ç æ›´åŠ æ¸…æ™°å’Œæ˜“äºç†è§£ã€‚ åœ¨ Go ä¸­ï¼Œç»„åˆæ˜¯é€šè¿‡å°†ä¸€ä¸ªæˆ–å¤šä¸ªç±»å‹ï¼ˆé€šå¸¸æ˜¯ç»“æ„ä½“ï¼‰åµŒå…¥åˆ°å¦ä¸€ä¸ªç»“æ„ä½“ä¸­æ¥å®ç°çš„ã€‚è¿™ä½¿å¾—åµŒå…¥çš„ç±»å‹çš„æ–¹æ³•è¢«â€œæå‡â€åˆ°åŒ…å«å®ƒçš„ç»“æ„ä½“ä¸­ï¼Œå…è®¸ä½ è°ƒç”¨è¿™äº›æ–¹æ³•å°±åƒå®ƒä»¬æ˜¯å¤–éƒ¨ç»“æ„ä½“çš„ä¸€éƒ¨åˆ†ä¸€æ ·ã€‚ type Engine struct Power intfunc (e *Engine) Start() // å¯åŠ¨å¼•æ“çš„é€»è¾‘type Car struct Engine // é€šè¿‡ç»„åˆçš„æ–¹å¼åµŒå…¥ Engine// ç°åœ¨ Car å¯ä»¥ç›´æ¥è°ƒç”¨ Start æ–¹æ³•car := CarEnginePower: 100car.Start() // è°ƒç”¨çš„æ˜¯ Engine çš„ Start æ–¹æ³• 2.2 ç»“æ„ä½“çš„æ–¹æ³• å‡è®¾æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªç»“æ„ä½“ Personï¼š type Person struct Name string åœ¨ Go ä¸­ï¼Œä½ å¯ä»¥ä¸ºç»“æ„ä½“çš„å€¼æˆ–æŒ‡é’ˆå®ç°ç‰¹å®šçš„æ–¹æ³•ï¼š func(p Person) SetName(name string) string p.Name = name func(p *Person) SetName(name string) string p.Name = name è¿™ä¸¤è€…æœ€æ ¸å¿ƒçš„åŒºåˆ«æ˜¯ï¼šå½“ä½ ä¸ºç»“æ„ä½“çš„æŒ‡é’ˆç±»å‹å®šä¹‰æ–¹æ³•æ—¶ï¼Œè¯¥æ–¹æ³•ä¼šåœ¨åŸå§‹ç»“æ„ä½“å®ä¾‹ä¸Šæ“ä½œã€‚è¿™æ„å‘³ç€æ–¹æ³•å†…éƒ¨å¯¹ç»“æ„ä½“çš„ä»»ä½•ä¿®æ”¹éƒ½ä¼šå½±å“åˆ°åŸå§‹ç»“æ„ä½“ã€‚ æ‰€ä»¥è¿™ä¸¤æ®µä»£ç çš„è¾“å‡ºæ˜¯ä¸ä¸€æ ·çš„ï¼š func main() p := PersonName: hedon\tp.SetName(new_name)\tfmt.Println(p.Name) // name_namefunc (p *Person) SetName(name string) p.Name = name func main() p := PersonName: hedon\tp.SetName(new_name)\tfmt.Println(p.Name) // hedonfunc (p Person) SetName(name string) p.Name = name ä½†æ˜¯è¿™é‡Œæˆ‘æƒ³å†è¡¥å……ä¸¤ä¸ªå°ç‚¹ã€‚è¯·å…ˆæ€è€ƒä¸€ä¸‹ä¸‹é¢è¿™ä¸¤æ®µä»£ç æ˜¯å¦å¯ä»¥ç¼–è¯‘é€šè¿‡ï¼Ÿå¦‚æœå¯ä»¥è¾“å‡ºæ˜¯ä»€ä¹ˆï¼Ÿ func main() p := PersonName: hedon\tp.SetName(new_name)\tfmt.Println(person name after set:, p.Name)\tpt := reflect.TypeOf(p)\tfmt.Println(the number of persons method: , pt.NumMethod())\tp2 := Person\tpt = reflect.TypeOf(p2)\tfmt.Println(the number of persons method: , pt.NumMethod())func (p *Person) SetName(name string) p.Name = name func main() p := PersonName: hedon\tp.SetName(new_name)\tfmt.Println(person name after set:, p.Name)\tpt := reflect.TypeOf(p)\tfmt.Println(the number of persons method: , pt.NumMethod())\tp2 := Person\tpt = reflect.TypeOf(p2)\tfmt.Println(the number of persons method: , pt.NumMethod())func (p Person) SetName(name string) p.Name = name å¾ˆæ˜æ˜¾è¿™ä¸¤æ®µä»£ç çš„å”¯ä¸€åŒºåˆ«å°±æ˜¯ï¼Œç¬¬ä¸€æ®µä»£ç æˆ‘ä»¬æ˜¯ä¸º *Person å®ç°äº† SetName æ–¹æ³•ï¼Œè€Œç¬¬äºŒæ®µä»£ç æˆ‘ä»¬æ˜¯ä¸º Person å®ç°äº† SetName æ–¹æ³•ã€‚ä¸¤æ®µä»£ç æˆ‘ä»¬éƒ½æ‰“å°äº†è°ƒç”¨ SetName å p.name çš„å€¼ï¼Œä»¥åŠåˆ©ç”¨æ–¹å¼åˆ†åˆ«è·å– Person å’Œ *Person å®ç°çš„æ–¹æ³•ä¸ªæ•°ã€‚ ç¬¬ä¸€æ®µä»£ç çš„è¾“å‡ºå¦‚ä¸‹ï¼š person name after set: new_namethe number of persons method: 0the number of persons method: 1 ç¬¬äºŒæ®µä»£ç çš„è¾“å‡ºå¦‚ä¸‹ï¼š person name after set: hedonthe number of persons method: 1the number of persons method: 1 è¿™é‡Œæˆ‘ä»¬å¯ä»¥å¾—å‡º 2 ä¸ªç»“è®ºï¼š â‘  ç»“æ„ä½“çš„ä¿®æ”¹ä¾èµ–äºæ–¹æ³•æ¥æ”¶å™¨çš„ç±»å‹ï¼š å½“æ–¹æ³•çš„æ¥æ”¶å™¨ä¸ºå€¼ç±»å‹ï¼ˆPersonï¼‰æ—¶ï¼Œå¯¹ç»“æ„ä½“çš„ä¿®æ”¹ä¸ä¼šå½±å“åŸå§‹ç»“æ„ä½“å®ä¾‹ï¼Œå› ä¸ºæ–¹æ³•ä½œç”¨äºç»“æ„ä½“çš„å‰¯æœ¬ä¸Šã€‚ å½“æ–¹æ³•çš„æ¥æ”¶å™¨ä¸ºæŒ‡é’ˆç±»å‹ï¼ˆ*Personï¼‰æ—¶ï¼Œå¯¹ç»“æ„ä½“çš„ä¿®æ”¹ä¼šå½±å“åŸå§‹ç»“æ„ä½“å®ä¾‹ï¼Œå› ä¸ºæ–¹æ³•ä½œç”¨äºç»“æ„ä½“çš„å¼•ç”¨ä¸Šã€‚ â‘¡ æ–¹æ³•é›†ä¾èµ–äºæ¥æ”¶å™¨çš„ç±»å‹ï¼š ä¸ºå€¼ç±»å‹ï¼ˆPersonï¼‰å®ç°çš„æ–¹æ³•ï¼Œæ—¢å±äºå€¼ç±»å‹ä¹Ÿå±äºæŒ‡é’ˆç±»å‹ï¼ˆ*Personï¼‰çš„æ–¹æ³•é›†ã€‚ ä¸ºæŒ‡é’ˆç±»å‹ï¼ˆ*Personï¼‰å®ç°çš„æ–¹æ³•ï¼Œåªå±äºæŒ‡é’ˆç±»å‹çš„æ–¹æ³•é›†ã€‚ å¯¹äº â‘¡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ Plan9 æ±‡ç¼–ä»£ç ä¸€æ¢ç©¶ç«Ÿã€‚ æˆ‘ä»¬ä¸ºç¬¬ä¸€æ®µä»£ç æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š go build -gcflags -S main.go åœ¨è¾“å‡ºçš„æœ€ä¸Šé¢ï¼Œå¯ä»¥çœ‹åˆ°åªæœ‰ main.(*Person).GetNameã€‚ # command-line-argumentsmain.main STEXT size=128 args=0x0 locals=0x48 funcid=0x0 align=0x0 ...main.(*Person).GetName STEXT size=16 args=0x8 locals=0x0 funcid=0x0 align=0x0 leaf ... æˆ‘ä»¬å†æ¥ä¸ºç¬¬äºŒæ®µä»£ç æ‰§è¡Œç›¸åŒçš„å‘½ä»¤ã€‚å¯ä»¥åœ¨è¾“å‡ºçš„æœ€ä¸Šé¢ï¼Œçœ‹åˆ°ä¸ä»…æœ‰ main.Person.GetNameï¼Œè¿˜å¯ä»¥å‘ç°ç¼–è¯‘å™¨è‡ªåŠ¨å¸®æˆ‘ä»¬ç”Ÿæˆäº† main.(*Person).GetNameã€‚ # command-line-argumentsmain.main STEXT size=480 args=0x0 locals=0xe8 funcid=0x0 align=0x0\t...main.Person.SetName STEXT size=16 args=0x28 locals=0x0 funcid=0x0 align=0x0 leaf ...main.(*Person).SetName STEXT dupok size=128 args=0x18 locals=0x8 funcid=0x16 align=0x0\t... å¯¹äº â‘¡ï¼Œç¬”è€…å…¶å®æœ‰ä¸€ä¸ªä¸å¤ªç†è§£çš„åœ°æ–¹ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç ï¼š func main() p := PersonName: hedon\tp.SetName(new_name)\tfmt.Println(person name after set:, p.Name) // hedonfunc (p Person) SetName(name string) p.Name = name è¿™é‡Œ p æ˜¯å¼•ç”¨ç±»å‹ï¼Œä¸‹é¢å®ç°çš„æ˜¯ Person.SetNameï¼ŒæŒ‰ç…§æˆ‘ä»¬ä¸Šé¢çš„ç»“è®ºï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬å®ç° (*Person).SetNameã€‚æŒ‰ç…§è¿™ç§æ€è·¯ï¼Œè¾“å‡º new_name ä¹Ÿæ˜¯è§£é‡Šå¾—é€šçš„ã€‚å› ä¸ºæ—¢ç„¶æˆ‘ä»¬å£°æ˜çš„æ˜¯ä¸€ä¸ªå¼•ç”¨ç±»å‹ï¼Œé‚£ä¹ˆ p å®Œå…¨å¯ä»¥å»è°ƒç”¨è‡ªåŠ¨ç”Ÿæˆçš„ (*Person).SetNameã€‚ä½†æ˜¯æœ€ç»ˆçš„ç»“æœè¿˜æ˜¯è¾“å‡º hedonï¼Œæ‰€ä»¥è¿™é‡Œç¼–è¯‘å™¨è‡ªåŠ¨å¸®æˆ‘ä»¬å°† p è¿›è¡Œè§£å¼•ç”¨ï¼Œç„¶åè°ƒç”¨äº† Person.SetNameã€‚ è¿™æ˜¯æ¯”è¾ƒå›°æ‰°ç¬”è€…çš„ä¸€ä¸ªåœ°æ–¹ï¼Œæ¬¢è¿è¯„è®ºåŒºè®¨è®º~ å¯èƒ½ç¼–è¯‘å™¨è¿˜æ˜¯æ›´å¸Œæœ›å¯¹äºå¼€å‘è€…æ¥è¯´â€œæ‰€è§å³æ‰€å¾—â€ï¼Œæ—¢ç„¶å¼€å‘è€…å®ç°çš„æ˜¯ Person.SetNameï¼Œé‚£ä¹ˆå¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œåº”è¯¥å°±æ˜¯å¸Œæœ›ä¸å½±å“åŸå§‹ç»“æ„ä½“çš„å€¼ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨è¿˜æ˜¯é€‰æ‹©éµå¾ªè¿™ç§â€œæ„æ„¿â€ï¼Œä¸ä¹±æ“ä½œã€‚ 2.3 ç»“æ„ä½“æ¯”è¾ƒ Go å…è®¸ç›´æ¥æ¯”è¾ƒä¸¤ä¸ªç»“æ„ä½“å®ä¾‹ï¼Œä½†æœ‰ä¸€å®šçš„é™åˆ¶ï¼š å¯æ¯”è¾ƒæ€§ï¼šåªæœ‰å½“ç»“æ„ä½“ä¸­çš„æ‰€æœ‰å­—æ®µéƒ½æ˜¯å¯æ¯”è¾ƒçš„æ—¶ï¼Œç»“æ„ä½“æ‰æ˜¯å¯æ¯”è¾ƒçš„ã€‚åŸºæœ¬æ•°æ®ç±»å‹ï¼ˆå¦‚ intã€string ç­‰ï¼‰æ˜¯å¯æ¯”è¾ƒçš„ï¼Œä½†åˆ‡ç‰‡ã€æ˜ å°„ã€å‡½æ•°ç­‰ç±»å‹ä¸å¯æ¯”è¾ƒã€‚ ç›¸ç­‰æ€§æ£€æµ‹ï¼šå½“ä¸¤ä¸ªç»“æ„ä½“çš„å¯¹åº”å­—æ®µéƒ½ç›¸ç­‰æ—¶ï¼Œè¿™ä¸¤ä¸ªç»“æ„ä½“è¢«è®¤ä¸ºæ˜¯ç›¸ç­‰çš„ã€‚å¯ä»¥ä½¿ç”¨ == å’Œ != æ“ä½œç¬¦æ¥è¿›è¡Œæ¯”è¾ƒã€‚ ä¸‹é¢è¿™æ®µç¤ºä¾‹ï¼Œp3==p4 è¿”å›äº† trueï¼Œè¿™ç¬¦åˆæˆ‘ä»¬ä¸Šé¢æ€»ç»“çš„ç»“è®ºã€‚p1==p2 è¿”å›äº† falseï¼Œå› ä¸ºè¿™å…¶å®ä¸æ˜¯ç»“æ„ä½“ä¹‹é—´çš„æ¯”è¾ƒäº†ï¼Œè¿™æ˜¯æŒ‡é’ˆçš„æ¯”è¾ƒäº†ã€‚ p1 := PersonName: hedon, Age: 18p2 := PersonName: hedon, Age: 18fmt.Println(p1 == p2) // falsep3 := PersonName: hedon, Age: 18p4 := PersonName: hedon, Age: 18fmt.Println(p3 == p4) // true ç»“æ„ä½“çš„æ¯”è¾ƒåªæ”¯æŒ == å’Œ !=ï¼Œä¸æ”¯æŒ å’Œ ç­‰å…¶ä»–è¿ç®—ç¬¦çš„æ¯”è¾ƒã€‚è€Œ Go è¯­è¨€åˆä¸æ”¯æŒæ¯”è¾ƒç¬¦é‡è½½ã€‚æ‰€ä»¥å¦‚æœä½ è¦æ¯”è¾ƒä¸¤ä¸ªç»“æ„ä½“çš„å¤§å°ï¼Œé‚£ä¹ˆåªèƒ½è‡ªè¡Œå°è£…ç±»å‹ compare çš„å‡½æ•°ã€‚åœ¨è¿™æˆ‘ä»¬æ’åºç»“æ„ä½“æ•°ç»„æˆ–åˆ‡ç‰‡çš„æ—¶å€™ï¼Œç»å¸¸ä½¿ç”¨åˆ°ï¼Œæ¯”å¦‚æˆ‘ä»¬å¸Œæœ›æŒ‰ Age å­—æ®µä»å°åˆ°å¤§æ’åºï¼š sort.Slice(persons, func(i, j int) bool return persons[i].Age persons[j].Age) 2.4 ç»“æ„ä½“å¤åˆ¶ åœ¨ Go ä¸­ï¼Œç»“æ„ä½“ä¹Ÿæ˜¯å€¼ç±»å‹ï¼Œè¿™æ„å‘³ç€å½“å®ƒä»¬è¢«èµ‹å€¼ç»™æ–°çš„å˜é‡æˆ–ä½œä¸ºå‡½æ•°å‚æ•°ä¼ é€’æ—¶ï¼Œå®é™…ä¸Šæ˜¯è¿›è¡Œäº†ä¸€æ¬¡æ·±æ‹·è´ï¼š å€¼å¤åˆ¶ï¼šå½“å°†ä¸€ä¸ªç»“æ„ä½“èµ‹å€¼ç»™ä¸€ä¸ªæ–°å˜é‡æ—¶ï¼Œæ–°å˜é‡ä¼šè·å¾—åŸå§‹ç»“æ„ä½“çš„ä¸€ä¸ªå‰¯æœ¬ï¼Œå®ƒä»¬åœ¨å†…å­˜ä¸­å æœ‰ä¸åŒçš„ä½ç½®ã€‚ ç‹¬ç«‹æ€§ï¼šå› ä¸ºæ˜¯æ·±æ‹·è´ï¼Œæ‰€ä»¥åŸå§‹ç»“æ„ä½“å’Œå‰¯æœ¬ç»“æ„ä½“æ˜¯å®Œå…¨ç‹¬ç«‹çš„ï¼›ä¿®æ”¹å…¶ä¸­ä¸€ä¸ªä¸ä¼šå½±å“å¦ä¸€ä¸ªã€‚ type Point struct X, Y intoriginal := Point1, 2copy := originalcopy.X = 3fmt.Println(original) // 1, 2fmt.Println(copy) // 3, 2 3. ç»“æ„ä½“ä¸æ¥å£ åœ¨ Go è¯­è¨€ä¸­ï¼Œå¦‚æœä¸€ä¸ªç±»å‹å®ç°äº†æ¥å£ä¸­æ‰€æœ‰çš„æ–¹æ³•ï¼Œåˆ™è¿™ä¸ªç±»å‹å°±å®ç°äº†è¯¥æ¥å£ã€‚å…³äºæ¥å£éƒ¨åˆ†çš„çŸ¥è¯†ç‚¹ï¼Œæ¯”å¦‚æ¥å£å®šä¹‰ã€å¤šæ€å’Œæ–­è¨€ç­‰ï¼Œæœ¬æ–‡å°±ä¸èµ˜è¿°äº†ã€‚ åœ¨è¿™é‡Œæˆ‘ä¸»è¦æƒ³ä»å¦å¤–ä¸€ä¸ªè§’åº¦ç»§ç»­æ¥éªŒè¯å‰é¢æˆ‘ä»¬æ€»ç»“çš„ï¼šä¸ºå€¼ç±»å‹ï¼ˆPersonï¼‰å®ç°çš„æ–¹æ³•ï¼Œæ—¢å±äºå€¼ç±»å‹ä¹Ÿå±äºæŒ‡é’ˆç±»å‹ï¼ˆ*Personï¼‰çš„æ–¹æ³•é›†ã€‚ è¯·çœ‹è¿™æ®µä»£ç ï¼š package mainimport fmttype Person interface GetName() stringtype Man struct Name stringfunc (m Man) GetName() string return m.Namefunc PrintPersonName(p Person) fmt.Println(p.GetName())func main() m1 := ManName: hedon1\tPrintPersonName(m1)\tm2 := ManName: hedon2\tPrintPersonName(m2) è¿™æ®µä»£ç æˆ‘ä»¬å®šä¹‰äº† Person æ¥å£ï¼Œå®ƒåªæœ‰ä¸€ä¸ªæ–¹æ³• GetNameã€‚ç„¶åæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªç»“æ„ä½“ Manï¼Œå¹¶ä¸ºå®ƒçš„å€¼ç±»å‹å®ç°äº† Person æ¥å£ã€‚é€šè¿‡æˆ‘ä»¬ä¸Šé¢çš„ç»“è®ºï¼Œè¿™é‡Œ Man å’Œ *Man å…¶å®éƒ½å®ç°äº† Person æ¥å£ï¼Œæ‰€ä»¥ä¸Šé¢çš„ä»£ç æ˜¯å¯ä»¥ç¼–è¯‘é€šè¿‡çš„ã€‚ å¦‚æœæ”¹æˆä¸ºæŒ‡é’ˆç±»å‹å®ç°æ¥å£å‘¢ï¼Ÿä½ å¯ä»¥è¯•ä¸€ä¸‹~ func (m *Man) GetName() string return m.Name 4. æ³›å‹ç»“æ„ä½“ Go è¯­è¨€åœ¨å…¶ 1.18 ç‰ˆæœ¬ä¸­å¼•å…¥äº†æ³›å‹æ”¯æŒï¼Œè¿™åŒ…æ‹¬äº†å¯¹æ³›å‹ç»“æ„ä½“çš„æ”¯æŒã€‚é€šè¿‡ä½¿ç”¨æ³›å‹ï¼Œä½ å¯ä»¥åˆ›å»ºæ›´çµæ´»å’Œå¯é‡ç”¨çš„æ•°æ®ç»“æ„å’Œå‡½æ•°ã€‚ type Container[T any] struct items []T å¯ä»¥çœ‹åˆ° Go è¯­è¨€ç”¨ [] æ¥å®ç°æ³›å‹ï¼Œè€Œä¸åƒå…¶ä»–è¯­è¨€ä¸€æ ·ç”¨ ï¼ŒçœŸæ˜¯å–œæ¬¢æç‰¹æ®Šå•Š ğŸ¤¡ï¼Œåˆä¸‘åˆå®¹æ˜“è·Ÿ map å’Œ slice æ··æ·†ã€‚ 5. ç»“æ„ä½“çš„æ ‡ç­¾ï¼ˆTagï¼‰ åœ¨ç»“æ„ä½“å­—æ®µåé¢ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ `` æ¥æŒ‡å®šæ ‡ç­¾ï¼Œè¿™å…è®¸æˆ‘ä»¬å¯¹ç»“æ„ä½“å®šåˆ¶åŒ–ä¸€äº›å¸¸ç”¨æ“ä½œï¼Œæœ€ç»å…¸çš„å°±æ˜¯åºåˆ—åŒ–ä¸ååºåˆ—åŒ–ã€‚ 5.1 åºåˆ—åŒ–ä¸ååºåˆ—åŒ– å¯¹äºå¸¸è§çš„æ•°æ®ç»“æ„ï¼Œå¦‚ jsonã€yamlã€xml æˆ– tomlï¼Œæˆ‘ä»¬éƒ½å¯ä»¥é€šè¿‡åœ¨ç»“æ„ä½“ä¸­æŒ‡å®šæ ‡ç­¾ï¼Œç„¶åä½¿ç”¨å¯¹åº”è§£æåº“è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚æ¯”å¦‚ï¼š package mainimport (\tencoding/json\tfmt)type Person struct Name string `json:name`\tAge int `json:age`func main() p := PersonName: hedon, Age: 18\tbs, _ := json.Marshal(p) // åºåˆ—åŒ–\tfmt.Println(string(bs)) // name:hedon,age:18\tnewP := Person\t_ = json.Unmarshal(bs, newP) // ååºåˆ—åŒ–\tfmt.Println(newP) // hedon 18 åœ¨ç¬”è€…çš„å®è·µè¿‡ç¨‹ä¸­ï¼Œåœ¨ç»“æ„ä½“ç»„åˆçš„åœºæ™¯ä¸‹ï¼Œä¸åŒæ•°æ®æ ¼å¼çš„è§£æä¼šæœ‰ä¸€äº›å°å·®åˆ«ï¼Œè¿™åœ¨å®æˆ˜è¿‡ç¨‹ä¸­ä½ éœ€è¦é‡ç‚¹å…³æ³¨å’ŒéªŒè¯ã€‚æ¯”å¦‚ json å’Œ yaml å°±ä¼šæœ‰ä¸€äº›ä¸åŒã€‚ æ¯”å¦‚è¯´æˆ‘è¿™é‡Œå®šä¹‰äº†ä¸‹é¢ 2 ä¸ªç»“æ„ä½“ï¼Œå…¶ä¸­ Person ç»„åˆäº† Schoolï¼š type Person struct Name string `json:name yaml:name`\tAge int `json:age yaml:age`\tSchooltype School struct SchoolName string `json:school_name yaml:school_name`\tSchoolAddress string `json:school_address json:school_address` å®ƒä»¬éƒ½åŠ ä¸Šäº† json å’Œ yaml æ ‡ç­¾ï¼Œå¯¹äº json ç±»å‹ï¼Œä½ å¯ä»¥ç”¨æ ‡å‡†åº“çš„ encoding/json æ¥è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œè€Œ yaml ä½ å¯ä»¥ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ï¼šgo-yamlã€‚ å…ˆæ¥çœ‹ç³»åˆ—åŒ–ç»“æœï¼š func main() p := PersonName: hedon, Age: 18, School: SchoolSchoolName: nb_school, SchoolAddress: a_good_school_place\tbs, _ := json.Marshal(p)\tfmt.Println(json: , string(bs))\tbs, _ = yaml.Marshal(p)\tfmt.Println(yaml: , string(bs)) è¾“å‡ºå¦‚ä¸‹ï¼š json: name:hedon,age:18,school_name:nb_school,school_address:a_good_school_placeyaml: name: hedon age: 18 school: school_name: nb_school school_address: a_good_school_place é€šè¿‡è§‚å¯Ÿä½ å¯ä»¥å‘ç°å“ˆï¼Œåœ¨ json ä¸­ï¼Œç»„åˆçš„æ—¶å€™ï¼ˆæ²¡æœ‰ç»™ School åŠ æ ‡ç­¾ï¼‰ç›´æ¥å°† School å¹³é“ºåœ¨ Person ä¸­ï¼Œæ‰€ä»¥åœ¨åºåˆ—åŒ–çš„ç»“æœä¸­ï¼Œæ‰¾ä¸åˆ° \"school\": ã€‚è€Œåœ¨ yaml ä¸­ï¼Œå¹¶ä¸æ˜¯ç›´æ¥å¹³é“ºçš„ã€‚ è¿™ä¸ªåŒºåˆ«åœ¨ä½ è§£æé…ç½®æ–‡ä»¶çš„æ—¶å€™å°¤å…¶é‡è¦ï¼Œå¦‚æœä¸æ³¨æ„ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šå¯¼è‡´é…ç½®è§£æå¤±è´¥ã€‚ æˆ‘å‡†å¤‡äº† 4 ä¸ªé…ç½®æ–‡ä»¶ï¼Œåˆ†åˆ«æ˜¯ï¼š // person1.json name: hedon_json, age: 18, school: school_name: nb_json_school, school_address: a_good_place_in_json # person1.yamlname: hedon_yamlage: 18school: school_name: nb_yaml_school school_address: a_good_price_in_yaml // person2.json name: hedon_json, age: 18, school_name: nb_json_school, school_address: a_good_place_in_json # person2.yamlname: hedon_yamlage: 18school_name: nb_yaml_schoolschool_address: a_good_price_in_yaml è§£æä»£ç å¦‚ä¸‹ï¼š func main() filenames := []stringperson1.json, person1.yaml, person2.json, person2.yaml\tfor i, fn := range filenames bs := readFileIntoBytes(fn) p := Person if i%2 == 0 _ = json.Unmarshal(bs, p) else _ = yaml.Unmarshal(bs, p) fmt.Printf(%s - %v , fn, p)\tfunc readFileIntoBytes(filename string) []byte f, err := os.Open(filename)\tif err != nil panic(err) bs, _ := io.ReadAll(f)\treturn bs è¾“å‡ºï¼š person1.json - hedon_json 18 person1.yaml - hedon_yaml 18 nb_yaml_school a_good_price_in_yamlperson2.json - hedon_json 18 nb_json_school a_good_place_in_jsonperson2.yaml - hedon_yaml 18 å¦‚æœç»™ School å­—æ®µåŠ ä¸Š json tag çš„è¯ï¼Œç»“æœåˆæ˜¯ä¸åŒï¼š type Person struct Name string `json:name yaml:name`\tAge int `json:age yaml:age`\tSchool `json:school yaml:school` è¾“å‡ºï¼š person1.json - hedon_json 18 nb_json_school a_good_place_in_jsonperson1.yaml - hedon_yaml 18 nb_yaml_school a_good_price_in_yamlperson2.json - hedon_json 18 person2.yaml - hedon_yaml 18 å¯ä»¥çœ‹åˆ°å—å½±å“çš„åªæœ‰ jsonã€‚ åˆ°è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ€»ç»“ï¼šåœ¨ç»„åˆåœºæ™¯ä¸‹ï¼Œå¦‚æœä¸æ˜ç¡®æŒ‡å®š tagï¼Œyaml è§£ææœŸæœ›å­—æ®µæ˜¯åµŒå¥—çš„ï¼Œè€Œ json è§£ææœŸæœ›å­—æ®µæ˜¯å¹³é“ºçš„ã€‚ 5.2 è‡ªå®šä¹‰ Tag åœ¨ Go ä¸­ï¼Œä½ å¯ä»¥ä¸ºç»“æ„ä½“å­—æ®µå®šä¹‰ä»»æ„çš„æ ‡ç­¾ã€‚è¿™äº›æ ‡ç­¾åœ¨ç¼–è¯‘æ—¶ä¼šè¢«å­˜å‚¨ï¼Œå¹¶ä¸”å¯ä»¥åœ¨è¿è¡Œæ—¶é€šè¿‡åå°„ï¼ˆreflectionï¼‰æ¥è®¿é—®ã€‚ å‡è®¾æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªåä¸º check çš„æ ‡ç­¾ï¼Œå®ƒç”¨äºæˆ‘ä»¬å¯¹ç»“æ„ä½“å­—æ®µçš„æ£€æŸ¥ï¼Œå‡è®¾æˆ‘ä»¬è¿™ä¸ªæ ‡ç­¾æ”¯æŒä»¥ä¸‹åŠŸèƒ½ï¼š check:\"strnoempty\": å­—ç¬¦ä¸²ä¸å¯ä»¥ä¸ºç©ºã€‚ å‡å¦‚åŠ å…¥ check æ ‡ç­¾çš„ Person ç»“æ„ä½“å¦‚ä¸‹ï¼š type Person struct Name string `check:strnoempty` æˆ‘ä»¬æ¥ä¸º check å®ç°è§£æå‡½æ•°ï¼š func CheckPerson(p Person) error pt := reflect.TypeOf(p)\tpv := reflect.ValueOf(p)\tfor i := 0; i pt.NumField(); i++ field := pt.Field(i) tagValue := field.Tag.Get(check) if tagValue == continue if field.Type.Kind() == reflect.String tagValue == strnoempty if err := checkStrNoEmpty(field.Name, pv.Field(i).Interface()); err != nil return err return nilfunc checkStrNoEmpty(fieldName string, v any) error s, ok := v.(string)\tif !ok return fmt.Errorf(%v is not string, v) if s == return fmt.Errorf([check] %s should not be empty, fieldName) return nil æµ‹è¯•å¦‚ä¸‹ï¼š func main() p1 := Person\tp2 := PersonName: hedon\tfmt.Println(CheckPerson(p1)) // [check] Name should not be empty\tfmt.Println(CheckPerson(p2)) // nil 6. ç»“æ„ä½“å†…å­˜å¯¹é½ åœ¨æœ¬å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†æ¢è®¨ Go è¯­è¨€ç»“æ„ä½“çš„å†…å­˜ç»“æ„å’Œå¯¹é½ç­–ç•¥ã€‚ 6.1 é—®é¢˜å¼•å‡º æ€è€ƒä¸‹é¢è¿™æ®µä»£ç çš„è¾“å‡ºï¼š type S1 struct num2 int8\tnum1 int16\tflag booltype S2 struct num1 int8\tflag bool\tnum2 int16func main() fmt.Println(unsafe.Sizeof(S1))\tfmt.Println(unsafe.Sizeof(S2)) ä¸ºä»€ä¹ˆä»…æ˜¯å­—æ®µé¡ºåºä¸åŒï¼ŒS1 å’Œ S2 çš„å¤§å°å°±ä¸ä¸€æ ·äº†ï¼Ÿ æˆ‘ä»¬å¯ä»¥å†™ä¸ªç®€å•çš„ç¨‹åºæ¥è¾“å‡º S1 å’Œ S2 çš„å†…å­˜ç»“æ„ï¼š func main() s1 := S1\ts2 := S2\tfmt.Print(s1: )\tprintMemory(s1)\tfmt.Print(s2: )\tprintMemory(s2)func printMemory(a any) t := reflect.TypeOf(a)\tmem := make([]int, int(t.Size()))\tfor i := 0; i t.NumField(); i++ field := t.Field(i) offset := int(field.Offset) size := int(field.Type.Size()) for j := 0; j size; j++ mem[j+offset] = i + 1 fmt.Println(mem) è¾“å‡ºï¼š s1: [1 0 2 2 3 0]s2: [1 2 3 3] å…¶ä¸­ 1ã€2ã€3 åˆ†åˆ«æ›¿ä»£ç»“æ„ä½“ä¸­çš„ç¬¬ 1/2/3 ä¸ªå­—æ®µæ‰€å ç”¨çš„å†…å­˜ã€‚è¿™é‡Œå¯ä»¥çœ‹åˆ° s1 çš„é•¿åº¦æ˜¯ 6 å­—èŠ‚ï¼Œè€Œ s2 æ˜¯ 4 å­—èŠ‚ã€‚è¿™é‡Œ s1 æ¯” s2 å¤šå‡ºçš„ 2 ä¸ªå­—èŠ‚å°±æ˜¯è¿™ä¸¤ä¸ªå¡«å……çš„ 0ã€‚è¿™è€Œ 2 ä¸ªå­—èŠ‚çš„å¡«å……ï¼Œå°±æ˜¯ä¸ºäº†å†…å­˜å¯¹é½ã€‚ 6.2 å†…å­˜å¯¹é½ å¦‚ä¸Šåˆ†æï¼Œs1 çš„å†…å­˜ç»“æ„å¦‚ä¸‹ï¼š s1 å†…å­˜ç»“æ„ å¦‚æœæ²¡æœ‰å†…å­˜å¯¹é½å‘¢ï¼Ÿs1 çš„ç»“æ„å¯èƒ½å¦‚ä¸‹ï¼š æ²¡æœ‰å†…å­˜å¯¹é½çš„ s1 å†…å­˜ç»“æ„ å¦‚æœæ˜¯ 16 ä½ç³»ç»Ÿçš„è¯ï¼Œé‚£ä¹ˆæ²¡æœ‰å†…å­˜å¯¹é½çš„æƒ…å†µä¸‹ï¼Œè¦è®¿é—® s1.num2 å­—æ®µï¼Œå°±éœ€è¦è·¨è¿‡ 2 ä¸ªç³»ç»Ÿå­—é•¿çš„å†…å­˜ï¼Œæ•ˆç‡å°±ä½äº†ã€‚å…·ä½“æ¥è¯´ï¼Œå†…å­˜å¯¹é½æ˜¯è®¡ç®—æœºå†…å­˜åˆ†é…çš„ä¸€ç§ä¼˜åŒ–æ–¹å¼ï¼Œç”¨äºç¡®ä¿æ•°æ®ç»“æ„çš„å­˜å‚¨æŒ‰ç…§ç‰¹å®šçš„å­—èŠ‚è¾¹ç•Œå¯¹é½ã€‚è¿™ç§å¯¹é½æ˜¯ä¸ºäº†æé«˜è®¡ç®—æœºå¤„ç†æ•°æ®çš„æ•ˆç‡ã€‚ 6.3 å¯¹é½ç³»æ•° å¯¹é½ç³»æ•°ï¼šå˜é‡çš„å†…å­˜åœ°å€å¿…é¡»è¢«å¯¹é½ç³»æ•°æ•´é™¤ã€‚ unsafe.Alignof(): å¯ä»¥æŸ¥çœ‹å€¼åœ¨å†…å­˜ä¸­çš„å¯¹é½ç³»æ•°ã€‚ 6.4 åŸºæœ¬ç±»å‹å¯¹é½ fmt.Printf(bool size: %d, align: %d , unsafe.Sizeof(bool(true)), unsafe.Alignof(bool(true)))fmt.Printf(byte size: %d, align: %d , unsafe.Sizeof(byte(0)), unsafe.Alignof(byte(0)))fmt.Printf(int8 size: %d, align: %d , unsafe.Sizeof(int8(0)), unsafe.Alignof(int8(0)))fmt.Printf(int16 size: %d, align: %d , unsafe.Sizeof(int16(0)), unsafe.Alignof(int16(0)))fmt.Printf(int32 size: %d, align: %d , unsafe.Sizeof(int32(0)), unsafe.Alignof(int32(0)))fmt.Printf(int64 size: %d, align: %d , unsafe.Sizeof(int64(0)), unsafe.Alignof(int64(0))) è¾“å‡ºï¼š bool size: 1, align: 1byte size: 1, align: 1int8 size: 1, align: 1int16 size: 2, align: 2int32 size: 4, align: 4int64 size: 8, align: 8 ç»“è®ºï¼šåŸºæœ¬ç±»å‹çš„å¯¹é½ç³»æ•°è·Ÿå®ƒçš„é•¿åº¦ä¸€è‡´ã€‚ åŸºæœ¬ç±»å‹å†…å­˜å¯¹é½ 6.5 ç»“æ„ä½“å†…éƒ¨å¯¹é½ ç»“æ„ä½“å†…å­˜å¯¹é½åˆ†ä¸ºå†…éƒ¨å¯¹é½å’Œç»“æ„ä½“ä¹‹é—´å¯¹é½ã€‚ æˆ‘ä»¬å…ˆæ¥çœ‹ç»“æ„ä½“å†…éƒ¨å¯¹é½ï¼š æŒ‡çš„æ˜¯ç»“æ„ä½“å†…éƒ¨æˆå‘˜çš„ç›¸å¯¹ä½ç½®ï¼ˆåç§»é‡ï¼‰ï¼› æ¯ä¸ªæˆå‘˜çš„åç§»é‡æ˜¯ è‡ªèº«å¤§å° å’Œ å¯¹é½ç³»æ•° çš„è¾ƒå°å€¼çš„å€æ•° type Demo struct a bool b string c int16 å‡å¦‚æˆ‘ä»¬å®šä¹‰äº†ä¸Šé¢çš„ç»“æ„ä½“ Demoï¼Œå¦‚æœåœ¨ 64 ä½ç³»ç»Ÿä¸Šï¼ˆå­—é•¿ä¸º 8 å­—èŠ‚ï¼‰é€šè¿‡ä¸Šé¢çš„è§„åˆ™ï¼Œå¯ä»¥åˆ¤æ–­å‡ºï¼šï¼ˆå•ä½ä¸ºå­—èŠ‚ï¼‰ a: size=1, align=1 b: size=16, align=8 c: size=2, align=2 Demo å†…å­˜ç»“æ„ å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ç¨‹åºè¾“å‡ºæ¥éªŒè¯ï¼š type Demo struct a bool // size=1, align=1\tb string // size=16, align=8\tc int16 // size=2, align=2func main() d := Demo\tfmt.Printf(a: size=%d, align=%d , unsafe.Sizeof(d.a), unsafe.Alignof(d.a))\tfmt.Printf(b: size=%d, align=%d , unsafe.Sizeof(d.b), unsafe.Alignof(d.b))\tfmt.Printf(c: size=%d, align=%d , unsafe.Sizeof(d.c), unsafe.Alignof(d.c))\tprintMemory(d)func printMemory(a any) t := reflect.TypeOf(a)\tmem := make([]int, int(t.Size()))\tfor i := 0; i t.NumField(); i++ field := t.Field(i) offset := int(field.Offset) size := int(field.Type.Size()) for j := 0; j size; j++ mem[j+offset] = i + 1 fmt.Println(mem) è¾“å‡ºï¼š a: size=1, align=1b: size=16, align=8c: size=2, align=2[1 0 0 0 0 0 0 0 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 3 3 0 0 0 0 0 0] 6.6 ç»“æ„ä½“é•¿åº¦å¡«å…… ä¸Šé¢ Demo ç»“æ„ä½“æœ€åè¿˜å¡«äº† 6 ä¸ªå­—èŠ‚çš„ 0ï¼Œè¿™å°±æ˜¯ç»“æ„ä½“é•¿åº¦å¡«å……ï¼š ç»“æ„ä½“é€šè¿‡å¡«å……é•¿åº¦ï¼Œæ¥å¯¹é½ç³»ç»Ÿå­—é•¿ã€‚ ç»“æ„ä½“é•¿åº¦æ˜¯ æœ€å¤§æˆå‘˜é•¿åº¦ å’Œ ç³»ç»Ÿå­—é•¿ è¾ƒå°å€¼çš„æ•´æ•°å€ã€‚ æˆ‘çš„ç³»ç»Ÿç¯å¢ƒæ˜¯ m2maxï¼Œç³»ç»Ÿå­—é•¿æ˜¯ 8 å­—èŠ‚ï¼ŒDemo æœ€å¤§æˆå‘˜é•¿åº¦æ˜¯ b stringï¼Œå³ 16 ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥ Demo çš„é•¿åº¦åº”è¯¥æ˜¯ 8 çš„å€æ•°ï¼Œæ‰€ä»¥æœ€åå¡«å……äº† 6 ä¸ªå­—èŠ‚çš„ 0ã€‚ 6.7 ç»“æ„ä½“ä¹‹é—´å¯¹é½ ç»“æ„ä½“ä¹‹é—´å¯¹é½ï¼Œæ˜¯ä¸ºäº†ç¡®å®šç»“æ„ä½“çš„ç¬¬ä¸€ä¸ªæˆå‘˜å˜é‡çš„å†…å­˜åœ°å€ï¼Œä»¥è®©åé¢çš„æˆå‘˜åœ°å€éƒ½åˆæ³•ã€‚ ç»“æ„ä½“çš„å¯¹é½ç³»æ•°æ˜¯ å…¶æˆå‘˜çš„æœ€å¤§å¯¹é½ç³»æ•°ï¼› 6.8 ç©ºç»“æ„ä½“å¯¹é½ å‰é¢æˆ‘ä»¬ä¸“é—¨è®¨è®ºäº†ç©ºç»“æ„ä½“ structï¼Œå®ƒä»¬çš„å†…å­˜åœ°å€ç»Ÿä¸€æŒ‡å‘ zerobaseï¼Œè€Œä¸”å†…å­˜é•¿åº¦ä¸º 0ã€‚è¿™ä¹Ÿå¯¼è‡´äº†å®ƒçš„å†…å­˜å¯¹é½è§„åˆ™ï¼Œæœ‰ä¸€äº›ä¸åŒã€‚å…·ä½“å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ 4 ä¸ªæƒ…å†µã€‚ 6.8.1 ç©ºç»“æ„ä½“å•ç‹¬å­˜åœ¨ ç©ºç»“æ„ä½“å•ç‹¬å­˜åœ¨æ—¶ï¼Œå…¶å†…å­˜åœ°å€ä¸º zerobaseï¼Œä¸é¢å¤–åˆ†é…å†…å­˜ã€‚ 6.8.2 ç©ºç»“æ„ä½“åœ¨ç»“æ„ä½“æœ€å‰ ç©ºç»“æ„ä½“æ˜¯ç»“æ„ä½“ç¬¬ä¸€ä¸ªå­—æ®µæ—¶ï¼Œå®ƒçš„åœ°å€è·Ÿç»“æ„ä½“æœ¬èº«åŠç»“æ„ä½“ç¬¬ 2 ä¸ªå­—æ®µä¸€æ ·ï¼Œä¸å æ®å†…å­˜ç©ºé—´ã€‚ type TestEmpty struct empty struct\ta bool\tb stringfunc main() te := TestEmpty\tfmt.Printf(address of te: %p , te)\tfmt.Printf(address of te.empty: %p , (te.empty))\tfmt.Printf(address of te.a: %p , (te.a))\tfmt.Printf(empty: size=%d, align=%d , unsafe.Sizeof(te.empty), unsafe.Alignof(te.empty))\tfmt.Printf(a: size=%d, align=%d , unsafe.Sizeof(te.a), unsafe.Alignof(te.a))\tfmt.Printf(b: size=%d, align=%d , unsafe.Sizeof(te.b), unsafe.Alignof(te.b))\tprintMemory(te) è¾“å‡ºï¼š address of te: 0x140000ba000address of te.empty: 0x140000ba000address of te.a: 0x140000ba000empty: size=0, align=1a: size=1, align=1b: size=16, align=8[2 0 0 0 0 0 0 0 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3] 6.8.3 ç©ºç»“æ„ä½“åœ¨ç»“æ„ä½“ä¸­é—´ ç©ºç»“æ„ä½“å‡ºç°åœ¨ç»“æ„ä½“ä¸­æ—¶ï¼Œåœ°å€è·Ÿéšå‰ä¸€ä¸ªå˜é‡ã€‚ ç©ºç»“æ„ä½“åœ¨ç»“æ„ä½“ä¸­é—´å†…å­˜å¯¹é½ type TestEmpty struct a bool\tempty struct\tb stringfunc main() te := TestEmpty\tfmt.Printf(address of te: %p , te)\tfmt.Printf(address of te.a: %p , (te.a))\tfmt.Printf(address of te.empty: %p , (te.empty))\tfmt.Printf(a: size=%d, align=%d , unsafe.Sizeof(te.a), unsafe.Alignof(te.a))\tfmt.Printf(empty: size=%d, align=%d , unsafe.Sizeof(te.empty), unsafe.Alignof(te.empty))\tfmt.Printf(b: size=%d, align=%d , unsafe.Sizeof(te.b), unsafe.Alignof(te.b))\tprintMemory(te) è¾“å‡ºï¼š address of te: 0x14000128000address of te.a: 0x14000128000address of te.empty: 0x14000128001a: size=1, align=1empty: size=0, align=1b: size=16, align=8[1 0 0 0 0 0 0 0 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3] 6.8.4 ç©ºç»“æ„ä½“åœ¨ç»“æ„ä½“æœ€å ç©ºç»“æ„ä½“å‡ºç°åœ¨ç»“æ„ä½“æœ€åï¼Œå¦‚æœå¼€å¯äº†ä¸€ä¸ªæ–°çš„ç³»ç»Ÿå­—é•¿ï¼Œåˆ™éœ€è¦è¡¥é›¶ï¼Œé˜²æ­¢ä¸å…¶ä»–ç»“æ„ä½“æ··ç”¨åœ°å€ã€‚ ç©ºç»“æ„ä½“åœ¨ç»“æ„ä½“æœ€åå†…å­˜å¯¹é½ type TestEmpty struct a bool\tb string\tempty structfunc main() te := TestEmpty\tfmt.Printf(address of te: %p , te)\tfmt.Printf(address of te.a: %p , (te.a))\tfmt.Printf(address of te.empty: %p , (te.empty))\tfmt.Printf(a: size=%d, align=%d , unsafe.Sizeof(te.a), unsafe.Alignof(te.a))\tfmt.Printf(b: size=%d, align=%d , unsafe.Sizeof(te.b), unsafe.Alignof(te.b))\tfmt.Printf(empty: size=%d, align=%d , unsafe.Sizeof(te.empty), unsafe.Alignof(te.empty))\tprintMemory(te) è¾“å‡ºï¼š address of te: 0x1400006a020address of te.a: 0x1400006a020address of te.empty: 0x1400006a038a: size=1, align=1b: size=16, align=8empty: size=0, align=1[1 0 0 0 0 0 0 0 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 0 0 0 0 0 0 0 0] 6.9 ä½¿ç”¨ fieldalignment -fix å·¥å…·ä¼˜åŒ–ç»“æ„ä½“å†…å­˜å¯¹é½ è¿˜è®°å¾—æˆ‘ä»¬æœ€å¼€å§‹æå‡ºçš„é—®é¢˜å—ï¼Ÿ type S1 struct num2 int8\tnum1 int16\tflag booltype S2 struct num1 int8\tflag bool\tnum2 int16func main() fmt.Println(unsafe.Sizeof(S1))\tfmt.Println(unsafe.Sizeof(S2)) S1 å’Œ S2 æä¾›çš„ç¨‹åºåŠŸèƒ½æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯ S1 å´æ¯” S2 èŠ±è´¹äº†æ›´å¤šçš„å†…å­˜ç©ºé—´ã€‚æ‰€ä»¥æœ‰æ—¶å€™æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»…ä»…è°ƒæ•´ç»“æ„ä½“å†…éƒ¨å­—æ®µçš„é¡ºåºå°±å‡å°‘ä¸å°‘çš„å†…å­˜ç©ºé—´æ¶ˆè€—ã€‚åœ¨è¿™ä¸ªæ—¶å€™ fieldalignment å¯ä»¥å¸®åŠ©æˆ‘ä»¬è‡ªåŠ¨æ£€æµ‹å¹¶ä¼˜åŒ–ã€‚ ä½ å¯ä»¥è¿è¡Œä¸‹é¢å‘½ä»¤å®‰è£… fieldalignment å‘½ä»¤ï¼š go install golang.org/x/tools/go/analysis/passes/fieldalignment/cmd/fieldalignment@latest ç„¶ååœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹è¿è¡Œä¸‹é¢å‘½ä»¤ï¼Œå¯¹æˆ‘ä»¬çš„ä»£ç è¿›è¡Œæ£€æŸ¥ï¼š go vet -vettool=$(which fieldalignment) ./... è¿™é‡Œä¼šè¾“å‡ºï¼š ./main.go:9:9: struct of size 6 could be 4 è¿™ä¸ªæ—¶å€™å¯ä»¥æ‰§è¡Œ fieldalignment -fix ç›®å½•|æ–‡ä»¶ ï¼Œå®ƒä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬çš„ä»£ç è¿›è¡Œä¿®å¤ï¼Œä½†æ˜¯å¼ºçƒˆå»ºè®®ä½ åœ¨è¿è¡Œä¹‹å‰ï¼Œå¤‡ä»½ä½ çš„ä»£ç ï¼Œå› ä¸ºæ³¨é‡Šä¼šè¢«åˆ é™¤ï¼ fieldalignment -fix ./... è¾“å‡ºï¼š /Users/hedon/GolandProjects/learn-go-struct/main.go:9:9: struct of size 6 could be 4 è¿™ä¸ªæ—¶å€™ S1 å·²ç»è¢«ä¼˜åŒ–å¥½äº†ï¼š type S1 struct num1 int16\tnum2 int8\tflag bool","tags":["Go"],"categories":["Go"]},{"title":"Rust å®æˆ˜ä¸¨HTTPie","path":"/2024/03/06/rust-action-httpie/","content":"æ¦‚è¿° ä¹‹å‰å­¦ä¹ è¿‡ã€Šé™ˆå¤©Â·Rust ç¼–ç¨‹ç¬¬ä¸€è¯¾ - 04ï½œget hands dirtyï¼šæ¥å†™ä¸ªå®ç”¨çš„ CLI å°å·¥å…·ã€‹ï¼Œå­¦çš„æ—¶å€™è¿·è¿·ç³Šç³Šã€‚åæ¥åœ¨ç³»ç»Ÿå­¦ä¹ å®Œ Rust åï¼Œé‡æ–°å›è¿‡å¤´æ¥çœ‹è¿™ä¸ªå®æˆ˜å°æ¡ˆä¾‹ï¼ŒåŸºæœ¬ä¸Šéƒ½èƒ½æŒæ¡ï¼Œå¹¶ä¸”æœ‰äº†ä¸€äº›æ–°çš„ç†è§£ã€‚æ‰€ä»¥æˆ‘å†³å®šä»¥ä¸€ä¸ª Rust åˆå­¦è€…çš„è§’åº¦ï¼Œå¹¶ä»¥æœ€æ–°ç‰ˆæœ¬çš„ Rustï¼ˆ1.7.6ï¼‰å’Œ clapï¼ˆ4.5.1ï¼‰æ¥é‡æ–°å®ç°è¿™ä¸ªæ¡ˆä¾‹ï¼ŒæœŸæœ›èƒ½å¯¹ Rust æ„Ÿå…´è¶£çš„åˆå­¦è€…æä¾›ä¸€äº›å¸®åŠ©ã€‚ æœ¬æ–‡å°†å®ç°çš„åº”ç”¨å« HTTPieï¼ŒHTTPie æ˜¯ä¸€ä¸ªç”¨ Python ç¼–å†™çš„å‘½ä»¤è¡Œ HTTP å®¢æˆ·ç«¯ï¼Œå…¶ç›®æ ‡æ˜¯ä½¿ CLI ä¸ web æœåŠ¡çš„äº¤äº’å°½å¯èƒ½æ„‰å¿«ã€‚å®ƒè¢«è®¾è®¡ä¸ºä¸€ä¸ª curl å’Œ wget çš„æ›¿ä»£å“ï¼Œæä¾›æ˜“äºä½¿ç”¨çš„ç•Œé¢å’Œä¸€äº›ç”¨æˆ·å‹å¥½çš„åŠŸèƒ½ï¼Œå¦‚ JSON æ”¯æŒã€è¯­æ³•é«˜äº®å’Œæ’ä»¶ã€‚å®ƒå¯¹äºæµ‹è¯•ã€è°ƒè¯•å’Œé€šå¸¸ä¸ HTTP æœåŠ¡å™¨æˆ– RESTful API è¿›è¡Œäº¤äº‘çš„å¼€å‘äººå‘˜æ¥è¯´éå¸¸æœ‰ç”¨ã€‚ HTTPie çš„ä¸€äº›å…³é”®ç‰¹æ€§åŒ…æ‹¬ï¼š JSON æ”¯æŒï¼šé»˜è®¤æƒ…å†µä¸‹ï¼ŒHTTPie ä¼šè‡ªåŠ¨å‘é€ JSONï¼Œå¹¶ä¸”å¯ä»¥è½»æ¾åœ°é€šè¿‡å‘½ä»¤è¡Œå‘é€ JSON è¯·æ±‚ä½“ã€‚ è¯­æ³•é«˜äº®ï¼šå®ƒä¼šä¸º HTTP å“åº”è¾“å‡ºæä¾›è¯­æ³•é«˜äº®æ˜¾ç¤ºï¼Œä½¿å¾—ç»“æœæ›´åŠ æ˜“äºé˜…è¯»ã€‚ æ’ä»¶ï¼šHTTPie æ”¯æŒæ’ä»¶ï¼Œå…è®¸æ‰©å±•å…¶æ ¸å¿ƒåŠŸèƒ½ã€‚ è¡¨å•å’Œæ–‡ä»¶ä¸Šä¼ ï¼šå¯ä»¥å¾ˆå®¹æ˜“åœ°é€šè¿‡è¡¨å•ä¸Šä¼ æ–‡ä»¶ã€‚ è‡ªå®šä¹‰ HTTP æ–¹æ³•å’Œå¤´éƒ¨ï¼šå¯ä»¥å‘é€ä»»ä½• HTTP æ–¹æ³•çš„è¯·æ±‚ï¼Œè‡ªå®šä¹‰è¯·æ±‚å¤´éƒ¨ã€‚ HTTPSã€ä»£ç†å’Œèº«ä»½éªŒè¯æ”¯æŒï¼šæ”¯æŒ HTTPS è¯·æ±‚ã€ä½¿ç”¨ä»£ç†ä»¥åŠå¤šç§ HTTP èº«ä»½éªŒè¯æœºåˆ¶ã€‚ æµå¼ä¸Šä¼ å’Œä¸‹è½½ï¼šæ”¯æŒå¤§æ–‡ä»¶çš„æµå¼ä¸Šä¼ å’Œä¸‹è½½ã€‚ ä¼šè¯æ”¯æŒï¼šå¯ä»¥ä¿å­˜å’Œé‡ç”¨å¸¸ç”¨çš„è¯·æ±‚å’Œé›†åˆã€‚ æœ¬æ–‡æˆ‘ä»¬å°†å®ç°å…¶ä¸­çš„ 1ã€2 å’Œ 5ã€‚æˆ‘ä»¬ä¼šæ”¯æŒå‘é€ GET å’Œ POST è¯·æ±‚ï¼Œå…¶ä¸­ POST æ”¯æŒè®¾ç½®è¯·æ±‚å¤´å’Œ JSON æ•°æ®ã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œä½ å¯ä»¥å­¦ä¹ åˆ°ï¼š å¦‚ä½•ç”¨ clap è§£æå‘½ä»¤è¡Œå‚æ•°ã€‚ å¦‚ä½•ç”¨ tokio è¿›è¡Œå¼‚æ­¥ç¼–ç¨‹ã€‚ å¦‚ä½•ç”¨ reqwest å‘é€ HTTP è¯·æ±‚ã€‚ å¦‚ä½•ç”¨ colored åœ¨ç»ˆç«¯è¾“å‡ºå¸¦é¢œè‰²çš„å†…å®¹ã€‚ å¦‚ä½•ç”¨ jsonxf ç¾åŒ– json å­—ç¬¦ä¸²ã€‚ å¦‚ä½•ç”¨ anyhow é…åˆ ? è¿›è¡Œé”™è¯¯ä¼ æ’­ã€‚ å¦‚ä½•ä½¿ç”¨ HTTPie æ¥è¿›è¡Œ HTTP æ¥å£æµ‹è¯•ã€‚ åœ¨è¿›è¡Œå®é™…å¼€å‘ä¹‹å‰ï¼Œæ¨èä½ å…ˆäº†è§£ä¸€ä¸‹ï¼š https://hedon.top/2024/03/02/rust-crate-reqwest/https://hedon.top/2024/03/02/rust-crate-reqwest/ https://hedon.top/2024/03/05/rust-crate-anyhow/https://hedon.top/2024/03/05/rust-crate-anyhow/ https://hedon.top/2024/03/02/rust-crate-clap/https://hedon.top/2024/03/02/rust-crate-clap/ æœ¬æ–‡å®Œæ•´ä»£ç ï¼š https://github.com/hedon-rust-road/httpiehttps://github.com/hedon-rust-road/httpie å¼€å‘æ€è·¯ HTTP åè®® å›é¡¾ä¸€ä¸‹ HTTP åè®®çš„è¯·æ±‚ä½“å’Œå“åº”ä½“ç»“æ„ã€‚ è¯·æ±‚ç»“æ„ï¼š http request structure å“åº”ç»“æ„ï¼š http response structure å‘½ä»¤åˆ†æ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°±å®ç° HTTPie cli å®˜æ–¹çš„è¿™ä¸ªç¤ºä¾‹ï¼šå³å…è®¸æŒ‡å®šè¯·æ±‚æ–¹æ³•ã€æºå¸¦ headers å’Œ json æ•°æ®å‘é€è¯·æ±‚ã€‚ HTTPie å®˜æ–¹ç¤ºä¾‹ æˆ‘ä»¬æ¥æ‹†è§£ä¸€ä¸‹ï¼Œè¿™ä¸ªå‘½ä»¤å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š httpie METHOD URL [headers | params]... METHOD: è¯·æ±‚æ–¹æ³•ï¼Œæœ¬æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬ä»…æ”¯æŒ GET å’Œ POSTã€‚ URL: è¯·æ±‚åœ°å€ã€‚ HEADERS: è¯·æ±‚å¤´ï¼Œæ ¼å¼ä¸º h1:v1ã€‚ PARAMS: è¯·æ±‚å‚æ•°ï¼Œæ ¼å¼ä¸º k1=v1ï¼Œæœ€ç»ˆä»¥ json ç»“æ„å‘é€ã€‚ æ•ˆæœå±•ç¤º âœ httpie git:(master) âœ— ./Httpie --help Usage: Httpie COMMANDCommands: get post help Print this message or the help of the given subcommand(s)Options: -h, --help Print help -V, --version Print version å…¶ä¸­ post å­å‘½ä»¤ï¼š Usage: Httpie post URL BODY...Arguments: URL Specify the url you wanna request to BODY... Set the request body. Examples: headers: header1:value1 params: key1=value1Options: -h, --help Print help è¯·æ±‚ç¤ºä¾‹ï¼š httpie response demo æ€è·¯æ¢³ç† httpie å¼€å‘æ€è·¯æ¢³ç† ç¬¬ 1 æ­¥ï¼šè§£æå‘½ä»¤è¡Œå‚æ•° æœ¬æ¡ˆä¾‹ä¸­ httpie æ”¯æŒ 2 ä¸ªå­å‘½ä»¤ï¼š get æ”¯æŒ url å‚æ•° post æ”¯æŒ urlã€body å‚æ•°ï¼Œå› ä¸ºå…¶ä¸­ headers å’Œ params æ˜¯å˜é•¿çš„ï¼Œæˆ‘ä»¬ç»Ÿä¸€ç”¨ VecString ç±»å‹çš„ body æ¥æ¥æ”¶ï¼Œç„¶åç”¨ : å’Œ = æ¥åŒºåˆ†å®ƒä»¬ã€‚ ç¬¬ 2 æ­¥ï¼šå‘é€è¯·æ±‚ ä½¿ç”¨ reqwest åˆ›å»º http clientï¼› è®¾ç½® urlï¼› è®¾ç½® methodï¼› è®¾ç½® headersï¼› è®¾ç½® paramsï¼› å‘é€è¯·æ±‚ï¼› è·å–å“åº”ä½“ã€‚ ç¬¬ 3 æ­¥ï¼šæ‰“å°å“åº” æ‰“å° http version å’Œ statusï¼Œå¹¶ä½¿ç”¨ colored èµ‹äºˆè“è‰²ï¼› æ‰“å° response headersï¼Œå¹¶ä½¿ç”¨ colored èµ‹äºˆç»¿è‰²ï¼› ç¡®å®š content-typeï¼Œå¦‚æœæ˜¯ jsonï¼Œæˆ‘ä»¬å°±ç”¨ jsonxf ç¾åŒ– json ä¸²å¹¶ä½¿ç”¨ colored èµ‹äºˆè“ç»¿è‰²è¾“å‡ºï¼Œå¦‚æœæ˜¯å…¶ä»–ç±»å‹ï¼Œè¿™é‡Œæˆ‘ä»¬å°±è¾“å‡ºåŸæ–‡å³å¯ã€‚ å®æˆ˜è¿‡ç¨‹ 1. åˆ›å»ºé¡¹ç›® cargo new httpie 2. æ·»åŠ ä¾èµ– [package]name = httpieversion = 0.1.0edition = 2021[dependencies]anyhow = 1.0.80clap = version = 4.5.1, features = [derive] colored = 2.1.0jsonxf = 1.1.1mime = 0.3.17reqwest = version = 0.11.24, features = [json] tokio = version = 1.36.0, features = [rt, rt-multi-thread, macros] anyhow: ç”¨äºç®€åŒ–å¼‚å¸¸å¤„ç†ã€‚ clap: è§£æå‘½ä»¤è¡Œå‚æ•°ã€‚ colored: ä¸ºç»ˆç«¯è¾“å‡ºå†…å®¹èµ‹äºˆé¢œè‰²ã€‚ jsonxf: ç¾åŒ– json ä¸²ã€‚ mime: æä¾›äº†å„ç§ Media Type çš„ç±»å‹å°è£…ã€‚ reqwest: http å®¢æˆ·ç«¯ã€‚ tokio: å¼‚æ­¥åº“ï¼Œæœ¬æ¡ˆä¾‹ç§æˆ‘ä»¬ä½¿ç”¨ reqwest çš„å¼‚æ­¥åŠŸèƒ½ã€‚ 3. å®Œæ•´æºç  // src/main.rs ä¸ºå‡å°ç¯‡å¹…ï¼Œçœç•¥äº†å•å…ƒæµ‹è¯•ï¼Œè¯»è€…å¯è‡ªè¡Œè¡¥å……ã€‚use std::collections::HashMap;use reqwest::Client, header, Response;use std::str::FromStr;use anyhow::anyhow;use clap::Args, Parser, Subcommand;use colored::Colorize;use mime::Mime;use reqwest::header::HeaderMap, HeaderName, HeaderValue;use reqwest::Url;#[derive(Parser)]#[command(version, author, about, long_about = None)]struct Httpie #[command(subcommand)] methods: Method,#[derive(Subcommand)]enum Method Get(Get), Post(Post)#[derive(Args)]struct Get #[arg(value_parser = parse_url)] url: String,#[derive(Args)]struct Post /// Specify the url you wanna request to. #[arg(value_parser = parse_url)] url: String, /// Set the request body. /// Examples: /// headers: /// header1:value1 /// params: /// key1=value1 #[arg(required = true, value_parser = parse_kv_pairs)] body: VecKvPair#[derive(Debug, Clone)]struct KvPair k: String, v: String, t: KvPairType,#[derive(Debug,Clone)]enum KvPairType Header, Param,impl FromStr for KvPair type Err = anyhow::Error; fn from_str(s: str) - ResultSelf, Self::Err let pair_type: KvPairType; let split_char = if s.contains(:) pair_type = KvPairType::Header; : else pair_type = KvPairType::Param; = ; let mut split = s.split(split_char); let err = || anyhow!(format!(failed to parse pairs ,s)); Ok(Self k: (split.next().ok_or_else(err)?).to_string(), v: (split.next().ok_or_else(err)?).to_string(), t: pair_type, ) fn parse_url(s: str) - anyhow::ResultString let _url: Url = s.parse()?; Ok(s.into())fn parse_kv_pairs(s: str) - anyhow::ResultKvPair Ok(s.parse()?)async fn get(client: Client, args: Get) - anyhow::Result() let resp = client.get(args.url).send().await?; Ok(print_resp(resp).await?)async fn post(client: Client, args: Post) - anyhow::Result() let mut body = HashMap::new(); let mut header_map = HeaderMap::new(); for pair in args.body.iter() match pair.t KvPairType::Param = body.insert(pair.k, pair.v); KvPairType::Header = if let Ok(name) = HeaderName::from_str(pair.k.as_str()) if let Ok(value) = HeaderValue::from_str(pair.v.as_str()) header_map.insert(name,value); else println!(Invalid header value for key: , pair.v); else println!(Invalid header key: , pair.k); let resp = client.post(args.url) .headers(header_map) .json(body).send().await?; Ok(print_resp(resp).await?)async fn print_resp(resp: Response) - anyhow::Result() print_status(resp); print_headers(resp); let mime = get_content_type(resp); let body = resp.text().await?; print_body(mime, body); Ok(())fn print_status(resp: Response) let status = format!(:? , resp.version(), resp.status()).blue(); println!( , status);fn print_headers(resp: Response) for (k,v) in resp.headers() println!(: :?, k.to_string().green(), v); print!( );fn print_body(mime: OptionMime, resp: String) match mime Some(v) = if v == mime::APPLICATION_JSON println!(, jsonxf::pretty_print(resp).unwrap().cyan()) _ = print!(, resp), fn get_content_type(resp: Response) - OptionMime resp.headers() .get(header::CONTENT_TYPE) .map(|v|v.to_str().unwrap().parse().unwrap())#[tokio::main]async fn main() - anyhow::Result() let httpie = Httpie::parse(); let client = Client::new(); let result = match httpie.methods Method::Get(ref args) = get(client, args).await?, Method::Post(ref args) = post(client, args).await?, ; Ok(result) å¯ä»¥çœ‹åˆ°ï¼Œå³ä½¿ç®—ä¸Š use éƒ¨åˆ†ï¼Œæ€»ä»£ç ä¹Ÿä¸è¿‡160 è¡Œå·¦å³ï¼ŒRust çš„ clap åº“åœ¨ CLI å¼€å‘ä¸Šç¡®å® yydsï¼ æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä¸€ä¸€æ‹†è§£è¿™éƒ¨åˆ†çš„ä»£ç ï¼Œå…¶ä¸­å…³äº clap çš„éƒ¨åˆ†æˆ‘ä¸ä¼šè¿‡å¤šå±•å¼€ï¼Œåˆšå…´è¶£çš„è¯»è€…å¯ä»¥å‚é˜…ï¼šæ·±å…¥æ¢ç´¢ Rust çš„ clap åº“ï¼šå‘½ä»¤è¡Œè§£æçš„è‰ºæœ¯ã€‚ 3.1 å‘½ä»¤è¡Œè§£æ æˆ‘ä»¬å…ˆä» main() å¼€å§‹ï¼š #[tokio::main]async fn main() - anyhow::Result() let httpie = Httpie::parse(); let client = Client::new(); let result = match httpie.methods Method::Get(ref args) = get(client, args).await?, Method::Post(ref args) = post(client, args).await?, ; Ok(result) æˆ‘ä»¬å¸Œæœ›ä½¿ç”¨ clap çš„å¼‚æ­¥åŠŸèƒ½ï¼Œæ‰€ä»¥ä½¿ç”¨äº† async å…³é”®å­—ï¼ŒåŒæ—¶åŠ ä¸Šäº† tokio æä¾›çš„å±æ€§å® #[tokio::main]ï¼Œç”¨äºè®¾ç½®å¼‚æ­¥ç¯å¢ƒã€‚ä¸ºäº†èƒ½å¤Ÿä½¿ç”¨ ? å¿«é€Ÿä¼ æ’­é”™è¯¯ï¼Œæˆ‘ä»¬è®¾ç½®è¿”å›å€¼ä¸º anyhow::Result()ï¼Œæœ¬é¡¹ç›®ä¸­æˆ‘ä»¬ä¸å¯¹é”™è¯¯è¿›è¡Œè¿‡å¤šå¤„ç†ï¼Œæ‰€ä»¥è¿™ç§æ–¹å¼å¯ä»¥å¤§å¤§ç®€åŒ–æˆ‘ä»¬çš„é”™è¯¯å¤„ç†è¿‡ç¨‹ã€‚ main() ä¸­æˆ‘ä»¬ä½¿ç”¨ Httpie::parse() è§£æå‘½ä»¤è¡Œä¸­çš„å‚æ•°ï¼Œä½¿ç”¨ Client::new() åˆ›å»ºä¸€ä¸ª http clientï¼Œæ ¹æ®è§£æåˆ°çš„å‘½ä»¤è¡Œå‚æ•°ï¼Œæˆ‘ä»¬åŒ¹é…å­å‘½ä»¤ methodsï¼Œåˆ†åˆ«è°ƒç”¨ get() å’Œ post() æ¥å‘é€ GET å’Œ POST è¯·æ±‚ã€‚ Httpie çš„å®šä¹‰å¦‚ä¸‹ï¼š #[derive(Parser)]#[command(version, author, about, long_about = None)]struct Httpie #[command(subcommand)] methods: Method, #[derive(Parser)] æ˜¯ä¸€ä¸ªè¿‡ç¨‹å®ï¼ˆprocedural macroï¼‰ï¼Œç”¨äºè‡ªåŠ¨ä¸ºç»“æ„ä½“å®ç° clap::Parser traitã€‚è¿™ä½¿å¾—è¯¥ç»“æ„ä½“å¯ä»¥ç”¨æ¥è§£æå‘½ä»¤è¡Œå‚æ•°ã€‚ åœ¨ Httpie ä¸­æˆ‘ä»¬å®šä¹‰äº†å­å‘½ä»¤ Methodï¼š #[derive(Subcommand)]enum Method Get(Get), Post(Post) #[derive(Subcommand)] å±æ€§å®ä¼šè‡ªåŠ¨ä¸ºæšä¸¾æ´¾ç”Ÿä¸€äº›ä»£ç ï¼Œä»¥ä¾¿å®ƒå¯ä»¥ä½œä¸ºå­å‘½ä»¤æ¥è§£æå‘½ä»¤è¡Œå‚æ•°ã€‚ç›®å‰æ”¯æŒ Get å’Œ Post ä¸¤ä¸ªå­å‘½ä»¤ï¼Œå®ƒä»¬åˆ†åˆ«æ¥æ”¶ Get å’Œ Post å‚æ•°ï¼š #[derive(Args)]struct Get #[arg(value_parser = parse_url)] url: String,#[derive(Args)]struct Post #[arg(value_parser = parse_url)] url: String, #[arg(value_parser = parse_kv_pairs)] body: VecKvPair #[derive(Args)] å±æ€§å®è¡¨æ˜å½“å‰ struct æ˜¯å‘½ä»¤çš„å‚æ•°ï¼Œå…¶ä¸­ Get ä»…æ”¯æŒ url å‚æ•°ï¼ŒPost æ”¯æŒ url å’Œ body å‚æ•°ã€‚ url å‚æ•°æˆ‘ä»¬ä½¿ç”¨ parse_url å‡½æ•°æ¥è¿›è¡Œè§£æï¼š use reqwest::Url;fn parse_url(s: str) - anyhow::ResultString let _url: Url = s.parse()?; Ok(s.into()) è¿™é‡Œ reqwest::Url å·²ç»å®ç°äº† FromStr traitï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è°ƒç”¨ s.parse() æ¥è§£æ urlã€‚ è€Œ bodyï¼Œå› ä¸ºæˆ‘ä»¬æœŸæœ› CLI ä½¿ç”¨èµ·æ¥åƒï¼š httpie url header1:value1 param1=v1 body å°±æ˜¯ header1:value1 param1=v1ï¼Œä¸€å¯¹ kv å°±ä»£è¡¨ç€ä¸€ä¸ª header æˆ–è€… paramï¼Œç”¨ : å’Œ = æ¥åŒºåˆ†ã€‚å› ä¸º kv å¯¹çš„ä¸ªæ•°çš„å˜é•¿çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ VecKvPair æ¥æ¥æ”¶ body è¿™ä¸ªå‚æ•°ï¼Œå¹¶ä½¿ç”¨ parse_kv_pairs æ¥è§£æ kv å¯¹ã€‚ KvPair æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„ç±»å‹ï¼š #[derive(Debug, Clone)]struct KvPair k: String, v: String, t: KvPairType,#[derive(Debug,Clone)]enum KvPairType Header, Param, parse_kv_pairs çš„å®ç°å¦‚ä¸‹ï¼š fn parse_kv_pairs(s: str) - anyhow::ResultKvPair Ok(s.parse()?) åœ¨è¿™é‡Œï¼Œä½ å¯ä»¥åœ¨ parse_kv_pairs() å‡½æ•°ä¸­ï¼Œå¯¹ s è¿›è¡Œè§£æå¹¶è¿”å› anyhow::ResultKvPairã€‚ä¸è¿‡ï¼Œæ›´ä¼˜é›…ï¼Œæ›´ç»Ÿä¸€çš„æ–¹å¼æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå°±æ˜¯åƒ reqwest::Url ä¸€æ ·ï¼Œä¸º KvPair å®ç° FromStr traitï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥è°ƒç”¨ s.parse() æ¥è¿›è¡Œè§£æäº†ã€‚ impl FromStr for KvPair type Err = anyhow::Error; fn from_str(s: str) - ResultSelf, Self::Err ... 3.2 å‘é€è¯·æ±‚ å‚æ•°è§£æå®Œï¼Œå°±åˆ°äº†å‘é€è¯·æ±‚çš„åœ°æ–¹äº†ï¼Œè¿™é‡Œä½¿ç”¨ reqwest crate å°±éå¸¸æ–¹ä¾¿äº†ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ï¼Œå…·ä½“å¯ä»¥å‚è€ƒï¼šRust reqwest ç®€æ˜æ•™ç¨‹ã€‚ async fn get(client: Client, args: Get) - anyhow::Result() ... async fn post(client: Client, args: Post) - anyhow::Result() ... 3.3 æ‰“å°å“åº” httpie response demo å“åº”åˆ†ä¸º 3 ä¸ªéƒ¨åˆ†ï¼š print_status() print_headers() print_body() async fn print_resp(resp: Response) - anyhow::Result() print_status(resp); print_headers(resp); let mime = get_content_type(resp); let body = resp.text().await?; print_body(mime, body); Ok(()) print_status() æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯æ‰“å° HTTP ç‰ˆæœ¬å’Œå“åº”çŠ¶æ€ç ï¼Œç„¶åæˆ‘ä»¬ä½¿ç”¨ colored crate çš„ blue() ä½¿å…¶åœ¨ç»ˆç«¯ä»¥è“è‰²è¾“å‡ºã€‚ fn print_status(resp: Response) let status = format!(:? , resp.version(), resp.status()).blue(); println!( , status); print_headers() ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ green() ä½¿ header_name åœ¨ç»ˆç«¯ä»¥ç»¿è‰²è¾“å‡ºã€‚ fn print_headers(resp: Response) for (k,v) in resp.headers() println!(: :?, k.to_string().green(), v); print!( ); å“åº”ä½“çš„æ ¼å¼ï¼ˆMedia Typeï¼‰æœ‰å¾ˆå¤šï¼Œæœ¬æ¡ˆä¾‹ä¸­æˆ‘ä»¬ä»…æ”¯æŒ application/jsonï¼Œæ‰€ä»¥åœ¨ print_body() ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆè¯»å– response header ä¸­çš„ content-typeï¼š fn get_content_type(resp: Response) - OptionMime resp.headers() .get(header::CONTENT_TYPE) .map(|v|v.to_str().unwrap().parse().unwrap()) åœ¨ print_resp() ä¸­ï¼Œå¯¹äº application/jsonï¼Œæˆ‘ä»¬ä½¿ç”¨ jsonxf crate å¯¹è¿›è¡Œç¾åŒ–ï¼Œå¹¶ä½¿ç”¨ cyan() ä½¿å…¶åœ¨ç»ˆç«¯ä»¥è“ç»¿è‰²è¾“å‡ºã€‚å¯¹äºå…¶ä»–ç±»å‹ï¼Œæˆ‘ä»¬å§‘ä¸”ç…§åŸæ–‡è¾“å‡ºã€‚ fn print_body(mime: OptionMime, resp: String) match mime Some(v) = if v == mime::APPLICATION_JSON println!(, jsonxf::pretty_print(resp).unwrap().cyan()) _ = print!(, resp), æ€»ç»“ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬æ·±å…¥æ¢è®¨äº†å¦‚ä½•ä½¿ç”¨ Rust è¯­è¨€æ¥å®ç°ä¸€ä¸ªç±»ä¼¼äº HTTPie çš„å‘½ä»¤è¡Œå·¥å…·ã€‚è¿™ä¸ªè¿‡ç¨‹åŒ…æ‹¬äº†å¯¹ HTTP åè®®çš„ç†è§£ã€å‘½ä»¤è¡Œå‚æ•°çš„è§£æã€HTTP å®¢æˆ·ç«¯çš„åˆ›å»ºå’Œè¯·æ±‚å‘é€ï¼Œä»¥åŠå¯¹å“åº”çš„å¤„ç†å’Œå±•ç¤ºã€‚é€šè¿‡æœ¬æ–‡ï¼Œè¯»è€…ä¸ä»…èƒ½å¤Ÿè·å¾—ä¸€ä¸ªå®ç”¨çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œè¿˜èƒ½å¤Ÿå­¦ä¹ åˆ°å¦‚ä½•ä½¿ç”¨ Rust çš„åº“æ¥æ„å»ºå®é™…çš„åº”ç”¨ç¨‹åºï¼ŒåŒ…æ‹¬ clapã€reqwestã€tokio å’Œ colored ç­‰ã€‚æ­¤å¤–ï¼Œæ–‡ç« ä¹Ÿè¯´æ˜äº†åœ¨ Rust ä¸­è¿›è¡Œå¼‚æ­¥ç¼–ç¨‹å’Œé”™è¯¯å¤„ç†çš„ä¸€äº›å¸¸è§æ¨¡å¼ã€‚å°½ç®¡ç¤ºä¾‹ä»£ç çš„é”™è¯¯å¤„ç†è¾ƒä¸ºç®€å•ï¼Œä½†å®ƒæä¾›äº†ä¸€ä¸ªè‰¯å¥½çš„èµ·ç‚¹ï¼Œå¼€å‘è€…å¯ä»¥åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œæ‰©å±•å’Œæ”¹è¿›ï¼Œä»¥é€‚åº”æ›´å¤æ‚çš„åº”ç”¨åœºæ™¯ã€‚","tags":["Rust"],"categories":["Rust","Rust å®æˆ˜"]},{"title":"Rust anyhow ç®€æ˜æ•™ç¨‹","path":"/2024/03/05/rust-crate-anyhow/","content":"anyhow æ˜¯ Rust ä¸­çš„ä¸€ä¸ªåº“ï¼Œæ—¨åœ¨æä¾›çµæ´»çš„ã€å…·ä½“çš„é”™è¯¯å¤„ç†èƒ½åŠ›ï¼Œå»ºç«‹åœ¨ std::error::Error åŸºç¡€ä¸Šã€‚å®ƒä¸»è¦ç”¨äºé‚£äº›éœ€è¦ç®€å•é”™è¯¯å¤„ç†çš„åº”ç”¨ç¨‹åºå’ŒåŸå‹å¼€å‘ä¸­ï¼Œå°¤å…¶æ˜¯åœ¨é”™è¯¯ç±»å‹ä¸éœ€è¦è¢«ä¸¥æ ¼åŒºåˆ†çš„åœºæ™¯ä¸‹ã€‚ ä»¥ä¸‹æ˜¯ anyhow çš„å‡ ä¸ªå…³é”®ç‰¹æ€§ï¼š æ˜“ç”¨æ€§: anyhow æä¾›äº†ä¸€ä¸ª Error ç±»å‹ï¼Œè¿™ä¸ªç±»å‹å¯ä»¥åŒ…å«ä»»ä½•å®ç°äº† std::error::Error çš„é”™è¯¯ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥ä½¿ç”¨ anyhow::Error æ¥åŒ…è£…å‡ ä¹æ‰€æœ‰ç±»å‹çš„é”™è¯¯ï¼Œæ— éœ€æ‹…å¿ƒå…·ä½“çš„é”™è¯¯ç±»å‹ã€‚ ç®€æ´çš„é”™è¯¯é“¾: anyhow æ”¯æŒé€šè¿‡ ? æ“ä½œç¬¦æ¥ä¼ æ’­é”™è¯¯ï¼ŒåŒæ—¶ä¿ç•™é”™è¯¯å‘ç”Ÿçš„ä¸Šä¸‹æ–‡ã€‚è¿™è®©é”™è¯¯å¤„ç†æ›´åŠ ç›´è§‚ï¼ŒåŒæ—¶è¿˜èƒ½ä¿ç•™é”™è¯¯é“¾ï¼Œä¾¿äºè°ƒè¯•ã€‚ ä¾¿äºè°ƒè¯•: anyhow æ”¯æŒé€šè¿‡ :# æ ¼å¼åŒ–æŒ‡ç¤ºç¬¦æ¥æ‰“å°é”™è¯¯åŠå…¶æ‰€æœ‰ç›¸å…³çš„ä¸Šä¸‹æ–‡å’ŒåŸå› ï¼Œè¿™ä½¿å¾—è°ƒè¯•å¤æ‚çš„é”™è¯¯é“¾å˜å¾—æ›´åŠ ç®€å•ã€‚ æ— éœ€å…³å¿ƒé”™è¯¯ç±»å‹: åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œç‰¹åˆ«æ˜¯åœ¨åº”ç”¨ç¨‹åºçš„é¡¶å±‚ï¼Œä½ å¯èƒ½ä¸éœ€è¦å…³å¿ƒé”™è¯¯çš„å…·ä½“ç±»å‹ï¼Œåªéœ€è¦çŸ¥é“å‡ºé”™äº†å¹¶ä¸”èƒ½å¤Ÿå°†é”™è¯¯ä¿¡æ¯ä¼ é€’ç»™ç”¨æˆ·æˆ–æ—¥å¿—ã€‚anyhow è®©è¿™ä¸€è¿‡ç¨‹å˜å¾—ç®€å•ï¼Œå› ä¸ºå®ƒå¯ä»¥åŒ…è£…ä»»ä½•é”™è¯¯ï¼Œè€Œä¸éœ€è¦æ˜¾å¼åœ°æŒ‡å®šé”™è¯¯ç±»å‹ã€‚ ä½¿ç”¨ anyhow çš„å…¸å‹åœºæ™¯åŒ…æ‹¬å¿«é€ŸåŸå‹å¼€å‘ã€åº”ç”¨ç¨‹åºé¡¶å±‚çš„é”™è¯¯å¤„ç†ï¼Œæˆ–è€…åœ¨åº“ä¸­ä½œä¸ºè¿”å›é”™è¯¯ç±»å‹çš„ä¸€ä¸ªç®€ä¾¿é€‰æ‹©ï¼Œå°¤å…¶æ˜¯åœ¨åº“çš„ä½¿ç”¨è€…ä¸éœ€è¦å…³å¿ƒå…·ä½“é”™è¯¯ç±»å‹çš„æ—¶å€™ã€‚ anyhow::Error anyhow::Error æ˜¯ anyhow åº“å®šä¹‰çš„ä¸€ä¸ªé”™è¯¯ç±»å‹ã€‚å®ƒæ˜¯ä¸€ä¸ªåŒ…è£…å™¨ï¼ˆwrapperï¼‰ç±»å‹ï¼Œå¯ä»¥åŒ…å«ä»»ä½•å®ç°äº† std::error::Error trait çš„é”™è¯¯ç±»å‹ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥å°†å‡ ä¹æ‰€æœ‰çš„é”™è¯¯è½¬æ¢ä¸º anyhow::Error ç±»å‹ï¼Œä»è€Œåœ¨å‡½æ•°ä¹‹é—´ä¼ é€’ï¼Œè€Œä¸éœ€è¦åœ¨æ„å…·ä½“çš„é”™è¯¯ç±»å‹ã€‚è¿™åœ¨å¿«é€ŸåŸå‹å¼€å‘æˆ–åº”ç”¨ç¨‹åºé¡¶å±‚é”™è¯¯å¤„ç†ä¸­ç‰¹åˆ«æœ‰ç”¨ï¼Œå› ä¸ºå®ƒç®€åŒ–äº†é”™è¯¯å¤„ç†çš„é€»è¾‘ã€‚ å®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š #[cfg_attr(not(doc), repr(transparent))]pub struct Error inner: OwnErrorImpl, å…¶ä¸­æ ¸å¿ƒæ˜¯ ErrorImplï¼š #[repr(C)]pub(crate) struct ErrorImplE = () vtable: static ErrorVTable, backtrace: OptionBacktrace, // NOTE: Dont use directly. Use only through vtable. Erased type may have // different alignment. _object: E, ErrorImpl æ˜¯ä¸€ä¸ªå†…éƒ¨ç»“æ„ä½“ï¼Œç”¨äºå®ç° anyhow::Error ç±»å‹çš„å…·ä½“åŠŸèƒ½ã€‚å®ƒåŒ…å«äº†ä¸‰ä¸ªä¸»è¦å­—æ®µï¼š vtable æ˜¯ä¸€ä¸ªæŒ‡å‘é™æ€è™šæ‹Ÿè¡¨çš„æŒ‡é’ˆï¼Œç”¨äºåŠ¨æ€æ´¾å‘é”™è¯¯ç›¸å…³çš„æ–¹æ³•ã€‚ backtrace æ˜¯ä¸€ä¸ªå¯é€‰çš„å›æº¯ï¼ˆBacktraceï¼‰ç±»å‹ï¼Œç”¨äºå­˜å‚¨é”™è¯¯å‘ç”Ÿæ—¶çš„è°ƒç”¨æ ˆä¿¡æ¯ã€‚ _object å­—æ®µç”¨äºå­˜å‚¨å…·ä½“çš„é”™è¯¯å¯¹è±¡ï¼Œå…¶ç±»å‹åœ¨ç¼–è¯‘æ—¶è¢«æ“¦é™¤ä»¥æä¾›ç±»å‹å®‰å…¨çš„åŠ¨æ€é”™è¯¯å¤„ç†ã€‚ è¿™ç§è®¾è®¡å…è®¸ anyhow é”™è¯¯å°è£…å¹¶è¡¨ç¤ºå„ç§ä¸åŒçš„é”™è¯¯ç±»å‹ï¼ŒåŒæ—¶æä¾›äº†æ–¹æ³•åŠ¨æ€æ´¾å‘å’Œå›æº¯åŠŸèƒ½ï¼Œä»¥ä¾¿äºé”™è¯¯è°ƒè¯•ã€‚ anyhow::Error å¯ä»¥åŒ…å«ä»»ä½•å®ç°äº† std::error::Error trait çš„é”™è¯¯ç±»å‹ï¼Œè¿™é‡Œå› ä¸ºä¸‹é¢çš„ implï¼š implE StdError for ErrorImplEwhere E: StdError, fn source(self) - Option(dyn StdError + static) unsafe ErrorImpl::error(self.erase()).source() #[cfg(error_generic_member_access)] fn providea(a self, request: mut Requesta) unsafe ErrorImpl::provide(self.erase(), request) anyhow::Result anyhow::Result æ˜¯ä¸€ä¸ªåˆ«åï¼ˆtype aliasï¼‰ï¼Œå®ƒæ˜¯ std::result::ResultT, anyhow::Error çš„ç®€å†™ã€‚åœ¨ä½¿ç”¨ anyhow åº“è¿›è¡Œé”™è¯¯å¤„ç†æ—¶ï¼Œä½ ä¼šé¢‘ç¹åœ°çœ‹åˆ°è¿™ä¸ªç±»å‹ã€‚å®ƒåŸºæœ¬ä¸Šæ˜¯æ ‡å‡†çš„ Result ç±»å‹ï¼Œä½†é”™è¯¯ç±»å‹è¢«å›ºå®šä¸º anyhow::Errorã€‚è¿™ä½¿å¾—ä½ å¯ä»¥å¾ˆå®¹æ˜“åœ°åœ¨å‡½æ•°ä¹‹é—´ä¼ é€’é”™è¯¯ï¼Œè€Œä¸éœ€è¦å£°æ˜å…·ä½“çš„é”™è¯¯ç±»å‹ã€‚ pub type ResultT, E = Error = core::result::ResultT, E; ä½¿ç”¨ anyhow::Result çš„å¥½å¤„åœ¨äºå®ƒæä¾›äº†ä¸€ç§ç»Ÿä¸€çš„æ–¹å¼æ¥å¤„ç†é”™è¯¯ã€‚ä½ å¯ä»¥ä½¿ç”¨ ? æ“ä½œç¬¦æ¥ä¼ æ’­é”™è¯¯ï¼ŒåŒæ—¶ä¿ç•™é”™è¯¯çš„ä¸Šä¸‹æ–‡ä¿¡æ¯å’Œå›æº¯ã€‚è¿™æå¤§åœ°ç®€åŒ–äº†é”™è¯¯å¤„ç†ä»£ç ï¼Œå°¤å…¶æ˜¯åœ¨å¤šä¸ªå¯èƒ½äº§ç”Ÿä¸åŒé”™è¯¯ç±»å‹çš„æ“ä½œé“¾ä¸­ã€‚ 3 ä¸ªæ ¸å¿ƒä½¿ç”¨æŠ€å·§ ä½¿ç”¨ ResultT, anyhow::Error æˆ–è€… anyhow::ResultT ä½œä¸ºè¿”å›å€¼ï¼Œç„¶ååˆ©ç”¨ ? è¯­æ³•ç³–æ— è„‘ä¼ æ’­æŠ¥é”™ã€‚ ä½¿ç”¨ with_context(f) æ¥é™„åŠ é”™è¯¯ä¿¡æ¯ã€‚ ä½¿ç”¨ downcast åè§£å…·ä½“çš„é”™è¯¯ç±»å‹ã€‚ å®æˆ˜æ¡ˆä¾‹ ä¸‹é¢æˆ‘ä»¬ç”¨ä¸€ä¸ªæ¡ˆä¾‹æ¥ä½“ä¼š anyhow çš„ä½¿ç”¨æ–¹å¼ï¼š æˆ‘ä»¬çš„éœ€æ±‚æ˜¯ï¼šæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œè§£ææ–‡ä»¶ä¸­çš„æ•°æ®å¹¶è¿›è¡Œå¤§å†™åŒ–ï¼Œç„¶åè¾“å‡ºå¤„ç†åçš„æ•°æ®ã€‚ use anyhow::Result, Context;use std::fs, io;// 1. è¯»å–æ–‡ä»¶ã€è§£ææ•°æ®å’Œæ‰§è¡Œæ•°æ®æ“ä½œéƒ½å¯èƒ½å‡ºç°é”™è¯¯ï¼Œ// æ‰€ä»¥æˆ‘ä»¬éœ€è¦è¿”å› Result æ¥å…¼å®¹å¼‚å¸¸æƒ…å†µã€‚// è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ anyhow::Result æ¥ç®€åŒ–å’Œä¼ æ’­é”™è¯¯ã€‚fn read_and_process_file(file_path: str) - Result() // å°è¯•è¯»å–æ–‡ä»¶ let data = fs::read_to_string(file_path) // 2. ä½¿ç”¨ with_context æ¥é™„åŠ é”™è¯¯ä¿¡æ¯ï¼Œç„¶ååˆ©ç”¨ ? è¯­æ³•ç³–ä¼ æ’­é”™è¯¯ã€‚ .with_context(||format!(failed to read file ``, file_path))?; // è§£ææ•°æ® let processed_data = parse_data(data) .with_context(||format!(failed to parse data from file ``, file_path))?; // æ‰§è¡Œæ•°æ®æ“ä½œ perform_some_operation(processed_data) .with_context(|| failed to perform operation based on file data)?; Ok(())fn parse_data(data: str) - ResultString Ok(data.to_uppercase())fn perform_some_operation(data: String) - Result() println!(processed data: , data); Ok(())fn main() let file_path = ./anyhow.txt; // æ‰§è¡Œå¤„ç†é€»è¾‘ let res = read_and_process_file(file_path); // å¤„ç†ç»“æœ match res Ok(_) = println!(successfully!), Err(e) = // 3. ä½¿ç”¨ downcast æ¥åè§£å‡ºå®é™…çš„é”™è¯¯å®ä¾‹ï¼Œæœ¬æ¡ˆä¾‹ä¸­å¯èƒ½å‡ºç°çš„å¼‚å¸¸æ˜¯ io::Errorã€‚ if let Some(my_error) = e.downcast_ref::io::Error() println!(has io error: :#, my_error); else println!(unknown error: :?, e);","tags":["Rust"],"categories":["Rust","Rust å¸¸ç”¨åº“"]},{"title":"æ·±å…¥æ¢ç´¢ Rust çš„ clap åº“ï¼šå‘½ä»¤è¡Œè§£æçš„è‰ºæœ¯","path":"/2024/03/02/rust-crate-clap/","content":"ç‰ˆæœ¬å£°æ˜ Rust: 1.76 clap: 4.5.1 clap_complete 4.5.1 rpassword: 7.3.1 ç»“è®ºå…ˆè¡Œ æœ¬æ–‡å°†ä» CLIï¼ˆCommand Line Interfaceï¼‰å‘½ä»¤è¡Œå·¥å…·çš„æ¦‚è¿°è®²èµ·ï¼Œä»‹ç»ä¸€ä¸ªä¼˜ç§€çš„å‘½ä»¤è¡Œå·¥å…·åº”è¯¥å…·å¤‡çš„åŠŸèƒ½å’Œç‰¹æ€§ã€‚ç„¶åä»‹ç» Rust ä¸­ä¸€ä¸ªéå¸¸ä¼˜ç§€çš„å‘½ä»¤è¡Œè§£æå·¥å…· clap ç»å…¸ä½¿ç”¨æ–¹æ³•ï¼Œå¹¶åˆ©ç”¨ clap å®ç°ä¸€ä¸ªç±»ä¼¼äº curl çš„å·¥å…· httpieã€‚æ–‡ç« æœ€åè¿˜å°† clap äº Go è¯­è¨€ä¸­åŒæ ·ä¼˜ç§€çš„å‘½ä»¤è¡Œè§£æå·¥å…· cobra è¿›è¡Œä¸€ä¸ªç®€å•å¯¹æ¯”ï¼Œä¾¿äºè¯»è€…è¿›ä¸€æ­¥ä½“ä¼š clap çš„ç®€æ´å’Œä¼˜ç§€ã€‚ æœ¬æ–‡å°†åŒ…å«ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š CLI æ¦‚è¿°ï¼šä» CLI çš„åŸºæœ¬æ¦‚å¿µå‡ºå‘ï¼Œä»‹ç»ä¼˜ç§€å‘½ä»¤è¡Œå·¥å…·åº”è¯¥å…·å¤‡çš„åŠŸèƒ½ç‰¹æ€§ï¼Œå¹¶ä»¥ curl ä½œä¸ºç»å…¸èŒƒä¾‹è¿›è¡Œè¯´æ˜ã€‚ è¯¦ç»†ä»‹ç» clapï¼šåŸºäº clap å®˜æ–¹æ–‡æ¡£ï¼Œåˆ†åˆ«è¯¦ç»†ä»‹ç» clap ä»¥ derive å’Œ builder ä¸¤ä¸ªæ–¹å¼æ„å»º cli çš„å¸¸ç”¨æ–¹æ³•ã€‚ å®æˆ˜ httpieï¼šå‚è€ƒé™ˆå¤©è€å¸ˆçš„ã€ŠRust ç¼–ç¨‹ç¬¬ä¸€è¯¾ã€‹ï¼Œç”¨æœ€æ–°çš„ clap ç‰ˆæœ¬ï¼ˆ1.7.6ï¼‰å®ç° httpie å·¥å…·ã€‚ å¯¹æ¯” cobraï¼šä»è®¾è®¡ç†å¿µå’Œç›®æ ‡ã€åŠŸèƒ½ç‰¹ç‚¹ã€ä½¿ç”¨åœºæ™¯ç­‰æ–¹é¢ç®€è¦å¯¹æ¯” clap å’Œ Go æµè¡Œçš„å‘½ä»¤è¡Œè§£æåº“ cobraã€‚ ç‰¹æ­¤å£°æ˜ï¼Œæœ¬æ–‡åŒ…å« AI è¾…åŠ©ç”Ÿæˆå†…å®¹ï¼Œå¦‚æœ‰é”™è¯¯é—æ¼ä¹‹å¤„ï¼Œæ•¬è¯·æŒ‡å‡ºã€‚ CLI æ¦‚è¿° CLIï¼ˆCommand Line Interfaceï¼Œå‘½ä»¤è¡Œç•Œé¢ï¼‰æ˜¯ä¸€ç§å…è®¸ç”¨æˆ·é€šè¿‡æ–‡æœ¬å‘½ä»¤ä¸è®¡ç®—æœºç¨‹åºæˆ–æ“ä½œç³»ç»Ÿè¿›è¡Œäº¤äº’çš„æ¥å£ã€‚ä¸å›¾å½¢ç”¨æˆ·ç•Œé¢ï¼ˆGUIï¼ŒGraphical User Interfaceï¼‰ç›¸æ¯”ï¼ŒCLI ä¸æä¾›å›¾å½¢å…ƒç´ ï¼Œå¦‚æŒ‰é’®æˆ–å›¾æ ‡ï¼Œè€Œæ˜¯ä¾èµ–äºæ–‡æœ¬è¾“å…¥ã€‚ç”¨æˆ·é€šè¿‡é”®ç›˜è¾“å…¥ç‰¹å®šçš„å‘½ä»¤è¡ŒæŒ‡ä»¤ï¼Œå‘½ä»¤è¡Œç•Œé¢è§£é‡Šè¿™äº›æŒ‡ä»¤å¹¶æ‰§è¡Œç›¸åº”çš„æ“ä½œã€‚ ä¸€æ¬¾ä¼˜ç§€çš„ CLI å·¥å…·åº”è¯¥å…·å¤‡ä»¥ä¸‹çš„åŠŸèƒ½å’Œç‰¹æ€§ï¼Œä»¥æå‡ç”¨æˆ·ä½“éªŒå’Œæ•ˆç‡ï¼š ä¸€ä¸ªä¼˜ç§€çš„å‘½ä»¤è¡Œå·¥å…·ï¼ˆCLI, Command Line Interfaceï¼‰åº”è¯¥å…·å¤‡ä»¥ä¸‹åŠŸèƒ½å’Œç‰¹æ€§ï¼Œä»¥æå‡ç”¨æˆ·ä½“éªŒå’Œæ•ˆç‡ï¼š ç›´è§‚æ˜“ç”¨ï¼š ç®€æ´çš„å‘½ä»¤è¯­æ³•ï¼šå‘½ä»¤å’Œå‚æ•°çš„è®¾è®¡åº”ç›´è§‚æ˜“æ‡‚ï¼Œæ–¹ä¾¿ç”¨æˆ·è®°å¿†å’Œä½¿ç”¨ã€‚ è‡ªåŠ¨è¡¥å…¨ï¼šæ”¯æŒå‘½ä»¤å’Œå‚æ•°çš„è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ï¼Œæé«˜ç”¨æˆ·è¾“å…¥æ•ˆç‡ã€‚ å‘½ä»¤åˆ«åï¼šæä¾›å¸¸ç”¨å‘½ä»¤çš„ç®€çŸ­åˆ«åï¼Œå‡å°‘è¾“å…¥çš„å·¥ä½œé‡ã€‚ å¼ºå¤§çš„å¸®åŠ©ç³»ç»Ÿï¼š è¯¦ç»†çš„å¸®åŠ©æ–‡æ¡£ï¼šæ¯ä¸ªå‘½ä»¤å’Œå‚æ•°éƒ½åº”æœ‰æ¸…æ™°çš„è¯´æ˜æ–‡æ¡£ã€‚ ç¤ºä¾‹ä½¿ç”¨æ–¹å¼ï¼šæä¾›å¸¸è§çš„ä½¿ç”¨ç¤ºä¾‹ï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿç†è§£å’Œåº”ç”¨ã€‚ å†…ç½®å¸®åŠ©å‘½ä»¤ï¼šé€šè¿‡å¦‚--helpæˆ–-hå‚æ•°è½»æ¾è®¿é—®å¸®åŠ©ä¿¡æ¯ã€‚ é”™è¯¯å¤„ç†ä¸åé¦ˆï¼š æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯ï¼šå‡ºç°é”™è¯¯æ—¶ï¼Œæä¾›æ˜ç¡®ã€å…·ä½“çš„é”™è¯¯ä¿¡æ¯ï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿå®šä½é—®é¢˜ã€‚ å»ºè®®å’Œè§£å†³æ–¹æ¡ˆï¼šåœ¨å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œç»™å‡ºé”™è¯¯è§£å†³çš„å»ºè®®æˆ–è‡ªåŠ¨ä¿®å¤é€‰é¡¹ã€‚ é«˜æ•ˆçš„æ‰§è¡Œå’Œè¾“å‡ºï¼š å¿«é€Ÿå“åº”ï¼šå‘½ä»¤æ‰§è¡Œåº”è¿…é€Ÿï¼Œå‡å°‘ç”¨æˆ·ç­‰å¾…æ—¶é—´ã€‚ æ ¼å¼åŒ–çš„è¾“å‡ºï¼šæä¾›æ˜“äºé˜…è¯»å’Œè§£æçš„è¾“å‡ºæ ¼å¼ï¼Œå¦‚è¡¨æ ¼ã€JSON æˆ– XML ç­‰ã€‚ è¾“å‡ºè¿‡æ»¤å’Œæ’åºï¼šå…è®¸ç”¨æˆ·æ ¹æ®éœ€è¦è¿‡æ»¤å’Œæ’åºè¾“å‡ºç»“æœï¼Œæé«˜ä¿¡æ¯çš„æŸ¥æ‰¾æ•ˆç‡ã€‚ è·¨å¹³å°å…¼å®¹ï¼š å¤šå¹³å°æ”¯æŒï¼šèƒ½å¤Ÿåœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸Šè¿è¡Œï¼Œå¦‚ Windowsã€macOSã€Linux ç­‰ã€‚ ç¯å¢ƒé€‚åº”æ€§ï¼šè‡ªåŠ¨é€‚åº”ä¸åŒçš„ç»ˆç«¯ç¯å¢ƒå’Œå­—ç¬¦ç¼–ç ï¼Œç¡®ä¿è¾“å‡ºæ˜¾ç¤ºæ­£ç¡®ã€‚ å®‰å…¨æ€§ï¼š å®‰å…¨çš„é»˜è®¤è®¾ç½®ï¼šé»˜è®¤é…ç½®åº”å¼ºè°ƒå®‰å…¨ï¼Œé¿å…æš´éœ²æ•æ„Ÿä¿¡æ¯ã€‚ æ•°æ®åŠ å¯†ï¼šåœ¨å¤„ç†æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚å¯†ç ï¼‰æ—¶ï¼Œåº”ä½¿ç”¨åŠ å¯†æ‰‹æ®µä¿æŠ¤æ•°æ®å®‰å…¨ã€‚ ç‰ˆæœ¬ç®¡ç†ï¼š ç‰ˆæœ¬æ§åˆ¶ï¼šæä¾›å‘½ä»¤æŸ¥çœ‹å·¥å…·ç‰ˆæœ¬ï¼Œæ”¯æŒå¤šç‰ˆæœ¬å…±å­˜æˆ–å‡çº§ã€‚ å‘åå…¼å®¹ï¼šæ–°ç‰ˆæœ¬åº”å°½é‡ä¿æŒä¸æ—§ç‰ˆæœ¬çš„å…¼å®¹æ€§ï¼Œé¿å…ç ´åç”¨æˆ·ç°æœ‰çš„å·¥ä½œæµç¨‹ã€‚ è¿™äº›ç‰¹æ€§ä¸ä»…èƒ½å¤Ÿæé«˜ç”¨æˆ·çš„å·¥ä½œæ•ˆç‡ï¼Œè¿˜èƒ½å¢å¼ºç”¨æˆ·ä½“éªŒï¼Œä½¿å‘½ä»¤è¡Œå·¥å…·æ›´åŠ å¼ºå¤§å’Œæ˜“ç”¨ã€‚ ä¸‹é¢æˆ‘ä»¬ä»¥ curl ä¸ºä¾‹ï¼Œçœ‹çœ‹ä¼˜ç§€çš„ CLI å·¥å…·å¤§æ¦‚é•¿ä»€ä¹ˆæ ·å­ã€‚ curl æ˜¯ä¸€ç§å‘½ä»¤è¡Œå·¥å…·å’Œåº“ï¼Œç”¨äºä¼ è¾“æ•°æ®ã€‚å®ƒæ”¯æŒå¤šç§åè®®ï¼ŒåŒ…æ‹¬ HTTPã€HTTPSã€FTPã€FTPSã€SCPã€SFTPã€TFTPã€TELNETã€DICTã€LDAPã€LDAPSã€IMAPã€POP3ã€SMTP å’Œ RTSP ç­‰ã€‚curl æ˜¯ä¸€ä¸ªéå¸¸å¼ºå¤§å’Œçµæ´»çš„å·¥å…·ï¼Œå¹¿æ³›åº”ç”¨äºè‡ªåŠ¨åŒ–è„šæœ¬ã€ç³»ç»Ÿæµ‹è¯•ã€æ•°æ®æ”¶é›†å’Œè®¸å¤šå…¶ä»–ç”¨é€”ã€‚ è¿›å…¥ç»ˆç«¯ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸‹é¢å‘½ä»¤æŸ¥çœ‹ curl çš„è¯´æ˜æ–‡æ¡£ï¼š âœ ~ curl --helpUsage: curl [options...] url -d, --data data HTTP POST data -f, --fail Fail fast with no output on HTTP errors -h, --help category Get help for commands -i, --include Include protocol response headers in the output -o, --output file Write to file instead of stdout -O, --remote-name Write output to a file named as the remote file -s, --silent Silent mode -T, --upload-file file Transfer local FILE to destination -u, --user user:password Server user and password -A, --user-agent name Send User-Agent name to server -v, --verbose Make the operation more talkative -V, --version Show version number and quitThis is not the full help, this menu is stripped into categories.Use --help category to get an overview of all categories.For all options use the manual or --help all. ä½¿ç”¨ç¤ºä¾‹ï¼š ä¸‹è½½æ–‡ä»¶ï¼š curl -O http://example.com/file.txt å‘é€ POST è¯·æ±‚ï¼š curl -d param1=value1param2=value2 http://example.com/resource ä½¿ç”¨ HTTPS å¹¶å¿½ç•¥è¯ä¹¦éªŒè¯ï¼š curl -k https://example.com ä½¿ç”¨åŸºæœ¬è®¤è¯ï¼š curl -u username:password http://example.com curl çš„è¿™äº›ç‰¹æ€§ä½¿å…¶æˆä¸ºå¼€å‘è€…ã€ç³»ç»Ÿç®¡ç†å‘˜å’Œè‡ªåŠ¨åŒ–è„šæœ¬ä¸­å¹¿æ³›ä½¿ç”¨çš„å·¥å…·ä¹‹ä¸€ã€‚ clap æ¦‚è¿° clapï¼Œä»£è¡¨ Command Line Argument Parserï¼Œæ˜¯ä¸€ä¸ªæ—¨åœ¨åˆ›å»ºç›´è§‚ã€æ˜“ç”¨ä¸”åŠŸèƒ½å¼ºå¤§çš„å‘½ä»¤è¡Œç•Œé¢çš„ Rust åº“ã€‚æˆªè‡³ç›®å‰ï¼ˆ2024.2ï¼‰ï¼Œclap å·²ç»å‘å±•åˆ°äº† 4.5.1 ç‰ˆæœ¬ï¼Œå®ƒé€šè¿‡ç®€åŒ–å‘½ä»¤è¡Œå‚æ•°çš„å¤„ç†ï¼Œè®©å¼€å‘è€…èƒ½æ›´ä¸“æ³¨äºåº”ç”¨é€»è¾‘çš„æ„å»ºã€‚ clap ä¹‹æ‰€ä»¥åœ¨ Rust ç¤¾åŒºå¦‚æ­¤æµè¡Œï¼Œå¾—ç›Šäºä»¥ä¸‹å‡ ä¸ªä¼˜ç‚¹ï¼š 1. æ˜“äºä½¿ç”¨ clap çš„è®¾è®¡ç†å¿µæ˜¯è®©å‘½ä»¤è¡Œå‚æ•°çš„è§£æå˜å¾—ç®€å•è€Œç›´è§‚ã€‚å³ä½¿æ˜¯æ²¡æœ‰ç»éªŒçš„å¼€å‘è€…ä¹Ÿèƒ½å¿«é€Ÿä¸Šæ‰‹ï¼Œé€šè¿‡å‡ è¡Œä»£ç å°±èƒ½å®ç°å¤æ‚çš„å‘½ä»¤è¡Œå‚æ•°è§£æã€‚ 2. åŠŸèƒ½ä¸°å¯Œ clap æä¾›äº†å¹¿æ³›çš„åŠŸèƒ½æ¥æ»¡è¶³å„ç§å‘½ä»¤è¡Œè§£æéœ€æ±‚ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š è‡ªåŠ¨ç”Ÿæˆçš„å¸®åŠ©ä¿¡æ¯ï¼šclap èƒ½æ ¹æ®å®šä¹‰çš„å‚æ•°è‡ªåŠ¨ç”Ÿæˆå¸®åŠ©ä¿¡æ¯ï¼ŒåŒ…æ‹¬å‚æ•°çš„è¯´æ˜ã€ç±»å‹ã€é»˜è®¤å€¼ç­‰ã€‚ å¼ºå¤§çš„é”™è¯¯æç¤ºï¼šå½“ç”¨æˆ·è¾“å…¥æ— æ•ˆçš„å‘½ä»¤è¡Œå‚æ•°æ—¶ï¼Œclap ä¼šæä¾›æ¸…æ™°ä¸”æœ‰ç”¨çš„é”™è¯¯æç¤ºï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿå®šä½é—®é¢˜ã€‚ å‚æ•°éªŒè¯ï¼šå¼€å‘è€…å¯ä»¥ä¸ºå‚æ•°è®¾å®šéªŒè¯è§„åˆ™ï¼Œç¡®ä¿è¾“å…¥çš„å‚æ•°ç¬¦åˆé¢„æœŸã€‚ å¤æ‚çš„å‘½ä»¤ç»“æ„ï¼šæ”¯æŒå­å‘½ä»¤çš„åµŒå¥—ï¼Œå…è®¸æ„å»ºå¤æ‚çš„å‘½ä»¤è¡Œåº”ç”¨ç»“æ„ã€‚ è‡ªå®šä¹‰æ´¾ç”Ÿï¼šé€šè¿‡ clap çš„æ´¾ç”Ÿå®ï¼Œå¯ä»¥ç®€åŒ–å‘½ä»¤è¡Œè§£æå™¨çš„å®šä¹‰ï¼Œä½¿ä»£ç æ›´åŠ æ¸…æ™°ã€‚ 3. é«˜åº¦å¯å®šåˆ¶ clap å…è®¸å¼€å‘è€…é«˜åº¦å®šåˆ¶å‘½ä»¤è¡Œè§£æçš„è¡Œä¸ºå’Œå¤–è§‚ï¼ŒåŒ…æ‹¬è‡ªå®šä¹‰å¸®åŠ©ä¿¡æ¯çš„æ ¼å¼ã€æ§åˆ¶é”™è¯¯æ¶ˆæ¯çš„æ˜¾ç¤ºæ–¹å¼ç­‰ã€‚è¿™ç§çµæ´»æ€§æ„å‘³ç€ä½ å¯ä»¥æ ¹æ®åº”ç”¨ç¨‹åºçš„éœ€æ±‚è°ƒæ•´ clap çš„è¡Œä¸ºã€‚ 4. æ€§èƒ½ä¼˜å¼‚ å°½ç®¡ clap åŠŸèƒ½å¼ºå¤§ï¼Œä½†å®ƒä»ç„¶éå¸¸æ³¨é‡æ€§èƒ½ã€‚clap ç»è¿‡ä¼˜åŒ–ï¼Œä»¥å°½å¯èƒ½å°‘çš„æ€§èƒ½å¼€é”€å¤„ç†å‘½ä»¤è¡Œå‚æ•°ã€‚ 5. æ´»è·ƒçš„ç¤¾åŒºæ”¯æŒ clap æœ‰ä¸€ä¸ªéå¸¸æ´»è·ƒçš„ç¤¾åŒºï¼Œåœ¨ GitHub ä¸Šä¸æ–­æœ‰æ–°çš„è´¡çŒ®è€…åŠ å…¥ã€‚è¿™æ„å‘³ç€ clap ä¸æ–­åœ°å¾—åˆ°æ”¹è¿›å’Œæ›´æ–°ï¼ŒåŒæ—¶ä¹Ÿæœ‰å¤§é‡çš„ç¤¾åŒºèµ„æºå¯ä¾›å‚è€ƒã€‚ Derive vs Builder (1) åˆæ¢ clap æä¾›äº† 2 ç§æ„å»ºå‘½ä»¤è¡Œçš„æ–¹å¼ï¼Œåˆ†åˆ«ä¸º Derive å’Œ Builderã€‚é¡¾åæ€ä¹‰ï¼ŒDerive å°±æ˜¯åˆ©ç”¨å®å¼ºå¤§çš„åŠŸèƒ½æ¥æ„å»ºå‘½ä»¤è¡Œï¼Œè€Œ Builder åˆ™é‡‡ç”¨æ„å»ºè€…æ¨¡å¼é“¾å¼æ„å»ºå‘½ä»¤è¡Œå·¥å…·ã€‚ åœ¨è¿™é‡Œæˆ‘ä»¬å…ˆç»™å‡ºç¤ºä¾‹æ¥ç›´è§‚æ„Ÿå—è¿™ 2 ç§æ„å»ºæ–¹å¼çš„ä¸åŒï¼š Derive: #[derive(Parser)]#[command(version, author, about, long_about = None)]struct Cli /// Specify your name name: String, /// Specify your age optionally #[arg(short, long)] age: Optioni8,fn main() let cli = Cli::parse(); println!(name: , cli.name); println!(age: :?, cli.age); Builder: fn main() let matches = Command::new(myapp) .version(1.0.0) .author(hedon) .about(this is the short about) .long_about(this is the long about) .arg(arg!([NAME]).required(true).help(Specify your name)) .arg(arg!(-a --age AGE) .value_parser(clap::value_parser!(u8)) .help(Specify your age optionally)) .get_matches(); println!(name: :?, matches.get_one::String(NAME)); println!(age: :?, matches.get_one::u8(age)); è¿™ 2 ä¸ªç¨‹åºéƒ½å®ç°äº†ç›¸åŒçš„åŠŸèƒ½ï¼Œä½¿ç”¨ --help ï¼Œè¾“å‡ºçš„å†…å®¹å¤§è‡´éƒ½å¦‚ä¸‹ï¼š Usage: derive [OPTIONS] NAMEArguments: NAME Specify your nameOptions: -a, --age AGE Specify your age optionally -h, --help Print help é€šè¿‡è§‚å¯Ÿï¼Œå¯ä»¥å‘ç° Derive æ¨¡å¼ä¸‹ï¼Œå®ä¸­çš„æ¯ä¸€ä¸ªå±æ€§ï¼Œå¦‚ versionã€author ç­‰ï¼Œéƒ½å¯¹åº”åˆ° Builder æ¨¡å¼ä¸‹ä¸€ä¸ªåŒåçš„å‡½æ•°ã€‚ ä¸‹é¢æˆ‘ä»¬å°†ä»ã€Œåº”ç”¨é…ç½®ã€ã€ã€Œå‚æ•°ç±»å‹ã€å’Œã€Œå‚æ•°æ ¡éªŒã€ä¸‰ä¸ªæ–¹é¢ï¼Œåˆ†åˆ«ä»‹ç» clap ä¸­ Derive å’Œ Builder ä¸¤ç§æ¨¡å¼æ„å»º CLI çš„å¸¸ç”¨æ–¹æ³•ã€‚ ç‰¹åˆ«è¯´æ˜ï¼šåç»­çš„ä¾‹å­å‡åœ¨ examples ç›®å½•ä¸‹å®ç°ï¼Œæ•…ç¼–è¯‘å’Œæ‰§è¡Œå‘½ä»¤éƒ½åŒ…å« exampleã€‚ ç›®å½•ç»“æ„å¤§æ¦‚å¦‚ä¸‹ï¼š âœ learn-clap git:(master) âœ— tree .â”œâ”€â”€ Cargo.lockâ”œâ”€â”€ Cargo.tomlâ”œâ”€â”€ examplesâ”‚ â”œâ”€â”€ optional.rsâ”œâ”€â”€ srcâ”‚ â””â”€â”€ main.rsâ””â”€â”€ target â””â”€â”€ release â””â”€â”€ examples â””â”€â”€ optional Derive è¦ä½¿ç”¨ clap çš„ Derive æ¨¡å¼ï¼Œéœ€è¦ï¼š cargo add clap --features derive 1. åº”ç”¨é…ç½® æˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ª strut æ¥è¡¨ç¤ºæˆ‘ä»¬çš„ applicationï¼Œåˆ©ç”¨å®ƒæ¥æ‰¿è½½åº”ç”¨çš„å‚æ•°ï¼š /// The example of clap derive#[derive(Parser)]#[command(version, author, about, long_about = None)]struct Cli /// Specify your name name: String, /// Specify your age optionally #[arg(short, long)] age: Optioni8,fn main() let cli = Cli::parse(); println!(name: , cli.name); println!(age: :?, cli.age); #[derive(Parser)] æ˜¯ä¸€ä¸ªè¿‡ç¨‹å®ï¼ˆprocedural macroï¼‰ï¼Œç”¨äºè‡ªåŠ¨ä¸ºç»“æ„ä½“å®ç° clap::Parser traitã€‚è¿™ä½¿å¾—è¯¥ç»“æ„ä½“å¯ä»¥ç”¨æ¥è§£æå‘½ä»¤è¡Œå‚æ•°ã€‚ ä½¿ç”¨ #[derive(Parser)]ï¼Œä½ å¯ä»¥ç®€åŒ–å‘½ä»¤è¡Œè§£æçš„ä»£ç ï¼Œå› ä¸º clap ä¼šæ ¹æ®ç»“æ„ä½“çš„å­—æ®µè‡ªåŠ¨ç”Ÿæˆå‘½ä»¤è¡Œè§£æçš„é€»è¾‘ã€‚ æ¯ä¸ªå­—æ®µéƒ½å¯¹åº”ä¸€ä¸ªå‘½ä»¤è¡Œå‚æ•°ï¼Œå­—æ®µçš„ç±»å‹å’Œå±æ€§ç”¨æ¥å†³å®šå‚æ•°çš„è§£ææ–¹å¼å’ŒéªŒè¯è§„åˆ™ã€‚ #[command(version, about, long_about = None)] å±æ€§ç”¨äºä¸ºæ•´ä¸ªå‘½ä»¤è¡Œç¨‹åºæä¾›å…ƒä¿¡æ¯ï¼Œå®ƒæ”¯æŒä»¥ä¸‹å‡ ä¸ªå…ƒç´ ï¼š #[command] æ”¯æŒçš„å…ƒç´  #[arg(short, long)] å±æ€§ç”¨äºé…ç½®å‘½ä»¤å‚æ•°çš„å…ƒä¿¡æ¯ï¼Œå®ƒæ”¯æŒä»¥ä¸‹å‡ ä¸ªå±æ€§ï¼š å±æ€§ æ–¹æ³• é»˜è®¤å€¼/è¡Œä¸º å¤‡æ³¨ id Arg::id fieldâ€™s name å½“å±æ€§ä¸å­˜åœ¨æ—¶ï¼Œä½¿ç”¨å­—æ®µå value_parser Arg::value_parser auto-select based on field type å½“å±æ€§ä¸å­˜åœ¨æ—¶ï¼Œä¼šåŸºäºå­—æ®µç±»å‹è‡ªåŠ¨é€‰æ‹©å®ç° action Arg::action auto-select based on field type å½“å±æ€§ä¸å­˜åœ¨æ—¶ï¼Œä¼šåŸºäºå­—æ®µç±»å‹è‡ªåŠ¨é€‰æ‹©åŠ¨ä½œ help Arg::help Doc comment summary å½“å±æ€§ä¸å­˜åœ¨æ—¶ï¼Œä½¿ç”¨æ–‡æ¡£æ³¨é‡Šæ‘˜è¦ long_help Arg::long_help Doc comment with blank line, else nothing å½“å±æ€§ä¸å­˜åœ¨æ—¶ï¼Œä½¿ç”¨æ–‡æ¡£æ³¨é‡Šï¼Œå¦‚æœæœ‰ç©ºè¡Œ verbatim_doc_comment Minimizes preprocessing - å°†æ–‡æ¡£æ³¨é‡Šè½¬æ¢ä¸º help/long_help æ—¶æœ€å°åŒ–é¢„å¤„ç† short Arg::short no short set å½“å±æ€§ä¸å­˜åœ¨æ—¶ï¼Œæ²¡æœ‰çŸ­åç§°è®¾ç½® long Arg::long no long set å½“å±æ€§ä¸å­˜åœ¨æ—¶ï¼Œæ²¡æœ‰é•¿åç§°è®¾ç½® env Arg::env no env set å½“å±æ€§ä¸å­˜åœ¨æ—¶ï¼Œæ²¡æœ‰ç¯å¢ƒå˜é‡è®¾ç½® from_global Read Arg::global - æ— è®ºåœ¨å“ªä¸ªå­å‘½ä»¤ä¸­ï¼Œéƒ½è¯»å– Arg::global å‚æ•° value_enum Parse with ValueEnum - ä½¿ç”¨ ValueEnum è§£æå€¼ skip Ignore this field fills the field with Default::default() å¿½ç•¥æ­¤å­—æ®µï¼Œç”¨ expr æˆ– Default::default() å¡«å…… default_value Arg::default_value Arg::required(false) è®¾ç½®é»˜è®¤å€¼ï¼Œå¹¶å°† Arg è®¾ç½®ä¸ºéå¿…é¡» default_value_t Arg::default_value Arg::required(false) è¦æ±‚ std::fmt::Display ä¸ Arg::value_parser ç›¸åŒ¹é… default_values_t Arg::default_values Arg::required(false) è¦æ±‚å­—æ®µç±»å‹ä¸º VecTï¼ŒT å®ç° std::fmt::Display default_value_os_t Arg::default_value_os Arg::required(false) è¦æ±‚ std::convert::IntoOsString default_values_os_t Arg::default_values_os Arg::required(false) è¦æ±‚å­—æ®µç±»å‹ä¸º VecTï¼ŒT å®ç°std::convert::IntoOsString 2. å‚æ•°ç±»å‹ 2.1 Arguments Options ä»ä¸Šé¢è¿™ä¸ªè¾“å‡ºæ ·ä¾‹ä¸­ï¼š the example of clap deriveUsage: derive [OPTIONS] NAMEArguments: NAME Specify your nameOptions: -a, --age AGE Specify your age optionally -h, --help Print help å¯ä»¥çœ‹åˆ°è·Ÿåœ¨å‘½ä»¤åé¢æœ‰ 2 ä¸­å‚æ•°ç±»å‹ï¼š Arguments: ç›´æ¥åœ¨å‘½ä»¤åé¢æŒ‡å®šå€¼ï¼Œå¦‚ cmd hedonï¼Œæœ‰ä¸¥æ ¼çš„é¡ºåºè¦æ±‚ã€‚ Options: éœ€è¦ç”¨ -short æˆ– --long æ¥æŒ‡å®šæ˜¯å“ªä¸ªå‚æ•°ï¼Œæ— ä¸¥æ ¼çš„é¡ºåºè¦æ±‚ã€‚ å®ƒä»¬çš„å®šä¹‰åŒºåˆ«å°±æ˜¯æ˜¯å¦ä½¿ç”¨äº† #[arg]ï¼š Options: æŒ‡å®šäº† short æˆ– longã€‚ Arguments: æ²¡æœ‰ short å’Œ longã€‚ #[derive(Parser)]struct Cli /// ä¼šè¢«è§£ææˆ [NAME] name: String, /// ä¼šè¢«è§£ææˆ -a AGE #[arg(short, long)] age: u8, 2.2 å¯é€‰å‚æ•° å¯ä»¥ä½¿ç”¨ Option æ¥å®ç°å¯é€‰å‚æ•°ï¼š use clap::Parser;#[derive(Parser)]#[command(version, author, about, long_about = None)]struct Cli name: OptionString, #[arg(short, long)] age: Optionu8,fn main() let cli = Cli::parse(); println!(name: :?, cli.name); println!(age: :?, cli.age); ç¼–è¯‘ï¼š cargo build --example optional --release æ‰§è¡Œï¼š /target/release/examples/optional --help è¾“å‡ºï¼š this is the about from Cargo.tomlUsage: optional [OPTIONS] [NAME]Arguments: [NAME] Options: -a, --age AGE -h, --help Print help -V, --version Print version æµ‹è¯•ï¼š âœ learn-clap git:(master) âœ— ./target/release/examples/optional name: Noneage: Noneâœ learn-clap git:(master) âœ— ./target/release/examples/optional -a 1 name: Noneage: Some(1)âœ learn-clap git:(master) âœ— ./target/release/examples/optional hedon name: Some(hedon)age: Noneâœ learn-clap git:(master) âœ— ./target/release/examples/optional hedon -a 18name: Some(hedon)age: Some(18) 2.3 æšä¸¾å‚æ•° å¯ä»¥ä½¿ç”¨ enum æ­é… value_enum æ¥å®ç°å¤šé€‰ä¸€å‚æ•°ï¼Œå¹¶é™åˆ¶å¯é€‰å‚æ•°çš„å–å€¼ã€‚ use clap::Parser, ValueEnum;#[derive(Parser)]#[command(version, author, about, long_about = None)]struct Cli /// Choose the program mode run in #[arg(value_enum)] mode: Mode,#[derive(Copy, Clone, PartialEq, Eq, PartialOrd, Ord, ValueEnum)]enum Mode /// run in fast mode Fast, /// run in slow mode Slow,fn main() let cli = Cli::parse(); match cli.mode Mode::Fast = println!(fast!!!!!), Mode::Slow = println!(slow......), è¾“å‡ºï¼š Usage: enum MODEArguments: MODE Choose the program mode run in Possible values: - fast: run in fast mode - slow: run in slow modeOptions: -h, --help Print help (see a summary with -h) -V, --version Print version 2.4 ç´¯è®¡å‚æ•° ç´¯ç§¯å‚æ•°å…è®¸ç”¨æˆ·é€šè¿‡é‡å¤æŒ‡å®šåŒä¸€ä¸ªæ ‡å¿—ï¼ˆä¾‹å¦‚ -dï¼‰æ¥ç´¯åŠ å€¼æˆ–æ•ˆæœï¼Œé€šå¸¸ç”¨äºæ§åˆ¶å‘½ä»¤è¡Œåº”ç”¨çš„è¯¦ç»†çº§åˆ«ï¼ˆverbosity levelï¼‰æˆ–å…¶ä»–éœ€è¦æ ¹æ®æ¬¡æ•°å˜åŒ–çš„è¡Œä¸ºã€‚ åœ¨å¾ˆå¤šå‘½ä»¤è¡Œå·¥å…·ä¸­ï¼Œç´¯ç§¯å‚æ•°å¸¸è§äºæ§åˆ¶æ—¥å¿—è¾“å‡ºçš„è¯¦ç»†ç¨‹åº¦ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ª -vï¼ˆverboseï¼‰æ ‡å¿—å¯èƒ½æ¯è¢«æŒ‡å®šä¸€æ¬¡ï¼Œå°±å¢åŠ ä¸€å±‚è¯¦ç»†çº§åˆ«ã€‚æ‰€ä»¥ï¼Œ-vvvï¼ˆç­‰ä»·äº -v -v -vï¼‰ ä¼šæ¯”å•ä¸ª -v æä¾›æ›´å¤šçš„è¯¦ç»†ä¿¡æ¯ã€‚ åœ¨ clap ä¸­å¯ä»¥é€šè¿‡ clap::ArgAction::Count æ¥å®ç°è¿™ç§ç´¯ç§¯å‚æ•°ã€‚ use clap::Parser;#[derive(Parser)]#[command(version, author, about, long_about = None)]struct Cli #[arg(short, long, action = clap::ArgAction::Count)] verbose: u8,fn main() let cli = Cli::parse(); println!(verbose: , cli.verbose); è¾“å‡ºï¼š âœ learn-clap git:(master) âœ— ./target/release/examples/accurate --helpthis is the about from Cargo.tomlUsage: accurate [OPTIONS]Options: -v, --verbose... -h, --help Print help -V, --version Print versionâœ learn-clap git:(master) âœ— ./target/release/examples/accurate -v verbose: 1âœ learn-clap git:(master) âœ— ./target/release/examples/accurate -vvvvverbose: 4 2.5 å˜é•¿å‚æ•° æœ‰æ—¶å€™æˆ‘ä»¬å¸Œæœ›æ¥æ”¶å˜é•¿å‚æ•°ï¼Œæ¯”å¦‚è¯´ï¼š del file1 file2 file3 è¿™ä¸ªæ—¶å€™å¯ä»¥ä½¿ç”¨ Vec æ¥å®ç°ã€‚ use clap::Parser;#[derive(Parser)]#[command(version, author, about, long_about = None)]struct Cli files: VecString,fn main() let cli = Cli::parse(); println!(files: :?, cli.files); è¾“å‡ºï¼š âœ learn-clap git:(master) âœ— ./target/release/examples/var_length --helpthis is the about from Cargo.tomlUsage: var_length [FILES]...Arguments: [FILES]... Options: -h, --help Print help -V, --version Print versionâœ learn-clap git:(master) âœ— ./target/release/examples/var_length files: []âœ learn-clap git:(master) âœ— ./target/release/examples/var_length file1 files: [file1]âœ learn-clap git:(master) âœ— ./target/release/examples/var_length file1 file2files: [file1, file2]âœ learn-clap git:(master) âœ— ./target/release/examples/var_length file1 file2 file3files: [file1, file2, file3] 2.6 æ ‡å¿—å‚æ•° å¯¹äºæ ‡å¿—å‚æ•°ï¼Œåªè¦æŒ‡å®šç±»å‹ä¸º boolï¼Œå°±å¯ä»¥è‡ªåŠ¨å®ç°äº†ã€‚ use clap::Parser;#[derive(Parser)]#[command(version, author, about, long_about = None)]struct Cli #[arg(short, long)] verbose: bool,fn main() let cli = Cli::parse(); println!(verbose: , cli.verbose); è¾“å‡ºï¼š âœ learn-clap git:(master) âœ— ./target/release/examples/flag --helpUsage: flag [OPTIONS]Options: -v, --verbose -h, --help Print help -V, --version Print versionâœ learn-clap git:(master) âœ— ./target/release/examples/flag verbose: falseâœ learn-clap git:(master) âœ— ./target/release/examples/flag -v verbose: true 2.7 å­å‘½ä»¤ åœ¨æ›´å¤æ‚çš„å‘½ä»¤è¡Œå·¥å…·ä¸­ï¼Œé™¤äº†ä¸»å‘½ä»¤ï¼Œè¿˜æœ‰å­å‘½ä»¤ï¼Œç”šè‡³å­å‘½ä»¤ä¸‹é¢è¿˜æœ‰å­å‘½ä»¤ï¼Œå…¶å®å°±æ˜¯ä¸€é¢—å‘½ä»¤æ ‘ã€‚ command tree åœ¨ clap ä¸­å¯ä»¥ä½¿ç”¨ #[command(subcommand)] æ­é… #[derive(Subcommand)] å®ç°å­å‘½ä»¤åŠŸèƒ½ã€‚ use clap::Parser, Subcommand;#[derive(Parser)]#[command(version, author, about, long_about = None)]struct Cli #[command(subcommand)] test: OptionTest,#[derive(Subcommand)]enum Test /// Add a number Add #[arg(short, long)] num: u16, , /// Sub a number Sub #[arg(short, long)] num: u16, fn main() let cli = Cli::parse(); if let Some(test) = cli.test match test Test::Add num = println!(test add num: :?, num), Test::Sub num = println!(test sub num: :?, num), è¾“å‡ºï¼š âœ learn-clap git:(master) âœ— ./target/release/examples/subcommand --help this is the about from Cargo.tomlUsage: subcommand [COMMAND]Commands: add Add a number sub Sub a number help Print this message or the help of the given subcommand(s)Options: -h, --help Print help -V, --version Print versionâœ learn-clap git:(master) âœ— ./target/release/examples/subcommand add --helpAdd a numberUsage: subcommand add --num NUMOptions: -n, --num NUM -h, --help Print helpâœ learn-clap git:(master) âœ— ./target/release/examples/subcommand add -n 1 test add num: 1âœ learn-clap git:(master) âœ— ./target/release/examples/subcommand sub -n 2test sub num: 2 3. å‚æ•°æ ¡éªŒ 3.1 ç±»å‹æ ¡éªŒ å¯ä»¥å‘ç°ï¼Œä½¿ç”¨ Derive æ¨¡å¼çš„æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨å‚æ•°åé¢æŒ‡å®šå‚æ•°ç±»å‹çš„æ—¶å€™ï¼Œclap å°±ä¼šå¯¹æˆ‘ä»¬è¾“å…¥å‚æ•°è¿›è¡Œç±»å‹æ£€æŸ¥ï¼Œä¸åŒ¹é…çš„æ—¶å€™ä¼šè¾“å‡ºä¸°å¯Œçš„æŠ¥é”™ä¿¡æ¯å’ŒæŒ‡å¯¼å»ºè®®ã€‚ error: invalid value xxxx for --num NUM: invalid digit found in stringFor more information, try --help. é»˜è®¤æ”¯æŒï¼š åŸç”Ÿç±»å‹ï¼šbool, String, OsString, PathBufã€usizeã€isize èŒƒå›´æ•°æ®ï¼šu8, i8, u16, i16, u32, i32, u64, i64 å®ç°äº† ValueEnum çš„ enum ç±»å‹ å®ç°äº† FromOsStringã€FromOsStr ã€FromStr çš„ç±»å‹ è¿™æ˜¯å› ä¸ºä»–ä»¬éƒ½å®ç°äº† TypedValueParser traitï¼Œä½ è‡ªå®šä¹‰çš„ç±»å‹ä¹Ÿå¯ä»¥å®ç°è¿™ä¸ª triatï¼Œè¿™æ ·å°±å¯ä»¥è‡ªåŠ¨è¿›è¡Œç±»å‹æ ¡éªŒäº†ã€‚ clap è¿˜æä¾›äº†ä¸€äº›æ›´åŠ ä¸¥æ ¼çš„å‚æ•°æ ¡éªŒåŠŸèƒ½ã€‚ğŸ‘‡ğŸ» 3.2 æšä¸¾æ ¡éªŒ å¯¹äºå®ç° ValueEnum çš„æšä¸¾ç±»å‹ï¼Œå¦‚æœè¾“å…¥çš„å€¼ä¸æ˜¯æšä¸¾ä¸­å®šä¹‰çš„ï¼Œåˆ™ clap ä¼šæŠ¥é”™å¹¶æç¤ºå¯é€‰å€¼ã€‚ æˆ‘ä»¬å¤ç”¨ä¸Šé¢ä»‹ç»ã€Œå¤šé€‰ä¸€å‚æ•°ã€çš„ä»£ç ï¼š use clap::Parser, ValueEnum;#[derive(Parser)]#[command(version, author, about, long_about = None)]struct Cli /// Choose the program mode run in #[arg(value_enum)] mode: Mode,#[derive(Copy, Clone, PartialEq, Eq, PartialOrd, Ord, ValueEnum)]enum Mode /// run in fast mode Fast, /// run in slow mode Slow,fn main() let cli = Cli::parse(); match cli.mode Mode::Fast = println!(fast!!!!!), Mode::Slow = println!(slow......), ä½¿ç”¨é”™è¯¯çš„å€¼è¿›è¡Œå°è¯•ï¼š âœ learn-clap git:(master) âœ— ./target/release/examples/enum xxxx error: invalid value xxxx for MODE [possible values: fast, slow]For more information, try --help. 3.3 èŒƒå›´æ ¡éªŒ å¦‚æœä½ æƒ³è¦å®ç°æ•°å­—ç±»å‹èŒƒå›´é™åˆ¶çš„è¯ï¼Œæ¯”å¦‚ç«¯å£å·å‚æ•°çš„èŒƒå›´åº”è¯¥æ˜¯ [1, 65535]ï¼Œé‚£å¯ä»¥ä½¿ç”¨ value_parser! = clap::value_parser!(u16).range(1..) æ¥å®ç°è¿™ä¸ªåŠŸèƒ½ï¼š use clap::Parser;#[derive(Parser)]#[command(version, author, about, long_about = None)]struct Cli #[arg(short, long, value_parser = clap::value_parser!(u16).range(1..))] port: u16,fn main() let cli = Cli::parse(); println!(port: :?, cli.port); è¾“å‡ºï¼š âœ learn-clap git:(master) âœ— ./target/release/examples/range --help this is the about from Cargo.tomlUsage: range --port PORTOptions: -p, --port PORT -h, --help Print help -V, --version Print version âœ learn-clap git:(master) âœ— ./target/release/examples/range -p 0 error: invalid value 0 for --port PORT: 0 is not in 1..=65535For more information, try --help.âœ learn-clap git:(master) âœ— ./target/release/examples/range -p 11111111error: invalid value 11111111 for --port PORT: 11111111 is not in 1..=65535For more information, try --help.âœ learn-clap git:(master) âœ— ./target/release/examples/range -p 1111 port: 1111 åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œvalue_parser = clap::value_parser!(u16).range(1..) çš„å«ä¹‰å¯ä»¥åˆ†ä¸ºä¸¤éƒ¨åˆ†è§£é‡Šï¼š 1. clap::value_parser!(u16) è¿™éƒ¨åˆ†ä½¿ç”¨ value_parser! å®ä¸ºå‘½ä»¤è¡Œå‚æ•°æŒ‡å®šäº† u16 ç±»å‹çš„è§£æå™¨ã€‚è¿™æ„å‘³ç€è¾“å…¥çš„å‚æ•°å€¼ä¼šè¢«å°è¯•è§£æä¸ºæ— ç¬¦å· 16 ä½æ•´æ•°ï¼ˆu16ï¼‰ã€‚å¦‚æœè¾“å…¥ä¸èƒ½è¢«æˆåŠŸè§£æä¸º u16 ç±»å‹ï¼ˆä¾‹å¦‚ï¼Œè¾“å…¥æ˜¯éæ•°å­—å­—ç¬¦ä¸²æˆ–è€…æ•°å­—è¿‡å¤§/è¿‡å°è€Œä¸ç¬¦åˆ u16 çš„èŒƒå›´ï¼‰ï¼Œclap ä¼šæŠ¥é”™å¹¶æç¤ºç”¨æˆ·è¾“å…¥æœ‰æ•ˆçš„å‚æ•°å€¼ã€‚ 2. .range(1..) è¿™éƒ¨åˆ†è¿›ä¸€æ­¥é™åˆ¶äº†å‚æ•°å€¼çš„æœ‰æ•ˆèŒƒå›´ã€‚.range(1..) æŒ‡å®šäº†å‚æ•°å€¼å¿…é¡»å¤§äºæˆ–ç­‰äº 1ï¼ˆåŒ…å« 1ï¼‰ï¼Œä½†æ²¡æœ‰ä¸Šé™ã€‚æ¢å¥è¯è¯´ï¼Œä»»ä½•å°äº 1 çš„å€¼éƒ½å°†è¢«è®¤ä¸ºæ˜¯æ— æ•ˆçš„ï¼Œclap ä¼šå› æ­¤æŠ¥é”™å¹¶è¦æ±‚ç”¨æˆ·è¾“å…¥ä¸€ä¸ªç¬¦åˆèŒƒå›´è¦æ±‚çš„å€¼ã€‚è¿™åœ¨éœ€è¦é™å®šå‚æ•°å€¼ä¸ºæ­£æ•°æ—¶éå¸¸æœ‰ç”¨ã€‚ ç»“åˆèµ·æ¥ï¼Œvalue_parser = clap::value_parser!(u16).range(1..) åˆ›å»ºäº†ä¸€ä¸ªè§„åˆ™ï¼Œè¦æ±‚å‘½ä»¤è¡Œå‚æ•°å¿…é¡»æ˜¯ä¸€ä¸ªå¤§äºæˆ–ç­‰äº 1 çš„ u16 ç±»å‹çš„æ•°å€¼ã€‚è¿™åœ¨å¾ˆå¤šåœºæ™¯ä¸‹éƒ½éå¸¸æœ‰ç”¨ï¼Œæ¯”å¦‚å½“ä½ éœ€è¦ç”¨æˆ·æŒ‡å®šä¸€ä¸ªæ­£æ•°ç«¯å£å·æ—¶ã€‚ åœ¨ RustRover ä¸­ï¼Œä½ å¯ä»¥åœ¨ Builder æ¨¡å¼ï¼Œé€šè¿‡åœ¨ clap::value_parser!() ä¸­æŒ‡å®šå…¶ä»–çš„ç±»å‹ï¼Œç„¶åè¾“å…¥ . è·å¾—å…¶ä»–ç±»å‹çš„å†…ç½®æ ¡éªŒè§„åˆ™ã€‚ 3.4 è‡ªå®šä¹‰æ ¡éªŒ å¯¹äºæ›´å¤æ‚çš„è§„åˆ™ï¼Œclap è¿˜æ”¯æŒè‡ªå®šä¹‰æ ¡éªŒè§„åˆ™ã€‚æ¯”å¦‚ä¸Šé¢å¯¹ port çš„æ ¡éªŒï¼Œä¹Ÿå¯ä»¥è‡ªå·±å®ç°ã€‚ use std::ops::RangeInclusive;use clap::Parser;#[derive(Parser)]#[command(version, author, about, long_about = None)]struct Cli #[arg(short, long, value_parser = parse_port)] port: u16,const PORT_RANGE: RangeInclusiveusize = 1..=65535;fn parse_port(s: str) - Resultu16, String let port: usize = s .parse() .map_err(|_| format!(`s` isnt a port number`))?; if PORT_RANGE.contains(port) Ok(port as u16) else Err(format!( port not in range -, PORT_RANGE.start(), PORT_RANGE.end(), )) fn main() let cli = Cli::parse(); println!(port: :?, cli.port); åœ¨ä»£ç ä¸­ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ value_parser = parse_port æ¥æŒ‡å®šè‡ªå®šä¹‰çš„æ ¡éªŒè§„åˆ™ã€‚ æˆ‘ä»¬è‡ªå®šä¹‰çš„æ ¡éªŒè§„åˆ™ä¸ºï¼š fn parse_port(s: str) - Resultu16, String å®ƒéœ€è¦æ»¡è¶³ï¼š å…¥å‚æ˜¯ str å‡ºå‚æ˜¯ Resultå‚æ•°ç±»å‹, String å¯ä»¥æµ‹è¯•è¾“å‡ºï¼š âœ learn-clap git:(master) âœ— ./target/release/examples/custom --helpthis is the about from Cargo.tomlUsage: custom --port PORTOptions: -p, --port PORT -h, --help Print help -V, --version Print version âœ learn-clap git:(master) âœ— ./target/release/examples/custom -p xxxerror: invalid value xxx for --port PORT: `xxx` isnt a port number`For more information, try --help.âœ learn-clap git:(master) âœ— ./target/release/examples/custom -p 0 error: invalid value 0 for --port PORT: port not in range 1-65535For more information, try --help.âœ learn-clap git:(master) âœ— ./target/release/examples/custom -p 9527port: 9527 3.5 å…³è”å‚æ•° æœ‰æ—¶å€™å‚æ•°ç›´æ¥è¿˜æœ‰å…³è”å…³ç³»ï¼Œæ¯”å¦‚è¯´ï¼š ä¾èµ–ï¼šå¿…é¡»å­˜åœ¨ -a å‚æ•°ï¼Œ-b å‚æ•°æ‰æœ‰æ„ä¹‰ï¼Œå³è¦ä½¿ç”¨ -b å‚æ•°æ—¶ï¼Œå¿…é¡»æŒ‡å®š -a å‚æ•°ã€‚ äº’æ–¥ï¼š-a å’Œ -b åªèƒ½åŒæ—¶å­˜åœ¨ä¸€ä¸ªã€‚ å¯ä»¥ä½¿ç”¨ requires å®ç°ä¾èµ–å…³ç³»ï¼š use clap::Parser;#[derive(Parser)]#[command(version, author, about, long_about = None)]struct Cli #[arg(short, long)] a: OptionString, #[arg(short, long,requires = a)] b: OptionString,fn main() let cli = Cli::parse(); println!(a: :?, cli.a); println!(b: :?, cli.b); ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬åœ¨å‚æ•° b ä¸­åŠ å…¥äº† requires = \"a\"ï¼Œè¡¨ç¤ºè¦ä½¿ç”¨ b å‚æ•°å¿…é¡»è¦æœ‰ a å‚æ•°ã€‚ è¾“å‡ºï¼š âœ learn-clap git:(master) âœ— ./target/release/examples/relation a: Noneb: Noneâœ learn-clap git:(master) âœ— ./target/release/examples/relation -b 1 error: the following required arguments were not provided: --a AUsage: relation --a A --b BFor more information, try --help.âœ learn-clap git:(master) âœ— ./target/release/examples/relation -a 1a: Some(1)b: Noneâœ learn-clap git:(master) âœ— ./target/release/examples/relation -a 1 -b 2a: Some(1)b: Some(2) å¯ä»¥ä½¿ç”¨ #[group(required = true, mutiple = false)] æ¥å®ç°äº’æ–¥å…³ç³»ï¼š use clap::Args, Parser;#[derive(Parser)]#[command(version, author, about, long_about = None)]struct Cli #[command(flatten)] args: Only,#[derive(Args, Debug)]#[group(required = true, multiple = false)]struct Only #[arg(long)] a: OptionString, #[arg(long)] b: OptionString, #[arg(long)] c: OptionString, #[arg(long)] d: OptionString,fn main() let cli = Cli::parse(); println!(only: :?, cli.args) #[command(flattern)] ç›´æ¥å°†ç»“æ„ä½“é‡Œé¢çš„å‚æ•°å¹³é“ºã€‚ #[group] ç”¨äºå°†ä¸€ç»„å‚æ•°å½’ä¸ºä¸€ä¸ªç»„ï¼Œrequired = true è¡¨ç¤ºå¿…é¡»æä¾›è¯¥ group ä¸­çš„å‚æ•°ï¼Œmultiple = false è¡¨ç¤ºåªèƒ½æœ‰ä¸€ä¸ªå‚æ•°è¢«æä¾›ã€‚ æµ‹è¯•è¾“å‡ºå¦‚ä¸‹ï¼š âœ learn-clap git:(master) âœ— ./target/release/examples/only_one --helpthis is the about from Cargo.tomlUsage: only_one --a A|--b B|--c C|--d DOptions: --a A --b B --c C --d D -h, --help Print help -V, --version Print version âœ learn-clap git:(master) âœ— ./target/release/examples/only_one error: the following required arguments were not provided: --a A|--b B|--c C|--d DUsage: only_one --a A|--b B|--c C|--d DFor more information, try --help.âœ learn-clap git:(master) âœ— ./target/release/examples/only_one --a 1 only: Only a: Some(1), b: None, c: None, d: None âœ learn-clap git:(master) âœ— ./target/release/examples/only_one --a 1 --b 2error: the argument --a A cannot be used with --b BUsage: only_one --a A|--b B|--c C|--d DFor more information, try --help.âœ learn-clap git:(master) âœ— ./target/release/examples/only_one --b 2 only: Only a: None, b: Some(2), c: None, d: None Builder ä½¿ç”¨ clap çš„ Builder æ¨¡å¼ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸éœ€è¦é¢å¤–å¼•å…¥å…¶ä»–çš„ featuresï¼š cargo add clap ä½†æ˜¯å¦‚æœè¦ä½¿ç”¨ command! æ¥æ„å»ºåº”ç”¨çš„è¯ï¼Œéœ€è¦å¼•å…¥ cargo è¿™ä¸ª featuresï¼š cargo add clap --features cargo 1. åº”ç”¨é…ç½® åœ¨ Builder æ¨¡å¼ä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨ command!() æˆ– Command::new(\"appname\") æ¥æ„å»ºä¸€ä¸ªå‘½ä»¤è¡Œåº”ç”¨ï¼Œå…¶ä¸­ command!() é»˜è®¤å°† appname è®¾ç½®åº”ç”¨åç§°ï¼Œè€Œ Command::new() å¿…é¡»æ˜¾ç¤ºæŒ‡å®š appnameã€‚ use clap::arg, Arg, Command, command, value_parser;fn main() // let matches = command!() let matches = Command::new(MyApp) // Application configuration .version(1.0.0) .author(hedon) .about(This the intro of the cli application) // Application args .arg(arg!([NAME]).help(Specify your name)) .arg( Arg::new(age).short(a).long(age).value_parser(value_parser!(u8)) ) .get_matches(); // Read and parse command args if let Some(name) = matches.get_one::String(NAME) println!(Value for name: name); if let Some(age) = matches.get_one::u8(age) println!(Value for age: age); è¿™æ®µä»£ç åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š 1. åˆ›å»ºå‘½ä»¤è¡Œåº”ç”¨å®ä¾‹ï¼š let matches = Command::new(MyApp) è¿™é‡Œä½¿ç”¨ Command::new æ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å‘½ä»¤è¡Œåº”ç”¨å®ä¾‹ï¼Œå‘½åä¸º \"MyApp\"ã€‚ 2. é…ç½®åº”ç”¨ï¼š .version(1.0.0).author(hedon).about(This the intro of the cli application) æ¥ä¸‹æ¥ï¼Œä½¿ç”¨é“¾å¼è°ƒç”¨æ–¹æ³•é…ç½®åº”ç”¨çš„ç‰ˆæœ¬å·ä¸º \"1.0.0\"ï¼Œä½œè€…ä¸º \"hedon\"ï¼Œå¹¶æ·»åŠ äº†ä¸€ä¸ªç®€çŸ­çš„æè¿°ã€‚ è¿™é‡Œç­‰ä»·äº Builder æ¨¡å¼ä¸‹çš„ï¼š #[command(version, author, about)] 3. æ·»åŠ å‘½ä»¤è¡Œå‚æ•°ï¼š .arg(arg!([NAME]).help(Specify your name)).arg( Arg::new(age).short(a).long(age).value_parser(value_parser!(u8))) è¿™éƒ¨åˆ†ä»£ç æ·»åŠ äº†ä¸¤ä¸ªå‘½ä»¤è¡Œå‚æ•°ï¼š - .arg(arg!([NAME]).required(true).help(\"Specify your name\")) ä½¿ç”¨ arg! å®æ·»åŠ äº†ä¸€ä¸ªåä¸º NAME çš„å¿…éœ€å‚æ•°ï¼Œå¹¶æä¾›äº†ä¸€äº›å¸®åŠ©ä¿¡æ¯ã€‚ - .arg(Arg::new(\"age\").short('a').long(\"age\").value_parser(value_parser!(u8))) åˆ›å»ºäº†å¦ä¸€ä¸ªå‚æ•° ageï¼Œå¯ä»¥é€šè¿‡ -a æˆ– --age æ¥æŒ‡å®šã€‚è¿™ä¸ªå‚æ•°ä½¿ç”¨äº† value_parser å®æ¥æŒ‡æ˜å®ƒçš„å€¼åº”è¢«è§£æä¸º u8 ç±»å‹çš„æ•°å­—ã€‚ 4. è§£æå‘½ä»¤è¡Œå‚æ•°ï¼š .get_matches(); ä½¿ç”¨ .get_matches() æ–¹æ³•æ¥è§£æå‘½ä»¤è¡Œå‚æ•°å¹¶å°†ç»“æœå­˜å‚¨åœ¨ matches å˜é‡ä¸­ã€‚ 5. è¯»å–å¹¶æ‰“å°å‚æ•°å€¼ï¼š if let Some(name) = matches.get_one::String(NAME) println!(Value for name: name);if let Some(age) = matches.get_one::u8(age) println!(Value for age: age); æœ€åï¼Œä½¿ç”¨ matches.get_one::T(\"arg_name\") æ–¹æ³•å°è¯•è·å–æŒ‡å®šåç§°çš„å‚æ•°å€¼ã€‚å¦‚æœæˆåŠŸæ‰¾åˆ°ï¼Œåˆ™å°†å…¶æ‰“å°å‡ºæ¥ã€‚è¿™é‡Œåˆ†åˆ«å°è¯•è·å– \"NAME\" å’Œ \"age\" å‚æ•°çš„å€¼ï¼Œå¹¶ä½¿ç”¨ println! å®å°†å®ƒä»¬æ‰“å°åˆ°æ§åˆ¶å°ã€‚ ä½¿ç”¨ -- help æµ‹è¯•è¾“å‡ºå¦‚ä¸‹ï¼š This the intro of the cli applicationUsage: app2 [OPTIONS] [NAME]Arguments: [NAME] Specify your nameOptions: -a, --age AGE -h, --help Print help -V, --version Print version ä½ å¯ä»¥å°†å…¶ä¸ã€ŒDerive - åº”ç”¨é…ç½®ã€è¿›è¡Œæ¯”è¾ƒï¼Œåº”è¯¥å¾ˆå®¹æ˜“æ‰¾åˆ°å®ƒä»¬ä¹‹é—´çš„å¯¹åº”å…³ç³»ã€‚ åœ¨ Derive ä¸­ #[command] å’Œ #[arg] æ”¯æŒçš„å±æ€§ï¼Œéƒ½å¯ä»¥åœ¨ Builder ä¸­æ‰¾åˆ°å¯¹åº”çš„åŒåçš„å‡½æ•°ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚ 2. å‚æ•°ç±»å‹ åœ¨ Builder æ¨¡å¼ä¸­ï¼Œé…ç½®å‚æ•°æœ‰ä¸¤ç§æ–¹å¼ï¼š arg!([-short] [--long] id) Args::new(\"id\").short('s').long(\"long\") 2.1 Arguments Options Arguments: [NAME] Specify your nameOptions: -a, --age AGE Argument: ä¸åŒ…å« -short å’Œ --longã€‚ Options: åŒ…å« -short æˆ– --longã€‚ .arg(arg!([NAME]).help(Specify your name)).arg(arg!(-a --age AGE).value_parser(value_parser!(u16))) 2.2 å¯é€‰å‚æ•° æ ¹æ®çº¦å®šï¼Œ è¡¨ç¤ºå¿…é¡»ï¼Œè€Œ [] è¡¨ç¤ºå¯é€‰ï¼š .arg(arg!(NAME) // å¿…é¡».arg(arg!([ADDRESS])) // å¯é€‰ ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ .required(bool) å‡½æ•°æ˜ç¡®æŒ‡å‡ºæ˜¯å¦å¿…é¡»ï¼š .arg(arg!(NAME).required(true)) .required() çš„ä¼˜å…ˆçº§é«˜äº å’Œ []ï¼Œä½†æ˜¯å»ºè®®ä½ åœ¨æ„å»ºçš„æ—¶å€™è¿˜æ˜¯éµå¾ªçº¦å®šã€‚ 2.3 æšä¸¾å‚æ•° ç¬¬ 1 ç§ï¼šåœ¨ value_parser() ä¸­ç›´æ¥æŒ‡å®šå¯é€‰çš„æšä¸¾å‚æ•° .arg(arg!(MODE).value_parser([fast, slow])) ç¬¬ 2 ç§ï¼šä½¿ç”¨æšä¸¾ï¼Œä½†æ˜¯æšä¸¾éœ€è¦å®ç° ValueEnum trait è¿™é‡Œåˆæœ‰ 2 ç§æ–¹å¼ï¼Œä½ å¯ä»¥å‘ Derive ä¸€æ ·å¼•å…¥ derive featuresï¼Œç„¶åç›´æ¥ #[derive(ValueElem)] ä½¿ç”¨é»˜è®¤å®ç°ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨å®ç°ã€‚æˆ‘æ›´å€¾å‘äºå‰è€…ã€‚ use clap::arg, command, value_parser, ValueEnum;fn main() let matches = command!() // .arg(arg!(MODE).value_parser([fast, slow])) .arg( arg!(MODE).value_parser(value_parser!(Mode)).required(true) ) .get_matches(); match matches.get_one::Mode(MODE) .expect(Mode is required and parsing will fail if its missing) Mode::Fast = println!(fast), Mode::Slow = println!(slow), #[derive(Copy, Clone, Ord, PartialOrd, Eq, PartialEq, ValueEnum)]enum Mode /// Run in fast mode Fast, /// Run in slow mode Slow, 2.4 ç´¯è®¡å‚æ•° ä½¿ç”¨ clap::ArgAction::Count è®¾ç½®å‚æ•°ä¸ºç´¯è®¡å‚æ•°ï¼Œç„¶åä½¿ç”¨ get_count(id) è·å–å‚æ•°çš„å€¼ï¼š use clap::arg, command;fn main() let matches = command!() .arg(arg!(-v --verbose...).action(clap::ArgAction::Count)) .get_matches(); println!(v count: :?, matches.get_count(verbose)); è¿™é‡Œè¦æ³¨æ„ï¼Œarg!() ä¸­å‚æ•°çš„å®šä¹‰ï¼Œä¹Ÿè¦ç¬¦åˆç´¯è®¡å‚æ•°çš„æ ¼å¼ -short --long...ã€‚ 2.5 å˜é•¿å‚æ•° ä½¿ç”¨ clap::ArgAction::Append è®¾ç½®å‚æ•°ä¸ºå˜é•¿å‚æ•°ï¼Œç„¶åä½¿ç”¨ get_many::ç±»å‹(\"id\") è·å–å‚æ•°çš„å€¼ï¼š use clap::arg, Command;fn main() let matches = Command::new(append-application) .arg(arg!([FILES]...).action(clap::ArgAction::Append)) .get_matches(); let files = matches .get_many::String(FILES) .unwrap_or_default() .map(|v|v.as_str()) .collect::Vec_(); println!(files: :?, files); è¿™é‡Œè¦æ³¨æ„ï¼Œarg!() ä¸­å‚æ•°çš„å®šä¹‰ï¼Œä¹Ÿè¦ç¬¦åˆå˜é•¿å‚æ•°çš„æ ¼å¼ [arg]|arg...ã€‚ 2.6 æ ‡å¿—å‚æ•° ä½¿ç”¨ clap::ArgAction::SetTrue æˆ– clap::ArgAction::SetFalse è®¾ç½®å‚æ•°ä¸ºæ ‡å¿—å‚æ•°ï¼Œç„¶åä½¿ç”¨ get_flag() è·å–å‚æ•°çš„å€¼ï¼š use clap::arg, command;fn main() let matches = command!() .arg(arg!(-d --debug).action(clap::ArgAction::SetTrue)) .arg(arg!(-v --verbose).action(clap::ArgAction::SetFalse)) .get_matches(); println!(debug: :?, matches.get_flag(debug)); println!(verbose: :?, matches.get_flag(verbose)) å…¶ä¸­ï¼š clap::ArgAction::SetTrue : è®¾ç½®å‚æ•°çš„è¯ï¼Œåˆ™ä¸º trueï¼Œå¦åˆ™ falseï¼ˆé»˜è®¤ï¼‰ã€‚ clap::ArgAction::SetFalse : è®¾ç½®å‚æ•°çš„è¯ï¼Œåˆ™ä¸º falseï¼Œå¦åˆ™ trueï¼ˆé»˜è®¤ï¼‰ã€‚ æµ‹è¯•ï¼š âœ learn-clap-builder git:(master) âœ— ./target/release/examples/flag debug: falseverbose: trueâœ learn-clap-builder git:(master) âœ— ./target/release/examples/flag -d debug: trueverbose: trueâœ learn-clap-builder git:(master) âœ— ./target/release/examples/flag -v debug: falseverbose: false 2.7 å­å‘½ä»¤ å¯ä»¥ä½¿ç”¨ subcommand(sub_cmd) å’Œ subcommand([sub_cmd1, sub_cmd2]) æ¥æ·»åŠ å­å‘½ä»¤ï¼Œè§£æçš„æ—¶å€™ä½¿ç”¨ matches.subcommand() åŒ¹é…å­å‘½ä»¤ï¼Œå†æŒ‰ç…§ä¹‹å‰çš„è§„åˆ™è§£æå­å‘½ä»¤ä¸­å¯¹åº”çš„å‚æ•°å³å¯ã€‚ use clap::arg, Command, value_parser;fn main() let matches = Command::new(myapp) .subcommands([ Command::new(add) .arg(arg!(NUM).value_parser(value_parser!(i16))), Command::new(sub) .arg(arg!(NUM).value_parser(value_parser!(i16))), ]) .get_matches(); match matches.subcommand() Some((add, add_cmd)) = println!( myapp add was used, num is: :?, add_cmd.get_one::i16(NUM), ), Some((sub, sub_cmd)) = println!( myapp sub was used, num is: :?, sub_cmd.get_one::i16(NUM), ), _ = unreachable!() 3. å‚æ•°æ ¡éªŒ 3.1 ç±»å‹æ ¡éªŒ ä½¿ç”¨ value_parser!() åœ¨æ‹¬å·ä¸­æŒ‡å®šç±»å‹ï¼Œclap å°±ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬å¯¹å‚æ•°è¿›è¡Œç±»å‹æ ¡éªŒï¼Œå½“ç„¶ä½ åœ¨è·å–å‚æ•°å€¼ get_one::ç±»å‹() çš„æ—¶å€™ï¼Œç±»å‹è¦å¯¹ä¸Šï¼Œå¦åˆ™ä¼š panicã€‚ é»˜è®¤æ”¯æŒï¼š åŸç”Ÿç±»å‹ï¼šbool, String, OsString, PathBufã€usizeã€isize èŒƒå›´æ•°æ®ï¼šu8, i8, u16, i16, u32, i32, u64, i64 å®ç°äº† ValueEnum çš„ enum ç±»å‹ å®ç°äº† FromOsStringã€FromOsStr ã€FromStr çš„ç±»å‹ 3.2 æšä¸¾æ ¡éªŒ 2.3 ä¸­æšä¸¾å‚æ•°çš„è¯´æ˜ä¸­ï¼Œå·²ç»ä½“ç°äº†æšä¸¾æ ¡éªŒçš„åŠŸèƒ½äº†ï¼Œè¿™é‡Œä¸èµ˜è¿°ã€‚ 3.3 èŒƒå›´æ ¡éªŒ å¯¹äºä¸Šè¿°æåˆ°çš„ã€ŒèŒƒå›´æ•°æ®ã€ï¼Œå¯ä»¥ä½¿ç”¨ value_parser!(ç±»å‹).range() è¿›è¡ŒèŒƒå›´æ ¡éªŒã€‚ arg!(PORT) .value_parser(value_parser!(u16).range(1..)) 3.4 è‡ªå®šä¹‰æ ¡éªŒ value_parser() ä¸­ä¹Ÿå¯ä»¥ä¼ è‡ªå®šä¹‰çš„æ ¡éªŒå‡½æ•°ï¼Œè¯¥å‡½æ•°çš„ç­¾åéœ€è¦æ»¡è¶³çš„æ¡ä»¶è·Ÿæˆ‘ä»¬åœ¨ä»‹ç» Derive æ—¶ä¸€æ ·ã€‚ use std::ops::RangeInclusive;use clap::arg, command;fn main() let matches = command!() .arg(arg!(PORT).value_parser(port_in_range)) .get_matches(); println!(port: :?, matches.get_one::u16(PORT))const PORT_RANGE: RangeInclusiveusize = RangeInclusive::new(1, 65535);fn port_in_range(s: str) - Resultu16, String let port: usize = s .parse() .map_err(|_|format!(`s` is not a port number))?; if PORT_RANGE.contains(port) Ok(port as u16) else Err(format!( port not in range -, PORT_RANGE.start(), PORT_RANGE.end(), )) 3.5 å…³è”å‚æ•° ä¾èµ–å…³ç³»ï¼šä½¿ç”¨ requires(id | group) æ’æ–¥å…³ç³»ï¼šä½¿ç”¨ group().multiple(false).required(true) .group( ArgGroup::new(vers) // è¡¨ç¤º set-ver, major, minor, patch å¿…é¡»æœ‰ä¸€ä¸ªä¸”åªèƒ½æœ‰ä¸€ä¸ªå­˜åœ¨ .multiple(false) .required(true) .args([set-ver, major, minor, patch]),).arg( arg!([INPUT_FILE] some regular input) .value_parser(value_parser!(PathBuf)) .group(input),).arg( arg!(config: -c CONFIG) .value_parser(value_parser!(PathBuf)) // è¡¨ç¤º -c éœ€è¦æœ‰ group ä¸º input çš„å‘½ä»¤å­˜åœ¨æ‰å¯ä»¥ä½¿ç”¨ .requires(input),) Derive vs Builder (2) å¯¹æ¯” Derive vs Builder clap + rpassword å®ç°åŠ å¯†è¾“å…¥ å¯¹äºå¯†ç ã€å¯†é’¥ç­‰å…³é”®ä¿¡æ¯çš„è¾“å…¥ï¼Œä¸ºäº†ä¿¡æ¯å®‰å…¨ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šä½¿ç”¨åŠ å¯†è¾“å‡ºï¼Œclap æœ¬èº«ä¸æ”¯æŒåŠ å¯†è¾“å…¥åŠŸèƒ½ã€‚è‹¥ä½ æœ‰è¿™æ–¹é¢çš„éœ€æ±‚ï¼Œå¯ä»¥ä½¿ç”¨ rpassword crate è¾…åŠ©å®Œæˆã€‚ ç¤ºä¾‹ï¼š use clap::Parser;use rpassword::read_password;#[derive(Parser)]#[command(version, author, about, long_about = None)]struct Cli #[arg(short, long)] username: String, #[arg(short, long, required = true)] password: bool,fn main() let cli = Cli::parse(); let password = if cli.password // Prompt user to enter password read_password().expect(Failed to read password) else .to_string() ; // Use username and password to do something println!(username: , password: , cli.username, password); clap_complete å®ç°è‡ªåŠ¨è¡¥å…¨ è¦å®ç°è‡ªåŠ¨è¡¥å…¨ï¼Œéœ€è¦åœ¨ .zshrc æˆ– .bashrc ç­‰ SHELL æ–‡ä»¶ä¸­åŠ å…¥å‘½ä»¤è‡ªåŠ¨è¡¥å…¨è„šæœ¬ã€‚è¿™æ—¶å€™å¯ä»¥ä½¿ç”¨ clap_complete æ¥å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚ ä¸‹é¢çš„ç¤ºä¾‹ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š â”œâ”€â”€ Cargo.lockâ”œâ”€â”€ Cargo.tomlâ”œâ”€â”€ build.rsâ””â”€â”€ src â”œâ”€â”€ cli.rs â””â”€â”€ main.rs é¦–å…ˆæˆ‘ä»¬éœ€è¦å¼•å…¥ clap å’Œ clap_complete crateï¼Œå…¶ä¸­ clap_complete åªéœ€åœ¨ build ç¯å¢ƒä¸‹å³å¯ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ Cargo.tmol å¦‚ä¸‹ï¼š [package]name = myappversion = 0.1.0edition = 2021build = build.rs[dependencies]clap = version = 4.5.1 dirs = 5.0.1[build-dependencies]clap = version = 4.5.1clap_complete = 4.5.1 æˆ‘ä»¬å…ˆåœ¨ src/cli.rs ä¸­å®ç°ä¸€ä¸ªç®€å•çš„å‘½ä»¤è¡Œç¨‹åº myappï¼š use clap::Arg, ArgAction, Command;pub fn build_cli() - Command Command::new(myapp) .about(Tests completions) .arg(Arg::new(file) .help(some input file)) .subcommand(Command::new(test) .about(tests things) .arg(Arg::new(case) .long(case) .action(ArgAction::Set) .help(the case to test))) æˆ‘ä»¬ä¸»è¦æ˜¯æ¼”ç¤ºè¿™ä¸ªè‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ï¼Œä¸ºäº†çœäº‹ï¼Œsrc/main.rs ä¸­å°±ä¸å®ç°å…·ä½“é€»è¾‘äº†ï¼š mod cli;fn main() let _m = cli::build_cli().get_matches(); æ¥ç€ï¼Œæˆ‘ä»¬åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹å®ç° build.rsï¼Œå®ƒå°†ä¸ºæˆ‘ä»¬æŒ‡å®šçš„å‘½ä»¤ç”Ÿæˆè‡ªåŠ¨è¡¥å…¨è„šæœ¬ï¼š touch build.rs use clap_complete::generate_to, shells::Bash;use std::env;use std::io::Error;include!(src/cli.rs);fn main() - Result(), Error let outdir = match env::var_os(OUT_DIR) None = return Ok(()), Some(outdir) = outdir, ; let mut cmd = build_cli(); let path = generate_to( Bash, mut cmd, // We need to specify what generator to use myapp, // We need to specify the bin name manually outdir, // We need to specify where to write to )?; println!(cargo:warning=completion file is generated: path:?); Ok(()) ä½ éœ€è¦æŠŠå…¶ä¸­çš„ myapp æ›¿æ¢ä¸ºä½ çš„å‘½ä»¤ã€‚ æ‰§è¡Œæ„å»ºå‘½ä»¤ï¼š cargo build å¯ä»¥çœ‹åˆ°è¾“å‡ºï¼š warning: myapp@0.1.0: completion file is generated: /Users/hedon/RustroverProjects/learn-clap-complete/target/debug/build/myapp-42e401d08c044ca3/out/myapp.bash Finished dev [unoptimized + debuginfo] target(s) in 1.90s è¿™é‡Œä¼šè¾“å‡ºç”Ÿæˆè„šæœ¬æ‰€åœ¨çš„ä½ç½®ï¼Œæˆ‘è¿™é‡Œæ˜¯ /Users/hedon/RustroverProjects/learn-clap-complete/target/debug/build/myapp-42e401d08c044ca3/out/myapp.bashã€‚ æˆ‘çš„ç»ˆç«¯ä½¿ç”¨çš„æ˜¯ zshï¼š âœ echo $SHELL /bin/zsh æ‰€ä»¥æˆ‘éœ€è¦å°†è¿™ä¸ªæ–‡ä»¶çš„å†…å®¹åŠ åˆ° ~/.zshrc æ–‡ä»¶çš„æœ«å°¾ï¼š cat /Users/hedon/RustroverProjects/learn-clap-complete/target/debug/build/myapp-42e401d08c044ca3/out/myapp.bash ~/.zshrc é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶ï¼š source ~/.zshrc è¿™ä¸ªæ—¶å€™ä½ ä½¿ç”¨ myapp å‘½ä»¤çš„æ—¶å€™ï¼ŒæŒ‰ tap é”®ï¼Œå°±æœ‰è‡ªåŠ¨è¡¥å…¨äº†ï¼š âœ ./target/debug/myapp --help -h \\[file\\] help test HTTPie ç”±äºç¯‡å¹…åŸå› ï¼Œå®æˆ˜ HTTPie éƒ¨åˆ†è¯·çœ‹ï¼šRust å®æˆ˜ä¸¨HTTPie ä¸ Go è¯­è¨€ cobra æ¯”è¾ƒ Go çš„ cobra ä¹Ÿæ˜¯ç”¨äºæ„å»ºå‘½ä»¤è¡Œåº”ç”¨ç¨‹åºçš„åº“ï¼Œå®ƒåœ¨ Go è¯­è¨€ç”Ÿæ€ä¸­éå¸¸å—æ¬¢è¿ã€‚ ä¸ºäº†ç›´è§‚å±•ç¤ºè¿™ 2 ä¸ªåº“æ„å»ºå‘½ä»¤è¡Œåº”ç”¨ç¨‹åºçš„åŒºåˆ«ï¼Œæˆ‘ä»¬æ¥è®¾è®¡ä¸€ä¸ªç®€å•çš„å‘½ä»¤è¡Œç¨‹åºï¼Œç”¨ clap å’Œ cobra åˆ†åˆ«å®ç°ï¼Œä»¥å±•ç¤ºå¦‚ä½•ç”¨è¿™ä¸¤ä¸ªåº“å®ç°ç›¸åŒçš„åŠŸèƒ½ã€‚ è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª CLI ç¨‹åºï¼Œå®ƒæœ‰ä¸€ä¸ª greet å­å‘½ä»¤ï¼Œæ¥å—ä¸€ä¸ª -n æˆ– --name å‚æ•°ï¼Œå¹¶æ‰“å°å‡ºä¸€æ¡æ¬¢è¿ä¿¡æ¯ã€‚ Rust clap å®ç° use clap:: Parser, Subcommand;#[derive(Parser)]#[command(bin_name = greet_app)]struct Cli #[command(subcommand)] sub: OptionSub,#[derive(Subcommand)]enum Sub Greet #[arg(short, long)] name: String, fn main() let cli = Cli::parse(); if let Some(sub) = cli.sub match sub Sub::Greetname = println!(greeting: :?, name), Go cobra å®ç° package mainimport (\tfmt\tos\tgithub.com/spf13/cobra)var rootCmd = cobra.Command\tUse: greet_app,\tShort: A simple greeting application,\tLong: `This is a simple greeting application with a greet command.`,var greetCmd = cobra.Command\tUse: greet,\tShort: Greets a user,\tLong: `Prints a greeting message for the specified user.`,\tRun: func(cmd *cobra.Command, args []string) name, _ := cmd.Flags().GetString(name) fmt.Printf(Hello, %s! , name)\t,func init() rootCmd.AddCommand(greetCmd)\tgreetCmd.Flags().StringP(name, n, , Sets the name to greet)\tgreetCmd.MarkFlagRequired(name)func main() if err := rootCmd.Execute(); err != nil fmt.Println(err) os.Exit(1) è¾“å‡ºï¼š This is a simple greeting application with a greet command.Usage: greet_app [command]Available Commands: completion Generate the autocompletion script for the specified shell greet Greets a user help Help about any commandFlags: -h, --help help for greet_appUse greet_app [command] --help for more information about a command. å¯¹æ¯” è®¾è®¡å“²å­¦å’Œæ˜“ç”¨æ€§ clap: ä½¿ç”¨ Rust çš„å®æ¥æä¾›å¼ºå¤§çš„ç¼–è¯‘æ—¶åŠŸèƒ½ï¼Œå¦‚å‚æ•°è§£æã€éªŒè¯ç­‰ã€‚ åˆ©ç”¨ Rust çš„ç±»å‹å®‰å…¨ç‰¹æ€§ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯ã€‚ æ”¯æŒé€šè¿‡æ´¾ç”Ÿå®è‡ªåŠ¨ä»ç»“æ„ä½“ç”Ÿæˆå‘½ä»¤è¡Œè§£æä»£ç ï¼Œç®€åŒ–å¼€å‘æµç¨‹ã€‚ cobra: é‡‡ç”¨æ›´ä¼ ç»Ÿçš„å‘½ä»¤å¼ç¼–ç¨‹æ¨¡å‹ï¼Œç›´è§‚ä¸”æ˜“äºä¸Šæ‰‹ã€‚ é€šè¿‡ç»„åˆå‘½ä»¤å¯¹è±¡æ¥æ„å»ºå¤æ‚çš„å‘½ä»¤è¡Œåº”ç”¨ã€‚ æä¾›äº†ä¸€å¥—å®Œæ•´çš„ç”Ÿæˆå·¥å…·æ¥åˆ›å»ºå‘½ä»¤å’Œé…ç½®ï¼Œä¿ƒè¿›äº†å¼€å‘é€Ÿåº¦ã€‚ åŠŸèƒ½å’Œç‰¹æ€§ clap: è‡ªåŠ¨ç”Ÿæˆå¸®åŠ©ä¿¡æ¯ã€ç‰ˆæœ¬ä¿¡æ¯ç­‰ã€‚ æ”¯æŒå¤šçº§å­å‘½ä»¤ã€‚ æ”¯æŒè‡ªå®šä¹‰éªŒè¯å™¨å’Œå¤æ‚çš„å‚æ•°å…³ç³»ï¼ˆå¦‚äº’æ–¥ã€ä¾èµ–ç­‰ï¼‰ã€‚ cobra: æ”¯æŒè‡ªåŠ¨ç”Ÿæˆå¸®åŠ©æ–‡æ¡£ã€‚ å†…ç½®å‘½ä»¤è‡ªåŠ¨è¡¥å…¨è„šæœ¬ç”ŸæˆåŠŸèƒ½ã€‚ æ”¯æŒæŒä¹…åŒ–å‘½ä»¤è¡Œæ ‡å¿—åˆ°é…ç½®æ–‡ä»¶ã€‚ é€šè¿‡æ’ä»¶æ”¯æŒå¢åŠ é¢å¤–çš„å­å‘½ä»¤ã€‚ èƒ½å¤Ÿè½»æ¾åœ°ä¸å…¶ä»– Go åº“é›†æˆï¼Œå¦‚ Viper ç”¨äºé…ç½®ç®¡ç†ã€‚ æ€§èƒ½ clap: ç”±äº Rust çš„ç¼–è¯‘æ—¶ä¼˜åŒ–ï¼Œclap åœ¨è§£æå‘½ä»¤è¡Œå‚æ•°æ—¶é€šå¸¸ä¼šæœ‰æ›´å¥½çš„æ€§èƒ½ã€‚ æ›´å°‘çš„è¿è¡Œæ—¶å¼€é”€ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†å¤§é‡å¤æ‚å‘½ä»¤è¡Œå‚æ•°æ—¶ã€‚ cobra: æ€§èƒ½å¯¹äºå¤§å¤šæ•°å‘½ä»¤è¡Œåº”ç”¨æ¥è¯´å·²ç»è¶³å¤Ÿï¼Œä½†å¯èƒ½ä¸å¦‚ clap ä¼˜åŒ–ã€‚ Go çš„è¿è¡Œæ—¶å¯èƒ½ä¼šå¼•å…¥é¢å¤–çš„å¼€é”€ï¼Œå°¤å…¶æ˜¯åœ¨å¹¶å‘å¤„ç†æ—¶ã€‚","tags":["Rust","clap"],"categories":["Rust","Rust å¸¸ç”¨åº“"]},{"title":"Rust reqwest ç®€æ˜æ•™ç¨‹","path":"/2024/03/02/rust-crate-reqwest/","content":"æ¦‚è¿° reqwest æ˜¯ Rust ä¸­ä¸€ä¸ªéå¸¸æµè¡Œå’Œå¼ºå¤§çš„ HTTP å®¢æˆ·ç«¯åº“ï¼Œå®ƒæä¾›äº†ä¸€ç§ç®€å•çš„æ–¹å¼æ¥å‘é€ HTTP è¯·æ±‚å¹¶å¤„ç†å“åº”ã€‚reqwest æ”¯æŒé˜»å¡å’Œéé˜»å¡ï¼ˆå¼‚æ­¥ï¼‰è¯·æ±‚ï¼Œä½¿å…¶é€‚åˆäºå„ç§ä¸åŒçš„åº”ç”¨åœºæ™¯ã€‚åœ¨è¿™ç¯‡åšæ–‡ä¸­ï¼Œæˆ‘ä»¬å°†è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ reqwest å‘é€å„ç§ HTTP è¯·æ±‚ï¼Œå¹¶å¤„ç†è¿”å›çš„å“åº”ã€‚ å¼€å§‹ä¹‹å‰ åœ¨å¼€å§‹ç¼–å†™ä»£ç ä¹‹å‰ï¼Œä½ éœ€è¦åœ¨ä½ çš„ Rust é¡¹ç›®ä¸­æ·»åŠ  reqwest ä¾èµ–ã€‚æ‰“å¼€ä½ çš„ Cargo.toml æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š [dependencies]reqwest = version = 0.12.4, features = [json] tokio = version = 1, features = [full] serde = version = 1.0.197, features = [derive] serde_json = 1.0.114 è¿™é‡Œæˆ‘ä»¬è¿˜æ·»åŠ äº†å…¶ä»–å‡ ä¸ªä¾èµ–ï¼š tokio: åœ¨åé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ reqwest çš„å¼‚æ­¥åŠŸèƒ½ã€‚ serde: ç”¨äºæ•°æ®è§£æï¼Œåœ¨ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä¼šæ¼”ç¤º json æ•°æ®çš„è§£æã€‚ serde_json: ä¾¿äºä½¿ç”¨ json! å®å¿«é€Ÿæ„å»º json æ•°æ®ã€‚ å‘é€ GET è¯·æ±‚ å‘é€ä¸€ä¸ª GET è¯·æ±‚æ˜¯æœ€åŸºæœ¬çš„ HTTP æ“ä½œã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨ reqwest å‘é€ GET è¯·æ±‚å¹¶è®¾ç½®è¯·æ±‚å¤´çš„ç¤ºä¾‹ï¼š use reqwest::header;#[tokio::main]async fn main() - Result(), reqwest::Error let params = [(key1, value1), (key2, values)]; let client = reqwest::Client::new(); let body = client .get(http://httpbin.org/get) // set query params .form(params) // set request headers .header(header::USER_AGENT, My Rust Program) .header(header::CONTENT_TYPE, application/json) .send() .await? .text() .await?; println!(body = :?, body); Ok(()) åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ reqwest::get å‡½æ•°å‘é€ä¸€ä¸ª GET è¯·æ±‚åˆ° \"https://httpbin.org/get\"ï¼Œå¹¶é€šè¿‡ text æ–¹æ³•è·å–å“åº”çš„æ–‡æœ¬å†…å®¹ã€‚ å‘é€ POST - text è¯·æ±‚ use reqwest::Client;#[tokio::main]async fn main() - Result(), reqwest::Error let client = Client::new(); let res = client.post(http://httpbin.org/post) .body(the exact body that is sent) .send() .await? .text() .await?; println!(body: :?, res); Ok(()) å‘é€ POST - form è¯·æ±‚ #[tokio::main]async fn main() - Result(), reqwest::Error let params = [(key1, value1), (key2, values)]; let client = reqwest::Client::new(); let res = client.post(http://httpbin.org/post) .form(params) .send() .await? .text() .await?; println!(body: :?, res); Ok(()) å‘é€ POST - json è¯·æ±‚ å‘é€ POST è¯·æ±‚é€šå¸¸ç”¨äºå‘æœåŠ¡å™¨æäº¤æ•°æ®ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨ reqwest å‘é€åŒ…å« JSON æ•°æ®çš„ POST è¯·æ±‚çš„ç¤ºä¾‹ï¼š use reqwest;use serde_json::json;#[tokio::main]async fn main() - Result(), reqwest::Error let client = reqwest::Client::new(); let res = client.post(https://httpbin.org/post) .json(json!(key: value)) .send() .await?; let body = res.text().await?; println!(Body: , body); Ok(()) è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ Client::post æ–¹æ³•åˆ›å»ºä¸€ä¸ª POST è¯·æ±‚ï¼Œå¹¶é€šè¿‡ json æ–¹æ³•è®¾ç½® JSON è´Ÿè½½ã€‚ç„¶åï¼Œæˆ‘ä»¬è°ƒç”¨ send æ–¹æ³•å‘é€è¯·æ±‚ã€‚ å¤„ç† JSON å“åº” use reqwest;use serde::Deserialize;#[derive(Deserialize)]struct Ip origin: String,#[tokio::main]async fn main() - Result(), reqwest::Error let ip: Ip = reqwest::get(https://httpbin.org/ip) .await? .json() .await?; println!(IP: , ip.origin); Ok(()) åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª Ip ç»“æ„ä½“æ¥è¡¨ç¤º JSON å“åº”ï¼Œç„¶åä½¿ç”¨ json æ–¹æ³•å°†å“åº”ååºåˆ—åŒ–ä¸º Ip ç±»å‹ã€‚ æ€»ç»“ reqwest åº“ä¸º Rust æä¾›äº†ä¸€ä¸ªåŠŸèƒ½ä¸°å¯Œè€Œçµæ´»çš„ HTTP å®¢æˆ·ç«¯ï¼Œé€‚ç”¨äºå„ç§ç½‘ç»œç¼–ç¨‹ä»»åŠ¡ã€‚æ— è®ºæ˜¯ç®€å•çš„æ•°æ®è·å–è¿˜æ˜¯å¤æ‚çš„ API äº¤äº’ï¼Œreqwest éƒ½èƒ½å¸®åŠ©ä½ ä»¥ç®€æ´çš„ Rust ä»£ç å®Œæˆä»»åŠ¡ã€‚å¸Œæœ›è¿™ç¯‡åšæ–‡èƒ½å¸®åŠ©ä½ å¼€å§‹ä½¿ç”¨ reqwest æ¥å¼€å‘ç½‘ç»œç›¸å…³çš„ Rust åº”ç”¨ï¼","tags":["Rust"],"categories":["Rust","Rust å¸¸ç”¨åº“"]},{"title":"æ·±å…¥æµ…å‡º Go è¯­è¨€çš„ GPM æ¨¡å‹ï¼ˆGo1.21ï¼‰","path":"/2024/01/20/go-gpm/","content":"å¼•è¨€ åœ¨ç°ä»£è½¯ä»¶å¼€å‘ä¸­ï¼Œæœ‰æ•ˆåœ°åˆ©ç”¨å¹¶å‘æ˜¯æé«˜åº”ç”¨æ€§èƒ½å’Œå“åº”é€Ÿåº¦çš„å…³é”®ã€‚éšç€å¤šæ ¸å¤„ç†å™¨çš„æ™®åŠï¼Œç¼–ç¨‹è¯­è¨€å’Œæ¡†æ¶å¦‚ä½•é«˜æ•ˆã€ç®€ä¾¿åœ°æ”¯æŒå¹¶å‘ç¼–ç¨‹ï¼Œæˆä¸ºäº†è½¯ä»¶å·¥ç¨‹å¸ˆä»¬è¯„ä¼°å’Œé€‰æ‹©å·¥å…·æ—¶çš„ä¸€ä¸ªé‡è¦è€ƒé‡ã€‚åœ¨è¿™æ–¹é¢ï¼ŒGo è¯­è¨€å‡­å€Ÿå…¶åˆ›æ–°çš„å¹¶å‘æ¨¡å‹â€”GPMï¼ˆGoroutine, P, Mï¼‰â€”åœ¨ä¼—å¤šç¼–ç¨‹è¯­è¨€ä¸­è„±é¢–è€Œå‡ºï¼Œä¸ºå¼€å‘è€…æä¾›äº†å¼ºå¤§çš„å·¥å…·ï¼Œä»¥ç®€å•ã€é«˜æ•ˆçš„æ–¹å¼å®ç°å¹¶å‘ã€‚ è‡ªä» 2009 å¹´é¦–æ¬¡å‘å¸ƒä»¥æ¥ï¼ŒGo è¯­è¨€å°±ä»¥å…¶å‡ºè‰²çš„æ€§èƒ½ã€ç®€æ´çš„è¯­æ³•å’Œå¯¹å¹¶å‘çš„åŸç”Ÿæ”¯æŒèµ¢å¾—äº†å¹¿æ³›çš„å…³æ³¨ã€‚å°¤å…¶æ˜¯å…¶å¹¶å‘æ¨¡å‹ï¼Œè¢«è®¾è®¡ä¸ºèƒ½å¤Ÿå……åˆ†åˆ©ç”¨ç°ä»£å¤šæ ¸å¤„ç†å™¨çš„èƒ½åŠ›ï¼ŒåŒæ—¶éšè—åº•å±‚çš„çº¿ç¨‹ç®¡ç†å’ŒåŒæ­¥å¤æ‚æ€§ï¼Œè®©å¼€å‘è€…èƒ½å¤Ÿä»¥æ›´ç›´è§‚ã€æ›´é«˜çº§çš„æŠ½è±¡æ¥æ„å»ºå¹¶å‘ç¨‹åºã€‚GPM æ¨¡å‹ï¼Œä½œä¸º Go è¯­è¨€å¹¶å‘ç¼–ç¨‹çš„æ ¸å¿ƒï¼Œé€šè¿‡ Goroutineã€Pï¼ˆprocessorï¼‰ã€Mï¼ˆmachineï¼‰ä¸‰è€…çš„ååŒå·¥ä½œï¼Œå®ç°äº†ä¸€ç§é«˜æ•ˆä¸”æ˜“äºç®¡ç†çš„å¹¶å‘æœºåˆ¶ã€‚ æœ¬æ–‡å°†åŸºäº Go1.21 æ·±å…¥æµ…å‡ºåœ°æ¢è®¨ Go è¯­è¨€çš„ GPM æ¨¡å‹ï¼Œä¸»è¦åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ï¼š é¦–å…ˆä»å…¶è®¾è®¡ç†å¿µå‡ºå‘ï¼Œè¯¦ç»†è§£æ Goroutineã€P å’Œ M ä¸‰è€…çš„è§’è‰²ã€å·¥ä½œåŸç†åŠå…¶ç›¸äº’ä¹‹é—´çš„äº¤äº’æ–¹å¼ã€‚ ç„¶åå¼•å…¥å‡ ä¸ªå…³é”®é—®é¢˜ï¼Œæˆ‘ä»¬ä¼šä»ç»“è®ºä¸Šå…ˆæ€»ç»“ GPM çš„æ ¸å¿ƒè¦ç‚¹ï¼Œå†…å®¹åŒ…æ‹¬åç¨‹è°ƒåº¦å¾ªç¯ã€è°ƒåº¦ç­–ç•¥å’Œè°ƒåº¦æ—¶æœºã€‚ æ¥ç€æˆ‘ä»¬ä¼šæ·±å…¥æºç ï¼Œå»ä¸€æ­¥æ­¥æ´å¯Ÿ Go è¯­è¨€è®¾è®¡è€…æ˜¯å¦‚ä½•å®ç° GPM æ¨¡å‹ä¸­çš„å„ä¸ªè¦ç‚¹çš„ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šæ¯”è¾ƒç¹çï¼Œä½†å…¶å®ä¹Ÿæ¯”è¾ƒæœ‰è¶£ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥é˜…è¯»è¿™ä¸€å—ï¼Œè‹¥åªæ˜¯æƒ³å¯¹ GPM æ¨¡å‹æœ‰ä¸ªå¤§æ¦‚äº†è§£ï¼Œé‚£ä¹ˆåœç•™åœ¨ä¸Šä¸€æ­¥ä¹Ÿè¶³çŸ£äº†ã€‚ æœ€åæˆ‘ä»¬åŸºäºå‰é¢çš„åˆ†æï¼Œæ€»ç»“ Gã€Pã€M ä¸‰å¤§ç»„ä»¶åœ¨ Go ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­çš„çŠ¶æ€æµè½¬å›¾ã€‚ é€šè¿‡å¯¹ GPM æ¨¡å‹çš„æ¢è®¨ï¼Œæˆ‘ä»¬ä¸ä»…èƒ½å¤Ÿç†è§£ Go è¯­è¨€å¦‚ä½•åœ¨ä¼—å¤šç°ä»£ç¼–ç¨‹è¯­è¨€ä¸­ä»¥å…¶å¹¶å‘ç¼–ç¨‹èƒ½åŠ›è„±é¢–è€Œå‡ºï¼Œè¿˜èƒ½å¤Ÿæ´å¯Ÿå…¶è®¾è®¡èƒŒåçš„æ™ºæ…§ï¼Œä»¥åŠè¿™ä¸€æ¨¡å‹å¦‚ä½•éšç€ Go è¯­è¨€ç‰ˆæœ¬çš„è¿­ä»£è€Œä¸æ–­è¿›åŒ–å’Œä¼˜åŒ–ã€‚æ— è®ºä½ æ˜¯å¯¹ Go è¯­è¨€å……æ»¡å¥½å¥‡çš„æ–°æ‰‹ï¼Œè¿˜æ˜¯å¸Œæœ›æ·±åŒ–ç†è§£å…¶å¹¶å‘æ¨¡å‹çš„ç»éªŒå¼€å‘è€…ï¼Œæœ¬æ–‡éƒ½å°†ä¸ºä½ æä¾›å®è´µçš„è§†è§’å’Œæ·±åˆ»çš„æ´è§ã€‚ ç»“è®ºå…ˆè¡Œ GPM è°ƒåº¦åŸç†å›¾ Goroutine è°ƒåº¦åŸç†å›¾ Goroutine åº•å±‚ç»“æ„ Goroutine åº•å±‚ç»“æ„ç¤ºä¾‹ è°ƒåº¦å™¨ P åº•å±‚ç»“æ„ P åº•å±‚ç»“æ„ GPM è°ƒåº¦å¾ªç¯ GPM è°ƒåº¦å¾ªç¯å›¾ GPM åç¨‹è°ƒåº¦ä¼˜å…ˆçº§ä¸é¡ºåº Go åç¨‹è°ƒåº¦ä¼˜å…ˆçº§ä¸é¡ºåº å¯»æ‰¾å¯æ‰§è¡Œ G è¿‡ç¨‹ findRunnable() åç¨‹åˆ‡æ¢æ—¶æœº Go åç¨‹åˆ‡æ¢æ—¶æœº GPM æ¨¡å‹ 1. æ¦‚è§ˆ è¿™é‡Œæœ‰ä¸€å¼ å¾ˆæµè¡Œçš„ Goroutine è°ƒåº¦åŸç†å›¾ï¼š Goroutine è°ƒåº¦åŸç†å›¾ ä»£å· åç§° å®šä¹‰ä½ç½® ä½œç”¨ Sched è°ƒåº¦å™¨ proc.c ç»´æŠ¤æœ‰å­˜å‚¨ M å’Œ G çš„é˜Ÿåˆ—ä»¥åŠè°ƒåº¦å™¨çš„ä¸€äº›çŠ¶æ€ä¿¡æ¯ç­‰ã€‚ M Machine ç³»ç»Ÿçº¿ç¨‹ runtime.h å®ƒç”±æ“ä½œç³»ç»Ÿç®¡ç†çš„ï¼ŒGoroutine å°±æ˜¯è·‘åœ¨ M ä¹‹ä¸Šçš„ï¼›M æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„ç»“æ„ï¼Œé‡Œé¢ç»´æŠ¤å°å¯¹è±¡å†…å­˜ cacheï¼ˆmcacheï¼‰ã€å½“å‰æ‰§è¡Œçš„ Goroutineã€éšæœºæ•°å‘ç”Ÿå™¨ç­‰ç­‰éå¸¸å¤šçš„ä¿¡æ¯ã€‚ P Processor å¤„ç†å™¨ runtime.h å®ƒçš„ä¸»è¦ç”¨é€”å°±æ˜¯ç”¨æ¥æ‰§è¡Œ Goroutine çš„ï¼Œå®ƒç»´æŠ¤äº†ä¸€ä¸ª Goroutine é˜Ÿåˆ—ï¼Œå³ runqueueã€‚Processor æ˜¯è®©æˆ‘ä»¬ä» N:1 è°ƒåº¦åˆ° M:N è°ƒåº¦çš„é‡è¦éƒ¨åˆ†ã€‚æ‰€æœ‰çš„ P éƒ½åœ¨ç¨‹åºå¯åŠ¨æ—¶åˆ›å»ºï¼Œå¹¶ä¿å­˜åœ¨æ•°ç»„ä¸­ï¼Œæœ€å¤šæœ‰ GOMAXPROCSï¼ˆå¯é…ç½®ï¼‰ä¸ªã€‚ G Goroutine å®ç°çš„æ ¸å¿ƒç»“æ„ runtime.h å®ƒåŒ…å«äº†æ ˆï¼ŒæŒ‡ä»¤æŒ‡é’ˆï¼Œä»¥åŠå…¶ä»–å¯¹è°ƒåº¦ Goroutine å¾ˆé‡è¦çš„ä¿¡æ¯ï¼Œä¾‹å¦‚å…¶é˜»å¡çš„ channelã€‚ Global Queue å…¨å±€é˜Ÿåˆ— proc.h å­˜æ”¾ç­‰å¾…è¿è¡Œçš„ Gã€‚å…¨å±€é˜Ÿåˆ—å¯èƒ½è¢«ä»»æ„çš„ P åŠ é”å»è·å–é‡Œé¢çš„ Gã€‚ P Local Queue P çš„æœ¬åœ°é˜Ÿåˆ— proc.h åŒå…¨å±€é˜Ÿåˆ—ç±»ä¼¼ï¼Œå­˜æ”¾çš„ä¹Ÿæ˜¯ç­‰å¾…è¿è¡Œçš„ Gï¼Œä½†å­˜æ”¾çš„æ•°æ®æœ‰é™ï¼Œä¸ä¼šè¶…è¿‡ 256 ä¸ªã€‚æ–°å»º G æ—¶ï¼ŒG ä¼šä¼˜å…ˆåŠ å…¥æœ¬åœ°é˜Ÿåˆ—ã€‚å¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™ä¼šæŠŠæœ¬åœ°é˜Ÿåˆ—ä¸­ä¸€åŠçš„ G ä»¥åŠæ–° G ä¸€èµ·ç§»åŠ¨åˆ°å…¨å±€é˜Ÿåˆ—ã€‚ é€šè¿‡è¿™ä¸ªåŸç†å›¾æˆ‘ä»¬çŸ¥é“ Go è¯­è¨€çš„ GPM æ¨¡å‹çš„ä½œç”¨éå¸¸ç®€å•ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªâ€œç²¾æ‰“ç»†ç®—â€çš„å·¥å…·ã€‚ä»¥å‰å•è¿›ç¨‹æ— æ³•å……åˆ†åˆ©ç”¨ CPU èµ„æºï¼Œæ‰€ä»¥å¼•å…¥äº†å¤šè¿›ç¨‹ã€‚åˆå› ä¸ºè¿›ç¨‹æ‹¥æœ‰çš„èµ„æºå¤ªå¤šï¼Œå…¶åˆ›å»ºã€åˆ‡æ¢å’Œé”€æ¯éƒ½ä¼šå ç”¨å¾ˆé•¿æ—¶é—´ï¼Œæ‰€ä»¥å¼•å…¥äº†æ›´å°ç²’åº¦çš„çº¿ç¨‹ã€‚éšç€è®¡ç®—æœºç§‘å­¦çš„è¿›æ­¥ï¼Œç°åœ¨çœ‹æ¥ï¼Œçº¿ç¨‹æ‹¥æœ‰çš„èµ„æºä¹Ÿæ˜¯â€œæ¯”è¾ƒå¤šâ€çš„ï¼Œæ‰€ä»¥çº¿ç¨‹çš„åˆ›å»ºã€åˆ‡æ¢å’Œé”€æ¯ä»£ä»·ä¹Ÿæ˜¯â€œç›¸å¯¹å¤§â€çš„ã€‚æ‰€ä»¥å¾ˆå¤šç¼–ç¨‹è¯­è¨€å°±å¼•å…¥äº†åç¨‹è¿™ä¸ªæ¦‚å¿µï¼Œå…¶æ ¸å¿ƒç›®çš„å°±æ˜¯åº”ç”¨å±‚è‡ªå·±æŠ½è±¡ä¸€ä¸ªæ¯”çº¿ç¨‹æ›´å°ç²’åº¦çš„è°ƒåº¦å•å…ƒï¼Œåº”ç”¨å±‚ç»“åˆæ“ä½œç³»ç»Ÿçš„å¤šçº¿ç¨‹èƒ½åŠ›ï¼Œè‡ªå·±æ¥ç®¡ç†â€œè°ƒåº¦å•å…ƒâ€çš„åˆ›å»ºã€åˆ‡æ¢å’Œé”€æ¯ï¼Œä»è€Œå°½å¯èƒ½å‡å°‘ç”±çº¿ç¨‹åˆ‡æ¢å¸¦æ¥çš„å¼€é”€ï¼Œä»¥åšåˆ°æ›´è½»é‡çº§çš„å¹¶å‘ã€‚ ä¸åŒçš„ç¼–ç¨‹è¯­è¨€å¯èƒ½æœ‰ä¸åŒçš„å®ç°ï¼Œè€Œå…³é”®å°±åœ¨äºå¦‚ä½•è®©è°ƒåº¦æ›´å¿«ã€å¼€é”€æ›´å°ã€‚è¿™ä¾¿æ˜¯æˆ‘ä»¬æœ¬æ–‡è¦æ¢è®¨çš„ä¸»è¦å†…å®¹ã€‚ Go è¯­è¨€çš„å®ç° çº¿ç¨‹æƒ³è¿è¡Œä»»åŠ¡å°±å¾—è·å– Pï¼Œä» P çš„æœ¬åœ°é˜Ÿåˆ—è·å– Gï¼Œå½“ Pçš„æœ¬åœ°é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼ŒM ä¼šå°è¯•ä»å…¨å±€é˜Ÿåˆ—è·å¾—ä¸€æ‰¹ G æ”¾åˆ° Pçš„æœ¬åœ°é˜Ÿåˆ—ï¼Œæˆ–è€…ä»å…¶ä»– P çš„æœ¬åœ°é˜Ÿåˆ—ä¸­â€œå·â€ä¸€åŠ G æ”¾åˆ°è‡ªå·±çš„æœ¬åœ°é˜Ÿåˆ—ã€‚ç„¶åM è¿è¡Œ Gï¼ŒG æ‰§è¡Œä¹‹åï¼Œå†ä» P è·å–ä¸‹ä¸€ä¸ª Gï¼Œå¦‚æ­¤ä¸æ–­é‡å¤ä¸‹å»ã€‚ åœ¨è¿›å…¥æ›´åŠ å…·ä½“æ·±å…¥çš„è®¨è®ºä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦é‡ç‚¹æ€è€ƒä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š G æˆ‘ä»¬å¯ä»¥éšä¾¿åˆ›å»ºï¼Œå¯èƒ½æœ‰æˆåƒä¸Šä¸‡ä¸ªï¼Œé‚£ P å’Œ M æœ‰å¤šå°‘ä¸ªå‘¢ï¼Ÿ P å’Œ M ä»€ä¹ˆæ—¶å€™è¢«åˆ›å»ºå‘¢ï¼Ÿ æ“ä½œç³»ç»ŸåªçŸ¥é“çº¿ç¨‹ï¼Œæ‰€ä»¥å®é™…ä¸Šè¿˜æ˜¯çº¿ç¨‹åœ¨æ‰§è¡Œä»»åŠ¡ï¼Œé‚£ä¹ˆ G æ˜¯å¦‚ä½•è°ƒåº¦åˆ°çº¿ç¨‹ä¸Šå¹¶æ‰§è¡Œçš„å‘¢ï¼Ÿ å¦‚ä½•é˜²æ­¢åç¨‹é¥¥é¥¿ï¼Ÿ å¦‚ä½•å‡å°‘é¢‘ç¹åœ°åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ï¼Ÿ å¤šä¸ªçº¿ç¨‹ä»å…¨å±€é˜Ÿåˆ—æ‹¿ G å¦‚ä½•è§£å†³å¹¶å‘é—®é¢˜ï¼Ÿåˆå¦‚ä½•å‡å°‘è¿™ç§æ•°æ®ç«äº‰å‘¢ï¼Ÿ åœ¨æ•´ä¸ª Go è°ƒåº¦åç¨‹çš„è¿‡ç¨‹ä¸­ï¼ŒGã€Pã€M æœ‰å“ªäº›çŠ¶æ€ï¼Ÿå®ƒä»¬åˆæ˜¯å¦‚ä½•è½®è½¬çš„å‘¢ï¼Ÿ å¦‚æœä½ å¯¹è¿™å‡ ä¸ªé—®é¢˜æœ‰å…´è¶£ï¼Œè¯·ç»§ç»­é˜…è¯»ä¸‹æ–‡ã€‚ 2. P å’Œ M çš„ä¸ªæ•°é—®é¢˜ P çš„æ•°é‡ç”±å¯åŠ¨æ—¶ç¯å¢ƒå˜é‡ $GOMAXPROCS æˆ–è€…ç¨‹åºä¸­ runtime.GOMAXPROCS() å†³å®šã€‚è¿™æ„å‘³ç€åœ¨ç¨‹åºæ‰§è¡Œçš„ä»»æ„æ—¶åˆ»éƒ½åªæœ‰ GOMAXPROCS ä¸ª Goroutine åœ¨åŒæ—¶è¿è¡Œã€‚ M çš„æ•°é‡ç”± Go è¯­è¨€æœ¬èº«çš„é™åˆ¶å†³å®šï¼ŒGo ç¨‹åºå¯åŠ¨æ—¶ä¼šè®¾ç½® M çš„æœ€å¤§æ•°é‡ä¸º 10000 ä¸ªï¼Œä½†æ˜¯å†…æ ¸å¾ˆéš¾æ”¯æŒè¿™ä¹ˆå¤šçš„çº¿ç¨‹æ•°ï¼Œæ‰€ä»¥è¿™ä¸ªé™åˆ¶å¯ä»¥å¿½ç•¥ã€‚å¯ä»¥ä½¿ç”¨ runtime.SetMaxThreads() è®¾ç½® M çš„æœ€å¤§æ•°é‡ã€‚ 3. P å’Œ M ä½•æ—¶è¢«åˆ›å»º P çš„åˆ›å»ºæ—¶æœºåœ¨ç¡®å®šäº† P çš„æœ€å¤§æ•°é‡ n åï¼Œruntime ä¼šæ ¹æ®è¿™ä¸ªæ•°é‡åˆ›å»º n ä¸ª Pã€‚ M åˆ›å»ºçš„æ—¶æœºæ˜¯åœ¨å½“æ²¡æœ‰è¶³å¤Ÿçš„ M æ¥å…³è” P å¹¶è¿è¡Œå…¶ä¸­å¯è¿è¡Œçš„ G çš„æ—¶å€™ï¼Œå¦‚æ‰€æœ‰çš„ M æ­¤æ—¶éƒ½é˜»å¡ä½äº†ï¼Œè€Œ P ä¸­è¿˜æœ‰å¾ˆå¤šå°±ç»ªä»»åŠ¡ï¼Œå°±ä¼šå»å¯»æ‰¾ç©ºé—²çš„ Mï¼Œå¦‚æœæ²¡æœ‰ç©ºé—²çš„ Mï¼Œå°±ä¼šå»åˆ›å»ºæ–°çš„ Mã€‚ 4. è°ƒåº¦å¾ªç¯ åœ¨è®¨è®º G æ˜¯å¦‚ä½•è¢«è°ƒåº¦åˆ° M å»æ‰§è¡Œçš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å…ˆä»‹ç» GPM æ¨¡å‹ä¸­ä¸¤ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„è§’è‰²ï¼šm0 å’Œ g0ã€‚ 4.1 m0 å®šä¹‰ï¼šm0 æ˜¯ Go ç¨‹åºå¯åŠ¨æ—¶åˆ›å»ºçš„ç¬¬ä¸€ä¸ª Mã€‚å®ƒæ˜¯ç”± Go è¿è¡Œæ—¶ç³»ç»Ÿç›´æ¥ä»æ“ä½œç³»ç»Ÿçº¿ç¨‹åˆ›å»ºçš„ï¼Œä¸æ˜¯ä»çº¿ç¨‹æ± ä¸­è·å–çš„ã€‚ ä½œç”¨ï¼šm0 è´Ÿè´£åˆå§‹åŒ–å’Œå¯åŠ¨ Go è¿è¡Œæ—¶ç¯å¢ƒï¼ŒåŒ…æ‹¬åˆ›å»ºè°ƒåº¦å™¨ã€åˆ†é…ç¬¬ä¸€ä¸ª Pï¼ˆp0ï¼‰ï¼Œå¹¶åˆ›å»ºå…¶ä»–ç³»ç»Ÿçº§åˆ«çš„èµ„æºã€‚åœ¨ç¨‹åºçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­ï¼Œm0 ä¼šç»§ç»­å­˜åœ¨ï¼Œå³ä½¿å®ƒå¯èƒ½ä¸æ‰§è¡Œä»»ä½• Go ä»£ç ã€‚ ç‰¹ç‚¹ï¼šm0 ä¸åŒäºå…¶ä»– Mï¼Œå› ä¸ºå®ƒä¸æ˜¯ä»çº¿ç¨‹æ± ä¸­è·å–çš„ã€‚å®ƒå¯èƒ½æ²¡æœ‰ç»‘å®šä»»ä½• Pï¼Œé™¤éç¨‹åºä¸­åªæœ‰ä¸€ä¸ª Pï¼ˆå³ GOMAXPROCS è®¾ç½®ä¸º 1ï¼‰ã€‚ 4.2 g0 å®šä¹‰ï¼šg0 æ˜¯æ¯ä¸ª M çš„ç‰¹æ®Š Goroutineï¼Œå®ƒä¸æ‰§è¡Œä»»ä½•å®é™…çš„ Go ä»£ç ã€‚æ¯ä¸ª M åœ¨åˆ›å»ºæ—¶éƒ½ä¼šåˆ†é…ä¸€ä¸ª g0ã€‚ ä½œç”¨ï¼šg0 ä¸»è¦ç”¨äºæ‰§è¡Œè°ƒåº¦å™¨ä»£ç å’Œè¿›è¡Œç³»ç»Ÿè°ƒç”¨ã€‚å½“ M éœ€è¦æ‰§è¡Œè¿™äº›éç”¨æˆ·ä»£ç æ—¶ï¼Œä¼šåˆ‡æ¢åˆ° g0 çš„æ ˆä¸Šè¿è¡Œã€‚ ç‰¹ç‚¹ï¼šg0 æ‹¥æœ‰è‡ªå·±çš„æ ˆï¼Œè¿™ä¸ªæ ˆç”¨äºå­˜æ”¾è°ƒåº¦å™¨å‡½æ•°å’Œç³»ç»Ÿè°ƒç”¨çš„æ•°æ®ã€‚è¿™æ„å‘³ç€å½“æ‰§è¡Œè¿™äº›æ“ä½œæ—¶ï¼Œä¸ä¼šå½±å“å½“å‰è¿è¡Œçš„ç”¨æˆ· Goroutine çš„æ ˆã€‚ 4.3 åç¨‹æ ˆåˆ‡æ¢ g0 æ˜¯ M ä¸­è´Ÿè´£è°ƒåº¦å…¶ä»– g çš„åç¨‹ï¼Œæ‰€ä»¥ä¸€ä¸ª M ä¸­çš„åç¨‹è°ƒåº¦å…¶å®å°±æ˜¯åœ¨ g å’Œ g0 ä¹‹é—´ä¸æ–­åˆ‡æ¢ï¼š åç¨‹ g ä¸ åç¨‹ g0 çš„å¯¹åº”å…³ç³» å¤§è‡´è¿‡ç¨‹å¦‚ä¸‹ï¼š å½“ M æ‰§è¡Œä¸€ä¸ª Gï¼ˆç”¨æˆ· Goroutineï¼‰æ—¶ï¼Œå®ƒä½¿ç”¨ G çš„æ ˆæ¥è¿è¡Œç”¨æˆ·ä»£ç ã€‚ å½“éœ€è¦æ‰§è¡Œç³»ç»Ÿè°ƒç”¨æˆ–è°ƒåº¦å™¨ç›¸å…³çš„ä»£ç æ—¶ï¼ŒM ä¼šåˆ‡æ¢åˆ° g0ã€‚g0 æ‹¥æœ‰è‡ªå·±çš„æ ˆï¼Œä¸“é—¨ç”¨äºæ‰§è¡Œç³»ç»Ÿè°ƒç”¨å’Œè°ƒåº¦å™¨ä»£ç ï¼Œè¿™æ ·å¯ä»¥é¿å…æ±¡æŸ“ç”¨æˆ· Goroutine çš„æ ˆç©ºé—´ã€‚åœ¨ g0 ä¸Šï¼ŒM å¯ä»¥æ‰§è¡Œå¦‚å†…å­˜åˆ†é…ã€è°ƒåº¦å†³ç­–ã€å¤„ç† Goroutine çš„åˆ›å»ºå’Œé”€æ¯ç­‰æ“ä½œã€‚ å®Œæˆç³»ç»Ÿè°ƒç”¨æˆ–è°ƒåº¦å™¨ä»»åŠ¡åï¼ŒM ä¼šåˆ‡æ¢å›ä¹‹å‰çš„ Gï¼Œç»§ç»­æ‰§è¡Œç”¨æˆ·ä»£ç ã€‚è¿™ä¸ªè¿‡ç¨‹ä¼šä» g0 çš„æ ˆåˆ‡æ¢å› G çš„æ ˆã€‚ è¯¦ç»†ç»†èŠ‚æˆ‘ä»¬ç•™åˆ°åé¢çš„æºç åˆ†ææ­æ™“ã€‚ 5. è°ƒåº¦ç­–ç•¥ Go åç¨‹è°ƒåº¦ä¼˜å…ˆçº§ä¸é¡ºåº 5.1 è·å–æœ¬åœ°è¿è¡Œé˜Ÿåˆ— P ä¼šä¼˜å…ˆå°è¯•ä»è‡ªå·±çš„æœ¬åœ°é˜Ÿåˆ—ä¸­å¯»æ‰¾å°±ç»ªçš„ Gï¼Œå®ƒä¸€èˆ¬ä¼šä¼˜å…ˆè°ƒåº¦æœ€è¿‘åŠ å…¥çš„ã€‚ å› ä¸ºè¿™ä¸ªæ—¶å€™å¯èƒ½ç”±å…¶ä»– P æ¥çªƒå– Gï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯éœ€è¦åŒæ­¥æœºåˆ¶çš„ï¼ŒGo é‡‡ç”¨åŸå­æ“ä½œæ¥é™ä½åŒæ­¥å¼€é”€ã€‚ æœ¬åœ°é˜Ÿåˆ— G çš„ä¸ªæ•°ä¸è¶…è¿‡ 256 ä¸ªï¼Œå¦‚æœåœ¨åˆ›å»º G çš„æ—¶å€™æœ¬åœ°é˜Ÿåˆ—æ»¡äº†ï¼Œä¼šå°†æœ¬åœ°é˜Ÿåˆ—ä¸­ 1/2 çš„ G è¿åŒæ–°åˆ›å»ºçš„ G ä¸€èµ·æ”¾å…¥å…¨å±€é˜Ÿåˆ—ä¸­ã€‚ 5.2 è·å–å…¨å±€è¿è¡Œé˜Ÿåˆ— P ä¼šä¼˜å…ˆæœ¬åœ°é˜Ÿåˆ—ï¼Œç„¶åæ‰å…¨å±€é˜Ÿåˆ—ï¼Œè¿™æœ‰ä¸ªå¥½å¤„ï¼š å¦‚æœåªæœ‰å…¨å±€é˜Ÿåˆ—ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„ P éƒ½éœ€è¦å»ç«äº‰å…¨å±€é˜Ÿåˆ—ä¸­çš„ Gï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦ä¸Šé”ï¼Œä¸”æ•°æ®ç«äº‰ä¼šæ¯”è¾ƒæ¿€çƒˆï¼Œæ€§èƒ½è¾ƒå·®ã€‚ é€šè¿‡æ¯ä¸ª P ç»´æŠ¤ä¸€ä¸ªè‡ªå·±çš„æœ¬åœ°é˜Ÿåˆ—å¯ä»¥å‡å°‘å¹¶å‘å†²çªï¼Œå¦‚æœå®åœ¨éœ€è¦å»å…¨å±€é˜Ÿåˆ—æ‹¿ Gï¼Œä¹Ÿå¯ä»¥ä¸€æ¬¡æ€§æ‹¿å¤šä¸ªï¼Œå¤§å¤§å‡å°‘äº†å¹¶å‘å†²çªçš„æƒ…å†µå‘ç”Ÿã€‚ ä½†è¿™åˆå¸¦æ¥äº†ä¸€ä¸ªé—®é¢˜ï¼Œå…¨å±€é˜Ÿåˆ—ä¸­åç¨‹çš„é¥¥é¥¿é—®é¢˜ï¼Œå› ä¸º P ä¼šä¼˜å…ˆè°ƒåº¦æœ€è¿‘åŠ å…¥åˆ°è‡ªå·±æœ¬åœ°é˜Ÿåˆ—ä¸­çš„ Gï¼Œé‚£å¯èƒ½ä¼šä¸€ç›´æœ‰æ–°çš„ G è¢«åˆ›å»ºï¼Œå¯¼è‡´å…¨å±€é˜Ÿåˆ—ä¸­çš„ G æ²¡æœ‰æœºä¼šè¢«è°ƒåº¦åˆ°ã€‚Go çš„è§£å†³æ€è·¯æ˜¯ï¼š P æ¯è°ƒåº¦ 61 æ¬¡åï¼Œå°±ä¼šä»å…¨å±€é˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ª G æ¥è¿è¡Œã€‚ 5.3 è·å–å‡†å¤‡å°±ç»ªçš„ç½‘ç»œåç¨‹ å¦‚æœæœ¬åœ°é˜Ÿåˆ—å’Œå…¨å±€é˜Ÿåˆ—éƒ½æ‰¾ä¸åˆ°å°±ç»ªçš„ G å¯ä»¥æ‰§è¡Œçš„è¯ã€‚è°ƒåº¦ä¼šé€šè¿‡ runtime.netpoll è·å–å¯ä»¥è¿è¡Œçš„ç½‘ç»œåç¨‹ã€‚ Go è¯­è¨€çš„ç½‘ç»œæ¨¡å‹æ˜¯å¯¹ä¸åŒæ“ä½œç³»ç»Ÿå¹³å°ä¸Š I/O å¤šè·¯å¤ç”¨æŠ€æœ¯çš„å°è£…ã€‚ å½“ Goroutine åœ¨è¿›è¡Œç½‘ç»œ I/O æ—¶ï¼Œå®ƒä¼šè¢«æŒ‚èµ·ï¼Œçº¿ç¨‹ä¼šå»æ‰§è¡Œå…¶ä»– Goroutineã€‚ä¸€æ—¦ I/O æ“ä½œå®Œæˆï¼Œè¯¥ Goroutine ä¼šè¢«å”¤é†’å¹¶é‡æ–°æ’é˜Ÿç­‰å¾…æ‰§è¡Œã€‚ 5.4 ç³»ç»Ÿè°ƒç”¨ å½“ä¸€ä¸ª Goroutine æ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå®ƒå¯èƒ½ä¼šè¢«é˜»å¡ï¼Œè¿™æ—¶å®ƒçš„æ‰§è¡Œçº¿ç¨‹ï¼ˆMï¼‰å¯èƒ½ä¼šé‡Šæ”¾å½“å‰ç»‘å®šçš„å¤„ç†å™¨ï¼ˆPï¼‰ï¼Œä»¥ä¾¿å…¶ä»– Goroutine å¯ä»¥åœ¨è¯¥ P ä¸Šè¿è¡Œã€‚ 5.5 åç¨‹çªƒå– ç©ºé—²çš„ M å¦‚æœç»‘å®šäº† Pï¼Œé‚£ä¹ˆå®ƒçš„ P ä¼šä¸€ç›´å°è¯•ä»å…¶ä»– P çš„é˜Ÿåˆ—ä¸­çªƒå– Goroutineï¼Œä»¥å¹³è¡¡è´Ÿè½½å’Œé¿å…ç©ºé—²ã€‚è¿™ä¸ªæ—¶å€™ä¸ºäº†è®©æ¯ä¸ª P éƒ½æœ‰å¯èƒ½è¢«çªƒå–ï¼ŒGo æ²¡æœ‰ç›´æ¥é¡ºåºéå† P åˆ—è¡¨ï¼Œè€Œæ˜¯é‡‡ç”¨äº†ä¸€ç§ç›¸å¯¹éšæœºçš„æ–¹å¼å»éå† P åˆ—è¡¨ï¼Œç›´åˆ°æ‰¾åˆ°å¯ä»¥è¿è¡Œçš„åç¨‹å°±è¿”å›ã€‚M ä¸æ–­å¯»æ‰¾å¯æ‰§è¡Œ G çš„è¿™æ®µæœŸé—´ï¼Œå®ƒè¢«ç§°ä¸ºè‡ªæ—‹çº¿ç¨‹ã€‚ æ‰€ä»¥ä¸ºå‡å°‘åˆ›å»ºã€åˆ‡æ¢å’Œé”€æ¯çº¿ç¨‹çš„å¼€é”€ï¼ŒGo åšäº†è‡³å°‘ä¸¤ç‚¹åŠªåŠ›ï¼š å·å–ï¼ˆWork Stealingï¼‰æœºåˆ¶ å½“æœ¬çº¿ç¨‹æ— å¯è¿è¡Œçš„ G æ—¶ï¼Œå®ƒæ‰€ç»‘å®šçš„ P ä¼šå°è¯•ä»å…¶ä»–çº¿ç¨‹ç»‘å®šçš„ P çªƒå– Gï¼Œè€Œä¸æ˜¯é”€æ¯çº¿ç¨‹ã€‚ ç§»äº¤ï¼ˆHand Offï¼‰æœºåˆ¶ å½“æœ¬çº¿ç¨‹å› ä¸º G è¿›è¡Œç³»ç»Ÿè°ƒç”¨è€Œé˜»å¡æ—¶ï¼Œçº¿ç¨‹ä¼šé‡Šæ”¾ç»‘å®šçš„ Pï¼ŒæŠŠ P ç§»äº¤ç»™å…¶ä»–ç©ºé—²çš„çº¿ç¨‹æ‰§è¡Œã€‚ 6. è°ƒåº¦æ—¶æœº Go è¯­è¨€çš„è°ƒåº¦å™¨ç»“åˆäº†æŠ¢å å¼è°ƒåº¦å’Œåä½œå¼è°ƒåº¦ï¼Œä»¥ä¸‹æ˜¯ Go ä¸­è¿™ä¸¤ç§è°ƒåº¦æ–¹å¼çš„å…·ä½“å®ç°å’Œç‰¹æ€§ï¼š 6.1 åä½œå¼è°ƒåº¦ï¼ˆCooperative Schedulingï¼‰ é˜»å¡æ“ä½œï¼š å½“ Goroutine æ‰§è¡Œé˜»å¡æ“ä½œï¼ˆå¦‚é€šé“æ“ä½œã€ç­‰å¾…é”ã€ç³»ç»Ÿè°ƒç”¨ç­‰ï¼‰æ—¶ï¼Œå®ƒä¼šä¸»åŠ¨æ”¾å¼ƒ CPU æ§åˆ¶æƒï¼Œå…è®¸è°ƒåº¦å™¨åˆ‡æ¢åˆ°å…¶ä»– Goroutineã€‚ æ˜¾å¼è°ƒåº¦ï¼š Goroutine æ˜¾å¼è¯·æ±‚ runtime.Gosched() è°ƒç”¨ï¼Œè°ƒåº¦å™¨è¿›è¡Œè°ƒåº¦ã€‚ è¿™ä¸ªæ—¶å€™å›ä»å½“å‰åç¨‹åˆ‡æ¢åˆ° g0 åç¨‹ï¼Œå–æ¶ˆ G ä¸ M ä¹‹é—´çš„ç»‘å®šå…³ç³»ï¼ŒæŠŠ G æ”¾å…¥å…¨å±€é˜Ÿåˆ—ä¸­ã€‚ 6.2 æŠ¢å å¼è°ƒåº¦ï¼ˆPreemptive Schedulingï¼‰ åŸºäºæ—¶é—´çš„æŠ¢å ï¼š ä» Go 1.14 å¼€å§‹ï¼Œè°ƒåº¦å™¨å¼•å…¥äº†åŸºäºæ—¶é—´çš„æŠ¢å æœºåˆ¶ã€‚å¦‚æœä¸€ä¸ª Goroutine è¿è¡Œæ—¶é—´è¶…è¿‡ 10 æ¯«ç§’ï¼Œæˆ–è€…åœ¨ç³»ç»Ÿè°ƒç”¨ä¸­è¶…è¿‡äº† 20 å¾®å¦™ï¼Œè°ƒåº¦å™¨ä¼šåœ¨å®‰å…¨ç‚¹ï¼ˆå¦‚å‡½æ•°è°ƒç”¨ã€å¾ªç¯è¿­ä»£ã€é˜»å¡æ“ä½œç­‰ï¼‰å°è¯•æš‚åœè¯¥ Goroutineã€‚ è¿™ç§æŠ¢å ä¸ä¾èµ–äº Goroutine çš„æ˜¾å¼æ”¾å¼ƒæ§åˆ¶ï¼Œè€Œæ˜¯ç”±è°ƒåº¦å™¨ä¸»åŠ¨è§¦å‘ã€‚ å®‰å…¨ç‚¹çš„é€‰æ‹©æ—¨åœ¨å‡å°‘å¯¹ Goroutine æ‰§è¡Œçš„å¹²æ‰°ï¼ŒåŒæ—¶ç¡®ä¿è°ƒåº¦çš„å…¬å¹³æ€§å’Œå“åº”æ€§ã€‚ åŸºäºä¿¡å·çš„æŠ¢å ï¼š å½“ç¨‹åºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ—¢æ— æ³•ä¸»åŠ¨æŒ‚èµ·ï¼Œä¹Ÿä¸èƒ½è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œä¸”æ— æ³•è¿›è¡Œå‡½æ•°è°ƒç”¨æ—¶ï¼Œå°±å¯ä»¥ä½¿ç”¨ä¿¡å·æ¥è°ƒåº¦ã€‚ ä¿¡å·å…¶å®å°±æ˜¯çº¿ç¨‹ä¿¡å·ï¼Œåœ¨æ“ä½œç³»ç»Ÿä¸­æœ‰å¾ˆå¤šåŸºäºä¿¡å·çš„åº•å±‚é€šä¿¡æ–¹å¼ï¼ˆSIGPIPE / SIGURG / SIGHUPï¼‰ï¼Œè€Œæˆ‘ä»¬çš„çº¿ç¨‹å¯ä»¥æ³¨å†Œå¯¹åº”ä¿¡å·çš„å¤„ç†å‡½æ•°ã€‚ å½“çº¿ç¨‹æ¥æ”¶åˆ°æŠ¢å ä¿¡å·æ—¶ï¼Œä¼šè¿›å…¥ä¸€ä¸ªä¸“é—¨çš„ä¿¡å·å¤„ç†å™¨ã€‚è¿™ä¸ªå¤„ç†å™¨ä¼šæ£€æŸ¥æ˜¯å¦å¤„äºå®‰å…¨ç‚¹ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æš‚åœå½“å‰ Goroutine å¹¶è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚ æºç åˆ†æ å‰é¢æˆ‘ä»¬å¯¹ Go è¯­è¨€çš„ GPM æ¨¡å‹åœ¨åŸºæœ¬æ¦‚å¿µã€è°ƒåº¦å¾ªç¯ã€è°ƒåº¦ç­–ç•¥å’Œè°ƒåº¦æ—¶æœºå„ä¸ªæ–¹é¢éƒ½è¿›è¡Œäº†è¯¦ç»†çš„é˜è¿°ã€‚å¦‚æœè¯»è€…åªæ˜¯æƒ³ç®€å•äº†è§£ä¸€ä¸‹ GPM æ¨¡å‹çš„ä¸€äº›æ¦‚å¿µå’Œè®¾è®¡æ€æƒ³ï¼Œé‚£ä¹ˆé˜…è¯»åˆ°è¿™é‡Œå°±åŸºæœ¬è¶³å¤Ÿäº†ã€‚å¦‚æœå¯¹å…¶æºç å®ç°æœ‰å…´è¶£çš„è¯ï¼Œé‚£ä¹ˆè¯·ç»§ç»­å¾€ä¸‹é˜…è¯»~ æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ¥å¯¹ Go è¯­è¨€çš„ GPM æ¨¡å‹è¿›è¡Œæºç åˆ†æï¼š Gã€Pã€M åœ¨ Go è¯­è¨€ä¸­çš„è¡¨ç¤ºã€‚ G çš„åˆ›å»ºè¿‡ç¨‹ã€‚ g å’Œ g0 çš„åˆ‡æ¢è¿‡ç¨‹ã€‚ GPM çš„è°ƒåº¦æœºåˆ¶ã€‚ 1. G çš„åº•å±‚ç»“æ„ G åœ¨ Go é‡Œé¢å°±æ˜¯ runtime2.go é‡Œé¢å®šä¹‰çš„ g ç»“æ„ä½“ï¼š type g struct // æ ˆå‚æ•°ã€‚\t// stack æè¿°å®é™…çš„æ ˆå†…å­˜ï¼š[stack.lo, stack.hi)ã€‚\t// stackguard0 æ˜¯åœ¨ Go æ ˆå¢é•¿åºè¨€ä¸­æ¯”è¾ƒçš„æ ˆæŒ‡é’ˆã€‚\t// é€šå¸¸æ˜¯ stack.lo+StackGuardï¼Œä½†å¯ä»¥æ˜¯ StackPreempt æ¥è§¦å‘æŠ¢å ã€‚\t// stackguard1 æ˜¯åœ¨ C æ ˆå¢é•¿åºè¨€ä¸­æ¯”è¾ƒçš„æ ˆæŒ‡é’ˆã€‚\t// åœ¨ g0 å’Œ gsignal æ ˆä¸Šæ˜¯ stack.lo+StackGuardã€‚\t// åœ¨å…¶ä»– goroutine æ ˆä¸Šæ˜¯ ~0ï¼Œä»¥è§¦å‘å¯¹ morestackc çš„è°ƒç”¨ï¼ˆå¹¶å´©æºƒï¼‰ã€‚\tstack stack // è¿è¡Œæ—¶/CGO å·²çŸ¥çš„åç§»\tstackguard0 uintptr // liblink å·²çŸ¥çš„åç§»\tstackguard1 uintptr // liblink å·²çŸ¥çš„åç§»\t_panic *_panic // æœ€å†…å±‚çš„ panic - liblink å·²çŸ¥çš„åç§»\t_defer *_defer // æœ€å†…å±‚çš„ defer\tm *m // å½“å‰ mï¼›arm liblink å·²çŸ¥çš„åç§»\tsched gobuf // å½“å‰åç¨‹çš„è¿è¡Œç°åœº\tsyscallsp uintptr // å¦‚æœ status==Gsyscall, syscallsp = sched.sp åœ¨ gc æœŸé—´ä½¿ç”¨\tsyscallpc uintptr // å¦‚æœ status==Gsyscall, syscallpc = sched.pc åœ¨ gc æœŸé—´ä½¿ç”¨\tstktopsp uintptr // æ ˆé¡¶çš„é¢„æœŸ spï¼Œç”¨äºå›æº¯æ£€æŸ¥\t// param æ˜¯ä¸€ä¸ªé€šç”¨çš„æŒ‡é’ˆå‚æ•°å­—æ®µï¼Œç”¨äºåœ¨ç‰¹å®šä¸Šä¸‹æ–‡ä¸­ä¼ é€’å€¼ï¼Œ\t// å…¶ä»–å­˜å‚¨å‚æ•°çš„æ–¹å¼éš¾ä»¥æ‰¾åˆ°ã€‚ç›®å‰æœ‰ä¸‰ç§ç”¨é€”ï¼š\t// 1. å½“é€šé“æ“ä½œå”¤é†’ä¸€ä¸ªé˜»å¡çš„ goroutine æ—¶ï¼Œå®ƒå°† param è®¾ç½®ä¸º\t// æŒ‡å‘å·²å®Œæˆé˜»å¡æ“ä½œçš„ sudogã€‚\t// 2. ç”± gcAssistAlloc1 ä½¿ç”¨ï¼Œä»¥å‘å…¶è°ƒç”¨è€…ä¿¡å·ï¼Œè¡¨æ˜ goroutine å®Œæˆäº† GC å‘¨æœŸã€‚\t// ä»¥ä»»ä½•å…¶ä»–æ–¹å¼è¿™æ ·åšæ˜¯ä¸å®‰å…¨çš„ï¼Œå› ä¸ºæ­¤æ—¶ goroutine çš„æ ˆå¯èƒ½å·²ç»ç§»åŠ¨ã€‚\t// 3. ç”± debugCallWrap ä½¿ç”¨ï¼Œä»¥å°†å‚æ•°ä¼ é€’ç»™æ–°çš„ goroutineï¼Œå› ä¸ºåœ¨è¿è¡Œæ—¶åˆ†é…é—­åŒ…æ˜¯è¢«ç¦æ­¢çš„ã€‚\tparam unsafe.Pointer\tatomicstatus atomic.Uint32\tstackLock uint32 // sigprof/scang é”ï¼›TODO: åˆå¹¶åˆ° atomicstatus\tgoid uint64\tschedlink guintptr\twaitsince int64 // g å˜ä¸ºé˜»å¡çš„å¤§è‡´æ—¶é—´\twaitreason waitReason // å¦‚æœ status==Gwaiting\tpreempt bool // æŠ¢å ä¿¡å·ï¼Œå¤åˆ¶ stackguard0 = stackpreempt\tpreemptStop bool // åœ¨æŠ¢å æ—¶è½¬æ¢ä¸º _Gpreemptedï¼›å¦åˆ™ï¼Œåªæ˜¯å–æ¶ˆè°ƒåº¦\tpreemptShrink bool // åœ¨åŒæ­¥å®‰å…¨ç‚¹ç¼©å°æ ˆ\t// asyncSafePoint è®¾ç½®ä¸º true è¡¨ç¤º g åœ¨å¼‚æ­¥å®‰å…¨ç‚¹åœæ­¢ã€‚\t// è¿™æ„å‘³ç€æ ˆä¸Šæœ‰æ²¡æœ‰ç²¾ç¡®æŒ‡é’ˆä¿¡æ¯çš„å¸§ã€‚\tasyncSafePoint bool\tpaniconfault bool // åœ¨æ„å¤–çš„æ•…éšœåœ°å€ä¸Šè§¦å‘ panicï¼ˆè€Œä¸æ˜¯å´©æºƒï¼‰\tgcscandone bool // g å·²æ‰«ææ ˆï¼›ç”± _Gscan ä½åœ¨çŠ¶æ€ä¸­ä¿æŠ¤\tthrowsplit bool // å¿…é¡»ä¸åˆ†å‰²æ ˆ\t// activeStackChans è¡¨ç¤ºæœ‰æœªé”å®šçš„é€šé“æŒ‡å‘è¿™ä¸ª goroutine çš„æ ˆã€‚\t// å¦‚æœä¸º trueï¼Œæ ˆå¤åˆ¶éœ€è¦è·å–é€šé“é”æ¥ä¿æŠ¤è¿™äº›æ ˆåŒºåŸŸã€‚\tactiveStackChans bool\t// parkingOnChan è¡¨ç¤º goroutine å³å°†åœ¨ chansend æˆ– chanrecv ä¸Šåœè½¦ã€‚\t// ç”¨äºæ ‡è®°æ ˆç¼©å°çš„ä¸å®‰å…¨ç‚¹ã€‚\tparkingOnChan atomic.Bool\traceignore int8 // å¿½ç•¥ç«æ€æ£€æµ‹äº‹ä»¶\ttracking bool // æ˜¯å¦è·Ÿè¸ªæ­¤ G ä»¥è·å–è°ƒåº¦å»¶è¿Ÿç»Ÿè®¡\ttrackingSeq uint8 // ç”¨äºå†³å®šæ˜¯å¦è·Ÿè¸ªæ­¤ G\ttrackingStamp int64 // G æœ€åå¼€å§‹è¢«è·Ÿè¸ªçš„æ—¶é—´æˆ³\trunnableTime int64 // å¯è¿è¡Œæ—¶é—´ï¼Œè¿è¡Œæ—¶æ¸…é™¤ï¼Œä»…åœ¨è·Ÿè¸ªæ—¶ä½¿ç”¨\tlockedm muintptr\tsig uint32\twritebuf []byte\tsigcode0 uintptr\tsigcode1 uintptr\tsigpc uintptr\tparentGoid uint64 // åˆ›å»ºæ­¤ goroutine çš„ goroutine çš„ goid\tgopc uintptr // åˆ›å»ºæ­¤ goroutine çš„ go è¯­å¥çš„ pc\tancestors *[]ancestorInfo // åˆ›å»ºæ­¤ goroutine çš„ç¥–å…ˆ goroutine çš„ä¿¡æ¯ï¼ˆä»…åœ¨ debug.tracebackancestors ä½¿ç”¨ï¼‰\tstartpc uintptr // goroutine å‡½æ•°çš„ pc\tracectx uintptr\twaiting *sudog // æ­¤ g æ­£åœ¨ç­‰å¾…çš„ sudog ç»“æ„ï¼ˆå…·æœ‰æœ‰æ•ˆçš„ elem æŒ‡é’ˆï¼‰ï¼›æŒ‰é”é¡ºåº\tcgoCtxt []uintptr // cgo å›æº¯ä¸Šä¸‹æ–‡\tlabels unsafe.Pointer // åˆ†æå™¨æ ‡ç­¾\ttimer *timer // ç¼“å­˜çš„è®¡æ—¶å™¨ï¼Œç”¨äº time.Sleep\tselectDone atomic.Uint32 // æˆ‘ä»¬æ˜¯å¦å‚ä¸ select å¹¶ä¸”æœ‰äººèµ¢å¾—äº†ç«èµ›ï¼Ÿ\t// goroutineProfiled æŒ‡ç¤ºå½“å‰ goroutine çš„æ ˆçŠ¶æ€ // æ˜¯å¦å·²ç»è¢«è®°å½•åœ¨è¿›è¡Œä¸­çš„ goroutine æ€§èƒ½åˆ†æä¸­ã€‚\tgoroutineProfiled goroutineProfileStateHolder\t// æ¯ä¸ª G çš„è¿½è¸ªçŠ¶æ€ã€‚\ttrace gTraceState\t// æ¯ä¸ª G çš„ GC çŠ¶æ€\t// gcAssistBytes æ˜¯æ­¤ G çš„ GC ååŠ©ä¿¡ç”¨ï¼Œä»¥åˆ†é…çš„å­—èŠ‚ä¸ºå•ä½ã€‚\t// å¦‚æœä¸ºæ­£ï¼Œåˆ™ G æœ‰ä¿¡ç”¨åˆ†é… gcAssistBytes å­—èŠ‚è€Œä¸ååŠ©ã€‚\t// å¦‚æœä¸ºè´Ÿï¼Œåˆ™ G å¿…é¡»é€šè¿‡æ‰§è¡Œæ‰«æå·¥ä½œæ¥çº æ­£è¿™ä¸€ç‚¹ã€‚\t// æˆ‘ä»¬ä»¥å­—èŠ‚ä¸ºå•ä½è·Ÿè¸ªè¿™ä¸€ç‚¹ï¼Œä»¥ä¾¿åœ¨ malloc çƒ­è·¯å¾„ä¸­å¿«é€Ÿæ›´æ–°å’Œæ£€æŸ¥å€ºåŠ¡ã€‚\t// ååŠ©æ¯”ç‡å†³å®šäº†è¿™å¦‚ä½•å¯¹åº”äºæ‰«æå·¥ä½œå€ºåŠ¡ã€‚\tgcAssistBytes int64 å¯ä»¥çœ‹åˆ° g ç»“æ„å­—æ®µéå¸¸å¤šï¼Œè¿™ä¸ªç»“æ„ä½“çš„è®¾è®¡åæ˜ äº† Go è¯­è¨€å¯¹å¹¶å‘å’Œåç¨‹ç®¡ç†çš„åº•å±‚æœºåˆ¶ï¼ŒåŒ…æ‹¬æ ˆç®¡ç†ã€è°ƒåº¦ã€åƒåœ¾å›æ”¶ã€å¼‚å¸¸å¤„ç†ç­‰å¤šä¸ªæ–¹é¢ã€‚é€šè¿‡è¿™ç§æŠ½è±¡ï¼ŒGo è¯­è¨€èƒ½å¤Ÿæœ‰æ•ˆåœ°ç®¡ç†æˆåƒä¸Šä¸‡çš„ goroutineï¼Œä½¿å¾—å¹¶å‘ç¼–ç¨‹å˜å¾—æ›´åŠ ç®€å•å’Œé«˜æ•ˆã€‚ è¿™é‡Œæˆ‘ä»¬åªå…³æ³¨ GPM æ¨¡å‹ç›¸å…³çš„å†…å®¹ï¼Œéœ€è¦é‡ç‚¹å…³å¿ƒä»¥ä¸‹å‡ ä¸ªå­—æ®µï¼š type g struct stack stack // å½“å‰åç¨‹çš„åç¨‹æ ˆ\tm *m // å½“å‰çº¿ç¨‹\tsched gobuf // ä¿å­˜åç¨‹çš„è¿è¡Œç°åœº\tatomicstatus atomic.Uint32 // åç¨‹çŠ¶æ€\tgoid uint64 // åç¨‹ID 1.1 åç¨‹æ ˆ stack å…¶ä¸­ stack ç»“æ„å¦‚ä¸‹ï¼Œå®ƒå­˜å‚¨äº†åç¨‹æ ˆçš„ä½åœ°å€å’Œé«˜åœ°å€ã€‚ type stack struct lo uintptr // æ ˆçš„ä½åœ°å€\thi uintptr // æ ˆçš„é«˜åœ°å€ 1.2 çº¿ç¨‹æŠ½è±¡ m è€Œ m å°±æ˜¯ Go è¯­è¨€å¯¹æ“ä½œç³»ç»Ÿçº¿ç¨‹çš„æŠ½è±¡ï¼Œè¿™ä¸æ˜¯å®é™…çš„çº¿ç¨‹ï¼Œè¿™åªæ˜¯ Go è¯­è¨€å¯¹çº¿ç¨‹ç›¸å…³ä¿¡æ¯çš„æŠ½è±¡ï¼Œä»¥æ–¹ä¾¿æ›´å¥½åœ°è°ƒåº¦åç¨‹ã€‚ type m struct g0 *g // g0 åç¨‹ï¼ŒGo ä¸­çš„ä¸»åç¨‹\tcurg *g // ç°åœ¨æ­£åœ¨è¿è¡Œçš„åç¨‹\tid int64 // çº¿ç¨‹ID\tmOS // å½“å‰æ“ä½œç³»ç»Ÿå¯¹çº¿ç¨‹çš„é¢å¤–æè¿°ä¿¡æ¯\t... m ç»“æ„ä½“åŒ…å«äº†è®¸å¤šå­—æ®µï¼Œè¿™äº›å­—æ®µæ¶‰åŠåˆ°çº¿ç¨‹ç®¡ç†ã€è°ƒåº¦ã€ä¿¡å·å¤„ç†ã€ç³»ç»Ÿè°ƒç”¨ã€é”ç®¡ç†ç­‰å¤šä¸ªæ–¹é¢ã€‚è¿™ä¸ªç»“æ„ä½“æ˜¯ Go å¹¶å‘æ¨¡å‹çš„æ ¸å¿ƒéƒ¨åˆ†ä¹‹ä¸€ï¼Œå®ƒä¸ gï¼ˆgoroutineï¼‰å’Œ pï¼ˆprocessorï¼‰ç»“æ„ä½“ä¸€èµ·ï¼Œæ„æˆäº† Go çš„è°ƒåº¦ç³»ç»Ÿçš„åŸºç¡€ã€‚é€šè¿‡è¿™ç§è®¾è®¡ï¼ŒGo èƒ½å¤Ÿæœ‰æ•ˆåœ°åœ¨å¤šä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ä¹‹é—´è°ƒåº¦æˆåƒä¸Šä¸‡çš„ goroutineï¼Œå®ç°é«˜æ•ˆçš„å¹¶å‘æ‰§è¡Œã€‚ 1.3 åç¨‹ä¸Šä¸‹æ–‡ gobuf gobuf ç»“æ„ä½“åœ¨ Go è¯­è¨€çš„è¿è¡Œæ—¶ç³»ç»Ÿä¸­ç”¨äºä¿å­˜ Goroutine çš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œç‰¹åˆ«æ˜¯åœ¨è°ƒåº¦å’Œç³»ç»Ÿè°ƒç”¨ä¸­ã€‚è¿™ä¸ªç»“æ„ä½“ä¿å­˜äº†è¶³å¤Ÿçš„ä¿¡æ¯ä»¥ä¾¿åœ¨ Goroutine è¢«æš‚åœåèƒ½å¤Ÿæ¢å¤æ‰§è¡Œã€‚ ä¸‹é¢æ˜¯å¯¹ gobuf ç»“æ„ä½“ä¸­å„ä¸ªå­—æ®µçš„è§£é‡Šï¼š type gobuf struct // sp, pc å’Œ g çš„åç§»é‡æ˜¯å·²çŸ¥çš„ï¼ˆåœ¨ libmach ä¸­ç¡¬ç¼–ç ï¼‰ã€‚\t//\t// ctxt åœ¨ GC æ–¹é¢æ¯”è¾ƒç‰¹æ®Šï¼šå®ƒå¯èƒ½æ˜¯ä¸€ä¸ªå †åˆ†é…çš„ funcvalï¼Œ\t// å› æ­¤ GC éœ€è¦è·Ÿè¸ªå®ƒï¼Œä½†å®ƒéœ€è¦åœ¨æ±‡ç¼–ä¸­è®¾ç½®å’Œæ¸…é™¤ï¼Œ\t// åœ¨é‚£é‡Œå®ç°å†™å±éšœæ¯”è¾ƒå›°éš¾ã€‚ç„¶è€Œï¼Œctxt å®é™…ä¸Šæ˜¯ä¸€ä¸ªä¿å­˜çš„ã€æ´»è·ƒçš„å¯„å­˜å™¨ï¼Œ\t// æˆ‘ä»¬åªåœ¨çœŸå®å¯„å­˜å™¨å’Œ gobuf ä¹‹é—´äº¤æ¢å®ƒã€‚å› æ­¤ï¼Œæˆ‘ä»¬åœ¨æ ˆæ‰«ææœŸé—´å°†å…¶è§†ä¸ºæ ¹ï¼Œ\t// è¿™æ„å‘³ç€ä¿å­˜å’Œæ¢å¤å®ƒçš„æ±‡ç¼–ä¸éœ€è¦å†™å±éšœã€‚å®ƒä»ç„¶è¢«ç±»å‹åŒ–ä¸ºæŒ‡é’ˆï¼Œ\t// ä»¥ä¾¿ä»»ä½•å…¶ä»–ä» Go è¿›è¡Œçš„å†™æ“ä½œéƒ½ä¼šè·å¾—å†™å±éšœã€‚\tsp uintptr // æ ˆæŒ‡é’ˆ\tpc uintptr // ç¨‹åºè®¡æ•°å™¨\tg guintptr // æŒ‡å‘å½“å‰ goroutine çš„æŒ‡é’ˆ\tctxt unsafe.Pointer // ä¸Šä¸‹æ–‡ï¼Œç”¨äºä¿å­˜é¢å¤–çš„çŠ¶æ€æˆ–ä¿¡æ¯\tret uintptr // ç”¨äºä¿å­˜å‡½æ•°è¿”å›å€¼\tlr uintptr // é“¾æ¥å¯„å­˜å™¨ï¼ˆåœ¨æŸäº›æ¶æ„ä¸­ç”¨äºå‡½æ•°è°ƒç”¨ï¼‰\tbp uintptr // åŸºæŒ‡é’ˆï¼ˆåœ¨å¯ç”¨å¸§æŒ‡é’ˆçš„æ¶æ„ä¸­ä½¿ç”¨ï¼‰ æˆ‘ä»¬é‡ç‚¹éœ€è¦å…³æ³¨ 2 ä¸ªå­—æ®µï¼š spï¼šæ ˆæŒ‡é’ˆï¼Œè¡¨ç¤ºå½“å‰åç¨‹è¿è¡Œåˆ°æ ˆä¸­çš„å“ªä¸ªä½ç½®äº†ã€‚ pcï¼šç¨‹åºè®¡æ•°å™¨ï¼Œè¡¨ç¤ºå½“å‰åç¨‹è¿è¡Œåˆ°å“ªä¸€è¡Œä»£ç äº†ã€‚ 1.4 åç¨‹çŠ¶æ€ atomicstatus æˆ‘è®°å¾—åœ¨ Go1.16 ç‰ˆæœ¬ä¸­ï¼Œè¿™ä¸ªå­—æ®µçš„ç±»å‹è¿˜æ˜¯ uint32ï¼š atomicstatus uint32 ç°åœ¨ Go1.21 ç‰ˆæœ¬ä¸­ï¼Œå·²ç»ç”¨äº†åŸå­æ“ä½œæ¥å‡å°‘å¹¶å‘å†²çªäº†ï¼š atomicstatus atomic.Uint32 å¯ä»¥çœ‹åˆ° Go çš„åº•å±‚ä¹Ÿæ˜¯éšç€ç‰ˆæœ¬æ›´æ–°ä¸æ–­ä¼˜åŒ–ä¸­çš„ã€‚ runtime2.go å®šä¹‰äº† G çš„å„ç§çŠ¶æ€ï¼Œå¦‚ï¼š _Gidle (0): è¡¨ç¤º G åˆšåˆšè¢«åˆ†é…ï¼Œå°šæœªåˆå§‹åŒ–ã€‚ _Grunnable (1): è¡¨ç¤º G åœ¨è¿è¡Œé˜Ÿåˆ—ä¸Šã€‚å®ƒå½“å‰æ²¡æœ‰æ‰§è¡Œç”¨æˆ·ä»£ç ã€‚æ ˆä¸è¢«è¯¥ goroutine æ‹¥æœ‰ã€‚ ... åé¢æˆ‘ä»¬ä¼šç»™å‡º G çŠ¶æ€çš„æµè½¬å›¾ã€‚ 1.5 ä¸¾ä¸ªä¾‹å­ å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰ä»¥ä¸‹ Go ä»£ç ï¼šmain() è°ƒç”¨ do1()ï¼Œdo1() è°ƒç”¨ do2()ï¼Œdo2() è°ƒç”¨ do3()ã€‚ func do3() fmt.Println(here is do3)func do2() do3() //\t---------------func do1() do2()func main() do1() é‚£ä¹ˆå½“è¿™æ®µç¨‹åºè¿è¡Œåˆ°ç¬¬ 6 è¡Œçš„æ—¶å€™ï¼Œå®ƒçš„åº•å±‚ç»“æ„å¤§æ¦‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š Goroutine åº•å±‚ç»“æ„ç¤ºä¾‹ è‡³äºä¸ºä»€ä¹ˆè¿™é‡Œæœ‰ä¸ª goexit()ï¼Œå…¶å®å°±æ˜¯ä¸ºäº†å¯ä»¥è·³å›åˆ° g0 åç¨‹ï¼Œåé¢æˆ‘ä»¬ä¼šå…·ä½“åˆ†æåˆ°ã€‚ 2. P çš„åº•å±‚ç»“æ„ P çš„æœ¬è´¨æ˜¯ runtime2.go é‡Œé¢å®šä¹‰çš„ p ç»“æ„ä½“ï¼š type p struct id int32 // P çš„å”¯ä¸€æ ‡è¯†ç¬¦ status uint32 // P çš„çŠ¶æ€ï¼Œå¦‚ pidle/prunning/... link puintptr // P é“¾æ¥ schedtick uint32 // æ¯æ¬¡è°ƒåº¦å™¨è°ƒç”¨æ—¶é€’å¢ syscalltick uint32 // æ¯æ¬¡ç³»ç»Ÿè°ƒç”¨æ—¶é€’å¢ sysmontick sysmontick // sysmon è§‚å¯Ÿåˆ°çš„æœ€åä¸€ä¸ª tick m muintptr // å…³è”çš„ M çš„åå‘é“¾æ¥ï¼ˆå¦‚æœç©ºé—²åˆ™ä¸º nilï¼‰ mcache *mcache // M ç¼“å­˜ pcache pageCache // é¡µé¢ç¼“å­˜ raceprocctx uintptr // ç”¨äºç«æ€æ£€æµ‹çš„ä¸Šä¸‹æ–‡ // å»¶è¿Ÿç»“æ„ä½“æ±  deferpool []*_defer deferpoolbuf [32]*_defer // Goroutine ID ç¼“å­˜ï¼Œå‡å°‘å¯¹ runtimeÂ·sched.goidgen çš„è®¿é—® goidcache uint64 goidcacheend uint64 // å¯è¿è¡Œ goroutine é˜Ÿåˆ—ï¼Œæ— é”è®¿é—® runqhead uint32 runqtail uint32 runq [256]guintptr runnext guintptr // ä¸‹ä¸€ä¸ªè¦è¿è¡Œçš„ G // ç©ºé—² G çš„åˆ—è¡¨ï¼ˆçŠ¶æ€ == Gdeadï¼‰ gFree struct gList n int32 // sudog ç¼“å­˜ sudogcache []*sudog sudogbuf [128]*sudog // å †ä¸Š mspan å¯¹è±¡çš„ç¼“å­˜ mspancache struct len int buf [128]*mspan // pinner å¯¹è±¡çš„ç¼“å­˜ pinnerCache *pinner // P çŠ¶æ€è·Ÿè¸ª trace pTraceState // æ¯ä¸ª P çš„æŒä¹…åˆ†é…ï¼Œé¿å…äº’æ–¥ palloc persistentAlloc // å®šæ—¶å™¨ç›¸å…³å­—æ®µ timer0When atomic.Int64 timerModifiedEarliest atomic.Int64 timersLock mutex timers []*timer numTimers atomic.Uint32 deletedTimers atomic.Uint32 timerRaceCtx uintptr // GC ç›¸å…³å­—æ®µ gcAssistTime int64 gcFractionalMarkTime int64 gcw gcWork wbBuf wbBuf // æŒ‡ç¤ºæ˜¯å¦åœ¨ä¸‹ä¸€ä¸ªå®‰å…¨ç‚¹è¿è¡Œç‰¹å®šçš„å‡½æ•° runSafePointFn uint32 // æŒ‡ç¤ºå½“å‰ P æ˜¯å¦æ­£åœ¨å†™å…¥ä»»ä½•ç»Ÿè®¡æ•°æ®ã€‚ // å¶æ•°æ—¶è¡¨ç¤ºæ²¡æœ‰å†™å…¥ï¼Œå¥‡æ•°æ—¶è¡¨ç¤ºæ­£åœ¨å†™å…¥ã€‚ statsSeq atomic.Uint32 // æŒ‡ç¤ºå½“å‰çš„ P åº”è¯¥å°½å¿«è¿›å…¥è°ƒåº¦å™¨ï¼Œæ— è®ºå…¶ä¸Šè¿è¡Œçš„æ˜¯å“ªä¸ª Gã€‚ // è¿™æ˜¯å®ç°æŠ¢å å¼è°ƒåº¦çš„ä¸€éƒ¨åˆ†ï¼Œå…è®¸è°ƒåº¦å™¨åœ¨å¿…è¦æ—¶ä¸­æ–­é•¿æ—¶é—´è¿è¡Œçš„ goroutineï¼Œ // ä»¥ä¾¿å…¶ä»– goroutine æœ‰æœºä¼šè¿è¡Œã€‚ preempt bool // è®°å½•é¡µé¢åˆ†é…ã€é‡Šæ”¾å’Œæ¸…ç†è·Ÿè¸ªä¿¡æ¯çš„ç¼“å†²åŒºã€‚ pageTraceBuf pageTraceBuf p ç»“æ„ä½“åœ¨ Go è¯­è¨€çš„è¿è¡Œæ—¶ç³»ç»Ÿä¸­ä»£è¡¨äº†ä¸€ä¸ªå¤„ç†å™¨ï¼ˆprocessorï¼‰ï¼Œå®ƒæ˜¯è°ƒåº¦å™¨çš„æ ¸å¿ƒç»„æˆéƒ¨åˆ†ã€‚æ¯ä¸ª p è´Ÿè´£ç®¡ç†ä¸€ç»„ goroutine çš„è¿è¡Œã€‚è¿™ä¸ªç»“æ„ä½“åŒ…å«äº†è®¸å¤šå­—æ®µï¼Œæ¶‰åŠåˆ° goroutine çš„è°ƒåº¦ã€å†…å­˜åˆ†é…ã€åƒåœ¾å›æ”¶å’Œå…¶ä»–ç³»ç»Ÿçº§åˆ«çš„æ“ä½œã€‚ æˆ‘ä»¬é‡ç‚¹å…³æ³¨ä»¥ä¸‹å‡ ä¸ªå­—æ®µï¼š type p struct m muintptr // å½“å‰è´Ÿè´£çš„çº¿ç¨‹ // æœ¬åœ°å¯è¿è¡Œçš„åç¨‹çš„é˜Ÿåˆ—ï¼Œå¯æ— é”è®¿é—®\trunqhead uint32 // é˜Ÿå¤´\trunqtail uint32 // é˜Ÿå°¾\trunq [256]guintptr // é•¿åº¦ä¸º 256\trunnext guintptr // ä¸‹ä¸€ä¸ªå¯ç”¨çš„åç¨‹çš„æŒ‡é’ˆ // æŠ¢å æ ‡è¯†ï¼ŒæŒ‡ç¤ºå½“å‰çš„ P åº”è¯¥å°½å¿«è¿›å…¥è°ƒåº¦å™¨ï¼Œæ— è®ºå…¶ä¸Šè¿è¡Œçš„æ˜¯å“ªä¸ª Gã€‚ preempt bool P åº•å±‚ç»“æ„ 3. Goroutine çš„åˆ›å»º Go å¹¶å‘èƒ½åŠ›çš„ä¼˜ç§€ä¹‹å¤„ï¼Œå°±åœ¨äºå®ƒå¯åŠ¨ä¸€ä¸ªæ–°çš„åç¨‹å®åœ¨æ˜¯å¤ªæ–¹ä¾¿äº†ï¼š go func() ... () é‚£ä¹ˆåº•å±‚ç©¶ç«Ÿåšäº†ä»€ä¹ˆå‘¢ï¼Ÿ 3.1 newproc() Goroutine é€šè¿‡ proc.go ä¸­çš„ newproc() åˆ›å»ºï¼š func newproc(fn *funcval) gp := getg() pc := getcallerpc() systemstack(func() newg := newproc1(fn, gp, pc) pp := getg().m.p.ptr() runqput(pp, newg, true) if mainStarted wakep() ) è·å–å½“å‰ goroutine å’Œè°ƒç”¨è€… PC: getg() è·å–å½“å‰æ­£åœ¨æ‰§è¡Œçš„ goroutineï¼Œgetcallerpc() è·å–è°ƒç”¨è€…çš„ç¨‹åºè®¡æ•°å™¨åœ°å€ã€‚ åœ¨ç³»ç»Ÿæ ˆä¸Šæ‰§è¡Œ newproc1: systemstack ç¡®ä¿ newproc1 åœ¨ç³»ç»Ÿæ ˆä¸Šæ‰§è¡Œï¼Œè€Œä¸æ˜¯å½“å‰ goroutine çš„æ ˆã€‚è¿™æ˜¯å› ä¸ºæ–°çš„ goroutine å¯èƒ½éœ€è¦æ›´å¤šçš„æ ˆç©ºé—´ã€‚ åˆ›å»ºæ–°çš„ goroutine: newproc1 è¢«è°ƒç”¨æ¥å®é™…åˆ›å»ºæ–°çš„ goroutineã€‚ å°†æ–°çš„ goroutine æ”¾å…¥è¿è¡Œé˜Ÿåˆ—: runqput å°†æ–°åˆ›å»ºçš„ goroutine æ”¾å…¥è¿è¡Œé˜Ÿåˆ—ã€‚ å”¤é†’å¤„ç†å™¨: å¦‚æœä¸»å‡½æ•°å·²ç»å¼€å§‹æ‰§è¡Œï¼Œwakep ç”¨äºå”¤é†’ä¸€ä¸ªç©ºé—²çš„ P æ¥è¿è¡Œæ–°çš„ goroutineã€‚ 3.2 newproc1() func newproc1(fn *funcval, callergp *g, callerpc uintptr) *g // ... (çœç•¥äº†é”™è¯¯æ£€æŸ¥å’Œè·å– M çš„ä»£ç ) // å°è¯•ä» P çš„ç©ºé—²åˆ—è¡¨è·å–ä¸€ä¸ª Gï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„ newg := gfget(pp) if newg == nil newg = malg(stackMin) casgstatus(newg, _Gidle, _Gdead) allgadd(newg) // è®¾ç½®æ–° G çš„æ ˆ totalSize := uintptr(4*goarch.PtrSize + sys.MinFrameSize) totalSize = alignUp(totalSize, sys.StackAlign) sp := newg.stack.hi - totalSize spArg := sp // æ¸…ç©ºå¹¶è®¾ç½®æ–° G çš„è°ƒåº¦å™¨ç›¸å…³å­—æ®µ memclrNoHeapPointers(unsafe.Pointer(newg.sched), unsafe.Sizeof(newg.sched)) newg.sched.sp = sp newg.stktopsp = sp newg.sched.pc = abi.FuncPCABI0(goexit) + sys.PCQuantum newg.sched.g = guintptr(unsafe.Pointer(newg)) // è®¾ç½®æ–° G çš„å…¶ä»–å­—æ®µ gostartcallfn(newg.sched, fn) newg.parentGoid = callergp.goid newg.gopc = callerpc newg.startpc = fn.fn // ... (çœç•¥äº†è·Ÿè¸ªå’Œè°ƒè¯•ç›¸å…³çš„ä»£ç ) casgstatus(newg, _Gdead, _Grunnable) return newg åˆ›å»ºæˆ–è·å–ä¸€ä¸ªæ–°çš„ goroutine: gfget å°è¯•ä» P çš„ç©ºé—²åˆ—è¡¨ä¸­è·å–ä¸€ä¸ª goroutineï¼Œå¦‚æœæ²¡æœ‰å¯ç”¨çš„ï¼Œåˆ™é€šè¿‡ malg åˆ†é…ä¸€ä¸ªæ–°çš„ã€‚ åˆå§‹åŒ– goroutine çš„æ ˆå’Œè°ƒåº¦å™¨: è®¾ç½®æ–° goroutine çš„æ ˆã€ç¨‹åºè®¡æ•°å™¨ã€è°ƒç”¨å‡½æ•°ç­‰ã€‚è¿™é‡Œæœ‰ä¸ªéå¸¸æ ¸å¿ƒçš„ç‚¹ newg.sched.pc = abi.FuncPCABI0(goexit) + sys.PCQuantumï¼Œæˆ‘ä»¬å‰é¢ç•™äº†ä¸ªç–‘é—®ï¼Œåç¨‹æ ˆé¡¶çš„ goexit æ˜¯å“ªé‡Œæ¥çš„ï¼Œå°±æ˜¯è¿™é‡Œæ¥çš„ã€‚è¿™é‡Œè®¾ç½®æ–° goroutine çš„ç¨‹åºè®¡æ•°å™¨ï¼ˆpcï¼‰æŒ‡å‘ goexit å‡½æ•°ã€‚goexit æ˜¯æ¯ä¸ª goroutine åœ¨é€€å‡ºæ—¶å¿…é¡»è°ƒç”¨çš„å‡½æ•°ï¼Œç”¨äºæ‰§è¡Œæ¸…ç†å·¥ä½œå¹¶åˆ‡æ¢åˆ° g0 æ ˆã€‚ è®¾ç½®çˆ¶ goroutine ID å’Œåˆ›å»ºç‚¹: è®°å½•åˆ›å»ºè¿™ä¸ªæ–° goroutine çš„çˆ¶ goroutine çš„ ID å’Œ go è¯­å¥çš„ä½ç½®ã€‚ æ›´æ”¹ goroutine çŠ¶æ€: å°†æ–° goroutine çš„çŠ¶æ€ä» _Gdead æ”¹ä¸º _Grunnableï¼Œä½¿å…¶å‡†å¤‡å¥½è¢«è°ƒåº¦ã€‚ è¿”å›æ–°çš„ goroutine: å‡½æ•°è¿”å›æ–°åˆ›å»ºçš„ goroutineã€‚ 3.3 runqput() // runqput tries to put g on the local runnable queue.// If next is false, runqput adds g to the tail of the runnable queue.// If next is true, runqput puts g in the pp.runnext slot.// If the run queue is full, runnext puts g on the global queue.// Executed only by the owner P.func runqput(pp *p, gp *g, next bool) if randomizeScheduler next fastrandn(2) == 0 next = false if next retryNext: oldnext := pp.runnext if !pp.runnext.cas(oldnext, guintptr(unsafe.Pointer(gp))) goto retryNext if oldnext == 0 return gp = oldnext.ptr()\tretry:\th := atomic.LoadAcq(pp.runqhead) t := pp.runqtail\tif t-h uint32(len(pp.runq)) pp.runq[t%uint32(len(pp.runq))].set(gp) atomic.StoreRel(pp.runqtail, t+1) return if runqputslow(pp, gp, h, t) return goto retry éšæœºè°ƒåº¦å™¨ï¼šå¦‚æœå¯ç”¨äº†è°ƒåº¦å™¨çš„éšæœºåŒ–ï¼ˆrandomizeSchedulerï¼‰ï¼Œå¹¶ä¸” next ä¸º trueï¼ˆnewproc è°ƒç”¨çš„æ—¶å€™æ°¸è¿œéƒ½æ˜¯ä¼ çš„ trueï¼‰ï¼Œåˆ™æœ‰ä¸€åŠçš„æ¦‚ç‡å°† next è®¾ç½®ä¸º falseã€‚è¿™æœ‰åŠ©äºé˜²æ­¢è°ƒåº¦å™¨çš„è¡Œä¸ºè¿‡äºå¯é¢„æµ‹ã€‚ å¤„ç† runnext æ§½ï¼šå¦‚æœ next ä¸º trueï¼Œå‡½æ•°å°è¯•å°† gp æ”¾å…¥ pp.runnext æ§½ã€‚å¦‚æœè¯¥æ§½å·²è¢«å ç”¨ï¼Œåˆ™å°†åŸæœ‰çš„ goroutine ç§»åŠ¨åˆ°å¸¸è§„è¿è¡Œé˜Ÿåˆ—ï¼Œå¹¶é‡è¯•å°†æ–°çš„ gp æ”¾å…¥ runnextã€‚ æ”¾å…¥æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ï¼šå¦‚æœ next ä¸º false æˆ– runnext æ§½å·²æ»¡ï¼Œå‡½æ•°å°è¯•å°† gp æ”¾å…¥æœ¬åœ°è¿è¡Œé˜Ÿåˆ—çš„å°¾éƒ¨ã€‚å¦‚æœé˜Ÿåˆ—æœªæ»¡ï¼Œgp å°†è¢«æˆåŠŸæ·»åŠ ã€‚ å¤„ç†é˜Ÿåˆ—æ»¡çš„æƒ…å†µï¼šå¦‚æœæœ¬åœ°è¿è¡Œé˜Ÿåˆ—å·²æ»¡ï¼Œrunqputslow è¢«è°ƒç”¨ï¼Œå°è¯•å°† gp è¿åŒè‡ªå·±é˜Ÿåˆ—ä¸­ä¸€åŠçš„ g æ”¾å…¥å…¨å±€è¿è¡Œé˜Ÿåˆ—ã€‚å¦‚æœè¿™ä¹Ÿå¤±è´¥äº†ï¼Œå‡½æ•°ä¼šé‡è¯•å°† gp æ”¾å…¥æœ¬åœ°é˜Ÿåˆ—ã€‚ åŸå­æ“ä½œï¼šå‡½æ•°ä½¿ç”¨åŸå­æ“ä½œæ¥åŠ è½½å’Œå­˜å‚¨é˜Ÿåˆ—å¤´ï¼ˆrunqheadï¼‰å’Œå°¾ï¼ˆrunqtailï¼‰æŒ‡é’ˆï¼Œä»¥ç¡®ä¿å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„æ•°æ®ä¸€è‡´æ€§å’Œçº¿ç¨‹å®‰å…¨ã€‚ 3.4 runqputslow() runqputslow å‡½æ•°å¤„ç†æœ¬åœ°è¿è¡Œé˜Ÿåˆ—æ»¡çš„æƒ…å†µï¼Œå°† goroutine æ‰¹é‡è½¬ç§»åˆ°å…¨å±€é˜Ÿåˆ—ã€‚è¿™ä¸ªå‡½æ•°é€šè¿‡åŸå­æ“ä½œå’Œé”æ¥ç¡®ä¿æ“ä½œçš„åŸå­æ€§å’Œçº¿ç¨‹å®‰å…¨ã€‚éšæœºåŒ–è°ƒåº¦å™¨çš„ä½¿ç”¨å¢åŠ äº†è°ƒåº¦çš„éšæœºæ€§å’Œå…¬å¹³æ€§ã€‚ // Put g and a batch of work from local runnable queue on global queue.// Executed only by the owner P.func runqputslow(pp *p, gp *g, h, t uint32) bool // ä» pp çš„æœ¬åœ°é˜Ÿåˆ—ä¸­è·å–ä¸€åŠçš„ goroutine var batch [len(pp.runq)/2 + 1]*g\tn := t - h\tn = n / 2\tif n != uint32(len(pp.runq)/2) throw(runqputslow: queue is not full) for i := uint32(0); i n; i++ batch[i] = pp.runq[(h+i)%uint32(len(pp.runq))].ptr() if !atomic.CasRel(pp.runqhead, h, h+n) return false batch[n] = gp // éšæœºæ‰“ä¹± goroutine çš„é¡ºåºï¼Œä»¥å¢åŠ è°ƒåº¦çš„éšæœºæ€§\tif randomizeScheduler for i := uint32(1); i = n; i++ j := fastrandn(i + 1) batch[i], batch[j] = batch[j], batch[i] // ä¸²æˆé˜Ÿåˆ—\tfor i := uint32(0); i n; i++ batch[i].schedlink.set(batch[i+1]) var q gQueue\tq.head.set(batch[0])\tq.tail.set(batch[n])\t// æ”¾å…¥å…¨å±€é˜Ÿåˆ—ä¸­\tlock(sched.lock)\tglobrunqputbatch(q, int32(n+1))\tunlock(sched.lock)\treturn true åˆ›å»ºæ‰¹å¤„ç†æ•°ç»„ï¼šå‡½æ•°é¦–å…ˆåˆ›å»ºä¸€ä¸ª batch æ•°ç»„ï¼Œç”¨äºå­˜å‚¨ä»æœ¬åœ°é˜Ÿåˆ—ä¸­å–å‡ºçš„ goroutineã€‚ ä»æœ¬åœ°é˜Ÿåˆ—ä¸­è·å–ä¸€æ‰¹ goroutineï¼šå‡½æ•°è®¡ç®—å‡ºè¦ä»æœ¬åœ°é˜Ÿåˆ—ä¸­å–å‡ºå¤šå°‘ä¸ª goroutineï¼ˆé€šå¸¸æ˜¯é˜Ÿåˆ—é•¿åº¦çš„ä¸€åŠï¼‰ï¼Œå¹¶å°†å®ƒä»¬æ·»åŠ åˆ° batch æ•°ç»„ä¸­ã€‚ åŸå­æ“ä½œæ›´æ–°é˜Ÿåˆ—å¤´éƒ¨ï¼šä½¿ç”¨åŸå­æ“ä½œ atomic.CasRel æ›´æ–°æœ¬åœ°è¿è¡Œé˜Ÿåˆ—çš„å¤´éƒ¨ç´¢å¼•ï¼Œè¿™æ˜¯ä¸€ä¸ªé‡Šæ”¾ï¼ˆreleaseï¼‰æ“ä½œï¼Œç¡®ä¿ä¹‹å‰çš„è¯»å–æ“ä½œå®Œæˆã€‚ å°†å½“å‰ goroutine æ·»åŠ åˆ°æ‰¹å¤„ç†ä¸­ï¼šå°†ä¼ å…¥çš„ gp æ·»åŠ åˆ° batch æ•°ç»„çš„æœ«å°¾ã€‚ éšæœºåŒ–è°ƒåº¦å™¨ï¼šå¦‚æœå¯ç”¨äº†éšæœºè°ƒåº¦å™¨ï¼Œå‡½æ•°ä¼šéšæœºæ‰“ä¹± batch æ•°ç»„ä¸­çš„ goroutine é¡ºåºï¼Œä»¥å¢åŠ è°ƒåº¦çš„éšæœºæ€§ã€‚ é“¾æ¥ goroutineï¼šå°† batch æ•°ç»„ä¸­çš„ goroutine é“¾æ¥èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªé˜Ÿåˆ—ã€‚ å‡†å¤‡å…¨å±€é˜Ÿåˆ—ï¼šåˆ›å»ºä¸€ä¸ª gQueue ç»“æ„ï¼Œå¹¶è®¾ç½®å…¶å¤´éƒ¨å’Œå°¾éƒ¨æŒ‡å‘ batch æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ª goroutineã€‚ å°†æ‰¹å¤„ç†æ”¾å…¥å…¨å±€é˜Ÿåˆ—ï¼šåŠ é”è®¿é—®å…¨å±€è°ƒåº¦å™¨çš„é”ï¼Œç„¶åå°†æ•´ä¸ª batch é˜Ÿåˆ—æ”¾å…¥å…¨å±€è¿è¡Œé˜Ÿåˆ—ã€‚ 4. è°ƒåº¦è¿‡ç¨‹ schedule() Go çš„è°ƒåº¦å™¨æ ¸å¿ƒæ‰§è¡Œé€»è¾‘éƒ½åœ¨ proc.go çš„ schedule() å‡½æ•°ä¸­ã€‚æˆ‘ä»¬å…ˆä¸æ¢è®¨è¿‡å¤šçš„ç»†èŠ‚ï¼Œæˆ‘ä»¬å…ˆæŠŠæ•´ä¸ªå¤§ä½“è„‰ç»œç†æ¸…æ¥šå†è¯´ã€‚ ç®€åŒ–åçš„ schedule() å¦‚ä¸‹ï¼š func schedule() // è·å–å½“å‰æ­£åœ¨æ‰§è¡Œçš„ M\tmp := getg().m ... // æŸ¥æ‰¾ä¸€ä¸ªå¯è¿è¡Œçš„ Gï¼Œä¼šé˜»å¡ä½ç›´åˆ°è¿”å›ã€‚\tgp, inheritTime, tryWakeP := findRunnable() ...\t// æ‰§è¡Œ g\texecute(gp, inheritTime) execute() æ‰§è¡Œ gï¼Œå®ƒç®€åŒ–åå¦‚ä¸‹ï¼š func execute(gp *g, inheritTime bool) mp := getg().m\t..\tgogo(gp.sched) å®ƒè°ƒç”¨äº† gogo()ï¼š func gogo(buf *gobuf) ä¸€èˆ¬è¿™ç§æ ¼å¼è¯´æ˜å‡½æ•°æ˜¯ç”¨æ±‡ç¼–å®ç°çš„ï¼Œæˆ‘ä»¬åœ¨ Goland ä¸Šå¯ä»¥åŒå‡» shift ç„¶åæœç´¢ runtimeÂ·gogoï¼š runtimeÂ·gogo ä¸åŒçš„å¹³å°æœ‰ä¸åŒçš„å®ç°ï¼Œä½†æ˜¯æ ¸å¿ƒé€»è¾‘éƒ½æ˜¯ä¸€æ ·çš„ï¼Œ å®ƒç›´æ¥æ“ä½œå¤„ç†å™¨çš„å¯„å­˜å™¨å’Œæ ˆï¼Œä»¥å®ç°ä»ä¸€ä¸ª goroutine åˆ‡æ¢åˆ°å¦ä¸€ä¸ª goroutine çš„åŠŸèƒ½ã€‚ æˆ‘ä»¬åé¢çš„å‘å†…å¿ƒä¼šå‘ç° goexit() æœ€ç»ˆä¼šè°ƒç”¨ schedule()ã€‚ è¿™å°±ä¸²èµ·æ¥äº†ï¼ŒGo ç¨‹åºå¯åŠ¨åä¼šåˆ›å»º m0 å’Œ g0ï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ªschedule() æ˜¯ g0 è°ƒç”¨çš„ï¼Œæœ€åé€šè¿‡ gogo åˆ‡æ¢åˆ°ç”¨æˆ·åç¨‹ g ä¸Šé¢æ‰§è¡Œä¸šåŠ¡æ–¹æ³•ï¼Œå®Œäº‹å g é€šè¿‡ goexit å›åˆ° schedule()ï¼Œä»¥æ­¤å¾ªç¯åå¤ä¸‹å»ã€‚ ç°åœ¨æˆ‘ä»¬å¯ä»¥æ¥æ€»ç»“ä¸€ä¸‹ GPM è°ƒåº¦å¾ªç¯çš„è¿‡ç¨‹ï¼Œå¤§æ¦‚å¦‚ä¸‹å›¾è¡¨ç¤ºï¼š GPM è°ƒåº¦å¾ªç¯å›¾ ä¸‹é¢æˆ‘ä»¬å†å¯¹è¿™ä¸ªè¿‡ç¨‹ä¸­çš„å…³é”®å‡½æ•°è¿›è¡Œç»†è‡´åˆ†æï¼š schedule()ï¼šè°ƒåº¦å…¥å£ã€‚ findRunnable()ï¼šå¯»æ‰¾å¯æ‰§è¡Œçš„ Gã€‚ execute()ï¼šæ‰§è¡Œ Gã€‚ gogo()ï¼šåˆ‡æ¢åç¨‹æ ˆ g0 åˆ° gã€‚ goexit()ï¼šé€€å‡º g åç¨‹ï¼Œåˆ‡æ¢å› g0 æ ˆã€‚ 4.1 schedule() func schedule() // è·å–å½“å‰æ­£åœ¨æ‰§è¡Œçš„ M\tmp := getg().m // æœ‰é”çš„è¯æŠ›å‡ºå¼‚å¸¸ï¼Œé¿å…è¯¥æƒ…å†µä¸‹è°ƒåº¦å‡ºç°æ­»é”æˆ–å…¶ä»–é—®é¢˜\tif mp.locks != 0 throw(schedule: holding locks) // M è¢«é”å®šäº†ç‰¹å®šçš„ Gï¼Œè¿™ä¸ªæ—¶å€™ç›´æ¥æ‰§è¡Œè¿™ä¸ªé”å®šçš„ Gã€‚\tif mp.lockedg != 0 stoplockedm() execute(mp.lockedg.ptr(), false) // Never returns. // CGO è°ƒç”¨éœ€è¦ g0 æ ˆï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™ä¸ç»§ç»­è°ƒåº¦äº†ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚\tif mp.incgo throw(schedule: in cgo)\ttop:\tpp := mp.p.ptr()\tpp.preempt = false\t// å®‰å…¨ç‚¹æ£€æŸ¥ï¼šå¦‚æœå½“å‰ M åœ¨è‡ªæ—‹çš„è¯ï¼Œåº”è¯¥æ˜¯æ²¡æœ‰å¯æ‰§è¡Œ G çš„ã€‚\tif mp.spinning (pp.runnext != 0 || pp.runqhead != pp.runqtail) throw(schedule: spinning with local work) // æŸ¥æ‰¾ä¸€ä¸ªå¯è¿è¡Œçš„ Gï¼Œä¼šé˜»å¡ä½ç›´åˆ°è¿”å›ã€‚\tgp, inheritTime, tryWakeP := findRunnable() // è°ƒè¯•çš„æ—¶å€™ç³»ç»Ÿä¼šå¤„äºâ€œå†»ç»“â€çŠ¶æ€ï¼Œ // è¿™é‡Œæ•…æ„é€šè¿‡ä¸¤æ¬¡ lock å¼•å…¥æ­»é”ä½¿å½“å‰ M é™·å…¥æ— é™ç­‰å¾…ï¼Œ // ä»¥åœ¨è°ƒè¯•æ—¶ä¿æŒå½“å‰çš„è°ƒåº¦å™¨å’Œè¿è¡Œæ—¶çŠ¶æ€ä¸å˜ã€‚\tif debug.dontfreezetheworld 0 freezing.Load() lock(deadlock) lock(deadlock) // å¦‚æœå½“å‰ M ä¹‹å‰æ˜¯è‡ªæ—‹çš„ï¼Œä½†æ˜¯ç°åœ¨è¦å‡†å¤‡æ‰§è¡Œ G äº†ï¼Œé‚£å°±ä¸æ˜¯è‡ªæ—‹äº†ã€‚\tif mp.spinning resetspinning() // å½“ç”¨æˆ·çº§è°ƒåº¦è¢«ç¦ç”¨æ—¶ï¼Œé‡‡ç”¨åŒé‡æ£€æŸ¥åå¦‚æœç¡®å®è¢«ç¦ç”¨äº†ï¼Œ // é‚£ä¹ˆå°±æŠŠå½“å‰ g æ”¾åœ¨ sched.disable.runnable åˆ—è¡¨ä¸­ï¼Œ // ç­‰å¾…è°ƒåº¦é‡å¯å¯ç”¨æ—¶å†å¤„ç†ã€‚ // åœ¨ gc çš„æ—¶å€™ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼š // gcStart() - schedEnableUser(false) // gcMarkDone() - schedEnableUser(true)\tif sched.disable.user !schedEnabled(gp) lock(sched.lock) if schedEnabled(gp) unlock(sched.lock) else sched.disable.runnable.pushBack(gp) sched.disable.n++ unlock(sched.lock) goto top // æ£€æŸ¥æ˜¯å¦éœ€è¦å”¤é†’ä¸€ä¸ª Pã€‚ // å¦‚æœè¿”å›çš„ g æ¯”è¾ƒç‰¹æ®Šï¼Œæ¯”å¦‚è¦è´Ÿè´£ gcï¼Œé‚£ä¹ˆè¿™ä¸ªå€¼ä¼šæ˜¯ trueã€‚\tif tryWakeP wakep() // å¦‚æœ g å·²ç»ç»‘å®šäº† Mï¼Œåˆ™ç›´æ¥å¯åŠ¨è¯¥ M å»æ‰§è¡Œ gã€‚\tif gp.lockedm != 0 startlockedm(gp) goto top // æ‰§è¡Œ g\texecute(gp, inheritTime) schedule() å‡½æ•°æ˜¯ Go è°ƒåº¦å™¨çš„æ ¸å¿ƒï¼Œè´Ÿè´£ç®¡ç† goroutine çš„æ‰§è¡Œã€‚å®ƒåŒ…æ‹¬å¤šä¸ªæ­¥éª¤ï¼Œå¦‚æ£€æŸ¥å½“å‰ M çš„çŠ¶æ€ï¼Œå¤„ç†ç‰¹æ®Šæƒ…å†µï¼ˆå¦‚ goroutine è¢«é”å®šåˆ°ç‰¹å®šçš„ Mï¼Œæˆ–è€… M æ­£åœ¨æ‰§è¡Œ CGO è°ƒç”¨ï¼‰ï¼Œä»¥åŠé€‰æ‹©å’Œæ‰§è¡Œå¯è¿è¡Œçš„ goroutineã€‚ 4.2 findRunnable() // Finds a runnable goroutine to execute.// Tries to steal from other Ps, get g from local or global queue, poll network.// tryWakeP indicates that the returned goroutine is not normal (GC worker, trace reader) so the caller should try to wake a P.func findRunnable() (gp *g, inheritTime, tryWakeP bool) é€šè¿‡æ³¨é‡Šå°±å¯ä»¥çŸ¥é“è¿™ä¸ªå‡½æ•°çš„ä½œç”¨ï¼šå¯»æ‰¾ä¸€ä¸ªå¯æ‰§è¡Œçš„ goroutineï¼š å°è¯•ä»å…¶ä»– P çªƒå– gã€ä»æœ¬åœ°è·å– gã€ä»å…¨å±€é˜Ÿåˆ—è·å– gã€ä»ç½‘ç»œè½®è¯¢å™¨è·å– gï¼› å¦‚æœæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ gï¼Œå¦‚è¦è´Ÿè´£ gc æˆ– traceï¼Œé‚£ä¹ˆä¼šå°† tryWakeP ç½®ä¸º trueï¼Œè¡¨ç¤ºè°ƒåº¦å™¨éœ€è¦å°è¯•å”¤é†’æˆ–å¯åŠ¨ä¸€ä¸ªæ–°çš„ P æ¥è¿è¡Œè¿™ä¸ª gï¼Œä»¥ç¡®ä¿äº†å³ä½¿åœ¨ç³»ç»Ÿè´Ÿè½½è¾ƒä½æ—¶ï¼Œè¿™äº›ç‰¹æ®Šçš„g ä¹Ÿèƒ½å¾—åˆ°åŠæ—¶å¤„ç†ã€‚ æˆ‘ä»¬åªå…³å¿ƒå®ƒçš„æ ¸å¿ƒéƒ¨åˆ†ï¼š func findRunnable() (gp *g, inheritTime, tryWakeP bool) // è·å–å½“å‰ M\tmp := getg().mtop: // è·å– M ç»‘å®šçš„ P\tpp := mp.p.ptr()\t// 1. æ¯ 61 æ¬¡å¾ªç¯è°ƒåº¦ï¼Œå°±ä¼šå»å…¨å±€é˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ª g æ¥æ‰§è¡Œ\tif pp.schedtick%61 == 0 sched.runqsize 0 lock(sched.lock) gp := globrunqget(pp, 1) unlock(sched.lock) if gp != nil return gp, false, false // 2. ä»æœ¬åœ°é˜Ÿåˆ—ä¸­è·å– g\tif gp, inheritTime := runqget(pp); gp != nil return gp, inheritTime, false // 3. ä»å…¨å±€é˜Ÿåˆ—ä¸­è·å– g\tif sched.runqsize != 0 lock(sched.lock) gp := globrunqget(pp, 0) unlock(sched.lock) if gp != nil return gp, false, false // 4. ä»ç½‘ç»œè½®è¯¢å™¨ä¸­è·å– g\tif netpollinited() netpollWaiters.Load() 0 sched.lastpoll.Load() != 0 if list := netpoll(0); !list.empty() // non-blocking gp := list.pop() injectglist(list) casgstatus(gp, _Gwaiting, _Grunnable) if traceEnabled() traceGoUnpark(gp, 0) return gp, false, false // 5. è‡ªæ—‹ï¼Œä»å…¶ä»– P çªƒå– g // mp.spinning è¿™ä¸ªæ¡ä»¶æ£€æŸ¥å½“å‰ Mï¼ˆæ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼‰æ˜¯å¦åº”è¯¥è¿›å…¥è‡ªæ—‹çŠ¶æ€ã€‚ // è‡ªæ—‹çŠ¶æ€æ„å‘³ç€ M ä¼šç§¯æåœ°å¯»æ‰¾å·¥ä½œï¼Œè€Œä¸æ˜¯ä¼‘çœ ã€‚ // 2*sched.nmspinning.Load() gomaxprocs-sched.npidle.Load() // è¿™ä¸ªæ¡ä»¶ç¡®ä¿ç³»ç»Ÿä¸­è‡ªæ—‹çš„ M çš„æ•°é‡ä¸ä¼šè¶…è¿‡ä¸€å®šæ¯”ä¾‹ã€‚ // è¿™æ˜¯ä¸ºäº†é˜²æ­¢åœ¨ä½å¹¶å‘æƒ…å†µä¸‹è¿‡å¤šçš„ CPU ä½¿ç”¨ã€‚\tif mp.spinning || 2*sched.nmspinning.Load() gomaxprocs-sched.npidle.Load() if !mp.spinning mp.becomeSpinning() gp, inheritTime, tnow, w, newWork := stealWork(now) if gp != nil return gp, inheritTime, false if newWork goto top now = tnow if w != 0 (pollUntil == 0 || w pollUntil) pollUntil = w ...\tgoto top è¿™ä¸ªè¿‡ç¨‹æ¶‰åŠåˆ°å‡ ä¸ªé‡è¦çš„å‡½æ•°ï¼š globrunqget()ï¼šä»å…¨å±€é˜Ÿåˆ—ä¸­å¯»æ‰¾å¯è¿è¡Œçš„ Gã€‚ runqget()ï¼šä»æœ¬åœ°é˜Ÿåˆ—ä¸­å¯»æ‰¾å¯è¿è¡Œçš„ Gã€‚ netpoll()ï¼šå¯»æ‰¾å¯ä»¥è¿è¡Œçš„ç½‘ç»œåç¨‹ã€‚ stealWork()ï¼šä»å…¶ä»– P çªƒå–å¯è¿è¡Œçš„ Gã€‚ 4.3 globrunqget() func globrunqget(pp *p, max int32) *g // æŠ¢å…¨å±€åˆ—è¡¨çš„é” assertLockHeld(sched.lock) // å¦‚æœä¸ºç©ºåˆ™ç›´æ¥è¿”å› if sched.runqsize == 0 return nil // ç¡®å®š n çš„å¤§å°ï¼Œå³è¦ä»å…¨å±€é˜Ÿåˆ—ä¸­è·å–çš„ g çš„ä¸ªæ•°ã€‚ // è¿™é‡Œä¼šç»“åˆå…¥å‚ max å¯¹è¾¹ç•Œå€¼è¿›è¡Œåˆ¤æ–­ï¼Œä»¥è·å¾—ä¸€ä¸ªåˆç†çš„ nã€‚ // ä¸€æ¬¡æ€§æœ€å¤šæ‹¿ len(pp.runq)/2 ä¸ª gã€‚ n := sched.runqsize/gomaxprocs + 1 if n sched.runqsize n = sched.runqsize if max 0 n max n = max if n int32(len(pp.runq))/2 n = int32(len(pp.runq)) / 2 sched.runqsize -= n // é€šè¿‡ pop() ä»å…¨å±€é˜Ÿåˆ—ä¸­å¼¹å‡º g gp := sched.runq.pop() n-- for ; n 0; n-- gp1 := sched.runq.pop() // å°† g æ”¾å…¥ pp çš„æœ¬åœ°é˜Ÿåˆ—ä¸­ // runqput åœ¨å‰é¢åˆ›å»ºåç¨‹çš„åœ°æ–¹å·²ç»ä»‹ç»è¿‡äº†ï¼Œè¿™é‡Œä¸èµ˜è¿°ã€‚ runqput(pp, gp1, false) return gp 4.4 runqget() func runqget(pp *p) (gp *g, inheritTime bool) // runnext çš„ g ä¼šä¼˜å…ˆæ‰§è¡Œ\tnext := pp.runnext\tif next != 0 pp.runnext.cas(next, 0) return next.ptr(), true for // åŸå­æ“ä½œè·å–é˜Ÿå¤´æŒ‡é’ˆ h := atomic.LoadAcq(pp.runqhead) t := pp.runqtail if t == h return nil, false // ä»é˜Ÿå¤´è·å– gï¼Œå¹¶é€šè¿‡åŸå­æ“ä½œæ›´æ–°é˜Ÿå¤´ï¼ˆå³æŠ¢è¿™ä¸ª gï¼‰ gp := pp.runq[h%uint32(len(pp.runq))].ptr() if atomic.CasRel(pp.runqhead, h, h+1) return gp, false runqget() å‡½æ•°ç”¨äºä»æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ªå¯è¿è¡Œçš„ goroutineã€‚è¿™ä¸ªå‡½æ•°åªèƒ½ç”±æ‹¥æœ‰è¯¥é˜Ÿåˆ—çš„å¤„ç†å™¨ï¼ˆPï¼‰æ‰§è¡Œã€‚ä¸‹é¢æ˜¯å¯¹è¿™ä¸ªå‡½æ•°çš„è¯¦ç»†è§£é‡Šï¼š 1. æ£€æŸ¥ runnextï¼š runnext æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å­—æ®µï¼Œç”¨äºå­˜å‚¨ä¸‹ä¸€ä¸ªè¦è¿è¡Œçš„ goroutineã€‚å¦‚æœ runnext éé›¶ï¼Œå¹¶ä¸”èƒ½æˆåŠŸé€šè¿‡åŸå­æ“ä½œï¼ˆCASï¼‰å°†å…¶è®¾ç½®ä¸ºé›¶ï¼Œåˆ™ç›´æ¥è¿”å›è¿™ä¸ª goroutineã€‚ å¦‚æœæˆåŠŸè·å– runnext æŒ‡å‘çš„ goroutineï¼ŒinheritTime è¢«è®¾ç½®ä¸º trueï¼Œè¡¨ç¤ºè¿™ä¸ª goroutine åº”è¯¥ç»§æ‰¿å½“å‰æ—¶é—´ç‰‡çš„å‰©ä½™æ—¶é—´ã€‚ å¦‚æœæ²¡æˆåŠŸï¼Œæ„å‘³ç€ runnext çš„è¿™ä¸ª g å·²ç»è¢«å…¶ä»– P ç»™æŠ¢äº†ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥å‘ç°æœ¬ P åªå¯èƒ½å°†å…¶è®¾ç½®ä¸º 0ï¼Œåªæœ‰å…¶ä»– P æ‰ä¼šå°†å…¶è®¾ç½®ä»¥ä¸ºé 0ã€‚ 2. ä»æœ¬åœ°é˜Ÿåˆ—ä¸­è·å– goroutineï¼š ä½¿ç”¨åŸå­æ“ä½œåŠ è½½ runqheadï¼ˆé˜Ÿåˆ—å¤´æŒ‡é’ˆï¼‰ï¼Œrunqtailï¼ˆé˜Ÿåˆ—å°¾æŒ‡é’ˆï¼‰ã€‚ å¦‚æœ runqhead ç­‰äº runqtailï¼Œè¡¨ç¤ºé˜Ÿåˆ—ä¸ºç©ºï¼Œè¿”å› nilã€‚ å¦åˆ™ï¼Œä»é˜Ÿåˆ—ä¸­è·å– runqhead æŒ‡å‘çš„ goroutineï¼Œå¹¶å°è¯•é€šè¿‡åŸå­æ“ä½œï¼ˆCASï¼‰æ›´æ–° runqheadã€‚ å¦‚æœæ›´æ–°æˆåŠŸï¼Œè¿”å›è·å–åˆ°çš„ goroutineï¼ŒinheritTime è¢«è®¾ç½®ä¸º falseï¼Œè¡¨ç¤ºè¿™ä¸ª goroutine åº”è¯¥å¼€å§‹ä¸€ä¸ªæ–°çš„æ—¶é—´ç‰‡ã€‚ ä¸¤ä¸ªé—®é¢˜ï¼š 1. ä¸ºä»€ä¹ˆè·å– runqhead éœ€è¦ä¸Šé”ï¼Œè·å– runqtail å°±ä¸éœ€è¦ï¼Ÿ å•ä¸€ç”Ÿäº§è€…ï¼šæ¯ä¸ªæœ¬åœ°è¿è¡Œé˜Ÿåˆ—åªæœ‰ä¸€ä¸ªç”Ÿäº§è€…ï¼Œå³ä¸ä¹‹å…³è”çš„å½“å‰ Pã€‚åªæœ‰è¿™ä¸ª P å¯ä»¥å‘é˜Ÿåˆ—å°¾éƒ¨æ·»åŠ æ–°çš„ goroutineã€‚ç”±äºä¸å­˜åœ¨å¤šä¸ªç”Ÿäº§è€…çš„å¹¶å‘å†™å…¥é—®é¢˜ï¼Œå› æ­¤ä¸éœ€è¦é”æ¥ä¿æŠ¤é˜Ÿå°¾ã€‚ 2. inheritTime æœ‰ä»€ä¹ˆç”¨ï¼Ÿ inheritTime çš„ä¸»è¦ä½œç”¨æ˜¯å†³å®šæ–°è°ƒåº¦çš„ goroutine æ˜¯å¦åº”è¯¥ç«‹å³å¼€å§‹ä¸€ä¸ªæ–°çš„æ—¶é—´ç‰‡ï¼Œæˆ–è€…ç»§ç»­ä½¿ç”¨å½“å‰æ—¶é—´ç‰‡çš„å‰©ä½™éƒ¨åˆ†ã€‚è¿™åœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¸‹å°¤ä¸ºé‡è¦ï¼š ç»§æ‰¿æ—¶é—´ç‰‡ (inheritTime == true)ï¼šå½“ runqget ä» runnext å­—æ®µè·å– goroutine æ—¶ï¼Œè¿™ä¸ª goroutine è¢«è®¤ä¸ºæ˜¯ç‰¹åˆ«ä¼˜å…ˆçš„ï¼Œå› æ­¤å®ƒç»§æ‰¿äº†å½“å‰æ—¶é—´ç‰‡çš„å‰©ä½™æ—¶é—´ã€‚è¿™é€šå¸¸å‘ç”Ÿåœ¨ goroutine é€šè¿‡ç‰¹å®šçš„åŒæ­¥æœºåˆ¶ï¼ˆå¦‚é€šé“æ“ä½œï¼‰è¢«æ˜ç¡®å”¤é†’æ—¶ã€‚ å¼€å§‹æ–°çš„æ—¶é—´ç‰‡ (inheritTime == false)ï¼šå½“ runqget ä»æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ä¸­æ­£å¸¸è·å– goroutine æ—¶ï¼Œè¿™ä¸ª goroutine å°†å¼€å§‹ä¸€ä¸ªå…¨æ–°çš„æ—¶é—´ç‰‡ã€‚è¿™ç¡®ä¿äº†è°ƒåº¦çš„å…¬å¹³æ€§ï¼Œä½¿å¾—æ¯ä¸ª goroutine éƒ½æœ‰æœºä¼šåœ¨ç»™å®šçš„æ—¶é—´ç‰‡å†…è¿è¡Œã€‚ 4.5 netpoll() netpoll() å‡½æ•°æ˜¯ Go è¯­è¨€è¿è¡Œæ—¶ç½‘ç»œè½®è¯¢æœºåˆ¶çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºæ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦å‡†å¤‡å¥½è¿›è¡Œéé˜»å¡ I/O æ“ä½œã€‚è¿™ä¸ªå‡½æ•°è¿”å›ä¸€ç»„å·²ç»å˜ä¸ºå¯è¿è¡ŒçŠ¶æ€çš„ goroutineï¼Œè¿™äº› goroutine ä¹‹å‰å¯èƒ½å› ç­‰å¾…ç½‘ç»œ I/O è€Œè¢«æŒ‚èµ·ã€‚ è¿™é‡Œæ¶‰åŠåˆ° Go è¯­è¨€ç½‘ç»œç¼–ç¨‹åŸç†ï¼Œåœ¨æœ¬æ–‡ä¸­ä¸ç»†ç©¶ï¼Œå°±ç®€å•å¸¦è¿‡äº†ã€‚ func netpoll(delay int64) gList // æ£€æŸ¥è½®è¯¢å™¨æ˜¯å¦åˆå§‹åŒ–ã€‚\tif kq == -1 return gList // è®¾ç½®è½®è¯¢è¶…æ—¶ã€‚\tvar tp *timespec\tvar ts timespec\tif delay 0 tp = nil else if delay == 0 tp = ts else ts.setNsec(delay) if ts.tv_sec 1e6 ts.tv_sec = 1e6 tp = ts // ä½¿ç”¨ kevent è¿›è¡Œè½®è¯¢æ“ä½œï¼Œç»“æœæ”¾åœ¨ events ä¸­ã€‚\tvar events [64]keventtretry:\tn := kevent(kq, nil, 0, events[0], int32(len(events)), tp)\tif n 0 if n != -_EINTR println(runtime: kevent on fd, kq, failed with, -n) throw(runtime: netpoll failed) if delay 0 return gList goto retry // éå† events å¤„ç†è½®è¯¢äº‹ä»¶ã€‚\tvar toRun gList\tfor i := 0; i int(n); i++ ev := events[i] // netpollBreakRd ç”¨äºå”¤é†’è½®è¯¢ï¼Œå³å”¤é†’ç­‰å¾…ä¸­çš„ goroutineã€‚ if uintptr(ev.ident) == netpollBreakRd if ev.filter != _EVFILT_READ println(runtime: netpoll: break fd ready for, ev.filter) throw(runtime: netpoll: break fd ready for something unexpected) if delay != 0 var tmp [16]byte read(int32(netpollBreakRd), noescape(unsafe.Pointer(tmp[0])), int32(len(tmp))) netpollWakeSig.Store(0) continue // æ ¹æ®è½®è¯¢äº‹ä»¶çš„ç±»å‹ï¼ˆè¯»æˆ–å†™ï¼‰ï¼Œå”¤é†’ç›¸åº”ç­‰å¾…ç½‘ç»œ I/O çš„ groutineã€‚ var mode int32 switch ev.filter case _EVFILT_READ: mode += r if ev.flags_EV_EOF != 0 mode += w case _EVFILT_WRITE: mode += w if mode != 0 var pd *pollDesc var tag uintptr if goarch.PtrSize == 4 pd = (*pollDesc)(unsafe.Pointer(ev.udata)) tag = 0 else tp := taggedPointer(uintptr(unsafe.Pointer(ev.udata))) pd = (*pollDesc)(tp.pointer()) tag = tp.tag() if pd.fdseq.Load() != tag continue pd.setEventErr(ev.flags == _EV_ERROR, tag) // æ ‡è®° goroutine å¯æ‰§è¡Œã€‚ netpollready(toRun, pd, mode) // è¿”å›å¯è¿è¡Œçš„ goroutine åˆ—è¡¨ã€‚\treturn toRun 4.6 stealWork() stealWork() å‡½æ•°ç”¨äºå°è¯•ä»å…¶ä»–å¤„ç†å™¨ï¼ˆPï¼‰çªƒå–å¯è¿è¡Œçš„ goroutine æˆ–å®šæ—¶å™¨ã€‚ func stealWork(now int64) (gp *g, inheritTime bool, rnow, pollUntil int64, newWork bool) // è·å–å½“å‰ M ç»‘å®šçš„ Pã€‚\tpp := getg().m.p.ptr()\tranTimer := false // å°è¯• 4 æ¬¡ã€‚\tconst stealTries = 4\tfor i := 0; i stealTries; i++ // å‰ 3 æ¬¡å°è¯•çªƒå– gã€‚ // ç¬¬ 4 æ¬¡å°è¯•çªƒå– timerï¼Œå¹¶ä¸”å°è¯•è·å–å…¶ä»– P çš„ runnext ä¸­çš„ gã€‚ stealTimersOrRunNextG := i == stealTries-1 // éšæœºé€‰ä¸€ä¸ª Pã€‚ for enum := stealOrder.start(fastrand()); !enum.done(); enum.next() // å¦‚æœç³»ç»Ÿæ­£åœ¨ GCï¼Œåˆ™å¯ä»¥ç›´æ¥è¿”å› trueï¼Œå› ä¸ºå¯èƒ½è¦è´Ÿè´£ gc äº†ï¼Œæœ‰äº‹å¹²äº†ã€‚ if sched.gcwaiting.Load() return nil, false, now, pollUntil, true // è·å–é€‰ä¸­çš„ Pï¼Œå¦‚æœæ˜¯å½“å‰ P åˆ™ç›´æ¥ continueï¼Œé‡è¯•ã€‚ p2 := allp[enum.position()] if pp == p2 continue // ç¬¬ 4 æ¬¡å°è¯•å»çªƒå– p2 çš„ timerã€‚ if stealTimersOrRunNextG timerpMask.read(enum.position()) // æ£€æŸ¥å¹¶å¯èƒ½æ‰§è¡Œ timerã€‚ tnow, w, ran := checkTimers(p2, now) now = tnow if w != 0 (pollUntil == 0 || w pollUntil) pollUntil = w // å¦‚æœæ‰§è¡Œäº† timerï¼Œåˆ™æ£€æŸ¥æœ¬åœ°é˜Ÿåˆ—æ˜¯å¦æœ‰ g å¯ä»¥è¿è¡Œï¼Œ // å› ä¸º timer ä¼šå”¤é†’è¢«æŒ‚èµ·çš„ gã€‚ if ran if gp, inheritTime := runqget(pp); gp != nil return gp, inheritTime, now, pollUntil, ranTimer ranTimer = true // å‰ 3 æ¬¡å°è¯•æˆ–è€…ç¬¬ 4 æ¬¡å°è¯•æ²¡æœ‰çªƒå–åˆ° timer çš„æ—¶å€™ï¼Œ // å°±ä»å…¶ä»–éç©ºé—² P çš„æœ¬åœ°é˜Ÿåˆ—ä¸­å°è¯•çªƒå– gã€‚ if !idlepMask.read(enum.position()) // å¦‚æœ stealTimersOrRunNextG ä¸º trueï¼Œ // é‚£ä¹ˆä¼šåœ¨çªƒå–çš„æ—¶å€™ï¼Œå°è¯•çªƒå– p2 çš„ runnextã€‚ if gp := runqsteal(pp, p2, stealTimersOrRunNextG); gp != nil return gp, false, now, pollUntil, ranTimer return nil, false, now, pollUntil, ranTimer é˜…è¯»æºç çš„å¥½å¤„è¿™å°±ä½“ç°äº†ï¼Œæ‰€æœ‰äººéƒ½å‘Šè¯‰æˆ‘ä»¬ P æ‰¾ä¸åˆ°å¯è¿è¡Œ G çš„æ—¶å€™å°±ä¼šå»çªƒå–å…¶ä»– P çš„ Gï¼Œä½†æ²¡äººå‘Šè¯‰æˆ‘ä»¬ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹è¿˜å¯èƒ½ä¼šå»çªƒå–å…¶ä»– P çš„ timer å’Œ runnextã€‚ æ‰€è°“ timerï¼Œå³å®šæ—¶å™¨ï¼Œç”¨äºåœ¨æŒ‡å®šçš„æ—¶é—´åæ‰§è¡ŒæŸäº›æ“ä½œã€‚è¿™äº›æ“ä½œé€šå¸¸åŒ…æ‹¬å”¤é†’ç­‰å¾…ç‰¹å®šæ—¶é—´çš„ goroutineï¼Œæˆ–æ‰§è¡Œä¸æ—¶é—´ç›¸å…³çš„ä»»åŠ¡ã€‚å®šæ—¶å™¨åœ¨ Go çš„å¹¶å‘æ¨¡å‹ä¸­æ‰®æ¼”ç€é‡è¦çš„è§’è‰²ï¼Œç‰¹åˆ«æ˜¯åœ¨æ¶‰åŠåˆ°æ—¶é—´å»¶è¿Ÿæˆ–å‘¨æœŸæ€§ä»»åŠ¡çš„åœºæ™¯ä¸­ã€‚åœ¨è°ƒåº¦å™¨å±‚é¢ï¼Œå®šæ—¶å™¨çš„ç®¡ç†å¯¹äºç¡®ä¿åŠæ—¶å“åº”æ—¶é—´ç›¸å…³çš„äº‹ä»¶å’Œç»´æŒé«˜æ•ˆçš„è°ƒåº¦è‡³å…³é‡è¦ã€‚é€šè¿‡åˆç†åœ°å¤„ç†å®šæ—¶å™¨äº‹ä»¶ï¼ŒGo èƒ½å¤Ÿåœ¨ä¿æŒé«˜å¹¶å‘æ€§çš„åŒæ—¶ï¼Œæœ‰æ•ˆåœ°ç®¡ç†æ—¶é—´å»¶è¿Ÿå’Œå‘¨æœŸæ€§ä»»åŠ¡ã€‚ åœ¨ Go è¯­è¨€çš„è°ƒåº¦å™¨ä¸­ï¼Œè·¨ P çš„å®šæ—¶å™¨çªƒå–æ˜¯ä¸€ç§ä¼˜åŒ–æœºåˆ¶ï¼Œå®ƒæœ‰ 2 ä¸ªå¥½å¤„ï¼š ä¿æŒå¤„ç†å™¨æ´»è·ƒï¼šå½“ä¸€ä¸ª P æ²¡æœ‰è¶³å¤Ÿçš„æœ¬åœ°å·¥ä½œæ—¶ï¼Œå®ƒå¯ä»¥å°è¯•ä»å…¶ä»– P çªƒå–å®šæ—¶å™¨ä»»åŠ¡ã€‚è¿™æ ·åšå¯ä»¥ä¿æŒè¯¥ P æ´»è·ƒï¼Œé¿å…å®ƒè¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œä»è€Œæé«˜æ•´ä½“ç³»ç»Ÿçš„æ•ˆç‡ã€‚ å¹³è¡¡ç³»ç»Ÿè´Ÿè½½ï¼šåœ¨å¤šæ ¸ç³»ç»Ÿä¸­ï¼Œä¸åŒçš„ P å¯èƒ½ä¼šæœ‰ä¸åŒçš„è´Ÿè½½ã€‚è·¨ P çš„å®šæ—¶å™¨çªƒå–æœ‰åŠ©äºåœ¨ P ä¹‹é—´å¹³è¡¡è´Ÿè½½ï¼Œç‰¹åˆ«æ˜¯åœ¨ä¸€äº› P éå¸¸å¿™ç¢Œè€Œå…¶ä»– P ç›¸å¯¹ç©ºé—²çš„æƒ…å†µä¸‹ã€‚ å¥½çš„ï¼Œå›è¿‡å¤´æ¥ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬ä¼šè¯´çªƒå–çš„æ—¶å€™ä¼šä»é˜Ÿå¤´çªƒå–å‘¢ï¼Ÿä¸ºä»€ä¹ˆæ˜¯çªƒå– p2 ä¸€åŠçš„ g å‘¢ï¼Ÿè¿™ä¸ªè¿‡ç¨‹å°±åœ¨ runqsteal() ä¸­ï¼š func runqsteal(pp, p2 *p, stealRunNextG bool) *g t := pp.runqtail // ä» p2 ä¸­è·å– n ä¸ª gã€‚\tn := runqgrab(p2, pp.runq, t, stealRunNextG)\tif n == 0 return nil // è¿”å›ç¬¬ 1 ä¸ª gï¼Œå› ä¸ºå®ƒå¯ä»¥ç›´æ¥æ‰§è¡Œäº†ã€‚\tn--\tgp := pp.runq[(t+n)%uint32(len(pp.runq))].ptr()\tif n == 0 return gp // å¦‚æœè¿˜æœ‰å‰©ä¸‹çš„ gï¼Œé‚£ä¹ˆå°±åŠ å…¥åˆ°æœ¬åœ°é˜Ÿåˆ—ä¸­ã€‚ // è¿™é‡Œå¯ä»¥çœ‹åˆ°æ˜¯ä»é˜Ÿå¤´åŠ å…¥çš„ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨åŸå­æ“ä½œè·å–é˜Ÿå¤´ã€‚\th := atomic.LoadAcq(pp.runqhead)\tif t-h+n = uint32(len(pp.runq)) throw(runqsteal: runq overflow) atomic.StoreRel(pp.runqtail, t+n)\treturn gp runqgrab() æ˜¯çªƒå– n ä¸ª g çš„è¿‡ç¨‹ï¼š func runqgrab(pp *p, batch *[256]guintptr, batchHead uint32, stealRunNextG bool) uint32 // ä½¿ç”¨æ— é™å¾ªç¯æ¥å°è¯•çªƒå–å·¥ä½œï¼Œç›´åˆ°æˆåŠŸæˆ–ç¡®å®šæ²¡æœ‰å¯çªƒå–çš„å·¥ä½œã€‚\tfor h := atomic.LoadAcq(pp.runqhead) t := atomic.LoadAcq(pp.runqtail) n := t - h // è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œè¦çªƒå–çš„ä¸ªæ•°ï¼Œå°±æ˜¯ pp æœ¬åœ°é˜Ÿåˆ—ä¸­ g ä¸ªæ•°çš„ä¸€åŠ n = n - n/2 // å¦‚æœ n ä¸º 0ï¼Œä¸” stealRunNextG == trueï¼Œ // é‚£ä¹ˆå°±å°è¯•çªƒå– pp çš„ runnext ä¸­çš„ gã€‚ if n == 0 if stealRunNextG if next := pp.runnext; next != 0 if !pp.runnext.cas(next, 0) continue batch[batchHead%uint32(len(batch))] = next return 1 return 0 // å¦‚æœ n ä¸ä¸ºé˜Ÿåˆ—é•¿åº¦çš„ä¸€åŠï¼Œåˆ™è¯´æ˜é˜Ÿåˆ—å‘ç”Ÿäº†å˜åŒ–ï¼Œ // è¿™ä¸ªæ—¶å€™é‡æ–°å°è¯•çªƒå–ã€‚ if n uint32(len(pp.runq)/2) continue // å°†è¦çªƒå–çš„ g ä» pp.runq ä¸­è½¬ç§»åˆ° batch ä¸­ã€‚ for i := uint32(0); i n; i++ g := pp.runq[(h+i)%uint32(len(pp.runq))] batch[(batchHead+i)%uint32(len(batch))] = g // ä½¿ç”¨åŸå­æ“ä½œå°è¯•æ›´æ–° pp çš„é˜Ÿåˆ—å¤´éƒ¨ï¼Œå³å°† g ä» pp.runq ä¸­ç§»é™¤ã€‚ if atomic.CasRel(pp.runqhead, h, h+n) return n findRunnable() çš„å…¨éƒ¨è¿‡ç¨‹æˆ‘ä»¬æ€»ç®—æ˜¯æ¢³ç†å®Œäº†ï¼Œè¿™ä¸ªè¿‡ç¨‹ç¡®å®éå¸¸ç²¾å½©ï¼ŒGo è°ƒåº¦å™¨åœ¨æé«˜è°ƒåº¦æ€§èƒ½ã€ç¡®ä¿è°ƒåº¦çš„å…¬å¹³æ€§ã€å¹³è¡¡ç³»ç»Ÿè´Ÿè½½ã€é™ä½åŒæ­¥å¼€é”€ã€å‡å°‘èµ„æºå†åˆ†é…ç­‰æ–¹é¢éƒ½åšäº†å¾ˆå¤šçš„åŠªåŠ›ï¼Œè¿™æ‰è®© Go è¯­è¨€çš„å¹¶å‘åˆå¼ºå¤§åˆæ˜“ç”¨ã€‚ ä¸‹é¢æ˜¯å¯¹ findRunnable() ä¸€ä¸ªç®€å•çš„æ€»ç»“ï¼š findRunnable() 4.7 execute() findRunnable() ä¹‹åå°±æ˜¯ execute()ï¼Œå®ƒçš„æ ¸å¿ƒè¿‡ç¨‹å¦‚ä¸‹ï¼ˆæœ‰åˆ å‡ï¼‰ï¼š func execute(gp *g, inheritTime bool) mp := getg().m\t// å°† g0 d çº¿ç¨‹ä¿¡æ¯å¤åˆ¶åˆ°å³å°†è¦è°ƒç”¨çš„åç¨‹ gp ä¸­ã€‚\tmp.curg = gp\tgp.m = mp // ä¿®æ”¹ gp çš„çŠ¶æ€ä¸º _Grunningï¼Œå³è¿è¡Œä¸­ã€‚\tcasgstatus(gp, _Grunnable, _Grunning)\tgp.waitsince = 0 // æ ‡è®°ä¸ºéæŠ¢å \tgp.preempt = false // ç”¨äºæ ˆä¿æŠ¤ï¼Œæ£€æµ‹æ ˆæº¢å‡º\tgp.stackguard0 = gp.stack.lo + stackGuard // gogo ä¼šå®Œæˆ g0 åˆ° g çš„åç¨‹æ ˆçš„åˆ‡æ¢ï¼Œå¹¶ä» gp.sched å¼€å§‹æ‰§è¡Œã€‚ // sched å­—æ®µæˆ‘ä»¬å‰é¢ä»‹ç»è¿‡ï¼Œå®ƒæ˜¯ gobuf ç»“æ„ä½“ï¼Œå­˜å‚¨äº† sp å’Œ pcã€‚\tgogo(gp.sched) æ‰€ä»¥ execute() çš„å·¥ä½œéå¸¸ç®€å•ï¼Œå…¶å®å°±æ˜¯å°† g0 çš„çº¿ç¨‹ä¿¡æ¯å¤åˆ¶åˆ° gp ä¸Šï¼Œå¹¶ä¿®æ”¹çŠ¶æ€å’Œä¸€äº›å…ƒæ•°æ®ï¼Œæ ¸å¿ƒéƒ¨åˆ†å…¶å®åœ¨ gogo() ä¸­ã€‚ 4.8 gogo() å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼Œgogo() ä¼šå®Œæˆ g0 æ ˆåˆ° g æ ˆçš„åˆ‡æ¢ï¼Œä¸”åœ¨ä¸åŒå¹³å°ä¸‹æœ‰ä¸åŒçš„è§†çº¿ï¼Œè¿™é‡Œæˆ‘ä»¬ä»¥ asm_arm64.s ä¸ºä»£è¡¨æ¥çœ‹ä¸€ä¸‹ gogo() çš„æ±‡ç¼–å®ç°ï¼š TEXT runtimeÂ·gogo(SB), NOSPLIT|NOFRAME, $0-8\tMOVD\tbuf+0(FP), R5\tMOVD\tgobuf_g(R5), R6\tMOVD\t0(R6), R4\t// make sure g != nil\tB\tgogo(SB)TEXT gogo(SB), NOSPLIT|NOFRAME, $0\tMOVD\tR6, g\tBL\truntimeÂ·save_g(SB)\tMOVD\tgobuf_sp(R5), R0\tMOVD\tR0, RSP\tMOVD\tgobuf_bp(R5), R29\tMOVD\tgobuf_lr(R5), LR\tMOVD\tgobuf_ret(R5), R0\tMOVD\tgobuf_ctxt(R5), R26\tMOVD\t$0, gobuf_sp(R5)\tMOVD\t$0, gobuf_bp(R5)\tMOVD\t$0, gobuf_ret(R5)\tMOVD\t$0, gobuf_lr(R5)\tMOVD\t$0, gobuf_ctxt(R5)\tCMP\tZR, ZR // set condition codes for == test, needed by stack split\tMOVD\tgobuf_pc(R5), R6\tB\t(R6) å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š runtimeÂ·gogo å‡½æ•°ï¼šè¿™ä¸ªå‡½æ•°ç”¨äºè®¾ç½®æ–°çš„ goroutine ä¸Šä¸‹æ–‡ã€‚å®ƒæ¥æ”¶ä¸€ä¸ªæŒ‡å‘ gobuf ç»“æ„çš„æŒ‡é’ˆï¼ˆbuf+0(FP)ï¼‰ï¼Œè¯¥ç»“æ„åŒ…å«äº† goroutine çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚ åŠ è½½ gobuf å¹¶æ£€æŸ¥ gï¼šåŠ è½½ gobuf ç»“æ„ï¼Œå¹¶æ£€æŸ¥ g æ˜¯å¦ä¸º nilã€‚ è·³è½¬åˆ° gogoï¼šæ‰§è¡Œæ— æ¡ä»¶è·³è½¬åˆ° gogo å‡½æ•°ã€‚ gogo å‡½æ•°ï¼šè¿™ä¸ªå‡½æ•°å®é™…ä¸Šå®Œæˆäº†ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚ è®¾ç½®å½“å‰ goroutineï¼šå°† R6 å¯„å­˜å™¨ä¸­çš„å€¼ï¼ˆæ–°çš„ goroutineï¼‰è®¾ç½®ä¸ºå½“å‰ goroutineã€‚ ä¿å­˜å½“å‰ goroutineï¼šè°ƒç”¨ runtimeÂ·save_g ä¿å­˜å½“å‰ goroutine çš„çŠ¶æ€ã€‚ æ¢å¤æ ˆæŒ‡é’ˆå’Œå…¶ä»–å¯„å­˜å™¨ï¼šä» gobuf ç»“æ„ä¸­æ¢å¤æ ˆæŒ‡é’ˆï¼ˆRSPï¼‰ã€åŸºæŒ‡é’ˆï¼ˆR29ï¼‰ã€é“¾æ¥å¯„å­˜å™¨ï¼ˆLRï¼‰ã€è¿”å›å€¼ï¼ˆR0ï¼‰å’Œä¸Šä¸‹æ–‡ï¼ˆR26ï¼‰ã€‚ æ¸…ç©º gobuf ç»“æ„ï¼šå°† gobuf ç»“æ„ä¸­çš„å­—æ®µæ¸…é›¶ã€‚ å‡†å¤‡è·³è½¬åˆ°æ–°çš„ç¨‹åºè®¡æ•°å™¨ä½ç½®ï¼šä» gobuf ä¸­åŠ è½½æ–°çš„ç¨‹åºè®¡æ•°å™¨åœ°å€ï¼ˆgobuf_pc(R5)ï¼‰åˆ° R6ã€‚ è·³è½¬æ‰§è¡Œï¼šé€šè¿‡ B (R6) è·³è½¬åˆ°æ–°çš„ç¨‹åºè®¡æ•°å™¨åœ°å€ï¼Œç»§ç»­æ‰§è¡Œæ–° goroutine çš„ä»£ç ã€‚ è¿™æ®µæ±‡ç¼–ä»£ç æ˜¯ Go è¿è¡Œæ—¶ä¸­å¤„ç† goroutine ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å…³é”®éƒ¨åˆ†ã€‚å®ƒç›´æ¥æ“ä½œå¤„ç†å™¨çš„å¯„å­˜å™¨å’Œæ ˆï¼Œä»¥å®ç°ä»ä¸€ä¸ª goroutine åˆ‡æ¢åˆ°å¦ä¸€ä¸ª goroutine çš„åŠŸèƒ½ã€‚ åœ¨ execute() ä¸­æ˜¯è¿™ä¹ˆè°ƒç”¨ gogo() çš„ï¼š gogo(gp.sched) æ‰€ä»¥å®Œæˆæ ˆçš„åˆ‡æ¢åä¼šä» gp.sched å¼€å§‹ï¼Œæ‰§è¡Œä»£ç ï¼Œå‰é¢æˆ‘ä»¬ä»‹ç»è¿‡ sched æ˜¯ä¸€ä¸ª gobuf ç»“æ„ä½“ï¼š type gobuf struct sp uintptr\tpc uintptr\tg guintptr\tctxt unsafe.Pointer\tret uintptr\tlr uintptr\tbp uintptr æ‰€ä»¥ä¼šä» pc å¤„å¼€å§‹æ‰§è¡Œä¸šåŠ¡ä»£ç ï¼Œå‰é¢åœ¨ newproc() çš„æ—¶å€™ï¼Œæˆ‘ä»¬æè¿‡ä¸€è¡Œä»£ç ï¼š newg.sched.pc = abi.FuncPCABI0(goexit) + sys.PCQuantum è¿™è¡Œä»£ç çš„ä½œç”¨ï¼Œæ˜¯åœ¨åç¨‹åˆ›å»ºçš„æ—¶å€™æ’å…¥ä¸€ä¸ª goexit å‡½æ•°çš„åœ°å€ï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™ g åˆšåˆ›å»ºï¼Œæ‰€ä»¥å…¶å®å°±æ˜¯å¾€åç¨‹æ ˆé¡¶æ’å…¥äº† goexit çš„åœ°å€ã€‚æ‰€ä»¥å½“ g æ‰§è¡Œå®Œä¸šåŠ¡ä»£ç åï¼Œå½“æ ˆä¸­å…ƒç´ ä¸æ–­å¼¹å‡ºåï¼Œæœ€ç»ˆå°±ä¼šå¼¹å‡º goexit çš„åœ°å€ï¼Œç„¶åæ‰§è¡Œ goexit() å‡½æ•°ï¼Œé€€å‡ºå½“å‰ gï¼Œåˆ‡æ¢å› g0ã€‚ 4.9 goexit() goexit å®šä¹‰åœ¨ runtime/stubs.go ä¸­ï¼š // goexit is the return stub at the top of every goroutine call stack.// Each goroutine stack is constructed as if goexit called the// goroutines entry point function, so that when the entry point// function returns, it will return to goexit, which will call goexit1// to perform the actual exit.//// This function must never be called directly. Call goexit1 instead.// gentraceback assumes that goexit terminates the stack. A direct// call on the stack will cause gentraceback to stop walking the stack// prematurely and if there is leftover state it may panic.func goexit(neverCallThisFunction) é€šè¿‡æ³¨é‡Šæˆ‘ä»¬å¯ä»¥å¾—åˆ° 2 ä¸ªä¿¡æ¯ï¼š goexit çš„ä½äºæ¯ä¸ª goroutine è°ƒç”¨æ ˆçš„é¡¶éƒ¨ã€‚æ¯ä¸ª goroutine çš„æ ˆè¢«æ„é€ å¾—å¥½åƒ goexit è°ƒç”¨äº† goroutine çš„å…¥å£å‡½æ•°ã€‚è¿™æ„å‘³ç€å½“å…¥å£å‡½æ•°è¿”å›æ—¶ï¼Œå®ƒå®é™…ä¸Šè¿”å›åˆ° goexitã€‚ ä¸è¦ç›´æ¥è°ƒç”¨ goexitï¼Œåº”è¯¥è°ƒç”¨ goexit1ã€‚ goexit1 ä½äº runtime/proc.go ä¸­ï¼š // Finishes execution of the current goroutine.func goexit1() if raceenabled racegoend() if traceEnabled() traceGoEnd() mcall(goexit0) å¥½å§ï¼Œå®ƒè°ƒç”¨äº† goexit0ï¼ŒåŸæ¥è¿™æ‰æ˜¯çœŸæ­£çš„é€€å‡ºå…¥å£ï¼Œå®ƒä¹Ÿä½äº runtime/proc.go ä¸­ï¼š func goexit0(gp *g) // è·å–å½“å‰çš„ M å’Œ P\tmp := getg().m\tpp := mp.p.ptr() // ä¿®æ”¹ gp çš„çŠ¶æ€ä¸º _Gdeadï¼Œæ ‡å¿—å®ƒçš„ç»ˆæ­¢\tcasgstatus(gp, _Grunning, _Gdead) // æ ‡è®° gc çš„æ ˆå†…å­˜æ˜¯å¯ä»¥è¿›è¡Œ gc æ‰«æçš„\tgcController.addScannableStack(pp, -int64(gp.stack.hi-gp.stack.lo))\t// å¦‚æœ gp æ˜¯ç³»ç»Ÿ goroutineï¼Œåˆ™å°†ç³»ç»Ÿ goroutine çš„è®¡æ•°å‡å°‘ if isSystemGoroutine(gp, false) sched.ngsys.Add(-1) // æ¸…ç† gp çš„çŠ¶æ€\tgp.m = nil\tlocked := gp.lockedm != 0\tgp.lockedm = 0\tmp.lockedg = 0\tgp.preemptStop = false\tgp.paniconfault = false\tgp._defer = nil gp._panic = nil\tgp.writebuf = nil\tgp.waitreason = waitReasonZero\tgp.param = nil\tgp.labels = nil\tgp.timer = nil // å¦‚æœå¯ç”¨äº†åƒåœ¾å›æ”¶ï¼ˆGCï¼‰å¹¶ä¸” gp.gcAssistBytes å¤§äº 0ï¼Œ // åˆ™å°†è¾…åŠ©ä¿¡ç”¨å½’è¿˜ç»™å…¨å±€æ± ã€‚è¿™æœ‰åŠ©äºæ›´å¥½åœ°æ§åˆ¶åƒåœ¾å›æ”¶è¿›ç¨‹ã€‚\tif gcBlackenEnabled != 0 gp.gcAssistBytes 0 assistWorkPerByte := gcController.assistWorkPerByte.Load() scanCredit := int64(assistWorkPerByte * float64(gp.gcAssistBytes)) gcController.bgScanCredit.Add(scanCredit) gp.gcAssistBytes = 0 // å°†å½“å‰ g ä» P çš„è¿è¡Œé˜Ÿåˆ—ä¸­ç§»é™¤\tdropg() // WebAssembly å¹³å°ç‰¹æ®Šå¤„ç†\tif GOARCH == wasm gfput(pp, gp) schedule() // å°† gp æ”¾å›å¤„ç†å™¨çš„å¯ç”¨é˜Ÿåˆ—ä¸­ï¼Œè¿™æ ·å¯ä»¥å¤ç”¨ g\tgfput(pp, gp) // å¦‚æœ goroutine è¢«ç»‘å®šåˆ°å½“å‰çº¿ç¨‹ä¸Šï¼Œ // é‚£å¯èƒ½æ˜¯åœ¨åšç³»ç»Ÿè°ƒç”¨ï¼Œcgo è°ƒç”¨æˆ–å…¶ä»–ç‰¹æ®Šä»»åŠ¡ï¼Œ // é‚£ä¹ˆå°±éœ€è¦åˆ‡åˆ° g0ï¼Œè®© g0 æ¥å®Œæˆåé¢çš„è°ƒåº¦ã€‚ if locked // å¦‚æœ goroutine åœ¨ç»ˆæ­¢å‰æ›¾é”å®šå½“å‰çº¿ç¨‹ï¼Œ // åˆ™æ ¹æ®ä¸åŒçš„æ“ä½œç³»ç»Ÿæ‰§è¡Œä¸åŒçš„å¤„ç†ã€‚ // åœ¨å¤§å¤šæ•°æ“ä½œç³»ç»Ÿä¸Šï¼Œä¼šè·³è½¬åˆ° mstart å‡½æ•°ï¼Œé‡Šæ”¾ P å¹¶é€€å‡ºçº¿ç¨‹ã€‚ // ä½†åœ¨ Plan 9 æ“ä½œç³»ç»Ÿä¸Šï¼Œä¼šæ¸…é™¤ lockedExtã€‚ if GOOS != plan9 // See golang.org/issue/22227. gogo(mp.g0.sched) else mp.lockedExt = 0 // ç»§ç»­è°ƒåº¦ // å¦‚æœæ‰§è¡Œäº† gogoï¼Œé‚£å°±æ˜¯ g0 åœ¨è°ƒåº¦ã€‚ // å¦‚æœæ²¡æœ‰æ‰§è¡Œ gogoï¼Œé‚£å°±æ˜¯ gp åœ¨è°ƒåº¦ã€‚\tschedule() åˆ°è¿™é‡Œæˆ‘ä»¬å°±å®Œæˆäº†å¯¹ GPM è°ƒåº¦å¾ªç¯çš„å…¨è¿‡ç¨‹æºç åˆ†æäº†ï¼Œä½ å¯ä»¥å›åˆ° 4. è°ƒåº¦è¿‡ç¨‹ schedule() çœ‹ä¸€ä¸‹æˆ‘æ€»ç»“çš„é‚£å¼ å›¾ï¼Œè¿™å›ä½ åº”è¯¥ä¼šæœ‰æ›´åŠ æ·±å…¥çš„ç†è§£äº†ã€‚ 5. åç¨‹åˆ‡æ¢ å¦‚æœè¦ä¸€ä¸ªåç¨‹è¦ä¸€ç›´åˆ°æ‰§è¡Œå®Œæ¯•æ‰é€€å‡ºçš„è¯ï¼Œé‚£å¾ˆå¯èƒ½ä¼šé€ æˆå…¶ä»–åç¨‹é¥¥é¥¿çš„é—®é¢˜ã€‚æ‰€ä»¥ Go å…¶å®ä¼šåœ¨ä¸€äº›ç‰¹æ®Šçš„æ—¶æœºå¯¹åç¨‹è¿›è¡Œåˆ‡æ¢ï¼Œè¿™ä¸ªè¿‡ç¨‹æœ‰æŠ¢å å¼è°ƒåº¦ï¼Œä¹Ÿæœ‰åä½œå¼çš„è°ƒåº¦ã€‚ åç¨‹åˆ‡æ¢çš„æ—¶å€™ï¼Œæœ€æ ¸å¿ƒçš„å°±æ˜¯è¦ä¿å­˜å½“å‰åç¨‹çš„ç°åœºï¼Œä»¥æ–¹ä¾¿å›åˆ°è¯¥åç¨‹çš„æ—¶å€™ç»§ç»­æ‰§è¡Œå‰©ä¸‹çš„å†…å®¹ã€‚å¤§è‡´è¿‡ç¨‹å¦‚ä¸‹ï¼š Go åç¨‹åˆ‡æ¢ æœ‰å“ªäº›æ—¶æœºä¼šè§¦å‘åˆ‡æ¢å‘¢ï¼Œè¿™é‡Œæˆ‘ç›´æ¥ç»™å‡ºç»“è®ºï¼š åŸºäºåä½œçš„æŠ¢å å¼è°ƒåº¦ ä¸»åŠ¨æŒ‚èµ·ï¼šruntime.gopark() ç³»ç»Ÿè°ƒç”¨ç»“æŸæ—¶ï¼šexitsyscall() å‡½æ•°è·³è½¬æ—¶ï¼šmorestack() åŸºäºä¿¡å·çš„æŠ¢å å¼è°ƒåº¦ ä¿¡å·è°ƒåº¦ï¼šdoSigPreempt() 5.1 ä¸»åŠ¨æŒ‚èµ· runtime.gopack() gopack åç¨‹åˆ‡æ¢ è¿™ä¸ªå‡½æ•°ä½äº runtime/proc.go ä¸­ï¼š func gopark(unlockf func(*g, unsafe.Pointer) bool, lock unsafe.Pointer, reason waitReason, traceReason traceBlockReason, traceskip int) if reason != waitReasonSleep checkTimeouts() mp := acquirem()\tgp := mp.curg\tstatus := readgstatus(gp)\tif status != _Grunning status != _Gscanrunning throw(gopark: bad g status) mp.waitlock = lock\tmp.waitunlockf = unlockf\tgp.waitreason = reason\tmp.waitTraceBlockReason = traceReason\tmp.waitTraceSkip = traceskip\treleasem(mp)\tmcall(park_m) gopark å‡½æ•°çš„ä¸»è¦ç›®çš„æ˜¯ä½¿ G è¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œç­‰å¾…è¢«å”¤é†’ã€‚ æœ€åå®ƒè°ƒç”¨äº† mcall()ï¼š // mcall switches from the g to the g0 stack and invokes fn(g)// mcall åˆ‡æ¢åˆ° g0ï¼Œå¹¶æ‰§è¡Œ fnã€‚func mcall(fn func(*g)) æ‰€ä»¥è¿™é‡Œåˆ‡æ¢å› g0ï¼Œå¹¶æ‰§è¡Œäº† pack_mï¼š func park_m(gp *g) ...\tschedule() pack_m() å…¶å®å°±æ˜¯è°ƒç”¨äº† schedule() å»è¿›è¡Œä¸‹ä¸€è½®è°ƒåº¦ï¼Œè¿™å°±å®Œæˆäº†åç¨‹çš„åˆ‡æ¢ã€‚ å½“åç¨‹è¢«é˜»å¡çš„æ—¶å€™ï¼Œå°±ä¼šå»è°ƒç”¨ runtime.gopark() ä¸»åŠ¨è®©å‡º CPUï¼Œåˆ‡å› g0ï¼Œç­‰å¾…è¢«å”¤é†’ï¼Œä»¥æ­¤ä¿è¯æœ€å¤§åŒ–åˆ©ç”¨ CPU èµ„æºã€‚æ¯”å¦‚ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š ä¼‘çœ  channel é€šé“é˜»å¡ ç½‘ç»œ I/O é˜»å¡ å› ä¸ºæ‰§è¡Œåƒåœ¾å›æ”¶è€Œæš‚åœ 5.2 ç³»ç»Ÿè°ƒç”¨ç»“æŸæ—¶ exitsyscall() exitsyscall åç¨‹åˆ‡æ¢ Go é€šè¿‡ entersyscall() è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œå®Œäº‹åä¼šæ‰§è¡Œ exitsyscall()ï¼Œå®ƒä¹Ÿä½äº runtime/proc.go ä¸­ï¼š func exitsyscall() ...\tmcall(exitsyscall0) å…¶å®å®ƒæœ€ç»ˆä¹Ÿæ˜¯è°ƒç”¨ mcall() åˆ‡æ¢åˆ° g0ï¼Œ æˆ‘ä»¬ä¸éš¾çŒœå‡ºï¼Œå®ƒè¿™é‡Œè®© g0 å»æ‰§è¡Œ exitsyscall0 å‡½æ•°ï¼Œåšå®Œç³»ç»Ÿè°ƒç”¨çš„å–„ååï¼Œè‚¯å®šè¿˜æ˜¯ä¼šæ‰§è¡Œ schedule() å‡½æ•°è¿›è¡Œåç¨‹è°ƒåº¦ã€‚ func exitsyscall0(gp *g) ...\tschedule() 5.3 å‡½æ•°è·³è½¬æ—¶ morestack() morestack åç¨‹åˆ‡æ¢ å› ä¸ºå‡½æ•°è·³è½¬æ„å‘³ç€â€œå‹æ ˆâ€ï¼Œå‡½æ•°è·³è½¬æ—¶éƒ½ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œå®ƒçš„æœ¬æ„åœ¨äºæ£€æŸ¥å½“å‰åç¨‹æ ˆç©ºé—´æ˜¯å¦æœ‰è¶³å¤Ÿå†…å­˜ï¼Œå¦‚æœä¸å¤Ÿå°±è¦æ‰©å¤§è¯¥æ ˆç©ºé—´ã€‚ ä¸ºäº†è®©æ¯ä¸ªåç¨‹éƒ½æœ‰æ‰§è¡Œçš„æœºä¼šï¼Œå¹¶ä¸”æœ€å¤§åŒ–åˆ©ç”¨ CPU èµ„æºï¼ŒGo è¯­è¨€åœ¨åˆå§‹åŒ–æ—¶ä¼šå¯åŠ¨ä¸€ä¸ªç‰¹æ®Šçš„çº¿ç¨‹æ¥æ‰§è¡Œç³»ç»Ÿç›‘æ§ä»»åŠ¡ï¼Œç³»ç»Ÿç›‘æ§åœ¨ä¸€ä¸ªç‹¬ç«‹çš„ M ä¸Šè¿è¡Œï¼Œä¸ç”¨ç»‘å®šé€»è¾‘å¤„ç†å™¨ Pã€‚å½“ç³»ç»Ÿç›‘æ§åˆ°åç¨‹è¿è¡Œè¶…è¿‡ 10msï¼Œå°±å°† g.stackguard0 ç½®ä¸º stackPreemptï¼ˆè¯¥å€¼æ˜¯ä¸€ä¸ªæŠ¢å æ ‡å¿—ï¼‰ã€‚ const forcePreemptNS = 10 * 1000 * 1000 // 10msfunc retake(now int64) uint32 // éå†æ‰€æœ‰çš„ P\tfor i := 0; i len(allp); i++ pp := allp[i] pd := pp.sysmontick s := pp.status sysretake := false if s == _Prunning || s == _Psyscall t := int64(pp.schedtick) if int64(pd.schedtick) != t pd.schedtick = uint32(t) pd.schedwhen = now else if pd.schedwhen+forcePreemptNS = now // å¦‚æœ G è¿è¡Œæ—¶é—´è¿‡é•¿ï¼Œè¶…è¿‡äº† forcePreemptNS(10ms)ï¼Œ // åˆ™æ ‡è®°æŠ¢å  preemptone(pp) sysretake = true if s == _Psyscall // å¦‚æœæ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œä¸”å·²ç»è¶…è¿‡äº†ä¸€ä¸ªç³»ç»Ÿç›‘æ§çš„ tick(20us)ï¼Œ // åˆ™ä»ç³»ç»Ÿè°ƒç”¨ä¸­æŠ¢å  pã€‚ t := int64(pp.syscalltick) if !sysretake int64(pd.syscalltick) != t pd.syscalltick = uint32(t) pd.syscallwhen = now continue ... // æ ‡è®°æŠ¢å func preemptone(pp *p) bool mp := pp.m.ptr()\tgp := mp.curg\tgp.preempt = true\tgp.stackguard0 = stackPreempt\treturn true å·§çš„å°±æ˜¯ï¼ŒGo è®¾è®¡è€…ï¼Œè®©ç¨‹åºåœ¨æ‰§è¡Œ morestack() å‡½æ•°æ—¶é¡ºä¾¿åˆ¤æ–­ä¸€ä¸‹ g ä¸­çš„ stackguard æ˜¯å¦å·²ç»è¢«ç½®ä¸ºæŠ¢å  stackPreemptï¼Œå¦‚æœçš„ç¡®è¢«æ ‡è®°æŠ¢å ï¼Œå°±å›åˆ° schedule() æ–¹æ³•ï¼Œå¹¶å°†å½“å‰åç¨‹æ”¾å›é˜Ÿåˆ—ä¸­ã€‚ morestack æ˜¯æ±‡ç¼–å®ç°ï¼š TEXT runtimeÂ·morestack(SB),NOSPLIT|NOFRAME,$0-0\t...\tBL\truntimeÂ·newstack(SB) å®ƒæœ€ç»ˆä¼šè°ƒç”¨ newstack()ï¼š func newstack() thisg := getg() gp := thisg.m.curg // 1. åˆ¤æ–­ gp.stackguard0 æ˜¯å¦è¢«æ ‡è®°ä¸ºæŠ¢å  stackguard0 := atomic.Loaduintptr(gp.stackguard0)\tpreempt := stackguard0 == stackPreempt // 2. å¦‚æœè¢«æ ‡è®°ä½æŠ¢å ï¼Œè°ƒç”¨ gopreempt_m() if preempt // 3. æœ€ç»ˆä¼šå»è°ƒç”¨ schedule() å»è°ƒæ–°çš„åç¨‹æ‰§è¡Œ gopreempt_m(gp) // never return\tfunc gopreempt_m(gp *g) if traceEnabled() traceGoPreempt() goschedImpl(gp)func goschedImpl(gp *g) ...\tschedule() 5.4 ä¿¡å·è°ƒåº¦ doSigPreempt() å½“ç¨‹åºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ—¢æ— æ³•ä¸»åŠ¨æŒ‚èµ·ï¼Œä¹Ÿä¸èƒ½è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œä¸”æ— æ³•è¿›è¡Œå‡½æ•°è°ƒç”¨æ—¶ï¼Œå°±å¯ä»¥ä½¿ç”¨ä¿¡å·æ¥è°ƒåº¦ã€‚ ä¿¡å·å…¶å®å°±æ˜¯çº¿ç¨‹ä¿¡å·ï¼Œåœ¨æ“ä½œç³»ç»Ÿä¸­æœ‰å¾ˆå¤šåŸºäºä¿¡å·çš„åº•å±‚é€šä¿¡æ–¹å¼ï¼ˆSIGPIPE / SIGURG / SIGHUPï¼‰ï¼Œè€Œæˆ‘ä»¬çš„çº¿ç¨‹å¯ä»¥æ³¨å†Œå¯¹åº”ä¿¡å·çš„å¤„ç†å‡½æ•°ã€‚ Go ä¸­æ˜¯æ³¨å†Œäº† SIGURG ä¿¡å·çš„å¤„ç†å‡½æ•° doSigPreempt()ï¼Œåœ¨ GC å·¥ä½œæ—¶ï¼Œå‘ç›®æ ‡çº¿ç¨‹å‘é€ä¿¡å·ã€‚çº¿ç¨‹æ”¶åˆ°ä¿¡å·åï¼Œä¼šè§¦å‘è°ƒåº¦ã€‚ doSigPreempt åç¨‹åˆ‡æ¢ doSigPreempt ä½äº runtime.signal_unix.go ä¸­ï¼š func doSigPreempt(gp *g, ctxt *sigctxt) // æ£€æŸ¥æ­¤ g æ˜¯å¦è¦è¢«æŠ¢å å¹¶ä¸”å®‰å…¨æŠ¢å \tif wantAsyncPreempt(gp) if ok, newpc := isAsyncSafePoint(gp, ctxt.sigpc(), ctxt.sigsp(), ctxt.siglr()); ok // 2. è°ƒæ•´ç¨‹åºè®¡æ•°å™¨ PC å¹¶å¼‚æ­¥è°ƒç”¨ asyncPreempt ctxt.pushCall(abi.FuncPCABI0(asyncPreempt), newpc) å…¶ä¸­ asyncPreempt çš„å®ç°å¦‚ä¸‹ï¼š func asyncPreempt()// func asyncPreempt2() gp := getg()\tgp.asyncSafePoint = true // if gp.preemptStop mcall(preemptPark) else mcall(gopreempt_m) gp.asyncSafePoint = false asyncPreempt æ˜¯æ±‡ç¼–å®ç°ï¼Œæœ€ç»ˆæ˜¯è°ƒçš„ asyncPreempt2ï¼Œå®ƒä¼šè°ƒç”¨ mcall åˆ‡å› g0ï¼Œå¹¶æ‰§è¡Œ preemptPark æˆ– gopreempt_mï¼Œ gopreempt_m å°±æ˜¯å‰é¢ morestack æœ€åè°ƒçš„ï¼ä¸å‡ºæ„å¤–ï¼ŒpreemptPack æœ€åè‚¯å®šè¿˜æ˜¯è°ƒçš„ schedule()ã€‚ func preemptPark(gp *g) ...\tschedule() 5.5 runtime.Gosched() åœ¨æˆ‘ä»¬å®é™…ç¼–ç¨‹ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡æ˜¾å¼è°ƒç”¨ runtime.Gosched() æ¥ä¸»åŠ¨è®©å‡º CPUï¼Œä¿ƒè¿› Go çš„ä¸‹ä¸€è½®è°ƒåº¦ï¼Œæˆ‘ä»¬æ¥çœ‹å®ƒçš„å…·ä½“å®ç°ï¼Œè‚¯å®šè¿˜æ˜¯è°ƒçš„ schedule()ï¼Œæ²¡æœ‰æ„å¤–ï¼ func Gosched() checkTimeouts()\tmcall(gosched_m)func gosched_m(gp *g) if traceEnabled() traceGoSched() goschedImpl(gp)func goschedImpl(gp *g) status := readgstatus(gp)\tif status^_Gscan != _Grunning dumpgstatus(gp) throw(bad g status) casgstatus(gp, _Grunning, _Grunnable)\tdropg()\tlock(sched.lock)\tglobrunqput(gp)\tunlock(sched.lock)\tschedule() 5.6 æ€»ç»“ Go è¯­è¨€ä¸ºäº†ç¡®ä¿ P ä¸ä¼šå› ä¸º G è¿è¡Œæ—¶é—´è¿‡é•¿æˆ–ç³»ç»Ÿè°ƒç”¨é˜»å¡æ—¶é—´è¿‡é•¿è€Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚å®ƒä¼šå°è¯•è¿›è¡Œåç¨‹åˆ‡æ¢ï¼Œä»¥ç¡®ä¿ä»»åŠ¡å¯ä»¥é€‚æ—¶åœ°è¢«åˆ†é…å’Œæ‰§è¡Œã€‚è¿™æœ‰åŠ©äºä¿æŒGoç¨‹åºçš„å¹¶å‘æ€§èƒ½å’Œå“åº”æ€§ã€‚è€Œåç¨‹åˆ‡æ¢çš„æ–¹å¼æœ‰åŸºäºåä½œçš„æŠ¢å å¼è°ƒåº¦ï¼ˆä¸»åŠ¨æŒ‚èµ· runtime.gopark()ï¼Œç³»ç»Ÿè°ƒç”¨ç»“æŸæ—¶exitsyscall()ï¼Œå‡½æ•°è·³è½¬æ—¶ morestack()ï¼‰ï¼Œä¹Ÿæœ‰åŸºäºä¿¡å·çš„æŠ¢å å¼è°ƒåº¦ doSigPreempt()ï¼Œä»–ä»¬éƒ½æ— ä¸€ä¾‹å¤–çš„æœ€ç»ˆè°ƒç”¨äº† schedule()ã€‚ æ‰€ä»¥æ€»ç»“ä¸‹æ¥å…¶å®è¿˜æ˜¯è¿™å¼ å›¾ï¼š Go åç¨‹åˆ‡æ¢ Gã€Pã€M çŠ¶æ€æµè½¬ ç»è¿‡æˆ‘ä»¬å‰é¢çš„åˆ†æï¼Œä½ å¯ä»¥è‡ªè¡Œæ•´ç† Gã€Pã€M çŠ¶æ€çš„æµè½¬ï¼Œè¿™é‡Œæˆ‘ç»™å‡ºå‡ å¼ å›¾ä¾›ä½ å‚è€ƒï¼š Go åç¨‹ï¼ˆGï¼‰çŠ¶æ€è½¬æ¢å›¾ Go å¤„ç†å™¨ï¼ˆPï¼‰çŠ¶æ€è½¬æ¢å›¾ Go Mï¼ˆæ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼‰çŠ¶æ€è½¬æ¢ æ€»ç»“ ä»¥ä¸Šä¾¿æ˜¯å¯¹ Go è¯­è¨€ GPM æ¨¡å‹çš„å…¨éƒ¨åˆ†äº«å•¦ï¼GPM æ¨¡å‹ä½¿å¾— Go è¯­è¨€èƒ½å¤Ÿå¹¶å‘æ‰§è¡Œæˆåƒä¸Šä¸‡ä¸ªåç¨‹ã€‚ ä¸ºäº†å‡å°‘çº¿ç¨‹â€œç›¸å¯¹æ˜‚è´µâ€çš„åˆ‡æ¢ä»£ä»·ï¼ŒGo å¼•å…¥äº† GPMï¼Œå°†å¤§é‡çš„ Goroutine åˆ†é…åˆ°å°‘é‡çš„ç³»ç»Ÿçº¿ç¨‹ä¸Šå»æ‰§è¡Œï¼Œå¹¶åˆ©ç”¨å¤šæ ¸å¹¶è¡Œï¼Œå®ç°æ›´å¼ºå¤§çš„å¹¶å‘ã€‚ ä¸ºäº†å‡å°å¹¶å‘å†²çªï¼ŒGo åœ¨å…¨å±€é˜Ÿåˆ—çš„åŸºç¡€ä¸Šå¼•å…¥äº†æœ¬åœ°é˜Ÿåˆ—ã€‚ ä¸ºäº†é¿å…åç¨‹é¥¥é¥¿ï¼ŒGo åˆå¼•å…¥äº†å¤šç§åç¨‹è°ƒåº¦çš„ç­–ç•¥ã€‚ ä¸ºäº†é¿å…åç¨‹é˜»å¡æµªè´¹ CPUï¼ŒGo å¼•å…¥äº†å¤šç§åç¨‹åˆ‡æ¢çš„æ–¹å¼ã€‚ Go è¯­è¨€è®¾è®¡è€…è¿›è¡Œäº†å¦‚æ­¤å¤æ‚çš„è°ƒåº¦å™¨å®ç°ï¼Œæœ€ç»ˆäº¤ä»˜ç»™ Gopher çš„ï¼Œä»…ä»…æ˜¯ä¸€ä¸ª go å…³é”®å­—è¿™ä¹ˆç®€å•ï¼ŒçœŸçš„æ˜¯å¤§é“è‡³ç®€ï¼Œè¿™ä¹Ÿæ˜¯å……åˆ†å°è¯äº†é‚£å¥è¯ï¼šâ€œGo ä¸ºå¹¶å‘è€Œç”Ÿâ€ã€‚ å¸Œæœ›æœ¬æ–‡èƒ½å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œenjoy~ happy coding~ å‚è€ƒ æ·±å…¥ç†è§£ Go è¯­è¨€ Go è¯­è¨€åº•å±‚åŸç†å‰–æ æ·±å…¥ Go åº•å±‚åŸç† ChatGPT4 ä½œå›¾å·¥å…· excalidraw whimsical","tags":["Go"],"categories":["Go"]},{"title":"Rust å®æˆ˜ä¸¨ç»˜åˆ¶æ›¼å¾·åšé›†","path":"/2024/01/17/rust-action-mandelbrot/","content":"æ›¼å¾·åšé›† æ›¼å¾·åšé›† æ›¼å¾·åšé›†å…¶å®æ˜¯ä¸€ä¸ªâ€œæ²¡ä»€ä¹ˆç”¨â€çš„å‘ç°ã€‚ æ›¼å¾·åšé›†ï¼ˆMandelbrot Setï¼‰æ˜¯ä¸€ç§åœ¨å¤å¹³é¢ä¸Šå½¢æˆç‹¬ç‰¹ä¸”å¤æ‚å›¾æ¡ˆçš„ç‚¹çš„é›†åˆã€‚è¿™ä¸ªé›†åˆæ˜¯ä»¥æ•°å­¦å®¶æœ¬åÂ·æ›¼å¾·åšï¼ˆBenoit Mandelbrotï¼‰çš„åå­—å‘½åçš„ï¼Œä»–åœ¨ç ”ç©¶å¤æ‚ç»“æ„å’Œæ··æ²Œç†è®ºæ—¶å‘ç°äº†è¿™ä¸ªé›†åˆã€‚æ›¼å¾·åšé›†æ˜¯åˆ†å½¢å‡ ä½•çš„ä¸€ä¸ªç»å…¸ä¾‹å­ï¼Œæ˜¾ç¤ºäº†ä¸€ä¸ªç®€å•çš„æ•°å­¦å…¬å¼å¦‚ä½•èƒ½äº§ç”Ÿæ— é™å¤æ‚å’Œç¾ä¸½çš„å›¾æ¡ˆã€‚ æ›¼å¾·åšé›†çš„å®šä¹‰ç›¸å¯¹ç®€å•ã€‚å¯¹äºæ¯ä¸€ä¸ªå¤æ•° \\(c\\)ï¼Œæˆ‘ä»¬è€ƒè™‘ä»¥ä¸‹è¿­ä»£åºåˆ—ï¼š \\[ Z_{n+1} = z_n^2 + c \\;\\;\\\\ å…¶ä¸­ \\;\\; (z_0 = 0) \\] æ›¼å¾·åšé›†åˆç”±é‚£äº›ä½¿å¾—ä¸Šè¿°åºåˆ—ä¸è¶‹äºæ— é™å¤§çš„å¤æ•° \\(c\\) ç»„æˆã€‚åœ¨å¤å¹³é¢ä¸Šï¼Œè¿™äº›ç‚¹å½¢æˆäº†ä¸€ç§ç‹¬ç‰¹çš„å›¾æ¡ˆï¼Œé€šå¸¸ä»¥ä¸€ç§ç¾ä¸½ä¸”è‰ºæœ¯çš„æ–¹å¼å‘ˆç°ã€‚è¿™ä¸ªå›¾æ¡ˆçš„è¾¹ç•Œéå¸¸å¤æ‚ï¼ŒåŒ…å«äº†æ— é™çš„ç»†èŠ‚å’Œè‡ªç›¸ä¼¼çš„ç»“æ„ã€‚è¿™æ„å‘³ç€æ— è®ºä½ æ”¾å¤§å›¾æ¡ˆçš„å“ªä¸€éƒ¨åˆ†ï¼Œä½ éƒ½ä¼šå‘ç°è¶Šæ¥è¶Šç²¾ç»†çš„ç»“æ„ï¼Œè¿™äº›ç»“æ„åœ¨å½¢å¼ä¸Šä¸æ•´ä½“å›¾æ¡ˆç›¸ä¼¼ã€‚ æ›¼å¾·åšé›†åˆä¸ä»…åœ¨æ•°å­¦ä¸Šæœ‰æ„ä¹‰ï¼Œä¹Ÿåœ¨è‰ºæœ¯å’Œç§‘å­¦ä¸­æœ‰å¹¿æ³›çš„åº”ç”¨ï¼Œå°¤å…¶æ˜¯åœ¨ç ”ç©¶æ··æ²Œç†è®ºå’Œå¤æ‚ç³»ç»Ÿæ—¶ã€‚ å…·ä½“å¯ä»¥çœ‹ ç»´åŸºç™¾ç§‘-æ›¼å¾·åšé›† bilibili - 2000äº¿å€æ”¾å¤§æ›¼å¾·åšé›† ç›®æ ‡åŠŸèƒ½ æœ€ç»ˆæˆ‘ä»¬å°†å®ç°ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œå®ƒä¼šæ ¹æ®æˆ‘ä»¬è¾“å…¥çš„å‚æ•°ç”Ÿæˆæ›¼å¾·åšé›†å›¾ï¼Œä½¿ç”¨å¦‚ä¸‹ï¼š ./mandelbrot FILE PIXELS UPPERLEFT LOWERRIGHT FILE: æ›¼å¾·åšé›†å›¾ç”Ÿæˆçš„å›¾ç‰‡è·¯ç»ã€‚ PIXELS: å›¾ç‰‡åˆ†è¾¨ç‡ï¼Œå¦‚ 4x3ã€‚ UPPERLEFT: æŒ‡å®šåœ¨å¤å¹³é¢ä¸­å›¾ç‰‡è¦†ç›–çš„å·¦ä¸Šè§’ï¼Œå¦‚ 4.0,3.0ã€‚ LOWERRIGHT: åˆ¶å®šåœ¨å¤å¹³é¢ä¸­å›¾ç‰‡è¦†ç›–çš„å³ä¸‹è§’ã€‚ æ‰€ä»¥æˆ‘ä»¬æœ€ç»ˆä¼šæ ¹æ®æŒ‡å®šçš„å›¾ç‰‡èŒƒå›´ï¼Œæˆªå– PIXELS åˆ†è¾¨ç‡å¤§å°çš„æ›¼å¾·åšé›†å›¾ï¼š æˆªå–æ›¼å¾·åšé›†ç¤ºæ„å›¾ åŸºäºä»¥ä¸Šç›®æ ‡ï¼Œæˆ‘ä»¬æ‹†åˆ†æˆå‡ ä¸ªé—®é¢˜ï¼š å¦‚ä½•è¡¨ç¤ºå¤æ•°ï¼Ÿ å¦‚ä½•è§£æåˆ†è¾¨ç‡å’Œåæ ‡ï¼Ÿ å¦‚ä½•å°†å›¾ä¸Šåƒç´ æ˜ å°„åˆ°å¤æ•°ï¼Ÿ å¦‚ä½•ç”Ÿæˆæ›¼å¾·åšé›†å›¾ï¼Ÿå³å¦‚ä½•æ‰¾åˆ°é‚£äº›ç¬¦åˆæ›¼å¾·åšé›†çš„ç‚¹ï¼Œå¹¶å°†å…¶è¿›è¡Œç€è‰²æ ‡æ³¨ï¼Ÿ å¦‚ä½•å†™å…¥å›¾ç‰‡æ–‡ä»¶ï¼Ÿ å¦‚ä½•æ¸²æŸ“æ›¼å¾·åšé›†ï¼Ÿ å¦‚ä½•è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Ÿ å¦‚ä½•å¹¶å‘å†™å…¥å›¾ç‰‡æ–‡ä»¶ï¼Ÿ èƒ½å­¦åˆ°ä»€ä¹ˆ æ›¼å¾·åšé›†æ˜¯ä»€ä¹ˆï¼Ÿ Rust ä¸­çš„å¤æ•°çš„åŸç†ä¸åº”ç”¨ã€‚ Rust æ³›å‹åˆæ¢ã€‚ Rust ä¸­çš„ Option å’Œ Result åˆæ¢ã€‚ Rust å¹¶å‘åˆæ¢ã€‚ Rust ä¸­å¦‚ä½•è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Ÿ Rust å¦‚ä½•å†™å…¥å›¾åƒæ–‡ä»¶ï¼Ÿ Rust å¦‚ä½•å†™æµ‹è¯•ç”¨ä¾‹ï¼Ÿ Rust å®ç”¨ crate numã€imageã€crossbeamã€‚ ç‰ˆæœ¬ [package]name = mandelbrotversion = 0.1.0edition = 2021[dependencies]image = version = 0.13.0, features = [default, png]num = 0.4.1crossbeam = 0.8rayon = 1.10.0 å®Œæ•´ä»£ç ï¼šhttps://github.com/hedon954/mandelbrot/blob/master/src/main.rs ç¼–ç å®ç° 0. åˆ›å»ºé¡¹ç›® cargo new mandelbrot cd mandelbrot 1. å¤æ•°è¡¨ç¤º ä½¿ç”¨å¤æ•°ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥ä¸€ä¸ª creteï¼šnumï¼š cargo add num å…¶ä¸­å®šä¹‰äº†ä¸€ä¸ªå¤æ•°ç±»å‹ Complexï¼š pub struct ComplexT /// å¤æ•°çš„å®éƒ¨ pub re: T, /// å¤æ•°çš„è™šéƒ¨ pub im: T, è¿™é‡Œ T æ˜¯ Rust ä¸­çš„æ³›å‹åŠŸèƒ½ï¼Œè¡¨ç¤ºä»»æ„ç±»å‹ Tï¼Œç¡®å®šå¥½è¿™ä¸ªç»“æ„ä½“çš„ T çš„ç±»å‹åï¼Œå…¶ä¸­çš„å±æ€§ re å’Œ im çš„ç±»å‹ä¹Ÿå°±éšä¹‹ç¡®å®šäº†ã€‚ 2. è§£æåˆ†è¾¨ç‡å’Œåæ ‡ åˆ†è¾¨ç‡æ ¼å¼ä¸ºï¼š4000x3000 åæ ‡æ ¼å¼ä¸ºï¼š-1.0,2.0 2.1 è§£ææ•°å¯¹ æˆ‘ä»¬è¦åšçš„å°±æ˜¯ï¼Œå°†åˆ†è¾¨ç‡æ‹†æˆ (4000,3000)ï¼Œå°†åæ ‡æ‹†ä¸º (-1.0, 2.0)ã€‚è¿™é‡Œï¼š å¸¦è§£æçš„å…ƒç´  s æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸² strã€‚ åˆ†éš”ç¬¦ separator æ˜¯ä¸€ä¸ªå­—ç¬¦ charã€‚ è¿”å›å€¼æ˜¯ä¸€ä¸ªå…ƒç»„ (T, T)ï¼Œå…¶ä¸­ T è¿™é‡Œå¯ä»¥æ˜¯ u64/f32 ç­‰æ•°å­—ï¼Œå®ƒä»¬éƒ½éœ€è¦èƒ½ä»å­—ç¬¦ä¸²è½¬åŒ–è€Œæ¥ï¼Œå³ T:FromStrã€‚ å› ä¸ºè§£æå¯èƒ½å‡ºé”™ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ Option æ¥æ‰¿è½½ã€‚ /// æŠŠå­—ç¬¦ä¸² `s`ï¼ˆå½¢å¦‚ `400Ã—600` æˆ– ``1.0,0.5ï¼‰è§£ææˆä¸€ä¸ªåæ ‡å¯¹////// å…·ä½“æ¥è¯´ï¼Œ`s` åº”è¯¥å…·æœ‰leftseprightçš„æ ¼å¼ï¼Œå…¶ä¸­sepæ˜¯ç”±`separator`/// å‚æ•°ç»™å‡ºçš„å­—ç¬¦ï¼Œè€Œleftå’Œrightæ˜¯å¯ä»¥è¢« `T:from_str` è§£æçš„å­—ç¬¦ä¸²ã€‚/// `separator` å¿…é¡»æ˜¯ ASCII å­—ç¬¦////// å¦‚æœ `s` å…·æœ‰æ­£ç¡®çš„æ ¼å¼ï¼Œå°±è¿”å› `Some(x,y)`ï¼Œå¦åˆ™è¿”å› `None`fn parse_pairT: FromStr(s: str, separator: char) - Option(T, T) match s.find(separator) None = None, Some(index) = match (T::from_str(s[..index]), T::from_str(s[index + 1..])) (Ok(l), Ok(r)) = Some((l, r)), _ = None, , æˆ‘ä»¬å¯ä»¥å†™å‡ ä¸ªæµ‹è¯•ç”¨ä¾‹æ¥éªŒè¯ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„æ­£ç¡®æ€§ï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨åˆ° #[test] å’Œ assert_eq!ï¼š #[test]fn test_parse_pair() assert_eq!(parse_pair::i32(, ,), None); assert_eq!(parse_pair::i32(10,, ,), None); assert_eq!(parse_pair::i32(,10, ,), None); assert_eq!(parse_pair::i32(10,20, ,), Some((10, 20))); assert_eq!(parse_pair::i32(10,20xy, ,), None); assert_eq!(parse_pair::f64(0.5x, x), None); assert_eq!(parse_pair::f64(0.5x1.5, x), Some((0.5, 1.5))); 2.2 è½¬ä¸ºå¤æ•° æˆ‘ä»¬éœ€è¦çš„å‚æ•° upper_left å’Œ lower_right éƒ½æ˜¯å¤å¹³é¢ä¸­çš„ä¸€ä¸ªç‚¹ï¼Œæ‰€ä»¥ä»å­—ç¬¦ä¸²ä¸­å°†æ•°å¯¹è§£æå®Œæ¯•åï¼Œæˆ‘ä»¬å°†å…¶èµ‹å€¼åˆ°å¤æ•°çš„å®éƒ¨å’Œè™šéƒ¨ï¼Œè½¬ä¸ºå¤æ•°å®ä¾‹ã€‚ // æŠŠä¸€å¯¹ç”¨é€—å·éš”å¼€çš„æµ®ç‚¹æ•°è§£æä¸ºå¤æ•°fn parse_complex(s: str) - OptionComplexf64 match parse_pair(s, ,) Some((re, im)) = Some(Complex re, im ), None = None, 3. å°†åƒç´ ç‚¹æ˜ å°„æˆå¤æ•° ç¬¬ 2 æ­¥æˆ‘ä»¬å…¶å®ç¡®å®šäº†ä¸¤ä»¶äº‹ï¼š ç¡®å®šæˆªå–æ›¼å¾·åšé›†çš„å“ªä¸€éƒ¨åˆ†ã€‚ è¦åœ¨è¿™ä¸ªéƒ¨åˆ†ä¸­ç”»å¤šå°‘ä¸ªç‚¹ã€‚ ç›®æ ‡åŒºåŸŸä¸­çš„åƒç´ ç‚¹ è¿™ä¸€æ­¥æˆ‘ä»¬éœ€è¦æŠŠ x ç‚¹è½¬ä¸ºå¤æ•°ï¼Œå³ç¡®å®šå®ƒçš„æ¨ªåæ ‡å’Œçºµåæ ‡ã€‚è¿™éƒ¨åˆ†å¯èƒ½éœ€è¦å‘æŒ¥ä¸€ä¸‹ä½ çš„å‡ ä½•æ•°å­¦èƒ½åŠ›äº†ï¼ˆğŸ¤¡ğŸ¤¡ğŸ¤¡ï¼‰ã€‚ /// ç»™å®šè¾“å‡ºå›¾åƒé‡åƒç´ çš„è¡Œå’Œåˆ—ï¼Œè¿”å›å¤å¹³é¢ä¸­å¯¹åº”çš„åæ ‡////// `pixed` æ˜¯è¡¨ç¤ºç»™å›¾ç‰‡ä¸­ç‰¹å®šåƒç´ çš„ (column, row) äºŒå…ƒç»„ã€‚/// `upper_left` å‚æ•°å’Œ `lower_right` å‚æ•°æ˜¯åœ¨å¤å¹³é¢ä¸­è¡¨ç¤ºæŒ‡å®šå›¾åƒè¦†ç›–èŒƒå›´çš„ç‚¹ã€‚fn pixed_to_point( /* Â·-------------------- bounds.0 re ä¸¨ ä¸¨ ä¸¨ bounds.1 im */ bounds: (usize, usize), pixed: (usize, usize), upper_left: Complexf64, lower_right: Complexf64,) - Complexf64 let (width, height) = ( lower_right.re - upper_left.re, // å³-å·¦ upper_left.im - lower_right.im, // ä¸Š-ä¸‹ ); Complex re: upper_left.re + pixed.0 as f64 * width / bounds.0 as f64, im: upper_left.im - pixed.1 as f64 * height / bounds.1 as f64, #[test]fn test_pixed_to_point() assert_eq!( pixed_to_point( (100, 200), (25, 175), Complex re: -1.0, im: 1.0 , Complex re: 1.0, im: -1.0 ), Complex re: -0.5, im: -0.75, ); 4. å¯»æ‰¾æ›¼å¾·åšé›†ç‚¹ ä»€ä¹ˆæ˜¯æ›¼å¾·åšé›†ç‚¹ï¼Ÿçœ‹çœ‹ä¸Šé¢çš„å®šä¹‰ï¼šæ›¼å¾·åšé›†åˆç”±é‚£äº›ä½¿å¾—ä¸Šè¿°åºåˆ—ä¸è¶‹äºæ— é™å¤§çš„å¤æ•° \\(c\\) ç»„æˆã€‚ ç°åœ¨æˆ‘ä»¬å¯ä»¥æ¥è¡¨ç¤ºä¸Šè¿°çš„å…¬å¼ \\(Z_{n+1} = z_n^2 + c\\) äº†ï¼š fn complex_square_add_loop(c: Complexf64) let mut z = Complex re: 0.0, im: 0.0 ; loop z = z * z + c å…¶ä¸­æˆ‘ä»¬å°†æ³›å‹ç»“æ„ä½“ Complex çš„ T ç¡®å®šä¸º f64ï¼Œå¹¶ä½¿ç”¨ loop å…³é”®å­—è¿›è¡Œæ— é™å¾ªç¯ã€‚ æ‰€ä»¥æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿæ‰¾åˆ°ä»¤ z ä¸ä¼šâ€œé£åˆ°â€æ— ç©·è¿œçš„ cã€‚ ç”±äºå¤æ•° \\(c\\) å…·æœ‰å®éƒ¨ re å’Œè™šéƒ¨ imï¼Œå› æ­¤å¯ä»¥æŠŠå®ƒä»¬è§†ä¸ºç¬›å¡å°”å¹³é¢ä¸ŠæŸä¸ªç‚¹çš„ x åæ ‡å’Œ y åæ ‡ï¼Œå¦‚æœ \\(c\\) åœ¨æ›¼å¾·åšé›†ä¸­ï¼Œå°±åœ¨å…¶ä¸­ç”¨é»‘è‰²ç€è‰²ï¼Œå¦åˆ™å°±ç”¨æµ…è‰²ã€‚å› æ­¤ï¼Œå¯¹äºå›¾åƒä¸­çš„æ¯ä¸ªåƒç´ ï¼Œå¿…é¡»åœ¨å¤å¹³é¢ä¸Šç›¸åº”ç‚¹ä½è¿è¡Œå‰é¢çš„å¾ªç¯ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦é€ƒé€¸åˆ°æ— ç©·è¿œè¿˜æ˜¯æ°¸è¿œç»•ç€åŸç‚¹è¿è¡Œï¼Œå¹¶ç›¸åº”å°†å…¶ç€è‰²ã€‚ æ— é™å¾ªç¯è‚¯å®šæ˜¯ä¸ç°å®çš„ï¼Œæˆ‘ä»¬æ€»è¦æ‰¾åˆ°é€€å‡ºå¾ªç¯çš„æœºä¼šï¼Œæœ‰ 2 ä¸ªæ€è·¯ï¼š è¿›è¡Œæœ‰é™æ¬¡æ•°çš„è¿­ä»£ï¼Œè¿™æ ·å¯ä»¥è·å¾—è¯¥é›†åˆçš„ä¸€ä¸ªä¸é”™çš„è¿‘ä¼¼å€¼ï¼Œè¿­ä»£çš„æ¬¡æ•°å–å†³äº†ç²¾åº¦çš„éœ€è¦ï¼› ä¸šç•Œå·²è¯æ˜ï¼Œä¸€æ—¦ z ç¦»å¼€äº†ä»¥åŸç‚¹ä¸ºä¸­å¿ƒçš„åŠå¾„ 2 çš„åœ†ï¼Œå®ƒæœ€ç»ˆä¸€å®šä¼šâ€œé£åˆ°â€æ— ç©·è¿œã€‚ æ‰€ä»¥æˆ‘ä»¬æœ€ç»ˆç¡®å®šçš„å‡½æ•°å¦‚ä¸‹ï¼Œå…¶ä¸­ norm_sqr() ä¼šè¿”å› z è·Ÿå¤å¹³é¢åŸç‚¹çš„è·ç¦»çš„å¹³æ–¹ï¼š /// å°è¯•æµ‹è¯• `c` æ˜¯å¦ä½äºæ›¼å¾·åšé›†ä¸­ï¼Œä½¿ç”¨æœ€å¤š `limit` æ¬¡è¿­ä»£æ¥åˆ¤å®š////// å¦‚æœ `c` ä¸æ˜¯é›†åˆæˆå‘˜ä¹‹ä¸€ï¼Œåˆ™è¿”å› `Some(i)`ï¼Œå…¶ä¸­ `i` æ˜¯ `c` ç¦»å¼€ä»¥åŸç‚¹/// ä¸ºä¸­å¿ƒçš„åŠå¾„ä¸º 2 çš„åœ†æ—¶æ‰€éœ€çš„è¿­ä»£æ¬¡æ•°ã€‚å¦‚æœ `c` ä¼¼ä¹æ˜¯é›†ç¾¤æˆå‘˜ä¹‹ä¸€ï¼ˆç¡®/// åˆ‡è€Œè¨€æ˜¯è¾¾åˆ°äº†è¿­ä»£æ¬¡æ•°é™åˆ¶ä½†ä»ç„¶æ— æ³•è¯æ˜ `c` ä¸æ˜¯æˆå‘˜ï¼‰ï¼Œåˆ™è¿”å› `None`fn escape_time(c: Complexf64, limit: usize) - Optionusize let mut z = Complex re: 0.0, im: 0.0 ; for i in 0..limit if z.norm_sqr() 4.0 return Some(i); z = z * z + c None 5. å†™å…¥å›¾ç‰‡æ–‡ä»¶ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ image è¿™ä¸ª crate æ¥å†™å…¥å›¾ç‰‡æ–‡ä»¶ï¼Œå®ƒæ”¯æŒå¤šç§æ ¼å¼å›¾ç‰‡çš„è¯»å†™ï¼Œå¹¶å†…ç½®äº†å¤šç§é¢œè‰²è‰²å€¼ã€‚ è¿™é‡Œæˆ‘ä»¬å‡†å¤‡ç”Ÿæˆ png å›¾ç‰‡ï¼Œä¸”éœ€è¦å¯¹å›¾ç‰‡è¿›è¡Œä¸åŒé¢œè‰²çš„ç€è‰²ï¼Œæ‰€ä»¥æˆ‘ä»¬å¼•å…¥ default å’Œ png è¿™ä¸¤ä¸ª featureã€‚ cargo add image --features default,png 5.1 åˆ›å»ºæ–‡ä»¶ File::create() æˆ‘ä»¬å¯ä»¥ç”¨æ ‡å‡†åº“ä¸­çš„ File::create(filename) æ¥åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼ŒæˆåŠŸçš„è¯ä¼šè¿”å›ä¸€ä¸ªæ–‡ä»¶å¥æŸ„ï¼š let output = File::create(filename)?; 5.2 å†™å…¥å›¾ç‰‡ PNGEncoder image ä¸­æä¾›äº† PNGEncoder ç”¨äºå†™å…¥ png å›¾ç‰‡ï¼Œå®ƒæœ‰ä¸¤ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼š implW: Write PNGEncoderW /// Create a new encoder that writes its output to ```w``` pub fn new(w: W) - PNGEncoderW PNGEncoder w: w /// Encodes the image ```image``` /// that has dimensions ```width``` and ```height``` /// and ```ColorType``` ```c``` pub fn encode(self, data: [u8], width: u32, height: u32, color: ColorType) - io::Result() let (ct, bits) = color.into(); let mut encoder = png::Encoder::new(self.w, width, height); encoder.set(ct).set(bits); let mut writer = try!(encoder.write_header()); writer.write_image_data(data).map_err(|e| e.into()) new(w): ä¼ è¿›ç›®æ ‡ writerï¼Œå³æˆ‘ä»¬ä¸Šé¢åˆ›å»ºçš„ outputã€‚ encode(): å†™å…¥å›¾ç‰‡ä¿¡æ¯ï¼Œè¿™é‡Œæœ‰å‡ ä¸ªå‚æ•°ï¼š width: u32: å›¾ç‰‡å®½åº¦ã€‚ height: u32: å›¾ç‰‡é«˜åº¦ã€‚ color: ColorType: é¢œè‰²ç±»å‹ï¼Œå¯ä»¥æ˜¯ RGB, Gray(8) ç­‰ã€‚ data: [u8]: åƒç´ è‰²å€¼åˆ—è¡¨ï¼Œå®ƒçš„é•¿åº¦åº”è¯¥ç”±ä¸Šé¢ 3 ä¸ªå­—æ®µå…±åŒå†³å®šï¼Œå¦‚æœé€‰å–çš„é¢œè‰²æ˜¯ RGBï¼Œæ„å‘³ç€éœ€è¦ 3 ä¸ª u8 æ‰èƒ½è¡¨ç¤ºä¸€ä¸ªåƒç´ ç‚¹çš„é¢œè‰²ï¼Œæ‰€ä»¥é•¿åº¦ä¸º width * height * 3ï¼Œå¦‚æœé€‰å–çš„é¢œè‰²æ˜¯ Gray(8)ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç”¨ 1 ä¸ª u8 å°±å¯ä»¥è¡¨ç¤ºä¸€ä¸ªåƒç´ ç‚¹çš„ç°åº¦å€¼ï¼Œæ‰€ä»¥é•¿åº¦ä¸º width * height * 1ã€‚æœ¬æ–‡ä¸­æˆ‘ä»¬ä¼šé‡‡ç”¨ Gray(8) æ¥æ±‡æ€»æ›¼å¾·åšé›†çš„é»‘ç™½å›¾ã€‚ 6. æ¸²æŸ“æ›¼å¾·åšé›† è¿™ä¸€æ­¥æˆ‘ä»¬éœ€è¦æ¥ç¡®å®šä¸Šè¿° PNGEncoder::encode() çš„ 4 ä¸ªå‚æ•°ï¼š width: u32: å›¾ç‰‡å®½åº¦ç”±å‘½ä»¤è¡Œå‚æ•°ä¸­æŒ‡å®šå³å¯ã€‚ height: u32: å›¾ç‰‡é«˜åº¦ç”±å‘½ä»¤è¡Œå‚æ•°ä¸­æŒ‡å®šå³å¯ã€‚ color: ColorType: æœ¬æ–‡æˆ‘ä»¬åªç»˜åˆ¶é»‘ç™½å›¾ï¼Œè¿™é‡Œä½¿ç”¨ ColorType::Gray(8)ï¼Œå®ƒè¡¨ç¤ºå›¾åƒæ˜¯ä¸€ä¸ªç°åº¦ï¼ˆå•è‰²ï¼‰å›¾åƒï¼Œæ¯ä¸ªåƒç´ ç”¨8ä½ï¼ˆå³1ä¸ªå­—èŠ‚ï¼‰æ¥è¡¨ç¤ºã€‚åœ¨è¿™ç§æ ¼å¼ä¸­ï¼Œæ¯ä¸ªåƒç´ çš„ç°åº¦å€¼èŒƒå›´æ˜¯ 0 åˆ° 255ï¼Œå…¶ä¸­ 0 é€šå¸¸è¡¨ç¤ºé»‘è‰²ï¼Œ255 è¡¨ç¤ºç™½è‰²ï¼Œä¸­é—´å€¼è¡¨ç¤ºä¸åŒçš„ç°åº¦ã€‚ data: [u8]: åƒç´ è‰²å€¼åˆ—è¡¨ï¼Œæˆ‘ä»¬éœ€è¦ç¡®å®š width * height ä¸ªåƒç´ çš„ç°åº¦å€¼ã€‚ é¦–å…ˆæˆ‘ä»¬æ ¹æ®ç¬¬ 3 æ­¥å°†åƒç´ ç‚¹æ˜ å°„æˆå¤æ•° \\(c\\)ï¼Œç„¶åä½¿ç”¨ç¬¬ 4 æ­¥ä¸­çš„ escape_time() å‡½æ•°æ¥åˆ¤æ–­å¤æ•° \\(c\\) æ˜¯å¦ä½äºæ›¼å¾·åšé›†ä¸­ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ç€é»‘è‰²ï¼Œå³èµ‹å€¼ 0ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™çœ‹å®ƒè¿­ä»£äº†å¤šå°‘æ¬¡æ‰å¤±è´¥ï¼Œæ¬¡æ•°è¶Šå¤šï¼Œåˆ™è¶Šæ¥è¿‘æ›¼å¾·åšé›†ï¼Œé¢œè‰²è¶Šæ·±ï¼Œå³è¶Šé è¿‘ 0ï¼Œæ‰€ä»¥èµ‹å€¼ 255-timeã€‚ æœ€ç»ˆæˆ‘ä»¬å®ç°çš„å‡½æ•°å¦‚ä¸‹ï¼š /// å°†æ›¼å¾·åšé›†å¯¹åº”çš„çŸ©å½¢æ¸²æŸ“åˆ°åƒç´ ç¼“å†²åŒºä¸­////// `bounds` å‚æ•°ä¼šç»™ç¼“å†²åŒº `pixels` çš„å®½åº¦å’Œé«˜åº¦ï¼Œæ­¤ç¼“å†²åŒºçš„æ¯ä¸ªå­—èŠ‚éƒ½/// åŒ…å«ä¸€ä¸ªç°åº¦åƒç´ ã€‚`upper_left` å’Œ `lower_right` å‚æ•°åˆ†åˆ«æŒ‡å®šäº†/// å¤å¹³é¢ä¸­å¯¹åº”äºåƒç´ ç¼“å†²åŒºå·¦ä¸Šè§’å’Œå³ä¸Šè§’çš„ç‚¹ã€‚fn render( pixels: mut [u8], bounds: (usize, usize), upper_left: Complexf64, lower_right: Complexf64,) assert_eq!(pixels.len(), bounds.0 * bounds.1); for raw in 0..bounds.1 for column in 0..bounds.0 let point = pixed_to_point(bounds, (column, raw), upper_left, lower_right); pixels[raw * bounds.0 + column] = match escape_time(point, 255) None = 0, Some(count) = 255 - count as u8, 7. è§£æå‘½ä»¤è¡Œå‚æ•° æ ¸å¿ƒé€»è¾‘éƒ¨åˆ†åˆ°è¿™é‡Œå…¶å®å°±å®Œæˆäº†ï¼Œç°åœ¨æˆ‘ä»¬è¦åšæœ€åä¸€æ­¥ï¼Œå°±æ˜¯è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Œè®©ç¨‹åºå¯ä»¥æ ¹æ®æˆ‘ä»¬çš„è¦æ±‚ç»˜åˆ¶æ›¼å¾·åšé›†å›¾ã€‚ 7.1 è§£æ std::env::args() åœ¨ Rust ä¸­è§£æå‘½ä»¤è¡Œå‚æ•°çš„ä¸€ä¸ªå¸¸ç”¨æ–¹æ³•æ˜¯ä½¿ç”¨std::env::argså‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ªè¿­ä»£å™¨ï¼Œå®ƒåŒ…å«äº†å‘½ä»¤è¡Œä¸Šä¼ é€’ç»™ç¨‹åºçš„æ‰€æœ‰å‚æ•°ã€‚å¯¹äºæ›´å¤æ‚çš„å‘½ä»¤è¡Œå‚æ•°è§£æï¼Œå¯ä»¥ä½¿ç”¨åƒclapæˆ–structoptè¿™æ ·çš„ç¬¬ä¸‰æ–¹åº“ï¼Œè¿™äº›åº“æä¾›äº†æ›´é«˜çº§çš„åŠŸèƒ½å’Œæ›´å¥½çš„é”™è¯¯å¤„ç†ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨std::env::argsçš„åŸºæœ¬ä¾‹å­ï¼š use std::env;fn main() let args: VecString = env::args().collect(); for arg in args.iter() println!(, arg); 7.2 åŸºç¡€ç‰ˆç¨‹åº åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±å¯ä»¥å®ç°å®Œæ•´çš„åŸºç¡€ç‰ˆç¨‹åºäº†ã€‚ fn main() // è¯»å–å‚æ•° let args: VecString = env::args().collect(); // å‚æ•°ä¸ªæ•° = 1 + 4ï¼Œå…¶ä¸­ç¬¬ 1 ä¸ªæ˜¯åº”ç”¨ç¨‹åºå if args.len() != 5 eprintln!(Usage: FILE PIXELS UPPERLEFT LOWERRIGHT, args[0]); eprintln!( Example: mandel.png 1000x700 -1.20,0.35 -1,0.20, args[0] ); std::process::exit(1); // è§£æå‚æ•° let bounds = parse_pair(args[2], x).expect(error parsing image dimensions); let upper_left = parse_complex(args[3]).expect(error parsing upper left corner point); let lower_right = parse_complex(args[4]).expect(error parsing lower right corner point); let mut pixels = vec![0; bounds.0 * bounds.1]; // æ¸²æŸ“æ›¼å¾·åšé›† render(mut pixels, bounds, upper_left, lower_right); // è¾“å‡ºå›¾ç‰‡ write_image(args[1], pixels, bounds).expect(error writing PNG file); æˆ‘ä»¬åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹ç¼–è¯‘ä¸€ä¸‹ç¨‹åºï¼š cargo build --release ä¼šåœ¨ target/release ä¸‹ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ‰§è¡Œï¼š ./target/release/mandelbrot mandel.png 4000x3000 -1.20,0.35 -1,0.20 æ‰§è¡Œåä½ åº”è¯¥å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ç”Ÿæˆçš„æ›¼å¾·åšé›†å›¾å¦‚ä¸‹ï¼š ç¨‹åºç”Ÿæˆçš„æ›¼å¾·åšé›† å¤§æ¦‚æ˜¯å¤„äºè¿™ä¸ªä½ç½®ï¼š ç¨‹åºæˆªå–çš„å±€éƒ¨æ›¼å¾·åšé›†å¤„äºæ•´ä¸ªæ›¼å¾·åšé›†ä¸­çš„ä½ç½® 8. å¹¶å‘æ¸²æŸ“ åœ¨ macOS æˆ– linux ç³»ç»Ÿä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ time æ¥è¾“å‡ºç¨‹åºçš„æ‰§è¡Œæ—¶é—´ï¼š time ./target/release/mandelbrot mandel.png 4000x3000 -1.20,0.35 -1,0.20./target/release/mandelbrot mandel.png 4000x3000 -1.20,0.35 -1,0.20 3.30s user 0.01s system 98% cpu 3.341 total ç¬”è€…ä½¿ç”¨çš„ç”µè„‘ä¸º macbook Pro m2 max èŠ¯ç‰‡ 32 G å†…å­˜ 12 æ ¸ï¼Œå¯ä»¥çœ‹åˆ°åœ¨å•æ ¸æ¨¡å¼ä¸‹ï¼Œå·®ä¸å¤šéœ€è¦ 3~4s çš„æ—¶é—´ã€‚ å‡ ä¹æ‰€æœ‰çš„ç°ä»£æœºå™¨éƒ½æœ‰å¤šä¸ªå¤„ç†å™¨æ ¸å¿ƒï¼Œè€Œå½“å‰è¿™ä¸ªç¨‹åºåªä½¿ç”¨äº†ä¸€ä¸ªã€‚å¦‚æœå¯ä»¥æŠŠæ­¤å·¥ä½œåˆ†æ´¾ä¸ªæœºå™¨æä¾›çš„å¤šä¸ªå¤„ç†å™¨æ ¸å¿ƒï¼Œåˆ™åº”è¯¥å¯ä»¥æ›´å¿«åœ°ç”»å®Œå›¾åƒã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å°†å›¾åƒåˆ’åˆ†æˆå¤šä¸ªéƒ¨åˆ†ï¼Œæ¯ä¸ªå¤„ç†å™¨è´Ÿè´£å…¶ä¸­çš„ä¸€ä¸ªéƒ¨åˆ†ï¼Œå¹¶è®©æ¯ä¸ªå¤„ç†å™¨ä¸ºåˆ†æ´¾ç»™å®ƒçš„åƒç´ ç€è‰²ã€‚ä¸ºç®€å•èµ·è§ï¼Œå¯ä»¥å°†å…¶åˆ†æˆä¸€äº›æ°´å¹³æ¡å¸¦ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å°†åƒç´ ç¼“å†²åŒºåˆ’åˆ†ä¸ºä¸€äº›æ¡å¸¦ä»¥è¿›è¡Œå¹¶å‘æ¸²æŸ“ crossbeam æ˜¯ Rust ä¸­çš„ä¸€ä¸ªå¹¶å‘ç¼–ç¨‹å·¥å…·ç®±ï¼Œå®ƒå¹¿æ³›ç”¨äºæä¾›å„ç§å¹¶å‘å’Œå¤šçº¿ç¨‹ç¼–ç¨‹çš„ç»„ä»¶ã€‚ crossbeam::scope æ˜¯ crossbeam æä¾›çš„ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„åŠŸèƒ½ï¼Œå®ƒå…è®¸ä½ å®‰å…¨åœ°åˆ›å»ºä¸´æ—¶çš„çº¿ç¨‹ï¼Œå¹¶ç¡®ä¿è¿™äº›çº¿ç¨‹åœ¨ç¦»å¼€ä½œç”¨åŸŸä¹‹å‰ç»“æŸã€‚ è¿™é‡Œæˆ‘ä»¬å¼•å…¥ crossbeamï¼š cargo add crossbeam æˆ‘ä»¬å°† fn main() ä¸­çš„ï¼š render(mut pixels, bounds, upper_left, lower_right); æ›¿æ¢æˆï¼š // ä½¿ç”¨ 8 ä¸ªçº¿ç¨‹æ¥å¹¶å‘æ‰§è¡Œlet threads = 8;// è®¡ç®—æ¯ä¸ªçº¿ç¨‹è´Ÿè´£æ¸²æŸ“çš„é«˜åº¦ï¼Œå‘ä¸Šå–æ•´let rows_per_band = bounds.1 / threads + 1; // chunks_mut() ä¼šè¿”å›ä¸€ä¸ªè¿­ä»£å™¨ï¼Œè¯¥è¿­ä»£å™¨ä¼šç”Ÿæˆæ­¤ç¼“å†²åŒºçš„å¯å˜ä¸”ä¸å¯è¿­ä»£çš„åˆ‡ç‰‡ let bands: Vecmut [u8] = pixels.chunks_mut(rows_per_band * bounds.0).collect(); // crossbeam::scope ç¡®ä¿æ‰€æœ‰å­çº¿ç¨‹åœ¨ä½œç”¨åŸŸç»“æŸä¹‹å‰å®Œæˆï¼Œ // è¿™é˜²æ­¢äº†æ‚¬å‚æŒ‡é’ˆå’Œå…¶ä»–æ•°æ®ç«äº‰é—®é¢˜ã€‚ crossbeam::scope(|spawner| // éå†åƒç´ ç¼“å†²åŒºçš„å„ä¸ªæ¡å¸¦ï¼Œ // è¿™é‡Œ into_iter() è¿­ä»£å™¨ä¼šä¸ºå¾ªç¯ä½“çš„æ¯æ¬¡è¿­ä»£èµ‹äºˆç‹¬å ä¸€ä¸ªæ¡å¸¦çš„æ‰€æœ‰æƒï¼Œ // ç¡®ä¿ä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥å†™å…¥å®ƒã€‚ for (i, band) in bands.into_iter().enumerate() // ç¡®å®šæ¯ä¸ªæ¡å¸¦çš„å‚æ•° let top = rows_per_band * i; let height = band.len() / bounds.0; let band_bounds = (bounds.0, height); let band_upper_left = pixed_to_point(bounds, (0, top), upper_left, lower_right); let band_lower_right = pixed_to_point(bounds, (bounds.0, top + height), upper_left, lower_right); // åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œæ¸²æŸ“å›¾åƒ // move è¡¨ç¤ºè¿™ä¸ªé—­åŒ…ä¼šæ¥æ‰‹å®ƒæ‰€ç”¨éå†çš„æ‰€æœ‰æƒï¼Œ // æ‰€ä»¥åªæœ‰æ­¤é—­å…³ï¼Œå³åªæœ‰æ­¤çº¿ç¨‹å¯ä»¥ä½¿ç”¨å¯å˜åˆ‡ç‰‡ bandã€‚ spawner.spawn(move |_| render(band, band_bounds, band_upper_left, band_lower_right); ); ) .unwrap(); å†æ¬¡æ‰§è¡Œï¼š time ./target/release/mandelbrot mandel.png 4000x3000 -1.20,0.35 -1,0.20./target/release/mandelbrot mandel.png 4000x3000 -1.20,0.35 -1,0.20 3.57s user 0.01s system 335% cpu 1.067 total å¯ä»¥çœ‹åˆ°è™½ç„¶æ€»å…±ä½¿ç”¨çš„ CPU æ—¶é—´è¿˜æ˜¯ 3~4sï¼Œä½†æ˜¯æ•´ä¸ªç¨‹åºçš„æ‰§è¡Œæ—¶é—´åªç¼©çŸ­åˆ° 1s å·¦å³äº†ã€‚ 9. rayon å·¥ä½œçªƒå– å‰é¢æˆ‘ä»¬ä½¿ç”¨ 8 ä¸ªå·¥ä½œçº¿ç¨‹ä¼˜åŒ–äº†æ›¼å¾·åšé›†çš„ç»˜åˆ¶é€Ÿåº¦ï¼Œå¤§æ¦‚æ˜¯ 4 å€çš„é€Ÿåº¦æå‡ã€‚å…¶å®è¿™è¿˜ä¸å¤Ÿå¿«ã€‚ é—®é¢˜çš„æ ¹æºåœ¨äºæˆ‘ä»¬æ²¡æœ‰å¹³å‡åˆ†é…å·¥ä½œé‡ã€‚è®¡ç®—å›¾åƒçš„ä¸€ä¸ªåƒç´ ç›¸å½“äºè¿è¡Œä¸€ä¸ªå¾ªç¯ã€‚äº‹å®ä¸Šï¼Œå›¾åƒçš„æµ…ç°è‰²éƒ¨åˆ†ï¼ˆå¾ªç¯ä¼šå¿«é€Ÿé€€å‡ºçš„åœ°æ–¹ï¼‰æ¯”é»‘è‰²éƒ¨åˆ†ï¼ˆå¾ªç¯ä¼šè¿è¡Œæ•´æ•´ 255 æ¬¡è¿­ä»£çš„åœ°æ–¹ï¼‰æ¸²æŸ“é€Ÿåº¦è¦å¿«å¾—å¤šã€‚å› æ­¤ï¼Œè™½ç„¶æˆ‘ä»¬å°†æ•´ä¸ªåŒºåŸŸåˆ’åˆ†æˆäº†å¤§å°ç›¸ç­‰çš„æ°´å¹³æ¡å¸¦ï¼Œä½†åˆ›å»ºäº†ä¸å‡ç­‰çš„å·¥ä½œè´Ÿè½½ï¼Œ æ›¼å¾·åšé›†ç¨‹åºä¸­çš„å·¥ä½œåˆ†é…ä¸å‡ç­‰ ä½¿ç”¨ rayon å¾ˆå®¹æ˜“è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æˆ‘ä»¬å¯ä»¥ä¸ºè¾“å‡ºä¸­çš„æ¯ä¸€è¡Œåƒç´ å¯åŠ¨ä¸€ä¸ªå¹¶è¡Œä»»åŠ¡ã€‚è¿™ä¼šåˆ›å»ºæ•°ç™¾ä¸ªä»»åŠ¡ï¼Œè€Œ rayon å¯ä»¥åœ¨å…¶çº¿ç¨‹ä¸­åˆ†é…è¿™äº›ä»»åŠ¡ã€‚æœ‰äº†å·¥ä½œçªƒå–æœºåˆ¶ï¼Œä»»åŠ¡çš„è§„æ¨¡æ˜¯æ— å…³ç´§è¦çš„ã€‚rayon ä¼šå¯¹è¿™äº›å·¥ä½œè¿›è¡Œå¹³è¡¡ã€‚ æˆ‘ä»¬å…ˆå¼•å…¥ rayonï¼š cargo add rayon åœ¨ main.rs ä¸­å¼•å…¥ rayon: use rayon::prelude::*; ç„¶å main ä¸­å¹¶å‘ç»˜åˆ¶çš„éƒ¨åˆ†æ›¿æ¢ä¸ºä¸‹é¢çš„ä»£ç ï¼š let bands: Vec(usize, mut [u8]) = pixels.chunks_mut(bounds.0).enumerate().collect();bands.into_par_iter().for_each(|(i, band)| let top = i; let band_bounds = (bounds.0, 1); let band_upper_left = pixed_to_point(bounds, (0, top), upper_left, lower_right); let band_lower_right = pixed_to_point(bounds, (bounds.0, top + 1), upper_left, lower_right); render(band, band_bounds, band_upper_left, band_lower_right);); é¦–å…ˆï¼Œåˆ›å»º bandsï¼Œä¹Ÿå°±æ˜¯è¦ä¼ ç»™ rayon çš„ä»»åŠ¡é›†åˆã€‚æ¯ä¸ªä»»åŠ¡åªæ˜¯ä¸€ä¸ªå…ƒç»„ç±»å‹ (usize, mut [u8])ï¼šç¬¬ä¸€ä¸ªæ˜¯è®¡ç®—æ‰€éœ€çš„è¡Œå·ï¼Œç¬¬äºŒä¸ªæ˜¯è¦å¡«å……çš„ pixels åˆ‡ç‰‡ã€‚æˆ‘ä»¬ä½¿ç”¨ chunks_mut æ–¹æ³•å°†å›¾åƒç¼“å†²åŒºåˆ†æˆä¸€äº›è¡Œï¼Œenumerate åˆ™ä¼šç»™æ¯ä¸€è¡Œæ·»åŠ è¡Œå·ï¼Œç„¶å collect ä¼šå°†æ‰€æœ‰æ•°å€¼åˆ‡ç‰‡å¯¹æ”¾å…¥ä¸€ä¸ªå‘é‡ä¸­ã€‚ï¼ˆè¿™é‡Œéœ€è¦ä¸€ä¸ªå‘é‡ï¼Œå› ä¸º rayon åªèƒ½ä»æ•°ç»„å’Œå‘é‡ä¸­åˆ›å»ºå¹¶è¡Œè¿­ä»£å™¨ã€‚ï¼‰ ç¼–è¯‘ï¼š cargo build --release å†æ¬¡æ‰§è¡Œï¼š time ./target/release/mandelbrot mandel.png 4000x3000 -1.20,0.35 -1,0.20./target/release/mandelbrot mandel.png 4000x3000 -1.20,0.35 -1,0.20 3.96s user 0.01s system 973% cpu 0.408 total å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ¬¡é€Ÿåº¦æå‡æ›´åŠ æ˜æ˜¾ï¼Œæ€»å…±åªç”¨äº† 0.4s å·¦å³çš„æ—¶é—´ã€‚ ä»¥ä¸Šå°±æ˜¯å®ç”¨ Rust ç»˜åˆ¶æ›¼å¾·åšé›†å®æˆ˜çš„å…¨éƒ¨å†…å®¹ï¼Œenjoyï¼Œhappy coding~","tags":["Rust"],"categories":["Rust","Rust å®æˆ˜"]},{"title":"ä¸€æ–‡å½»åº•æŒæ¡æµ®ç‚¹æ•°","path":"/2023/12/23/floating-point-number/","content":"ç»å…¸é—®é¢˜ 0.1 + 0.2 = ï¼Ÿ æˆ‘ä»¬å†™ä¸ª Go ç¨‹åºæ¥æµ‹è¯•ä¸€ä¸‹ï¼š func main() var f1 float64 = 0.1\tvar f2 float64 = 0.2\tfmt.Println(f1+f2 == 0.3)\tfmt.Println(f1 + f2) è¾“å‡ºï¼š false0.30000000000000004 å¦‚æ­¤è¿èƒŒ â€œå¸¸è¯†â€ çš„ç»“æœï¼Œå…¶å®æ˜¯å› ä¸ºå½“ä¸‹è®¡ç®—æœºä½“ç³»ä¸­å°æ•°çš„è¡¨ç¤ºæ–¹å¼æ˜¯æµ®ç‚¹æ•°ï¼Œè€Œè®¡ç®—æœºä¸­å¯¹æµ®ç‚¹æ•°çš„è¡¨ç¤ºå¹¶éç™¾åˆ†ç™¾ç²¾ç¡®çš„ï¼Œåœ¨è¡¨ç¤ºå’Œè®¡ç®—è¿‡ç¨‹ä¸­éƒ½æœ‰å¯èƒ½ä¼šä¸¢å¤±ç²¾åº¦ã€‚ è¿™è¿«ä½¿å¿…é¡»æ·±å…¥ç†è§£æµ®ç‚¹æ•°åœ¨è®¡ç®—æœºä¸­çš„å­˜å‚¨æ–¹å¼åŠæ€§è´¨ï¼Œæ‰èƒ½æ­£ç¡®å¤„ç†å…³äºæ•°å­—çš„è®¡ç®—é—®é¢˜ã€‚ ç»“è®ºå…ˆè¡Œ IEEE-754 æµ®ç‚¹æ•° å®šç‚¹æ•° è¦ç†è§£æµ®ç‚¹æ•°çš„ç¬¬ä¸€æ­¥æ˜¯è€ƒè™‘å«æœ‰å°æ•°å€¼çš„äºŒè¿›åˆ¶æ•°å­—ã€‚åœ¨è¿™ä¹‹å‰ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æ›´åŠ ç†Ÿæ‚‰çš„åè¿›åˆ¶è¡¨ç¤ºæ³•ï¼š \\[ d_md_{m-1} Â·Â·Â· d_1d_0 . d_{-1}d_{-2}Â·Â·Â· d_{-n} \\] å°æ•°ç‚¹ . å·¦è¾¹æ˜¯æ•´æ•°éƒ¨åˆ†ï¼Œå³è¾¹æ˜¯å°æ•°éƒ¨åˆ†ã€‚å…¶ä¸­æ¯ä¸ªåè¿›åˆ¶æ•° di çš„å–å€¼èŒƒå›´æ˜¯ 0~9ã€‚ å¦‚åè¿›åˆ¶çš„ 12.34 å³å¯ä»¥è¡¨ç¤ºä¸ºï¼š \\[ 1Ã—10^1+2Ã—10^0+3Ã—10^{-1}+4Ã—10^{-2} \\] é‚£å…¶å®äºŒè¿›åˆ¶ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ï¼Œåªä¸è¿‡æŠŠå…¶ä¸­çš„ 10 æ¢æˆ 2ï¼Œè€Œ di çš„å–å€¼èŒƒå›´ä¸º 0~1ã€‚ å¦‚äºŒè¿›åˆ¶çš„ 101.11 å¯ä»¥è¡¨ç¤ºä¸ºï¼š \\[ 1Ã—2^2+0Ã—2^1+1Ã—2^0+1Ã—2^{-1}+1Ã—2^{-2} \\] å¦‚æœæˆ‘ä»¬ä»…è€ƒè™‘æœ‰é™é•¿åº¦çš„ç¼–ç ï¼Œé‚£ä¹ˆåè¿›åˆ¶è¡¨ç¤ºæ³•ä¸èƒ½å‡†ç¡®è¡¨è¾¾åƒ 1/3 å’Œ 5/7 è¿™æ ·çš„æ•°ã€‚ç±»ä¼¼çš„ï¼Œå°æ•°çš„äºŒè¿›åˆ¶è¡¨ç¤ºæ³•åªèƒ½è¡¨ç¤ºé‚£äº›èƒ½å¤Ÿè¢«å†™æˆä»¥ä¸‹å½¢å¼çš„æ•°ï¼š \\[ x Ã— 2^y \\] å…¶ä»–çš„å€¼å°±åªèƒ½è¿‘ä¼¼åœ°è¡¨ç¤ºã€‚ å®šç‚¹æ•°çš„æ•´æ•°éƒ¨åˆ†æ˜¯å°æ•°éƒ¨åˆ†çš„ä½æ•°æ˜¯å›ºå®šä¸å˜çš„ï¼Œåœ¨ä½æ•°æœ‰é™çš„æƒ…å†µä¸‹ï¼Œå®šç‚¹æ•°çš„å–å€¼èŒƒå›´å’Œç²¾åº¦éƒ½æ¯”è¾ƒå·®ã€‚äºæ˜¯å°±æœ‰äº† IEEE-754 æå‡ºçš„æµ®ç‚¹æ•°è¡¨ç¤ºæ³•ã€‚ æµ®ç‚¹æ•° æ‰€è°“â€œæµ®ç‚¹æ•°â€ï¼ˆFloating-point numbersï¼‰ï¼Œå³å°æ•°ç‚¹å¯ä»¥â€œæµ®åŠ¨â€ï¼Œå³å°æ•°ç‚¹çš„ä½ç½®ä¸æ˜¯å›ºå®šçš„ï¼Œè€Œæ˜¯å¯ä»¥æ ¹æ®æ•°å€¼çš„å¤§å°å’Œç²¾åº¦éœ€æ±‚ç§»åŠ¨çš„ã€‚è¿™ç§è¡¨ç¤ºæ³•å…è®¸åœ¨å¹¿æ³›çš„èŒƒå›´å†…è¡¨ç¤ºæ•°å€¼ï¼ŒåŒæ—¶ä¿æŒç›¸å¯¹æ’å®šçš„ç²¾åº¦ã€‚ åœ¨è®¡ç®—æœºä¸­ï¼Œæµ®ç‚¹æ•°é€šå¸¸éµå¾ª IEEE-754 æ ‡å‡†ã€‚è¿™ä¸ªæ ‡å‡†å®šä¹‰äº†æµ®ç‚¹æ•°çš„å­˜å‚¨å’Œè¿ç®—æ–¹å¼ï¼Œç¡®ä¿äº†ä¸åŒè®¡ç®—æœºç³»ç»Ÿä¹‹é—´çš„ä¸€è‡´æ€§ã€‚IEEE-754 ç”¨ä»¥ä¸‹å½¢å¼æ¥è¡¨ç¤ºä¸€ä¸ªæ•°ï¼š \\[ V = (-1)^sÃ—MÃ—2^E \\] å…¶ä¸­ï¼š s ç¬¦å·ä½ï¼ˆSign bitï¼‰ï¼šè¡¨ç¤ºæ•°å€¼çš„æ­£è´Ÿã€‚ M å°¾æ•°ï¼ˆMantissaï¼‰ï¼šè¡¨ç¤ºæ•°å€¼çš„æœ‰æ•ˆæ•°å­—ã€‚ E æŒ‡æ•°ï¼ˆExponentï¼‰ï¼šå†³å®šå°æ•°ç‚¹çš„ä½ç½®ã€‚ IEEE-754 å°†æµ®ç‚¹æ•°çš„ä½è¡¨ç¤ºåˆ’åˆ†æˆä¸‰ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«å¯¹å„ä¸ªéƒ¨åˆ†è¿›è¡Œç¼–ç ï¼Œå¯¹åº”ä¸Šé¢å…¬å¼å³è¾¹çš„ 3 ä¸ªå­—æ¯ï¼š ä¸€ä¸ªå•ç‹¬çš„ç¬¦å·ä½ s ç›´æ¥ç¼–ç ç¬¦å· sã€‚ \\(k\\) ä½çš„é˜¶ç å­—æ®µ \\(exp=e_{k-1}\\cdots e_1e_0\\) ç¼–ç é˜¶ç  Eã€‚ \\(n\\) ä½å°æ•°å­—æ®µ \\(frac=f_{n-1}\\cdots f_1f_0\\) ç¼–ç å°¾æ•° Mï¼Œä½†æ˜¯ç¼–ç å‡ºæ¥çš„å€¼ä¹Ÿä¾èµ–äºé˜¶ç å­—æ®µçš„å€¼æ˜¯å¦ç­‰äº 0ã€‚ åœ¨ IEEE-754 æ ‡å‡†ä¸­ï¼Œå®šä¹‰äº†ä¸¤ç§ç²¾åº¦çš„æµ®ç‚¹æ•°ï¼Œåˆ†åˆ«æ˜¯å•ç²¾åº¦æµ®ç‚¹æ•°ï¼ˆ32 ä½ï¼‰å’ŒåŒç²¾åº¦æµ®ç‚¹æ•°ï¼ˆ64 ä½ï¼‰ã€‚ å•ç²¾åº¦ï¼š 1 ä½ç¬¦å·ä½ s 8 ä½æŒ‡æ•° exp 23 ä½å°¾æ•° frac å•ç²¾åº¦æµ®ç‚¹æ•° åŒç²¾åº¦ï¼š 1 ä½ç¬¦å·ä½ s 11 ä½æŒ‡æ•° exp 52 ä½å°¾æ•° frac åŒç²¾åº¦æµ®ç‚¹æ•° æ ¹æ® exp çš„å€¼ï¼Œæµ®ç‚¹æ•°åˆå¯ä»¥åˆ†æˆä¸‰ç±»ï¼š è§„æ ¼åŒ–çš„ éè§„æ ¼åŒ–çš„ ç‰¹æ®Šçš„ å…¶ä¸­ç¬¬ä¸‰ç±»â€œç‰¹æ®Šçš„â€åˆå¯ä»¥æ ¹æ® frac åˆ†æˆä¸¤ç±»ï¼š æ— ç©·å¤§ ä¸æ˜¯ä¸€ä¸ªæ•° NaNï¼ˆNot a Numberï¼‰ å…·ä½“å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š exp frac è§„æ ¼åŒ–çš„ â‰ 0 â‰  255 f éè§„æ ¼åŒ–çš„ 0 f ç‰¹æ®Šçš„ 1 f - æ— ç©·å¤§ 1 0 - NaN 1 â‰ 0 å¯¹äºä¸åŒç±»å‹çš„æµ®ç‚¹æ•°ï¼Œåœ¨è®¡ç®—å…¬å¼ \\(V=(-1)^sÃ—MÃ—2^E\\) ä¸­ï¼Œexp - E å’Œ frac - M çš„æ–¹å¼æœ‰æ‰€ä¸åŒã€‚ ä¸‹é¢æˆ‘ä»¬æ¥å¯¹è¿™å‡ ç§ä¸åŒç±»å‹è¿›è¡Œè¯¦ç»†è®¨è®ºï¼Œå…¶ä¸­ä¸ä¹æœ‰ä¸€äº›å¾ˆæœ‰è¶£ä¸”å……æ»¡æ™ºæ…§çš„è®¾è®¡ç†å¿µã€‚ ç‰¹æ®Šå€¼ Special Values æŒ‡æ•°éƒ¨åˆ†ï¼šå…¨ä¸º 0ã€‚ å°¾æ•°éƒ¨åˆ†ï¼šå…¨ä¸º 0 åˆ™è¡¨ç¤ºæ— ç©·å¤§ï¼Œä¸å…¨ä¸º 0 åˆ™è¡¨ç¤º NaNã€‚ ä½œç”¨ï¼šç‰¹æ®Šå€¼ç”¨äºè¡¨ç¤ºé‚£äº›æ— æ³•ç”¨å¸¸è§„æ•°å€¼è¡¨ç¤ºçš„æƒ…å†µï¼Œå¦‚æ— ç©·å¤§ã€éæ•°ï¼ˆNaNï¼‰ç­‰ã€‚è¿™äº›å€¼é€šå¸¸ç”¨äºæ“ä½œçš„é”™è¯¯æˆ–ç‰¹æ®Šæƒ…å†µçš„ç»“æœï¼Œå¦‚é™¤ä»¥ 0ã€æ— æ•ˆæ“ä½œç­‰ã€‚ è§„æ ¼åŒ–çš„å€¼ Normalize Values æŒ‡æ•°éƒ¨åˆ†ï¼šä¸å…¨ä¸º 0 ä¸”ä¸å…¨ä¸º 1ã€‚ å°¾æ•°éƒ¨åˆ†ï¼šå¯ä»¥æ˜¯ä»»æ„å€¼ã€‚ ä½œç”¨ï¼šç”¨äºè¡¨ç¤ºå¤§å¤šæ•°éé›¶æ•°å€¼ åœ¨è§„æ ¼åŒ–å€¼ä¸­ï¼š \\(E=e-bias\\) \\(M=1+f\\) å…¶ä¸­ e å³ä¸º expï¼Œï¼Œbias æ˜¯åç½®é‡ï¼Œå®ƒçš„å€¼ä¸º \\(2^{k-1} -1\\)ï¼Œå…¶ä¸­ k ä¸º exp çš„ä½æ•°ï¼Œæ•…ï¼š åœ¨å•ç²¾åº¦ä¸­ï¼Œ\\(bias=2^{8-1}-1=2^7-1=128-1=127\\) åœ¨åŒç²¾åº¦ä¸­ï¼Œ\\(bias=2^{11-1}-1=2^{10}-1=1024-1=1023\\) å…¶ä¸­ f ä¸º frac è¡¨ç¤ºçš„æ•°ï¼ŒèŒƒå›´ \\(0â‰¤f1\\)ã€‚ æ‰€ä»¥ä¸€ä¸ªè§„æ ¼åŒ–æ•°ï¼Œå…·ä½“å¯ä»¥è¡¨ç¤ºä¸ºï¼š \\[ V=(-1)^{sign}Ã—1.fracÃ—2^{(exp-bias)} \\] è¿™é‡Œæœ‰ 4 ä¸ªé—®é¢˜ï¼š è¿™ä¸ª bias æ˜¯ä»€ä¹ˆï¼Ÿ ä¸ºä»€ä¹ˆ E è¦ e å»å‡æ‰ä¸€ä¸ª biasï¼Ÿ bias çš„å€¼æ˜¯æ€ä¹ˆå®šä¸‹çš„ï¼Œå¦‚å•ç²¾åº¦ä¸ºä»€ä¹ˆæ˜¯ 127ï¼Œä¸æ˜¯ 126 æˆ– 128ï¼Ÿ M ä¸ºä»€ä¹ˆéœ€è¦ f å»åŠ ä¸Šä¸€ä¸ª 1ï¼Ÿ ä¸‹é¢æˆ‘ä»¬æ¥å¯¹è¿™ 4 ä¸ªé—®é¢˜è¿›è¡Œä¸€ä¸€è§£ç­”ã€‚ ç¬¬ 1 ä¸ªé—®é¢˜ï¼Œè¿™ä¸ª bias æ˜¯ä»€ä¹ˆï¼Ÿ bias æ˜¯ä¸€ä¸ªé¢„è®¾çš„åç§»é‡ï¼Œç”¨äºå°†æŒ‡æ•°éƒ¨åˆ†çš„å€¼åç§»åˆ°å…¨æ­£æ•°ï¼Œä»è€Œç®€åŒ–å¤„ç†ã€‚ ç¬¬ 2 ä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆ E è¦ e å»å‡å»ä¸€ä¸ª biasï¼Ÿ å…ˆè¯´ç»“è®ºï¼šä½¿ç”¨ biasï¼ˆåç½®æŒ‡æ•°ï¼Œbiased exponentï¼‰å¯ä»¥å…è®¸æµ®ç‚¹æ•°ä»¥ç»Ÿä¸€çš„æ–¹å¼è¡¨ç¤ºï¼ŒåŒæ—¶ä¹Ÿä½¿å¾—æµ®ç‚¹æ•°çš„æ’åºå’Œæ¯”è¾ƒå˜å¾—ç®€å•ã€‚ é¦–å…ˆæŒ‡æ•°è‚¯å®šå¾—æ”¯æŒæ­£è´Ÿå½¢å¼çš„å‡ºç°ï¼Œé‚£ä¹ˆç›´æ¥ä½¿ç”¨æ— ç¬¦å·æ•´å‹æ¥è¡¨ç¤ºæŒ‡æ•°è‚¯å®šæ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºå®ƒæ— æ³•è¡¨ç¤ºè´ŸæŒ‡æ•°ã€‚æš‚æ—¶å…ˆæŠ›å¼€ IEEE-754 å®šä¸‹çš„æ ‡å‡†ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•ç”¨è¡¥ç æ¥è¡¨ç¤ºæŒ‡æ•°ã€‚ å‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ª 32 ä½çš„æµ®ç‚¹æ•° A å’Œ Bï¼Œå¹¶ä¸”æˆ‘ä»¬å‡è®¾å®ƒä»¬çš„æŒ‡æ•°éƒ¨åˆ†ä½¿ç”¨ 8 ä½äºŒè¿›åˆ¶è¡¥ç è¡¨ç¤ºï¼ˆè¿™ä¸ IEEE-754 æ ‡å‡†ä¸åŒï¼‰ã€‚ A çš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼š0 0000010 00000000000000000000000 B çš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼š0 1111110 00000000000000000000000 åœ¨è¿™é‡Œï¼Œç¬¬ä¸€ä½æ˜¯ç¬¦å·ä½ï¼ˆ0 è¡¨ç¤ºæ­£æ•°ï¼‰ï¼Œæ¥ä¸‹æ¥çš„ 8 ä½æ˜¯ä»¥è¡¥ç å½¢å¼è¡¨ç¤ºçš„æŒ‡æ•°ï¼Œå‰©ä¸‹çš„ 23 ä½æ˜¯å°¾æ•°ã€‚ æˆ‘ä»¬æƒ³è¦æ¯”è¾ƒè¿™ä¸¤ä¸ªæ•°çš„å¤§å°ï¼Œéœ€è¦æ€ä¹ˆåšå‘¢ï¼Ÿ æˆ‘ä»¬å…ˆè§£æè¿™ 2 ä¸ªæ•°ï¼š ç¬¦å·ä½ï¼šå¯¹äº A å’Œ Bï¼Œç¬¦å·ä½éƒ½æ˜¯ 0ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸¤ä¸ªæ­£æ•°ã€‚ æŒ‡æ•°éƒ¨åˆ†ï¼ˆä½¿ç”¨è¡¥ç è¡¨ç¤ºï¼‰ A çš„æŒ‡æ•°ä¸º 0000010ï¼Œè§£è¯»ä¸ºæ­£æ•° +2ã€‚ B çš„æŒ‡æ•°ä¸º 1111110ï¼Œåœ¨è¡¥ç è¡¨ç¤ºä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ªè´Ÿæ•°ã€‚å…ˆåŠ å–åååŠ  1 è½¬æ¢ä¸ºæ­£æ•° 00000010ï¼Œå®ƒè¡¨ç¤º -2ã€‚ è¦æ¯”è¾ƒè¿™ 2 ä¸ªæ•°ï¼š å½“æˆ‘ä»¬æ¯”è¾ƒ A å’Œ B æ—¶ï¼Œé¦–å…ˆéœ€è¦è€ƒè™‘å®ƒä»¬çš„æŒ‡æ•°ã€‚ æŒ‡æ•° A ä¸º +2ï¼Œè€Œ B ä¸º -2ã€‚å³ä½¿å®ƒä»¬çš„å°¾æ•°éƒ¨åˆ†ç›¸åŒï¼ˆåœ¨è¿™ä¸ªä¾‹å­ä¸­éƒ½æ˜¯ 0ï¼‰ï¼ŒA çš„å®é™…å€¼è¦å¤§äº Bï¼Œå› ä¸ºæ­£æŒ‡æ•°è¡¨ç¤ºçš„æ•°å€¼èŒƒå›´è¿œå¤§äºè´ŸæŒ‡æ•°ã€‚ å¯ä»¥çœ‹å‡ºï¼šä½¿ç”¨è¡¥ç è¡¨ç¤ºæŒ‡æ•°å¢åŠ äº†æ¯”è¾ƒè¿‡ç¨‹çš„å¤æ‚æ€§ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦è§£è¯»è¡¥ç å¹¶è€ƒè™‘å…¶æ­£è´Ÿã€‚ç‰¹åˆ«æ˜¯åœ¨æ¶‰åŠåˆ°è´ŸæŒ‡æ•°çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸èƒ½ä»…ä»…æ¯”è¾ƒäºŒè¿›åˆ¶è¡¨ç¤ºçš„å¤§å°ï¼Œè€Œå¿…é¡»å°†è¡¥ç è½¬æ¢ä¸ºå®é™…çš„æ•°å€¼ï¼Œç„¶åå†è¿›è¡Œæ¯”è¾ƒã€‚ ç°åœ¨å›è¿‡å¤´æ¥çœ‹çœ‹ IEEE-754 çš„è®¾è®¡ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªå•ç²¾åº¦ï¼ˆ32 ä½ï¼‰æµ®ç‚¹æ•° A å’Œ Bï¼š A çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸ºï¼š0 10000010 00000000000000000000000 B çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸ºï¼š0 01111110 00000000000000000000000 è§£æè¿™ä¸¤ä¸ªæ•°ï¼š Aï¼šç¬¦å·ä½ä¸º 0ï¼ˆæ­£æ•°ï¼‰ï¼ŒæŒ‡æ•°éƒ¨åˆ†ä¸º 10000010ï¼ˆäºŒè¿›åˆ¶ï¼Œå¯¹åº”åè¿›åˆ¶çš„ 130ï¼‰ï¼Œå°¾æ•°éƒ¨åˆ†ä¸ºå…¨ 0ã€‚ Bï¼šç¬¦å·ä½ä¸º 0ï¼ˆæ­£æ•°ï¼‰ï¼ŒæŒ‡æ•°éƒ¨åˆ†ä¸º 01111110ï¼ˆäºŒè¿›åˆ¶ï¼Œå¯¹åº”åè¿›åˆ¶çš„ 126ï¼‰ï¼Œå°¾æ•°éƒ¨åˆ†ä¸ºå…¨ 0ã€‚ è®¡ç®—å®é™…æŒ‡æ•°å€¼ï¼šå•ç²¾åº¦æµ®ç‚¹æ•°çš„åç½®å€¼ bias ä¸º 127ï¼Œæ•…ï¼š A çš„å®é™…æŒ‡æ•° E = 130 - 127 = 3ã€‚ B çš„å®é™…æŒ‡æ•° E = 126 - 127 = -1ã€‚ æ¯”è¾ƒè¿™ä¸¤ä¸ªæ•°ï¼š åœ¨å‡å» bias åï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ¯”è¾ƒæŒ‡æ•°éƒ¨åˆ†çš„äºŒè¿›åˆ¶è¡¨ç¤ºæ¥ç¡®å®šæ•°å€¼çš„å¤§å°ã€‚ ç”±äº 10000010ï¼ˆ130ï¼‰å¤§äº 01111110ï¼ˆ126ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç›´æ¥å¾—å‡º A å¤§äº Bï¼Œè€Œæ— éœ€è€ƒè™‘è´ŸæŒ‡æ•°çš„å¤æ‚è¡¨ç¤ºé—®é¢˜ã€‚ è¿™ä¸ªä¾‹å­è¯´æ˜äº†é€šè¿‡å‡å»åç½®å€¼ï¼ŒIEEE-754 æ ‡å‡†èƒ½å¤Ÿç®€åŒ–æµ®ç‚¹æ•°çš„æ¯”è¾ƒå’Œæ’åºæ“ä½œã€‚åç½®åçš„æŒ‡æ•°è¡¨ç¤ºæ–¹æ³•å…è®¸è®¡ç®—æœºä»¥ç»Ÿä¸€å’Œé«˜æ•ˆçš„æ–¹å¼å¤„ç†æµ®ç‚¹æ•°ï¼Œæ— è®ºå®ƒä»¬çš„å®é™…æ•°å€¼å¤§å°å¦‚ä½•ã€‚ ç¬¬ 3 ä¸ªé—®é¢˜ï¼šbias çš„å€¼æ˜¯æ€ä¹ˆå®šä¸‹çš„ï¼Œå¦‚å•ç²¾åº¦ä¸ºä»€ä¹ˆæ˜¯ 127ï¼Œè€Œä¸æ˜¯ 126 æˆ– 128ï¼Ÿ bias å€¼çš„é€‰æ‹©ï¼Œæ˜¯ä¸ºäº†å¹³è¡¡æ­£è´ŸæŒ‡æ•°çš„è¡¨ç¤ºèŒƒå›´ï¼Œå¹¶ä¸”å……åˆ†åˆ©ç”¨æŒ‡æ•°éƒ¨åˆ†çš„å­˜å‚¨ç©ºé—´ã€‚ ä»¥å•ç²¾åº¦ä¸ºä¾‹ï¼Œexp å äº† 8 ä½ï¼Œ8 ä½äºŒè¿›åˆ¶å¯ä»¥è¡¨ç¤ºçš„å€¼çš„èŒƒå›´æ˜¯ \\([0,255]\\)ã€‚å¦‚æœæˆ‘ä»¬é€‰æ‹© 127 ä½œä¸º biasï¼Œåˆ™å­˜å‚¨çš„æŒ‡æ•°èŒƒå›´å°±æ˜¯ \\([-127,128]\\)ã€‚è¿™æ ·å¯ä»¥ä½¿å¾—æŒ‡æ•°éƒ¨åˆ†å¯ä»¥å‡åŒ€åœ°è¡¨ç¤ºä»è´Ÿå¤§æ•°åˆ°æ­£å¤§æ•°çš„èŒƒå›´ï¼ˆå¯¹ç§°ï¼‰ã€‚ åœ¨ IEEE-754 æ ‡å‡†ä¸­ï¼Œå…¨ 0 çš„æŒ‡æ•°è¡¨ç¤ºä¸ºéè§„æ ¼åŒ–æ•°æˆ– 0ï¼Œè€Œå…¨ 1 çš„æŒ‡æ•°ç”¨äºè¡¨ç¤ºæ— ç©·å¤§æˆ– NaNï¼‰ã€‚é€‰æ‹© 127 ä½œä¸º bias å¯ä»¥åœ¨ä¿ç•™è¿™äº›ç‰¹æ®Šå€¼çš„åŒæ—¶ï¼Œæä¾›æœ€å¤§çš„æœ‰æ•ˆæŒ‡æ•°èŒƒå›´ã€‚ ç¬¬ 4 ä¸ªé—®é¢˜ï¼šM ä¸ºä»€ä¹ˆéœ€è¦ f å»åŠ ä¸Šä¸€ä¸ª 1ï¼Ÿ åœ¨è§„æ ¼åŒ–æ•°ä¸­éšå«æœ€é«˜ä½ 1 æ˜¯ä¸ºäº†æé«˜å°¾æ•°éƒ¨åˆ†çš„è¡¨ç¤ºæ•ˆç‡ï¼Œä»è€Œå¢åŠ ç²¾åº¦ã€‚ å…¶å®è¿™è·Ÿç§‘å­¦è®¡æ•°æ³•çš„å¾ˆåƒçš„ï¼Œä¸ºäº†ç¡®ä¿æµ®ç‚¹æ•°è¡¨ç¤ºçš„å”¯ä¸€æ€§ï¼ŒIEEE-754 è§„å®šè§„æ ¼åŒ–æµ®ç‚¹æ•°æœ€é«˜ä½ä¸€å®šæ˜¯éé›¶çš„ã€‚å¦‚æœä¸è§„å®šæœ€é«˜ä½éé›¶ï¼ŒåŒä¸€ä¸ªæ•°å¯ä»¥æœ‰å¤šç§ä¸åŒçš„æµ®ç‚¹è¡¨ç¤ºï¼Œä¾‹å¦‚ï¼Œåœ¨äºŒè¿›åˆ¶ä¸­ 0.5 å¯ä»¥è¡¨ç¤ºä¸º \\(1.0Ã—2^{-1}\\)ï¼Œä¹Ÿå¯ä»¥è¡¨ç¤ºä½ \\(0.1Ã—2^0\\) æˆ– \\(0.01Ã—2^1\\) ç­‰ç­‰ã€‚è¿™ç§å¤šé‡è¡¨ç¤ºä¼šä½¿æµ®ç‚¹è¿ç®—å˜å¾—å¤æ‚ä¸”ä½æ•ˆã€‚ é‚£æ—¢ç„¶æœ€é«˜ä½æ€»æ˜¯ 1ï¼Œé‚£å°±æ²¡å¿…è¦æ˜¾ç¤ºå­˜å‚¨äº†ï¼Œè¿˜å¯ä»¥ä½¿å°¾æ•°éƒ¨åˆ†ä¸­å¤š 1 ä½çš„å­˜å‚¨ç©ºé—´ï¼Œä»è€Œå…è®¸å­˜å‚¨æ›´å¤šçš„æœ‰æ•ˆæ•°å­—ï¼Œä»¥æé«˜ç²¾åº¦ã€‚ éè§„æ ¼åŒ–çš„å€¼ Denormalized Values æŒ‡æ•°éƒ¨åˆ†ï¼šå…¨ä¸º 0ã€‚ å°¾æ•°éƒ¨åˆ†ï¼šå¯ä»¥æ˜¯ä»»æ„å€¼ã€‚ ä½œç”¨ï¼š æä¾›è¡¨ç¤ºæ•°å€¼ 0 çš„æ–¹æ³•ã€‚å› ä¸ºè§„æ ¼åŒ–ä¸­ \\(Mâ‰¥1\\)ï¼Œæ‰€ä»¥æ— æ³•è¡¨ç¤º 0ã€‚ ç”¨äºè¡¨ç¤ºéå¸¸æ¥è¿‘äº 0 çš„æ•°å€¼ï¼Œè¿™äº›æ•°å€¼å¤ªå°ï¼Œæ— æ³•ç”¨è§„æ ¼åŒ–æ ¼å¼è¡¨ç¤ºã€‚å®ƒä»¬å¡«è¡¥äº† 0 å’Œæœ€å°è§„æ ¼åŒ–æ­£æ•°ä¹‹é—´çš„é—´éš™ï¼Œæä¾›äº†æ¸è¿‘äº 0 çš„è¿ç»­è¡¨ç¤ºï¼Œé˜²æ­¢äº†æ‰€è°“çš„â€œä¸‹æº¢â€ã€‚ åœ¨éè§„æ ¼åŒ–å€¼ä¸­ï¼š \\(E=1-bias\\) \\(M=f\\) æ‰€ä»¥ä¸€ä¸ªè§„æ ¼åŒ–æ•°ï¼Œå…·ä½“å¯ä»¥è¡¨ç¤ºä¸ºï¼š \\[ V=(-1)^{sign}Ã—0.fracÃ—2^{(1-bias)} \\] é‚£è¿™é‡Œåˆæœ‰ 2 ä¸ªé—®é¢˜äº†ï¼š ä¸ºä»€ä¹ˆæŒ‡æ•°éƒ¨åˆ†ä¸æ˜¯ \\(0-bias\\) è€Œæ˜¯ \\(1-bias\\)ï¼Ÿ ä¸ºä»€ä¹ˆ M ä¸éœ€è¦éšå«çš„ 1 äº†ï¼Ÿ ç¬¬ 1 ä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆæŒ‡æ•°éƒ¨åˆ†ä¸æ˜¯ 0-bias è€Œæ˜¯ 1-biasï¼Ÿ è¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„è®¾è®¡ï¼Œæ—¨åœ¨ä½¿éè§„æ ¼åŒ–æ•°èƒ½å¤Ÿå¹³æ»‘åœ°è¿æ¥åˆ°è§„æ ¼åŒ–æ•°çš„æœ€å°æ­£å€¼ã€‚ æœ€å°çš„è§„æ ¼åŒ–æ•°çš„æŒ‡æ•°ä¸º 1 - biasã€‚ä¸ºäº†åœ¨æ•°å€¼ä¸Šå¹³æ»‘åœ°è¿‡æ¸¡åˆ°éè§„æ ¼åŒ–æ•°ï¼Œéè§„æ ¼åŒ–æ•°çš„å®é™…æŒ‡æ•°ä¹Ÿè¢«è®¾å®šä¸º 1 - biasã€‚è¿™æ ·ï¼Œéè§„æ ¼åŒ–æ•°å°±å¯ä»¥ä»£è¡¨é‚£äº›å°äºæœ€å°è§„æ ¼åŒ–æ­£æ•°çš„æ•°å€¼ï¼Œè€Œä¸ä¼šå‡ºç°ä¸€ä¸ªæ•°å€¼çš„â€œé—´éš™â€ã€‚ ç¬¬ 2 ä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆ M ä¸éœ€è¦éšå«çš„ 1 äº†ï¼Ÿ ä¸åŒ…å«éšå«çš„ 1 ä½¿å¾—éè§„æ ¼åŒ–æ•°èƒ½å¤Ÿåœ¨æµ®ç‚¹æ•°è¡¨ç¤ºä¸­å¡«è¡¥ 0 å’Œæœ€å°è§„æ ¼åŒ–æ•°ä¹‹é—´çš„ç©ºéš™ï¼Œæä¾›å¯¹æå°æ•°å€¼çš„è¿ç»­è¡¨ç¤ºã€‚ é¿å…ä¸‹æº¢ï¼šéè§„æ ¼åŒ–æ•°é€šè¿‡å…è®¸å°¾æ•°éƒ¨åˆ†ä¸ä»¥éšå«çš„ 1 å¼€å§‹ï¼ˆè€Œæ˜¯ä»¥æ˜¾å¼çš„ 0 å¼€å§‹ï¼‰ï¼Œä½¿å¾—å®ƒä»¬å¯ä»¥è¡¨ç¤ºæ¯”æœ€å°è§„æ ¼åŒ–æ•°è¿˜è¦å°çš„æ•°å€¼ã€‚è¿™å¯¹äºé¿å…æ•°å€¼ä¸‹æº¢è‡³ 0 éå¸¸é‡è¦ï¼Œå°¤å…¶æ˜¯åœ¨ç´¯ç§¯äº†å¤šæ¬¡è¿ç®—åçš„åœºåˆã€‚ ç²¾åº¦ç‰ºç‰²ï¼šä½¿ç”¨éè§„æ ¼åŒ–æ•°çš„ä»£ä»·æ˜¯ç‰ºç‰²äº†ä¸€äº›ç²¾åº¦ã€‚ç”±äºæ²¡æœ‰éšå«çš„æœ€é«˜ä½ 1ï¼Œéè§„æ ¼åŒ–æ•°çš„ç²¾åº¦è¾ƒä½ã€‚ä½†è¿™æ˜¯ä¸ºäº†åœ¨éå¸¸å°çš„æ•°å€¼èŒƒå›´å†…æä¾›æ•°å€¼çš„è¿ç»­æ€§æ‰€åšçš„å¿…è¦å¦¥åã€‚ æ€»ç»“ è§„æ ¼åŒ–å€¼ã€éè§„æ ¼åŒ–å€¼å’Œç‰¹æ®Šå€¼ä¸‰ç§ç±»å‹å…±åŒæ„æˆäº† IEEE-754 æµ®ç‚¹æ•°æ ‡å‡†çš„å®Œæ•´è¡¨ç¤ºä½“ç³»ï¼Œä½¿å¾—æµ®ç‚¹æ•°èƒ½å¤Ÿåœ¨è®¡ç®—æœºä¸­æœ‰æ•ˆä½å¤„ç†ä»éå¸¸å°åˆ°éå¸¸å¤§çš„æ•°å€¼èŒƒå›´ï¼ŒåŒæ—¶è¿˜èƒ½åº”å¯¹ç‰¹æ®Šçš„è®¡ç®—æƒ…å†µã€‚ ä¸¾ä¾‹ å‚è€ƒã€Šæ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿã€‹ï¼Œæˆ‘ä»¬ä»¥ 8 ä½æµ®ç‚¹æ•°ä¸ºä¾‹ï¼Œå…¶ä¸­ï¼š 1 ä½ç¬¦å· s 4 ä½æŒ‡æ•° exp 3 ä½å°¾æ•° frac å¯ä»¥ç®—å‡º \\(bias=2^{4-1}-1=2^3-1=8-1=7\\)ã€‚ 8 ä½æµ®ç‚¹æ•°ï¼ˆâ‰¥0éƒ¨åˆ†ï¼‰ å…¶ä¸­é è¿‘ 0 çš„æ˜¯éè§„æ ¼åŒ–å€¼ï¼š 8 ä½æµ®ç‚¹æ•° - éè§„æ ¼åŒ–å€¼ ä»¥ 0 0000 001 ä¸ºä¾‹ï¼š \\[ V = (-1)^sÃ—MÃ—2^E \\\\ = (-1)^sÃ—0.fracÃ—2^{1-bias} \\\\ = (-1)^0Ã—(0+(1/8))Ã—2^{1-7} \\\\ = 1Ã—1/8Ã—2^{-6} \\\\ =2^{(-9)} \\\\ = 1/512 \\] å†å¾€ä¸‹ï¼Œå°±æ˜¯è§„æ ¼åŒ–å€¼ï¼š 8 ä½æµ®ç‚¹æ•° - è§„æ ¼åŒ–å€¼ ä»¥ 0 0110 110 ä¸ºä¾‹ï¼š \\[ V = (-1)^sÃ—MÃ—2^E \\\\ = (-1)^sÃ—1.fracÃ—2^{e-bias} \\\\ = (-1)^0Ã—(1+6/8)Ã—2^{6-7} \\\\ =1Ã—14/8Ã—2^{-1} \\\\ = 14/16 \\\\ =7/8 \\] æ•´å‹è½¬ä¸ºæµ®ç‚¹å‹ ä¸‹é¢ä»¥ä¸€ä¸ªä¾‹å­æ¥ç›´è§‚æ„Ÿå—ä¸€ä¸‹ä¸€ä¸ªæ•´å‹æ˜¯å¦‚ä½•è½¬ä¸ºæµ®ç‚¹å‹çš„ã€‚ ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ª int32 çš„æ•´å‹ 123ï¼Œæˆ‘ä»¬å¸Œæœ›å°†å…¶è½¬ä¸ºå•ç²¾åº¦æµ®ç‚¹å‹ 123.0ã€‚ 1. å°†æ•´å‹ç”¨äºŒè¿›åˆ¶è¡¨ç¤ºå‡ºæ¥ \\[ 12345_{(10)} = 1111011_{(2)} \\] 2. è§„èŒƒåŒ–è¡¨ç¤º \\[ 1111011= 1.111011Ã—2^6 \\] 3. è®¡ç®—æŒ‡æ•° \\[ exp = 6 + 127 = 133_{(10)} = 10000101_{(2)} \\] 4. ç¡®å®šå°¾æ•°** è¿™æ˜¯ä¸ªè§„èŒƒåŒ–å€¼ï¼Œæ‰€ä»¥ 1.frac çš„ 1 çœç•¥ï¼Œåˆå› ä¸ºå•ç²¾åº¦æµ®ç‚¹æ•° frac å  23 ä½ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ 111011 åé¢å†å¡« 17 ä¸ª 0ï¼Œå³ï¼š \\[ frac = 111011 0000 0000 0000 0000 0 \\] 5. ç¡®å®šç¬¦å·ä½ \\[ s = 0_{(2)} \\] 6. ç»„åˆèµ·æ¥ 12345.0 = 0 10000101 11101100000000000000000 æµ®ç‚¹æ•°èˆå…¥ ç”±äºæµ®ç‚¹æ•°çš„è¡¨ç¤ºå…·æœ‰å›ºå®šçš„ç²¾åº¦ï¼Œåœ¨è¿›è¡Œè¿ç®—æˆ–è¡¨ç¤ºæ—¶ï¼Œç»å¸¸ä¼šé‡åˆ°æ— æ³•ç²¾ç¡®è¡¨ç¤ºçš„æ•°å€¼ï¼Œè¿™å°±éœ€è¦é‡‡ç”¨èˆå…¥æ–¹æ³•æ¥è¿‘ä¼¼è¡¨ç¤ºè¿™äº›æ•°å€¼ã€‚IEEE-754 æ ‡å‡†å®šä¹‰äº†å‡ ç§ä¸åŒçš„èˆå…¥æ¨¡å¼ï¼Œä»¥é€‚åº”ä¸åŒçš„è®¡ç®—éœ€æ±‚ã€‚ èˆå…¥æ¨¡å¼ æœ€è¿‘èˆå…¥ï¼ˆRound to Nearestï¼‰: è¿™æ˜¯æœ€å¸¸ç”¨çš„èˆå…¥æ¨¡å¼ï¼Œä¹Ÿæ˜¯é»˜è®¤çš„æ¨¡å¼ã€‚ è§„åˆ™æ˜¯å‘æœ€æ¥è¿‘çš„å¯è¡¨ç¤ºå€¼èˆå…¥ã€‚å¦‚æœç²¾ç¡®ç»“æœä½äºä¸¤ä¸ªå¯è¡¨ç¤ºå€¼çš„ä¸­ç‚¹ï¼Œé€šå¸¸èˆå…¥åˆ°æœ€è¿‘çš„å¶æ•°ï¼ˆå³å°¾æ•°çš„æœ€åä¸€ä½ä¸º 0ï¼‰ã€‚ è¿™ç§æ–¹æ³•å‡å°‘äº†ç´¯ç§¯è¯¯å·®ï¼Œç¡®ä¿äº†åœ¨å¤šæ¬¡è¿ç®—åçš„æ€»ä½“ç²¾åº¦ã€‚ å‘é›¶èˆå…¥ï¼ˆRound Toward Zeroï¼‰: è¿™ç§æ¨¡å¼æ€»æ˜¯èˆå…¥åˆ°é›¶çš„æ–¹å‘ï¼Œå³èˆå»å°æ•°éƒ¨åˆ†ã€‚ å¯¹äºæ­£æ•°ï¼Œè¿™ç›¸å½“äºå–ä¸‹é™ï¼Œå¯¹äºè´Ÿæ•°ï¼Œç›¸å½“äºå–ä¸Šé™ã€‚ å‘ä¸Šèˆå…¥ï¼ˆRound Upï¼‰: æ— è®ºæ­£è´Ÿï¼Œéƒ½å‘è¿œç¦»é›¶çš„æ–¹å‘èˆå…¥ã€‚ å¯¹äºæ­£æ•°ï¼Œèˆå…¥åçš„å€¼ä¸å°äºåŸå€¼ï¼›å¯¹äºè´Ÿæ•°ï¼Œèˆå…¥åçš„å€¼ä¸å¤§äºåŸå€¼ã€‚ å‘ä¸‹èˆå…¥ï¼ˆRound Downï¼‰: æ— è®ºæ­£è´Ÿï¼Œéƒ½å‘æ¥è¿‘é›¶çš„æ–¹å‘èˆå…¥ã€‚ å¯¹äºæ­£æ•°ï¼Œèˆå…¥åçš„å€¼ä¸å¤§äºåŸå€¼ï¼›å¯¹äºè´Ÿæ•°ï¼Œèˆå…¥åçš„å€¼ä¸å°äºåŸå€¼ã€‚ èˆå…¥çš„å½±å“ ç²¾åº¦æŸå¤±ï¼šç”±äºå›ºå®šçš„å°¾æ•°ä½æ•°ï¼Œèˆå…¥å¯èƒ½å¯¼è‡´ç²¾åº¦çš„æŸå¤±ã€‚ èˆå…¥è¯¯å·®ï¼šèˆå…¥æ“ä½œæœ¬èº«å¯èƒ½å¼•å…¥è¯¯å·®ï¼Œè¿™äº›è¯¯å·®åœ¨è¿ç»­è¿ç®—ä¸­å¯èƒ½ä¼šç´¯ç§¯ã€‚ é€‰æ‹©åˆé€‚çš„èˆå…¥æ¨¡å¼ï¼šä¸åŒçš„èˆå…¥æ¨¡å¼é€‚åˆä¸åŒçš„åº”ç”¨åœºæ™¯ã€‚ä¾‹å¦‚ï¼Œé‡‘èè®¡ç®—å¯èƒ½æ›´å€¾å‘äºä½¿ç”¨å‘é›¶èˆå…¥ï¼Œè€Œç§‘å­¦è®¡ç®—é€šå¸¸ä½¿ç”¨æœ€è¿‘èˆå…¥ä»¥å‡å°‘ç´¯ç§¯è¯¯å·®ã€‚ å®ä¾‹ Mode 1.40 1.60 1.50 2.50 -1.50 æœ€è¿‘èˆå…¥ 1 2 2 2 -2 å‘é›¶èˆå…¥ 1 1 1 2 -1 å‘ä¸Šèˆå…¥ 2 2 2 3 -1 å‘ä¸‹èˆå…¥ 1 1 1 2 -2 æµ®ç‚¹æ•°è¿ç®— å› ä¸ºæµ®ç‚¹æ•°æœ¬èº«å°±å­˜åœ¨ç²¾åº¦é—®é¢˜ï¼Œæ‰€ä»¥æµ®ç‚¹æ•°è¿ç®—åœ¨è®¡ç®—æœºä¸­æ˜¯ä¸€ä¸ªè¿‘ä¼¼è¿‡ç¨‹ï¼Œæ¶‰åŠåˆ°ç²¾ç¡®åº¦çš„æƒè¡¡ã€ç‰¹æ®Šå€¼çš„å¤„ç†ã€é”™è¯¯çš„ä¼ æ’­ï¼Œä»¥åŠèˆå…¥è§„åˆ™çš„åº”ç”¨ã€‚ æµ®ç‚¹æ•°åŠ å‡ æµ®ç‚¹æ•°åŠ æ³•å’Œå‡æ³•é¦–å…ˆéœ€è¦å¯¹æ“ä½œæ•°è¿›è¡Œå¯¹é½ï¼Œä½¿å¾—å®ƒä»¬çš„æŒ‡æ•°ç›¸åŒã€‚è¿™å¯èƒ½æ¶‰åŠå°†å°¾æ•°çš„äºŒè¿›åˆ¶è¡¨ç¤ºå‘å³ç§»ä½ï¼Œå¯èƒ½å¯¼è‡´ç²¾åº¦æŸå¤±ã€‚ ç„¶åæ‰§è¡ŒåŠ æ³•æˆ–å‡æ³•æ“ä½œã€‚ å¯¹ç»“æœè¿›è¡Œè§„èŒƒåŒ–å’Œèˆå…¥ã€‚ æ³¨æ„ï¼Œæµ®ç‚¹æ•°çš„åŠ å‡æ³•ä¸æ»¡è¶³ç»“åˆå¾‹ã€äº¤æ¢å¾‹å’Œåˆ†é…å¾‹ï¼Œè¿™ä½ ç®€å•åˆ†æä¸‹åº”è¯¥å°±å¯ä»¥ç†è§£äº†ï¼Œè¿™é‡Œä¸èµ˜è¿°äº†ã€‚ å‡è®¾æˆ‘ä»¬è¦åœ¨å•ç²¾åº¦æµ®ç‚¹æ•°æ ¼å¼ä¸‹è®¡ç®—ï¼š \\[ 12.375 + 0.1 = ? \\] ç¬¬ 1 æ­¥ï¼šè½¬ä¸ºäºŒè¿›åˆ¶è¡¨ç¤º å…¶ä¸­ 12.375 æˆ‘ä»¬å¯ä»¥ç”¨äºŒè¿›åˆ¶ç²¾ç¡®è¡¨ç¤ºï¼š \\[ 12.375_{(10)} = 1100.011_{(2)} \\] è€Œ 0.1 å°±æ¯”è¾ƒç‰¹æ®Šäº†ï¼Œç”¨äºŒè¿›åˆ¶è¡¨ç¤ºçš„è¯å®ƒä¼šæ— é™å¾ªç¯ã€‚ å°†åè¿›åˆ¶å°æ•°è½¬æ¢ä¸ºäºŒè¿›åˆ¶è¡¨ç¤ºæ¶‰åŠåˆ°é‡å¤ä¹˜ä»¥ 2 çš„è¿‡ç¨‹ï¼Œå¹¶æå–æ¯æ¬¡ä¹˜æ³•åæ•´æ•°éƒ¨åˆ†ä½œä¸ºäºŒè¿›åˆ¶ä½ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯ä¸€ä¸ªä¸æ–­é‡å¤çš„è¿‡ç¨‹ï¼Œç›´åˆ°å°æ•°éƒ¨åˆ†å˜ä¸º 0 æˆ–å¼€å§‹å¾ªç¯ã€‚ å– 0.1 çš„å°æ•°éƒ¨åˆ†ä¹˜ä»¥ 2ï¼ˆå³ 0.1 Ã— 2 = 0.2ï¼‰ï¼Œæ•´æ•°éƒ¨åˆ†æ˜¯ 0ï¼Œå°æ•°éƒ¨åˆ†æ˜¯ 0.2ã€‚ å†æ¬¡å–å°æ•°éƒ¨åˆ†ä¹˜ä»¥ 2ï¼ˆå³ 0.2 Ã— 2 = 0.4ï¼‰ï¼Œæ•´æ•°éƒ¨åˆ†æ˜¯ 0ï¼Œå°æ•°éƒ¨åˆ†æ˜¯ 0.4ã€‚ ç»§ç»­è¿™ä¸ªè¿‡ç¨‹ï¼Œæˆ‘ä»¬å¾—åˆ°ä»¥ä¸‹åºåˆ—ï¼š 0.4 Ã— 2 = 0.8 â†’ æ•´æ•°éƒ¨åˆ† 0 0.8 Ã— 2 = 1.6 â†’ æ•´æ•°éƒ¨åˆ† 1 0.6 Ã— 2 = 1.2 â†’ æ•´æ•°éƒ¨åˆ† 1 0.2 Ã— 2 = 0.4 â†’ æ•´æ•°éƒ¨åˆ† 0 â€¦ï¼ˆå¾ªç¯å¼€å§‹ï¼‰ æ‰€ä»¥ï¼Œ0.1 çš„äºŒè¿›åˆ¶è¡¨ç¤ºå¼€å§‹ä¸º 0.0001100110011â€¦ï¼Œå¹¶ä¸”è¿™ä¸ªæ¨¡å¼ä¼šæ— é™å¾ªç¯ä¸‹å»ã€‚ ç¬¬ 2 æ­¥ï¼šè§„æ ¼åŒ– å›é¡¾ä¸€ä¸‹è¿™å¼ å›¾ï¼š å•ç²¾åº¦æµ®ç‚¹æ•° æ‰€ä»¥ 12.375 è§„æ ¼åŒ–è¡¨ç¤ºä¸ºï¼š å…ˆè§„èŒƒåŒ–ä¸º 1.xxxx å½¢å¼ï¼š \\(1100.011_{(2)} = 1.100011 Ã— 2^3\\) æŒ‡æ•°ä¸ºï¼š\\(3 + 127 = 130 = 10000010_{(2)}\\) å°¾æ•°ä¸ºï¼š\\(10001100000000000000000ï¼ˆ23\\;ä½ï¼Œå³è¾¹è¡¥\\;0ï¼‰\\) æ±‡æ€»ï¼š\\(0\\;10000010\\;10001100000000000000000\\) è€Œ 0.1 ç”±äºæ— é™å¾ªç¯ï¼Œæˆ‘ä»¬åœ¨å•ç²¾åº¦ä¸‹åªèƒ½ä¿ç•™ 23 ä½ï¼Œå¹¶é‡‡ç”¨æœ€è¿‘èˆå…¥ï¼Œæ‰€ä»¥ 0.1 è§„æ ¼åŒ–è¡¨ç¤ºä¸ºï¼š å…ˆè§„èŒƒä¸º 1.xxxx å½¢å¼ï¼š\\(0.00011001100110011001100(å¾ªç¯) = 1.10011001100110011001100 Ã— 2^-4\\) æŒ‡æ•°ä¸ºï¼š\\(-4 + 127 = 123 = 01111011_{(2)}\\) å°¾æ•°ä¸ºï¼š\\(10011001100110011001100\\) æ±‡æ€»ï¼š\\(0\\;01111011\\;10011001100110011001100\\) ç¬¬ 3 æ­¥ï¼šå¯¹é½æŒ‡æ•° å…ˆæŠŠ 2 ä¸ªæµ®ç‚¹è¡¨ç¤ºæ”¾åœ¨ä¸€èµ·ï¼Œå¥½å¯¹æ¯”ï¼š \\(0\\;10000010\\;10001100000000000000000\\) \\(0\\;01111011\\;10011001100110011001100\\) å°†ä¸¤ä¸ªæ•°çš„æŒ‡æ•°å¯¹é½ï¼Œè¾ƒå°çš„æŒ‡æ•°å¢åŠ ï¼ŒåŒæ—¶ç›¸åº”åœ°è°ƒæ•´å°¾æ•°ã€‚ è¿™é‡Œéœ€è¦è°ƒæ•´å°† 0.1 çš„æŒ‡æ•°ä» 01111011 è°ƒæ•´åˆ° 10000010ï¼Œè¿™é‡ŒåŠ äº† 7ï¼Œæ‰€ä»¥ 0.1 çš„å°¾æ•° 1.10011001100110011001100éœ€è¦å³ç§» 7 ä½ï¼Œå³ï¼š0.00000011001100110011001ã€‚ ç¬¬ 4 æ­¥ï¼šç›¸åŠ  ç°åœ¨ä¸¤ä¸ªæ•°çš„æŒ‡æ•°ç›¸åŒäº†ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æŠŠå®ƒä»¬çš„å°¾æ•°ç›¸åŠ ï¼š \\[ \\;\\;\\;1.10001100000000000000000 \\\\ +\\;0.00000011001100110011001 \\\\ =\\;1.10001111001100110011001 \\] ç¬¬ 5 æ­¥ï¼šè§„èŒƒåŒ–ç»“æœ è¿™é‡Œæ— éœ€è§„èŒƒåŒ–ã€‚ ç¬¬ 6 æ­¥ï¼šèˆå…¥ è¿™é‡Œæ²¡æœ‰è¿›ä½ï¼Œä¸éœ€è¦èˆå…¥ã€‚ ç¬¬ 7 æ­¥ï¼šæµ®ç‚¹åŒ–è¡¨ç¤º \\[ 0\\;10000010\\;10001111001100110011001 \\] ç¬¬ 8 æ­¥ï¼šè½¬ä¸ºåè¿›åˆ¶ \\[ V =(-1)^sÃ—MÃ—2^E \\\\ = (-1)^sÃ—1.fracÃ—2^{e-bias} \\\\ = 1.10001111001100110011001 Ã— 2^3 \\\\ = 1100.01111001100110011001_{(2)} \\\\ = 12.47499942779541015625_{(10)} \\\\ â‰ˆ 12.475_{(10)} \\] æµ®ç‚¹æ•°ä¹˜æ³• ç¬¦å·ä½è®¡ç®—ï¼šç»“æœçš„ç¬¦å·ç”±ä¸¤ä¸ªæ“ä½œæ•°çš„ç¬¦å·ä½å†³å®šã€‚å¦‚æœç¬¦å·ä½ç›¸åŒï¼ˆéƒ½æ˜¯æ­£æ•°æˆ–éƒ½æ˜¯è´Ÿæ•°ï¼‰ï¼Œç»“æœä¸ºæ­£ï¼›å¦‚æœç¬¦å·ä½ä¸åŒï¼Œç»“æœä¸ºè´Ÿã€‚ æŒ‡æ•°ç›¸åŠ ï¼šä¸¤ä¸ªæ•°çš„æŒ‡æ•°ç›¸åŠ ï¼Œå¹¶å‡å»åç½®å€¼ï¼ˆå•ç²¾åº¦æµ®ç‚¹æ•°ä¸­ä¸º 127ï¼ŒåŒç²¾åº¦ä¸º 1023ï¼‰ã€‚ å°¾æ•°ç›¸ä¹˜ï¼šä¸¤ä¸ªæ•°çš„å°¾æ•°ç›¸ä¹˜ã€‚è¿™é‡Œçš„å°¾æ•°åŒ…æ‹¬éšå«çš„æœ€é«˜ä½ 1ã€‚ ç»“æœè§„èŒƒåŒ–ï¼šå¦‚æœä¹˜æ³•çš„ç»“æœéœ€è¦è§„èŒƒåŒ–ï¼ˆå³è°ƒæ•´ä¸º 1.xxxx çš„å½¢å¼ï¼‰ï¼Œåˆ™ç›¸åº”è°ƒæ•´æŒ‡æ•°ã€‚ èˆå…¥å¤„ç†ï¼šå¦‚æœéœ€è¦ï¼Œå¯¹ç»“æœè¿›è¡Œèˆå…¥ä»¥é€‚åº”ç›®æ ‡æ ¼å¼ã€‚ æ£€æŸ¥æº¢å‡ºæˆ–ä¸‹æº¢ï¼šå¦‚æœæŒ‡æ•°è¶…å‡ºäº†è¡¨ç¤ºèŒƒå›´ï¼Œåˆ™å‘ç”Ÿæº¢å‡ºï¼ˆç»“æœå¯èƒ½ä¸ºæ— ç©·å¤§æˆ–ç‰¹æ®Šå€¼ï¼‰ï¼›å¦‚æœæŒ‡æ•°å¤ªå°ï¼Œå‘ç”Ÿä¸‹æº¢ï¼ˆç»“æœå¯èƒ½ä¸º 0 æˆ–éè§„æ ¼åŒ–æ•°ï¼‰ã€‚ å‡è®¾æˆ‘ä»¬è¦åœ¨å•ç²¾åº¦æµ®ç‚¹æ•°æ ¼å¼ä¸‹è®¡ç®—ï¼š \\[ 2.0 Ã— 3.0 = ? \\] ç¬¬ 1 æ­¥ï¼šè½¬ä¸ºäºŒè¿›åˆ¶è¡¨ç¤º \\[ 2.0_{(10)} = 1_{(2)} \\\\ 3.0_{(10)} = 11_{(2)} \\] ç¬¬ 2 æ­¥ï¼šè§„èŒƒåŒ– \\[ 1 = 1.0 Ã— 2^0 \\\\ 11 = 1.1 Ã— 2^1 \\] ç¬¬ 3 æ­¥ï¼šæµ®ç‚¹åŒ– \\[ 2.0 = 0\\;00000001\\;00000000000000000000000 \\\\ 3.0 = 0\\;00000001\\;10000000000000000000000 \\] ç¬¬ 4 æ­¥ï¼šä¹˜æ³•æ“ä½œ ç¬¦å·ä½ï¼šæ­£æ­£å¾—æ­£ï¼š\\(0_{(2)} Ã— 0_{(2)} = 0_{(2)}\\) æŒ‡æ•°ç›¸åŠ å¹¶å‡å»åç½®å€¼ï¼š\\((127+1)+(127+1)-127=129\\) å°¾æ•°ç›¸ä¹˜ï¼š\\(1.0_{(2)}Ã—1.1_{(2)} = 1.1_{(2)}\\) ç¬¬ 5 æ­¥ï¼šè§„èŒƒåŒ– è¿™é‡Œæ— éœ€è§„èŒƒåŒ–ã€‚ ç¬¬ 6 æ­¥ï¼šèˆå…¥ è¿™é‡Œæ— éœ€èˆå…¥ã€‚ ç¬¬ 7 æ­¥ï¼šæµ®ç‚¹åŒ–ç»“æœ \\[ 0\\;00000010\\;10000000000000000000000 \\] ç¬¬ 8 æ­¥ï¼šè½¬ä¸ºåè¿›åˆ¶ \\[ V = (-1)^sÃ—1.fracÃ—2^{(e-127)} \\\\ = 0 Ã— 1.1 Ã— 2^2 \\\\ = 110_{(2)} \\\\ = 6.0_{(10)} \\] æµ®ç‚¹æ•°é™¤æ³• æµ®ç‚¹æ•°é™¤æ³•ç±»ä¼¼äºä¹˜æ³•ï¼Œä½†æœ‰ä¸€äº›ä¸åŒï¼š ç¬¦å·ä½è®¡ç®—ï¼šä¸ä¹˜æ³•ç±»ä¼¼ï¼Œç»“æœçš„ç¬¦å·ç”±ä¸¤ä¸ªæ“ä½œæ•°çš„ç¬¦å·ä½å†³å®šã€‚ æŒ‡æ•°ç›¸å‡ï¼šè¢«é™¤æ•°çš„æŒ‡æ•°å‡å»é™¤æ•°çš„æŒ‡æ•°ï¼Œå†åŠ ä¸Šåç½®å€¼ã€‚ å°¾æ•°ç›¸é™¤ï¼šè¢«é™¤æ•°çš„å°¾æ•°é™¤ä»¥é™¤æ•°çš„å°¾æ•°ã€‚ ç»“æœè§„èŒƒåŒ–ï¼šå¦‚æœå¿…è¦ï¼Œè°ƒæ•´ç»“æœä½¿å…¶è§„èŒƒåŒ–ã€‚ èˆå…¥å¤„ç†ï¼šå¦‚æœéœ€è¦ï¼Œå¯¹ç»“æœè¿›è¡Œèˆå…¥ã€‚ æ£€æŸ¥æº¢å‡ºæˆ–ä¸‹æº¢ï¼šä¸ä¹˜æ³•ç±»ä¼¼çš„æ£€æŸ¥ã€‚ å‡è®¾æˆ‘ä»¬è¦åœ¨å•ç²¾åº¦æµ®ç‚¹æ•°æ ¼å¼ä¸‹è®¡ç®—ï¼š \\[ 6.0 Ã· 3.0 =? \\] ç¬¬ 1 æ­¥ï¼šè½¬ä¸ºäºŒè¿›åˆ¶è¡¨ç¤º \\[ 6.0_{(10)} = 110_{(2)} \\\\ 3.0_{(10)} = 11_{(2)} \\] ç¬¬ 2 æ­¥ï¼šè§„èŒƒåŒ– \\[ 6.0 = 110 = 1.10 Ã— 2^2 \\\\ 3.0 = 11 = 1.1 Ã— 2^1 \\] ç¬¬ 3 æ­¥ï¼šæµ®ç‚¹åŒ– \\[ 6.0 = 0\\;00000020\\;10000000000000000000000 \\\\ 3.0 = 0\\;00000001\\;10000000000000000000000 \\] ç¬¬ 4 æ­¥ï¼šé™¤æ³•æ“ä½œ ç¬¦å·ä½ï¼šæ­£æ­£å¾—æ­£ï¼š\\(0_{(2)} Ã— 0_{(2)} = 0_{(2)}\\) æŒ‡æ•°å‡å¹¶åŠ ä¸Šåç½®å€¼ï¼š\\((127+2)-(127+1)+127=128\\) å°¾æ•°ç›¸é™¤ï¼š\\(1.1_{(2)}Ã—1.1_{(2)} = 1.0_{(2)}\\) ç¬¬ 5 æ­¥ï¼šè§„èŒƒåŒ– è¿™é‡Œæ— éœ€è§„èŒƒåŒ–ã€‚ ç¬¬ 6 æ­¥ï¼šèˆå…¥ è¿™é‡Œæ— éœ€èˆå…¥ã€‚ ç¬¬ 7 æ­¥ï¼šæµ®ç‚¹åŒ–ç»“æœ \\[ 0\\;00000001\\;00000000000000000000000 \\] ç¬¬ 8 æ­¥ï¼šè½¬ä¸ºåè¿›åˆ¶ \\[ V = (-1)^sÃ—1.fracÃ—2^{(e-127)} \\\\ = 0 Ã— 1.0 Ã— 2^1 \\\\ = 10_{(2)} \\\\ = 2.0_{(10)} \\] Go è¯­è¨€è¾“å‡ºæµ®ç‚¹æ•° func main() var number float32 = 12.375\tfmt.Printf(æµ®ç‚¹æ•°ï¼š%f , number)\tfmt.Printf(ç§‘å­¦è®¡æ•°æ³•ï¼š%e , number)\tfmt.Printf(ä¿ç•™ 2 ä½å°æ•°ï¼š%.2f , number)\tbits := math.Float32bits(number)\tbitsStr := fmt.Sprintf(%.32b, bits)\tfmt.Printf(è¾“å‡º32ä½æµ®ç‚¹è¡¨ç¤ºï¼š%s %s %s , bitsStr[:1], bitsStr[1:9], bitsStr[9:]) math/big Go è¯­è¨€çš„ math/big åŒ…æä¾›äº†å¯¹å¤§æ•°çš„ç²¾ç¡®è®¡ç®—æ”¯æŒï¼Œè¿™äº›å¤§æ•°çš„å¤§å°è¶…å‡ºäº†æ ‡å‡†æ•´æ•°ç±»å‹ï¼ˆå¦‚ int64ï¼‰æˆ–æµ®ç‚¹ç±»å‹ï¼ˆå¦‚ float64ï¼‰çš„èŒƒå›´ã€‚è¿™ä¸ªåŒ…ä¸»è¦ç”¨äºéœ€è¦é«˜ç²¾åº¦è®¡ç®—çš„é¢†åŸŸï¼Œå¦‚åŠ å¯†ã€ç§‘å­¦è®¡ç®—ç­‰ã€‚ ä¸»è¦åŠŸèƒ½ï¼š ç®—æœ¯è¿ç®—ï¼šæ”¯æŒåŸºæœ¬çš„åŠ ã€å‡ã€ä¹˜ã€é™¤ç­‰ç®—æœ¯è¿ç®—ã€‚ æ¯”è¾ƒæ“ä½œï¼šå¯ä»¥æ¯”è¾ƒä¸¤ä¸ªå¤§æ•°çš„å¤§å°ã€‚ ä½æ“ä½œï¼šå¯¹å¤§æ•´æ•°è¿›è¡Œä½æ“ä½œï¼Œå¦‚ä½ç§»ã€ä¸ã€æˆ–ã€å¼‚æˆ–ç­‰ã€‚ è§£æå’Œæ ¼å¼åŒ–ï¼šå¯ä»¥ä»å­—ç¬¦ä¸²è§£æå¤§æ•°ï¼Œä¹Ÿå¯ä»¥å°†å¤§æ•°æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²ã€‚ ç¤ºä¾‹ï¼š func main() a := big.NewFloat(math.MaxFloat64)\tb := big.NewFloat(math.MaxFloat64)\tsum := big.NewFloat(0)\tsum.Add(a, b)\tfmt.Println(a:, a)\tfmt.Println(sum:, sum)\tsum2 := big.NewFloat(0). SetPrec(15). // è®¾ç½®ç²¾åº¦ï¼Œprec è¶Šå¤§ï¼Œç²¾åº¦è¶Šé«˜ï¼Œè®¡ç®—è¶Šå¤æ‚ SetMode(big.ToZero) // è®¾ç½®èˆå…¥ç­–ç•¥\tsum2.Add(a, b)\tfmt.Println(sum2:, sum2)// a: 1.7976931348623157e+308// sum: 3.5953862697246314e+308// sum2: 3.5953e+308 æ³¨æ„äº‹é¡¹ï¼š æ€§èƒ½è€ƒè™‘ï¼šç”±äº math/big æä¾›çš„æ˜¯ä»»æ„ç²¾åº¦è®¡ç®—ï¼Œå…¶æ€§èƒ½é€šå¸¸ä½äºåŸç”Ÿçš„å›ºå®šå¤§å°æ•°å€¼ç±»å‹ã€‚ å†…å­˜ä½¿ç”¨ï¼šå¤§æ•°è¿ç®—å¯èƒ½ä¼šæ¶ˆè€—æ›´å¤šçš„å†…å­˜ã€‚ æ–¹æ³•é“¾å¼è°ƒç”¨ï¼šmath/big çš„è®¸å¤šæ–¹æ³•è¿”å›æ¥æ”¶è€…æœ¬èº«ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨ã€‚ å‚è€ƒèµ„æ–™ IEEE-754 æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ Go è¯­è¨€åº•å±‚åŸç†å‰–æ https://www.bilibili.com/video/BV1zK4y1j7Cn ChatGPT-4","tags":["è®¡ç®—æœºåŸç†","æµ®ç‚¹æ•°"],"categories":["è®¡ç®—æœºåŸºç¡€"]},{"title":"Go1.21.0 ç¨‹åºå¯åŠ¨è¿‡ç¨‹","path":"/2023/12/07/go-start/","content":"ç‰ˆæœ¬è¯´æ˜ Go 1.21.0 æ“ä½œç³»ç»Ÿï¼šWindows11 Intel64 ç»“è®ºå…ˆè¡Œ å¼€å‘å…³æ³¨ç‰ˆ åœ¨ Go è¯­è¨€ä¸­ï¼Œå¯åŠ¨é¡ºåºé€šå¸¸å¦‚ä¸‹ï¼š å¯¼å…¥åŒ…ï¼šé¦–å…ˆï¼ŒGo ç¼–è¯‘å™¨æŒ‰ç…§æºæ–‡ä»¶ä¸­çš„ import è¯­å¥å¯¼å…¥æ‰€æœ‰éœ€è¦çš„åŒ…ã€‚ åˆå§‹åŒ–å¸¸é‡å’Œå˜é‡ï¼šæ¥ç€ï¼Œç¼–è¯‘å™¨ä¼šåˆå§‹åŒ–åŒ…çº§åˆ«ï¼ˆå…¨å±€ï¼‰çš„å¸¸é‡å’Œå˜é‡ã€‚å®ƒä»¬çš„åˆå§‹åŒ–é¡ºåºæŒ‰ç…§å®ƒä»¬åœ¨æºæ–‡ä»¶ä¸­å‡ºç°çš„é¡ºåºè¿›è¡Œã€‚ æ‰§è¡Œ init å‡½æ•°ï¼šç„¶åï¼Œç¼–è¯‘å™¨ä¼šæ‰§è¡ŒåŒ…çº§åˆ«çš„ init å‡½æ•°ã€‚å¦‚æœä¸€ä¸ªåŒ…æœ‰å¤šä¸ª init å‡½æ•°ï¼Œå®ƒä»¬çš„æ‰§è¡Œé¡ºåºå’Œå®ƒä»¬åœ¨æºæ–‡ä»¶ä¸­å‡ºç°çš„é¡ºåºä¸€è‡´ã€‚ æ‰§è¡Œ main.main å‡½æ•°ï¼šæœ€åï¼Œç¼–è¯‘å™¨ä¼šæ‰§è¡Œ main å‡½æ•°ã€‚ Go ç¨‹åºå¯åŠ¨æµç¨‹ - å¼€å‘å…³æ³¨ç‰ˆ æ·±å…¥åŸç†ç‰ˆ å‘½ä»¤è¡Œå‚æ•°å¤åˆ¶ï¼šè¯»å–å‘½ä»¤è¡Œå‚æ•°ï¼Œå¤åˆ¶åˆ° argc å’Œ argvã€‚ åˆå§‹åŒ– g0 æ ˆï¼šg0 æ˜¯è¿è¡Œæ—¶ç³»ç»Ÿçš„ä¸€ä¸ªç‰¹æ®Šçš„ goroutineï¼Œå®ƒåœ¨ç¨‹åºå¯åŠ¨æ—¶è¢«åˆ›å»ºï¼Œç”¨äºæ‰§è¡Œç³»ç»Ÿè°ƒç”¨å’Œåç¨‹è°ƒåº¦ã€‚ runtime.check è¿è¡Œæ—¶æ£€æŸ¥ï¼š ç±»å‹é•¿åº¦ æŒ‡é’ˆæ“ä½œ ç»“æ„ä½“å­—æ®µåç§»é‡ CAS atomic æ“ä½œ æ ˆå¤§å°æ˜¯å¦ä¸º 2 çš„å¹‚æ¬¡ã€‚ runtime.args å‚æ•°åˆå§‹åŒ–ï¼šå°† argc å’Œ argv çš„å‚æ•°èµ‹å€¼åˆ° Go çš„å˜é‡ä¸­ã€‚ runtime.osinit åˆå§‹åŒ–æ“ä½œç³»ç»Ÿç‰¹ç‚¹çš„è®¾ç½®ï¼šä¸»è¦æ˜¯åˆ¤æ–­ç³»ç»Ÿå­—é•¿å’Œ CPU æ ¸æ•°ã€‚ runtime.schedinit åˆå§‹åŒ–è°ƒåº¦å™¨ï¼š é”åˆå§‹åŒ– ç«æ€æ£€æµ‹å™¨åˆå§‹åŒ– è°ƒåº¦å™¨è®¾ç½®ï¼Œè®¾ç½®è°ƒåº¦å™¨å¯ä»¥ç®¡ç†çš„æœ€å¤§çº¿ç¨‹ï¼ˆMï¼‰æ•°ç›® ç³»ç»Ÿåˆå§‹åŒ–ï¼Œåˆå§‹åŒ–å†…å­˜ç®¡ç†ã€CPU è®¾ç½®ã€ç®—æ³•ç­‰ï¼Œè¿™äº›éƒ½æ˜¯è°ƒåº¦å™¨æ­£å¸¸å·¥ä½œçš„åŸºç¡€ è®¾ç½®å½“å‰ M çš„ä¿¡å·æ©ç  è§£æç¨‹åºå‚æ•°å’Œç¯å¢ƒå˜é‡ åƒåœ¾æ”¶é›†å™¨åˆå§‹åŒ– è®¾ç½® process çš„æ•°é‡ runtime.newproc åˆ›å»ºä¸»åç¨‹ g0 å¹¶å°†å…¶æ”¾å…¥é˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œã€‚ runtime. mstart å¯åŠ¨è°ƒåº¦å™¨ï¼šåˆå§‹åŒ– m0ï¼Œå¹¶è°ƒåº¦ g0 å»æ‰§è¡Œ runtime.mainã€‚ runtime.main ç¨‹åºçœŸæ­£å…¥å£ï¼š runtime.init å¯åŠ¨ gc æ‰§è¡Œç”¨æˆ·åŒ… init æ‰§è¡Œç”¨æˆ·å‡½æ•° main.main Go ç¨‹åºå¯åŠ¨æµç¨‹ - æ·±å…¥åŸç†ç‰ˆ å¦‚æœåªæ˜¯æƒ³å¯¹ Go è¯­è¨€ç¨‹åºçš„å¯åŠ¨è¿‡ç¨‹æœ‰ä¸€ä¸ªç®€å•çš„äº†è§£ï¼Œé‚£ä¹ˆé˜…è¯»åˆ°è¿™é‡Œå°±å¯ä»¥ç»“æŸäº†ã€‚ Runtime åœ¨åˆ†æ Go ç¨‹åºçš„å¯åŠ¨è¿‡ç¨‹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ä¸€ä¸‹ Go ä¸­çš„ Runtimeã€‚æ‰€è°“ Runtimeï¼Œå³ Go çš„è¿è¡Œæ—¶ç¯å¢ƒï¼Œå¯ä»¥ç†è§£ä¸º Java çš„ JVMã€JavaScript ä¾èµ–çš„æµè§ˆå™¨å†…æ ¸ã€‚ Go çš„ Runtime æ˜¯ä¸€ä»½ä»£ç ï¼Œå®ƒä¼šéšç€ç”¨æˆ·ç¨‹åºä¸€èµ·æ‰“åŒ…æˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œéšç€ç¨‹åºä¸€èµ·è¿è¡Œã€‚ Runtime å…·æœ‰å†…å­˜ç®¡ç†ã€GCã€åç¨‹ã€å±è”½ä¸åŒæ“ä½œç³»ç»Ÿè°ƒç”¨ç­‰èƒ½åŠ›ã€‚ ç»¼ä¸Šï¼ŒGo ç¨‹åºçš„è¿è¡Œéƒ½ä¾èµ–äº Runtime è¿è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨åˆ†æ Go è¯­è¨€ç¨‹åºçš„å¯åŠ¨è¿‡ç¨‹çš„æ—¶å€™ï¼Œé¦–å…ˆè¦ç¡®å®šç¨‹åºçš„å…¥å£ï¼Œå³ Runtimeã€‚ è¿™éƒ¨åˆ†ä»£ç ä½äº go æºç ä¸­ src/runtime ç›®å½•ä¸‹ï¼Œå½“ä½ åœ¨æœ¬æœºå®‰è£… go åï¼Œä½ å¯ä»¥è¿›å…¥ç›¸åº”çš„ä»£ç ç›®å½•ä¸‹ï¼Œåœ¨ Windows ä¸Šï¼Œä½ å¯ä»¥åœ¨è¯¥ç›®å½•ä¸‹è¿è¡Œä¸‹é¢å‘½ä»¤ï¼š dir | findstr rt0 | findstr amd è¿™é‡Œæˆ‘ä»¬è¾“å‡º go å®˜æ–¹ä¸ºå¤šç§ amd å¤„ç†å™¨æ¶æ„çš„æ“ä½œç³»ç»Ÿæ‰€å®ç°çš„ runtimeï¼Œå¦‚ï¼š -a---- 2023/8/25 23:44 754 rt0_android_amd64.s-a---- 2023/8/25 23:44 399 rt0_darwin_amd64.s-a---- 2023/8/25 23:44 448 rt0_dragonfly_amd64.s-a---- 2023/8/25 23:44 442 rt0_freebsd_amd64.s-a---- 2023/8/25 23:44 311 rt0_illumos_amd64.s-a---- 2023/8/25 23:44 425 rt0_ios_amd64.s-a---- 2023/8/25 23:44 307 rt0_linux_amd64.s-a---- 2023/8/25 23:44 309 rt0_netbsd_amd64.s-a---- 2023/8/25 23:44 311 rt0_openbsd_amd64.s-a---- 2023/8/25 23:44 481 rt0_plan9_amd64.s-a---- 2023/8/25 23:44 311 rt0_solaris_amd64.s-a---- 2023/8/25 23:44 1166 rt0_windows_amd64.s åˆ°è¿™é‡Œä¹Ÿå°±æ˜ç™½äº†ï¼Œå‰é¢æ‰€è¯´çš„ Go Runtime èƒ½åŠ›ä¹‹ â€œå±è”½ä¸åŒæ“ä½œç³»ç»Ÿè°ƒç”¨èƒ½åŠ›â€ çš„æ–¹å¼ä¾¿æ˜¯é’ˆå¯¹æ¯ä¸€ç§æ“ä½œç³»ç»Ÿå•ç‹¬åšå®ç°ï¼Œæœ€ååœ¨ç¼–è¯‘çš„æ—¶å€™æ ¹æ®æ“ä½œç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„å®ç°å³å¯ã€‚ è¿™é‡Œæˆ‘ä»¬ä»¥ rt0_windows_amd64.s ä¸ºä¾‹ï¼Œçœ‹çœ‹è¿™ä¸ªæ–‡ä»¶å†™äº†äº›ä»€ä¹ˆï¼š TEXT _rt0_amd64_windows(SB),NOSPLIT|NOFRAME,$-8\tJMP\t_rt0_amd64(SB) è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒä¼šç›´æ¥è·³åˆ° _rt0_amd64(SB) è¿™é‡Œï¼Œåœ¨ Goland IDE ä¸­ï¼Œä½ å¯ä»¥åŒå‡» Shift é”®æ‰“å¼€æœç´¢ï¼Œæœç´¢ TEXT _rt0_amd64ï¼Œå°±å¯ä»¥å‘ç°è¿™ä¸ªå‡½æ•°ä½äº asm_amd64.s æ–‡ä»¶ä¸­ï¼ŒæŸ¥çœ‹è¯¥æ–‡ä»¶ï¼š // _rt0_amd64 is common startup code for most amd64 systems when using// internal linking. This is the entry point for the program from the// kernel for an ordinary -buildmode=exe program. The stack holds the// number of arguments and the C-style argv.TEXT _rt0_amd64(SB),NOSPLIT,$-8\tMOVQ\t0(SP), DI\t// argc\tLEAQ\t8(SP), SI\t// argv\tJMP\truntimeÂ·rt0_go(SB) ç¿»è¯‘ä¸€ä¸‹ä¸Šé¢çš„æ³¨é‡Šï¼š_rt0_amd64 æ˜¯å¤§å¤šæ•° amd64 ç³»ç»Ÿåœ¨ä½¿ç”¨å†…éƒ¨é“¾æ¥æ—¶çš„é€šç”¨å¯åŠ¨ä»£ç ã€‚è¿™æ˜¯ exe ç¨‹åºä»å†…æ ¸è¿›å…¥ç¨‹åºçš„å…¥å£ç‚¹ã€‚å †æ ˆä¿å­˜äº†å‚æ•°çš„æ•°é‡å’Œ C è¯­è¨€é£æ ¼çš„ argvã€‚ åˆ°è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥éå¸¸ç¡®å®šåœ°æ‰¾åˆ°äº†å¯¹åº”æ“ä½œç³»ç»Ÿçš„ Go è¯­è¨€ç¨‹åºå¯åŠ¨å…¥å£äº†ï¼Œæ¥ä¸‹æ¥åªéœ€è¦æ²¿ç€è¯¥å…¥å£ç»§ç»­åˆ†æå³å¯ã€‚ runtimeÂ·rt0_go ä¸Šé¢æˆ‘ä»¬åˆ†æåˆ° _rt0_adm64 ä¼š JMP åˆ° runtimeÂ·rt0_go æ‰§è¡Œï¼Œè¿™ä¸ªå‡½æ•°ä¹Ÿä½äº asm_amd64.s æ–‡ä»¶ä¸­ï¼Œé€šè¿‡åˆ†æè¿™ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥äº†è§£åˆ° Go è¯­è¨€ç¨‹åºçš„æ•´ä¸ªå¯åŠ¨è¿‡ç¨‹ã€‚ ä¸‹é¢å°†å¯¹è¿™æ•´ä¸ªå‡½æ•°è¿›è¡Œä¸€ä¸ªæ¦‚è§ˆï¼Œåé¢ä¼šå¯¹é‡ç‚¹è¿‡ç¨‹é€ä¸ªè¯¦è¿°ã€‚ TEXT runtimeÂ·rt0_go(SB),NOSPLIT|NOFRAME|TOPFRAME,$0\t// è¯»å–å‘½ä»¤è¡Œå‚æ•°ï¼Œå¤åˆ¶å‚æ•°å˜é‡ argc å’Œ argv åˆ°æ ˆä¸Š\tMOVQ\tDI, AX // argc\tMOVQ\tSI, BX // argv\tSUBQ\t$(5*8), SP ANDQ\t$~15, SP\tMOVQ\tAX, 24(SP)\tMOVQ\tBX, 32(SP)\t// ä»ç»™å®šçš„ï¼ˆæ“ä½œç³»ç»Ÿï¼‰å †æ ˆåˆ›å»ºistackã€‚\t// è¿™æ˜¯åœ¨è®¾ç½® g0 çš„å †æ ˆï¼Œg0 æ˜¯è¿è¡Œæ—¶ç³»ç»Ÿçš„ä¸€ä¸ªç‰¹æ®Šçš„ goroutineã€‚\t// å®ƒåœ¨ç¨‹åºå¯åŠ¨æ—¶è¢«åˆ›å»ºï¼Œç”¨äºæ‰§è¡Œç³»ç»Ÿè°ƒç”¨å’Œåç¨‹è°ƒåº¦ã€‚\t// è¿™é‡Œåªæ˜¯åˆå§‹åŒ– g0 çš„å †æ ˆï¼Œè¿˜æ²¡æœ‰å¯åŠ¨ g0ã€‚\tMOVQ\t$runtimeÂ·g0(SB), DI\tLEAQ\t(-64*1024)(SP), BX\tMOVQ\tBX, g_stackguard0(DI)\tMOVQ\tBX, g_stackguard1(DI)\tMOVQ\tBX, (g_stack+stack_lo)(DI)\tMOVQ\tSP, (g_stack+stack_hi)(DI)\t// æ£€æŸ¥ CPU çš„å‚å•† IDï¼š\t//\tå¦‚æœæ²¡æœ‰ CPU ä¿¡æ¯ï¼Œåˆ™è·³è½¬åˆ° nocpuinfoï¼›\t//\tå¦‚æœæ˜¯ Intel çš„ CPUï¼Œå°±è®¾ç½® runtimeÂ·isIntel=1ï¼Œå¦åˆ™è·³åˆ° notintelã€‚\tMOVL\t$0, AX\tCPUID\tCMPL\tAX, $0\tJE\tnocpuinfo\tCMPL\tBX, $0x756E6547 // Genu\tJNE\tnotintel\tCMPL\tDX, $0x49656E69 // ineI\tJNE\tnotintel\tCMPL\tCX, $0x6C65746E // ntel\tJNE\tnotintel\tMOVB\t$1, runtimeÂ·isIntel(SB)notintel: // åŠ è½½ EXA=1 çš„ cpuid æ ‡å¿—å’Œç‰ˆæœ¬ä¿¡æ¯\tMOVL\t$1, AX\tCPUID\tMOVL\tAX, runtimeÂ·processorVersionInfo(SB)nocpuinfo: // å¦‚æœæœ‰ _cgo_init å°±è°ƒç”¨å®ƒ\tMOVQ\t_cgo_init(SB), AX\tTESTQ\tAX, AX\t// å¦‚æœ _cgo_init ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆè·³è¿‡åé¢çš„ä»£ç ï¼Œ\t// ç›´æ¥è¿›å…¥åˆ° needtls è¿›è¡Œ TLS çš„åˆå§‹åŒ–ã€‚\t// TLSï¼Œå…¨ç§°ä¸ºThread-Local Storageï¼ˆçº¿ç¨‹å±€éƒ¨å­˜å‚¨ï¼‰ï¼Œ\t// æ˜¯æ“ä½œç³»ç»Ÿæä¾›çš„ä¸€ç§æœºåˆ¶ï¼Œå…è®¸æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰ä¸€ä»½è‡ªå·±çš„æ•°æ®å‰¯æœ¬ã€‚\t// è¿™äº›æ•°æ®åœ¨åŒä¸€çº¿ç¨‹çš„æ‰€æœ‰å‡½æ•°ä¸­éƒ½æ˜¯å¯è§çš„ï¼Œä½†å¯¹å…¶ä»–çº¿ç¨‹æ˜¯ä¸å¯è§çš„ã€‚\t// è¿™æ ·ï¼Œæ¯ä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®å’Œä¿®æ”¹è‡ªå·±çš„æ•°æ®ï¼Œè€Œä¸ä¼šå½±å“å…¶ä»–çº¿ç¨‹ã€‚\tJZ\tneedtls\t// å°† setg_gcc å‡½æ•°çš„åœ°å€åŠ è½½åˆ° SI å¯„å­˜å™¨ä¸­ã€‚\t// è¿™æ˜¯ _cgo_init å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ã€‚\tMOVQ\t$setg_gcc(SB), SI // arg 2: setg_gcc\t// åœ¨ä½¿ç”¨å¹³å°çš„TLSæ—¶ä¸ä½¿ç”¨è¿™ç¬¬3å’Œç¬¬4ä¸ªå‚æ•°ã€‚\tMOVQ\t$0, DX MOVQ\t$0, CX#ifdef GOOS_android\tMOVQ\t$runtimeÂ·tls_g(SB), DX // arg 3: tls_g\t// arg 4: TLS base, stored in slot 0 (Androids TLS_SLOT_SELF).\t// Compensate for tls_g (+16).\tMOVQ\t-16(TLS), CX#endif#ifdef GOOS_windows\tMOVQ\t$runtimeÂ·tls_g(SB), DX // arg 3: tls_g\t// è°ƒæ•´ Win64 çš„è°ƒç”¨çº¦å®šã€‚\tMOVQ\tCX, R9 // arg 4\tMOVQ\tDX, R8 // arg 3\tMOVQ\tSI, DX // arg 2\tMOVQ\tDI, CX // arg 1#endif\t// å‰é¢ MOVQ\t_cgo_init(SB), AXï¼Œè¿™é‡Œå°±æ˜¯è°ƒç”¨ _cgo_init\tCALL\tAX\t// åœ¨ _cgo_init ä¹‹åæ›´æ–° stackguard\tMOVQ\t$runtimeÂ·g0(SB), CX\tMOVQ\t(g_stack+stack_lo)(CX), AX\tADDQ\t$const_stackGuard, AX\tMOVQ\tAX, g_stackguard0(CX)\tMOVQ\tAX, g_stackguard1(CX)#ifndef GOOS_windows\tJMP ok#endif// é’ˆå¯¹ä¸åŒæ“ä½œç³»ç»Ÿå¯¹ TLS è¿›è¡Œè®¾ç½®needtls: #ifdef GOOS_plan9\t// skip TLS setup on Plan 9\tJMP ok#endif#ifdef GOOS_solaris\t// skip TLS setup on Solaris\tJMP ok#endif#ifdef GOOS_illumos\t// skip TLS setup on illumos\tJMP ok#endif#ifdef GOOS_darwin\t// skip TLS setup on Darwin\tJMP ok#endif#ifdef GOOS_openbsd\t// skip TLS setup on OpenBSD\tJMP ok#endif#ifdef GOOS_windows\tCALL\truntimeÂ·wintls(SB)#endif\tLEAQ\truntimeÂ·m0+m_tls(SB), DI\tCALL\truntimeÂ·settls(SB)\t// æ£€æŸ¥ TLS æ˜¯å¦æ­£å¸¸å·¥ä½œ\tget_tls(BX)\tMOVQ\t$0x123, g(BX)\tMOVQ\truntimeÂ·m0+m_tls(SB), AX\tCMPQ\tAX, $0x123\tJEQ 2(PC)\tCALL\truntimeÂ·abort(SB)ok:\t//è®¾ç½® g0 å’Œ m0 å’Œ TLS\tget_tls(BX)\tLEAQ\truntimeÂ·g0(SB), CX\tMOVQ\tCX, g(BX)\tLEAQ\truntimeÂ·m0(SB), AX\tMOVQ\tCX, m_g0(AX)\tMOVQ\tAX, g_m(CX)\tCLD // ä¸‹é¢çš„ ifdef NEED_xxx ä¸»è¦æ˜¯åœ¨æ£€æŸ¥ CPU æ˜¯å¦æ”¯æŒ Go è¿è¡Œæ—¶ç³»ç»Ÿéœ€è¦çš„ç‰¹æ€§ã€‚// æˆ‘ä»¬éœ€è¦åœ¨è®¾ç½®äº† TLS ä¹‹ååšè¿™ä¸ªï¼Œ// å¦‚æœå¤±è´¥å°±è·³è½¬åˆ° bad_cpu æŠ¥å‘Šé”™è¯¯ã€‚#ifdef NEED_FEATURES_CX\tMOVL\t$0, AX\tCPUID\tCMPL\tAX, $0\tJE\tbad_cpu\tMOVL\t$1, AX\tCPUID\tANDL\t$NEED_FEATURES_CX, CX\tCMPL\tCX, $NEED_FEATURES_CX\tJNE\tbad_cpu#endif#ifdef NEED_MAX_CPUID\tMOVL\t$0x80000000, AX\tCPUID\tCMPL\tAX, $NEED_MAX_CPUID\tJL\tbad_cpu#endif#ifdef NEED_EXT_FEATURES_BX\tMOVL\t$7, AX\tMOVL\t$0, CX\tCPUID\tANDL\t$NEED_EXT_FEATURES_BX, BX\tCMPL\tBX, $NEED_EXT_FEATURES_BX\tJNE\tbad_cpu#endif#ifdef NEED_EXT_FEATURES_CX\tMOVL\t$0x80000001, AX\tCPUID\tANDL\t$NEED_EXT_FEATURES_CX, CX\tCMPL\tCX, $NEED_EXT_FEATURES_CX\tJNE\tbad_cpu#endif#ifdef NEED_OS_SUPPORT_AX\tXORL CX, CX\tXGETBV\tANDL\t$NEED_OS_SUPPORT_AX, AX\tCMPL\tAX, $NEED_OS_SUPPORT_AX\tJNE\tbad_cpu#endif#ifdef NEED_DARWIN_SUPPORT\tMOVQ\t$commpage64_version, BX\tCMPW\t(BX), $13 // cpu_capabilities64 undefined in versions 13\tJL\tbad_cpu\tMOVQ\t$commpage64_cpu_capabilities64, BX\tMOVQ\t(BX), BX\tMOVQ\t$NEED_DARWIN_SUPPORT, CX\tANDQ\tCX, BX\tCMPQ\tBX, CX\tJNE\tbad_cpu#endif\t// æ£€æŸ¥å®Œ AMD64 ä¸åŒæ“ä½œç³»ç»Ÿæ˜¯å¦æ”¯æŒ Go è¿è¡Œæ—¶ç³»ç»Ÿéœ€è¦çš„ç‰¹æ€§åï¼Œ\t// è¿™é‡Œæ‰§è¡Œ runtimeÂ·check å¯¹ä»£ç åšä¸€ä¸‹è¿è¡Œæ—¶æ£€æŸ¥ã€‚\tCALL\truntimeÂ·check(SB)\t// å¤åˆ¶ argcï¼ˆå‘½ä»¤è¡Œå‚æ•°çš„æ•°é‡ï¼‰åˆ° AX å¯„å­˜å™¨ï¼Œ\t// ç„¶åæŠŠ AX å¯„å­˜å™¨çš„å€¼å­˜åˆ°æ ˆä¸Šã€‚\tMOVL\t24(SP), AX\tMOVL\tAX, 0(SP)\t// å¤åˆ¶ argvï¼ˆå‘½ä»¤è¡Œå‚æ•°çš„æ•°ç»„ï¼‰åˆ° AX å¯„å­˜å™¨ï¼Œ\t// ç„¶åæŠŠ AX å¯„å­˜å™¨çš„å€¼å­˜åˆ°æ ˆä¸Šã€‚\tMOVQ\t32(SP), AX\tMOVQ\tAX, 8(SP)\t// è°ƒç”¨ runtimeÂ·args å‡½æ•°å¤„ç†å‘½ä»¤è¡Œå‚æ•°ã€‚\tCALL\truntimeÂ·args(SB)\t// è°ƒç”¨ runtimeÂ·osinit å‡½æ•°åˆå§‹åŒ–æ“ä½œç³»ç»Ÿç‰¹å®šçš„è®¾ç½®ã€‚\tCALL\truntimeÂ·osinit(SB)\t// è°ƒç”¨ runtimeÂ·schedinit å‡½æ•°åˆå§‹åŒ–è°ƒåº¦å™¨ã€‚\tCALL\truntimeÂ·schedinit(SB) /** è¡¥å……ï¼šè¿™æ˜¯è¯¥æ–‡ä»¶ä¸‹é¢å¯¹ runtimeÂ·mainPC çš„å£°æ˜ // mainPC is a function value for runtime.main, to be passed to newproc. // The reference to runtime.main is made via ABIInternal, since the // actual function (not the ABI0 wrapper) is needed by newproc. DATA\truntimeÂ·mainPC+0(SB)/8,$runtimeÂ·mainABIInternal(SB) */ // å– runtimeÂ·mainPC çš„åœ°å€ï¼Œè¿™å…¶å®å°±æ˜¯ runtime åŒ…ä¸‹çš„ main() æ–¹æ³•ã€‚ // å®ƒæ˜¯ Go è¯­è¨€ç¨‹åºçš„çœŸæ­£å…¥å£ï¼Œè€Œä¸æ˜¯ main.main()ã€‚\tMOVQ\t$runtimeÂ·mainPC(SB), AX PUSHQ\tAX // åˆ›å»ºä¸€ä¸ªæ–°çš„ goroutine æ¥è¿è¡Œç¨‹åºçš„ä¸»å‡½æ•°ã€‚ // è¿™é‡Œè¿˜æ²¡æœ‰æ­£åœ¨çš„è¿è¡Œï¼Œå› ä¸ºè°ƒåº¦å™¨è¿˜æ²¡æœ‰å¯åŠ¨ï¼Œ // åªæ˜¯å°† runtime.main æ”¾è¿› goroutine çš„ queue ä¸­ç­‰å¾…æ‰§è¡Œã€‚\tCALL\truntimeÂ·newproc(SB)\tPOPQ\tAX\t// è°ƒç”¨ runtimeÂ·mstart å‡½æ•°å¯åŠ¨ Mï¼ˆmachineï¼Œä»£è¡¨ä¸€ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼‰ï¼Œ\t// å¼€å§‹æ‰§è¡Œ goroutinesã€‚\tCALL\truntimeÂ·mstart(SB)\t// å¦‚æœ runtimeÂ·mstart å‡½æ•°è¿”å›ï¼Œé‚£ä¹ˆå°±è°ƒç”¨ runtimeÂ·abort å‡½æ•°ç»ˆæ­¢ç¨‹åºã€‚\t// å› ä¸º runtimeÂ·mstart å‡½æ•°åœ¨æ­£å¸¸æƒ…å†µä¸‹æ˜¯ä¸åº”è¯¥è¿”å›çš„ï¼Œå¦‚æœè¿”å›äº†ï¼Œè¯´æ˜æœ‰é”™è¯¯å‘ç”Ÿã€‚\tCALL\truntimeÂ·abort(SB)\t// mstart should never return\tRETbad_cpu: // å½“å‰ CPU ä¸æ”¯æŒ Go è¿è¡Œæ—¶ç³»ç»Ÿéœ€è¦çš„æ—¶å€™çš„é”™è¯¯æŠ¥å‘Šã€‚\tMOVQ\t$2, 0(SP)\tMOVQ\t$bad_cpu_msg(SB), AX\tMOVQ\tAX, 8(SP)\tMOVQ\t$84, 16(SP)\tCALL\truntimeÂ·write(SB)\tMOVQ\t$1, 0(SP)\tCALL\truntimeÂ·exit(SB)\tCALL\truntimeÂ·abort(SB)\tRET\t// Prevent dead-code elimination of debugCallV2, which is\t// intended to be called by debuggers.\tMOVQ\t$runtimeÂ·debugCallV2ABIInternal(SB), AX\tRET æ•´ç†ä¸€ä¸‹ï¼ŒruntimeÂ·rt0_go çš„å¤§ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š è¯»å–å‘½ä»¤è¡Œå‚æ•°ï¼Œå¤åˆ¶å‚æ•°å˜é‡ argc å’Œ argv åˆ°æ ˆä¸Šã€‚ åˆå§‹åŒ– g0 æ ˆï¼Œg0 æ˜¯ä¸ºäº†è°ƒåº¦åç¨‹è€Œäº§ç”Ÿçš„åç¨‹ï¼Œæ˜¯ g0 æ˜¯è¿è¡Œæ—¶ç³»ç»Ÿçš„ä¸€ä¸ªç‰¹æ®Šçš„ goroutineï¼Œå®ƒåœ¨ç¨‹åºå¯åŠ¨æ—¶è¢«åˆ›å»ºï¼Œç”¨äºæ‰§è¡Œç³»ç»Ÿè°ƒç”¨å’Œåç¨‹è°ƒåº¦ã€‚ è·å– CPU ä¿¡æ¯ã€‚ å¦‚æœå­˜åœ¨ _cgo_initï¼Œè¿™è°ƒç”¨å®ƒã€‚ æ£€æŸ¥å¹¶è®¾ç½®çº¿æ€§å±€éƒ¨å­˜å‚¨ï¼ˆTLSï¼‰ã€‚ æ£€æŸ¥ CPU æ˜¯å¦æ”¯æŒ Go è¿è¡Œæ—¶ç³»ç»Ÿéœ€è¦çš„ç‰¹æ€§ã€‚ å®Œæˆè¿è¡Œæ—¶ç³»ç»Ÿæ£€æŸ¥å’Œåˆå§‹åŒ–ï¼š è°ƒç”¨ runtimeÂ·check å¯¹ä»£ç è¿›è¡Œè¿è¡Œæ—¶æ£€æŸ¥ã€‚ è°ƒç”¨ runtimeÂ·args å‡½æ•°å¤„ç†å‘½ä»¤è¡Œå‚æ•°ã€‚ è°ƒç”¨ runtimeÂ·osinit å‡½æ•°åˆå§‹åŒ–æ“ä½œç³»ç»Ÿç‰¹å®šçš„è®¾ç½®ã€‚ è°ƒç”¨ runtimeÂ·schedinit å‡½æ•°åˆå§‹åŒ–è°ƒåº¦å™¨ã€‚ è°ƒç”¨ runtimeÂ·newproc åˆ›å»ºä¸€ä¸ªæ–°çš„ goroutine æ¥è¿è¡Œç¨‹åºçš„ä¸»å‡½æ•°ã€‚ è°ƒç”¨ runtimeÂ·mstart å¯åŠ¨å½“å‰çš„ machineï¼Œæ‰§è¡Œ goroutinesï¼Œæ‰§è¡Œç¨‹åºã€‚ ä¸€å¥è¯ï¼šruntimeÂ·rt0_go æ˜¯ Go è¯­è¨€è¿è¡Œæ—¶çš„å…¥å£ç‚¹ï¼Œå®ƒè´Ÿè´£è®¾ç½®å’Œåˆå§‹åŒ–è¿è¡Œæ—¶ç¯å¢ƒï¼Œç„¶ååˆ›å»º g0 å’Œ m0 æ¥è¿è¡Œç¨‹åºçš„ä¸»å‡½æ•°ã€‚ Go è¿è¡Œæ—¶ç³»ç»Ÿåˆå§‹åŒ–æµç¨‹ äº†è§£å®Œ Go ç¨‹åºçš„æ•´ä½“å¯åŠ¨æµç¨‹åï¼Œæˆ‘ä»¬é‡ç‚¹æ¥åˆ†æä¸€ä¸‹å…¶ä¸­çš„ runtimeÂ·checkã€runtimeÂ·argsã€runtimeÂ·osinitã€runtimeÂ·schedinitã€runtimeÂ·newproc å’Œ runtimeÂ·mstartã€‚ å¯¹äº†ï¼Œå……åˆ†ç†è§£ Go å¯åŠ¨æµç¨‹ï¼Œå¯èƒ½éœ€è¦ä½ å¯¹ Go çš„ GMP æ¨¡å‹æœ‰ä¸€å®šçš„äº†è§£ã€‚ // TODO runtimeÂ·check åœ¨ Goland IDE ä¸Šï¼Œæˆ‘ä»¬åŒå‡» Shiftï¼Œå…¨å±€æœç´¢ runtimeÂ·check ä¼šå‘ç°æ‰¾ä¸åˆ°å‡½æ•°çš„å®ç°ã€‚ Go è¯­è¨€çš„è¿è¡Œæ—¶ç³»ç»Ÿå¤§éƒ¨åˆ†æ˜¯ç”¨ Go è‡ªå·±ç¼–å†™çš„ï¼Œä½†æ˜¯æœ‰ä¸€éƒ¨åˆ†ï¼Œç‰¹åˆ«æ˜¯ä¸å¹³å°ç›¸å…³çš„éƒ¨åˆ†ï¼Œæ˜¯ç”¨æ±‡ç¼–è¯­è¨€ç¼–å†™çš„ã€‚åœ¨æ±‡ç¼–è¯­è¨€ä¸­ï¼Œè°ƒç”¨ Go å‡½æ•°çš„ä¸€ç§æ–¹å¼æ˜¯ä½¿ç”¨ CALL æŒ‡ä»¤å’Œå‡½æ•°çš„å…¨åï¼ŒåŒ…æ‹¬åŒ…åå’Œå‡½æ•°åã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒruntimeÂ·check å°±æ˜¯è°ƒç”¨ runtime åŒ…ä¸‹çš„ check() å‡½æ•°ã€‚ æ‰€ä»¥æˆ‘ä»¬éœ€è¦åŒå‡» Shiftï¼Œæœç´¢ runtine.checkï¼Œå³å°† Â· æ¢æˆ .ï¼ˆåé¢æ‰€æœ‰å‡½æ•°å‡æ˜¯è¿™ä¸ªé“ç†ï¼‰ã€‚æˆ‘ä»¬ä¼šå‘ç° check() ä½äº runtime/runtime1.go ä¸­ã€‚ func check() var ( a int8 b uint8 c int16 d uint16 e int32 f uint32 g int64 h uint64 i, i1 float32 j, j1 float64 k unsafe.Pointer l *uint16 m [4]byte\t)\ttype x1t struct x uint8 type y1t struct x1 x1t y uint8 var x1 x1t\tvar y1 y1t // æ£€æŸ¥å„ç§ç±»å‹çš„å˜é‡çš„å¤§å°æ˜¯å¦ç¬¦åˆé¢„æœŸ\tif unsafe.Sizeof(a) != 1 throw(bad a) ... // æ£€æŸ¥æŒ‡é’ˆæ“ä½œ\tif unsafe.Sizeof(k) != goarch.PtrSize throw(bad k) ...\t// æ£€æŸ¥ç»“æ„ä½“ä¸­å­—æ®µçš„åç§»é‡æ˜¯å¦ç¬¦åˆé¢„æœŸ if unsafe.Offsetof(y1.y) != 1 throw(bad offsetof y1.y) // timediv å‡½æ•°çš„ç›®çš„æ˜¯åœ¨ 32 ä½å¤„ç†å™¨ä¸Šå®ç° 64 ä½çš„é™¤æ³•è¿ç®—ã€‚ // ç”±äºåœ¨ 32 ä½å¤„ç†å™¨ä¸Šï¼Œ64 ä½çš„é™¤æ³•è¿ç®—ä¼šè¢«è½¬æ¢ä¸º _divv() å‡½æ•°è°ƒç”¨ï¼Œ // è¿™å¯èƒ½ä¼šè¶…å‡º nosplit å‡½æ•°çš„æ ˆé™åˆ¶ï¼Œæ‰€ä»¥éœ€è¦è¿™ä¸ªç‰¹æ®Šçš„å‡½æ•°æ¥è¿›è¡Œå¤„ç†ã€‚ // //go:nosplit æ˜¯ä¸€ä¸ªç¼–è¯‘å™¨æŒ‡ä»¤ï¼Œå®ƒå‘Šè¯‰ç¼–è¯‘å™¨ä¸è¦åœ¨è¿™ä¸ªå‡½æ•°ä¸­æ’å…¥æ ˆåˆ†å‰²æ£€æŸ¥ã€‚ // è¿™æ„å‘³ç€è¿™ä¸ªå‡½æ•°å¿…é¡»åœ¨å½“å‰çš„æ ˆå¸§ä¸­è¿è¡Œï¼Œä¸èƒ½å¢åŠ æ ˆçš„å¤§å°ã€‚ // å¦‚æœè¿™ä¸ªå‡½æ•°éœ€è¦æ›´å¤šçš„æ ˆç©ºé—´ï¼Œé‚£ä¹ˆå®ƒå°†ä¼šå¯¼è‡´æ ˆæº¢å‡ºã€‚\tif timediv(12345*1000000000+54321, 1000000000, e) != 12345 || e != 54321 throw(bad timediv) // CAS æ“ä½œæ£€æŸ¥\tvar z uint32\tz = 1\tif !atomic.Cas(z, 1, 2) throw(cas1) ... // æ£€æŸ¥ atomic åŸå­æ“ä½œ\tm = [4]byte1, 1, 1, 1\tatomic.Or8(m[1], 0xf0)\tif m[0] != 1 || m[1] != 0xf1 || m[2] != 1 || m[3] != 1 throw(atomicor8) // æµ‹è¯•æµ®ç‚¹æ•° NaNï¼ˆNot a Numberï¼‰çš„è¡Œä¸º\t*(*uint64)(unsafe.Pointer(j)) = ^uint64(0)\tif j == j throw(float64nan) if !(j != j) throw(float64nan1) // æµ‹è¯• 64 ä½åŸå­æ“ä½œ\ttestAtomic64() // æ£€æŸ¥æ ˆå¤§å°æ˜¯å¦æ˜¯ 2 çš„ n æ¬¡å¹‚\tif fixedStack != round2(fixedStack) throw(FixedStack is not power-of-2) // ä¸ŠæŠ¥ç¼–ä»£ç çš„è¿è¡Œæ—¶æ£€æŸ¥ä¸­æ˜¯å¦æœ‰å¼‚å¸¸\tif !checkASM() throw(assembly checks failed) ç»¼ä¸Šï¼šruntimeÂ·check ä¸»è¦æ˜¯åšä¸€äº›è¿è¡Œæ—¶çš„æ£€æŸ¥ã€‚ ä½¿ç”¨ unsafe.Sizeof å‡½æ•°æ£€æŸ¥å„ç§ç±»å‹çš„å˜é‡çš„å¤§å°æ˜¯å¦ç¬¦åˆé¢„æœŸã€‚ ä½¿ç”¨ unsafe.Offsetof å‡½æ•°æ£€æŸ¥ç»“æ„ä½“ä¸­å­—æ®µçš„åç§»é‡æ˜¯å¦ç¬¦åˆé¢„æœŸã€‚ æµ‹è¯• timediv å‡½æ•°æ£€æŸ¥åœ¨ 32 ä½æœºå™¨ä¸Šè¿›è¡Œ 64 ä½é™¤æ³•è¿ç®—çš„ç»“æœæ˜¯å¦ç¬¦åˆé¢„æœŸã€‚ ä½¿ç”¨ atomic.Cas å‡½æ•°ï¼ˆCompare and Swapï¼‰è¿›è¡ŒåŸå­æ¯”è¾ƒå’Œäº¤æ¢æµ‹è¯•ã€‚ ä½¿ç”¨ atomic.Or8 å’Œ atomic.And8 å‡½æ•°è¿›è¡ŒåŸå­ä½æ“ä½œæµ‹è¯•ã€‚ æµ‹è¯•æµ®ç‚¹æ•° NaNï¼ˆNot a Numberï¼‰çš„è¡Œä¸ºã€‚ è°ƒç”¨ testAtomic64 å‡½æ•°æµ‹è¯• 64 ä½çš„åŸå­æ“ä½œã€‚ æ£€æŸ¥ fixedStack æ ˆå¤§å°æ˜¯å¦æ˜¯ 2 çš„å¹‚ã€‚ è°ƒç”¨ checkASM å‡½æ•°æ£€æŸ¥æ±‡ç¼–ä»£ç æ£€æŸ¥è¿è¡Œæ—¶ä¸­æ˜¯å¦æœ‰å¼‚å¸¸ã€‚ runtimeÂ·args package runtimevar (\targc int32\targv **byte)func args(c int32, v **byte) argc = c\targv = v\tsysargs(c, v) è¿™ä¸ªå‡½æ•°æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å°†å‘½ä»¤è¡Œå‚æ•°æ‹·è´åˆ° runtime åŒ…ä¸‹çš„å…¨å±€å˜é‡ argc å’Œ argv ä¸Šã€‚åé¢åœ¨ shcedinit() å‡½æ•°ä¸­ä¼šè°ƒç”¨ goargs() æ¥éå† argv å°†å‚æ•°å¤åˆ¶åˆ° slice ä¸Šã€‚ func goargs() if GOOS == windows return argslice = make([]string, argc)\tfor i := int32(0); i argc; i++ argslice[i] = gostringnocopy(argv_index(argv, i)) runtimeÂ·osinit è¿™é‡Œå‡½æ•°ä¸»è¦æ˜¯åˆå§‹åŒ–æ“ä½œç³»ç»Ÿç‰¹ç‚¹çš„è®¾ç½®ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œé’ˆå¯¹ä¸åŒæ“ä½œç³»ç»Ÿéƒ½åšäº†å®ç°ï¼š osinit è¿™é‡Œæˆ‘ä»¬ä»¥ os_windows.go ä¸ºä¾‹ï¼š func osinit() // è·å– asmstdcall å‡½æ•°çš„åœ°å€ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºä¸€ä¸ªä¸å®‰å…¨çš„æŒ‡é’ˆã€‚ // è¿™é€šå¸¸åœ¨éœ€è¦ç›´æ¥æ“ä½œå†…å­˜æˆ–è¿›è¡Œç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™ä½¿ç”¨ã€‚\tasmstdcallAddr = unsafe.Pointer(abi.FuncPCABI0(asmstdcall)) // åŠ è½½ä¸€äº›å¯é€‰çš„ç³»ç»Ÿè°ƒç”¨ã€‚\tloadOptionalSyscalls() // é˜»æ­¢æ˜¾ç¤ºé”™è¯¯å¯¹è¯æ¡†ã€‚è¿™å¯èƒ½æ˜¯ä¸ºäº†é˜²æ­¢åœ¨å‡ºç°é”™è¯¯æ—¶æ‰“æ–­ç”¨æˆ·ã€‚\tpreventErrorDialogs() // åˆå§‹åŒ–å¼‚å¸¸å¤„ç†å™¨ï¼Œç”¨äºå¤„ç†è¿è¡Œæ—¶å‘ç”Ÿçš„å¼‚å¸¸ã€‚\tinitExceptionHandler() // åˆå§‹åŒ–é«˜åˆ†è¾¨ç‡è®¡æ—¶å™¨ï¼Œç”¨äºç²¾ç¡®çš„æ—¶é—´æµ‹é‡ã€‚\tinitHighResTimer()\ttimeBeginPeriodRetValue = osRelax(false) // åˆå§‹åŒ–ç³»ç»Ÿç›®å½•\tinitSysDirectory() // å¯ç”¨é•¿è·¯å¾„æ”¯æŒã€‚ // åœ¨ Windows ä¸­ï¼Œè·¯å¾„çš„é•¿åº¦é€šå¸¸é™åˆ¶ä¸º 260 ä¸ªå­—ç¬¦ã€‚å¯ç”¨é•¿è·¯å¾„æ”¯æŒå¯ä»¥çªç ´è¿™ä¸ªé™åˆ¶ã€‚\tinitLongPathSupport() // ç è·å–å¤„ç†å™¨çš„æ•°é‡å¹¶å°†å…¶èµ‹ç»™ ncpuã€‚ ncpu = getproccount() // è·å–å†…å­˜é¡µçš„å¤§å°å¹¶å°†å…¶èµ‹ç»™ physPageSizeï¼Œä¸ºäº†åé¢è¿›è¡Œå†…å­˜ç®¡ç†ã€‚\tphysPageSize = getPageSize() // è°ƒç”¨ SetProcessPriorityBoost å‡½æ•°ï¼Œç¦ç”¨åŠ¨æ€ä¼˜å…ˆçº§æå‡ã€‚ // åœ¨ Windows ä¸­ï¼ŒåŠ¨æ€ä¼˜å…ˆçº§æå‡æ˜¯ä¸€ç§æœºåˆ¶ï¼Œå¯ä»¥æ ¹æ®çº¿ç¨‹çš„ç±»å‹å’Œè¡Œä¸ºè‡ªåŠ¨è°ƒæ•´å…¶ä¼˜å…ˆçº§ã€‚ // ä½†åœ¨ Go çš„ç¯å¢ƒä¸­ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½æ˜¯ç­‰ä»·çš„ï¼Œéƒ½å¯èƒ½è¿›è¡Œ GUIã€IOã€è®¡ç®—ç­‰å„ç§æ“ä½œï¼Œ // æ‰€ä»¥åŠ¨æ€ä¼˜å…ˆçº§æå‡å¯èƒ½ä¼šå¸¦æ¥é—®é¢˜ï¼Œå› æ­¤è¿™é‡Œé€‰æ‹©ç¦ç”¨å®ƒã€‚\tstdcall2(_SetProcessPriorityBoost, currentProcess, 1) runtimeÂ·schedinit â˜… è¿™ä¸ªå‡½æ•°å°±éå¸¸é‡è¦äº†ï¼Œä»åå­—å°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¿™æ˜¯ Go è¯­è¨€è°ƒåº¦å™¨çš„åˆå§‹åŒ–è¿‡ç¨‹ã€‚è¿™ä¸ªå‡½æ•°ä½äºï¼šruntime/proc.goã€‚ æˆ‘ä»¬å¯ä»¥å…ˆæ¥çœ‹çœ‹ schedinit() çš„å‡½æ•°æ³¨é‡Šï¼Œè¿™é‡Œä¹Ÿé€éœ²äº† Go è¯­è¨€ç¨‹åºçš„å¯åŠ¨æµç¨‹çš„æ ¸å¿ƒé¡ºåºã€‚ // The bootstrap sequence is: å¯åŠ¨æµç¨‹é¡ºåºï¼š////\tcall osinit 1. è°ƒç”¨ osinit//\tcall schedinit 2. è°ƒç”¨ schedinit//\tmake queue new G 3. åˆ›å»ºä¸€ä¸ªåç¨‹ G//\tcall runtimeÂ·mstart 4. è°ƒç”¨ mstart//// The new G calls runtimeÂ·main. 5. G æ‰§è¡Œ runtime.mainfunc schedinit() æ¥ä¸‹æ¥æˆ‘ä»¬è¯¦ç»†æ¥çœ‹çœ‹ schedinit() éƒ½åšäº†äº›ä»€ä¹ˆï¼š func schedinit() // åˆå§‹åŒ–å„ç§é”ï¼Œå…¶ä¸­ lockRankXXX æŒ‡å®šé”çš„çº§åˆ«ã€‚\tlockInit(sched.lock, lockRankSched)\tlockInit(sched.sysmonlock, lockRankSysmon)\tlockInit(sched.deferlock, lockRankDefer)\tlockInit(sched.sudoglock, lockRankSudog)\tlockInit(deadlock, lockRankDeadlock)\tlockInit(paniclk, lockRankPanic)\tlockInit(allglock, lockRankAllg)\tlockInit(allpLock, lockRankAllp)\tlockInit(reflectOffs.lock, lockRankReflectOffs)\tlockInit(finlock, lockRankFin)\tlockInit(cpuprof.lock, lockRankCpuprof)\ttraceLockInit()\tlockInit(memstats.heapStats.noPLock, lockRankLeafRank)\t// å¦‚æœå¯ç”¨äº†ç«æ€æ£€æµ‹ï¼Œåˆ™åˆå§‹åŒ–ç«æ€æ£€æµ‹å™¨ï¼Œ // å³æˆ‘ä»¬ä½¿ç”¨ -race çš„æ—¶å€™ä¼šæ‰§è¡Œè¿™é‡Œã€‚\tgp := getg()\tif raceenabled gp.racectx, raceprocctx0 = raceinit() // é™åˆ¶ M çš„æ•°é‡ï¼Œå³çº¿ç¨‹çš„æ•°é‡ã€‚ // maxmcount int32 // maximum number of ms allowed (or die)\tsched.maxmcount = 10000\t// å°†è°ƒåº¦å™¨è®¾ç½®ä¸ºåˆå§‹æš‚åœçŠ¶æ€ï¼Œåœ¨å¿…è¦çš„åˆå§‹åŒ–å®Œæˆä¹‹å‰ä¸è°ƒåº¦ä»»ä½•åç¨‹ã€‚\tworldStopped() // è¿›è¡Œä¸€ç³»åˆ—çš„ç³»ç»Ÿåˆå§‹åŒ–ï¼ˆå†…å­˜ç®¡ç†ã€CPU è®¾ç½®ã€æ ˆã€ç®—æ³•ç­‰ï¼‰\tmoduledataverify()\tstackinit()\tmallocinit()\tgodebug := getGodebugEarly()\tinitPageTrace(godebug) // must run after mallocinit but before anything allocates\tcpuinit(godebug) // must run before alginit\talginit() // maps, hash, fastrand must not be used before this call\tfastrandinit() // must run before mcommoninit\tmcommoninit(gp.m, -1)\tmodulesinit() // provides activeModules\ttypelinksinit() // uses maps, activeModules\titabsinit() // uses activeModules\tstkobjinit() // must run before GC starts // è®¾ç½®å’Œä¿å­˜å½“å‰ M çš„ä¿¡å·æ©ç \tsigsave(gp.m.sigmask)\tinitSigmask = gp.m.sigmask // è§£æç¨‹åºå‚æ•°å’Œç¯å¢ƒå˜é‡\tgoargs()\tgoenvs()\tsecure()\tparsedebugvars() // åˆå§‹åŒ–åƒåœ¾å›æ”¶å™¨\tgcinit()\t// å¦‚æœè®¾ç½®äº† disableMemoryProfilingï¼Œå³ç¦ç”¨å†…å­˜åˆ†æï¼Œ // åˆ™å°† MemProfileRate ç½®ä¸º 0ï¼Œå…³é—­å†…å­˜åˆ†æã€‚\tif disableMemoryProfiling MemProfileRate = 0 // é”å®šè°ƒåº¦å™¨ï¼Œå¤„ç†ç¯å¢ƒå˜é‡ GOMAXPROCSï¼Œè¿™æ˜¯å¼€å‘è€…å¯ä»¥è®¾ç½®çš„å…è®¸çš„æœ€å¤šçš„ P çš„æ•°é‡ã€‚\tlock(sched.lock)\tsched.lastpoll.Store(nanotime())\tprocs := ncpu\tif n, ok := atoi32(gogetenv(GOMAXPROCS)); ok n 0 procs = n if procresize(procs) != nil throw(unknown runnable goroutine during bootstrap) unlock(sched.lock)\t// å°†è°ƒåº¦å™¨è®¾ç½®ä¸ºå¼€å§‹çŠ¶æ€ã€‚\tworldStarted() // ç¡®ä¿æ„å»ºç‰ˆæœ¬å’Œæ¨¡å—ä¿¡æ¯è¢«ä¿ç•™åœ¨æœ€ç»ˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚\tif buildVersion == buildVersion = unknown if len(modinfo) == 1 modinfo = æ€»ç»“ï¼šschedinit æ˜¯ Go è¯­è¨€è¿è¡Œæ—¶ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œè´Ÿè´£åˆå§‹åŒ–è°ƒåº¦å™¨åŠå…¶ç›¸å…³ç»„ä»¶ï¼Œå¦‚é”ã€ä¿¡å·æ©ç ã€å†…å­˜åˆ†é…ã€ä»¥åŠå…¶ä»–ç³»ç»Ÿçº§åˆ«çš„è®¾ç½®ï¼Œç¡®ä¿å¹¶å‘æ‰§è¡Œç¯å¢ƒçš„æ­£ç¡®é…ç½®å’Œé«˜æ•ˆè¿ä½œã€‚ å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š é”åˆå§‹åŒ–: å‡½æ•°å¼€å§‹æ—¶ï¼Œé€šè¿‡ lockInit è°ƒç”¨åˆå§‹åŒ–äº†å¤šä¸ªé”ã€‚åœ¨ Go çš„è°ƒåº¦å™¨ä¸­ï¼Œé”ç”¨äºä¿æŠ¤å…±äº«èµ„æºå’Œè°ƒåº¦æ•°æ®ç»“æ„ï¼Œç¡®ä¿åœ¨å¤šä¸ªçº¿ç¨‹æˆ–åç¨‹ä¸­çš„å®‰å…¨è®¿é—®ã€‚æ¯ä¸ªé”éƒ½æœ‰ä¸€ä¸ªç‰¹å®šçš„çº§åˆ«ï¼Œè¿™æœ‰åŠ©äºé˜²æ­¢æ­»é”ã€‚ ç«æ€æ£€æµ‹å™¨åˆå§‹åŒ–: å¦‚æœå¯ç”¨äº†ç«æ€æ£€æµ‹ (raceenabled)ï¼Œåˆ™åˆå§‹åŒ–ç«æ€ä¸Šä¸‹æ–‡ã€‚è¿™å¯¹äºåœ¨å¼€å‘é˜¶æ®µæ£€æµ‹å’Œé¿å…ç«æ€æ¡ä»¶éå¸¸é‡è¦ã€‚ è°ƒåº¦å™¨è®¾ç½®: sched.maxmcount = 10000 è®¾ç½®è°ƒåº¦å™¨å¯ä»¥ç®¡ç†çš„æœ€å¤§çº¿ç¨‹ï¼ˆMï¼‰æ•°ç›®ï¼Œè¿™å¯¹äºæ§åˆ¶èµ„æºä½¿ç”¨å’Œæ€§èƒ½è°ƒä¼˜å¾ˆé‡è¦ã€‚ worldStopped() å°†è°ƒåº¦å™¨è®¾ç½®ä¸ºåˆå§‹æš‚åœçŠ¶æ€ï¼Œåœ¨å¿…è¦çš„åˆå§‹åŒ–å®Œæˆä¹‹å‰ä¸è°ƒåº¦ä»»ä½•åç¨‹ã€‚ ç³»ç»Ÿåˆå§‹åŒ–: æ¥ä¸‹æ¥è°ƒç”¨ä¸€ç³»åˆ—å‡½æ•°ï¼ˆå¦‚ moduledataverify, mallocinit, cpuinit, alginit ç­‰ï¼‰æ¥åˆå§‹åŒ–å†…å­˜ç®¡ç†ã€CPU è®¾ç½®ã€ç®—æ³•ç­‰ï¼Œè¿™äº›éƒ½æ˜¯è°ƒåº¦å™¨æ­£å¸¸å·¥ä½œçš„åŸºç¡€ã€‚ ç¯å¢ƒå’Œè°ƒè¯•å˜é‡è®¾ç½®: è§£æç¨‹åºå‚æ•°ã€ç¯å¢ƒå˜é‡ã€å®‰å…¨è®¾ç½®å’Œè°ƒè¯•å˜é‡ã€‚ åƒåœ¾æ”¶é›†å™¨åˆå§‹åŒ–: gcinit() åˆå§‹åŒ–åƒåœ¾æ”¶é›†å™¨ï¼Œè¿™æ˜¯ Go è¿è¡Œæ—¶çš„å…³é”®ç»„æˆéƒ¨åˆ†ï¼Œè´Ÿè´£è‡ªåŠ¨å†…å­˜ç®¡ç†ã€‚ å†…å­˜åˆ†æè®¾ç½®: æ ¹æ® disableMemoryProfiling æ ‡å¿—å†³å®šæ˜¯å¦å…³é—­å†…å­˜åˆ†æåŠŸèƒ½ã€‚ å¤„ç†å™¨æ•°é‡è®¾ç½®å’Œè°ƒåº¦å™¨é”: é”å®šè°ƒåº¦å™¨æ¥å®‰å…¨åœ°åŸºäºç¯å¢ƒå˜é‡ GOMAXPROCS è®¾ç½®å¤„ç†å™¨ï¼ˆprocsï¼‰æ•°é‡ã€‚ ä½¿ç”¨ procresize å‡½æ•°æ ¹æ®å¤„ç†å™¨æ•°é‡è°ƒæ•´è°ƒåº¦å™¨çš„å†…éƒ¨ç»“æ„ã€‚ æœ€ç»ˆæ­¥éª¤å’Œé”™è¯¯æ£€æŸ¥: è°ƒç”¨ worldStarted() è¡¨ç¤ºè°ƒåº¦å™¨å·²å‡†å¤‡å¥½å¼€å§‹è°ƒåº¦åç¨‹ã€‚ æ£€æŸ¥å’Œè®¾ç½®æ„å»ºç‰ˆæœ¬å’Œæ¨¡å—ä¿¡æ¯ï¼Œä¿è¯è¿™äº›ä¿¡æ¯åœ¨æœ€ç»ˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚ è¿™é‡Œæœ‰å‡ ä¸ªåœ°æ–¹æ¯”è¾ƒæœ‰è¶£ï¼Œæˆ‘ä»¬æ¥åšä¸€ä¸‹ç®€å•çš„äº†è§£ã€‚ï¼ˆå¯è·³è¿‡ï¼‰ åˆå§‹åŒ–é” lockInit(mutex, rank) æˆ‘ä»¬çŸ¥é“ lockInit(mutex,rank) æ˜¯ç”¨æ¥åˆå§‹åŒ–é”çš„ï¼Œç¬¬ 2 ä¸ªå‚æ•° rank ä¾¿æ˜¯é”çš„ç­‰çº§ã€‚å¦‚æœè¿™ä¸ªæ—¶å€™ä½ é“¾æ¥åˆ° lcokInit å®ç°çš„åœ°æ–¹ï¼Œä½ ä¼šå‘ç°é»˜è®¤ä¼šè·³åˆ° lockrank_off.goï¼Œè€Œä¸”ä½ ä¼šå‘ç°ï¼Œå®ƒçš„å®ç°æ˜¯ç©ºçš„ï¼š //go:build !goexperiment.staticlockrankingpackage runtimefunc lockInit(l *mutex, rank lockRank) å…¶å® lockInit è¿˜æœ‰å¦å¤–ä¸€ä¸ªå®ç°ï¼Œåœ¨ lockrank_on.go æ–‡ä»¶ä¸­ï¼š //go:build goexperiment.staticlockrankingpackage runtimeconst staticLockRanking = truefunc getLockRank(l *mutex) lockRank return l.rank è¿™ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿé€šè¿‡æ–‡ä»¶åç§°æˆ‘ä»¬å…¶å®å°±å¯ä»¥çŒœåˆ°äº†ï¼Œlockrank_off.go æ˜¯æä¾›äº†æ— é”çº§åˆ«çš„é”ï¼Œè€Œ lockrank_on.go æ˜¯æä¾›äº†æœ‰é”çº§åˆ«çš„é”ã€‚è‡³äºåº”è¯¥é‡‡ç”¨å“ªä¸€ä¸ªï¼Œæ˜¯é€šè¿‡ go build ä¸­çš„ goexperiment.staticlockranking å‚æ•°æ¥æ§åˆ¶çš„ã€‚ è¿™é‡Œæ¶‰åŠä¸€ä¸ªæ¦‚å¿µï¼Œå«åšé”æ’åºï¼ˆLock Rankingï¼‰ï¼š é”æ’åºæ˜¯ä¸€ç§ç”¨äºé¿å…æ­»é”çš„æŠ€æœ¯ã€‚åœ¨è¿™ç§æœºåˆ¶ä¸­ï¼Œæ¯ä¸ªé”éƒ½è¢«èµ‹äºˆä¸€ä¸ªç­‰çº§ï¼ˆæˆ–ç§°ä¸º â€œrankâ€ï¼‰ï¼Œå¹¶ä¸”æœ‰è§„åˆ™ç¡®ä¿é”çš„è·å–éµå¾ªè¿™äº›ç­‰çº§çš„é¡ºåºã€‚ é€šå¸¸ï¼Œè¿™æ„å‘³ç€ä¸€ä¸ªçº¿ç¨‹åœ¨è·å–ç­‰çº§è¾ƒä½çš„é”ä¹‹å‰ï¼Œå¿…é¡»å…ˆé‡Šæ”¾æ‰€æœ‰ç­‰çº§è¾ƒé«˜çš„é”ã€‚è¿™æ ·å¯ä»¥é˜²æ­¢æ­»é”ï¼Œå› ä¸ºå®ƒé¿å…äº†å¾ªç¯ç­‰å¾…æ¡ä»¶çš„å‘ç”Ÿã€‚ Go è¯­è¨€ä¸­é”çš„ç­‰çº§å’Œé¡ºåºå®šä¹‰åœ¨ lockrank.go æ–‡ä»¶ä¸­ã€‚ é”æ’åºçš„ä½œç”¨ï¼š åœ¨ Go çš„å¹¶å‘æ¨¡å‹ä¸­ï¼Œé”æ˜¯åŒæ­¥å…±äº«èµ„æºè®¿é—®çš„é‡è¦æœºåˆ¶ã€‚lockInit å‡½æ•°åœ¨è¿è¡Œæ—¶åˆå§‹åŒ–é”ï¼Œä¸ºå…¶åˆ†é…ç­‰çº§ï¼Œæœ‰åŠ©äºç»´æŠ¤ç¨‹åºçš„ç¨³å®šæ€§å’Œæ€§èƒ½ã€‚ é”æ’åºåŠŸèƒ½çš„å¼€å¯æˆ–å…³é—­å–å†³äºæ˜¯å¦éœ€è¦é¢å¤–çš„æ­»é”æ£€æµ‹ã€‚åœ¨å¼€å‘å’Œè°ƒè¯•é˜¶æ®µï¼Œå¼€å¯é”æ’åºå¯ä»¥å¸®åŠ©å‘ç°æ­»é”é—®é¢˜ã€‚ç„¶è€Œï¼Œå®ƒå¯èƒ½å¼•å…¥é¢å¤–çš„æ€§èƒ½å¼€é”€ï¼Œå› æ­¤åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¯èƒ½ä¼šè¢«å…³é—­ã€‚ æœ€åæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ schedinit() éƒ½åˆå§‹åŒ–äº†å“ªäº›é”ï¼š Lock Description sched.lock åˆå§‹åŒ–è°ƒåº¦å™¨çš„ä¸»é”ã€‚è¿™ä¸ªé”ç”¨äºæ§åˆ¶å¯¹è°ƒåº¦å™¨çš„è®¿é—®ï¼Œä¿è¯è°ƒåº¦è¿‡ç¨‹çš„æ­£ç¡®æ€§ã€‚ sched.sysmonlock ç³»ç»Ÿç›‘æ§é”ï¼Œç”¨äºä¿æŠ¤ç³»ç»Ÿç›‘æ§ç›¸å…³çš„æ•°æ®ç»“æ„ã€‚ sched.deferlock ç”¨äºæ§åˆ¶å»¶è¿Ÿæ‰§è¡Œå‡½æ•°åˆ—è¡¨çš„é”ã€‚ sched.sudoglock sudog æ˜¯ Go ä¸­è¡¨ç¤ºç­‰å¾…é€šä¿¡çš„ goroutine çš„ç»“æ„ã€‚è¿™ä¸ªé”ä¿æŠ¤ä¸ sudog ç›¸å…³çš„æ“ä½œã€‚ deadlock å¯èƒ½ç”¨äºæ£€æµ‹æˆ–é˜²æ­¢æ­»é”çš„é”ã€‚ paniclk åœ¨å¤„ç† panic æ—¶ä½¿ç”¨çš„é”ã€‚ allglock ç”¨äºæ§åˆ¶å¯¹æ‰€æœ‰ goroutine åˆ—è¡¨çš„è®¿é—®ã€‚ allpLock æ§åˆ¶å¯¹æ‰€æœ‰å¤„ç†å™¨ï¼ˆPï¼‰çš„è®¿é—®ã€‚ reflectOffs.lock ç”¨äºåå°„æ“ä½œçš„é”ã€‚ finlock ç®¡ç†ç»ˆç»“å™¨åˆ—è¡¨çš„é”ã€‚ cpuprof.lock ç”¨äº CPU åˆ†ææ•°æ®çš„é”ã€‚ traceLockInit() ä¸“é—¨ç”¨äºè¿½è¸ªç³»ç»Ÿçš„é”åˆå§‹åŒ–å‡½æ•°ã€‚ memstats.heapStats.noPLock è¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„é”ï¼Œè¢«æ ‡è®°ä¸º lockRankLeafRankï¼Œæ„å‘³ç€å®ƒåº”è¯¥æ˜¯é”å±‚çº§ä¸­çš„æœ€æœ«ç«¯ï¼ˆleafï¼‰ã€‚è¿™æ ·çš„é”åº”è¯¥åªåœ¨éå¸¸çŸ­çš„å…³é”®éƒ¨åˆ†ä¸­ä½¿ç”¨ï¼Œä»¥é¿å…æˆä¸ºæ­»é”çš„æºå¤´ã€‚ ä¿¡å·æ©ç  initSigmask è¿™ä¸¤è¡Œä»£ç æ˜¯åœ¨æå•¥å‘¢ï¼Ÿ sigsave(gp.m.sigmask)initSigmask = gp.m.sigmask sigmask çš„ä¸­æ–‡æ„æ€æ˜¯ ä¿¡å·æ©ç ã€‚ å…ˆçœ‹ä¸€ä¸‹æºç ä¸­ initSigmast çš„æ³¨é‡Šï¼š // Value to use for signal mask for newly created Ms.var initSigmask sigset initSigmask æ˜¯ä¸€ä¸ªå˜é‡ï¼Œå­˜å‚¨ç€ç”¨äºæ–°åˆ›å»ºçš„ Mï¼ˆMachineï¼Œå³æ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼‰çš„åˆå§‹ä¿¡å·æ©ç ã€‚ ä»€ä¹ˆæ˜¯ä¿¡å·æ©ç ï¼š ä¿¡å·æ©ç æ˜¯æ“ä½œç³»ç»Ÿä¸­ç”¨äºæ§åˆ¶ä¿¡å·ä¼ é€’ç»™è¿›ç¨‹æˆ–çº¿ç¨‹çš„ä¸€ç§æœºåˆ¶ã€‚å®ƒå…è®¸è¿›ç¨‹æˆ–çº¿ç¨‹æŒ‡å®šå“ªäº›ä¿¡å·å¯ä»¥è¢«é˜»å¡ï¼ˆæš‚æ—¶å¿½ç•¥ï¼‰æˆ–å…è®¸ã€‚åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œè¿™ä¸ªæœºåˆ¶å°¤å…¶é‡è¦ï¼Œå› ä¸ºå®ƒå¸®åŠ©ç¡®ä¿çº¿ç¨‹å®‰å…¨åœ°å¤„ç†ä¿¡å·ã€‚ ä¿¡å·æ©ç çš„ä½œç”¨ï¼š ä¿¡å·æ©ç å®šä¹‰äº†ä¸€ç»„ä¿¡å·ï¼Œè¿™äº›ä¿¡å·åœ¨ç‰¹å®šæ—¶é—´å†…ä¸ä¼šä¼ é€’ç»™è¿›ç¨‹æˆ–çº¿ç¨‹ï¼Œå³ä½¿è¿™äº›ä¿¡å·å‘ç”Ÿäº†ä¹Ÿä¼šè¢«ç³»ç»ŸæŒ‚èµ·ã€‚è¿™å…è®¸è¿›ç¨‹æˆ–çº¿ç¨‹åœ¨ä¸€ä¸ªç¨³å®šçš„çŠ¶æ€ä¸‹è¿è¡Œï¼Œä¸è¢«ç‰¹å®šä¿¡å·ä¸­æ–­ã€‚ è¿™ç§æœºåˆ¶å¯¹äºå¤„ç†é‚£äº›å¯èƒ½åœ¨å…³é”®æ“ä½œæœŸé—´å¯¼è‡´ä¸ç¨³å®šçŠ¶æ€çš„ä¿¡å·ç‰¹åˆ«é‡è¦ã€‚ ä¿¡å·æ©ç çš„é‡è¦æ€§ï¼š åœ¨å¤šçº¿ç¨‹ç¨‹åºä¸­ï¼Œä¸åŒçš„çº¿ç¨‹å¯èƒ½éœ€è¦å“åº”ä¸åŒçš„ä¿¡å·æˆ–ä»¥ä¸åŒæ–¹å¼å¤„ç†ç›¸åŒçš„ä¿¡å·ã€‚é€šè¿‡ä¸ºæ¯ä¸ªçº¿ç¨‹è®¾ç½®é€‚å½“çš„ä¿¡å·æ©ç ï¼Œå¯ä»¥ç¡®ä¿çº¿ç¨‹åªå¤„ç†å¯¹å®ƒä»¬æ¥è¯´é‡è¦çš„ä¿¡å·ã€‚ è¿™æœ‰åŠ©äºé˜²æ­¢çº¿ç¨‹åœ¨æ‰§è¡Œå…³é”®ä»£ç æ—¶è¢«ä¸ç›¸å…³çš„ä¿¡å·æ‰“æ–­ã€‚ sigsave(gp.m.sigmask)ï¼š sigsave(gp.m.sigmask) è¿™ä¸ªè°ƒç”¨æ˜¯åœ¨ä¿å­˜å½“å‰ M çš„ä¿¡å·æ©ç ã€‚gp æŒ‡çš„æ˜¯å½“å‰çš„ goroutineï¼Œgp.m æ˜¯è¯¥ goroutine æ­£åœ¨è¿è¡Œçš„ Mï¼ˆæ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼‰ã€‚ sigsave å‡½æ•°çš„ä½œç”¨æ˜¯å°† gp.m çš„å½“å‰ä¿¡å·æ©ç ä¿å­˜åˆ°æä¾›çš„åœ°å€ï¼ˆåœ¨è¿™é‡Œæ˜¯ gp.m.sigmaskï¼‰ã€‚è¿™å¯¹äºæ¢å¤çº¿ç¨‹çš„ä¿¡å·æ©ç åˆ°ä¸€ä¸ªå·²çŸ¥çŠ¶æ€æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚ initSigmask = gp.m.sigmaskï¼š è¿™ä¸€è¡Œå°† gp.m çš„ä¿¡å·æ©ç èµ‹å€¼ç»™ initSigmaskã€‚è¿™æ„å‘³ç€ initSigmask ç°åœ¨ä¿å­˜äº†å½“å‰ M çš„ä¿¡å·æ©ç ï¼Œè¿™ä¸ªæ©ç å°†è¢«ç”¨ä½œæ–°åˆ›å»ºçš„ M çš„åˆå§‹ä¿¡å·æ©ç ã€‚ è¿™æ˜¯ä¸€ä¸ªé‡è¦çš„æ­¥éª¤ï¼Œå› ä¸ºå®ƒç¡®ä¿äº†æ‰€æœ‰æ–°åˆ›å»ºçš„ M éƒ½å°†å…·æœ‰ä¸å½“å‰ M ç›¸åŒçš„ä¿¡å·å¤„ç†è¡Œä¸ºã€‚ è¿™æ„å‘³ç€æ‰€æœ‰æ–°çº¿ç¨‹éƒ½ä¼šä»¥ä¸€è‡´çš„ä¿¡å·æ©ç å¯åŠ¨ï¼Œè¿™æœ‰åŠ©äºé¿å…ç”±äºä¸åŒçº¿ç¨‹å¤„ç†ä¿¡å·çš„ä¸ä¸€è‡´æ€§å¯¼è‡´çš„é—®é¢˜ã€‚ æ€»ä½“æ¥è¯´ï¼ŒGo è¯­è¨€åœ¨å…¶è¿è¡Œæ—¶ä¸­è¿™æ ·å¤„ç†ä¿¡å·æ©ç ï¼Œæ˜¯ä¸ºäº†ç¡®ä¿åœ¨å¹¶å‘æ‰§è¡Œå’Œçº¿ç¨‹è°ƒåº¦ä¸­èƒ½å¤Ÿå®‰å…¨ã€ä¸€è‡´åœ°å¤„ç†ä¿¡å·ï¼Œè¿™å¯¹äºç»´æŠ¤é«˜æ•ˆå’Œç¨³å®šçš„è¿è¡Œæ—¶ç¯å¢ƒè‡³å…³é‡è¦ã€‚ åˆå§‹åŒ–åƒåœ¾å›æ”¶å™¨ gcinit() func gcinit() // æ£€æŸ¥ workbuf ç»“æ„ä½“çš„å¤§å°æ˜¯å¦ç­‰äºé¢„æœŸçš„ _WorkbufSizeã€‚ // å¦‚æœä¸æ˜¯ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚è¿™æ˜¯ä¸ºäº†ç¡®ä¿ workbuf çš„å¤§å°æ˜¯æœ€ä¼˜çš„ï¼Œ // workbuf ç”¨äºåƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­çš„å†…éƒ¨å·¥ä½œã€‚ if unsafe.Sizeof(workbuf) != _WorkbufSize throw(size of Workbuf is suboptimal) // ç¬¬ä¸€ä¸ªåƒåœ¾å›æ”¶å‘¨æœŸä¸è¿›è¡Œæ‰«ææ“ä½œã€‚ // åœ¨ Go çš„åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­ï¼Œæ‰«ææ˜¯å›æ”¶å‰æ¸…ç†å†…å­˜çš„é‡è¦æ­¥éª¤ã€‚ sweep.active.state.Store(sweepDrainedMask) // ä½¿ç”¨ç¯å¢ƒå˜é‡ GOGC å’Œ GOMEMLIMIT æ¥è®¾ç½®åˆå§‹çš„åƒåœ¾å›æ”¶ç™¾åˆ†æ¯”å’Œå†…å­˜é™åˆ¶ã€‚ gcController.init(readGOGC(), readGOMEMLIMIT()) // åˆå§‹åŒ–ç”¨äºæ§åˆ¶åƒåœ¾å›æ”¶å·¥ä½œæµç¨‹çš„ä¿¡å·é‡ã€‚ // è¿™äº›ä¿¡å·é‡ç”¨äºåŒæ­¥åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­çš„ä¸åŒé˜¶æ®µã€‚ work.startSema = 1 work.markDoneSema = 1 // åˆå§‹åŒ–äº†ç”¨äºåƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­çš„å„ç§é”ã€‚ // è¿™äº›é”ç”¨äºä¿æŠ¤åƒåœ¾å›æ”¶ç›¸å…³æ•°æ®ç»“æ„çš„å¹¶å‘è®¿é—®ï¼Œç¡®ä¿åƒåœ¾å›æ”¶è¿‡ç¨‹çš„çº¿ç¨‹å®‰å…¨ã€‚ lockInit(work.sweepWaiters.lock, lockRankSweepWaiters) lockInit(work.assistQueue.lock, lockRankAssistQueue) lockInit(work.wbufSpans.lock, lockRankWbufSpans)func (c *gcControllerState) init(gcPercent int32, memoryLimit int64) // è®¾ç½® heapMinimum ä¸ºé»˜è®¤çš„æœ€å°å †å¤§å°ã€‚ // è¿™æ˜¯åƒåœ¾å›æ”¶å™¨è€ƒè™‘å¯åŠ¨æ–°å›æ”¶å‘¨æœŸå‰çš„æœ€å°å †å†…å­˜å¤§å°ã€‚\tc.heapMinimum = defaultHeapMinimum // å°† triggered è®¾ç½®ä¸º uint64 çš„æœ€å¤§å€¼ã€‚ // è¿™ä¸ªå­—æ®µç”¨äºè¡¨ç¤ºè§¦å‘åƒåœ¾å›æ”¶çš„å†…å­˜é˜ˆå€¼ï¼Œ // è¿™é‡Œçš„è®¾ç½®æ„å‘³ç€åœ¨åˆå§‹çŠ¶æ€ä¸‹ä¸ä¼šè‡ªåŠ¨è§¦å‘åƒåœ¾å›æ”¶\tc.triggered = ^uint64(0) // è®¾ç½®åƒåœ¾å›æ”¶çš„ç™¾åˆ†æ¯”é˜ˆå€¼ã€‚ // gcPercent å‚æ•°è¡¨ç¤ºè§¦å‘åƒåœ¾å›æ”¶çš„å†…å­˜å¢é•¿ç™¾åˆ†æ¯”ã€‚ // è¿™ä¸ªè®¾ç½®æ§åˆ¶äº†å †å†…å­˜å¢é•¿åˆ°å¤šå°‘ç™¾åˆ†æ¯”æ—¶ä¼šè§¦å‘åƒåœ¾å›æ”¶ã€‚\tc.setGCPercent(gcPercent) // è®¾ç½®å†…å­˜é™åˆ¶ã€‚ // memoryLimit å‚æ•°å¯èƒ½è¡¨ç¤ºå †å†…å­˜çš„æœ€å¤§é™åˆ¶ï¼Œ // ç”¨äºæ§åˆ¶åƒåœ¾å›æ”¶å™¨åœ¨å†…å­˜ä½¿ç”¨æ–¹é¢çš„è¡Œä¸ºã€‚\tc.setMemoryLimit(memoryLimit) // æäº¤åƒåœ¾å›æ”¶æ§åˆ¶å™¨çš„å½“å‰è®¾ç½®ï¼Œå¹¶æŒ‡ç¤ºç¬¬ä¸€æ¬¡åƒåœ¾å›æ”¶å‘¨æœŸæ²¡æœ‰æ‰«æï¼ˆsweepï¼‰é˜¶æ®µã€‚ // åœ¨ Go çš„åƒåœ¾å›æ”¶ä¸­ï¼Œæ‰«ææ˜¯å›æ”¶å‘¨æœŸçš„ä¸€éƒ¨åˆ†ï¼Œè¿™é‡ŒæŒ‡æ˜åœ¨ç¬¬ä¸€æ¬¡åƒåœ¾å›æ”¶æ—¶è·³è¿‡æ‰«æé˜¶æ®µã€‚\tc.commit(true) runtimeÂ·newproc â˜… åˆå§‹åŒ–å®Œè°ƒåº¦å™¨åï¼Œå°±è¿›å…¥åˆ°åˆ›å»º g0 çš„é˜¶æ®µäº†ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªåç¨‹æ¥è¿è¡Œç¨‹åºçš„å…¥å£ï¼šruntime.mainã€‚ newproc() çš„ä½œç”¨å¦‚æ³¨é‡Šæ‰€è¯´ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ goroutine æ¥æ‰§è¡Œ fnï¼Œå¹¶å°†å®ƒæ”¾å…¥ç­‰å¾…è¿è¡Œçš„ g é˜Ÿåˆ—ä¸­ã€‚ // Create a new g running fn.// Put it on the queue of gs waiting to run.// The compiler turns a go statement into a call to this.func newproc(fn *funcval) gp := getg() // è·å–å½“å‰åç¨‹\tpc := getcallerpc() // è·å–å½“å‰ç¨‹åºè®¡æ•°å™¨\tsystemstack(func() // åœ¨ç³»ç»Ÿæ ˆä¸Šæ‰§è¡Œæ–° goroutine çš„åˆ›å»º newg := newproc1(fn, gp, pc)\t// åˆ›å»ºæ–° goroutine pp := getg().m.p.ptr()\t// è·å–å½“å‰ M ç»‘å®šçš„ P runqput(pp, newg, true)\t// å°†æ–°åˆ›å»ºçš„ goroutine æ”¾å…¥ P çš„æœ¬åœ°é˜Ÿåˆ—ä¸­ if mainStarted wakep()\t// å¦‚æœä¸»ç¨‹åºå·²ç»å¯åŠ¨ï¼Œåˆ™å”¤é†’æˆ–å¯åŠ¨ä¸€ä¸ª Mï¼Œä»¥ç¡®ä¿æ–°çš„ goroutine æœ‰æœºä¼šè¢«æ‰§è¡Œ ) é‡ç‚¹æ¥çœ‹ä¸€ä¸‹ newproc1() å’Œ runqput()ã€‚ åˆ›å»ºåç¨‹ newproc1() è¿™æ®µä»£ç çš„ä¸»è¦ä½œç”¨æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„ goroutine å¹¶è®¾ç½®å…¶åˆå§‹çŠ¶æ€ï¼Œä»¥ä¾¿å®ƒå¯ä»¥è¢«è°ƒåº¦å™¨å®‰æ’è¿è¡Œã€‚å®ƒå¤„ç†äº†ä»åˆ†é… goroutine çš„å†…å­˜åˆ°è®¾ç½®å…¶æ ˆç©ºé—´å’Œè°ƒåº¦ä¿¡æ¯ç­‰ä¸€ç³»åˆ—æ­¥éª¤ã€‚ // åˆ›å»ºä¸€ä¸ªæ–°çš„ goroutineï¼ŒçŠ¶æ€ä¸º _Grunnableï¼Œä»å‡½æ•° fn å¼€å§‹æ‰§è¡Œã€‚// callerpc æ˜¯åˆ›å»ºæ­¤ goroutine çš„ go è¯­å¥çš„åœ°å€ã€‚// è°ƒç”¨è€…è´Ÿè´£å°†æ–°çš„ g æ·»åŠ åˆ°è°ƒåº¦å™¨ä¸­ã€‚func newproc1(fn *funcval, callergp *g, callerpc uintptr) *g if fn == nil fatal(go of nil func value) // å¦‚æœ fn æ˜¯ nilï¼ŒæŠ›å‡ºè‡´å‘½é”™è¯¯ mp := acquirem() // ç¦ç”¨æŠ¢å ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨å±€éƒ¨å˜é‡ä¸­æŒæœ‰ M å’Œ P\tpp := mp.p.ptr()\tnewg := gfget(pp) // å°è¯•ä» P çš„ç©ºé—²åˆ—è¡¨ä¸­è·å–ä¸€ä¸ª g\tif newg == nil newg = malg(stackMin) // å¦‚æœæ²¡æœ‰ç©ºé—²çš„ gï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ casgstatus(newg, _Gidle, _Gdead) // å°† g çš„çŠ¶æ€ä» _Gidle æ”¹ä¸º _Gdead allgadd(newg) // å°†æ–°çš„ g æ·»åŠ åˆ°æ‰€æœ‰ goroutine çš„åˆ—è¡¨ä¸­ if newg.stack.hi == 0 throw(newproc1: newg missing stack) // å¦‚æœæ–°çš„ g æ²¡æœ‰æ ˆï¼ŒæŠ›å‡ºå¼‚å¸¸ if readgstatus(newg) != _Gdead throw(newproc1: new g is not Gdead) // ç¡®ä¿æ–°çš„ g çš„çŠ¶æ€ä¸º _Gdead totalSize := uintptr(4*goarch.PtrSize + sys.MinFrameSize) // è®¡ç®—é¢å¤–çš„æ ˆç©ºé—´å¤§å°\ttotalSize = alignUp(totalSize, sys.StackAlign) // æ ˆç©ºé—´å¯¹é½\tsp := newg.stack.hi - totalSize // è®¾ç½®æ ˆæŒ‡é’ˆ\tspArg := sp\tif usesLR *(*uintptr)(unsafe.Pointer(sp)) = 0 // é’ˆå¯¹ LR æ¶æ„ï¼Œè®¾ç½®è°ƒç”¨è€…çš„ LR prepGoExitFrame(sp) spArg += sys.MinFrameSize memclrNoHeapPointers(unsafe.Pointer(newg.sched), unsafe.Sizeof(newg.sched)) // æ¸…é™¤è°ƒåº¦å™¨çš„å†…å­˜\tnewg.sched.sp = sp // è®¾ç½®è°ƒåº¦å™¨çš„æ ˆæŒ‡é’ˆ\tnewg.stktopsp = sp // è®¾ç½®æ ˆé¡¶æŒ‡é’ˆ\t// è®¾ç½®è°ƒåº¦å™¨çš„ç¨‹åºè®¡æ•°å™¨ï¼Œ+PCQuantum ä½¿å¾—å‰ä¸€ä¸ªæŒ‡ä»¤åœ¨åŒä¸€å‡½æ•°ä¸­\tnewg.sched.pc = abi.FuncPCABI0(goexit) + sys.PCQuantum newg.sched.g = guintptr(unsafe.Pointer(newg)) // è®¾ç½®è°ƒåº¦å™¨çš„ g æŒ‡é’ˆ\tgostartcallfn(newg.sched, fn) // å¯åŠ¨æ–°çš„ g æ‰§è¡Œå‡½æ•° fn\tnewg.parentGoid = callergp.goid // è®¾ç½®æ–° g çš„çˆ¶ goroutine ID\tnewg.gopc = callerpc // è®¾ç½®æ–° g çš„åˆ›å»ºä½ç½®\tnewg.ancestors = saveAncestors(callergp) // ä¿å­˜ç¥–å…ˆä¿¡æ¯\tnewg.startpc = fn.fn // è®¾ç½®æ–° g çš„èµ·å§‹å‡½æ•°åœ°å€\tif isSystemGoroutine(newg, false) sched.ngsys.Add(1) // å¦‚æœæ˜¯ç³»ç»Ÿ goroutineï¼Œå¢åŠ è®¡æ•° else if mp.curg != nil newg.labels = mp.curg.labels // åªæœ‰ç”¨æˆ· goroutines ç»§æ‰¿ pprof æ ‡ç­¾ if goroutineProfile.active newg.goroutineProfiled.Store(goroutineProfileSatisfied) // æ ‡è®°ä¸éœ€è¦çº³å…¥ goroutine åˆ†æ newg.trackingSeq = uint8(fastrand()) // è®¾ç½®è¿½è¸ªåºåˆ—å·\tif newg.trackingSeq%gTrackingPeriod == 0 newg.tracking = true // æ˜¯å¦å¯ç”¨è¿½è¸ª casgstatus(newg, _Gdead, _Grunnable) // å°†æ–° g çš„çŠ¶æ€ä» _Gdead æ”¹ä¸º _Grunnable\tgcController.addScannableStack(pp, int64(newg.stack.hi-newg.stack.lo)) // å°†æ–° g çš„æ ˆæ·»åŠ åˆ°å¯æ‰«ææ ˆåˆ—è¡¨\tif pp.goidcache == pp.goidcacheend pp.goidcache = sched.goidgen.Add(_GoidCacheBatch) // åˆ†é…æ–°çš„ goroutine ID pp.goidcache -= _GoidCacheBatch - 1 pp.goidcacheend = pp.goidcache + _GoidCacheBatch newg.goid = pp.goidcache // è®¾ç½®æ–° g çš„ ID\tpp.goidcache++\tif raceenabled newg.racectx = racegostart(callerpc) // è®¾ç½®ç«æ€æ£€æµ‹ä¸Šä¸‹æ–‡ newg.raceignore = 0 if newg.labels != nil racereleasemergeg(newg, unsafe.Pointer(labelSync)) // åŒæ­¥ç«æ€æ£€æµ‹å’Œä¿¡å·å¤„ç† if traceEnabled() traceGoCreate(newg, newg.startpc) // è®°å½•è¿½è¸ªä¿¡æ¯ releasem(mp) // é‡Šæ”¾å½“å‰ M\treturn newg // è¿”å›æ–°åˆ›å»ºçš„ goroutine newproc1() å‡½æ•°æ¦‚è¿° æœ‰å‡ ä¸ªåœ°æ–¹æ¯”è¾ƒæœ‰è¶£ï¼Œæˆ‘ä»¬å¯ä»¥æ¥ç ”ç©¶ä¸€ä¸‹ã€‚ è·å– g // The minimum size of stack used by Go codestackMin = 2048func newproc1() ... newg := gfget(pp) // å°è¯•ä» P çš„ç©ºé—²åˆ—è¡¨ä¸­è·å–ä¸€ä¸ª g if newg == nil newg = malg(stackMin) // å¦‚æœæ²¡æœ‰ç©ºé—²çš„ gï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ casgstatus(newg, _Gidle, _Gdead) // å°† g çš„çŠ¶æ€ä» _Gidle æ”¹ä¸º _Gdead allgadd(newg) // å°†æ–°çš„ g æ·»åŠ åˆ°æ‰€æœ‰ goroutine çš„åˆ—è¡¨ä¸­ ... è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼ŒGo è¯­è¨€æ¯ä¸ªæ–°åˆ›å»ºçš„åç¨‹åˆ†é…çš„é»˜è®¤å¤§å°å°±æ˜¯ stackMinï¼Œå³ 2KBã€‚ å…¶å® statck.go è¿˜å®šä¹‰äº†å¦å¤–ä¸€ä¸ªå­—æ®µï¼Œå³æ ˆæœ€å¤§ä¸º 2GBï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒGo åç¨‹æ ˆå¤§å° [2KB, 2GB]ã€‚ var maxstacksize uintptr = 1 20 // enough until runtime.main sets it for real å¦å¤–æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥ï¼ŒGo è¯­è¨€ä¼šå°½å¯èƒ½é‡ç”¨ç°æœ‰çš„ç©ºé—² goroutineï¼Œä»¥å‡å°‘å†…å­˜åˆ†é…çš„å¼€é”€ï¼Œæä¾›åˆ›å»ºæ–° goroutine çš„æ•ˆç‡ã€‚ é‡ç”¨çš„å…·ä½“é€»è¾‘åœ¨ gfget(pp) ä¸­ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯ä»ä¸å½“å‰ M ç»‘å®šçš„ P çš„ç©ºé—²åˆ—è¡¨ä¸­è·å–ä¸€ä¸ªç©ºé—²çš„ gï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™å°è¯•ä»å…¨å±€ç©ºé—²åˆ—è¡¨ä¸­è·å– gã€‚ // Get from gfree list.// If local list is empty, grab a batch from global list.func gfget(pp *p) *g retry: // å¦‚æœå½“å‰ P çš„ç©ºé—²é˜Ÿåˆ—ä¸ºç©ºï¼Œå¹¶ä¸”å…¨å±€ç©ºé—²é˜Ÿåˆ—ä¸­æœ‰å¯ç”¨çš„ goroutineï¼Œåˆ™è¿›è¡Œä¸‹åˆ—æ“ä½œã€‚\tif pp.gFree.empty() (!sched.gFree.stack.empty() || !sched.gFree.noStack.empty()) // æ·é”å…¨å±€ç©ºé—²åˆ—è¡¨ lock(sched.gFree.lock) // å°†æœ€å¤š 32 ä¸ªç©ºé—²çš„ g ä»å…¨å±€åˆ—è¡¨ä¸­ç§»åŠ¨åˆ°å½“å‰ P çš„ç©ºé—²åˆ—è¡¨ for pp.gFree.n 32 // ä¼˜å…ˆé€‰æ‹©æœ‰æ ˆçš„ g gp := sched.gFree.stack.pop() if gp == nil // å®åœ¨æ²¡æœ‰æ ˆï¼Œä¹Ÿå¯ä»¥æ¥å— gp = sched.gFree.noStack.pop() if gp == nil break sched.gFree.n-- pp.gFree.push(gp) pp.gFree.n++ unlock(sched.gFree.lock) // ä¸€ç›´å°è¯•ï¼ŒçŸ¥é“ P æœ‰ç©ºé—² gï¼Œæˆ–è€…å…¨å±€åˆ—è¡¨ä¹Ÿæ²¡æœ‰ç©ºé—² g äº†ï¼Œå°±é€€å‡º for å¾ªç¯ï¼Œè¿›è¡Œä¸‹é¢çš„æ“ä½œã€‚ goto retry // ä» P çš„ç©ºé—²åˆ—è¡¨ä¸­å–å‡ºä¸€ä¸ª g\tgp := pp.gFree.pop()\tif gp == nil return nil pp.gFree.n-- // æ£€æŸ¥è·å–åˆ°çš„ g æ˜¯å¦æœ‰ä¸€ä¸ªæœ‰æ•ˆçš„æ ˆï¼Œå¦‚æœæ ˆä¸ç¬¦åˆé¢„æœŸçš„å¤§å°ï¼Œåˆ™é‡Šæ”¾æ—§æ ˆ\tif gp.stack.lo != 0 gp.stack.hi-gp.stack.lo != uintptr(startingStackSize) systemstack(func() stackfree(gp.stack) gp.stack.lo = 0 gp.stack.hi = 0 gp.stackguard0 = 0 ) // å¦‚æœ g æ²¡æœ‰æœ‰æ•ˆçš„æ ˆï¼Œæˆ–è€…åˆšåˆšè¢«é‡Šæ”¾äº†ï¼Œåˆ™åˆ†é…æ–°æ ˆç»™ g\tif gp.stack.lo == 0 systemstack(func() gp.stack = stackalloc(startingStackSize) ) gp.stackguard0 = gp.stack.lo + stackGuard else if raceenabled racemalloc(unsafe.Pointer(gp.stack.lo), gp.stack.hi-gp.stack.lo) if msanenabled msanmalloc(unsafe.Pointer(gp.stack.lo), gp.stack.hi-gp.stack.lo) if asanenabled asanunpoison(unsafe.Pointer(gp.stack.lo), gp.stack.hi-gp.stack.lo) return gp å…¶ä¸­ startingStackSize è¡¨ç¤ºæ–°åˆ›å»ºçš„ goroutine å¼€å§‹æ—¶çš„æ ˆå¤§å°ã€‚å®ƒè¢«åˆå§‹åŒ–ä¸º fixedStack çš„å€¼ã€‚startingStackSize åœ¨æ¯æ¬¡åƒåœ¾å›æ”¶ï¼ˆGCï¼‰åå¯èƒ½ä¼šæ›´æ–°ï¼Œä»¥åæ˜ åœ¨ GC è¿‡ç¨‹ä¸­æ‰«æçš„æ ˆçš„å¹³å‡å¤§å°ã€‚ var startingStackSize uint32 = fixedStackfunc gcComputeStartingStackSize() ... // æ±‚å‡ºæ ˆå¹³å‡å¤§å°\tavg := scannedStackSize/scannedStacks + stackGuard\tif avg uint64(maxstacksize) avg = uint64(maxstacksize) if avg fixedStack avg = fixedStack // æ›´æ–° startingStackSize\tstartingStackSize = uint32(round2(int32(avg))) åˆå§‹åŒ–åç¨‹æ ˆ totalSize := uintptr(4*goarch.PtrSize + sys.MinFrameSize) // è®¡ç®—é¢å¤–çš„æ ˆç©ºé—´å¤§å°totalSize = alignUp(totalSize, sys.StackAlign) // æ ˆç©ºé—´å¯¹é½sp := newg.stack.hi - totalSize // è®¾ç½®æ ˆæŒ‡é’ˆspArg := spif usesLR *(*uintptr)(unsafe.Pointer(sp)) = 0 // é’ˆå¯¹ LR æ¶æ„ï¼Œè®¾ç½®è°ƒç”¨è€…çš„ LR prepGoExitFrame(sp) spArg += sys.MinFrameSize 1. è®¡ç®—é¢å¤–çš„æ ˆç©ºé—´å¤§å°: totalSize := uintptr(4*goarch.PtrSize + sys.MinFrameSize) è¿™è¡Œä»£ç è®¡ç®—æ–° goroutine éœ€è¦çš„é¢å¤–æ ˆç©ºé—´å¤§å°ã€‚ 4*goarch.PtrSize æ˜¯ä¸ºäº†ç•™å‡ºè¶³å¤Ÿçš„ç©ºé—´æ¥å­˜å‚¨å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­çš„ä¸€äº›é¢å¤–ä¿¡æ¯ï¼ˆä¾‹å¦‚è¿”å›åœ°å€ã€å¯„å­˜å™¨ä¿å­˜ç­‰ï¼‰ã€‚ sys.MinFrameSize ï¼šæ˜¯ç³»ç»Ÿä¸ºæ¯ä¸ªæ ˆå¸§ä¿ç•™çš„æœ€å°ç©ºé—´ï¼Œç”¨äºå­˜å‚¨ä¸€äº›ç‰¹å®šäºæ¶æ„çš„ä¿¡æ¯ã€‚ // MinFrameSize is the size of the system-reserved words at the bottom// of a frame (just above the architectural stack pointer).// It is zero on x86 and PtrSize on most non-x86 (LR-based) systems.// On PowerPC it is larger, to cover three more reserved words:// the compiler word, the link editor word, and the TOC save word.const MinFrameSize = goarch.MinFrameSize goarch.PtrSizeï¼šæŒ‡é’ˆå¤§å°ã€‚ // PtrSize is the size of a pointer in bytes - unsafe.Sizeof(uintptr(0)) but as an ideal constant.// It is also the size of the machines native word size (that is, 4 on 32-bit systems, 8 on 64-bit).const PtrSize = 4 (^uintptr(0) 63) 2. æ ˆç©ºé—´å¯¹é½: totalSize = alignUp(totalSize, sys.StackAlign): æ ¹æ®ç³»ç»Ÿçš„æ ˆå¯¹é½è¦æ±‚è°ƒæ•´ totalSize çš„å¤§å°ã€‚æ ˆå¯¹é½æ˜¯ä¸ºäº†ç¡®ä¿æ ˆä¸Šçš„æ•°æ®æŒ‰ç…§ç¡¬ä»¶è¦æ±‚çš„è¾¹ç•Œå¯¹é½ï¼Œè¿™é€šå¸¸æ˜¯ä¸ºäº†æé«˜è®¿é—®æ•ˆç‡æˆ–æ»¡è¶³ç‰¹å®šçš„ç¡¬ä»¶è¦æ±‚ã€‚ 3. è®¾ç½®æ ˆæŒ‡é’ˆ (sp): sp := newg.stack.hi - totalSize: è®¡ç®—æ–° goroutine çš„æ ˆé¡¶æŒ‡é’ˆã€‚newg.stack.hi æ˜¯åˆ†é…ç»™è¿™ä¸ª goroutine çš„æ ˆçš„é«˜åœ°å€ï¼ˆæ ˆé¡¶ï¼‰ï¼Œä»è¿™é‡Œå‘ä¸‹åˆ†é…ç©ºé—´ã€‚é€šè¿‡ä»æ ˆé¡¶åœ°å€å‡å»è®¡ç®—å‡ºçš„ totalSizeï¼Œè®¾ç½®æ–°çš„æ ˆé¡¶ä½ç½®ã€‚ 4. å¤„ç†é“¾æ¥å¯„å­˜å™¨ï¼ˆLRï¼‰æ¶æ„: åœ¨æŸäº›æ¶æ„ä¸Šï¼ˆå¦‚ ARMã€PowerPCï¼‰ï¼Œå‡½æ•°è°ƒç”¨çš„è¿”å›åœ°å€ä¸æ˜¯å­˜å‚¨åœ¨æ ˆä¸Šï¼Œè€Œæ˜¯å­˜å‚¨åœ¨ä¸€ä¸ªåä¸ºé“¾æ¥å¯„å­˜å™¨ï¼ˆLRï¼‰çš„ç‰¹æ®Šå¯„å­˜å™¨ä¸­ã€‚è¿™å‡ è¡Œä»£ç æ£€æŸ¥æ˜¯å¦åœ¨è¿™ç§æ¶æ„ä¸Šè¿è¡Œ (usesLR)ã€‚ å¦‚æœæ˜¯ï¼Œåˆ™åœ¨æ ˆä¸Šçš„é€‚å½“ä½ç½®å­˜å‚¨ä¸€ä¸ª 0 å€¼ä½œä¸ºè¿”å›åœ°å€ï¼Œå¹¶è°ƒç”¨ prepGoExitFrame æ¥å‡†å¤‡ goroutine é€€å‡ºæ—¶çš„æ ˆå¸§ã€‚è¿™æ˜¯ä¸ºäº†æ¨¡æ‹Ÿåœ¨é LR æ¶æ„ä¸Šçš„æ ˆå¸§ç»“æ„ã€‚ spArg æ˜¯ä¸€ä¸ªè¾…åŠ©å˜é‡ï¼Œç”¨äºè®°å½•å‚æ•°ä¼ é€’æ—¶åº”è¯¥ä½¿ç”¨çš„æ ˆåœ°å€ã€‚åœ¨ LR æ¶æ„ä¸Šï¼Œå®ƒéœ€è¦æ ¹æ® sys.MinFrameSize è¿›è¡Œè°ƒæ•´ï¼Œä»¥ä¿è¯å‡½æ•°å‚æ•°çš„æ­£ç¡®ä½ç½®ã€‚ æ”¾å…¥é˜Ÿåˆ— runqput() runqput() è´Ÿè´£å°† goroutine (gp) æ”¾å…¥åˆ°æœ¬åœ°å¯è¿è¡Œé˜Ÿåˆ—æˆ–å…¨å±€é˜Ÿåˆ—ä¸­ã€‚ // runqput å°è¯•å°† g æ”¾å…¥å½“å‰çš„æ‰§è¡Œé˜Ÿåˆ—ä¸­// å¦‚æœ next=falseï¼Œåˆ™å°† g æ”¾åœ¨é˜Ÿåˆ—æœ«å°¾ï¼Œ// å¦‚æœ next=trueï¼Œåˆ™å°† g æ”¾åœ¨ pp.runnextï¼Œå³ä¸‹ä¸€ä¸ªè¦æ‰§è¡Œçš„ goroutineã€‚// å¦‚æœæœ¬åœ°é˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™åŠ å…¥åˆ°å…¨å±€é˜Ÿåˆ—ã€‚func runqput(pp *p, gp *g, next bool) // å¦‚æœå¯ç”¨äº†éšæœºè°ƒåº¦å™¨ (randomizeScheduler)ï¼Œ // å¹¶ä¸”è°ƒç”¨è€…æŒ‡ç¤ºå°† goroutine æ”¾å…¥ runnext ä½ç½® (next ä¸º true)ï¼Œ // åˆ™æœ‰ 50% çš„æ¦‚ç‡å°† next è®¾ç½®ä¸º falseï¼Œä»¥éšæœºåœ°å°† goroutine æ”¾å…¥é˜Ÿåˆ—å°¾éƒ¨ã€‚\tif randomizeScheduler next fastrandn(2) == 0 next = false if next retryNext: // å¦‚æœä¸º nextï¼Œåˆ™å°è¯•å°† p æ”¾å…¥ pp.runnext æ’æ§½ oldnext := pp.runnext if !pp.runnext.cas(oldnext, guintptr(unsafe.Pointer(gp))) goto retryNext // å¦‚æœè¿™ä¸ªæ§½ä¹‹å‰æ²¡æœ‰è¢«å ç”¨ï¼Œåˆ™ç›´æ¥è¿”å› if oldnext == 0 return // å¦‚æœè¿™ä¸ªæ§½ä¹‹å‰å·²ç»è¢«å ç”¨äº†ï¼Œåˆ™å‰”é™¤æ—§ goroutineï¼Œ // ç„¶åè¿›è¡Œä¸‹é¢çš„é€»è¾‘ï¼Œå³å°†å…¶æ”¾å…¥å¸¸è§„çš„è¿è¡Œé˜Ÿåˆ—ä¸­ gp = oldnext.ptr()\tretry:\th := atomic.LoadAcq(pp.runqhead) // å–å‡ºé˜Ÿåˆ—å¤´éƒ¨\tt := pp.runqtail // å–å‡ºé˜Ÿåˆ—å°¾éƒ¨ // å¦‚æœè¿˜æ²¡æ»¡ï¼Œåˆ™å°† gp æ”¾å…¥æœ¬åœ°é˜Ÿåˆ—ä¸­ï¼ˆå¯èƒ½æ˜¯æ–° gï¼Œä¹Ÿå¯èƒ½æ˜¯ä¹‹å‰åœ¨ runnext çš„ g\tif t-h uint32(len(pp.runq)) pp.runq[t%uint32(len(pp.runq))].set(gp) atomic.StoreRel(pp.runqtail, t+1) // store-release, makes the item available for consumption return // å¦‚æœæœ¬åœ°é˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™å°è¯•å°†å…¶æ”¾å…¥å…¨å±€é˜Ÿåˆ—ä¸­\tif runqputslow(pp, gp, h, t) return goto retry å…¶ä¸­ runqputslow() ä¸ä»…ä¼šå°è¯•å°† gp æ”¾å…¥å…¨å±€é˜Ÿåˆ—ä¸­ï¼Œè¿˜ä¼šå°è¯•å°†æœ¬åœ°é˜Ÿåˆ—çš„éƒ¨åˆ† g æ”¾å…¥å…¨å±€é˜Ÿåˆ—ä¸­ï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™æœ¬åœ°é˜Ÿåˆ—å·²ç»æ»¡äº†ï¼Œæ”¾å…¥å…¨å±€é˜Ÿåˆ—ä¸­å°±æœ‰æœºä¼šè¢«å…¶ä»– P æ‰€è°ƒåº¦ï¼Œå‡å°‘é¥¥é¥¿ã€‚ // Put g and a batch of work from local runnable queue on global queue.// Executed only by the owner P.func runqputslow(pp *p, gp *g, h, t uint32) bool // åˆå§‹åŒ–ä¸€ä¸ªæ•°ç»„ batchï¼Œå¤§å°ä¸ºæœ¬åœ°é˜Ÿåˆ—çš„ä¸€åŠï¼Œ // å®ƒç”¨æ¥å­˜å‚¨å°†è¦ç§»åŠ¨åˆ°å…¨å±€é˜Ÿåˆ—çš„ goroutineã€‚\tvar batch [len(pp.runq)/2 + 1]*g\tn := t - h\tn = n / 2 // åªæœ‰æœ¬åœ°é˜Ÿåˆ—æ»¡æ‰è¿™ä¹ˆæ“ä½œ\tif n != uint32(len(pp.runq)/2) throw(runqputslow: queue is not full) // å°†æœ¬åœ°é˜Ÿåˆ—ä¸€åŠçš„ g å¤åˆ¶åˆ° batch ä¸­\tfor i := uint32(0); i n; i++ batch[i] = pp.runq[(h+i)%uint32(len(pp.runq))].ptr() // CAS æ›´æ–°æœ¬åœ°é˜Ÿåˆ—å¤´æŒ‡é’ˆï¼Œå¦‚æœå¤±è´¥ï¼Œåˆ™è¿”å›\tif !atomic.CasRel(pp.runqhead, h, h+n) // cas-release, commits consume return false // å°†å½“å‰è¦è°ƒåº¦çš„ gp æ”¾å…¥ batch çš„æœ«å°¾\tbatch[n] = gp // å¦‚æœå¯åŠ¨äº†éšæœºè°ƒåº¦å™¨ï¼Œåˆ™éšæœºåŒ– batch æ•°ç»„\tif randomizeScheduler for i := uint32(1); i = n; i++ j := fastrandn(i + 1) batch[i], batch[j] = batch[j], batch[i] // é“¾æ¥ goroutineï¼Œä»¥ä¾¿å®ƒä»¬å¯ä»¥ä½œä¸ºä¸€ä¸ªè¿ç»­çš„é˜Ÿåˆ—è¢«å¤„ç†\tfor i := uint32(0); i n; i++ batch[i].schedlink.set(batch[i+1]) var q gQueue\tq.head.set(batch[0])\tq.tail.set(batch[n])\t// å°† batch æ”¾å…¥å…¨å±€é˜Ÿåˆ—ä¸­\tlock(sched.lock)\tglobrunqputbatch(q, int32(n+1))\tunlock(sched.lock)\treturn true runqput() å‡½æ•°æ¦‚è¿° æ€»ç»“ åˆ°è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ€»ç»“ï¼ŒruntimeÂ·newproc çš„æ ¸å¿ƒåŠŸèƒ½å°±æ˜¯åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ goroutineï¼Œå¹¶å°†å…¶æ”¾å…¥é˜Ÿåˆ—ä¸­è¿›è¡Œè°ƒåº¦ã€‚å…¶ä¸­ newproc1() ä¼šæ–°å»ºæˆ–å¤ç”¨ç©ºé—²çš„ goroutineï¼Œç„¶ååˆå§‹åŒ–å…¶æ ˆç©ºé—´å’Œè°ƒåº¦ä¿¡æ¯ï¼› runqput() ä¼šä¼˜å…ˆå°† g æ”¾å…¥æœ¬åœ°é˜Ÿåˆ—ä¸­è°ƒåº¦ï¼Œå¦‚æœæœ¬åœ°é˜Ÿåˆ—æ»¡äº†ï¼Œä¼šè¿å¸¦æœ¬åœ°é˜Ÿåˆ—ä¸­ä¸€åŠçš„ goroutine ä¸€èµ·è½¬ç§»åˆ°å…¨å±€é˜Ÿåˆ—ä¸­è°ƒåº¦ã€‚ runtimeÂ·mstart è°ƒåº¦å™¨ m0 å’Œä¸»åç¨‹ g0 éƒ½åˆå§‹åŒ–å®Œæ¯•äº†ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥å¯åŠ¨è°ƒåº¦å™¨æ¥è°ƒåº¦åç¨‹å·¥ä½œäº†ã€‚ æˆ‘ä»¬æ‰¾åˆ° mstart() å‡½æ•°çš„å£°æ˜ï¼Œä½äºï¼šproc.go // mstart is the entry-point for new Ms.// It is written in assembly, uses ABI0, is marked TOPFRAME, and calls mstart0.func mstart() å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œ mstart() æ˜¯æ²¡ç”¨å‡½æ•°ä½“çš„ï¼Œé€šè¿‡æ³¨é‡Šæˆ‘ä»¬å¯ä»¥çŸ¥é“è¿™ä¸ªå‡½æ•°çš„å®ç°éƒ¨åˆ†æ˜¯ç”¨æ±‡ç¼–å®ç°çš„ï¼ŒGo ç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘çš„æ—¶å€™å¾€è¿™ä¸ªå‡½æ•°é‡Œé¢æ’å…¥ç›¸å…³æŒ‡ä»¤ã€‚å¦å¤–æ³¨é‡Šä¹Ÿå‘Šè¯‰æˆ‘ä»¬ï¼Œè¿™é‡Œæœ€ç»ˆå…¶å®å°±æ˜¯è°ƒç”¨ mstart0() å‡½æ•°ã€‚æˆ‘ä»¬æ‰¾åˆ°ç›¸å…³çš„æ±‡ç¼–ä»£ç ï¼Œæœç„¶æ˜¯å¦‚æ­¤ï¼š TEXT runtimeÂ·mstart(SB),NOSPLIT|TOPFRAME,$0\tCALL\truntimeÂ·mstart0(SB)\tRET // not reached mstart0() å°±åœ¨ mstart() çš„ä¸‹é¢ï¼š func mstart0() gp := getg()\tosStack := gp.stack.lo == 0\tif osStack // Initialize stack bounds from system stack. // Cgo may have left stack size in stack.hi. // minit may update the stack bounds. size := gp.stack.hi if size == 0 size = 8192 * sys.StackGuardMultiplier gp.stack.hi = uintptr(noescape(unsafe.Pointer(size))) gp.stack.lo = gp.stack.hi - size + 1024 // Initialize stack guard so that we can start calling regular\t// Go code.\tgp.stackguard0 = gp.stack.lo + stackGuard\t// This is the g0, so we can also call go:systemstack\t// functions, which check stackguard1.\tgp.stackguard1 = gp.stackguard0\tmstart1()\t// Exit this thread.\tif mStackIsSystemAllocated() // Windows, Solaris, illumos, Darwin, AIX and Plan 9 always system-allocate // the stack, but put it in gp.stack before mstart, // so the logic above hasnt set osStack yet. osStack = true mexit(osStack) ç®€å•è¿‡ä¸€ä¸‹ mstart0() åï¼Œæˆ‘ä»¬ä¼šå‘ç°å…¶å® mstart0() ä¹Ÿä¸æ˜¯å…³é”®ï¼Œå…³é”®æ˜¯ mstart1()ã€‚ æˆ‘ä»¬å…ˆå¯¹ mstart0() åšä¸€ä¸ªç®€å•çš„æ€»ç»“ï¼šå®ƒæ˜¯ Go è¯­è¨€è¿è¡Œæ—¶ä¸­æ–° Mï¼ˆæ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼‰çš„å…¥å£ç‚¹ã€‚è¿™ä¸ªå‡½æ•°è´Ÿè´£åˆå§‹åŒ–æ–°çº¿ç¨‹çš„æ ˆå’Œä¸€äº›å…¶ä»–è®¾ç½®ï¼Œç„¶åè°ƒç”¨ mstart1 æ¥ç»§ç»­çº¿ç¨‹çš„åˆå§‹åŒ–è¿‡ç¨‹ã€‚ æˆ‘ä»¬ç»§ç»­æ¥çœ‹ mstart1()ï¼Œå®ƒç”¨äºè¿›ä¸€æ­¥è®¾ç½®æ–°çº¿ç¨‹å¹¶æœ€ç»ˆå°†æ§åˆ¶æƒäº¤ç»™è°ƒåº¦å™¨ã€‚ func mstart1() // è·å–å½“å‰åç¨‹\tgp := getg() // åªæœ‰ g0 åç¨‹å¯ä»¥æ‰§è¡Œ mstart1()ï¼Œå³å¯åŠ¨ m0ã€‚ // æ¯ä¸€ä¸ª M éƒ½æœ‰ä¸€ä¸ªç‰¹æ®Šçš„ goroutineï¼Œå…¶è¢«ç§°ä¸º g0ï¼Œå®ƒç”¨äºæ‰§è¡Œç³»ç»Ÿçº§ä»»åŠ¡ã€‚\tif gp != gp.m.g0 throw(bad runtimeÂ·mstart) // è®¾ç½® gp.sched è°ƒåº¦ä¿¡æ¯ï¼Œä»¥ä¾¿ goroutine èƒ½å¤Ÿåœ¨æœªæ¥è¢«æ­£ç¡®è°ƒåº¦ã€‚\tgp.sched.g = guintptr(unsafe.Pointer(gp))\t// goroutine æŒ‡é’ˆ\tgp.sched.pc = getcallerpc()\t// ç¨‹åºè®¡æ•°å™¨\tgp.sched.sp = getcallersp()\t// æ ˆæŒ‡é’ˆ // åˆå§‹åŒ–äºæ±‡ç¼–ç›¸å…³çš„è®¾ç½®ã€‚\tasminit() // åˆå§‹åŒ–å½“å‰ M çš„çº¿ç¨‹å±€éƒ¨å­˜å‚¨å’Œå…¶ä»–çº¿ç¨‹ç›¸å…³çš„æ•°æ®ã€‚\tminit()\t// å¦‚æœæ˜¯ m0ï¼Œåˆ™å®‰è£…ä¿¡å·å¤„ç†å™¨\tif gp.m == m0 mstartm0() // å¦‚æœ M å¯åŠ¨æ—¶é…ç½®äº†å‡½æ•°ï¼Œåˆ™è°ƒç”¨å®ƒ\tif fn := gp.m.mstartfn; fn != nil fn() // å¦‚æœå½“å‰ç°åœºä¸æ˜¯ m0ï¼ˆä¸»çº¿ç¨‹ï¼‰ï¼Œåˆ™è·å–ä¸€ä¸ª Pï¼Œå‡†å¤‡å¼€å§‹æ‰§è¡Œ goroutine\tif gp.m != m0 acquirep(gp.m.nextp.ptr()) gp.m.nextp = 0 // è°ƒç”¨ schedule() å°†æ§åˆ¶æƒäº¤ç»™è°ƒåº¦å™¨ï¼Œå¼€å§‹æ‰§è¡Œ goroutine\tschedule()func mstartm0() if (iscgo || GOOS == windows) !cgoHasExtraM cgoHasExtraM = true newextram() // å®‰è£…ä¿¡å·å¤„ç†å™¨\tinitsig(false) å…¶ä¸­ schedule() æ˜¯è°ƒåº¦å™¨çš„å…·ä½“è°ƒåº¦è¿‡ç¨‹ï¼Œè¿™éƒ¨åˆ†ä¼šåœ¨ GMP ç¯‡ç« è¿›è¡Œå±•å¼€ï¼ˆTODO ğŸ˜ï¼‰ã€‚ æ³¨æ„è¿™é‡Œï¼š // å¦‚æœ M å¯åŠ¨æ—¶é…ç½®äº†å‡½æ•°ï¼Œåˆ™è°ƒç”¨å®ƒif fn := gp.m.mstartfn; fn != nil fn() å‰é¢æˆ‘ä»¬æåˆ° runtimeÂ·newproc çš„æ—¶å€™ï¼Œè·å–å¹¶è®¾ç½®äº† runtime.main çš„å‡½æ•°åœ°å€ï¼š // å– runtimeÂ·mainPC çš„åœ°å€ï¼Œè¿™å…¶å®å°±æ˜¯ runtime åŒ…ä¸‹çš„ main() æ–¹æ³•ã€‚// å®ƒæ˜¯ Go è¯­è¨€ç¨‹åºçš„çœŸæ­£å…¥å£ï¼Œè€Œä¸æ˜¯ main.main()ã€‚MOVQ\t$runtimeÂ·mainPC(SB), AX PUSHQ\tAX// åˆ›å»ºä¸€ä¸ªæ–°çš„ goroutine æ¥è¿è¡Œç¨‹åºçš„ä¸»å‡½æ•°ã€‚// è¿™é‡Œè¿˜æ²¡æœ‰æ­£åœ¨çš„è¿è¡Œï¼Œå› ä¸ºè°ƒåº¦å™¨è¿˜æ²¡æœ‰å¯åŠ¨ï¼Œ// åªæ˜¯å°† runtime.main æ”¾è¿› goroutine çš„ queue ä¸­ç­‰å¾…æ‰§è¡Œã€‚CALL\truntimeÂ·newproc(SB)POPQ\tAX æ‰€ä»¥è¿™é‡Œå…¶å®å°±æ˜¯è°ƒç”¨ runtime.main()ï¼Œåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬ç»ˆäºå¼€å§‹æ‰§è¡Œç¨‹åºçš„ä¸»å‡½æ•°äº†ã€‚ runtime.main â˜… ç»ˆäºæˆ‘ä»¬åˆ°äº† runtime.main è¿™ä¸ª Go è¯­è¨€ä¸–ç•Œä¸­ â€œçœŸæ­£â€ çš„ä¸»å‡½æ•°äº†ï¼Œå®ƒä½äºï¼šproc.goã€‚ // The main goroutine.func main() // è·å–å½“å‰çš„ M\tmp := getg().m\tmp.g0.racectx = 0\t// é™åˆ¶æ ˆå¤§å°çš„ä¸Šé™ï¼Œ64 ä½ç³»ç»Ÿä¸º 1Gï¼Œ32 ä½ç³»ç»Ÿä¸º 250M\tif goarch.PtrSize == 8 maxstacksize = 1000000000 else maxstacksize = 250000000 // è¿™é‡Œå°±å°†æ ˆçš„ä¸Šé™æå‡ 2 å€ï¼Œç”¨äºé¿å…åœ¨åˆ†é…è¿‡å¤§çš„æ ˆæ—¶å´©æºƒã€‚ // æ‰€ä»¥å…¶å® 64 ä½ç³»ç»Ÿæœ€å¤§æ ˆ 2Gï¼Œ32 ä½ç³»ç»Ÿæœ€å¤§æ ˆ 500Mã€‚\tmaxstackceiling = 2 * maxstacksize\t// å°† mainStarted ç½®ä¸º trueï¼Œå…è®¸ newproc å¯åŠ¨æ–°çš„ Mã€‚\tmainStarted = true // WebAssemby ä¸Šæš‚æ—¶æ²¡æœ‰çº¿ç¨‹å’Œç³»ç»Ÿç›‘è§†å™¨ï¼Œæ‰€ä»¥è¿™é‡Œè¿‡æ»¤æ‰ã€‚\tif GOARCH != wasm // å…¶ä»–æ¶æ„å°±å¯åŠ¨ç³»ç»Ÿç›‘è§†å™¨ã€‚ systemstack(func() newm(sysmon, nil, -1) ) // åœ¨åˆå§‹åŒ–æœŸé—´å°† g0 é”å®šåœ¨ m0 ä¸Šã€‚\tlockOSThread() // åªæœ‰ m0 å¯ä»¥è¿è¡Œ runtime.main\tif mp != m0 throw(runtime.main not on m0) // è®°å½• runtime çš„å¼€å§‹æ—¶é—´ï¼Œéœ€è¦åœ¨ doInit() ä¹‹å‰ï¼Œå› ä¸ºè¿™æ ·æ‰æŠŠ init ä¹Ÿè¿½è¸ªä¸Šã€‚\truntimeInitTime = nanotime()\tif runtimeInitTime == 0 throw(nanotime returning zero) // åˆå§‹åŒ– trace\tif debug.inittrace != 0 inittrace.id = getg().goid inittrace.active = true // æ‰§è¡Œ runtime çš„ init() æ–¹æ³•\tdoInit(runtime_inittasks) // Must be before defer. // defer è§£é”ï¼Œä»¥ä¾¿åœ¨åˆå§‹åŒ–æœŸé—´è°ƒç”¨ runtime.Goexit æ—¶ä¹Ÿèƒ½è§£é”ã€‚\tneedUnlock := true\tdefer func() if needUnlock unlockOSThread() () // å¯åŠ¨åƒåœ¾å›æ”¶æœŸ\tgcenable() // ç›‘å¬åˆå§‹åŒ–å®Œæˆçš„ä¿¡å·\tmain_init_done = make(chan bool) // å¦‚æœä½¿ç”¨ cgoï¼Œåˆ™è¿›è¡Œç›¸å…³çš„åˆå§‹åŒ–\tif iscgo ... cgocall(_cgo_notify_runtime_init_done, nil) // æ‰§è¡Œæ‰€æœ‰æ¨¡å—çš„ init()\tfor _, m := range activeModules() doInit(m.inittasks) // åˆå§‹åŒ–ä»»åŠ¡éƒ½å®Œæˆåï¼Œåˆ™ç¦ç”¨åˆå§‹åŒ– traceã€‚\tinittrace.active = false // å…³é—­åˆå§‹åŒ–å®Œæˆçš„ä¿¡å·é€šé“\tclose(main_init_done) // è§£é” m0 çº¿ç¨‹\tneedUnlock = false\tunlockOSThread() // ä»¥ -buildmode=(c-archive|c-shared) æ–¹å¼è¿›è¡Œæ„å»ºç¨‹åºçš„è¯ï¼Œåˆ™ä¸æ‰§è¡Œ main.main\tif isarchive || islibrary // A program compiled with -buildmode=c-archive or c-shared // has a main, but it is not executed. return // æ‰§è¡Œ main.main() å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è‡ªå·±å†™çš„ main()\tfn := main_main fn() // å¦‚æœæˆ‘ä»¬å¯åŠ¨äº†ä¸€ä¸ª server æœåŠ¡ï¼Œè¿™é‡Œå°±ä¼šè¢«é˜»å¡ä½ï¼Œç›´åˆ°æˆ‘ä»¬çš„ main è¿”å›ã€‚ // é™æ€æ£€æµ‹è¾“å‡º\tif raceenabled runExitHooks(0) // run hooks now, since racefini does not return racefini() // å¤„ç†åœ¨ main è¿”å›æ—¶åŒæ—¶å­˜åœ¨çš„å…¶ä»– goroutine çš„ panic\tif runningPanicDefers.Load() != 0 for c := 0; c 1000; c++ // æ‰§è¡Œ defer if runningPanicDefers.Load() == 0 break Gosched() // é˜»å¡ g0 çš„æ‰§è¡Œï¼Œç›´åˆ°æ‰€æœ‰çš„ panic éƒ½å¤„ç†å®Œæ¯•\tif panicking.Load() != 0 gopark(nil, nil, waitReasonPanicWait, traceBlockForever, 1) // æ‰§è¡Œ hook é€€å‡ºå‡½æ•°\trunExitHooks(0) // é€€å‡ºç¨‹åºï¼Œ0 è¡¨ç¤ºæ­£å¸¸é€€å‡º\texit(0) // ç†è®ºä¸Š exit(0) åº”è¯¥é€€å‡ºç¨‹åºçš„ï¼Œ // å¦‚æœè¿˜æ²¡é€€å‡ºï¼Œä½¿ç”¨ nil æŒ‡é’ˆå¼ºè¡Œèµ‹å€¼ï¼Œå¼•å‘å´©æºƒï¼Œå¼ºè¡Œé€€å‡ºç¨‹åºã€‚\tfor var x *int32 *x = 0 æ€»çš„æ¥è¯´ï¼Œruntime.main() å¹²è¿™ä¹ˆå‡ ä»¶äº‹ï¼š é¦–å…ˆè¿›è¡Œä¸€äº›åŸºæœ¬çš„è®¾ç½®å’Œæ£€æŸ¥ï¼ŒåŒ…æ‹¬è®¾ç½®æ ˆå¤§å°é™åˆ¶å’Œé”å®šä¸» goroutine åˆ°ä¸» OS çº¿ç¨‹ã€‚ ç„¶åï¼Œå‡½æ•°æ‰§è¡Œä¸€ç³»åˆ—åˆå§‹åŒ–æ“ä½œï¼ŒåŒ…æ‹¬å¯åŠ¨åƒåœ¾å›æ”¶å™¨ã€å¤„ç† CGo äº¤äº’ã€æ‰§è¡ŒåŒ…çš„ init()ã€‚ åœ¨å®Œæˆæ‰€æœ‰ init() åï¼Œå‡½æ•°è°ƒç”¨ç”¨æˆ·å®šä¹‰çš„ main.main å‡½æ•°ã€‚ æœ€åï¼Œå‡½æ•°å¤„ç†ç¨‹åºé€€å‡ºï¼ŒåŒ…æ‹¬æ‰§è¡Œ deferã€ç­‰å¾… panic å¤„ç†å®Œæˆï¼Œå¹¶æ­£å¼é€€å‡ºç¨‹åºã€‚ æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å°±çŸ¥é“äº†ä¸ºä»€ä¹ˆ init() ä¼šåœ¨ main.main() ä¹‹å‰è¢«æ‰§è¡Œï¼Œè€Œä¸”å¦‚æœä¸€ä¸ª package åœ¨æ•´ä¸ªç¨‹åºè·¯å¾„éƒ½æ²¡æœ‰è¢« import çš„æ—¶å€™ï¼Œinit() æ˜¯ä¸ä¼šè¢«æ‰§è¡Œçš„ï¼Œå°±æ˜¯å› ä¸º runtime.main() åªå¤„ç†äº† activeModules() çš„ initTasks()ã€‚ è¡¥å……è¯´æ˜ï¼šå…¨å±€å˜é‡çš„åˆå§‹åŒ– åˆ°è¿™é‡Œï¼Œè¿˜æœ‰ä¸ªé—ç•™é—®é¢˜ï¼Œå¼€å‘æ—¶æˆ‘ä»¬éœ€è¦å…³æ³¨çš„ init() å’Œmain.main()å¯ä»¥è®¨è®ºè¿‡äº†ï¼Œé‚£å…¨å±€å˜é‡çš„åˆå§‹åŒ–æ˜¯åœ¨å“ªé‡Œåšçš„å‘¢ï¼Ÿåœ¨ Goè¯­è¨€çš„ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œå…¨å±€å˜é‡çš„åˆå§‹åŒ–ä¸»è¦å‘ç”Ÿåœ¨é“¾æ¥é˜¶æ®µã€‚ç¼–è¯‘å™¨é¦–å…ˆç¼–è¯‘æ¯ä¸ªåŒ…ï¼Œç”Ÿæˆå¯¹è±¡æ–‡ä»¶ã€‚ç„¶ååœ¨é“¾æ¥é˜¶æ®µï¼Œç¼–è¯‘å™¨æˆ–é“¾æ¥å™¨å°†è¿™äº›å¯¹è±¡æ–‡ä»¶åˆå¹¶æˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œç¼–è¯‘å™¨æˆ–é“¾æ¥å™¨è´Ÿè´£ç”Ÿæˆåˆå§‹åŒ–å…¨å±€å˜é‡çš„ä»£ç ï¼Œå¹¶å®‰æ’è¿™äº›ä»£ç åœ¨ç¨‹åºå¯åŠ¨æ—¶æ‰§è¡Œã€‚è¿™äº›åˆå§‹åŒ–ä»£ç é€šå¸¸åµŒå…¥åœ¨ç¨‹åºçš„å¯åŠ¨åºåˆ—ä¸­ï¼Œç¡®ä¿åœ¨æ‰§è¡Œä»»ä½•åŒ…çº§init å‡½æ•°æˆ–ç”¨æˆ·å®šä¹‰çš„ mainå‡½æ•°ä¹‹å‰ï¼Œæ‰€æœ‰å…¨å±€å˜é‡å·²ç»è¢«åˆå§‹åŒ–ã€‚ç”±äºè¿™äº›æ“ä½œæ˜¯ç¼–è¯‘å™¨åœ¨å†…éƒ¨æ‰§è¡Œçš„ï¼Œå®ƒä»¬ä¸ä¼šç›´æ¥æ˜¾ç¤ºåœ¨æºä»£ç æˆ–è¿è¡Œæ—¶ä»£ç ä¸­ã€‚ runtime.main å‡½æ•°æ¦‚è¿° è‡³æ­¤ï¼Œæˆ‘ä»¬å°±åˆ†æå®Œ Go è¯­è¨€ç¨‹åºçš„æ•´ä¸ªå¯åŠ¨è¿‡ç¨‹äº†ã€‚å…·ä½“çš„å¯åŠ¨æµç¨‹æ€»ç»“ï¼Œå¯ä»¥å›åˆ°å¼€å¤´çš„ â€œç»“è®ºå…ˆè¡Œâ€ æŸ¥çœ‹ã€‚ å‚è€ƒ æ…•è¯¾ç½‘-æ·±å…¥Goåº•å±‚åŸç† Go1.21.0 å®˜æ–¹æºç  ChatGPT-4","tags":["Go"],"categories":["Go"]},{"title":"Go1.21.0 ç¨‹åºç¼–è¯‘è¿‡ç¨‹","path":"/2023/11/29/go-compilation/","content":"ç‰ˆæœ¬è¯´æ˜ Go 1.21 å®˜æ–¹æ–‡æ¡£ Go è¯­è¨€å®˜æ–¹æ–‡æ¡£è¯¦ç»†é˜è¿°äº† Go è¯­è¨€ç¼–è¯‘å™¨çš„å…·ä½“æ‰§è¡Œè¿‡ç¨‹ï¼ŒGo1.21 ç‰ˆæœ¬å¯ä»¥çœ‹è¿™ä¸ªï¼šhttps://github.com/golang/go/tree/release-branch.go1.21/src/cmd/compile å¤§è‡´è¿‡ç¨‹å¦‚ä¸‹ï¼š è§£æ (cmd/compile/internal/syntax): è¯æ³•åˆ†æå™¨å’Œè¯­æ³•åˆ†æå™¨ï¼šæºä»£ç è¢«åˆ†è¯ï¼ˆè¯æ³•åˆ†æï¼‰å¹¶è§£æï¼ˆè¯­æ³•åˆ†æï¼‰ã€‚ è¯­æ³•æ ‘æ„å»ºï¼šä¸ºæ¯ä¸ªæºæ–‡ä»¶æ„å»ºä¸€ä¸ªè¯­æ³•æ ‘ã€‚ ç±»å‹æ£€æŸ¥ (cmd/compile/internal/types2): ç±»å‹æ£€æŸ¥ï¼štypes2 åŒ…æ˜¯ go/types çš„ä¸€ä¸ªç§»æ¤ç‰ˆæœ¬ï¼Œå®ƒä½¿ç”¨ syntax åŒ…çš„ ASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰è€Œä¸æ˜¯ go/astã€‚ IR æ„å»ºï¼ˆ\"noding\"ï¼‰: ç¼–è¯‘å™¨ç±»å‹ (cmd/compile/internal/types) ç¼–è¯‘å™¨ AST (cmd/compile/internal/ir) AST è½¬æ¢ (cmd/compile/internal/typecheck) åˆ›å»ºç¼–è¯‘å™¨ AST (cmd/compile/internal/noder) è¿™ä¸ªé˜¶æ®µä½¿ç”¨è‡ªå·±çš„ AST å®šä¹‰å’Œ Go ç±»å‹çš„è¡¨ç¤ºï¼Œè¿™äº›å®šä¹‰å’Œè¡¨ç¤ºå½¢å¼æ˜¯ç”¨ C ç¼–å†™æ—¶é—ç•™ä¸‹æ¥çš„ã€‚å®ƒçš„æ‰€æœ‰ä»£ç éƒ½æ˜¯æ ¹æ®è¿™äº›ç¼–å†™çš„ï¼Œå› æ­¤ç±»å‹æ£€æŸ¥åçš„ä¸‹ä¸€æ­¥æ˜¯è½¬æ¢è¯­æ³•å’Œ types2 è¡¨ç¤ºå½¢å¼åˆ° ir å’Œ typesã€‚è¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¸ºâ€œnodingâ€ã€‚ ä¸­é—´é˜¶æ®µ: æ­»ä»£ç æ¶ˆé™¤ (cmd/compile/internal/deadcode) å‡½æ•°è°ƒç”¨å†…è” (cmd/compile/internal/inline) å·²çŸ¥æ¥å£æ–¹æ³•è°ƒç”¨çš„å»è™šæ‹ŸåŒ– (cmd/compile/internal/devirtualize) é€ƒé€¸åˆ†æ (cmd/compile/internal/escape) åœ¨ IR è¡¨ç¤ºä¸Šæ‰§è¡Œå‡ ä¸ªä¼˜åŒ–è¿‡ç¨‹ï¼šæ­»ä»£ç æ¶ˆé™¤ã€ï¼ˆæ—©æœŸçš„ï¼‰å»è™šæ‹ŸåŒ–ã€å‡½æ•°è°ƒç”¨å†…è”å’Œé€ƒé€¸åˆ†æã€‚ Walk (cmd/compile/internal/walk): æ±‚å€¼é¡ºåºå’Œè¯­æ³•ç³–ï¼šè¿™æ˜¯å¯¹ IR è¡¨ç¤ºçš„æœ€åä¸€æ¬¡éå†ï¼Œå®ƒæœ‰ä¸¤ä¸ªç›®çš„ï¼šå°†å¤æ‚çš„è¯­å¥åˆ†è§£ä¸ºç®€å•çš„å•ä¸ªè¯­å¥ï¼Œå¼•å…¥ä¸´æ—¶å˜é‡å¹¶éµå®ˆæ±‚å€¼é¡ºåºï¼›å°†é«˜çº§ Go æ„é€ è½¬æ¢ä¸ºæ›´åŸå§‹çš„æ„é€ ã€‚ é€šç”¨ SSA (cmd/compile/internal/ssa å’Œ cmd/compile/internal/ssagen): åœ¨è¿™ä¸ªé˜¶æ®µï¼ŒIR è¢«è½¬æ¢ä¸ºé™æ€å•èµ‹å€¼ï¼ˆSSAï¼‰å½¢å¼ï¼Œè¿™æ˜¯ä¸€ç§å…·æœ‰ç‰¹å®šå±æ€§çš„ä½çº§ä¸­é—´è¡¨ç¤ºï¼Œä½¿å¾—ä»ä¸­å®ç°ä¼˜åŒ–å¹¶æœ€ç»ˆç”Ÿæˆæœºå™¨ä»£ç å˜å¾—æ›´å®¹æ˜“ã€‚ ç”Ÿæˆæœºå™¨ä»£ç  (cmd/compile/internal/ssa å’Œ cmd/internal/obj): è¿™æ˜¯ç¼–è¯‘å™¨çš„æœºå™¨ä¾èµ–é˜¶æ®µï¼Œä»¥â€œlowerâ€è¿‡ç¨‹å¼€å§‹ï¼Œå°†é€šç”¨å€¼é‡å†™ä¸ºå®ƒä»¬çš„æœºå™¨ç‰¹å®šå˜ä½“ã€‚ç„¶åè¿›è¡Œæœ€ç»ˆçš„ä»£ç ä¼˜åŒ–è¿‡ç¨‹ã€‚æœ€åï¼ŒGo å‡½æ•°è¢«è½¬æ¢ä¸ºä¸€ç³»åˆ— obj.Prog æŒ‡ä»¤ï¼Œè¿™äº›æŒ‡ä»¤è¢«æ±‡ç¼–å™¨ï¼ˆcmd/internal/objï¼‰è½¬æ¢ä¸ºæœºå™¨ä»£ç ï¼Œå¹¶å†™å‡ºæœ€ç»ˆçš„ç›®æ ‡æ–‡ä»¶ã€‚ Goç¼–è¯‘å™¨æ¦‚è§ˆ ç¼–è¯‘è¿‡ç¨‹ Go ç¨‹åºçš„ç¼–è¯‘è¿‡ç¨‹ç¬¦åˆç»å…¸ç¼–è¯‘åŸç†çš„è¿‡ç¨‹æ‹†è§£ï¼Œå³ä¸‰é˜¶æ®µç¼–è¯‘å™¨ï¼Œåˆ†åˆ«ä¸ºç¼–è¯‘å™¨å‰ç«¯ã€ä¸­ç«¯å’Œåç«¯ï¼š å‰ç«¯ï¼ˆFront Endï¼‰ï¼š å‰ç«¯çš„ä»»åŠ¡æ˜¯è¿›è¡Œè¯­æ³•åˆ†æå’Œè¯­ä¹‰åˆ†æã€‚è¿™ä¸€é˜¶æ®µä¼šå°†æºä»£ç è½¬æ¢ä¸ºä¸€ä¸ªä¸­é—´è¡¨ç¤ºã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œç¼–è¯‘å™¨ä¼šæ£€æŸ¥ä»£ç çš„è¯­æ³•å’Œè¯­ä¹‰ï¼Œæ¯”å¦‚è¯­æ³•é”™è¯¯ã€ç±»å‹é”™è¯¯ç­‰ã€‚å‰ç«¯é€šå¸¸æ˜¯ä¾èµ–äºå…·ä½“è¯­è¨€çš„ï¼Œæ¯”å¦‚ Go çš„å‰ç«¯å’Œ C++ çš„å‰ç«¯å°±ä¼šæœ‰å¾ˆå¤§çš„ä¸åŒã€‚ ä¸­é—´ç«¯ï¼ˆMiddle Endï¼‰ï¼š ä¸­é—´ç«¯çš„ä»»åŠ¡æ˜¯å¯¹ä¸­é—´è¡¨ç¤ºè¿›è¡Œä¼˜åŒ–ã€‚è¿™ä¸€é˜¶æ®µçš„ä¼˜åŒ–æ˜¯è¯­è¨€æ— å…³çš„ï¼Œæ¯”å¦‚å¸¸é‡æŠ˜å ã€æ­»ä»£ç æ¶ˆé™¤ã€å¾ªç¯ä¼˜åŒ–ç­‰ã€‚è¿™äº›ä¼˜åŒ–å¯ä»¥æé«˜ç”Ÿæˆçš„ä»£ç çš„æ€§èƒ½ï¼Œä½†æ˜¯ä¸ä¼šæ”¹å˜ç¨‹åºçš„è¯­ä¹‰ã€‚ åç«¯ï¼ˆBack Endï¼‰ï¼š åç«¯çš„ä»»åŠ¡æ˜¯å°†ä¼˜åŒ–åçš„ä¸­é—´è¡¨ç¤ºè½¬æ¢ä¸ºç›®æ ‡æœºå™¨ä»£ç ã€‚è¿™ä¸€é˜¶æ®µä¼šè¿›è¡Œæ›´å¤šçš„ä¼˜åŒ–ï¼Œæ¯”å¦‚å¯„å­˜å™¨åˆ†é…ã€æŒ‡ä»¤é€‰æ‹©ã€æŒ‡ä»¤è°ƒåº¦ç­‰ã€‚åç«¯é€šå¸¸æ˜¯ä¾èµ–äºå…·ä½“æœºå™¨çš„ï¼Œæ¯”å¦‚ x86 çš„åç«¯å’Œ ARM çš„åç«¯å°±ä¼šæœ‰å¾ˆå¤§çš„ä¸åŒã€‚ å‚è€ƒã€ŠGo è¯­è¨€åº•å±‚åŸç†å‰–æï¼ˆéƒ‘å»ºå‹‹ï¼‰ã€‹ä¸€ä¹¦ï¼Œæœ¬æ–‡å°† Go è¯­è¨€ç¼–è¯‘å™¨æ‰§è¡Œæµç¨‹æ‹†åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š è¯æ³•è§£æ è¯­æ³•è§£æ æŠ½è±¡è¯­æ³•æ ‘æ„å»º ç±»å‹æ£€æŸ¥ æ­»ä»£ç æ¶ˆé™¤ å»è™šæ‹ŸåŒ– å‡½æ•°å†…è” é€ƒé€¸åˆ†æ å˜é‡æ•è· é—­åŒ…é‡å†™ éå†å‡½æ•° SSA ç”Ÿæˆ æœºå™¨ç ç”Ÿæˆ ä¸‹é¢æœ¬æ–‡å°†ä»¥æ­¤ä¹¦ä¸ºå‚è€ƒå¹¶ç»“åˆ Go1.21.0 ç‰ˆæœ¬ï¼Œå¯¹æ¯ä¸ªè¿‡ç¨‹è¿›è¡Œé˜è¿°ã€‚ å¦‚æœåªæƒ³å¯¹ Go ç¨‹åºçš„ç¼–è¯‘è¿‡ç¨‹åšä¸€ä¸ªç®€å•çš„äº†è§£ï¼Œé‚£é˜…è¯»åˆ°è¿™é‡Œå°±å·²ç»è¶³å¤Ÿäº†ã€‚ è¯æ³•è§£æ è¯æ³•è§£æè¿‡ç¨‹ä¸»è¦è´Ÿè´£å°†æºä»£ç ä¸­çš„å­—ç¬¦åºåˆ—è½¬æ¢æˆä¸€ç³»åˆ—çš„æ ‡è®°ï¼ˆtokensï¼‰ï¼Œè¿™äº›æ ‡è®°æ˜¯ç¼–è¯‘å™¨æ›´è¿›ä¸€æ­¥å¤„ç†çš„åŸºæœ¬å•ä½ã€‚åœ¨ Go è¯­è¨€çš„ç¼–è¯‘å™¨ä¸­ï¼Œtokens.go æ–‡ä»¶åŒ…å«äº†ä¸è¯æ³•åˆ†ææœ‰å…³çš„æ ‡è®°å®šä¹‰ã€‚ è¯æ³•è§£æçš„è¿‡ç¨‹å¯ä»¥åˆ†ä¸ºå‡ ä¸ªå…³é”®æ­¥éª¤ï¼š æ‰«æï¼ˆScanningï¼‰ï¼šç¼–è¯‘å™¨çš„æ‰«æå™¨ä¼šé€å­—ç¬¦è¯»å–æºä»£ç ï¼Œè¯†åˆ«å‡ºåŸºæœ¬çš„è¯­æ³•å•ä½ï¼Œå¦‚æ ‡è¯†ç¬¦ã€å…³é”®å­—ã€å­—é¢é‡ã€è¿ç®—ç¬¦ç­‰ã€‚ æ ‡è®°ç”Ÿæˆï¼ˆToken Generationï¼‰ï¼šæ¯å½“æ‰«æå™¨è¯†åˆ«å‡ºä¸€ä¸ªæœ‰æ•ˆçš„è¯­æ³•å•ä½æ—¶ï¼Œå®ƒä¼šç”Ÿæˆä¸€ä¸ªç›¸åº”çš„æ ‡è®°ã€‚ä¾‹å¦‚ï¼Œå¯¹äºä¸€ä¸ªå˜é‡åï¼Œæ‰«æå™¨ä¼šç”Ÿæˆä¸€ä¸ªæ ‡è¯†ç¬¦æ ‡è®°ã€‚ å»é™¤ç©ºç™½å­—ç¬¦å’Œæ³¨é‡Šï¼šåœ¨ç”Ÿæˆæ ‡è®°çš„è¿‡ç¨‹ä¸­ï¼Œæ‰«æå™¨è¿˜ä¼šå¿½ç•¥ç©ºç™½å­—ç¬¦ï¼ˆå¦‚ç©ºæ ¼ã€æ¢è¡Œç¬¦ï¼‰å’Œæ³¨é‡Šï¼Œå› ä¸ºå®ƒä»¬å¯¹ç¨‹åºçš„é€»è¾‘æ²¡æœ‰å½±å“ã€‚ é”™è¯¯å¤„ç†ï¼šå¦‚æœæ‰«æå™¨åœ¨æºä»£ç ä¸­é‡åˆ°æ— æ³•è¯†åˆ«çš„å­—ç¬¦æˆ–åºåˆ—ï¼Œå®ƒä¼šç”Ÿæˆä¸€ä¸ªé”™è¯¯æ¶ˆæ¯ã€‚ æˆ‘ä»¬æ¥çœ‹ä»¥ä¸‹ tokens.go æ–‡ä»¶ä¸­çš„ token å®šä¹‰ï¼Œå®ƒä»¬å®è´¨ä¸Šæ˜¯ç”¨ iota å£°æ˜çš„ä¸€ç³»åˆ—æ•´æ•°ï¼š const (\t_ token = iota\t_EOF // EOF\t// names and literals\t_Name // name\t_Literal // literal\t// operators and operations\t// _Operator is excluding * (_Star)\t_IncOp // opop _Define // := ...\t// delimiters\t_Lparen // (\t_Rparen // )\t...\t// keywords\t_Break // break\t...\t// empty line comment to exclude it from .String\ttokenCount //) ä¸¾ä¸ªä¾‹å­ï¼Œa := b + c(12) è¿™ä¸ªè¡¨è¾¾å¼ï¼Œè¢«è§£æåï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š Go è¯­è¨€ç¼–è¯‘å™¨è¯æ³•è§£æç¤ºä¾‹å›¾ è¯­æ³•è§£æ è¯­æ³•è§£æå‘ç”Ÿåœ¨è¯æ³•è§£æä¹‹åï¼Œå…¶ä¸»è¦ç›®çš„æ˜¯åˆ†ææºä»£ç ä¸­æ ‡è®°ï¼ˆtokensï¼‰çš„æ’åˆ—å’Œç»“æ„ï¼Œä»¥ç¡®å®šå®ƒä»¬æ˜¯å¦å½¢æˆäº†æœ‰æ•ˆçš„è¯­å¥ã€‚æ ¸å¿ƒç®—æ³•ä½äºä¸¤ä¸ªæ–‡ä»¶ä¸­ï¼š syntax/nodes.goï¼šå®šä¹‰äº†è¯­æ³•èŠ‚ç‚¹ï¼ˆSyntax Nodesï¼‰ï¼Œè¿™äº›èŠ‚ç‚¹æ˜¯æ„æˆæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰çš„åŸºæœ¬å…ƒç´ ã€‚æ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨äº† Go è¯­æ³•ä¸­çš„ä¸€ä¸ªæ„é€ ï¼Œæ¯”å¦‚å˜é‡å£°æ˜ã€å‡½æ•°è°ƒç”¨ã€è¡¨è¾¾å¼ç­‰ã€‚é€šè¿‡è¿™äº›èŠ‚ç‚¹ï¼Œç¼–è¯‘å™¨èƒ½å¤Ÿç†è§£å’Œè¡¨ç¤ºç¨‹åºä»£ç çš„ç»“æ„ã€‚ syntax/parser.goï¼šåŒ…å«äº†è§£æå™¨çš„å®ç°ã€‚è§£æå™¨è´Ÿè´£è¯»å–è¯æ³•åˆ†æé˜¶æ®µç”Ÿæˆçš„æ ‡è®°æµï¼Œå¹¶æ ¹æ®è¿™äº›æ ‡è®°æ„å»º ASTã€‚å®ƒéµå¾ª Go è¯­è¨€çš„è¯­æ³•è§„åˆ™ï¼Œç¡®ä¿ä»£ç ç¬¦åˆè¯­æ³•ç»“æ„ï¼Œå¹¶åœ¨é‡åˆ°è¯­æ³•é”™è¯¯æ—¶æä¾›ç›¸åº”çš„åé¦ˆã€‚ Go è¯­è¨€é‡‡ç”¨äº†æ ‡å‡†çš„è‡ªä¸Šè€Œä¸‹çš„é€’å½’ä¸‹é™ï¼ˆTop-Down Recursive-Descentï¼‰ç®—æ³•ï¼Œä»¥ç®€å•é«˜æ•ˆçš„æ–¹å¼å®Œæˆæ— é¡»å›æº¯çš„è¯­æ³•æ‰«æã€‚ ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹ nodes.go æ–‡ä»¶ä¸­å¯¹å„ä¸ªèŠ‚ç‚¹çš„å£°æ˜ï¼ˆä»¥ä¸‹éƒ½çœç•¥äº† struct ä¸­çš„å…·ä½“å±æ€§ï¼‰ï¼š å£°æ˜ Declarations type (\tDecl interface Node aDecl() ImportDecl struct // å¯¼å…¥å£°æ˜\tConstDecl struct // å¸¸é‡å£°æ˜\tTypeDecl struct // ç±»å‹å£°æ˜\tVarDecl struct // å˜é‡å£°æ˜\tFuncDecl struct // å‡½æ•°å£°æ˜) è¡¨è¾¾å¼ Expressions type (\tExpr interface Node typeInfo aExpr() // çœç•¥äº†ç»“æ„ä½“å±æ€§\tBadExpr struct // æ— æ•ˆè¡¨è¾¾å¼\tName struct // Value\tBasicLit struct // Value\tCompositeLit struct // Type ElemList[0], ElemList[1], ... KeyValueExpr struct // Key: Value\tFuncLit struct // func Type Body ParenExpr struct // (X)\tSelectorExpr struct // X.Sel\tIndexExpr struct // X[Index]\tSliceExpr struct // X[Index[0] : Index[1] : Index[2]]\tAssertExpr struct // X.(Type)\tTypeSwitchGuard struct // Lhs := X.(type)\tOperation struct // æ“ä½œ +-*\\\tCallExpr struct // Fun(ArgList[0], ArgList[1], ...)\tListExpr struct // ElemList[0], ElemList[1], ...\tArrayType struct // [Len]Elem\tSliceType struct // []Elem\tDotsType struct // ...Elem\tStructType struct // struct FieldList[0] TagList[0]; FieldList[1] TagList[1]; ... Field struct // Name Type\tInterfaceType struct // interface MethodList[0]; MethodList[1]; ... FuncType struct // type FuncName func (param1, param2) return1, return2\tMapType struct // map[Key]Value\tChanType struct // chan Elem, -chan Elem, chan- Elem) è¯­å¥ Statements type ( // æ‰€æœ‰è¯­å¥çš„é€šç”¨æ¥å£ Stmt interface Node aStmt() // æ›´åŠ ç®€å•è¯­å¥çš„é€šç”¨æ¥å£ SimpleStmt interface EmptyStmt struct // ç©ºè¯­å¥ LabeledStmt struct // æ ‡ç­¾è¯­å¥ BlockStmt struct // ä»£ç å—è¯­å¥ ExprStmt struct // è¡¨è¾¾å¼è¯­å¥ SendStmt struct // å‘é€è¯­å¥ï¼Œç”¨äº channel DeclStmt struct // å£°æ˜è¯­å¥ AssignStmt struct // èµ‹å€¼è¯­å¥ BranchStmt struct // åˆ†æ”¯è¯­å¥ï¼Œbreak, continue CallStmt struct // è°ƒç”¨è¯­å¥ ReturnStmt struct // è¿”å›è¯­å¥ IfStmt struct // if æ¡ä»¶è¯­å¥ ForStmt struct // for å¾ªç¯è¯­å¥ SwitchStmt struct // switch è¯­å¥ SelectStmt struct // select è¯­å¥) æˆ‘ä»¬å¯ä»¥é‡ç‚¹æ¥çœ‹ä¸€ä¸‹æœ€å¸¸ç”¨çš„èµ‹å€¼è¯­å¥ï¼š type AssignStmt struct Op Operator // æ“ä½œç¬¦ 0 means no operation Lhs, Rhs Expr // å·¦å³ä¸¤ä¸ªè¡¨è¾¾å¼ Rhs == nil means Lhs++ (Op == Add) or Lhs-- (Op == Sub) simpleStmt ä¸¾ä¾‹ package mainimport fmtconst name = hedontype String stringvar s String = hello + wordfunc main() fmt.Println(s) ä¸Šé¢çš„æºä»£ç ä¼šè¢«è§£ææˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š Go ç¼–è¯‘å™¨è¯­æ³•è§£æç¤ºä¾‹å›¾ å†æ¥çœ‹ä¸€ä¸ªèµ‹å€¼è¯­å¥æ˜¯å¦‚ä½•è§£æçš„ï¼Œå°±ä»¥ä¹‹å‰çš„ a := b + c(12) ä¸ºä¾‹ï¼š ç‰¹å®šèµ‹å€¼è¯­å¥çš„è¯­æ³•è§£æç¤ºä¾‹ æŠ½è±¡è¯­æ³•æ ‘æ„å»º ç¼–è¯‘å™¨å‰ç«¯å¿…é¡»æ„å»ºç¨‹åºçš„ä¸­é—´è¡¨ç¤ºå½¢å¼ï¼Œä»¥ä¾¿åœ¨ç¼–è¯‘å™¨ä¸­ç«¯åŠåç«¯ä½¿ç”¨ï¼ŒæŠ½è±¡è¯­æ³•æ ‘ï¼ˆAbstract Syntax Treeï¼ŒASTï¼‰æ˜¯ä¸€ç§å¸¸è§çš„æ ‘çŠ¶ç»“æ„çš„ä¸­é—´æ€ã€‚ æŠ½è±¡è¯­æ³•æ ‘ æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼ŒAbstract Syntax Treeï¼‰æ˜¯æºä»£ç çš„æ ‘çŠ¶ç»“æ„è¡¨ç¤ºï¼Œå®ƒç”¨äºè¡¨ç¤ºç¼–ç¨‹è¯­è¨€çš„è¯­æ³•ç»“æ„ï¼Œä½†ä¸åŒ…æ‹¬æ‰€æœ‰è¯­æ³•ç»†èŠ‚ã€‚AST æ˜¯ç¼–è¯‘å™¨è®¾è®¡ä¸­çš„å…³é”®æ¦‚å¿µï¼Œå¹¿æ³›åº”ç”¨äºç¼–è¯‘å™¨çš„å„ä¸ªé˜¶æ®µã€‚ åŸºæœ¬æ¦‚å¿µï¼š ç»“æ„ï¼šAST æ˜¯ä¸€ç§æ ‘å½¢ç»“æ„ï¼Œå…¶ä¸­æ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨ç¨‹åºä¸­çš„ä¸€ç§æ„é€ ï¼ˆå¦‚è¡¨è¾¾å¼ã€è¯­å¥ç­‰ï¼‰ã€‚ æŠ½è±¡æ€§ï¼šå®ƒæŠ½è±¡å‡ºäº†ä»£ç çš„è¯­æ³•ç»“æ„ï¼Œçœç•¥äº†æŸäº›è¯­æ³•ç»†èŠ‚ï¼ˆå¦‚æ‹¬å·ã€ç‰¹å®šçš„è¯­æ³•æ ¼å¼ç­‰ï¼‰ã€‚ èŠ‚ç‚¹ç±»å‹ï¼š æ ¹èŠ‚ç‚¹ï¼šä»£è¡¨æ•´ä¸ªç¨‹åºæˆ–ä¸€æ®µå®Œæ•´ä»£ç ã€‚ å†…éƒ¨èŠ‚ç‚¹ï¼šé€šå¸¸ä»£è¡¨æ§åˆ¶ç»“æ„ï¼ˆå¦‚å¾ªç¯ã€æ¡ä»¶è¯­å¥ï¼‰å’Œæ“ä½œç¬¦ï¼ˆå¦‚åŠ ã€å‡ã€ä¹˜ã€é™¤ï¼‰ã€‚ å¶èŠ‚ç‚¹ï¼šä»£è¡¨ç¨‹åºä¸­çš„åŸºæœ¬å…ƒç´ ï¼Œå¦‚å¸¸é‡ã€å˜é‡å’Œæ ‡è¯†ç¬¦ã€‚ æ„å»ºè¿‡ç¨‹ï¼š è¯æ³•åˆ†æï¼šæºä»£ç é¦–å…ˆç»è¿‡è¯æ³•åˆ†æï¼Œåˆ†è§£ä¸ºä¸€ç³»åˆ—æ ‡è®°ï¼ˆtokensï¼‰ã€‚ è¯­æ³•åˆ†æï¼šç„¶åï¼ŒåŸºäºè¿™äº›æ ‡è®°ï¼Œè¯­æ³•åˆ†æå™¨æ ¹æ®ç¼–ç¨‹è¯­è¨€çš„è¯­æ³•è§„åˆ™æ„å»º ASTã€‚ æ ‘çš„æ„å»ºï¼šåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œåˆ†æå™¨ä¼šæ ¹æ®è¯­è¨€çš„è¯­æ³•åˆ›å»ºä¸åŒç±»å‹çš„èŠ‚ç‚¹ï¼Œå¹¶æŒ‰ç…§ç¨‹åºçš„ç»“æ„å°†å®ƒä»¬ç»„ç»‡æˆæ ‘ã€‚ ä½¿ç”¨åœºæ™¯ï¼š è¯­ä¹‰åˆ†æï¼šç¼–è¯‘å™¨ä½¿ç”¨ AST æ¥è¿›è¡Œç±»å‹æ£€æŸ¥å’Œå…¶ä»–è¯­ä¹‰åˆ†æã€‚ ä»£ç ä¼˜åŒ–ï¼šåœ¨ä¼˜åŒ–é˜¶æ®µï¼Œç¼–è¯‘å™¨ä¼šå¯¹ AST è¿›è¡Œå˜æ¢ï¼Œä»¥æé«˜ä»£ç çš„æ‰§è¡Œæ•ˆç‡ã€‚ ä»£ç ç”Ÿæˆï¼šç¼–è¯‘å™¨æ ¹æ® AST ç”Ÿæˆä¸­é—´ä»£ç æˆ–ç›®æ ‡ä»£ç ã€‚ ä¼˜ç‚¹ï¼š ç®€åŒ–å¤„ç†ï¼šç”±äºçœç•¥äº†ä¸å¿…è¦çš„è¯­æ³•ç»†èŠ‚ï¼ŒAST ä½¿å¾—ç¼–è¯‘å™¨çš„è®¾è®¡æ›´ä¸ºç®€æ´å’Œé«˜æ•ˆã€‚ çµæ´»æ€§ï¼šAST å¯ä»¥è½»æ¾åœ°è¿›è¡Œä¿®æ”¹å’Œæ‰©å±•ï¼Œä¾¿äºå®ç°å„ç§ç¼–è¯‘å™¨åŠŸèƒ½ã€‚ å¯è§†åŒ–ï¼šAST çš„æ ‘å½¢ç»“æ„ä½¿å¾—ä»£ç çš„é€»è¾‘ç»“æ„ä¸€ç›®äº†ç„¶ï¼Œæœ‰åŠ©äºç†è§£å’Œè°ƒè¯•ã€‚ Go æ„å»ºæŠ½è±¡è¯­æ³•æ ‘ åœ¨ Go è¯­è¨€æºæ–‡ä»¶ä¸­çš„ä»»ä½•ä¸€ç§ Declarations éƒ½æ˜¯ä¸€ä¸ªæ ¹èŠ‚ç‚¹ï¼Œå¦‚ä¸‹ pkgInit(decls) å‡½æ•°å°†æºæ–‡ä»¶ä¸­çš„æ‰€æœ‰å£°æ˜è¯­å¥éƒ½è½¬æ¢ä¸ºèŠ‚ç‚¹ï¼ˆNodeï¼‰ï¼Œä»£ç ä½äºï¼šsyntax/syntax.go å’Œ syntax/parser.go ä¸­ã€‚ Parse() func Parse(base *PosBase, src io.Reader, errh ErrorHandler, pragh PragmaHandler, mode Mode) (_ *File, first error) defer func() if p := recover(); p != nil if err, ok := p.(Error); ok first = err return panic(p) ()\tvar p parser\tp.init(base, src, errh, pragh, mode)\tp.next()\treturn p.fileOrNil(), p.first ä¸‹é¢æ˜¯å¯¹ Parse() å‡½æ•°çš„ä¸€ä¸ªç®€å•è§£é‡Šï¼š ä½œç”¨ï¼šè§£æå•ä¸ª Go æºæ–‡ä»¶å¹¶è¿”å›ç›¸åº”çš„è¯­æ³•æ ‘ã€‚ å‚æ•° base: ä½ç½®åŸºç¡€ä¿¡æ¯ã€‚ src: è¦è§£æçš„æºæ–‡ä»¶ã€‚ errh: é”™è¯¯å¤„ç†å‡½æ•°ã€‚ pragh: ç”¨äºå¤„ç†æ¯ä¸ªé‡åˆ°çš„ç¼–è¯‘æŒ‡ä»¤ï¼ˆpragmaï¼‰ã€‚ mode: è§£ææ¨¡å¼ã€‚ è¿”å›å€¼ï¼šè¿”å›ä¸€ä¸ª File ç±»å‹çš„æŒ‡é’ˆï¼Œè¡¨ç¤ºè§£æåçš„ ASTï¼Œä»¥åŠå¯èƒ½çš„é”™è¯¯ã€‚ é”™è¯¯å¤„ç† å¦‚æœ errh ä¸ä¸ºç©ºï¼šå°†ä¼šè°ƒç”¨å®ƒå¤„ç†æ¯ä¸ªé‡åˆ°çš„é”™è¯¯ï¼Œè§£æå™¨å°½å¯èƒ½å¤šåœ°å¤„ç†æºæ–‡ä»¶ã€‚æ­¤æ—¶ï¼Œåªæœ‰åœ¨æ²¡æœ‰æ‰¾åˆ°æ­£ç¡®çš„åŒ…å£°æ˜æ—¶ï¼Œè¿”å›çš„è¯­æ³•æ ‘æ‰ä¸º nilã€‚ å¦‚æœ errh ä¸ºç©ºï¼šè§£æå™¨åœ¨é‡åˆ°ç¬¬ä¸€ä¸ªé”™è¯¯æ—¶ç«‹å³ç»ˆæ­¢ï¼Œè¿”å›çš„è¯­æ³•æ ‘ä¸º nilã€‚ å…¶ä¸­ File ç±»å‹ç»“æ„å¦‚ä¸‹ï¼š type File struct Pragma Pragma // ç¼–è¯‘æŒ‡ä»¤\tPkgName *Name // åŒ…å\tDeclList []Decl // æºæ–‡ä»¶ä¸­çš„å„ç§å£°æ˜\tEOF Pos // è§£æä½ç½®\tGoVersion string // go ç‰ˆæœ¬ node // è¯¥æºæ–‡ä»¶çš„ AST æ ¹èŠ‚ç‚¹ parser.fileOrNil() å…·ä½“çš„è§£æè¿‡ç¨‹åœ¨ parser.fileOrNil() æ–¹æ³•ä¸­ï¼š func (p *parser) fileOrNil() *File if trace defer p.trace(file)() // 1. åˆå§‹åŒ–æ–‡ä»¶èŠ‚ç‚¹\tf := new(File)\tf.pos = p.pos()\t// 2. è§£æåŒ…å£°æ˜\tf.GoVersion = p.goVersion\tp.top = false\tif !p.got(_Package) // åŒ…å£°æ˜å¿…é¡»æ”¾åœ¨ç¬¬ä¸€ä½ï¼Œè¿™è·Ÿæˆ‘ä»¬å­¦ Go è¯­æ³•å¯¹åº”ä¸Šäº† p.syntaxError(package statement must be first) return nil f.Pragma = p.takePragma() // è·å–ç¼–è¯‘æŒ‡ä»¤\tf.PkgName = p.name()\t// è·å–åŒ…å p.want(_Semi) // _Semi åœ¨ä¹‹å‰çš„ tokens.go ä¸­å¯ä»¥å‘ç°æ˜¯åˆ†å·ï¼ˆ;)ï¼Œæ˜¯çš„ï¼ŒåŒ…å£°æ˜åé¢å°±æ˜¯å¾—å¸¦åˆ†å·\t// 3. å¤„ç†åŒ…å£°æ˜é”™è¯¯\tif p.first != nil return nil // 4. å¾ªç¯è§£æé¡¶å±‚å£°æ˜ // å¾ªç¯å¤„ç†æ–‡ä»¶ä¸­çš„æ‰€æœ‰å£°æ˜ï¼ŒåŒ…æ‹¬ importã€constã€typeã€var å’Œ func // å¯¹æ¯ç§ç±»å‹çš„å£°æ˜ï¼Œè°ƒç”¨å…¶è§£æå‡½æ•°ï¼Œå¦‚ importDeclã€constDecl è¿›è¡Œè§£æ\tprev := _Import\tfor p.tok != _EOF if p.tok == _Import prev != _Import p.syntaxError(imports must appear before other declarations) prev = p.tok switch p.tok case _Import: p.next() f.DeclList = p.appendGroup(f.DeclList, p.importDecl) case _Const: p.next() f.DeclList = p.appendGroup(f.DeclList, p.constDecl) case _Type: p.next() f.DeclList = p.appendGroup(f.DeclList, p.typeDecl) case _Var: p.next() f.DeclList = p.appendGroup(f.DeclList, p.varDecl) case _Func: p.next() if d := p.funcDeclOrNil(); d != nil f.DeclList = append(f.DeclList, d) default: // 5. å¤„ç†å¼‚å¸¸å’Œé”™è¯¯ if p.tok == _Lbrace len(f.DeclList) 0 isEmptyFuncDecl(f.DeclList[len(f.DeclList)-1]) p.syntaxError(unexpected semicolon or newline before ) else p.syntaxError(non-declaration statement outside function body) p.advance(_Import, _Const, _Type, _Var, _Func) continue // Reset p.pragma BEFORE advancing to the next token (consuming ;) // since comments before may set pragmas for the next function decl. p.clearPragma() if p.tok != _EOF !p.got(_Semi) p.syntaxError(after top level declaration) p.advance(_Import, _Const, _Type, _Var, _Func) // 6. å®Œæˆè§£æï¼Œè®°å½•æ–‡ä»¶ç»“æŸçš„ä½ç½®\tp.clearPragma()\tf.EOF = p.pos()\treturn f æ€»ç»“ parser.fileOrNil() æ–¹æ³•çš„å¤„ç†è¿‡ç¨‹å¤§è‡´å¦‚ä¸‹ï¼š åˆå§‹åŒ–æ–‡ä»¶èŠ‚ç‚¹ï¼š f := new(File): åˆ›å»ºä¸€ä¸ªæ–°çš„ File èŠ‚ç‚¹ã€‚ f.pos = p.pos(): è®¾ç½®èŠ‚ç‚¹çš„ä½ç½®ä¿¡æ¯ã€‚ è§£æåŒ…å£°æ˜ï¼ˆPackage Clauseï¼‰ï¼š f.GoVersion = p.goVersion: è®°å½• Go ç‰ˆæœ¬ã€‚ p.top = false: è®¾ç½®çŠ¶æ€ï¼Œè¡¨ç¤ºä¸å†å¤„äºæ–‡ä»¶é¡¶å±‚ã€‚ if !p.got(_Package) ...: æ£€æŸ¥æ˜¯å¦å­˜åœ¨åŒ…å£°æ˜ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™æŠ¥é”™å¹¶è¿”å› nilã€‚ f.Pragma = p.takePragma(): è·å–ä¸åŒ…å£°æ˜ç›¸å…³çš„ç¼–è¯‘æŒ‡ä»¤ã€‚ f.PkgName = p.name(): è·å–åŒ…åã€‚ p.want(_Semi): ç¡®è®¤åŒ…å£°æ˜åæœ‰åˆ†å·ã€‚ å¤„ç†åŒ…å£°æ˜é”™è¯¯ï¼š if p.first != nil ...: å¦‚æœå·²æœ‰é”™è¯¯ï¼Œåœæ­¢è§£æå¹¶è¿”å› nilã€‚ è§£æé¡¶å±‚å£°æ˜ï¼š é€šè¿‡ä¸€ä¸ªå¾ªç¯å¤„ç†æ–‡ä»¶ä¸­çš„æ‰€æœ‰å£°æ˜ï¼ŒåŒ…æ‹¬å¯¼å…¥ï¼ˆimportï¼‰ã€å¸¸é‡ï¼ˆconstï¼‰ã€ç±»å‹ï¼ˆtypeï¼‰ã€å˜é‡ï¼ˆvarï¼‰å’Œå‡½æ•°ï¼ˆfuncï¼‰ã€‚ å¯¹æ¯ç§ç±»å‹çš„å£°æ˜ï¼Œè°ƒç”¨ç›¸åº”çš„è§£æå‡½æ•°ï¼ˆå¦‚ p.importDeclã€p.constDecl ç­‰ï¼‰ã€‚ å°†è§£æå¾—åˆ°çš„å£°æ˜æ·»åŠ åˆ° f.DeclList ä¸­ã€‚ å¤„ç†å¼‚å¸¸å’Œé”™è¯¯ï¼š åœ¨è§£æè¿‡ç¨‹ä¸­é‡åˆ°çš„ä»»ä½•ä¸ç¬¦åˆè¯­æ³•çš„æƒ…å†µéƒ½ä¼šè§¦å‘é”™è¯¯å¤„ç†ã€‚ ä½¿ç”¨ p.syntaxError æŠ¥å‘Šè¯­æ³•é”™è¯¯ã€‚ ä½¿ç”¨ p.advance åœ¨é‡åˆ°é”™è¯¯æ—¶è·³è¿‡ä¸€äº›æ ‡è®°ï¼Œä»¥å°è¯•æ¢å¤åˆ°ä¸€ä¸ªå·²çŸ¥çš„ç¨³å®šçŠ¶æ€ã€‚ å®Œæˆè§£æï¼š å½“é‡åˆ°æ–‡ä»¶ç»“æŸæ ‡è®°ï¼ˆEOFï¼‰æ—¶ï¼Œå®Œæˆè§£æã€‚ f.EOF = p.pos(): è®°å½•æ–‡ä»¶ç»“æŸçš„ä½ç½®ã€‚ è¿”å›æ„å»ºçš„ File èŠ‚ç‚¹ã€‚ Op å­—æ®µ AST æ¯ä¸ªèŠ‚ç‚¹éƒ½åŒ…å«äº†å½“å‰èŠ‚ç‚¹å±æ€§çš„ Op å­—æ®µï¼Œå®šä¹‰åœ¨ ir/node.go ä¸­ï¼Œä»¥ O å¼€å¤´ã€‚ä¸è¯æ³•è§£æé˜¶æ®µä¸­çš„ token ç›¸åŒçš„æ˜¯ï¼ŒOp å­—æ®µä¹Ÿæ˜¯ä¸€ä¸ªæ•´æ•°ã€‚ä¸åŒçš„æ˜¯ï¼Œæ¯ä¸ª Op å­—æ®µéƒ½åŒ…å«äº†è¯­ä¹‰ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œå½“ä¸€ä¸ªèŠ‚ç‚¹çš„ Op æ“ä½œä¸º OAS æ—¶ï¼Œè¯¥èŠ‚ç‚¹ä»£è¡¨çš„è¯­ä¹‰ä¸º Left := Rightï¼Œè€Œå½“èŠ‚ç‚¹çš„æ“ä½œä¸º OAS2 æ—¶ï¼Œä»£ç çš„è¯­ä¹‰ä¸º x,y,z = a,b,cã€‚ è¿™é‡Œä»…å±•ç¤ºéƒ¨åˆ† Op å­—æ®µçš„å®šä¹‰ï¼š type Op uint8// Node ops.const (\tOXXX Op = iota\t// names\tONAME // var or func name\t// Unnamed arg or return value: f(int, string) (int, error) etc // Also used for a qualified package identifier that hasnt been resolved yet.\tONONAME\tOTYPE // type name\tOLITERAL // literal\tONIL // nil\t// expressions\tOADD // X + Y\t...\t// X = Y or (if Def=true) X := Y\t// If Def, then Init includes a DCL node for X.\tOAS\t// Lhs = Rhs (x, y, z = a, b, c) or (if Def=true) Lhs := Rhs\t// If Def, then Init includes DCL nodes for Lhs\tOAS2\t... // statements OLABEL // Label: ...\tOEND) ä»¥å‰é¢ä¸¾ä¾‹çš„èµ‹å€¼è¯­å¥ a := b + c(12) ä¸ºä¾‹ï¼Œè¯¥èµ‹å€¼è¯­å¥æœ€ç»ˆä¼šç¼–ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºçš„æŠ½è±¡è¯­æ³•æ ‘ï¼ŒèŠ‚ç‚¹ä¹‹é—´å…·æœ‰ä»ä¸Šåˆ°ä¸‹çš„å±‚æ¬¡ç»“æ„å’Œä¾èµ–å…³ç³»ã€‚ æŠ½è±¡è¯­æ³•æ ‘ç¤ºä¾‹å›¾ ç±»å‹æ£€æŸ¥ å®Œæˆ AST çš„åˆæ­¥æ„å»ºåï¼Œå°±è¿›å…¥ç±»å‹æ£€æŸ¥é˜¶æ®µéå†èŠ‚ç‚¹æ ‘å¹¶å†³å®šèŠ‚ç‚¹çš„ç±»å‹ã€‚å…·ä½“çš„ä»£ç åœ¨ types2/check,goã€‚ checker.CheckFiles() å…¶ä¸­æœ€æ ¸å¿ƒçš„æ–¹æ³•å°±æ˜¯ checker.CheckFiles()ï¼š func (check *Checker) checkFiles(files []*syntax.File) (err error) // 1. ä¸æ£€æŸ¥ unsafe åŒ…\tif check.pkg == Unsafe return nil // 2. æ£€æŸ¥ go ç‰ˆæœ¬\tcheck.version, err = parseGoVersion(check.conf.GoVersion)\tif err != nil return err if check.version.after(version1, goversion.Version) return fmt.Errorf(package requires newer Go version %v, check.version) if check.conf.FakeImportC check.conf.go115UsesCgo return errBadCgo // 3. é”™è¯¯å¤„ç†\tdefer check.handleBailout(err) // 4. è¯¦ç»†æ£€æŸ¥æ¯ä¸ªåœ°æ–¹\tprint := func(msg string) if check.conf.Trace fmt.Println() fmt.Println(msg) print(== initFiles ==)\tcheck.initFiles(files)\tprint(== collectObjects ==)\tcheck.collectObjects()\tprint(== packageObjects ==)\tcheck.packageObjects()\tprint(== processDelayed ==)\tcheck.processDelayed(0) // incl. all functions\tprint(== cleanup ==)\tcheck.cleanup()\tprint(== initOrder ==)\tcheck.initOrder()\tif !check.conf.DisableUnusedImportCheck print(== unusedImports ==) check.unusedImports() print(== recordUntyped ==)\tcheck.recordUntyped()\tif check.firstErr == nil check.monomorph() check.pkg.goVersion = check.conf.GoVersion\tcheck.pkg.complete = true\t// 5. æ›´æ–°å’Œæ¸…ç†\tcheck.imports = nil\tcheck.dotImportMap = nil\tcheck.pkgPathMap = nil\tcheck.seenPkgMap = nil\tcheck.recvTParamMap = nil\tcheck.brokenAliases = nil\tcheck.unionTypeSets = nil\tcheck.ctxt = nil\treturn æ€»ç»“ checker.checkFiles() çš„è¿‡ç¨‹å¤§è‡´å¦‚ä¸‹ï¼š æ£€æŸ¥ç‰¹æ®ŠåŒ…ï¼šå¦‚æœæ˜¯ Unsafe åŒ…ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œå› ä¸ºå®ƒä¸èƒ½è¿›è¡Œç±»å‹æ£€æŸ¥ä¸”ä¸åº”è¢«ä¿®æ”¹ã€‚ è§£æGoç‰ˆæœ¬ï¼šæ ¹æ®é…ç½®è§£æ Go ç‰ˆæœ¬ï¼Œå¹¶è¿›è¡Œå…¼å®¹æ€§æ£€æŸ¥ã€‚ é”™è¯¯å¤„ç†ï¼šè®¾ç½®ä¸€ä¸ªå»¶è¿Ÿå‡½æ•°æ¥å¤„ç†ä»»ä½•å¯èƒ½å‡ºç°çš„é”™è¯¯ã€‚ ç±»å‹æ£€æŸ¥çš„æ­¥éª¤ï¼š initFiles: åˆå§‹åŒ–æ–‡ä»¶ã€‚ collectObjects: æ”¶é›†å¯¹è±¡ã€‚ packageObjects: æ‰“åŒ…å¯¹è±¡ã€‚ processDelayed: å¤„ç†å»¶è¿Ÿçš„ä»»åŠ¡ï¼ˆåŒ…æ‹¬æ‰€æœ‰å‡½æ•°ï¼‰ã€‚ cleanup: æ¸…ç†ã€‚ initOrder: åˆå§‹åŒ–é¡ºåºã€‚ unusedImports: æ£€æŸ¥æœªä½¿ç”¨çš„å¯¼å…¥ã€‚ recordUntyped: è®°å½•æœªå®šç±»å‹ã€‚ monomorph: å¦‚æœæ²¡æœ‰é”™è¯¯ï¼Œè¿›è¡Œå•æ€åŒ–å¤„ç†ã€‚ æ›´æ–°å’Œæ¸…ç†ï¼š æ›´æ–°åŒ…çš„ Go ç‰ˆæœ¬å’Œå®ŒæˆçŠ¶æ€ã€‚ æ¸…ç†ä¸å†éœ€è¦çš„å†…éƒ¨æ•°æ®ç»“æ„ï¼Œé‡Šæ”¾å†…å­˜ã€‚ è¿”å›ï¼šå‡½æ•°å®Œæˆç±»å‹æ£€æŸ¥å¹¶è¿”å›ã€‚ å¯ä»¥çœ‹å‡ºå…·ä½“çš„æ£€æŸ¥æ­¥éª¤éƒ½å°è£…åœ¨ç¬¬ 4 ç‚¹çš„å„ä¸ªå‡½æ•°ä¸­ï¼Œå…¶å®æ£€æŸ¥çš„ä¸œè¥¿æˆ‘ä»¬å­¦ä¹  Go è¯­è¨€æ—¶æ‰€éœ€è¦æŒæ¡çš„é‚£äº›è¯­æ³•ï¼Œæˆ‘ä»¬ä»¥ initFiles ä¸ºä¾‹å­æ¥åˆ†æä¸€ä¸‹ï¼Œå¯¹äºå…¶ä»–æ£€æŸ¥å‡½æ•°ï¼Œä½ æœ‰å…´è¶£çš„è¯ä¹Ÿå¯ä»¥äº†è§£ä¸€ä¸‹ï¼Œè¿™é‡Œæ¨èå°†å‡½æ•°æºä»£ç æ‹·è´å‘ç»™ ChatGPT-4ï¼Œç›¸ä¿¡å¯¹ä½ ä¼šæœ‰å¾ˆå¤§çš„å¸®åŠ©ã€‚ checker.initFiles() // initFiles åˆå§‹åŒ–ä¸æ–‡ä»¶ç›¸å…³çš„ç±»å‹æ£€æŸ¥å™¨// å‚æ•°ä¸­çš„ files å¿…é¡»éƒ½å±äºåŒä¸€ä¸ª packagefunc (check *Checker) initFiles(files []*syntax.File) // 1. åˆå§‹åŒ–\tcheck.files = nil\tcheck.imports = nil\tcheck.dotImportMap = nil\tcheck.firstErr = nil\tcheck.methods = nil\tcheck.untyped = nil\tcheck.delayed = nil\tcheck.objPath = nil\tcheck.cleaners = nil\t// 2. ç¡®å®šåŒ…åå’Œæœ‰æ•ˆæ–‡ä»¶\tpkg := check.pkg\tfor _, file := range files switch name := file.PkgName.Value; pkg.name case : if name != _ pkg.name = name else check.error(file.PkgName, BlankPkgName, invalid package name _) fallthrough case name: check.files = append(check.files, file) default: check.errorf(file, MismatchedPkgName, package %s; expected %s, name, pkg.name) // ignore this file // 3. å¯¹æ¯ä¸ªæ–‡ä»¶ï¼Œè§£æå…¶ä¸­æŒ‡å®šçš„ Go ç‰ˆæœ¬\tfor _, file := range check.files v, _ := parseGoVersion(file.GoVersion) if v.major 0 if v.equal(check.version) continue // Go 1.21 introduced the feature of setting the go.mod // go line to an early version of Go and allowing //go:build lines // to â€œupgradeâ€ the Go version in a given file. // We can do that backwards compatibly. // Go 1.21 also introduced the feature of allowing //go:build lines // to â€œdowngradeâ€ the Go version in a given file. // That cant be done compatibly in general, since before the // build lines were ignored and code got the modules Go version. // To work around this, downgrades are only allowed when the // modules Go version is Go 1.21 or later. // If there is no check.version, then we dont really know what Go version to apply. // Legacy tools may do this, and they historically have accepted everything. // Preserve that behavior by ignoring //go:build constraints entirely in that case. if (v.before(check.version) check.version.before(version1, 21)) || check.version.equal(version0, 0) continue if check.posVers == nil check.posVers = make(map[*syntax.PosBase]version) check.posVers[base(file.Pos())] = v æ€»ç»“ checker.initFiles() æ–¹æ³•çš„å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š åˆå§‹åŒ–çŠ¶æ€ï¼šæ¸…ç©º Checker ç»“æ„ä½“ä¸­ä¸æ–‡ä»¶ç›¸å…³çš„å¤šä¸ªå­—æ®µï¼Œå¦‚ files, imports, dotImportMap ç­‰ï¼Œä¸ºæ–°çš„æ£€æŸ¥è¿‡ç¨‹åšå‡†å¤‡ã€‚ ç¡®å®šåŒ…åå’Œæœ‰æ•ˆæ–‡ä»¶ï¼š éå†æä¾›çš„æ–‡ä»¶ï¼Œç¡®å®šåŒ…åï¼Œå¹¶æ”¶é›†æœ‰æ•ˆçš„æ–‡ä»¶ã€‚ å¦‚æœæ–‡ä»¶çš„åŒ…åä¸ Checker ä¸­çš„åŒ…åä¸åŒ¹é…ï¼Œåˆ™æŠ¥é”™å¹¶å¿½ç•¥è¯¥æ–‡ä»¶ã€‚ å¤„ç†Goç‰ˆæœ¬ï¼š å¯¹æ¯ä¸ªæ–‡ä»¶ï¼Œè§£æå…¶ä¸­æŒ‡å®šçš„ Go ç‰ˆæœ¬ã€‚ å¤„ç† Go ç‰ˆæœ¬çš„å…¼å®¹æ€§å’Œå‡çº§é€»è¾‘ï¼Œå°¤å…¶æ˜¯åœ¨ Go 1.21 å¼•å…¥çš„ä¸€äº›ç‰¹æ€§ï¼Œå¦‚ //go:build è¡Œçš„å¤„ç†ã€‚ å¯ä»¥çœ‹åˆ° Go è¯­è¨€å¼€å‘å›¢é˜Ÿåœ¨è¿™é‡Œå†™äº†ä¸€å¤§æ®µå…³äº Go1.21 çš„æ³¨é‡Šï¼Œè¿™æ®µæ³¨é‡Šæè¿°äº† Go 1.21 ç‰ˆæœ¬å¼•å…¥çš„å…³äº Go ç‰ˆæœ¬è®¾ç½®çš„ä¸¤ä¸ªæ–°ç‰¹æ€§,è¿™é‡Œç®€å•è§£é‡Šä¸€ä¸‹ï¼š å‡çº§ Go ç‰ˆæœ¬çš„ç‰¹æ€§ï¼šåœ¨ Go 1.21 ç‰ˆæœ¬ä¸­ï¼Œå¯ä»¥åœ¨ go.mod æ–‡ä»¶é‡Œè®¾ç½®ä¸€ä¸ªè¾ƒæ—§çš„Goç‰ˆæœ¬ï¼ŒåŒæ—¶å…è®¸åœ¨æºæ–‡ä»¶ä¸­é€šè¿‡ //go:build è¡Œæ¥æŒ‡å®šä¸€ä¸ªæ›´é«˜çš„ Go ç‰ˆæœ¬ã€‚è¿™æ ·åšå¯ä»¥å‘åå…¼å®¹ï¼Œå³å…è®¸æ—§ç‰ˆæœ¬ä»£ç åœ¨æ–°ç‰ˆæœ¬çš„ Go ç¯å¢ƒä¸­è¿è¡Œã€‚ é™çº§ Go ç‰ˆæœ¬çš„é™åˆ¶ï¼šGo 1.21 ä¹Ÿå…è®¸é€šè¿‡ //go:build è¡Œæ¥é™ä½æºæ–‡ä»¶ä¸­çš„ Go ç‰ˆæœ¬ã€‚ä½†è¿™é€šå¸¸ä¸æ˜¯å‘åå…¼å®¹çš„ï¼Œå› ä¸ºåœ¨ä»¥å‰ï¼Œ//go:build è¡Œè¢«å¿½ç•¥ï¼Œä»£ç æ€»æ˜¯ä½¿ç”¨æ¨¡å—å®šä¹‰çš„ Go ç‰ˆæœ¬ã€‚ä¸ºäº†é¿å…å…¼å®¹æ€§é—®é¢˜ï¼Œä»…å½“æ¨¡å—çš„ Go ç‰ˆæœ¬ä¸º 1.21 æˆ–æ›´é«˜æ—¶ï¼Œæ‰å…è®¸è¿™ç§é™çº§ã€‚ æœªæŒ‡å®šç‰ˆæœ¬çš„æƒ…å†µï¼šå¦‚æœæ²¡æœ‰æ˜ç¡®æŒ‡å®š check.versionï¼Œç¼–è¯‘å™¨å°±ä¸ç¡®å®šåº”è¯¥ä½¿ç”¨å“ªä¸ª Go ç‰ˆæœ¬ã€‚ä¸ºäº†ä¿æŒä¸æ—§å·¥å…·çš„å…¼å®¹ï¼Œå¦‚æœæ²¡æœ‰æ˜ç¡®çš„ç‰ˆæœ¬çº¦æŸï¼Œç¼–è¯‘å™¨å°†å¿½ç•¥ //go:build è¡Œçš„é™åˆ¶ã€‚ æ­»ä»£ç æ¶ˆé™¤ ç±»å‹æ£€æŸ¥é˜¶æ®µå®Œæˆåï¼Œç¼–è¯‘å™¨å‰ç«¯å·¥ä½œåŸºæœ¬å®Œæˆï¼Œåé¢å°±è¿›å…¥ä¸­ç«¯äº†ã€‚è¿™ä¸ªé˜¶æ®µ Go è¯­è¨€ç¼–è¯‘å™¨å°†å¯¹ AST è¿›è¡Œåˆ†æå’Œé‡æ„ï¼Œä»è€Œå®Œæˆä¸€ç³»åˆ—ä¼˜åŒ–ã€‚ ç¬¬ä¸€éƒ¨åˆ†æ˜¯æ­»ä»£ç æ¶ˆé™¤ï¼ˆdead code eliminationï¼‰ï¼Œè¿‡ç¨‹è¯†åˆ«å¹¶ç§»é™¤ä¸ä¼šåœ¨è¿è¡Œæ—¶æ‰§è¡Œçš„ä»£ç ã€‚è¿™åŒ…æ‹¬æœªä½¿ç”¨çš„å˜é‡ã€å‡½æ•°ã€å¸¸é‡ç­‰ã€‚é€šè¿‡åˆ é™¤è¿™äº›æ— ç”¨ä»£ç ç‰‡æ®µï¼Œå¯ä»¥å‡å°æœ€ç»ˆç¨‹åºçš„å¤§å°å¹¶æé«˜è¿è¡Œæ•ˆç‡ã€‚ è¿™éƒ¨åˆ†çš„ä»£ç åœ¨ï¼šdeadcode/deadcode.goã€‚æ‰“å¼€ä»£ç æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°æ ¸å¿ƒå°±æ˜¯ Func() å’Œ stmt() è¿™ 2 ä¸ªå‡½æ•°ã€‚ Func() func Func(fn *ir.Func) // 1. å¯¹å‡½æ•°ä½“è¿›è¡Œé¢„å¤„ç†\tstmts(fn.Body) // 2. ç©ºå‡½æ•°ä½“ç›´æ¥è¿”å›\tif len(fn.Body) == 0 return // 3. éå†å‡½æ•°ä½“ï¼Œå¯¹å…¶ä¸­æ¯ä¸ªèŠ‚ç‚¹è¿›è¡Œå¤„ç†\tfor _, n := range fn.Body // èŠ‚ç‚¹æœ‰ä»»ä½•åˆå§‹åŒ–æ“ä½œï¼Œåˆ™ä¸å¯æ¶ˆé™¤ï¼Œæå‰è¿”å›ã€‚ if len(n.Init()) 0 return switch n.Op() case ir.OIF: n := n.(*ir.IfStmt) // å¦‚æœ if è¯­å¥åˆ¤æ–­æ¡ä»¶ä¸æ˜¯å¸¸é‡ï¼Œæˆ–è€… if else ä¸­çš„ body ä¸ä¸ºç©ºï¼Œåˆ™ä¸å¯æ¶ˆé™¤ï¼Œæå‰è¿”å› if !ir.IsConst(n.Cond, constant.Bool) || len(n.Body) 0 || len(n.Else) 0 return case ir.OFOR: n := n.(*ir.ForStmt) // å¦‚æœ for å¾ªç¯æ¡ä»¶ä¸æ˜¯å¸¸é‡æˆ–ä¸€ç›´ä¸ºçœŸï¼Œåˆ™ä¸å¯æ¶ˆé™¤ï¼Œæå‰è¿”å› if !ir.IsConst(n.Cond, constant.Bool) || ir.BoolVal(n.Cond) return default: return // 4. æ ‡è®°éšè—é—­åŒ…ä¸ºæ­»ä»£ç \tir.VisitList(fn.Body, markHiddenClosureDead) // 5. é‡ç½®å‡½æ•°ä½“ï¼Œæ›¿æ¢ä¸ºä¸€ä¸ªç©ºè¯­å¥ï¼Œè¿›è¡Œæ¸…ç†å’Œä¼˜åŒ–\tfn.Body = []ir.Nodeir.NewBlockStmt(base.Pos, nil) è¯­å¥å¤„ç†ï¼ˆstmts(fn.Body)ï¼‰ï¼šå¯¹å‡½æ•°ä½“ä¸­çš„è¯­å¥è¿›è¡Œé¢„å¤„ç†æˆ–è½¬æ¢ï¼Œä»¥ä¾¿äºåç»­çš„åˆ†æå’Œä¼˜åŒ–ã€‚ ç©ºå‡½æ•°ä½“ç›´æ¥è¿”å›ï¼šå¦‚æœå‡½æ•°ä½“ä¸ºç©ºï¼Œæ²¡æœ‰ä»»ä½•ä»£ç éœ€è¦æ‰§è¡Œï¼Œå› æ­¤å‡½æ•°ç›´æ¥è¿”å›ã€‚è¿™æ˜¯ä¸€ç§ä¼˜åŒ–ï¼Œé¿å…å¯¹ç©ºå‡½æ•°ä½“è¿›è¡Œä¸å¿…è¦çš„åˆ†æã€‚ éå†å‡½æ•°ä½“: èŠ‚ç‚¹åˆå§‹åŒ–æ£€æŸ¥ï¼šå¦‚æœä»»ä½•èŠ‚ç‚¹æœ‰åˆå§‹åŒ–æ“ä½œï¼Œæ„å‘³ç€å¯èƒ½å­˜åœ¨å‰¯ä½œç”¨æˆ–å¿…è¦çš„ä»£ç æ‰§è¡Œï¼Œå› æ­¤å‡½æ•°æå‰è¿”å›ã€‚ If å’Œ For è¯­å¥ç‰¹æ®Šå¤„ç† ir.OIFï¼šå¦‚æœ If è¯­å¥çš„æ¡ä»¶ä¸æ˜¯å¸¸é‡å¸ƒå°”å€¼ï¼Œæˆ–è€… If è¯­å¥æœ‰éç©ºçš„ body æˆ– else åˆ†æ”¯ï¼Œåˆ™æå‰è¿”å›ï¼Œå› ä¸ºè¿™äº›åˆ†æ”¯å¯èƒ½åŒ…å«é‡è¦çš„ä»£ç ã€‚ ir.OFORï¼šå¯¹äº For å¾ªç¯ï¼Œå¦‚æœæ¡ä»¶ä¸æ˜¯å¸¸é‡å¸ƒå°”å€¼æˆ–è€…å¸ƒå°”å€¼ä¸ºçœŸï¼Œæ„å‘³ç€å¾ªç¯å¯èƒ½æ‰§è¡Œï¼Œå› æ­¤æå‰è¿”å›ã€‚ æ ‡è®°éšè—é—­åŒ…ä¸ºæ­»ä»£ç ï¼ˆmarkHiddenClosureDeadï¼‰ï¼šå¦‚æœæ‰€æœ‰èŠ‚ç‚¹éƒ½ä¸è§¦å‘æå‰è¿”å›ï¼Œæ„å‘³ç€æ•´ä¸ªå‡½æ•°ä½“å¯èƒ½æ²¡æœ‰æœ‰æ•ˆçš„ä»£ç æ‰§è¡Œã€‚æ­¤æ—¶ï¼Œå°†éšè—çš„é—­åŒ…æ ‡è®°ä¸ºæ­»ä»£ç ï¼Œå¯èƒ½æ˜¯ä¸ºäº†è¿›ä¸€æ­¥çš„ä¼˜åŒ–å¤„ç†ï¼Œå¦‚ç§»é™¤è¿™äº›ä»£ç ã€‚ é‡ç½®å‡½æ•°ä½“ï¼šæœ€åï¼Œå°†å‡½æ•°ä½“æ›¿æ¢ä¸ºä¸€ä¸ªç©ºçš„æ–°å—è¯­å¥ï¼Œè¿™è¡¨æ˜åŸå§‹çš„å‡½æ•°ä½“è¢«è®¤ä¸ºæ˜¯æ— æ•ˆçš„æˆ–ä¸ä¼šè¢«æ‰§è¡Œï¼Œä»è€Œè¿›è¡Œäº†ä»£ç çš„æ¸…ç†å’Œä¼˜åŒ–ã€‚ stmt() è¿™ä¸ªå‡½æ•°çš„ç›®çš„æ˜¯é€šè¿‡åˆ†æå’Œç®€åŒ–æ§åˆ¶æµç»“æ„ï¼Œæ¥è¯†åˆ«å’Œç§»é™¤é‚£äº›åœ¨ç¨‹åºæ‰§è¡Œä¸­æ°¸è¿œä¸ä¼šåˆ°è¾¾çš„ä»£ç éƒ¨åˆ†ã€‚è¿™æ ·çš„ä¼˜åŒ–å¯ä»¥å‡å°‘ç¼–è¯‘åçš„ä»£ç é‡ï¼Œå¹¶æé«˜ç¨‹åºè¿è¡Œæ—¶çš„æ•ˆç‡ã€‚ func stmts(nn *ir.Nodes) // 1. æ ‡è®°æœ€åä¸€ä¸ªæ ‡ç­¾ï¼Œå…¶å¯¹åº”çš„ Op å­—æ®µå°±æ˜¯ OLABEL\tvar lastLabel = -1\tfor i, n := range *nn if n != nil n.Op() == ir.OLABEL lastLabel = i // 2. å¤„ç† if å’Œ switch è¯­å¥\tfor i, n := range *nn cut := false if n == nil continue if n.Op() == ir.OIF n := n.(*ir.IfStmt) n.Cond = expr(n.Cond) // if è¯­å¥æ ¹æ®æ¡ä»¶æ˜¯å¦ä¸ºå¸¸é‡æ¥ä¿ç•™å’Œç§»é™¤åˆ†æ”¯ if ir.IsConst(n.Cond, constant.Bool) var body ir.Nodes if ir.BoolVal(n.Cond) ir.VisitList(n.Else, markHiddenClosureDead) n.Else = ir.Nodes body = n.Body else ir.VisitList(n.Body, markHiddenClosureDead) n.Body = ir.Nodes body = n.Else // å¦‚æœ then æˆ– else åˆ†æ”¯ä»¥ panic æˆ– return è¯­å¥ç»“æŸï¼Œé‚£ä¹ˆå¯ä»¥å®‰å…¨åœ°ç§»é™¤è¯¥èŠ‚ç‚¹ä¹‹åçš„æ‰€æœ‰è¯­å¥ã€‚ // è¿™æ˜¯å› ä¸º panic æˆ– return ä¼šå¯¼è‡´å‡½æ•°ç»ˆæ­¢ï¼Œåç»­çš„ä»£ç æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œã€‚ // åŒæ—¶ï¼Œæ³¨é‡Šæåˆ°è¦é¿å…ç§»é™¤æ ‡ç­¾ï¼ˆlabelsï¼‰ï¼Œå› ä¸ºå®ƒä»¬å¯èƒ½æ˜¯ goto è¯­å¥çš„ç›®æ ‡ï¼Œ // è€Œä¸”ä¸ºäº†é¿å… goto ç›¸å…³çš„å¤æ‚æ€§ï¼Œæ²¡æœ‰ä½¿ç”¨ isterminating æ ‡è®°ã€‚ // might be the target of a goto. See issue 28616. if body := body; len(body) != 0 switch body[(len(body) - 1)].Op() case ir.ORETURN, ir.OTAILCALL, ir.OPANIC: if i lastLabel cut = true // å°è¯•ç®€åŒ– switch è¯­å¥ï¼Œæ ¹æ®æ¡ä»¶å€¼å†³å®šå“ªä¸ªåˆ†æ”¯å§‹ç»ˆè¢«æ‰§è¡Œ if n.Op() == ir.OSWITCH n := n.(*ir.SwitchStmt) func() if n.Tag != nil n.Tag.Op() == ir.OTYPESW return // no special type-switch case yet. var x constant.Value // value were switching on if n.Tag != nil if ir.ConstType(n.Tag) == constant.Unknown return x = n.Tag.Val() else x = constant.MakeBool(true) // switch ... = switch true ... var def *ir.CaseClause for _, cas := range n.Cases if len(cas.List) == 0 // default case def = cas continue for _, c := range cas.List if ir.ConstType(c) == constant.Unknown return // cant statically tell if it matches or not - give up. if constant.Compare(x, token.EQL, c.Val()) for _, n := range cas.Body if n.Op() == ir.OFALL return // fallthrough makes it complicated - abort. // This switch entry is the one that always triggers. for _, cas2 := range n.Cases for _, c2 := range cas2.List ir.Visit(c2, markHiddenClosureDead) if cas2 != cas ir.VisitList(cas2.Body, markHiddenClosureDead) // Rewrite to switch case true: ... n.Tag = nil cas.List[0] = ir.NewBool(c.Pos(), true) cas.List = cas.List[:1] n.Cases[0] = cas n.Cases = n.Cases[:1] return if def != nil for _, n := range def.Body if n.Op() == ir.OFALL return // fallthrough makes it complicated - abort. for _, cas := range n.Cases if cas != def ir.VisitList(cas.List, markHiddenClosureDead) ir.VisitList(cas.Body, markHiddenClosureDead) n.Cases[0] = def n.Cases = n.Cases[:1] return // TODO: handle case bodies ending with panic/return as we do in the IF case above. // entire switch is a nop - no case ever triggers for _, cas := range n.Cases ir.VisitList(cas.List, markHiddenClosureDead) ir.VisitList(cas.Body, markHiddenClosureDead) n.Cases = n.Cases[:0] () // 3. å¯¹èŠ‚ç‚¹çš„åˆå§‹åŒ–è¯­å¥é€’å½’è°ƒç”¨ stmt å‡½æ•°è¿›è¡Œå¤„ç† if len(n.Init()) != 0 stmts(n.(ir.InitNode).PtrInit()) // 4. éå†å…¶ä»–æ§åˆ¶ç»“æ„ï¼Œé€’å½’å¤„ç†å®ƒä»¬çš„å†…éƒ¨è¯­å¥ switch n.Op() case ir.OBLOCK: n := n.(*ir.BlockStmt) stmts(n.List) case ir.OFOR: n := n.(*ir.ForStmt) stmts(n.Body) case ir.OIF: n := n.(*ir.IfStmt) stmts(n.Body) stmts(n.Else) case ir.ORANGE: n := n.(*ir.RangeStmt) stmts(n.Body) case ir.OSELECT: n := n.(*ir.SelectStmt) for _, cas := range n.Cases stmts(cas.Body) case ir.OSWITCH: n := n.(*ir.SwitchStmt) for _, cas := range n.Cases stmts(cas.Body) // 5. å¦‚æœç¡®å®šäº†æ˜¯å¯ä»¥æ¶ˆé™¤çš„ä»£ç ï¼Œåˆ™å¯¹å‡½æ•°ä½“è¿›è¡Œé˜¶æ®µï¼Œä¸”æ ‡è®°å…¶ä¸­çš„é—­åŒ…ä¸ºæ­»ä»£ç  if cut ir.VisitList((*nn)[i+1:len(*nn)], markHiddenClosureDead) *nn = (*nn)[:i+1] break æ ‡è®°æœ€åä¸€ä¸ªæ ‡ç­¾ï¼šéå†æ‰€æœ‰èŠ‚ç‚¹ï¼Œè®°å½•æœ€åä¸€ä¸ªæ ‡ç­¾ï¼ˆOLABELï¼‰çš„ä½ç½®ã€‚è¿™å¯¹äºåé¢åˆ¤æ–­æ˜¯å¦å¯ä»¥å®‰å…¨åœ°ç§»é™¤ä»£ç éå¸¸é‡è¦ã€‚ å¤„ç† if å’Œ switch è¯­å¥ï¼š å¯¹äº if è¯­å¥ï¼Œå®ƒæ ¹æ®æ¡ä»¶æ˜¯å¦ä¸ºå¸¸é‡æ¥å†³å®šä¿ç•™å“ªä¸ªåˆ†æ”¯ï¼Œç§»é™¤å¦ä¸€ä¸ªåˆ†æ”¯ã€‚ å¯¹äº switch è¯­å¥ï¼Œå®ƒå°è¯•ç®€åŒ– switchï¼Œæ ¹æ®æ¡ä»¶å€¼å†³å®šå“ªä¸ªåˆ†æ”¯å°†å§‹ç»ˆè¢«æ‰§è¡Œã€‚ èŠ‚ç‚¹åˆå§‹åŒ–ï¼šå¦‚æœèŠ‚ç‚¹æœ‰åˆå§‹åŒ–è¯­å¥ï¼Œå¯¹è¿™äº›åˆå§‹åŒ–è¯­å¥é€’å½’è°ƒç”¨ stmts å‡½æ•°ã€‚ éå†å…¶ä»–æ§åˆ¶ç»“æ„ï¼šå¯¹äº forã€ifã€rangeã€select å’Œ switch ç­‰æ§åˆ¶ç»“æ„ï¼Œé€’å½’åœ°å¤„ç†å®ƒä»¬çš„å†…éƒ¨è¯­å¥ã€‚ æ¶ˆé™¤æ­»ä»£ç ï¼šå¦‚æœåˆ¤æ–­ä¸€ä¸ªèŠ‚ç‚¹ä¹‹åçš„æ‰€æœ‰ä»£ç éƒ½æ˜¯æ— æ•ˆçš„ï¼Œå®ƒä¼šæ ‡è®°è¿™äº›ä»£ç ä¸ºæ­»ä»£ç å¹¶æˆªæ–­å‡½æ•°ä½“ã€‚ å»è™šæ‹ŸåŒ– å»è™šæ‹ŸåŒ–ï¼ˆDevirtualizationï¼‰æ˜¯ç¼–è¯‘å™¨ä¼˜åŒ–çš„ä¸€ç§æŠ€æœ¯ï¼Œç”¨äºæé«˜é¢å‘å¯¹è±¡ç¨‹åºçš„æ€§èƒ½ã€‚åœ¨é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­ï¼Œæ–¹æ³•è°ƒç”¨é€šå¸¸æ˜¯é€šè¿‡è™šæ‹Ÿå‡½æ•°è¡¨ï¼ˆvtableï¼‰åŠ¨æ€è§£æçš„ï¼Œè¿™è¢«ç§°ä¸ºè™šæ‹Ÿè°ƒç”¨ã€‚è™šæ‹Ÿè°ƒç”¨å…è®¸å¯¹è±¡åœ¨è¿è¡Œæ—¶è¡¨ç°å‡ºå¤šæ€è¡Œä¸ºï¼Œä½†è¿™ä¹Ÿå¸¦æ¥äº†ä¸€å®šçš„æ€§èƒ½å¼€é”€ã€‚ å»è™šæ‹ŸåŒ–çš„ç›®çš„æ˜¯åœ¨ç¼–è¯‘æ—¶é™æ€ç¡®å®šæ–¹æ³•è°ƒç”¨çš„ç›®æ ‡ï¼Œä»è€Œé¿å…è¿è¡Œæ—¶çš„åŠ¨æ€æŸ¥æ‰¾ã€‚å¦‚æœç¼–è¯‘å™¨èƒ½å¤Ÿç¡®å®šä¸€ä¸ªç‰¹å®šçš„æ¥å£è°ƒç”¨æ€»æ˜¯è°ƒç”¨åŒä¸€ä¸ªæ–¹æ³•ï¼Œå®ƒå¯ä»¥å°†è¿™ä¸ªè™šæ‹Ÿè°ƒç”¨æ›¿æ¢ä¸ºç›´æ¥è°ƒç”¨ï¼Œå‡å°‘è¿è¡Œæ—¶å¼€é”€ã€‚è¿™ç§ä¼˜åŒ–ç‰¹åˆ«é€‚ç”¨äºé‚£äº›è°ƒç”¨ç›®æ ‡ä¸ä¼šå› ä¸ºç¨‹åºæ‰§è¡Œçš„ä¸åŒè·¯å¾„è€Œæ”¹å˜çš„æƒ…å†µã€‚ è¿™éƒ¨åˆ†çš„ä»£ç åœ¨ devirtuailze/devirtualize.goã€‚ æ ¸å¿ƒå°± 2 ä¸ªå‡½æ•°ï¼š Static() ï¼šéå†å‡½æ•°ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œå°¤å…¶æ³¨æ„è·³è¿‡åœ¨ go æˆ– defer è¯­å¥ä¸­çš„è°ƒç”¨ï¼Œå¹¶å¯¹å…¶ä»–æ¥å£æ–¹æ³•è°ƒç”¨å°è¯•è¿›è¡Œé™æ€å»è™šæ‹ŸåŒ–ä¼˜åŒ–ã€‚ staticCall() ï¼šé’ˆå¯¹ä¸€ä¸ªå…·ä½“çš„æ¥å£æ–¹æ³•è°ƒç”¨ï¼Œå¦‚æœå¯èƒ½ï¼Œå°†å…¶æ›¿æ¢ä¸ºç›´æ¥çš„å…·ä½“ç±»å‹æ–¹æ³•è°ƒç”¨ï¼Œä»¥ä¼˜åŒ–æ€§èƒ½ã€‚ Static() func Static(fn *ir.Func) ir.CurFunc = fn\tgoDeferCall := make(map[*ir.CallExpr]bool) // 1. VisitList å¯¹ fn.Body ä¸­æ‰€æœ‰èŠ‚ç‚¹è°ƒç”¨åé¢çš„ func\tir.VisitList(fn.Body, func(n ir.Node) switch n := n.(type) // 2. è·³è¿‡ go å’Œ defer è¯­å¥ case *ir.GoDeferStmt: if call, ok := n.Call.(*ir.CallExpr); ok goDeferCall[call] = true return // 3. è°ƒç”¨ staticCall å°è¯•è¿›è¡Œå»è™šæ‹ŸåŒ– case *ir.CallExpr: if !goDeferCall[n] staticCall(n) ) è®¾å®šå½“å‰å‡½æ•°ä¸º fnã€‚ éå†å‡½æ•°ä½“å†…çš„èŠ‚ç‚¹ï¼Œç‰¹åˆ«æ³¨æ„ go å’Œ defer è¯­å¥ã€‚å¦‚æœè°ƒç”¨å‘ç”Ÿåœ¨è¿™äº›è¯­å¥ä¸­ï¼Œå®ƒä¼šè¢«è·³è¿‡ï¼Œå› ä¸ºå»è™šæ‹ŸåŒ–å¯èƒ½æ”¹å˜ç¨‹åºçš„è¯­ä¹‰ã€‚ å¯¹äºä¸åœ¨ go æˆ– defer è¯­å¥ä¸­çš„æ¥å£æ–¹æ³•è°ƒç”¨ï¼Œè°ƒç”¨ staticCall å‡½æ•°å°è¯•è¿›è¡Œå»è™šæ‹ŸåŒ–ã€‚ staticCall() func staticCall(call *ir.CallExpr) // 1. æ£€æŸ¥è°ƒç”¨æ˜¯å¦ä¸ºæ¥å£æ–¹æ³•è°ƒç”¨ï¼Œå¦‚æœä¸æ˜¯ï¼Œç›´æ¥è¿”å›\tif call.Op() != ir.OCALLINTER return // 2. è·å–æ¥æ”¶å™¨å’Œç›¸å…³ç±»å‹\tsel := call.X.(*ir.SelectorExpr)\tr := ir.StaticValue(sel.X) // 3. æ£€æŸ¥æ¥æ”¶å™¨æ˜¯å¦æ˜¯æ¥å£è½¬æ¢ï¼Œå¦‚æœä¸æ˜¯ï¼Œç›´æ¥è¿”å›\tif r.Op() != ir.OCONVIFACE return recv := r.(*ir.ConvExpr) // 4. æå–æ¥æ”¶å™¨ç±»å‹\ttyp := recv.X.Type()\tif typ.IsInterface() return // 5. shape ç±»å‹ç›´æ¥è¿”å›ï¼Œå› ä¸ºè¿™ä¸€èˆ¬æ¶‰åŠåˆ°æ³›å‹ï¼Œéœ€è¦é€šè¿‡å­—å…¸è¿›è¡Œé—´æ¥è°ƒç”¨\tif typ.IsShape() return if typ.HasShape() if base.Flag.LowerM != 0 base.WarnfAt(call.Pos(), cannot devirtualize %v: shaped receiver %v, call, typ) return if sel.X.Type().HasShape() if base.Flag.LowerM != 0 base.WarnfAt(call.Pos(), cannot devirtualize %v: shaped interface %v, call, sel.X.Type()) return // 6. ç±»å‹æ–­è¨€å’Œæ–¹æ³•é€‰æ‹©ï¼Œå°è¯•ç¡®å®šè°ƒç”¨çš„å…·ä½“æ–¹æ³•\tdt := ir.NewTypeAssertExpr(sel.Pos(), sel.X, nil)\tdt.SetType(typ)\tx := typecheck.Callee(ir.NewSelectorExpr(sel.Pos(), ir.OXDOT, dt, sel.Sel))\tswitch x.Op() case ir.ODOTMETH: x := x.(*ir.SelectorExpr) if base.Flag.LowerM != 0 base.WarnfAt(call.Pos(), devirtualizing %v to %v, sel, typ) call.SetOp(ir.OCALLMETH) call.X = x\tcase ir.ODOTINTER: x := x.(*ir.SelectorExpr) if base.Flag.LowerM != 0 base.WarnfAt(call.Pos(), partially devirtualizing %v to %v, sel, typ) call.SetOp(ir.OCALLINTER) call.X = x\tdefault: if base.Flag.LowerM != 0 base.WarnfAt(call.Pos(), failed to devirtualize %v (%v), x, x.Op()) return // 7. æ ¹æ®ç±»å‹æ–­è¨€çš„ç»“æœï¼Œå°è¯•å°†æ¥å£æ–¹æ³•è°ƒç”¨è½¬æ¢ä¸ºç›´æ¥æ–¹æ³•è°ƒç”¨æˆ–ä¿ç•™ä¸ºæ¥å£æ–¹æ³•è°ƒç”¨ã€‚\ttypes.CheckSize(x.Type())\tswitch ft := x.Type(); ft.NumResults() case 0:\tcase 1: call.SetType(ft.Results().Field(0).Type)\tdefault: call.SetType(ft.Results()) // 8. å¯¹å¯èƒ½ä¿®æ”¹åçš„æ–¹æ³•è°ƒç”¨è¿›è¡Œè¿›ä¸€æ­¥çš„ç±»å‹æ£€æŸ¥å’Œè°ƒæ•´ã€‚\ttypecheck.FixMethodCall(call) æ£€æŸ¥æ˜¯å¦ä¸ºæ¥å£æ–¹æ³•è°ƒç”¨ï¼šå‡½æ•°é¦–å…ˆåˆ¤æ–­ä¼ å…¥çš„è°ƒç”¨æ˜¯å¦æ˜¯æ¥å£æ–¹æ³•è°ƒç”¨ï¼ˆir.OCALLINTERï¼‰ï¼Œè¿™æ˜¯å»è™šæ‹ŸåŒ–çš„å‰ææ¡ä»¶ã€‚ å¤„ç†å½¢çŠ¶ç±»å‹ï¼šä»£ç ä¸­æåˆ°ï¼Œå¦‚æœæ¥æ”¶å™¨çš„ç±»å‹æ˜¯å½¢çŠ¶ç±»å‹ï¼ˆç”¨äºæ³›å‹ï¼‰ï¼Œåˆ™æ— æ³•å»è™šæ‹ŸåŒ–ï¼Œå› ä¸ºè¿™éœ€è¦é€šè¿‡å­—å…¸è¿›è¡Œé—´æ¥è°ƒç”¨ã€‚ å¤„ç†å½¢çŠ¶ç±»å‹çš„æ¥æ”¶å™¨ï¼šå¦‚æœæ¥æ”¶å™¨çš„ç±»å‹å…·æœ‰å½¢çŠ¶ç±»å‹ï¼Œåˆ™å½“å‰æ— æ³•è¿›è¡Œå»è™šæ‹ŸåŒ–ã€‚æ³¨é‡Šä¸­è¿˜æåˆ°äº†ä¸€äº›å¾…å®ç°ï¼ˆTODOï¼‰çš„ä¼˜åŒ–ç‚¹ï¼Œä¾‹å¦‚å¤„ç†éæ³›å‹çš„æå‡æ–¹æ³•ã€‚ å¤„ç†å½¢çŠ¶ç±»å‹çš„æ¥å£ï¼šå¦‚æœè°ƒç”¨çš„æ¥å£æœ¬èº«æ˜¯ä¸€ä¸ªå½¢çŠ¶ç±»å‹ï¼Œç”±äºæŒ‡é’ˆèº«ä»½çš„ä¸åŒï¼Œç±»å‹æ–­è¨€å¯èƒ½ä¼šå¤±è´¥ï¼Œå› æ­¤åœ¨è¿™ç§æƒ…å†µä¸‹ä¹Ÿæ— æ³•å»è™šæ‹ŸåŒ–ã€‚ è½¬æ¢æ–¹æ³•è°ƒç”¨ï¼šæ ¹æ®è°ƒç”¨çš„å…·ä½“æƒ…å†µï¼Œå°†æ¥å£æ–¹æ³•è°ƒç”¨è½¬æ¢ä¸ºç›´æ¥çš„æ–¹æ³•è°ƒç”¨ï¼ˆOCALLMETHï¼‰æˆ–ä¿ç•™ä¸ºæ¥å£æ–¹æ³•è°ƒç”¨ï¼ˆOCALLINTERï¼‰ã€‚ æ›´æ–°è°ƒç”¨ç±»å‹ï¼šä¸ºäº†æ­£ç¡®å¤„ç†å‡½æ•°è¿”å›å€¼ï¼Œéœ€è¦æ›´æ–°è°ƒç”¨çš„ç±»å‹ï¼Œç¡®ä¿å‚æ•°å¤§å°å’Œæ ˆåç§»é‡æ­£ç¡®ã€‚ åç³–åŒ–æ–¹æ³•è°ƒç”¨ï¼šå¦‚æœåˆ›å»ºäº†ç›´æ¥æ–¹æ³•è°ƒç”¨ï¼Œéœ€è¦å¯¹å…¶è¿›è¡Œåç»­çš„ç±»å‹æ£€æŸ¥å’Œè°ƒæ•´ã€‚ å‡½æ•°å†…è” å‡½æ•°å†…è”æ˜¯å°†ä¸€ä¸ªå‡½æ•°çš„ä»£ç ç›´æ¥æ’å…¥åˆ°æ¯ä¸ªè°ƒç”¨ç‚¹ï¼Œè€Œä¸æ˜¯è¿›è¡Œå¸¸è§„çš„å‡½æ•°è°ƒç”¨ã€‚è¿™æ„å‘³ç€å‡½æ•°çš„æ•´ä¸ªä½“è¢«å¤åˆ¶åˆ°æ¯ä¸ªè°ƒç”¨è¯¥å‡½æ•°çš„åœ°æ–¹ã€‚ ä¼˜ç‚¹ï¼š å‡å°‘å¼€é”€ï¼šå†…è”æ¶ˆé™¤äº†å‡½æ•°è°ƒç”¨çš„å¼€é”€ï¼Œå¦‚å‚æ•°ä¼ é€’ã€æ ˆæ“ä½œç­‰ã€‚ æå‡æ€§èƒ½ï¼šæœ‰åŠ©äºå…¶ä»–ä¼˜åŒ–ï¼Œæ¯”å¦‚å¾ªç¯å±•å¼€ã€å¸¸é‡ä¼ æ’­ï¼Œå› ä¸ºç¼–è¯‘å™¨å¯ä»¥çœ‹åˆ°å‡½æ•°ä½“å†…çš„ä»£ç ã€‚ é€‰æ‹©å“ªäº›å‡½æ•°å†…è”ï¼š å°å‡½æ•°ï¼šé€šå¸¸æ˜¯å°å‡½æ•°ï¼Œå› ä¸ºå®ƒä»¬çš„å†…è”å¸¦æ¥çš„æ€§èƒ½æå‡ç›¸å¯¹äºä»£ç è†¨èƒ€çš„ä»£ä»·æ¥è¯´æ˜¯å€¼å¾—çš„ã€‚ è°ƒç”¨é¢‘ç‡é«˜çš„å‡½æ•°ï¼šè¿™äº›å‡½æ•°å¦‚æœå†…è”ï¼Œå¯ä»¥æ˜¾è‘—å‡å°‘è¿è¡Œæ—¶çš„è°ƒç”¨å¼€é”€ã€‚ åœ¨ Go è¯­è¨€ä¸­ï¼Œå¯ä»¥é€šè¿‡ //go:noinline æ¥ç¦æ­¢å‡½æ•°å†…è”ã€‚ è¿™éƒ¨åˆ†çš„ä¸»è¦å®ç°åœ¨ inline.inl.goï¼Œæ ¸å¿ƒå‡½æ•°æ˜¯ï¼šCanInline() å’Œ InlineImpossible()ã€‚ CanInline() // Inlining budget parameters, gathered in one placeconst ( // budget æ˜¯å†…è”å¤æ‚åº¦çš„è¡¡é‡ï¼Œ // è¶…è¿‡ 80 è¡¨ç¤ºç¼–è¯‘å™¨è®¤ä¸ºè¿™ä¸ªå‡½æ•°å¤ªå¤æ‚äº†ï¼Œå°±ä¸è¿›è¡Œå‡½æ•°å†…è”äº†\tinlineMaxBudget = 80 )// CanInline ç”¨äºåˆ¤æ–­ fn æ˜¯å¦å¯å†…è”ã€‚// å¦‚æœå¯ä»¥ï¼Œä¼šå°† fn.Body å’Œ fn.Dcl æ‹·è´ä¸€ä»½æ”¾åˆ° fn.Inlï¼Œ// å…¶ä¸­ fn å’Œ fn.Body éœ€è¦ç¡®ä¿å·²ç»ç»è¿‡ç±»å‹æ£€æŸ¥äº†ã€‚func CanInline(fn *ir.Func, profile *pgo.Profile) // å‡½æ•°åå¿…é¡»æœ‰æ•ˆ\tif fn.Nname == nil base.Fatalf(CanInline no nname %+v, fn) // å¦‚æœä¸èƒ½å†…è”ï¼Œè¾“å‡ºåŸå› \tvar reason string\tif base.Flag.LowerM 1 || logopt.Enabled() defer func() if reason != if base.Flag.LowerM 1 fmt.Printf(%v: cannot inline %v: %s , ir.Line(fn), fn.Nname, reason) if logopt.Enabled() logopt.LogOpt(fn.Pos(), cannotInlineFunction, inline, ir.FuncName(fn), reason) () // æ£€æŸ¥æ˜¯å¦ç¬¦åˆä¸å¯èƒ½å†…è”çš„æƒ…å†µï¼Œå¦‚æœè¿”å›çš„ reason ä¸ä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºæœ‰ä¸å¯ä»¥å†…è”çš„åŸå› \treason = InlineImpossible(fn)\tif reason != return if fn.Typecheck() == 0 base.Fatalf(CanInline on non-typechecked function %v, fn) n := fn.Nname\tif n.Func.InlinabilityChecked() return defer n.Func.SetInlinabilityChecked(true)\tcc := int32(inlineExtraCallCost)\tif base.Flag.LowerL == 4 cc = 1 // this appears to yield better performance than 0. // è®¾ç½®å†…è”é¢„ç®—ï¼Œåé¢å¦‚æœæ£€æŸ¥å‡½æ•°çš„å¤æ‚åº¦è¶…è¿‡é¢„ç®—äº†ï¼Œå°±ä¸å†…è”äº†\tbudget := int32(inlineMaxBudget)\tif profile != nil if n, ok := profile.WeightedCG.IRNodes[ir.LinkFuncName(fn)]; ok if _, ok := candHotCalleeMap[n]; ok budget = int32(inlineHotMaxBudget) if base.Debug.PGODebug 0 fmt.Printf(hot-node enabled increased budget=%v for func=%v , budget, ir.PkgFuncName(fn)) // éå†å‡½æ•°ä½“ï¼Œè®¡ç®—å¤æ‚åº¦ï¼Œåˆ¤æ–­æ˜¯å¦è¶…è¿‡å†…è”é¢„ç®—\tvisitor := hairyVisitor curFunc: fn, budget: budget, maxBudget: budget, extraCallCost: cc, profile: profile, if visitor.tooHairy(fn) reason = visitor.reason return // å‰é¢æ£€æŸ¥éƒ½æ²¡é—®é¢˜ï¼Œåˆ™æ ‡è®°ä¸ºå¯ä»¥å†…è”ï¼Œå¹¶å¤åˆ¶å…¶å‡½æ•°ä½“å’Œå£°æ˜åˆ°å†…è”ç»“æ„ä½“ä¸­\tn.Func.Inl = ir.Inline Cost: budget - visitor.budget, Dcl: pruneUnusedAutos(n.Defn.(*ir.Func).Dcl, visitor), Body: inlcopylist(fn.Body), CanDelayResults: canDelayResults(fn), // æ—¥å¿—å’Œè°ƒè¯•\tif base.Flag.LowerM 1 fmt.Printf(%v: can inline %v with cost %d as: %v %v , ir.Line(fn), n, budget-visitor.budget, fn.Type(), ir.Nodes(n.Func.Inl.Body)) else if base.Flag.LowerM != 0 fmt.Printf(%v: can inline %v , ir.Line(fn), n) if logopt.Enabled() logopt.LogOpt(fn.Pos(), canInlineFunction, inline, ir.FuncName(fn), fmt.Sprintf(cost: %d, budget-visitor.budget)) åŸºæœ¬æ£€æŸ¥ï¼šéªŒè¯å‡½æ•°æ˜¯å¦å·²ç»è¿›è¡Œäº†ç±»å‹æ£€æŸ¥ï¼Œä»¥åŠå‡½æ•°åæ˜¯å¦æœ‰æ•ˆã€‚ åˆ¤æ–­æ˜¯å¦å¯ä»¥å†…è”ï¼šè°ƒç”¨ InlineImpossible å‡½æ•°æ¥æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•åŸºæœ¬çš„é™åˆ¶æ¡ä»¶é˜»æ­¢å†…è”ï¼ˆä¾‹å¦‚å‡½æ•°å¤ªå¤§ã€é€’å½’ç­‰ï¼‰ã€‚ å†…è”é¢„ç®—è®¾ç½®ï¼šæ ¹æ®å‡½æ•°çš„ç‰¹å¾å’Œå¯èƒ½çš„æ€§èƒ½å‰–æä¿¡æ¯æ¥è®¾å®šå†…è”é¢„ç®—ã€‚è¿™ä¸ªé¢„ç®—æ˜¯å†…è”å†³ç­–çš„å…³é”®å‚æ•°ä¹‹ä¸€ã€‚ è¯¦ç»†åˆ†æï¼šhairyVisitor ç»“æ„ç”¨äºéå†å‡½æ•°ä½“ï¼Œåˆ¤æ–­æ˜¯å¦è¶…å‡ºäº†å†…è”é¢„ç®—ã€‚è¿™æ¶‰åŠå¯¹å‡½æ•°ä½“çš„å¤æ‚åº¦å’Œå¤§å°çš„è¯„ä¼°ã€‚ å†…è”å†³ç­–ï¼šå¦‚æœå‡½æ•°é€šè¿‡äº†æ‰€æœ‰æ£€æŸ¥å¹¶ä¸”æœªè¶…å‡ºé¢„ç®—ï¼Œåˆ™æ ‡è®°ä¸ºå¯ä»¥å†…è”ï¼Œå¹¶å¤åˆ¶å…¶å‡½æ•°ä½“å’Œå£°æ˜ï¼ˆDclï¼‰åˆ°å†…è”ç»“æ„ä½“ä¸­ã€‚ æ—¥å¿—å’Œè°ƒè¯•ï¼šæ ¹æ®ç¼–è¯‘å™¨çš„æ—¥å¿—çº§åˆ«ï¼Œè¾“å‡ºå…³äºå†…è”å†³ç­–çš„è¯¦ç»†ä¿¡æ¯ï¼Œä¾‹å¦‚ä¸ºä»€ä¹ˆä¸€ä¸ªå‡½æ•°ä¸èƒ½è¢«å†…è”æˆ–è€…å®ƒçš„å†…è”æˆæœ¬æ˜¯å¤šå°‘ã€‚ InlineImpossible() func InlineImpossible(fn *ir.Func) string var reason string // reason, if any, that the function can not be inlined.\tif fn.Nname == nil reason = no name return reason // If marked go:noinline, dont inline.\tif fn.Pragmair.Noinline != 0 reason = marked go:noinline return reason // If marked go:norace and -race compilation, dont inline.\tif base.Flag.Race fn.Pragmair.Norace != 0 reason = marked go:norace with -race compilation return reason // If marked go:nocheckptr and -d checkptr compilation, dont inline.\tif base.Debug.Checkptr != 0 fn.Pragmair.NoCheckPtr != 0 reason = marked go:nocheckptr return reason // If marked go:cgo_unsafe_args, dont inline, since the function\t// makes assumptions about its argument frame layout.\tif fn.Pragmair.CgoUnsafeArgs != 0 reason = marked go:cgo_unsafe_args return reason // If marked as go:uintptrkeepalive, dont inline, since the keep\t// alive information is lost during inlining.\t//\t// TODO(prattmic): This is handled on calls during escape analysis,\t// which is after inlining. Move prior to inlining so the keep-alive is\t// maintained after inlining.\tif fn.Pragmair.UintptrKeepAlive != 0 reason = marked as having a keep-alive uintptr argument return reason // If marked as go:uintptrescapes, dont inline, since the escape\t// information is lost during inlining.\tif fn.Pragmair.UintptrEscapes != 0 reason = marked as having an escaping uintptr argument return reason // The nowritebarrierrec checker currently works at function\t// granularity, so inlining yeswritebarrierrec functions can confuse it\t// (#22342). As a workaround, disallow inlining them for now.\tif fn.Pragmair.Yeswritebarrierrec != 0 reason = marked go:yeswritebarrierrec return reason // If a local function has no fn.Body (is defined outside of Go), cannot inline it.\t// Imported functions dont have fn.Body but might have inline body in fn.Inl.\tif len(fn.Body) == 0 !typecheck.HaveInlineBody(fn) reason = no function body return reason // If fn is synthetic hash or eq function, cannot inline it.\t// The function is not generated in Unified IR frontend at this moment.\tif ir.IsEqOrHashFunc(fn) reason = type eq/hash function return reason return æ— å‡½æ•°åï¼šå¦‚æœå‡½æ•°æ²¡æœ‰åå­—ï¼Œä¸èƒ½å†…è”ã€‚ æœ‰ go:noinline æŒ‡ä»¤ï¼šæ˜¾å¼æ ‡è®°ä¸ºä¸å†…è”ã€‚ æœ‰ go:norace æŒ‡ä»¤å¹¶åœ¨ -race ç¼–è¯‘æ¨¡å¼ä¸‹ï¼šåœ¨ç«æ€æ£€æµ‹ç¼–è¯‘æ¨¡å¼ä¸‹ä¸å†…è”æ ‡è®°ä¸º norace çš„å‡½æ•°ã€‚ æœ‰ go:nocheckptr æŒ‡ä»¤å¹¶åœ¨ -d checkptr ç¼–è¯‘æ¨¡å¼ä¸‹ï¼šåœ¨æŒ‡é’ˆæ£€æŸ¥ç¼–è¯‘æ¨¡å¼ä¸‹ä¸å†…è”æ ‡è®°ä¸º nocheckptr çš„å‡½æ•°ã€‚ æœ‰ go:cgo_unsafe_args æŒ‡ä»¤ï¼šå¯¹äºæ ‡è®°ä¸º cgo_unsafe_args çš„å‡½æ•°ï¼Œç”±äºå‚æ•°å¸ƒå±€çš„å‡è®¾ï¼Œä¸å†…è”ã€‚ æœ‰ go:uintptrkeepalive æŒ‡ä»¤ï¼šä¸å†…è”æ ‡è®°ä¸º uintptrkeepalive çš„å‡½æ•°ã€‚ æœ‰ go:uintptrescapes æŒ‡ä»¤ï¼šä¸å†…è”æ ‡è®°ä¸º uintptrescapes çš„å‡½æ•°ã€‚ æœ‰ go:yeswritebarrierrec æŒ‡ä»¤ï¼šä¸ºäº†é˜²æ­¢å†™å±éšœè®°å½•æ£€æŸ¥å™¨çš„æ··æ·†ï¼Œä¸å†…è”æ ‡è®°ä¸º yeswritebarrierrec çš„å‡½æ•°ã€‚ æ— å‡½æ•°ä½“ï¼šæœ¬åœ°å®šä¹‰ä½†æ²¡æœ‰å‡½æ•°ä½“çš„å‡½æ•°ï¼ˆå¤–éƒ¨å®šä¹‰çš„ Go å‡½æ•°ï¼‰ä¸å¯å†…è”ã€‚ æ˜¯åˆæˆçš„ hash æˆ– eq å‡½æ•°ï¼šä¸èƒ½å†…è”è¿™äº›ç±»å‹çš„å‡½æ•°ã€‚ ä¸¾ä¾‹ æˆ‘ä»¬é€šè¿‡ä¸€æ®µä»£ç æ¥çœ‹çœ‹ç¼–è¯‘å™¨çš„å‡½æ•°å†…è”æƒ…å†µã€‚ func SayHello() string s := hello, + world\treturn sfunc Fib(index int) int if index 2 return index return Fib(index-1) + Fib(index-2)func ForSearch() int var s = []int1, 2, 3, 4, 5, 6, 7, 8, 9, 0\tres := 0\tfor i := 0; i len(s); i++ if s[i] == i res = i return resfunc main() SayHello()\tFib(65)\tForSearch() åœ¨ç¼–è¯‘æ—¶æˆ‘ä»¬å¯ä»¥åŠ å…¥ -m=2 æ ‡ç­¾ï¼Œæ¥æ‰“å°å‡½æ•°çš„å†…è”è°ƒè¯•ä¿¡æ¯ã€‚åœ¨ main.go ç›®å½•ä¸‹æ‰§è¡Œï¼š go tool compile -m=2 main.go è¾“å‡ºï¼š main.go:3:6: can inline SayHello with cost 7 as: func() string s := hello, + world; return s main.go:8:6: cannot inline Fib: recursivemain.go:15:6: can inline ForSearch with cost 45 as: func() int s := []int...; res := 0; for loop; return res main.go:26:6: cannot inline main: function too complex: cost 116 exceeds budget 80main.go:27:10: inlining call to SayHellomain.go:29:11: inlining call to ForSearchmain.go:16:15: []int... does not escapemain.go:29:11: []int... does not escape å¯ä»¥çœ‹åˆ° SayHello() å’Œ ForSearch éƒ½è¢«å†…è”äº†ï¼Œè€Œ Fib() å› ä¸ºæœ‰é€’å½’ï¼Œæ‰€ä»¥ä¸ä¼šè¢«å†…è”ã€‚ é€ƒé€¸åˆ†æ é€ƒé€¸åˆ†ææ˜¯ Go è¯­è¨€ä¸­éå¸¸é‡è¦çš„ä¼˜åŒ–é˜¶æ®µï¼Œç”¨äºæ ‡è¯†å˜é‡å†…å­˜åº”è¯¥è¢«åˆ†é…åœ¨æ ˆä¸Šè¿˜æ˜¯å †ä¸Šã€‚ åœ¨ä¼ ç»Ÿçš„ C æˆ– C++ å¼€å‘ä¸­ï¼Œå¼€å‘è€…ç»å¸¸ä¼šçŠ¯çš„é”™è¯¯å°±æ˜¯å‡½æ•°è¿”å›äº†ä¸€ä¸ªæ ˆä¸Šçš„å¯¹è±¡æŒ‡é’ˆï¼Œåœ¨å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œå‡½æ•°æ ˆä¼šè¢«é”€æ¯ï¼Œå¦‚æœç»§ç»­è®¿é—®è¢«é”€æ¯æ ˆä¸Šçš„å¯¹è±¡æŒ‡é’ˆï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°é—®é¢˜ã€‚ Go è¯­è¨€èƒ½å¤Ÿé€šè¿‡ç¼–è¯‘æ—¶çš„é€ƒé€¸åˆ†æè¯†åˆ«è¿™ç§é—®é¢˜ï¼Œè‡ªåŠ¨å°†è¿™ç±»å˜é‡æ”¾ç½®åˆ°å †åŒºï¼Œå¹¶å€ŸåŠ© Go è¿è¡Œæ—¶çš„åƒåœ¾å›æ”¶æœºåˆ¶è‡ªåŠ¨é‡Šæ”¾å†…å­˜ã€‚ç¼–è¯‘å™¨ä¼šå°½å¯èƒ½åœ°å°†å˜é‡æ”¾ç½®åœ¨æ ˆä¸Šï¼Œå› ä¸ºæ ˆä¸­çš„å¯¹è±¡ä¼šéšç€å‡½æ•°è°ƒç”¨ç»“æŸè¢«è‡ªåŠ¨é”€æ¯ï¼Œè¿™å¯ä»¥å‡è½»è¿è¡Œæ—¶åˆ†é…å’Œåƒåœ¾å›æ”¶çš„è´Ÿæ‹…ã€‚ åœ¨ Go è¯­è¨€ä¸­ï¼Œå¼€å‘è€…æ¨¡ç³Šäº†æ ˆåŒºå’Œå †åŒºçš„åŒºåˆ«ï¼Œä¸ç®¡æ˜¯å­—ç¬¦ä¸²ã€æ•°ç»„å­—é¢é‡ï¼Œè¿˜æ˜¯é€šè¿‡ newã€make æ ‡è¯†ç¬¦åˆ›å»ºçš„å¯¹è±¡ï¼Œéƒ½æ—¢å¯èƒ½è¢«åˆ†é…åˆ°æ ˆä¸Šï¼Œä¹Ÿå¯èƒ½è¢«åˆ†é…åˆ°å †ä¸Šã€‚ä½†æ˜¯ï¼Œæ•´ä½“ä¸Šä¼šéµå¾ª 2 ä¸ªåŸåˆ™ï¼š æŒ‡å‘æ ˆä¸Šå¯¹è±¡çš„æŒ‡é’ˆä¸èƒ½è¢«å­˜å‚¨åˆ°å †ä¸Šï¼› æŒ‡å‘æ ˆä¸Šå¯¹è±¡çš„æŒ‡é’ˆä¸èƒ½è¶…è¿‡è¯¥æ ˆå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚ è¿™éƒ¨åˆ†çš„ä»£ç ä¸»è¦åœ¨ escapeã€‚ åˆ†æè¿‡ç¨‹ Go è¯­è¨€é€šè¿‡å¯¹ AST çš„é™æ€æ•°æ®æµåˆ†ææ¥å®ç°é€ƒé€¸åˆ†æï¼ˆescape/graph.goï¼‰ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ï¼Œå®ƒä¼šæ„å»ºå¸¦æƒé‡çš„æœ‰å‘å›¾ï¼Œå…¶ä¸­æƒé‡å¯ä»¥è¡¨é¢å½“å‰å˜é‡å¼•ç”¨å’Œè§£å¼•ç”¨çš„æ•°é‡ã€‚ å¼•ç”¨ï¼ˆaï¼‰ å‡ 1 è§£å¼•ç”¨ï¼ˆ*aï¼‰åŠ  1 func (k hole) deref(where ir.Node, why string) hole return k.shift(1).note(where, why) // è§£å¼•ç”¨func (k hole) addr(where ir.Node, why string) hole return k.shift(-1).note(where, why) // å¼•ç”¨ å…·ä½“æ¥è¯´ï¼ŒGo é€ƒé€¸åˆ†æä¼šæŒ‰ç…§å¦‚ä¸‹è§„åˆ™ç”Ÿæˆæ•°æ®æµå›¾ï¼ˆå¸¦æƒé‡çš„æœ‰å‘å›¾ï¼‰ï¼š æ¯ä¸ªå˜é‡ä½œä¸ºä¸€ä¸ªèŠ‚ç‚¹ï¼ˆlocationï¼‰ï¼› æ¯ä¸ªèµ‹å€¼åŠ¨ä½œæ˜¯ä¸€ä¸ªæœ‰å‘è¾¹ï¼ˆedgeï¼‰ï¼Œèµ‹å€¼ç»™è°åˆ™æŒ‡å‘è°ï¼› è§£å¼•ç”¨ï¼ˆderefï¼‰ï¼Œå³ *æ“ä½œä¼šç»™è¾¹çš„æƒé‡ +1ï¼› å¼•ç”¨ï¼ˆaddrï¼‰ï¼Œå³ æ“ä½œä¼šç»™è¾¹æƒé‡ -1ã€‚ å…¶ä¸­ï¼šèŠ‚ç‚¹æƒé‡ = æŒ‡å‘çš„èŠ‚ç‚¹æƒé‡ + è¾¹æƒé‡ é€ƒé€¸åˆ†æçš„ç›®æ ‡å°±æ˜¯æ‰¾åˆ°å…¶ä¸­èŠ‚ç‚¹æƒé‡ä¸º -1 çš„å˜é‡ï¼Œå¹¶ç»“åˆä¸Šè¿°æåˆ°çš„ 2 ä¸ªåŸåˆ™ï¼Œæ¥åˆ¤æ–­è¦ä¸è¦å°†å˜é‡åˆ†é…åˆ°å †ä¸Šã€‚ åˆ†æå®ä¾‹ æˆ‘ä»¬ä¸¾ä¸€ä¸ªä¾‹å­æ¥è¿›è¡Œåˆ†æï¼š package mainvar o *intfunc main() l := new(int) *l = 42\tm := l\tn := m\to = **n å†æ¬¡å›é¡¾ä¸€ä¸‹ï¼Œ* æ˜¯åŠ  1ï¼Œ æ˜¯å‡ä¸€ã€‚æŒ‰ç…§å¸¸è§„æ€è·¯ï¼Œæˆ‘ä»¬ä»ä¸Šå¾€ä¸‹åˆ†æï¼š å…ˆç”»å‡ºèŠ‚ç‚¹çš„èµ‹å€¼é¡ºåºï¼Œèµ‹å€¼ç»™è°ï¼Œè¾¹å°±æŒ‡å‘è°ï¼š ç¬¬1æ­¥ï¼šæ¢³ç†èŠ‚ç‚¹é¡ºåº ç„¶åæ ¹æ®å¼•ç”¨å’Œè§£å¼•ç”¨ç»™è¾¹èµ‹æƒé‡ï¼Œå› ä¸º new(int) å…¶å®å°±æ˜¯åˆ†é…ä¸€ä¸ª int(0) å¹¶å–åœ°å€ï¼Œç›¸å½“äº ï¼Œæ‰€ä»¥æŒ‡å‘ l çš„è¾¹æƒé‡æ˜¯ -1ï¼š ç¬¬2æ­¥ï¼šç»™è¾¹èµ‹å€¼ èŠ‚ç‚¹æƒé‡ = è¾¹æƒé‡ + æŒ‡å‘èŠ‚ç‚¹æƒé‡ï¼Œå› ä¸ºæ²¡æœ‰å¯¹ o å˜é‡è¿›è¡Œä»»ä½•çš„æ“ä½œï¼Œæ‰€ä»¥ o æƒé‡ä¸º 0ï¼Œä»å³å¾€å·¦æ¨å¯ä»¥å¾—åˆ°ï¼š ç¬¬3æ­¥ï¼šè®¡ç®—èŠ‚ç‚¹æƒé‡ ç»è¿‡åˆ†æï¼Œæˆ‘ä»¬å°±æ‰¾åˆ°äº†èŠ‚ç‚¹æƒé‡ä¸º -1 çš„èŠ‚ç‚¹ new(int)ï¼Œåˆç”±äºå®ƒçš„èŠ‚ç‚¹å˜é‡åœ°å€æœ€ç»ˆä¼šè¢«ä¼ é€’åˆ°å˜é‡ o ä¸Šï¼Œç»“åˆä¹‹å‰çš„ 2 ä¸ªåŸåˆ™ï¼Œo æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå£°æ˜å‘¨æœŸæ˜¯è¶…è¿‡å‡½æ•°æ ˆçš„ï¼Œæ‰€ä»¥ new(int) ä¼šè¢«åˆ†é…åˆ°å †ä¸Šã€‚ å¯ä»¥æ‰§è¡Œä¸‹é¢è¯­å¥è¾“å‡ºé€ƒé€¸ç»“æœï¼š go tool compile -m main.go å¦‚ï¼š /escape/main.go:5:6: can inline main/escape/main.go:6:10: new(int) escapes to hea ä¹Ÿå¯ä»¥æ‰§è¡Œä¸‹é¢è¯­å¥è¾“å‡ºæ•°æ®æµå›¾æ„å»ºè¿‡ç¨‹ï¼š go build -gcflags=-m -m -l main.go å¦‚ï¼š # command-line-arguments./main.go:6:10: new(int) escapes to heap:./main.go:6:10: flow: l = storage for new(int):./main.go:6:10: from new(int) (spill) at ./main.go:6:10./main.go:6:10: from l := new(int) (assign) at ./main.go:6:4./main.go:6:10: flow: m = l:./main.go:6:10: from l (address-of) at ./main.go:8:7./main.go:6:10: from m := l (assign) at ./main.go:8:4./main.go:6:10: flow: n = m:./main.go:6:10: from m (address-of) at ./main.go:9:7./main.go:6:10: from n := m (assign) at ./main.go:9:4./main.go:6:10: flow: heap = **n:./main.go:6:10: from *n (indirection) at ./main.go:10:7./main.go:6:10: from *(*n) (indirection) at ./main.go:10:6./main.go:6:10: from o = *(*n) (assign) at ./main.go:10:4./main.go:6:10: new(int) escapes to heap å¦‚æœæˆ‘ä»¬è¯•ä¸€ä¸‹ï¼ŒæŠŠ o æ”¾åœ¨ main() é‡Œé¢å‘¢ï¼Ÿ func main() var o *int\tl := new(int)\t*l = 42\tm := l n := m o = **n o = o // è®©ç¼–è¯‘é€šè¿‡ æ‰§è¡Œä¸‹é¢è¯­å¥ï¼š go tool compile -m main.go è¾“å‡ºï¼š /escape/main.go:3:6: can inline main/escape/main.go:5:10: new(int) does not escape å¦‚æˆ‘ä»¬æ‰€æƒ³ï¼Œè™½ç„¶ new(int) çš„æƒé‡ä¸º -1ï¼Œä½†æ˜¯å®ƒçš„å£°æ˜å‘¨æœŸå§‹ç»ˆæ²¡æœ‰è¶…è¿‡ main()ï¼Œæ‰€ä»¥æ²¡å¿…è¦é€ƒé€¸åˆ°å †ä¸Šã€‚ å˜é‡æ•è· å˜é‡æ•è·ä¸»è¦æ˜¯é’ˆå¯¹é—­åŒ…ï¼ˆclosureï¼‰åœºæ™¯è€Œè¨€çš„ï¼Œç”±äºé—­åŒ…å‡½æ•°ä¸­å¯èƒ½å¼•ç”¨é—­åŒ…å¤–çš„å˜é‡ï¼Œå› æ­¤å˜é‡æ•è·éœ€è¦æ˜ç¡®åœ¨é—­åŒ…ä¸­é€šè¿‡å€¼å¼•ç”¨æˆ–è€…åœ°å€å¼•ç”¨çš„æ–¹å¼æ¥æ•è·å˜é‡ã€‚ è¿™ä¸€è¿‡ç¨‹åœ¨å‰é¢æåˆ°çš„é€ƒé€¸åˆ†æè¿‡ç¨‹ä¸­è¿›è¡Œï¼Œå…·ä½“å®ç°åœ¨ escape/escape.go çš„ flowClosure() å‡½æ•°ä¸­ï¼š func (b *batch) flowClosure(k hole, clo *ir.ClosureExpr) // éå†é—­åŒ…ä¸­çš„æ‰€æœ‰å˜é‡ for _, cv := range clo.Func.ClosureVars n := cv.Canonical() loc := b.oldLoc(cv) // å¦‚æœå˜é‡æœªè¢«æ•è·ï¼Œåˆ™è§¦å‘é”™è¯¯ if !loc.captured base.FatalfAt(cv.Pos(), closure variable never captured: %v, cv) // æ ¹æ®å˜é‡çš„ç‰¹æ€§å†³å®šæ˜¯é€šè¿‡å€¼è¿˜æ˜¯å¼•ç”¨æ•è· // å¦‚æœå˜é‡æœªè¢«é‡æ–°èµ‹å€¼æˆ–å–å€ï¼Œå¹¶ä¸”å°äºç­‰äº 128 å­—èŠ‚ï¼Œåˆ™é€šè¿‡å€¼æ•è· n.SetByval(!loc.addrtaken !loc.reassigned n.Type().Size() = 128) if !n.Byval() n.SetAddrtaken(true) // ç‰¹æ®Šæƒ…å†µå¤„ç†ï¼šå­—å…¸å˜é‡ä¸é€šè¿‡å€¼æ•è· if n.Sym().Name == typecheck.LocalDictName base.FatalfAt(n.Pos(), dictionary variable not captured by value) // è®°å½•é—­åŒ…æ•è·å˜é‡çš„æ–¹å¼ï¼ˆå€¼æˆ–å¼•ç”¨ï¼‰ if base.Flag.LowerM 1 how := ref if n.Byval() how = value base.WarnfAt(n.Pos(), %v capturing by %s: %v (addr=%v assign=%v width=%d), n.Curfn, how, n, loc.addrtaken, loc.reassigned, n.Type().Size()) // å»ºç«‹é—­åŒ…å˜é‡çš„æ•°æ®æµ k := k if !cv.Byval() k = k.addr(cv, reference) b.flow(k.note(cv, captured by a closure), loc) ä¸¾ä¸ªä¾‹å­ï¼š package mainfunc main() a := 1\tb := 2\tgo func() add(a, b)\t()\ta = 99func add(a, b int) a = a + b æ‰§è¡Œä¸‹é¢è¯­å¥çœ‹çœ‹å˜é‡çš„æ•è·æ–¹å¼ï¼š go tool compile -m=2 main.go | grep capturing è¾“å‡ºï¼š main.go:4:2: main capturing by ref: a (addr=false assign=true width=8)main.go:5:2: main capturing by value: b (addr=false assign=false width=8) å¯ä»¥çœ‹åˆ° a æ˜¯é€šè¿‡ ref åœ°å€å¼•ç”¨ çš„æ–¹å¼è¿›è¡Œå¼•ç”¨çš„ï¼Œè€Œ b æ˜¯é€šè¿‡ value å€¼ä¼ é€’ çš„æ–¹å¼è¿›è¡Œå¼•ç”¨çš„ã€‚ ç®€å•åˆ†æä¸€ä¸‹ï¼šä¸Šè¿°ä¾‹å­ä¸­ï¼Œé—­åŒ…å¼•ç”¨äº† a å’Œ b è¿™ 2 ä¸ªé—­åŒ…å¤–å£°æ˜çš„å˜é‡ï¼Œè€Œå˜é‡ a åœ¨é—­åŒ…ä¹‹å‰åˆåšäº†ä¸€äº›å…¶ä»–çš„æ“ä½œï¼Œè€Œ b æ²¡æœ‰ï¼Œæ‰€ä»¥å¯¹äº aï¼Œå› ä¸ºé—­åŒ…å¤–æœ‰æ“ä½œï¼Œæ‰€ä»¥é—­åŒ…å†…çš„æ“ä½œå¯èƒ½æ˜¯æœ‰ç‰¹æ®Šæ„ä¹‰çš„ï¼Œéœ€è¦åé¦ˆåˆ°é—­åŒ…å¤–ï¼Œå°±éœ€è¦ç”¨ ref åœ°å€å¼•ç”¨äº†ï¼Œè€Œ b åœ¨é—­åŒ…å¤–å¹¶ä¸å…³å¿ƒï¼Œæ‰€ä»¥é—­åŒ…å†…çš„æ“ä½œä¸ä¼šå½±å“åˆ°é—­åŒ…å¤–ï¼Œæ•…ç›´æ¥ä½¿ç”¨ value å€¼ä¼ é€’ å³å¯ã€‚ é—­åŒ…é‡å†™ é€ƒé€¸åˆ†æåï¼Œç°åœ¨æˆ‘ä»¬è¿›å…¥ walk é˜¶æ®µäº†ã€‚è¿™é‡Œé¦–å…ˆä¼šè¿›è¡Œé—­åŒ…é‡å†™ã€‚å…¶æ ¸å¿ƒé€»è¾‘åœ¨ walk/closure.go ä¸­ã€‚ é—­åŒ…é‡å†™åˆ†ä¸º 2 ç§æƒ…å†µï¼š é—­åŒ…å®šä¹‰åè¢«ç«‹å³è°ƒç”¨ é—­åŒ…å®šä¹‰åä¸ç«‹å³è°ƒç”¨ é—­åŒ…å®šä¹‰åè¢«ç«‹å³è°ƒç”¨ åœ¨é—­åŒ…å®šä¹‰åè¢«ç«‹å³è°ƒç”¨çš„æƒ…å†µä¸‹ï¼Œé—­åŒ…åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œè¿™æ—¶å¯ä»¥å°†é—­åŒ…è½¬æ¢ä¸ºæ™®é€šå‡½æ•°çš„è°ƒç”¨å½¢å¼ã€‚ å¦‚ï¼š func main() a := 1\tb := 2\tgo func() add(a, b)\t()\ta = 99func add(a, b int) a = a + b ä¼šè¢«è½¬æ¢ä¸ºæ™®é€šå‡½æ•°çš„è°ƒç”¨å½¢å¼ï¼š func main() a := 1\tb := 2\tgo func1(a, b)\ta = 99// æ³¨æ„è¿™é‡Œ a çš„ç±»å‹çš„ *intï¼Œå› ä¸ºåœ¨å˜é‡æ•è·é˜¶æ®µï¼Œåˆ¤æ–­äº† a åº”è¯¥ç”¨åœ°å€å¼•ç”¨func func1(a *int, b int) add(*a, b)func add(a, b int) a = a + b ç¼–è¯‘å™¨å…·ä½“çš„å¤„ç†é€»è¾‘åœ¨ directClosureCall() ä¸­ï¼š // directClosureCall rewrites a direct call of a function literal into// a normal function call with closure variables passed as arguments.// This avoids allocation of a closure object.//// For illustration, the following call:////\tfunc(a int) // println(byval)// byref++//\t(42)//// becomes:////\tfunc(byval int, byref *int, a int) // println(byval)// (*byref)++//\t(byval, byref, 42)func directClosureCall(n *ir.CallExpr) clo := n.X.(*ir.ClosureExpr)\tclofn := clo.Func // å¦‚æœé—­åŒ…è¶³å¤Ÿç®€å•ï¼Œä¸è¿›è¡Œå¤„ç†ï¼Œç•™ç»™ walkClosure å¤„ç†ã€‚\tif ir.IsTrivialClosure(clo) return // leave for walkClosure to handle // å°†é—­åŒ…ä¸­çš„æ¯ä¸ªå˜é‡è½¬æ¢ä¸ºå‡½æ•°çš„å‚æ•°ã€‚å¯¹äºå¼•ç”¨æ•è·çš„å˜é‡ï¼Œåˆ›å»ºç›¸åº”çš„æŒ‡é’ˆå‚æ•°ã€‚\tvar params []*types.Field\tvar decls []*ir.Name\tfor _, v := range clofn.ClosureVars if !v.Byval() // å¯¹äºå¼•ç”¨æ•è·çš„å˜é‡ï¼Œåˆ›å»ºç›¸åº”çš„æŒ‡é’ˆå‚æ•°ã€‚ addr := ir.NewNameAt(clofn.Pos(), typecheck.Lookup(+v.Sym().Name)) addr.Curfn = clofn addr.SetType(types.NewPtr(v.Type())) v.Heapaddr = addr v = addr v.Class = ir.PPARAM decls = append(decls, v) fld := types.NewField(src.NoXPos, v.Sym(), v.Type()) fld.Nname = v params = append(params, fld) // åˆ›å»ºä¸€ä¸ªæ–°çš„å‡½æ•°ç±»å‹ï¼Œå°†æ•è·çš„å˜é‡ä½œä¸ºå‰ç½®å‚æ•°ï¼Œå¹¶æ›´æ–°å‡½æ•°çš„å£°æ˜ã€‚\tf := clofn.Nname\ttyp := f.Type()\ttyp = types.NewSignature(nil, append(params, typ.Params().FieldSlice()...), typ.Results().FieldSlice())\tf.SetType(typ)\tclofn.Dcl = append(decls, clofn.Dcl...)\t// å°†åŸå§‹çš„é—­åŒ…è°ƒç”¨é‡å†™ä¸ºå¯¹æ–°å‡½æ•°çš„è°ƒç”¨ï¼Œå¹¶å°†æ•è·çš„å˜é‡ä½œä¸ºå®é™…å‚æ•°ä¼ é€’ã€‚\tn.X = f\tn.Args.Prepend(closureArgs(clo)...)\t// è°ƒæ•´è°ƒç”¨è¡¨è¾¾å¼çš„ç±»å‹ï¼Œä»¥åæ˜ å‚æ•°å’Œè¿”å›å€¼ç±»å‹çš„å˜åŒ–ã€‚\tif typ.NumResults() == 1 n.SetType(typ.Results().Field(0).Type) else n.SetType(typ.Results()) // è™½ç„¶ä¸å†æ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„é—­åŒ…ï¼Œä½†ä¸ºäº†ç¡®ä¿å‡½æ•°è¢«ç¼–è¯‘ï¼Œå°†å…¶æ·»åŠ åˆ°å¾…ç¼–è¯‘åˆ—è¡¨ä¸­ã€‚\tir.CurFunc.Closures = append(ir.CurFunc.Closures, clofn) è¿™æ®µä»£ç æ˜¯ Go ç¼–è¯‘å™¨ä¸­çš„ directClosureCall å‡½æ•°ï¼Œç”¨äºå°†ç›´æ¥è°ƒç”¨çš„å‡½æ•°å­—é¢é‡é‡å†™ä¸ºæ­£å¸¸çš„å‡½æ•°è°ƒç”¨ï¼ŒåŒæ—¶å°†é—­åŒ…å˜é‡ä½œä¸ºå‚æ•°ä¼ é€’ã€‚è¿™é¿å…äº†é—­åŒ…å¯¹è±¡çš„åˆ†é…ã€‚ ä¸»è¦æ­¥éª¤å¦‚ä¸‹ï¼š æ£€æŸ¥é—­åŒ…æ˜¯å¦ç®€å•ï¼šå¦‚æœé—­åŒ…è¶³å¤Ÿç®€å•ï¼Œä¸è¿›è¡Œå¤„ç†ï¼Œç•™ç»™ walkClosure å¤„ç†ã€‚ å¤„ç†é—­åŒ…å˜é‡ï¼šå°†é—­åŒ…ä¸­çš„æ¯ä¸ªå˜é‡è½¬æ¢ä¸ºå‡½æ•°çš„å‚æ•°ã€‚å¯¹äºå¼•ç”¨æ•è·çš„å˜é‡ï¼Œåˆ›å»ºç›¸åº”çš„æŒ‡é’ˆå‚æ•°ã€‚ æ›´æ–°å‡½æ•°ç±»å‹å’Œå£°æ˜ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å‡½æ•°ç±»å‹ï¼Œå°†æ•è·çš„å˜é‡ä½œä¸ºå‰ç½®å‚æ•°ï¼Œå¹¶æ›´æ–°å‡½æ•°çš„å£°æ˜ã€‚ é‡å†™è°ƒç”¨ï¼šå°†åŸå§‹çš„é—­åŒ…è°ƒç”¨é‡å†™ä¸ºå¯¹æ–°å‡½æ•°çš„è°ƒç”¨ï¼Œå¹¶å°†æ•è·çš„å˜é‡ä½œä¸ºå®é™…å‚æ•°ä¼ é€’ã€‚ æ›´æ–°è°ƒç”¨è¡¨è¾¾å¼ç±»å‹ï¼šè°ƒæ•´è°ƒç”¨è¡¨è¾¾å¼çš„ç±»å‹ï¼Œä»¥åæ˜ å‚æ•°å’Œè¿”å›å€¼ç±»å‹çš„å˜åŒ–ã€‚ æ·»åŠ åˆ°å¾…ç¼–è¯‘åˆ—è¡¨ï¼šè™½ç„¶ä¸å†æ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„é—­åŒ…ï¼Œä½†ä¸ºäº†ç¡®ä¿å‡½æ•°è¢«ç¼–è¯‘ï¼Œå°†å…¶æ·»åŠ åˆ°å¾…ç¼–è¯‘åˆ—è¡¨ä¸­ã€‚ è¿™ä¸ªå‡½æ•°çš„ç›®çš„æ˜¯ä¼˜åŒ–é—­åŒ…çš„è°ƒç”¨ï¼Œé€šè¿‡é¿å…é—­åŒ…å¯¹è±¡çš„åˆ†é…æ¥æé«˜æ€§èƒ½ã€‚ é—­åŒ…å®šä¹‰åä¸ç«‹å³è°ƒç”¨ å¦‚æœé—­åŒ…å®šä¹‰åä¸è¢«ç«‹å³è°ƒç”¨ï¼Œè€Œæ˜¯åç»­è°ƒç”¨ï¼Œé‚£ä¹ˆåŒä¸€ä¸ªé—­åŒ…å¯èƒ½ä¼šè¢«è°ƒç”¨å¤šæ¬¡ï¼Œè¿™ä¸ªæ—¶å€™å°±å¿…é¡»åˆ›å»ºé—­åŒ…å¯¹è±¡äº†ã€‚ ç¼–è¯‘å™¨å…·ä½“çš„å¤„ç†é€»è¾‘åœ¨ walkClosure() ä¸­ï¼š func walkClosure(clo *ir.ClosureExpr, init *ir.Nodes) ir.Node clofn := clo.Func\t// å¦‚æœæ²¡æœ‰é—­åŒ…å˜é‡ï¼Œé—­åŒ…è¢«è§†ä¸ºå…¨å±€å‡½æ•°ï¼Œç›´æ¥è¿”å›å‡½æ•°åã€‚\tif ir.IsTrivialClosure(clo) if base.Debug.Closure 0 base.WarnfAt(clo.Pos(), closure converted to global) return clofn.Nname // å¯¹äºå¤æ‚é—­åŒ…ï¼Œè®¾ç½®éœ€è¦ä¸Šä¸‹æ–‡æ ‡è®°ï¼Œå¹¶è¿›è¡Œè¿è¡Œæ—¶æ£€æŸ¥ã€‚\tir.ClosureDebugRuntimeCheck(clo)\tclofn.SetNeedctxt(true)\t// ç¡®ä¿é—­åŒ…å‡½æ•°ä¸ä¼šè¢«é‡å¤æ·»åŠ åˆ°ç¼–è¯‘é˜Ÿåˆ—ã€‚\tif !clofn.Walked() clofn.SetWalked(true) ir.CurFunc.Closures = append(ir.CurFunc.Closures, clofn) // æ„é€ ä¸€ä¸ªå¤åˆå­—é¢é‡è¡¨è¾¾å¼æ¥è¡¨ç¤ºé—­åŒ…å®ä¾‹ã€‚\ttyp := typecheck.ClosureType(clo) // å°†é—­åŒ…å‡½æ•°å’Œæ•è·çš„å˜é‡ä½œä¸ºå­—æ®µæ·»åŠ åˆ°é—­åŒ…ç»“æ„ä¸­ã€‚\tclos := ir.NewCompLitExpr(base.Pos, ir.OCOMPLIT, typ, nil)\tclos.SetEsc(clo.Esc())\tclos.List = append([]ir.Nodeir.NewUnaryExpr(base.Pos, ir.OCFUNC, clofn.Nname), closureArgs(clo)...)\tfor i, value := range clos.List clos.List[i] = ir.NewStructKeyExpr(base.Pos, typ.Field(i), value) // åˆ›å»ºé—­åŒ…ç»“æ„çš„åœ°å€ï¼Œå¹¶è¿›è¡Œç±»å‹è½¬æ¢ä»¥ç¬¦åˆé—­åŒ…ç±»å‹ã€‚\taddr := typecheck.NodAddr(clos)\taddr.SetEsc(clo.Esc())\tcfn := typecheck.ConvNop(addr, clo.Type())\t// å¦‚æœå­˜åœ¨é¢„åˆ†é…çš„é—­åŒ…å¯¹è±¡ï¼Œè¿›è¡Œç›¸å…³å¤„ç†ã€‚\tif x := clo.Prealloc; x != nil if !types.Identical(typ, x.Type()) panic(closure type does not match orders assigned type) addr.Prealloc = x clo.Prealloc = nil // å¯¹æœ€ç»ˆæ„å»ºçš„é—­åŒ…è¡¨è¾¾å¼è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ã€‚\treturn walkExpr(cfn, init) æ£€æŸ¥æ˜¯å¦ä¸ºç®€å•é—­åŒ…ï¼šå¦‚æœæ²¡æœ‰é—­åŒ…å˜é‡ï¼Œé—­åŒ…è¢«è§†ä¸ºå…¨å±€å‡½æ•°ï¼Œç›´æ¥è¿”å›å‡½æ•°åã€‚ å¤„ç†éç®€å•é—­åŒ…ï¼šå¯¹äºå¤æ‚é—­åŒ…ï¼Œè®¾ç½®éœ€è¦ä¸Šä¸‹æ–‡æ ‡è®°ï¼Œå¹¶è¿›è¡Œè¿è¡Œæ—¶æ£€æŸ¥ã€‚ é˜²æ­¢é‡å¤å¤„ç†ï¼šç¡®ä¿é—­åŒ…å‡½æ•°ä¸ä¼šè¢«é‡å¤æ·»åŠ åˆ°ç¼–è¯‘é˜Ÿåˆ—ã€‚ åˆ›å»ºé—­åŒ…ç»“æ„ï¼šæ„é€ ä¸€ä¸ªå¤åˆå­—é¢é‡è¡¨è¾¾å¼æ¥è¡¨ç¤ºé—­åŒ…å®ä¾‹ã€‚ å¡«å……é—­åŒ…å‚æ•°ï¼šå°†é—­åŒ…å‡½æ•°å’Œæ•è·çš„å˜é‡ä½œä¸ºå­—æ®µæ·»åŠ åˆ°é—­åŒ…ç»“æ„ä¸­ã€‚ åœ°å€å’Œç±»å‹è½¬æ¢ï¼šåˆ›å»ºé—­åŒ…ç»“æ„çš„åœ°å€ï¼Œå¹¶è¿›è¡Œç±»å‹è½¬æ¢ä»¥ç¬¦åˆé—­åŒ…ç±»å‹ã€‚ å¤„ç†é¢„åˆ†é…çš„é—­åŒ…ï¼šå¦‚æœå­˜åœ¨é¢„åˆ†é…çš„é—­åŒ…å¯¹è±¡ï¼Œè¿›è¡Œç›¸å…³å¤„ç†ã€‚ è¡¨è¾¾å¼å¤„ç†ï¼šå¯¹æœ€ç»ˆæ„å»ºçš„é—­åŒ…è¡¨è¾¾å¼è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ã€‚ éå†å‡½æ•° é—­åŒ…é‡å†™åï¼Œä¼šè¿›å…¥ walk é˜¶æ®µï¼Œå¦‚å®˜æ–¹ æ–‡æ¡£æ‰€è¯´ï¼šè¿™æ˜¯å¯¹ IR è¡¨ç¤ºçš„æœ€åä¸€æ¬¡éå†ï¼Œå®ƒæœ‰ä¸¤ä¸ªç›®çš„ï¼š å°†å¤æ‚çš„è¯­å¥åˆ†è§£ä¸ºç®€å•çš„å•ä¸ªè¯­å¥ï¼Œå¼•å…¥ä¸´æ—¶å˜é‡å¹¶éµå®ˆæ±‚å€¼é¡ºåºï¼› å°†é«˜çº§ Go æ„é€ è½¬æ¢ä¸ºæ›´åŸå§‹çš„æ„é€ ã€‚ ä¸¾ä¸ªä¾‹å­ï¼ŒwalkRange() å‡½æ•°é’ˆå¯¹ä¸åŒç±»å‹çš„ range è¯­å¥ï¼ˆæ•°ç»„ã€åˆ‡ç‰‡ã€æ˜ å°„ã€é€šé“å’Œå­—ç¬¦ä¸²ï¼‰è¿›è¡Œå¤„ç†ï¼Œå°†å…¶è½¬æ¢ä¸ºæ›´åŸºæœ¬çš„å¾ªç¯ç»“æ„ï¼Œå¹¶åº”ç”¨å¿…è¦çš„å˜æ¢ã€‚ func walkRange(nrange *ir.RangeStmt) ir.Node // ... çœç•¥ä»£ç  ... // éå† range è¯­å¥çš„ä¸åŒæƒ…å†µ switch t.Kind() default: base.Fatalf(walkRange) // å¤„ç†æ•°ç»„ã€åˆ‡ç‰‡ã€æŒ‡é’ˆï¼ˆæŒ‡å‘æ•°ç»„ï¼‰çš„æƒ…å†µ case types.TARRAY, types.TSLICE, types.TPTR: // ... çœç•¥ä»£ç  ... // å¤„ç†æ˜ å°„çš„æƒ…å†µ case types.TMAP: // ... çœç•¥ä»£ç  ... // å¤„ç†é€šé“çš„æƒ…å†µ case types.TCHAN: // ... çœç•¥ä»£ç  ... // å¤„ç†å­—ç¬¦ä¸²çš„æƒ…å†µ case types.TSTRING: // ... çœç•¥ä»£ç  ... // ... çœç•¥ä»£ç  ... // æ„å»ºå¹¶è¿”å›æ–°çš„ for è¯­å¥ nfor.PtrInit().Append(init...) typecheck.Stmts(nfor.Cond.Init()) nfor.Cond = typecheck.Expr(nfor.Cond) nfor.Cond = typecheck.DefaultLit(nfor.Cond, nil) nfor.Post = typecheck.Stmt(nfor.Post) typecheck.Stmts(body) nfor.Body.Append(body...) nfor.Body.Append(nrange.Body...) var n ir.Node = nfor n = walkStmt(n) base.Pos = lno return n è¿™éƒ¨åˆ†ä»£ç åœ¨ walkï¼Œå¯¹å…¶ä»–ä¼˜åŒ–æ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥é˜…è¯»è¿™éƒ¨åˆ†çš„ä»£ç ã€‚ SSA ç”Ÿæˆ éå†å‡½æ•°ï¼ˆWalkï¼‰é˜¶æ®µåï¼Œç¼–è¯‘å™¨ä¼šå°† AST è½¬æ¢ä¸ºä¸‹ä¸€ä¸ªé‡è¦çš„ä¸­é—´è¡¨ç¤ºå½¢æ€ï¼Œç§°ä¸º SSAï¼Œå…¶å…¨ç§°ä¸º Static Single Assignmentï¼Œé™æ€å•èµ‹å€¼ã€‚SSA è¢«å¤§å¤šæ•°ç°ä»£çš„ç¼–è¯‘å™¨ï¼ˆåŒ…æ‹¬ GCC å’Œ LLVMï¼‰ä½¿ç”¨ï¼Œç”¨äºç¼–è¯‘è¿‡ç¨‹ä¸­çš„ä¼˜åŒ–å’Œä»£ç ç”Ÿæˆã€‚å…¶æ ¸å¿ƒç‰¹ç‚¹å’Œç”¨é€”å¦‚ä¸‹ï¼š å˜é‡å”¯ä¸€èµ‹å€¼ï¼šåœ¨ SSA å½¢å¼ä¸­ï¼Œæ¯ä¸ªå˜é‡åªè¢«èµ‹å€¼ä¸€æ¬¡ï¼Œä½¿å¾—å˜é‡çš„ä½¿ç”¨å’Œä¿®æ”¹æ›´åŠ æ¸…æ™°ã€‚ æ–¹ä¾¿çš„æ•°æ®æµåˆ†æï¼šSSA ä½¿å¾—æ•°æ®æµåˆ†ææ›´åŠ ç›´æ¥å’Œé«˜æ•ˆï¼Œå› ä¸ºæ¯ä¸ªå˜é‡çš„èµ‹å€¼ç‚¹åªæœ‰ä¸€ä¸ªã€‚ ä¼˜åŒ–ç®—æ³•çš„åŸºç¡€ï¼šè®¸å¤šç¼–è¯‘å™¨ä¼˜åŒ–æŠ€æœ¯ï¼Œå¦‚æ­»ä»£ç æ¶ˆé™¤ã€å¸¸é‡ä¼ æ’­ã€å¼ºåº¦å‰Šå‡ç­‰ï¼Œåœ¨ SSA å½¢å¼ä¸‹æ›´æ˜“å®ç°ã€‚ Phi å‡½æ•°ï¼šSSA å¼•å…¥äº† Phi å‡½æ•°æ¥å¤„ç†å˜é‡åœ¨ä¸åŒæ§åˆ¶æµè·¯å¾„ä¸Šçš„ä¸åŒèµ‹å€¼ã€‚ ä»£ç ç”Ÿæˆï¼šSSA å½¢å¼ç®€åŒ–äº†ç›®æ ‡ä»£ç ç”Ÿæˆçš„è¿‡ç¨‹ï¼Œå› ä¸ºå®ƒæä¾›äº†æ›´æ¸…æ™°çš„æ“ä½œå’Œå˜é‡ä½¿ç”¨è§†å›¾ã€‚ å®˜æ–¹å¯¹ SSA ç”Ÿæˆé˜¶æ®µè¿›è¡Œäº†è¯¦ç»†çš„æè¿°ï¼šIntroduction to the Go compiler's SSA backend Go æä¾›äº†å¼ºæœ‰åŠ›çš„å·¥å…·æŸ¥çœ‹ SSA åˆå§‹åŠå…¶åç»­ä¼˜åŒ–é˜¶æ®µç”Ÿæˆçš„ä»£ç ç‰‡æ®µï¼Œå¯ä»¥é€šè¿‡ç¼–è¯‘æ—¶æŒ‡å®š GOSSAFUNC=pkg.func å®ç°ã€‚ ä»¥ä¸‹é¢ä»£ç ä¸ºä¾‹ï¼š package mainvar d uint8func main() var a uint8 = 1\ta = 2\tif true a = 3 d = a æˆ‘ä»¬å¯ä»¥è‡ªè¡Œç®€å•åˆ†æä¸€ä¸‹ï¼Œè¿™æ®µä»£ç å‰é¢ a çš„æ‰€æœ‰æ“ä½œå…¶å®éƒ½æ˜¯æ— æ„ä¹‰çš„ï¼Œæ•´æ®µä»£ç å…¶å®å°±åœ¨è¯´ d = 3 è¿™ä»¶äº‹ã€‚ åœ¨ linux æˆ–è€… mac ä¸Šæ‰§è¡Œï¼š GOSSAFUNC=main.main go build main.go åœ¨ Windows ä¸Šæ‰§è¡Œï¼š $env:GOSSAFUNC=maingo build .\\main.go å¯ä»¥çœ‹åˆ°è¾“å‡ºï¼š dumped SSA to .\\ssa.html é€šè¿‡æµè§ˆå™¨æ‰“å¼€ç”Ÿæˆçš„ ssa.html æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° SSA çš„åˆå§‹é˜¶æ®µã€ä¼˜åŒ–é˜¶æ®µå’Œæœ€ç»ˆé˜¶æ®µçš„ä»£ç ç‰‡æ®µã€‚ ssa.html æ–‡ä»¶ç¤ºä¾‹ æˆ‘ä»¬ç›´æ¥çœ‹æœ€ç»ˆçš„ç»“æœï¼Œæ¥çœ‹çœ‹æˆ‘ä»¬å‰é¢çš„åˆ†ææ­£ç¡®ä¸å¦ï¼š ssa æœ€ç»ˆç»“æœ å¯ä»¥çœ‹åˆ°è¿™ä¸€è¡Œï¼š00003 (**+11**) MOVB $3, main.d(SB)ï¼Œé‚£å…¶å®å°±æ˜¯ç›´æ¥ d = 3ã€‚ æœºå™¨ç ç”Ÿæˆ åœ¨ SSA é˜¶æ®µï¼Œç¼–è¯‘å™¨å…ˆæ‰§è¡Œä¸ç‰¹å®šæŒ‡ä»¤é›†æ— å…³çš„ä¼˜åŒ–ï¼Œå†æ‰§è¡Œä¸ç‰¹å®šæŒ‡ä»¤é›†æœ‰å…³çš„ä¼˜åŒ–ï¼Œå¹¶æœ€ç»ˆç”Ÿæˆä¸ç‰¹å®šæŒ‡ä»¤é›†æœ‰å…³çš„æŒ‡ä»¤å’Œå¯„å­˜å™¨åˆ†é…æ–¹å¼ã€‚å¦‚ ssa/_gen/genericOps.go ä¸­åŒ…å«äº†ä¸ç‰¹å®šæŒ‡ä»¤é›†æ— å…³çš„ Op æ“ä½œï¼Œåœ¨ ssa/_gen/AMD64Ops.go ä¸­åŒ…å«äº†å’Œ AMD64 æŒ‡ä»¤é›†ç›¸å…³çš„ Op æ“ä½œã€‚ æœºå™¨ç ç”Ÿæˆé˜¶æ®µæ˜¯ç¼–è¯‘å™¨çš„æœºå™¨ä¾èµ–é˜¶æ®µï¼Œä¸»è¦è¿‡ç¨‹å¦‚ä¸‹ï¼š Lowering è¿‡ç¨‹ï¼šè¿™ä¸ªè¿‡ç¨‹å°†é€šç”¨çš„ SSA å½¢å¼è½¬æ¢ä¸ºç‰¹å®šäºç›®æ ‡æœºå™¨çš„å˜ä½“ã€‚è¿™åŒ…æ‹¬å°†é€šç”¨æ“ä½œç¬¦æ›¿æ¢ä¸ºé’ˆå¯¹ç‰¹å®šç¡¬ä»¶ä¼˜åŒ–çš„æ“ä½œã€‚ ä»£ç ä¼˜åŒ–ï¼šåœ¨æœºå™¨ç‰¹å®šçš„å½¢å¼ä¸Šæ‰§è¡Œæœ€ç»ˆä¼˜åŒ–ï¼Œè¿›ä¸€æ­¥æé«˜ä»£ç æ•ˆç‡ã€‚ ç”Ÿæˆæœºå™¨æŒ‡ä»¤ï¼šå°† Go å‡½æ•°è½¬æ¢ä¸º obj.Prog æŒ‡ä»¤åºåˆ—ã€‚ æ±‡ç¼–å’Œè¾“å‡ºï¼šè¿™äº›æŒ‡ä»¤ç”± cmd/internal/obj æ¨¡å—çš„æ±‡ç¼–å™¨å¤„ç†ï¼Œè½¬æ¢ä¸ºæœºå™¨ä»£ç ï¼Œå¹¶è¾“å‡ºæœ€ç»ˆçš„ç›®æ ‡æ–‡ä»¶ã€‚ Go ä¸ºæˆ‘ä»¬äº†è§£ Go è¯­è¨€ç¨‹åºçš„ç¼–è¯‘å’Œé“¾æ¥è¿‡ç¨‹æä¾›äº†ä¸€ä¸ªéå¸¸å¥½ç”¨çš„å‘½ä»¤ï¼š go build -n å…¶ä¸­ -n è¡¨ç¤ºåªè¾“å‡ºç¼–è¯‘è¿‡ç¨‹ä¸­å°†è¦æ‰§è¡Œçš„ shell å‘½ä»¤ï¼Œä½†ä¸æ‰§è¡Œã€‚ ä»¥ä¸‹é¢ç¨‹åºä¸ºä¾‹ï¼š package mainimport (\tfmt\tgithub.com/spf13/cast)func main() i := cast.ToInt(1)\tfmt.Println(i) è¿™ä¸ªç¨‹åºå¼•å…¥äº†æ ‡å‡†åº“ fmt ä»¥åŠç¬¬ä¸‰æ–¹åº“ github.com/spf13/castã€‚ åœ¨å·¥ç¨‹ç›®å½•ä¸‹æ‰§è¡Œï¼š go build -n -o main å¯ä»¥çœ‹åˆ°è¾“å‡ºï¼š mkdir -p $WORK/b001/cat $WORK/b001/importcfg.link EOF # internalpackagefile go-compilation=/Users/wangjiahan/Library/Caches/go-build/48/48745ff5ef7f8945297b5894ec377f47e246d94739e0b8f00e86b6d58879e71d-dpackagefile fmt=/Users/wangjiahan/Library/Caches/go-build/10/10ab74ff0df27a2f4bdbe7651290f13ad466f3df63e11241e07ccd21c169b206-dpackagefile github.com/spf13/cast=/Users/wangjiahan/Library/Caches/go-build/77/77eed0b7028cfc4c90d78d6670325d982325399573dff9d7f82ffbf76e4559e8-d...packagefile net/url=/Users/wangjiahan/Library/Caches/go-build/72/72d0ef9b8f99a52bf1de760bb2f630998d6bb66a3d2a3fa66bd66f4efddfbc71-dmodinfo 0w\\xaf\\f\\x92t\\b\\x02A\\xe1\\xc1\\a\\xe6\\xd6\\x18\\xe6path\\tgo-compilation mod\\tgo-compilation\\t(devel)\\t dep\\tgithub.com/spf13/cast\\tv1.6.0\\th1:GEiTHELF+vaR5dhz3VqZfFSzZjYbgeKDpBxQVS4GYJ0= build\\t-buildmode=exe build\\t-compiler=gc build\\tCGO_ENABLED=1 build\\tCGO_CFLAGS= build\\tCGO_CPPFLAGS= build\\tCGO_CXXFLAGS= build\\tCGO_LDFLAGS= build\\tGOARCH=arm64 build\\tGOOS=darwin \\xf92C1\\x86\\x18 r\\x00\\x82B\\x10A\\x16\\xd8\\xf2EOFmkdir -p $WORK/b001/exe/cd ./opt/homebrew/opt/go/libexec/pkg/tool/darwin_arm64/link -o $WORK/b001/exe/a.out -importcfg $WORK/b001/importcfg.link -buildmode=pie -buildid=FDJiS-4glijTlqBbjVbe/UWsngURatTblImv3DE6-/OjO-hZGekrr-XpHFs_zA/FDJiS-4glijTlqBbjVbe -extld=cc /Users/wangjiahan/Library/Caches/go-build/48/48745ff5ef7f8945297b5894ec377f47e246d94739e0b8f00e86b6d58879e71d-d/opt/homebrew/opt/go/libexec/pkg/tool/darwin_arm64/buildid -w $WORK/b001/exe/a.out # internalmv $WORK/b001/exe/a.out main è¿™é‡Œå»ºè®®ä½ å…ˆå°è¯•è‡ªè¡Œåˆ†æä¸€ä¸‹è¿™ä¸ªç¼–è¯‘è¿‡ç¨‹ï¼Œå†ç»§ç»­å¾€ä¸‹é˜…è¯»ã€‚ ç»è¿‡åˆ†æï¼Œä¸Šè¿°è¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ 8 ä¸ªæ­¥éª¤ï¼š åˆ›å»ºå·¥ä½œç›®å½•ï¼šmkdir -p $WORK/b001/ åˆ›å»ºä¸€ä¸ªä¸´æ—¶å·¥ä½œç›®å½•ï¼Œç”¨äºå­˜æ”¾ç¼–è¯‘è¿‡ç¨‹ä¸­çš„ä¸´æ—¶æ–‡ä»¶ã€‚ ç”Ÿæˆå¯¼å…¥é…ç½®æ–‡ä»¶ï¼šcat $WORK/b001/importcfg.link 'EOF' å‘½ä»¤å¼€å§‹åˆ›å»ºä¸€ä¸ªåä¸º importcfg.link çš„æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶åŒ…å«äº†ç¼–è¯‘è¿‡ç¨‹ä¸­éœ€è¦çš„åŒ…æ–‡ä»¶è·¯å¾„ã€‚ å†™å…¥åŒ…æ–‡ä»¶è·¯å¾„ï¼šæ¥ä¸‹æ¥çš„å¤šè¡Œå†…å®¹æ˜¯å¯¹ importcfg.link æ–‡ä»¶çš„å¡«å……ï¼ŒæŒ‡å®šäº†å„ä¸ªä¾èµ–åŒ…çš„å­˜å‚¨ä½ç½®ã€‚ ç»“æŸæ–‡ä»¶å†™å…¥ï¼šEOF æ ‡å¿—ç€ importcfg.link æ–‡ä»¶å†…å®¹çš„ç»“æŸã€‚ åˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶ç›®å½•ï¼šmkdir -p $WORK/b001/exe/ åˆ›å»ºä¸€ä¸ªç›®å½•ï¼Œç”¨äºå­˜æ”¾æœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚ ç¼–è¯‘é“¾æ¥ï¼š/opt/homebrew/opt/go/libexec/pkg/tool/darwin_arm64/link -o $WORK/b001/exe/a.out ... è¿™ä¸€æ­¥æ˜¯ç¼–è¯‘é“¾æ¥çš„æ ¸å¿ƒï¼Œå®ƒä½¿ç”¨Goçš„é“¾æ¥å·¥å…·ï¼Œæ ¹æ®ä¹‹å‰ç”Ÿæˆçš„ importcfg.link æ–‡ä»¶ï¼Œå°†ä»£ç ç¼–è¯‘æˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚ æ›´æ–°æ„å»ºIDï¼š/opt/homebrew/opt/go/libexec/pkg/tool/darwin_arm64/buildid -w $WORK/b001/exe/a.out è¿™ä¸€æ­¥æ›´æ–°äº†å¯æ‰§è¡Œæ–‡ä»¶çš„æ„å»ºIDã€‚ ç§»åŠ¨å¯æ‰§è¡Œæ–‡ä»¶ï¼šmv $WORK/b001/exe/a.out main å°†ç¼–è¯‘å¥½çš„å¯æ‰§è¡Œæ–‡ä»¶ç§»åŠ¨åˆ°å½“å‰ç›®å½•ï¼Œå¹¶é‡å‘½åä¸º mainã€‚ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š Goè¯­è¨€ç¼–è¯‘å’Œé“¾æ¥è¿‡ç¨‹ å‚è€ƒèµ„æ–™ Go1.21 å®˜æ–¹æ–‡æ¡£ ã€ŠGo è¯­è¨€åº•å±‚åŸç†å‰–æã€‹ ã€ŠGo è¯­è¨€è®¾è®¡ä¸å®ç°ã€‹ Go: Overview of the Compiler ç»´åŸºç™¾ç§‘ - AST ç»´åŸºç™¾ç§‘ - SSA Go æœºåˆ¶ï¼šé€ƒé€¸åˆ†æå­¦ä¹ ç¬”è®° ChatGPT-4 ä»¥ä¸Šä¾¿æ˜¯ Go è¯­è¨€åœ¨ 1.21.0 è¿™ä¸ªç‰ˆæœ¬ä¸‹ç¼–è¯‘è¿‡ç¨‹çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œç¬”è€…ä¼šåœ¨é˜…è¯»å®Œã€Šç”¨ Go è¯­è¨€è‡ªåˆ¶è§£é‡Šå™¨ã€‹å’Œã€Šç”¨ Go è¯­è¨€è‡ªåˆ¶ç¼–è¯‘å™¨ã€‹è¿™ä¸¤æœ¬ä¹¦åï¼Œè‹¥æœ‰å¯¹ç¼–è¯‘åŸç†æœ‰æ›´æ·±å…¥çš„ä½“ä¼šå’Œæ„Ÿæ‚Ÿï¼Œå†å›è¿‡æ¥å¯¹æœ¬æ–‡çš„å†…å®¹è¿›è¡Œå‹˜è¯¯å’Œè¿›ä¸€æ­¥æç‚¼ã€‚","tags":["Go","ç¼–è¯‘åŸç†"],"categories":["Go"]},{"title":"Kafka é¡ºåºæ¶ˆæ¯å®ç°","path":"/2023/11/23/kafka-ordered-msg/","content":"ç‰ˆæœ¬è¯´æ˜ æœ¬æ–‡æ‰€æœ‰çš„è®¨è®ºå‡åœ¨å¦‚ä¸‹ç‰ˆæœ¬è¿›è¡Œï¼Œå…¶ä»–ç‰ˆæœ¬å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒã€‚ Kafka: 3.6.0 Pulsar: 2.9.0 RabbitMQ 3.7.8 RocketMQ 5.0 Go1.21 github.com/segmentio/kafka-go v0.4.45 ç»“è®ºå…ˆè¡Œ Kafka åªèƒ½ä¿è¯å•ä¸€åˆ†åŒºå†…çš„é¡ºåºæ¶ˆæ¯ï¼Œæ— æ³•ä¿è¯å¤šåˆ†åŒºé—´çš„é¡ºåºæ¶ˆæ¯ã€‚å…·ä½“æ¥è¯´ï¼Œè¦åœ¨ Kafka å®Œå…¨å®ç°é¡ºåºæ¶ˆæ¯ï¼Œè‡³å°‘éœ€è¦ä¿è¯ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶ï¼š åŒä¸€ç”Ÿäº§è€…ç”Ÿäº§æ¶ˆæ¯ï¼› åŒæ­¥å‘é€æ¶ˆæ¯åˆ° Kafka brokerï¼› æ‰€æœ‰æ¶ˆæ¯å‘å¸ƒåˆ°åŒä¸€ä¸ªåˆ†åŒºï¼› åŒä¸€æ¶ˆè´¹è€…åŒæ­¥æŒ‰ç…§é¡ºåºæ¶ˆè´¹æ¶ˆæ¯ã€‚ è€Œè¦æ»¡è¶³ç¬¬ 3 ç‚¹ï¼Œå¸¸ç”¨çš„æœ‰ 2 ç§æ€è·¯ï¼š å›ºå®šæ¶ˆæ¯çš„ keyï¼Œç”Ÿäº§ç«¯é‡‡ç”¨ key hash çš„æ–¹å¼å†™å…¥ brokerï¼› è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥ï¼Œè¦ä¿è¯é¡ºåºçš„æ¶ˆæ¯éƒ½å†™å…¥åˆ°æŒ‡å®šçš„åˆ†åŒºã€‚ æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„é¡ºåºæ¶ˆæ¯å¦‚ä½•å®ç° é¡ºåºæ¶ˆæ¯å®šä¹‰ ç”Ÿäº§ç«¯å‘é€å‡ºæ¥çš„æ¶ˆæ¯çš„é¡ºåºå’Œæ¶ˆè´¹ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯çš„é¡ºåºæ˜¯ä¸€æ ·çš„ã€‚ æ¶ˆæ¯å­˜å‚¨ç»“æ„ ä¸€èˆ¬æ¥è¯´ï¼Œæ¶ˆæ¯é˜Ÿåˆ—éƒ½æ˜¯åŸºäºé¡ºåºå­˜å‚¨ç»“æ„æ¥å­˜å‚¨æ•°æ®çš„ï¼Œä¸éœ€è¦ B æ ‘ã€B+ æ ‘ç­‰å¤æ‚æ•°æ®ç»“æ„ï¼Œåˆ©ç”¨æ–‡ä»¶çš„é¡ºåºè¯»å†™ï¼Œæ€§èƒ½ä¹Ÿå¾ˆé«˜ã€‚æ‰€ä»¥ç†æƒ³æƒ…å†µä¸‹ï¼Œç”Ÿäº§è€…æŒ‰é¡ºåºå‘é€æ¶ˆæ¯ï¼Œbroker ä¼šæŒ‰é¡ºåºå­˜å‚¨æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…å†æŒ‰é¡ºåºæ¶ˆè´¹æ¶ˆæ¯ï¼Œé‚£ä¹ˆå¤©ç„¶å°±å®ç°äº†æˆ‘ä»¬è¦çš„é¡ºåºæ¶ˆæ¯äº†ï¼Œå¦‚ä¸‹ï¼š æ¶ˆæ¯é˜Ÿåˆ—é¡ºåºå­˜å‚¨ç»“æ„ åŸºæœ¬æ¡ä»¶ ä½†æ˜¯ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¸ºäº†æ”¯æŒæ›´é«˜çš„å¹¶å‘å’Œååï¼Œå¤§å¤šæ•°éƒ½æœ‰åˆ†åŒºï¼ˆpartitionï¼‰å’Œæ¶ˆè´¹è€…ç»„ï¼ˆconsumer groupï¼‰æœºåˆ¶ï¼Œè€Œä¸ºäº†é«˜å¯ç”¨ï¼Œä¸€èˆ¬ä¹Ÿä¼šæœ‰å‰¯æœ¬ï¼ˆreplicaï¼‰æœºåˆ¶ï¼Œæ‰€ä»¥æƒ…å†µå°±å¤æ‚å¾—å¤šäº†ï¼Œå¦‚ä¸‹é¢å‡ ä¸ªä¾‹å­ï¼Œå°±ä¼šå¯¼è‡´æ¶ˆæ¯å¤±åºï¼š å¤šä¸ªç”Ÿäº§è€…åŒæ—¶å‘é€æ¶ˆæ¯ï¼Œé‚£ä¹ˆåˆ°è¾¾ broker çš„æ—¶é—´ä¹Ÿæ˜¯ä¸ç¡®å®šçš„ï¼Œæ‰€ä»¥ broker å°±æ— æ³•ä¿è¯è½ç›˜çš„é¡ºåºæ€§äº†ï¼› å•ä¸ªç”Ÿäº§è€…ï¼Œä½†æ˜¯é‡‡ç”¨å¼‚æ­¥å‘é€ï¼Œå› ä¸ºå¼‚æ­¥çº¿ç¨‹æ˜¯å¹¶å‘æ‰§è¡Œçš„ï¼Œç”± CPU è¿›è¡Œè°ƒåº¦ï¼Œä¸”æœ‰å¯èƒ½ä¼šå› ä¸ºå‘é€å¤±è´¥è€Œé‡è¯•ï¼Œæ‰€ä»¥ä¹Ÿæ— æ³•ä¿è¯æ¶ˆæ¯å¯ä»¥æŒ‰ç…§é¡ºåºåˆ°è¾¾ brokerï¼ŒåŒç†ï¼Œæ¶ˆè´¹è€…å¼‚æ­¥å¤„ç†æ¶ˆæ¯ï¼Œä¹Ÿæ— æ³•ä¿è¯é¡ºåºæ€§ï¼› ä¸€ä¸ª topic æœ‰å¤šä¸ªåˆ†åŒºï¼Œé‚£ä¹ˆå³ä½¿æ˜¯åŒä¸€ä¸ªç”Ÿäº§è€…ï¼Œç”±äºåˆ†åŒºç­–ç•¥ï¼Œæ¶ˆæ¯å¯èƒ½ä¼šè¢«åˆ†å‘åˆ°å¤šä¸ªåˆ†åŒºä¸­ï¼Œæ¶ˆè´¹è€…ä¹Ÿå°±æ— æ³•ä¿è¯é¡ºåºæ€§äº†ã€‚ æ‰€ä»¥åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“å‡ºå®ç°é¡ºåºæ¶ˆæ¯ï¼Œè‡³å°‘éœ€è¦æ»¡è¶³ä»¥ä¸‹ 3 ç‚¹ï¼š å•ä¸€ç”Ÿäº§è€…åŒæ­¥å‘é€ï¼› å•ä¸€åˆ†åŒºï¼› å•ä¸€æ¶ˆè´¹è€…åŒæ­¥æ¶ˆè´¹ï¼› ç¬¬ 1ã€3 ç‚¹æ¯”è¾ƒç®€å•ï¼ŒKafka é€šè¿‡åˆ†åŒºå’Œ offset çš„æ–¹å¼ä¿è¯äº†æ¶ˆæ¯çš„é¡ºåºã€‚æ¯ä¸ªåˆ†åŒºéƒ½æ˜¯ä¸€ä¸ªæœ‰åºçš„ã€ä¸å¯å˜çš„æ¶ˆæ¯åºåˆ—ï¼Œæ¯ä¸ªæ¶ˆæ¯åœ¨åˆ†åŒºä¸­éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„åºæ•°æ ‡è¯†ï¼Œç§°ä¸º offsetã€‚ç”Ÿäº§è€…åœ¨å‘é€æ¶ˆæ¯åˆ°åˆ†åŒºæ—¶ï¼ŒKafka ä¼šè‡ªåŠ¨ä¸ºæ¶ˆæ¯åˆ†é…ä¸€ä¸ª offsetã€‚æ¶ˆè´¹è€…åœ¨è¯»å–æ¶ˆæ¯æ—¶ï¼Œä¼šæŒ‰ç…§ offset çš„é¡ºåºæ¥è¯»å–ï¼Œä»è€Œä¿è¯äº†æ¶ˆæ¯çš„é¡ºåºã€‚ ä¸‹é¢æˆ‘ä»¬ä¸»è¦æ¥è°ˆä¸€è°ˆç¬¬ 2 ç‚¹ã€‚ Kafka é¡ºåºæ¶ˆæ¯çš„å®ç° å†™å…¥æ¶ˆæ¯çš„è¿‡ç¨‹ é…ç½®ç”Ÿäº§è€…ï¼šé¦–å…ˆï¼Œä½ éœ€è¦é…ç½® Kafka ç”Ÿäº§è€…ã€‚è¿™åŒ…æ‹¬æŒ‡å®š Kafka é›†ç¾¤çš„åœ°å€å’Œç«¯å£ï¼Œä»¥åŠå…¶ä»–ç›¸å…³é…ç½®é¡¹ï¼Œå¦‚æ¶ˆæ¯åºåˆ—åŒ–å™¨ã€åˆ†åŒºç­–ç•¥ç­‰ã€‚ åˆ›å»ºç”Ÿäº§è€…å®ä¾‹ï¼šåœ¨åº”ç”¨ç¨‹åºä¸­ï¼Œä½ éœ€è¦åˆ›å»ºä¸€ä¸ª Kafka ç”Ÿäº§è€…çš„å®ä¾‹ã€‚è¿™ä¸ªå®ä¾‹å°†ç”¨äºä¸ Kafka é›†ç¾¤è¿›è¡Œé€šä¿¡ã€‚ åºåˆ—åŒ–æ¶ˆæ¯ï¼šåœ¨å°†æ¶ˆæ¯å‘é€åˆ° Kafka é›†ç¾¤ä¹‹å‰ï¼Œä½ éœ€è¦å°†æ¶ˆæ¯è¿›è¡Œåºåˆ—åŒ–ã€‚Kafka ä½¿ç”¨å­—èŠ‚æ•°ç»„æ¥è¡¨ç¤ºæ¶ˆæ¯çš„å†…å®¹ï¼Œå› æ­¤ä½ éœ€è¦å°†æ¶ˆæ¯å¯¹è±¡åºåˆ—åŒ–ä¸ºå­—èŠ‚æ•°ç»„ã€‚è¿™é€šå¸¸æ¶‰åŠå°†æ¶ˆæ¯å¯¹è±¡è½¬æ¢ä¸º JSONã€Avroã€Protobuf ç­‰æ ¼å¼ã€‚ é€‰æ‹©åˆ†åŒºï¼šKafka çš„ä¸»é¢˜ï¼ˆtopicï¼‰è¢«åˆ†ä¸ºå¤šä¸ªåˆ†åŒºï¼ˆpartitionï¼‰ï¼Œæ¯ä¸ªåˆ†åŒºéƒ½æ˜¯æœ‰åºä¸”æŒä¹…åŒ–çš„æ¶ˆæ¯æ—¥å¿—ã€‚å½“ä½ å‘é€æ¶ˆæ¯æ—¶ï¼Œä½ å¯ä»¥é€‰æ‹©å°†æ¶ˆæ¯å‘é€åˆ°ç‰¹å®šçš„åˆ†åŒºï¼Œæˆ–è€…è®© Kafka æ ¹æ®åˆ†åŒºç­–ç•¥è‡ªåŠ¨é€‰æ‹©åˆ†åŒºã€‚ å‘é€æ¶ˆæ¯ï¼šä¸€æ—¦æ¶ˆæ¯è¢«åºåˆ—åŒ–å¹¶é€‰æ‹©äº†ç›®æ ‡åˆ†åŒºï¼Œä½ å¯ä»¥ä½¿ç”¨ Kafka ç”Ÿäº§è€…çš„ send() æ–¹æ³•å°†æ¶ˆæ¯å‘é€åˆ° Kafka é›†ç¾¤ã€‚å‘é€æ¶ˆæ¯æ—¶ï¼Œç”Ÿäº§è€…ä¼šå°†æ¶ˆæ¯å‘é€åˆ°å¯¹åº”åˆ†åŒºçš„ leader å‰¯æœ¬ã€‚ å¼‚æ­¥å‘é€ï¼šKafka ç”Ÿäº§è€…é€šå¸¸ä½¿ç”¨å¼‚æ­¥æ–¹å¼å‘é€æ¶ˆæ¯ï¼Œè¿™æ ·å¯ä»¥æé«˜ååé‡ã€‚ç”Ÿäº§è€…å°†æ¶ˆæ¯æ·»åŠ åˆ°ä¸€ä¸ªå‘é€ç¼“å†²åŒºï¼ˆsend bufferï¼‰ä¸­ï¼Œå¹¶åœ¨åå°çº¿ç¨‹ä¸­æ‰¹é‡å‘é€æ¶ˆæ¯åˆ° Kafka é›†ç¾¤ã€‚ æ¶ˆæ¯æŒä¹…åŒ–ï¼šä¸€æ—¦æ¶ˆæ¯è¢«å‘é€åˆ° Kafka é›†ç¾¤çš„ leader å‰¯æœ¬ï¼Œå®ƒå°†è¢«æŒä¹…åŒ–å¹¶å¤åˆ¶åˆ°å…¶ä»–å‰¯æœ¬ï¼Œä»¥ç¡®ä¿æ•°æ®çš„é«˜å¯é æ€§å’Œå†—ä½™æ€§ã€‚åªæœ‰å½“æ¶ˆæ¯è¢«æˆåŠŸå†™å…¥åˆ°æŒ‡å®šæ•°é‡çš„å‰¯æœ¬åï¼Œç”Ÿäº§è€…æ‰ä¼šæ”¶åˆ°ç¡®è®¤ï¼ˆacknowledgementï¼‰ã€‚ é”™è¯¯å¤„ç†å’Œé‡è¯•ï¼šå¦‚æœå‘é€æ¶ˆæ¯æ—¶å‘ç”Ÿé”™è¯¯ï¼Œç”Ÿäº§è€…å¯ä»¥æ ¹æ®é…ç½®è¿›è¡Œé”™è¯¯å¤„ç†å’Œé‡è¯•ã€‚ä½ å¯ä»¥è®¾ç½®é‡è¯•æ¬¡æ•°ã€é‡è¯•é—´éš”ç­‰å‚æ•°æ¥æ§åˆ¶é‡è¯•è¡Œä¸ºã€‚ Kafka ç”Ÿäº§è€…ç»„ä»¶ -ã€ŠKafkaæƒå¨æŒ‡å—ç¬¬2ç‰ˆã€‹ å®ç°å•ä¸€åˆ†åŒº å† Kafka ä¸­ï¼Œæˆ‘ä»¬è¦å®ç°å°†æ¶ˆæ¯å†™å…¥åˆ°åŒä¸€ä¸ªåˆ†åŒºï¼Œæœ‰ 3 ç§æ€è·¯ï¼š é…ç½® num.partitions=1 æˆ–è€…åˆ›å»º topic çš„æ—¶å€™æŒ‡å®šåªæœ‰ 1 ä¸ªåˆ†åŒºï¼Œä½†è¿™ä¼šæ˜¾è‘—é™ä½ Kafka çš„ååé‡ã€‚ å›ºå®šæ¶ˆæ¯çš„ keyï¼Œç„¶åé‡‡ç”¨ key hash çš„åˆ†åŒºç­–ç•¥ï¼Œè¿™æ ·å°±å¯ä»¥è®©æ‰€æœ‰æ¶ˆæ¯éƒ½è¢«åˆ†åˆ°åŒä¸€ä¸ªåˆ†åŒºä¸­ã€‚ å®ç°å¹¶æŒ‡å®šè‡ªå®šä¹‰åˆ†åŒºç­–ç•¥ï¼Œå¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼Œå°†éœ€è¦é¡ºåºæ¶ˆè´¹çš„æ¶ˆæ¯éƒ½åˆ†åˆ°å›ºå®šä¸€ä¸ªåˆ†åŒºä¸­ã€‚ // å¦‚ä¸‹ä¾‹å­ï¼Œæ‰€æœ‰ä½¿ç”¨same-keyä½œä¸ºkeyçš„æ¶ˆæ¯éƒ½ä¼šè¢«å‘é€åˆ°åŒä¸€ä¸ªPartitionProducerRecordString, String record = new ProducerRecordString, String(topic, same-key, message);producer.send(record); é‡å¹³è¡¡å¸¦æ¥çš„é—®é¢˜ å¦‚æœé‡‡ç”¨ä¸Šè¿°çš„ç¬¬ 2 ç§æ€è·¯ï¼šå›ºå®šæ¶ˆæ¯ keyï¼Œä¾é  key hash åˆ†åŒºç­–ç•¥ï¼Œå®ç°å•ä¸€åˆ†åŒºã€‚åœ¨æˆ‘ä»¬åªæœ‰ 1 ä¸ªæ¶ˆè´¹è€…çš„æƒ…å†µä¸‹æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯æ¶ˆè´¹è€…ç»„ï¼Œé‚£ä¹ˆï¼Œåœ¨å‘ç”Ÿé‡å¹³è¡¡æ“ä½œçš„æ—¶å€™ï¼Œå°±å¯èƒ½ä¼šæœ‰é—®é¢˜äº†ã€‚ Kafka çš„é‡å¹³è¡¡ï¼ˆRebalanceï¼‰æ˜¯æŒ‡ Kafka æ¶ˆè´¹è€…ç»„ï¼ˆConsumer Groupï¼‰ä¸­çš„æ¶ˆè´¹è€…å®ä¾‹å¯¹åˆ†åŒºçš„é‡æ–°åˆ†é…ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸»è¦å‘ç”Ÿåœ¨ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š æ¶ˆè´¹è€…ç»„ä¸­æ–°çš„æ¶ˆè´¹è€…åŠ å…¥ã€‚ æ¶ˆè´¹è€…ç»„ä¸­çš„æ¶ˆè´¹è€…ç¦»å¼€æˆ–è€…æŒ‚æ‰ã€‚ è®¢é˜…çš„ Topic çš„åˆ†åŒºæ•°å‘ç”Ÿå˜åŒ–ã€‚ æ¶ˆè´¹è€…è°ƒç”¨äº† #unsubscribe() æˆ–è€… #subscribe() æ–¹æ³•ã€‚ é‡å¹³è¡¡çš„è¿‡ç¨‹ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š Revokeï¼šé¦–å…ˆï¼ŒKafka ä¼šæ’¤é”€æ¶ˆè´¹è€…ç»„ä¸­æ‰€æœ‰æ¶ˆè´¹è€…å½“å‰æŒæœ‰çš„åˆ†åŒºã€‚ Assignmentï¼šç„¶åï¼ŒKafka ä¼šé‡æ–°è®¡ç®—åˆ†åŒºçš„åˆ†é…æƒ…å†µï¼Œç„¶åå°†åˆ†åŒºåˆ†é…ç»™æ¶ˆè´¹è€…ã€‚ Resumeï¼šæœ€åï¼Œæ¶ˆè´¹è€…ä¼šå¼€å§‹æ¶ˆè´¹æ–°åˆ†é…åˆ°çš„åˆ†åŒºã€‚ é‡å¹³è¡¡çš„ç›®çš„æ˜¯ä¸ºäº†ä¿è¯æ¶ˆè´¹è€…ç»„ä¸­çš„æ¶ˆè´¹è€…èƒ½å¤Ÿå…¬å¹³åœ°æ¶ˆè´¹ Topic çš„åˆ†åŒºã€‚é€šè¿‡é‡å¹³è¡¡ï¼ŒKafka å¯ä»¥åœ¨æ¶ˆè´¹è€…çš„æ•°é‡å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒåŠ¨æ€åœ°è°ƒæ•´æ¶ˆè´¹è€…å¯¹åˆ†åŒºçš„åˆ†é…ï¼Œä»è€Œå®ç°è´Ÿè½½å‡è¡¡ã€‚ ç„¶è€Œï¼Œå½“å‘ç”Ÿé‡å¹³è¡¡æ—¶ï¼Œåˆ†åŒºå¯èƒ½ä¼šè¢«é‡æ–°åˆ†é…ç»™ä¸åŒçš„æ¶ˆè´¹è€…ï¼Œè¿™å¯èƒ½ä¼šå½±å“æ¶ˆæ¯çš„æ¶ˆè´¹é¡ºåºã€‚ ä¸¾ä¸ªä¾‹å­ï¼š å‡è®¾æ¶ˆè´¹è€… A æ­£åœ¨æ¶ˆè´¹åˆ†åŒº P çš„æ¶ˆæ¯ï¼Œå®ƒå·²ç»æ¶ˆè´¹äº†æ¶ˆæ¯ 1ï¼Œæ¶ˆæ¯ 2ï¼Œæ­£åœ¨å¤„ç†æ¶ˆæ¯ 3ã€‚ æ­¤æ—¶ï¼Œå‘ç”Ÿäº†é‡å¹³è¡¡ï¼Œåˆ†åŒº P è¢«é‡æ–°åˆ†é…ç»™äº†æ¶ˆè´¹è€… Bã€‚ æ¶ˆè´¹è€… B å¼€å§‹æ¶ˆè´¹åˆ†åŒº Pï¼Œå®ƒä¼šä»ä¸Šä¸€æ¬¡æäº¤çš„åç§»é‡ï¼ˆoffsetï¼‰å¼€å§‹æ¶ˆè´¹ã€‚å‡è®¾æ¶ˆè´¹è€… A åœ¨å¤„ç†æ¶ˆæ¯ 3 æ—¶å‘ç”Ÿäº†æ•…éšœï¼Œæ²¡æœ‰æäº¤åç§»é‡ï¼Œé‚£ä¹ˆæ¶ˆè´¹è€… B ä¼šä»æ¶ˆæ¯ 3 å¼€å§‹æ¶ˆè´¹ã€‚ è¿™æ ·ï¼Œæ¶ˆæ¯ 3 å¯èƒ½ä¼šè¢«æ¶ˆè´¹ä¸¤æ¬¡ï¼Œè€Œä¸”å¦‚æœæ¶ˆè´¹è€… B å¤„ç†æ¶ˆæ¯ 3 çš„é€Ÿåº¦å¿«äºæ¶ˆè´¹è€…Aï¼Œé‚£ä¹ˆæ¶ˆæ¯ 3 å¯èƒ½ä¼šåœ¨æ¶ˆæ¯ 2 ä¹‹åè¢«å¤„ç†ï¼Œè¿™å°±æ‰“ç ´äº†æ¶ˆæ¯çš„é¡ºåºæ€§ã€‚ é‡å¹³è¡¡å¯¼è‡´æ¶ˆæ¯å¤±åº å†ä¸¾ä¸ªä¾‹å­ï¼š topic-A æœ¬æ¥åªæœ‰ 3 ä¸ªåˆ†åŒºï¼ŒæŒ‰ç…§ key hashï¼Œkey ä¸º same-key çš„æ¶ˆæ¯åº”è¯¥éƒ½å‘åˆ° ç¬¬ 2 ä¸ªåˆ†åŒºï¼› ä½†æ˜¯åæ¥ topic-A å˜æˆäº† 4 ä¸ªåˆ†åŒºï¼ŒæŒ‰ç…§ key hashï¼Œkey ä¸º same-key çš„æ¶ˆæ¯å¯èƒ½å°±è¢«å‘åˆ°ç¬¬ 3 ä¸ªåˆ†åŒºäº†ï¼› è¿™å°±æ— æ³•åšåˆ°å•ä¸€åˆ†åŒºï¼Œå¯èƒ½ä¼šå¯¼è‡´æ¶ˆæ¯å¤±åºã€‚ å½“ç„¶è¿™ä¸ªä¾‹å­ä¸æ˜¯ç”±é‡å¹³è¡¡ç›´æ¥å¼•èµ·çš„ï¼Œä½†æ˜¯è¿™ç§æƒ…å†µä¹Ÿæ˜¯æœ‰å¯èƒ½å¯¼è‡´æ¶ˆæ¯å¤±åºçš„ã€‚ ç¼“è§£é‡å¹³è¡¡çš„é—®é¢˜ é¿å…åŠ¨æ€æ”¹å˜åˆ†åŒºæ•°ï¼šåœ¨éœ€è¦ä¸¥æ ¼ä¿æŒæ¶ˆæ¯é¡ºåºçš„åœºæ™¯ä¸‹ï¼Œåº”é¿å…åŠ¨æ€åœ°æ”¹å˜åˆ†åŒºæ•°ã€‚è¿™æ„å‘³ç€åœ¨è®¾è®¡ Kafka ä¸»é¢˜æ—¶ï¼Œåº”æå‰è§„åˆ’å¥½æ‰€éœ€çš„åˆ†åŒºæ•°ï¼Œä»¥é¿å…æ—¥åéœ€è¦è¿›è¡Œæ›´æ”¹ã€‚ ä½¿ç”¨å•ä¸ªåˆ†åŒºï¼šå¯¹äºä¸¥æ ¼é¡ºåºè¦æ±‚çš„åœºæ™¯ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨å•åˆ†åŒºä¸»é¢˜ã€‚è™½ç„¶è¿™ä¼šé™åˆ¶ååé‡å’Œå¹¶å‘æ€§ï¼Œä½†å¯ä»¥ä¿è¯æ¶ˆæ¯çš„å…¨å±€é¡ºåºã€‚ ä½¿ç”¨å…¶ä»–ç­–ç•¥ä¿æŒé¡ºåºï¼šåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯ä»¥é€šè¿‡åœ¨åº”ç”¨å±‚å®ç°é€»è¾‘æ¥ä¿æŒé¡ºåºï¼Œæ¯”å¦‚åœ¨æ¶ˆæ¯ä¸­åŒ…å«é¡ºåºå·æˆ–æ—¶é—´æˆ³ï¼Œå¹¶åœ¨æ¶ˆè´¹æ—¶æ ¹æ®è¿™äº›ä¿¡æ¯é‡å»ºæ­£ç¡®çš„é¡ºåºã€‚ ä½¿ç”¨é™æ€æˆå‘˜åŠŸèƒ½ï¼šå®ƒå…è®¸æ¶ˆè´¹è€…åœ¨æ–­å¼€å’Œé‡æ–°è¿æ¥æ—¶ä¿æŒå…¶æ¶ˆè´¹è€…ç»„å†…çš„èº«ä»½ï¼Œè¿™å¯ä»¥å‡å°‘å› çŸ­æš‚çš„ç½‘ç»œé—®é¢˜æˆ–æ¶ˆè´¹è€…é‡å¯å¯¼è‡´çš„ä¸å¿…è¦çš„é‡å¹³è¡¡ã€‚ ä¸Šé¢è¿™äº›æªæ–½ï¼Œåªèƒ½å‡å°‘é‡å¹³è¡¡å¸¦æ¥çš„é—®é¢˜ï¼Œå¹¶æ— æ³•æ ¹é™¤ï¼Œå¦‚æœéè¦å®ç°ä¸¥æ ¼æ„ä¹‰ä¸Šçš„é¡ºåºæ¶ˆæ¯ï¼Œè¦ä¹ˆåœ¨æ¶ˆæ¯ä¸­åŠ å…¥æ—¶é—´æˆ³ç­‰æ ‡è®°ï¼Œåœ¨ä¸šåŠ¡å±‚ä¿è¯é¡ºåºæ¶ˆè´¹ï¼Œè¦ä¹ˆå°±åªèƒ½é‡‡ç”¨ å•ä¸€ç”Ÿäº§è€…åŒæ­¥å‘é€ + å•ä¸€åˆ†åŒº +å•ä¸€æ¶ˆè´¹è€…åŒæ­¥æ¶ˆè´¹ è¿™ç§æ¨¡å¼äº†ã€‚ é™æ€æˆå‘˜åŠŸèƒ½ Kafka 2.3.0 ç‰ˆæœ¬å¼•å…¥äº†ä¸€é¡¹æ–°åŠŸèƒ½ï¼šé™æ€æˆå‘˜ï¼ˆStatic Membershipï¼‰ã€‚è¿™ä¸ªåŠŸèƒ½ä¸»è¦æ˜¯ä¸ºäº†å‡å°‘ç”±äºæ¶ˆè´¹è€…é‡å¹³è¡¡ï¼ˆrebalanceï¼‰å¼•èµ·çš„å¼€é”€å’Œå»¶è¿Ÿã€‚åœ¨ä¼ ç»Ÿçš„ Kafka æ¶ˆè´¹è€…ç»„ä¸­ï¼Œå½“æ–°çš„æ¶ˆè´¹è€…åŠ å…¥æˆ–ç¦»å¼€æ¶ˆè´¹è€…ç»„æ—¶ï¼Œä¼šè§¦å‘é‡å¹³è¡¡ã€‚è¿™ä¸ªè¿‡ç¨‹å¯èƒ½ä¼šå¯¼è‡´æ¶ˆæ¯çš„å¤„ç†å»¶è¿Ÿï¼Œå¹¶ä¸”åœ¨é«˜ååé‡çš„åœºæ™¯ä¸‹å¯èƒ½ä¼šå¯¹æ€§èƒ½é€ æˆå½±å“ã€‚é™æ€æˆå‘˜åŠŸèƒ½æ—¨åœ¨ç¼“è§£è¿™äº›é—®é¢˜ã€‚ä»¥ä¸‹æ˜¯å®ƒçš„ä¸€äº›å…³é”®ç‚¹ï¼š é™æ€æˆå‘˜çš„å·¥ä½œåŸç†ï¼š é™æ€æˆå‘˜æ ‡è¯†ï¼šæ¶ˆè´¹è€…åœ¨åŠ å…¥æ¶ˆè´¹è€…ç»„æ—¶å¯ä»¥æä¾›ä¸€ä¸ªé™æ€æˆå‘˜æ ‡è¯†ï¼ˆStatic Member IDï¼‰ã€‚è¿™å…è®¸ Kafka Broker è¯†åˆ«ç‰¹å®šçš„æ¶ˆè´¹è€…å®ä¾‹ï¼Œè€Œä¸æ˜¯ä»…ä»…ä¾èµ–äºæ¶ˆè´¹è€…ç»„å†…çš„åŠ¨æ€åˆ†é…ã€‚ é‡å¹³è¡¡ä¼˜åŒ–ï¼šå½“ä½¿ç”¨é™æ€æˆå‘˜åŠŸèƒ½æ—¶ï¼Œå¦‚æœä¸€ä¸ªå·²çŸ¥çš„æ¶ˆè´¹è€…ç”±äºæŸç§åŸå› ï¼ˆå¦‚ç½‘ç»œé—®é¢˜ï¼‰çŸ­æš‚æ–­å¼€åé‡æ–°è¿æ¥ï¼ŒKafka ä¸ä¼šç«‹å³è§¦å‘é‡å¹³è¡¡ã€‚ç›¸åï¼ŒKafka ä¼šç­‰å¾…ä¸€ä¸ªé¢„è®¾çš„è¶…æ—¶æœŸé™ï¼ˆsession.timeout.msï¼‰ï¼Œåœ¨æ­¤æœŸé—´å¦‚æœæ¶ˆè´¹è€…é‡æ–°è¿æ¥ï¼Œå®ƒå°†ä¿ç•™åŸæ¥çš„åˆ†åŒºåˆ†é…ã€‚ å‡å°‘é‡å¹³è¡¡æ¬¡æ•°ï¼šè¿™å¤§å¤§å‡å°‘äº†ç”±äºæ¶ˆè´¹è€…å´©æºƒå’Œæ¢å¤ã€ç½‘ç»œé—®é¢˜æˆ–ç»´æŠ¤æ“ä½œå¼•èµ·çš„ä¸å¿…è¦çš„é‡å¹³è¡¡æ¬¡æ•°ã€‚ ä½¿ç”¨é™æ€æˆå‘˜çš„ä¼˜ç‚¹ï¼š æé«˜ç¨³å®šæ€§ï¼šå‡å°‘é‡å¹³è¡¡å¯ä»¥æé«˜æ¶ˆè´¹è€…ç»„çš„æ•´ä½“ç¨³å®šæ€§ï¼Œå°¤å…¶æ˜¯åœ¨å¤§å‹æ¶ˆè´¹è€…ç»„å’Œé«˜ååé‡çš„æƒ…å†µä¸‹ã€‚ å‡å°‘å»¶è¿Ÿï¼šç”±äºå‡å°‘äº†é‡å¹³è¡¡çš„æ¬¡æ•°ï¼Œå¯ä»¥å‡å°‘å› é‡å¹³è¡¡å¯¼è‡´çš„æ¶ˆæ¯å¤„ç†å»¶è¿Ÿã€‚ æŒä¹…çš„æ¶ˆè´¹è€…åˆ†åŒºåˆ†é…ï¼šè¿™ä½¿å¾—æ¶ˆè´¹è€…åœ¨åˆ†åŒºåˆ†é…ä¸Šæ›´åŠ æŒä¹…ï¼Œæœ‰åŠ©äºæ›´å¥½åœ°ç®¡ç†å’Œä¼˜åŒ–æ¶ˆæ¯çš„æ¶ˆè´¹ã€‚ å¦‚ä½•ä½¿ç”¨ï¼š è¦ä½¿ç”¨é™æ€æˆå‘˜åŠŸèƒ½ï¼Œéœ€è¦åœ¨ Kafka æ¶ˆè´¹è€…çš„é…ç½®ä¸­è®¾ç½® group.instance.idã€‚è¿™ä¸ª ID åº”è¯¥æ˜¯å”¯ä¸€çš„ï¼Œå¹¶ä¸”åœ¨æ¶ˆè´¹è€…é‡å¯æˆ–é‡æ–°è¿æ¥æ—¶ä¿æŒä¸å˜ã€‚åŒæ—¶ï¼Œè¿˜éœ€è¦é…ç½® session.timeout.msï¼Œä»¥å†³å®šåœ¨è§¦å‘é‡å¹³è¡¡ä¹‹å‰æ¶ˆè´¹è€…å¯ä»¥ç¦»çº¿å¤šé•¿æ—¶é—´ã€‚ æ³¨æ„äº‹é¡¹ï¼š è™½ç„¶é™æ€æˆå‘˜åŠŸèƒ½å¯ä»¥å‡å°‘é‡å¹³è¡¡çš„å‘ç”Ÿï¼Œä½†å®ƒä¸ä¼šå®Œå…¨æ¶ˆé™¤é‡å¹³è¡¡ã€‚åœ¨æ¶ˆè´¹è€…ç»„æˆå‘˜çš„é•¿æœŸå˜åŒ–ï¼ˆå¦‚æ–°æ¶ˆè´¹è€…çš„åŠ å…¥æˆ–æ°¸ä¹…ç¦»å¼€ï¼‰æ—¶ï¼Œä»ç„¶ä¼šå‘ç”Ÿé‡å¹³è¡¡ã€‚ éœ€è¦åˆç†è®¾ç½® session.timeout.msï¼Œä»¥é¿å…æ¶ˆè´¹è€…ç”±äºçŸ­æš‚çš„ç½‘ç»œé—®é¢˜æˆ–å…¶ä»–åŸå› çš„æ–­å¼€è€Œè¿‡æ—©è§¦å‘é‡å¹³è¡¡ã€‚ é™æ€æˆå‘˜åŠŸèƒ½åœ¨å¤„ç†å¤§è§„æ¨¡ Kafka åº”ç”¨æ—¶å°¤å…¶æœ‰ç”¨ï¼Œå®ƒæä¾›äº†ä¸€ç§æœºåˆ¶æ¥ä¼˜åŒ–æ¶ˆè´¹è€…ç»„çš„æ€§èƒ½å’Œç¨³å®šæ€§ã€‚ å¹‚ç­‰æ€§ Kafka 0.11 ç‰ˆæœ¬åæä¾›äº†å¹‚ç­‰æ€§ç”Ÿäº§è€…ï¼Œè¿™æ„å‘³ç€å³ä½¿ç”Ÿäº§è€…å› ä¸ºæŸäº›é”™è¯¯é‡è¯•å‘é€ç›¸åŒçš„æ¶ˆæ¯ï¼Œè¿™äº›æ¶ˆæ¯ä¹Ÿåªä¼šè¢«è®°å½•ä¸€æ¬¡ã€‚è¿™æ˜¯é€šè¿‡ç»™æ¯ä¸€æ‰¹å‘é€åˆ° Kafka çš„æ¶ˆæ¯åˆ†é…ä¸€ä¸ªåºåˆ—å·å®ç°çš„ï¼Œbroker ä½¿ç”¨è¿™ä¸ªåºåˆ—å·æ¥åˆ é™¤é‡å¤å‘é€çš„æ¶ˆæ¯ã€‚ä½¿ç”¨å¹‚ç­‰æ€§ç”Ÿäº§è€…ï¼Œå¯ä»¥å‡å°‘é‡å¤æ¶ˆæ¯çš„é£é™©ï¼Œè¿™æ„å‘³ç€å³ä½¿åœ¨ç½‘ç»œé‡è¯•ç­‰æƒ…å†µä¸‹ï¼Œæ¶ˆæ¯çš„é¡ºåºä¹Ÿèƒ½å¾—åˆ°æ›´å¥½çš„ä¿è¯ã€‚å› ä¸ºé‡å¤æ¶ˆæ¯ä¸ä¼šè¢«å¤šæ¬¡è®°å½•ï¼Œæ‰€ä»¥ä¸ä¼šç ´åå·²æœ‰æ¶ˆæ¯çš„é¡ºåºã€‚ å…¶ä»–å¸¸è§æ¶ˆæ¯é˜Ÿåˆ—é¡ºåºæ¶ˆæ¯çš„å®ç° Pulsar Pulsar å’Œ Kafka ä¸€æ ·ï¼Œéƒ½æ˜¯é€šè¿‡ç”Ÿäº§ç«¯æŒ‰ Key Hash çš„æ–¹æ¡ˆå°†æ•°æ®å†™å…¥åˆ°åŒä¸€ä¸ªåˆ†åŒºã€‚ RabbitMQ RabbitMQ åœ¨ç”Ÿäº§æ—¶æ²¡æœ‰ç”Ÿäº§åˆ†åŒºåˆ†é…çš„è¿‡ç¨‹ã€‚å®ƒæ˜¯é€šè¿‡ Exchange å’Œ Route Key æœºåˆ¶æ¥å®ç°é¡ºåºæ¶ˆæ¯çš„ã€‚Exchange ä¼šæ ¹æ®è®¾ç½®å¥½çš„ Route Key å°†æ•°æ®è·¯ç”±åˆ°ä¸åŒçš„ Queue ä¸­å­˜å‚¨ã€‚æ­¤æ—¶ Route Key çš„ä½œç”¨å’Œ Kafka çš„æ¶ˆæ¯çš„ Key æ˜¯ä¸€æ ·çš„ã€‚ RocketMQ RocektMQ æ”¯æŒæ¶ˆæ¯ç»„ï¼ˆMessageGroupï¼‰çš„æ¦‚å¿µã€‚åœ¨ç”Ÿäº§ç«¯æŒ‡å®šæ¶ˆæ¯ç»„ï¼Œåˆ™åŒä¸€ä¸ªæ¶ˆæ¯ç»„çš„æ¶ˆæ¯å°±ä¼šè¢«å‘é€åˆ°åŒä¸€ä¸ªåˆ†åŒºä¸­ã€‚æ­¤æ—¶è¿™ä¸ªæ¶ˆæ¯ç»„èµ·åˆ°çš„ä½œç”¨å’Œ Kakfa çš„æ¶ˆæ¯çš„ Key æ˜¯ä¸€æ ·çš„ã€‚ å®æˆ˜ Kafka å®ç°é¡ºåºæ¶ˆæ¯ ä»£ç ä»“åº“ï¼šhttps://github.com/hedon954/kafka-go-examples/tree/master/orderedmsg ä¸‹é¢æˆ‘ä»¬æ¥å†™ä¸€å†™å®æˆ˜ç”¨ä¾‹ï¼Œæ›´åŠ ç›´è§‚åœ°æ„Ÿå—ä¸€ä¸‹ Kafka é¡ºåºæ¶ˆæ¯çš„å®ç°ç»†èŠ‚ã€‚ é¦–å…ˆæˆ‘ä»¬åœ¨é›†ç¾¤ä¸Šåˆ›å»ºä¸€ä¸ª topic ordered-msg-topicï¼Œåˆ†åŒºä¸º 3 ä¸ªï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š /opt/kafka-3.6.0/bin/kafka-topics.sh --bootstrap-server localhost:9092 --create --topic ordered-msg-topic --partitions 3 --replication-factor 1 æ­å»º Kafka é›†ç¾¤å¯ä»¥çœ‹è¿™ä¸¤ç¯‡ï¼šKafkaé›†ç¾¤æ­å»º(Zookeeper)ã€Kafkaé›†ç¾¤æ­å»º(KRaft)ã€‚ å•ç”Ÿäº§è€…å•æ¶ˆè´¹è€… æ­£å¸¸æƒ…å†µä¸‹ï¼Œä½¿ç”¨å•ä¸€ç”Ÿäº§è€…åŒæ­¥å‘é€å’Œå•ä¸€æ¶ˆè´¹è€…åŒæ­¥å‘é€ï¼Œåªè¦æˆ‘ä»¬ä¿è¯ key æ˜¯å›ºå®šçš„ï¼Œåˆ™æ‰€æœ‰æ¶ˆæ¯éƒ½ä¼šå†™åˆ°åŒä¸€ä¸ªåˆ†åŒºï¼Œæ˜¯å¯ä»¥å®ç°é¡ºåºæ¶ˆæ¯çš„ã€‚ ä»£ç ç›®å½•å¦‚ä¸‹ï¼š â”œâ”€configâ”‚ config.go # å¸¸é‡å®šä¹‰â”œâ”€consumerâ”‚ consumer.go # æ¶ˆè´¹è€…â””â”€producer producer.go # ç”Ÿäº§è€… é¦–å…ˆæˆ‘ä»¬å…ˆå®šä¹‰ä¸€äº›å¸¸é‡ï¼š import github.com/segmentio/kafka-govar (\tTopic = ordered-msg-topic\tBrokers = []stringkafka1.com:9092, kafka2.com:9092, kafka3.com:9092\tAddr = kafka.TCP(Brokers...)\tGroupId = ordered-msg-group\tMessageKey = []byte(message-key)) æˆ‘ä»¬å…ˆå®ç°ç”Ÿäº§è€…ç«¯ï¼Œä¸»è¦æ˜¯ä¸æ–­å¾€ ordered-msg-topic ä¸­å†™å…¥æ•°æ®ï¼š package mainimport (\tcontext\tfmt\ttime\tkafka-go-examples/orderedmsg/config\tgithub.com/segmentio/kafka-go)func NewProducer() *kafka.Writer return kafka.Writer Addr: config.Addr, Topic: config.Topic, Balancer: kafka.Hash, // å“ˆå¸Œåˆ†åŒº\tfunc NewMessages(count int) []kafka.Message res := make([]kafka.Message, count)\tfor i := 0; i count; i++ res[i] = kafka.Message Key: config.MessageKey, Value: []byte(fmt.Sprintf(msg-%d, i+1)), return resfunc main() producer := NewProducer()\tmessages := NewMessages(100)\tif err := producer.WriteMessages(context.Background(), messages...); err != nil panic(err) _ = producer.Close() æˆ‘ä»¬å†æ¥å®ç°æ¶ˆè´¹è€…ï¼Œç›®å‰æˆ‘ä»¬å°±å¯åŠ¨ 1 ä¸ªæ¶ˆè´¹è€…ï¼š package mainimport (\tcontext\tfmt\ttime\tkafka-go-examples/orderedmsg/config\tgithub.com/segmentio/kafka-go)type Consumer struct Id string\t*kafka.Reader// NewConsumer åˆ›å»ºä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œå®ƒå±äº config.GroupId è¿™ä¸ªæ¶ˆè´¹è€…ç»„func NewConsumer(id string) *Consumer c := Consumer Id: id, Reader: kafka.NewReader(kafka.ReaderConfig Brokers: config.Brokers, GroupID: config.GroupId, Topic: config.Topic, Dialer: kafka.Dialer ClientID: id, , ), return c// Read è¯»å–æ¶ˆæ¯ï¼ŒintervalMs ç”¨æ¥æ§åˆ¶æ¶ˆè´¹è€…çš„æ¶ˆè´¹é€Ÿåº¦func (c *Consumer) Read(intervalMs int) fmt.Printf(%s start read , c.Id)\tfor msg, err := c.ReadMessage(context.Background()) if err != nil fmt.Printf(%s read msg err: %v , c.Id, err) return // æ¨¡æ‹Ÿæ¶ˆè´¹é€Ÿåº¦ time.Sleep(time.Millisecond * time.Duration(intervalMs)) fmt.Printf(%s read msg: %s, time: %s , c.Id, string(msg.Value), time.Now().Format(03-04-05))\tfunc main() c1 := NewConsumer(consumer-1)\tc1.Read(500) å¯åŠ¨ç”Ÿäº§è€…ç”Ÿäº§æ¶ˆæ¯ï¼Œç„¶åå¯åŠ¨æ¶ˆè´¹è€…ï¼Œè§‚å¯Ÿæ§åˆ¶å°ï¼Œä¸éš¾çœ‹å‡ºè¿™ç§æƒ…å†µä¸‹å°±æ˜¯é¡ºåºæ¶ˆè´¹ï¼š consumer-1 read msg: msg-10, time: 04:29:10consumer-1 read msg: msg-11, time: 04:29:11consumer-1 read msg: msg-12, time: 04:29:12consumer-1 read msg: msg-13, time: 04:29:13consumer-1 read msg: msg-14, time: 04:29:14consumer-1 read msg: msg-15, time: 04:29:15consumer-1 read msg: msg-16, time: 04:29:16 é‡å¹³è¡¡å¸¦æ¥çš„é—®é¢˜ æˆ‘ä»¬å…ˆé‡å»º topicï¼Œæ¸…æ¥šæ‰ä¹‹å‰çš„æ•°æ®ï¼š /opt/kafka-3.6.0/bin/kafka-topics.sh --bootstrap-server localhost:9092 --delete --topic ordered-msg-topic /opt/kafka-3.6.0/bin/kafka-topics.sh --bootstrap-server localhost:9092 --create --topic ordered-msg-topic --partitions 3 --replication-factor 1 ä¸‹é¢æˆ‘ä»¬æ¥é‡‡ç”¨æ¶ˆè´¹è€…ç»„çš„å½¢å¼æ¶ˆè´¹æ¶ˆæ¯ï¼Œåœ¨è¿™æœŸé—´ï¼Œæˆ‘ä»¬ä¸æ–­å¾€æ¶ˆè´¹è€…ç»„ä¸­æ–°å¢æ¶ˆè´¹è€…ï¼Œä½¿å…¶å‘ç”Ÿé‡å¹³è¡¡ï¼Œæˆ‘ä»¬æ¥è§‚å¯Ÿä¸‹æ¶ˆæ¯çš„æ¶ˆè´¹æƒ…å†µã€‚ ä¿®æ”¹æ¶ˆè´¹è€…ç«¯çš„ main()ï¼š func main() // å…ˆå¯åŠ¨ c1\tc1 := NewConsumer(consumer-1)\tgo func() c1.Read(500)\t()\t// 5 ç§’åå¯åŠ¨ c2\ttime.Sleep(5 * time.Second)\tgo func() c2 := NewConsumer(consumer-2) c2.Read(300)\t()\t// å† 10 ç§’åå¯åŠ¨ c3 å’Œ c4\ttime.Sleep(10 * time.Second)\tgo func() c3 := NewConsumer(consumer-3) c3.Read(100)\t()\tgo func() c4 := NewConsumer(consumer-4) c4.Read(100)\t()\tselect å…ˆå¯åŠ¨ç”Ÿäº§è€…é‡æ–°ç”Ÿäº§æ•°æ®ï¼Œç„¶åå†å¯åŠ¨æ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ®ï¼Œè§‚å¯Ÿæ§åˆ¶å°ï¼š consumer-1 start readconsumer-1 read msg: msg-1, time: 04:44:28consumer-1 read msg: msg-2, time: 04:44:28consumer-1 read msg: msg-3, time: 04:44:29 # consumer-1 æŒ‰é¡ºåºæ¶ˆè´¹consumer-2 start read # consumer-2 è¿›æ¥consumer-1 read msg: msg-4, time: 04:44:30consumer-1 read msg: msg-5, time: 04:44:30consumer-1 read msg: msg-6, time: 04:44:31 # è¿™é‡Œç›¸å·®äº† 6sï¼Œå°±æ˜¯åœ¨è¿›è¡Œé‡å¹³è¡¡consumer-2 read msg: msg-7, time: 04:44:37 # é‡å¹³è¡¡åå‘ç°åŸæ¥çš„åˆ†åŒºç»™ consumer-2 æ¶ˆè´¹äº†consumer-1 read msg: msg-7, time: 04:44:37 # è¿™é‡Œå‘ç”Ÿäº†é‡å¤æ¶ˆè´¹consumer-2 read msg: msg-8, time: 04:44:37consumer-2 read msg: msg-9, time: 04:44:37consumer-2 read msg: msg-10, time: 04:44:38consumer-2 read msg: msg-11, time: 04:44:38consumer-2 read msg: msg-12, time: 04:44:38consumer-2 read msg: msg-13, time: 04:44:39consumer-2 read msg: msg-14, time: 04:44:39consumer-2 read msg: msg-15, time: 04:44:39 # consumer-2 æŒ‰é¡ºåºæ¶ˆæ¯consumer-4 start read # consumer-3 å’Œ consumer-4 è¿›æ¥consumer-3 start readconsumer-2 read msg: msg-16, time: 04:44:40 consumer-4 read msg: msg-17, time: 04:44:46 # è¿™é‡Œå‘ç”Ÿé‡å¹³è¡¡consumer-4 read msg: msg-18, time: 04:44:46 # é‡å¹³è¡¡åç”± consumer-4 è´Ÿè´£è¯¥åˆ†åŒºconsumer-2 read msg: msg-17, time: 04:44:46 # è¿™é‡Œç”±äº 2 çš„é€Ÿåº¦æ¯” 4 æ…¢å¾ˆå¤šï¼Œæ‰€ä»¥å°±ä¹±åºäº†ï¼Œè¿˜é‡å¤æ¶ˆè´¹consumer-4 read msg: msg-19, time: 04:44:46consumer-4 read msg: msg-20, time: 04:44:46# ... æ€»ç»“ å½“æˆ‘ä»¬é‡‡ç”¨æ¶ˆè´¹è€…ç»„çš„æ—¶å€™ï¼Œç”±äºé‡å¹³è¡¡æœºåˆ¶çš„å­˜åœ¨ï¼Œå•çº¯ä» Kafka çš„è§’åº¦æ¥è¯´æ˜¯æ— æ³•å®Œå…¨å®ç°é¡ºåºæ¶ˆæ¯çš„ï¼Œåªèƒ½é€šè¿‡é™æ€æˆå‘˜åŠŸèƒ½ã€é¿å…åˆ†åŒºæ•°é‡å˜åŒ–å’Œå‡å°‘æ¶ˆè´¹è€…ç»„æˆå‘˜æ•°é‡å˜åŒ–ç­‰æ–¹å¼æ¥å°½å¯èƒ½å‡å°‘é‡å¹³è¡¡çš„å‘ç”Ÿï¼Œè¿›è€Œå°½å¯èƒ½ç»´æŒæ¶ˆæ¯çš„é¡ºåºæ€§ã€‚ å‚è€ƒ æå®¢æ—¶é—´ - æ·±å…¥æ‹†è§£æ¶ˆæ¯é˜Ÿåˆ— 47 è®²ï¼ˆè®¸æ–‡å¼ºï¼‰ ã€ŠKafka æƒå¨æŒ‡å—ï¼ˆç¬¬ 2 ç‰ˆï¼‰ã€‹ Pulsar å®˜æ–¹æ–‡æ¡£-åˆ†åŒºtopic-é¡ºåºä¿è¯ RocketMQ å®˜æ–¹æ–‡æ¡£-åŠŸèƒ½ç‰¹æ€§-é¡ºåºæ¶ˆæ¯ RabbitMQ å®˜æ–¹æ–‡æ¡£","tags":["Kafka","ä¸­é—´ä»¶","æ¶ˆæ¯é˜Ÿåˆ—"],"categories":["Kafka"]},{"title":"Kafka é›†ç¾¤éƒ¨ç½²ï¼ˆKRaftï¼‰","path":"/2023/11/22/kafka-kraft-deploy/","content":"ç‰ˆæœ¬è¯´æ˜ Ubuntu 18.04.6 Kafka 3.6.0 JDK8 é›†ç¾¤é…ç½® æ“ä½œç³»ç»Ÿ ip åŸŸå Kafka Broker ç«¯å£ Kafka Controller ç«¯å£ Ubuntu 18.04.6 192.168.50.131 kafka1.com 9092 9093 Ubuntu 18.04.6 192.168.50.132 kafka2.com 9092 9093 Ubuntu 18.04.6 192.168.50.133 kafka3.com 9092 9093 å®‰è£… vim, curl sudo apt updatesudo apt install vimsudo apt install curl é…ç½®é™æ€ ip å’Œ hosts ä¸ºäº†ä½¿ç”¨åŸŸåï¼Œæ›´åŠ æ–¹ä¾¿çš„è¿›è¡Œé…ç½®ï¼Œè¿™é‡Œå°†è™šæ‹Ÿæœºçš„ DHCP æ”¹æˆäº†é™æ€åˆ†é… IPï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨è®¾ç½®ä¸€ä¸‹æ¯å°æœºå™¨ IP åœ°å€ï¼Œè¿™é‡Œä»¥ 192.168.50.131 ä¸ºä¾‹ã€‚ æ‰¾åˆ°ç½‘ç»œæ¥å£åç§°ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š ip addr æŸ¥æ‰¾ä»¥ ens æˆ– eth å¼€å¤´çš„æ¥å£åç§°ã€‚ä¾‹å¦‚ï¼Œens33 æˆ– eth0ã€‚ hedon@ubuntu:~$ ip addr1: lo: LOOPBACK,UP,LOWER_UP mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever inet6 ::1/128 scope host valid_lft forever preferred_lft forever2: ens33: BROADCAST,MULTICAST,UP,LOWER_UP mtu 1500 qdisc fq_codel state UP group default qlen 1000 link/ether 00:0c:29:82:9e:69 brd ff:ff:ff:ff:ff:ff inet 192.168.50.133/24 brd 192.168.50.255 scope global dynamic noprefixroute ens33 valid_lft 1644sec preferred_lft 1644sec inet6 fe80::c367:c7cc:3ad4:23b3/64 scope link valid_lft forever preferred_lft forever å¯ä»¥æ‰¾åˆ° ens33ï¼Œå…¶ä¸­ inet 192.168.50.133/24 è¡¨ç¤º IP åœ°å€ä¸º 192.168.50.133ï¼Œå­ç½‘æ©ç ä¸º /24ï¼ˆç­‰äº 255.255.255.0ï¼‰ã€‚ è¿™ä¸ª IP åœ°å€æ˜¯ DHCP åŠ¨æ€åˆ†é…çš„ï¼Œè¯´æ˜å®¿ä¸»æœºåˆ†é…ç»™è™šæ‹Ÿæœºçš„ IP èŒƒå›´å°±åœ¨ 192.168.50.xxxï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šå°†é™æ€ IP é…ç½®åœ¨è¿™ä¸ªèŒƒå›´å†…ã€‚ è·å–ç½‘å…³åœ°å€ ip route | grep default è¾“å‡ºï¼š hedon@ubuntu:~$ ip route | grep defaultdefault via 192.168.50.2 dev ens33 proto dhcp metric 100 è¯´æ˜é»˜è®¤ç½‘å…³æ˜¯ 192.168.50.2ï¼Œ ç¼–è¾‘ /etc/network/interfaces æ–‡ä»¶ï¼Œé…ç½®é™æ€ IP åœ°å€ï¼Œå†…å®¹å¦‚ä¸‹ï¼š auto ens33iface ens33 inet static address 192.168.50.131 netmask 255.255.255.0 gateway 192.168.50.2 dns-nameservers 8.8.8.8 8.8.4.4 é‡å¯ su reboot å†æ¬¡æŸ¥çœ‹ ip åœ°å€ ip addr æœ‰ä»¥ä¸‹è¾“å‡ºä¾¿è¯´æ˜é™æ€ IP é…ç½®æˆåŠŸäº†ã€‚ 1: lo: LOOPBACK,UP,LOWER_UP mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever inet6 ::1/128 scope host valid_lft forever preferred_lft forever2: ens33: BROADCAST,MULTICAST,UP,LOWER_UP mtu 1500 qdisc fq_codel state UP group default qlen 1000 link/ether 00:0c:29:82:9e:69 brd ff:ff:ff:ff:ff:ff inet 192.168.50.131/24 brd 192.168.50.255 scope global ens33 valid_lft forever preferred_lft forever inet6 fe80::20c:29ff:fe82:9e69/64 scope link valid_lft forever preferred_lft forever é…ç½®åŸŸå sudo vim /etc/hosts è¿½åŠ å†…å®¹å¦‚ä¸‹ï¼š 192.168.50.131 kafka1.com192.168.50.132 kafka2.com192.168.50.133 kafka3.com ping ä¸€ä¸‹ hedon@ubuntu:~$ ping kafka1.comPING kafka1.com (192.168.50.131) 56(84) bytes of data.64 bytes from kafka1.com (192.168.50.131): icmp_seq=1 ttl=64 time=0.024 ms64 bytes from kafka1.com (192.168.50.131): icmp_seq=2 ttl=64 time=0.021 ms64 bytes from kafka1.com (192.168.50.131): icmp_seq=3 ttl=64 time=0.029 ms^C--- kafka1.com ping statistics ---3 packets transmitted, 3 received, 0% packet loss, time 2029msrtt min/avg/max/mdev = 0.021/0.024/0.029/0.006 ms ping ä¸€ä¸‹ç™¾åº¦ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½è®¿é—®å¤–ç½‘ hedon@ubuntu:~$ ping baidu.comping: baidu.com: Name or service not known å¦‚æœè¿™é‡Œå¯ä»¥è®¿é—®ï¼Œåˆ™ç›´æ¥è·³è¿‡è¿›å…¥ä¸‹ä¸€æ­¥ï¼Œä¸å¯ä»¥çš„è¯ï¼Œéœ€è¦é…ç½®ä¸€ä¸‹åŸŸåè§£æç³»ç»Ÿã€‚ é…ç½®åŸŸåè§£æç³»ç»Ÿ Ubuntu ç³»ç»Ÿä½¿ç”¨ systemd-resolved æœåŠ¡æ¥ç®¡ç† DNSï¼Œä½ å¯ä»¥åœ¨ /etc/systemd/resolved.conf æ–‡ä»¶ä¸­è¿›è¡Œ DNS é…ç½®ã€‚ sudo vim /etc/systemd/resolved.conf å–æ¶ˆæˆ–æ·»åŠ  DNS çš„æ³¨é‡Šï¼Œå¹¶ä¿®æ”¹ä¸ºï¼š [Resolve]DNS=8.8.8.8 8.8.4.4 é‡å¯å¯åŠ¨ systemd-resolvedï¼š sudo systemctl restart systemd-resolved å†å°è¯• ping ä¸€ä¸‹ç™¾åº¦ï¼š hedon@ubuntu:~$ ping www.baidu.comPING www.a.shifen.com (153.3.238.110) 56(84) bytes of data.64 bytes from 153.3.238.110 (153.3.238.110): icmp_seq=1 ttl=128 time=15.9 ms64 bytes from 153.3.238.110 (153.3.238.110): icmp_seq=2 ttl=128 time=15.9 ms64 bytes from 153.3.238.110 (153.3.238.110): icmp_seq=3 ttl=128 time=16.1 ms64 bytes from 153.3.238.110 (153.3.238.110): icmp_seq=4 ttl=128 time=15.3 ms^C--- www.a.shifen.com ping statistics ---4 packets transmitted, 4 received, 0% packet loss, time 14104msrtt min/avg/max/mdev = 15.368/15.850/16.145/0.291 ms è¡¥å……è¯´æ˜ï¼š/etc/network/interfaces æ–‡ä»¶çš„é…ç½® è¿™æ˜¯ä¸€ä¸ªç”¨äºé…ç½® Linux ç³»ç»Ÿä¸Šç½‘ç»œæ¥å£çš„æ–‡ä»¶ã€‚åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä¸ºåä¸ºens33 çš„ç½‘ç»œæ¥å£é…ç½®äº†é™æ€ IPåœ°å€å’Œç›¸å…³çš„ç½‘ç»œè®¾ç½®ã€‚ä¸‹é¢æ˜¯å„è¡Œçš„è§£é‡Šï¼šauto ens33: è¿™ä¸€è¡Œè¡¨ç¤ºåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨æ¿€æ´»ens33 ç½‘ç»œæ¥å£ã€‚autoå…³é”®å­—åé¢è·Ÿç€æ¥å£åç§°ã€‚iface ens33 inet static: è¿™ä¸€è¡Œå®šä¹‰äº†ens33 ç½‘ç»œæ¥å£çš„é…ç½®ã€‚ifaceå…³é”®å­—åé¢è·Ÿç€æ¥å£åç§°ï¼Œinet è¡¨ç¤ºæˆ‘ä»¬æ­£åœ¨é…ç½® IPv4åœ°å€ï¼Œstatic è¡¨ç¤ºæˆ‘ä»¬è¦ä¸ºæ¥å£åˆ†é…ä¸€ä¸ªé™æ€ IPåœ°å€ï¼ˆè€Œä¸æ˜¯é€šè¿‡ DHCP è·å¾—ï¼‰ã€‚address 192.168.50.131: è¿™ä¸€è¡Œè®¾ç½®äº†ç½‘ç»œæ¥å£çš„é™æ€IP åœ°å€ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä¸º ens33 æ¥å£åˆ†é…äº†192.168.50.131 IP åœ°å€ã€‚IP åœ°å€æ˜¯ Internetåè®®ï¼ˆIPï¼‰ç”¨äºåœ¨ç½‘ç»œä¸­å”¯ä¸€æ ‡è¯†è®¾å¤‡çš„æ•°å­—æ ‡ç­¾ã€‚æ¯ä¸ªè¿æ¥åˆ°ç½‘ç»œçš„è®¾å¤‡éƒ½éœ€è¦ä¸€ä¸ªå”¯ä¸€çš„IP åœ°å€ï¼Œä»¥ä¾¿å…¶ä»–è®¾å¤‡å¯ä»¥æ‰¾åˆ°å¹¶ä¸ä¹‹é€šä¿¡ã€‚IP åœ°å€é€šå¸¸åˆ†ä¸ºä¸¤ç§ç‰ˆæœ¬ï¼šIPv4å’Œ IPv6ã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ª IPv4 åœ°å€ã€‚netmask 255.255.255.0:è¿™ä¸€è¡Œå®šä¹‰äº†å­ç½‘æ©ç ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå­ç½‘æ©ç æ˜¯255.255.255.0ï¼Œè¡¨ç¤ºå‰ä¸‰ä¸ªå­—èŠ‚ï¼ˆ24ä½ï¼‰æ˜¯ç½‘ç»œåœ°å€ï¼Œæœ€åä¸€ä¸ªå­—èŠ‚ï¼ˆ8 ä½ï¼‰æ˜¯ä¸»æœºåœ°å€ã€‚å­ç½‘æ©ç ç”¨äºåˆ’åˆ† IP åœ°å€çš„ç½‘ç»œéƒ¨åˆ†å’Œä¸»æœºéƒ¨åˆ†ã€‚å­ç½‘æ©ç ä¸ IPåœ°å€è¿›è¡ŒæŒ‰ä½ä¸æ“ä½œï¼Œä»è€Œå¾—åˆ°ç½‘ç»œåœ°å€ã€‚è¿™æœ‰åŠ©äºç¡®å®šå“ªäº› IPåœ°å€å±äºåŒä¸€å­ç½‘ï¼Œä»¥ä¾¿æ­£ç¡®åœ°å°†æ•°æ®åŒ…è·¯ç”±åˆ°ç›®çš„åœ°ã€‚å­ç½‘åˆ’åˆ†æœ‰åŠ©äºç»„ç»‡ç½‘ç»œã€æé«˜å®‰å…¨æ€§å’Œç®¡ç†æ€§ã€‚gateway 192.168.50.2:è¿™ä¸€è¡Œè®¾ç½®äº†é»˜è®¤ç½‘å…³ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†é»˜è®¤ç½‘å…³è®¾ç½®ä¸º192.168.50.2ã€‚é»˜è®¤ç½‘å…³æ˜¯ç”¨äºå°†æ•°æ®åŒ…å‘é€åˆ°å…¶ä»–ç½‘ç»œçš„è·¯ç”±å™¨æˆ–è®¾å¤‡çš„IP åœ°å€ã€‚ç½‘å…³æ˜¯ä¸€ä¸ªå……å½“ç½‘ç»œä¸­æ•°æ®åŒ…ä¼ è¾“çš„ä¸­ç»§ç‚¹çš„è®¾å¤‡ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªè·¯ç”±å™¨ã€‚å½“ä¸€ä¸ªè®¾å¤‡éœ€è¦å°†æ•°æ®åŒ…å‘é€åˆ°ä¸åŒå­ç½‘çš„å¦ä¸€ä¸ªè®¾å¤‡æ—¶ï¼Œå®ƒä¼šå°†æ•°æ®åŒ…å‘é€åˆ°ç½‘å…³ã€‚ç½‘å…³è´Ÿè´£å°†æ•°æ®åŒ…è·¯ç”±åˆ°æ­£ç¡®çš„ç›®çš„åœ°ã€‚é»˜è®¤ç½‘å…³æ˜¯è®¾å¤‡ç”¨äºå°†æ•°æ®åŒ…å‘é€åˆ°å…¶ä»–ç½‘ç»œçš„é¦–é€‰ç½‘å…³ã€‚dns-nameservers 8.8.8.8 8.8.4.4: è¿™ä¸€è¡ŒæŒ‡å®šäº† DNSæœåŠ¡å™¨çš„ IP åœ°å€ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†è°·æ­Œçš„å…¬å…± DNS æœåŠ¡å™¨8.8.8.8 å’Œ 8.8.4.4ã€‚DNSæœåŠ¡å™¨ç”¨äºå°†ä¸»æœºåè§£æä¸º IP åœ°å€ã€‚åŸŸåç³»ç»Ÿï¼ˆDNSï¼‰æ˜¯å°†äººç±»å¯è¯»çš„åŸŸåï¼ˆä¾‹å¦‚ www.baidu.comï¼‰IPåœ°å€çš„ç³»ç»Ÿã€‚DNSæœåŠ¡å™¨æ˜¯è´Ÿè´£æ‰§è¡Œæ­¤è§£æè¿‡ç¨‹çš„æœåŠ¡å™¨ã€‚å½“æ‚¨åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ä¸€ä¸ªç½‘å€æ—¶ï¼Œè®¡ç®—æœºä¼šå‘DNS æœåŠ¡å™¨æŸ¥è¯¢è¯¥åŸŸåå¯¹åº”çš„ IP åœ°å€ï¼Œç„¶åå°†è¯·æ±‚å‘é€åˆ°è¯¥ IPåœ°å€ä»¥è·å–ç½‘é¡µå†…å®¹ã€‚é…ç½®æ–‡ä»¶ä¸­çš„è¿™äº›è®¾ç½®å°†åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶ç”Ÿæ•ˆã€‚è¦ç«‹å³åº”ç”¨æ›´æ”¹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤é‡å¯ç½‘ç»œæœåŠ¡ï¼šsudo systemctl restart networking å®‰è£… jdk sudo apt updatesudo apt install openjdk-8-jdk éªŒè¯ java8 æ˜¯å¦å·²ç»å®‰è£…æˆåŠŸï¼š java -version æœ‰ä»¥ä¸‹ç±»ä¼¼è¾“å‡ºçš„è¯åˆ™è¡¨æ˜å®‰è£…æˆåŠŸï¼š openjdk version 1.8.0_362OpenJDK Runtime Environment (build 1.8.0_362-8u372-ga~us1-0ubuntu1~18.04-b09)OpenJDK 64-Bit Server VM (build 25.362-b09, mixed mode) å®‰è£… Kafka ä¸‹è½½å¹¶è§£å‹ Kafka wget https://archive.apache.org/dist/kafka/3.6.0/kafka_2.13-3.6.0.tgztar -zxvf kafka_2.13-3.6.0.tgz å°†è§£å‹ç¼©åçš„æ–‡ä»¶å¤¹ç§»åŠ¨åˆ° /opt ç›®å½•ä¸­ï¼š sudo mv kafka_2.13-3.6.0 /opt/kafka-3.6.0 ä½¿ç”¨ Kafka æä¾›çš„è„šæœ¬ç”Ÿæˆä¸€ä¸ª ClusterID export KAFKA_CLUSTER_ID=$(/opt/kafka-3.6.0/bin/kafka-storage.sh random-uuid) è¾“å‡º ClusterID hedon@ubuntu:/opt/kafka-3.6.0$ echo $KAFKA_CLUSTER_IDXiMRcbJ-QEO694L7sfDdBQ åœ¨å…¶ä»–èŠ‚ç‚¹ä¸Šå°† KAFKA_CLUSTER_ID è®¾ç½®ä¸ºä¸Šé¢çš„å€¼ï¼š export KAFKA_CLUSTER_ID=XiMRcbJ-QEO694L7sfDdBQ å¤‡ä»½é…ç½®æ–‡ä»¶ï¼Œæ³¨æ„è¿™é‡Œçš„é…ç½®æ–‡ä»¶æ˜¯ config/kraft/server.propertiesï¼Œåœ¨ config ç›®å½•ä¸‹çš„ kraft ç›®å½•ä¸­ï¼š cp /opt/kafka-3.6.0/config/kraft/server.properties /opt/kafka-3.6.0/config/kraft/server.properties.bak ä¿®æ”¹é…ç½® vim /opt/kafka-3.6.0/config/kraft/server.properties ä¸»è¦ä¿®æ”¹å†…å®¹å¦‚ä¸‹ï¼š # èŠ‚ç‚¹ IDï¼Œåˆ†åˆ«ä¸º 1ï¼Œ2ï¼Œ3node.id=1# æ—¥å¿—ç›®å½•log.dirs=/opt/kafka-3.6.0/kafka-combined-logs# å¯ä»¥æˆä¸ºæ§åˆ¶å™¨çš„èŠ‚ç‚¹å’Œå®ƒä»¬çš„ç«¯å£controller.quorum.voters=1@kafka1.com:9093,2@kafka2.com:9093,3@kafka3.com:9093# å®šä¹‰ Kafka Broker å¦‚ä½•å‘å¤–éƒ¨å…¬å¸ƒå®ƒçš„åœ°å€ã€‚# è¿™æ˜¯ Kafka Broker é€šçŸ¥ Producer å’Œ Consumer å¦‚ä½•è¿æ¥åˆ°è‡ªå·±çš„æ–¹å¼ã€‚# ä¾‹å¦‚ï¼Œå¦‚æœä½ è®¾ç½® advertised.listeners=PLAINTEXT://my.public.ip:9092ï¼Œ# é‚£ä¹ˆ Kafka Broker å°†å‘Šè¯‰ Producer å’Œ Consumer å®ƒçš„å…¬å…± IP åœ°å€æ˜¯ my.public.ipï¼Œå¹¶ä¸”å®ƒåœ¨ 9092 ç«¯å£ä¸Šç›‘å¬è¿æ¥ã€‚# è¿™é‡Œæˆ‘ä»¬éœ€è¦åœ¨ 3 ä¸ªèŠ‚ç‚¹åˆ†åˆ«è®¾ç½®å¯¹åº”çš„åœ°å€advertised.listeners=PLAINTEXT://kafka1.com:9092 æ ¼å¼åŒ–æ—¥å¿—ç›®å½• /opt/kafka-3.6.0/bin/kafka-storage.sh format -t $KAFKA_CLUSTER_ID -c /opt/kafka-3.6.0/config/kraft/server.properties è¾“å‡ºï¼š Formatting /opt/kafka-3.6.0/kraft-combined-logs with metadata.version 3.6-IV2. ä¸‰ä¸ªèŠ‚ç‚¹éƒ½å¯åŠ¨ Kafka /opt/kafka-3.6.0/bin/kafka-server-start.sh -daemon /opt/kafka-3.6.0/config/kraft/server.properties é€‰æ‹©ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹åˆ›å»ºä¸€ä¸ªæ–° topic /opt/kafka-3.6.0/bin/kafka-topics.sh --bootstrap-server localhost:9092 --create --topic test --replication-factor 1 --partitions=2 è¾“å‡ºï¼š Created topic test. åœ¨å…¶ä»–èŠ‚ç‚¹è·å– test è¿™ä¸ª topic çš„ä¿¡æ¯ /opt/kafka-3.6.0/bin/kafka-topics.sh --bootstrap-server localhost:9092 --describe --topic test å¯ä»¥çœ‹åˆ°å…³äº test è¿™ä¸ª topic çš„ä¿¡æ¯æ˜¯å¯ä»¥è·å–åˆ°çš„ï¼Œè¯´æ˜é›†ç¾¤ä¹‹å‰ä¿¡æ¯æ˜¯äº’é€šçš„ï¼Œé›†ç¾¤æ­å»ºå®Œæ¯•ã€‚ Topic: test\tTopicId: svJClTUpSFa9Z6FWDvkARg\tPartitionCount: 2\tReplicationFactor: 1\tConfigs: segment.bytes=1073741824\tTopic: test\tPartition: 0\tLeader: 2\tReplicas: 2\tIsr: 2\tTopic: test\tPartition: 1\tLeader: 3\tReplicas: 3\tIsr: 3 éšä¾¿é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¾€ test é‡Œé¢å†™å…¥æ•°æ®ï¼š /opt/kafka-3.6.0/bin/kafka-console-producer.sh --bootstrap-server localhost:9092 --topic test è¾“å…¥æ•°æ®åæŒ‰å›è½¦å³å‘é€ä¸€æ¡æ•°æ®ï¼Œå¯ä»¥éšæ—¶æŒ‰ Ctrl + C é€€å‡ºï¼š hedon@ubuntu:~/Downloads$ /opt/kafka-3.6.0/bin/kafka-console-producer.sh --bootstrap-server localhost:9092 --topic testmsg1msg2msg 3^ éšä¾¿é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¯åŠ¨æ¶ˆè´¹è€…æ¶ˆè´¹ topic ä¸­çš„æ•°æ®ï¼š /opt/kafka-3.6.0/bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic test --from-beginning è¾“å‡ºï¼š hedon@ubuntu:/opt/kafka-3.6.0$ /opt/kafka-3.6.0/bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic test --from-beginningmsg1msg2msg 3^CProcessed a total of 3 messages è‡³æ­¤ï¼ŒKafka çš„ KRaft ç‰ˆæœ¬é›†ç¾¤å°±éƒ¨ç½²å®Œæ¯•äº†ï¼ è¡¥å……è¯´æ˜ - KRaft é…ç½®æ–‡ä»¶ ä¸‹é¢æ˜¯ Kafka KRaft ç‰ˆæœ¬é…ç½®æ–‡ä»¶æ¯ä¸ªé…ç½®é¡¹çš„è§£é‡Šï¼šé…ç½®é¡¹è¯´æ˜process.rolesKafka æœåŠ¡å™¨çš„è§’è‰²ï¼Œè®¾ç½®æ­¤é¡¹å°† Kafka ç½®äº KRaft æ¨¡å¼ã€‚å¯èƒ½çš„å€¼åŒ…æ‹¬\"broker\" å’Œ \"controller\"ã€‚node.idä¸æ­¤å®ä¾‹å…³è”çš„èŠ‚ç‚¹ IDã€‚controller.quorum.votersæ§åˆ¶å™¨é€‰ä¸¾çš„æŠ•ç¥¨èŠ‚ç‚¹ï¼Œæ ¼å¼ä¸º node-id@host:portã€‚listenersæœåŠ¡å™¨ç›‘å¬çš„åœ°å€ï¼Œæ ¼å¼ä¸ºlistener_name://host_name:portã€‚inter.broker.listener.nameç”¨äº broker ä¹‹é—´é€šä¿¡çš„ç›‘å¬å™¨åç§°ã€‚advertised.listenersæœåŠ¡å™¨å‘å®¢æˆ·ç«¯å®£å‘Šçš„ç›‘å¬å™¨åç§°ã€ä¸»æœºåå’Œç«¯å£ã€‚controller.listener.namesæ§åˆ¶å™¨ä½¿ç”¨çš„ç›‘å¬å™¨åç§°åˆ—è¡¨ã€‚listener.security.protocol.mapç›‘å¬å™¨åç§°åˆ°å®‰å…¨åè®®çš„æ˜ å°„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä»¬æ˜¯ç›¸åŒçš„ã€‚num.network.threadsæœåŠ¡å™¨ç”¨äºä»ç½‘ç»œæ¥æ”¶è¯·æ±‚å’Œå‘ç½‘ç»œå‘é€å“åº”çš„çº¿ç¨‹æ•°ã€‚num.io.threadsæœåŠ¡å™¨ç”¨äºå¤„ç†è¯·æ±‚ï¼ˆå¯èƒ½åŒ…æ‹¬ç£ç›˜ I/Oï¼‰çš„çº¿ç¨‹æ•°ã€‚socket.send.buffer.bytesæœåŠ¡å™¨ç”¨äºå‘é€æ•°æ®çš„ç¼“å†²åŒºå¤§å°ã€‚socket.receive.buffer.bytesæœåŠ¡å™¨ç”¨äºæ¥æ”¶æ•°æ®çš„ç¼“å†²åŒºå¤§å°ã€‚socket.request.max.bytesæœåŠ¡å™¨æ¥å—çš„è¯·æ±‚çš„æœ€å¤§å¤§å°ï¼ˆç”¨äºé˜²æ­¢å†…å­˜æº¢å‡ºï¼‰ã€‚log.dirsç”¨äºå­˜å‚¨æ—¥å¿—æ–‡ä»¶çš„ç›®å½•åˆ—è¡¨ã€‚num.partitionsæ¯ä¸ªä¸»é¢˜çš„é»˜è®¤æ—¥å¿—åˆ†åŒºæ•°ã€‚num.recovery.threads.per.data.diræ¯ä¸ªæ•°æ®ç›®å½•åœ¨å¯åŠ¨æ—¶ç”¨äºæ—¥å¿—æ¢å¤å’Œå…³é—­æ—¶ç”¨äºåˆ·æ–°çš„çº¿ç¨‹æ•°ã€‚offsets.topic.replication.factorå†…éƒ¨ä¸»é¢˜ \"__consumer_offsets\" å’Œ \"__transaction_state\"çš„å¤åˆ¶å› å­ã€‚transaction.state.log.replication.factoräº‹åŠ¡çŠ¶æ€æ—¥å¿—çš„å¤åˆ¶å› å­ã€‚transaction.state.log.min.isräº‹åŠ¡çŠ¶æ€æ—¥å¿—çš„æœ€å°åŒæ­¥å‰¯æœ¬æ•°ã€‚log.flush.interval.messageså¼ºåˆ¶å°†æ•°æ®åˆ·æ–°åˆ°ç£ç›˜ä¹‹å‰æ¥å—çš„æ¶ˆæ¯æ•°ã€‚log.flush.interval.msæ¶ˆæ¯åœ¨æ—¥å¿—ä¸­åœç•™çš„æœ€å¤§æ—¶é—´ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´å°±ä¼šå¼ºåˆ¶åˆ·æ–°åˆ°ç£ç›˜ã€‚log.retention.hoursç”±äºå¹´é¾„è€Œä½¿æ—¥å¿—æ–‡ä»¶æœ‰èµ„æ ¼è¢«åˆ é™¤çš„æœ€å°å¹´é¾„ã€‚log.retention.bytesåŸºäºå¤§å°çš„æ—¥å¿—ä¿ç•™ç­–ç•¥ã€‚log.segment.bytesæ—¥å¿—æ®µæ–‡ä»¶çš„æœ€å¤§å¤§å°ã€‚log.retention.check.interval.msæ£€æŸ¥æ—¥å¿—æ®µæ˜¯å¦å¯ä»¥æ ¹æ®ä¿ç•™ç­–ç•¥è¢«åˆ é™¤çš„é—´éš”ã€‚è¯·æ³¨æ„ï¼Œè¿™åªæ˜¯ Kafka é…ç½®çš„ä¸€éƒ¨åˆ†ï¼ŒKafka é…ç½®çš„å®Œæ•´åˆ—è¡¨å¯ä»¥åœ¨ Kafkaçš„å®˜æ–¹æ–‡æ¡£ä¸­æ‰¾åˆ°ã€‚","tags":["Kafka","ä¸­é—´ä»¶","æ¶ˆæ¯é˜Ÿåˆ—","éƒ¨ç½²"],"categories":["Kafka"]},{"title":"Kafka é›†ç¾¤éƒ¨ç½²","path":"/2023/11/22/kakfa-cluster-deploy/","content":"ç‰ˆæœ¬è¯´æ˜ Ubuntu 18.04.6 Zookeeper 3.5.9 Kafka 2.7.0 JDK8 é›†ç¾¤é…ç½® æ“ä½œç³»ç»Ÿ ip åŸŸå Zookeeper ç«¯å£ Kafka ç«¯å£ Ubuntu 18.04.6 192.168.50.131 kafka1.com 2181 9092 Ubuntu 18.04.6 192.168.50.132 kafka2.com 2181 9092 Ubuntu 18.04.6 192.168.50.133 kafka3.com 2181 9092 å®‰è£… vim, curl sudo apt updatesudo apt install vimsudo apt install curl é…ç½®é™æ€ ip å’Œ hosts ä¸ºäº†ä½¿ç”¨åŸŸåï¼Œæ›´åŠ æ–¹ä¾¿çš„è¿›è¡Œé…ç½®ï¼Œè¿™é‡Œå°†è™šæ‹Ÿæœºçš„ DHCP æ”¹æˆäº†é™æ€åˆ†é… IPï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨è®¾ç½®ä¸€ä¸‹æ¯å°æœºå™¨ IP åœ°å€ï¼Œè¿™é‡Œä»¥ 192.168.50.131 ä¸ºä¾‹ã€‚ æ‰¾åˆ°ç½‘ç»œæ¥å£åç§°ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š ip addr æŸ¥æ‰¾ä»¥ ens æˆ– eth å¼€å¤´çš„æ¥å£åç§°ã€‚ä¾‹å¦‚ï¼Œens33 æˆ– eth0ã€‚ hedon@ubuntu:~$ ip addr1: lo: LOOPBACK,UP,LOWER_UP mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever inet6 ::1/128 scope host valid_lft forever preferred_lft forever2: ens33: BROADCAST,MULTICAST,UP,LOWER_UP mtu 1500 qdisc fq_codel state UP group default qlen 1000 link/ether 00:0c:29:82:9e:69 brd ff:ff:ff:ff:ff:ff inet 192.168.50.133/24 brd 192.168.50.255 scope global dynamic noprefixroute ens33 valid_lft 1644sec preferred_lft 1644sec inet6 fe80::c367:c7cc:3ad4:23b3/64 scope link valid_lft forever preferred_lft forever å¯ä»¥æ‰¾åˆ° ens33ï¼Œå…¶ä¸­ inet 192.168.50.133/24 è¡¨ç¤º IP åœ°å€ä¸º 192.168.50.133ï¼Œå­ç½‘æ©ç ä¸º /24ï¼ˆç­‰äº 255.255.255.0ï¼‰ã€‚ è¿™ä¸ª IP åœ°å€æ˜¯ DHCP åŠ¨æ€åˆ†é…çš„ï¼Œè¯´æ˜å®¿ä¸»æœºåˆ†é…ç»™è™šæ‹Ÿæœºçš„ IP èŒƒå›´å°±åœ¨ 192.168.50.xxxï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šå°†é™æ€ IP é…ç½®åœ¨è¿™ä¸ªèŒƒå›´å†…ã€‚ è·å–ç½‘å…³åœ°å€ ip route | grep default è¾“å‡ºï¼š hedon@ubuntu:~$ ip route | grep defaultdefault via 192.168.50.2 dev ens33 proto dhcp metric 100 è¯´æ˜é»˜è®¤ç½‘å…³æ˜¯ 192.168.50.2ï¼Œ ç¼–è¾‘ /etc/network/interfaces æ–‡ä»¶ï¼Œé…ç½®é™æ€ IP åœ°å€ï¼Œå†…å®¹å¦‚ä¸‹ï¼š auto ens33iface ens33 inet static\taddress 192.168.50.131\tnetmask 255.255.255.0\tgateway 192.168.50.2\tdns-nameservers 8.8.8.8 8.8.4.4 é‡å¯ su reboot å†æ¬¡æŸ¥çœ‹ ip åœ°å€ ip addr æœ‰ä»¥ä¸‹è¾“å‡ºä¾¿è¯´æ˜é™æ€ IP é…ç½®æˆåŠŸäº†ã€‚ 1: lo: LOOPBACK,UP,LOWER_UP mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever inet6 ::1/128 scope host valid_lft forever preferred_lft forever2: ens33: BROADCAST,MULTICAST,UP,LOWER_UP mtu 1500 qdisc fq_codel state UP group default qlen 1000 link/ether 00:0c:29:82:9e:69 brd ff:ff:ff:ff:ff:ff inet 192.168.50.131/24 brd 192.168.50.255 scope global ens33 valid_lft forever preferred_lft forever inet6 fe80::20c:29ff:fe82:9e69/64 scope link valid_lft forever preferred_lft forever é…ç½®åŸŸå sudo vim /etc/hosts è¿½åŠ å†…å®¹å¦‚ä¸‹ï¼š 192.168.50.131 kafka1.com192.168.50.132 kafka2.com192.168.50.133 kafka3.com ping ä¸€ä¸‹ hedon@ubuntu:~$ ping kafka1.comPING kafka1.com (192.168.50.131) 56(84) bytes of data.64 bytes from kafka1.com (192.168.50.131): icmp_seq=1 ttl=64 time=0.024 ms64 bytes from kafka1.com (192.168.50.131): icmp_seq=2 ttl=64 time=0.021 ms64 bytes from kafka1.com (192.168.50.131): icmp_seq=3 ttl=64 time=0.029 ms^C--- kafka1.com ping statistics ---3 packets transmitted, 3 received, 0% packet loss, time 2029msrtt min/avg/max/mdev = 0.021/0.024/0.029/0.006 ms ping ä¸€ä¸‹ç™¾åº¦ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½è®¿é—®å¤–ç½‘ hedon@ubuntu:~$ ping baidu.comping: baidu.com: Name or service not known å¦‚æœè¿™é‡Œå¯ä»¥è®¿é—®ï¼Œåˆ™ç›´æ¥è·³è¿‡è¿›å…¥ä¸‹ä¸€æ­¥ï¼Œä¸å¯ä»¥çš„è¯ï¼Œéœ€è¦é…ç½®ä¸€ä¸‹åŸŸåè§£æç³»ç»Ÿã€‚ é…ç½®åŸŸåè§£æç³»ç»Ÿ sudo vim /etc/resolv.conf è¿½åŠ ä¸‹é¢å†…å®¹ï¼š nameserver 8.8.8.8nameserver 8.8.4.4 å†å°è¯• ping ä¸€ä¸‹ç™¾åº¦ï¼š hedon@ubuntu:~$ ping www.baidu.comPING www.a.shifen.com (153.3.238.110) 56(84) bytes of data.64 bytes from 153.3.238.110 (153.3.238.110): icmp_seq=1 ttl=128 time=15.9 ms64 bytes from 153.3.238.110 (153.3.238.110): icmp_seq=2 ttl=128 time=15.9 ms64 bytes from 153.3.238.110 (153.3.238.110): icmp_seq=3 ttl=128 time=16.1 ms64 bytes from 153.3.238.110 (153.3.238.110): icmp_seq=4 ttl=128 time=15.3 ms^C--- www.a.shifen.com ping statistics ---4 packets transmitted, 4 received, 0% packet loss, time 14104msrtt min/avg/max/mdev = 15.368/15.850/16.145/0.291 ms è¡¥å……è¯´æ˜ï¼š/etc/network/interfaces æ–‡ä»¶çš„é…ç½® è¿™æ˜¯ä¸€ä¸ªç”¨äºé…ç½® Linux ç³»ç»Ÿä¸Šç½‘ç»œæ¥å£çš„æ–‡ä»¶ã€‚åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä¸ºåä¸ºens33 çš„ç½‘ç»œæ¥å£é…ç½®äº†é™æ€ IPåœ°å€å’Œç›¸å…³çš„ç½‘ç»œè®¾ç½®ã€‚ä¸‹é¢æ˜¯å„è¡Œçš„è§£é‡Šï¼šauto ens33: è¿™ä¸€è¡Œè¡¨ç¤ºåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨æ¿€æ´»ens33 ç½‘ç»œæ¥å£ã€‚autoå…³é”®å­—åé¢è·Ÿç€æ¥å£åç§°ã€‚iface ens33 inet static: è¿™ä¸€è¡Œå®šä¹‰äº†ens33 ç½‘ç»œæ¥å£çš„é…ç½®ã€‚ifaceå…³é”®å­—åé¢è·Ÿç€æ¥å£åç§°ï¼Œinet è¡¨ç¤ºæˆ‘ä»¬æ­£åœ¨é…ç½® IPv4åœ°å€ï¼Œstatic è¡¨ç¤ºæˆ‘ä»¬è¦ä¸ºæ¥å£åˆ†é…ä¸€ä¸ªé™æ€ IPåœ°å€ï¼ˆè€Œä¸æ˜¯é€šè¿‡ DHCP è·å¾—ï¼‰ã€‚address 192.168.50.131: è¿™ä¸€è¡Œè®¾ç½®äº†ç½‘ç»œæ¥å£çš„é™æ€IP åœ°å€ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä¸º ens33 æ¥å£åˆ†é…äº†192.168.50.131 IP åœ°å€ã€‚IP åœ°å€æ˜¯ Internetåè®®ï¼ˆIPï¼‰ç”¨äºåœ¨ç½‘ç»œä¸­å”¯ä¸€æ ‡è¯†è®¾å¤‡çš„æ•°å­—æ ‡ç­¾ã€‚æ¯ä¸ªè¿æ¥åˆ°ç½‘ç»œçš„è®¾å¤‡éƒ½éœ€è¦ä¸€ä¸ªå”¯ä¸€çš„IP åœ°å€ï¼Œä»¥ä¾¿å…¶ä»–è®¾å¤‡å¯ä»¥æ‰¾åˆ°å¹¶ä¸ä¹‹é€šä¿¡ã€‚IP åœ°å€é€šå¸¸åˆ†ä¸ºä¸¤ç§ç‰ˆæœ¬ï¼šIPv4å’Œ IPv6ã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ª IPv4 åœ°å€ã€‚netmask 255.255.255.0:è¿™ä¸€è¡Œå®šä¹‰äº†å­ç½‘æ©ç ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå­ç½‘æ©ç æ˜¯255.255.255.0ï¼Œè¡¨ç¤ºå‰ä¸‰ä¸ªå­—èŠ‚ï¼ˆ24ä½ï¼‰æ˜¯ç½‘ç»œåœ°å€ï¼Œæœ€åä¸€ä¸ªå­—èŠ‚ï¼ˆ8 ä½ï¼‰æ˜¯ä¸»æœºåœ°å€ã€‚å­ç½‘æ©ç ç”¨äºåˆ’åˆ† IP åœ°å€çš„ç½‘ç»œéƒ¨åˆ†å’Œä¸»æœºéƒ¨åˆ†ã€‚å­ç½‘æ©ç ä¸ IPåœ°å€è¿›è¡ŒæŒ‰ä½ä¸æ“ä½œï¼Œä»è€Œå¾—åˆ°ç½‘ç»œåœ°å€ã€‚è¿™æœ‰åŠ©äºç¡®å®šå“ªäº› IPåœ°å€å±äºåŒä¸€å­ç½‘ï¼Œä»¥ä¾¿æ­£ç¡®åœ°å°†æ•°æ®åŒ…è·¯ç”±åˆ°ç›®çš„åœ°ã€‚å­ç½‘åˆ’åˆ†æœ‰åŠ©äºç»„ç»‡ç½‘ç»œã€æé«˜å®‰å…¨æ€§å’Œç®¡ç†æ€§ã€‚gateway 192.168.50.2:è¿™ä¸€è¡Œè®¾ç½®äº†é»˜è®¤ç½‘å…³ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†é»˜è®¤ç½‘å…³è®¾ç½®ä¸º192.168.50.2ã€‚é»˜è®¤ç½‘å…³æ˜¯ç”¨äºå°†æ•°æ®åŒ…å‘é€åˆ°å…¶ä»–ç½‘ç»œçš„è·¯ç”±å™¨æˆ–è®¾å¤‡çš„IP åœ°å€ã€‚ç½‘å…³æ˜¯ä¸€ä¸ªå……å½“ç½‘ç»œä¸­æ•°æ®åŒ…ä¼ è¾“çš„ä¸­ç»§ç‚¹çš„è®¾å¤‡ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªè·¯ç”±å™¨ã€‚å½“ä¸€ä¸ªè®¾å¤‡éœ€è¦å°†æ•°æ®åŒ…å‘é€åˆ°ä¸åŒå­ç½‘çš„å¦ä¸€ä¸ªè®¾å¤‡æ—¶ï¼Œå®ƒä¼šå°†æ•°æ®åŒ…å‘é€åˆ°ç½‘å…³ã€‚ç½‘å…³è´Ÿè´£å°†æ•°æ®åŒ…è·¯ç”±åˆ°æ­£ç¡®çš„ç›®çš„åœ°ã€‚é»˜è®¤ç½‘å…³æ˜¯è®¾å¤‡ç”¨äºå°†æ•°æ®åŒ…å‘é€åˆ°å…¶ä»–ç½‘ç»œçš„é¦–é€‰ç½‘å…³ã€‚dns-nameservers 8.8.8.8 8.8.4.4: è¿™ä¸€è¡ŒæŒ‡å®šäº† DNSæœåŠ¡å™¨çš„ IP åœ°å€ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†è°·æ­Œçš„å…¬å…± DNS æœåŠ¡å™¨8.8.8.8 å’Œ 8.8.4.4ã€‚DNSæœåŠ¡å™¨ç”¨äºå°†ä¸»æœºåè§£æä¸º IP åœ°å€ã€‚åŸŸåç³»ç»Ÿï¼ˆDNSï¼‰æ˜¯å°†äººç±»å¯è¯»çš„åŸŸåï¼ˆä¾‹å¦‚ www.baidu.comï¼‰IPåœ°å€çš„ç³»ç»Ÿã€‚DNSæœåŠ¡å™¨æ˜¯è´Ÿè´£æ‰§è¡Œæ­¤è§£æè¿‡ç¨‹çš„æœåŠ¡å™¨ã€‚å½“æ‚¨åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ä¸€ä¸ªç½‘å€æ—¶ï¼Œè®¡ç®—æœºä¼šå‘DNS æœåŠ¡å™¨æŸ¥è¯¢è¯¥åŸŸåå¯¹åº”çš„ IP åœ°å€ï¼Œç„¶åå°†è¯·æ±‚å‘é€åˆ°è¯¥ IPåœ°å€ä»¥è·å–ç½‘é¡µå†…å®¹ã€‚é…ç½®æ–‡ä»¶ä¸­çš„è¿™äº›è®¾ç½®å°†åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶ç”Ÿæ•ˆã€‚è¦ç«‹å³åº”ç”¨æ›´æ”¹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤é‡å¯ç½‘ç»œæœåŠ¡ï¼šsudo systemctl restart networking å®‰è£… jdk sudo apt updatesudo apt install openjdk-8-jdk éªŒè¯ java8 æ˜¯å¦å·²ç»å®‰è£…æˆåŠŸï¼š java -version æœ‰ä»¥ä¸‹ç±»ä¼¼è¾“å‡ºçš„è¯åˆ™è¡¨æ˜å®‰è£…æˆåŠŸï¼š openjdk version 1.8.0_362OpenJDK Runtime Environment (build 1.8.0_362-8u372-ga~us1-0ubuntu1~18.04-b09)OpenJDK 64-Bit Server VM (build 25.362-b09, mixed mode) å®‰è£… zookeeper åœ¨ Ubuntu ä¸Šï¼Œæ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ­¥éª¤å®‰è£… Apache Zookeeper 3.5.9ï¼š ä¸‹è½½ Apache Zookeeper 3.5.9 çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ä¸‹è½½å¹¶è§£å‹ç¼© Zookeeperï¼š wget https://archive.apache.org/dist/zookeeper/zookeeper-3.5.9/apache-zookeeper-3.5.9-bin.tar.gztar -xzf apache-zookeeper-3.5.9-bin.tar.gz å°†è§£å‹ç¼©åçš„æ–‡ä»¶å¤¹ç§»åŠ¨åˆ° /opt ç›®å½•ä¸­ï¼š sudo mv apache-zookeeper-3.5.9-bin /opt/zookeeper-3.5.9 åœ¨ /opt/zookeeper-3.5.9 ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªåä¸º data çš„æ–‡ä»¶å¤¹ï¼Œç”¨äºå­˜å‚¨ Zookeeper çš„æ•°æ®ï¼š sudo mkdir /opt/zookeeper-3.5.9/data åœ¨ /opt/zookeeper-3.5.9/data ä¸‹åˆ›å»º myid æ–‡ä»¶å¹¶è®¾ç½®å†…å®¹ä¸º 1ï¼Œå…¶ä»–ä¸¤å°æœºå™¨åˆ™ä¸º 2 å’Œ 3ï¼š echo 1 | sudo tee /opt/zookeeper-3.5.9/data/myid å¤åˆ¶ Zookeeper é…ç½®æ–‡ä»¶æ ·æœ¬ï¼Œå¹¶å°†å…¶å‘½åä¸º zoo.cfgï¼š sudo cp /opt/zookeeper-3.5.9/conf/zoo_sample.cfg /opt/zookeeper-3.5.9/conf/zoo.cfg ä½¿ç”¨æ–‡æœ¬ç¼–è¾‘å™¨ï¼ˆä¾‹å¦‚ vimï¼‰ç¼–è¾‘ zoo.cfg æ–‡ä»¶ï¼š sudo vim /opt/zookeeper-3.5.9/conf/zoo.cfg ä¿®æ”¹ zoo.cfg æ–‡ä»¶ï¼š # The number of milliseconds of each ticktickTime=2000# The number of ticks that the initial # synchronization phase can takeinitLimit=10# The number of ticks that can pass between # sending a request and getting an acknowledgementsyncLimit=5# the directory where the snapshot is stored.# è®¾ç½®æ•°æ®å­˜å‚¨ç›®å½•dataDir=/opt/zookeeper-3.5.9/data# the port at which the clients will connectclientPort=2181# è®¾ç½®é›†ç¾¤ä¿¡æ¯server.1=kafka1.com:2888:3888server.2=kafka2.com:2888:3888server.3=kafka3.com:2888:3888 åœ¨ Zookeeper çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œserver.x=hostname:port1:port2 è¿™ç§æ ¼å¼çš„é…ç½®é¡¹æ˜¯ç”¨æ¥è®¾ç½® Zookeeper é›†ç¾¤ï¼ˆé›†ç¾¤æ¨¡å¼ä¸‹ï¼‰çš„ã€‚å…¶ä¸­ï¼Œx æ˜¯æœåŠ¡å™¨çš„ IDï¼Œhostname æ˜¯æœåŠ¡å™¨çš„ä¸»æœºåæˆ– IP åœ°å€ï¼Œport1 å’Œ port2 æ˜¯ç”¨äºé›†ç¾¤é—´é€šä¿¡çš„ç«¯å£ã€‚ å…·ä½“æ¥è¯´ï¼š port1ï¼ˆ2888ï¼‰ï¼šè¿™æ˜¯æœåŠ¡å™¨ä¹‹é—´ç”¨äºç›¸äº’é€šä¿¡çš„ç«¯å£ã€‚Zookeeper æœåŠ¡å™¨ä½¿ç”¨è¿™ä¸ªç«¯å£è¿›è¡Œ leader é€‰ä¸¾ä»¥åŠåŒæ­¥ follower å’Œ leader ä¹‹é—´çš„çŠ¶æ€ã€‚ port2ï¼ˆ3888ï¼‰ï¼šè¿™ä¸ªç«¯å£ç”¨äºæœåŠ¡å™¨ä¹‹é—´çš„ leader é€‰ä¸¾ã€‚åœ¨ Zookeeper é›†ç¾¤å¯åŠ¨æˆ–è€…åœ¨ leader æœåŠ¡å™¨å´©æºƒåï¼Œfollower æœåŠ¡å™¨ä¼šé€šè¿‡è¿™ä¸ªç«¯å£è¿›è¡Œæ–°ä¸€è½®çš„ leader é€‰ä¸¾ã€‚ è¿™ä¸¤ä¸ªç«¯å£å¯ä»¥æ ¹æ®ä½ çš„ç½‘ç»œé…ç½®è¿›è¡Œä¿®æ”¹ï¼Œä½†å¿…é¡»åœ¨æ‰€æœ‰çš„ Zookeeper æœåŠ¡å™¨ä¸Šä¿æŒä¸€è‡´ã€‚ ä¸‰ä¸ªèŠ‚ç‚¹éƒ½å¯åŠ¨ Zookeeper æœåŠ¡å™¨ï¼š /opt/zookeeper/bin/zkServer.sh start å¯ä»¥è¿æ¥åˆ° Zookeeper çš„ç«¯å£ä¸Šï¼ˆé»˜è®¤æ˜¯ 2181ï¼‰ï¼Œé€šè¿‡å‘é€å››å­—å‘½ä»¤ srvr æ¥éªŒè¯ Zookeeper æ˜¯å¦å®‰è£…æ­£ç¡®ï¼ˆéƒ¨ç½²é›†ç¾¤çš„è¯éœ€è¦æŠŠæ‰€æœ‰ Zookeeper å¯åŠ¨ï¼‰ï¼š hedon@ubuntu:/opt/zookeeper-3.5.9$ telnet localhost 2181Trying 127.0.0.1...Connected to localhost.Escape character is ^].srvrZookeeper version: 3.5.9-83df9301aa5c2a5d284a9940177808c01bc35cef, built on 01/06/2021 19:49 GMTLatency min/avg/max: 0/0/0Received: 1Sent: 0Connections: 1Outstanding: 0Zxid: 0x0Mode: standaloneNode count: 5Connection closed by foreign host. è¦åœæ­¢ Zookeeper æœåŠ¡å™¨ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š /opt/zookeeper/bin/zkServer.sh stop å®‰è£… Kafka ä¸‹è½½å¹¶è§£å‹ Kafka wget https://archive.apache.org/dist/kafka/2.7.0/kafka_2.13-2.7.0.tgztar -zxvf kafka_2.13-2.7.0.tgz å°†è§£å‹ç¼©åçš„æ–‡ä»¶å¤¹ç§»åŠ¨åˆ° /opt ç›®å½•ä¸­ï¼š sudo mv kafka_2.13-2.7.0 /opt/kafka-2.7.0 åˆ›å»ºæ—¥å¿—ç›®å½• sudo mkdir /opt/kafka-2.7.0/kafka-logs å¤‡ä»½ Kafka é»˜è®¤é…ç½® sudo cp /opt/kafka-2.7.0/config/server.properties /opt/kafka-2.7.0/config/server.properties.bak ä¿®æ”¹ Kafka é…ç½® sudo vim /opt/kafka-2.7.0/config/server.properties ä¸»è¦æ˜¯ä¿®æ”¹ä¸‹é¢å‡ ä¸ªé…ç½®ï¼š # é›†ç¾¤ä¸­æ¯ä¸ª broker çš„ id å¿…é¡»å”¯ä¸€ï¼Œè¿™é‡Œåˆ†åˆ«ä¸º 1ï¼Œ2ï¼Œ3broker.id=1# æ—¥å¿—ç›®å½•log.dirs=/opt/kafka-2.7.0/kafka-logs# é…ç½® Zookeeperzookeeper.connect=kafka1.com:2181,kafka2.com:2181,kafka3.com:2181# å®šä¹‰ Kafka Broker åœ¨å“ªäº›ç½‘ç»œåœ°å€ä¸Šç›‘å¬è¿æ¥ï¼Œä¸‹é¢é…ç½®è¡¨ç¤ºåœ¨æ‰€æœ‰çš„ IP åœ°å€ä¸Šç›‘å¬ 9092 ç«¯å£listeners=PLAINTEXT://:9092# å®šä¹‰ Kafka Broker å¦‚ä½•å‘å¤–éƒ¨å…¬å¸ƒå®ƒçš„åœ°å€ã€‚è¿™æ˜¯ Kafka Broker é€šçŸ¥ Producer å’Œ Consumer å¦‚ä½•è¿æ¥åˆ°è‡ªå·±çš„æ–¹å¼ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ è®¾ç½® advertised.listeners=PLAINTEXT://my.public.ip:9092ï¼Œé‚£ä¹ˆ Kafka Broker å°†å‘Šè¯‰ Producer å’Œ Consumer å®ƒçš„å…¬å…± IP åœ°å€æ˜¯ my.public.ipï¼Œå¹¶ä¸”å®ƒåœ¨ 9092 ç«¯å£ä¸Šç›‘å¬è¿æ¥ã€‚advertised.listeners=PLAINTEXT://kafka1.com:9092 ä¸‰ä¸ªèŠ‚ç‚¹éƒ½å¯åŠ¨ Kafka /opt/kafka-2.7.0/bin/kafka-server-start.sh -daemon /opt/kafka-2.7.0/config/server.properties é€‰æ‹©ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹åˆ›å»ºä¸€ä¸ªæ–° topic /opt/kafka-2.7.0/bin/kafka-topics.sh --bootstrap-server localhost:9092 --create --topic test --replication-factor 1 --partitions=2 è¾“å‡ºï¼š Created topic test. åœ¨å…¶ä»–èŠ‚ç‚¹è·å– test è¿™ä¸ª topic çš„ä¿¡æ¯ /opt/kafka-2.7.0/bin/kafka-topics.sh --bootstrap-server localhost:9092 --describe --topic test å¯ä»¥çœ‹åˆ°å…³äº test è¿™ä¸ª topic çš„ä¿¡æ¯æ˜¯å¯ä»¥è·å–åˆ°çš„ï¼Œè¯´æ˜é›†ç¾¤ä¹‹å‰ä¿¡æ¯æ˜¯äº’é€šçš„ï¼Œé›†ç¾¤æ­å»ºå®Œæ¯•ã€‚ Topic: test\tPartitionCount: 2\tReplicationFactor: 1\tConfigs: segment.bytes=1073741824\tTopic: test\tPartition: 0\tLeader: 1\tReplicas: 1\tIsr: 1\tTopic: test\tPartition: 1\tLeader: 2\tReplicas: 2\tIsr: 2","tags":["Kafka","ä¸­é—´ä»¶","æ¶ˆæ¯é˜Ÿåˆ—","éƒ¨ç½²"],"categories":["Kafka"]},{"title":"Raft-Extended è®ºæ–‡ç¿»è¯‘","path":"/2023/11/18/raft/","content":"åŸæ–‡ï¼šhttps://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf è¾¨æ consensus vs consistency ä¸€è‡´æ€§ï¼ˆconsistencyï¼‰å¾€å¾€æŒ‡åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¤šä¸ªå‰¯æœ¬å¯¹å¤–å‘ˆç°çš„æ•°æ®çš„çŠ¶æ€ã€‚å¦‚é¡ºåºä¸€è‡´æ€§ã€çº¿æ€§ä¸€è‡´æ€§ï¼Œæè¿°äº†å¤šä¸ªèŠ‚ç‚¹å¯¹æ•°æ®çŠ¶æ€çš„ç»´æŠ¤èƒ½åŠ›ã€‚ å…±è¯†ï¼ˆconsensusï¼‰åˆ™æè¿°äº†åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¤šä¸ªèŠ‚ç‚¹ä¹‹é—´ï¼Œå½¼æ­¤å¯¹æŸä¸ªææ¡ˆè¾¾æˆä¸€è‡´ç»“æœçš„è¿‡ç¨‹ã€‚ å› æ­¤ï¼Œä¸€è‡´æ€§æè¿°çš„æ˜¯ç»“æœï¼Œå…±è¯†åˆ™æ˜¯ä¸€ç§æ‰‹æ®µã€‚ æœ‰çš„äººä¼šè¯´ä¸€è‡´æ€§å’Œå…±è¯†å®é™…ä¸Šæ˜¯ä¸€ä¸ªé—®é¢˜çš„ä¸€ä½“ä¸¤é¢ï¼ŒæŸç§ç¨‹åº¦ä¸Šæ¥è¯´ï¼Œå…±è¯†æ–¹æ³•ç¡®å®å¯ä»¥çœ‹ä½œæ˜¯å®ç°å¼ºä¸€è‡´æ€§çš„ä¸€ç§æ–¹æ³•ã€‚äº‹å®ä¸Šåœ¨å·¥ä¸šç•Œæœ‰è®¸å¤šä»¥å…±è¯†ç®—æ³•ä½œä¸ºæ ¸å¿ƒç»„ä»¶çš„å¤šå‰¯æœ¬çŠ¶æ€æœºï¼ˆReplicated State Machineï¼‰å®ç°ï¼Œæœ¬è´¨ä¸Šåˆ©ç”¨äº†å…±è¯†ç®—æ³•ä¿è¯äº†æ‰€æœ‰å‰¯æœ¬çš„æ“ä½œæ—¥å¿—å…·æœ‰å®Œå…¨ç›¸åŒçš„é¡ºåºï¼Œä»è€Œå®ç°äº†å‰¯æœ¬çš„ä¸€è‡´æ€§ã€‚ä½†æ˜¯ï¼Œå³ä½¿æ˜¯åœ¨è¿™æ ·çš„åœºæ™¯ä¸‹ï¼Œè®¨è®ºä¸€ä¸ªå…±è¯†ç®—æ³•çš„ä¸€è‡´æ€§ä¹Ÿæ˜¯ä¸åˆé€‚çš„ï¼Œå› ä¸ºæ•´ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿæœ€ç»ˆçš„ä¸€è‡´æ€§å¹¶ä¸å•å•å–å†³äºå…±è¯†ç®—æ³•ï¼Œå…±è¯†ç®—æ³•åªæ˜¯è§£å†³äº†å…¶ä¸­ä¸€ä¸ªé—®é¢˜ã€‚ å‚è€ƒï¼šhttps://zhuanlan.zhihu.com/p/68743917 0. æ‘˜è¦ Raft æ˜¯ç”¨æ¥ç®¡ç†å¤åˆ¶æ—¥å¿—ï¼ˆreplicated logï¼‰çš„ä¸€è‡´æ€§åè®®ã€‚å®ƒè·Ÿ multi-Paxos ä½œç”¨ç›¸åŒï¼Œæ•ˆç‡ä¹Ÿç›¸å½“ã€‚ä½†æ˜¯å®ƒçš„ç»„ç»‡ç»“æ„è·Ÿ Paxos ä¸åŒï¼Œä¹Ÿæ˜¯å› ä¸º Raft æ›´ç®€å•çš„æ¶æ„ä½¿å¾—å®ƒæ›´å®¹æ˜“è¢«ç†è§£ï¼Œå¹¶ä¸”æ›´å®¹æ˜“åœ¨å®é™…å·¥ç¨‹ä¸­å¾—ä»¥å®ç°ã€‚ ä¸ºäº†è®© Raft æ›´å®¹æ˜“è¢«ç†è§£ï¼ŒRaft å°†å…±è¯†ç®—æ³•çš„å…³é”®æ€§å› ç´ åˆ‡åˆ†æˆå‡ ä¸ªéƒ¨åˆ†ï¼Œæ¯”å¦‚ï¼š leader electionï¼ˆé¢†å¯¼è€…é€‰ä¸¾ï¼‰ log replicationï¼ˆæ—¥å¿—å¤åˆ¶ï¼‰ safetyï¼ˆå®‰å…¨æ€§ï¼‰ å¹¶ä¸” Raft å®æ–½äº†ä¸€ç§æ›´å¼ºçš„å…±è¯†æ€§ä»¥ä¾¿å‡å°‘å¿…é¡»è¦è€ƒè™‘çš„çŠ¶æ€ï¼ˆstatesï¼‰çš„æ•°é‡ã€‚ ç”¨æˆ·ç ”ç©¶è¡¨æ˜ï¼Œå¯¹äºå­¦ç”Ÿæ¥è¯´ï¼ŒRaft ç›¸æ¯”äº Paxos æ˜¯æ›´å®¹æ˜“å­¦ä¹ çš„ã€‚ Raft è¿˜åŒ…æ‹¬ä¸€ä¸ªç”¨äºè§£å†³å˜æ›´é›†ç¾¤æˆå‘˜é—®é¢˜çš„æ–°æœºåˆ¶ï¼Œå®ƒä½¿ç”¨é‡å†™å¤šæ•°æ¥ä¿è¯å®‰å…¨æ€§ã€‚ 1. ä»‹ç» å…±è¯†ç®—æ³•å…è®¸å¤šå°æœºå™¨ä½œä¸ºä¸€ä¸ªé›†ç¾¤ååŒå·¥ä½œï¼Œå¹¶ä¸”åœ¨å…¶ä¸­çš„æŸå‡ å°æœºå™¨å‡ºæ•…éšœæ—¶é›†ç¾¤ä»ç„¶èƒ½æ­£å¸¸å·¥ä½œã€‚æ­£å› ä¸ºå¦‚æ­¤ï¼Œå…±è¯†ç®—æ³•åœ¨å»ºç«‹å¯é çš„å¤§è§„æ¨¡è½¯ä»¶ç³»ç»Ÿæ–¹é¢å‘æŒ¥äº†é‡è¦ä½œç”¨ã€‚åœ¨è¿‡å»åå¹´ä¸­ï¼ŒPaxos [15,16] ä¸»å¯¼äº†å…³äºå…±è¯†ç®—æ³•çš„è®¨è®ºï¼šå¤§å¤šæ•°å…±è¯†æ€§çš„å®ç°éƒ½æ˜¯åŸºäº Paxos æˆ–å—å…¶å½±å“ï¼ŒPaxos å·²ç»æˆä¸ºæ•™æˆå­¦ç”Ÿå…³äºå…±è¯†çŸ¥è¯†çš„ä¸»è¦å·¥å…·ã€‚ æ¯”è¾ƒé—æ†¾çš„æ˜¯ï¼Œå°½ç®¡å¾ˆå¤šäººä¸€ç›´åœ¨åŠªåŠ›å°è¯•ä½¿ Paxos æ›´æ˜“æ‡‚ï¼ŒPaxos è¿˜æ˜¯å¤ªéš¾ç†è§£äº†ã€‚æ­¤å¤–ï¼ŒPaxos çš„æ¶æ„éœ€è¦å¤æ‚çš„æ”¹å˜æ¥æ”¯æŒå®é™…ç³»ç»Ÿã€‚è¿™å¯¼è‡´çš„ç»“æœå°±æ˜¯ç³»ç»Ÿå¼€å‘è€…å’Œå­¦ç”Ÿåœ¨å­¦ç”Ÿå’Œä½¿ç”¨ Paxos è¿‡ç¨‹ä¸­éƒ½å¾ˆæŒ£æ‰ã€‚ åœ¨æˆ‘ä»¬è‡ªå·±ä¸ Paxos æ–—äº‰ä¹‹åï¼Œæˆ‘ä»¬å¼€å§‹ç€æ‰‹å¯»æ‰¾ä¸€ä¸ªæ–°çš„å…±è¯†ç®—æ³•ï¼Œå¸Œæœ›å¯ä»¥ä¸ºç³»ç»Ÿå¼€å‘å’Œæ•™å­¦æä¾›æ›´å¥½çš„åŸºç¡€ã€‚ æˆ‘ä»¬çš„æ–¹æ³•æ˜¯ä¸å¯»å¸¸çš„ï¼Œå› ä¸ºæˆ‘ä»¬çš„ä¸»è¦ç›®æ ‡æ˜¯å¯ç†è§£æ€§ï¼šæˆ‘ä»¬å¯ä»¥è®¾è®¡ä¸€ä¸ªæ¯” Paxos æ›´é€‚åˆç”¨äºå®é™…å·¥ç¨‹å®ç°å¹¶ä¸”æ›´æ˜“æ‡‚çš„å…±è¯†ç®—æ³•å—ï¼Ÿ åœ¨è¯¥ç®—æ³•çš„è®¾è®¡ä¸­ï¼Œé‡è¦çš„ä¸ä»…æ˜¯å¦‚ä½•è®©ç®—æ³•èµ·ä½œç”¨ï¼Œè¿˜è¦æ¸…æ™°åœ°çŸ¥é“è¯¥ç®—æ³•ä¸ºä»€ä¹ˆä¼šèµ·ä½œç”¨ã€‚ è¿™é¡¹å·¥ä½œçš„ç»“æœæ˜¯ä¸€ä¸ªç§°ä¸º Raft çš„å…±è¯†æ€§ç®—æ³•ã€‚åœ¨è®¾è®¡ Raft æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ç‰¹å®šçš„æŠ€æœ¯æ¥æé«˜å®ƒçš„å¯ç†è§£æ€§ï¼ŒåŒ…æ‹¬ï¼š åˆ†è§£ï¼ˆRaft åˆ†ç¦»å‡ºä¸‰ä¸ªå…³é”®ç‚¹ï¼šleader electionã€log replicationã€safetyï¼‰ å‡å°‘çŠ¶æ€ç©ºé—´ï¼ˆç›¸æ¯”äº Paxosï¼ŒRaft é™ä½äº†ä¸ç¡®å®šæ€§çš„ç¨‹åº¦å’ŒæœåŠ¡å™¨ä¹‹é—´çš„ä¸ä¸€è‡´ï¼‰ ä¸€é¡¹é’ˆå¯¹ 2 æ‰€å¤§å­¦å…± 43 åå­¦ç”Ÿçš„ç”¨æˆ·ç ”ç©¶è¡¨æ˜ï¼ŒRaft æ¯” Paxos æ›´å®¹æ˜“ç†è§£ï¼šåœ¨å­¦ä¹ ä¸¤ç§ç®—æ³•åï¼Œå…¶ä¸­ 33 åå­¦ç”Ÿèƒ½å¤Ÿæ›´å¥½åœ°å›ç­” Raft çš„ç›¸å…³é—®é¢˜ã€‚ Raft åœ¨è®¸å¤šæ–¹é¢ç±»ä¼¼äºç°æœ‰çš„å…¬å¼ç®—æ³•ï¼ˆå°¤å…¶æ˜¯ Okiã€Liskov çš„ Viewstamped Replication [29,22]ï¼‰ï¼Œä½†å®ƒæœ‰å‡ ä¸ªæ–°ç‰¹æ€§ï¼š Strong leaderï¼ˆå¼ºé¢†å¯¼æ€§ï¼‰ï¼šç›¸æ¯”äºå…¶ä»–ç®—æ³•ï¼ŒRaft ä½¿ç”¨äº†æ›´å¼ºçš„é¢†å¯¼å½¢å¼ã€‚æ¯”å¦‚ï¼Œæ—¥å¿—æ¡ç›®åªèƒ½ä» leader æµå‘ followerï¼ˆé›†ç¾¤ä¸­é™¤ leader å¤–å…¶ä»–çš„æœåŠ¡å™¨ï¼‰ã€‚è¿™åœ¨ä½¿ Raft æ›´æ˜“æ‡‚çš„åŒæ—¶ç®€åŒ–äº†æ—¥å¿—å¤åˆ¶çš„ç®¡ç†æµç¨‹ã€‚ Leader electionï¼ˆé¢†å¯¼é€‰ä¸¾ï¼‰ï¼šRaft ä½¿ç”¨éšæœºè®¡æ—¶å™¨æ¥è¿›è¡Œé¢†å¯¼é€‰ä¸¾ã€‚ä»»ä½•å…±è¯†ç®—æ³•éƒ½éœ€è¦å¿ƒè·³æœºåˆ¶ï¼ˆheartbeatsï¼‰ï¼ŒRaft åªéœ€è¦åœ¨è¿™ä¸ªåŸºç¡€ä¸Šï¼Œæ·»åŠ å°‘é‡æœºåˆ¶ï¼Œå°±å¯ä»¥ç®€å•å¿«é€Ÿåœ°è§£å†³å†²çªã€‚ Membership changesï¼ˆæˆå‘˜å˜æ›´ï¼‰ï¼šRaft åœ¨æ›´æ”¹é›†ç¾¤ä¸­æœåŠ¡å™¨é›†çš„æœºåˆ¶ä¸­ä½¿ç”¨äº†ä¸€ä¸ª è”åˆå…±è¯†ï¼ˆjoint consensusï¼‰ çš„æ–¹æ³•ã€‚åœ¨è”åˆå…±è¯†ï¼ˆjoint consensusï¼‰ä¸‹ï¼Œåœ¨é›†ç¾¤é…ç½®çš„è½¬æ¢è¿‡ç¨‹ä¸­ï¼Œæ–°æ—§ä¸¤ç§é…ç½®å¤§å¤šæ•°æ˜¯é‡å çš„ï¼Œè¿™ä½¿å¾—é›†ç¾¤åœ¨é…ç½®æ›´æ”¹æœŸé—´å¯ä»¥ç»§ç»­æ­£å¸¸è¿è¡Œã€‚ æˆ‘ä»¬è®¤ä¸º Raft è·Ÿ Paxos ä»¥åŠå…¶ä»–å…±è¯†ç®—æ³•ç›¸æ¯”æ˜¯æ›´ä¼˜çš„ï¼Œè¿™ä¸ä»…ä½“ç°åœ¨æ•™å­¦æ–¹é¢ï¼Œè¿˜ä½“ç°åœ¨å·¥ç¨‹å®ç°æ–¹é¢ã€‚ å®ƒæ¯”å…¶ä»–ç®—æ³•æ›´ç®€å•ä¸”æ›´æ˜“äºç†è§£ å®ƒè¢«æè¿°å¾—ååˆ†è¯¦ç»†è¶³ä»¥æ»¡è¶³å®é™…ç³»ç»Ÿçš„éœ€è¦ å®ƒæœ‰å¤šä¸ªå¼€æºå®ç°ï¼Œå¹¶è¢«å¤šå®¶å…¬å¸ä½¿ç”¨ å®ƒçš„å®‰å…¨æ€§å·²è¢«æ­£å¼è§„å®šå’ŒéªŒè¯ å®ƒçš„æ•ˆç‡ä¸å…¶ä»–ç®—æ³•ç›¸å½“ æœ¬æ–‡å‰©ä½™éƒ¨åˆ†ï¼š æ‰€åœ¨èŠ‚ å†…å®¹ ç¬¬ 2 èŠ‚ å¤åˆ¶çŠ¶æ€æœºé—®é¢˜ï¼ˆreplicated state machine problemï¼‰ ç¬¬ 3 èŠ‚ Paxos çš„ä¼˜ç¼ºç‚¹ ç¬¬ 4 èŠ‚ å®ç° Raft æ˜“ç†è§£æ€§çš„æªæ–½ ç¬¬ 5-8 èŠ‚ Raft å…±è¯†æ€§ç®—æ³•è¯¦ç»†é˜è¿° ç¬¬ 9 èŠ‚ è¯„ä¼° Raft ç¬¬ 10 èŠ‚ å…¶ä»–ç›¸å…³å·¥ä½œ 2. å¤åˆ¶çŠ¶æ€æœº å…±è¯†ç®—æ³•ä¸€èˆ¬éƒ½æ˜¯åœ¨å¤åˆ¶çŠ¶æ€æœº [37] çš„èƒŒæ™¯ä¸‹å®ç°çš„ã€‚åœ¨è¿™ç§æ–¹æ³•ä¸‹ï¼Œä¸€ç»„æœåŠ¡å™¨åœ¨çš„çŠ¶æ€æœºè®¡ç®—ç›¸åŒçŠ¶æ€çš„ç›¸åŒå‰¯æœ¬ï¼Œå³ä½¿æŸäº›æœåŠ¡å™¨å´©æºƒï¼Œå®ƒä»¬ä¹Ÿå¯ä»¥ç»§ç»­è¿è¡Œã€‚ å¤åˆ¶çŠ¶æ€æœºæ˜¯ç”¨æ¥è§£å†³åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å„ç§å®¹é”™é—®é¢˜ã€‚æ¯”å¦‚è¯´ï¼Œå…·æœ‰å•ä¸ª leader çš„å¤§è§„æ¨¡çš„ç³»ç»Ÿï¼Œå¦‚ GFS [8]ï¼ŒHDFS [38] å’Œ RAMCloud [33] ï¼Œä»–ä»¬é€šå¸¸éƒ½ä½¿ç”¨å•ç‹¬çš„å¤åˆ¶çŠ¶æ€æœºæ¥ç®¡ç† leader election å’Œä¿å­˜ leader å´©æºƒåé‡æ–°é€‰ä¸¾æ‰€éœ€çš„é…ç½®ä¿¡æ¯ã€‚åƒ Chubby [2] å’Œ ZooKeeper [11] éƒ½æ˜¯å¤åˆ¶çŠ¶æ€æœºã€‚ å¤åˆ¶çŠ¶æ€æœºé€šå¸¸éƒ½æ˜¯ä½¿ç”¨æ—¥å¿—å¤åˆ¶ï¼ˆlog replicationï¼‰æ¥å®ç°ã€‚å¦‚å›¾1ï¼šæ¯ä¸ªæœåŠ¡å™¨éƒ½ä¿å­˜ç€ä¸€ä»½æ‹¥æœ‰ä¸€ç³»åˆ—å‘½ä»¤çš„æ—¥å¿—ï¼Œç„¶åæœåŠ¡å™¨ä¸Šçš„çŠ¶æ€æœºä¼šæŒ‰é¡ºåºæ‰§è¡Œæ—¥å¿—ä¸­çš„å‘½ä»¤ã€‚æ¯ä¸€ä»½æ—¥å¿—ä¸­å‘½ä»¤ç›¸åŒå¹¶ä¸”é¡ºåºä¹Ÿç›¸åŒï¼Œå› æ­¤æ¯ä¸ªçŠ¶æ€æœºå¯ä»¥å¤„ç†ç›¸åŒçš„å‘½ä»¤åºåˆ—ã€‚æ‰€ä»¥çŠ¶æ€æœºæ˜¯å¯ç¡®å®šçš„ï¼Œæ¯ä¸ªçŠ¶æ€æœºéƒ½æ‰§è¡Œç›¸åŒçš„çŠ¶æ€å’Œç›¸åŒçš„è¾“å‡ºåºåˆ—ã€‚ image-20210719200404010 å…±è¯†ç®—æ³•çš„ä¸»è¦å·¥ä½œå°±æ˜¯ä¿è¯å¤åˆ¶æ—¥å¿—ï¼ˆreplicated logï¼‰çš„ä¸€è‡´æ€§ã€‚æ¯å°æœåŠ¡å™¨ä¸Šçš„å…±è¯†æ¨¡å—æ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯çš„å‘½ä»¤ï¼Œå¹¶å°†è¿™äº›å‘½ä»¤æ·»åŠ åˆ°å…¶æ—¥å¿—å½“ä¸­ã€‚å®ƒï¼ˆæŒ‡å…±è¯†æ¨¡å—ï¼‰ä¸å…¶ä»–æœåŠ¡å™¨ä¸Šçš„å…±è¯†æ¨¡å—è¿›è¡Œé€šä¿¡ï¼Œä»¥ç¡®ä¿æ¯å°æœåŠ¡å™¨ä¸Šæœ€ç»ˆä»¥ç›¸åŒçš„é¡ºåºåŒ…å«ç›¸åŒçš„å‘½ä»¤ï¼Œå³ä½¿éƒ¨åˆ†æœåŠ¡å™¨å´©æºƒäº†ï¼Œè¿™ä¸ªæ¡ä»¶ä¹Ÿå¯ä»¥æ»¡è¶³ã€‚ä¸€æ—¦å‘½ä»¤è¢«æ­£ç¡®å¤åˆ¶ï¼Œæ¯å°æœåŠ¡å™¨ä¸Šçš„çŠ¶æ€æœºå°±ä¼šæŒ‰æ—¥å¿—é¡ºåºå¤„ç†å®ƒä»¬ï¼Œå¹¶å°†è¾“å‡ºè¿”å›ç»™å®¢æˆ·ç«¯ã€‚è¿™æ ·å°±å½¢æˆäº†é«˜å¯ç”¨çš„å¤åˆ¶çŠ¶æ€æœºã€‚ é€‚ç”¨äºå®é™…ç³»ç»Ÿçš„å…±è¯†ç®—æ³•é€šå¸¸éƒ½åŒ…å«ä»¥ä¸‹å‡ ç‚¹ç‰¹å¾ï¼š å®ƒä»¬ç¡®ä¿åœ¨æ‰€æœ‰éæ‹œå åº­é”™è¯¯ä¸‹çš„å®‰å…¨æ€§ï¼Œä¹Ÿå°±æ˜¯ä»ä¸è¿”å›ä¸€ä¸ªé”™è¯¯çš„ç»“æœã€‚ï¼ˆå³ä½¿æ˜¯ç½‘ç»œå»¶è¿Ÿã€åˆ†åŒºã€æ•°æ®åŒ…ä¸¢å¤±ã€æ•°æ®åŒ…é‡å¤å’Œæ•°æ®åŒ…ä¹±åºï¼‰ æ‹œå åº­é”™è¯¯ï¼š å‡ºç°æ•…éšœï¼ˆcrash æˆ– fail-stopï¼Œå³ä¸å“åº”ï¼‰ä½†ä¸ä¼šä¼ªé€ ä¿¡æ¯çš„æƒ…å†µç§°ä¸ºâ€œéæ‹œå åº­é”™è¯¯â€ã€‚ ä¼ªé€ ä¿¡æ¯æ¶æ„å“åº”çš„æƒ…å†µç§°ä¸ºâ€œæ‹œå åº­é”™è¯¯â€ï¼Œå¯¹åº”èŠ‚ç‚¹ç§°ä¸ºæ‹œå åº­èŠ‚ç‚¹ã€‚ åªè¦ä»»ä½•å¤§å¤šæ•°ï¼ˆè¿‡åŠï¼‰æœåŠ¡å™¨æ˜¯å¯è¿è¡Œçš„ï¼Œå¹¶ä¸”å¯ä»¥äº’ç›¸é€šä¿¡å’Œä¸å®¢æˆ·ç«¯é€šä¿¡ï¼Œé‚£ä¹ˆå…±è¯†ç®—æ³•å°±å¯ç”¨ã€‚å‡è®¾æœåŠ¡å™¨å´©æºƒäº†ï¼Œä¸€å°æ®µæ—¶é—´åï¼Œå®ƒä»¬å¾ˆå¯èƒ½ä¼šæ ¹æ®å·²ç»ç¨³å®šå­˜å‚¨çš„çŠ¶æ€æ¥è¿›è¡Œæ¢å¤ï¼Œå¹¶é‡æ–°åŠ å…¥é›†ç¾¤ã€‚ å®ƒä»¬åœ¨ä¿è¯æ—¥å¿—ä¸€è‡´æ€§ä¸Šä¸ä¾èµ–äºæ—¶åºï¼šé”™è¯¯çš„æ—¶é’Ÿå’Œæç«¯æ¶ˆæ¯å»¶è¿Ÿåœ¨æœ€åçš„æƒ…å†µä¸‹ä¼šäº§ç”Ÿå½±å“å¯ç”¨æ€§çš„ä¸€ç³»åˆ—é—®é¢˜ã€‚ åœ¨é€šå¸¸æƒ…å†µä¸‹ï¼Œåªè¦é›†ç¾¤ä¸­å¤§éƒ¨åˆ†ï¼ˆè¿‡åŠï¼‰æœåŠ¡å™¨å·²ç»å“åº”äº†å•è½®è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆRPCï¼‰ï¼Œå‘½ä»¤å°±å¯ä»¥è¢«è§†ä¸ºå®Œæˆã€‚å°‘æ•°ï¼ˆä¸€åŠä»¥ä¸‹ï¼‰æ…¢æœåŠ¡å™¨ä¸ä¼šå½±å“æ•´ä¸ªç³»ç»Ÿçš„æ€§èƒ½ã€‚ 3. Paxos å­˜åœ¨çš„é—®é¢˜ åœ¨è¿‡å»çš„åå¹´é—´ï¼ŒLeslie Lamport çš„ Paxos åè®® [15] å‡ ä¹æˆä¸ºå…±è¯†æ€§ï¼ˆconsensusï¼‰çš„åŒä¹‰è¯ã€‚å®ƒæ˜¯è¯¾å ‚ä¸Šè¢«æ•™æˆæœ€å¤šçš„å…±è¯†åè®®ï¼Œå¤§å¤šæ•°å…±è¯†æ€§çš„å®ç°ä¹Ÿæ˜¯ä»¥å®ƒä¸ºèµ·ç‚¹ã€‚Paxos é¦–å…ˆå®šä¹‰äº†èƒ½åœ¨å•ä¸ªå†³ç­–é—®é¢˜ï¼ˆä¾‹å¦‚å•ä¸ªå¤åˆ¶æ—¥å¿—æ¡ç›®ï¼‰ä¸Šè¾¾æˆå…±è¯†çš„åè®®ã€‚æˆ‘ä»¬å°†è¿™ä¸ªå­é›†ç§°ä¸º signle-degree Paxosã€‚ç„¶å Paxos ç»„åˆè¯¥åè®®çš„å¤šä¸ªå®ä¾‹å»å®ç°ä¸€ç³»åˆ—å†³ç­–ï¼Œæ¯”å¦‚æ—¥å¿—ï¼ˆmutil-Paxosï¼‰ã€‚Paxos ä¿è¯äº†å®‰å…¨æ€§å’Œæ´»æ€§ï¼Œå®ƒä¹Ÿæ”¯æŒæ”¹å˜é›†ç¾¤ä¸­çš„æˆå‘˜ï¼Œå®ƒçš„å®‰å…¨æ€§ä¹Ÿå·²ç»è¢«è®ºè¯äº†ï¼Œå¹¶ä¸”å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½æ˜¯é«˜æ•ˆçš„ã€‚ ç¾ä¸­ä¸è¶³çš„æ˜¯ï¼ŒPaxos æœ‰ä¸¤ä¸ªä¸¥é‡çš„ç¼ºç‚¹ï¼š Paxos éå¸¸éš¾ç†è§£ ä¼—æ‰€å‘¨çŸ¥ï¼ŒPaxos éå¸¸æ™¦æ¶©éš¾æ‡‚ï¼Œé™¤éä¸‹äº†å¾ˆå¤§çš„åŠŸå¤«ï¼Œå¾ˆå°‘æœ‰äººèƒ½å¤ŸæˆåŠŸç†è§£å®ƒã€‚å› æ­¤ï¼Œå°½ç®¡ç›®å‰å·²ç»æœ‰å‡ ä¸ªå°è¯•å¸Œæœ›å°† Paxos [16,20,21] è§£é‡Šå¾—é€šä¿—æ˜“æ‡‚ä¸€äº›ï¼Œè€Œä¸”è¿™äº›è§£é‡Šéƒ½é›†ä¸­åœ¨ single-decree Paxosï¼Œä½†æ˜¯å®ƒä»¬è¿˜æ˜¯å¾ˆéš¾æ‡‚ã€‚ åœ¨å¯¹ NSDI 2012 å‚ä¼šè€…çš„éæ­£å¼è°ƒæŸ¥ä¸­ï¼Œæˆ‘ä»¬å‘ç°å¾ˆå°‘äººä¼šå–œæ¬¢ Paxosï¼Œå³ä½¿æ˜¯ç»éªŒä¸°å¯Œçš„ç ”ç©¶äººå‘˜ã€‚æˆ‘ä»¬è‡ªå·±ä¹Ÿä¸€ç›´åœ¨è·Ÿ Paxos ä½œæ–—äº‰ï¼Œæˆ‘ä»¬ä¹Ÿæ— æ³•å®Œå…¨ç†è§£æ•´ä¸ª Paxos åè®®ï¼Œç›´åˆ°é˜…è¯»äº†å‡ ä¸ªæ›´ç®€å•çš„æè¿°å’Œè‡ªå·±è®¾è®¡äº†æ›¿ä»£ Paxos çš„åè®®ï¼Œæˆ‘ä»¬æ‰å¯¹ Paxos æœ‰äº†æ¯”è¾ƒæ·±åˆ»çš„ç†è§£ã€‚ä½†è¿™ä¸ªè¿‡ç¨‹ï¼ŒèŠ±äº†å°†è¿‘ä¸€å¹´ã€‚ æˆ‘ä»¬æ¨æµ‹ Paxos è¿™ä¹ˆæ™¦æ¶©éš¾æ‡‚ï¼Œä¸»è¦æ˜¯å› ä¸ºä½œè€…é€‰æ‹©äº† Single-decree Paxos æ¥ä½œä¸ºåŸºç¡€ã€‚Single-decree Paxso éå¸¸æäººï¼šå®ƒåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å¯¹è¿™ä¸¤ä¸ªé˜¶æ®µè¿›è¡Œç®€å•ç›´è§‚çš„è¯´æ˜ï¼Œè€Œä¸”è¿™ä¸¤ä¸ªé˜¶æ®µä¹Ÿä¸èƒ½åˆ†å¼€äº†å•ç‹¬ç†è§£ï¼Œæ‰€ä»¥ä½¿ç”¨è€…å°†å°±å¾ˆéš¾ç†è§£ä¸ºä»€ä¹ˆè¯¥ç®—æ³•èƒ½èµ·ä½œç”¨ã€‚Multi-Paxos çš„åˆæˆè§„åˆ™åˆå¢åŠ äº†è®¸å¤šå¤æ‚æ€§ã€‚æˆ‘ä»¬ç›¸ä¿¡ï¼Œå¯¹å¤šä¸ªå†³å®šï¼ˆæ—¥å¿—ï¼Œå¹¶éå•ä¸ªæ—¥å¿—æ¡ç›®ï¼‰è¾¾æˆå…±è¯†çš„æ€»ä½“é—®é¢˜å¯ä»¥ç”¨å…¶ä»–æ›´ç›´æ¥å’Œæ›´æ˜æ˜¾çš„æ–¹å¼è¿›è¡Œåˆ†è§£ã€‚ Paxos æ²¡æœ‰ä¸ºå®é™…å®ç°æä¾›ä¸€ä¸ªè‰¯å¥½çš„åŸºç¡€ å…¶ä¸­ä¸€ä¸ªåŸå› æ˜¯æ²¡æœ‰å¹¿æ³›è®¤åŒçš„é’ˆå¯¹ Multi-Paxos çš„ç®—æ³•ã€‚Lamport çš„æè¿°ä¸»è¦æ˜¯é’ˆå¯¹ signle-decree Paxos çš„ï¼Œä»–æè¿°äº†é’ˆå¯¹ multi-Paxos çš„å¯èƒ½æ–¹æ³•ï¼Œä½†ç¼ºå°‘äº†å¾ˆå¤šç»†èŠ‚ã€‚ ç›®å‰å·²ç»æœ‰äººåœ¨å°è¯•å…·ä½“åŒ–å’Œä¼˜åŒ– Paxosï¼Œæ¯”å¦‚ [26]ï¼Œ[39] å’Œ [13]ï¼Œä½†æ˜¯è¿™äº›å°è¯•éƒ½äº’ä¸ç›¸åŒå¹¶ä¸”å®ƒä»¬è·Ÿ Lamport æè¿°çš„ä¹Ÿä¸å°½ç›¸åŒã€‚è™½ç„¶åƒ Chubby [4] è¿™æ ·çš„ç³»ç»Ÿå·²ç»å®ç°äº†ç±» Paxosï¼ˆPaxos-likeï¼‰ç®—æ³•ï¼Œä½†æ˜¯ä»–ä»¬å¹¶æ²¡æœ‰é€éœ²å‡ºå¾ˆå¤šçš„å®ç°ç»†èŠ‚ã€‚ æ­¤å¤–ï¼ŒPaxos çš„æ¶æ„å¯¹äºæ„å»ºå®é™…ç³»ç»Ÿæ¥è¯´å…¶å®æ˜¯ä¸€ä¸ªç³Ÿç³•çš„è®¾è®¡ï¼Œè¿™æ˜¯ single-decree Paxos åˆ†è§£çš„å¦ä¸€ä¸ªç»“æœã€‚ä¸¾ä¸ªä¾‹å­ï¼Œè¿™å¯¹äºç‹¬ç«‹é€‰æ‹©åœ°æ—¥å¿—æ¡ç›®çš„é›†åˆï¼Œç„¶åå†å°†å®ƒä»¬åˆå¹¶åˆ°é¡ºåºæ—¥å¿—å½“ä¸­æ²¡æœ‰ä»»ä½•å¥½å¤„ï¼Œè¿™åªä¼šå¢åŠ å¤æ‚æ€§ã€‚å›´ç»•æ—¥å¿—æ¥è®¾è®¡ç³»ç»Ÿæ˜¯æ›´åŠ ç®€å•å’Œé«˜æ•ˆçš„æ–¹æ³•ï¼Œå…¶ä¸­æ–°æ¡ç›®æŒ‰å—çº¦æŸçš„é¡ºåºä¾æ¬¡é™„åŠ ã€‚å¦å¤–ä¸€ä¸ªé—®é¢˜æ˜¯ Paxos åœ¨å…¶æ ¸å¿ƒä½¿ç”¨äº†å¯¹ç§°å¯¹ç­‰æ–¹æ³•ï¼ˆå°½ç®¡å®ƒæœ€ç»ˆè¡¨æ˜äº†è¿™ä¼šè¢«ç”¨ä½œä¸€ç§æ€§èƒ½ä¼˜åŒ–çš„å¼±é¢†å¯¼æ¨¡å¼ï¼‰ã€‚è¿™åœ¨åªæœ‰ä¸€ä¸ªå†³ç­–çš„æƒ…å†µä¸‹æ˜¯æœ‰æ„ä¹‰çš„ï¼Œä½†æ˜¯å°½ç®¡å¦‚æ­¤ï¼Œè¿˜æ˜¯å¾ˆå°‘æœ‰å®é™…ç³»ç»Ÿé‡‡ç”¨äº†è¿™ç§æ–¹æ³•ã€‚å¦‚æœæœ‰ä¸€ç³»åˆ—çš„å†³ç­–éœ€è¦åˆ¶å®šï¼Œæ›´ç®€å•å’Œæ›´å¿«é€Ÿçš„æ–¹æ³•åº”è¯¥æ˜¯é¦–å…ˆé€‰æ‹©ä¸€ä¸ª leaderï¼Œç„¶åç”± leader å»åè°ƒè¿™äº›å†³ç­–ã€‚ å› æ­¤ï¼ŒæŒ‰ç…§ Paxos æ¥å®ç°çš„å®é™…ç³»ç»Ÿå¾€å¾€è·Ÿ Paxos ç›¸å·®å¾ˆå¤§ã€‚å‡ ä¹æ‰€æœ‰çš„å®ç°éƒ½æ˜¯ä» Paxos å¼€å§‹ï¼Œç„¶ååœ¨å®ç°çš„è¿‡ç¨‹ä¸­å‘ç°äº†ä¸€ç³»åˆ—çš„éš¾é¢˜ï¼Œåœ¨è§£å†³éš¾é¢˜çš„è¿‡ç¨‹ä¸­ï¼Œå¼€å‘å‡ºäº†è·Ÿ Paxos å®Œå…¨ä¸ä¸€æ ·çš„æ¶æ„ã€‚è¿™æ ·æ—¢è´¹æ—¶åˆå®¹æ˜“å‡ºé”™ï¼Œè€Œä¸” Paxos æœ¬èº«çš„æ™¦æ¶©éš¾æ‡‚åˆä½¿å¾—é—®é¢˜å˜å¾—æ›´åŠ ä¸¥é‡ã€‚Paxos å…¬å¼å¯èƒ½æ˜¯è¯æ˜å…¶æ­£ç¡®æ€§çš„ä¸€ä¸ªå¾ˆå¥½çš„å…¬å¼ï¼Œä½†çœŸæ­£çš„å®ç°ä¸ Paxos åˆç›¸å·®å¾ˆå¤§ï¼Œè¿™è¯æ˜äº†å®ƒå…¶å®æ²¡æœ‰ä»€ä¹ˆä»·å€¼ã€‚ä¸‹é¢æ¥è‡ª Chubby ä½œè€…çš„è¯„è®ºéå¸¸å…¸å‹ï¼š åœ¨ Paxos ç®—æ³•æè¿°å’Œç°å®å®ç°ç³»ç»Ÿä¹‹é—´æœ‰ç€å·¨å¤§çš„é¸¿æ²Ÿ... ï¼ˆå¦‚æœä¸€ç›´æŒ‰ç…§ Paxos ç®—æ³•èµ°ä¸‹å»ï¼‰ï¼Œæœ€ç»ˆçš„ç³»ç»Ÿå¾€å¾€ä¼šå»ºç«‹åœ¨ä¸€ä¸ªè¿˜æœªè¢«è¯æ˜çš„åè®®ä¹‹ä¸Šã€‚ ç»¼åˆä¸Šè¿°é—®é¢˜ï¼Œæˆ‘ä»¬è§‰å¾— Paxos åœ¨æ•™å­¦ç«¯å’Œç³»ç»Ÿæ„å»ºç«¯éƒ½æ²¡æœ‰æä¾›ä¸€ä¸ªè‰¯å¥½çš„åŸºç¡€ã€‚è€ƒè™‘åˆ°å…±è¯†æ€§åœ¨å¤§è§„æ¨¡è½¯ä»¶ç³»ç»Ÿä¸­çš„é‡è¦æ€§ï¼Œæˆ‘ä»¬å†³å®šå»å°è¯•ä¸€ä¸‹çœ‹çœ‹èƒ½ä¸èƒ½è®¾è®¡ä¸€ä¸ªæ›¿ä»£ Paxos å¹¶ä¸”å…·æœ‰æ›´å¥½ç‰¹æ€§çš„å…±è¯†ç®—æ³•ã€‚Raft å°±æ˜¯è¿™æ¬¡å®éªŒçš„ç»“æœã€‚ 4. ä¸ºå¯ç†è§£æ€§è€Œè®¾è®¡ åœ¨è®¾è®¡ Raft ç®—æ³•è¿‡ç¨‹ä¸­æˆ‘ä»¬æœ‰å‡ ä¸ªç›®æ ‡ï¼š å®ƒå¿…é¡»ä¸ºç³»ç»Ÿæ„å»ºæä¾›ä¸€ä¸ªå®Œæ•´ä¸”å®é™…çš„åŸºç¡€ï¼Œè¿™æ ·æ‰èƒ½å¤§å¤§å‡å°‘å¼€å‘è€…çš„å·¥ä½œ å®ƒå¿…é¡»åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½æ˜¯å®‰å…¨çš„å¹¶ä¸”åœ¨å…¸å‹çš„åº”ç”¨æ¡ä»¶ä¸‹æ˜¯å¯ç”¨çš„ï¼Œå¹¶ä¸”åœ¨æ­£å¸¸æƒ…å†µä¸‹æ˜¯é«˜æ•ˆçš„ ä½†æ˜¯æˆ‘ä»¬æœ€é‡è¦çš„ç›®æ ‡ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬é‡åˆ°çš„æœ€å¤§çš„æŒ‘æˆ˜ï¼š å®ƒå¿…é¡»å…·æœ‰æ˜“ç†è§£æ€§ï¼Œå®ƒå¿…é¡»ä¿è¯èƒ½å¤Ÿè¢«å¤§å¤šæ•°äººè½»æ¾åœ°ç†è§£ã€‚è€Œä¸”å®ƒå¿…é¡»èƒ½å¤Ÿè®©äººå½¢æˆç›´è§‚çš„è®¤è¯†ï¼Œè¿™æ ·ç³»ç»Ÿæ„å»ºè€…æ‰èƒ½åœ¨å®ç°è¿‡ç¨‹ä¸­å¯¹å®ƒè¿›è¡Œä¸å¯é¿å…çš„æ‹“å±•ã€‚ åœ¨è®¾è®¡ Raft ç®—æ³•çš„è¿‡ç¨‹ä¸­ï¼Œå¾ˆå¤šæƒ…å†µä¸‹æˆ‘ä»¬éœ€è¦åœ¨å¤šä¸ªå¤‡é€‰æ–¹æ¡ˆä¸‹åšå‡ºæŠ‰æ‹©ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¾€å¾€ä¼šåŸºäºå¯ç†è§£æ€§æ¥è¿›è¡ŒæŠ‰æ‹©ï¼š è§£é‡Šå„ä¸ªå¤‡é€‰æ–¹æ¡ˆçš„éš¾åº¦æœ‰å¤šå¤§ï¼Ÿä¾‹å¦‚ï¼Œå®ƒçš„çŠ¶æ€ç©ºé—´æœ‰å¤šå¤æ‚ï¼Ÿå®ƒæ˜¯å¦å…·æœ‰éš¾ä»¥ç†è§£çš„å«ä¹‰ï¼Ÿ å¯¹äºä¸€ä¸ªè¯»è€…æ¥è¯´ï¼Œå®Œæˆç†è§£è¿™ä¸ªæ–¹æ¡ˆå’Œæ–¹æ¡ˆä¸­çš„å„ç§å«ä¹‰æ˜¯å¦ç®€å•ï¼Ÿ æˆ‘ä»¬æ„è¯†åˆ°è¿™ä¸€çš„åˆ†æå…·æœ‰é«˜åº¦çš„ä¸»è§‚æ€§ã€‚æ‰€ä»¥æˆ‘ä»¬é‡‡å–äº†ä¸¤ç§é€šç”¨çš„æªæ–½æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ ç¬¬ä¸€ä¸ªæªæ–½å°±æ˜¯ä¼—æ‰€å‘¨çŸ¥çš„é—®é¢˜åˆ†è§£ï¼šåªè¦æœ‰å¯èƒ½ï¼Œæˆ‘ä»¬å°±å°†é—®é¢˜åˆ’åˆ†æˆå‡ ä¸ªç›¸å¯¹ç‹¬ç«‹åœ°è§£å†³ã€è§£é‡Šå’Œç†è§£çš„å­é—®é¢˜ã€‚ä¾‹å¦‚ï¼ŒRaft ç®—æ³•è¢«æˆ‘ä»¬åˆ’åˆ†æˆ leader é€‰ä¸¾ã€æ—¥å¿—å¤åˆ¶ã€å®‰å…¨æ€§å’Œæˆå‘˜å˜æ›´å‡ ä¸ªéƒ¨åˆ†ã€‚ ç¬¬äºŒä¸ªæªæ–½æ˜¯é€šè¿‡å‡å°‘çŠ¶æ€çš„æ•°é‡æ¥ç®€åŒ–çŠ¶æ€ç©ºé—´ï¼Œå°½å¯èƒ½åœ°ä½¿ç³»ç»Ÿå˜å¾—æ›´åŠ è¿è´¯å’Œå°½å¯èƒ½åœ°æ¶ˆé™¤ä¸ç¡®å®šæ€§ã€‚å¾ˆæ˜æ˜¾çš„ä¸€ä¸ªä¾‹å­å°±æ˜¯ï¼Œæ‰€æœ‰çš„æ—¥å¿—éƒ½æ˜¯ä¸å…è®¸æœ‰ç©ºæŒ¡çš„ï¼Œå¹¶ä¸” Raft é™åˆ¶äº†æ—¥å¿—ä¹‹é—´å¯èƒ½ä¸ä¸€æ ·çš„æ–¹å¼ã€‚å°½ç®¡åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬éƒ½æåŠ›å»æ¶ˆé™¤ä¸ç¡®å®šæ€§ï¼Œä½†æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹ä¸ç¡®å®šæ€§å´å¯ä»¥æé«˜å¯ç†è§£æ€§ã€‚ä¸€ä¸ªé‡è¦çš„ä¾‹å­å°±æ˜¯éšæœºåŒ–æ–¹æ³•ï¼Œå®ƒä»¬è™½ç„¶å¼•å…¥äº†ä¸ç¡®å®šæ€§ï¼Œä½†æ˜¯å®ƒä»¬å¾€å¾€èƒ½å¤Ÿé€šè¿‡ä»¥ç±»ä¼¼çš„æ–¹å¼å¤„ç†æ‰€æœ‰å¯èƒ½çš„é€‰æ‹©æ¥å‡å°‘çŠ¶æ€ç©ºé—´ï¼ˆéšä¾¿é€‰ï¼Œæ²¡å…³ç³»ï¼‰ã€‚æ‰€æœ‰æˆ‘ä»¬ä½¿ç”¨äº†éšæœºåŒ–æ¥ç®€åŒ– Raft ä¸­çš„ leader election ç®—æ³•ã€‚ 5. Raft å…±è¯†ç®—æ³• Raft æ˜¯ä¸€ç§ç”¨æ¥ç®¡ç†ç¬¬ 2 èŠ‚ä¸­æåˆ°çš„å¤åˆ¶æ—¥å¿—ï¼ˆreplicated logï¼‰çš„ç®—æ³•ã€‚å›¾ 2 æ˜¯è¯¥ç®—æ³•çš„æµ“ç¼©ï¼Œå¯ä»¥ä½œä¸ºå‚è€ƒã€‚å›¾ 3 åˆ—ä¸¾äº†è¯¥ç®—æ³•çš„ä¸€äº›å…³é”®ç‰¹æ€§ã€‚è¿™ä¸¤å¼ å›¾ä¸­çš„å†…å®¹å°†ä¼šåœ¨åé¢çš„å„ä¸ªç« èŠ‚ä¸­é€ä¸€ä»‹ç»ã€‚ Raft åœ¨å®ç°å…±è¯†ç®—æ³•çš„è¿‡ç¨‹ä¸­ï¼Œé¦–å…ˆé€‰ä¸¾ä¸€ä¸ª distinguished leaderï¼Œç„¶åç”±è¯¥ leader å…¨æƒè´Ÿè´£å¤åˆ¶æ—¥å¿—çš„ä¸€è‡´æ€§ã€‚Leader ä»å®¢æˆ·ç«¯æ¥æ”¶æ—¥å¿—æ¡ç›®ï¼Œç„¶åå°†è¿™äº›æ—¥å¿—æ¡ç›®å¤åˆ¶ç»™å…¶ä»–æœåŠ¡å™¨ï¼Œå¹¶ä¸”åœ¨ä¿è¯å®‰å…¨æ€§çš„æƒ…å†µä¸‹é€šçŸ¥å…¶ä»–æœåŠ¡å™¨å°†æ—¥å¿—æ¡ç›®åº”ç”¨åˆ°ä»–ä»¬çš„çŠ¶æ€æœºä¸­ã€‚æ‹¥æœ‰ä¸€ä¸ª leader å¤§å¤§ç®€åŒ–äº†å¯¹å¤åˆ¶æ—¥å¿—çš„ç®¡ç†æµç¨‹ã€‚ä¾‹å¦‚ï¼Œleader å¯ä»¥åœ¨ä¸è·Ÿå…¶ä»–æœåŠ¡å™¨å•†è®®çš„æƒ…å†µä¸‹å†³å®šæ–°çš„æ—¥å¿—æ¡ç›®åº”è¯¥å­˜æ”¾åœ¨æ—¥å¿—çš„ä»€ä¹ˆä½ç½®ï¼Œå¹¶ä¸”æ•°æ®éƒ½æ˜¯ä» leader æµå‘å…¶ä»–æœåŠ¡å™¨ã€‚å½“ç„¶äº†ï¼Œä¸€ä¸ª leader å¯èƒ½ä¼šå´©æºƒï¼Œä¹Ÿå¯èƒ½ä¸å…¶ä»–æœåŠ¡å™¨æ–­å¼€è¿æ¥ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼ŒRaft å°±ä¼šé€‰ä¸¾å‡ºä¸€ä¸ªæ–°çš„ leader å‡ºæ¥ã€‚ é€šè¿‡é€‰ä¸¾ä¸€ä¸ª leader çš„æ–¹å¼ï¼ŒRaft å°†å…±è¯†é—®é¢˜åˆ†è§£æˆä¸‰ä¸ªç‹¬ç«‹çš„å­é—®é¢˜ï¼Œè¿™äº›é—®é¢˜å°†ä¼šåœ¨æ¥ä¸‹æ¥çš„å­ç« èŠ‚ä¸­è¿›è¡Œè®¨è®ºï¼š Leader electionï¼ˆé¢†å¯¼é€‰ä¸¾ï¼‰ ä¸€ä¸ª leader å€’ä¸‹ä¹‹åï¼Œä¸€å®šä¼šæœ‰ä¸€ä¸ªæ–°çš„ leader ç«™èµ·æ¥ã€‚ Log replicationï¼ˆæ—¥å¿—å¤åˆ¶ï¼‰ leader å¿…é¡»æ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯çš„æ—¥å¿—æ¡ç›®ç„¶åå¤åˆ¶åˆ°é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹ï¼Œå¹¶ä¸”å¼ºåˆ¶å…¶ä»–èŠ‚ç‚¹çš„æ—¥å¿—å’Œè‡ªå·±çš„ä¿æŒä¸€è‡´ã€‚ Safetyï¼ˆå®‰å…¨æ€§ï¼‰ Raft ä¸­å®‰å…¨æ€§çš„å…³é”®æ˜¯å›¾ 3 ä¸­çŠ¶æ€æœºçš„å®‰å…¨æ€§ï¼šåªè¦æœ‰ä»»ä½•æœåŠ¡å™¨èŠ‚ç‚¹å°†ä¸€ä¸ªç‰¹å®šçš„æ—¥å¿—æ¡ç›®åº”ç”¨åˆ°å®ƒçš„çŠ¶æ€æœºä¸­ï¼Œé‚£ä¹ˆå…¶ä»–æœåŠ¡å™¨èŠ‚ç‚¹å°±ä¸èƒ½åœ¨åŒä¸€ä¸ªæ—¥å¿—ç´¢å¼•ä½ç½®ä¸Šå­˜å‚¨å¦å¤–ä¸€æ¡ä¸åŒçš„æŒ‡ä»¤ã€‚ç¬¬ 5.4 èŠ‚å°†ä¼šæè¿° Raft å¦‚ä½•ä¿è¯è¿™ç§ç‰¹æ€§ï¼Œè€Œä¸”è¯¥è§£å†³æ–¹æ¡ˆåœ¨ 5.2 èŠ‚æè¿°çš„é€‰ä¸¾æœºåˆ¶ä¸Šè¿˜å¢åŠ äº†é¢å¤–çš„é™åˆ¶ã€‚ image-20210709155333989 åœ¨å±•ç¤ºäº† Raft å…±è¯†ç®—æ³•åï¼Œæœ¬ç« èŠ‚å°†è®¨è®ºå¯ç”¨æ€§çš„ä¸€äº›é—®é¢˜ä»¥åŠæ—¶åºåœ¨ç³»ç»Ÿä¸­çš„æ‰€ç”¨ã€‚ 5.1 Raft åŸºç¡€ ä¸€ä¸ª Raft é›†ç¾¤ä¸­åŒ…å«è‹¥å¹²ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹ï¼Œ5 ä¸ªä¸€ä¸ªæ¯”è¾ƒå…¸å‹çš„æ•°å­—ï¼Œ5 ä¸ªæœåŠ¡å™¨çš„é›†ç¾¤å¯ä»¥å®¹å¿ 2 ä¸ªèŠ‚ç‚¹çš„å¤±æ•ˆã€‚åœ¨ä»»ä½•ä¸€ä¸ªæ—¶åˆ»ï¼Œé›†ç¾¤ä¸­çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½åªå¯èƒ½æ˜¯ä»¥ä¸‹æ˜¯ä¸‰ç§èº«ä»½ä¹‹ä¸€ï¼š leaderï¼šå®ƒä¼šå¤„ç†æ‰€æœ‰æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼ˆå¦‚æœä¸€ä¸ªå®¢æˆ·ç«¯å’Œ follower é€šä¿¡ï¼Œfollower ä¼šå°†è¯·æ±‚é‡å®šå‘åˆ° leader ä¸Šï¼‰ followerï¼šå®ƒä»¬è¢«åŠ¨çš„ï¼šå®ƒä»¬ä¸ä¼šå‘é€ä»»ä½•è¯·æ±‚ï¼Œåªæ˜¯ç®€å•çš„å“åº”æ¥è‡ª leader å’Œ candidate çš„è¯·æ±‚ candidateï¼šè¿™æ˜¯ç”¨æ¥é€‰ä¸¾ä¸€ä¸ªæ–°çš„ leader çš„æ—¶å€™å‡ºç°çš„ä¸€ç§ä¸´æ—¶çŠ¶æ€ï¼Œè¿™å°†åœ¨ç¬¬ 5.2 èŠ‚ä¸­è¯¦ç»†æè¿° åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œé›†ç¾¤ä¸­åªæœ‰ä¸€ä¸ª leaderï¼Œç„¶åå‰©ä¸‹çš„èŠ‚ç‚¹éƒ½æ˜¯ followerã€‚å›¾ 4 å±•ç¤ºäº†è¿™äº›çŠ¶æ€å’Œå®ƒä»¬ä¹‹é—´çš„è½¬æ¢å…³ç³»ï¼Œè¿™äº›è½¬æ¢å…³ç³»å°†ä¼šåœ¨æ¥ä¸‹æ¥è¿›è¡Œè®¨è®ºã€‚ image-20210709145034498 å¦‚å›¾ 5 æ‰€ç¤ºï¼ŒRaft å°†æ—¶é—´åˆ’åˆ†æˆä»»æ„é•¿åº¦çš„ä»»æœŸï¼ˆtermï¼‰ã€‚æ¯ä¸€æ®µä»»æœŸä»ä¸€æ¬¡é€‰ä¸¾å¼€å§‹ï¼Œåœ¨è¿™ä¸ªæ—¶å€™ä¼šæœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ª candidate å°è¯•å»æˆä¸º leaderã€‚å¦‚æœæŸä¸€ä¸ª candidate èµ¢å¾—äº†é€‰ä¸¾ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šåœ¨ä»»æœŸå‰©ä¸‹çš„æ—¶é—´é‡Œæ‰¿æ‹…ä¸€ä¸ª leader çš„è§’è‰²ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¸€æ¬¡é€‰ä¸¾æ— æ³•é€‰å‡º leaderï¼Œè¿™ä¸ªæ—¶å€™è¿™ä¸ªä»»æœŸä¼šä»¥æ²¡æœ‰ leader è€Œç»“æŸã€‚åŒæ—¶ä¸€ä¸ªæ–°çš„ä»»æœŸï¼ˆåŒ…å«ä¸€æ¬¡æ–°çš„é€‰ä¸¾ï¼‰ä¼šå¾ˆå¿«é‡æ–°å¼€å§‹ã€‚è¿™æ˜¯å› ä¸º Raft ä¼šä¿è¯åœ¨ä»»æ„ä¸€ä¸ªä»»æœŸå†…ï¼Œè‡³å¤šæœ‰ä¸€ä¸ª leaderã€‚ image-20210709145441879 é›†ç¾¤ä¸­ä¸åŒçš„æœåŠ¡å™¨è§‚å¯Ÿåˆ°çš„ä»»æœŸè½¬æ¢çš„æ¬¡æ•°ä¹Ÿè®¸æ˜¯ä¸åŒçš„ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¸€ä¸ªèŠ‚ç‚¹å¯èƒ½æ²¡æœ‰è§‚å¯Ÿåˆ° leader é€‰ä¸¾è¿‡ç¨‹ç”šè‡³æ˜¯æ•´ä¸ªä»»æœŸè¿‡ç¨‹ã€‚ ä»»æœŸåœ¨ Raft ä¸­è¿˜æ‰®æ¼”ç€ä¸€ä¸ªé€»è¾‘æ—¶é’Ÿï¼ˆlogical clockï¼‰çš„è§’è‰²ï¼Œè¿™ä½¿å¾—æœåŠ¡å™¨å¯ä»¥å‘ç°ä¸€äº›è¿‡æœŸçš„ä¿¡æ¯ï¼Œæ¯”å¦‚è¿‡æ—¶çš„ leaderã€‚ æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½å­˜å‚¨ç€ä¸€ä¸ªå½“å‰ä»»æœŸå·ï¼ˆcurrent term numberï¼‰ï¼Œè¯¥ä»»æœŸå·ä¼šéšç€æ—¶é—´å•è°ƒé€’å¢ã€‚èŠ‚ç‚¹ä¹‹é—´é€šä¿¡çš„æ—¶å€™ä¼šäº¤æ¢å½“å‰ä»»æœŸå·ï¼Œå¦‚æœä¸€ä¸ªèŠ‚ç‚¹çš„å½“å‰ä»»æœŸå·æ¯”å…¶ä»–èŠ‚ç‚¹å°ï¼Œé‚£ä¹ˆå®ƒå°±å°†è‡ªå·±çš„ä»»æœŸå·æ›´æ–°ä¸ºè¾ƒå¤§çš„é‚£ä¸ªå€¼ã€‚å¦‚æœä¸€ä¸ª candidate æˆ–è€… leader å‘ç°è‡ªå·±çš„ä»»æœŸå·è¿‡æœŸäº†ï¼Œå®ƒå°±ä¼šç«‹åˆ»å›åˆ° follower çŠ¶æ€ã€‚å¦‚æœä¸€ä¸ªèŠ‚ç‚¹æ¥æ”¶äº†ä¸€ä¸ªå¸¦ç€è¿‡æœŸçš„ä»»æœŸå·çš„è¯·æ±‚ï¼Œé‚£ä¹ˆå®ƒä¼šæ‹’ç»è¿™æ¬¡è¯·æ±‚ã€‚ Raft ç®—æ³•ä¸­æœåŠ¡å™¨èŠ‚ç‚¹ä¹‹é—´é‡‡ç”¨ RPC è¿›è¡Œé€šä¿¡ï¼Œä¸€èˆ¬çš„å…±è¯†ç®—æ³•éƒ½åªéœ€è¦ä¸¤ç§ç±»å‹çš„ RPCã€‚ RequestVote RPCsï¼ˆè¯·æ±‚æŠ•ç¥¨ï¼‰ï¼šç”± candidate åœ¨é€‰ä¸¾è¿‡ç¨‹ä¸­å‘å‡ºï¼ˆ5.2 èŠ‚ä¸­æè¿°ï¼‰ AppendEntries RPCsï¼ˆè¿½åŠ æ¡ç›®ï¼‰ï¼šç”± leader å‘å‡ºï¼Œç”¨æ¥åšæ—¥å¿—å¤åˆ¶å’Œæä¾›å¿ƒè·³æœºåˆ¶ï¼ˆ5.3 èŠ‚ä¸­æè¿°ï¼‰ã€‚ åœ¨ç¬¬ 7 èŠ‚ä¸­ä¸ºäº†åœ¨èŠ‚ç‚¹ä¹‹é—´ä¼ è¾“å¿«ç…§ï¼ˆsnapshotï¼‰å¢åŠ äº†ç¬¬ä¸‰ç§ RPCã€‚å½“èŠ‚ç‚¹æ²¡æœ‰åŠæ—¶çš„æ”¶åˆ° RPC çš„å“åº”æ—¶ï¼Œä¼šè¿›è¡Œé‡è¯•ï¼Œè€Œä¸”èŠ‚ç‚¹ä¹‹é—´éƒ½æ˜¯ä»¥å¹¶è¡Œï¼ˆparallelï¼‰çš„æ–¹å¼å‘é€ RPC è¯·æ±‚ï¼Œä»¥æ­¤æ¥è·å¾—æœ€ä½³çš„æ€§èƒ½ã€‚ 5.2 Leader election Raft é‡‡ç”¨ä¸€ç§å¿ƒè·³æœºåˆ¶æ¥è§¦å‘ leader é€‰ä¸¾ã€‚å½“æœåŠ¡å™¨å¯åŠ¨çš„æ—¶å€™ï¼Œä»–ä»¬éƒ½ä¼šç§°ä¸º followerã€‚ä¸€ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹åªè¦ä» candidate æˆ–è€… leader é‚£æ¥æ”¶åˆ°æœ‰æ•ˆçš„ RPC å°±ä¸€ç›´ä¿æŒ follower çš„çŠ¶æ€ã€‚Leader ä¼šå‘¨æœŸæ€§åœ°å‘æ‰€æœ‰çš„ follower å‘èµ·å¿ƒè·³æ¥ç»´æŒè‡ªå·±çš„ leader åœ°ä½ï¼Œæ‰€è°“å¿ƒè·³ï¼Œå°±æ˜¯ä¸åŒ…å«æ—¥å¿—æ¡ç›®çš„ AppendEntries RPCã€‚å¦‚æœä¸€ä¸ª follower åœ¨ä¸€æ®µæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°ä»»ä½•ä¿¡æ¯ï¼ˆè¿™æ®µæ—¶é—´æˆ‘ä»¬ç§°ä¸ºé€‰ä¸¾è¶…æ—¶ election timeoutï¼‰ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šå‡å®šç›®å‰é›†ç¾¤ä¸­æ²¡æœ‰ä¸€ä¸ªå¯ç”¨çš„ leaderï¼Œç„¶åå¼€å¯ä¸€æ¬¡é€‰ä¸¾æ¥é€‰æ‹©ä¸€ä¸ªæ–°çš„ leaderã€‚ å¼€å§‹è¿›è¡Œé€‰ä¸¾çš„æ—¶å€™ï¼Œä¸€ä¸ª follower ä¼šè‡ªå¢å½“å‰ä»»æœŸå·ç„¶ååˆ‡æ¢ä¸º candidate çŠ¶æ€ã€‚ç„¶åå®ƒä¼šç»™è‡ªå·±æŠ•ç¥¨ï¼ŒåŒæ—¶ä»¥å¹¶è¡Œçš„æ–¹å¼å‘é€ä¸€ä¸ª RequestVote RPCs ç»™é›†ç¾¤ä¸­çš„å…¶ä»–æœåŠ¡å™¨èŠ‚ç‚¹ï¼ˆä¼å›¾å¾—åˆ°å®ƒä»¬çš„æŠ•ç¥¨ï¼‰ã€‚ä¸€ä¸ª candidate ä¼šä¸€ç›´ä¿æŒå½“å‰çŠ¶æ€ç›´åˆ°ä»¥ä¸‹çš„ä¸‰ä»¶äº‹ä¹‹ä¸€å‘ç”Ÿï¼ˆè¿™äº›æƒ…å†µéƒ½ä¼šåœ¨ä¸‹é¢çš„ç« èŠ‚é‡Œåˆ†åˆ«è®¨è®ºï¼‰ï¼š å®ƒèµ¢å¾—é€‰ä¸¾ï¼Œæˆä¸ºäº† leader å…¶ä»–èŠ‚ç‚¹èµ¢å¾—äº†é€‰æ‹©ï¼Œé‚£ä¹ˆå®ƒä¼šå˜æˆ follower ä¸€æ®µæ—¶é—´ä¹‹åæ²¡æœ‰ä»»ä½•èŠ‚ç‚¹åœ¨é€‰ä¸¾ä¸­èƒœå‡º å½“ä¸€ä¸ª candidate è·å–é›†ç¾¤ä¸­è¿‡åŠæœåŠ¡å™¨èŠ‚ç‚¹é’ˆå¯¹åŒä¸€ä»»æœŸçš„æŠ•ç¥¨æ—¶ï¼Œå®ƒå°±èµ¢å¾—äº†è¿™æ¬¡é€‰ä¸¾å¹¶æˆä¸ºæ–°çš„ leaderã€‚å¯¹äºåŒä¸€ä¸ªä»»æœŸï¼Œæ¯ä¸€ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹ä¼šæŒ‰ç…§ å…ˆæ¥å…ˆæœåŠ¡åŸåˆ™ï¼ˆfirst-come-first-servedï¼‰ åªæŠ•ç»™ä¸€ä¸ª candidateï¼ˆåœ¨5.4 èŠ‚ä¼šåœ¨æŠ•ç¥¨ä¸Šå¢åŠ é¢å¤–çš„é™åˆ¶ï¼‰ã€‚è¿™ç§è¦æ±‚è·å¾—è¿‡åŠæŠ•ç¥¨æ‰èƒ½æˆä¸º leader çš„è§„åˆ™ç¡®ä¿äº†æœ€å¤šåªæœ‰ä¸€ä¸ª candidate èµ¢å¾—æ­¤æ¬¡é€‰ä¸¾ï¼ˆå›¾ 3 ä¸­çš„é€‰ä¸¾å®‰å…¨æ€§ï¼‰ã€‚åªè¦æœ‰ä¸€ä¸ª candidate èµ¢å¾—é€‰ä¸¾ï¼Œå®ƒå°±ä¼šæˆä¸º leaderã€‚ç„¶åå®ƒå°±ä¼šå‘é›†ç¾¤ä¸­å…¶ä»–èŠ‚ç‚¹å‘é€å¿ƒè·³æ¶ˆæ¯æ¥ç¡®å®šè‡ªå·±çš„åœ°ä½å¹¶é˜»æ­¢æ–°çš„é€‰ä¸¾ã€‚ ä¸€ä¸ª candidate åœ¨ç­‰å¾…å…¶ä»–èŠ‚ç‚¹ç»™å®ƒæŠ•ç¥¨çš„æ—¶å€™ï¼Œå®ƒä¹Ÿæœ‰å¯èƒ½æ¥æ”¶åˆ°å¦å¤–ä¸€ä¸ªè‡ªç§°ä¸º leader çš„èŠ‚ç‚¹ç»™å®ƒå‘è¿‡æ¥çš„ AppendEntries RPCã€‚ å¦‚æœè¿™ä¸ª leader çš„ä»»æœŸå·ï¼ˆè¿™ä¸ªä»»æœŸå·ä¼šåœ¨è¿™æ¬¡ RPC ä¸­æºå¸¦ç€ï¼‰ä¸å°äºè¿™ä¸ª candidate çš„å½“å‰ä»»æœŸå·ï¼Œé‚£ä¹ˆè¿™ä¸ª candidate å°±ä¼šè§‰å¾—è¿™ä¸ª leader æ˜¯åˆæ³•çš„ï¼Œç„¶åå°†è‡ªå·±è½¬å˜ä¸º follower çŠ¶æ€ã€‚ å¦‚æœè¿™ä¸ª leader çš„ä»»æœŸå·å°äºè¿™ä¸ª candidate çš„å½“å‰ä»»æœŸå·ï¼Œé‚£ä¹ˆè¿™ä¸ª candidate å°±ä¼šæ‹’ç»è¿™æ¬¡ RPCï¼Œç„¶åç»§ç»­ä¿æŒ candidate çŠ¶æ€ã€‚ ç¬¬ä¸‰ç§å¯èƒ½çš„ç»“æœæ˜¯ candidate æ—¢æ²¡æœ‰èµ¢å¾—é€‰ä¸¾ä¹Ÿæ²¡æœ‰è¾“ã€‚å¯ä»¥è®¾æƒ³ä¸€ä¸‹è¿™ä¹ˆä¸€ä¸ªæƒ…å†µã€‚æ‰€æœ‰çš„ follower åŒæ—¶å˜æˆ candidateï¼Œç„¶åå®ƒä»¬éƒ½å°†ç¥¨æŠ•ç»™è‡ªå·±ï¼Œé‚£è¿™æ ·å°±æ²¡æœ‰ candidate èƒ½å¾—åˆ°è¶…è¿‡åŠæ•°çš„æŠ•ç¥¨äº†ï¼ŒæŠ•ç¥¨æ— æœã€‚å½“è¿™ç§æƒ…å†µå‘ç”Ÿçš„æ—¶å€™ï¼Œæ¯ä¸ª candidate éƒ½ä¼šè¿›è¡Œä¸€æ¬¡è¶…æ—¶å“åº”ï¼ˆtime outï¼‰ï¼Œç„¶åé€šè¿‡è‡ªå¢ä»»æœŸå·æ¥å¼€å¯ä¸€è½®æ–°çš„é€‰ä¸¾ï¼Œå¹¶å¯åŠ¨å¦ä¸€è½®çš„ RequestVote RPCsã€‚ç„¶è€Œï¼Œå¦‚æœæ²¡æœ‰é¢å¤–çš„æªæ–½ï¼Œè¿™ç§æ— ç»“æœçš„æŠ•ç¥¨å¯èƒ½ä¼šæ— é™é‡å¤ä¸‹å»ã€‚ ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼ŒRaft é‡‡ç”¨ éšæœºé€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼ˆrandomized election timeoutsï¼‰ æ¥ç¡®ä¿å¾ˆå°‘å‘ç”Ÿæ— æœçš„æŠ•ç¥¨ï¼Œå¹¶ä¸”å°±ç®—å‘ç”Ÿäº†ä¹Ÿèƒ½å¾ˆå¿«åœ°è§£å†³ã€‚ä¸ºäº†é˜²æ­¢é€‰ç¥¨ä¸€å¼€å§‹å°±è¢«ç“œåˆ†ï¼Œé€‰ä¸¾è¶…æ—¶æ—¶é—´æ˜¯ä»ä¸€ä¸ªå›ºå®šçš„åŒºé—´ï¼ˆæ¯”å¦‚ï¼Œ150-300msï¼‰ä¸­éšæœºé€‰æ‹©ã€‚è¿™æ ·å¯ä»¥æŠŠæœåŠ¡å™¨åˆ†æ•£å¼€æ¥ä»¥ç¡®ä¿åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ä¼šåªæœ‰ä¸€ä¸ªæœåŠ¡å™¨ç‡å…ˆç»“æŸè¶…æ—¶ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼Œå®ƒå°±å¯ä»¥èµ¢å¾—é€‰ä¸¾å¹¶åœ¨å…¶ä»–æœåŠ¡å™¨ç»“æŸè¶…æ—¶ä¹‹å‰å‘é€å¿ƒè·³ï¼ˆè¯‘è€…æ³¨ï¼šä¹˜è™šè€Œå…¥ï¼Œä¸è®²æ­¦å¾·ï¼‰ã€‚ åŒæ ·çš„æœºåˆ¶ä¹Ÿå¯ä»¥è¢«ç”¨æ¥è§£å†³é€‰ç¥¨è¢«ç“œåˆ†ï¼ˆsplit votesï¼‰çš„æƒ…å†µã€‚æ¯ä¸ª candidate åœ¨å¼€å§‹ä¸€è½®é€‰ä¸¾ä¹‹å‰ä¼šé‡ç½®ä¸€ä¸ªéšæœºé€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼Œç„¶åä¸€ç›´ç­‰å¾…ç›´åˆ°ç»“æŸè¶…æ—¶çŠ¶æ€ã€‚è¿™æ ·å‡å°‘äº†åœ¨ä¸€æ¬¡æŠ•ç¥¨æ— æœåå†ä¸€æ¬¡æŠ•ç¥¨æ— æœçš„å¯èƒ½æ€§ã€‚9.3 èŠ‚å±•ç¤ºäº†è¯¥æ–¹æ¡ˆèƒ½å¤Ÿå¿«é€Ÿåœ°é€‰å‡ºä¸€ä¸ª leaderã€‚ é€‰ä¸¾çš„ä¾‹å­å¯ä»¥å¾ˆå¥½åœ°å±•ç°å¯ç†è§£æ€§æ˜¯å¦‚ä½•æŒ‡å¯¼æˆ‘ä»¬åœ¨å¤šç§å¤‡é€‰è®¾è®¡æ–¹æ¡ˆä¸­åšå‡ºæŠ‰æ‹©çš„ã€‚åœ¨ä¸€å¼€å§‹ï¼Œæˆ‘ä»¬æœ¬æ‰“ç®—ä½¿ç”¨ä¸€ç§ç­‰çº§ç³»ç»Ÿï¼ˆrank systemï¼‰ï¼šæ¯ä¸€ä¸ª candidate è¢«èµ‹äºˆä¸€ä¸ªä¸€æ¬¡çš„ç­‰çº§ï¼ˆrankï¼‰ï¼Œå¦‚æœä¸€ä¸ª candidate å‘ç°å¦å¤–ä¸€ä¸ª candidate æœ‰ç€æ›´é«˜çš„ç™»è®°ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šè¿”å› follower çŠ¶æ€ï¼Œè¿™æ ·å¯ä»¥ä½¿é«˜ç­‰çº§çš„ candidate æ›´åŠ å®¹æ˜“åœ°èµ¢å¾—ä¸‹ä¸€è½®é€‰ä¸¾ã€‚ä½†æ˜¯æˆ‘ä»¬å‘ç°è¿™ç§æ–¹æ³•åœ¨å¯ç”¨æ€§æ–¹é¢ä¼šæœ‰ä¸€äº›å°é—®é¢˜ï¼š å¦‚æœç­‰çº§è¾ƒé«˜çš„æœåŠ¡å™¨å´©æºƒäº†ï¼Œé‚£ä¹ˆç­‰çº§è¾ƒä½çš„æœåŠ¡å™¨å¯èƒ½éœ€è¦è¿›å…¥è¶…æ—¶çŠ¶æ€ï¼Œç„¶åé‡æ–°æˆä¸ºä¸€ä¸ª candidateã€‚å¦‚æœè¿™ç§æ“ä½œå‡ºç°å¾—å¤ªå¿«ï¼Œé‚£ä¹ˆå®ƒå¯èƒ½ä¼šé‡å¯è¿›ç¨‹å»å¼€å¯ä¸€è½®æ–°çš„é€‰ä¸¾ã€‚ ç»è¿‡æˆ‘ä»¬å¯¹è¯¥ç®—æ³•åšå‡ºäº†å¤šæ¬¡çš„è°ƒæ•´ï¼Œæˆ‘ä»¬æœ€ç»ˆè¿˜æ˜¯è®¤ä¸ºéšæœºé‡è¯•çš„æ–¹æ³•æ›´åŠ é€šä¿—æ˜“æ‡‚ã€‚ 5.3 Log replication Leader ä¸€æ—¦è¢«é€‰ä¸¾å‡ºæ¥ï¼Œå®ƒå°±è¦å¼€å§‹ä¸ºå®¢æˆ·ç«¯çš„è¯·æ±‚æä¾›æœåŠ¡äº†ã€‚æ¯ä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚éƒ½åŒ…å«ä¸€æ¡å°†è¢«å¤åˆ¶çŠ¶æ€æœºæ‰§è¡Œçš„å‘½ä»¤ã€‚leader ä¼šä»¥ä¸€ä¸ªæ–°æ¡ç›®çš„æ–¹å¼å°†è¯¥å‘½ä»¤è¿½åŠ åˆ°è‡ªå·±çš„æ—¥å¿—ä¸­ï¼Œå¹¶ä¸”ä»¥åŒæ­¥çš„æ–¹å¼å‘é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹å‘èµ· AppendEntires RPCsï¼Œè®©å®ƒä»¬å¤åˆ¶è¯¥æ¡ç›®ã€‚å½“æ¡ç›®è¢«å®‰å…¨åœ°å¤åˆ¶ï¼ˆä½•ä¸ºå®‰å…¨å¤åˆ¶ï¼Œåé¢ä¼šä»‹ç»ï¼‰ä¹‹åï¼Œleader ä¼šå°†è¯¥æ¡ç›®åº”ç”¨åˆ°è‡ªå·±çš„çŠ¶æ€æœºä¸­ï¼ŒçŠ¶æ€æœºæ‰§è¡Œè¯¥æŒ‡ä»¤ï¼Œç„¶åæŠŠæ‰§è¡Œçš„ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚å¦‚æœ follower å´©æºƒäº†æˆ–è€…è¿è¡Œç¼“æ…¢ï¼Œæˆ–è€…ç½‘ç»œä¸¢åŒ…ï¼Œleader ä¼šä¸æ–­åœ°é‡è¯• AppendEntiries RPCsï¼ˆå³ä½¿å·²ç»å¯¹å®¢æˆ·ç«¯ä½œå‡ºäº†å“åº”ï¼‰ç›´åˆ°æ‰€æœ‰çš„ follower éƒ½æˆåŠŸå­˜å‚¨äº†æ‰€æœ‰çš„æ—¥å¿—æ¡ç›®ã€‚ æ—¥å¿—ä»¥å›¾ 6 å±•ç¤ºçš„æ–¹å¼ç»„ç»‡ç€ã€‚æ¯æ¡æ—¥å¿—æ¡ç›®éƒ½å­˜å‚¨ç€ä¸€æ¡çŠ¶æ€æœºæŒ‡ä»¤å’Œ leader æ”¶åˆ°è¯¥æŒ‡å®šæ—¶çš„ä»»æœŸå·ã€‚æ—¥å¿—æ¡ç›®ä¸­çš„ä»»æœŸå·å¯ä»¥ç”¨æ¥æ£€æµ‹å¤šä¸ªæ—¥å¿—å‰¯æœ¬ä¹‹é—´æ˜¯å¦ä¸ä¸€è‡´ï¼Œä»¥æ­¤æ¥ä¿è¯å›¾ 3 ä¸­çš„æŸäº›æ€§è´¨ã€‚æ¯ä¸ªæ—¥å¿—æ¡ç›®è¿˜æœ‰ä¸€ä¸ªæ•´æ•°ç´¢å¼•å€¼æ¥è¡¨æ˜å®ƒåœ¨æ—¥å¿—ä¸­çš„ä½ç½®ã€‚ image-20210709165036190 é‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼Œleader ä»€ä¹ˆæ—¶å€™ä¼šè§‰å¾—æŠŠæ—¥å¿—æ¡ç›®åº”ç”¨åˆ°çŠ¶æ€æœºæ˜¯å®‰å…¨çš„å‘¢ï¼Ÿ è¿™ç§æ—¥å¿—æ¡ç›®è¢«ç§°ä¸ºå·²æäº¤çš„æ—¥å¿—æ¡ç›®ã€‚Raft ä¿è¯è¿™ç§å·²æäº¤çš„æ—¥å¿—æ¡ç›®éƒ½æ˜¯æŒä¹…åŒ–çš„å¹¶ä¸”æœ€ç»ˆéƒ½ä¼šè¢«æ‰€æœ‰å¯ç”¨çš„çŠ¶æ€æœºæ‰§è¡Œã€‚ ä¸€æ—¦åˆ›å»ºè¯¥æ—¥å¿—æ¡ç›®çš„ leader å°†å®ƒå¤åˆ¶åˆ°è¿‡åŠçš„èŠ‚ç‚¹ä¸Šæ—¶ï¼ˆæ¯”å¦‚å›¾ 6 ä¸­çš„æ¡ç›® 7ï¼‰ï¼Œè¯¥æ—¥å¿—æ¡ç›®å°±ä¼šè¢«æäº¤ã€‚ åŒæ—¶ï¼Œleader æ—¥å¿—ä¸­è¯¥æ—¥å¿—æ¡ç›®ä¹‹å‰çš„æ‰€æœ‰æ—¥å¿—æ¡ç›®ä¹Ÿéƒ½ä¼šè¢«æäº¤ï¼ŒåŒ…æ‹¬ç”±ä¹‹å‰çš„å…¶ä»– leader åˆ›å»ºçš„æ—¥å¿—æ¡ç›®ã€‚5.4 èŠ‚ä¼šè®¨è®ºåœ¨ leader å˜æ›´ä¹‹ååº”ç”¨è¯¥è§„åˆ™çš„ä¸€äº›ç»†èŠ‚ï¼Œå¹¶è¯æ˜è¿™ç§æäº¤çš„è§„åˆ™æ˜¯å®‰å…¨çš„ã€‚leader ä¼šè¿½è¸ªå®ƒæ‰€çŸ¥é“çš„è¦æäº¤çš„æœ€é«˜ç´¢å¼•ï¼Œå¹¶å°†è¯¥ç´¢å¼•åŒ…å«åœ¨æœªæ¥çš„ AppendEntries RPC ä¸­ï¼ˆåŒ…æ‹¬å¿ƒè·³ï¼‰ï¼Œä»¥ä¾¿å…¶ä»–çš„èŠ‚ç‚¹å¯ä»¥å‘ç°è¿™ä¸ªç´¢å¼•ã€‚ä¸€æ—¦ä¸€ä¸ª follower çŸ¥é“äº†ä¸€ä¸ªæ—¥å¿—æ¡ç›®è¢«æäº¤äº†ã€‚å®ƒå°±ä¼šå°†è¯¥æ—¥å¿—æ¡ç›®æŒ‰æ—¥å¿—é¡ºåºåº”ç”¨åˆ°è‡ªå·±çš„çŠ¶æ€æœºä¸­ã€‚ æˆ‘ä»¬è®¾è®¡ Raft æ—¥å¿—æœºåˆ¶æ¥ä½¿å¾—ä¸åŒèŠ‚ç‚¹ä¸Šçš„æ—¥å¿—ä¹‹é—´å¯ä»¥ä¿æŒé«˜æ°´å¹³çš„ä¸€è‡´æ€§ã€‚è¿™ä¹ˆåšä¸ä»…ç®€åŒ–äº†ç³»ç»Ÿçš„è¡Œä¸ºä¹Ÿä½¿å¾—ç³»ç»Ÿæ›´åŠ å¯é¢„æµ‹ï¼ŒåŒæ—¶è¯¥æœºåˆ¶ä¹Ÿæ˜¯ä¿è¯å®‰å…¨æ€§çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚Raft ä¼šä¸€ç›´ç»´æŠ¤ç€ä»¥ä¸‹çš„ç‰¹æ€§ï¼Œè¿™äº›ç‰¹æ€§ä¹ŸåŒæ—¶æ„æˆäº†å›¾ 3 ä¸­çš„æ—¥å¿—åŒ¹é…ç‰¹æ€§ï¼ˆLog Matching Propertyï¼‰ï¼š å¦‚æœä¸åŒæ—¥å¿—ä¸­çš„ä¸¤ä¸ªæ¡ç›®æœ‰ç€ç›¸åŒçš„ç´¢å¼•å’Œä»»æœŸå€¼ï¼Œé‚£ä¹ˆå®ƒä»¬å°±å­˜å‚¨ç€ç›¸åŒçš„å‘½ä»¤ å¦‚æœä¸åŒæ—¥å¿—ä¸­çš„ä¸¤ä¸ªæ¡ç›®æœ‰ç€ç›¸åŒçš„ç´¢å¼•å’Œä»»æœŸå€¼ï¼Œé‚£ä¹ˆä»–ä»¬ä¹‹å‰çš„æ‰€æœ‰æ—¥å¿—æ¡ç›®ä¹Ÿéƒ½ç›¸åŒ ç¬¬ä¸€æ¡ç‰¹æ€§æºäºè¿™æ ·ä¸€ä¸ªäº‹å®ï¼Œåœ¨ç»™å®šçš„ä¸€ä¸ªä»»æœŸå€¼å’Œç»™å®šçš„ä¸€ä¸ªæ—¥å¿—ç´¢å¼•ä¸­ï¼Œä¸€ä¸ª leader æœ€å¤šåˆ›å»ºä¸€ä¸ªæ—¥å¿—æ¡ç›®ï¼Œè€Œä¸”æ—¥å¿—æ¡ç›®æ°¸è¿œä¸ä¼šæ”¹å˜å®ƒä»¬åœ¨æ—¥å¿—ä¸­çš„ä½ç½®ã€‚ ç¬¬äºŒæ¡ç‰¹æ€§æ˜¯ç”± AppendEntries RPC æ‰§è¡Œçš„ä¸€ä¸ªç®€å•çš„ä¸€è‡´æ€§æ£€æŸ¥æ‰€ä¿è¯çš„ã€‚å½“ leader å‘é€ä¸€ä¸ª AppendEntries RPC çš„æ—¶å€™ï¼Œleader ä¼šå°†å‰ä¸€ä¸ªæ—¥å¿—æ¡ç›®çš„ç´¢å¼•ä½ç½®å’Œä»»æœŸå·åŒ…å«åœ¨é‡Œé¢ï¼ˆç´§é‚»æœ€æ–°çš„æ—¥å¿—æ¡ç›®ï¼‰ã€‚å¦‚æœä¸€ä¸ª follower åœ¨å®ƒçš„æ—¥å¿—ä¸­æ‰¾ä¸åˆ°åŒ…å«ç›¸åŒç´¢å¼•ä½ç½®å’Œä»»æœŸå·çš„æ¡ç›®ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šæ‹’ç»è¯¥æ–°çš„æ—¥å¿—æ¡ç›®ã€‚ä¸€è‡´æ€§æ£€æŸ¥å°±åƒä¸€ä¸ªå½’çº³æ­¥éª¤ï¼šä¸€å¼€å§‹ç©ºçš„æ—¥å¿—çŠ¶æ€è‚¯å®šæ˜¯æ»¡è¶³æ—¥å¿—åŒ¹é…ç‰¹æ€§ï¼ˆLog Matching Propertyï¼‰çš„ï¼Œç„¶åä¸€è‡´æ€§æ£€æŸ¥ä¿è¯äº†æ—¥å¿—æ‰©å±•æ—¶çš„æ—¥å¿—åŒ¹é…ç‰¹æ€§ã€‚å› æ­¤ï¼Œå½“ AppendEntries RPC è¿”å›æˆåŠŸæ—¶ï¼Œleader å°±çŸ¥é“ follower çš„æ—¥å¿—ä¸€å®šå’Œè‡ªå·±ç›¸åŒï¼ˆä»ç¬¬ä¸€ä¸ªæ—¥å¿—æ¡ç›®åˆ°æœ€æ–°æ¡ç›®ï¼‰ã€‚ æ­£å¸¸æ“ä½œæœŸé—´ï¼Œleader å’Œ follower çš„æ—¥å¿—éƒ½æ˜¯ä¿æŒä¸€è‡´çš„ï¼Œæ‰€ä»¥ AppendEntries çš„ä¸€è‡´æ€§æ£€æŸ¥ä»æ¥ä¸ä¼šå¤±è´¥ã€‚ä½†æ˜¯ï¼Œå¦‚æœ leader å´©æºƒäº†ï¼Œé‚£ä¹ˆå°±æœ‰å¯èƒ½ä¼šé€ æˆæ—¥å¿—å¤„äºä¸ä¸€è‡´çš„çŠ¶æ€ï¼Œæ¯”å¦‚è¯´è€çš„ leader å¯èƒ½è¿˜æ²¡æœ‰å®Œå…¨å¤åˆ¶å®ƒæ—¥å¿—ä¸­çš„æ‰€æœ‰æ¡ç›®å®ƒå°±å´©æºƒäº†ã€‚è¿™äº›ä¸ä¸€è‡´çš„æƒ…å†µä¼šåœ¨ä¸€ç³»åˆ—çš„ leader å’Œ follower å´©æºƒçš„æƒ…å†µä¸‹åŠ å‰§ã€‚å›¾ 7 è§£é‡Šäº†ä»€ä¹ˆæƒ…å†µä¸‹ follower çš„æ—¥å¿—å¯èƒ½å’Œæ–°çš„ leader çš„æ—¥å¿—ä¸åŒã€‚follower å¯èƒ½ä¼šç¡®å®ä¸€äº›åœ¨æ–° leader ä¸­æœ‰çš„æ—¥å¿—æ¡ç›®ï¼Œä¹Ÿæœ‰å¯èƒ½æ‹¥æœ‰ä¸€äº›æ–°çš„ leader æ²¡æœ‰çš„æ—¥å¿—æ¡ç›®ï¼Œæˆ–è€…åŒæ—¶å­˜åœ¨ã€‚ç¼ºå¤±æˆ–å¤šå‡ºæ—¥å¿—æ¡ç›®çš„æƒ…å†µæœ‰å¯èƒ½ä¼šæ¶‰åŠåˆ°å¤šä¸ªä»»æœŸã€‚ image-20210712144330139 åœ¨ Raft ç®—æ³•ä¸­ï¼Œleader é€šè¿‡å¼ºåˆ¶ follower å¤åˆ¶ leader æ—¥å¿—æ¥è§£å†³æ—¥å¿—ä¸ä¸€è‡´çš„é—®é¢˜ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œfollower ä¸­è·Ÿ leader å†²çªçš„æ—¥å¿—æ¡ç›®ä¼šè¢« leader çš„æ—¥å¿—æ¡ç›®æ‰€è¦†ç›–ã€‚5.4 èŠ‚ä¼šè¯æ˜é€šè¿‡å¢åŠ ä¸€ä¸ªé™åˆ¶ï¼Œè¿™ç§æ–¹å¼å°±å¯ä»¥ä¿è¯å®‰å…¨æ€§ã€‚ ä¸ºäº†ä½¿ follower çš„æ—¥å¿—è·Ÿè‡ªå·±ï¼ˆleaderï¼‰ä¸€è‡´ï¼Œleader å¿…é¡»æ‰¾åˆ°ä¸¤è€…è¾¾æˆä¸€è‡´çš„æœ€å¤§çš„æ—¥å¿—æ¡ç›®ç´¢å¼•ï¼Œåˆ é™¤ follower æ—¥å¿—ä¸­ä»é‚£ä¸ªç´¢å¼•ä¹‹åçš„æ‰€æœ‰æ—¥å¿—æ¡ç›®ï¼Œå¹¶ä¸”å°†è‡ªå·±é‚£ä¸ªç´¢å¼•ä¹‹åçš„æ‰€æœ‰æ—¥å¿—æ¡ç›®å‘é€ç»™ followerã€‚æ‰€æœ‰çš„è¿™äº›æ“ä½œéƒ½å‘ç”Ÿåœ¨ AppendEntries RPCs çš„ä¸€è‡´æ€§æ£€æŸ¥çš„å›å¤ä¸­ã€‚leader ç»´æŠ¤ç€ä¸€ä¸ªé’ˆå¯¹æ¯ä¸€ä¸ª follower çš„ nextIndexï¼Œè¿™ä¸ª nextIndex ä»£è¡¨çš„å°±æ˜¯ leader è¦å‘é€ç»™ follower çš„ä¸‹ä¸€ä¸ªæ—¥å¿—æ¡ç›®çš„ç´¢å¼•ã€‚å½“é€‰å‡ºä¸€ä¸ªæ–°çš„ leader æ—¶ï¼Œè¯¥ leader å°†æ‰€æœ‰çš„ nextIndex çš„å€¼éƒ½åˆå§‹åŒ–ä¸ºè‡ªå·±æœ€åä¸€ä¸ªæ—¥å¿—æ¡ç›®çš„ index åŠ  1ï¼ˆå›¾7 ä¸­çš„ 11ï¼‰ã€‚å¦‚æœä¸€ä¸ª follower çš„æ—¥å¿—è·Ÿ leader çš„æ˜¯ä¸ä¸€è‡´çš„ï¼Œé‚£ä¹ˆä¸‹ä¸€æ¬¡çš„ AppendEntries RPC çš„ä¸€è‡´æ€§æ£€æŸ¥å°±ä¼šå¤±è´¥ã€‚AppendEntries RPC åœ¨è¢« follower æ‹’ç»ä¹‹åï¼Œleader å¯¹ nextIndex è¿›è¡Œå‡ 1ï¼Œç„¶åé‡è¯• AppendEntries RPCã€‚æœ€ç»ˆ nextIndex ä¼šåœ¨æŸä¸ªä½ç½®æ»¡è¶³ leader å’Œ follower åœ¨è¯¥ä½ç½®åŠä¹‹å‰çš„æ—¥å¿—æ˜¯ä¸€è‡´çš„ï¼Œæ­¤æ—¶ï¼ŒAppendEntries RPC å°±ä¼šæˆåŠŸï¼Œå°† follower è·Ÿ leader å†²çªçš„æ—¥å¿—æ¡ç›®å…¨éƒ¨åˆ é™¤ç„¶åè¿½åŠ  leader ä¸­çš„æ—¥å¿—æ¡ç›®ï¼ˆéœ€è¦çš„è¯ï¼‰ã€‚ä¸€æ—¦ AppendEntries RPC æˆåŠŸï¼Œfollower çš„æ—¥å¿—å°±å’Œ leader çš„ä¸€è‡´äº†ï¼Œå¹¶ä¸”åœ¨è¯¥ä»»æœŸæ¥ä¸‹æ¥çš„æ—¶é—´é‡Œéƒ½ä¿æŒä¸€è‡´ã€‚ å¦‚æœéœ€è¦çš„è¯ï¼Œä¸‹é¢çš„åè®®å¯ä»¥ç”¨æ¥ä¼˜åŒ–è¢«æ‹’ç»çš„ AppendEntries RPCs çš„ä¸ªæ•°ã€‚ æ¯”å¦‚è¯´ï¼Œå½“æ‹’ç»ä¸€ä¸ª AppendEntries RPC çš„æ—¶å€™ï¼Œfollower å¯ä»¥åŒ…å«å†²çªæ¡ç›®çš„ä»»æœŸå·å’Œè‡ªå·±å­˜å‚¨çš„é‚£ä¸ªä»»æœŸçš„ç¬¬ä¸€ä¸ª indexã€‚å€ŸåŠ©è¿™äº›ä¿¡æ¯ï¼Œleader å¯ä»¥è·³è¿‡é‚£ä¸ªä»»æœŸå†…æ‰€æœ‰çš„æ—¥å¿—æ¡ç›®æ¥å‡å°‘ indexIndexã€‚è¿™æ ·å°±å˜æˆäº†æ¯ä¸ªæœ‰å†²çªæ—¥å¿—æ¡ç›®çš„ä»»æœŸåªéœ€è¦ä¸€ä¸ª AppendEntries RPCï¼Œè€Œä¸æ˜¯æ¯ä¸€ä¸ªæ—¥å¿—æ¡ç›®éƒ½éœ€è¦ä¸€æ¬¡ AppendEntires RPCã€‚ åœ¨å®è·µä¸­ï¼Œæˆ‘ä»¬è®¤ä¸ºè¿™ç§ä¼˜åŒ–æ˜¯æ²¡æœ‰å¿…è¦çš„ï¼Œå› ä¸ºå¤±è´¥ä¸ç»å¸¸å‘ç”Ÿå¹¶ä¸”ä¹Ÿä¸å¯èƒ½æœ‰å¾ˆå¤šä¸ä¸€è‡´çš„æ—¥å¿—æ¡ç›®ã€‚ é€šè¿‡ä¸Šè¿°æœºåˆ¶ï¼Œleader åœ¨å½“æƒä¹‹åå°±ä¸éœ€è¦ä»»ä½•ç‰¹æ®Šçš„æ“ä½œæ¥ä½¿æ—¥å¿—æ¢å¤åˆ°ä¸€è‡´çŠ¶æ€ã€‚leader åªéœ€è¿›è¡Œæ­£å¸¸çš„æ“ä½œï¼Œç„¶åæ—¥å¿—å°±èƒ½åœ¨å›å¤ AppendEntries RPC ä¸€è‡´æ€§æ£€æŸ¥çš„æ—¶å€™è‡ªåŠ¨è¶‹äºä¸€è‡´ã€‚leader ä»æ¥ä¸ä¼šé‡å†™æˆ–è€…åˆ é™¤è‡ªå·±çš„æ—¥å¿—æ¡ç›®ï¼ˆå›¾3 ä¸­çš„ Leader Append-Only å±æ€§ï¼‰ã€‚ ä¸Šè¿°è¿™ç§æ—¥å¿—å¤åˆ¶æœºåˆ¶å±•ç°äº†ç¬¬ 2 èŠ‚ä¸­æè¿°çš„ Raft ç®—æ³•çš„å…±è¯†ç‰¹æ€§ï¼šåªè¦è¿‡åŠçš„èŠ‚ç‚¹èƒ½æ­£å¸¸è¿è¡Œï¼ŒRaft å°±èƒ½æ¥å—ã€å¤åˆ¶å¹¶å¤„ç†æ–°çš„æ—¥å¿—æ¡ç›®ã€‚åœ¨é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªæ–°çš„æ¡ç›®å¯ä»¥åœ¨ä¸€è½® RPC ä¸­è¢«å¤åˆ¶ç»™é›†ç¾¤ä¸­è¿‡åŠçš„èŠ‚ç‚¹ï¼Œå¹¶ä¸”å•ä¸ªè¿è¡Œç¼“æ…¢çš„ follower å¹¶ä¸ä¼šå½±å“æ•´ä¸ªé›†ç¾¤çš„æ€§èƒ½ã€‚ è¯‘è€…æ³¨ï¼šæ€»ç»“ Leader æ”¶åˆ° Client çš„å†™è¯·æ±‚ï¼Œå‘æ‰€æœ‰ Follower å‘èµ·ä¸€ä¸ªæ—¥å¿—åŒæ­¥è¯·æ±‚ï¼Œå¾—åˆ°é›†ç¾¤å†…è¿‡åŠèŠ‚ç‚¹ï¼ˆåŒ…æ‹¬ Leader è‡ªå·±ï¼‰çš„å“åº”ï¼Œå°±æ¨è¿› commitIndexï¼Œç„¶å apply æ—¥å¿—åˆ°çŠ¶æ€æœºï¼Œå†æ¨è¿› applyIndexï¼Œè¿”å› Client æˆåŠŸã€‚ çŠ¶æ€æœºåŒæ­¥åˆ†ä¸ºä¸¤è½® RPC å¹¿æ’­ï¼š ç¬¬ä¸€è½®ï¼šåŒæ­¥æ—¥å¿— AppendEntriesï¼Œå¾—åˆ°è¿‡åŠèŠ‚ç‚¹å›å¤ï¼ŒLeader çŠ¶æ€æœºæ¨è¿›ï¼Œè¿”å› Client æˆåŠŸã€‚ ç¬¬äºŒè½®ï¼šåœ¨ä¸‹ä¸€æ¬¡çš„ AppendEntries ä¸­é™„å¸¦ä¸Šä¸€æ¬¡çš„ commitIndexï¼ŒFollower æ”¶åˆ°åï¼Œapply æ—¥å¿—æ¡ç›®åˆ°å„è‡ªçš„çŠ¶æ€æœºã€‚ 5.4 Safety å‰é¢çš„ç« èŠ‚æè¿°äº† Raft å¦‚ä½•åš Leader Election å’Œ Log Replicationã€‚ç„¶è€Œï¼Œåˆ°ç›®å‰ä¸ºæ­¢æ‰€è®¨è®ºçš„æœºåˆ¶å¹¶ä¸èƒ½å……åˆ†åœ°ä¿è¯æ¯ä¸€ä¸ªçŠ¶æ€æœºä¼šæŒ‰ç›¸åŒçš„é¡ºåºæ‰§è¡Œç›¸åŒçš„æŒ‡ä»¤ã€‚æ¯”å¦‚è¯´ï¼Œä¸€ä¸ª follower å¯èƒ½ä¼šè¿›å…¥ä¸å¯ç”¨çŠ¶æ€ï¼Œåœ¨æ­¤æœŸé—´ï¼Œleader å¯èƒ½æäº¤äº†è‹¥å¹²çš„æ—¥å¿—æ¡ç›®ï¼Œç„¶åè¿™ä¸ª follower å¯èƒ½è¢«é€‰ä¸¾ä¸ºæ–°çš„ leader å¹¶ä¸”ç”¨æ–°çš„æ—¥å¿—æ¡ç›®å»è¦†ç›–è¿™äº›æ—¥å¿—æ¡ç›®ã€‚è¿™æ ·å°±ä¼šé€ æˆä¸åŒçš„çŠ¶æ€æœºæ‰§è¡Œä¸åŒçš„æŒ‡ä»¤çš„æƒ…å†µã€‚ æœ¬èŠ‚é€šè¿‡å¯¹ Leader Election å¢åŠ ä¸€ä¸ªé™åˆ¶æ¥å®Œå–„ Raft ç®—æ³•ã€‚è¿™ä¸ªé™åˆ¶ä¿è¯äº†å¯¹äºç»™å®šçš„ä»»æ„ä»»æœŸå·ï¼Œè¯¥ä»»æœŸå·å¯¹åº”çš„ leader éƒ½åŒ…å«äº†ä¹‹å‰å„ä¸ªä»»æœŸæ‰€æœ‰è¢«æäº¤çš„æ—¥å¿—æ¡ç›®ï¼ˆå›¾3 ä¸­çš„ Leader Completeness æ€§è´¨ï¼‰ã€‚æœ‰äº†è¿™ä¸ªé™åˆ¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿æ—¥å¿—æäº¤è§„åˆ™æ›´åŠ æ¸…æ™°ã€‚æœ€åï¼Œæˆ‘ä»¬ä¼šå±•ç¤ºå¯¹äº Leader Completeness æ€§è´¨çš„ç®€è¦è¯æ˜å¹¶ä¸”è¯´è¯¥æ€§è´¨æ˜¯å¦‚ä½•ä¿è¯çŠ¶æ€æœºæ‰§è¡Œæ­£ç¡®çš„è¡Œä¸ºçš„ã€‚ 5.4.1 é€‰ä¸¾é™åˆ¶ åœ¨ä»»ä½•åŸºäº leader çš„å…±è¯†ç®—æ³•ä¸­ï¼Œleader æœ€ç»ˆéƒ½å¿…é¡»å­˜å‚¨æ‰€æœ‰å·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®ã€‚åœ¨æŸäº›å…±è¯†ç®—æ³•ä¸­ï¼Œä¾‹å¦‚ Viewstamped Replication [22]ï¼Œå³ä½¿ä¸€ä¸ªèŠ‚ç‚¹å®ƒä¸€å¼€å§‹å¹¶æ²¡æœ‰åŒ…å«æ‰€æœ‰å·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®ï¼Œå®ƒä¹Ÿæœ‰å¯èƒ½è¢«é€‰ä¸¾ä¸º leaderã€‚è¿™äº›ç®—æ³•åŒ…å«ä¸€äº›é¢å¤–çš„æœºåˆ¶æ¥è¯†åˆ«ä¸¢å¤±çš„æ—¥å¿—æ¡ç›®å¹¶å°†å®ƒä»¬ä¼ é€ç»™æ–°çš„ leaderï¼Œè¿™ä¸ªæœºåˆ¶è¦ä¹ˆå‘ç”Ÿåœ¨é€‰ä¸¾é˜¶æ®µï¼Œè¦ä¹ˆåœ¨é€‰ä¸¾å®Œæˆä¹‹åå¾ˆå¿«è¿›è¡Œã€‚æ¯”è¾ƒé—æ†¾çš„æ˜¯ï¼Œè¿™ç§æ–¹æ³•ä¼šå¢åŠ è®¸å¤šé¢å¤–çš„æœºåˆ¶ï¼Œä½¿å¾—ç®—æ³•å¤æ‚æ€§å¤§å¤§å¢åŠ ã€‚Raft ä½¿ç”¨äº†ä¸€ç§æ›´åŠ ç®€å•çš„æ–¹æ³•ï¼Œå®ƒå¯ä»¥ä¿è¯æ–° leader åœ¨å½“é€‰æ—¶å°±åŒ…å«äº†ä¹‹å‰æ‰€æœ‰ä»»æœŸä¸­å·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®ï¼Œæ ¹æœ¬å°±ä¸éœ€è¦å†ä¼ é€è¿™äº›æ—¥å¿—æ¡ç›®ç»™æ–°çš„ leaderã€‚è¿™å°±æ„å‘³ç€æ—¥å¿—æ¡ç›®çš„ä¼ é€åªæœ‰ä¸€ä¸ªæ–¹å‘ï¼Œé‚£å°±æ˜¯ä» leader åˆ° followerï¼Œleader ä»æ¥ä¸ä¼šè¦†ç›–æœ¬åœ°æ—¥å¿—ä¸­å·²æœ‰çš„æ—¥å¿—ã€‚ Raft é‡‡ç”¨æŠ•ç¥¨çš„æ–¹å¼æ¥ä¿è¯ä¸€ä¸ª candidate åªæœ‰æ‹¥æœ‰ä¹‹å‰æ‰€æœ‰ä»»æœŸä¸­å·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®ä¹‹åï¼Œæ‰æœ‰å¯èƒ½èµ¢å¾—é€‰ä¸¾ã€‚ä¸€ä¸ª candidate å¦‚æœæƒ³è¦è¢«é€‰ä¸º leaderï¼Œé‚£å®ƒå°±å¿…é¡»è·Ÿé›†ç¾¤ä¸­è¶…è¿‡åŠæ•°çš„èŠ‚ç‚¹è¿›è¡Œé€šä¿¡ï¼Œè¿™å°±æ„å‘³è¿™äº›èŠ‚ç‚¹ä¸­è‡³å°‘ä¸€ä¸ªåŒ…å«äº†æ‰€æœ‰å·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®ã€‚å¦‚æœ candidate çš„æ—¥å¿—è‡³å°‘è·Ÿè¿‡åŠçš„æœåŠ¡å™¨èŠ‚ç‚¹ä¸€æ ·æ–°ï¼Œé‚£ä¹ˆå®ƒå°±ä¸€å®šåŒ…å«äº†æ‰€æœ‰ä»¥åŠæäº¤çš„æ—¥å¿—æ¡ç›®ï¼Œä¸€æ—¦æœ‰æŠ•ç¥¨è€…è‡ªå·±çš„æ—¥å¿—æ¯” candidate çš„è¿˜æ–°ï¼Œé‚£ä¹ˆè¿™ä¸ªæŠ•ç¥¨è€…å°±ä¼šæ‹’ç»è¯¥æŠ•ç¥¨ï¼Œè¯¥ candidate ä¹Ÿå°±ä¸ä¼šèµ¢å¾—é€‰ä¸¾ã€‚ æ‰€è°“ â€œæ–°â€ ï¼š Raft é€šè¿‡æ¯”è¾ƒä¸¤ä»½æ—¥å¿—ä¸­çš„æœ€åä¸€æ¡æ—¥å¿—æ¡ç›®çš„ç´¢å¼•å’Œä»»æœŸå·æ¥å®šä¹‰è°çš„æ—¥å¿—æ›´æ–°ã€‚ å¦‚æœä¸¤ä»½æ—¥å¿—æœ€åæ¡ç›®çš„ä»»æœŸå·ä¸åŒï¼Œé‚£ä¹ˆä»»æœŸå·å¤§çš„æ—¥å¿—æ›´æ–° å¦‚æœä¸¤ä»½æ—¥å¿—æœ€åæ¡ç›®çš„ä»»æœŸå·ç›¸åŒï¼Œé‚£ä¹ˆè°çš„æ—¥å¿—æ›´é•¿ï¼Œè°å°±æ›´æ–° 5.4.2 æäº¤ä¹‹å‰ä»»æœŸå†…çš„æ—¥å¿—æ¡ç›® è¯‘è€…æ³¨ï¼šæ³¨æ„ï¼è¿™ä¸€èŠ‚ã€Œæäº¤ä¹‹å‰ä»»æœŸå†…çš„æ—¥å¿—æ¡ç›®ã€è¿™ç§æ“ä½œ Raft çš„ä¸å…è®¸çš„ï¼æœ¬å°èŠ‚åªæ˜¯ç”¨æ¥ä¸¾ä¸€ç§é”™è¯¯æƒ…å†µï¼ å¦‚ 5.3 èŠ‚ä¸­æåˆ°çš„é‚£æ ·ï¼Œä¸€æ—¦å½“å‰ä»»æœŸå†…çš„æŸä¸ªæ—¥å¿—æ¡ç›®ä»¥åŠå­˜å‚¨åˆ°è¿‡åŠçš„æœåŠ¡å™¨èŠ‚ç‚¹ä¸Šï¼Œleader å°±çŸ¥é“è¯¥æ—¥å¿—å¯ä»¥è¢«æäº¤äº†ã€‚å¦‚æœè¿™ä¸ª leader åœ¨æäº¤æŸä¸ªæ—¥å¿—æ¡ç›®ä¹‹å‰å´©æºƒäº†ï¼Œä»¥åçš„ leader ä¼šå°è¯•å®Œæˆè¯¥æ—¥å¿—æ¡ç›®çš„å¤åˆ¶ã€‚ç„¶è€Œï¼Œå¦‚æœæ˜¯ä¹‹å‰ä»»æœŸå†…çš„æŸä¸ªæ—¥å¿—æ¡ç›®å·²ç»å­˜å‚¨åˆ°äº†è¿‡åŠçš„æœåŠ¡å™¨èŠ‚ç‚¹ä¸Šäº†ï¼Œæ–°ä»»æœŸå†…çš„ leader ä¹Ÿæ— æ³•ç«‹å³æ–­å®šè¯¥æ—¥å¿—æ¡ç›®å·²ç»è¢«æäº¤äº†ã€‚å›¾ 8 å±•ç¤ºäº†ä¸€ç§æƒ…å†µï¼šä¸€ä¸ªå·²ç»è¢«å­˜å‚¨åˆ°è¿‡åŠèŠ‚ç‚¹çš„è€æ—¥å¿—æ¡ç›®ï¼Œä»ç„¶æœ‰å¯èƒ½ä¼šè¢«æœªæ¥çš„ leader è¦†ç›–æ‰ã€‚ image-20210712160506841 è¯‘è€…æ³¨ï¼šå¯¹å›¾ 8 çš„ç†è§£çš„è¡¥å……ã€‚ å‚è€ƒï¼š çŸ¥ä¹ æ ¸å¿ƒï¼š å›¾ 8 ç”¨æ¥è¯´æ˜ä¸ºä»€ä¹ˆ leader ä¸èƒ½æäº¤ä¹‹å‰ä»»æœŸçš„æ—¥å¿—ï¼Œåªèƒ½é€šè¿‡æäº¤è‡ªå·±ä»»æœŸçš„æ—¥å¿—ï¼Œä»è€Œé—´æ¥æäº¤ä¹‹å‰ä»»æœŸçš„æ—¥å¿—ã€‚ åˆ†æï¼š å…ˆæŒ‰é”™è¯¯çš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯ leader æäº¤ä¹‹å‰ä»»æœŸçš„æ—¥å¿—ï¼Œé‚£ä¹ˆä¸Šè¿°çš„æµç¨‹ï¼š S1 æ˜¯ä»»æœŸ 2 çš„ leaderï¼Œæ—¥å¿—å·²ç»å¤åˆ¶ç»™äº† S2ï¼Œæ­¤æ—¶è¿˜æ²¡è¿‡åŠï¼› S1 å´©æºƒï¼ŒS5 è·å¾—äº† S3ã€S4ã€S5 çš„æŠ•ç¥¨æˆä¸º leaderï¼Œç„¶åå†™äº†ä¸€ä¸ªæ—¥å¿—æ¡ç›®ï¼ˆindex=2ï¼Œterm=3ï¼‰ï¼› S5 åˆšå†™å®Œæ—¥å¿—ï¼Œè¿˜æ²¡æ¥å¾—åŠå¤åˆ¶ï¼Œå°±å´©æºƒäº†ï¼Œæ­¤æ—¶ S1 å’Œ S2 éƒ½å¯èƒ½å½“é€‰ï¼ŒåŠ å…¥ S1 å½“é€‰ï¼ˆcurrentTerm=4ï¼‰ï¼Œæ­¤åˆ»è¿˜æ²¡æœ‰æ–°çš„è¯·æ±‚è¿›æ¥ï¼ŒS1 å°†æ—¥å¿—æ¡ç›®ï¼ˆindex=2ï¼Œterm=2ï¼‰å¤åˆ¶ç»™äº† S3ï¼Œå¤šæ•°æ´¾è¾¾æˆï¼ŒS1 æäº¤äº†è¿™ä¸ªæ—¥å¿—æ¡ç›®ï¼ˆindex=2ï¼Œterm=2ï¼‰ï¼Œ æ³¨æ„ï¼Œè¯¥æ—¥å¿—ä¸æ˜¯å½“å‰ä»»æœŸå†…çš„æ—¥å¿—ï¼Œæˆ‘ä»¬åœ¨è®¨è®ºé”™è¯¯çš„æƒ…å†µï¼ ç„¶åè¯·æ±‚è¿›æ¥ï¼ŒS1 å†™æ—¥å¿—æ¡ç›®ï¼ˆindex=3ï¼Œterm=4ï¼‰ï¼Œç„¶å S1 å´©æºƒã€‚ æƒ…å†µä¸€ï¼š(d) S5 é‡å¯ï¼Œå› ä¸º S5 æœ€åçš„æ—¥å¿—æ¡ç›®çš„ä»»æœŸå·æ¯” S2ã€S3 å¤§ï¼Œæ‰€ä»¥ S5 å¯ä»¥èµ¢å¾—é€‰ä¸¾ï¼ˆcurrentTerm=5ï¼‰ï¼ŒS5 å°†æ—¥å¿—æ¡ç›®ï¼ˆindex=2ï¼Œitem=3ï¼‰å¤åˆ¶ç»™å…¶ä»–æ‰€æœ‰èŠ‚ç‚¹å¹¶æäº¤ï¼Œ æ­¤æ—¶ index=2 çš„æ—¥å¿—æ¡ç›®è¢«æäº¤äº†ä¸¤æ¬¡ï¼ä¸€æ¬¡ term=2ï¼Œä¸€æ¬¡term=3ï¼Œè¿™æ˜¯ä¸è¢«å…è®¸çš„ï¼Œå› ä¸ºå·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®æ˜¯ä¸èƒ½è¢«è¦†ç›–çš„ï¼ âœ–ï¸ æƒ…å†µäºŒï¼š(e) S1 åœ¨å´©æºƒä¹‹å‰å°†è‡ªå·±çš„æ—¥å¿—æ¡ç›®ï¼ˆindex=3ï¼Œterm=4ï¼‰å¤åˆ¶åˆ°äº†è¿‡åŠèŠ‚ç‚¹ä¸Šï¼Œè¿™ç§æƒ…å†µä¸‹ï¼ŒS5 ä¸å¯èƒ½é€‰ä¸¾æˆåŠŸã€‚è¿™æ˜¯ S1 ä¸å‘ç”Ÿæ•…éšœï¼Œè¿™æ˜¯æ­£ç¡®å¤åˆ¶çš„æƒ…å†µã€‚âœ”ï¸ æ‰€ä»¥ ã€Œleader å¯ä»¥æäº¤ä¹‹å‰ä»»æœŸçš„æ—¥å¿—ã€ è¿™ç§æ“ä½œæ˜¯ä¸å…è®¸çš„ï¼Œæˆ‘ä»¬éœ€è¦åŠ ä¸Šçº¦æŸï¼š ã€Œleader åªèƒ½æäº¤è‡ªå·±ä»»æœŸçš„æ—¥å¿—ã€ ã€‚ åŠ äº†çº¦æŸä¹‹åï¼Œå‰é¢çš„ (a) å’Œ (b) æ²¡æœ‰æ”¹å˜ï¼Œä» (c) å¼€å§‹ï¼š S1 è¿˜æ˜¯å°†æ—¥å¿—æ¡ç›®ï¼ˆindex=2ï¼Œterm=2ï¼‰å¤åˆ¶ç»™å…¶ä»–èŠ‚ç‚¹ï¼Œå®ƒå¤åˆ¶ç»™äº† S3ï¼Œæ­¤æ—¶å·²ç»å¤åˆ¶ç»™äº†è¿‡åŠçš„èŠ‚ç‚¹äº†ï¼Œä½†æ˜¯ç”±äº currentTerm=4ï¼Œæ‰€ä»¥ S1 è¿˜æ˜¯ä¸èƒ½æäº¤è¯¥æ—¥å¿—æ¡ç›®ã€‚å¦‚æœ S1 å°†æ—¥å¿—æ¡ç›®ï¼ˆindex=3ï¼Œterm=4ï¼‰ä¹Ÿå¤åˆ¶ç»™äº†è¿‡åŠçš„èŠ‚ç‚¹ï¼ŒS1 æ˜¯å¯ä»¥æäº¤è¯¥æ—¥å¿—æ¡ç›®çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼Œå‰é¢çš„æ—¥å¿—æ¡ç›®ï¼ˆindex=2ï¼Œterm=2ï¼‰ä¹Ÿä¼šè¢«é—´æ¥æäº¤ï¼Œè¿™å°±æ˜¯ (e) æ‰€å±•ç¤ºçš„æƒ…å†µã€‚ S1 è¿˜æ˜¯å°†æ—¥å¿—æ¡ç›®ï¼ˆindex=2ï¼Œterm=2ï¼‰å¤åˆ¶ç»™å…¶ä»–èŠ‚ç‚¹ï¼Œå®ƒå¤åˆ¶ç»™äº† S3ï¼Œæ­¤æ—¶å·²ç»å¤åˆ¶ç»™äº†è¿‡åŠçš„èŠ‚ç‚¹äº†ï¼Œä½†æ˜¯ç”±äº currentTerm=4ï¼Œæ‰€ä»¥ S1 è¿˜æ˜¯ä¸èƒ½æäº¤è¯¥æ—¥å¿—æ¡ç›®ã€‚ä½†æ˜¯è¿™ä¸ªæ—¶å€™ï¼ŒS1 åªæ˜¯æ—¥å¿—æ¡ç›®ï¼ˆindex=3ï¼Œterm=4ï¼‰å†™å…¥è‡ªå·±çš„æ—¥å¿—ï¼Œè¿˜æ²¡æ¥å¾—åŠå¤åˆ¶å°±å´©æºƒäº†ã€‚ç„¶å S5 é‡å¯å¹¶èµ¢å¾—äº†é€‰ä¸¾ï¼ˆcurrentTerm=5ï¼‰ï¼Œç„¶åå°†æ—¥å¿—æ¡ç›®ï¼ˆindex=2ï¼Œterm=3ï¼‰å¤åˆ¶ç»™å…¶ä»–æ‰€æœ‰èŠ‚ç‚¹ï¼Œç°åœ¨ index=2 çš„æ—¥å¿—æ¡ç›®æ˜¯æ²¡æœ‰æäº¤è¿‡çš„ï¼ŒS5 èƒ½æäº¤è¯¥æ—¥å¿—å—ï¼Ÿ ä¸èƒ½ï¼å› ä¸º leader ä¸èƒ½æäº¤ä¹‹å‰ä»»æœŸçš„æ—¥å¿—ï¼åªæœ‰ç­‰æ–°çš„è¯·æ±‚è¿›æ¥ï¼Œè¶…è¿‡åŠæ•°èŠ‚ç‚¹å¤åˆ¶äº† 1-3-5 ä¹‹åï¼Œterm=3 çš„æ—¥å¿—æ‰èƒ½è·Ÿç€ term=5 çš„æ—¥å¿—ä¸€èµ·è¢«æäº¤ã€‚ å»¶ä¼¸ï¼š åŠ äº†ä¸Šè¿°çº¦æŸåï¼Œå°±ä¸ä¼šå‡ºç°åŒä¸€ä¸ª index ä¸Šçš„æ—¥å¿—æ¡ç›®è¢«é‡å¤æäº¤çš„æƒ…å†µäº†ï¼Œä½†æ˜¯è¿™åˆå¤šå‡ºäº†å¦å¤–ä¸€ä¸ªé—®é¢˜äº†ï¼šå¦‚æœä¸€ç›´æ²¡æœ‰æ–°çš„è¯·æ±‚è¿›æ¥ï¼Œé‚£ä¹ˆæ—¥å¿—æ¡ç›®ï¼ˆindex=2ï¼Œterm=3ï¼‰å²‚ä¸æ˜¯å°±ä¸€ç›´ä¸èƒ½æäº¤ï¼Ÿé‚£ä¸å°±é˜»å¡äº†å—ï¼Ÿ è¿™é‡Œå¦‚æœæ˜¯ kv æ•°æ®åº“ï¼Œé—®é¢˜å°±å¾ˆæ˜æ˜¾äº†ã€‚å‡è®¾ (c) æˆ– (d) ä¸­çš„æ—¥å¿—æ¡ç›®ï¼ˆindex=2ï¼‰é‡Œçš„ Command æ˜¯ Set(\"k\", \"1\")ï¼ŒS5 å½“é€‰ leader åï¼Œå®¢æˆ·ç«¯æ¥æŸ¥è¯¢ Get(\"k\")ï¼Œleader æŸ¥åˆ°æ—¥å¿—æœ‰è®°å½•ä½†åˆä¸èƒ½å›å¤ 1 ç»™å®¢æˆ·ç«¯ï¼ˆå› ä¸ºæŒ‰ç…§çº¦æŸè¿™æ¡æ—¥å¿—æœªæäº¤ï¼‰ï¼Œçº¿æ€§ä¸€è‡´æ€§è¦æ±‚ä¸èƒ½è¿”å›é™ˆæ—§çš„æ•°æ®ï¼Œleader è¿«åˆ‡åœ°éœ€è¦çŸ¥é“è¿™æ¡æ—¥å¿—åˆ°åº•èƒ½ä¸èƒ½æäº¤ã€‚ æ‰€ä»¥ Raft è®ºæ–‡æé«˜äº†å¼•å…¥ no-op æ—¥å¿—æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¿™ä¸ªåœ¨ etcd ä¸­æœ‰å®ç°ã€‚ no-op æ—¥å¿—ï¼š no-op æ—¥å¿—å³åªæœ‰ index å’Œ term ä¿¡æ¯ï¼Œcommand ä¿¡æ¯ä¸ºç©ºã€‚ä¹Ÿæ˜¯è¦å†™åˆ°ç£ç›˜å­˜å‚¨çš„ã€‚ å…·ä½“æµç¨‹æ˜¯åœ¨ leader åˆšé€‰ä¸¾æˆåŠŸçš„æ—¶å€™ï¼Œç«‹å³è¿½åŠ ä¸€æ¡ no-op æ—¥å¿—ï¼Œå¹¶ç«‹å³å¤åˆ¶åˆ°å…¶å®ƒèŠ‚ç‚¹ï¼Œno-op æ—¥å¿—ä¸€ç»æäº¤ï¼Œleader å‰é¢é‚£äº›æœªæäº¤çš„æ—¥å¿—å…¨éƒ¨é—´æ¥æäº¤ï¼Œé—®é¢˜å°±è§£å†³äº†ã€‚åƒä¸Šé¢çš„ kv æ•°æ®åº“ï¼Œæœ‰äº† no-op æ—¥å¿—ä¹‹åï¼ŒLeader å°±èƒ½å¿«é€Ÿå“åº”å®¢æˆ·ç«¯æŸ¥è¯¢äº†ã€‚ æœ¬è´¨ä¸Šï¼Œno-op æ—¥å¿—ä½¿ leader éšå¼åœ°å¿«é€Ÿæäº¤ä¹‹å‰ä»»æœŸæœªæäº¤çš„æ—¥å¿—ï¼Œç¡®è®¤å½“å‰ commitIndexï¼Œè¿™æ ·ç³»ç»Ÿæ‰ä¼šå¿«é€Ÿå¯¹å¤–æ­£å¸¸å·¥ä½œã€‚ ä¸ºäº†è§£å†³å›¾ 8 ä¸­æè¿°çš„é—®é¢˜ï¼ŒRaft æ°¸è¿œä¸ä¼šé€šè¿‡è®¡ç®—å‰¯æœ¬æ•°ç›®çš„æ–¹å¼æ¥æäº¤ä¹‹å‰ä»»æœŸå†…çš„æ—¥å¿—æ¡ç›®ã€‚åªæœ‰ leader å½“æœŸå†…çš„æ—¥å¿—æ¡ç›®æ‰é€šè¿‡è®¡ç®—å‰¯æœ¬æ•°ç›®çš„æ–¹å¼æ¥æäº¤ã€‚ä¸€æ—¦å½“å‰ä»»æœŸå†…çš„æŸä¸ªæ—¥å¿—æ¡ç›®ä»¥è¿™ç§æ–¹å¼è¢«æäº¤ï¼ˆå¦‚å›¾ 8 ä¸­çš„ eï¼‰ï¼Œé‚£ä¹ˆç”±äºæ—¥å¿—åŒ¹é…ç‰¹æ€§ï¼ˆLog Matchingï¼‰ï¼Œä¹‹å‰çš„æ‰€æœ‰æ—¥å¿—æ¡ç›®ä¹Ÿä¼šè¢«é—´æ¥åœ°æäº¤ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œleader å¯ä»¥å®‰å…¨åœ°æ–­å®šä¸€ä¸ªè€çš„æ—¥å¿—æ¡ç›®å·²ç»è¢«æäº¤ï¼ˆä¾‹å¦‚ï¼Œå¦‚æœè¯¥æ¡ç›®å·²ç»è¢«å­˜å‚¨åˆ°æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸Šäº†ï¼‰ã€‚ä½†æ˜¯ Raft ä¸ºäº†ç®€åŒ–é—®é¢˜ï¼Œé‡‡å–äº†ä¸Šè¿°æè¿°çš„æ›´åŠ ä¿å®ˆçš„æ–¹æ³•ã€‚ Raft ä¼šåœ¨æäº¤è§„åˆ™ä¸Šå¢åŠ é¢å¤–çš„å¤æ‚æ€§æ˜¯å› ä¸ºå½“ leader å¤åˆ¶ä¹‹å‰ä»»æœŸå†…çš„æ—¥å¿—æ¡ç›®æ—¶ï¼Œè¿™äº›æ—¥å¿—æ¡ç›®éƒ½ä¿ç•™åŸæ¥çš„ä»»æœŸå·ã€‚åœ¨å…¶ä»–çš„å…±è¯†ç®—æ³•ä¸­ï¼Œå¦‚æœä¸€ä¸ªæ–°çš„ leader è¦é‡æ–°å¤åˆ¶ä¹‹å‰ä»»æœŸé‡Œçš„æ—¥å¿—æ—¶ï¼Œå®ƒå¿…é¡»ä½¿ç”¨å½“å‰æ–°çš„ä»»æœŸå·ã€‚Raft çš„åšæ³•ä½¿å¾—æ›´åŠ å®¹æ˜“æ¨å¯¼å‡ºæ—¥å¿—æ¡ç›®ï¼Œå› ä¸ºå®ƒä»¬è‡ªå§‹è‡³ç»ˆéƒ½ä½¿ç”¨åŒä¸€ä¸ªä»»æœŸå·ã€‚å¦å¤–ï¼Œå’Œå…¶ä»–çš„ç®—æ³•ç›¸æ¯”ï¼ŒRaft ä¸­çš„æ–° leader åªéœ€è¦å‘é€æ›´å°‘çš„æ—¥å¿—æ¡ç›®ï¼ˆå…¶ä»–ç®—æ³•ä¸­å¿…é¡»åœ¨å®ƒä»¬è¢«æäº¤ä¹‹å‰å‘é€æ›´å¤šçš„å†—ä½™æ—¥å¿—æ¡ç›®æ¥ç»™å®ƒä»¬é‡æ–°ç¼–å·ï¼‰ã€‚ 5.4.3 å®‰å…¨æ€§è®ºè¯ ç»™å‡ºäº†å®Œæ•´çš„ Raft ç®—æ³•åï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥æ›´ä¸¥æ ¼åœ°æ¥è®ºè¯ leader å®Œæ•´æ€§ç‰¹æ€§ï¼ˆLeader Completeness Propertyï¼‰ï¼ˆè¿™ä¸€è®¨è®ºåŸºäº 9.2 èŠ‚çš„å®‰å…¨æ€§è¯æ˜ï¼‰ã€‚æˆ‘ä»¬å…ˆå‡è®¾ Leader Completeness Property æ˜¯ä¸æ»¡è¶³çš„ï¼Œç„¶åå†æ¨å‡ºçŸ›ç›¾æ¥ã€‚ å‡è®¾ï¼š å‡è®¾ä»»æœŸ T çš„ leaderT åœ¨ä»»æœŸå†…æäº¤äº†ä¸€ä¸ªæ—¥å¿—æ¡ç›®ï¼Œä½†æ˜¯è¯¥æ—¥å¿—æ¡ç›®æ²¡æœ‰å­˜åœ¨æœªæ¥æŸäº›ä»»æœŸçš„ leader ä¸­ï¼Œå‡è®¾ U æ˜¯å¤§äº T çš„æ²¡æœ‰å­˜å‚¨è¯¥æ—¥å¿—æ¡ç›®çš„æœ€å°ä»»æœŸå·ï¼Œå¤„åœ¨ä»»æœŸ U çš„ leader ç§°ä¸º leaderUã€‚ è®ºè¯ï¼š å› ä¸º leader ä»æ¥ä¸åˆ é™¤æˆ–é‡å†™è‡ªå·±çš„æ—¥å¿—æ¡ç›®ï¼Œæ‰€ä»¥å¦‚æœä¸€ä¸ªå·²æäº¤çš„æ—¥å¿—è¦åšåˆ°ä¸å­˜åœ¨æœªæ¥çš„ leaderU ä¸­çš„è¯ï¼Œé‚£ä¹ˆå®ƒåªå¯èƒ½åœ¨ leaderU é€‰ä¸¾çš„è¿‡ç¨‹ä¸­è¢«ä¸¢å¤±ã€‚ leaderT å°†è¯¥æ—¥å¿—å¤åˆ¶ç»™äº†é›†ç¾¤ä¸­è¿‡åŠçš„èŠ‚ç‚¹ï¼ŒleaderU ä»é›†ç¾¤ä¸­è¿‡åŠçš„èŠ‚ç‚¹å¾—åˆ°äº†æŠ•ç¥¨ã€‚å› æ­¤ï¼Œè‡³å°‘æœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆè¿™é‡Œç§°å®ƒä¸º voterï¼‰åŒæ—¶æ¥æ”¶äº†æ¥è‡ª leaderT çš„æ—¥å¿—æ¡ç›®å¹¶ä¸”ç»™ leaderU æŠ•ç¥¨äº†ã€‚ image-20210713185232381 voter å¿…ç„¶åœ¨ç»™ leaderU æŠ•ç¥¨ä¹‹å‰å°±å·²ç»æ¥æ”¶äº†è¿™ä¸ªå·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®äº†ã€‚å¦åˆ™ï¼Œå®ƒå°±ä¼šæ‹’ç»æ¥è‡ª leaderT çš„ AppendEntries RPC è¯·æ±‚ï¼Œå› ä¸ºå¦‚æœå®ƒåœ¨ç»™ leaderU æŠ•ç¥¨ä¹‹åå†æ¥æ”¶æ¡ç›®çš„è¯ï¼Œé‚£ä¹ˆå®ƒçš„å½“å‰ä»»æœŸå·ä¼šæ¯” T å¤§ã€‚ è¯‘è€…æ³¨ï¼šå› ä¸ºè¦ä¸¾è¡Œ Leader election çš„è¯éœ€è¦å¼€ä¸€è½®æ–°çš„ä»»æœŸï¼Œè¿™ä¸ªæ—¶å€™å‰ä¸€è½®ä»»æœŸå·²ç»ç»“æŸäº†ã€‚æˆ‘ä»¬è¿™é‡Œå‡è®¾äº† T Uï¼Œä¸Šè¿°æ‰€è¯´çš„å·²æäº¤æ—¥å¿—æ¡ç›®æ˜¯åœ¨ä»»æœŸ T ä¸­çš„ï¼Œå¦‚æœ voter å…ˆæŠ•ç¥¨çš„è¯ï¼Œé‚£ä¹ˆå°±è¯´æ˜å®ƒå·²ç»è¿›å…¥äº†ä»»æœŸ U äº†ï¼Œè€Œ U Tï¼Œvoter æ˜¯ä¸å¯èƒ½æ¥å— leaderT çš„ AppendEntries è¯·æ±‚çš„ã€‚ è€Œä¸”ï¼Œvoter åœ¨ç»™ leaderU æŠ•ç¥¨çš„æ—¶å€™ï¼Œå®ƒä¾æ—§ä¿æœ‰è¯¥æ—¥å¿—æ¡ç›®ï¼Œå› ä¸ºä»»ä½• Uã€T ä¹‹é—´çš„ leader éƒ½åŒ…å«è¯¥æ—¥å¿—æ¡ç›®ï¼ˆå› ä¸ºæˆ‘ä»¬å‰é¢å‡è®¾äº† U æ˜¯å¤§äº T çš„æ²¡æœ‰å­˜å‚¨è¯¥æ—¥å¿—æ¡ç›®çš„æœ€å°ä»»æœŸå·ï¼‰ï¼Œè€Œä¸” leader ä»æ¥ä¸ä¼šåˆ é™¤æ¡ç›®ï¼Œå¹¶ä¸” follower åªæœ‰å†è·Ÿ leader å†²çªçš„æ—¶å€™æ‰ä¼šåˆ é™¤æ¡ç›®ã€‚ è¯¥æŠ•ç¥¨è€…æŠŠè‡ªå·±çš„é€‰ç¥¨æŠ•ç»™ leaderU çš„æ—¶å€™ï¼ŒleaderU çš„æ—¥å¿—è‡³å°‘è·Ÿ voter ä¸€æ ·æ–°ï¼ˆå¯ä»¥æ›´æ–°ï¼‰ï¼Œè¿™å°±å¯¼è‡´äº†ä»¥ä¸‹çš„ä¸¤ä¸ªçŸ›ç›¾ä¹‹ä¸€äº†ã€‚ ç¬¬ä¸€ä¸ªçŸ›ç›¾ï¼š å¦‚æœ voter å’Œ leaderU æœ€åä¸€ä¸ªæ—¥å¿—æ¡ç›®çš„ä»»æœŸå·ç›¸åŒçš„è¯ï¼Œé‚£ä¹ˆ leaderU çš„æ—¥å¿—è‡³å°‘å’Œ voter çš„ä¸€æ ·é•¿ï¼Œæ‰€ä»¥ leaderU çš„æ—¥å¿—ä¸€å®šåŒ…å« voter æ—¥å¿—ä¸­çš„æ‰€æœ‰æ—¥å¿—æ¡ç›®ã€‚ è¿™æ˜¯ä¸€ä¸ªçŸ›ç›¾ï¼Œå› ä¸º voter åŒ…å«äº†è¯¥å·²æäº¤çš„æ—¥å¿—æ¡ç›®ï¼Œæ‰€ä»¥ leaderU å¿…å®šä¹ŸåŒ…å«è¯¥æ—¥å¿—æ¡ç›®ï¼Œè€Œå‰é¢æˆ‘ä»¬å‡è®¾äº† leaderU æ˜¯ä¸åŒ…å«çš„ï¼Œè¿™å°±äº§ç”Ÿäº†çŸ›ç›¾ã€‚ ç¬¬äºŒä¸ªçŸ›ç›¾ï¼š å¦‚æœä¸æ˜¯ä¸Šé¢æè¿°çš„æƒ…å†µçš„è¯ï¼Œé‚£ä¹ˆ leaderU æœ€åä¸€ä¸ªæ—¥å¿—æ¡ç›®çš„ä»»æœŸå·å¿…ç„¶éœ€è¦æ¯” voter çš„æ›´å¤§ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜æ¯” T è¦å¤§ï¼Œå› ä¸º voter æ‹¥æœ‰åœ¨ä»»æœŸå·ä¸º T æäº¤çš„æ—¥å¿—æ¡ç›®ï¼Œæ‰€ä»¥ voter æœ€åä¸€ä¸ªæ—¥å¿—æ¡ç›®çš„ä»»æœŸå·è‡³å°‘ä¸º Tã€‚åˆ›å»ºäº† leaderU çš„æœ€åä¸€ä¸ªæ—¥å¿—æ¡ç›®çš„ä¹‹å‰çš„ leader ä¸€å®šå·²ç»åŒ…å«äº†è¯¥å·²è¢«æäº¤çš„æ—¥å¿—æ¡ç›®ï¼ˆå› ä¸ºæˆ‘ä»¬ä¸Šé¢å‡è®¾äº† leaderU æ˜¯ç¬¬ä¸€ä¸ªæ²¡æœ‰è¯¥æ—¥å¿—æ¡ç›®çš„ leaderï¼‰ã€‚æ‰€ä»¥ï¼Œæ ¹æ®æ—¥å¿—åŒ¹é…ç‰¹æ€§ï¼ŒleaderU ä¸€å®šä¹ŸåŒ…å«äº†è¯¥å·²è¢«æäº¤çš„æ—¥å¿—æ¡ç›®ï¼Œè¿™æ ·ä¹Ÿäº§ç”Ÿäº†çŸ›ç›¾ã€‚ ä¸Šè¿°è®¨è®ºå°±è¯æ˜äº†å‡è®¾æ˜¯ä¸æˆç«‹çš„ã€‚å› æ­¤ï¼Œæ‰€æœ‰æ¯” T å¤§çš„ä»»æœŸçš„ leader ä¸€å®šåŒ…å«äº†ä»»æœŸ T ä¸­æäº¤çš„æ‰€æœ‰æ—¥å¿—æ¡ç›®ã€‚ æ—¥å¿—åŒ¹é…ç‰¹æ€§ä¿è¯äº†æœªæ¥çš„ leader ä¹Ÿä¼šåŒ…å«è¢«é—´æ¥æäº¤çš„æ—¥å¿—æ¡ç›®ï¼Œå¦‚å›¾ 8 (d) ä¸­çš„ç´¢å¼• 2ã€‚ é€šè¿‡ leader çš„å®Œæ•´æ€§ç‰¹æ€§ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¯æ˜å›¾ 3 ä¸­çš„çŠ¶æ€æœºå®‰å…¨ç‰¹æ€§äº†ï¼Œå³å¦‚æœæŸä¸ªèŠ‚ç‚¹å·²ç»å°†æŸä¸ªç»™å®šçš„ç´¢å¼•å¤„çš„æ—¥å¿—æ¡ç›®åº”ç”¨åˆ°è‡ªå·±çš„çŠ¶æ€æœºé‡Œäº†ï¼Œé‚£ä¹ˆå…¶ä»–çš„èŠ‚ç‚¹å°±ä¸ä¼šåœ¨ç›¸åŒçš„ç´¢å¼•å¤„åº”ç”¨ä¸€ä¸ªä¸åŒçš„æ—¥å¿—æ¡ç›®ã€‚åœ¨ä¸€ä¸ªèŠ‚ç‚¹åº”ç”¨ä¸€ä¸ªæ—¥å¿—æ¡ç›®åˆ°è‡ªå·±çš„çŠ¶æ€æœºä¸­æ—¶ï¼Œå®ƒçš„æ—¥å¿—å’Œ leader çš„æ—¥å¿—ä»å¼€å§‹åˆ°è¯¥æ—¥å¿—æ¡ç›®éƒ½æ˜¯ç›¸åŒçš„ï¼Œå¹¶ä¸”è¯¥æ—¥å¿—æ¡ç›®å¿…é¡»è¢«æäº¤ã€‚ç°åœ¨è€ƒè™‘ä¸€ä¸ªæœ€å°çš„ä»»æœŸå·ï¼Œåœ¨è¯¥ä»»æœŸä¸­ä»»æ„èŠ‚ç‚¹åº”ç”¨äº†ä¸€ä¸ªç»™å®šçš„æœ€å°ç´¢å¼•ä¸Šé¢çš„æ—¥å¿—æ¡ç›®ï¼Œé‚£ä¹ˆ Log çš„å®Œæ•´æ€§ç‰¹æ€§å°±ä¼šä¿è¯è¯¥ä»»æœŸä¹‹åçš„æ‰€æœ‰ leader å°†å­˜å‚¨ç›¸åŒçš„æ—¥å¿—æ¡ç›®ï¼Œå› æ­¤åœ¨åé¢çš„ä»»æœŸä¸­åº”ç”¨è¯¥ç´¢å¼•ä¸Šçš„æ—¥å¿—æ¡ç›®çš„èŠ‚ç‚¹ä¼šåº”ç”¨ç›¸åŒçš„å€¼ã€‚æ‰€ä»¥ï¼ŒçŠ¶æ€æœºå®‰å…¨ç‰¹æ€§æ˜¯å¯ä»¥å¾—åˆ°ä¿è¯çš„ã€‚ æœ€åï¼Œå› ä¸º Raft è¦æ±‚æœåŠ¡å™¨èŠ‚ç‚¹æŒ‰ç…§æ—¥å¿—ç´¢å¼•é¡ºåºåº”ç”¨æ—¥å¿—æ¡ç›®ï¼Œå†åŠ ä¸ŠçŠ¶æ€æœºå®‰å…¨ç‰¹æ€§ï¼Œè¿™æ ·å°±æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä¿è¯æ‰€æœ‰çš„æœåŠ¡å™¨éƒ½ä¼šæŒ‰ç…§ç›¸åŒçš„é¡ºåºåº”ç”¨ç›¸åŒçš„æ—¥å¿—æ¡ç›®åˆ°è‡ªå·±çš„çŠ¶æ€æœºä¸­äº†ã€‚ 5.5 follower å’Œ candidate å´©æºƒ åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬åªå…³æ³¨äº† leader å´©æºƒçš„æƒ…å†µã€‚follower å’Œ candidate å´©æºƒåçš„å¤„ç†æ–¹å¼è¦æ¯” leader å´©æºƒç®€å•å¾—å¤šï¼Œè€Œä¸”å®ƒä»¬çš„å¤„ç†æ–¹å¼æ˜¯ç›¸åŒçš„ã€‚å¦‚æœä¸€ä¸ª follower æˆ–è€… candidate å´©æºƒçš„è¯ï¼Œåé¢å‘é€ç»™å®ƒä»¬çš„ RequestVote å’Œ AppendEntries RPCs éƒ½ä¼šå¤±è´¥ã€‚Raft é€šè¿‡æ— é™é‡è¯•æ¥å¤„ç†è¿™ç§å¤±è´¥ã€‚å¦‚æœå´©æºƒçš„èŠ‚ç‚¹é‡å¯äº†ï¼Œé‚£ä¹ˆè¿™äº› RPC å°±ä¼šè¢«æˆåŠŸåœ°å®Œæˆã€‚å¦‚æœä¸€ä¸ªèŠ‚ç‚¹åœ¨å®Œæˆäº†ä¸€ä¸ª RPCï¼Œä½†æ˜¯è¿˜æ²¡æ¥å¾—åŠå“åº”å°±å´©æºƒäº†çš„è¯ï¼Œé‚£ä¹ˆåœ¨å®ƒé‡å¯ä¹‹åå®ƒä¼šå†æ¬¡æ”¶åˆ°åŒæ ·çš„è¯·æ±‚ã€‚Raft çš„ RPCs éƒ½æ˜¯å¹‚ç­‰çš„ï¼Œæ‰€ä»¥é‡å¤å‘é€ç›¸åŒçš„ RPCs ä¸ä¼šå¯¹ç³»ç»Ÿé€ æˆå±å®³ã€‚å®é™…æƒ…å†µä¸‹ï¼Œä¸€ä¸ª follower å¦‚æœæ¥æ”¶äº†ä¸€ä¸ª AppendEntries è¯·æ±‚ï¼Œä½†æ˜¯è¿™ä¸ªè¯·æ±‚é‡Œé¢çš„è¿™äº›æ—¥å¿—æ¡ç›®åœ¨å®ƒæ—¥å¿—ä¸­å·²ç»æœ‰äº†ï¼Œå®ƒå°±ä¼šç›´æ¥å¿½ç•¥è¿™ä¸ªæ–°çš„è¯·æ±‚ä¸­çš„è¿™äº›æ—¥å¿—æ¡ç›®ã€‚ è¯‘è€…æ³¨ï¼šå¹‚ç­‰ åœ¨ç¼–ç¨‹ä¸­ä¸€ä¸ªå¹‚ç­‰æ“ä½œçš„ç‰¹ç‚¹æ˜¯å…¶ä»»æ„å¤šæ¬¡æ‰§è¡Œæ‰€äº§ç”Ÿçš„å½±å“å‡ä¸ä¸€æ¬¡æ‰§è¡Œçš„å½±å“ç›¸åŒã€‚å¹‚ç­‰å‡½æ•°ï¼Œæˆ–å¹‚ç­‰æ–¹æ³•ï¼Œæ˜¯æŒ‡å¯ä»¥ä½¿ç”¨ç›¸åŒå‚æ•°é‡å¤æ‰§è¡Œï¼Œå¹¶èƒ½è·å¾—ç›¸åŒç»“æœçš„å‡½æ•°ã€‚è¿™äº›å‡½æ•°ä¸ä¼šå½±å“ç³»ç»ŸçŠ¶æ€ï¼Œä¹Ÿä¸ç”¨æ‹…å¿ƒé‡å¤æ‰§è¡Œä¼šå¯¹ç³»ç»Ÿé€ æˆæ”¹å˜ã€‚ä¾‹å¦‚ï¼Œâ€œsetTrue()â€å‡½æ•°å°±æ˜¯ä¸€ä¸ªå¹‚ç­‰å‡½æ•°,æ— è®ºå¤šæ¬¡æ‰§è¡Œï¼Œå…¶ç»“æœéƒ½æ˜¯ä¸€æ ·çš„.æ›´å¤æ‚çš„æ“ä½œå¹‚ç­‰ä¿è¯æ˜¯åˆ©ç”¨å”¯ä¸€äº¤æ˜“å·(æµæ°´å·)å®ç°ã€‚ 5.6 æ—¶åºå’Œå¯ç”¨æ€§ Raft ä¸­æœ‰ä¸€ä¸ªè¦æ±‚å°±æ˜¯ Raft çš„å®‰å…¨æ€§ä¸èƒ½ä¾èµ–äºæ—¶åºï¼ˆtimingï¼‰ï¼šæ•´ä¸ªç³»ç»Ÿä¸èƒ½å› ä¸ºæŸäº›äº‹ä»¶è¿è¡Œå¾—æ¯”é¢„æœŸå¿«ä¸€ç‚¹æˆ–è€…æ…¢ä¸€ç‚¹å°±äº§ç”Ÿé”™è¯¯çš„ç»“æœã€‚ç„¶è€Œï¼Œå¯ç”¨æ€§ï¼ˆå³ç³»ç»Ÿèƒ½å¤ŸåŠæ—¶å“åº”å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼‰ä¸å¯é¿å…çš„è¦ä¾èµ–äºæ—¶åºã€‚æ¯”å¦‚è¯´ï¼Œå¦‚æœä¿¡æ¯äº¤æ¢çš„æ—¶é—´æ¯”ä¸€èˆ¬æœåŠ¡å™¨å´©æºƒæ‰€æŒç»­çš„æ—¶é—´è¿˜è¦é•¿çš„è¯ï¼Œé‚£ä¹ˆ candidate å¯èƒ½ç­‰ä¸åˆ°èµ¢å¾—é€‰ä¸¾äº†ï¼Œè€Œç¼ºå°‘äº†ä¸€ä¸ªç¨³å®šçš„ leaderï¼ŒRaft å°†æ— æ³•å·¥ä½œã€‚ Raft ä¸­æ—¶åºæœ€å…³é”®çš„åœ°æ–¹å°±æ˜¯ Leader electionã€‚åªè¦æ•´ä¸ªç³»ç»Ÿæ»¡è¶³ä¸‹é¢çš„æ—¶é—´è¦æ±‚ï¼ŒRaft å°±å¯ä»¥é€‰ä¸¾å¹¶ç»´æŒä¸€ä¸ªç¨³å®šçš„ leaderï¼š å¹¿æ’­æ—¶é—´ï¼ˆbroadcastTimeï¼‰ é€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼ˆelectionTimeoutï¼‰ å¹³å‡æ•…éšœé—´éš”æ—¶é—´ï¼ˆMTBFï¼‰ åœ¨è¿™ä¸ªä¸ç­‰å¼ä¸­ï¼Œå¹¿æ’­æ—¶é—´æŒ‡çš„æ˜¯ä¸€ä¸ªèŠ‚ç‚¹å¹¶è¡Œåœ°å‘é€ RPCs ç»™é›†ç¾¤ä¸­å…¶ä»–æ‰€æœ‰çš„èŠ‚ç‚¹å¹¶å¾—åˆ°å“åº”çš„å¹³å‡æ—¶é—´ã€‚é€‰ä¸¾è¶…æ—¶æ—¶é—´å°±æ˜¯åœ¨ 5.2 èŠ‚ä¸­ä»‹ç»çš„é€‰ä¸¾è¶…æ—¶æ—¶é—´ã€‚å¹³å‡æ•…éšœé—´éš”æ—¶é—´å°±æ˜¯å¯¹äºä¸€å°æœåŠ¡å™¨è€Œè¨€ï¼Œä¸¤æ¬¡æ•…éšœé—´éš”æ—¶é—´çš„å¹³å‡å€¼ã€‚å¹¿æ’­æ—¶é—´å¿…é¡»é€‰ä¸¾è¶…æ—¶æ—¶é—´å°ä¸€ä¸ªé‡çº§ï¼Œè¿™æ · leader æ‰èƒ½å¤Ÿæœ‰æ•ˆå‘é€å¿ƒè·³ä¿¡æ¯æ¥ç»„ç»‡ follower è¿›å…¥é€‰ä¸¾çŠ¶æ€ã€‚å†åŠ ä¸ŠéšæœºåŒ–é€‰ä¸¾è¶…æ—¶æ—¶é—´çš„æ–¹æ³•ï¼Œè¿™ä¸ªä¸ç­‰å¼ä¹Ÿä½¿å¾—æ— æœé€‰ç¥¨ï¼ˆsplit voteï¼‰å˜å¾—å‡ ä¹ä¸å¯èƒ½ã€‚è€Œé€‰ä¸¾è¶…æ—¶æ—¶é—´éœ€è¦æ¯”å¹³å‡æ•…éšœé—´éš”æ—¶é—´å°ä¸Šå‡ ä¸ªæ•°é‡çº§ï¼Œè¿™æ ·æ•´ä¸ªç³»ç»Ÿæ‰å¯ä»¥ç¨³å®šåœ°è¿è¡Œã€‚æœ‰äº†è¿™ä¸ªé™åˆ¶åï¼Œå½“ leader å´©æºƒåï¼Œæ•´ä¸ªç³»ç»Ÿä¼šæœ‰ä¸€æ®µå¤§çº¦é€‰ä¸¾è¶…æ—¶æ—¶é—´çš„æ—¶é•¿ä¸å¯ç”¨ï¼Œæˆ‘ä»¬å¸Œæœ›è¯¥æƒ…å†µåœ¨æ•´ä¸ªç³»ç»Ÿè¿è¡Œæ—¶é—´é‡Œåªå ä¸€å°éƒ¨åˆ†ã€‚ å¹¿æ’­æ—¶é—´å’Œå¹³å‡æ•…éšœé—´éš”æ—¶é—´æ˜¯ç”±ç³»ç»Ÿå†³å®šçš„ï¼Œä½†æ˜¯é€‰ä¸¾è¶…æ—¶æ—¶é—´æ˜¯æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰çš„ã€‚Raft çš„ RPCs éœ€è¦æ¥æ”¶æ–¹å°†ä¿¡æ¯æŒä¹…åŒ–åœ°ä¿å­˜åˆ°ç¨³å®šå­˜å‚¨ä¸­ï¼Œæ‰€ä»¥å¹¿æ’­æ—¶é—´å¤§çº¦æ˜¯ 0.5ms ~ 20ms ä¹‹é—´ï¼Œå–å†³äºå­˜å‚¨çš„æŠ€æœ¯ã€‚å› æ­¤ï¼Œé€‰ä¸¾è¶…æ—¶æ—¶é—´å¯èƒ½éœ€è¦åœ¨ 10ms ~ 500ms ä¹‹é—´ã€‚è€Œå¤§å¤šæ•°çš„æœåŠ¡å™¨çš„å¹³å‡æ•…éšœé—´éš”æ—¶é—´éƒ½åœ¨å‡ ä¸ªæœˆç”šè‡³æ›´é•¿ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“æ»¡è¶³æ—¶é—´çš„è¦æ±‚ã€‚ 6. é›†ç¾¤æˆå‘˜å˜æ›´ åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬éƒ½å‡è®¾é›†ç¾¤çš„é…ç½®ï¼ˆå‚ä¸å…±è¯†ç®—æ³•çš„æœåŠ¡å™¨èŠ‚ç‚¹é›†åˆï¼‰æ˜¯å›ºå®šä¸å˜çš„ã€‚ä½†æ˜¯åœ¨å®é™…æƒ…å†µä¸­ï¼Œæˆ‘ä»¬æœ‰æ—¶å€™æ˜¯éœ€è¦å»æ”¹å˜é›†ç¾¤é…ç½®çš„ï¼Œæ¯”å¦‚è¯´åœ¨æœåŠ¡å™¨å´©æºƒçš„æ—¶å€™å»æ›´æ¢æœåŠ¡å™¨æˆ–è€…æ˜¯æ›´æ”¹å‰¯æœ¬çš„æ•°é‡ã€‚å°½ç®¡å¯ä»¥é€šè¿‡ä¸‹çº¿æ•´ä¸ªé›†ç¾¤ï¼Œæ›´æ–°æ‰€æœ‰é…ç½®ï¼Œç„¶åé‡å¯æ•´ä¸ªé›†ç¾¤çš„æ–¹å¼æ¥å®ç°è¿™ä¸ªéœ€æ±‚ï¼Œä½†æ˜¯è¿™ä¼šå¯¼è‡´é›†ç¾¤åœ¨æ›´æ”¹è¿‡ç¨‹ä¸­æ˜¯ä¸å¯ç”¨çš„ã€‚å¦å¤–ï¼Œå¦‚æœè¿™ä¸ªè¿‡ç¨‹ä¸­å­˜åœ¨ä¸€äº›æ“ä½œéœ€è¦äººå·¥å¹²é¢„ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰æ“ä½œå¤±è¯¯çš„é£é™©ã€‚ä¸ºäº†é¿å…è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬å†³å®šå°†é…ç½®å˜æ›´è‡ªåŠ¨åŒ–å¹¶å°†å…¶çº³å…¥åˆ° Raft çš„å…±è¯†ç®—æ³•ä¸­æ¥ã€‚ ä¸ºäº†ä½¿é…ç½®å˜æ›´æœºåˆ¶è¶³å¤Ÿå®‰å…¨ï¼Œåœ¨é…ç½®å˜æ›´è¿‡ç¨‹ä¸­ä¸èƒ½å­˜åœ¨ä»»ä½•ä¸€ä¸ªæ—¶åˆ»ä½¿å¾—åŒä¸€ä»»æœŸä¸­é€‰å‡ºä¸¤ä¸ª leaderã€‚é—æ†¾çš„æ˜¯ï¼Œä»»ä½•æœåŠ¡å™¨ç›´æ¥ä»æ—§çš„é…ç½®è½¬æ¢ä¸ºæ–°çš„é…ç½®çš„æ–¹æ¡ˆéƒ½æ˜¯ä¸å®‰å…¨çš„ã€‚ä¸€æ¬¡æ€§è‡ªåŠ¨åœ°è½¬æ¢æ‰€æœ‰æœåŠ¡å™¨çš„é…ç½®çš„ä¸å¯èƒ½çš„ï¼Œæ‰€ä»¥åœ¨è½¬æ¢æœŸé—´æ•´ä¸ªé›†ç¾¤å¯èƒ½åˆ’åˆ†ä¸ºä¸¤ä¸ªç‹¬ç«‹çš„å¤§å¤šæ•°ï¼ˆå¦‚å›¾ 10 æ‰€ç¤ºï¼‰ã€‚ image-20210714195412552 è¯‘è€…æ³¨ï¼šå›¾ 10 è¡¥å…… ä¸Šå›¾ä¸­ï¼Œåœ¨ä¸­é—´ä½ç½® Server1 å¯ä»¥é€šè¿‡è‡ªèº«å’Œ Server2 çš„é€‰ç¥¨æˆä¸º leaderï¼ˆæ»¡è¶³æ—§é…ç½®ä¸‹æ”¶åˆ°å¤§å¤šæ•°é€‰ç¥¨çš„åŸåˆ™ï¼‰ï¼›Server3 å¯ä»¥é€šè¿‡è‡ªèº«å’Œ Server4ã€Server5 çš„é€‰ç¥¨æˆä¸º leaderï¼ˆæ»¡è¶³æ–°é…ç½®çº¿ï¼Œå³é›†ç¾¤æœ‰ 5 ä¸ªèŠ‚ç‚¹çš„æƒ…å†µä¸‹çš„æ”¶åˆ°å¤§å¤šæ•°é€‰ç¥¨çš„åŸåˆ™ï¼‰ï¼›æ­¤æ—¶æ•´ä¸ªé›†ç¾¤å¯èƒ½åœ¨åŒä¸€ä»»æœŸä¸­å‡ºç°äº†ä¸¤ä¸ª leaderï¼Œè¿™å’Œ Raft åè®®æ˜¯è¿èƒŒçš„ã€‚ ä¸ºäº†ä¿è¯å®‰å…¨æ€§ï¼Œé…ç½®å˜æ›´å¿…é¡»é‡‡å–ä¸€ç§ä¸¤æ®µå¼æ–¹æ³•ã€‚ç›®å‰æœ‰å¾ˆå¤šç§ä¸¤æ®µå¼çš„å®ç°ã€‚ä¾‹å¦‚ï¼Œæœ‰äº›ç³»ç»Ÿï¼ˆå¦‚ [22] ï¼‰åœ¨ç¬¬ä¸€é˜¶æ®µåœæ‰æ—§çš„é…ç½®ï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªé˜¶æ®µä¸èƒ½å¤„ç†ç”¨æˆ·çš„è¯·æ±‚ï¼Œç„¶ååœ¨ç¬¬äºŒé˜¶æ®µå¯ç”¨æ–°çš„é…ç½®ã€‚åœ¨ Raft ä¸­ï¼Œé›†ç¾¤å…ˆåˆ‡æ¢åˆ°ä¸€ä¸ªè¿‡æ¸¡çš„é…ç½®ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º è”åˆå…±è¯†ï¼ˆjoint consensusï¼‰ ã€‚ä¸€æ—¦è”åˆå…±è¯†é…ç½®å·²ç»è¢«æäº¤äº†ï¼Œç³»ç»Ÿå°±å¯ä»¥åˆ‡æ¢åˆ°æ–°çš„é…ç½®ä¸Šäº†ã€‚è”åˆå…±è¯†é…ç½®æ˜¯æ–°æ—§é…ç½®çš„å¹¶é›†ï¼š æ—¥å¿—æ¡ç›®è¢«å¤åˆ¶ç»™é›†ç¾¤ä¸­å¤„äºæ–°ã€è€é…ç½®çš„æ‰€æœ‰èŠ‚ç‚¹ æ–°ã€æ—§é…ç½®çš„èŠ‚ç‚¹éƒ½å¯èƒ½æˆä¸º leader è¾¾æˆä¸€è‡´ï¼ˆé’ˆå¯¹é€‰ä¸¾å’Œæäº¤ï¼‰éœ€è¦åˆ†åˆ«å¾—åˆ°åœ¨ä¸¤ç§é…ç½®ä¸Šè¿‡åŠçš„æ”¯æŒ è”åˆå…±è¯†å…è®¸æ¯ä¸€ä¸ªèŠ‚ç‚¹åœ¨ä¸å¦¥åå®‰å…¨æ€§çš„å‰æä¸‹ï¼Œåœ¨ä¸åŒçš„æ—¶åˆ»è¿›è¡Œé…ç½®è½¬æ¢è¿‡ç¨‹ã€‚æ­¤å¤–ï¼Œè”åˆå…±è¯†è¿˜å…è®¸åœ¨é›†ç¾¤é…ç½®å˜æ›´æœŸé—´å“åº”å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚ é›†ç¾¤é…ç½®åœ¨å¤åˆ¶æ—¥å¿—ä¸­ä»¥ç‰¹æ®Šçš„æ—¥å¿—æ¡ç›®æ¥å­˜å‚¨å’Œé€šä¿¡ã€‚å›¾ 11 å±•ç¤ºäº†é…ç½®å˜æ›´çš„è¿‡ç¨‹ã€‚ image-20210714193852320 å½“ leader æ¥æ”¶åˆ°ä¸€ä¸ªæ›´æ–°é…ç½®çš„è¯·æ±‚çš„æ—¶å€™ï¼Œå®ƒå°±åˆ›å»ºä¸€ä¸ªè”åˆå…±è¯†æ—¥å¿—æ¡ç›® Cold,newï¼Œå¹¶ä»¥å‰é¢æè¿°çš„æ–¹å¼å¤åˆ¶è¯¥æ¡ç›®ã€‚ ä¸€æ—¦æŸä¸ªèŠ‚ç‚¹å°†è¯¥é…ç½®æ—¥å¿—æ¡ç›®å¢åŠ åˆ°è‡ªå·±çš„æ—¥å¿—ä¸­ã€‚é‚£ä¹ˆè¿™ä¸ªèŠ‚ç‚¹å°±ä¼šç”¨è¯¥é…ç½®æ¥åšå‡ºæœªæ¥çš„æ‰€æœ‰å†³ç­–ï¼ˆä¸€ä¸ªèŠ‚ç‚¹æ€»æ˜¯ä½¿ç”¨æ—¥å¿—ä¸­æœ€æ–°çš„é…ç½®ï¼Œæ— è®ºè¯¥æ—¥å¿—æ˜¯å¦å·²ç»è¢«æäº¤ï¼‰ã€‚ è¿™å°±æ„å‘³ç€ leader ä¼šä½¿ç”¨ Cold,new çš„è§„åˆ™æ¥åˆ¤æ–­ Cold,new æ—¥å¿—æ¡ç›®æ˜¯ä»€ä¹ˆæ—¶å€™è¢«æäº¤çš„ã€‚å¦‚æœ leader å´©æºƒäº†ï¼Œæ–°çš„ leader æœ‰å¯èƒ½å¤„äº Cold é…ç½®ï¼Œä¹Ÿå¯èƒ½å¤„äº Cold,new é…ç½®ï¼Œè¿™å–å†³äºèµ¢å¾—é€‰ä¸¾çš„ candidate æ˜¯å¦å·²ç»æ¥æ”¶åˆ°äº† Cold,new é…ç½®ã€‚åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œå¤„äº Cnew çŠ¶æ€çš„èŠ‚ç‚¹åœ¨æ­¤æœŸé—´éƒ½æ˜¯ä¸èƒ½å•ç‹¬åšå‡ºå†³å®šçš„ã€‚ å½“ Cold,new è¢«æäº¤äº†ï¼Œé‚£ä¹ˆ Cold å’Œ Cnew éƒ½ä¸èƒ½åœ¨æ²¡æœ‰å¾—åˆ°å¯¹æ–¹è®¤å¯çš„æƒ…å†µä¸‹åšå‡ºå†³å®šï¼Œå¹¶ä¸” Leade å®Œæ•´ç‰¹æ€§ï¼ˆLeader Completeness Propertyï¼‰ä¿è¯äº†åªæœ‰æ‹¥æœ‰ Cold,new æ—¥å¿—çš„ candidate æœ‰å¯èƒ½è¢«é€‰ä¸º leaderã€‚æ‰€ä»¥ç°åœ¨ leader å°±å¯ä»¥å®‰å…¨åœ°åˆ›å»ºä¸€ä¸ªæè¿° Cnew çš„æ—¥å¿—æ¡ç›®å¹¶å°†å…¶å¤åˆ¶ç»™é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹äº†ã€‚ä¸€æ ·çš„ï¼Œæ–°çš„é…ç½®è¢«èŠ‚ç‚¹æ”¶åˆ°åå°±ä¼šç«‹åˆ»ç”Ÿæ•ˆã€‚å½“æ–°çš„é…ç½®åœ¨ Cnew çš„è§„åˆ™ä¸‹è¢«æäº¤äº†ä¹‹åï¼Œæ—§é…ç½®å°±å˜å¾—æ— å…³ç´§è¦äº†ï¼Œå¤„äºæ—§é…ç½®çš„èŠ‚ç‚¹ä¹Ÿå¯ä»¥å…³é—­äº†ã€‚å¦‚å›¾ 11 æ‰€ç¤ºï¼Œæ²¡æœ‰ä»»ä½•ä¸€ä¸ªæ—¶åˆ» Cold å’Œ Cnew æ˜¯å¯ä»¥å•ç‹¬åšå†³å®šçš„ï¼Œè¿™ä¿è¯äº†å®‰å…¨æ€§ã€‚ å…³äºé…ç½®å˜æ›´æœ‰ä¸‰ä¸ªé—®é¢˜éœ€è¦è§£å†³ï¼š ç¬¬ä¸€ä¸ªé—®é¢˜ï¼šæ–°çš„èŠ‚ç‚¹å¯èƒ½åœ¨ä¸€å¼€å§‹å¹¶æ²¡æœ‰å­˜å‚¨ä»»ä½•çš„æ—¥å¿—æ¡ç›®ã€‚å½“è¿™äº›èŠ‚ç‚¹ä»¥è¿™ç§çŠ¶æ€åŠ å…¥åˆ°é›†ç¾¤ä¸­çš„æ—¶å€™ï¼Œå®ƒä»¬éœ€è¦ä¸€æ®µæ—¶é—´æ¥æ›´æ–°è‡ªå·±çš„æ—¥å¿—ï¼Œä»¥ä¾¿èµ¶ä¸Šå…¶ä»–èŠ‚ç‚¹ï¼Œåœ¨è¿™ä¸ªæ—¶é—´æ®µé‡Œé¢å®ƒä»¬æ˜¯ä¸å¯èƒ½æäº¤ä¸€ä¸ªæ–°çš„æ—¥å¿—æ¡ç›®çš„ã€‚ ä¸ºäº†é¿å…å› æ­¤é€ æˆçš„ç³»ç»ŸçŸ­æ—¶é—´çš„ä¸å¯ç”¨ï¼ŒRaft åœ¨é…ç½®å˜æ›´å‰å¼•å…¥äº†ä¸€ä¸ªé¢å¤–çš„é˜¶æ®µã€‚åœ¨è¯¥é˜¶æ®µä¸­ï¼Œæ–°çš„èŠ‚ç‚¹ä»¥æ²¡æœ‰æŠ•ç¥¨æƒèº«ä»½åŠ å…¥åˆ°é›†ç¾¤ä¸­æ¥ï¼ˆleader ä¼šæŠŠæ—¥å¿—å¤åˆ¶ç»™å®ƒä»¬ï¼Œä½†æ˜¯è€ƒè™‘è¿‡åŠçš„æ—¶å€™ä¸éœ€è¦è€ƒè™‘å®ƒä»¬ï¼‰ã€‚ ä¸€æ—¦æ–°èŠ‚ç‚¹çš„æ—¥å¿—å·²ç»èµ¶ä¸Šäº†é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹ï¼Œé‚£ä¹ˆé…ç½®å˜æ›´å°±å¯ä»¥æŒ‰ç…§ä¹‹å‰æè¿°çš„æ–¹å¼è¿›è¡Œäº†ã€‚ ç¬¬äºŒä¸ªé—®é¢˜ï¼šleader æœ‰å¯èƒ½ä¸æ˜¯æ–°é…ç½®ä¸­çš„ä¸€å‘˜ï¼ˆè¯‘è€…æ³¨ï¼šä¹Ÿå°±æ˜¯è¯´è¿™ä¸ª leader åé¢æ˜¯éœ€è¦è¢«ä¸‹çº¿çš„ï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œleader ä¸€æ—¦æäº¤äº† Cnew æ—¥å¿—æ¡ç›®ï¼Œå®ƒå°±ä¼šé€€ä½ä¸º followerï¼ˆè¯‘è€…æ³¨ï¼šCold,new çŠ¶æ€ä¸‹ä¾æ—§å¯ç”¨ï¼‰ã€‚è¿™å°±æ„å‘³ç€æœ‰è¿™æ ·ä¸€æ®µæ—¶é—´ï¼ˆleader æäº¤ Cnew æœŸé—´ï¼‰ï¼šleader ç®¡ç†ç€ä¸€ä¸ªä¸åŒ…æ‹¬è‡ªå·±çš„é›†ç¾¤ï¼Œå®ƒä¼šå¤åˆ¶æ—¥å¿—ç»™å…¶ä»–èŠ‚ç‚¹ï¼Œä½†æ˜¯ç®—å‰¯æœ¬æ•°é‡çš„æ—¶å€™ä¸ä¼šç®—ä¸Šè‡ªå·±ã€‚leader è½¬æ¢å‘ç”Ÿåœ¨ Cnew è¢«æäº¤çš„æ—¶å€™ï¼Œå› ä¸ºè¿™æ˜¯æ–°é…ç½®å¯ä»¥ç‹¬ç«‹è¿è¡Œçš„æœ€æ—©æ—¶åˆ»ï¼ˆåœ¨è¿™ä¸ªæ—¶åˆ»ä¹‹åï¼Œä¸€å®šæ˜¯ä» Cnew ä¸­é€‰å‡ºæ–°çš„ leaderï¼‰ã€‚åœ¨è¿™ä¸ªæ—¶é—´ç‚¹ä¹‹å‰ï¼Œæœ‰å¯èƒ½åªèƒ½ä» Cold ä¸­é€‰å‡º leaderã€‚ ç¬¬ä¸‰ä¸ªé—®é¢˜ï¼šé‚£ä¹ˆè¢«ç§»é™¤çš„èŠ‚ç‚¹ï¼ˆä¸å¤„äº Cnew çŠ¶æ€çš„èŠ‚ç‚¹ï¼‰æœ‰å¯èƒ½ä¼šæ‰°ä¹±é›†ç¾¤ã€‚è¿™äº›èŠ‚ç‚¹å°†ä¸ä¼šæ”¶åˆ°å¿ƒè·³ä¿¡æ¯ï¼Œæ‰€ä»¥å½“é€‰ä¸¾è¶…æ—¶æ—¶ï¼Œå®ƒä»¬å°±ä¼šè¿›è¡Œæ–°çš„é€‰ä¸¾è¿‡ç¨‹ã€‚å®ƒä»¬ä¼šå‘é€å¸¦æœ‰æ–°ä»»æœŸå·çš„ RequestVote RPCsï¼Œè¿™æ ·ä¼šå¯¼è‡´å½“å‰çš„ leader å›åˆ° follower çŠ¶æ€ï¼Œç„¶åé€‰å‡ºä¸€ä¸ªæ–°çš„ leaderã€‚ä½†æ˜¯è¿™äº›è¢«ç§»é™¤çš„èŠ‚ç‚¹è¿˜æ˜¯ä¼šæ”¶ä¸åˆ°å¿ƒè·³ï¼Œç„¶åå†æ¬¡è¶…æ—¶ï¼Œå†æ¬¡å¾ªç¯è¿™ä¸ªè¿‡ç¨‹ï¼Œå¯¼è‡´ç³»ç»Ÿçš„å¯ç”¨æ€§å¾ˆå·®ã€‚ ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œå½“èŠ‚ç‚¹è®¤ä¸ºå½“å‰æœ‰ leader å­˜åœ¨æ—¶ï¼ŒèŠ‚ç‚¹ä¼šå¿½ç•¥ RequestVote RPCsã€‚å…·ä½“æ¥è¯´ï¼Œå½“ä¸€ä¸ªèŠ‚ç‚¹åœ¨æœ€å°é€‰ä¸¾è¶…æ—¶æ—¶é—´å†…æ”¶åˆ°ä¸€ä¸ª RequestVote RPCï¼Œå®ƒä¸ä¼šæ›´æ–°å®ƒçš„ä»»æœŸæˆ–æˆäºˆå®ƒçš„æŠ•ç¥¨ã€‚è¿™ä¸ä¼šå½±å“æ­£å¸¸çš„é€‰ä¸¾ï¼Œæ¯ä¸ªèŠ‚ç‚¹åœ¨å¼€å¯ä¸€è½®é€‰ä¸¾ä¹‹å‰ï¼Œå®ƒä¼šè‡³å°‘ç­‰å¾…ä¸€æ¬¡æœ€å°é€‰ä¸¾è¶…æ—¶æ—¶é—´ã€‚ç›¸åï¼Œè¿™æœ‰åˆ©äºé¿å…è¢«ç§»é™¤çš„èŠ‚ç‚¹çš„æ‰°ä¹±ï¼šå¦‚æœä¸€ä¸ª leader èƒ½å¤Ÿå‘é€å¿ƒè·³ç»™é›†ç¾¤ï¼Œé‚£å®ƒå°±ä¸ä¼šè¢«æ›´å¤§çš„ä»»æœŸå·åºŸé»œã€‚ è¯‘è€…æ³¨ï¼šå¯¹é…ç½®å˜æ›´çš„å½’çº³ é…ç½®å˜æ›´è¿‡ç¨‹ leader åœ¨æœ¬åœ°ç”Ÿæˆä¸€ä¸ªæ–°çš„æ—¥å¿—æ¡ç›®ï¼Œå…¶å†…å®¹æ˜¯ Cold âˆª Cnewï¼Œä»£è¡¨å½“å‰æ—¶åˆ»æ–°æ—§æˆå‘˜é…ç½®å…±å­˜ï¼Œå†™å…¥æœ¬åœ°æ—¥å¿—ï¼Œç§°ä¸º Cold,newã€‚åé¢ leader å°±ä»¥è¯¥æ—¥å¿—ä½œä¸ºè‡ªå·±çš„é…ç½®äº†ã€‚åŒæ—¶å°†è¯¥æ—¥å¿—æ¡ç›®å¤åˆ¶é›†ç¾¤ä¸­æ˜¯æ‰€æœ‰èŠ‚ç‚¹ä¸­ã€‚åœ¨æ­¤ä¹‹åæ–°çš„æ—¥å¿—åŒæ­¥éœ€è¦ä¿è¯å¾—åˆ° Cold å’Œ Cnew ä¸¤ä¸ªå¤šæ•°æ´¾çš„ç¡®è®¤ã€‚ follower æ”¶åˆ° Cold.new çš„æ—¥å¿—åæ›´æ–°æœ¬åœ°æ—¥å¿—ï¼Œå¹¶ä¸”æ­¤æ—¶å°±ä»¥è¯¥é…ç½®ä½œä¸ºè‡ªå·±çš„æˆå‘˜é…ç½®ã€‚ å¦‚æœ Cold å’Œ Cnew ä¸­çš„ä¸¤ä¸ªå¤šæ•°æ´¾ç¡®è®¤äº† Cold.new è¿™ä¸ªæ—¥å¿—æ¡ç›®ï¼Œleader å°±æäº¤å®ƒã€‚ æ¥ä¸‹æ¥ leader ç”Ÿæˆä¸€æ¡æ–°çš„æ—¥å¿—æ¡ç›®ï¼Œå…¶å†…å®¹æ˜¯æ–°æˆå‘˜é…ç½® Cnewï¼ŒåŒæ ·å°†è¯¥æ—¥å¿—æ¡ç›®å†™å…¥æœ¬åœ°æ—¥å¿—ï¼ŒåŒæ—¶å¤åˆ¶ç»™é›†ç¾¤ä¸­å…¶ä»–èŠ‚ç‚¹ã€‚ follower æ”¶åˆ°æ–°æˆå‘˜é…ç½® Cnew åï¼Œå°†å…¶å†™å…¥æ—¥å¿—ï¼Œå¹¶ä¸”ä»æ­¤åˆ»èµ·ï¼Œå°±ä»¥è¯¥é…ç½®ä½œä¸ºè‡ªå·±çš„æˆå‘˜é…ç½®ï¼Œå¹¶ä¸”å¦‚æœå‘ç°è‡ªå·±ä¸åœ¨ Cnew è¿™ä¸ªæˆå‘˜é…ç½®ä¸­ä¼šè‡ªåŠ¨é€€å‡ºã€‚ leader æ”¶åˆ° Cnew çš„å¤šæ•°æ´¾ç¡®è®¤åï¼Œè¡¨ç¤ºæˆå‘˜å˜æ›´æˆåŠŸï¼Œåç»­çš„æ—¥å¿—åªè¦å¾—åˆ° Cnew å¤šæ•°æ´¾ç¡®è®¤å³å¯ã€‚ å®Œæˆä¸Šè¿°ä¸¤é˜¶æ®µåï¼Œleader å°±å¯ä»¥ç»™å®¢æˆ·ç«¯å›å¤é…ç½®å˜æ›´æ‰§è¡ŒæˆåŠŸã€‚ å¦‚æœå½“å‰çš„ leader ä¸åœ¨ Cnew çš„é…ç½®ä¸­ä¼šæ€ä¹ˆæ ·ï¼Ÿ å› ä¸ºå½“å‰ leader ä¸åœ¨ Cnew é…ç½®ä¸­ï¼Œæ‰€ä»¥å½“ Cnew æ—¥å¿—æ¡ç›®è¢«æäº¤çš„æ—¶å€™ï¼Œleader å…¶å®æ˜¯è¦è¢«ä¸‹çº¿çš„ï¼ˆæ¯”å¦‚è¯´é›†ç¾¤èŠ‚ç‚¹æ•°ä» 5 ç¼©å®¹ä¸º 3ï¼Œä¸”åˆšå¥½ä¸‹çº¿çš„èŠ‚ç‚¹ä¸­åŒ…å«å½“å‰ leaderï¼‰ã€‚é‚£è¿™æ ·çš„è¯ï¼Œåœ¨ Cold,new çŠ¶æ€ä¸‹ï¼Œleader è¿˜æ˜¯å¯ç”¨çš„ï¼Œä½†æ˜¯ä¸€æ—¦ Cnew æ—¥å¿—æ¡ç›®è¢«æäº¤äº†ï¼Œleader å°±éœ€è¦ä¸‹çº¿äº†ï¼Œè¿™ä¸ªæ—¶å€™ä¸ç”¨å½“å¿ƒï¼Œå› ä¸º Cnew å·²ç»è¢«å¤åˆ¶è¿‡åŠäº†ï¼Œé‡æ–°é€‰ leader ä¹Ÿä¸€å®šæ˜¯é€‰æœ‰ Cnew çš„ã€‚ å¦‚æœåœ¨é…ç½®åˆ†å‘è¿‡ç¨‹ä¸­ leader å´©æºƒäº†æ€ä¹ˆåŠï¼Ÿ åˆ†ä¸¤ç§æƒ…å†µï¼š Cnew å·²ç»åˆ†å‘è¿‡åŠ é›†ç¾¤å¼€å§‹é‡æ–°é€‰ä¸¾ï¼Œæ­¤æ—¶åœ¨ Cnew çš„è§„åˆ™ä¸‹ï¼Œä¸å­˜åœ¨æ–°é…ç½®ä¸­çš„èŠ‚ç‚¹ä¸ä¼šèµ¢å¾—é€‰ä¸¾ï¼ˆå› ä¸ºä»–ä»¬è¦åœ¨Cold,new çš„æƒ…å†µä¸‹å†³å®šï¼Œä½†æ˜¯æ‹¿ä¸åˆ° Cnew çš„é€‰ç¥¨ï¼‰ï¼Œåªæœ‰æ‹¿åˆ° Cnew çš„èŠ‚ç‚¹å¯èƒ½æˆä¸º leader å¹¶ç»§ç»­ä¸‹å‘ Cnew é…ç½®ï¼Œæµç¨‹æ¢å¤ã€‚ Cnew æ²¡æœ‰åˆ†å‘è¿‡åŠ è¿™ç§æƒ…å†µä¸‹ï¼ŒCold,new å’Œ Cnew çš„èŠ‚ç‚¹éƒ½å¯ä»¥æˆä¸º leaderï¼Œä½†æ˜¯æ— æ‰€è°“ï¼Œå› ä¸ºæ— è®ºè°æˆä¸º leaderï¼Œéƒ½èƒ½æ ¹æ®å½“å‰çš„é…ç½®ç»§ç»­å®Œæˆåç»­æµç¨‹ï¼ˆå¦‚æœæ˜¯ Cnew é‚£ä¹ˆç›¸å½“ä¸å®Œæˆäº†æœ€ç»ˆçš„é…ç½®ï¼Œä¸åœ¨ Cnew çš„èŠ‚ç‚¹ä¼šå› ä¸ºæ²¡æœ‰å¿ƒè·³æ•°æ®è€Œå¤±æ•ˆï¼‰ã€‚ æ—§é…ç½®èŠ‚ç‚¹ä¸‹çº¿é€ æˆçš„é—®é¢˜ Raft çš„å¤„ç†æ–¹å¼ï¼šå½“èŠ‚ç‚¹ç¡®ä¿¡æœ‰ leader å­˜åœ¨æ—¶ï¼Œä¸ä¼šè¿›è¡ŒæŠ•ç¥¨ï¼ˆåœ¨ leader è¶…æ—¶ä¹‹å‰æ”¶åˆ°æ–°çš„æŠ•ç¥¨è¯·æ±‚æ—¶ä¸ä¼šæå‡ä»»æœŸå·å’Œåšå‡ºæŠ•ç¥¨ï¼‰ã€‚ä¸”å¼€å§‹é€‰ä¸¾ä¹‹å‰ç­‰å¾…ä¸€ä¸ªé€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼Œè¿™æ ·åœ¨æ–° leader æ­£å¸¸å·¥ä½œçš„æƒ…å†µä¸‹ï¼Œä¸ä¼šå—åˆ°æ—§èŠ‚ç‚¹çš„å½±å“ã€‚ æ—§é…ç½®èŠ‚ç‚¹åœ¨å‘èµ·é€‰ä¸¾å‰éœ€è¦ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œé‚£ä¹ˆè¿™æ®µæ—¶é—´æ–° leader å¯ä»¥å‘é€å¿ƒè·³ï¼Œè¿™æ ·å°±å‡å°‘äº†å½±å“ã€‚ å¯¹æ­£å¸¸æµç¨‹çš„å½±å“ä¸å¤§ã€‚ï¼ˆleader å¤±æ•ˆåè¦ç­‰ä¸€æ®µæ—¶é—´ï¼Œæ²¡æœ‰åŠæ—¶è§¦å‘ï¼Œç„¶è€Œæœ¬èº«è¿™é‡Œå°±æœ‰ä¸€ä¸ªåˆ¤æ–­å¤±æ•ˆçš„æ—¶é—´ï¼Œå¥½åƒå½±å“ä¸å¤§ï¼›æ¯”å¦‚åŸå…ˆè¶…æ—¶æ—¶é—´æ˜¯ 10sï¼Œé‚£ä¹ˆå¦‚æœè®¾ç½®æˆ 5sï¼ŒåŸç­–ç•¥ä¸‹ 10s è¶…æ—¶å°±æ˜¯ 10s åå¼€å§‹é€‰ä¸¾ï¼Œæ–°ç­–ç•¥ä¸‹ 5s è¶…æ—¶å°±æ˜¯è¶…æ—¶åå†ç­‰ 5s å†å¼€å§‹é€‰ä¸¾ï¼Œå½±å“å°±æ˜¯è¶…æ—¶æ—¶é—´å˜çŸ­ï¼‰ æ— æ•°æ®çš„æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ä¸­çš„é—®é¢˜ æ–°åŠ å…¥çš„èŠ‚ç‚¹éœ€è¦æ—¶é—´å¤åˆ¶æ•°æ®ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹å®Œæˆä¹‹å‰ï¼ŒRaft é‡‡ç”¨ä»¥ä¸‹æœºåˆ¶æ¥ä¿è¯å¯ç”¨æ€§ï¼š æ–°åŠ å…¥èŠ‚ç‚¹æ²¡æœ‰æŠ•ç¥¨æƒï¼ˆ leader å¤åˆ¶æ—¥å¿—ç»™ä»–ä»¬ï¼Œä½†è®¡ç®—å·²å¤åˆ¶æ—¥å¿—æ¡ç›®çš„å‰¯æœ¬æ•°çš„æ—¶å€™ä¸è€ƒè™‘å®ƒä»¬ï¼‰ï¼Œç›´åˆ°è¿™äº›èŠ‚ç‚¹çš„æ—¥å¿—è¿½ä¸Šå…¶ä»–èŠ‚ç‚¹ã€‚ å¦‚æœåœ¨é…ç½®å˜æ›´è¿‡ç¨‹ä¸­æ¥æ”¶åˆ°ç”¨æˆ·è¯·æ±‚çš„è¯ï¼Œæ˜¯ç”¨æ—§é…ç½®å“åº”è¿˜æ˜¯ç”¨æ–°é…ç½®å“åº”ï¼Ÿ æŒ‰ç…§ç¬”è€…çš„ç†è§£ï¼Œè¿™ä¸ªæ–¹é¢ï¼Œå¯¹ Raft åè®®çš„å…·ä½“å®ç°å¯ä»¥æ ¹æ®è‡ªèº«éœ€æ±‚æ¥è‡ªå®šä¹‰å®ç°ï¼ŒRaft çš„è”åˆå…±è¯†æ˜¯ä¸ºäº†é¿å…åŒä¸€æ—¶åˆ»å‡ºç°äº† 2 ä¸ª leaderï¼Œé¿å…äº†å¯¹å®¢æˆ·ç«¯çš„ä¸€ä¸ªè¯·æ±‚åŒæ—¶æœ‰ä¸¤ä¸ªä¸åŒçš„å“åº”å‡ºç°ã€‚è€Œåœ¨å…·ä½“å®ç°ä¸­ï¼Œåœ¨æŸä¸ªé˜¶æ®µï¼Œç©¶ç«Ÿæ˜¯é‡‡å–æ–°é…ç½®å“åº”è¿˜æ˜¯æ—§é…ç½®å“åº”ï¼Œå¯ä»¥å†æ–Ÿé…Œã€‚ æ¯”å¦‚è¯´å¯ä»¥è¿™æ ·ï¼š Cold é˜¶æ®µï¼šä½¿ç”¨æ—§é…ç½®ï¼Œéœ€è¦è¿‡åŠæ—§é…ç½®èŠ‚ç‚¹ç¡®è®¤ Cnew å·²æäº¤é˜¶æ®µï¼šä½¿ç”¨æ–°é…ç½®ï¼Œéœ€è¦è¿‡åŠæ–°é…ç½®èŠ‚ç‚¹ç¡®è®¤ Cold,new é˜¶æ®µï¼šé…ç½®ä¿¡æ¯ä¸­æœ‰èŠ‚ç‚¹æ•°é‡ï¼ˆè¿™æ ·æ‰å¯èƒ½åˆ¤æ–­æ˜¯å¦è¿‡åŠï¼‰ï¼Œè¿™ä¸ªæ—¶å€™æ–°æ—§é…ç½®éƒ½éœ€è¦è¿‡åŠèŠ‚ç‚¹ç¡®è®¤ï¼Œè€Œå“åº”æ–°é…ç½®æ‰§è¡Œçš„ç»“æœè¿˜æ˜¯å“åº”æ—§é…ç½®æ‰§è¡Œçš„ç»“æœï¼Œå°±çœ‹ old å¤šè¿˜æ˜¯ new å¤šï¼Œè°å¤šç”¨è°ã€‚ å¦‚æœ leader è¦ä¸‹çº¿ï¼Œå®¢æˆ·ç«¯å‘æ¥çš„æ–°çš„è¯·æ±‚å¦‚ä½•å¤„ç†ï¼Ÿ å¦‚æœæ˜¯åœ¨ leader å¤åˆ¶ Cnew ä¹‹åï¼Œæäº¤ Cnew ä¹‹å‰çš„è¯ï¼Œleader å·¥ä½œåœ¨æ–°çš„é›†ç¾¤é…ç½®ä¸‹ï¼Œæ‰€ä»¥ä¼šå°†æ—¥å¿—å¤åˆ¶åˆ°æ–°é›†ç¾¤çš„èŠ‚ç‚¹ä¸‹ï¼Œå½“æ”¶åˆ°æ–°é›†ç¾¤ï¼ˆä¸åŒ…å« leader æœ¬èº«ï¼‰è¶…è¿‡åŠæ•°èŠ‚ç‚¹ç¡®è®¤åï¼Œå°±å¯ä»¥æäº¤æ—¥å¿—ã€‚ åœ¨å…¶ä»–é˜¶æ®µï¼Œleader å°±æ˜¯æ­£å¸¸å¯ç”¨çš„ã€‚ æ‰€è°“ Cnew å’Œ Cold,new æ—¥å¿—æ¡ç›®ï¼Œé‡Œé¢æ²¡æœ‰æ•°æ®ï¼Œåªæœ‰æŒ‡ä»¤ï¼Œé‡Œé¢çš„æŒ‡ä»¤å°±æ˜¯è®©èŠ‚ç‚¹æ‰§è¡Œå¯¹åº”çš„é…ç½®é¡¹ã€‚ 7. æ—¥å¿—å‹ç¼© åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼ŒRaft çš„æ—¥å¿—ä¼šéšç€å®¢æˆ·ç«¯è¯·æ±‚çš„å¢åŠ è€Œä¸æ–­å¢é•¿ã€‚ä½†åœ¨å®é™…ç³»ç»Ÿä¸­ï¼Œæ—¥å¿—ä¸å¯èƒ½æ— é™åˆ¶åœ°å¢é•¿ã€‚éšç€æ—¥å¿—è¶Šæ¥è¶Šé•¿ï¼Œå®ƒä¼šå ç”¨è¶Šæ¥è¶Šå¤šçš„ç©ºé—´ï¼Œå¹¶ä¸”éœ€è¦èŠ±æ›´å¤šçš„æ—¶é—´æ¥é‡æ–°æ‰§è¡Œæ—¥å¿—ä¸­çš„æ—¥å¿—æ¡ç›®ã€‚å¦‚æœæ²¡æœ‰ä¸€å®šçš„æœºåˆ¶æ¥æ¸…é™¤æ—¥å¿—ä¸­ç§¯ç´¯çš„è¿‡æœŸçš„ä¿¡æ¯ï¼Œé‚£ä¹ˆæœ€ç»ˆä¸€å®šä¼šå½±å“ç³»ç»Ÿçš„å¯ç”¨æ€§ã€‚ å¿«ç…§æŠ€æœ¯ï¼ˆsnapshottingï¼‰ æ˜¯æ—¥å¿—å‹ç¼©æœ€ç®€å•çš„æ–¹æ³•ã€‚åœ¨å¿«ç…§æŠ€æœ¯ä¸­ï¼ŒæŸä¸ªæ—¶é—´ç‚¹ä¸‹çš„å‰æ•´ä¸ªç³»ç»Ÿçš„çŠ¶æ€éƒ½ä¼šä»¥å¿«ç…§çš„å½¢å¼æŒä¹…åŒ–èµ·æ¥ï¼Œç„¶åè¯¥æ—¶é—´ç‚¹ä¹‹å‰çš„æ—¥å¿—ä¼šè¢«å…¨éƒ¨ä¸¢å¼ƒã€‚å¿«ç…§æŠ€æœ¯å‘—ä½¿ç”¨åœ¨ Chubby å’Œ ZooKeeper å½“ä¸­ï¼Œæ¥ä¸‹æ¥çš„ç« èŠ‚ä¼šä»‹ç» Raft ä¸­çš„å¿«ç…§æŠ€æœ¯ã€‚ å¢é‡å‹ç¼©æ–¹æ³•ï¼ˆIncremental approach to compactionï¼‰ï¼Œä¾‹å¦‚æ—¥å¿—æ¸…æ´—ï¼ˆlog cleaningï¼‰[36] å’Œæ—¥å¿—ç»“æ„åˆå¹¶æ ‘ï¼ˆlog-structured merge treesï¼‰[30, 5]ï¼Œéƒ½æ˜¯å¯è¡Œçš„ã€‚è¿™äº›æ–¹æ³•æ¯æ¬¡åªå¯¹ä¸€å°éƒ¨åˆ†æ•°æ®è¿›è¡Œæ“ä½œï¼Œè¿™æ ·å°±åˆ†æ•£äº†å‹ç¼©çš„è´Ÿè½½å‹åŠ›ã€‚é¦–å…ˆï¼Œé€‰æ‹©ä¸€ä¸ªç§¯ç´¯äº†å¤§é‡è¢«åˆ é™¤æˆ–è¢«è¦†ç›–çš„å¯¹è±¡çš„æ•°æ®åŒºåŸŸï¼Œç„¶åé‡å†™è¯¥åŒºåŸŸå†…è¿˜æ´»ç€çš„å¯¹è±¡ï¼Œä¹‹åé‡Šæ”¾è¯¥åŒºåŸŸã€‚å’Œå¿«ç…§æŠ€æœ¯ç›¸æ¯”ï¼Œè¿™éœ€è¦å¤§é‡é¢å¤–çš„æœºåˆ¶ï¼Œå¹¶ä¸”å¢åŠ äº†æ›´å¤šçš„å¤æ‚æ€§ï¼Œå¿«ç…§æŠ€æœ¯é€šè¿‡æ“ä½œæ•´ä¸ªæ•°æ®é›†æ¥ç®€åŒ–é—®é¢˜ã€‚è™½ç„¶æ—¥å¿—æ¸…ç†éœ€è¦å¯¹ Raft è¿›è¡Œä¿®æ”¹ï¼Œä½†æ˜¯çŠ¶æ€æœºå¯ä»¥ä½¿ç”¨ä¸å¿«ç…§æŠ€æœ¯ç›¸åŒçš„æ¥å£æ¥å®ç° LSMï¼ˆæ—¥å¿—ç»“æ„åˆå¹¶ï¼‰ æ ‘ã€‚ image-20210715195808192 å›¾ 12 å±•ç¤ºäº† Raft å¿«ç…§æŠ€æœ¯çš„åŸºæœ¬æ€æƒ³ã€‚æ¯ä¸€ä¸ªèŠ‚ç‚¹ç‹¬ç«‹åœ°ç”Ÿæˆå¿«ç…§ï¼Œå¿«ç…§ä¸­åªåŒ…å«è‡ªå·±æ—¥å¿—ä¸­å·²ç»è¢«æäº¤çš„æ¡ç›®ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸»è¦çš„å·¥ä½œæ˜¯çŠ¶æ€æœºå°†è‡ªå·±çš„çŠ¶æ€å†™å…¥å¿«ç…§ä¸­ã€‚Raft åœ¨å¿«ç…§ä¸­è¿˜ä¿ç•™äº†å°‘é‡çš„å…ƒæ•°æ®ï¼š last included indexï¼šæŒ‡çš„æ˜¯æœ€åä¸€ä¸ªè¢«å¿«ç…§å–ä»£çš„æ—¥å¿—æ¡ç›®çš„ç´¢å¼•å€¼ï¼ˆçŠ¶æ€æœºæœ€ååº”ç”¨çš„æ—¥å¿—æ¡ç›®ï¼‰ last included termï¼šæŒ‡çš„æ˜¯è¯¥æ¡ç›®æ‰€å¤„çš„ä»»æœŸå· ä¿ç•™è¿™äº›å…ƒæ•°æ®æ˜¯ä¸ºäº†æ”¯æŒå¿«ç…§åç¬¬ä¸€ä¸ªæ¡ç›®çš„ AppendEntries ä¸€è‡´æ€§æ£€æŸ¥ï¼Œå› ä¸ºè¯¥æ¡ç›®éœ€è¦ä¸€ä¸ªä¹‹å‰çš„æ—¥å¿—ç´¢å¼•å’Œä»»æœŸå·ã€‚ä¸ºäº†æ”¯æŒé›†ç¾¤æˆå‘˜å˜æ›´ï¼ˆç¬¬ 6 èŠ‚ä¸­è®¨è®ºçš„ï¼‰ï¼Œå¿«ç…§ä¸­è¿˜åŒ…å«æ—¥å¿—ä¸­åˆ° last included index ä¸ºæ­¢çš„æœ€æ–°çš„é…ç½®ã€‚ä¸€æ—¦èŠ‚ç‚¹å®Œæˆäº†å¿«ç…§çš„å†™å…¥ï¼Œå®ƒå¯èƒ½å°±ä¼šåˆ é™¤ last included index åŠä¹‹å‰çš„æ‰€æœ‰æ—¥å¿—æ¡ç›®ï¼Œä»¥åŠä¹‹å‰çš„å¿«ç…§ã€‚ å°½ç®¡é€šå¸¸æƒ…å†µä¸‹ï¼ŒèŠ‚ç‚¹éƒ½æ˜¯ç‹¬ç«‹ç”Ÿæˆå¿«ç…§çš„ï¼Œä½†æ˜¯ leader ä¸å¯é¿å…å¶å°”éœ€è¦å‘é€å¿«ç…§ç»™ä¸€äº›è½åçš„ followerã€‚è¿™é€šå¸¸å‘ç”Ÿåœ¨ leader å·²ç»ä¸¢å¼ƒäº†éœ€è¦å‘ç»™ follower çš„ä¸‹ä¸€æ¡æ—¥å¿—æ¡ç›®çš„æ—¶å€™ã€‚å¹¸è¿çš„æ˜¯ï¼Œè¿™ç§æƒ…å†µåœ¨æ­£å¸¸æ“ä½œä¸­æ˜¯ä¸ä¼šå‡ºç°çš„ï¼šä¸€ä¸ªä¸ leader ä¿æŒåŒæ­¥çš„ follower é€šå¸¸éƒ½ä¼šæ‹¥æœ‰è¯¥æ—¥å¿—æ¡ç›®ã€‚ä¸è¿‡å¦‚æœä¸€ä¸ª follower è¿è¡Œæ¯”è¾ƒç¼“æ…¢ï¼Œæˆ–è€…æ˜¯å®ƒåˆšåŠ å…¥é›†ç¾¤ï¼Œé‚£ä¹ˆå®ƒå°±å¯èƒ½ä¼šæ²¡æœ‰è¯¥æ—¥å¿—æ¡ç›®ã€‚è¿™ä¸ªæ—¶å€™ leader ä¼šé€šè¿‡ç½‘ç»œå°†è¯¥å¿«ç…§å‘é€ç»™è¯¥ followerï¼Œä»¥ä½¿å¾—è¯¥ follower å¯ä»¥æ›´æ–°åˆ°æœ€æ–°çš„çŠ¶æ€ã€‚ image-20210715205247442 è¿™ä¸ªæ—¶å€™ leader ä½¿ç”¨äº†ä¸€ç§æ–°çš„ RPC æ¥å‘é€å¿«ç…§ç»™é‚£äº›å¤ªè½åçš„ followersï¼Œå¦‚å›¾ 13 æ‰€ç¤ºï¼Œè¿™ç§ RPC å«åš InstallSnapshotã€‚å½“ä¸€ä¸ª follower é€šè¿‡è¿™ç§ RPC æ”¶åˆ°å¿«ç…§çš„æ—¶å€™ï¼Œå®ƒå¿…é¡»å†³å®šå¦‚ä½•å¤„ç†å½“å‰å·²ç»å­˜åœ¨çš„æ—¥å¿—æ¡ç›®ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œè¿™ä»½å¿«ç…§ä¼šåŒ…å«æ¥å—è€…æ—¥å¿—è€…æ²¡æœ‰çš„ä¿¡æ¯ã€‚æ‰€ä»¥è¿™ç§æƒ…å†µä¸‹ follower ä¼šä¸¢å¼ƒå®ƒçš„æ•´ä¸ªæ—¥å¿—ï¼Œå®ƒçš„æ—¥å¿—ä¼šå…¨éƒ¨è¢«å¿«ç…§å–ä»£ï¼Œå¹¶ä¸”å¯èƒ½æœ‰ä¸å¿«ç…§å†²çªçš„æœªæäº¤çš„æ¡ç›®ã€‚ç›¸åï¼Œå¦‚æœä¸€ä¸ª follower æ”¶åˆ°ä¸€ä¸ªæè¿°å…¶æ—¥å¿—å‰ç¼€çš„å¿«ç…§ï¼ˆå¯èƒ½æ˜¯ç”±äºé‡ä¼ æˆ–é”™è¯¯ï¼‰ï¼Œåˆ™è¢«å¿«ç…§è¦†ç›–çš„æ—¥å¿—æ¡ç›®å°†è¢«åˆ é™¤ï¼Œä½†æ˜¯å¿«ç…§ä¹‹åçš„æ¡ç›®ä»ç„¶æœ‰æ•ˆï¼Œä¸”å¿…é¡»è¦ä¿ç•™ã€‚ è¿™ç§å¿«ç…§çš„æ–¹å¼è¿åäº† Raft çš„ strong leader åŸåˆ™ï¼Œå› ä¸º follower å¯èƒ½åœ¨ä¸çŸ¥é“ leader çš„æƒ…å†µä¸‹åˆ›å»ºå¿«ç…§ã€‚ä½†æ˜¯æˆ‘ä»¬è®¤ä¸ºè¿™ç§è¿èƒŒæ˜¯åˆä¹æƒ…ç†çš„ã€‚leader çš„å­˜åœ¨ï¼Œæ˜¯ä¸ºäº†é˜²æ­¢åœ¨è¾¾æˆå…±è¯†çš„æ—¶å€™äº§ç”Ÿå†²çªï¼Œä½†æ˜¯åœ¨åˆ›å»ºå¿«ç…§çš„æ—¶å€™ï¼Œå…±è¯†å·²ç»è¾¾æˆäº†ï¼Œå› æ­¤æ²¡æœ‰å†³ç­–ä¼šå‡ºç°å†²çªã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæ•°æ®è¿˜æ˜¯è·Ÿä¹‹å‰ä¸€æ ·ï¼Œåªèƒ½ä» leader æµå‘ followerï¼Œåªä¸è¿‡ç°åœ¨å…è®¸ follower å¯ä»¥é‡æ–°ç»„ç»‡å®ƒä»¬çš„æ•°ç»„è€Œå·²ã€‚ æˆ‘ä»¬æ›¾ç»è€ƒè™‘è¿‡ä¸€ç§å¯æ›¿ä»£çš„æ–¹æ¡ˆï¼Œé‚£å°±æ˜¯åªæœ‰ leader å¯ä»¥åˆ›å»ºå¿«ç…§ï¼Œç„¶åç”± leader å°†è¿™ä»½å¿«ç…§å‘é€ç»™å…¶ä»–æ‰€æœ‰çš„ followerã€‚ä½†æ˜¯ï¼Œè¿™ç§æ–¹æ¡ˆæœ‰ä¸¤ä¸ªç¼ºç‚¹ï¼š å‘é€å¿«ç…§ç»™æ¯ä¸ª follower ä¼šæµªè´¹ç½‘ç»œå¸¦å®½å’Œå»¶ç¼“äº†å¿«ç…§å¤„ç†è¿‡ç¨‹ã€‚å®é™…ä¸Šæ¯ä¸€ä¸ª follower å·²ç»æ‹¥æœ‰äº†åˆ›å»ºè‡ªå·±å¿«ç…§æ‰€éœ€è¦çš„å…¨éƒ¨ä¿¡æ¯äº†ï¼Œæ‰€ä»¥å¾ˆæ˜¾ç„¶ï¼Œfollower æ ¹æ®æœ¬åœ°çš„çŠ¶æ€åˆ›å»ºå¿«ç…§è¦æ¯”é€šè¿‡ç½‘ç»œæ¥æ¥æ”¶åˆ«äººå‘è¿‡æ¥çš„è¦æ›´åŠ å®æƒ ã€‚ è¿™ä¼šé€ æˆ leader çš„å®ç°æ›´åŠ å¤æ‚ã€‚æ¯”å¦‚è¯´ï¼Œleader å‘é€å¿«ç…§ç»™ follower çš„åŒæ—¶è¦èƒ½å¤Ÿåšåˆ°å¹¶è¡Œåœ°å°†æ–°çš„æ—¥å¿—æ¡ç›®å‘é€ç»™å®ƒä»¬ï¼Œè¿™æ ·æ‰ä¸ä¼šé˜»å¡æ–°çš„å®¢æˆ·ç«¯è¯·æ±‚ï¼Œè¿™å°±å¤æ‚å¾—å¤šäº†ã€‚ è¿˜æœ‰ä¸¤ä¸ªé—®é¢˜ä¼šå½±å“å¿«ç…§çš„æ€§èƒ½ï¼š æ¯ä¸€ä¸ªèŠ‚ç‚¹å¿…é¡»åˆ¤æ–­ä½•æ—¶å»ç”Ÿæˆå¿«ç…§ã€‚å¦‚æœä¸€ä¸ªèŠ‚ç‚¹ç”Ÿæˆå¿«ç…§çš„é¢‘ç‡å¤ªé«˜ï¼Œé‚£ä¹ˆå°±ä¼šæµªè´¹å¤§é‡çš„ç£ç›˜å¸¦å®½å’Œå…¶ä»–èµ„æºï¼›å¦‚æœä¸€ä¸ªèŠ‚ç‚¹ç”Ÿæˆå¿«ç…§çš„é¢‘ç‡å¤ªä½ï¼Œé‚£ä¹ˆå°±è¦æ‰¿æ‹…è€—å°½å­˜å‚¨å®¹é‡çš„é£é™©ï¼ŒåŒæ—¶ä¹Ÿå¢åŠ äº†é‡å¯æ—¶é‡æ–°æ‰§è¡Œæ—¥å¿—çš„æ—¶é—´ã€‚ ä¸€ä¸ªç®€å•çš„ç­–ç•¥å°±æ˜¯å½“æ—¥å¿—å¤§å°è¾¾åˆ°ä¸€ä¸ªå›ºå®šçš„é˜ˆå€¼çš„æ—¶å€™å°±ç”Ÿæˆä¸€ä»½å¿«ç…§ã€‚å¦‚æœè¿™ä¸ªé˜ˆå€¼è®¾ç½®å¾—æ˜¾è‘—å¤§äºæœŸæœ›çš„å¿«ç…§çš„å¤§å°ï¼Œé‚£ä¹ˆå¿«ç…§çš„ç£ç›˜å¸¦å®½å¼€é”€å°†è¾ƒå°ã€‚ ç¬¬äºŒä¸ªå½±å“æ€§èƒ½çš„å°±æ˜¯å†™å¿«ç…§éœ€è¦èŠ±è´¹ä¸€å®šçš„æ—¶é—´ï¼Œè€Œæˆ‘ä»¬åˆä¸å¸Œæœ›å®ƒä¼šå½±å“åˆ°æ­£å¸¸çš„æ“ä½œã€‚ è§£å†³æ–¹æ¡ˆå°±æ˜¯ä½¿ç”¨ å†™æ—¶å¤åˆ¶çš„æŠ€æœ¯ï¼ˆcopy-on-writeï¼‰ ï¼Œè¿™æ ·æ–°çš„æ›´æ–°å°±å¯ä»¥åœ¨ä¸å½±å“æ­£åœ¨å†™çš„å¿«ç…§çš„æƒ…å†µä¸‹è¢«æ¥æ”¶ã€‚ä¾‹å¦‚ï¼Œå…·æœ‰æ³›å‹å‡½æ•°ç»“æ„çš„çŠ¶æ€æœºå¤©ç„¶æ”¯æŒè¿™æ ·çš„åŠŸèƒ½ã€‚å¦å¤–ï¼Œæ“ä½œç³»ç»Ÿå¯¹å†™æ—¶å¤åˆ¶æŠ€æœ¯çš„æ”¯æŒï¼ˆå¦‚ Linux ä¸Šçš„ forkï¼‰å¯ä»¥è¢«ç”¨æ¥åˆ›å»ºæ•´ä¸ªçŠ¶æ€æœºçš„å†…å­˜å¿«ç…§ï¼ˆæˆ‘ä»¬çš„å®ç°ç”¨çš„å°±æ˜¯è¿™ç§æ–¹æ³•ï¼‰ã€‚ 8. å®¢æˆ·ç«¯äº¤äº’ æœ¬èŠ‚ä»‹ç»å®¢æˆ·ç«¯å¦‚ä½•å’Œ Raft è¿›è¡Œäº¤äº’ï¼ŒåŒ…æ‹¬å®¢æˆ·ç«¯å¦‚ä½•æ‰¾åˆ° leader å’Œ Raft æ˜¯å¦‚ä½•æ”¯æŒçº¿æ€§åŒ–è¯­ä¹‰çš„ [10]ã€‚è¿™äº›é—®é¢˜å¯¹äºæ‰€æœ‰çš„åŸºäºå…±è¯†ç®—æ³•çš„ç³»ç»Ÿéƒ½æ˜¯å­˜åœ¨çš„ï¼ŒRaft çš„è§£å†³æ–¹æ¡ˆä¹Ÿè·Ÿå…¶ä»–çš„ç³»ç»Ÿå·®ä¸å¤šã€‚ Raft çš„å®¢æˆ·ç«¯ä»¬å°†æ‰€æœ‰çš„è¯·æ±‚å‘é€ç»™ leaderã€‚å½“å®¢æˆ·ç«¯ç¬¬ä¸€æ¬¡å¯åŠ¨çš„æ—¶å€™ï¼Œå®ƒä¼šéšæœºæŒ‘é€‰ä¸€ä¸ªèŠ‚ç‚¹æ¥è¿›è¡Œé€šä¿¡ã€‚å¦‚æœå®¢æˆ·ç«¯é¦–é€‰çš„ä¸æ˜¯ leaderï¼Œé‚£ä¹ˆè¢«å®¢æˆ·ç«¯é€‰ä¸­çš„èŠ‚ç‚¹å°±ä¼šæ‹’ç»å®¢æˆ·ç«¯çš„è¯·æ±‚å¹¶ä¸”æä¾›å…³äºå®ƒæœ€è¿‘æ”¶åˆ°çš„ leader çš„ä¿¡æ¯ï¼ˆAppendEntries RPC åŒ…å«äº† leader çš„ç½‘ç»œåœ°å€ï¼‰ã€‚å¦‚æœ leader å´©æºƒäº†ï¼Œå®¢æˆ·ç«¯è¯·æ±‚å°±ä¼šè¶…æ—¶ï¼Œè¿™ä¸ªæ—¶å€™å®¢æˆ·ç«¯éœ€è¦éšæœºé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹æ¥é‡è¯•å‘é€è¯·æ±‚ã€‚ æˆ‘ä»¬å¯¹ Raft çš„æœŸè®¸æ˜¯å¸Œæœ›å®ƒå¯ä»¥å®ç°çº¿æ€§åŒ–è¯­ä¹‰ï¼ˆå³æ¯æ¬¡æ“ä½œçœ‹èµ·æ¥ä¼¼ä¹éƒ½æ˜¯åœ¨è°ƒç”¨å’Œå“åº”ä¹‹é—´çš„æŸä¸ªç‚¹ä¸Šå³æ—¶æ‰§è¡Œä¸€æ¬¡ï¼‰ã€‚ä½†æ˜¯ï¼ŒæŒ‰ç…§ä¸Šé¢æè¿°çš„ï¼ŒRaft å¯èƒ½ä¼šå¯¹åŒä¸€æ¡æŒ‡ä»¤æ‰§è¡Œå¤šæ¬¡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ leader åœ¨æäº¤äº†æŸä¸ªæ—¥å¿—æ¡ç›®åï¼Œåœ¨è¿˜æ²¡æ¥å¾—åŠå“åº”å®¢æˆ·ç«¯çš„æ—¶å€™å°±å´©æºƒäº†ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯ä¼šå’Œæ–°çš„ leader é‡è¯•è¯¥æŒ‡ä»¤ï¼Œè¿™å°±é€ æˆäº†åŒä¸€æŒ‡ä»¤è¢«æ‰§è¡Œäº†ä¸¤æ¬¡ã€‚è§£å†³æ–¹æ¡ˆæ˜¯å®¢æˆ·ç«¯å¯¹äºæ¯ä¸€æ¡æŒ‡ä»¤éƒ½èµ‹äºˆä¸€ä¸ªå”¯ä¸€çš„åºåˆ—å·ã€‚ç„¶åï¼ŒçŠ¶æ€æœºè·Ÿè¸ªæ¯ä¸ªå®¢æˆ·ç«¯å·²ç»å¤„ç†çš„æœ€æ–°çš„åºåˆ—å·ä»¥åŠç›¸å…³è”çš„å“åº”ã€‚å¦‚æœçŠ¶æ€æœºæ¥æ”¶åˆ°äº†ä¸€æ¡å·²ç»æ‰§è¡Œè¿‡çš„æŒ‡ä»¤äº†ï¼Œå°±ç«‹å³ä½œå‡ºå“åº”ï¼Œå¹¶ä¸”ä¸ä¼šé‡å¤æ‰§è¡Œè¯¥æŒ‡ä»¤ã€‚ åªè¯»æ“ä½œï¼ˆRead-Onlyï¼‰å¯ä»¥ç›´æ¥å¤„ç†è€Œä¸è®°å½•æ—¥å¿—ã€‚ä½†æ˜¯ï¼Œå¦‚æœä¸é‡‡å–ä»»ä½•æªæ–½çš„è¯ï¼Œè¿™å¯èƒ½ä¼šæœ‰è¿”å›è¿‡æœŸæ•°æ®ï¼ˆstale dataï¼‰çš„é£é™©ã€‚å› ä¸º leader å“åº”å®¢æˆ·ç«¯è¯·æ±‚çš„æ—¶å€™å®ƒå¯èƒ½å·²ç»è¢«æ–°çš„ leader ä»£æ›¿äº†ï¼Œä½†æ˜¯å®ƒè¿˜ä¸çŸ¥é“è‡ªå·±å·²ç»ä¸æ˜¯æœ€æ–°çš„ leader äº†ã€‚ è¯‘è€…è¡¥å……ï¼šä¸ºä»€ä¹ˆä¸€ä¸ª leader å¥½å¥½çš„ä¼šæœ‰å¦å¤–ä¸€ä¸ª leader å‡ºç°ï¼Ÿ å‚è€ƒï¼šhttps://segmentfault.com/a/1190000039264427 å®é™…ä¸Šï¼Œè€çš„ leader å¯èƒ½ä¸ä¼šé©¬ä¸Šæ¶ˆå¤±ï¼Œä¾‹å¦‚ï¼šç½‘ç»œåˆ†åŒºå°† leader ä¸é›†ç¾¤çš„å…¶ä½™éƒ¨åˆ†åˆ†éš”ï¼Œå…¶ä½™éƒ¨åˆ†é€‰ä¸¾å‡ºäº†ä¸€ä¸ªæ–°çš„ leaderã€‚ç„¶åè€çš„ leader å´©æºƒåé‡æ–°è¿æ¥ï¼Œå¯èƒ½ä¼šä¸çŸ¥é“æ–°çš„ leader å·²ç»è¢«é€‰å‡ºæ¥äº†ã€‚ çº¿æ€§åŒ–çš„æ“ä½œè‚¯å®šä¸ä¼šè¿”å›è¿‡æœŸçš„æ•°æ®ã€‚Raft éœ€è¦ä½¿ç”¨ä¸¤ä¸ªé¢å¤–çš„é¢„é˜²æªæ–½æ¥åœ¨ä¸é€‚ç”¨æ—¥å¿—çš„æ—¶å€™ä¿è¯è¿™ä¸€ç‚¹ã€‚ leader å¿…é¡»æ‹¥æœ‰é‚£äº›å·²æäº¤çš„æ—¥å¿—æ¡ç›®çš„æœ€æ–°ä¿¡æ¯ã€‚Leader å®Œæ•´æ€§ç‰¹æ€§ï¼ˆLeader Completeness Propertyï¼‰ä¿è¯äº† leader ä¸€å®šæ‹¥æœ‰æ‰€æœ‰å·²è¢«æäº¤çš„æ—¥å¿—æ¡ç›®ï¼Œä½†æ˜¯åœ¨å®ƒä»»æœŸåˆšå¼€å§‹çš„æ—¶å€™ï¼Œå®ƒå¯èƒ½è¿˜ä¸çŸ¥é“å“ªäº›æ˜¯å·²ç»è¢«æäº¤çš„ã€‚ä¸ºäº†çŸ¥é“è¿™äº›ä¿¡æ¯ï¼Œå®ƒéœ€è¦åœ¨å®ƒçš„ä»»æœŸé‡Œæäº¤ä¸€ä¸ªæ—¥å¿—æ¡ç›®ã€‚ Raft é€šè¿‡è®© leader åœ¨ä»»æœŸå¼€å§‹çš„æ—¶å€™æäº¤ä¸€ä¸ªç©ºçš„æ—¥å¿—æ¡ç›®åˆ°æ—¥å¿—ä¸­æ¥è§£å†³è¯¥é—®é¢˜ã€‚ï¼ˆè¯‘è€…æ³¨ï¼šè¿™å°±æ˜¯å‰é¢ 5.4.2 èŠ‚æåˆ°çš„ no-op æ—¥å¿—ï¼‰ leader åœ¨å¤„ç†åªè¯»è¯·æ±‚çš„æ—¶å€™å¿…é¡»æ£€æŸ¥è‡ªå·±æ˜¯å¦å·²ç»è¢«æ›¿ä»£äº†ï¼ˆå› ä¸ºå¦‚æœä¸€ä¸ªæ–° leader è¢«é€‰å‡ºæ¥äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—§ leader çš„æ•°æ®å¯èƒ½å°±è¿‡æ—¶äº†ï¼‰ã€‚ Raft é€šè¿‡è®© leader åœ¨å“åº”åªè¯»è¯·æ±‚ä¹‹å‰ï¼Œå…ˆå’Œé›†ç¾¤ä¸­è¿‡åŠçš„èŠ‚ç‚¹äº¤æ¢ä¸€æ¬¡å¿ƒè·³ä¿¡æ¯æ¥è§£å†³è¯¥é—®é¢˜ã€‚ å¦ä¸€ç§å¯é€‰çš„æ–¹æ¡ˆï¼Œleader å¯ä»¥ä¾èµ–å¿ƒè·³æœºåˆ¶æ¥å®ç°ä¸€ç§ç§Ÿçº¦çš„å½¢å¼ [9]ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼çš„å®‰å…¨æ€§éœ€è¦ä¾èµ–äºæ—¶åºï¼ˆå‡è®¾æ—¶é—´è¯¯å·®æ˜¯æœ‰ç•Œçš„ï¼‰ã€‚ 9. ç®—æ³•å®ç°ä¸è¯„ä¼° æˆ‘ä»¬å·²ç»å®ç°äº† Raft ä½œä¸ºå¤åˆ¶çŠ¶æ€æœºçš„ä¸€éƒ¨åˆ†ï¼Œè¯¥çŠ¶æ€æœºå­˜å‚¨äº† RAMCloud [33] çš„é…ç½®ä¿¡æ¯ï¼Œå¹¶å¸®åŠ© RAMCloud åè°ƒå™¨è¿›è¡Œæ•…éšœè½¬ç§»ã€‚è¿™ä¸ª Raft å®ç°å¤§æ¦‚åŒ…å«äº† 2000+ è¡Œ C++ ä»£ç ï¼Œä½†æ˜¯è¿™é‡Œé¢æ²¡æœ‰åŒ…å«æµ‹è¯•ã€æ³¨é‡Šå’Œç©ºè¡Œã€‚è¿™äº›ä»£ç æ˜¯å¼€æºçš„ [23]ã€‚åŒæ—¶ä¹Ÿæœ‰å¤§çº¦ 25 ä¸ªå…¶ä»–ç‹¬ç«‹çš„ç¬¬ä¸‰æ–¹ã€é’ˆå¯¹ä¸åŒçš„å¼€å‘åœºæ™¯ã€åŸºäºè¿™ç¯‡è®ºæ–‡è‰ç¨¿çš„å¼€æºå®ç°ã€‚åŒæ—¶ï¼Œå¾ˆå¤šå…¬å¸å·²ç»éƒ¨ç½²äº†åŸºäº Raft ç®—æ³•çš„ç³»ç»Ÿäº†ã€‚ æœ¬èŠ‚å‰©ä¸‹çš„ç¯‡å¹…å°†ä»ä¸‰ä¸ªæ–¹é¢æ¥è¯„ä¼° Raft ç®—æ³•ï¼š å¯ç†è§£æ€§ æ­£ç¡®æ€§ æ€§èƒ½ 9.1 å¯ç†è§£æ€§ ä¸ºäº†è¡¡é‡ Raft ç›¸å¯¹äº Paxos çš„å¯ç†è§£æ€§ï¼Œæˆ‘ä»¬é’ˆå¯¹é«˜å±‚æ¬¡çš„æœ¬ç§‘ç”Ÿå’Œç ”ç©¶ç”Ÿï¼Œåœ¨æ–¯å¦ç¦å¤§å­¦çš„é«˜çº§æ“ä½œç³»ç»Ÿè¯¾ç¨‹å’ŒåŠ å·å¤§å­¦ä¼¯å…‹åˆ©åˆ†æ ¡çš„åˆ†å¸ƒå¼è®¡ç®—è¯¾ç¨‹ä¸Šï¼Œè¿›è¡Œäº†ä¸€é¡¹å®éªŒç ”ç©¶ã€‚æˆ‘ä»¬ä¸º Raft å’Œ Paxos åˆ†åˆ«å½•åˆ¶äº†ä¸€ä¸ªè§†é¢‘æ•™ç¨‹ï¼Œå¹¶ä¸”å‡†å¤‡äº†ç›¸åº”çš„å°æµ‹éªŒã€‚å…¶ä¸­ Raft è¯¾ç¨‹è¦†ç›–äº†æœ¬ç¯‡è®ºæ–‡é™¤äº†æ—¥å¿—å‹ç¼©ä¹‹å¤–çš„å…¨éƒ¨å†…å®¹ï¼Œè€Œ Paxos è¯¾ç¨‹æ¶µç›–äº†åˆ›å»ºä¸€ä¸ªä¸ Raft ç­‰ä»·çš„å¤åˆ¶çŠ¶æ€æœºçš„å…¨éƒ¨èµ„æ–™ï¼ŒåŒ…æ‹¬ signle-decree Paxosã€multi-decree Paxosã€é‡æ–°é…ç½®å’Œä¸€åˆ‡å®é™…ç³»ç»Ÿéœ€è¦çš„æ€§èƒ½ä¼˜åŒ–ï¼ˆæ¯”å¦‚ leader é€‰ä¸¾ï¼‰ã€‚è¿™ä¸ªå°æµ‹éªŒä¸»è¦æ˜¯æµ‹è¯•ä¸€äº›å¯¹ç®—æ³•çš„ç†è§£å’Œè§£é‡Šä¸€äº›è¾¹ç¼˜æƒ…å†µã€‚æ¯ä¸ªå­¦ç”Ÿéƒ½æ˜¯çœ‹å®Œç¬¬ä¸€ä¸ªè§†é¢‘ï¼Œç„¶ååšå¯¹åº”çš„æµ‹éªŒï¼Œç„¶åå†çœ‹ç¬¬äºŒä¸ªè§†é¢‘ï¼Œå†åšç¬¬äºŒä»½æµ‹éªŒã€‚ä¸ºäº†è§£é‡Šä¸ªäººè¡¨ç°ä¸ä»ç¬¬ä¸€éƒ¨åˆ†ç ”ç©¶ä¸­è·å¾—çš„ç»éªŒå·®å¼‚çš„åŸå› ï¼Œå¤§çº¦æœ‰ä¸€åŠçš„å­¦ç”Ÿå…ˆè¿›è¡Œ Paxos çš„éƒ¨åˆ†ï¼Œç„¶åå¦ä¸€åŠå­¦ç”Ÿå…ˆè¿›è¡Œ Raft çš„éƒ¨åˆ†ã€‚æˆ‘ä»¬é€šè¿‡è®¡ç®—å‚ä¸äººå‘˜çš„æ¯ä¸€ä»½æµ‹éªŒçš„å¾—åˆ†æ¥çœ‹å‚ä¸è€…æ˜¯å¦æ›´åŠ å®¹æ˜“ç†è§£ Raft ç®—æ³•ã€‚ æˆ‘ä»¬å°½å¯èƒ½çš„ä½¿å¾—åœ¨æ¯”è¾ƒ Raft å’Œ Paxos è¿‡ç¨‹ä¸­æ˜¯å…¬å¹³çš„ã€‚è¿™ä¸ªå®éªŒä»ä¸¤ä¸ªæ–¹é¢åå‘äº† Paxosï¼š 43 ä¸ªå‚ä¸è€…ä¸­æœ‰ 15 ä¸ªäººåœ¨ä¹‹å‰æœ‰ä¸€äº› Paxos çš„ç»éªŒ Paxos è§†é¢‘æ•™ç¨‹çš„æ—¶é•¿è¦é•¿ 14% å¦‚è¡¨æ ¼ 1 æ€»ç»“çš„é‚£æ ·ï¼Œæˆ‘ä»¬é‡‡å–äº†ä¸€äº›æªæ–½æ¥å‡è½»è¿™ç§æ½œåœ¨çš„åå‘ã€‚æˆ‘ä»¬æ‰€æœ‰çš„ææ–™éƒ½å¯ä¾›å®¡æŸ¥ [28, 31]ã€‚ å…³æ³¨ç‚¹ ç¼“å’Œåå‘é‡‡å–çš„æ‰‹æ®µ å¯ä¾›æŸ¥çœ‹çš„ææ–™ ç›¸åŒçš„è®²è¯¾è´¨é‡ ä¸¤ä»½æ•™ç¨‹é‡‡ç”¨åŒä¸€ä¸ªè®²å¸ˆã€‚Paxos çš„æ•™ç¨‹æ˜¯åœ¨ç°æœ‰çš„ä¸€äº›å¤§å­¦ä½¿ç”¨çš„ææ–™åŸºç¡€ä¸Šæ”¹è¿›çš„ã€‚Paxos çš„æ•™ç¨‹è¦é•¿ 14%ã€‚ è§†é¢‘ ç›¸åŒçš„æµ‹éªŒéš¾åº¦ é—®é¢˜ä»¥éš¾åº¦åˆ†ç»„ï¼Œåœ¨ä¸¤ä¸ªæµ‹éªŒé‡Œæˆå¯¹å‡ºç°ã€‚ å°æµ‹éªŒ å…¬å¹³è¯„åˆ† ä½¿ç”¨è¯„ä»·é‡è§„ã€‚éšæœºé¡ºåºæ‰“åˆ†ï¼Œä¸¤ä¸ªæµ‹éªŒäº¤æ›¿è¿›è¡Œã€‚ è¯„åˆ†ç»†åˆ™ è¡¨æ ¼1ï¼šè€ƒè™‘åˆ°æ½œåœ¨çš„å®éªŒåå‘ï¼Œæˆ‘ä»¬å¯¹äºæ¯ç§æƒ…å†µçš„è§£å†³æ–¹æ³•ï¼Œä»¥åŠç›¸åº”çš„ææ–™ã€‚ å¹³å‡ä¸Šçœ‹ï¼Œå‚ä¸è€…åœ¨ Raft æµ‹éªŒä¸Šçš„å¾—åˆ†è¦æ¯”åœ¨ Paxos æµ‹éªŒä¸Šçš„å¾—åˆ†é«˜å¤„ 4.9 åˆ†ï¼ˆåœ¨ 60 åˆ†ä¸­ï¼ŒRaft çš„å¹³å‡å¾—åˆ†æ˜¯ 25.7 åˆ†ï¼ŒPaxos çš„å¹³å‡å¾—åˆ†æ˜¯ 20.8 åˆ†ï¼‰ã€‚å›¾ 14 å±•ç¤ºäº†æ¯ä¸ªå‚ä¸è€…çš„å¾—åˆ†ã€‚é…å¯¹ t æ£€éªŒï¼ˆpaired t-testï¼‰è¡¨æ˜ï¼Œåœ¨ 95% çš„ç½®ä¿¡åº¦ä¸‹ï¼ŒRaft åˆ†æ•°çš„çœŸå®åˆ†å¸ƒçš„å¹³å‡å€¼è‡³å°‘è¦æ¯” Paxos çš„å¤§ 2.5 åˆ†ã€‚ image-20210716175208106 æˆ‘ä»¬ä¹Ÿå»ºç«‹äº†ä¸€ä¸ªçº¿æ€§å›å½’æ¨¡å‹æ¥é¢„æµ‹ä¸€ä¸ªæ–°çš„å­¦ç”Ÿçš„æµ‹éªŒæˆç»©ï¼Œè¿™ä¸ªæ¨¡å‹åŸºäºä»¥ä¸‹ä¸‰ç‚¹ï¼š ä»–ä»¬ä½¿ç”¨çš„æ˜¯å“ªä¸ªæµ‹éªŒ ä¹‹å‰å¯¹äº Paxos çš„ç»éªŒ å­¦ä¹ ç®—æ³•çš„é¡ºåº è¯¥æ¨¡å‹é¢„æµ‹ï¼Œå¯¹å°æµ‹éªŒçš„é€‰æ‹©ä¼šäº§ç”Ÿ 12.5 åˆ†çš„æœ‰åˆ©äº Raft çš„å·®åˆ«ï¼Œè¿™å¾ˆæ˜æ˜¾é«˜äºè§‚å¯Ÿåˆ°çš„ 4.9 åˆ†çš„åˆ†å·®ã€‚è¿™æ˜¯å› ä¸ºå®é™…ä¸Šè®¸å¤šçš„å­¦ç”Ÿä¹‹å‰æœ‰å­¦ä¹ è¿‡ Paxosï¼Œè¿™å¯¹ Paxos çš„æœ‰å¾ˆå¤§å¸®åŠ©çš„ï¼Œä½†æ˜¯å¯¹ Raft çš„å¸®åŠ©å°±è¾ƒå°äº†ã€‚ä½†æ˜¯å¥‡æ€ªçš„æ˜¯ï¼Œæ¨¡å‹é¢„æµ‹å¯¹äºå…ˆè¿›è¡Œ Paxos å°æµ‹éªŒçš„äººè€Œè¨€ï¼ŒRaft çš„å¾—åˆ†ä½äº† 6.3 åˆ†ã€‚è™½ç„¶æˆ‘ä»¬ä¸çŸ¥é“è¿™æ˜¯ä¸ºä»€ä¹ˆï¼Œä½†æ˜¯è¿™ä¼¼ä¹åœ¨ç»Ÿè®¡ä¸Šæ˜¯æœ‰æ„ä¹‰çš„ã€‚ image-20210716183850084 æˆ‘ä»¬åŒæ—¶ä¹Ÿåœ¨æµ‹éªŒä¹‹åå¯¹å‚ä¸è€…è¿›è¡Œäº†è°ƒæŸ¥ï¼Œè°ƒæŸ¥çš„å†…å®¹æ˜¯ä»–ä»¬è®¤ä¸ºå“ªä¸ªç®—æ³•æ›´å®¹æ˜“å»å®ç°æˆ–è§£é‡Šã€‚è¿™äº›è°ƒæŸ¥ç»“æœå±•ç¤ºåœ¨å›¾ 15ã€‚è°ƒæŸ¥ç»“æœæ˜¯ç¢¾å‹æ€§çš„ï¼Œç»“æœè¡¨æ˜ Raft ç®—æ³•æ›´åŠ å®¹æ˜“å®ç°å’Œè§£é‡Šï¼ˆ41 äººä¸­çš„ 33 ä¸ªï¼‰ã€‚ç„¶è€Œï¼Œè¿™ç§è‡ªæˆ‘æŠ¥å‘Šçš„æ„Ÿè§‰å¯èƒ½æ²¡æœ‰å‚ä¸è€…çš„æµ‹è¯•åˆ†æ•°æ¥å¾—å¯é ï¼Œè€Œä¸”å‚ä¸è€…å¯èƒ½ç”±äºæˆ‘ä»¬å‡è®¾ Raft æ›´å®¹æ˜“ç†è§£è€Œå­˜åœ¨åå‘ã€‚ åœ¨å‚è€ƒæ–‡çŒ® [33] ä¸­æœ‰ä¸€ä¸ªå…³äº Raft ç”¨æˆ·å­¦ä¹ çš„æ›´åŠ è¯¦ç»†çš„è®¨è®ºã€‚ 9.2 æ­£ç¡®æ€§ åœ¨ç¬¬ 5 èŠ‚ä¸­ï¼Œæˆ‘ä»¬å·²ç»å¯¹å…±è¯†æœºåˆ¶åˆ¶å®šäº†æ­£å¼çš„è§„èŒƒå¹¶ä¸”å¯¹å…¶å®‰å…¨æ€§åšäº†è¯æ˜ã€‚è¿™ä»½æ­£å¼çš„è§„èŒƒä½¿ç”¨ TLA+ è§„èŒƒè¯­è¨€ [17] ä½¿å›¾ 2 ä¸­å¯¹ç®—æ³•çš„æ€»ç»“çš„ä¿¡æ¯éå¸¸æ¸…æ™°ã€‚å®ƒå·®ä¸å¤šæœ‰ 400 è¡Œå¹¶ä¸”ä½œä¸ºäº†æˆ‘ä»¬è¦è¯æ˜çš„æ ¸å¿ƒã€‚åŒæ—¶è¿™ä»½è§„èŒƒå¯¹äºä»»ä½•æƒ³å®ç° Raft çš„äººéƒ½æ˜¯ååˆ†æœ‰ç”¨çš„ã€‚æˆ‘ä»¬ç”¨ TLA è¯æ˜ç³»ç»Ÿ [7] æœºæ¢°åœ°è¯æ˜äº†æ—¥å¿—å®Œæ•´æ€§ï¼ˆLog Completeness Propertyï¼‰ã€‚ç„¶è€Œï¼Œè¿™ä¸ªè¯æ˜ä¾èµ–çš„çº¦æŸå‰æè¿˜æ²¡æœ‰è¢«æœºæ¢°è¯æ˜ï¼ˆä¾‹å¦‚ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰è¯æ˜è§„èŒƒä¸­çš„ç±»å‹å®‰å…¨ï¼‰ã€‚è€Œä¸”ï¼Œæˆ‘ä»¬å·²ç»ç¼–å†™äº†çŠ¶æ€æœºå®‰å…¨ç‰¹æ€§çš„éæ­£å¼è¯æ˜ [31]ï¼Œå®ƒæ˜¯å®Œæ•´çš„ï¼ˆå®ƒä»…ä¾èµ–äºè§„èŒƒï¼‰å’Œç›¸å¯¹ç²¾ç¡®çš„ï¼ˆå¤§çº¦ 3500 å­—é•¿ï¼‰ã€‚ 9.3 æ€§èƒ½ Raft çš„æ€§èƒ½è·Ÿå…¶ä»–åƒ Paxos çš„å…±è¯†ç®—æ³•å¾ˆæ¥è¿‘ã€‚åœ¨æ€§èƒ½æ–¹é¢ï¼Œæœ€é‡è¦çš„å…³æ³¨ç‚¹å°±æ˜¯ï¼Œå½“ä¸€ä¸ª leader è¢«é€‰ä¸¾å‡ºæ¥åï¼Œå®ƒè¦åœ¨ä»€ä¹ˆæ—¶å€™å¤åˆ¶æ–°çš„æ—¥å¿—æ¡ç›®ã€‚Raft é€šè¿‡å¾ˆå°‘é‡çš„æ¶ˆæ¯åŒ…ï¼ˆä¸€è½®ä» leader åˆ°é›†ç¾¤ä¸­è¿‡åŠèŠ‚ç‚¹çš„çš„æ¶ˆæ¯ä¼ é€’ï¼‰å°±è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚åŒæ—¶ï¼Œè¿›ä¸€æ­¥æå‡ Raft çš„æ€§èƒ½ä¹Ÿæ˜¯æœ‰å¯èƒ½çš„ã€‚æ¯”å¦‚è¯´ï¼Œå¾ˆå®¹æ˜“é€šè¿‡æ”¯æŒæ‰¹é‡æ“ä½œå’Œç®¡é“æ“ä½œæ¥æé«˜ååé‡å’Œé™ä½å»¶è¿Ÿã€‚å¯¹äºå…¶ä»–å…±è¯†ç®—æ³•å·²ç»æå‡ºè¿‡å¾ˆå¤šæ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆï¼Œå…¶ä¸­å¾ˆå¤šéƒ½å¯ä»¥åº”ç”¨åˆ° Raft ä¸Šï¼Œä½†æ˜¯æˆ‘ä»¬æš‚æ—¶æŠŠè¿™äº›å·¥ä½œæ”¾åˆ°æœªæ¥çš„å·¥ä½œä¸­ã€‚ æˆ‘ä»¬ä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„ Raft å®ç°æ¥è¡¡é‡ Raft çš„ leader election ç®—æ³•çš„æ€§èƒ½å¹¶ä¸”å›ç­”ä¸¤ä¸ªé—®é¢˜ï¼š leader é€‰ä¸¾è¿‡ç¨‹æ”¶æ•›æ˜¯å¦è¶³å¤Ÿå¿«ï¼Ÿ åœ¨ leader å´©æºƒä¹‹åï¼Œæœ€å°çš„ç³»ç»Ÿå´©æºƒæ—¶é—´æ˜¯å¤šä¹…ï¼Ÿ image-20210716194110554 ä¸ºäº†è¡¡é‡ leader election çš„æ€§èƒ½ï¼Œæˆ‘ä»¬åå¤ä½¿ä¸€ä¸ªæ‹¥æœ‰ 5 ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤çš„ leader å®•æœºï¼Œå¹¶è®¡ç®—å®ƒæ£€æµ‹å´©æºƒå’Œé‡æ–°é€‰ä¸€ä¸ªæ–°çš„ leader æ‰€éœ€çš„æ—¶é—´ï¼ˆè§å›¾ 16ï¼‰ã€‚ä¸ºäº†æ„å»ºä¸€ä¸ªæœ€åçš„æƒ…æ™¯ï¼Œæˆ‘ä»¬ä½¿å„ä¸ªèŠ‚ç‚¹ä¸­çš„æ—¥å¿—é•¿åº¦éƒ½æ˜¯ä¸åŒçš„ï¼Œè¿™æ ·æŸäº› candidate æ˜¯æ— æ³•æˆä¸º leader çš„ã€‚è€Œå·²ï¼Œä¸ºäº†å°½å¯èƒ½å‡ºç°æ— ç»“æœçš„æŠ•ç¥¨ï¼ˆsplit voteï¼‰æƒ…å†µï¼Œæˆ‘ä»¬çš„æµ‹è¯•è„šæœ¬åœ¨ç»ˆæ­¢ leader çš„è¿›ç¨‹ä¹‹å‰ä» leader é‚£è§¦å‘äº†ä¸€ä¸ªåŒæ­¥çš„å‘é€äº†ä¸€æ¬¡å¿ƒè·³å¹¿æ’­ï¼ˆç±»ä¼¼äº leader åœ¨å´©æºƒå‰å¤åˆ¶ä¸€ä¸ªæ—¥å¿—æ¡ç›®ç»™å…¶ä»–èŠ‚ç‚¹ï¼‰ã€‚leader åœ¨å…¶å¿ƒè·³é—´éš”å†…å‡åŒ€éšæœºåœ°å´©æºƒï¼Œè¿™ä¸ªå¿ƒè·³é—´éš”ä¹Ÿæ˜¯æ‰€æœ‰æµ‹è¯•ä¸­æœ€å°é€‰ä¸¾è¶…æ—¶æ—¶é•¿çš„ä¸€åŠã€‚å› æ­¤ï¼Œæœ€å°å®•æœºæ—¶é—´å¤§çº¦å°±æ˜¯æœ€å°é€‰ä¸¾è¶…æ—¶æ—¶é—´çš„ä¸€åŠã€‚ å›¾ 16 ä¸­ä¸Šé¢çš„å›¾è¡¨æ˜ï¼Œåªéœ€è¦åœ¨é€‰ä¸¾è¶…æ—¶æ—¶é—´ä¸Šä½¿ç”¨å¾ˆå°çš„éšæœºåŒ–å°±å¯ä»¥å¤§å¤§é¿å…å‡ºç°æ²¡æœ‰ç»“æœçš„æŠ•ç¥¨çš„æƒ…å†µã€‚åœ¨æ²¡æœ‰éšæœºåŒ–çš„æƒ…å†µä¸‹ï¼ˆè¯‘è€…æ³¨ï¼šè§å›¾ 16 ä¸­ä¸Šé¢çš„å›¾å³è¾¹çš„æ©™è‰²è™šçº¿ï¼‰ï¼Œç”±äºå‡ºç°äº†å¾ˆå¤šæ²¡æœ‰ç»“æœçš„æŠ•ç¥¨çš„æƒ…å†µï¼Œleader election å¾€å¾€éƒ½éœ€è¦èŠ±è´¹è¶…è¿‡ 10s çš„æ—¶é—´ã€‚ä»…ä»…åŠ å…¥ 5ms çš„éšæœºåŒ–æ—¶é—´ï¼Œå°±å¤§å¤§æ”¹å–„äº†é€‰ä¸¾è¿‡ç¨‹ï¼Œç°åœ¨å¹³å‡çš„å®•æœºæ—¶é—´åªæœ‰ 287msã€‚ç»§ç»­å¢å¤§éšæœºæ€§å¯ä»¥å¤§å¤§æ”¹å–„æœ€åçš„æƒ…å†µï¼šé€šè¿‡å¢åŠ  50ms çš„éšæœºåŒ–æ—¶é—´ï¼Œæœ€åçš„å®Œæˆæƒ…å†µï¼ˆå³å®Œæˆ 1000 æ¬¡å®éªŒï¼‰åªéœ€è¦ 513 msã€‚ å›¾ 16 ä¸­ä¸‹é¢çš„å›¾è¡¨æ˜ï¼Œé€šè¿‡å‡å°‘é€‰ä¸¾è¶…æ—¶æ—¶é—´å¯ä»¥ç¦çƒ§ç³»ç»Ÿçš„å®•æœºæ—¶é—´ã€‚åœ¨é€‰ä¸¾è¶…æ—¶æ—¶é—´ä¸º 12~24ms çš„æƒ…å†µä¸‹ï¼Œåªéœ€è¦å¹³å‡ 35ms å°±å¯ä»¥é€‰ä¸¾å‡ºæ–°çš„ leaderï¼ˆæœ€é•¿çš„ä¸€æ¬¡èŠ±è´¹äº† 152msï¼‰ã€‚ç„¶è€Œï¼Œè¿›ä¸€æ­¥é™ä½é€‰ä¸¾è¶…æ—¶æ—¶é—´å¯èƒ½å°±ä¼šè¿å Raft ä¸ç­‰å¼çš„è¦æ±‚ã€‚ å¹¿æ’­æ—¶é—´ï¼ˆbroadcastTimeï¼‰ é€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼ˆelectionTimeoutï¼‰ å¹³å‡æ•…éšœé—´éš”æ—¶é—´ï¼ˆMTBFï¼‰ å› ä¸ºè¿™ä¼šä½¿å¾—åœ¨å…¶ä»–èŠ‚ç‚¹å¼€å¯ä¸€è½®æ–°çš„é€‰ä¸¾ä¹‹å‰ï¼Œå½“å‰çš„ leader è¦å®Œæˆå‘é€ä¸€æ¬¡å¿ƒè·³å¹¿æ’­å˜å¾—å¾ˆéš¾ã€‚è¿™ä¼šé€ æˆä¸å¿…è¦çš„ leader æ›´æ¢ï¼Œä»è€Œé™ä½äº†ç³»ç»Ÿçš„å¯ç”¨æ€§ã€‚æˆ‘ä»¬æ¨èä½¿ç”¨ä¸€ä¸ªæ›´ä¸ºä¿å®ˆçš„é€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼Œæ¯”å¦‚ 150~300msã€‚è¿™æ ·çš„æ—¶é—´ä¸å¤§å¯èƒ½å¯¼è‡´ä¸å¿…è¦çš„ leader æ›´æ¢ï¼ŒåŒæ—¶è¿˜èƒ½æä¾›ä¸é”™çš„å¯ç”¨æ€§ã€‚ 10. ç›¸å…³å·¥ä½œ ç°åœ¨å·²ç»æœ‰å¾ˆå¤šå…³äºå…±è¯†ç®—æ³•ç›¸å…³çš„äº§ç‰©äº†ï¼Œå…¶ä¸­å¾ˆå¤šéƒ½å±äºä»¥ä¸‹ç±»åˆ«ä¹‹ä¸€ï¼š Lamport å¯¹äº Paxos çš„æœ€åˆçš„æè¿° [15]ï¼Œä»¥åŠå°è¯•å°† Paxos è§£é‡Šåœ°æ›´æ¸…æ™°çš„æè¿° [16, 20, 21 ]ã€‚ å…³äº Paxos çš„æ›´è¯¦å°½çš„æè¿°ï¼Œè¡¥å……é—æ¼çš„ç»†èŠ‚å¹¶ä¿®æ”¹ç®—æ³•ï¼Œä½¿å¾—å¯ä»¥æä¾›æ›´åŠ å®¹æ˜“çš„å®ç°åŸºç¡€ [26, 39, 13]ã€‚ å®ç°å…±è¯†ç®—æ³•çš„ç³»ç»Ÿï¼Œä¾‹å¦‚ Chubby [2, 4]ï¼ŒZooKeeper [11, 12] å’Œ Spanner [6]ã€‚å¯¹äº Chubby å’Œ Spanner çš„ç®—æ³•å¹¶æ²¡æœ‰å…¬å¼€å‘è¡¨å…¶æŠ€æœ¯ç»†èŠ‚ï¼Œå°½ç®¡ä»–ä»¬éƒ½å£°ç§°æ˜¯åŸºäº Paxos çš„ã€‚ZooKeeper çš„ç®—æ³•ç»†èŠ‚å·²ç»å‘è¡¨ï¼Œä½†æ˜¯å’Œ Paxos ç€å®æœ‰ç€å¾ˆå¤§çš„å·®åˆ«ã€‚ å¯¹äº Paxos çš„æ€§èƒ½ä¼˜åŒ– [18, 19, 3, 25, 1, 27]ã€‚ Oki å’Œ Liskov çš„ Viewstamped Replicationï¼ˆVRï¼‰ï¼Œä¸€ç§å’Œ Paxos å·®ä¸å¤šçš„æ›¿ä»£ç®—æ³•ã€‚åŸå§‹çš„ç®—æ³•æè¿° [29] å’Œåˆ†å¸ƒå¼ä¼ è¾“åè®®è€¦åˆåœ¨äº†ä¸€èµ·ï¼Œä½†æ˜¯æ ¸å¿ƒçš„å…±è¯†ç®—æ³•åœ¨æœ€è¿‘æ›´æ–°çš„ç‰ˆæœ¬ [22] é‡Œè¢«åˆ†ç¦»äº†å‡ºæ¥ã€‚VR ä½¿ç”¨äº†ä¸€ç§åŸºäº leader çš„æ–¹æ³•ï¼Œå’Œ Raft æœ‰å¾ˆå¤šç›¸ä¼¼ä¹‹å¤„ã€‚ Raft å’Œ Paxos æœ€å¤§çš„ä¸åŒå°±åœ¨äº Raft çš„å¼ºé¢†å¯¼æ€§ï¼ˆstrong leadershipï¼‰ã€‚Raft å°† leader election ä½œä¸ºå…±è¯†åè®®ä¸­éå¸¸é‡è¦çš„ä¸€ç¯ï¼Œå¹¶ä¸”å°†å°½å¯èƒ½å¤šçš„åŠŸèƒ½é›†ä¸­åˆ°äº† leader èº«ä¸Šã€‚è¿™ç§æ–¹æ³•ä½¿å¾—ç®—æ³•æ›´åŠ ç®€å•å’Œæ›´å®¹æ˜“ç†è§£ã€‚æ¯”å¦‚è¯´ï¼Œåœ¨ Paxos ä¸­ï¼Œleader election å’ŒåŸºæœ¬çš„å…±è¯†åè®®æ˜¯æ­£äº¤çš„ï¼šå®ƒåªæ˜¯ä½œä¸ºä¸€ç§æ€§èƒ½ä¼˜åŒ–ï¼Œè€Œä¸æ˜¯å®ç°å…±è¯†æ‰€å¿…éœ€çš„ã€‚ç„¶è€Œï¼Œè¿™å¸¦æ¥äº†å¾ˆå¤šé¢å¤–çš„æœºåˆ¶ï¼š Paxos ä¸­åŒ…å«äº†ä¸€ä¸ªä¸¤æ®µå¼çš„åŸºæœ¬å…±è¯†åè®® Paxos ä¸­è¿˜åŒ…å«äº†ä¸€ä¸ªå•ç‹¬çš„ leader election æœºåˆ¶ ç›¸æ¯”ä¹‹ä¸‹ï¼ŒRaft å°† leader election ç›´æ¥çº³å…¥äº†å…±è¯†ç®—æ³•å¹¶ä¸”å°†å…¶ä½œä¸ºå…±è¯†ä¸¤é˜¶æ®µä¸­çš„ç¬¬ä¸€ä¸ªé˜¶æ®µï¼Œè¿™ä½¿å¾— Raft ä½¿ç”¨çš„æœºåˆ¶è¦æ¯” Paxos å°‘å¾—å¤šã€‚ åƒ Raft ä¸€æ ·ï¼ŒVR å’Œ ZooKeeper ä¹Ÿæ˜¯åŸºäº leader çš„ï¼Œå› æ­¤ä»–ä»¬ä¹Ÿæ‹¥æœ‰ä¸€äº› Raft çš„ä¼˜ç‚¹ã€‚ä½†æ˜¯ï¼ŒRaft æ¯” VR å’Œ ZooKeeper æ‹¥æœ‰æ›´å°‘çš„æœºåˆ¶ã€‚å› ä¸º Raft å°½å¯èƒ½çš„å‡å°‘äº†é leader è€…çš„åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼ŒRaft ä¸­æ—¥å¿—æ¡ç›®éƒ½éµå¾ªç€ä» leader å‘é€ç»™ follower è¿™ä¸€ä¸ªæ–¹å‘ï¼šAppendEntries RPCs æ˜¯å‘å¤–å‘é€çš„ã€‚åœ¨ VR ä¸­ï¼Œæ—¥å¿—æ¡ç›®çš„æµåŠ¨æ˜¯åŒå‘çš„ï¼ˆleader äººå¯ä»¥åœ¨é€‰ä¸¾è¿‡ç¨‹ä¸­æ¥æ”¶æ—¥å¿—ï¼‰ï¼›è¿™å°±å¯¼è‡´äº†é¢å¤–çš„æœºåˆ¶å’Œå¤æ‚æ€§ã€‚æ ¹æ® ZooKeeper å…¬å¼€çš„èµ„æ–™çœ‹ï¼Œå®ƒçš„æ—¥å¿—æ¡ç›®ä¹Ÿæ˜¯åŒå‘ä¼ è¾“çš„ï¼Œä½†æ˜¯å®ƒçš„å®ç°æ›´åƒ Raftã€‚ è·Ÿæˆ‘ä»¬ä¸Šè¿°æåˆ°çš„å…¶ä»–åŸºäºå…±è¯†æ€§çš„æ—¥å¿—å¤åˆ¶ç®—æ³•ç›¸æ¯”ï¼ŒRaft çš„æ¶ˆæ¯ç±»å‹æ›´å°‘ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬è®¡ç®—äº†ä¸€ä¸‹ VR å’Œ ZooKeeper ç”¨æ¥å®ç°åŸºæœ¬åŠŸèƒ½å’Œé›†ç¾¤æˆå‘˜å˜æ›´ï¼ˆä¸åŒ…æ‹¬æ—¥å¿—å‹ç¼©å’Œå®¢æˆ·ç«¯äº¤äº’ï¼Œå› ä¸ºè¿™äº›éƒ½æ¯”è¾ƒç‹¬ç«‹ä¸”å’Œç®—æ³•å…³ç³»ä¸å¤§ï¼‰æ‰€éœ€è¦çš„æ¶ˆæ¯ç±»å‹ã€‚VR å’Œ ZooKeeper éƒ½åˆ†åˆ«å®šä¹‰äº† 10 ç§ä¸åŒçš„æ¶ˆæ¯ç±»å‹ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒRaft åªæœ‰ 4 ç§æ¶ˆæ¯ç±»å‹ï¼ˆä¸¤ç§ RPC Request åŠå…¶å¯¹åº”çš„ä¸¤ç§ RPC Responseï¼‰ã€‚Raft çš„æ¶ˆæ¯çš„æ¶ˆæ¯é‡æ¯”å…¶ä»–ç®—æ³•çš„è¦å¤§ä¸€ç‚¹ï¼Œä½†æ€»çš„æ¥è¯´ï¼Œå®ƒä»¬æ›´åŠ ç®€å•ã€‚å¦å¤–ï¼ŒVR å’Œ ZooKeeper éƒ½åœ¨ leader æ”¹å˜çš„æ—¶å€™ä¼ è¾“äº†æ•´ä¸ªæ—¥å¿—ï¼Œæ‰€ä»¥è¿™äº›ç®—æ³•ä¸ºäº†èƒ½åœ¨å®è·µä¸­ä½¿ç”¨ï¼Œå°±ä¸å¾—ä¸å¢åŠ é¢å¤–çš„æ¶ˆæ¯ç±»å‹äº†ã€‚ Raft çš„å¼º leader æ¨¡å‹ç®€åŒ–äº†æ•´ä¸ªç®—æ³•ï¼Œä½†æ˜¯åŒæ—¶ä¹Ÿæ’æ–¥äº†ä¸€äº›æ€§èƒ½ä¼˜åŒ–çš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œå¹³ç­‰ä¸»ä¹‰ Paxos ï¼ˆEPaxosï¼‰åœ¨æŸäº›æ²¡æœ‰ leader çš„æƒ…å†µä¸‹å¯ä»¥è¾¾åˆ°å¾ˆé«˜çš„æ€§èƒ½ [27]ã€‚å¹³ç­‰ä¸»ä¹‰ Paxos å……åˆ†å‘æŒ¥äº†åœ¨çŠ¶æ€æœºæŒ‡ä»¤ä¸­çš„äº¤æ¢æ€§ã€‚ä»»ä½•æœåŠ¡å™¨éƒ½å¯ä»¥åœ¨ä¸€è½®é€šä¿¡ä¸‹å°±æäº¤æŒ‡ä»¤ï¼Œé™¤éå…¶ä»–æŒ‡ä»¤åŒæ—¶è¢«æå‡ºäº†ã€‚ç„¶è€Œï¼Œå¦‚æœæŒ‡ä»¤éƒ½æ˜¯å¹¶å‘çš„è¢«æå‡ºï¼Œå¹¶ä¸”äº’ç›¸ä¹‹é—´ä¸é€šä¿¡æ²Ÿé€šï¼Œé‚£ä¹ˆ EPaxos å°±éœ€è¦é¢å¤–çš„ä¸€è½®é€šä¿¡ã€‚å› ä¸ºä»»ä½•æœåŠ¡å™¨éƒ½å¯ä»¥æäº¤æŒ‡ä»¤ï¼Œæ‰€ä»¥ EPaxos åœ¨æœåŠ¡å™¨ä¹‹é—´çš„è´Ÿè½½å‡è¡¡åšçš„å¾ˆå¥½ï¼Œå¹¶ä¸”å¾ˆå®¹æ˜“åœ¨ WAN ç½‘ç»œç¯å¢ƒä¸‹è·å¾—å¾ˆä½çš„å»¶è¿Ÿã€‚ä½†æ˜¯ï¼Œä»–åœ¨ Paxos ä¸Šå¢åŠ äº†éå¸¸æ˜æ˜¾çš„å¤æ‚æ€§ã€‚ ä¸€äº›é›†ç¾¤æˆå‘˜å˜æ›´çš„æ–¹æ³•å·²ç»è¢«æå‡ºæˆ–è€…åœ¨å…¶ä»–çš„å·¥ä½œä¸­è¢«å®ç°ï¼ŒåŒ…æ‹¬ Lamport çš„åŸå§‹çš„è®¨è®º [15]ï¼ŒVR [22] å’Œ SMART [24]ã€‚æˆ‘ä»¬é€‰æ‹©ä½¿ç”¨è”åˆå…±è¯†çš„æ–¹æ³•æ˜¯å› ä¸ºå®ƒåˆ©ç”¨äº†å…±è¯†åè®®çš„å…¶ä½™éƒ¨åˆ†ï¼Œè¿™æ ·æˆ‘ä»¬åªéœ€è¦å¾ˆå°‘çš„ä¸€äº›æœºåˆ¶å°±å¯ä»¥å®ç°æˆå‘˜å˜æ›´ã€‚Lamport çš„åŸºäº Î± çš„æ–¹æ³•ä¹‹æ‰€ä»¥æ²¡æœ‰è¢« Raft é€‰æ‹©æ˜¯å› ä¸ºå®ƒå‡è®¾åœ¨æ²¡æœ‰ leader çš„æƒ…å†µä¸‹ä¹Ÿå¯ä»¥è¾¾åˆ°å…±è¯†æ€§ã€‚å’Œ VR å’Œ SMART ç›¸æ¯”è¾ƒï¼ŒRaft çš„é‡æ–°é…ç½®ç®—æ³•å¯ä»¥åœ¨ä¸é™åˆ¶æ­£å¸¸è¯·æ±‚å¤„ç†çš„æƒ…å†µä¸‹è¿›è¡Œã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒVR åœ¨é…ç½®å˜æ›´æœŸé—´éœ€è¦åœæ­¢æ‰€æœ‰æ­£å¸¸çš„å¤„ç†è¿‡ç¨‹ï¼Œè€Œ SMART å¯¹æœªå®Œæˆè¯·æ±‚çš„æ•°é‡å®æ–½äº†ç±»ä¼¼ Î± æ–¹æ³•çš„é™åˆ¶ã€‚å¦å¤–ï¼Œå’Œ VRã€SMART ç›¸æ¯”ï¼ŒRaft çš„æ–¹æ³•ä¹Ÿåªéœ€è¦å¢åŠ æ›´å°‘çš„é¢å¤–æœºåˆ¶æ¥å®ç°ã€‚ 11. ç»“è®º ç®—æ³•çš„è®¾è®¡é€šå¸¸ä»¥æ­£ç¡®æ€§ã€æ•ˆç‡å’Œç®€æ´æ€§ä¸ºä¸»è¦ç›®æ ‡ã€‚è™½ç„¶è¿™äº›éƒ½æ˜¯æœ‰ä»·å€¼çš„ç›®æ ‡ï¼Œä½†æˆ‘ä»¬ç›¸ä¿¡å¯ç†è§£æ€§åŒæ ·é‡è¦ã€‚åœ¨å¼€å‘äººå‘˜å°†ç®—æ³•è½¬åŒ–ä¸ºå®é™…å®ç°ä¹‹å‰ï¼Œå…¶ä»–ä»»ä½•ç›®æ ‡éƒ½ä¸èƒ½å®ç°ï¼Œè€Œå®é™…å®ç°å°†ä¸å¯é¿å…åœ°åç¦»å’Œæ‰©å±•å‘å¸ƒçš„å½¢å¼ã€‚é™¤éå¼€å‘äººå‘˜å¯¹ç®—æ³•æœ‰æ·±åˆ»çš„ç†è§£ï¼Œå¹¶èƒ½å¯¹ç®—æ³•æœ‰ç›´è§‚çš„è®¤è¯†ï¼Œå¦åˆ™ä»–ä»¬å¾ˆéš¾åœ¨å®ç°ä¸­ä¿ç•™ç®—æ³•ç†æƒ³çš„ç‰¹æ€§ã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬è®¨è®ºäº†åˆ†å¸ƒå¼å…±è¯†çš„é—®é¢˜ï¼Œåœ¨è¿™ä¸ªé—®é¢˜ä¸Šï¼Œä¸€ä¸ªè¢«å¹¿æ³›æ¥å—ä½†éš¾ä»¥ç†è§£çš„ç®—æ³•ï¼šPaxosï¼Œå¤šå¹´æ¥ä¸€ç›´è®©å­¦ç”Ÿå’Œå¼€å‘äººå‘˜éå¸¸æŒ£æ‰ã€‚æˆ‘ä»¬å¼€å‘äº†ä¸€ç§æ–°çš„ç®—æ³•ï¼šRaftï¼Œæˆ‘ä»¬å·²ç»è¯æ˜å®ƒæ¯” Paxos æ›´å®¹æ˜“ç†è§£ã€‚æˆ‘ä»¬ä¹Ÿç›¸ä¿¡ Raft ä¼šä¸ºç³»ç»Ÿå»ºè®¾æä¾›æ›´å¥½çš„åŸºç¡€ã€‚å°†å¯ç†è§£æ€§ä½œä¸ºä¸»è¦è®¾è®¡ç›®æ ‡æ”¹å˜äº†æˆ‘ä»¬å¤„ç† Raft è®¾è®¡çš„æ–¹å¼ã€‚éšç€è®¾è®¡çš„è¿›å±•ï¼Œæˆ‘ä»¬å‘ç°è‡ªå·±åå¤ä½¿ç”¨äº†ä¸€äº›æŠ€æœ¯ï¼Œæ¯”å¦‚åˆ†è§£é—®é¢˜å’Œç®€åŒ–çŠ¶æ€ç©ºé—´ã€‚è¿™äº›æŠ€æœ¯ä¸ä»…æé«˜äº† Raft çš„å¯ç†è§£æ€§ï¼Œè€Œä¸”ä½¿æˆ‘ä»¬æ›´å®¹æ˜“è¯å®å®ƒçš„æ­£ç¡®æ€§ã€‚ 12. è‡´è°¢ è¿™é¡¹ç ”ç©¶å¿…é¡»æ„Ÿè°¢ä»¥ä¸‹äººå‘˜çš„æ”¯æŒï¼šAli Ghodsiï¼ŒDavid Mazie`resï¼Œå’Œä¼¯å…‹åˆ© CS 294-91 è¯¾ç¨‹ã€æ–¯å¦ç¦ CS 240 è¯¾ç¨‹çš„å­¦ç”Ÿï¼Œæ²¡æœ‰ä»–ä»¬çš„å¤§åŠ›æ”¯æŒï¼Œè¿™é¡¹ç ”ç©¶æ˜¯ä¸å¯èƒ½å®Œæˆçš„ã€‚Scott Klemmer å¸®æˆ‘ä»¬è®¾è®¡äº†ç”¨æˆ·è°ƒæŸ¥ï¼ŒNelson Ray å»ºè®®æˆ‘ä»¬è¿›è¡Œç»Ÿè®¡å­¦çš„åˆ†æã€‚åœ¨ç”¨æˆ·è°ƒæŸ¥æ—¶ä½¿ç”¨çš„å…³äº Paxos çš„å¹»ç¯ç‰‡å¾ˆå¤§ä¸€éƒ¨åˆ†æ˜¯ä» Lorenzo Alvisi çš„å¹»ç¯ç‰‡ä¸Šå€Ÿé‰´è¿‡æ¥çš„ã€‚ç‰¹åˆ«çš„ï¼Œéå¸¸æ„Ÿè°¢ DavidMazieres å’Œ Ezra Hochï¼Œä»–ä»¬æ‰¾åˆ°äº† Raft ä¸­ä¸€äº›éš¾ä»¥å‘ç°çš„æ¼æ´ã€‚è®¸å¤šäººæä¾›äº†å…³äºè¿™ç¯‡è®ºæ–‡ååˆ†æœ‰ç”¨çš„åé¦ˆå’Œç”¨æˆ·è°ƒæŸ¥ææ–™ï¼ŒåŒ…æ‹¬ Ed Bugnionï¼ŒMichael Chanï¼ŒHugues Evrardï¼ŒDaniel Giffinï¼ŒArjun Gopalanï¼ŒJon Howellï¼ŒVimalkumar Jeyakumarï¼ŒAnkita Kejriwalï¼ŒAleksandar Kracunï¼ŒAmit Levyï¼ŒJoel Martinï¼ŒSatoshi Matsushitaï¼ŒOleg Pesokï¼ŒDavid Ramosï¼ŒRobbert van Renesseï¼ŒMendel Rosenblumï¼ŒNicolas Schiperï¼ŒDeian Stefanï¼ŒAndrew Stoneï¼ŒRyan Stutsmanï¼ŒDavid Tereiï¼ŒStephen Yangï¼ŒMatei Zaharia ä»¥åŠ 24 ä½åŒ¿åçš„ä¼šè®®å®¡æŸ¥äººå‘˜ï¼ˆå¯èƒ½æœ‰é‡å¤ï¼‰ï¼Œå¹¶ä¸”ç‰¹åˆ«æ„Ÿè°¢æˆ‘ä»¬çš„é¢†å¯¼äºº Eddie Kohlerã€‚Werner Vogels å‘äº†ä¸€æ¡æ—©æœŸè‰ç¨¿é“¾æ¥çš„æ¨ç‰¹ï¼Œç»™ Raft å¸¦æ¥äº†æå¤§çš„å…³æ³¨ã€‚æˆ‘ä»¬çš„å·¥ä½œç”± Gigascale ç³»ç»Ÿç ”ç©¶ä¸­å¿ƒå’Œ Multiscale ç³»ç»Ÿç ”ç©¶ä¸­å¿ƒç»™äºˆæ”¯æŒï¼Œè¿™ä¸¤ä¸ªç ”ç©¶ä¸­å¿ƒç”±å…³æ³¨ä¸­å¿ƒç ”ç©¶ç¨‹åºèµ„é‡‘æ”¯æŒï¼Œä¸€ä¸ªæ˜¯åŠå¯¼ä½“ç ”ç©¶å…¬å¸çš„ç¨‹åºï¼Œç”± STARnet æ”¯æŒï¼Œä¸€ä¸ªåŠå¯¼ä½“ç ”ç©¶å…¬å¸çš„ç¨‹åºç”± MARCO å’Œ DARPA æ”¯æŒï¼Œåœ¨å›½å®¶ç§‘å­¦åŸºé‡‘ä¼šçš„ 0963859 å·æ‰¹å‡†ï¼Œå¹¶ä¸”è·å¾—äº†æ¥è‡ª Facebookï¼ŒGoogleï¼ŒMellanoxï¼ŒNECï¼ŒNetAppï¼ŒSAP å’Œ Samsung çš„æ”¯æŒã€‚Diego Ongaro ç”± Junglee å…¬å¸ï¼Œæ–¯å¦ç¦çš„æ¯•ä¸šå›¢ä½“æ”¯æŒã€‚ å‚è€ƒæ–‡çŒ® [1] BOLOSKY, W. J., BRADSHAW, D., HAAGENS, R. B., KUSTERS, N. P., AND LI, P. Paxos replicated state machines as the basis of a high-performance data store. In Proc. NSDIâ€™11, USENIX Conference on Networked Systems Design and Implementation (2011), USENIX, pp. 141â€“154. [2] BURROWS, M. The Chubby lock service for loosely- coupled distributed systems. In Proc. OSDIâ€™06, Sympo- sium on Operating Systems Design and Implementation (2006), USENIX, pp. 335â€“350. [3] CAMARGOS, L. J., SCHMIDT, R. M., AND PEDONE, F. Multicoordinated Paxos. In Proc. PODCâ€™07, ACM Sym- posium on Principles of Distributed Computing (2007), ACM, pp. 316â€“317. [4] CHANDRA, T. D., GRIESEMER, R., AND REDSTONE, J. Paxos made live: an engineering perspective. In Proc. PODCâ€™07, ACM Symposium on Principles of Distributed Computing (2007), ACM, pp. 398â€“407. [5] CHANG, F., DEAN, J., GHEMAWAT, S., HSIEH, W. C., WALLACH, D. A., BURROWS, M., CHANDRA, T., FIKES, A., AND GRUBER, R. E. Bigtable: a distributed storage system for structured data. In Proc. OSDIâ€™06, USENIX Symposium on Operating Systems Design and Implementation (2006), USENIX, pp. 205â€“218. [6] CORBETT, J. C., DEAN, J., EPSTEIN, M., FIKES, A., FROST, C., FURMAN, J. J., GHEMAWAT, S., GUBAREV, A., HEISER, C., HOCHSCHILD, P., HSIEH, W., KAN- THAK, S., KOGAN, E., LI, H., LLOYD, A., MELNIK, S., MWAURA, D., NAGLE, D., QUINLAN, S., RAO, R., ROLIG, L., SAITO, Y., SZYMANIAK, M., TAYLOR, C., WANG, R., AND WOODFORD, D. Spanner: Googleâ€™s globally-distributed database. In Proc. OSDIâ€™12, USENIX Conference on Operating Systems Design and Implemen- tation (2012), USENIX, pp. 251â€“264. [7] COUSINEAU, D., DOLIGEZ, D., LAMPORT, L., MERZ, S., RICKETTS, D., AND VANZETTO, H. TLA+ proofs. In Proc. FMâ€™12, Symposium on Formal Methods (2012), D. Giannakopoulou and D. Me Ìry, Eds., vol. 7436 of Lec- ture Notes in Computer Science, Springer, pp. 147â€“154. [8] GHEMAWAT, S., GOBIOFF, H., AND LEUNG, S.-T. The Google file system. In Proc. SOSPâ€™03, ACM Symposium on Operating Systems Principles (2003), ACM, pp. 29â€“43. [9] GRAY,C.,ANDCHERITON,D.Leases:Anefficientfault- tolerant mechanism for distributed file cache consistency. In Proceedings of the 12th ACM Ssymposium on Operating Systems Principles (1989), pp. 202â€“210. [10] HERLIHY, M. P., AND WING, J. M. Linearizability: a correctness condition for concurrent objects. ACM Trans- actions on Programming Languages and Systems 12 (July 1990), 463â€“492. [11] HUNT, P., KONAR, M., JUNQUEIRA, F. P., AND REED, B . ZooKeeper: wait-free coordination for internet-scale systems. In Proc ATCâ€™10, USENIX Annual Technical Con- ference (2010), USENIX, pp. 145â€“158. [12] JUNQUEIRA, F. P., REED, B. C., AND SERAFINI, M. Zab: High-performance broadcast for primary-backup sys- tems. In Proc. DSNâ€™11, IEEE/IFIP Intâ€™l Conf. on Depend- able Systems Networks (2011), IEEE Computer Society, pp. 245â€“256. [13] KIRSCH, J., AND AMIR, Y. Paxos for system builders. Tech. Rep. CNDS-2008-2, Johns Hopkins University, 2008. [14] L A M P O RT, L . Time, clocks, and the ordering of events in a distributed system. Commununications of the ACM 21, 7 (July 1978), 558â€“565. [15] L A M P O RT, L . The part-time parliament. ACM Transac- tions on Computer Systems 16, 2 (May 1998), 133â€“169. [16] LAMPORT, L. Paxos made simple. ACM SIGACT News 32, 4 (Dec. 2001), 18â€“25. [17] L A M P O RT, L . Specifying Systems, The TLA+ Language and Tools for Hardware and Software Engineers. Addison- Wesley, 2002. [18] LAMPORT, L. Generalized consensus and Paxos. Tech. Rep. MSR-TR-2005-33, Microsoft Research, 2005. [19] L A M P O RT, L . Fast paxos. (2006), 79â€“103. [20] LAMPSON, B. W. How to build a highly available system using consensus. In Distributed Algorithms, O. Baboaglu and K. Marzullo, Eds. Springer-Verlag, 1996, pp. 1â€“17. [21] LAMPSON, B. W. The ABCDâ€™s of Paxos. In Proc. PODCâ€™01, ACM Symposium on Principles of Distributed Computing (2001), ACM, pp. 13â€“13. [22] LISKOV, B., AND COWLING, J. Viewstamped replica- tion revisited. Tech. Rep. MIT-CSAIL-TR-2012-021, MIT, July 2012. [23] LogCabin source code. http://github.com/ logcabin/logcabin. [24] LORCH, J. R., ADYA, A., BOLOSKY, W. J., CHAIKEN, R., DOUCEUR, J. R., AND HOWELL, J. The SMART way to migrate replicated stateful services. In Proc. Eu- roSysâ€™06, ACM SIGOPS/EuroSys European Conference on Computer Systems (2006), ACM, pp. 103â€“115. [25] MAO, Y., JUNQUEIRA, F. P., AND MARZULLO, K. Mencius: building efficient replicated state machines for WANs. In Proc. OSDIâ€™08, USENIX Conference on Operating Systems Design and Implementation (2008), USENIX, pp. 369â€“384. [26] MAZIE` RES, D. Paxos made practical. http://www.scs.stanford.edu/ Ìƒdm/home/ papers/paxos.pdf, Jan. 2007. [27] MORARU, I., ANDERSEN, D. G., AND KAMINSKY, M. There is more consensus in egalitarian parliaments. In Proc. SOSPâ€™13, ACM Symposium on Operating System Principles (2013), ACM. [28] Raft user study. http://ramcloud.stanford. edu/ Ìƒongaro/userstudy/. [29] OKI, B. M., AND LISKOV, B. H. Viewstamped replication: A new primary copy method to support highly-available distributed systems. In Proc. PODCâ€™88, ACM Symposium on Principles of Distributed Computing (1988), ACM, pp. 8â€“17. [30] Oâ€™NEIL, P., CHENG, E., GAWLICK, D., AND ONEIL, E. The log-structured merge-tree (LSM-tree). Acta Informat- ica 33, 4 (1996), 351â€“385. [31] ONGARO, D. Consensus: Bridging Theory and Practice. PhD thesis, Stanford University, 2014 (work in progress). [32] ONGARO, D., AND OUSTERHOUT, J. In search of an understandable consensus algorithm. In Proc ATCâ€™14, USENIX Annual Technical Conference (2014), USENIX. [33] OUSTERHOUT, J., AGRAWAL, P., ERICKSON, D., KOZYRAKIS, C., LEVERICH, J., MAZIE`RES, D., MI- TRA, S., NARAYANAN, A., ONGARO, D., PARULKAR, G., ROSENBLUM, M., RUMBLE, S. M., STRATMANN, E., AND STUTSMAN, R. The case for RAMCloud. Com- munications of the ACM 54 (July 2011), 121â€“130. [34] Raft consensus algorithm website. http://raftconsensus.github.io. [35] REED, B. Personal communications, May 17, 2013. [36] ROSENBLUM, M., AND OUSTERHOUT, J. K. The design and implementation of a log-structured file system. ACM Trans. Comput. Syst. 10 (February 1992), 26â€“52. [37] S C H N E I D E R , F. B . Implementing fault-tolerant services using the state machine approach: a tutorial. ACM Com- puting Surveys 22, 4 (Dec. 1990), 299â€“319. [38] SHVACHKO, K., KUANG, H., RADIA, S., AND CHANSLER, R. The Hadoop distributed file system. In Proc. MSSTâ€™10, Symposium on Mass Storage Sys- tems and Technologies (2010), IEEE Computer Society, pp. 1â€“10. [39] VAN RENESSE, R. Paxos made moderately complex. Tech. rep., Cornell University, 2012.","tags":["åˆ†å¸ƒå¼","Raft","åŸåˆ›"],"categories":["è®ºæ–‡ç¿»è¯‘"]},{"title":"å…³äºæˆ‘","path":"/about/index.html","content":""}]